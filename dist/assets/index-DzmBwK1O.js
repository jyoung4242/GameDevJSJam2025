(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const h of o)if(h.type==="childList")for(const c of h.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function i(o){const h={};return o.integrity&&(h.integrity=o.integrity),o.referrerPolicy&&(h.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?h.credentials="include":o.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function n(o){if(o.ep)return;o.ep=!0;const h=i(o);fetch(o.href,h)}})();class ls{constructor(){this.state="created",this.host=null,this.bindings=[],this.views=[],this.animations=[],this.animationQueue=[],this.destroyed="",this.moved=""}static create(t,i={},n,o={parent:null,prepare:!0,sibling:null}){const h=new ls;if(h.model=i,h.element=n??t,h.parent=o.parent??vt,h.host=o.host??h.parent.host,h.sibling=o.sibling??null,n instanceof HTMLTemplateElement||n?.tagName==="TEMPLATE"){const c=n.content.cloneNode(!0);if(c.children.length===1)return vt.create(t,i,c.firstElementChild,o);h.views=[...c.children].map(f=>vt.create(t,i,f,{...o,parent:h})),h.state="rendered"}else h.bindings.push(...vt.parse(h.element,i,h,o.parent));return h.parentElement=n!=null?t:t.ownerDocument.documentElement,h.views.length>1?(h.attached=Promise.all(h.views.map(c=>c.attached)),h.detached=Promise.all(h.views.map(c=>c.detached))):(h.attached=new Promise(c=>{h.t=c}),h.detached=new Promise(c=>{h.i=c})),h}get lastElement(){return this.render==null&&(this.render=!(this.element.hasAttribute?.("PUI-UNRENDERED")??!1)),this.render?this.element:this.bindings.flatMap(n=>n.views).slice(-1)[0]?.lastElement}destroy(){this.views.forEach(t=>t.destroy()),this.element.classList?.add("pui-removing"),this.destroyed="queue",vt.destroyed.push(this)}terminate(){Promise.all(this.getAnimations()).then(()=>{const t=this.element.parentElement;t?.removeChild(this.element),this.i?.(),this.dispatchEvent(t,"removed"),this.bindings.forEach(n=>n.unbind());const i=this.parent.views.findIndex(n=>n===this);i>-1&&this.parent.views.splice(i,1)}),this.destroyed="destroyed"}move(t){this.moved="queue",this.element.classList?.add("pui-moving"),this.sibling=t}play(t,i){return typeof t=="string"&&(t=this.animations.find(n=>n.name===t).clone()),t.element=i,t.state="pending",this.animationQueue.push(t),this.updateAnimations(performance.now()),t}updateFromUI(){this.views.forEach(t=>t.updateFromUI()),this.bindings.forEach(t=>t.updateFromUI())}updateToUI(){const t=this.state==="created";switch(t||(this.views.forEach(i=>i.updateToUI()),this.bindings.forEach(i=>i.updateToUI())),this.state){case"created":if(this.element.classList?.add("pui-adding"),this.render=!(this.element.hasAttribute?.("PUI-UNRENDERED")??!1),this.render){const i=this.parent?.parent;let o=(i?.render??!1?this.sibling:i?.sibling)??null;o=(o instanceof ls?o.lastElement:o)??null;const h=this.parentElement??vt.parentElement(this.element,this.parent);h.insertBefore(this.element,o?.nextSibling??null),this.dispatchEvent(h,"added")}this.t(),this.state="attaching";break;case"attaching":this.getAnimations(!1).length===0&&(this.element.classList?.remove("pui-adding"),this.state="attached");break;case"attached":this.state="rendered";break}t&&(this.views.forEach(i=>i.updateToUI()),this.bindings.forEach(i=>i.updateToUI()))}updateAtEvents(){this.views.forEach(t=>t.updateAtEvents()),this.bindings.forEach(t=>t.updateAtEvents())}updateAnimations(t){for(;this.animationQueue[0]?.state==="finished";)this.animationQueue.shift().destroy();for(let i=0;i<this.animationQueue.length;i++){const n=this.animationQueue[i];n.state==="pending"&&(n.isBlocked(t)||(n.state="playing",n.startTime=t,n.animation=n.element.animate(n.keyframes,n.options),n.finished=n.animation.finished,n.finished.then(()=>{n.state="finished",this.updateAnimations(performance.now())})))}}updateMove(){switch(this.moved){case"queue":this.moved="move";break;case"move":if(this.getAnimations().length===0){const t=this.parentElement??vt.parentElement(this.element,this.parent);let i=(this.sibling instanceof ls?this.sibling.lastElement:this.sibling)??null;if(this.render)t.insertBefore(this.element,i?.nextSibling??null);else{const n=this.bindings.flatMap(o=>o.views);for(const o of n)t.insertBefore(o.element,i?.nextSibling??null),i=o.element}this.element.classList?.remove("pui-moving"),this.moved="",this.sibling=null}break}this.bindings.forEach(t=>t.updateMove()),this.views.forEach(t=>t.updateMove())}getAnimations(t=!0){return(this.element.getAnimations?.({subtree:t})??[]).filter(i=>i.playState!=="finished"&&i.effect?.getTiming().iterations!==1/0).map(i=>i.finished)}dispatchEvent(t,i){if(t!=null){const n=new CustomEvent(`pui-${i}`,{detail:{model:this.model.$model??this.model,context:this.model,element:this.element,view:this},bubbles:!0,cancelable:!0});t.dispatchEvent(n)}}}class wl{constructor(){this.fromUI=!1,this.toUI=!0,this.atEvent=!1,this.oneTime=!1,this.views=[],this.firstUpdate=!0,this.events=[],this.triggerAtEvent=t=>{t.type==="change"?this.events.push(t):vt.resolveValue(this.object,this.property).call(this.object.$model,t,this.object.$model,this.element,this.attribute,this.object)},this.twoWayBindingEvent=t=>{const{target:i,property:n}=vt.resolveProperty(this.object,this.property),o=t.detail;if(o!==this.lastUIValue){let h=o;h!==void 0&&h!==this.lastValue&&vt.resolveValue(this.object,this.property)==="number"&&!isNaN(h)&&(h=+h),i[n]=h}},this.id=++vt.id}get element(){return this.$element==null&&(this.$element=typeof this.selector=="string"?this.context.querySelector(this.selector):this.selector),this.$element}set element(t){this.$element=t}static create(t){const i=new wl,n=t.property?.split(":")??[],o=n.shift(),h=typeof t.attribute!="boolean"?(t.attribute??"innerText").split(":"):[],c=typeof t.attribute!="boolean"?h.shift():t.attribute;if(i.parent=t.parent??vt,i.object="$model"in t.object?t.object:{$model:t.object},i.object.$parent==null){const f=i.parent.parent?.object?.$parent;f!=null&&(i.object.$parent=f)}return i.property=o,i.propertyArguments=n,i.context=t.context??document,i.selector=t.selector,i.attribute=c,i.attributeArguments=h,i.value=t.value??i.value,i.template=t.template??i.template,i.fromUI=t.fromUI??i.fromUI,i.toUI=t.toUI??i.toUI,i.atEvent=t.atEvent??i.atEvent,i.oneTime=t.oneTime??i.oneTime,i.addListener(),typeof i.fromUI!="boolean"&&(i.fromUI=i.fromUI.bind(i)),typeof i.toUI!="boolean"&&(i.toUI=i.toUI.bind(i)),i}destroy(){this.element=null,this.removeListener(),this.views.forEach(t=>t.destroy())}unbind(){vt.unbind(this)}addListener(){this.atEvent&&(this.toUI=!1,this.fromUI=!1,this.element.addEventListener(this.attribute,this.triggerAtEvent)),this.toUI&&this.fromUI&&customElements.get(this.element.tagName.toLowerCase())!=null&&this.element.addEventListener(this.attribute,this.twoWayBindingEvent)}removeListener(){this.atEvent&&this.element.removeEventListener(this.attribute,this.triggerAtEvent),this.toUI&&this.fromUI&&customElements.get(this.element.tagName.toLowerCase())!=null&&this.element.removeEventListener(this.attribute,this.twoWayBindingEvent)}updateFromUI(){if(this.fromUI===!1||this.firstUpdate){this.firstUpdate=!1,this.views.forEach(o=>o.updateFromUI());return}const{target:t,property:i}=vt.resolveProperty(this.element,this.attribute),n=t[i];if(n!==this.lastUIValue){let o=this.fromUI!==!0?this.fromUI(n,this.lastUIValue,this.property,this.object):n;if(this.lastUIValue=n,o!==void 0&&o!==this.lastValue){this.lastValue=o;const{target:h,property:c}=vt.resolveProperty(this.object,this.property);vt.resolveValue(this.object,this.property)==="number"&&!isNaN(o)&&(o=+o),h[c]=o}else this.lastValue=o;this.parent.host?.dispatchEvent(new CustomEvent(i,{detail:o}))}this.views.forEach(o=>o.updateFromUI())}updateToUI(){if(this.toUI===!1){this.views.forEach(i=>i.updateToUI());return}let t=vt.resolveValue(this.object,this.property);if(this.template!=null)if(this.template instanceof HTMLElement)if(typeof this.attribute=="boolean"){if(t=(t??!1)!==!1,t!==this.lastValue){const i=this.toUI!==!0?this.toUI(t,this.lastValue,this.property,this.object,this.value):t;i!==void 0&&i!==this.lastUIValue&&(i===this.attribute?this.views.push(ls.create(this.element.parentElement,this.object,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:this.element})):this.views.pop()?.destroy(),this.lastValue=t,this.lastUIValue=i)}}else{let i=!1,n=!1;t==null&&(t=[]);const o=this.propertyArguments[0],h=this.lastValue??[];if(t.length!==h.length)i=!0;else for(let b=0,T=t.length;b<T;b++){let P,I;o==null?t[b]!==h[b]&&(i=!0,n=!0):(P=vt.resolveValue(t[b]??{},o),I=vt.resolveValue(h[b]??{},o),P!==I&&(i=!0),t[b]!==h[b]&&(n=!0))}if(!i)if(n){const b=this.toUI!==!0?this.toUI(t,h,this.property,this.object,this.value):t;return this.updateViews(t,b)}else return this.updateViews();const c=this.toUI!==!0?this.toUI(t,h,this.property,this.object,this.value):t;if(c==null)return this.updateViews();const f=this.lastUIValue??[];let g=0;for(let b=0,T=c.length,P=0;b<T;b++,P++){let I,F;if(o==null?(I=c[b],F=f[P]):(I=vt.resolveValue(c[b]??{},o),F=vt.resolveValue(f[P]??{},o)),I===F)g++;else break}if(g===c.length&&c.length===f.length)return this.updateViews(t,c);const v=this.views.splice(0,g);let x=v[v.length-1];for(let b=g,T=c.length,P=g;b<T;b++,P++){const I=c[b],F=this.views.shift();if(F==null){const U={$model:{[this.attribute]:I},$parent:this.object},V=ls.create(this.element.parentElement,U,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:x??this.element});v.push(V),x=V;continue}const R=o==null?I:vt.resolveValue(I??{},o),S=F?.model.$model[this.attribute],M=o==null?S:vt.resolveValue(S??{},o);if(R===M){v.push(F),F.move(x??this.element),x=F;continue}if(!c.slice(b).map(U=>o==null?U:vt.resolveValue(U??{},o)).includes(M)){F.destroy(),b--,x=F;continue}this.views.unshift(F);let W=!1;for(let U=0,V=this.views.length;U<V;U++){const j=this.views[U],q=j?.model.$model[this.attribute],nt=o==null?q:vt.resolveValue(q??{},o);if(R===nt){v.push(...this.views.splice(U,1)),j.move(x??this.element),W=!0,x=j;break}}if(!W){const U={$model:{[this.attribute]:I},$parent:this.object},V=ls.create(this.element.parentElement,U,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:x??this.element});v.push(V),x=V}}return this.views.forEach(b=>b.destroy()),this.views=v,this.updateViews(t,c)}else{const i=vt.resolveValue(this.object,this.attribute);if((t??i)==null||(t??i)!==this.lastValue){this.lastUIValue!=null&&(this.lastUIValue.destroy(),this.lastUIValue=null);const n=t==null?i:i.create(t),o=i.template;this.lastValue=t??i;const h=this.element.nodeType===8?this.element.parentElement:this.element,c=this.element.nodeType===8?this.element:null;if(this.lastUIValue=vt.create(h,n,o,{parent:this,prepare:!0,sibling:c}),this.attributeArguments[0]!=null&&t!=null){const{target:f,property:g}=vt.resolveProperty(this.object,this.attributeArguments[0]);f[g]=this.lastUIValue}this.views.push(this.lastUIValue)}}else if(t!==this.lastValue){const i=this.toUI!==!0?this.toUI(t,this.lastValue,this.property,this.object,this.value):t;if(i!==void 0&&i!==this.lastUIValue){const{target:n,property:o}=vt.resolveProperty(this.element,this.attribute);n[o]=i,"setAttribute"in this.element&&this.element.setAttribute(this.attribute,i),this.lastValue=t,this.lastUIValue=i}}this.updateViews()}updateAtEvents(){let t=this.events.shift();for(;t!=null;)vt.resolveValue(this.object,this.property).call(this.object.$model,t,this.object.$model,this.element,this.attribute,this.object),t=this.events.shift();this.views.forEach(i=>i.updateAtEvents())}updateMove(){this.views.forEach(t=>t.updateMove())}updateViews(t,i){t==null?this.views.forEach(n=>n.updateToUI()):(this.views.forEach((n,o)=>{const h=i[o];typeof h=="object"&&(h.$index=o),n.model.$model[this.attribute]=h,n.model.$index=o,n.updateToUI()}),this.lastValue=[...t],this.lastUIValue=[...i]),this.oneTime&&(this.toUI=!1,this.fromUI=!1)}}var $h;class Be{static initialize(t=!0){if(!this.initialized&&(this.initialized=!0,this.initializeLoadPromise(),t!==!1)){if(t===!0){const i=()=>{this.update(),requestAnimationFrame(i)};requestAnimationFrame(i);return}setInterval(()=>this.update(),1e3/t)}}static import(t){this.initializeLoadPromise(),document.body.insertAdjacentHTML("afterbegin",`<object type="text/pui" data="${t}"></object>`)}static ready(){return this.initialize(),this.loadPromise.then(()=>(this.hoist()&&document.head.insertAdjacentHTML("beforeend",'<style> object[type="text/pui"] { height: 0; position: absolute; } </style>'),this.registrations))}static create(t=document.body,i={},n=null,o={parent:null,prepare:!0,sibling:null}){if(typeof t=="string"&&(t=document.querySelector(t)),(typeof i=="string"||i instanceof HTMLElement)&&(console.warn("Old parameter order to UI.create!"),[i,n]=[n,i]),typeof n=="string"){const c=t?.ownerDocument?.defaultView!=null?t.ownerDocument:document;if(n.startsWith("#"))n=c.querySelector(n).cloneNode(!0);else{const f=c.createElement("template");f.innerHTML=o.prepare?this.prepare(n):n,n=f}}const h=ls.create(t,i,n,o);return h.parent===vt&&this.views.push(h),this.initialize(),h}static play(t,i){return typeof t=="string"?(t=this.globals.animations.find(n=>n.name===t).clone(),t.play(i)):t.play()}static queue(t){this.h.push(t),this.initialize()}static register(t,i){if(typeof t=="string"){this.registrations[t]=i;return}this.registerWebComponent(i,t)}static parse(t,i,n,o){const h=[];if(t instanceof Comment)return[];if(t instanceof HTMLTemplateElement||t.tagName==="TEMPLATE")return[];if(t.nodeType===3){let c=t.textContent,f=c.match(this.regexValue);for(;f!=null;){const g=f[1];let v=f[2];c=f[3];let x=!1;v.startsWith("|")&&(x=!0,v=v.slice(1).trimStart());const b=v.match(this.regexConditionalValue);let T,P=!0;if(v.startsWith("(")){const F=`_pui${this.bindingCounter++}`;Object.defineProperty(i,F,{get:new Function(`return ${v}`)}),v=F}else b&&(v=b[3],T=`${b[2]}${b[1]}`,P=function(F,R,S,M,W){const U=W[0]==="=";return W=W.slice(2,-1),!!F===U?W:""});let I=t.cloneNode();t.textContent=g,this.parentElement(t,o).insertBefore(I,t.nextSibling),h.push(this.bind({selector:I,attribute:"textContent",object:i,property:v,parent:n,oneTime:x,value:T,toUI:P})),t=I,I=t.cloneNode(),I.textContent=c,this.parentElement(t,o).insertBefore(I,t.nextSibling),t=I,f=c.match(this.regexValue)}}else{const c=t.getAttribute("pui")??"";if(c.trim().length>0){const f=c.split(";");for(let g of f)g=g.trim(),g.length>0&&t.setAttribute(`pui.${this.bindingCounter++}`,g)}if(t.removeAttribute("pui"),h.push(...Object.keys(t.attributes??[]).reverse().map(f=>{const g=[];if(t instanceof Comment)return[];const v=t.attributes[f];if(v.name.startsWith("pui.")){const P=v.value.match(this.regexAttribute);let[I,F,R,S,M]=P,W,U,V=!1;if(R!=="@"){const j=F.match(/^'(.*?)'$/);if(j!=null)W=j[1],t.setAttribute("value",W),F=t.nodeName.toLowerCase()==="option"?"selected":"checked",S=q=>q?W:void 0,R=q=>q===W;else if(F==="")if(S===">"){const[q,nt]=M.split(":");if(q.length>0){const{target:ht,property:xt}=this.resolveProperty(i,q);ht[xt]=t}return(nt??"").length>0&&vt.queue(()=>{const{target:ht,property:xt}=this.resolveProperty(i,nt);ht[xt]=n}),[]}else({element:t,template:U}=this.replaceWithComment(t,n,o,v.name)),F=R==="=",R=!0,S==="|"&&(V=!0);else if(S==="="&&R==="="){if(!t.tagName.includes("-")){t.setAttribute("pui-unrendered","");const q=this.parentNode(t,o);q.nodeType!==8?{element:t,template:U}=this.replaceWithComment(t,n,o,v.name,U):t=q}U=F,R=!0}else S==="*"?{element:t,template:U}=this.replaceWithComment(t,n,o,v.name):S==="|"?V=!0:F!=="checked"&&t.setAttribute(F,t.getAttribute?.(F)??"")}return[this.bind({selector:t,attribute:F,value:W,object:i,property:M,template:U,toUI:typeof R=="string"?R==="<":R,fromUI:typeof S=="string"?S===">":S,atEvent:R==="@",parent:n,oneTime:V})]}const x=[v.value];let b=0,T=x[b].match(this.regexValue);for(;T!=null;){let{before:P,property:I,after:F}=T.groups,R=!1;I.startsWith("|")&&(R=!0,I=I.slice(1).trimStart());const S=I.match(this.regexConditionalValue);let M;S&&(I=S[3],M=`${S[2]}${S[1]}`),g.push(this.bind({selector:t,attribute:v.name,object:i,property:I,oneTime:R,toUI(W,U,V,j,q){if(this.oneTime){const ht=x.indexOf(V);ht>-1&&(x[ht]=vt.resolveValue(j,V),x[ht-1]+=x[ht]+x[ht+1],x.splice(ht,2))}const nt=x.map((ht,xt)=>{if(xt%2===0)return ht;const gt=ht.match(vt.regexSplitConditionalValue);if(gt){const yt=ht===`${V}${q}`?W:vt.resolveValue(j,gt[1]),St=gt[2]==="=";return!!yt===St?gt[3].slice(1,-1):""}return ht===V?W:vt.resolveValue(j,ht)}).join("");return t.setAttribute(v.name,nt),nt},parent:n,value:M})),x[b++]=P,x[b++]=`${I}${M??""}`,x[b]=F,T=x[b].match(this.regexValue)}return g}).flat()),t instanceof Comment)return h.filter(f=>f.template!=null?!0:(f.unbind(),!1));if(!this.leaveAttributes)for(let f=Object.keys(t.attributes??[]).length-1;f>=0;f--){const g=t.attributes[Object.keys(t.attributes??[])[f]];g.name.startsWith("pui.")&&t.removeAttribute(g.name)}h.push(...Array.from(t.childNodes).map(f=>this.parse(f,i,n,o)).flat())}return h}static bind(t){return wl.create(t)}static unbind(t){if(t.destroy(),t.parent!==vt){const i=t.parent.bindings,n=i.indexOf(t);n>-1&&i.splice(n,1)}}static update(){this.u.forEach(i=>i()),this.u=this.h,this.h=[],this.views.forEach(i=>i.updateToUI()),this.views.forEach(i=>i.updateFromUI()),this.views.forEach(i=>i.updateAtEvents());const t=performance.now();[...this.views,this.globals].forEach(i=>i.updateAnimations(t)),this.views.forEach(i=>{i.updateMove()});for(let i=0;i<this.destroyed.length;i++){const n=this.destroyed[i];switch(n.destroyed){case"queue":n.state==="rendered"?n.destroyed="destroy":n.updateToUI();break;case"destroy":{n.terminate();const o=this.destroyed.findIndex(h=>n===h);o>-1&&(this.destroyed.splice(o,1),i--)}}}}static resolveProperty(t,i){i=i.replace("[",".").replace("]",".");const n=i.split(".").filter(h=>(h??"").length>0);for(;n[0]==="$parent"&&t.$parent!=null;)t=t.$parent,n.shift();let o=t;if(n[0]==="$index"&&this.objectHas(o,"$index"))return{target:o,property:n[0]};for(this.objectHas(o,"$model")&&(o=t.$model);n.length>1;)o=o[n.shift()];return{target:o,property:n[0]}}static resolveValue(t,i){let n=0;do{const{target:o,property:h}=this.resolveProperty(t,i);if(o!=null&&this.objectHas(o,h))return o[h];t=t.$parent}while(t!=null&&n++<1e3);if(i in this.registrations)return this.registrations[i]}static initializeLoadPromise(){this.loadPromise==null&&(this.loadPromise=new Promise(t=>this.loadResolve=t),document.defaultView?.addEventListener("load",this.loaded))}static hoist(t=document,i=document){t!==i&&((i.querySelectorAll("style")??[]).forEach(h=>{t.head.appendChild(h.cloneNode(!0))}),(i.querySelectorAll("template")??[]).forEach(h=>{t.head.appendChild(h.cloneNode(!0))}));const n=i.querySelectorAll('object[type="text/pui"]')??[];let o=n.length>0;return n.forEach(h=>{o=this.hoist(t,h.contentDocument)||o}),o}static objectHas(t,i){try{return i in t}catch{return!1}}static replaceWithComment(t,i,n,o,h){const c=document.createComment(o);return this.parentNode(t,n).insertBefore(c,t),this.parentNode(t,n).removeChild(t),t.removeAttribute(o),h=h??t,t=c,t.parentNode instanceof DocumentFragment&&(i.element=t),{element:t,template:h}}static parentElement(t,i){const n=t.parentElement;if(n!=null)return n;for(;i!=null&&(i.element==null||i.element===t);)i=i.parent;return i?.element}static parentNode(t,i){const n=t.parentNode;if(n!=null)return n;for(;i!=null&&(i.element==null||i.element===t);)i=i.parent;return i?.element}static prepare(t){let i=t;t="";let n=i.match(this.regexReplace);for(;n!=null;){const[o,h,c,f]=n;c.match(/\S\s*===/)?t+=`${h.trimEnd()}br PUI.${this.bindingCounter++}="${c}"`:t+=`${h} PUI.${this.bindingCounter++}="${c}" `,i=f,n=i.match(this.regexReplace)}return t+=i,t}static parseAttribute(t,i,n,o,h,c){const f=c.match(this.regexAttribute);let[g,v,x,b,T]=f,P,I,F=!1;if(x!=="@"){const R=v.match(/^'(.*?)'$/);if(R!=null)P=R[1],t.setAttribute("value",P),v=t.nodeName.toLowerCase()==="option"?"selected":"checked",b=S=>S?P:void 0,x=S=>S===P;else if(v==="")if(b===">"){const{target:S,property:M}=this.resolveProperty(i,T);return S[M]=t,[]}else({element:t,template:I}=this.replaceWithComment(t,n,o,h)),v=x==="=",x=!0,b==="|"&&(F=!0);else if(b==="="&&x==="="){const S=this.parentNode(t,o);S.nodeType!==8?{element:t,template:I}=this.replaceWithComment(t,n,o,h,I):t=S,I=v,F=!0,x=!0}else b==="*"?{element:t,template:I}=this.replaceWithComment(t,n,o,h):b==="|"?F=!0:v!=="checked"&&t.setAttribute(v,"")}return[this.bind({selector:t,attribute:v,value:P,object:i,property:T,template:I,toUI:typeof x=="string"?x==="<":x,fromUI:typeof b=="string"?b===">":b,atEvent:x==="@",parent:n,oneTime:F})]}static registerWebComponent(t,i){t??(t=i.webComponent);class n extends HTMLElement{constructor(){super(),this.webComponentComponent=i,this.webComponentUIView=null,this.attachShadow({mode:"open"})}connectedCallback(){this.initialize()}disconnectedCallback(){this.terminate()}attributeChangedCallback(c,f,g){this.initialize(),this.webComponentUIView.model[c]=g}initialize(){if(this.webComponentUIView==null){const c="create"in this.webComponentComponent?this.webComponentComponent.create():new this.webComponentComponent;c.webComponentHost=this,this.webComponentUIView=vt.create(this.shadowRoot,c,this.webComponentComponent.template,{host:this.shadowRoot?.host})}}terminate(){this.webComponentUIView!=null&&this.webComponentUIView.destroy()}}n.observedAttributes=i.observedAttributes??[],n.observedProperties=i.observedProperties??n.observedAttributes;const o=[...new Set([...n.observedAttributes,...n.observedProperties])];for(const h of o)Object.defineProperty(n.prototype,h,{configurable:!0,enumerable:!1,get(){return this.webComponentUIView.model[h]},set(c){n.observedAttributes.includes(h)?this.setAttribute(h,c):(this.initialize(),this.webComponentUIView.model[h]=c)}});return customElements.define(t,n),n}}$h=Be;Be.initialized=!1;Be.id=0;Be.views=[];Be.destroyed=[];Be.globals=new ls;Be.registrations={};Be.leaveAttributes=!1;Be.regexReplace=/([\S\s]*?)\\?\$\{([^}]*?[<=@!]=[*=>|][^}]*?)\}([\S\s]*)/m;Be.regexAttribute=/^\s*(\S*?)\s*([<=@!])=([*=>|])\s*(\S*?)\s*$/;Be.regexValue=/(?<before>[\S\s]*?)\\?\$\{\s*(?<property>[\s\S]*?)\s*\}(?<after>[\S\s]*)/m;Be.regexConditionalValue=/^\s*(.+?)\s*([=!])\s*(\S+)/;Be.regexSplitConditionalValue=/^(.+?)([=!])(.*)/;Be.bindingCounter=0;Be.u=[];Be.h=[];Be.loaded=()=>{$h.loadResolve(),document.defaultView?.removeEventListener("load",$h.loaded)};function Sg(){let d=window,t=window;for(;;)try{if(d.parent===d){t=d;break}else d.parent.UI!=="guarantee-condition-always-true"&&(d=d.parent)}catch{break}return t}const Qh=Sg();"UI"in Qh||(Qh.UI=Be);const vt=Qh.UI;/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var Eg={851:(d,t,i)=>{i.d(t,{A:()=>g});var n=i(1),o=i.n(n),h=i(935),c=i.n(h),f=c()(o());f.push([d.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const g=f},296:(d,t,i)=>{i.d(t,{A:()=>g});var n=i(1),o=i.n(n),h=i(935),c=i.n(h),f=c()(o());f.push([d.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const g=f},935:d=>{d.exports=function(t){var i=[];return i.toString=function(){return this.map(function(o){var h="",c=typeof o[5]<"u";return o[4]&&(h+="@supports (".concat(o[4],") {")),o[2]&&(h+="@media ".concat(o[2]," {")),c&&(h+="@layer".concat(o[5].length>0?" ".concat(o[5]):""," {")),h+=t(o),c&&(h+="}"),o[2]&&(h+="}"),o[4]&&(h+="}"),h}).join("")},i.i=function(o,h,c,f,g){typeof o=="string"&&(o=[[null,o,void 0]]);var v={};if(c)for(var x=0;x<this.length;x++){var b=this[x][0];b!=null&&(v[b]=!0)}for(var T=0;T<o.length;T++){var P=[].concat(o[T]);c&&v[P[0]]||(typeof g<"u"&&(typeof P[5]>"u"||(P[1]="@layer".concat(P[5].length>0?" ".concat(P[5]):""," {").concat(P[1],"}")),P[5]=g),h&&(P[2]&&(P[1]="@media ".concat(P[2]," {").concat(P[1],"}")),P[2]=h),f&&(P[4]?(P[1]="@supports (".concat(P[4],") {").concat(P[1],"}"),P[4]=f):P[4]="".concat(f)),i.push(P))}},i}},1:d=>{d.exports=function(t){var i=t[1],n=t[3];if(!n)return i;if(typeof btoa=="function"){var o=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),h="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(o),c="/*# ".concat(h," */");return[i].concat([c]).join(`
`)}return[i].join(`
`)}}},pu={};function Te(d){var t=pu[d];if(t!==void 0)return t.exports;var i=pu[d]={id:d,exports:{}};return Eg[d](i,i.exports,Te),i.exports}Te.n=d=>{var t=d&&d.__esModule?()=>d.default:()=>d;return Te.d(t,{a:t}),t};Te.d=(d,t)=>{for(var i in t)Te.o(t,i)&&!Te.o(d,i)&&Object.defineProperty(d,i,{enumerable:!0,get:t[i]})};Te.o=(d,t)=>Object.prototype.hasOwnProperty.call(d,t);Te.r=d=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(d,"__esModule",{value:!0})};var C={};Te.d(C,{eKr:()=>Ql,yVm:()=>Nr,a7j:()=>Qu,U_w:()=>wc,JF2:()=>$l,htg:()=>Mn,HXL:()=>_c,mcg:()=>Vl,Agj:()=>Ze,J3_:()=>zm,Wgv:()=>Kl,u6S:()=>_m,x7M:()=>_e,X55:()=>Ti,m3M:()=>wr,aE5:()=>lm,YJU:()=>Ai,eZi:()=>dl,GNv:()=>yr,Y56:()=>fl,_0v:()=>Qo,vhs:()=>Wo,vrQ:()=>Wr,Z8b:()=>w_,Yfw:()=>Ct,IcQ:()=>lt,kgJ:()=>gl,GTT:()=>J_,ypY:()=>Er,i7d:()=>k_,fQ3:()=>Wm,HlI:()=>na,jlt:()=>oa,VQc:()=>He,zD7:()=>mc,AUF:()=>qi,JoF:()=>Us,MlA:()=>fe,PZh:()=>Js,qA:()=>br,CrD:()=>fs,dQK:()=>Vi,D3r:()=>Ei,Qpo:()=>jo,D9n:()=>Yo,b6v:()=>xr,mvh:()=>ca,Bpo:()=>ut,Q1f:()=>K,IKv:()=>Q_,fcV:()=>rn,Glf:()=>$_,uAl:()=>fi,ElT:()=>Ce,Z8r:()=>Cl,QSL:()=>N_,sPV:()=>Xo,nAn:()=>ps,zCU:()=>qo,QrV:()=>Me,fF9:()=>bv,Jqv:()=>T_,d_u:()=>C_,xI8:()=>ql,yar:()=>Ae,SP7:()=>K_,oRy:()=>ha,f5X:()=>cc,V1c:()=>Tl,Mlx:()=>tf,ZiM:()=>ml,ZCo:()=>Ar,J5p:()=>ef,mL_:()=>ti,Guw:()=>b_,N5j:()=>Zu,pgY:()=>y_,OP3:()=>Go,rl5:()=>of,eod:()=>$m,q5Z:()=>ye,YUC:()=>ic,saR:()=>$o,hvr:()=>vl,Qol:()=>v_,Wf4:()=>m_,JCs:()=>Wt,gJV:()=>oi,fWD:()=>M_,Va_:()=>Ms,N$8:()=>Je,_jQ:()=>Qm,rxj:()=>jl,rhv:()=>Yl,wCu:()=>We,HAp:()=>mm,Zy1:()=>U_,bkB:()=>Zt,wfL:()=>Vo,sVA:()=>yl,$Gs:()=>tc,CJ0:()=>Zo,NWh:()=>ds,tWi:()=>Zl,xAj:()=>Xl,zWh:()=>x_,i_4:()=>xv,iIx:()=>Ie,Hxo:()=>A_,c9e:()=>ll,KQV:()=>hn,weH:()=>Lt,jXp:()=>vv,zzY:()=>No,yRQ:()=>Ho,MtE:()=>sf,rPj:()=>Rr,KLc:()=>di,Fir:()=>wt,V5f:()=>Rl,Xj7:()=>Dl,Wud:()=>ko,FVg:()=>Wl,g5Y:()=>Ol,YQB:()=>zl,KPb:()=>Hl,nHK:()=>ua,Jrb:()=>lf,TX_:()=>gv,Olt:()=>uf,r3n:()=>Ln,Fvk:()=>ev,gpR:()=>Ko,vYh:()=>ie,hnk:()=>se,D2R:()=>Bn,n1o:()=>lc,h9O:()=>G_,X5j:()=>Ni,p3P:()=>dc,RLG:()=>Gl,fBU:()=>nc,Adb:()=>pe,bEs:()=>Gi,wCy:()=>It,CbD:()=>Yt,x_C:()=>Vn,pGf:()=>gc,ibQ:()=>q_,shR:()=>Sr,Yjk:()=>fc,_u1:()=>iv,OBI:()=>cf,klh:()=>mr,s3S:()=>Y_,D$R:()=>Ir,xth:()=>ia,JU7:()=>Km,h9x:()=>B_,N1A:()=>xc,e_k:()=>ae,aHM:()=>dn,tlv:()=>Sm,Vi9:()=>D_,ieR:()=>R_,$bb:()=>ge,VyI:()=>ct,imn:()=>Gu,uqu:()=>ri,QnL:()=>Kh,vnc:()=>ec,wk_:()=>cl,GH0:()=>Mt,_1r:()=>la,l0X:()=>al,bT:()=>n_,HHX:()=>hl,jtW:()=>o_,tjk:()=>Is,rWe:()=>Ks,j9l:()=>Yu,l0$:()=>yc,sGJ:()=>hs,NVp:()=>rc,cPK:()=>Ye,XoL:()=>pc,RmF:()=>je,DXI:()=>aa,tCD:()=>sv,J3D:()=>sa,vCJ:()=>Jm,e6k:()=>qu,f9l:()=>Ri,v9m:()=>fa,yRJ:()=>V_,EU6:()=>pl,m3O:()=>os,Ryz:()=>Fs,OxP:()=>vr,LEs:()=>_a,Ec:()=>an,Pi5:()=>da,gmH:()=>as,tS:()=>bc,XxX:()=>Re,bCz:()=>ea,nYS:()=>cn,yiT:()=>kl,NHl:()=>Gn,mO8:()=>Ul,PXI:()=>Il,bn5:()=>Fl,Ywr:()=>Ls,cMd:()=>ln,Bs6:()=>Bl,G0k:()=>Nn,pyn:()=>Ll,QeM:()=>El,aPX:()=>Xm,ITP:()=>Ml,BY0:()=>ks,MFw:()=>zr,sBn:()=>Lr,S3L:()=>Rn,XKQ:()=>Tr,ESI:()=>z_,uxz:()=>F_,o8N:()=>zn,u_r:()=>Wn,RlV:()=>tn,gVA:()=>ul,M_G:()=>Hr,BpG:()=>Jl,GRB:()=>pm,kM6:()=>Ku,dO8:()=>Ju,jgM:()=>sl,FWq:()=>Br,s3j:()=>Lg,hlw:()=>c_,L0q:()=>l_,B7e:()=>h_,PGN:()=>a_,H_X:()=>ee,S_d:()=>g_,_Tq:()=>p_,U7E:()=>__,IOH:()=>u_,Z58:()=>ci,yh2:()=>Ym,ff$:()=>nl,cWi:()=>Fu,NBt:()=>ac,oNz:()=>Am,QlU:()=>Z_,Xey:()=>Ds,jft:()=>Pv,_r8:()=>ue,bTC:()=>$u,Mtr:()=>ei,ypk:()=>Oe,mnM:()=>Ut,q7S:()=>yv,bAZ:()=>Cr,ABN:()=>ju,VK6:()=>Pm,Hj2:()=>uc,Df8:()=>_l,oOx:()=>kn,kxk:()=>Si,DT1:()=>ta,FLG:()=>en,qN_:()=>vc,Z37:()=>ra,FtL:()=>I_,Z6X:()=>df,iQT:()=>ui,ziO:()=>O_,OEF:()=>ji,uuE:()=>ai,tiv:()=>Pr,T$Y:()=>nf,EYj:()=>Ur,nOB:()=>Oo,Tap:()=>te,FAs:()=>E_,B_P:()=>S_,aA5:()=>Om,J3s:()=>Ac,Y0Q:()=>kr,M4G:()=>nn,l$l:()=>rf,dLy:()=>_s,WZP:()=>st,eB6:()=>pa,nFK:()=>ol,l9z:()=>L_,YOF:()=>Nm,yhB:()=>me,J0N:()=>Al,Miz:()=>k,Bj4:()=>tl,Rcs:()=>Xi,vJ4:()=>ms,TqC:()=>sc,nM0:()=>Nl,X1u:()=>sn,SpZ:()=>Xu,DX8:()=>Fn,Yx$:()=>j_,HK4:()=>W_,yt5:()=>Du,vAR:()=>tv,SE$:()=>cs,qE8:()=>bt,Pz7:()=>_f,sX_:()=>on,JuI:()=>Ig,pxT:()=>us,Nl$:()=>Sl,zDr:()=>uv,OwT:()=>av,P$G:()=>dv,mHV:()=>lv,kEA:()=>_v,Fx_:()=>pv,WFC:()=>fv,vKu:()=>rv,aDq:()=>nv,jIg:()=>cv,UH3:()=>hv,AJO:()=>ov,U4:()=>e_,xAc:()=>i_,_3Y:()=>Um,K6X:()=>fm,C1Y:()=>Vu,Aw1:()=>rl,tm8:()=>s_,LBV:()=>r_,A8$:()=>gm,F5e:()=>Lm,ran:()=>km,c8L:()=>f_,o6M:()=>d_,hsx:()=>Oi,l9E:()=>P_,aSf:()=>H_,CcK:()=>t_,nU8:()=>oc,td6:()=>Or,Zex:()=>ff,bkJ:()=>zt,mXP:()=>Cv,vt$:()=>On,hCA:()=>Ii,pjR:()=>pt,U43:()=>Wi,pSZ:()=>Mg,y17:()=>Dg,Ew7:()=>Yi,hG1:()=>Bm,jVr:()=>Av,_SZ:()=>Nt,xWn:()=>Mu,ehJ:()=>Rg,t6s:()=>G,Eyn:()=>xl});var xl={};Te.r(xl);Te.d(xl,{getAttributeComponentSize:()=>Wu,getAttributePointerType:()=>Nu,getGLTypeFromSource:()=>Ou,getGlTypeSizeBytes:()=>Jh,getMaxShaderComplexity:()=>Pl,isAttributeInSource:()=>Hu});var bl={};Te.r(bl);Te.d(bl,{circle:()=>um,line:()=>el,point:()=>cm,roundRect:()=>il,vector:()=>dm});var yl={};Te.r(yl);Te.d(yl,{ActionCompleteEvent:()=>Ql,ActionStartEvent:()=>$l,ActivateEvent:()=>Vl,AddEvent:()=>Kl,CollisionEndEvent:()=>br,CollisionPostSolveEvent:()=>jo,CollisionPreSolveEvent:()=>Yo,CollisionStartEvent:()=>xr,ContactEndEvent:()=>Xo,ContactStartEvent:()=>qo,DeactivateEvent:()=>ql,EnterTriggerEvent:()=>jl,EnterViewPortEvent:()=>Yl,EventTypes:()=>Vo,ExitTriggerEvent:()=>Zl,ExitViewPortEvent:()=>Xl,GameEvent:()=>wt,GameStartEvent:()=>Rl,GameStopEvent:()=>Dl,GamepadAxisEvent:()=>Wl,GamepadButtonEvent:()=>Ol,GamepadConnectEvent:()=>zl,GamepadDisconnectEvent:()=>Hl,HiddenEvent:()=>Gl,InitializeEvent:()=>Vn,KillEvent:()=>ia,PostCollisionEvent:()=>cn,PostDebugDrawEvent:()=>kl,PostDrawEvent:()=>Gn,PostFrameEvent:()=>Ul,PostKillEvent:()=>Il,PostTransformDrawEvent:()=>Fl,PostUpdateEvent:()=>Ls,PreCollisionEvent:()=>ln,PreDebugDrawEvent:()=>Bl,PreDrawEvent:()=>Nn,PreFrameEvent:()=>Ll,PreKillEvent:()=>El,PreTransformDrawEvent:()=>Ml,PreUpdateEvent:()=>ks,RemoveEvent:()=>Jl,VisibleEvent:()=>Nl});var Al={};Te.r(Al);Te.d(Al,{ConsoleAppender:()=>Cl,DrawUtil:()=>bl,EasingFunctions:()=>Wt,LogLevel:()=>ge,Logger:()=>ct,Observable:()=>Ye,ScreenAppender:()=>Fu,addItemToArray:()=>Fg,contains:()=>Bu,delay:()=>Uo,fail:()=>ku,getPosition:()=>gr,isObject:()=>Bo,mergeDeep:()=>zo,omit:()=>Lu,removeItemFromArray:()=>Hn});function Ru(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(d){window.setInterval(d,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const t=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(i){return new Promise((n,o)=>{t.call(this,i,n,o)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(d){const t=Date.now();return setTimeout(function(){d({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(d){clearTimeout(d)})}class Ie{static useCanvasGraphicsContext(){Ie.enable("use-canvas-context")}static useLegacyImageRenderer(){Ie.enable("use-legacy-image-renderer")}static freeze(){Ie._FROZEN=!0}static _reset(){Ie._FROZEN=!1,Ie._FLAGS={}}static enable(t){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");Ie._FLAGS[t]=!0}static disable(t){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");Ie._FLAGS[t]=!1}static isEnabled(t){return!!Ie._FLAGS[t]}static show(){return Object.keys(Ie._FLAGS)}}Ie._FROZEN=!1;Ie._FLAGS={};function on(d,t){return{type:d,value:t}}class di{constructor(){this._isCompleted=!1,this.promise=new Promise((t,i)=>{this._resolver=t,this._rejecter=i})}get isCompleted(){return this._isCompleted}resolve(t){this._isCompleted||(this._isCompleted=!0,this._resolver(t))}reject(t){this._isCompleted||(this._isCompleted=!0,this._rejecter(t))}}class Zt{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(t,i){var n;return this._empty=!1,this._listeners[t]=(n=this._listeners[t])!==null&&n!==void 0?n:[],this._listeners[t].push(i),{close:()=>this.off(t,i)}}once(t,i){var n;return this._empty=!1,this._listenersOnce[t]=(n=this._listenersOnce[t])!==null&&n!==void 0?n:[],this._listenersOnce[t].push(i),{close:()=>this.off(t,i)}}off(t,i){var n,o;if(i){const h=(n=this._listeners[t])===null||n===void 0?void 0:n.filter(f=>f!==i);this._listeners[t]=h;const c=(o=this._listenersOnce[t])===null||o===void 0?void 0:o.filter(f=>f!==i);this._listenersOnce[t]=c}else delete this._listeners[t]}emit(t,i){if(this._empty||this._paused)return;const n=this._listeners[t];if(n)for(let h=0;h<n.length;h++)n[h](i);const o=this._listenersOnce[t];if(this._listenersOnce[t]=[],o)for(let h=0;h<o.length;h++)o[h](i);for(let h=0;h<this._pipes.length;h++)this._pipes[h].emit(t,i)}pipe(t){if(this===t)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(t),{close:()=>{const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}}}unpipe(t){const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var an;(function(d){d.Canvas="Canvas",d.Document="Document"})(an||(an={}));var ee;(function(d){d.ShortestPath="shortest-path",d.LongestPath="longest-path",d.Clockwise="clockwise",d.CounterClockwise="counter-clockwise"})(ee||(ee={}));const Oh=4294967295;class zn{constructor(t){this.seed=t,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(t||Date.now())>>>0;for(let i=1;i<this._n;i++){const n=this._mt[i-1]^this._mt[i-1]>>>this._w-2;this._mt[i]=(this._f*((n&4294901760)>>>16)<<16)+this._f*(n&65535)+i>>>0}this._index=this._n}_twist(){const t=[0,this._a];let i=0,n=0;for(;n<this._n-this._m;n++)i=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+this._m]^i>>>1^t[i&1]&Oh;for(;n<this._n-1;n++)i=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+(this._m-this._n)]^i>>>1^t[i&1]&Oh;i=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^i>>>1^t[i&1]&Oh,this._index=0}nextInt(){this._index>=this._n&&this._twist();let t=this._mt[this._index++];return t^=t>>>this._u,t^=t<<this._s&this._b,t^=t<<this._t&this._c,t^=t>>>this._l,t>>>0}next(){return this.nextInt()*(1/4294967296)}floating(t,i){return(i-t)*this.next()+t}integer(t,i){return Math.floor((i-t+1)*this.next()+t)}bool(t=.5){return this.next()<=t}pickOne(t){return t[this.integer(0,t.length-1)]}pickSet(t,i,n=!1){return n?this._pickSetWithDuplicates(t,i):this._pickSetWithoutDuplicates(t,i)}_pickSetWithoutDuplicates(t,i){if(i>t.length||i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(i===t.length)return t;const n=new Array(i);let o=0;const h=t.slice(0);for(;o<i;){const c=this.integer(0,h.length-1);n[o++]=h[c],h.splice(c,1)}return n}_pickSetWithDuplicates(t,i){if(i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const n=new Array(i);for(let o=0;o<i;o++)n[o]=this.pickOne(t);return n}shuffle(t){const i=t.slice(0);let n;for(let o=0;o<i.length-2;o++){const h=this.integer(o,i.length-1);n=i[o],i[o]=i[h],i[h]=n}return i}range(t,i,n){const o=new Array(t);for(let h=0;h<t;h++)o[h]=this.integer(i,n);return o}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const me=Math.PI*2;function Ig(d){return d>=0?d-Math.floor(d):d-Math.ceil(d)}function Nt(d){return d===0?0:d<0?-1:1}function bt(d,t,i){return Math.min(Math.max(t,d),i)}function Du(d,t,i){return Math.abs(d-t)<i}function cs(d){let t=d;if(d>=me)for(;t>=me;)t-=me;if(d<0)for(;t<0;)t+=me;return t}function Mu(d){return 180/Math.PI*d}function Rg(d){return d/180*Math.PI}const Dg=(d,t)=>Array.from(new Array(t-d+1),(i,n)=>n+d);function Wi(d,t,i=new zn){return i?i.floating(d,t):d+Math.random()*(t-d)}function Mg(d,t,i=new zn){return i?i.integer(d,t):Math.round(Wi(d,t))}class k{static get Zero(){return new k(0,0)}static get One(){return new k(1,1)}static get Half(){return new k(.5,.5)}static get Up(){return new k(0,-1)}static get Down(){return new k(0,1)}static get Left(){return new k(-1,0)}static get Right(){return new k(1,0)}static fromAngle(t){return new k(Math.cos(t),Math.sin(t))}static isValid(t){return!(t==null||isNaN(t.x)||isNaN(t.y)||t.x===1/0||t.y===1/0||t.x===-1/0||t.y===-1/0)}static distance(t,i){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))}static min(t,i){return new k(Math.min(t.x,i.x),Math.min(t.y,i.y))}static max(t,i){return new k(Math.max(t.x,i.x),Math.max(t.y,i.y))}constructor(t,i){this._x=0,this._y=0,this._x=t,this._y=i}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}setTo(t,i){this.x=t,this.y=i}equals(t,i=k.EQUALS_EPSILON){return Math.abs(this.x-t.x)<=i&&Math.abs(this.y-t.y)<=i}distance(t){if(!t)return Math.sqrt(this.x*this.x+this.y*this.y);const i=this.x-t.x,n=this.y-t.y;return Math.sqrt(i*i+n*n)}squareDistance(t){t||(t=k.Zero);const i=this.x-t.x,n=this.y-t.y;return i*i+n*n}clampMagnitude(t){const i=this.magnitude,n=bt(i,0,t);return this.magnitude=n,this}get size(){return this.distance()}set size(t){const i=this.normalize().scale(t);this.setTo(i.x,i.y)}get magnitude(){return this.distance()}set magnitude(t){this.normalize().scale(t,this)}normalize(){const t=this.distance();return t===0?k.Zero:new k(this.x/t,this.y/t)}average(t){return this.add(t).scale(.5)}scale(t,i){const n=i||new k(0,0);return t instanceof k?(n.x=this.x*t.x,n.y=this.y*t.y):(n.x=this.x*t,n.y=this.y*t),n}add(t,i){return i?(i.x=this.x+t.x,i.y=this.y+t.y,i):new k(this.x+t.x,this.y+t.y)}sub(t,i){const n=i||new k(0,0),o=this.x-t.x,h=this.y-t.y;return n.x=o,n.y=h,n}addEqual(t){return this.setTo(this.x+t.x,this.y+t.y),this}subEqual(t){return this.setTo(this.x-t.x,this.y-t.y),this}scaleEqual(t){return this.setTo(this.x*t,this.y*t),this}dot(t){return this.x*t.x+this.y*t.y}cross(t){if(t instanceof k)return this.x*t.y-this.y*t.x;if(typeof t=="number")return new k(t*this.y,-t*this.x)}static cross(t,i){return new k(-t*i.y,t*i.x)}perpendicular(){return new k(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return cs(Math.atan2(this.y,this.x))}angleBetween(t,i){const n=this.toAngle(),o=cs(t);let h=0,c=0;switch(o>n?h=o-n:h=(me-n+o)%me,c=(h-me)%me,i){case ee.ShortestPath:return Math.abs(h)<Math.abs(c)?h:c;case ee.LongestPath:return Math.abs(h)>Math.abs(c)?h:c;case ee.Clockwise:return h;case ee.CounterClockwise:return c}}rotate(t,i,n){const o=n||new k(0,0);i||(i=new k(0,0));const h=Math.sin(t),c=Math.cos(t),f=c*(this.x-i.x)-h*(this.y-i.y)+i.x,g=h*(this.x-i.x)+c*(this.y-i.y)+i.y;return o.x=f,o.y=g,o}clone(t){const i=t??new k(0,0);return i.x=this.x,i.y=this.y,i}toString(t){return t?`(${this.x.toFixed(t)}, ${this.y.toFixed(t)})`:`(${this.x}, ${this.y})`}}k.EQUALS_EPSILON=.001;function G(d,t){return new k(d,t)}class K{constructor(t,i,n,o){this.r=t,this.g=i,this.b=n,this.a=o??1}static fromRGB(t,i,n,o){return new K(t,i,n,o)}static fromRGBString(t){const i=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let n=null;if(n=t.match(i)){const o=parseInt(n[1],10),h=parseInt(n[2],10),c=parseInt(n[3],10);let f=1;return n[4]&&(f=parseFloat(n[4])),new K(o,h,c,f)}else throw new Error("Invalid rgb/a string: "+t)}static fromHex(t){const i=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let n=null;if(n=t.match(i)){const o=parseInt(n[1],16),h=parseInt(n[2],16),c=parseInt(n[3],16);let f=1;return n[4]&&(f=parseInt(n[4],16)/255),new K(o,h,c,f)}else throw new Error("Invalid hex string: "+t)}static fromHSL(t,i,n,o=1){return new Ci(t,i,n,o).toRGBA()}lighten(t=.1){const i=Ci.fromRGBA(this.r,this.g,this.b,this.a);return i.l+=(1-i.l)*t,i.toRGBA()}darken(t=.1){const i=Ci.fromRGBA(this.r,this.g,this.b,this.a);return i.l-=i.l*t,i.toRGBA()}saturate(t=.1){const i=Ci.fromRGBA(this.r,this.g,this.b,this.a);return i.s+=i.s*t,i.toRGBA()}desaturate(t=.1){const i=Ci.fromRGBA(this.r,this.g,this.b,this.a);return i.s-=i.s*t,i.toRGBA()}multiply(t){const i=t.r/255*this.r/255*255,n=t.g/255*this.g/255*255,o=t.b/255*this.b/255*255,h=t.a*this.a;return new K(i,n,o,h)}screen(t){const i=t.invert(),n=t.invert();return i.multiply(n).invert()}invert(){return new K(255-this.r,255-this.g,255-this.b,1-this.a)}average(t){const i=(t.r+this.r)/2,n=(t.g+this.g)/2,o=(t.b+this.b)/2,h=(t.a+this.a)/2;return new K(i,n,o,h)}equal(t){return this.toString()===t.toString()}toString(t="rgb"){switch(t){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(t){const i=Math.max(Math.round(t),0).toString(16);return i.length===1?"0"+i:i}toHex(){let t="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(t+=this._componentToHex(this.a*255)),t}toRGBA(){const t=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+t+", "+String(this.a)+")":"rgb("+t+")"}toHSLA(){return Ci.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(t){const i=t||new K(this.r,this.g,this.b,this.a);return i.r=this.r,i.g=this.g,i.b=this.b,i.a=this.a,i}static get Black(){return K.fromHex("#000000")}static get White(){return K.fromHex("#FFFFFF")}static get Gray(){return K.fromHex("#808080")}static get LightGray(){return K.fromHex("#D3D3D3")}static get DarkGray(){return K.fromHex("#A9A9A9")}static get Yellow(){return K.fromHex("#FFFF00")}static get Orange(){return K.fromHex("#FFA500")}static get Red(){return K.fromHex("#FF0000")}static get Vermilion(){return K.fromHex("#FF5B31")}static get Rose(){return K.fromHex("#FF007F")}static get Pink(){return K.fromHex("#FFC0CB")}static get Magenta(){return K.fromHex("#FF00FF")}static get Violet(){return K.fromHex("#7F00FF")}static get Purple(){return K.fromHex("#800080")}static get Blue(){return K.fromHex("#0000FF")}static get Azure(){return K.fromHex("#007FFF")}static get Cyan(){return K.fromHex("#00FFFF")}static get Viridian(){return K.fromHex("#59978F")}static get Teal(){return K.fromHex("#008080")}static get Green(){return K.fromHex("#00FF00")}static get Chartreuse(){return K.fromHex("#7FFF00")}static get Transparent(){return K.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return K.fromHex("#176BAA")}static get Brown(){return K.fromHex("#964B00")}}class Ci{constructor(t,i,n,o){this.h=t,this.s=i,this.l=n,this.a=o}static hue2rgb(t,i,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+(i-t)*6*n:n<1/2?i:n<2/3?t+(i-t)*(2/3-n)*6:t}static fromRGBA(t,i,n,o){t/=255,i/=255,n/=255;const h=Math.max(t,i,n),c=Math.min(t,i,n);let f,g;const v=(h+c)/2;if(h===c)f=g=0;else{const x=h-c;switch(g=v>.5?x/(2-h-c):x/(h+c),h){case t:f=(i-n)/x+(i<n?6:0);break;case i:f=(n-t)/x+2;break;case n:f=(t-i)/x+4;break}f/=6}return new Ci(f,g,v,o)}toRGBA(){let t,i,n;if(this.s===0)t=i=n=this.l;else{const o=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,h=2*this.l-o;t=Ci.hue2rgb(h,o,this.h+1/3),i=Ci.hue2rgb(h,o,this.h),n=Ci.hue2rgb(h,o,this.h-1/3)}return new K(t*255,i*255,n*255,this.a)}toString(){const t=this.h.toFixed(0),i=this.s.toFixed(0),n=this.l.toFixed(0),o=this.a.toFixed(0);return`hsla(${t}, ${i}, ${n}, ${o})`}}var ge;(function(d){d[d.Debug=0]="Debug",d[d.Info=1]="Info",d[d.Warn=2]="Warn",d[d.Error=3]="Error",d[d.Fatal=4]="Fatal"})(ge||(ge={}));class ct{constructor(){if(this._appenders=[],this.defaultLevel=ge.Info,this._logOnceSet=new Set,ct._INSTANCE)throw new Error("Logger is a singleton");return ct._INSTANCE=this,ct._INSTANCE.addAppender(new Cl),ct._INSTANCE}static getInstance(){return ct._INSTANCE==null&&(ct._INSTANCE=new ct),ct._INSTANCE}addAppender(t){this._appenders.push(t)}clearAppenders(){this._appenders.length=0}_log(t,i){t==null&&(t=this.defaultLevel);const n=this._appenders.length;for(let o=0;o<n;o++)t>=this.defaultLevel&&this._appenders[o].log(t,i)}_logOnce(t,i){const n=t+i.join("+");this._logOnceSet.has(n)||(this._logOnceSet.add(n),this._log(t,i))}debug(...t){this._log(ge.Debug,t)}debugOnce(...t){this._logOnce(ge.Debug,t)}info(...t){this._log(ge.Info,t)}infoOnce(...t){this._logOnce(ge.Info,t)}warn(...t){this._log(ge.Warn,t)}warnOnce(...t){this._logOnce(ge.Warn,t)}error(...t){this._log(ge.Error,t)}errorOnce(...t){this._logOnce(ge.Error,t)}fatal(...t){this._log(ge.Fatal,t)}fatalOnce(...t){this._logOnce(ge.Fatal,t)}}ct._INSTANCE=null;class Cl{log(t,i){if(!console&&!console.log&&console.warn&&console.error)return;const n=[];n.unshift.apply(n,i),n.unshift("["+ge[t]+"] : "),t<ge.Warn?console.log.apply?console.log.apply(console,n):console.log(n.join(" ")):t<ge.Error?console.warn.apply?console.warn.apply(console,n):console.warn(n.join(" ")):console.error.apply?console.error.apply(console,n):console.error(n.join(" "))}}class Fu{constructor(t){var i,n;this._messages=[],this._pos=10,this._color=K.Black,this._options=t,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(n=(i=t.zIndex)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),t.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var t,i,n,o;const h=this._options;this.canvas.width=(t=h.width)!==null&&t!==void 0?t:h.engine.screen.resolution.width,this.canvas.height=(i=h.height)!==null&&i!==void 0?i:h.engine.screen.resolution.height,this.canvas.style.position="absolute";const c=h.engine.screen.screenToPageCoordinates(G(0,0));this.canvas.style.left=c.x+"px",this.canvas.style.top=c.y+"px",this._pos=(n=h.xPos)!==null&&n!==void 0?n:this._pos,this._color=(o=h.color)!==null&&o!==void 0?o:this._color}log(t,i){const n=i.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+ge[t]+"] : "+n);let o=10;this._messages=this._messages.slice(0,1e3);for(let h=0;h<this._messages.length;h++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[h],this._pos,o),o+=10}}var Ut;(function(d){d.None="None",d.Top="Top",d.Bottom="Bottom",d.Left="Left",d.Right="Right"})(Ut||(Ut={}));(function(d){function t(n){return n===d.Top?d.Bottom:n===d.Bottom?d.Top:n===d.Left?d.Right:n===d.Right?d.Left:d.None}d.getOpposite=t;function i(n){return Math.abs(n.x)>=Math.abs(n.y)?n.x<=0?d.Left:d.Right:n.y<=0?d.Top:d.Bottom}d.fromDirection=i})(Ut||(Ut={}));class lt{constructor(t=0,i=0,n=0,o=0){this._points=[],typeof t=="object"?(this.left=t.left,this.top=t.top,this.right=t.right,this.bottom=t.bottom):typeof t=="number"&&(this.left=t,this.top=i,this.right=n,this.bottom=o)}clone(t){const i=t||new lt(0,0,0,0);return i.left=this.left,i.right=this.right,i.top=this.top,i.bottom=this.bottom,i}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(t){return t&&t?Math.abs(t.x)>Math.abs(t.y)?t.x<0?Ut.Right:Ut.Left:t.y<0?Ut.Bottom:Ut.Top:Ut.None}static fromPoints(t){let i=1/0,n=1/0,o=-1/0,h=-1/0;for(let c=0;c<t.length;c++)t[c].x<i&&(i=t[c].x),t[c].x>o&&(o=t[c].x),t[c].y<n&&(n=t[c].y),t[c].y>h&&(h=t[c].y);return new lt(i,n,o,h)}static fromDimension(t,i,n=k.Half,o=k.Zero){return new lt(-t*n.x+o.x,-i*n.y+o.y,t-t*n.x+o.x,i-i*n.y+o.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new k((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new k(this.left,this.top)}get bottomRight(){return new k(this.right,this.bottom)}get topRight(){return new k(this.right,this.top)}get bottomLeft(){return new k(this.left,this.bottom)}translate(t){return new lt(this.left+t.x,this.top+t.y,this.right+t.x,this.bottom+t.y)}rotate(t,i=k.Zero){const n=this.getPoints().map(o=>o.rotate(t,i));return lt.fromPoints(n)}scale(t,i=k.Zero){const n=this.translate(i);return new lt(n.left*t.x,n.top*t.y,n.right*t.x,n.bottom*t.y)}transform(t){const i=t.data[0]*this.left,n=t.data[1]*this.left,o=t.data[0]*this.right,h=t.data[1]*this.right,c=t.data[2]*this.top,f=t.data[3]*this.top,g=t.data[2]*this.bottom,v=t.data[3]*this.bottom,x=t.getPosition(),b=Math.min(i,o)+Math.min(c,g)+x.x,T=Math.min(n,h)+Math.min(f,v)+x.y,P=Math.max(i,o)+Math.max(c,g)+x.x,I=Math.max(n,h)+Math.max(f,v)+x.y;return new lt({left:b,top:T,right:P,bottom:I})}getPerimeter(){const t=this.width,i=this.height;return 2*(t+i)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new k(this.left,this.top)),this._points.push(new k(this.right,this.top)),this._points.push(new k(this.right,this.bottom)),this._points.push(new k(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(t,i=1/0){let n=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,c=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,f=(this.left-t.pos.x)*h,g=(this.right-t.pos.x)*h;n=Math.min(f,g),o=Math.max(f,g);const v=(this.top-t.pos.y)*c,x=(this.bottom-t.pos.y)*c;return n=Math.max(n,Math.min(v,x)),o=Math.min(o,Math.max(v,x)),o>=Math.max(0,n)&&n<i}rayCastTime(t,i=1/0){let n=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,c=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,f=(this.left-t.pos.x)*h,g=(this.right-t.pos.x)*h;n=Math.min(f,g),o=Math.max(f,g);const v=(this.top-t.pos.y)*c,x=(this.bottom-t.pos.y)*c;return n=Math.max(n,Math.min(v,x)),o=Math.min(o,Math.max(v,x)),o>=Math.max(0,n)&&n<i?n:-1}contains(t){return t instanceof k?this.left<=t.x&&this.top<=t.y&&t.y<=this.bottom&&t.x<=this.right:t instanceof lt?this.left<=t.left&&this.top<=t.top&&t.bottom<=this.bottom&&t.right<=this.right:!1}combine(t,i){const n=i||new lt(0,0,0,0),o=Math.min(this.left,t.left),h=Math.min(this.top,t.top),c=Math.max(this.right,t.right),f=Math.max(this.bottom,t.bottom);return n.left=o,n.top=h,n.right=c,n.bottom=f,n}get dimensions(){return new k(this.width,this.height)}overlaps(t,i){const n=i||0;if(t.hasZeroDimensions())return this.contains(t);if(this.hasZeroDimensions())return t.contains(this);const o=this.combine(t);return o.width+n<t.width+this.width&&o.height+n<t.height+this.height}intersect(t){const i=this.combine(t);if(i.width<t.width+this.width&&i.height<t.height+this.height&&!i.dimensions.equals(t.dimensions)&&!i.dimensions.equals(this.dimensions)){let n=0;this.right>=t.left&&this.right<=t.right?n=t.left-this.right:n=t.right-this.left;let o=0;return this.top<=t.bottom&&this.top>=t.top?o=t.bottom-this.top:o=t.top-this.bottom,Math.abs(n)<Math.abs(o)?new k(n,0):new k(0,o)}else if(i.dimensions.equals(t.dimensions)||i.dimensions.equals(this.dimensions)){let n=0;this.width-t.width>=0?this.right-t.right<=t.left-this.left?n=t.left-this.right:n=t.right-this.left:t.right-this.right<=this.left-t.left?n=this.left-t.right:n=this.right-t.left;let o=0;return this.height-t.height>=0?this.bottom-t.bottom<=t.top-this.top?o=t.top-this.bottom:o=t.bottom-this.top:t.bottom-this.bottom<=this.top-t.top?o=this.top-t.bottom:o=this.bottom-t.top,Math.abs(n)<Math.abs(o)?new k(n,0):new k(0,o)}else return null}intersectWithSide(t){const i=this.intersect(t);return lt.getSideFromIntersection(i)}draw(t,i=K.Yellow){t.debug.drawRect(this.left,this.top,this.width,this.height,{color:i})}}function gr(d){if(d&&d.getBoundingClientRect){const t=d.getBoundingClientRect();return G(t.x+window.scrollX,t.y+window.scrollY)}return k.Zero}function Fg(d,t){return t.indexOf(d)===-1?(t.push(d),!0):!1}function Hn(d,t){let i=-1;return(i=t.indexOf(d))>-1?(t.splice(i,1),!0):!1}function Bu(d,t){for(let i=0;i<d.length;i++)if(d[i]===t)return!0;return!1}function ku(d){throw new Error(d)}function Uo(d,t){var i;const n=new di;return((i=t?.schedule.bind(t))!==null&&i!==void 0?i:setTimeout)(()=>{n.resolve()},d),n.promise}function Lu(d,t){const i={};for(const n in d)t.includes(n)||(i[n]=d[n]);return i}function Bo(d){return d&&typeof d=="object"&&!Array.isArray(d)}function zo(d,...t){if(!t.length)return d;const i=t.shift();if(Bo(d)&&Bo(i))for(const n in i)Bo(i[n])?(d[n]||Object.assign(d,{[n]:{}}),zo(d[n],i[n])):Object.assign(d,{[n]:i[n]});return zo(d,...t)}var Kh;(function(d){d[d.X=12]="X",d[d.Y=13]="Y"})(Kh||(Kh={}));class ri{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(t,i,n,o,h,c){const f=new ri;return f.data[0]=2/(i-t),f.data[1]=0,f.data[2]=0,f.data[3]=0,f.data[4]=0,f.data[5]=2/(o-n),f.data[6]=0,f.data[7]=0,f.data[8]=0,f.data[9]=0,f.data[10]=-2/(c-h),f.data[11]=0,f.data[12]=-(i+t)/(i-t),f.data[13]=-(o+n)/(o-n),f.data[14]=-(c+h)/(c-h),f.data[15]=1,f}clone(t){const i=t||new ri;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i.data[6]=this.data[6],i.data[7]=this.data[7],i.data[8]=this.data[8],i.data[9]=this.data[9],i.data[10]=this.data[10],i.data[11]=this.data[11],i.data[12]=this.data[12],i.data[13]=this.data[13],i.data[14]=this.data[14],i.data[15]=this.data[15],i}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(t){const i=new ri;return i.data=t,i}static identity(){const t=new ri;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}static translation(t,i){const n=ri.identity();return n.data[12]=t,n.data[13]=i,n}static scale(t,i){const n=ri.identity();return n.data[0]=t,n.data[5]=i,n.data[10]=1,n.data[15]=1,n}static rotation(t){const i=ri.identity();return i.data[0]=Math.cos(t),i.data[4]=-Math.sin(t),i.data[1]=Math.sin(t),i.data[5]=Math.cos(t),i}multiply(t,i){if(t instanceof k){const n=i||new k(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[4]+this.data[12],c=o.x*this.data[1]+o.y*this.data[5]+this.data[13];return n.x=h,n.y=c,n}else{const n=i||new ri,o=t,h=this.data[0],c=this.data[1],f=this.data[2],g=this.data[3],v=this.data[4],x=this.data[5],b=this.data[6],T=this.data[7],P=this.data[8],I=this.data[9],F=this.data[10],R=this.data[11],S=this.data[12],M=this.data[13],W=this.data[14],U=this.data[15],V=o.data[0],j=o.data[1],q=o.data[2],nt=o.data[3],ht=o.data[4],xt=o.data[5],gt=o.data[6],yt=o.data[7],St=o.data[8],B=o.data[9],z=o.data[10],$=o.data[11],tt=o.data[12],Ht=o.data[13],ot=o.data[14],pi=o.data[15];n.data[0]=h*V+v*j+P*q+S*nt,n.data[1]=c*V+x*j+I*q+M*nt,n.data[2]=f*V+b*j+F*q+W*nt,n.data[3]=g*V+T*j+R*q+U*nt,n.data[4]=h*ht+v*xt+P*gt+S*yt,n.data[5]=c*ht+x*xt+I*gt+M*yt,n.data[6]=f*ht+b*xt+F*gt+W*yt,n.data[7]=g*ht+T*xt+R*gt+U*yt,n.data[8]=h*St+v*B+P*z+S*$,n.data[9]=c*St+x*B+I*z+M*$,n.data[10]=f*St+b*B+F*z+W*$,n.data[11]=g*St+T*B+R*z+U*$,n.data[12]=h*tt+v*Ht+P*ot+S*pi,n.data[13]=c*tt+x*Ht+I*ot+M*pi,n.data[14]=f*tt+b*Ht+F*ot+W*pi,n.data[15]=g*tt+T*Ht+R*ot+U*pi;const Zi=this.getScale();return n._scaleSignX=Nt(Zi.x)*Nt(n._scaleSignX),n._scaleSignY=Nt(Zi.y)*Nt(n._scaleSignY),n}}translate(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],f=this.data[4],g=this.data[5],v=this.data[6],x=this.data[7],b=this.data[8],T=this.data[9],P=this.data[10],I=this.data[11],F=this.data[12],R=this.data[13],S=this.data[14],M=this.data[15],W=0,U=1;return this.data[12]=n*t+f*i+b*W+F*U,this.data[13]=o*t+g*i+T*W+R*U,this.data[14]=h*t+v*i+P*W+S*U,this.data[15]=c*t+x*i+I*W+M*U,this}setPosition(t,i){this.data[12]=t,this.data[13]=i}getPosition(){return G(this.data[12],this.data[13])}rotate(t){const i=this.data[0],n=this.data[1],o=this.data[2],h=this.data[3],c=this.data[4],f=this.data[5],g=this.data[6],v=this.data[7],x=Math.sin(t),b=Math.cos(t);return this.data[0]=b*i+x*c,this.data[1]=b*n+x*f,this.data[2]=b*o+x*g,this.data[3]=b*h+x*v,this.data[4]=b*c-x*i,this.data[5]=b*f-x*n,this.data[6]=b*g-x*o,this.data[7]=b*v-x*h,this}scale(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],f=this.data[4],g=this.data[5],v=this.data[6],x=this.data[7];return this.data[0]=n*t,this.data[1]=o*t,this.data[2]=h*t,this.data[3]=c*t,this.data[4]=f*i,this.data[5]=g*i,this.data[6]=v*i,this.data[7]=x*i,this}setRotation(t){const i=this.getScale(),n=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=n*i.y,this.data[4]=-n*i.x,this.data[5]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return cs(t)}getScaleX(){const t=G(this.data[0],this.data[4]).magnitude;return this._scaleSignX*t}getScaleY(){const t=G(this.data[1],this.data[5]).magnitude;return this._scaleSignY*t}getScale(){return G(this.getScaleX(),this.getScaleY())}setScaleX(t){if(this._scaleX===t)return;this._scaleSignX=Nt(t);const i=G(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[4]=i.y*t,this._scaleX=t}setScaleY(t){if(this._scaleY===t)return;this._scaleSignY=Nt(t);const i=G(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[5]=i.y*t,this._scaleY=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(t){const n=1/this.getBasisDeterminant(),o=this.data[0],h=this.data[4],c=this.data[1],f=this.data[5],g=t||ri.identity();g.data[0]=f*n,g.data[1]=-c*n,g.data[4]=-h*n,g.data[5]=o*n;const v=this.data[12],x=this.data[13];return g.data[12]=-(v*g.data[0]+x*g.data[4]),g.data[13]=-(v*g.data[1]+x*g.data[5]),g}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class _e{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const t=new _e;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}static translation(t,i){const n=_e.identity();return n.data[4]=t,n.data[5]=i,n}static scale(t,i){const n=_e.identity();return n.data[0]=t,n.data[3]=i,n._scale[0]=t,n._scale[1]=i,n}static rotation(t){const i=_e.identity();return i.data[0]=Math.cos(t),i.data[1]=Math.sin(t),i.data[2]=-Math.sin(t),i.data[3]=Math.cos(t),i}setPosition(t,i){this.data[4]=t,this.data[5]=i}getPosition(){return G(this.data[4],this.data[5])}rotate(t){const i=this.data[0],n=this.data[1],o=this.data[2],h=this.data[3],c=Math.sin(t),f=Math.cos(t);return this.data[0]=f*i+c*o,this.data[1]=f*n+c*h,this.data[2]=f*o-c*i,this.data[3]=f*h-c*n,this}translate(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],f=this.data[4],g=this.data[5];return this.data[4]=n*t+h*i+f,this.data[5]=o*t+c*i+g,this}scale(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3];return this.data[0]=n*t,this.data[1]=o*t,this.data[2]=h*i,this.data[3]=c*i,this._scale[0]=t,this._scale[1]=i,this._scaleSignX=Nt(t),this._scaleSignY=Nt(i),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(t){const i=this.determinant();let n=i;i!==0&&(n=1/i);const o=this.data[0],h=this.data[2],c=this.data[1],f=this.data[3],g=t||_e.identity();g.data[0]=f*n,g.data[1]=-c*n,g.data[2]=-h*n,g.data[3]=o*n;const v=this.data[4],x=this.data[5];return g.data[4]=-(v*g.data[0]+x*g.data[2]),g.data[5]=-(v*g.data[1]+x*g.data[3]),g}multiply(t,i){if(t instanceof k){const n=i||new k(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[2]+this.data[4],c=o.x*this.data[1]+o.y*this.data[3]+this.data[5];return n.x=h,n.y=c,n}else{const n=i||new _e,o=t,h=this.data[0],c=this.data[1],f=this.data[2],g=this.data[3],v=this.data[4],x=this.data[5],b=o.data[0],T=o.data[1],P=o.data[2],I=o.data[3],F=o.data[4],R=o.data[5];n.data[0]=h*b+f*T,n.data[1]=c*b+g*T,n.data[2]=h*P+f*I,n.data[3]=c*P+g*I,n.data[4]=h*F+f*R+v,n.data[5]=c*F+g*R+x;const S=this._scaleSignX,M=this._scaleSignY;return n._scaleSignX=S*Nt(n._scaleSignX),n._scaleSignY=M*Nt(n._scaleSignY),n}}multiplyQuadInPlace(t){const i=t[0]*this.data[0]+t[1]*this.data[2]+this.data[4],n=t[0]*this.data[1]+t[1]*this.data[3]+this.data[5];t[0]=i,t[1]=n;const o=t[2]*this.data[0]+t[3]*this.data[2]+this.data[4],h=t[2]*this.data[1]+t[3]*this.data[3]+this.data[5];t[2]=o,t[3]=h;const c=t[4]*this.data[0]+t[5]*this.data[2]+this.data[4],f=t[4]*this.data[1]+t[5]*this.data[3]+this.data[5];t[4]=c,t[5]=f;const g=t[6]*this.data[0]+t[7]*this.data[2]+this.data[4],v=t[6]*this.data[1]+t[7]*this.data[3]+this.data[5];t[6]=g,t[7]=v}to4x4(){const t=new ri;return t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=0,t.data[3]=0,t.data[4]=this.data[2],t.data[5]=this.data[3],t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=this.data[4],t.data[13]=this.data[5],t.data[14]=0,t.data[15]=1,t}setRotation(t){const i=this.getScale(),n=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=n*i.y,this.data[2]=-n*i.x,this.data[3]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return cs(t)}getScaleX(){const t=this.data[0]*this.data[0]+this.data[2]*this.data[2];return t===1?this._scaleSignX:this._scaleSignX*Math.sqrt(t)}getScaleY(){const t=this.data[1]*this.data[1]+this.data[3]*this.data[3];return t===1?this._scaleSignY:this._scaleSignY*Math.sqrt(t)}getScale(){return G(this.getScaleX(),this.getScaleY())}setScaleX(t){if(t===this._scale[0])return;this._scaleSignX=Nt(t);const i=G(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[2]=i.y*t,this._scale[0]=t}setScaleY(t){if(t===this._scale[1])return;this._scaleSignY=Nt(t);const i=G(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[3]=i.y*t,this._scale[1]=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}clone(t){const i=t||new _e;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i._scaleSignX=this._scaleSignX,i._scaleSignY=this._scaleSignY,i}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}let Fr=class{constructor(t,i,n=1){this.builder=t,this.cleaner=i,this._pool=[],this._size=0,this.grow(n)}grow(t){if(t>0){this._size+=t;for(let i=0;i<t;i++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}};class Bg{constructor(){this._pool=new Fr(()=>_e.identity(),t=>t.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(t,i){return this._currentTransform.translate(t,i)}rotate(t){return this._currentTransform.rotate(t)}scale(t,i){return this._currentTransform.scale(t,i)}reset(){this._currentTransform.reset()}set current(t){this._currentTransform=t}get current(){return this._currentTransform}}class kg{constructor(){this.opacity=1,this.z=0,this.tint=K.White,this.material=null}}class Uu{constructor(){this._pool=new Fr(()=>new kg,t=>(t.opacity=1,t.z=0,t.tint=K.White,t.material=null,t),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(t){var i;return t.opacity=this.current.opacity,t.z=this.current.z,t.tint=(i=this.current.tint)===null||i===void 0?void 0:i.clone(),t.material=this.current.material,t}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const Lg={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class Br{constructor(t,i,n=!1){this.path=t,this.responseType=i,this.bustCache=n,this.data=null,this.logger=ct.getInstance(),this.events=new Zt}isLoaded(){return this.data!==null}_cacheBust(t){return/\?\w*=\w*/.test(t)?t+="&__="+Date.now():t+="?__="+Date.now(),t}load(){return new Promise((t,i)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),t(this.data);return}const n=new XMLHttpRequest;n.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),n.responseType=this.responseType,n.addEventListener("loadstart",o=>this.events.emit("loadstart",o)),n.addEventListener("progress",o=>this.events.emit("progress",o)),n.addEventListener("error",o=>this.events.emit("error",o)),n.addEventListener("load",o=>this.events.emit("load",o)),n.addEventListener("load",()=>{if(n.status!==0&&n.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",n.status),this.events.emit("error",n.response),i(new Error(n.statusText));return}if(n.response instanceof Blob&&n.response.type==="text/html"){const o=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",n.response),i(new Error(o));return}this.data=n.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),t(this.data)}),n.send()})}}function Pi(d,t){return d&&(d.__isProxy===void 0?new Proxy(d,{set:(i,n,o)=>(i[n]!==o&&(i[n]=o,typeof n=="string"&&n[0]!=="_"&&t(i)),!0),get:(i,n)=>n!=="__isProxy"?i[n]:!0}):d)}const zu=(d=[],t,i)=>({get:(n,o)=>o==="__isProxy"?!0:typeof n[o]=="object"&&n[o]!=null?new Proxy(n[o],zu([...d,o],t,i)):n[o],set:(n,o,h)=>(typeof o=="string"&&o[0]!=="_"&&t(i),n[o]=h,!0)});function Ug(d,t){return d&&(d.__isProxy===void 0?new Proxy(d,zu([],t,d)):d)}class ie{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(t){this._flipHorizontal=t,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(t){this._flipVertical=t,this._transformStale=!0}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._transformStale=!0}get scale(){return this._scale}set scale(t){this._scale=Pi(t,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(t){t&&(this._origin=Pi(t,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(t){var i,n,o,h,c,f,g;this.id=ie._ID++,this.transform=_e.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=k.One,this._width=0,this._height=0,t&&(this.origin=(i=t.origin)!==null&&i!==void 0?i:this.origin,this.flipHorizontal=(n=t.flipHorizontal)!==null&&n!==void 0?n:this.flipHorizontal,this.flipVertical=(o=t.flipVertical)!==null&&o!==void 0?o:this.flipVertical,this.rotation=(h=t.rotation)!==null&&h!==void 0?h:this.rotation,this.opacity=(c=t.opacity)!==null&&c!==void 0?c:this.opacity,this.scale=(f=t.scale)!==null&&f!==void 0?f:this.scale,this.tint=(g=t.tint)!==null&&g!==void 0?g:this.tint,t.width&&(this._width=t.width),t.height&&(this._height=t.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(t){this._width=t,this._transformStale=!0}set height(t){this._height=t,this._transformStale=!0}get localBounds(){return lt.fromDimension(this.width,this.height,k.Zero)}draw(t,i,n){this._preDraw(t,i,n),this._drawImage(t,0,0),this._postDraw(t)}_preDraw(t,i,n){t.save(),t.translate(i,n),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),t.multiply(this.transform),t.opacity=t.opacity*this.opacity,this.tint&&(t.tint=this.tint)}_rotate(t){var i;const n=this.scale.x>0?1:-1,o=this.scale.y>0?1:-1,h=(i=this.origin)!==null&&i!==void 0?i:G(this.width/2,this.height/2);t.translate(h.x,h.y),t.rotate(this.rotation),t.scale(n,o),t.translate(-h.x,-h.y)}_flip(t){this.flipHorizontal&&(t.translate(this.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,this.height/this.scale.y),t.scale(1,-1))}_postDraw(t){this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore()}}ie._ID=0;class Si extends ie{static from(t,i){return new Si({image:t,...i})}constructor(t){var i,n;super(t),this._logger=ct.getInstance(),this._dirty=!0,this.image=t.image;const{width:o,height:h}=t;this.sourceView=(i=t.sourceView)!==null&&i!==void 0?i:{x:0,y:0,width:o??0,height:h??0},this.destSize=(n=t.destSize)!==null&&n!==void 0?n:{width:o??0,height:h??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(t){t/=Math.abs(this.scale.x),this.destSize.width=t,super.width=Math.ceil(this.destSize.width)}set height(t){t/=Math.abs(this.scale.y),this.destSize.height=t,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var t,i,n,o,h,c;const{width:f,height:g}=this.image;this.sourceView.width=((t=this.sourceView)===null||t===void 0?void 0:t.width)||f,this.sourceView.height=((i=this.sourceView)===null||i===void 0?void 0:i.height)||g,this.destSize.width=((n=this.destSize)===null||n===void 0?void 0:n.width)||((o=this.sourceView)===null||o===void 0?void 0:o.width)||f,this.destSize.height=((h=this.destSize)===null||h===void 0?void 0:h.height)||((c=this.sourceView)===null||c===void 0?void 0:c.height)||g,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(t,i,n){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(t,i,n)}_drawImage(t,i,n){this.image.isLoaded()?t.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,i,n,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new Si({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var pe;(function(d){d.Pixel="Pixel",d.Blended="Blended"})(pe||(pe={}));function On(d){switch(d){case pe.Pixel:return pe.Pixel;case pe.Blended:return pe.Blended;default:return}}var Yt;(function(d){d.Clamp="Clamp",d.Repeat="Repeat",d.Mirror="Mirror"})(Yt||(Yt={}));function Ii(d){switch(d){case Yt.Clamp:return Yt.Clamp;case Yt.Repeat:return Yt.Repeat;case Yt.Mirror:return Yt.Mirror;default:return Yt.Clamp}}class te{constructor(t,i){var n;this._garbageCollector=i,this._textureMap=new Map,this._collect=o=>{var h;if(this._gl){const c=(h=o.dataset.originalSrc)!==null&&h!==void 0?h:o.constructor.name;return te._LOGGER.debug(`WebGL Texture for ${c} collected`),this.delete(o),!0}return!1},this._gl=t,te._MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),this._garbageCollector&&(te._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(n=this._garbageCollector.garbageCollector)===null||n===void 0||n.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[t]of this._textureMap)this.delete(t);this._textureMap.clear(),this._gl=null}get(t){return this._textureMap.get(t)}has(t){return this._textureMap.has(t)}load(t,i,n=!1){var o,h;const c=this._gl;if(!c)return null;const{filtering:f,wrapping:g}={...i};let v=null;if(this.has(t)&&(v=this.get(t)),v)return n&&(c.bindTexture(c.TEXTURE_2D,v),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t)),(o=this._garbageCollector)===null||o===void 0||o.garbageCollector.touch(t),v;v=c.createTexture(),te.checkImageSizeSupportedAndLog(t),c.bindTexture(c.TEXTURE_2D,v),c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let x;g&&(typeof g=="string"?x={x:g,y:g}:x={x:g.x,y:g.y});const{x:b,y:T}=x??te.wrapping;switch(b){case Yt.Clamp:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);break;case Yt.Repeat:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT);break;case Yt.Mirror:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.MIRRORED_REPEAT);break;default:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE)}switch(T){case Yt.Clamp:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);break;case Yt.Repeat:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT);break;case Yt.Mirror:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.MIRRORED_REPEAT);break;default:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE)}const P=f??te.filtering;return c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,P===pe.Pixel?c.NEAREST:c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,P===pe.Pixel?c.NEAREST:c.LINEAR),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t),this._textureMap.set(t,v),(h=this._garbageCollector)===null||h===void 0||h.garbageCollector.addCollectableResource("texture",t),v}delete(t){const i=this._gl;if(i&&this.has(t)){const n=this.get(t);n&&(this._textureMap.delete(t),i.deleteTexture(n))}}static checkImageSizeSupportedAndLog(t){var i;const n=(i=t.dataset.originalSrc)!==null&&i!==void 0?i:"internal canvas bitmap";return t.width>te._MAX_TEXTURE_SIZE||t.height>te._MAX_TEXTURE_SIZE?(te._LOGGER.error(`The image [${n}] provided to Excalibur is too large for the device's maximum texture size of (${te._MAX_TEXTURE_SIZE}x${te._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((t.width>4096||t.height>4096)&&te._LOGGER.warn(`The image [${n}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}te._LOGGER=ct.getInstance();te.filtering=pe.Blended;te.wrapping={x:Yt.Clamp,y:Yt.Clamp};te._MAX_TEXTURE_SIZE=4096;const It={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class Gi{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(t,i,n){this._logger=ct.getInstance(),this.data=new Image,this._readyFuture=new di,this.ready=this._readyFuture.promise,this.path=t;let o=!1,h;typeof i=="boolean"?o=i:{filtering:n,wrapping:h,bustCache:o}={...i},this._resource=new Br(t,"blob",o),this.filtering=n??this.filtering,typeof h=="string"?this.wrapping={x:h,y:h}:this.wrapping=h??this.wrapping,t.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${t} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(t,i){const n=new Gi("");if(n._src="image-element",n.data=t,n.data.setAttribute("data-original-src","image-element"),i?.filtering?n.data.setAttribute(It.Filtering,i?.filtering):n.data.setAttribute(It.Filtering,pe.Blended),i?.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},n.data.setAttribute(It.WrappingX,o.x),n.data.setAttribute(It.WrappingY,o.y)}else n.data.setAttribute(It.WrappingX,Yt.Clamp),n.data.setAttribute(It.WrappingY,Yt.Clamp);return te.checkImageSizeSupportedAndLog(t),n._readyFuture.resolve(t),n}static fromHtmlCanvasElement(t,i){const n=new Gi("");if(n._src="canvas-element-blob",n.data.setAttribute("data-original-src","canvas-element-blob"),i?.filtering?n.data.setAttribute(It.Filtering,i?.filtering):n.data.setAttribute(It.Filtering,pe.Blended),i?.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},n.data.setAttribute(It.WrappingX,o.x),n.data.setAttribute(It.WrappingY,o.y)}else n.data.setAttribute(It.WrappingX,Yt.Clamp),n.data.setAttribute(It.WrappingY,Yt.Clamp);return te.checkImageSizeSupportedAndLog(t),t.toBlob(o=>{const h=URL.createObjectURL(o);n.image.onload=()=>{URL.revokeObjectURL(h),n.data=n.image,n._readyFuture.resolve(n.image)},n.image.src=h}),n}static fromSvgString(t,i){const n=new Blob([t],{type:"image/svg+xml"}),o=URL.createObjectURL(n);return new Gi(o,i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){var t,i,n,o;if(this.isLoaded())return this.data;try{let h;if(this.path.includes("data:image/"))h=this.path;else{const g=await this._resource.load();h=URL.createObjectURL(g)}const c=new Image,f=new di;c.onload=()=>f.resolve(),c.src=h,c.setAttribute("data-original-src",this.path),await f.promise,this.data=c,te.checkImageSizeSupportedAndLog(this.data)}catch(h){throw`Error loading ImageSource from path '${this.path}' with error [${h.message}]`}return this.data.setAttribute(It.Filtering,this.filtering),this.data.setAttribute(It.WrappingX,(i=(t=this.wrapping)===null||t===void 0?void 0:t.x)!==null&&i!==void 0?i:Yt.Clamp),this.data.setAttribute(It.WrappingY,(o=(n=this.wrapping)===null||n===void 0?void 0:n.y)!==null&&o!==void 0?o:Yt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(t){return Si.from(this,t)}unload(){this.data=new Image}}class ta extends ie{constructor(t){super(t),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=ct.getInstance();const{alphabet:i,spriteSheet:n,caseInsensitive:o,spacing:h,shadow:c,lineHeight:f}=t;this.alphabet=i,this.spriteSheet=n,this.caseInsensitive=o??this.caseInsensitive,this.spacing=h??this.spacing,this.shadow=c??this.shadow,this.lineHeight=f??this.lineHeight}_getCharacterSprites(t){const i=[],n=this.caseInsensitive?t.toLocaleLowerCase():t,o=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let h=0;h<n.length;h++){const c=n[h];let f=o.indexOf(c);f===-1&&(f=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${c}' in configured alphabet '${o}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const g=this.spriteSheet.sprites[f];g?i.push(g):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${c}' at index '${f}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return i}measureText(t,i){const n=this._getLinesFromText(t,i),o=n.reduce((g,v)=>g.length>v.length?g:v),h=this._getCharacterSprites(o);let c=0,f=0;for(const g of h)c+=g.width+this.spacing,f=Math.max(f,g.height);return lt.fromDimension(c*this.scale.x,f*n.length*this.scale.y,k.Zero)}_drawImage(t,i,n,o){var h;let c=0,f=0,g=0;const v=this._getLinesFromText(this._text,o);for(const x of v){for(const b of this._getCharacterSprites(x))b.draw(t,i+c,n+f),c+=b.width+this.spacing,g=Math.max(g,b.height);c=0,f+=(h=this.lineHeight)!==null&&h!==void 0?h:g}}render(t,i,n,o,h,c){this._text=i;const f=this.measureText(i,c);this.width=f.width,this.height=f.height,this.shadow&&(t.save(),t.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(t,o,h),this._drawImage(t,0,0,c),this._postDraw(t),t.restore()),this._preDraw(t,o,h),this._drawImage(t,0,0,c),this._postDraw(t)}clone(){return new ta({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(t,i){var n;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let c=o[h],f="";if(this.measureText(c).width>i){for(;this.measureText(c).width>i;)f=c[c.length-1]+f,c=c.slice(0,-1);o[h]=c,o[h+1]=f}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class kr extends Si{constructor(t){super({image:t.image,sourceView:t.sourceView,destSize:{width:t.width,height:t.height},flipHorizontal:t.flipHorizontal,flipVertical:t.flipVertical,rotation:t.rotation,scale:t.scale,opacity:t.opacity,tint:t.tint,origin:t.origin}),this._ready=new di,this.ready=this._ready.promise,this._options=t,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(t,i){return new kr({sourceView:{...t.sourceView},width:t.width,height:t.height,...i,image:t.image})}_applyTiling(){const{width:t,height:i,filtering:n,wrapping:o}={...this._options},h=document.createElement("canvas");h.width=this.sourceView.width,h.height=this.sourceView.height,h.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const f=Gi.fromHtmlCanvasElement(h,{wrapping:o??Yt.Repeat,filtering:n});t&&(this.destSize.width=t,this.sourceView.width=t),i&&(this.destSize.height=i,this.sourceView.height=i),this.sourceView.x=0,this.sourceView.y=0,this.image=f,this.image.ready.then(()=>this._ready.resolve())}}class en{constructor(t){this.sprites=[];const{sprites:i,rows:n,columns:o}=t;this.sprites=i,this.rows=n??1,this.columns=o??this.sprites.length}getSprite(t,i,n){var o,h,c,f,g,v,x,b,T;if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const P=t+i*this.columns,I=this.sprites[P];if(I){if(n){const F=I.clone();return F.flipHorizontal=(o=n.flipHorizontal)!==null&&o!==void 0?o:F.flipHorizontal,F.flipVertical=(h=n.flipVertical)!==null&&h!==void 0?h:F.flipVertical,F.width=(c=n.width)!==null&&c!==void 0?c:F.width,F.height=(f=n.height)!==null&&f!==void 0?f:F.height,F.rotation=(g=n.rotation)!==null&&g!==void 0?g:F.rotation,F.scale=(v=n.scale)!==null&&v!==void 0?v:F.scale,F.opacity=(x=n.opacity)!==null&&x!==void 0?x:F.opacity,F.tint=(b=n.tint)!==null&&b!==void 0?b:F.tint,F.origin=(T=n.origin)!==null&&T!==void 0?T:F.origin,F}return I}throw Error(`Invalid sprite coordinates (${t}, ${i})`)}getTiledSprite(t,i,n){if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const o=t+i*this.columns,h=this.sprites[o];if(h)return kr.fromSprite(h,n);throw Error(`Invalid sprite coordinates (${t}, ${i})`)}static fromImageSourceWithSourceViews(t){const i=t.sourceViews.map(n=>new Si({image:t.image,sourceView:n}));return new en({sprites:i})}static fromImageSource(t){var i;const n=[];t.spacing=(i=t.spacing)!==null&&i!==void 0?i:{};const{image:o,grid:{rows:h,columns:c,spriteWidth:f,spriteHeight:g},spacing:{originOffset:v,margin:x}}=t,b={x:0,y:0,...v},T={x:0,y:0,...x};for(let P=0;P<c;P++)for(let I=0;I<h;I++)n[P+I*c]=new Si({image:o,sourceView:{x:P*f+T.x*P+b.x,y:I*g+T.y*I+b.y,width:f,height:g},destSize:{height:g,width:f}});return new en({sprites:n,rows:h,columns:c})}clone(){return new en({sprites:this.sprites.map(t=>t.clone()),rows:this.rows,columns:this.columns})}}const zg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class Tl{constructor(){this.fontSheet=zg,this.size=16,this.load()}load(){return this._imageSource=new Gi(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=en.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new ta({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(t,i,n){this._imageSource.isLoaded()&&this._spriteFont.render(t,i,null,n.x,n.y)}}class Hg{constructor(t,i){this._gl=t,this._texture=i}use(){const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture)}disable(){const t=this._gl;t.bindTexture(t.TEXTURE_2D,null)}}class Io{constructor(t){var i,n;this.antialias=!1,this.samples=1,this._gl=t.gl,this.width=t.width,this.height=t.height,this.transparency=t.transparency,this.antialias=(i=t.antialias)!==null&&i!==void 0?i:this.antialias,this.samples=(n=t.samples)!==null&&n!==void 0?n:this._gl.getParameter(this._gl.MAX_SAMPLES);const o=this._gl;o.drawingBufferFormat?this.bufferFormat=o.drawingBufferFormat:this.transparency?this.bufferFormat=o.RGBA8:this.bufferFormat=o.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(t,i){const n=this._gl;this.width=t,this.height=i,n.bindTexture(n.TEXTURE_2D,this._frameTexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.width,this.height,0,n.RGBA,n.UNSIGNED_BYTE,null),this._renderBuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,this._renderBuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,Math.min(this.samples,n.getParameter(n.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const t=this._gl;this._renderBuffer=t.createRenderbuffer(),this._renderFrameBuffer=t.createFramebuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._renderBuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,Math.min(this.samples,t.getParameter(t.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const t=this._gl;this._frameTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._frameTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const i=t.COLOR_ATTACHMENT0;this._frameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,i,t.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new Hg(this._gl,this._frameTexture)}blitToScreen(){const t=this._gl;this._renderBuffer?(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)):(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.frameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const t=this._gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.frameBuffer),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)}}copyToTexture(t){const i=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this._frameBuffer),i.bindTexture(i.TEXTURE_2D,t),i.copyTexImage2D(i.TEXTURE_2D,0,i.RGBA,0,0,this.width,this.height,0)}use(){const t=this._gl;this.antialias?t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.viewport(0,0,this.width,this.height)}disable(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null)}}const Og=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,Wg=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function Jh(d,t){switch(t){case d.INT:case d.UNSIGNED_INT:case d.FLOAT:return 4;case d.SHORT:return 2;case d.UNSIGNED_SHORT:return 2;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;default:return 1}}function Hu(d,t){const i=`(?<type>[a-z0-9]+)\\s+${t};`,o=new RegExp(i,"g").exec(d);return o?.length>0}function Ou(d,t,i){var n;const o=`(?<type>[a-z0-9]+)\\s+${i};`,c=new RegExp(o,"g").exec(t);switch((n=c?.groups)===null||n===void 0?void 0:n.type){case"float":case"vec2":case"vec3":case"vec4":return d.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return d.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return d.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return d.BOOL;case"short":return d.SHORT;case"ushort":return d.UNSIGNED_SHORT;case"ubyte":return d.UNSIGNED_BYTE;case"byte":return d.BYTE;default:return d.FLOAT}}function Wu(d,t){switch(t){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:return 1;case d.FLOAT_VEC2:return 2;case d.FLOAT_VEC3:return 3;case d.FLOAT_VEC4:return 4;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;case d.UNSIGNED_SHORT:case d.SHORT:return 1;default:return 1}}function Nu(d,t){switch(t){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:case d.FLOAT_VEC2:case d.FLOAT_VEC3:case d.FLOAT_VEC4:return d.FLOAT;case d.BYTE:return d.BYTE;case d.UNSIGNED_BYTE:return d.UNSIGNED_BYTE;case d.SHORT:return d.SHORT;case d.UNSIGNED_SHORT:return d.UNSIGNED_SHORT;default:return d.FLOAT}}function Pl(d,t){const i=o=>{const h=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let c="";for(let f=0;f<o;f++)f===0?c+=`if (index <= ${f}.5) {
`:c+=`   else if (index <= ${f}.5) {
`,c+=`      fragColor = vec4(1.0);
`,c+=`   }
`;return h.replace("%%complexity%%",c)};let n=!1;do{const o=i(t),h=d.createShader(d.FRAGMENT_SHADER);d.shaderSource(h,o),d.compileShader(h),n=d.getShaderParameter(h,d.COMPILE_STATUS),n||(t=t/2|0)}while(!n);return t}class ei{get compiled(){return this._compiled}constructor(t){this._logger=ct.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:i,vertexSource:n,fragmentSource:o,onPreLink:h,onPostCompile:c}=t;this._gl=i,this.vertexSource=n,this.fragmentSource=o,this._onPreLink=h,this._onPostCompile=c}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),ei._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return ei._ACTIVE_SHADER_INSTANCE===this}compile(){const t=this._gl,i=this._compileShader(t,this.vertexSource,t.VERTEX_SHADER),n=this._compileShader(t,this.fragmentSource,t.FRAGMENT_SHADER);this.program=this._createProgram(t,i,n);const o=this.getAttributes();for(const c of o)this.attributes[c.name]=c;const h=this.getUniforms();for(const c of h)this.uniforms[c.name]=c;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS),n=[];for(let o=0;o<i;o++){const h=t.getActiveUniform(this.program,o),c=t.getUniformLocation(this.program,h.name);n.push({name:h.name,glType:h.type,location:c})}return n}getAttributes(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES),n=[];for(let o=0;o<i;o++){const h=t.getActiveAttrib(this.program,o),c=t.getAttribLocation(this.program,h.name);n.push({name:h.name,glType:Nu(t,h.type),size:Wu(t,h.type),location:c,normalized:!1})}return n}setTexture(t,i){const n=this._gl;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,i)}setUniformInt(t,i){this.setUniform("uniform1i",t,~~i)}trySetUniformInt(t,i){return this.trySetUniform("uniform1i",t,~~i)}setUniformIntArray(t,i){this.setUniform("uniform1iv",t,i)}trySetUniformIntArray(t,i){return this.trySetUniform("uniform1iv",t,i)}setUniformBoolean(t,i){this.setUniform("uniform1i",t,i?1:0)}trySetUniformBoolean(t,i){return this.trySetUniform("uniform1i",t,i?1:0)}setUniformFloat(t,i){this.setUniform("uniform1f",t,i)}trySetUniformFloat(t,i){return this.trySetUniform("uniform1f",t,i)}setUniformFloatArray(t,i){this.setUniform("uniform1fv",t,i)}trySetUniformFloatArray(t,i){return this.trySetUniform("uniform1fv",t,i)}setUniformFloatVector(t,i){this.setUniform("uniform2f",t,i.x,i.y)}trySetUniformFloatVector(t,i){return this.trySetUniform("uniform2f",t,i.x,i.y)}setUniformFloatColor(t,i){this.setUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}trySetUniformFloatColor(t,i){return this.trySetUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}setUniformMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,i.data)}setUniformAffineMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,[i.data[0],i.data[1],0,0,i.data[2],i.data[3],0,0,0,0,1,0,i.data[4],i.data[5],0,1])}trySetUniformMatrix(t,i){return this.trySetUniform("uniformMatrix4fv",t,!1,i.data)}setUniform(t,i,...n){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${t}:${i}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const h=this._gl.getUniformLocation(this.program,i);if(h){const c=[h,...n];this._gl[t].apply(this._gl,c)}else throw Error(`Uniform ${t}:${i} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(t,i,...n){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${t}:${i}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const h=this._gl.getUniformLocation(this.program,i);if(h){const c=[h,...n];this._gl[t].apply(this._gl,c)}else return!1;return!0}_createProgram(t,i,n){const o=t.createProgram();if(o===null)throw Error("Could not create graphics shader program");if(t.attachShader(o,i),t.attachShader(o,n),this._onPreLink&&this._onPreLink(o),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw Error(`Could not link the program: [${t.getProgramInfoLog(o)}]`);return o}_compileShader(t,i,n){const o=t.VERTEX_SHADER===n?"vertex":"fragment",h=t.createShader(n);if(h===null)throw Error(`Could not build shader: [${i}]`);if(t.shaderSource(h,i),t.compileShader(h),!t.getShaderParameter(h,t.COMPILE_STATUS)){const f=t.getShaderInfoLog(h);throw Error(`Could not compile ${o} shader:

${f}${this._processSourceForError(i,f)}`)}return h}_processSourceForError(t,i){if(!t)return i;const n=t.split(`
`),o=i.search(/\d:\d/),h=i.indexOf(" ",o),[c,f]=i.slice(o,h).split(":").map(g=>Number(g));for(let g=0;g<n.length;g++)n[g]=`${g+1}: ${n[g]}${f===g+1?" <----- ERROR!":""}`;return`

Source:
`+n.join(`
`)}}ei._ACTIVE_SHADER_INSTANCE=null;class Xi{constructor(t){this.type="dynamic";const{gl:i,size:n,type:o,data:h}=t;if(this._gl=i,this.buffer=this._gl.createBuffer(),!h&&!n)throw Error("Must either provide data or a size to the VertexBuffer");h?this.bufferData=h:this.bufferData=new Float32Array(n),this.type=o??this.type,i.bindBuffer(i.ARRAY_BUFFER,this.buffer),i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this.buffer)}unbind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,null)}upload(t){const i=this._gl;i.bindBuffer(i.ARRAY_BUFFER,this.buffer),t?i.bufferSubData(i.ARRAY_BUFFER,0,this.bufferData,0,t):i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class ms{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(t){this._logger=ct.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:i,shader:n,vertexBuffer:o,attributes:h,suppressWarnings:c}=t;this._gl=i,this._vertexBuffer=o,this._attributes=h,this._shader=n,this._suppressWarnings=c,n&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(t){t&&this._shader!==t&&(this._shader=t,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const t=this._shader.attributes;for(const h of this._attributes){const c=t[h[0]];if(!c){if(!Hu(this._shader.vertexSource,h[0]))throw Error(`The attribute named: ${h[0]} size ${h[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${h[0]} size ${h[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${h[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${h[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const f=Ou(this._gl,this._shader.vertexSource,h[0]);this._layout.push({name:h[0],glType:f,size:h[1],location:-1,normalized:!1})}if(c){if(c.size!==h[1])throw Error(`VertexLayout size definition for attribute: [${h[0]}, ${h[1]}], doesn't match shader source size ${c.size}:
 ${this._shader.vertexSource}`);this._layout.push(c)}}let i=0;for(const h of this._layout){const c=Jh(this._gl,h.glType);this._vertexTotalSizeBytes+=c*h.size,i+=h.size}this._vertexBuffer.bufferData.length%i!==0&&this._logger.warn(`The vertex component size (${i})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const n=this._gl;this._vao=n.createVertexArray(),n.bindVertexArray(this._vao),this._vertexBuffer.bind();let o=0;for(const h of this._layout)h.location!==-1&&(h.glType===n.INT?n.vertexAttribIPointer(h.location,h.size,h.glType,this.totalVertexSizeBytes,o):n.vertexAttribPointer(h.location,h.size,h.glType,h.normalized,this.totalVertexSizeBytes,o),n.enableVertexAttribArray(h.location)),o+=Jh(n,h.glType)*h.size;n.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(t=!1,i){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const n=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),t&&this._vertexBuffer.upload(i),n.bindVertexArray(this._vao)}}class jt{static clear(){jt.DrawCallCount=0,jt.DrawnImagesCount=0}}jt.DrawCallCount=0;jt.DrawnImagesCount=0;class Ng{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=G(0,0),this._endScratch=G(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new ei({gl:t,vertexSource:Og,fragmentSource:Wg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new Xi({gl:t,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new ms({gl:t,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,n){this._isFull()&&this.flush(),this._lineCount++;const o=this._context.getTransform(),h=o.multiply(t,this._startScratch),c=o.multiply(i,this._endScratch),f=this._vertexBuffer.bufferData;f[this._vertexIndex++]=h.x,f[this._vertexIndex++]=h.y,f[this._vertexIndex++]=n.r/255,f[this._vertexIndex++]=n.g/255,f[this._vertexIndex++]=n.b/255,f[this._vertexIndex++]=n.a,f[this._vertexIndex++]=c.x,f[this._vertexIndex++]=c.y,f[this._vertexIndex++]=n.r/255,f[this._vertexIndex++]=n.g/255,f[this._vertexIndex++]=n.b/255,f[this._vertexIndex++]=n.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.LINES,0,this._lineCount*2),jt.DrawnImagesCount+=this._lineCount,jt.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const Gg=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,Vg=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class qg{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new ei({gl:t,vertexSource:Gg,fragmentSource:Vg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new Xi({gl:t,size:7*this._maxPoints,type:"dynamic"}),this._layout=new ms({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,n){this._isFull()&&this.flush(),this._pointCount++;const o=this._context.getTransform(),h=this._context.opacity,c=this._context.snapToPixel,f=o.multiply(t);c&&(f.x=~~(f.x+pt),f.y=~~(f.y+pt));const g=this._buffer.bufferData;g[this._vertexIndex++]=f.x,g[this._vertexIndex++]=f.y,g[this._vertexIndex++]=i.r/255,g[this._vertexIndex++]=i.g/255,g[this._vertexIndex++]=i.b/255,g[this._vertexIndex++]=i.a*h,g[this._vertexIndex++]=n*Math.max(o.getScaleX(),o.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.POINTS,0,this._pointCount),jt.DrawnImagesCount+=this._pointCount,jt.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const Xg=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,Yg=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class jg{constructor(t){this._gl=t,this._shader=new ei({gl:t,vertexSource:Xg,fragmentSource:Yg}),this._shader.compile(),this._buffer=new Xi({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new ms({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(t){const i=this._gl,n=t.getShader();n.use(),t.getLayout().use(),i.activeTexture(i.TEXTURE0),n.trySetUniformInt("u_image",0),t.onDraw&&t.onDraw(),i.drawArrays(i.TRIANGLES,0,6)}renderToScreen(){const t=this._gl;this._shader.use(),this._layout.use(),t.drawArrays(t.TRIANGLES,0,6)}}class Lr{constructor(t,i,n){this._logger=ct.getInstance(),this._gl=t,this.buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer);const o=i*6;if(!n)this.bufferData=new Uint32Array(o);else{const f=Math.floor(16383.5);this.bufferGlType=t.UNSIGNED_SHORT,this.bufferData=new Uint16Array(o),i>f&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${f}) requested quads(${i})`)}let h=0;for(let c=0;c<o;c+=6)this.bufferData[c+0]=h+0,this.bufferData[c+1]=h+1,this.bufferData[c+2]=h+2,this.bufferData[c+3]=h+2,this.bufferData[c+4]=h+1,this.bufferData[c+5]=h+3,h+=4;t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const Zg=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,$g=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class Qg{constructor(t){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=K.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=Pl(t,n);this._maxTextures=Math.min(n,o);const h=this._transformFragmentSource(Zg,this._maxTextures);this._shader=new ei({gl:t,fragmentSource:h,vertexSource:$g}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((c,f)=>f)),this._buffer=new Xi({gl:t,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new ms({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new Lr(t,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let n=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_textureIndex <= ${h}.5) {
`:o+=`   else if (v_textureIndex <= ${h}.5) {
`,o+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return n=n.replace("%%texture_picker%%",o),n}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(It.Filtering),n=i?On(i):void 0,o=Ii(t.getAttribute(It.WrappingX)),h=Ii(t.getAttribute(It.WrappingY)),c=t.getAttribute("forceUpload")==="true",f=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);t.removeAttribute("forceUpload"),this._textures.indexOf(f)===-1&&(this._textures.push(f),this._textureToIndex.set(f,this._textureIndex++),this._images.add(t))}_bindTextures(t){for(let i=0;i<this._maxTextures;i++)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,this._textures[i]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const n=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(n))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,n,o,h,c,f,g,v){var x,b,T,P;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const I=this._getImageWidth(t),F=this._getImageHeight(t);let R=I||o||0,S=F||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(x=o??I)!==null&&x!==void 0?x:0,this._view[3]=(b=h??F)!==null&&b!==void 0?b:0,this._dest[0]=i??1,this._dest[1]=n??1,c!==void 0&&f!==void 0&&g!==void 0&&v!==void 0&&(this._view[0]=i??1,this._view[1]=n??1,this._view[2]=(T=o??I)!==null&&T!==void 0?T:0,this._view[3]=(P=h??F)!==null&&P!==void 0?P:0,this._dest[0]=c,this._dest[1]=f,R=g,S=v),i=this._view[0],n=this._view[1];const M=this._view[2],W=this._view[3],U=this._context.getTransform(),V=this._context.opacity,j=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+R,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+S,this._quad[6]=this._dest[0]+R,this._quad[7]=this._dest[1]+S,U.multiplyQuadInPlace(this._quad),j&&(this._quad[0]=~~(this._quad[0]+Nt(this._quad[0])*pt),this._quad[1]=~~(this._quad[1]+Nt(this._quad[1])*pt),this._quad[2]=~~(this._quad[2]+Nt(this._quad[2])*pt),this._quad[3]=~~(this._quad[3]+Nt(this._quad[3])*pt),this._quad[4]=~~(this._quad[4]+Nt(this._quad[4])*pt),this._quad[5]=~~(this._quad[5]+Nt(this._quad[5])*pt),this._quad[6]=~~(this._quad[6]+Nt(this._quad[6])*pt),this._quad[7]=~~(this._quad[7]+Nt(this._quad[7])*pt));const q=this._context.tint||this._defaultTint,nt=this._getTextureIdForImage(t),ht=I||R,xt=F||S,gt=(i+this.uvPadding)/ht,yt=(n+this.uvPadding)/xt,St=(i+M-this.uvPadding)/ht,B=(n+W-this.uvPadding)/xt,z=I,$=F,tt=this._layout.vertexBuffer.bufferData;tt[this._vertexIndex++]=this._quad[0],tt[this._vertexIndex++]=this._quad[1],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=$,tt[this._vertexIndex++]=gt,tt[this._vertexIndex++]=yt,tt[this._vertexIndex++]=nt,tt[this._vertexIndex++]=q.r/255,tt[this._vertexIndex++]=q.g/255,tt[this._vertexIndex++]=q.b/255,tt[this._vertexIndex++]=q.a,tt[this._vertexIndex++]=this._quad[4],tt[this._vertexIndex++]=this._quad[5],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=$,tt[this._vertexIndex++]=gt,tt[this._vertexIndex++]=B,tt[this._vertexIndex++]=nt,tt[this._vertexIndex++]=q.r/255,tt[this._vertexIndex++]=q.g/255,tt[this._vertexIndex++]=q.b/255,tt[this._vertexIndex++]=q.a,tt[this._vertexIndex++]=this._quad[2],tt[this._vertexIndex++]=this._quad[3],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=$,tt[this._vertexIndex++]=St,tt[this._vertexIndex++]=yt,tt[this._vertexIndex++]=nt,tt[this._vertexIndex++]=q.r/255,tt[this._vertexIndex++]=q.g/255,tt[this._vertexIndex++]=q.b/255,tt[this._vertexIndex++]=q.a,tt[this._vertexIndex++]=this._quad[6],tt[this._vertexIndex++]=this._quad[7],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=$,tt[this._vertexIndex++]=St,tt[this._vertexIndex++]=B,tt[this._vertexIndex++]=nt,tt[this._vertexIndex++]=q.r/255,tt[this._vertexIndex++]=q.g/255,tt[this._vertexIndex++]=q.b/255,tt[this._vertexIndex++]=q.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),this._quads.bind(),t.drawElements(t.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),jt.DrawnImagesCount+=this._imageCount,jt.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const Kg=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,Jg=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class tm{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=K.Transparent,this._scratch1=G(0,0),this._scratch2=G(0,0),this._scratch3=G(0,0),this._scratch4=G(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new ei({gl:t,fragmentSource:Kg,vertexSource:Jg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new Xi({gl:t,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new ms({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Lr(t,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...t){t[0]instanceof k&&t[1]instanceof k?this.drawLine.apply(this,t):this.drawRectangle.apply(this,t)}drawLine(t,i,n,o=1){this._isFull()&&this.flush(),this._rectangleCount++;const h=this._context.getTransform(),c=this._context.opacity,f=this._context.snapToPixel,g=i.sub(t),v=g.magnitude,x=g.normalize().perpendicular(),b=o/2,T=h.multiply(x.scale(b,this._scratch1).add(t,this._scratch1),this._scratch1),P=h.multiply(x.scale(-b,this._scratch2).add(t,this._scratch2),this._scratch2),I=h.multiply(x.scale(b,this._scratch3).add(i,this._scratch3),this._scratch3),F=h.multiply(x.scale(-b,this._scratch4).add(i,this._scratch4),this._scratch4);f&&(T.x=~~(T.x+pt),T.y=~~(T.y+pt),I.x=~~(I.x+pt),I.y=~~(I.y+pt),P.x=~~(P.x+pt),P.y=~~(P.y+pt),F.x=~~(F.x+pt),F.y=~~(F.y+pt));const R=0,S=0,M=1,W=1,U=this._transparent,V=0,j=1,q=this._layout.vertexBuffer.bufferData;q[this._vertexIndex++]=T.x,q[this._vertexIndex++]=T.y,q[this._vertexIndex++]=R,q[this._vertexIndex++]=S,q[this._vertexIndex++]=v,q[this._vertexIndex++]=o,q[this._vertexIndex++]=c,q[this._vertexIndex++]=n.r/255,q[this._vertexIndex++]=n.g/255,q[this._vertexIndex++]=n.b/255,q[this._vertexIndex++]=n.a,q[this._vertexIndex++]=U.r/255,q[this._vertexIndex++]=U.g/255,q[this._vertexIndex++]=U.b/255,q[this._vertexIndex++]=U.a,q[this._vertexIndex++]=V/j,q[this._vertexIndex++]=P.x,q[this._vertexIndex++]=P.y,q[this._vertexIndex++]=R,q[this._vertexIndex++]=W,q[this._vertexIndex++]=v,q[this._vertexIndex++]=o,q[this._vertexIndex++]=c,q[this._vertexIndex++]=n.r/255,q[this._vertexIndex++]=n.g/255,q[this._vertexIndex++]=n.b/255,q[this._vertexIndex++]=n.a,q[this._vertexIndex++]=U.r/255,q[this._vertexIndex++]=U.g/255,q[this._vertexIndex++]=U.b/255,q[this._vertexIndex++]=U.a,q[this._vertexIndex++]=V/j,q[this._vertexIndex++]=I.x,q[this._vertexIndex++]=I.y,q[this._vertexIndex++]=M,q[this._vertexIndex++]=S,q[this._vertexIndex++]=v,q[this._vertexIndex++]=o,q[this._vertexIndex++]=c,q[this._vertexIndex++]=n.r/255,q[this._vertexIndex++]=n.g/255,q[this._vertexIndex++]=n.b/255,q[this._vertexIndex++]=n.a,q[this._vertexIndex++]=U.r/255,q[this._vertexIndex++]=U.g/255,q[this._vertexIndex++]=U.b/255,q[this._vertexIndex++]=U.a,q[this._vertexIndex++]=V/j,q[this._vertexIndex++]=F.x,q[this._vertexIndex++]=F.y,q[this._vertexIndex++]=M,q[this._vertexIndex++]=W,q[this._vertexIndex++]=v,q[this._vertexIndex++]=o,q[this._vertexIndex++]=c,q[this._vertexIndex++]=n.r/255,q[this._vertexIndex++]=n.g/255,q[this._vertexIndex++]=n.b/255,q[this._vertexIndex++]=n.a,q[this._vertexIndex++]=U.r/255,q[this._vertexIndex++]=U.g/255,q[this._vertexIndex++]=U.b/255,q[this._vertexIndex++]=U.a,q[this._vertexIndex++]=V/j}drawRectangle(t,i,n,o,h=K.Transparent,c=0){this._isFull()&&this.flush(),this._rectangleCount++;const f=this._context.getTransform(),g=this._context.opacity,v=this._context.snapToPixel,x=f.multiply(t.add(G(0,0))),b=f.multiply(t.add(G(i,0))),T=f.multiply(t.add(G(i,n))),P=f.multiply(t.add(G(0,n)));v&&(x.x=~~(x.x+pt),x.y=~~(x.y+pt),b.x=~~(b.x+pt),b.y=~~(b.y+pt),P.x=~~(P.x+pt),P.y=~~(P.y+pt),T.x=~~(T.x+pt),T.y=~~(T.y+pt));const I=0,F=0,R=1,S=1,M=this._layout.vertexBuffer.bufferData;M[this._vertexIndex++]=x.x,M[this._vertexIndex++]=x.y,M[this._vertexIndex++]=I,M[this._vertexIndex++]=F,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=g,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=P.x,M[this._vertexIndex++]=P.y,M[this._vertexIndex++]=I,M[this._vertexIndex++]=S,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=g,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=b.x,M[this._vertexIndex++]=b.y,M[this._vertexIndex++]=R,M[this._vertexIndex++]=F,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=g,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=T.x,M[this._vertexIndex++]=T.y,M[this._vertexIndex++]=R,M[this._vertexIndex++]=S,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=g,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),jt.DrawnImagesCount+=this._rectangleCount,jt.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const em=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,im=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class sm{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new ei({gl:t,fragmentSource:em,vertexSource:im}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new Xi({gl:t,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new ms({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Lr(t,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(t,i,n,o=K.Transparent,h=0){this._isFull()&&this.flush(),this._circleCount++;const c=this._context.getTransform(),f=this._context.opacity,g=this._context.snapToPixel,v=c.multiply(t.add(G(-i,-i))),x=c.multiply(t.add(G(i,-i))),b=c.multiply(t.add(G(i,i))),T=c.multiply(t.add(G(-i,i)));g&&(v.x=~~(v.x+pt),v.y=~~(v.y+pt),x.x=~~(x.x+pt),x.y=~~(x.y+pt),T.x=~~(T.x+pt),T.y=~~(T.y+pt),b.x=~~(b.x+pt),b.y=~~(b.y+pt));const P=0,I=0,F=1,R=1,S=this._layout.vertexBuffer.bufferData;S[this._vertexIndex++]=v.x,S[this._vertexIndex++]=v.y,S[this._vertexIndex++]=P,S[this._vertexIndex++]=I,S[this._vertexIndex++]=f,S[this._vertexIndex++]=n.r/255,S[this._vertexIndex++]=n.g/255,S[this._vertexIndex++]=n.b/255,S[this._vertexIndex++]=n.a,S[this._vertexIndex++]=o.r/255,S[this._vertexIndex++]=o.g/255,S[this._vertexIndex++]=o.b/255,S[this._vertexIndex++]=o.a,S[this._vertexIndex++]=h/i,S[this._vertexIndex++]=T.x,S[this._vertexIndex++]=T.y,S[this._vertexIndex++]=P,S[this._vertexIndex++]=R,S[this._vertexIndex++]=f,S[this._vertexIndex++]=n.r/255,S[this._vertexIndex++]=n.g/255,S[this._vertexIndex++]=n.b/255,S[this._vertexIndex++]=n.a,S[this._vertexIndex++]=o.r/255,S[this._vertexIndex++]=o.g/255,S[this._vertexIndex++]=o.b/255,S[this._vertexIndex++]=o.a,S[this._vertexIndex++]=h/i,S[this._vertexIndex++]=x.x,S[this._vertexIndex++]=x.y,S[this._vertexIndex++]=F,S[this._vertexIndex++]=I,S[this._vertexIndex++]=f,S[this._vertexIndex++]=n.r/255,S[this._vertexIndex++]=n.g/255,S[this._vertexIndex++]=n.b/255,S[this._vertexIndex++]=n.a,S[this._vertexIndex++]=o.r/255,S[this._vertexIndex++]=o.g/255,S[this._vertexIndex++]=o.b/255,S[this._vertexIndex++]=o.a,S[this._vertexIndex++]=h/i,S[this._vertexIndex++]=b.x,S[this._vertexIndex++]=b.y,S[this._vertexIndex++]=F,S[this._vertexIndex++]=R,S[this._vertexIndex++]=f,S[this._vertexIndex++]=n.r/255,S[this._vertexIndex++]=n.g/255,S[this._vertexIndex++]=n.b/255,S[this._vertexIndex++]=n.a,S[this._vertexIndex++]=o.r/255,S[this._vertexIndex++]=o.g/255,S[this._vertexIndex++]=o.b/255,S[this._vertexIndex++]=o.a,S[this._vertexIndex++]=h/i}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),jt.DrawnImagesCount+=this._circleCount,jt.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class ea{constructor(t,i,n=100){this.builder=t,this.recycler=i,this.maxObjects=n,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=ct.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let t=0;t<this.maxObjects;t++)this.objects[t]=this.builder()}using(t){const i=t(this);return i?this.done(...i):this.done()}borrow(t){const i=this.get();t(i),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...t){this.index=0;for(const i of t){const n=this.objects.indexOf(i);this.objects[n]=this.builder(),this.totalAllocations++}return t}}class nm{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=_e.identity(),this.state={z:0,opacity:1,tint:K.White,material:null},this.args=new Array(10)}}const rm=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class Gu{constructor(t){this._logger=ct.getInstance(),this._color=K.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:i,name:n,vertexSource:o,fragmentSource:h,graphicsContext:c,images:f}=t;if(this._name=n??"anonymous material",this._vertexSource=o??rm,this._fragmentSource=h,this._color=i??this._color,!c)throw Error(`Material ${n} must be provided an excalibur webgl graphics context`);if(c instanceof ds?(this._graphicsContext=c,this._initialize(c)):this._logger.warn(`Material ${n} was created in 2D Canvas mode, currently only WebGL is supported`),f)for(const g in f)this.addImageSource(g,f[g])}_initialize(t){if(this._initialized)return;const i=t.__gl;this._maxTextureSlots=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=t.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(t){this._color=t}get name(){var t;return(t=this._name)!==null&&t!==void 0?t:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(t){this._shader&&(this._shader.use(),t(this._shader))}getShader(){return this._shader}addImageSource(t,i){this._images.size<this._maxTextureSlots?this._images.set(t,i):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(t){const i=this._images.get(t);this._graphicsContext.textureLoader.delete(i.image),this._images.delete(t)}_loadImageSource(t){const i=t.image,n=i.getAttribute(It.Filtering),o=n?On(n):void 0,h=Ii(i.getAttribute(It.WrappingX)),c=Ii(i.getAttribute(It.WrappingY)),f=i.getAttribute("forceUpload")==="true",g=this._graphicsContext.textureLoader.load(i,{filtering:o,wrapping:{x:h,y:c}},f);return i.removeAttribute("forceUpload"),this._textures.has(t)||this._textures.set(t,g),g}uploadAndBind(t,i=2){let n=i;for(const[o,h]of this._images.entries()){if(!h.isLoaded()){this._logger.warnOnce(`Image named ${o} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const c=this._loadImageSource(h);t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,c),this._shader.trySetUniformInt(o,n),n++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class gu{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(t,i){this._gl=t,this._context=i,this._buffer=new Xi({gl:t,size:6*4,type:"dynamic"}),this._layout=new ms({gl:t,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new Lr(t,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(t,i,n,o,h,c,f,g,v){var x,b,T,P;const I=this._gl,F=this._context.material;if(!F)return;const R=this._context.getTransform(),S=this._context.opacity,M=F.getShader(),W=this._layout.vertexBuffer.bufferData;let U=0,V=t?.width||o||0,j=t?.height||h||0,q=[0,0,(x=o??t?.width)!==null&&x!==void 0?x:0,(b=h??t?.height)!==null&&b!==void 0?b:0],nt=[i??1,n??1];c!==void 0&&f!==void 0&&g!==void 0&&v!==void 0&&(q=[i??1,n??1,(T=o??t?.width)!==null&&T!==void 0?T:0,(P=h??t?.height)!==null&&P!==void 0?P:0],nt=[c,f],V=g,j=v),i=q[0],n=q[1];const ht=q[2],xt=q[3],gt=G(nt[0],nt[1]),yt=G(nt[0]+V,nt[1]),St=G(nt[0],nt[1]+j),B=G(nt[0]+V,nt[1]+j),z=t.width||V,$=t.height||j,tt=i/z,Ht=n/$,ot=(i+ht-.01)/z,pi=(n+xt-.01)/$,Zi=R.getPosition(),Pt=Zi.add(B),at=Zi.x/this._context.width,vs=Zi.y/this._context.height,Gr=Pt.x/this._context.width,$i=Pt.y/this._context.height;W[U++]=gt.x,W[U++]=gt.y,W[U++]=tt,W[U++]=Ht,W[U++]=at,W[U++]=vs,W[U++]=St.x,W[U++]=St.y,W[U++]=tt,W[U++]=pi,W[U++]=at,W[U++]=$i,W[U++]=yt.x,W[U++]=yt.y,W[U++]=ot,W[U++]=Ht,W[U++]=Gr,W[U++]=vs,W[U++]=B.x,W[U++]=B.y,W[U++]=ot,W[U++]=pi,W[U++]=Gr,W[U++]=$i;const Vr=this._addImageAsTexture(t);F.use(),this._layout.shader=M,this._layout.use(!0),M.trySetUniformFloat("u_time_ms",performance.now()),M.trySetUniformFloat("u_opacity",S),M.trySetUniformFloatVector("u_resolution",G(this._context.width,this._context.height)),M.trySetUniformFloatVector("u_graphic_resolution",G(z,$)),M.trySetUniformFloatVector("u_size",G(ht,xt)),M.trySetUniformMatrix("u_matrix",this._context.ortho),M.trySetUniformMatrix("u_transform",R.to4x4()),I.activeTexture(I.TEXTURE0+0),I.bindTexture(I.TEXTURE_2D,Vr),M.trySetUniformInt("u_graphic",0),I.activeTexture(I.TEXTURE0+1),I.bindTexture(I.TEXTURE_2D,this._context.materialScreenTexture),M.trySetUniformInt("u_screen_texture",1),F.uploadAndBind(I),this._quads.bind(),I.drawElements(I.TRIANGLES,6,this._quads.bufferGlType,0),jt.DrawnImagesCount++,jt.DrawCallCount++}_addImageAsTexture(t){const i=t.getAttribute(It.Filtering),n=i?On(i):void 0,o=Ii(t.getAttribute(It.WrappingX)),h=Ii(t.getAttribute(It.WrappingY)),c=t.getAttribute("forceUpload")==="true",f=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);return t.removeAttribute("forceUpload"),this._textures.indexOf(f)===-1&&this._textures.push(f),f}hasPendingDraws(){return!1}flush(){}}const om=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,am=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var Me;(function(d){d.World="world",d.Screen="screen"})(Me||(Me={}));class tl extends k{constructor(t){super(0,0),this._getX=t.getX,this._getY=t.getY,this._setX=t.setX,this._setY=t.setY}get x(){return this._x=this._getX()}set x(t){this._setX(t),this._x=t}get y(){return this._y=this._getY()}set y(t){this._setY(t),this._y=t}}class Rs extends k{constructor(t,i){super(t.x,t.y),this.original=t,this.change=i}get x(){return this._x=this.original.x}set x(t){t!==this._x&&(this.change(t,this._y),this._x=this.original.x=t)}get y(){return this._y=this.original.y}set y(t){t!==this._y&&(this.change(this._x,t),this._y=this.original.y=t)}setTo(t,i){this.x=t,this.y=i}}class _s{constructor(){this._parent=null,this._children=[],this._pos=new Rs(G(0,0),()=>{this.flagDirty()}),this._globalPos=new tl({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:t=>{if(this.parent){const{x:i}=this.parent.inverse.multiply(G(t,this.pos.y));this.pos.x=i}else this.pos.x=t;t!==this.matrix.data[4]&&this.flagDirty()},setY:t=>{if(this.parent){const{y:i}=this.parent.inverse.multiply(G(this.pos.x,t));this.pos.y=i}else this.pos.y=t;t!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new Rs(G(1,1),()=>{this.flagDirty()}),this._globalScale=new tl({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:t=>{if(this.parent){const i=this.parent.globalScale.x;this.scale.x=t/i}else this.scale.x=t},setY:t=>{if(this.parent){const i=this.parent.globalScale.y;this.scale.y=t/i}else this.scale.y=t}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=_e.identity(),this._inverse=_e.identity(),this._scratch=_e.identity()}get parent(){return this._parent}set parent(t){if(this._parent){const i=this._parent._children.indexOf(this);i>-1&&this._parent._children.splice(i,1)}this._parent=t,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(t){this._pos.x=t.x,this._pos.y=t.y}get pos(){return this._pos}set globalPos(t){let i=t.clone();this.parent&&(i=this.parent.inverse.multiply(t)),i.equals(this._pos)||(this._pos=i,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(t){const i=cs(t);i!==this._rotation&&this.flagDirty(),this._rotation=i}get rotation(){return this._rotation}set globalRotation(t){let i=0;this.parent&&(i=this.parent.globalRotation);const n=cs(t+i);n!==this._rotation&&this.flagDirty(),this._rotation=n}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(t){this._scale.x=t.x,this._scale.y=t.y}get scale(){return this._scale}set globalScale(t){let i=G(1,1);this.parent&&(i=this.parent.globalScale),this.scale=t.scale(G(1/i.x,1/i.y))}get globalScale(){return this._globalScale}set z(t){this._z=t,this.flagDirty()}get z(){return this._z}set globalZ(t){this.parent?this.z=t-this.parent.globalZ:this.z=t}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let t=0;t<this._children.length;t++)this._children[t].flagDirty()}apply(t){return this.matrix.multiply(t)}applyInverse(t){return this.inverse.multiply(t)}setTransform(t,i,n){this._pos.x=t.x,this._pos.y=t.y,this._rotation=cs(i),this._scale.x=n.x,this._scale.y=n.y,this.flagDirty()}isMirrored(){const t=Nt(this.scale.x)>>>31,i=Nt(this.scale.y)>>>31;return!!(t^i)}clone(t){const i=t??new _s;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.flagDirty(),i}cloneWithParent(t){const i=t??new _s;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.parent=this.parent,i.flagDirty(),i}toString(){return this.matrix.toString()}}function Vu(d){return!!d&&!!d.prototype&&!!d.prototype.constructor}function hm(d){return!!d?.clone}class fi{constructor(){this.owner=void 0}clone(){const t=new this.constructor;for(const i in this)if(this.hasOwnProperty(i)){const n=this[i];hm(n)&&i!=="owner"&&i!=="clone"?t[i]=n.clone():t[i]=n}return t}}class Ye{constructor(){this.observers=[],this.subscriptions=[]}register(t){this.observers.push(t)}subscribe(t){this.subscriptions.push(t)}unregister(t){const i=this.observers.indexOf(t);i!==-1&&this.observers.splice(i,1)}unsubscribe(t){const i=this.subscriptions.indexOf(t);i!==-1&&this.subscriptions.splice(i,1)}notifyAll(t){const i=this.observers.length;for(let o=0;o<i;o++)this.observers[o].notify(t);const n=this.subscriptions.length;for(let o=0;o<n;o++)this.subscriptions[o](t)}clear(){this.observers.length=0,this.subscriptions.length=0}}class st extends fi{constructor(){super(...arguments),this._logger=ct.getInstance(),this._parentComponent=null,this._transform=new _s,this._addChildTransform=t=>{const i=t.get(st);i&&(i._transform.parent=this._transform,i._parentComponent=this)},this.zIndexChanged$=new Ye,this._coordPlane=Me.World}get(){return this._transform}onAdd(t){for(const i of t.children)this._addChildTransform(i);t.childrenAdded$.subscribe(i=>this._addChildTransform(i)),t.childrenRemoved$.subscribe(i=>{const n=i.get(st);n&&(n._transform.parent=null,n._parentComponent=null)})}onRemove(t){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(t){const i=this._transform.z;this._transform.z=t,i!==t&&this.zIndexChanged$.notifyAll(t)}get globalZ(){return this._transform.globalZ}set globalZ(t){this._transform.globalZ=t}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(t){var i;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(i=this.owner)===null||i===void 0?void 0:i.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=t}get pos(){return this._transform.pos}set pos(t){this._transform.pos=t}get globalPos(){return this._transform.globalPos}set globalPos(t){this._transform.globalPos=t}get rotation(){return this._transform.rotation}set rotation(t){this._transform.rotation=t}get globalRotation(){return this._transform.globalRotation}set globalRotation(t){this._transform.globalRotation=t}get scale(){return this._transform.scale}set scale(t){this._transform.scale=t}get globalScale(){return this._transform.globalScale}set globalScale(t){this._transform.globalScale=t}applyInverse(t){return this._transform.applyInverse(t)}apply(t){return this._transform.apply(t)}clone(){const t=new st;return t._transform=this._transform.clone(),t}}var wr;(function(d){d.Forward="forward",d.Backward="backward"})(wr||(wr={}));var Ai;(function(d){d.End="end",d.Loop="loop",d.PingPong="pingpong",d.Freeze="freeze"})(Ai||(Ai={}));const lm={Frame:"frame",Loop:"loop",End:"end"};class Ti extends ie{constructor(t){var i,n,o;super(t),this.events=new Zt,this.frames=[],this.strategy=Ai.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=t.frames,this.speed=(i=t.speed)!==null&&i!==void 0?i:this.speed,this.strategy=(n=t.strategy)!==null&&n!==void 0?n:this.strategy,this.frameDuration=t.totalDuration?t.totalDuration/this.frames.length:(o=t.frameDuration)!==null&&o!==void 0?o:this.frameDuration,t.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new Ti({frames:this.frames.map(t=>({...t})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.width*this.scale.x):0}get height(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.height*this.scale.y):0}static fromSpriteSheet(t,i,n,o=Ai.Loop){const h=t.sprites.length-1,c=i.filter(f=>f<0||f>h);return c.length&&Ti._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${c.join(",")} no frame will be shown`),new Ti({frames:t.sprites.filter((f,g)=>i.indexOf(g)>-1).map(f=>({graphic:f,duration:n})),strategy:o})}static fromSpriteSheetCoordinates(t){var i;const{spriteSheet:n,frameCoordinates:o,durationPerFrame:h,durationPerFrameMs:c,speed:f,strategy:g,reverse:v}=t,x=(i=h??c)!==null&&i!==void 0?i:100,b=[];for(const T of o){const{x:P,y:I,duration:F,options:R}=T,S=n.getSprite(P,I,R);S?b.push({graphic:S,duration:F??x}):Ti._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${P}, ${I}), please check your SpriteSheet to confirm that sprite exists`)}return new Ti({frames:b,strategy:g,speed:f,reverse:v})}get speed(){return this._speed}set speed(t){this._speed=bt(Math.abs(t),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?wr.Backward:wr.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const t=this.frames[this._currentFrame];t&&(this._timeLeftInFrame=t?.duration||this.frameDuration)}get canFinish(){switch(this.strategy){case Ai.End:case Ai.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(t,i){this._currentFrame=t,this._timeLeftInFrame=i??this.frameDuration;const n=this.frames[this._currentFrame];n&&!this._done&&(this._timeLeftInFrame=i??(n?.duration||this.frameDuration),this.events.emit("frame",{...n,frameIndex:this.currentFrameIndex}))}_nextFrame(){const t=this._currentFrame;if(this._done)return t;let i=-1;switch(this.strategy){case Ai.Loop:{i=(t+1)%this.frames.length,i===0&&this.events.emit("loop",this);break}case Ai.End:{i=t+1,i>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case Ai.Freeze:{i=bt(t+1,0,this.frames.length-1),i>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case Ai.PingPong:{t+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),t+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),i=t+this._pingPongDirection%this.frames.length;break}}return i}tick(t,i=0){this._idempotencyToken!==i&&(this._idempotencyToken=i,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=t*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(t,i,n){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(t,i,n)}}Ti._LOGGER=ct.getInstance();class Bn extends ie{constructor(t){var i;super(t),this._logger=ct.getInstance(),this.useAnchor=!0,this.members=[],this.members=t.members,this.useAnchor=(i=t.useAnchor)!==null&&i!==void 0?i:this.useAnchor,this._updateDimensions()}clone(){return new Bn({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const t=this.localBounds;return this.width=t.width,this.height=t.height,t}get localBounds(){const t=new lt;for(const i of this.members)if(i instanceof ie)i.localBounds.combine(t,t);else{const{graphic:n,offset:o,useBounds:h}=i;n?(h===void 0?!0:h)&&n.localBounds.translate(o).combine(t,t):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(i)}.`)}return t}_isAnimationOrGroup(t){return t instanceof Ti||t instanceof Bn}tick(t,i){for(const n of this.members){let o;n instanceof ie?o=n:o=n.graphic,this._isAnimationOrGroup(o)&&o.tick(t,i)}}reset(){for(const t of this.members){let i;t instanceof ie?i=t:i=t.graphic,this._isAnimationOrGroup(i)&&i.reset()}}_preDraw(t,i,n){this._updateDimensions(),super._preDraw(t,this.useAnchor?i:0,this.useAnchor?n:0)}_drawImage(t,i,n){const o=k.Zero;for(const h of this.members){let c;h instanceof ie?c=h:(c=h.graphic,h.offset.clone(o)),c&&(t.save(),t.translate(i,n),c.draw(t,o.x,o.y),this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore())}}}class Wn extends ie{constructor(t){var i,n,o,h,c,f,g,v,x,b;super(Lu({...t},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=Pi(K.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,t&&(this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this.color=(n=t.color)!==null&&n!==void 0?n:K.Black,this.strokeColor=t?.strokeColor,this.smoothing=(o=t.smoothing)!==null&&o!==void 0?o:this.smoothing,this.lineWidth=(h=t.lineWidth)!==null&&h!==void 0?h:this.lineWidth,this.lineDash=(c=t.lineDash)!==null&&c!==void 0?c:this.lineDash,this.lineCap=(f=t.lineCap)!==null&&f!==void 0?f:this.lineCap,this.padding=(g=t.padding)!==null&&g!==void 0?g:this.padding,this.filtering=(v=t.filtering)!==null&&v!==void 0?v:this.filtering),this._bitmap=document.createElement("canvas");const T=(x=t?.width)!==null&&x!==void 0?x:this._bitmap.width,P=(b=t?.height)!==null&&b!==void 0?b:this._bitmap.height;this.width=T,this.height=P;const I=this._bitmap.getContext("2d");if(I)this._ctx=I;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(t){t/=Math.abs(this.scale.x),this._bitmap.width=t,this._originalWidth=t,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(t){t/=Math.abs(this.scale.y),this._bitmap.height=t,this._originalHeight=t,this.flagDirty()}_getTotalWidth(){var t;return(((t=this._originalWidth)!==null&&t!==void 0?t:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var t;return(((t=this._originalHeight)!==null&&t!==void 0?t:this._bitmap.height)+this.padding*2)*1}get localBounds(){return lt.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,k.Zero)}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this.flagDirty()}get color(){return this._color}set color(t){this.flagDirty(),this._color=Pi(t,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(t){this.flagDirty(),t&&(this._strokeColor=Pi(t,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(t){this._lineDash=t,this.flagDirty()}get padding(){return this._padding}set padding(t){this._padding=t,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(t){var i,n,o,h;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),t.scale(this.quality,this.quality),t.translate(this.padding,this.padding),t.imageSmoothingEnabled=this.smoothing,t.lineWidth=this.lineWidth,t.setLineDash((i=this.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.lineCap=this.lineCap,t.strokeStyle=(o=(n=this.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&o!==void 0?o:"",t.fillStyle=(h=this.color)===null||h===void 0?void 0:h.toString()}_drawImage(t,i,n){this._dirty&&this.rasterize(),t.scale(1/this.quality,1/this.quality),t.drawImage(this._bitmap,i,n)}}var Ho;(function(d){d.Em="em",d.Rem="rem",d.Px="px",d.Pt="pt",d.Percent="%"})(Ho||(Ho={}));var Oo;(function(d){d.Left="left",d.Right="right",d.Center="center",d.Start="start",d.End="end"})(Oo||(Oo={}));var Wo;(function(d){d.Top="top",d.Hanging="hanging",d.Middle="middle",d.Alphabetic="alphabetic",d.Ideographic="ideographic",d.Bottom="bottom"})(Wo||(Wo={}));var No;(function(d){d.Normal="normal",d.Italic="italic",d.Oblique="oblique"})(No||(No={}));var Go;(function(d){d.LeftToRight="ltr",d.RightToLeft="rtl"})(Go||(Go={}));function el(d,t=K.Red,i,n,o,h,c=1,f="butt"){d.save(),d.beginPath(),d.lineWidth=c,d.lineCap=f,d.strokeStyle=t.toString(),d.moveTo(i,n),d.lineTo(o,h),d.closePath(),d.stroke(),d.restore()}function cm(d,t=K.Red,i){d.beginPath(),d.strokeStyle=t.toString(),d.arc(i.x,i.y,5,0,Math.PI*2),d.closePath(),d.stroke()}function dm(d,t,i,n,o=1){const h=t?t.toString():"blue",c=n.scale(o);d.beginPath(),d.strokeStyle=h,d.moveTo(i.x,i.y),d.lineTo(i.x+c.x,i.y+c.y),d.closePath(),d.stroke()}function il(d,t,i,n,o,h=5,c=K.White,f=null){let g;if(typeof h=="number")g={tl:h,tr:h,br:h,bl:h};else{const v={tl:0,tr:0,br:0,bl:0};for(const x in v)if(v.hasOwnProperty(x)){const b=x;g[b]=h[b]||v[b]}}d.beginPath(),d.moveTo(t+g.tl,i),d.lineTo(t+n-g.tr,i),d.quadraticCurveTo(t+n,i,t+n,i+g.tr),d.lineTo(t+n,i+o-g.br),d.quadraticCurveTo(t+n,i+o,t+n-g.br,i+o),d.lineTo(t+g.bl,i+o),d.quadraticCurveTo(t,i+o,t,i+o-g.bl),d.lineTo(t,i+g.tl),d.quadraticCurveTo(t,i,t+g.tl,i),d.closePath(),f&&(d.fillStyle=f.toString(),d.fill()),c&&(d.strokeStyle=c.toString(),d.stroke())}function um(d,t,i,n,o=K.White,h=null){d.beginPath(),d.arc(t,i,n,0,Math.PI*2),d.closePath(),h&&(d.fillStyle=h.toString(),d.fill()),o&&(d.strokeStyle=o.toString(),d.stroke())}class Dn{constructor(t,i,n,o){this.font=t,this.text=i,this.color=n,this.maxWidth=o,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const h=this.canvas.getContext("2d");if(!h)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=h,this.dimensions=this.measureText(i),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(t,i){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let n=null;i!=null?n=this._getLinesFromText(t,i):n=t.split(`
`);const o=n.reduce((T,P)=>T.length>P.length?T:P);this._applyFont(this.ctx);const h=this.ctx.measureText(o);let c=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);const f=c*n.length;c=f;const g=f-Math.abs(h.actualBoundingBoxAscent),v=0,x=0;return new lt({left:v-Math.abs(h.actualBoundingBoxLeft)-this.font.padding,top:x-Math.abs(h.actualBoundingBoxAscent)-this.font.padding,bottom:x+g+this.font.padding,right:v+Math.abs(h.actualBoundingBoxRight)+this.font.padding})}_setDimension(t,i){let n=1;this.font.lineHeight&&(n=this.font.lineHeight/this.font.size),i.canvas.width=(t.width+this.font.padding*2)*2*this.font.quality,i.canvas.height=(t.height+this.font.padding*2)*2*this.font.quality*n}static getHashCode(t,i,n){var o;return i+"__hashcode__"+t.fontString+t.showDebug+t.textAlign+t.baseAlign+t.direction+t.lineHeight+JSON.stringify(t.shadow)+(t.padding.toString()+t.smoothing.toString()+t.lineWidth.toString()+t.lineDash.toString()+((o=t.strokeColor)===null||o===void 0?void 0:o.toString())+(n?n.toString():t.color.toString()))}getHashCode(t=!0){return Dn.getHashCode(this.font,this.text,t?this.color:void 0)}_applyRasterProperties(t){var i,n,o;t.translate(this.font.padding,this.font.padding),t.imageSmoothingEnabled=this.font.smoothing,t.lineWidth=this.font.lineWidth,t.setLineDash((i=this.font.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.strokeStyle=(o=(n=this.font.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&o!==void 0?o:"",t.fillStyle=this.color.toString()}_applyFont(t){t.resetTransform(),t.translate(this.font.padding+t.canvas.width/2,this.font.padding+t.canvas.height/2),t.scale(this.font.quality,this.font.quality),t.textAlign=this.font.textAlign,t.textBaseline=this.font.baseAlign,t.font=this.font.fontString,t.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(t.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(t.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(t.shadowOffsetX=this.font.shadow.offset.x,t.shadowOffsetY=this.font.shadow.offset.y))}_drawText(t,i,n){this._applyRasterProperties(t),this._applyFont(t);for(let o=0;o<i.length;o++){const h=i[o];this.color&&t.fillText(h,0,o*n),this.font.strokeColor&&t.strokeText(h,0,o*n)}this.font.showDebug&&(el(t,K.Green,-t.canvas.width/2,0,t.canvas.width/2,0,2),el(t,K.Red,0,-t.canvas.height/2,0,t.canvas.height/2,2))}_splitTextBitmap(t){const i=[];let n=0,o=0;const h=Math.min(4096,t.canvas.width),c=Math.min(4096,t.canvas.height);for(;n<t.canvas.width;){for(;o<t.canvas.height;){const f=document.createElement("canvas");f.width=h,f.height=c;const g=f.getContext("2d");if(!g)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");g.drawImage(t.canvas,n,o,h,c,0,0,h,c),i.push({x:n,y:o,canvas:f}),o+=c}n+=h,o=0}return i}flagDirty(){this._dirty=!0}render(t,i,n,o){var h;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=t;const c=this.getHashCode();if(this._lastHashCode!==c&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,o),this._setDimension(this.dimensions,this.ctx);const f=this._getLinesFromText(this.text,o),g=(h=this.font.lineHeight)!==null&&h!==void 0?h:this.dimensions.height/f.length;if(this._drawText(this.ctx,f,g),t instanceof ds)for(const v of this._textFragments)t.textureLoader.delete(v.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),t instanceof ds)for(const v of this._textFragments)t.textureLoader.load(v.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=c,this._dirty=!1}for(const f of this._textFragments)t.drawImage(f.canvas,0,0,f.canvas.width,f.canvas.height,f.x/this.font.quality+i-this.ctx.canvas.width/this.font.quality/2,f.y/this.font.quality+n-this.ctx.canvas.height/this.font.quality/2,f.canvas.width/this.font.quality,f.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof ds)for(const t of this._textFragments)this._ex.textureLoader.delete(t.canvas);this._textFragments.length=0}_getLinesFromText(t,i){var n;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let c=o[h],f="";if(this.measureText(c).width>i){for(;this.measureText(c).width>i;)f=c[c.length-1]+f,c=c.slice(0,-1);o[h]=c,o[h+1]=f}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class Lt{static measureText(t,i,n){const o=Dn.getHashCode(i,t);if(Lt._MEASURE_CACHE.has(o))return Lt._MEASURE_CACHE.get(o);Lt._LOGGER.debug("Font text measurement cache miss");const h=i.measureTextWithoutCache(t,n);return Lt._MEASURE_CACHE.set(o,h),h}static getTextInstance(t,i,n){const o=Dn.getHashCode(i,t,n);let h=Lt._TEXT_CACHE.get(o);return h||(h=new Dn(i,t,n),Lt._TEXT_CACHE.set(o,h),Lt._LOGGER.debug("Font text instance cache miss")),Lt._TEXT_USAGE.set(h,performance.now()),h}static checkAndClearCache(){const t=[],i=new Set;for(const[o,h]of Lt._TEXT_USAGE.entries())if(h+Lt.FONT_TIMEOUT<performance.now())Lt._LOGGER.debug(`Text cache entry timed out ${o.text}`),t.push(o),o.dispose();else{const c=o.getHashCode(!1);i.add(c)}t.forEach(o=>{Lt._TEXT_USAGE.delete(o)}),this._TEXT_CACHE.clear();for(const[o]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(o.getHashCode(),o);const n=new Map;for(const o of i)Lt._MEASURE_CACHE.has(o)&&n.set(o,Lt._MEASURE_CACHE.get(o));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=n}static get cacheSize(){return Lt._TEXT_USAGE.size}static clearCache(){for(const[t]of Lt._TEXT_USAGE.entries())t.dispose();Lt._TEXT_USAGE.clear(),Lt._TEXT_CACHE.clear(),Lt._MEASURE_CACHE.clear()}}Lt.FONT_TIMEOUT=500;Lt._LOGGER=ct.getInstance();Lt._TEXT_USAGE=new Map;Lt._TEXT_CACHE=new Map;Lt._MEASURE_CACHE=new Map;class hn extends ie{constructor(t={}){var i,n,o,h,c,f,g,v,x,b,T,P,I,F,R,S,M,W,U,V;super(t),this.filtering=pe.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=K.Black,this.family="sans-serif",this.style=No.Normal,this.bold=!1,this.unit=Ho.Px,this.textAlign=Oo.Left,this.baseAlign=Wo.Top,this.direction=Go.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new lt,this._textMeasurement=new Dn(this,"",K.Black),this.smoothing=(i=t?.smoothing)!==null&&i!==void 0?i:this.smoothing,this.padding=(n=t?.padding)!==null&&n!==void 0?n:this.padding,this.color=(o=t?.color)!==null&&o!==void 0?o:this.color,this.strokeColor=(h=t?.strokeColor)!==null&&h!==void 0?h:this.strokeColor,this.lineDash=(c=t?.lineDash)!==null&&c!==void 0?c:this.lineDash,this.lineWidth=(f=t?.lineWidth)!==null&&f!==void 0?f:this.lineWidth,this.filtering=(g=t?.filtering)!==null&&g!==void 0?g:this.filtering,this.family=(v=t?.family)!==null&&v!==void 0?v:this.family,this.style=(x=t?.style)!==null&&x!==void 0?x:this.style,this.bold=(b=t?.bold)!==null&&b!==void 0?b:this.bold,this.size=(T=t?.size)!==null&&T!==void 0?T:this.size,this.unit=(P=t?.unit)!==null&&P!==void 0?P:this.unit,this.textAlign=(I=t?.textAlign)!==null&&I!==void 0?I:this.textAlign,this.baseAlign=(F=t?.baseAlign)!==null&&F!==void 0?F:this.baseAlign,this.direction=(R=t?.direction)!==null&&R!==void 0?R:this.direction,this.lineHeight=(S=t?.lineHeight)!==null&&S!==void 0?S:this.lineHeight,this.quality=(M=t?.quality)!==null&&M!==void 0?M:this.quality,t?.shadow&&(this.shadow={},this.shadow.blur=(W=t.shadow.blur)!==null&&W!==void 0?W:this.shadow.blur,this.shadow.offset=(U=t.shadow.offset)!==null&&U!==void 0?U:this.shadow.offset,this.shadow.color=(V=t.shadow.color)!==null&&V!==void 0?V:this.shadow.color)}clone(){return new hn({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(t,i,n){}_rotate(t){var i;const n=(i=this.origin)!==null&&i!==void 0?i:this._textBounds.center;t.translate(n.x,n.y),t.rotate(this.rotation),t.translate(-n.x,-n.y)}_flip(t){this.flipHorizontal&&(t.translate(this._textBounds.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,-this._textBounds.height/2/this.scale.y),t.scale(1,-1))}measureTextWithoutCache(t,i){return this._textMeasurement.measureText(t,i)}measureText(t,i){return Lt.measureText(t,this,i)}_postDraw(t){t.restore()}render(t,i,n,o,h,c){const f=Lt.getTextInstance(i,this,n);this._textBounds=f.dimensions,this._preDraw(t,o,h),f.render(t,o,h,c),this._postDraw(t)}}class Ur extends ie{constructor(t){var i,n;super(t),this._text="",this._textWidth=0,this._textHeight=0,this.font=(i=t.font)!==null&&i!==void 0?i:new hn,this.color=(n=t.color)!==null&&n!==void 0?n:this.color,this.text=t.text,this.maxWidth=t.maxWidth}clone(){var t,i;return new Ur({text:this.text.slice(),color:(i=(t=this.color)===null||t===void 0?void 0:t.clone())!==null&&i!==void 0?i:K.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(t){this._text=t,this._calculateDimension()}get font(){return this._font}set font(t){this._font=t}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:t,height:i}=this.font.measureText(this._text,this.maxWidth);this._textWidth=t,this._textHeight=i}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(t){}_flip(t){}_preDraw(t,i,n){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(t,i,n)}_drawImage(t,i,n){var o;let h=K.Black;this.font instanceof hn&&(h=(o=this.color)!==null&&o!==void 0?o:this.font.color);const{width:c,height:f}=this.font.measureText(this._text,this.maxWidth);this._textWidth=c,this._textHeight=f,this.font.render(t,this._text,h,i,n,this.maxWidth),this.font.showDebug&&(t.debug.drawRect(i-c,n-f,c*2,f*2),this.maxWidth!=null&&t.debug.drawRect(i,n,this.maxWidth,this.height,{color:K.Yellow}))}}function Sl(d){return!!d.tick}class se extends fi{get visible(){return this.isVisible}set visible(t){this.isVisible=t}get offset(){return this._offset}set offset(t){this._offset=new Rs(t,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(t){this._anchor=new Rs(t,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(t){if(t){this._color=t.clone();const i=this.graphics.current;(i instanceof Wn||i instanceof Ur)&&(i.color=this._color)}}constructor(t){super(),this._logger=ct.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new Rs(k.Zero,()=>this.recalculateBounds()),this._anchor=new Rs(k.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,t={visible:this.isVisible,graphics:{},...t};const{current:i,anchor:n,color:o,opacity:h,visible:c,graphics:f,offset:g,copyGraphics:v,onPreDraw:x,onPostDraw:b,onPreTransformDraw:T,onPostTransformDraw:P}=t;for(const[I,F]of Object.entries(f))F instanceof ie?this._graphics[I]=F:(this._graphics[I]=F.graphic,this._options[I]=F.options);this.offset=g??this.offset,this.opacity=h??this.opacity,this.anchor=n??this.anchor,this.color=o??this.color,this.copyGraphics=v??this.copyGraphics,this.onPreDraw=x??this.onPreDraw,this.onPostDraw=b??this.onPostDraw,this.onPreDraw=T??this.onPreTransformDraw,this.onPostTransformDraw=P??this.onPostTransformDraw,this.isVisible=!!c,this._current=i??this._current,i&&this._graphics[i]&&this.use(i)}getGraphic(t){return this._graphics[t]}getOptions(t){return this._options[t]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(t,i,n){let o="default",h=null,c;if(typeof t=="string"&&i instanceof ie&&(o=t,h=i,c=n),t instanceof ie&&!(i instanceof ie)&&(h=t,c=i),!h)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[o]=this.copyGraphics?h.clone():h,this._options[o]=this.copyGraphics?{...c}:c,o==="default"&&this.use("default"),h}remove(t){delete this._graphics[t],delete this._options[t],this._current===t&&(this._current="default",this.recalculateBounds())}use(t,i){var n;if(t instanceof ie){let o=t;this.copyGraphics&&(o=t.clone()),this._current="default",this._graphics[this._current]=o,this._options[this._current]=i}else this._current=t,this._options[this._current]=i,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(n=this.owner)===null||n===void 0?void 0:n.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(t){this._localBounds=t}recalculateBounds(){let t=new lt;const i=this._graphics[this._current],n=this._options[this._current];if(!i){this._localBounds=t;return}let o=this.anchor,h=this.offset;n?.anchor&&(o=n.anchor),n?.offset&&(h=n.offset);const c=i.localBounds,f=-c.width*o.x+h.x,g=-c.height*o.y+h.y;i instanceof Bn&&!i.useAnchor?t=i?.localBounds.combine(t):t=i?.localBounds.translate(G(f,g)).combine(t),this._localBounds=t}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let t=this.localBounds;if(this.owner){const i=this.owner.get(st);i&&(t=t.transform(i.get().matrix))}return t}update(t,i=0){const n=this.current;n&&Sl(n)&&n.tick(t,i)}clone(){const t=new se;return t._graphics={...this._graphics},t._options={...this._options},t.offset=this.offset.clone(),this.color&&(t.color=this.color.clone()),t.opacity=this.opacity,t.anchor=this.anchor.clone(),t.copyGraphics=this.copyGraphics,t.onPreDraw=this.onPreDraw,t.onPostDraw=this.onPostDraw,t.isVisible=this.isVisible,t}}var Vo;(function(d){d.Kill="kill",d.PreKill="prekill",d.PostKill="postkill",d.PreDraw="predraw",d.PostDraw="postdraw",d.PreDebugDraw="predebugdraw",d.PostDebugDraw="postdebugdraw",d.PreUpdate="preupdate",d.PostUpdate="postupdate",d.PreFrame="preframe",d.PostFrame="postframe",d.PreCollision="precollision",d.CollisionStart="collisionstart",d.CollisionEnd="collisionend",d.PostCollision="postcollision",d.Initialize="initialize",d.Activate="activate",d.Deactivate="deactivate",d.ExitViewport="exitviewport",d.EnterViewport="enterviewport",d.ExitTrigger="exit",d.EnterTrigger="enter",d.Connect="connect",d.Disconnect="disconnect",d.Button="button",d.Axis="axis",d.Visible="visible",d.Hidden="hidden",d.Start="start",d.Stop="stop",d.PointerUp="pointerup",d.PointerDown="pointerdown",d.PointerMove="pointermove",d.PointerEnter="pointerenter",d.PointerLeave="pointerleave",d.PointerCancel="pointercancel",d.PointerWheel="pointerwheel",d.Up="up",d.Down="down",d.Move="move",d.Enter="enter",d.Leave="leave",d.Cancel="cancel",d.Wheel="wheel",d.Press="press",d.Release="release",d.Hold="hold",d.PointerDragStart="pointerdragstart",d.PointerDragEnd="pointerdragend",d.PointerDragEnter="pointerdragenter",d.PointerDragLeave="pointerdragleave",d.PointerDragMove="pointerdragmove",d.ActionStart="actionstart",d.ActionComplete="actioncomplete",d.Add="add",d.Remove="remove"})(Vo||(Vo={}));class wt{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(t){this._bubbles=t}stopPropagation(){this.bubbles=!1}}class ia extends wt{constructor(t){super(),this.self=t,this.target=t}}class El extends wt{constructor(t){super(),this.self=t,this.target=t}}class Il extends wt{constructor(t){super(),this.self=t,this.target=t}}class Rl extends wt{constructor(t){super(),this.self=t,this.target=t}}class Dl extends wt{constructor(t){super(),this.self=t,this.target=t}}class Nn extends wt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class Gn extends wt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class Ml extends wt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class Fl extends wt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class Bl extends wt{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class kl extends wt{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class ks extends wt{constructor(t,i,n){super(),this.engine=t,this.elapsed=i,this.self=n,this.target=n}}class Ls extends wt{constructor(t,i,n){super(),this.engine=t,this.elapsed=i,this.self=n,this.target=n}}class Ll extends wt{constructor(t,i){super(),this.engine=t,this.prevStats=i,this.target=t}}class Ul extends wt{constructor(t,i){super(),this.engine=t,this.stats=i,this.target=t}}class zl extends wt{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class Hl extends wt{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class Ol extends wt{constructor(t,i,n,o){super(),this.button=t,this.index=i,this.value=n,this.self=o,this.target=o}}class Wl extends wt{constructor(t,i,n){super(),this.axis=t,this.value=i,this.self=n,this.target=n}}class Nl extends wt{constructor(t){super(),this.self=t,this.target=t}}class Gl extends wt{constructor(t){super(),this.self=t,this.target=t}}class ln extends wt{constructor(t,i,n,o,h){super(),this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h,this.target=t}}class cn extends wt{constructor(t,i,n,o,h){super(),this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h,this.target=t}}class qo{constructor(t,i,n,o){this.self=t,this.other=i,this.side=n,this.contact=o}}class Xo{constructor(t,i,n,o){this.self=t,this.other=i,this.side=n,this.lastContact=o}}class Yo{constructor(t,i,n,o,h){this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h}}class jo{constructor(t,i,n,o,h){this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h}}class xr extends wt{constructor(t,i,n,o){super(),this.self=t,this.other=i,this.side=n,this.contact=o,this.target=t}}class br extends wt{constructor(t,i,n,o){super(),this.self=t,this.other=i,this.side=n,this.lastContact=o,this.target=t}}class Vn extends wt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class Vl extends wt{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class ql extends wt{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class Xl extends wt{constructor(t){super(),this.self=t,this.target=t}}class Yl extends wt{constructor(t){super(),this.self=t,this.target=t}}class jl extends wt{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class Zl extends wt{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class $l extends wt{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class Ql extends wt{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class Kl extends wt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class Jl extends wt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class _m{constructor(t){this.data=t,this.type="Component Added"}}function fm(d){return!!d&&d.type==="Component Added"}class pm{constructor(t){this.data=t,this.type="Component Removed"}}function gm(d){return!!d&&d.type==="Component Removed"}const mm={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class We{constructor(t,i){this.id=We._ID++,this.name=`Entity#${this.id}`,this.events=new Zt,this._tags=new Set,this.componentAdded$=new Ye,this.componentRemoved$=new Ye,this.tagAdded$=new Ye,this.tagRemoved$=new Ye,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new Ye,this.childrenRemoved$=new Ye,this._children=[],this._isInitialized=!1,this._isAdded=!1;let n,o;if(Array.isArray(t))n=t,o=i;else if(t&&typeof t=="object"){const{components:h,name:c,silenceWarnings:f}=t;n=h??[],o=c}if(o&&(this.name=o),n)for(const h of n)this.addComponent(h)}get active(){return this.isActive}set active(t){this.isActive=t}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new ia(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(t){return this._tags.has(t)}addTag(t){return this._tags.add(t),this.tagAdded$.notifyAll(t),this}removeTag(t){return this._tags.delete(t),this.tagRemoved$.notifyAll(t),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(t){for(let i=0;i<t.length;i++)if(!this.components.has(t[i]))return!1;return!0}hasAllTags(t){for(let i=0;i<t.length;i++)if(!this.tags.has(t[i]))return!1;return!0}get(t){return this.components.get(t)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(t){if(t.parent===null){if(this.getAncestors().includes(t))throw new Error("Cycle detected, cannot add entity");this._children.push(t),t._parent=this,this.childrenAdded$.notifyAll(t)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(t){return t.parent===this&&(Hn(t,this._children),t._parent=null,this.childrenRemoved$.notifyAll(t)),this}removeAllChildren(){for(let t=this.children.length-1;t>=0;t--)this.removeChild(this.children[t]);return this}getAncestors(){const t=[this];let i=this.parent;for(;i;)t.push(i),i=i.parent;return t.reverse()}getDescendants(){let t=[this],i=[this];for(;i.length>0;){const n=i.pop();n&&(i=i.concat(n.children),t=t.concat(n.children))}return t}clone(){const t=new We;for(const i of this.types){const n=this.get(i);n&&t.addComponent(n.clone())}for(const i of this.children)t.addChild(i.clone());return t}addTemplate(t,i=!1){for(const n of t.getComponents())this.addComponent(n.clone(),i);for(const n of t.children)this.addChild(n.clone().addTemplate(n));return this}_getClassHierarchyRoot(t){var i,n;let o=t,h=(i=Object.getPrototypeOf(o.prototype))===null||i===void 0?void 0:i.constructor;for(;h&&h!==Object&&h!==fi;)o=h,h=(n=Object.getPrototypeOf(o.prototype))===null||n===void 0?void 0:n.constructor;return o}addComponent(t,i=!1){if(this.has(t.constructor))if(i)this.removeComponent(t.constructor,!0);else return this;if(t.dependencies&&t.dependencies.length)for(const o of t.dependencies)this.addComponent(new o);t.owner=this;const n=this._getClassHierarchyRoot(t.constructor);return this.components.set(n,t),this.components.set(t.constructor,t),this.componentValues.push(t),t.onAdd&&t.onAdd(this),this.componentAdded$.notifyAll(t),this}removeComponent(t,i=!1){let n;if(Vu(t)?n=t:n=t.constructor,i){const o=this.components.get(n);if(o){this.componentRemoved$.notifyAll(o),o.owner=void 0,o.onRemove&&o.onRemove(this);const c=this.componentValues.indexOf(o);c>-1&&this.componentValues.splice(c,1)}const h=this._getClassHierarchyRoot(n);this.components.delete(h),this.components.delete(n)}else this._componentsToRemove.push(n);return this}clearComponents(){const t=this.types;for(const i of t)this.removeComponent(i)}processComponentRemoval(){for(const t of this._componentsToRemove)this.removeComponent(t,!0);this._componentsToRemove.length=0}has(t){return this.components.has(t)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(t){this.isInitialized||(this.onInitialize(t),this.events.emit("initialize",new Vn(t,this)),this._isInitialized=!0)}_add(t){!this.isAdded&&this.isActive&&(this.onAdd(t),this.events.emit("add",new Kl(t,this)),this._isAdded=!0)}_remove(t){this.isAdded&&!this.isActive&&(this.onRemove(t),this.events.emit("remove",new Jl(t,this)),this._isAdded=!1)}_preupdate(t,i){this.events.emit("preupdate",new ks(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new Ls(t,i,this)),this.onPostUpdate(t,i)}onInitialize(t){}onAdd(t){}onRemove(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i);for(const n of this.children)n.update(t,i);this._postupdate(t,i),this._remove(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}We._ID=0;class Mt extends fi{constructor(){super(...arguments),this.vel=k.Zero,this.acc=k.Zero,this.scaleFactor=k.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class Xe{static integrate(t,i,n,o){const h=o/1e3;i.vel.addEqual(n.scale(h,Xe._ACC)),t.pos.add(i.vel.scale(h,Xe._VEL),Xe._POS).addEqual(n.scale(.5*h*h,Xe._VEL_ACC)),i.angularVelocity+=i.torque*(1/i.inertia)*h;const c=t.rotation+i.angularVelocity*h;t.scale.add(i.scaleFactor.scale(h,this._SCALE_FACTOR),Xe._SCALE),t.get().setTransform(Xe._POS,c,Xe._SCALE)}}Xe._POS=new k(0,0);Xe._SCALE=new k(1,1);Xe._ACC=new k(0,0);Xe._VEL=new k(0,0);Xe._VEL_ACC=new k(0,0);Xe._SCALE_FACTOR=new k(0,0);class sa extends We{constructor(t){super({silenceWarnings:!0}),this.beginColor=K.White,this.endColor=K.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=K.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=Ri.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new st),this.addComponent(this.motion=new Mt),this.addComponent(this.graphics=new se),this.configure(t)}registerEmitter(t){if(this._emitter=t,this.particleTransform===Ri.Global){const i=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(i),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(t){var i,n,o,h,c,f,g,v,x,b,T,P,I,F;this.particleTransform=(i=t.transform)!==null&&i!==void 0?i:this.particleTransform,this.life=(n=t.life)!==null&&n!==void 0?n:this.life,this.fade=(o=t.fade)!==null&&o!==void 0?o:this.fade,this.size=(h=t.size)!==null&&h!==void 0?h:this.size,this.endColor=(c=t.endColor)!==null&&c!==void 0?c:this.endColor.clone(),this.beginColor=(f=t.beginColor)!==null&&f!==void 0?f:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=t.graphic,this.graphics.opacity=(g=t.opacity)!==null&&g!==void 0?g:this.graphics.opacity,this.transform.pos=(v=t.pos)!==null&&v!==void 0?v:this.transform.pos,this.transform.rotation=(x=t.rotation)!==null&&x!==void 0?x:0,this.transform.scale=G(1,1),this.motion.vel=(b=t.vel)!==null&&b!==void 0?b:this.motion.vel,this.motion.angularVelocity=(T=t.angularVelocity)!==null&&T!==void 0?T:0,this.motion.acc=(P=t.acc)!==null&&P!==void 0?P:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(I=t.startSize)!==null&&I!==void 0?I:0,this.endSize=(F=t.endSize)!==null&&F!==void 0?F:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=lt.fromDimension(this.size,this.size,k.Half),this.graphics.onPostDraw=R=>{R.save(),R.debug.drawPoint(G(0,0),{color:this._currentColor,size:this.size}),R.restore()})}kill(){var t;!((t=this._emitter)===null||t===void 0)&&t.isActive?this._emitter.removeParticle(this):super.kill()}update(t,i){this.life=this.life-i,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=bt(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=bt(this.sizeRate*i+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=bt(this._currentColor.r+this._rRate*i,0,255),this._currentColor.g=bt(this._currentColor.g+this._gRate*i,0,255),this._currentColor.b=bt(this._currentColor.b+this._bRate*i,0,255),this._currentColor.a=this.graphics.opacity;let n=this.motion.acc;this.focus&&(n=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(i/1e3)),Xe.integrate(this.transform,this.motion,n,i)}}sa.DefaultConfig={beginColor:K.White,endColor:K.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var Ri;(function(d){d.Global="global",d.Local="local"})(Ri||(Ri={}));class qu{constructor(){this.type="ex.particle",this.priority=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new ei({gl:t,vertexSource:om,fragmentSource:am,onPreLink:n=>{t.transformFeedbackVaryings(n,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],t.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(t){const i=t.getAttribute(It.Filtering),n=i?On(i):void 0,o=Ii(t.getAttribute(It.WrappingX)),h=Ii(t.getAttribute(It.WrappingY)),c=t.getAttribute("forceUpload")==="true",f=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);return t.removeAttribute("forceUpload"),f}draw(t,i){var n,o,h,c,f,g,v,x,b;const T=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const P=t.particle.transform===Ri.Local?this._context.getTransform():this._context.getTransform().multiply(t.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",P),this._shader.setUniformBoolean("fade",!!t.particle.fade),this._shader.setUniformBoolean("useTexture",!!t.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(n=t.particle.life)!==null&&n!==void 0?n:2e3),this._shader.setUniformFloat("deltaMs",i),this._shader.setUniformFloatVector("gravity",(o=t.particle.acc)!==null&&o!==void 0?o:G(0,0)),this._shader.setUniformFloatColor("beginColor",(h=t.particle.beginColor)!==null&&h!==void 0?h:K.Transparent),this._shader.setUniformFloatColor("endColor",(c=t.particle.endColor)!==null&&c!==void 0?c:K.Transparent);let I=(f=t.particle.startSize)!==null&&f!==void 0?f:0,F=(g=t.particle.endSize)!==null&&g!==void 0?g:0;const R=(v=t.particle.size)!==null&&v!==void 0?v:0;if(R>0&&(I=R,F=R),this._shader.setUniformFloat("startSize",I??10),this._shader.setUniformFloat("endSize",F??10),this._shader.setUniformFloat("startOpacity",(x=t.particle.opacity)!==null&&x!==void 0?x:1),t.particle.focus&&(this._shader.setUniformFloatVector("focus",t.particle.focus),this._shader.setUniformFloat("focusAccel",(b=t.particle.focusAccel)!==null&&b!==void 0?b:0)),t.particle.graphic){const S=t.particle.graphic,M=this._getTexture(S.image.image);T.activeTexture(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,M),this._shader.setUniformInt("graphic",0)}t.draw(T)}hasPendingDraws(){return!1}flush(){}dispose(){}}const vm=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,wm=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class xm{constructor(t){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=K.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=Pl(t,n);this._maxTextures=Math.min(n,o);const h=this._transformFragmentSource(vm,this._maxTextures);this._shader=new ei({gl:t,fragmentSource:h,vertexSource:wm}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((b,T)=>T)),this._vao=t.createVertexArray(),t.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._meshBuffer),t.bufferData(t.ARRAY_BUFFER,this._quadMesh,t.STATIC_DRAW),t.vertexAttribPointer(0,2,t.FLOAT,!1,16,0),t.enableVertexAttribArray(0),t.vertexAttribPointer(1,2,t.FLOAT,!1,16,8),t.enableVertexAttribArray(1),t.bindBuffer(t.ARRAY_BUFFER,null);const c=this._components;this._transformData=new Xi({gl:t,size:c*this._maxImages,type:"dynamic"}),this._transformData.bind();let f=0,g=2;const v=4,x=c*4;t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,f),t.enableVertexAttribArray(2),f+=2*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,f),t.enableVertexAttribArray(3),f+=2*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,f),t.enableVertexAttribArray(4),f+=2*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,f),t.enableVertexAttribArray(5),f+=2*v,t.vertexAttribPointer(g++,1,t.FLOAT,!1,x,f),t.enableVertexAttribArray(6),f+=1*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,f),t.enableVertexAttribArray(7),f+=2*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,f),t.enableVertexAttribArray(8),f+=2*v,t.vertexAttribPointer(g++,1,t.FLOAT,!1,x,f),t.enableVertexAttribArray(9),f+=1*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,f),t.enableVertexAttribArray(10),f+=2*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,f),t.enableVertexAttribArray(11),f+=2*v,t.vertexAttribPointer(g++,4,t.FLOAT,!1,x,f),t.enableVertexAttribArray(12),f+=4*v,t.vertexAttribDivisor(2,1),t.vertexAttribDivisor(3,1),t.vertexAttribDivisor(4,1),t.vertexAttribDivisor(5,1),t.vertexAttribDivisor(6,1),t.vertexAttribDivisor(7,1),t.vertexAttribDivisor(8,1),t.vertexAttribDivisor(9,1),t.vertexAttribDivisor(10,1),t.vertexAttribDivisor(11,1),t.vertexAttribDivisor(12,1),t.bindVertexArray(null)}_bindData(t){const i=this._components;this._transformData.bind(),this._transformData.upload(i*this._imageCount),t.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let n=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_texture_index <= ${h}.5) {
`:o+=`   else if (v_texture_index <= ${h}.5) {
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return n=n.replace("%%texture_picker%%",o),n}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(It.Filtering),n=i?On(i):void 0,o=Ii(t.getAttribute(It.WrappingX)),h=Ii(t.getAttribute(It.WrappingY)),c=t.getAttribute("forceUpload")==="true",f=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);t.removeAttribute("forceUpload"),this._textures.indexOf(f)===-1&&(this._textures.push(f),this._textureToIndex.set(f,this._textureIndex++),this._images.add(t))}_bindTextures(t){const i=Math.min(this._textureIndex,this._maxTextures);for(let n=0;n<i;n++)t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,this._textures[n]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const n=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(n))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,n,o,h,c,f,g,v){var x,b,T,P;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const I=this._getImageWidth(t),F=this._getImageHeight(t);let R=I||o||0,S=F||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(x=o??I)!==null&&x!==void 0?x:0,this._view[3]=(b=h??F)!==null&&b!==void 0?b:0,this._dest[0]=i??1,this._dest[1]=n??1,c!==void 0&&f!==void 0&&g!==void 0&&v!==void 0&&(this._view[0]=i??1,this._view[1]=n??1,this._view[2]=(T=o??I)!==null&&T!==void 0?T:0,this._view[3]=(P=h??F)!==null&&P!==void 0?P:0,this._dest[0]=c,this._dest[1]=f,R=g,S=v),i=this._view[0],n=this._view[1];const M=this._view[2],W=this._view[3],U=this._context.getTransform(),V=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+pt),this._dest[1]=~~(this._dest[1]+pt));const q=this._context.tint||this._defaultTint,nt=this._getTextureIdForImage(t),ht=I||R,xt=F||S,gt=(i+this.uvPadding)/ht,yt=(n+this.uvPadding)/xt,St=(i+M-this.uvPadding)/ht,B=(n+W-this.uvPadding)/xt,z=I,$=F,tt=this._transformData.bufferData;tt[this._vertexIndex++]=this._dest[0],tt[this._vertexIndex++]=this._dest[1],tt[this._vertexIndex++]=U.data[0],tt[this._vertexIndex++]=U.data[1],tt[this._vertexIndex++]=U.data[2],tt[this._vertexIndex++]=U.data[3],tt[this._vertexIndex++]=U.data[4],tt[this._vertexIndex++]=U.data[5],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=R,tt[this._vertexIndex++]=S,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=$,tt[this._vertexIndex++]=nt,tt[this._vertexIndex++]=gt,tt[this._vertexIndex++]=yt,tt[this._vertexIndex++]=St,tt[this._vertexIndex++]=B,tt[this._vertexIndex++]=q.r/255,tt[this._vertexIndex++]=q.g/255,tt[this._vertexIndex++]=q.b/255,tt[this._vertexIndex++]=q.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._bindData(t),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),t.drawArraysInstanced(t.TRIANGLES,0,6,this._imageCount),jt.DrawnImagesCount+=this._imageCount,jt.DrawCallCount++,t.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const pt=1e-4;class bm{constructor(t){this._webglCtx=t,this._debugText=new Tl}drawRect(t,i,n,o,h={color:K.Black}){this.drawLine(G(t,i),G(t+n,i),{...h}),this.drawLine(G(t+n,i),G(t+n,i+o),{...h}),this.drawLine(G(t+n,i+o),G(t,i+o),{...h}),this.drawLine(G(t,i+o),G(t,i),{...h})}drawLine(t,i,n){var o;this._webglCtx.draw("ex.line",t,i,(o=n?.color)!==null&&o!==void 0?o:K.Black)}drawPoint(t,i={color:K.Black,size:5}){this._webglCtx.draw("ex.point",t,i.color,i.size)}drawText(t,i){this._debugText.write(this._webglCtx,t,i)}}class ds{get z(){return this._state.current.z}set z(t){this._state.current.z=t}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(t){let i=!0;return(t.width>4096||t.height>4096)&&(i=!1),i}constructor(t){this._logger=ct.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=Ie.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new ea(()=>new nm,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new Bg,this._state=new Uu,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=K.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new bm(this),this._totalPostProcessorTime=0;const{canvasElement:i,context:n,enableTransparency:o,antialiasing:h,uvPadding:c,multiSampleAntialiasing:f,pixelArtSampler:g,powerPreference:v,snapToPixel:x,backgroundColor:b,useDrawSorting:T,garbageCollector:P,handleContextLost:I,handleContextRestored:F}=t;if(this.__gl=n??i.getContext("webgl2",{antialias:h??this.smoothing,premultipliedAlpha:!1,alpha:o??this.transparency,depth:!1,powerPreference:v??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");I&&this.__gl.canvas.addEventListener("webglcontextlost",I,!1),F&&this.__gl.canvas.addEventListener("webglcontextrestored",F,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new te(this.__gl,P),this.snapToPixel=x??this.snapToPixel,this.smoothing=h??this.smoothing,this.transparency=o??this.transparency,this.pixelArtSampler=g??this.pixelArtSampler,this.uvPadding=c??this.uvPadding,this.multiSampleAntialiasing=typeof f=="boolean"?f:this.multiSampleAntialiasing,this.samples=typeof f=="object"?f.samples:void 0,this.backgroundColor=b??this.backgroundColor,this.useDrawSorting=T??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const t of this._renderers.values())t.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const t=this.__gl;if(this._ortho=ri.ortho(0,t.canvas.width,t.canvas.height,0,400,-400),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!1),this.register(new Qg({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new gu),this.register(new tm),this.register(new sm),this.register(new qg),this.register(new Ng),this.lazyRegister("ex.particle",()=>new qu),this.register(new xm({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=t.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");t.bindTexture(t.TEXTURE_2D,this.materialScreenTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),this._screenRenderer=new jg(t),this._renderTarget=new Io({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),this._postProcessTargets=[new Io({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),new Io({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height})],this._msaaTarget=new Io({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(t){this._renderers.set(t.type,t),t.initialize(this.__gl,this)}lazyRegister(t,i){this._lazyRenderersFactory.set(t,i)}get(t){let i=this._renderers.get(t);if(!i){const n=this._lazyRenderersFactory.get(t);n&&(this._logger.debug("lazy init renderer:",t),i=n(),this.register(i))}return i}_isCurrentRenderer(t){return!this._currentRenderer||this._currentRenderer===t}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(t,...i){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${t}, the webgl context is lost`);return}const n=this.get(t);if(n)if(this.useDrawSorting){const o=this._drawCallPool.get();o.z=this._state.current.z,o.priority=n.priority,o.renderer=t,this.getTransform().clone(o.transform),o.state.z=this._state.current.z,o.state.opacity=this._state.current.opacity,o.state.tint=this._state.current.tint,o.state.material=this._state.current.material,o.args[0]=i[0],o.args[1]=i[1],o.args[2]=i[2],o.args[3]=i[3],o.args[4]=i[4],o.args[5]=i[5],o.args[6]=i[6],o.args[7]=i[7],o.args[8]=i[8],o.args[9]=i[9],this._drawCalls[this._drawCallIndex++]=o}else this._currentRenderer||(this._currentRenderer=n),this._isCurrentRenderer(n)||this._currentRenderer.flush(),n.draw(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9]),this._currentRenderer=n;else throw Error(`No renderer with name ${t} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(t){const i=this.__gl;this._ortho=this._ortho=ri.ortho(0,t.width,t.height,0,400,-400),this._renderTarget.setResolution(i.canvas.width,i.canvas.height),this._msaaTarget.setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[0].setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[1].setResolution(i.canvas.width,i.canvas.height)}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}drawImage(t,i,n,o,h,c,f,g,v){if(!(o===0||h===0)){{if(g===0||v===0)return;if(this._getImageWidth(t)===0||this._getImageHeight(t)===0)return}if(!t){ct.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",t,i,n,o,h,c,f,g,v):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,t,i,n,o,h,c,f,g,v):this.draw(this.imageRenderer,t,i,n,o,h,c,f,g,v)}}drawLine(t,i,n,o=1){this.draw("ex.rectangle",t,i,n,o)}drawRectangle(t,i,n,o,h,c){this.draw("ex.rectangle",t,i,n,o,h,c)}drawCircle(t,i,n,o,h){this.draw("ex.circle",t,i,n,o,h)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(t,i){this._transform.translate(this.snapToPixel?~~(t+pt):t,this.snapToPixel?~~(i+pt):i)}rotate(t){this._transform.rotate(t)}scale(t,i){this._transform.scale(t,i)}transform(t){this._transform.current=t}getTransform(){return this._transform.current}multiply(t){this._transform.current.multiply(t,this._transform.current)}addPostProcessor(t){this._postprocessors.push(t),t.initialize(this.__gl)}removePostProcessor(t){const i=this._postprocessors.indexOf(t);i!==-1&&this._postprocessors.splice(i,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(t){for(const i of this._postprocessors){const n=i.getShader();n.use();const o=n.getUniforms();this._totalPostProcessorTime+=t,o.find(h=>h.name==="u_time_ms")&&n.setUniformFloat("u_time_ms",this._totalPostProcessorTime),o.find(h=>h.name==="u_elapsed_ms")&&n.setUniformFloat("u_elapsed_ms",t),o.find(h=>h.name==="u_resolution")&&n.setUniformFloatVector("u_resolution",G(this.width,this.height)),i.onUpdate&&i.onUpdate(t)}}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return new Gu({...t,graphicsContext:this})}createShader(t){const i=this.__gl,{vertexSource:n,fragmentSource:o}=t,h=new ei({gl:i,vertexSource:n,fragmentSource:o});return h.compile(),h}clear(){const t=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT)}flush(){var t;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let i=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(i.use(),this.useDrawSorting){for(let c=this._drawCallIndex;c<this._drawCalls.length;c++)this._drawCalls[c]=null;const n=new Map;for(const[c]of this._renderers){let f=0;for(f=0;f<this._drawCallIndex&&this._drawCalls[f].renderer!==c;f++);n.set(c,f)}this._drawCalls.sort((c,f)=>{if(c===null||f===null)return 0;const g=c.z-f.z,v=n.get(c.renderer)-n.get(f.renderer),x=c.priority-f.priority;return g===0?x===0?v:x:g});const o=this._transform.current,h=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let c=this._drawCalls[0].renderer,f=this.get(c);for(let g=0;g<this._drawCallIndex;g++)this._transform.current=this._drawCalls[g].transform,this._state.current=this._drawCalls[g].state,this._drawCalls[g].renderer!==c&&(f.flush(),c=this._drawCalls[g].renderer,f=this.get(c)),f instanceof gu&&(!((t=this.material)===null||t===void 0)&&t.isUsingScreenTexture)&&(i.copyToTexture(this.materialScreenTexture),i.use()),f.draw(...this._drawCalls[g].args);f.hasPendingDraws()&&f.flush()}this._transform.current=o,this._state.current=h,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const n of this._renderers.values())n.hasPendingDraws()&&n.flush();i.disable(),this._postprocessors.length>0&&i.toRenderSource().use();for(let n=0;n<this._postprocessors.length;n++)i=this._postProcessTargets[n%2],this._postProcessTargets[n%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[n]),this._postProcessTargets[n%2].toRenderSource().use();i.blitToScreen()}}const oe=1e-4;class ym{constructor(t){this._ex=t,this._debugText=new Tl}drawRect(t,i,n,o){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(t+oe):t,this._ex.snapToPixel?~~(i+oe):i,this._ex.snapToPixel?~~(n+oe):n,this._ex.snapToPixel?~~(o+oe):o),this._ex.__ctx.restore()}drawLine(t,i,n={color:K.Black}){var o,h;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(h=(o=n.color)===null||o===void 0?void 0:o.toString())!==null&&h!==void 0?h:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(t.x+oe):t.x,this._ex.snapToPixel?~~(t.y+oe):t.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(i.x+oe):i.x,this._ex.snapToPixel?~~(i.y+oe):i.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(t,i={color:K.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=i.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(t.x+oe):t.x,this._ex.snapToPixel?~~(t.y+oe):t.y,i.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(t,i){this._debugText.write(this._ex,t,i)}}class Zo{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(t){this.__ctx.imageSmoothingEnabled=t}constructor(t){this.useDrawSorting=!1,this.z=0,this.backgroundColor=K.ExcaliburBlue,this._state=new Uu,this.snapToPixel=!1,this.debug=new ym(this);const{canvasElement:i,context:n,enableTransparency:o,snapToPixel:h,antialiasing:c,backgroundColor:f}=t;if(this.__ctx=n??i.getContext("2d",{alpha:o??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=f??this.backgroundColor,this.snapToPixel=h??this.snapToPixel,this.smoothing=c??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(t){}drawImage(t,i,n,o,h,c,f,g,v){if(o===0||h===0)return;if(g===0||v===0)return;if(t.width===0||t.height===0)return;this.__ctx.globalAlpha=this.opacity;const x=[t,i,n,o,h,c,f,g,v].filter(b=>b!==void 0).map(b=>typeof b=="number"&&this.snapToPixel?~~b:b);this.__ctx.drawImage.apply(this.__ctx,x),jt.DrawCallCount++,jt.DrawnImagesCount=1}drawLine(t,i,n,o=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=n.toString(),this.__ctx.moveTo(this.snapToPixel?~~(t.x+oe):t.x,this.snapToPixel?~~(t.y+oe):t.y),this.__ctx.lineTo(this.snapToPixel?~~(i.x+oe):i.x,this.snapToPixel?~~(i.y+oe):i.y),this.__ctx.lineWidth=o,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(t,i,n,o){this.__ctx.save(),this.__ctx.fillStyle=o.toString(),this.__ctx.fillRect(this.snapToPixel?~~(t.x+oe):t.x,this.snapToPixel?~~(t.y+oe):t.y,this.snapToPixel?~~(i+oe):i,this.snapToPixel?~~(n+oe):n),this.__ctx.restore()}drawCircle(t,i,n,o,h){this.__ctx.save(),this.__ctx.beginPath(),o&&(this.__ctx.strokeStyle=o.toString()),h&&(this.__ctx.lineWidth=h),this.__ctx.fillStyle=n.toString(),this.__ctx.arc(this.snapToPixel?~~(t.x+oe):t.x,this.snapToPixel?~~(t.y+oe):t.y,i,0,Math.PI*2),this.__ctx.fill(),o&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(t,i){this.__ctx.translate(this.snapToPixel?~~(t+oe):t,this.snapToPixel?~~(i+oe):i)}rotate(t){this.__ctx.rotate(t)}scale(t,i){this.__ctx.scale(t,i)}getTransform(){throw new Error("Not implemented")}multiply(t){this.__ctx.setTransform(this.__ctx.getTransform().multiply(t.toDOMMatrix()))}addPostProcessor(t){}removePostProcessor(t){}clearPostProcessors(){}updatePostProcessors(t){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),jt.clear()}flush(){}dispose(){this.__ctx=void 0}}var ye;(function(d){d.Fixed="Fixed",d.FitContainerAndFill="FitContainerAndFill",d.FitScreenAndFill="FitScreenAndFill",d.FitContainerAndZoom="FitContainerAndZoom",d.FitScreenAndZoom="FitScreenAndZoom",d.FitScreen="FitScreen",d.FillScreen="FillScreen",d.FitContainer="FitContainer",d.FillContainer="FillContainer"})(ye||(ye={}));class sl{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const Am={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class nl{constructor(t){var i,n,o,h;this.events=new Zt,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=ct.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const c=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(c),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new lt,this._unsafeArea=new lt,this.viewport=t.viewport,this.resolution=(i=t.resolution)!==null&&i!==void 0?i:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(n=t.displayMode)!==null&&n!==void 0?n:ye.Fixed,this._canvas=t.canvas,this.graphicsContext=t.context,this._antialiasing=(o=t.antialiasing)!==null&&o!==void 0?o:this._antialiasing,this._canvasImageRendering=(h=t.canvasImageRendering)!==null&&h!==void 0?h:this._canvasImageRendering,this._browser=t.browser,this._pixelRatioOverride=t.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const t=this.worldToPageCoordinates(k.Zero);return this.worldToPageCoordinates(G(1,0)).sub(t).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(t){this._pixelRatioOverride=t}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case ye.FillContainer:case ye.FitContainer:case ye.FitContainerAndFill:case ye.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(t){this._resolution=t}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(t){this._viewport=t}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(t){this._camera=t}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof ds&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let o=Math.max(1,this.pixelRatio-.5),h=!1;for(;o>1&&!h;){o=Math.max(1,o-.5);const c=this._resolution.width*o,f=this._resolution.height*o;h=this.graphicsContext.checkIfResolutionSupported({width:c,height:f})}this.pixelRatioOverride=o,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const t=this.viewport.widthUnit==="percent"?"%":"px",i=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+t,this._canvas.style.height=this.viewport.height+i,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof Zo&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(t){this._antialiasing=t,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(t){return this.enterFullscreen(t)}enterFullscreen(t){var i,n,o,h,c,f;if(t){const g=document.getElementById(t);if(g?.requestFullscreen||g?.webkitRequestFullscreen){if(g.getAttribute("ex-fullscreen-listener")||(g.setAttribute("ex-fullscreen-listener","true"),g.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),g.requestFullscreen)return(i=g.requestFullscreen())!==null&&i!==void 0?i:Promise.resolve();if(g.webkitRequestFullscreen)return(n=g.webkitRequestFullscreen())!==null&&n!==void 0?n:Promise.resolve()}}return!((o=this._canvas)===null||o===void 0)&&o.requestFullscreen?(c=(h=this._canvas)===null||h===void 0?void 0:h.requestFullscreen())!==null&&c!==void 0?c:Promise.resolve():this._canvas.webkitRequestFullscreen?(f=this._canvas.webkitRequestFullscreen())!==null&&f!==void 0?f:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(t){return{width:t.widthUnit==="percent"?this.canvas.offsetWidth:t.width,height:t.heightUnit==="percent"?this.canvas.offsetHeight:t.height}}pageToScreenCoordinates(t){let i=t.x,n=t.y;this._isFullscreen||(i-=gr(this._canvas).x,n-=gr(this._canvas).y);const o=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,c=(window.innerHeight-h)/2;n=(n-c)/h*o.height,i=i/window.innerWidth*o.width}else{const h=window.innerHeight*this.aspectRatio,c=(window.innerWidth-h)/2;i=(i-c)/h*o.width,n=n/window.innerHeight*o.height}return i=i/o.width*this.resolution.width,n=n/o.height*this.resolution.height,i=i-this.contentArea.left,n=n-this.contentArea.top,new k(i,n)}screenToPageCoordinates(t){let i=t.x,n=t.y;const o=this._viewportToPixels(this.viewport);if(i=i/this.resolution.width*o.width,n=n/this.resolution.height*o.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,c=(window.innerHeight-h)/2;n=n/o.height*h+c,i=i/o.width*window.innerWidth}else{const h=window.innerHeight*this.aspectRatio,c=(window.innerWidth-h)/2;i=i/o.width*h+c,n=n/o.height*window.innerHeight}return this._isFullscreen||(i+=gr(this._canvas).x,n+=gr(this._canvas).y),new k(i,n)}screenToWorldCoordinates(t){return t=t.add(G(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(t):t.sub(G(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(t){return this._camera?this._camera.transform.multiply(t):t.add(G(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(t){const i=this.pageToScreenCoordinates(t);return this.screenToWorldCoordinates(i)}worldToPageCoordinates(t){const i=this.worldToScreenCoordinates(t);return this.screenToPageCoordinates(i)}getWorldBounds(){return lt.fromDimension(this.resolution.width,this.resolution.height,k.Half).scale(G(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return lt.fromDimension(this.resolution.width,this.resolution.height,k.Zero,k.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return G(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=this.aspectRatio;let i=0,n=0;window.innerWidth/t<window.innerHeight?(i=window.innerWidth,n=window.innerWidth/t):(i=window.innerHeight*t,n=window.innerHeight),this.viewport={width:i,height:n},this._contentArea=lt.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this._unsafeArea=lt.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndFill(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(t,i,n){if(this.viewport=n??{width:t,height:i},t/i<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:t*this._contentResolution.width/t,height:t*this._contentResolution.width/t*i/t};const o=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new lt({top:o,left:0,right:this._contentResolution.width,bottom:this.resolution.height-o}),this._unsafeArea=new lt({top:-o,left:0,right:this._contentResolution.width,bottom:this.resolution.height+o})}else{this.resolution={width:i*this._contentResolution.height/i*t/i,height:i*this._contentResolution.height/i};const o=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new lt({top:0,left:o,right:this.resolution.width-o,bottom:this._contentResolution.height}),this._unsafeArea=new lt({top:0,left:-o,right:this.resolution.width+o,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndZoom(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const t=this.canvas.parentElement;t.style.overflow="hidden";const{offsetWidth:i,offsetHeight:n}=this.canvas;this._computeFitAndZoom(i,n),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(t,i){const n=this.aspectRatio;let o=0,h=0;t/n<i?(o=t,h=t/n):(o=i*n,h=i);const c=t/o,f=i/h,g=Math.max(c,f),v=o*g,x=h*g;v>t?this.canvas.style.left=-(v-t)/2+"px":this.canvas.style.left="",x>i?this.canvas.style.top=-(x-i)/2+"px":this.canvas.style.top="",this.viewport={width:v,height:x};const b=lt.fromDimension(this.viewport.width,this.viewport.height,k.Zero);if(this.viewport.width>t){const T=(this.viewport.width-t)/this.viewport.width*this.resolution.width;b.top=0,b.left=T/2,b.right=this.resolution.width-T/2,b.bottom=this.resolution.height}if(this.viewport.height>i){const T=(this.viewport.height-i)/this.viewport.height*this.resolution.height;b.top=T/2,b.left=0,b.bottom=this.resolution.height-T/2,b.right=this.resolution.width}this._contentArea=b}_computeFitContainer(){const t=this.aspectRatio;let i=0,n=0,o="pixel",h="pixel";const c=this.canvas.parentElement;c.clientWidth/t<c.clientHeight?(this.canvas.style.width="100%",i=100,o="percent",n=this.canvas.offsetWidth/t):(this.canvas.style.height="100%",n=100,h="percent",i=this.canvas.offsetHeight*t),this.viewport={width:i,widthUnit:o,height:n,heightUnit:h},this._contentArea=lt.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(t){this.displayMode===ye.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===ye.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:t.innerWidth,height:t.innerHeight},this.viewport=this.resolution),this._contentArea=lt.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.displayMode===ye.FitScreen&&this._computeFit(),this.displayMode===ye.FitContainer&&this._computeFitContainer(),this.displayMode===ye.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===ye.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===ye.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===ye.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class yr{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function Cm(d){return!!d.playbackState}class sn{static unlock(){return new Promise((i,n)=>{if(sn._UNLOCKED||!yr.create())return i(!0);const o=setTimeout(()=>{ct.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),i(!1)},200),h=yr.create();h.resume().then(()=>{const c=h.createBuffer(1,1,22050),f=h.createBufferSource();let g=!1;f.buffer=c,f.connect(h.destination),f.onended=()=>g=!0,f.start(0),setTimeout(()=>{Cm(f)?(f.playbackState===f.PLAYING_STATE||f.playbackState===f.FINISHED_STATE)&&(sn._UNLOCKED=!0):(h.currentTime>0||g)&&(sn._UNLOCKED=!0)},0),clearTimeout(o),i(!0)},()=>{n()})})}static isUnlocked(){return this._UNLOCKED}}sn._UNLOCKED=!1;class na extends Wn{get ctx(){return this._ctx}constructor(t={}){super(t),this._options=t}clone(){return new na({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){var i,n;!((i=this._options)===null||i===void 0)&&i.draw&&((n=this._options)===null||n===void 0||n.draw(t)),this._options.cache||this.flagDirty()}}class tc{}tc.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class ra{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(t){this._currentState=t}static create(t,i){const n=new ra;n.data=i;for(const o in t.states)n.states.set(o,{name:o,...t.states[o]});for(const o of n.states.values())for(const h of o.transitions)if(h!=="*"&&!n.states.has(h))throw Error(`Invalid state machine, state [${o.name}] has a transition to another state that doesn't exist [${h}]`);return n.currentState=n.startState=n.states.get(t.start),n}in(t){return this.currentState.name===t}go(t,i){var n,o;if(this.currentState.transitions.includes(t)||this.currentState.transitions.includes("*")){const h=this.states.get(t);return this.currentState.onExit&&((n=this.currentState)===null||n===void 0?void 0:n.onExit({to:h.name,data:this.data}))===!1||h?.onEnter&&h?.onEnter({from:this.currentState.name,eventData:i,data:this.data})===!1?!1:(this.currentState=h,!((o=this.currentState)===null||o===void 0)&&o.onState&&this.currentState.onState(),!0)}return!1}update(t){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,t)}save(t){localStorage.setItem(t,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(t){const i=JSON.parse(localStorage.getItem(t));this.currentState=this.states.get(i.currentState),this.data=i.data}}class Xu{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(t){this._loop=t,this._instance&&(this._instance.loop=t,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(t){t=bt(t,0,1),this._volume=t,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(t,this._audioContext.currentTime,.1):this._volumeNode.gain.value=t}get volume(){return this._volume}get duration(){var t;return(t=this._duration)!==null&&t!==void 0?t:this.getTotalPlaybackDuration()}set duration(t){this._duration=t}constructor(t){this._src=t,this._audioContext=yr.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new di,this._stateMachine=ra.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:i})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,i.pausedAt*this._playbackRate):this._instance.start(0,i.pausedAt*this._playbackRate,this.duration),i.startedAt=this._audioContext.currentTime-i.pausedAt,i.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:i})=>{i==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:i,data:n})=>{n.pausedAt=(i??0)/this._playbackRate,n.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:i})=>{i.pausedAt=0,i.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:i})=>{i.pausedAt=this._audioContext.currentTime-i.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(t=()=>{}){return this._playStarted=t,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(t){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",t)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:t,startedAt:i}=this._stateMachine.data;return t?t*this._playbackRate:i?(this._audioContext.currentTime-i)*this._playbackRate:0}set playbackRate(t){this._instance.playbackRate.value=this._playbackRate=t}get playbackRate(){return this._instance.playbackRate.value}}class ec extends wt{set bubbles(t){}get bubbles(){return!1}get _path(){return null}set _path(t){}constructor(t,i="MediaEvent"){super(),this.target=t,this._name=i}stopPropagation(){}action(){}propagate(){}layPath(t){}}class Ks extends ec{constructor(t,i){super(t,"NativeSoundEvent"),this.track=i}}class Yu extends ec{constructor(t,i){super(t,"NativeSoundProcessedEvent"),this._processedData=i,this.data=this._processedData}}function Tm(d){try{const t=new Audio,i=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,n=d.match(i)[1];return!!t.canPlayType("audio/"+n)}catch(t){return ct.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",t),!1}}const Pm={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class ju{set loop(t){this._loop=t;for(const i of this._tracks)i.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(t){this._volume=t;for(const i of this._tracks)i.volume=this._volume;this.events.emit("volumechange",new Ks(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(t){this._duration=t}get instances(){return this._tracks}get path(){return this._resource.path}set path(t){this._resource.path=t}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}constructor(...t){this.events=new Zt,this.logger=ct.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=yr.create(),this._resource=new Br("",tc.type.arraybuffer);for(const i of t)if(Tm(i)){this.path=i;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",t.join(", ")),this.logger.warn("Attempting to use",t[0]),this.path=t[0])}isLoaded(){return!!this.data}async load(){var t,i;if(this.data)return this.data;const n=await this._resource.load(),o=await this.decodeAudio(n.slice(0));return this._duration=(i=(t=this._duration)!==null&&t!==void 0?t:o?.duration)!==null&&i!==void 0?i:void 0,this.events.emit("processed",new Yu(this,o)),this.data=o}async decodeAudio(t){try{return await this._audioContext.decodeAudioData(t.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(t){t&&(this._engine=t,this._engine.on("hidden",()=>{t.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{t.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(t=>t.isPlaying())}isPaused(){return this._tracks.some(t=>t.isPaused())}isStopped(){return this._tracks.some(t=>t.isStopped())}play(t){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=t||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const t of this._tracks)t.pause();this.events.emit("pause",new Ks(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const t of this._tracks)t.stop();this.events.emit("stop",new Ks(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._tracks.forEach(i=>{i.playbackRate=this._playbackRate})}seek(t,i=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[i].seek(t)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(t=0){return this._tracks.length?this._tracks[t].getPlaybackPosition():0}getTrackId(t){return this._tracks.indexOf(t)}async _resumePlayback(){if(this.isPaused()){const t=[];for(const i of this._tracks)t.push(i.play().then(()=>(this._tracks.splice(this.getTrackId(i),1),!0)));this.events.emit("resume",new Ks(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(t)}return!0}async _startPlayback(){const t=this._getTrackInstance(this.data),i=await t.play(()=>{this.events.emit("playbackstart",new Ks(this,t)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new Ks(this,t));const n=this.getTrackId(t);return n!==-1&&this._tracks.splice(n,1),i}_getTrackInstance(t){var i;const n=new Xu(t);return n.loop=this.loop,n.volume=this.volume,n.duration=(i=this.duration)!==null&&i!==void 0?i:0,n.playbackRate=this._playbackRate,this._tracks.push(n),n}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const Sm={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function rl(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class Ar{get resources(){return this._resources}constructor(t){var i;this.events=new Zt,this.canvas=new na({filtering:pe.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new di,t&&(!((i=t.loadables)===null||i===void 0)&&i.length)&&this.addResources(t.loadables)}onInitialize(t){this.engine=t,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await Uo(500,this.engine.clock)}addResource(t){this._resources.push(t)}addResources(t){let i=0;const n=t.length;for(i;i<n;i++)this.addResource(t[i])}markResourceComplete(){this._numLoaded++}get progress(){const t=this._resources.length;return t>0?bt(this._numLoaded,0,t)/t:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(t,i){this._totalTimeMs+=i}onDraw(t){const i=this._totalTimeMs/1e3;t.fillStyle=K.Black.toRGBA(),t.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),t.save(),t.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const n=i*10;t.strokeStyle="white",t.lineWidth=10,t.lineCap="round",t.arc(0,0,40,n,n+Math.PI*3/2),t.stroke(),t.fillStyle="white",t.font="16px sans-serif";const o=(this.progress*100).toFixed(0)+"%",h=t.measureText(o),c=Math.abs(h.actualBoundingBoxLeft)+Math.abs(h.actualBoundingBoxRight),f=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);t.fillText(o,-c/2,f/2),t.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async t=>{this.events.emit("loadresourcestart",t),await t.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",t)})}));for(const t of this._resources)t instanceof ju&&t.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await sn.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const Em="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var Im=Te(851);class dn extends Ar{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const t=document.getElementById("excalibur-play-root");return t&&(this._playButtonRootElement=t),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(t){const i=Array.isArray(t)?{loadables:t}:t;super(i),this._logger=ct.getInstance(),this._originalOptions={loadables:[]},this.events=new Zt,this._playButtonShown=!1,this.logo=Em,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=K.White,this.backgroundColor="#176BAA",this._imageLoaded=new di,this.suppressPlayButton=!1,this._playButtonStyles=Im.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let n=document.getElementById("excalibur-play");return n||(n=document.createElement("button")),n.id="excalibur-play",n.textContent=this.playButtonText,n.style.display="none",n},this._originalOptions={...dn._DEFAULT_LOADER_OPTIONS,...i}}onInitialize(t){this.engine=t,this.screen=t.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var t,i;if(this.suppressPlayButton)this.hidePlayButton(),await Uo(500,(t=this.engine)===null||t===void 0?void 0:t.clock);else{const n=()=>{try{this._positionPlayButton()}catch{}};return!((i=this.engine)===null||i===void 0)&&i.browser&&this.engine.browser.window.on("resize",n),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",h=>{h.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(h=>{const c=f=>{var g;if(f.stopPropagation(),this.hidePlayButton(),!((g=this.engine)===null||g===void 0)&&g.browser&&this.engine.browser.window.off("resize",n),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(v){this._logger.error("could not go fullscreen",v)}h()};this._playButton.addEventListener("click",c),this._playButton.addEventListener("touchend",c),this._playButton.addEventListener("pointerup",c),this.engine&&this.engine.input.gamepads.once("button",()=>c(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var t;await Uo(200,(t=this.engine)===null||t===void 0?void 0:t.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const t=this._image;await this._imageLoaded.promise,await t?.decode()}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:t,y:i,width:n,height:o}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const h=this._playButton.clientWidth,c=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${t+n/2-h/2}px`,this._playButtonRootElement.style.top=`${i+o/2-c/2+100}px`)}}}onDraw(t){const i=this.engine.canvasHeight/this.engine.pixelRatio,n=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),t.fillStyle=this.backgroundColor,t.fillRect(0,0,n,i);let o=i/2;const h=Math.min(this.logoWidth,n*.75);let c=n/2-h/2;this.logoPosition&&(c=this.logoPosition.x,o=this.logoPosition.y);const f=Math.floor(h*(this.logoHeight/this.logoWidth)),g=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,c,o,h,f):t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,c,o-f-20,h,f),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=g;return}let v=c,x=o;this.loadingBarPosition&&(v=this.loadingBarPosition.x,x=this.loadingBarPosition.y),t.lineWidth=2,il(t,v,x,h,20,10,this.loadingBarColor);const b=h*this.progress,T=5,P=b-T*2,I=20-T*2;il(t,v+T,x+T,P>10?P:10,I,5,null,this.loadingBarColor),this.engine.screen.antialiasing=g}}dn._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const mu={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class Zu{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("2d"))},arrayBufferSupport:function(){const t=new XMLHttpRequest;t.open("GET","/");try{t.responseType="arraybuffer"}catch{return!1}return t.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const t=document.createElement("a").style;return t.cssText="background-color:rgba(150,255,150,.5)",(""+t.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let t=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const i=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],n=this.getBrowserFeatures();for(const o of Object.keys(mu))n[o]?(t+="(%c%c)",i.push("font-weight: bold; color: green"),i.push("font-weight: normal; color: inherit")):(t+="(%c%c)",i.push("font-weight: bold; color: red"),i.push("font-weight: normal; color: inherit")),t+=" "+mu[o]+`
`;i.unshift(t),console.log.apply(console,i)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let t=!1;for(const i in this._criticalTests)this._criticalTests[i].call(this)||(this.failedTests.push(i),ct.getInstance().error("Critical browser feature missing, Excalibur requires:",i),t=!0);if(t)return!1;for(const i in this._warningTest)this._warningTest[i]()||ct.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",i);return!0}}var ut;(function(d){d.PreventCollision="PreventCollision",d.Passive="Passive",d.Active="Active",d.Fixed="Fixed"})(ut||(ut={}));class Vi{static create(t,i){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(t)){const o=this._GROUPS.get(t);if(o.mask===i)return o;throw new Error(`Collision group ${t} already exists with a different mask!`)}const n=new fs(t,this._CURRENT_BIT,i!==void 0?i:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(t,n),n}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(t){return this._GROUPS.get(t)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}Vi._STARTING_BIT=1;Vi._MAX_GROUPS=32;Vi._CURRENT_GROUP=1;Vi._CURRENT_BIT=Vi._STARTING_BIT;Vi._GROUPS=new Map;class fs{constructor(t,i,n){this._name=t,this._category=i,this._mask=n}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(t){const i=this.category&t.mask,n=this.mask&t.category;return i!==0&&n!==0}invert(){const t=Vi.create("~("+this.name+")",~this.mask|0);return t._category=~this.category,t}static combine(t){const i=t.map(h=>h.name).join("+"),o=~t.reduce((h,c)=>c.category|h,0);return Vi.create(i,o)}static collidesWith(t){const i=`collidesWith(${t.map(o=>o.name).join("+")})`,n=t.reduce((o,h)=>h.category|o,0);return Vi.create(i,n)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}fs.All=new fs("Collide with all groups",-1,-1);class je{constructor(t,i){this.colliderA=t,this.colliderB=i,this.id=null,this.id=je.calculatePairHash(t.id,i.id)}static canCollide(t,i){var n,o;if(t.id===i.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.localBounds.hasZeroDimensions()||i.localBounds.hasZeroDimensions())return!1;const h=(n=t?.owner)===null||n===void 0?void 0:n.get(Ct),c=(o=i?.owner)===null||o===void 0?void 0:o.get(Ct);return!(!h||!c||!h.group.canCollide(c.group)||h.collisionType===ut.Fixed&&c.collisionType===ut.Fixed||c.collisionType===ut.PreventCollision||h.collisionType===ut.PreventCollision||!h.isActive||!c.isActive)}get canCollide(){const t=this.colliderA,i=this.colliderB;return je.canCollide(t,i)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(t){return t===this.colliderA||t===this.colliderB}static calculatePairHash(t,i){return t.value<i.value?`#${t.value}+${i.value}`:`#${i.value}+${t.value}`}}class zr{constructor(t,i){this.min=t,this.max=i}overlaps(t){return this.max>t.min&&t.max>this.min}getOverlap(t){return this.overlaps(t)?this.max>t.max?t.max-this.min:this.max-t.min:0}}class ol{constructor(t){this.parent=t,this.parent=t||null,this.data=null,this.bounds=new lt,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class ic{constructor(t,i=new lt(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=t,this.worldBounds=i,this.root=null,this.nodes={}}_insert(t){if(this.root===null){this.root=t,this.root.parent=null;return}const i=t.bounds;let n=this.root;for(;!n.isLeaf();){const f=n.left,g=n.right,v=n.bounds.getPerimeter(),b=n.bounds.combine(i).getPerimeter(),T=2*b,P=2*(b-v);let I=0;const F=i.combine(f.bounds);let R,S;f.isLeaf()?I=F.getPerimeter()+P:(S=f.bounds.getPerimeter(),R=F.getPerimeter(),I=R-S+P);let M=0;const W=i.combine(g.bounds);if(g.isLeaf()?M=W.getPerimeter()+P:(S=g.bounds.getPerimeter(),R=W.getPerimeter(),M=R-S+P),T<I&&T<M)break;I<M?n=f:n=g}const o=n.parent,h=new ol(o);h.bounds=i.combine(n.bounds),h.height=n.height+1,o!==null?(o.left===n?o.left=h:o.right=h,h.left=n,h.right=t,n.parent=h,t.parent=h):(h.left=n,h.right=t,n.parent=h,t.parent=h,this.root=h);let c=t.parent;for(;c;){if(c=this._balance(c),!c.left)throw new Error("Parent of current leaf cannot have a null left child"+c);if(!c.right)throw new Error("Parent of current leaf cannot have a null right child"+c);c.height=1+Math.max(c.left.height,c.right.height),c.bounds=c.left.bounds.combine(c.right.bounds),c=c.parent}}_remove(t){if(t===this.root){this.root=null;return}const i=t.parent,n=i.parent;let o;if(i.left===t?o=i.right:o=i.left,n){n.left===i?n.left=o:n.right=o,o.parent=n;let h=n;for(;h;)h=this._balance(h),h.bounds=h.left.bounds.combine(h.right.bounds),h.height=1+Math.max(h.left.height,h.right.height),h=h.parent}else this.root=o,o.parent=null}trackCollider(t){const i=new ol;i.data=t,i.bounds=t.bounds,i.bounds.left-=2,i.bounds.top-=2,i.bounds.right+=2,i.bounds.bottom+=2,this.nodes[t.id.value]=i,this._insert(i)}updateCollider(t){var i;const n=this.nodes[t.id.value];if(!n)return!1;const o=t.bounds;if(!this.worldBounds.contains(o))return ct.getInstance().warn("Collider with id "+t.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(t),!1;if(n.bounds.contains(o))return!1;if(this._remove(n),o.left-=this._config.boundsPadding,o.top-=this._config.boundsPadding,o.right+=this._config.boundsPadding,o.bottom+=this._config.boundsPadding,t.owner){const h=(i=t.owner)===null||i===void 0?void 0:i.get(Ct);if(h){const c=h.vel.x*32/1e3*this._config.velocityMultiplier,f=h.vel.y*32/1e3*this._config.velocityMultiplier;c<0?o.left+=c:o.right+=c,f<0?o.top+=f:o.bottom+=f}}return n.bounds=o,this._insert(n),!0}untrackCollider(t){const i=this.nodes[t.id.value];i&&(this._remove(i),this.nodes[t.id.value]=null,delete this.nodes[t.id.value])}_balance(t){if(t===null)throw new Error("Cannot balance at null node");if(t.isLeaf()||t.height<2)return t;const i=t.left,n=t.right,o=t,h=i,c=n,f=i.left,g=i.right,v=n.left,x=n.right,b=c.height-h.height;if(b>1)return c.left=o,c.parent=o.parent,o.parent=c,c.parent?c.parent.left===o?c.parent.left=c:c.parent.right=c:this.root=c,v.height>x.height?(c.right=v,o.right=x,x.parent=o,o.bounds=h.bounds.combine(x.bounds),c.bounds=o.bounds.combine(v.bounds),o.height=1+Math.max(h.height,x.height),c.height=1+Math.max(o.height,v.height)):(c.right=x,o.right=v,v.parent=o,o.bounds=h.bounds.combine(v.bounds),c.bounds=o.bounds.combine(x.bounds),o.height=1+Math.max(h.height,v.height),c.height=1+Math.max(o.height,x.height)),c;if(b<-1){if(h.left=o,h.parent=o.parent,o.parent=h,h.parent)if(h.parent.left===o)h.parent.left=h;else{if(h.parent.right!==o)throw"Error rotating Dynamic Tree";h.parent.right=h}else this.root=h;return f.height>g.height?(h.right=f,o.left=g,g.parent=o,o.bounds=c.bounds.combine(g.bounds),h.bounds=o.bounds.combine(f.bounds),o.height=1+Math.max(c.height,g.height),h.height=1+Math.max(o.height,f.height)):(h.right=g,o.left=f,f.parent=o,o.bounds=c.bounds.combine(f.bounds),h.bounds=o.bounds.combine(g.bounds),o.height=1+Math.max(c.height,f.height),h.height=1+Math.max(o.height,g.height)),h}return t}getHeight(){return this.root===null?0:this.root.height}query(t,i){const n=t.bounds,o=h=>{if(h&&h.bounds.overlaps(n))if(h.isLeaf()&&h.data!==t){if(i.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}rayCastQuery(t,i=1/0,n){const o=h=>{if(h&&h.bounds.rayCast(t,i))if(h.isLeaf()){if(n.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}getNodes(){const t=i=>i?[i].concat(t(i.left),t(i.right)):[];return t(this.root)}debug(t){const i=n=>{n&&(n.isLeaf()?n.bounds.draw(t,K.Green):n.bounds.draw(t,K.White),n.left&&i(n.left),n.right&&i(n.right))};i(this.root)}}class tn{constructor(t,i){this.pos=t,this.dir=i.normalize()}intersect(t){const i=t.begin.sub(this.pos);if(this.dir.cross(t.getSlope())===0&&i.cross(this.dir)!==0)return-1;const n=this.dir.cross(t.getSlope());if(n===0)return-1;const o=i.cross(t.getSlope())/n;if(o>=0){const h=i.cross(this.dir)/n/t.getLength();if(h>=0&&h<=1)return o}return-1}intersectPoint(t){const i=this.intersect(t);return i<0?null:this.getPoint(i)}getPoint(t){return this.pos.add(this.dir.scale(t))}}class $o{constructor(t){this._config=t,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new ic(t.dynamicTree)}getColliders(){return this._colliders}query(t){const i=[];return t instanceof lt?this._dynamicCollisionTree.query({id:on("collider",-1),owner:null,bounds:t},n=>(i.push(n),!1)):this._dynamicCollisionTree.query({id:on("collider",-1),owner:null,bounds:new lt(t.x,t.y,t.x,t.y)},n=>(i.push(n),!1)),i}rayCast(t,i){var n,o,h;const c=[],f=(n=i?.maxDistance)!==null&&n!==void 0?n:1/0,g=i?.collisionGroup,v=g?g.category:(o=i?.collisionMask)!==null&&o!==void 0?o:fs.All.category,x=(h=i?.searchAllColliders)!==null&&h!==void 0?h:!1;return this._dynamicCollisionTree.rayCastQuery(t,f,b=>{const P=b.owner.get(Ct);if(i?.ignoreCollisionGroupAll&&P.group===fs.All)return!1;const I=(v&P.group.category)!==0;if(P?.group&&!I)return!1;const F=b.rayCast(t,f);if(F){if(i?.filter){if(i.filter(F)&&(c.push(F),!x))return!0}else if(c.push(F),!x)return!0}return!1}),c}track(t){if(!t){ct.getInstance().warn("Cannot track null collider");return}if(t instanceof Ce){const i=t.getColliders();for(const n of i)n.owner=t.owner,this._colliders.push(n),this._dynamicCollisionTree.trackCollider(n)}else this._colliders.push(t),this._dynamicCollisionTree.trackCollider(t)}untrack(t){if(!t){ct.getInstance().warn("Cannot untrack a null collider");return}if(t instanceof Ce){const i=t.getColliders();for(const n of i){const o=this._colliders.indexOf(n);o!==-1&&this._colliders.splice(o,1),this._dynamicCollisionTree.untrackCollider(n)}}else{const i=this._colliders.indexOf(t);i!==-1&&this._colliders.splice(i,1),this._dynamicCollisionTree.untrackCollider(t)}}_pairExists(t,i){const n=je.calculatePairHash(t.id,i.id);return this._pairs.has(n)}broadphase(t,i,n){const o=i/1e3,h=t.filter(f=>{var g,v;const x=(g=f.owner)===null||g===void 0?void 0:g.get(Ct);return((v=f.owner)===null||v===void 0?void 0:v.isActive)&&x.collisionType!==ut.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let c;for(let f=0,g=h.length;f<g;f++)c=h[f],this._dynamicCollisionTree.query(c,v=>{if(!this._pairExists(c,v)&&je.canCollide(c,v)){const x=new je(c,v);this._pairs.add(x.id),this._collisionPairCache.push(x)}return!1});if(n&&(n.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const f of h){const g=f.owner.get(Ct);if(g.collisionType!==ut.Active)continue;const v=g.vel.magnitude*o+g.acc.magnitude*.5*o*o,x=Math.min(f.bounds.height,f.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||v>x/2){n&&n.physics.fastBodies++;const b=g.globalPos.sub(g.oldPos),T=f.center,P=f.getFurthestPoint(g.vel),I=P.sub(b),F=new tn(I,g.vel);F.pos=F.pos.add(F.dir.scale(-2*this._config.continuous.surfaceEpsilon));let R,S=new k(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(F,v+this._config.continuous.surfaceEpsilon*2,M=>{if(!this._pairExists(f,M)&&je.canCollide(f,M)){const W=M.rayCast(F,v+this._config.continuous.surfaceEpsilon*10);if(W){const U=W.point.sub(I);U.magnitude<S.magnitude&&(S=U,R=M)}}return!1}),R&&k.isValid(S)){const M=new je(f,R);this._pairs.has(M.id)||(this._pairs.add(M.id),this._collisionPairCache.push(M));const W=T.sub(P);g.globalPos=I.add(W).add(S).add(F.dir.scale(10*this._config.continuous.surfaceEpsilon)),f.update(g.transform.get()),n&&n.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(t,i){let n=[];for(let o=0;o<t.length;o++){const h=t[o].collide();if(n=n.concat(h),i&&h.length>0)for(const c of h)i.physics.contacts.set(c.id,c)}return i&&(i.physics.collisions+=n.length),n}update(t){let i=0;const n=t.length;for(let o=0;o<n;o++)this._dynamicCollisionTree.updateCollider(t[o])&&i++;return i}debug(t){this._dynamicCollisionTree.debug(t)}}class Us{constructor(){this.id=on("collider",Us._ID++),this.composite=null,this.events=new Zt,this.offset=k.Zero}touching(t){return!!this.collide(t)}}Us._ID=0;var Cr;(function(d){d.Arcade="arcade",d.Realistic="realistic"})(Cr||(Cr={}));var ps;(function(d){d.None="none",d.VerticalFirst="vertical-first",d.HorizontalFirst="horizontal-first"})(ps||(ps={}));const sc={vertical:1,horizontal:2},nc={horizontal:1,vertical:2},rc={horizontal:0,vertical:0};var kn;(function(d){d.DynamicTree="dynamic-tree",d.SparseHashGrid="sparse-hash-grid"})(kn||(kn={}));const us=()=>({enabled:!0,gravity:G(0,0).clone(),solver:Cr.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:kn.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:ps.None},realistic:{contactSolveBias:ps.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class Ce extends Us{set compositeStrategy(t){this._compositeStrategy=t}get compositeStrategy(){return this._compositeStrategy}constructor(t){super(),this._collisionProcessor=new $o({...us()}),this._dynamicAABBTree=new ic({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const i of t)this.addCollider(i)}clearColliders(){this._colliders=[]}addCollider(t){let i;t instanceof Ce?(i=t.getColliders(),i.forEach(n=>n.offset.addEqual(t.offset))):i=[t];for(const n of i)n.events.pipe(this.events),n.composite=this,this._colliders.push(n),this._collisionProcessor.track(n),this._dynamicAABBTree.trackCollider(n)}removeCollider(t){t.events.pipe(this.events),t.composite=null,Hn(t,this._colliders),this._collisionProcessor.untrack(t),this._dynamicAABBTree.untrackCollider(t)}getColliders(){return this._colliders}get worldPos(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:k.Zero).add(this.offset)}get center(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:k.Zero).add(this.offset)}get bounds(){var t,i;const n=this.getColliders();return n.reduce((h,c)=>h.combine(c.bounds),(i=(t=n[0])===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new lt().translate(this.worldPos)).translate(this.offset)}get localBounds(){var t,i;const n=this.getColliders();return n.reduce((h,c)=>h.combine(c.localBounds),(i=(t=n[0])===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new lt)}get axes(){const t=this.getColliders();let i=[];for(const n of t)i=i.concat(n.axes);return i}getFurthestPoint(t){const i=this.getColliders(),n=[];for(const c of i)n.push(c.getFurthestPoint(t));let o=n[0],h=-Number.MAX_VALUE;for(const c of n){const f=c.dot(t);f>h&&(o=c,h=f)}return o}getInertia(t){const i=this.getColliders();let n=0;for(const o of i)n+=o.getInertia(t);return n}collide(t){let i=[t];t instanceof Ce&&(i=t.getColliders());const n=[];for(const h of i)this._dynamicAABBTree.query(h,c=>(n.push(new je(h,c)),!1));let o=[];for(const h of n)o=o.concat(h.collide());return o}getClosestLineBetween(t){const i=this.getColliders(),n=[];if(t instanceof Ce){const o=t.getColliders();for(const h of i)for(const c of o){const f=h.getClosestLineBetween(c);f&&n.push(f)}}else for(const o of i){const h=t.getClosestLineBetween(o);h&&n.push(h)}if(n.length){let o=n[0].getLength(),h=n[0];for(const c of n){const f=c.getLength();f<o&&(o=f,h=c)}return h}return null}contains(t){const i=this.getColliders();for(const n of i)if(n.contains(t))return!0;return!1}rayCast(t,i){const n=this.getColliders(),o=[];for(const h of n){const c=h.rayCast(t,i);c&&o.push(c)}if(o.length){let h=o[0],c=h.point.dot(t.dir);for(const f of o){const g=t.dir.dot(f.point);g<c&&(h=f,c=g)}return h}return null}project(t){const i=this.getColliders(),n=[];for(const o of i){const h=o.project(t);h&&n.push(h)}if(n.length){const o=new zr(n[0].min,n[0].max);for(const h of n)o.min=Math.min(h.min,o.min),o.max=Math.max(h.max,o.max);return o}return null}update(t){if(t){const i=this.getColliders();for(const n of i)n.owner=this.owner,n.update(t)}}debug(t,i,n){const o=this.getColliders();t.save(),t.translate(this.offset.x,this.offset.y);for(const h of o)h.debug(t,i,n);t.restore()}clone(){const t=new Ce(this._colliders.map(i=>i.clone()));return t.offset=this.offset.clone(),t}}class ae{constructor(t,i){this.begin=t,this.end=i}clone(t){const i=t||new ae(this.begin.clone(),this.end.clone());return i.begin=this.begin.clone(i.begin),i.end=this.end.clone(i.end),i}transform(t,i){const n=i||new ae(k.Zero,k.Zero);return n.begin=t.multiply(this.begin,n.begin),n.end=t.multiply(this.end,n.end),n}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const t=this.begin,i=this.end,n=t.distance(i);return this._slope=i.sub(t).scale(1/n)}getEdge(){const t=this.begin;return this.end.sub(t)}getLength(){const t=this.begin,i=this.end;return t.distance(i)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new ae(this.end,this.begin)}below(t){return(this.end.x-this.begin.x)*(t.y-this.begin.y)-(this.end.y-this.begin.y)*(t.x-this.begin.x)>=0}clip(t,i,n=!0){let o=t;n&&(o=o.normalize());const h=o.dot(this.begin)-i,c=o.dot(this.end)-i,f=[];if(h<=0&&f.push(this.begin),c<=0&&f.push(this.end),h*c<0){const g=h/(h-c);f.push(this.begin.add(this.end.sub(this.begin).scale(g)))}return f.length!==2?null:new ae(f[0],f[1])}distanceToPoint(t,i=!1){const n=t.x,o=t.y,h=this.getLength(),c=this.end.y-this.begin.y,f=this.end.x-this.begin.x,g=(c*n-f*o+this.end.x*this.begin.y-this.end.y*this.begin.x)/h;return i?g:Math.abs(g)}findVectorToPoint(t){const i=this.begin.sub(t),n=this.getSlope();return i.sub(n.scale(i.dot(n)))}findPoint(t=null,i=null){const n=this.slope,o=this.intercept;if(t!==null)return new k(t,n*t+o);if(i!==null)return new k((i-o)/n,i);throw new Error("You must provide an X or a Y value")}hasPoint(){let t,i=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")t=new k(arguments[0],arguments[1]),i=arguments[2]||0;else if(arguments[0]instanceof k)t=arguments[0],i=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const n=t.x-this.begin.x,o=t.y-this.begin.y,h=this.end.x-this.begin.x,c=this.end.y-this.begin.y,f=n*c-o*h;return Math.abs(f)>i?!1:Math.abs(h)>=Math.abs(c)?h>0?this.begin.x<=t.x&&t.x<=this.end.x:this.end.x<=t.x&&t.x<=this.begin.x:c>0?this.begin.y<=t.y&&t.y<=this.end.y:this.end.y<=t.y&&t.y<=this.begin.y}}function Wh(d,t){const n=d.dir(),o=t.dir(),h=n.dot(n),c=o.dot(o);if(h<1e-9&&c<1e-9)return new ae(d.begin,t.begin);if(h<1e-9){const R=bt(o.dot(d.begin.sub(t.begin))/c,0,1),S=t.begin.add(o.scale(R));return new ae(d.begin,S)}if(c<1e-9){const R=bt(n.dot(t.begin.sub(d.begin))/h,0,1),S=d.begin.add(n.scale(R));return new ae(S,t.begin)}const f=d.begin.sub(t.begin),g=h,v=c,x=o.dot(f),b=g*v-Math.pow(n.dot(o),2);let T=0,P=0;Math.abs(b)>1e-9?T=bt((n.dot(o)*x-v*n.dot(f))/b,0,1):T=bt(n.dot(f)/g,0,1),Math.abs(v)>1e-9?P=bt((n.dot(o)*T+x)/v,0,1):P=0;const I=d.begin.add(n.scale(T)),F=t.begin.add(o.scale(P));return new ae(I,F)}const qi={PolygonPolygonClosestLine(d,t){const i=d.getSides(),n=t.getSides();let o=Number.MAX_VALUE,h=null;for(let c=0;c<i.length;c++)for(let f=0;f<n.length;f++){const g=Wh(i[c],n[f]),v=g.getLength();v<o&&(o=v,h=g)}return h},PolygonEdgeClosestLine(d,t){const n=t.worldPos.sub(d.worldPos),o=new tn(d.worldPos,n),h=d.rayCast(o).point.add(o.dir.scale(.1)),c=d.getClosestFace(h),f=t.asLine();return Wh(c.face,f)},PolygonCircleClosestLine(d,t){const i=t.worldPos,n=i.sub(d.worldPos),o=new tn(d.worldPos,n.normalize()),h=d.rayCast(o).point.add(o.dir.scale(.1)),c=d.getClosestFace(h),f=c.face.begin,g=c.face.getEdge();let v=(g.x*(i.x-f.x)+g.y*(i.y-f.y))/(g.x*g.x+g.y*g.y);v>1?v=1:v<0&&(v=0);const x=Math.sqrt(Math.pow(f.x+g.x*v-i.x,2)+Math.pow(f.y+g.y*v-i.y,2))-t.radius,b=(f.x+g.x*v-i.x)*t.radius/(t.radius+x),T=(f.y+g.y*v-i.y)*t.radius/(t.radius+x);return new ae(g.scale(v).add(f),new k(i.x+b,i.y+T))},CircleCircleClosestLine(d,t){const n=t.worldPos.sub(d.worldPos),h=d.worldPos.sub(t.worldPos),c=new tn(d.worldPos,n),f=new tn(t.worldPos,h),g=d.rayCast(c),v=t.rayCast(f);return new ae(g.point,v.point)},CircleEdgeClosestLine(d,t){const i=d.worldPos,n=t.asLine(),o=n.begin,h=n.getEdge(),c=o,f=h;let g=(f.x*(i.x-c.x)+f.y*(i.y-c.y))/(f.x*f.x+f.y*f.y);g>1?g=1:g<0&&(g=0);const v=Math.sqrt(Math.pow(c.x+f.x*g-i.x,2)+Math.pow(c.y+f.y*g-i.y,2))-d.radius,x=(c.x+f.x*g-i.x)*d.radius/(d.radius+v),b=(c.y+f.y*g-i.y)*d.radius/(d.radius+v);return new ae(f.scale(g).add(c),new k(i.x+x,i.y+b))},EdgeEdgeClosestLine(d,t){const i=d.asLine(),n=t.asLine();return Wh(i,n)}};class He extends Us{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var t;if(this._radius)return this._radius;const i=this._transform,n=(t=i?.globalScale)!==null&&t!==void 0?t:k.One;return this._radius=this._naturalRadius*Math.min(n.x,n.y)}set radius(t){var i;const n=this._transform,o=(i=n?.globalScale)!==null&&i!==void 0?i:k.One;this._naturalRadius=t/Math.min(o.x,o.y),this._localBoundsDirty=!0,this._radius=t}constructor(t){super(),this.offset=k.Zero,this._globalMatrix=_e.identity(),this._localBoundsDirty=!0,this.offset=t.offset||k.Zero,this.radius=t.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new He({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(t){var i,n;return((n=(i=this._transform)===null||i===void 0?void 0:i.pos)!==null&&n!==void 0?n:this.offset).distance(t)<=this.radius}rayCast(t,i=1/0){var n,o;const h=this.center,c=t.dir,f=t.pos,g=h.sub(f),v=c.scale(g.dot(c)),b=g.sub(v).magnitude;if(b>this.radius)return null;{let T=0;if(Du(b,this.radius,1e-4)){if(T=-c.dot(f.sub(h)),T>0&&T<i){const P=t.getPoint(T);return{point:P,normal:P.sub(h).normalize(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(Ct),distance:T}}return null}else{const P=Math.sqrt(Math.pow(c.dot(f.sub(h)),2)-Math.pow(f.sub(h).distance(),2)+Math.pow(this.radius,2)),I=-c.dot(f.sub(h))+P,F=-c.dot(f.sub(h))-P,R=[];I>=0&&R.push(I),F>=0&&R.push(F);const S=Math.min(...R);if(S<=i){const M=t.getPoint(S);return{point:M,normal:M.sub(h).normalize(),collider:this,body:(o=this.owner)===null||o===void 0?void 0:o.get(Ct),distance:S}}return null}}}getClosestLineBetween(t){if(t instanceof He)return qi.CircleCircleClosestLine(this,t);if(t instanceof Re)return qi.PolygonCircleClosestLine(t,this).flip();if(t instanceof oi)return qi.CircleEdgeClosestLine(this,t).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof He)return Ei.CollideCircleCircle(this,t);if(t instanceof Re)return Ei.CollideCirclePolygon(this,t);if(t instanceof oi)return Ei.CollideCircleEdge(this,t);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){return this.center.add(t.normalize().scale(this.radius))}getFurthestLocalPoint(t){return t.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new lt(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(t){return t*this.radius*this.radius/2}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(t){const i=[],o=this.center.dot(t);return i.push(o),i.push(o+this.radius),i.push(o-this.radius),new zr(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i,n){var o,h,c,f;const{lineWidth:g}={lineWidth:1,...n},v=this._transform,x=(o=v?.globalScale)!==null&&o!==void 0?o:k.One,b=(h=v?.globalRotation)!==null&&h!==void 0?h:0,T=(c=v?.globalPos)!==null&&c!==void 0?c:k.Zero;t.save(),t.translate(T.x,T.y),t.rotate(b),t.scale(x.x,x.y),t.drawCircle((f=this.offset)!==null&&f!==void 0?f:k.Zero,this._naturalRadius,K.Transparent,i,g),t.restore()}}class Js{constructor(t,i,n,o,h,c,f,g){var v,x,b,T,P,I;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=t,this.colliderB=i,this.mtv=n,this.normal=o,this.tangent=h,this.points=c,this.localPoints=f,this.info=g,this.id=je.calculatePairHash(t.id,i.id),t.composite||i.composite){const F=((v=t.composite)===null||v===void 0?void 0:v.compositeStrategy)==="separate"?t.id:(b=(x=t.composite)===null||x===void 0?void 0:x.id)!==null&&b!==void 0?b:t.id,R=((T=i.composite)===null||T===void 0?void 0:T.compositeStrategy)==="separate"?i.id:(I=(P=i.composite)===null||P===void 0?void 0:P.id)!==null&&I!==void 0?I:i.id;this.id+="|"+je.calculatePairHash(F,R)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(Ct)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(Ct))}matchAwake(){const t=this.bodyA,i=this.bodyB;t&&i&&t.isSleeping!==i.isSleeping&&(t.isSleeping&&t.collisionType!==ut.Fixed&&i.sleepMotion>=t.wakeThreshold&&(t.isSleeping=!1),i.isSleeping&&i.collisionType!==ut.Fixed&&t.sleepMotion>=i.wakeThreshold&&(i.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(t){if(t!==this.colliderA&&t!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(t===this.colliderA)return this;const i=this.colliderA,n=this.colliderB;return this.colliderB=i,this.colliderA=n,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class $u{constructor(){this.axis=G(0,0),this.localAxis=G(0,0),this.side=new ae(G(0,0),G(0,0)),this.localSide=new ae(G(0,0),G(0,0)),this.point=G(0,0),this.localPoint=G(0,0)}}class ue{static findPolygonPolygonSeparation(t,i){if(i.transform.matrix.determinant()===0)return ue.findPolygonPolygonSeparationDegenerate(t,i);let n=-Number.MAX_VALUE,o=-1,h;const c=i.transform.inverse.multiply(t.transform.matrix,ue._SCRATCH_MATRIX),f=c.getRotation(),g=t.normals,v=t.points,x=i.points;for(let P=0;P<v.length;P++){const I=g[P].rotate(f,ue._ZERO,ue._SCRATCH_NORMAL),F=c.multiply(v[P],ue._SCRATCH_POINT);let R=Number.MAX_VALUE,S;for(let M=0;M<x.length;M++){const W=I.dot(x[M].sub(F,ue._SCRATCH_SUB_POINT));W<R&&(R=W,S=x[M])}R>n&&(n=R,o=P,h=S)}const b=(o+1)%v.length,T=ue.SeparationPool.get();return T.collider=t,T.separation=n,n>0||(g[o].clone(T.localAxis),g[o].rotate(t.transform.rotation,ue._ZERO,T.axis),t.transform.matrix.multiply(v[o],T.side.begin),t.transform.matrix.multiply(v[b],T.side.end),i.transform.matrix.multiply(h,T.point),T.sideId=o,h.clone(T.localPoint),v[o].clone(T.localSide.begin),v[b].clone(T.localSide.end)),T}static findCirclePolygonSeparation(t,i){const n=i.axes,h=i.center.sub(t.worldPos),c=i.getFurthestPoint(h.negate());n.push(c.sub(t.worldPos).normalize());let f=Number.MAX_VALUE,g=null,v=-1;for(let x=0;x<n.length;x++){const b=i.project(n[x]),T=t.project(n[x]),P=b.getOverlap(T);if(P<=0)return null;P<f&&(f=P,g=n[x],v=x)}return v<0?null:g.normalize().scale(f)}static findPolygonPolygonSeparationDegenerate(t,i){let n=-Number.MAX_VALUE,o=null,h=null,c=-1,f=null;const g=t.getSides(),v=t.getLocalSides();for(let x=0;x<g.length;x++){const b=g[x],T=b.normal(),P=i.getFurthestPoint(T.negate()),I=b.distanceToPoint(P,!0);I>n&&(n=I,o=b,h=T,c=x,f=P)}return{collider:t,separation:h?n:99,axis:h,side:o,localSide:v[c],sideId:c,point:f,localPoint:h?i.getFurthestLocalPoint(h.negate()):null}}}ue.SeparationPool=new ea(()=>new $u,d=>d,500);ue._ZERO=G(0,0);ue._SCRATCH_POINT=G(0,0);ue._SCRATCH_SUB_POINT=G(0,0);ue._SCRATCH_NORMAL=G(0,0);ue._SCRATCH_MATRIX=_e.identity();ue.SeparationPool.disableWarnings=!0;const Rm=k.Zero,Dm=k.Zero,Mm=_e.identity(),Ei={CollideCircleCircle(d,t){const i=d.worldPos,n=t.worldPos,o=d.radius+t.radius,h=i.distance(n);if(h>o)return[];const c=o-h,f=n.sub(i).normalize(),g=f.perpendicular(),v=f.scale(c),x=d.getFurthestPoint(f),b=d.getFurthestLocalPoint(f),T={collider:d,separation:c,axis:f,point:x};return[new Js(d,t,v,f,g,[x],[b],T)]},CollideCirclePolygon(d,t){var i,n;let o=ue.findCirclePolygonSeparation(d,t);if(!o)return[];o=o.dot(t.center.sub(d.center))<0?o.negate():o;const c=d.getFurthestPoint(o),g=((n=(i=d.owner)===null||i===void 0?void 0:i.get(st))!==null&&n!==void 0?n:new st).applyInverse(c),v=o.normalize(),x={collider:d,separation:-o.magnitude,axis:v,point:c,localPoint:g,side:t.findSide(v.negate()),localSide:t.findLocalSide(v.negate())};return[new Js(d,t,o,v,v.perpendicular(),[c],[g],x)]},CollideCircleEdge(d,t){const i=d.center,n=t.asLine(),o=n.end.sub(n.begin),h=o.dot(n.end.sub(i)),c=o.dot(i.sub(n.begin)),f=t.asLine(),g=t.asLocalLine();if(c<=0){const S=n.begin.sub(i),M=S.dot(S);if(M>d.radius*d.radius)return[];const W=S.normalize(),U=d.radius-Math.sqrt(M),V={collider:d,separation:U,axis:W,point:f.begin,side:f,localSide:g};return[new Js(d,t,W.scale(U),W,W.perpendicular(),[f.begin],[g.begin],V)]}if(h<=0){const S=n.end.sub(i),M=S.dot(S);if(M>d.radius*d.radius)return[];const W=S.normalize(),U=d.radius-Math.sqrt(M),V={collider:d,separation:U,axis:W,point:f.end,side:f,localSide:g};return[new Js(d,t,W.scale(U),W,W.perpendicular(),[f.end],[g.end],V)]}const v=o.dot(o),x=n.begin.scale(h).add(n.end.scale(c)).scale(1/v),b=i.sub(x),T=b.dot(b);if(T>d.radius*d.radius)return[];let P=o.perpendicular();P.dot(i.sub(n.begin))<0&&(P.x=-P.x,P.y=-P.y),P=P.normalize();const I=d.radius-Math.sqrt(T),F=P.scale(I),R={collider:d,separation:I,axis:P,point:x,side:f,localSide:g};return[new Js(d,t,F,P.negate(),P.negate().perpendicular(),[x],[x.sub(t.worldPos)],R)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(d,t){var i;const n=d.center,h=t.center.sub(n).normalize(),c=new Re({points:[t.begin,t.end,t.end.add(h.scale(100)),t.begin.add(h.scale(100))],offset:t.offset});c.owner=t.owner,((i=t.owner)===null||i===void 0?void 0:i.get(st))&&c.update(t.owner.get(st).get());const g=this.CollidePolygonPolygon(d,c);return g.length&&(g[0].colliderB=t,g[0].id=je.calculatePairHash(d.id,t.id)),g},CollidePolygonPolygon(d,t){const i=ue.findPolygonPolygonSeparation(d,t);if(i.separation>0)return[];const n=ue.findPolygonPolygonSeparation(t,d);if(n.separation>0)return[];const o=i.separation>n.separation?i:n,h=o.collider===d?t:d,c=o.collider===d?d:t,f=h.transform.inverse.multiply(c.transform.matrix,Mm),g=f.getRotation(),v=c.normals[o.sideId].rotate(g,Rm,Dm);let x=Number.MAX_VALUE,b=0;for(let S=0;S<h.normals.length;S++){const M=v.dot(h.normals[S]);M<x&&(x=M,b=S)}if(!o.localSide||!o.localAxis||!o.axis)return[];const T=o.localSide.transform(f),P=o.localAxis.perpendicular().negate().rotate(g),F=new ae(h.points[b],h.points[(b+1)%h.points.length]).clip(P.negate(),-P.dot(T.begin),!1);let R=null;if(F&&(R=F.clip(P,P.dot(T.end),!1)),R){const S=[],M=[],W=R.getPoints();for(let j=0;j<W.length;j++){const q=W[j];T.below(q)&&(S.push(q),M.push(h.transform.apply(q)))}let U=o.axis,V=U.perpendicular();return t.center.sub(d.center).dot(U)<0&&(U=U.negate(),V=U.perpendicular()),[new Js(d,t,U.scale(-o.separation),U,V,M,S,o)]}return[]},FindContactSeparation(d,t){var i,n,o,h;const c=d.colliderA,f=(n=(i=d.bodyA)===null||i===void 0?void 0:i.transform)!==null&&n!==void 0?n:new st,g=d.colliderB,v=(h=(o=d.bodyB)===null||o===void 0?void 0:o.transform)!==null&&h!==void 0?h:new st;if(c instanceof He&&g instanceof He){const x=c.radius+g.radius,b=f.pos.distance(v.pos);return-(x-b)}if(c instanceof Re&&g instanceof Re&&d.info.localSide){let x,b;return d.info.collider===c?(x=new ae(f.apply(d.info.localSide.begin).add(c.offset),f.apply(d.info.localSide.end).add(c.offset)),b=v.apply(t).add(g.offset)):(x=new ae(v.apply(d.info.localSide.begin).add(g.offset),v.apply(d.info.localSide.end).add(g.offset)),b=f.apply(t).add(c.offset)),x.distanceToPoint(b,!0)}if(c instanceof Re&&g instanceof He||g instanceof Re&&c instanceof He){const x=f.apply(t);if(d.info.side)return d.info.side.distanceToPoint(x,!0)}if(c instanceof oi&&g instanceof Re||g instanceof oi&&c instanceof Re){let x;if(d.info.collider===c?x=v.apply(t):x=f.apply(t),d.info.side)return d.info.side.distanceToPoint(x,!0)}if(c instanceof He&&g instanceof oi||g instanceof He&&c instanceof oi){const x=v.apply(t);let b;c instanceof He&&(b=c.getFurthestPoint(d.normal));const T=x.distance(b);if(d.info.side)return T>0?-T:0}return 0}};class oi extends Us{constructor(t){var i;super(),this._globalMatrix=_e.identity(),this.begin=t.begin||k.Zero,this.end=t.end||k.Zero,this.offset=(i=t.offset)!==null&&i!==void 0?i:k.Zero}clone(){return new oi({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var t;const i=this._transform;return(t=i?.globalPos.add(this.offset))!==null&&t!==void 0?t:this.offset}get center(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.average(i)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const t=this._getTransformedBegin(),i=this._getTransformedEnd(),n=t.distance(i);return i.sub(t).scale(1/n)}getLength(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.distance(i)}contains(){return!1}rayCast(t,i=1/0){var n;const o=this._getTransformedBegin().sub(t.pos);if(t.dir.cross(this.getSlope())===0&&o.cross(t.dir)!==0)return null;const h=t.dir.cross(this.getSlope());if(h===0)return null;const c=o.cross(this.getSlope())/h;if(c>=0&&c<=i){const f=o.cross(t.dir)/h/this.getLength();if(f>=0&&f<=1)return{distance:c,normal:this.asLine().normal(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(Ct),point:t.getPoint(c)}}return null}getClosestLineBetween(t){if(t instanceof He)return qi.CircleEdgeClosestLine(t,this);if(t instanceof Re)return qi.PolygonEdgeClosestLine(t,this).flip();if(t instanceof oi)return qi.EdgeEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof He)return Ei.CollideCircleEdge(t,this);if(t instanceof Re)return Ei.CollidePolygonEdge(t,this);if(t instanceof oi)return Ei.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this._getTransformedBegin(),n=this._getTransformedEnd();return t.dot(i)>0?i:n}_boundsFromBeginEnd(t,i,n=10){return new lt(Math.min(t.x,i.x)-n,Math.min(t.y,i.y)-n,Math.max(t.x,i.x)+n,Math.max(t.y,i.y)+n)}get bounds(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return this._boundsFromBeginEnd(t,i)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new ae(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new ae(this.begin,this.end)}get axes(){const i=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),n=[];return n.push(i),n.push(i.negate()),n.push(i.normal()),n.push(i.normal().negate()),n}getInertia(t){const i=this.end.sub(this.begin).distance()/2;return t*i*i}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(t){const i=[],n=[this._getTransformedBegin(),this._getTransformedEnd()],o=n.length;for(let h=0;h<o;h++)i.push(n[h].dot(t));return new zr(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i){const n=this._getTransformedBegin(),o=this._getTransformedEnd();t.drawLine(n,o,i,2),t.drawCircle(n,2,i),t.drawCircle(o,2,i)}}class Ae{static registerGraphicsContext(t){Ae._ctx=t}static draw(t){this._drawCalls.push(t)}static drawPoint(t,i){Ae.draw(n=>{n.debug.drawPoint(t,i)})}static drawLine(t,i,n){Ae.draw(o=>{o.debug.drawLine(t,i,n)})}static drawLines(t,i){t.length>1&&Ae.draw(n=>{for(let o=0;o<t.length-1;o++)n.debug.drawLine(t[o],t[o+1],i)})}static drawText(t,i){Ae.draw(n=>{n.debug.drawText(t,i)})}static drawPolygon(t,i){t.length>1&&Ae.draw(n=>{const o=t[0],h=[...t,o];for(let c=0;c<h.length-1;c++)n.debug.drawLine(h[c],h[c+1],i)})}static drawCircle(t,i,n){const{color:o,strokeColor:h,width:c}={color:K.Black,strokeColor:void 0,width:void 0,...n};Ae.draw(f=>{f.drawCircle(t,i,o,h,c)})}static drawBounds(t,i){Ae.draw(n=>{n.debug.drawRect(t.left,t.top,t.width,t.height,i)})}static drawRay(t,i){const{distance:n,color:o}={color:K.Blue,distance:10,...i};Ae.draw(h=>{const c=t.pos,f=t.pos.add(t.dir.scale(n));h.debug.drawLine(c,f,{color:o})})}static flush(t){t.save(),t.z=Ae.z;for(const i of Ae._drawCalls)i(t);t.restore(),Ae.clear()}static clear(){Ae._drawCalls.length=0}}Ae._drawCalls=[];Ae.z=1/0;class Re extends Us{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(t){if(t.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=t,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const t=[];for(let i=0;i<this._points.length;i++)t.push(this._points[(i+1)%this._points.length].sub(this._points[i]).normal());this._normals=t}get points(){return this._points}get transform(){return this._transform}constructor(t){var i;super(),this._logger=ct.getInstance(),this._transform=new _s,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(i=t.offset)!==null&&i!==void 0?i:k.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=t.points,this.isConvex()||t.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(t){this._isCounterClockwiseWinding(t)||t.reverse()}_isCounterClockwiseWinding(t){let i=0;for(let n=0;n<t.length;n++)i+=(t[(n+1)%t.length].x-t[n].x)*(t[(n+1)%t.length].y+t[n].y);return i<0}isConvex(){if(this.points.length<3)return!1;let t=this.points[this.points.length-2],i=this.points[this.points.length-1],n=Math.atan2(i.y-t.y,i.x-t.x),o=0,h=0,c=0;for(const[f,g]of this.points.entries()){if(t=i,o=n,i=g,n=Math.atan2(i.y-t.y,i.x-t.x),t.equals(i))return!1;let v=n-o;if(v<=-Math.PI?v+=Math.PI*2:v>Math.PI&&(v-=Math.PI*2),f===0){if(v===0)return!1;h=v>0?1:-1}else if(h*v<=0)return!1;c+=v}return Math.abs(Math.round(c/(Math.PI*2)))===1}tessellate(){const t=[];for(let i=1;i<this.points.length-2;i++)t.push([this.points[0],this.points[i+1],this.points[i+2]]);return t.push([this.points[0],this.points[1],this.points[2]]),new Ce(t.map(i=>Oe.Polygon(i)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const t=[],i=[...this.points].reverse();let n=i.length;function o(b){return b===0?n-1:b-1}function h(b){return b===n-1?0:b+1}function c(b){const T=o(b),P=h(b),I=i[T],F=i[b],R=i[P],S=I.sub(F),M=R.sub(F);return!(S.cross(M)<0)}const f=i.map((b,T)=>c(T));function g(b,T,P,I){const F=P.sub(T),R=I.sub(P),S=T.sub(I),M=b.sub(T),W=b.sub(P),U=b.sub(I),V=F.cross(M),j=R.cross(W),q=S.cross(U);return!(V>0||j>0||q>0)}function v(){for(let b=0;b<n;b++)if(f[b]){const T=o(b),P=h(b),I=i[T],F=i[b],R=i[P];let S=!0;for(let M=0;M<n;M++){if(M===b||M===T||M===P)continue;const W=i[M];if(g(W,I,F,R)){S=!1;break}}if(S)return b}for(let b=0;b<n;b++)if(f[b])return b;return 0}function x(b){const T=o(b),P=h(b),I=i[T],F=i[b],R=i[P];t.push([I,F,R]),i.splice(b,1),f.splice(b,1),n--}for(;n>3;){const b=v();x(b);for(let T=0;T<n;T++)f[T]=c(T)}return t.push([i[0],i[1],i[2]]),new Ce(t.map(b=>Oe.Polygon(b,k.Zero,!0)))}clone(){return new Re({offset:this.offset.clone(),points:this.points.map(t=>t.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const t=this.points,i=t.length;this._transformedPoints.length=0;for(let n=0;n<i;n++)this._transformedPoints[n]=this._transform.apply(t[n].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const t=[],i=this.getTransformedPoints(),n=i.length;for(let o=0;o<n;o++)t.push(new ae(i[o],i[(o+1)%n]));this._sides=t,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const t=[],i=this.points,n=i.length;for(let o=0;o<n;o++)t.push(new ae(i[o],i[(o+1)%n]));this._localSides=t,this._localSidesDirty=!1}return this._localSides}findSide(t){const i=this.getSides();let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=i[h],g=c.normal().dot(t);g>o&&(n=c,o=g)}return n}findLocalSide(t){const i=this.getLocalSides();let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=i[h],g=c.normal().dot(t);g>o&&(n=c,o=g)}return n}get axes(){const t=[],i=this.getSides();for(let n=0;n<i.length;n++)t.push(i[n].normal());return t}update(t){t&&(t.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(i=>G(i.x*Nt(this._transform.scale.x),i.y*Nt(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(t){const i=this._transform.applyInverse(t),n=new tn(i,new k(1,0));let o=0;const h=this.getLocalSides();for(let c=0;c<h.length;c++){const f=h[c];n.intersect(f)>=0&&o++}return o%2!==0}getClosestLineBetween(t){if(t instanceof He)return qi.PolygonCircleClosestLine(this,t);if(t instanceof Re)return qi.PolygonPolygonClosestLine(this,t);if(t instanceof oi)return qi.PolygonEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof He)return Ei.CollideCirclePolygon(t,this);if(t instanceof Re)return Ei.CollidePolygonPolygon(this,t);if(t instanceof oi)return Ei.CollidePolygonEdge(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this.getTransformedPoints();let n=null,o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=t.dot(i[h]);c>o&&(o=c,n=i[h])}return n}getFurthestLocalPoint(t){const i=this.points;let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=t.dot(i[h]);c>o&&(o=c,n=i[h])}return n}getClosestFace(t){const i=this.getSides();let n=Number.POSITIVE_INFINITY,o=-1,h=-1;for(let c=0;c<i.length;c++){const f=i[c].distanceToPoint(t);f<n&&(n=f,o=c,h=f)}return o!==-1?{distance:i[o].normal().scale(h),face:i[o]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=lt.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(t){if(this._cachedMass===t&&this._cachedInertia)return this._cachedInertia;let i=0,n=0;const o=this.points;for(let h=0;h<o.length;h++){const c=(h+1)%o.length,f=o[c].cross(o[h]);i+=f*(o[h].dot(o[h])+o[h].dot(o[c])+o[c].dot(o[c])),n+=f}return this._cachedMass=t,this._cachedInertia=t/6*(i/n)}rayCast(t,i=1/0){var n;const o=this.getSides(),h=o.length;let c=Number.MAX_VALUE,f,g=-1;for(let v=0;v<h;v++){const x=t.intersect(o[v]);x>=0&&x<c&&x<=i&&(c=x,f=o[v],g=v)}return g>=0?{collider:this,distance:c,body:(n=this.owner)===null||n===void 0?void 0:n.get(Ct),point:t.getPoint(c),normal:f.normal()}:null}project(t){const i=this.getTransformedPoints(),n=i.length;let o=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let c=0;c<n;c++){const f=i[c].dot(t);o=Math.min(o,f),h=Math.max(h,f)}return new zr(o,h)}debug(t,i,n){const o=this.getTransformedPoints();Ae.drawPolygon(o,{color:i})}}class Oe{static Box(t,i,n=k.Half,o=k.Zero){return new Re({points:new lt(-t*n.x,-i*n.y,t-t*n.x,i-i*n.y).getPoints(),offset:o})}static Polygon(t,i=k.Zero,n=!1){return new Re({points:t,offset:i,suppressConvexWarning:n})}static Circle(t,i=k.Zero){return new He({radius:t,offset:i})}static Edge(t,i){return new oi({begin:t,end:i})}static Capsule(t,i,n=k.Zero){const o=ct.getInstance();return t===i&&o.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),i>=t?new Ce([Oe.Circle(t/2,G(0,-i/2+t/2).add(n)),Oe.Box(t,i-t,k.Half,n),Oe.Circle(t/2,G(0,i/2-t/2).add(n))]):new Ce([Oe.Circle(i/2,G(-t/2+i/2,0).add(n)),Oe.Box(t-i,i,k.Half,n),Oe.Circle(i/2,G(t/2-i/2,0).add(n))])}}class fe extends fi{constructor(t){super(),this.events=new Zt,this.$colliderAdded=new Ye,this.$colliderRemoved=new Ye,this._collidersToRemove=[],this.set(t)}get(){return this._collider}set(t){return this.clear(),t&&(this._collider=t,this._collider.owner=this.owner,t.events.pipe(this.events),this.$colliderAdded.notifyAll(t),this.update()),t}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const t of this._collidersToRemove)t.events.unpipe(this.events),this.$colliderRemoved.notifyAll(t),t.owner=null}clone(){return new fe(this._collider.clone())}get bounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new lt}get localBounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new lt}update(){var t;const i=(t=this.owner)===null||t===void 0?void 0:t.get(st);this._collider&&(this._collider.owner=this.owner,i&&this._collider.update(i.get()))}collide(t){let i=this._collider,n=t._collider;if(!i||!n)return[];let o=!1;if(n instanceof Ce&&(i=n,n=this._collider,o=!0),this._collider){const h=i.collide(n);return h?(o&&h.forEach(c=>{c.mtv=c.mtv.negate(),c.normal=c.normal.negate(),c.tangent=c.normal.perpendicular(),c.colliderA=this._collider,c.colliderB=t._collider}),h):[]}return[]}onAdd(t){this._collider&&this.update(),this.events.on("precollision",i=>{const n=i;t.events.emit("precollision",new ln(n.self,n.other,n.side,n.intersection,n.contact)),t instanceof Ze&&t.onPreCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("postcollision",i=>{const n=i;t.events.emit("postcollision",new cn(n.self,n.other,n.side,n.intersection,n.contact)),t instanceof Ze&&t.onPostCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("collisionstart",i=>{const n=i;t.events.emit("collisionstart",new xr(n.self,n.other,n.side,n.contact)),t instanceof Ze&&t.onCollisionStart(n.self,n.other,n.side,n.contact)}),this.events.on("collisionend",i=>{const n=i;t.events.emit("collisionend",new br(n.self,n.other,n.side,n.lastContact)),t instanceof Ze&&t.onCollisionEnd(n.self,n.other,n.side,n.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(t,i,n=k.Half,o=k.Zero){const h=Oe.Box(t,i,n,o);return this.set(h)}usePolygonCollider(t,i=k.Zero){const n=Oe.Polygon(t,i);return this.set(n)}useCircleCollider(t,i=k.Zero){const n=Oe.Circle(t,i);return this.set(n)}useEdgeCollider(t,i){const n=Oe.Edge(t,i);return this.set(n)}useCompositeCollider(t){return this.set(new Ce(t))}}var ti;(function(d){d.Rotation="rotation",d.X="x",d.Y="y"})(ti||(ti={}));class Ct extends fi{constructor(t){var i,n,o;super(),this.dependencies=[st,Mt],this.id=on("body",Ct._ID++),this.events=new Zt,this.oldTransform=new _s,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=ut.PreventCollision,this.group=fs.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=k.Zero,this.oldVel=new k(0,0),this.oldAcc=k.Zero,this._impulseScratch=G(0,0),this._distanceFromCenterScratch=G(0,0),t?(this.collisionType=(i=t.type)!==null&&i!==void 0?i:this.collisionType,this.group=(n=t.group)!==null&&n!==void 0?n:this.group,this.useGravity=(o=t.useGravity)!==null&&o!==void 0?o:this.useGravity,this._bodyConfig={...us().bodies,...t.config}):this._bodyConfig={...us().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=Ct._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(t){this._bodyConfig={...us().bodies,...t},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(t){Ct._DEFAULT_CONFIG=t}get mass(){return this._mass}set mass(t){this._mass=t,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===ut.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(t){this.isSleeping=t}set isSleeping(t){this._sleeping=t,t?(this.vel=k.Zero,this.acc=k.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const t=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),i=this._bodyConfig.sleepBias;this.sleepMotion=i*this.sleepMotion+(1-i)*t,this.sleepMotion=bt(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const t=this.owner.get(fe);if(t){t.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),t.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const i=t.get();if(i)return this._cachedInertia=i.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===ut.Fixed?0:1/this.inertia}get active(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get isActive(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get center(){return this.globalPos}onAdd(t){var i,n;this.transform=(i=this.owner)===null||i===void 0?void 0:i.get(st),this.motion=(n=this.owner)===null||n===void 0?void 0:n.get(Mt)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get globalPos(){return this.transform.globalPos}set globalPos(t){this.transform.globalPos=t}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t}get torque(){return this.motion.torque}set torque(t){this.motion.torque=t}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(t){this.transform.globalRotation=t}get scale(){return this.transform.globalScale}set scale(t){this.transform.globalScale=t}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(t){this.motion.scaleFactor=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}applyImpulse(t,i){if(this.collisionType!==ut.Active)return;const n=i.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(ti.X)>-1&&(n.x=0),this.limitDegreeOfFreedom.indexOf(ti.Y)>-1&&(n.y=0),this.vel.addEqual(n),!this.limitDegreeOfFreedom.includes(ti.Rotation)){const o=t.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*o.cross(i)}}applyLinearImpulse(t){if(this.collisionType!==ut.Active)return;const i=t.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(ti.X)&&(i.x=0),this.limitDegreeOfFreedom.includes(ti.Y)&&(i.y=0),this.vel=this.vel.add(i)}applyAngularImpulse(t,i){if(this.collisionType===ut.Active&&!this.limitDegreeOfFreedom.includes(ti.Rotation)){const n=t.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*n.cross(i)}}captureOldTransform(){this.__oldTransformCaptured=!0;const t=this.transform.get();t.clone(this.oldTransform),this.oldTransform.parent=t.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}Ct._ID=0;Ct._DEFAULT_CONFIG={...us().bodies};class Hr extends Wn{constructor(t){super(t),this.width=t.width,this.height=t.height,this.rasterize()}clone(){return new Hr({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.color&&t.fillRect(0,0,this.width,this.height),this.strokeColor&&t.strokeRect(0,0,this.width,this.height)}}class oa extends Wn{get radius(){return this._radius}set radius(t){this._radius=t,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(t){var i,n,o;super(t),this._radius=0;const h=(i=t.lineWidth)!==null&&i!==void 0?i:t.strokeColor?1:0;this.padding=(n=t.padding)!==null&&n!==void 0?n:2+h/2,this.radius=t.radius,this.filtering=(o=t.filtering)!==null&&o!==void 0?o:pe.Blended,this.rasterize()}clone(){return new oa({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.radius>0&&(t.beginPath(),t.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&t.fill(),this.strokeColor&&t.stroke())}}class Fs extends fi{constructor(t){var i,n;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(i=t?.useColliderShape)!==null&&i!==void 0?i:this.useColliderShape,this.useGraphicsBounds=(n=t?.useGraphicsBounds)!==null&&n!==void 0?n:this.useGraphicsBounds,this.localBounds=t?.localBounds}}class Wt{static CreateReversibleEasingFunction(t){return(i,n,o,h)=>o<n?n-(t(i,o,n,h)-o):t(i,n,o,h)}static CreateVectorEasingFunction(t){return(i,n,o,h)=>new k(t(i,n.x,o.x,h),t(i,n.y,o.y,h))}}Wt.Linear=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,i*d/n+t));Wt.EaseInQuad=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,i*d*d+t));Wt.EaseOutQuad=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,-i*d*(d-2)+t));Wt.EaseInOutQuad=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n/2,d<1?i/2*d*d+t:(d--,-i/2*(d*(d-2)-1)+t)));Wt.EaseInCubic=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,i*d*d*d+t));Wt.EaseOutCubic=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,d--,i*(d*d*d+1)+t));Wt.EaseInOutCubic=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n/2,d<1?i/2*d*d*d+t:(d-=2,i/2*(d*d*d+2)+t)));class Qu{constructor(t){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=t}add(t){this._actions.push(t)}remove(t){const i=this._actions.indexOf(t);this._actions.splice(i,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const t=this._actions.length;for(let i=0;i<t;i++)this._actions[i].reset();this._completedActions=[]}update(t){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new $l(this._currentAction,this._entity))),this._currentAction.update(t),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new Ql(this._currentAction,this._entity));const i=this._actions.shift();i&&this._completedActions.push(i)}}}let Fm=0;function zt(){return Fm++}class Ku{constructor(t,i,n){this.id=zt(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new Nr(t),this._actionQueue=this._repeatContext.getQueue(),this._repeat=n,this._originalRepeat=n,this._repeatBuilder(this._repeatContext),this._repeat--}update(t){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(t)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class Ju{constructor(t,i){this.id=zt(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new Nr(t),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(t){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(t))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function t_(d,t,i){return(1-i)*d+t*i}function oc(d,t,i,n){const o=(d-t+me)%me>=Math.PI,h=Math.abs(t-d),c=me-h;let f=0,g=0;h>c?(f=c,g=h):(f=h,g=c);let v=0,x=1;switch(i){case ee.ShortestPath:v=f,x=o?1:-1;break;case ee.LongestPath:v=g,x=o?-1:1;break;case ee.Clockwise:x=1,v=o?f:g;break;case ee.CounterClockwise:x=-1,v=o?g:f;break}return d+x*(v*n)}function Or(d,t,i){return d.scale(1-i).add(t.scale(i))}function e_(d,t,i){return(i-d)/(t-d)}function i_(d,t,i){const n=i.sub(d),o=t.sub(d),h=n.x/o.x,c=n.y/o.y;return Math.min(h,c)}function Yi(d,t,i,n,o){const h=e_(d,t,o);return t_(i,n,h)}function Bm(d,t,i,n,o){const h=i_(d,t,o);return Or(i,n,h)}function s_(d){return d.offset instanceof k&&typeof d.duration=="number"}class n_{constructor(t,i){var n;if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._easing=Wt.Linear,this._offset=i.offset,this._easing=(n=i.easing)!==null&&n!==void 0?n:this._easing,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=t;const i=bt(Yi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),c=(o-n.x)/(t/1e3),f=(h-n.y)/(t/1e3);this._motion.vel.x=c,this._motion.vel.y=f,this.isComplete(this.entity)&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=G(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class al{constructor(t,i,n,o){if(this.id=zt(),this._started=!1,this._stopped=!1,this._entity=t,this._tx=t.get(st),this._motion=t.get(Mt),this._speed=o,this._offset=new k(i,n),o<=0)throw ct.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+o),new Error("Speed must be greater than 0 pixels per second")}update(t){this._started||(this._started=!0,this._start=new k(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(t){const i=t.get(st);return this._stopped||i.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=G(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function r_(d){return d.pos instanceof k&&typeof d.duration=="number"}class o_{constructor(t,i){var n;if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._easing=Wt.Linear,this._end=i.pos,this._easing=(n=i.easing)!==null&&n!==void 0?n:this._easing,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=t;const i=bt(Yi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),c=(o-n.x)/(t/1e3),f=(h-n.y)/(t/1e3);this._motion.vel.x=c,this._motion.vel.y=f,this.isComplete(this.entity)&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=G(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class hl{constructor(t,i,n,o){this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._end=new k(i,n),this._speed=o}update(t){this._started||(this._started=!0,this._start=new k(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const i=this._dir.scale(this._speed);this._motion.vel=G(i.x,i.y),this.isComplete(this.entity)&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(t){const i=t.get(st);return this._stopped||new k(i.pos.x,i.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=G(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function km(d){return typeof d.angle=="number"&&typeof d.duration=="number"}class a_{constructor(t,i){var n;if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=i.angle,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(n=i.rotationType)!==null&&n!==void 0?n:ee.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=t;const i=bt(Yi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=oc(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(n-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class h_{constructor(t,i,n,o){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._end=i,this._speed=n,this._rotationType=o||ee.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const i=Math.abs(this._end-this._start),n=me-i;switch(i>n?(this._shortDistance=n,this._longDistance=i):(this._shortDistance=i,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+me)%me>=Math.PI,this._rotationType){case ee.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case ee.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case ee.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case ee.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Lm(d){return typeof d.angleRadiansOffset=="number"&&typeof d.duration=="number"}class l_{constructor(t,i){var n;if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=i.angleRadiansOffset,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(n=i.rotationType)!==null&&n!==void 0?n:ee.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._endAngle=cs(this._startAngle+this._offset),this._started=!0),this._currentMs-=t;const i=bt(Yi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=oc(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(n-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class c_{constructor(t,i,n,o){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._speed=n,this._offset=i,this._rotationType=o||ee.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const i=Math.abs(this._end-this._start),n=me-i;switch(i>n?(this._shortDistance=n,this._longDistance=i):(this._shortDistance=i,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+me)%me>=Math.PI,this._rotationType){case ee.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case ee.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case ee.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case ee.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function d_(d){return typeof d.scale=="object"&&typeof d.duration=="number"}class u_{constructor(t,i){if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._endScale=G(1,1),this._startScale=G(1,1),this._endScale=i.scale,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=t;const i=bt(Yi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Or(this._startScale,this._endScale,i),o=this._tx.scale,h=n.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=k.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class __{constructor(t,i,n,o,h){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._endX=i,this._endY=n,this._speedX=o,this._speedY=h}update(t){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*i}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*i}this.isComplete()&&(this._tx.scale=G(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function f_(d){return typeof d.scaleOffset=="object"&&typeof d.duration=="number"}class p_{constructor(t,i){if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._endScale=G(1,1),this._scaleOffset=G(0,0),this._startScale=G(1,1),this._scaleOffset=i.scaleOffset,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=t;const i=bt(Yi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Or(this._startScale,this._endScale,i),o=this._tx.scale,h=n.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=k.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class g_{constructor(t,i,n,o){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._offset=new k(i,n),this._speedX=this._speedY=o}update(t){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class vu{constructor(t){this.id=zt(),this._hasBeenCalled=!1,this._method=t}update(t){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class m_{constructor(t,i,n,o,h){this.easingFcn=h,this.id=zt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new k(0,0),this._lerpEnd=new k(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._lerpDuration=o,this._lerpEnd=new k(i,n)}_initialize(){this._lerpStart=new k(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=G((i-this._tx.pos.x)/(t/1e3),(n-this._tx.pos.y)/(t/1e3))):(this._tx.pos=G(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=k.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=G(0,0),this._stopped=!0}}class v_{constructor(t,i,n,o,h){this.easingFcn=h,this.id=zt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new k(0,0),this._lerpEnd=new k(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._lerpDuration=o,this._offset=new k(i,n)}_initialize(){this._lerpStart=new k(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=G((i-this._tx.pos.x)/(t/1e3),(n-this._tx.pos.y)/(t/1e3))):(this._tx.pos=G(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=k.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=G(0,0),this._stopped=!0}}class w_{constructor(t,i,n,o=1){this.id=zt(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=t.get(se),this._timeVisible=i,this._timeNotVisible=n,this._duration=(i+n)*o}update(t){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=t,this._totalTime+=t,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class x_{constructor(t,i,n){this.id=zt(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=t.get(se),this._endOpacity=i,this._remainingTime=this._originalTime=n}update(t){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*t)/this._remainingTime),this._remainingTime-=t,this.isComplete()&&(this._graphics.opacity=this._endOpacity),ct.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class b_{constructor(t){this.id=zt(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=t}update(t){this._started||(this._started=!0),this._elapsedTime+=t}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class y_{constructor(t){this.id=zt(),this._stopped=!1,this._entity=t}update(t){this._entity.get(Mn).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class ll{constructor(t,i,n){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._followTx=i.get(st),this._followMotion=i.get(Mt),this._current=new k(this._tx.pos.x,this._tx.pos.y),this._end=new k(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=n!==void 0?n:this._current.distance(this._end),this._speed=0}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(i!==0&&(this._speed=i),this._current=G(this._tx.pos.x,this._tx.pos.y),this._end=G(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const n=this._dir.scale(this._speed);this._motion.vel=G(n.x,n.y)}else this._motion.vel=G(0,0);this.isComplete()&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}stop(){this._motion.vel=G(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class cl{constructor(t,i,n){this.id=zt(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._meetTx=i.get(st),this._meetMotion=i.get(Mt),this._current=new k(this._tx.pos.x,this._tx.pos.y),this._end=new k(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=n||0,n!==void 0&&(this._speedWasSpecified=!0)}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));i!==0&&!this._speedWasSpecified&&(this._speed=i),this._current=G(this._tx.pos.x,this._tx.pos.y),this._end=G(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const n=this._dir.scale(this._speed);this._motion.vel=G(n.x,n.y),this.isComplete()&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=G(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class A_{constructor(t,i,n=1e3){var o;this.id=zt(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=t.get(se),this._duration=n,this._entity=t,this._material=(o=t.scene)===null||o===void 0?void 0:o.engine.graphicsContext.createMaterial({name:"flash-material",color:i,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=n}update(t){var i;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=t,this._graphics&&((i=this._material)===null||i===void 0||i.update(n=>{n.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Wr{constructor(t){var i;if(this._distLookup=[],this.quality=4,t.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...t.controlPoints],this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(t){this._controlPoints=[...t],this._calculateLookup()}setControlPoint(t,i){this._controlPoints[t]=i,this._calculateLookup()}_calculateLookup(){let t=0;this._distLookup.length=0;let i=this.controlPoints[0];const n=this.controlPoints.length*this.quality;for(let o=0;o<n;o++){const h=o/(n-1),c=this.getPoint(h),f=i.distance(c);t+=f,this._distLookup.push(t),i=c}this._arcLength=t}_getTimeGivenDistance(t){const i=this._distLookup.length,n=this.arcLength;if(t>=0&&t<n){for(let o=0;o<i-1;o++)if(this._distLookup[o]<=t&&t<this._distLookup[o+1])return Yi(this._distLookup[o],this._distLookup[o+1],o/(i-1),(o+1)/(i-1),t)}return t/n}getPoint(t){const i=[...this.controlPoints];for(let n=1;n<i.length;n++)for(let o=0;o<i.length-n;o++)i[o]=Or(i[o],i[o+1],t);return i[0]}getTangent(t){const i=t*t,n=this.controlPoints[0],o=this.controlPoints[1],h=this.controlPoints[2],c=this.controlPoints[3];return n.scale(-3*i+6*t-3).add(o.scale(9*i-12*t+3).add(h.scale(-9*i+6*t).add(c.scale(3*i)))).normalize()}getUniformTangent(t){const i=t*this.arcLength,n=this._getTimeGivenDistance(i);return this.getTangent(n)}getNormal(t){return this.getTangent(t).normal()}getUniformNormal(t){return this.getUniformTangent(t).normal()}getUniformPoint(t){const i=t*this.arcLength,n=this._getTimeGivenDistance(i);return this.getPoint(n)}clone(){return new Wr({controlPoints:[...this.controlPoints],quality:this.quality})}}class C_{constructor(t,i){var n;if(this.id=zt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(st),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new Wr({controlPoints:[G(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(n=i.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=t;const i=bt(Yi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class T_{constructor(t,i){var n;if(this.id=zt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(st),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new Wr({controlPoints:[G(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(n=i.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=t;const i=bt(Yi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class Nr{constructor(t){this._entity=t,this._queue=new Qu(t)}getQueue(){return this._queue}update(t){this._queue.update(t)}clearActions(){this._queue.clearActions()}runAction(t){return t.reset(),this._queue.add(t),this}curveBy(t){return this._queue.add(new T_(this._entity,t)),this}curveTo(t){return this._queue.add(new C_(this._entity,t)),this}easeTo(...t){var i,n;let o=0,h=0,c=0,f=Wt.Linear;return t[0]instanceof k?(o=t[0].x,h=t[0].y,c=t[1],f=(i=t[2])!==null&&i!==void 0?i:f):(o=t[0],h=t[1],c=t[2],f=(n=t[3])!==null&&n!==void 0?n:f),this._queue.add(new m_(this._entity,o,h,c,f)),this}easeBy(...t){var i,n;let o=0,h=0,c=0,f=Wt.Linear;return t[0]instanceof k?(o=t[0].x,h=t[0].y,c=t[1],f=(i=t[2])!==null&&i!==void 0?i:f):(o=t[0],h=t[1],c=t[2],f=(n=t[3])!==null&&n!==void 0?n:f),this._queue.add(new v_(this._entity,o,h,c,f)),this}moveTo(t,i,n){let o=0,h=0,c=0;return t instanceof k?(o=t.x,h=t.y,c=+(i??0),this._queue.add(new hl(this._entity,o,h,c))):typeof t=="number"&&typeof i=="number"&&typeof n=="number"?(o=t,h=i,c=n,this._queue.add(new hl(this._entity,o,h,c))):r_(t)&&this._queue.add(new o_(this._entity,t)),this}moveBy(t,i,n){let o=0,h=0,c=0;return t instanceof k&&typeof i=="number"?(o=t.x,h=t.y,c=i,this._queue.add(new al(this._entity,o,h,c))):typeof t=="number"&&typeof i=="number"&&typeof n=="number"?(o=t,h=i,c=n,this._queue.add(new al(this._entity,o,h,c))):s_(t)&&this._queue.add(new n_(this._entity,t)),this}rotateTo(t,i,n){return typeof t=="number"&&typeof i=="number"?this._queue.add(new h_(this._entity,t,i,n)):typeof t=="object"&&this._queue.add(new a_(this._entity,t)),this}rotateBy(t,i,n){return typeof t=="object"?this._queue.add(new l_(this._entity,t)):this._queue.add(new c_(this._entity,t,i,n)),this}scaleTo(t,i,n,o){let h=1,c=1,f=0,g=0;return d_(t)?(this._queue.add(new u_(this._entity,t)),this):(t instanceof k&&i instanceof k&&(h=t.x,c=t.y,f=i.x,g=i.y),typeof t=="number"&&typeof i=="number"&&(h=t,c=i,f=n,g=o),this._queue.add(new __(this._entity,h,c,f,g)),this)}scaleBy(t,i,n){if(f_(t))return this._queue.add(new p_(this._entity,t)),this;let o=1,h=1;return t instanceof k&&(o=t.x,h=t.y,n=i),typeof t=="number"&&typeof i=="number"&&(o=t,h=i),this._queue.add(new g_(this._entity,o,h,n)),this}blink(t,i,n=1){return this._queue.add(new w_(this._entity,t,i,n)),this}fade(t,i){return this._queue.add(new x_(this._entity,t,i)),this}flash(t,i=1e3){return this._queue.add(new A_(this._entity,t,i)),this}delay(t){return this._queue.add(new b_(t)),this}die(){return this._queue.add(new y_(this._entity)),this}callMethod(t){return this._queue.add(new vu(t)),this}repeat(t,i){return i?(this._queue.add(new Ku(this._entity,t,i)),this):(this.repeatForever(t),this)}repeatForever(t){return this._queue.add(new Ju(this._entity,t)),this}follow(t,i){return i===void 0?this._queue.add(new ll(this._entity,t)):this._queue.add(new ll(this._entity,t,i)),this}meet(t,i){return i===void 0?this._queue.add(new cl(this._entity,t)):this._queue.add(new cl(this._entity,t,i)),this}toPromise(){return new Promise(i=>{this._queue.add(new vu(()=>{i()}))})}}class Mn extends fi{constructor(){super(...arguments),this.dependencies=[st,Mt],this._ctx=null}onAdd(t){this._ctx=new Nr(t)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(t){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(t)}update(t){var i;return(i=this._ctx)===null||i===void 0?void 0:i.update(t)}clearActions(){var t;(t=this._ctx)===null||t===void 0||t.clearActions()}curveBy(t){return this._getCtx().curveBy.apply(this._ctx,[t])}curveTo(t){return this._getCtx().curveTo.apply(this._ctx,[t])}easeTo(...t){return this._getCtx().easeTo.apply(this._ctx,t)}easeBy(...t){return this._getCtx().easeBy.apply(this._ctx,t)}moveTo(t,i,n){return this._getCtx().moveTo.apply(this._ctx,[t,i,n])}moveBy(t,i,n){return this._getCtx().moveBy.apply(this._ctx,[t,i,n])}rotateTo(t,i,n){return this._getCtx().rotateTo.apply(this._ctx,[t,i,n])}rotateBy(t,i,n){return this._getCtx().rotateBy.apply(this._ctx,[t,i,n])}scaleTo(t,i,n,o){return this._getCtx().scaleTo.apply(this._ctx,[t,i,n,o])}scaleBy(t,i,n){return this._getCtx().scaleBy.apply(this._ctx,[t,i,n])}blink(t,i,n){return this._getCtx().blink(t,i,n)}fade(t,i){return this._getCtx().fade(t,i)}flash(t,i=1e3){return this._getCtx().flash(t,i)}delay(t){return this._getCtx().delay(t)}die(){return this._getCtx().die()}callMethod(t){return this._getCtx().callMethod(t)}repeat(t,i){return this._getCtx().repeat(t,i)}repeatForever(t){return this._getCtx().repeatForever(t)}follow(t,i){return this._getCtx().follow(t,i)}meet(t,i){return this._getCtx().meet(t,i)}toPromise(){return this._getCtx().toPromise()}}function Um(d){return d instanceof Ze}const zm={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class Ze extends We{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(t){this.body.oldPos.setTo(t.x,t.y)}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t.clone()}get oldVel(){return this.body.oldVel}set oldVel(t){this.body.oldVel.setTo(t.x,t.y)}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t.clone()}set oldAcc(t){this.body.oldAcc.setTo(t.x,t.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(t){this.transform.rotation=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}get scale(){return this.get(st).scale}set scale(t){this.get(st).scale=t}get anchor(){return this._anchor}set anchor(t){this._anchor=Pi(t,i=>this._handleAnchorChange(i)),this._handleAnchorChange(t)}_handleAnchorChange(t){this.graphics&&(this.graphics.anchor=t)}get offset(){return this._offset}set offset(t){this._offset=Pi(t,i=>this._handleOffsetChange(i)),this._handleOffsetChange(t)}_handleOffsetChange(t){this.graphics&&(this.graphics.offset=t)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(t){t&&(t&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!t&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=t)}get color(){return this.graphics.color}set color(t){this.graphics.color=t}constructor(t){super(),this.events=new Zt,this._anchor=Pi(k.Half,ht=>this._handleAnchorChange(ht)),this._offset=Pi(k.Zero,ht=>this._handleOffsetChange(ht)),this.logger=ct.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=ht=>{this._dragging&&(this.pos=ht.worldPos)},this._pointerDragLeaveHandler=ht=>{this._dragging&&(this.pos=ht.worldPos)};const{name:i,x:n,y:o,pos:h,coordPlane:c,scale:f,width:g,height:v,radius:x,collider:b,vel:T,acc:P,rotation:I,angularVelocity:F,z:R,color:S,visible:M,opacity:W,anchor:U,offset:V,collisionType:j,collisionGroup:q,silenceWarnings:nt}={...t};this.name=i??this.name,this.anchor=U??Ze.defaults.anchor.clone(),this.offset=V??k.Zero,this.transform=new st,this.addComponent(this.transform),this.pos=h??G(n??0,o??0),this.rotation=I??0,this.scale=f??G(1,1),this.z=R??0,this.transform.coordPlane=c??Me.World,this._silenceWarnings=nt??!1,this.pointer=new Fs,this.addComponent(this.pointer),this.graphics=new se({anchor:this.anchor,offset:this.offset,opacity:W}),this.addComponent(this.graphics),this.motion=new Mt,this.addComponent(this.motion),this.vel=T??k.Zero,this.acc=P??k.Zero,this.angularVelocity=F??0,this.actions=new Mn,this.addComponent(this.actions),this.body=new Ct,this.addComponent(this.body),this.body.collisionType=j??ut.Passive,q&&(this.body.group=q),S&&(this.color=S),b?(this.collider=new fe(b),this.addComponent(this.collider)):x?(this.collider=new fe(Oe.Circle(x)),this.addComponent(this.collider),S&&this.graphics.add(new oa({color:S,radius:x}))):g>0&&v>0?(this.collider=new fe(Oe.Box(g,v,this.anchor)),this.addComponent(this.collider),S&&g&&v&&this.graphics.add(new Hr({color:S,width:g,height:v}))):(this.collider=new fe,this.addComponent(this.collider)),this.graphics.isVisible=M??!0}clone(){const t=new Ze({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});t.clearComponents(),t.processComponentRemoval(),t.addComponent(t.transform=this.transform.clone(),!0),t.addComponent(t.pointer=this.pointer.clone(),!0),t.addComponent(t.graphics=this.graphics.clone(),!0),t.addComponent(t.motion=this.motion.clone(),!0),t.addComponent(t.actions=this.actions.clone(),!0),t.addComponent(t.body=this.body.clone(),!0),t.addComponent(t.collider=this.collider.clone(),!0);const i=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],n=this.getComponents();for(const o of n)i.includes(o)||t.addComponent(o.clone(),!0);return t}onInitialize(t){}_initialize(t){super._initialize(t);for(const i of this.children)i._initialize(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_prekill(t){this.events.emit("prekill",new El(this)),this.onPreKill(t)}onPreKill(t){}_postkill(t){this.events.emit("postkill",new Il(this)),this.onPostKill(t)}onPostKill(t){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new ia(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(st).z}set z(t){this.get(st).z=t}get center(){const t=this.getGlobalPos();return new k(t.x+this.width/2-this.anchor.x*this.width,t.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new k(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(st).globalRotation}get globalRotation(){return this.get(st).globalRotation}getGlobalPos(){return this.get(st).globalPos}get globalPos(){return this.get(st).globalPos}getGlobalScale(){return this.get(st).globalScale}get globalScale(){return this.get(st).globalScale}get globalZ(){return this.get(st).globalZ}contains(t,i,n=!1){const o=G(t,i),h=this.get(fe);h.update();const c=h.get();if(!c)return!1;const f=c.contains(o);return n?f||this.children.some(g=>g.contains(t,i,!0)):f}within(t,i){const n=this.get(fe),o=t.get(fe),h=n.get(),c=o.get();return h&&c?h.getClosestLineBetween(c).getLength()<=i:!1}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i),this._postupdate(t,i),this._remove(t)}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreCollisionResolve(t,i,n,o){}onPostCollisionResolve(t,i,n,o){}onCollisionStart(t,i,n,o){}onCollisionEnd(t,i,n,o){}_preupdate(t,i){this.events.emit("preupdate",new ks(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new Ls(t,i,this)),this.onPostUpdate(t,i)}}Ze.defaults={anchor:k.Half};function P_(d){return d instanceof ac}class ac extends Ze{constructor(t){var i,n;super({...t}),this.get(st).coordPlane=Me.Screen,this.anchor=(i=t?.anchor)!==null&&i!==void 0?i:G(0,0),this.body.collisionType=(n=t?.collisionType)!==null&&n!==void 0?n:ut.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!t?.collider&&t?.width>0&&t?.height>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(t){this._engine=t,super._initialize(t)}contains(t,i,n=!0){if(n)return super.contains(t,i);const o=this._engine.worldToScreenCoordinates(new k(t,i));return super.contains(o.x,o.y)}}class nn{get complete(){return this._complete}constructor(t){var i;this._logger=ct.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const n=(i=t.action)!==null&&i!==void 0?i:t.fcn,o=t.interval,h=t.repeats,c=t.numberOfRepeats,f=t.randomRange,g=t.random;if(c&&c>=0&&(this.maxNumberOfRepeats=c,!h))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=nn._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=o,f){if(f[0]>f[1])throw new Error("min value must be lower than max value for range");this.random=g??new zn,this.randomRange=f,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=h||this.repeats,n&&this.on(n)}on(t){this._callbacks.push(t)}off(t){const i=this._callbacks.indexOf(t);this._callbacks.splice(i,1)}update(t){this._running&&(this._totalTimeAlive+=t,this._elapsedTime+=t,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(i=>{i.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(t,i){if(t&&t>=0&&(this._baseInterval=this.interval=t),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=i,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}nn._MAX_ID=0;class aa extends fi{constructor(t){super(),this.parallaxFactor=G(1,1),this.parallaxFactor=t??this.parallaxFactor}}class ha extends fi{constructor(t,i=!0){super(),this.draw=t,this.useTransform=i}}function wu(d){return d&&d._dispatchPointerEvents&&d._processPointerToObject}class Hm{get events(){return this.object.events}init(t,i,n){this.object=t,this.contains=i,this.active=n}}class hc{constructor(){this._proxyPool=new Fr(()=>new Hm,t=>t,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(t,i,n){const o=this._proxyPool.rent(!1);o.init(t,i,n),this._proxies.push(o),this._objectToProxy.set(t,o)}_getProxy(t){const i=this._objectToProxy.get(t);if(i)return i;throw new Error("No PointerTargetProxy for object")}removeObject(t){const i=this._objectToProxy.get(t);if(i){const n=this._proxies.indexOf(i);n>-1&&this._proxies.splice(n,1),this._proxyPool.return(i)}}_objectCurrentlyUnderPointer(t,i){return!!(this._currentFrameObjectToPointers.has(t)&&this._currentFrameObjectToPointers.get(t).includes(i))}_objectWasUnderPointer(t,i){return!!(this._lastFrameObjectToPointers.has(t)&&this._lastFrameObjectToPointers.get(t).includes(i))}_entered(t,i){return this._objectCurrentlyUnderPointer(t,i)&&!this._lastFrameObjectToPointers.has(t)}_left(t,i){return!this._currentFrameObjectToPointers.has(t)&&this._objectWasUnderPointer(t,i)}addPointerToObject(t,i){const n=this._objectToProxy.get(t);n&&this._addPointerToProxy(n,i)}_addPointerToProxy(t,i){if(!this._currentFrameObjectToPointers.has(t)){this._currentFrameObjectToPointers.set(t,[i]);return}const n=this._currentFrameObjectToPointers.get(t);this._currentFrameObjectToPointers.set(t,n.concat(i))}dispatchEvents(t,i){const n=new Set(this._lastFrameObjectToPointers.keys()),o=new Set(this._currentFrameObjectToPointers.keys());let h,c,f;for(let g=0;g<i.length;g++){const v=i[g],x=this._getProxy(v);if(wu(v)&&v._dispatchPointerEvents(t),n.has(x)||o.has(x)){f=this._processDownAndEmit(t,x),c=this._processUpAndEmit(t,x),h=this._processMoveAndEmit(t,x);const b=[...h.values(),...f.values(),...c.values()];this._processEnterLeaveAndEmit(t,x,b),this._processCancelAndEmit(t,x),this._processWheelAndEmit(t,x)}}}processPointerToObject(t,i){for(let n=0;n<i.length;n++){const o=i[n],h=this._getProxy(o);wu(o)&&o._processPointerToObject(t);for(const[c,f]of t.currentFramePointerCoords.entries())h.contains(f)&&this._addPointerToProxy(h,c)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(t,i){const n=new Map;for(const o of t.currentFrameDown)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerdown",o),t.isDragStart(o.pointerId)&&i.events.emit("pointerdragstart",o)),n.set(o.pointerId,o);return n}_processUpAndEmit(t,i){const n=new Map;for(const o of t.currentFrameUp)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerup",o),t.isDragEnd(o.pointerId)&&i.events.emit("pointerdragend",o)),n.set(o.pointerId,o);return n}_processMoveAndEmit(t,i){const n=new Map;for(const o of t.currentFrameMove)o.active&&i.active()&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointermove",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragmove",o)),n.set(o.pointerId,o);return n}_processEnterLeaveAndEmit(t,i,n){for(const o of n){if(o.active&&i.active()&&this._entered(i,o.pointerId)){i.events.emit("pointerenter",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragenter",o);break}if(o.active&&i.active()&&(this._left(i,o.pointerId)||this._objectCurrentlyUnderPointer(i,o.pointerId)&&o.type==="up")){i.events.emit("pointerleave",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragleave",o);break}}}_processCancelAndEmit(t,i){for(const n of t.currentFrameCancel)n.active&&i.active()&&this._objectCurrentlyUnderPointer(i,n.pointerId)&&i.events.emit("pointercancel",n)}_processWheelAndEmit(t,i){for(const n of t.currentFrameWheel)n.active&&i.active()&&this._objectCurrentlyUnderPointer(i,0)&&i.events.emit("pointerwheel",n)}}const Om={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class S_ extends We{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let t=0;t<this.tiles.length;t++)this.tiles[t]&&this.tiles[t].flagDirty()}get x(){var t;return(t=this.transform.pos.x)!==null&&t!==void 0?t:0}set x(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.get(st).pos=G(t,this.y))}get y(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.pos.y)!==null&&i!==void 0?i:0}set y(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.transform.pos=G(this.x,t))}get z(){var t;return(t=this.transform.z)!==null&&t!==void 0?t:0}set z(t){this.transform&&(this.transform.z=t)}get rotation(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.rotation)!==null&&i!==void 0?i:0}set rotation(t){this.transform&&(this.transform.rotation=t)}get scale(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.scale)!==null&&i!==void 0?i:k.One}set scale(t){var i;!((i=this.transform)===null||i===void 0)&&i.scale&&(this.transform.scale=t)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get vel(){return this._motion.vel}set vel(t){this._motion.vel=t}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,n,o;super([],t.name),this.events=new Zt,this._token=0,this.logger=ct.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(i=t.meshingLookBehind)!==null&&i!==void 0?i:this.meshingLookBehind,this.addComponent(new st),this.addComponent(new Mt),this.addComponent(new Ct({type:ut.Fixed})),this.addComponent(new se({onPostDraw:(c,f)=>this.draw(c,f)})),this.addComponent(new ha((c,f)=>this.debug(c,f),!1)),this.addComponent(new fe),this.addComponent(new Fs),this.pointer=this.get(Fs),this._graphics=this.get(se),this.transform=this.get(st),this._motion=this.get(Mt),this.collider=this.get(fe),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(n=t.pos)!==null&&n!==void 0?n:k.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(o=t.renderFromTopOfGraphic)!==null&&o!==void 0?o:this.renderFromTopOfGraphic,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight,this.rows=t.rows,this.columns=t.columns,this._pointerEventDispatcher=new hc,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let h=[];for(let c=0;c<this.columns;c++){for(let f=0;f<this.rows;f++){const g=new E_({x:c,y:f,map:this});g.map=this,this.tiles[c+f*this.columns]=g,this._pointerEventDispatcher.addObject(g,v=>g.bounds.contains(v.worldPos),()=>!0),h.push(g),this._rows[f]||(this._rows[f]=[]),this._rows[f].push(g)}this._cols[c]=h,h=[]}this._graphics.localBounds=new lt({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(t){super._initialize(t),this._engine=t}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:k.Zero;{const n=t.offset;return this._originalOffsets.set(t,n),n}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const t=[];this._composite=this.collider.useCompositeCollider([]);let i=null;const n=(h,c)=>h&&c?h.top===c.top&&h.bottom===c.bottom&&h.right===c.left:!1,o=(h,c,f=this.meshingLookBehind)=>{if(!h)return!1;for(let g=c.length-1;g>=0;g--){if(f--<0)return!1;const v=c[g];if(n(v,h))return c[g]=v.combine(h),!0}return!1};for(let h=0;h<this.columns;h++){for(let c=0;c<this.rows;c++){const f=this.tiles[h+c*this.columns];if(f.solid)if(f.getColliders().length>0){for(const g of f.getColliders()){const v=this._getOrSetColliderOriginalOffset(g);g.offset=G(f.x*this.tileWidth*this.scale.x,f.y*this.tileHeight*this.scale.y).add(v),g.owner=this,this._composite.addCollider(g)}i&&!o(i,t)&&t.push(i),i=null}else i?i=i.combine(f.defaultGeometry):i=f.defaultGeometry;else i&&!o(i,t)&&t.push(i),i=null}i&&!o(i,t)&&t.push(i),i=null}for(const h of t){const c=Oe.Box(h.width,h.height,k.Zero,G(h.left-this.pos.x,h.top-this.pos.y));c.owner=this,this._composite.addCollider(c)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(t){var i;return(i=this.tiles[t])!==null&&i!==void 0?i:null}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const{x:i,y:n}=this._getTileCoordinates(t),o=this.getTile(i,n);return i>=0&&n>=0&&i<this.columns&&n<this.rows&&o?o:null}_getTileCoordinates(t){t=this.transform.applyInverse(t);const i=Math.floor(t.x/this.tileWidth),n=Math.floor(t.y/this.tileHeight);return{x:i,y:n}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let t=this._engine.screen.getWorldBounds();const i=this.get(aa);if(i&&this.isInitialized){let P=this.pos;const I=k.One.sub(i.parallaxFactor),F=this._engine.currentScene.camera.pos.scale(I);P=P.sub(F),t=t.translate(P)}const n=this.transform.coordPlane===Me.Screen?this._engine.screen.getScreenBounds():t,o=this._getTileCoordinates(n.topLeft),h=this._getTileCoordinates(n.topRight),c=this._getTileCoordinates(n.bottomRight),f=this._getTileCoordinates(n.bottomLeft),g=Math.min(bt(o.x,0,this.columns-1),bt(h.x,0,this.columns-1)),v=Math.min(bt(o.y,0,this.rows-1),bt(h.y,0,this.rows-1)),x=Math.max(bt(c.x,0,this.columns-1),bt(f.x,0,this.columns-1)),b=Math.max(bt(c.y,0,this.rows-1),bt(f.y,0,this.rows-1)),T=[];for(let P=g;P<=x;P++)for(let I=v;I<=b;I++)T.push(this.getTile(P,I));return T}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(t,i){this._initialize(t),this.onPreUpdate(t,i),this.emit("preupdate",new ks(t,i,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(t,i),this.emit("postupdate",new Ls(t,i,this))}draw(t,i){if(!this.isInitialized)return;this.emit("predraw",new Nn(t,i,this));let n,o,h;const c=this.getOnScreenTiles();for(let f=0;f<c.length;f++){const g=c[f],v=g.getGraphicsOffsets();for(n=g.getGraphics(),o=0,h=n.length;o<h;o++){const x=n[o],b=v[o];if(x){Sl(x)&&x?.tick(i,this._token);const T=this.renderFromTopOfGraphic?0:x.height-this.tileHeight;x.draw(t,g.x*this.tileWidth+b.x,g.y*this.tileHeight-T+b.y)}}}this.emit("postdraw",new Gn(t,i,this))}debug(t,i){const{showAll:n,showGrid:o,gridColor:h,gridWidth:c,showSolidBounds:f,solidBoundsColor:g,showColliderGeometry:v}=i.tilemap,{geometryColor:x,geometryLineWidth:b,geometryPointSize:T}=i.collider,P=this.tileWidth*this.columns*this.scale.x,I=this.tileHeight*this.rows*this.scale.y,F=this.pos;if(o||n){for(let R=0;R<this.rows+1;R++){const S=G(0,R*this.tileHeight*this.scale.y);t.drawLine(F.add(S),F.add(G(P,S.y)),h,c)}for(let R=0;R<this.columns+1;R++){const S=G(R*this.tileWidth*this.scale.x,0);t.drawLine(F.add(S),F.add(G(S.x,I)),h,c)}}if(n||f||v){const R=this._composite.getColliders();t.save(),t.translate(this.pos.x,this.pos.y),t.scale(this.scale.x,this.scale.y);for(const S of R){const M=S.localBounds,W=S.worldPos.sub(this.pos);f&&t.drawRectangle(W,M.width,M.height,g)}if(t.restore(),v)for(const S of R)S.debug(t,x,{lineWidth:b,pointSize:T})}if(n||f){if(t.save(),t.z=999,f)for(let R=0;R<this.tiles.length;R++)this.tiles[R].bounds.draw(t);t.restore()}}}class E_{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(t){var i;(i=this.map)===null||i===void 0||i.flagCollidersDirty(),this._solid=t}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(t,i){this._graphics.push(t),i?.offset?this._offsets.push(i.offset):this._offsets.push(k.Zero)}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&(this._graphics.splice(i,1),this._offsets.splice(i,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(t){var i,n;this._posDirty=!1,this.events=new Zt,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=t.x,this.y=t.y,this.map=t.map,this._width=t.map.tileWidth*this.map.scale.x,this._height=t.map.tileHeight*this.map.scale.y,this.solid=(i=t.solid)!==null&&i!==void 0?i:this.solid,this._graphics=(n=t.graphics)!==null&&n!==void 0?n:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const t=this.map.pos.add(G(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new lt(t.x,t.y,t.x+this.map.tileWidth,t.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(G(this.x*this._width,this.y*this._height)),this._bounds=new lt(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new k(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}class I_{constructor(t){this.camera=t}lockToActor(t){this.camera.addStrategy(new R_(t))}lockToActorAxis(t,i){this.camera.addStrategy(new D_(t,i))}elasticToActor(t,i,n){this.camera.addStrategy(new M_(t,i,n))}radiusAroundActor(t,i){this.camera.addStrategy(new F_(t,i))}limitCameraBounds(t){this.camera.addStrategy(new B_(t))}}var Qo;(function(d){d[d.X=0]="X",d[d.Y=1]="Y"})(Qo||(Qo={}));class R_{constructor(t){this.target=t,this.action=(i,n,o,h)=>i.center}}class D_{constructor(t,i){this.target=t,this.axis=i,this.action=(n,o,h,c)=>{const f=n.center,g=o.getFocus();return this.axis===Qo.X?new k(f.x,g.y):new k(g.x,f.y)}}}class M_{constructor(t,i,n){this.target=t,this.cameraElasticity=i,this.cameraFriction=n,this.action=(o,h,c,f)=>{const g=o.center;let v=h.getFocus(),x=h.vel.clone();const b=g.sub(v).scale(this.cameraElasticity);x=x.add(b);const T=x.scale(-1).scale(this.cameraFriction);return x=x.add(T),v=v.add(x),v}}}class F_{constructor(t,i){this.target=t,this.radius=i,this.action=(n,o,h,c)=>{const f=n.center,g=o.getFocus(),v=f.sub(g),x=v.magnitude;if(x>=this.radius){const b=x-this.radius;return g.add(v.normalize().scale(b))}return g}}}class B_{constructor(t){this.target=t,this.boundSizeChecked=!1,this.action=(i,n,o,h)=>{const c=n.getFocus();this.boundSizeChecked||((i.bottom-i.top<o.drawHeight||i.right-i.left<o.drawWidth)&&ct.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let f=c.x,g=c.y;return c.x<i.left+o.halfDrawWidth?f=i.left+o.halfDrawWidth:c.x>i.right-o.halfDrawWidth&&(f=i.right-o.halfDrawWidth),c.y<i.top+o.halfDrawHeight?g=i.top+o.halfDrawHeight:c.y>i.bottom-o.halfDrawHeight&&(g=i.bottom-o.halfDrawHeight),G(f,g)}}}const Wm={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class k_{constructor(){this.events=new Zt,this.transform=_e.identity(),this.inverse=_e.identity(),this._cameraStrategies=[],this.strategy=new I_(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new Rs(k.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=k.Zero,this.acc=k.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Wt.EaseInOutCubic,this._easing=Wt.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=G(0,0)}get zoom(){return this._z}set zoom(t){this._z=t,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(t){this._angularVelocity=t}get pos(){return this._pos}set pos(t){this._posChanged=!0,this._pos=new Rs(t,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(t){!this._follow&&!this._cameraMoving&&(this.pos=G(t,this.pos.y))}get y(){return this.pos.y}set y(t){!this._follow&&!this._cameraMoving&&(this.pos=G(this.pos.x,t))}get dx(){return this.vel.x}set dx(t){this.vel=G(t,this.vel.y)}get dy(){return this.vel.y}set dy(t){this.vel=G(this.vel.x,t)}get ax(){return this.acc.x}set ax(t){this.acc=G(t,this.acc.y)}get ay(){return this.acc.y}set ay(t){this.acc=G(this.acc.x,t)}getFocus(){return this.pos}move(t,i,n=Wt.EaseInOutCubic){if(typeof n!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(t):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(t),this._lerpPromise=new Promise(o=>{this._lerpResolve=o}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=i,this._lerpEnd=t,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=n,this._lerpPromise)}shake(t,i,n){this._isShaking=!0,this._shakeMagnitudeX=t,this._shakeMagnitudeY=i,this._shakeDuration=n}zoomOverTime(t,i=0,n=Wt.EaseInOutCubic){if(this._zoomPromise=new Promise(o=>{this._zoomResolve=o}),i)this._isZooming=!0,this._zoomEasing=n,this._currentZoomTime=0,this._zoomDuration=i,this._zoomStart=this.zoom,this._zoomEnd=t;else return this._isZooming=!1,this.zoom=t,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new lt(0,0,0,0)}addStrategy(t){this._cameraStrategies.push(t)}removeStrategy(t){Hn(t,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(t,i){this.events.emit("preupdate",new ks(t,i,this)),this.onPreUpdate(t,i)}onPreUpdate(t,i){}_postupdate(t,i){this.events.emit("postupdate",new Ls(t,i,this)),this.onPostUpdate(t,i)}onPostUpdate(t,i){}get isInitialized(){return this._isInitialized}_initialize(t){if(!this.isInitialized){this._engine=t,this._screen=t.screen;const i=this._screen.contentArea;let n=G(i.width/2,i.height/2);if(!this._engine.loadingComplete){const o=this._screen.peekResolution();o&&(n=G(o.width/2,o.height/2))}this._halfWidth=n.x,this._halfHeight=n.y,this._posChanged||(this.pos=n),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(t,t.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(t),this.events.emit("initialize",new Vn(t,this)),this._isInitialized=!0}}onInitialize(t){}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}runStrategies(t,i){for(const n of this._cameraStrategies)this.pos=n.action.call(n,n.target,this,t,i)}updateViewport(){this._viewport=new lt(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(t,i){if(this._initialize(t),this._preupdate(t,i),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(i/1e3)),this.zoom+=this.dz*i/1e3,this.vel=this.vel.add(this.acc.scale(i/1e3)),this.dz+=this.az*i/1e3,this.rotation+=this.angularVelocity*i/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const n=this._zoomEasing,o=n(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=o,this._currentZoomTime+=i}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const o=Wt.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=o,this._currentLerpTime+=i}else{this.pos=this._lerpEnd;const n=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(n)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=i,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(t,i),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(t,i),this._posChanged=!1}draw(t){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const i=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,n=this.pos.scale(i).add(this._oldPos.scale(1-i));n.clone(this.drawPos),this.updateTransform(n)}if(t.snapToPixel){const i=this.drawPos.clone(this._snapPos);i.x=~~(i.x+pt*Nt(i.x)),i.y=~~(i.y+pt*Nt(i.y)),i.clone(this.drawPos),this.updateTransform(i)}t.multiply(this.transform)}updateTransform(t){const i=this._screen.resolution.width/this.zoom,n=this._screen.resolution.height/this.zoom,o=G(-t.x+i/2+this._xShake,-t.y+n/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(i/2,n/2),this.transform.rotate(this.rotation),this.transform.translate(-i/2,-n/2),this.transform.translate(o.x,o.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const Nm={ExitTrigger:"exit",EnterTrigger:"enter"};class L_ extends Ze{constructor(t){var i,n,o,h;super({...t}),this.events=new Zt,this.filter=(i=t.filter)!==null&&i!==void 0?i:()=>!0,this.repeat=(n=t.repeat)!==null&&n!==void 0?n:-1,this.action=(o=t.action)!==null&&o!==void 0?o:()=>{},this.target=t.target,this.graphics.isVisible=(h=t.visible)!==null&&h!==void 0?h:!1,this.body.collisionType=ut.Passive,this.events.on("collisionstart",({other:c})=>{this._matchesTarget(c.owner)&&(this.events.emit("enter",new jl(this,c.owner)),this._dispatchAction(c.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:c})=>{this._matchesTarget(c.owner)&&this.events.emit("exit",new Zl(this,c.owner))})}_matchesTarget(t){return this.filter(t)&&(this.target===void 0||this.target===t)}_dispatchAction(t){this.repeat!==0&&(this.action.call(this,t),this.repeat--)}}const ji={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var ai;(function(d){d.Update="update",d.Draw="draw"})(ai||(ai={}));class ui{}ui.priority=ji.Average;class U_{constructor(t){this._world=t,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>i=>{this.addEntity(i)},this._createChildRemovedHandler=()=>i=>{this.removeEntity(i,!1)},this._entitiesToRemove=[]}updateEntities(t,i){for(let n=0;n<this.entities.length;n++){const o=this.entities[n];o.update(t.engine,i),o.isActive||this.removeEntity(o)}}findEntitiesForRemoval(){for(let t=0;t<this.entities.length;t++){const i=this.entities[t];i.isActive||this.removeEntity(i)}}addEntity(t){if(t.isActive=!0,t.scene=this._world.scene,t&&!this._entityIndex[t.id]){this._entityIndex[t.id]=t,this.entities.push(t),this._world.queryManager.addEntity(t),t.children.forEach(o=>{o.scene=t.scene,this.addEntity(o)});const i=this._createChildAddedHandler();this._childAddedHandlerMap.set(t,i);const n=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(t,n),t.childrenAdded$.subscribe(i),t.childrenRemoved$.subscribe(n)}}removeEntity(t,i=!0){var n,o;let h=0;t instanceof We?h=t.id:h=t;const c=this._entityIndex[h];if(c&&c.isActive&&(c.isActive=!1),c&&i){this._entitiesToRemove.push(c);return}if(delete this._entityIndex[h],c){c.scene=null,Hn(c,this.entities),this._world.queryManager.removeEntity(c),c.children.forEach(v=>{v.scene=null,this.removeEntity(v,i)});const f=this._childAddedHandlerMap.get(c);f&&c.childrenAdded$.unsubscribe(f);const g=this._childRemovedHandlerMap.get(c);g&&c.childrenRemoved$.unsubscribe(g),!((o=(n=this._world)===null||n===void 0?void 0:n.scene)===null||o===void 0)&&o.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let t=0;t<this._entitiesToRemove.length;t++){const i=this._entitiesToRemove[t];i.isActive||this.removeEntity(i,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let t=0;t<this.entities.length;t++)this.entities[t].processComponentRemoval()}getById(t){return this._entityIndex[t]}getByName(t){return this.entities.filter(i=>i.name===t)}clear(){for(let t=this.entities.length-1;t>=0;t--)this.removeEntity(this.entities[t])}}class Tr{constructor(t){if(this.requiredComponents=t,this.components=new Set,this.entities=[],this.entityAdded$=new Ye,this.entityRemoved$=new Ye,t.length===0)throw new Error("Cannot create query without components");for(const i of t)this.components.add(i);this.id=Tr.createId(t)}static createId(t){return t.slice().map(i=>i.name).sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAll(Array.from(this.components))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class Pr{constructor(t){if(this.requiredTags=t,this.tags=new Set,this.entities=[],this.entityAdded$=new Ye,this.entityRemoved$=new Ye,t.length===0)throw new Error("Cannot create tag query without tags");for(const i of t)this.tags.add(i);this.id=Pr.createId(t)}static createId(t){return t.slice().sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAllTags(Array.from(this.tags))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class z_{constructor(t){this._world=t,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=i=>n=>{this.addComponent(i,n)},this._createRemoveComponentHandler=i=>n=>{this.removeComponent(i,n)},this._createAddTagHandler=i=>n=>{this.addTag(i,n)},this._createRemoveTagHandler=i=>n=>{this.removeTag(i,n)}}createQuery(t){const i=Tr.createId(t);if(this._queries.has(i))return this._queries.get(i);const n=new Tr(t);this._queries.set(n.id,n);for(const o of t){const h=this._componentToQueriesIndex.get(o);h?h.push(n):this._componentToQueriesIndex.set(o,[n])}for(const o of this._world.entities)this.addEntity(o);return n}createTagQuery(t){const i=Pr.createId(t);if(this._tagQueries.has(i))return this._tagQueries.get(i);const n=new Pr(t);this._tagQueries.set(n.id,n);for(const o of t){const h=this._tagToQueriesIndex.get(o);h?h.push(n):this._tagToQueriesIndex.set(o,[n])}for(const o of this._world.entities)this.addEntity(o);return n}addEntity(t){const i=this._addComponentHandlers.get(t),n=this._removeComponentHandlers.get(t),o=i??this._createAddComponentHandler(t),h=n??this._createRemoveComponentHandler(t);this._addComponentHandlers.set(t,o),this._removeComponentHandlers.set(t,h);const c=this._addTagHandlers.get(t),f=this._removeTagHandlers.get(t),g=c??this._createAddTagHandler(t),v=f??this._createRemoveTagHandler(t);this._addTagHandlers.set(t,g),this._removeTagHandlers.set(t,v);for(const x of this._queries.values())x.checkAndAdd(t);for(const x of this._tagQueries.values())x.checkAndAdd(t);t.componentAdded$.subscribe(o),t.componentRemoved$.subscribe(h),t.tagAdded$.subscribe(g),t.tagRemoved$.subscribe(v)}removeEntity(t){const i=this._addComponentHandlers.get(t),n=this._removeComponentHandlers.get(t);for(const c of this._queries.values())c.removeEntity(t);i&&t.componentAdded$.unsubscribe(i),n&&t.componentRemoved$.unsubscribe(n);const o=this._addTagHandlers.get(t),h=this._removeTagHandlers.get(t);for(const c of this._tagQueries.values())c.removeEntity(t);o&&t.tagAdded$.unsubscribe(o),h&&t.tagRemoved$.unsubscribe(h)}addComponent(t,i){var n;const o=(n=this._componentToQueriesIndex.get(i.constructor))!==null&&n!==void 0?n:[];for(const h of o)h.checkAndAdd(t)}removeComponent(t,i){var n;const o=(n=this._componentToQueriesIndex.get(i.constructor))!==null&&n!==void 0?n:[];for(const h of o)h.removeEntity(t)}addTag(t,i){var n;const o=(n=this._tagToQueriesIndex.get(i))!==null&&n!==void 0?n:[];for(const h of o)h.checkAndAdd(t)}removeTag(t,i){var n;const o=(n=this._tagToQueriesIndex.get(i))!==null&&n!==void 0?n:[];for(const h of o)h.removeEntity(t)}}function H_(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class O_{constructor(t){this._world=t,this.systems=[],this.initialized=!1}get(t){return this.systems.find(i=>i instanceof t)}addSystem(t){let i;t instanceof ui?i=t:i=new t(this._world),this.systems.push(i),this.systems.sort((n,o)=>n.constructor.priority-o.constructor.priority),this.initialized&&i.initialize&&i.initialize(this._world,this._world.scene)}removeSystem(t){Hn(t,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const t of this.systems)t.initialize&&t.initialize(this._world,this._world.scene)}}updateSystems(t,i,n){const o=this.systems.filter(h=>h.systemType===t);for(const h of o)h.preupdate&&h.preupdate(i,n);for(const h of o)h.update(n);for(const h of o)h.postupdate&&h.postupdate(i,n)}clear(){for(let t=this.systems.length-1;t>=0;t--)this.removeSystem(this.systems[t])}}class W_{constructor(t){this.scene=t,this._logger=ct.getInstance(),this.queryManager=new z_(this),this.entityManager=new U_(this),this.systemManager=new O_(this)}query(t){return this.queryManager.createQuery(t)}queryTags(t){return this.queryManager.createTagQuery(t)}update(t,i){t===ai.Update&&this.entityManager.updateEntities(this.scene,i),this.systemManager.updateSystems(t,this.scene,i),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(t){if(t instanceof We){this.entityManager.addEntity(t);return}if(t instanceof ui||H_(t)){this.systemManager.addSystem(t);return}this._logger.warn(`Could not add entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(t){return this.systemManager.get(t)}remove(t,i=!0){if(t instanceof We){this.entityManager.removeEntity(t,i);return}if(t instanceof ui){this.systemManager.removeSystem(t);return}this._logger.warn(`Could not remove entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class la extends ui{constructor(t,i){super(),this.world=t,this.physics=i,this.systemType=ai.Update,this._physicsConfigDirty=!1,i.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([st,Mt])}update(t){let i,n;const o=this.query.entities,h=this.physics.config.substep;for(let c=0;c<o.length;c++){i=o[c].get(st),n=o[c].get(Mt);const f=o[c].get(Ct);if(this._physicsConfigDirty&&f&&f.updatePhysicsConfig(this.physics.config.bodies),f?.isSleeping)continue;const g=n.acc.clone();f?.collisionType===ut.Active&&f?.useGravity&&g.addEqual(this.physics.config.gravity),o[c].parent||this.captureOldTransformWithChildren(o[c]),Xe.integrate(i,n,g,t/h)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(t){var i;(i=t.get(Ct))===null||i===void 0||i.captureOldTransform();for(let n=0;n<t.children.length;n++)this.captureOldTransformWithChildren(t.children[n])}}la.priority=ji.Higher;class dl{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map}solve(t){this.preSolve(t),t=t.filter(n=>!n.isCanceled());let i;switch(this.config.contactSolveBias){case ps.HorizontalFirst:{i=nc;break}case ps.VerticalFirst:{i=sc;break}default:i=rc}t.sort((n,o)=>{const h=this.directionMap.get(n.id),c=this.directionMap.get(o.id),f=this.distanceMap.get(n.id),g=this.distanceMap.get(o.id);return i[h]-i[c]||f-g});for(const n of t)this.solvePosition(n),this.solveVelocity(n);return this.postSolve(t),t}preSolve(t){for(let n=0;n<t.length;n++){const o=t[n];if(Math.abs(o.mtv.x)<1e-4&&Math.abs(o.mtv.y)<1e-4){o.cancel();continue}const h=Ut.fromDirection(o.mtv),c=o.mtv.negate(),f=Math.abs(o.info.separation);this.distanceMap.set(o.id,f),this.directionMap.set(o.id,h===Ut.Left||h===Ut.Right?"horizontal":"vertical"),o.colliderA.events.emit("precollision",new ln(o.colliderA,o.colliderB,h,c,o)),o.colliderB.events.emit("precollision",new ln(o.colliderB,o.colliderA,Ut.getOpposite(h),c.negate(),o))}}postSolve(t){var i,n;for(let o=0;o<t.length;o++){const h=t[o];if(h.isCanceled())continue;const c=h.colliderA,f=h.colliderB,g=(i=c.owner)===null||i===void 0?void 0:i.get(Ct),v=(n=f.owner)===null||n===void 0?void 0:n.get(Ct);if(g&&v&&(g.collisionType===ut.Passive||v.collisionType===ut.Passive))continue;const x=Ut.fromDirection(h.mtv),b=h.mtv.negate();h.colliderA.events.emit("postcollision",new cn(h.colliderA,h.colliderB,x,b,h)),h.colliderB.events.emit("postcollision",new cn(h.colliderB,h.colliderA,Ut.getOpposite(x),b.negate(),h))}}solvePosition(t){var i,n;if(!t.colliderA.bounds.overlaps(t.colliderB.bounds,1e-4)){t.cancel();return}if(Math.abs(t.mtv.x)<1e-4&&Math.abs(t.mtv.y)<1e-4){t.cancel();return}let h=t.mtv;const c=t.colliderA,f=t.colliderB,g=(i=c.owner)===null||i===void 0?void 0:i.get(Ct),v=(n=f.owner)===null||n===void 0?void 0:n.get(Ct);if(g&&v){if(g.collisionType===ut.Passive||v.collisionType===ut.Passive)return;g.collisionType===ut.Active&&v.collisionType===ut.Active&&(h=h.scale(.5)),g.collisionType===ut.Active&&(g.globalPos.x-=h.x,g.globalPos.y-=h.y,c.update(g.transform.get())),v.collisionType===ut.Active&&(v.globalPos.x+=h.x,v.globalPos.y+=h.y,f.update(v.transform.get()))}}solveVelocity(t){var i,n;if(t.isCanceled())return;const o=t.colliderA,h=t.colliderB,c=(i=o.owner)===null||i===void 0?void 0:i.get(Ct),f=(n=h.owner)===null||n===void 0?void 0:n.get(Ct);if(c&&f){if(c.collisionType===ut.Passive||f.collisionType===ut.Passive)return;const g=t.normal,v=g.negate();if(c.collisionType===ut.Active&&c.vel.normalize().dot(v)<0){const x=g.scale(g.dot(c.vel.negate()));c.vel=c.vel.add(x)}if(f.collisionType===ut.Active&&f.vel.normalize().dot(g)<0){const x=v.scale(v.dot(f.vel.negate()));f.vel=f.vel.add(x)}}}}class N_{constructor(t,i,n){this.point=t,this.local=i,this.contact=n,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new k(0,0),this.bToContact=new k(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const t=this.contact.bodyA,i=this.contact.colliderA,n=this.contact.bodyB,o=this.contact.colliderB;if(t&&n){const h=this.contact.normal,c=this.contact.tangent;this.aToContact=this.point.sub(i.center),this.bToContact=this.point.sub(o.center);const f=this.aToContact.cross(h),g=this.bToContact.cross(h);this.normalMass=t.inverseMass+n.inverseMass+t.inverseInertia*f*f+n.inverseInertia*g*g;const v=this.aToContact.cross(c),x=this.bToContact.cross(c);this.tangentMass=t.inverseMass+n.inverseMass+t.inverseInertia*v*v+n.inverseInertia*x*x}return this}getRelativeVelocity(){const t=this.contact.bodyA,i=this.contact.bodyB;if(t&&i){const n=t.vel.add(k.cross(t.angularVelocity,this.aToContact));return i.vel.add(k.cross(i.angularVelocity,this.bToContact)).sub(n)}return k.Zero}}class ul{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(t){var i;return(i=this.idToContactConstraint.get(t))!==null&&i!==void 0?i:[]}solve(t){this.preSolve(t),t=t.filter(n=>!n.isCanceled());let i;switch(this.config.contactSolveBias){case ps.HorizontalFirst:{i=nc;break}case ps.VerticalFirst:{i=sc;break}default:i=rc}return t.sort((n,o)=>{const h=this.directionMap.get(n.id),c=this.directionMap.get(o.id),f=this.distanceMap.get(n.id),g=this.distanceMap.get(o.id);return i[h]-i[c]||f-g}),this.solveVelocity(t),this.solvePosition(t),this.postSolve(t),t}preSolve(t){var i,n,o,h;for(let g=0;g<t.length;g++){const v=t[g];if(Math.abs(v.mtv.x)<1e-4&&Math.abs(v.mtv.y)<1e-4){v.cancel();continue}const x=Ut.fromDirection(v.mtv),b=Math.abs(((i=v?.info)===null||i===void 0?void 0:i.separation)||0);this.distanceMap.set(v.id,b),this.directionMap.set(v.id,x===Ut.Left||x===Ut.Right?"horizontal":"vertical"),v.colliderA.events.emit("precollision",new ln(v.colliderA,v.colliderB,x,v.mtv,v)),v.colliderA.events.emit("beforecollisionresolve",new Yo(v.colliderA,v.colliderB,x,v.mtv,v)),v.colliderB.events.emit("precollision",new ln(v.colliderB,v.colliderA,Ut.getOpposite(x),v.mtv.negate(),v)),v.colliderB.events.emit("beforecollisionresolve",new Yo(v.colliderB,v.colliderA,Ut.getOpposite(x),v.mtv.negate(),v)),v.matchAwake()}const f=Array.from(this.idToContactConstraint.keys());for(let g=0;g<t.length;g++){const v=t[g],x=f.indexOf(v.id);x>-1&&f.splice(x,1);const b=(n=this.idToContactConstraint.get(v.id))!==null&&n!==void 0?n:[];let T=0;const P=v.bodyA,I=v.colliderA,F=v.bodyB,R=v.colliderB;if(P&&F)for(let S=0;S<v.points.length;S++){const M=v.points[S],W=v.normal,U=v.tangent,V=M.sub(I.center),j=M.sub(R.center),q=V.cross(W),nt=j.cross(W),ht=P.inverseMass+F.inverseMass+P.inverseInertia*q*q+F.inverseInertia*nt*nt,xt=V.cross(U),gt=j.cross(U),yt=P.inverseMass+F.inverseMass+P.inverseInertia*xt*xt+F.inverseInertia*gt*gt;b[T]&&((h=(o=b[T])===null||o===void 0?void 0:o.point)===null||h===void 0?void 0:h.squareDistance(M))<4?(b[T].point=M,b[T].local=v.localPoints[T]):b[T]=new N_(M,v.localPoints[T],v),b[T].aToContact=V,b[T].bToContact=j,b[T].normalMass=1/ht,b[T].tangentMass=1/yt;const St=P.bounciness>F.bounciness?P.bounciness:F.bounciness,B=v.normal.dot(b[T].getRelativeVelocity());b[T].originalVelocityAndRestitution=0,B<-.1&&(b[T].originalVelocityAndRestitution=-St*B),T++}this.idToContactConstraint.set(v.id,b)}for(const g of f)this.idToContactConstraint.delete(g);if(this.config.warmStart)this.warmStart(t);else for(let g=0;g<t.length;g++){const v=t[g],x=this.getContactConstraints(v.id);for(const b of x)b.normalImpulse=0,b.tangentImpulse=0}}postSolve(t){for(let i=0;i<t.length;i++){const n=t[i],o=n.bodyA,h=n.bodyB;if(o&&h){if(o.collisionType===ut.Passive||h.collisionType===ut.Passive)continue;o.updateMotion(),h.updateMotion()}const c=Ut.fromDirection(n.mtv);n.colliderA.events.emit("postcollision",new cn(n.colliderA,n.colliderB,c,n.mtv,n)),n.colliderA.events.emit("aftercollisionresolve",new jo(n.colliderA,n.colliderB,c,n.mtv,n)),n.colliderB.events.emit("postcollision",new cn(n.colliderB,n.colliderA,Ut.getOpposite(c),n.mtv.negate(),n)),n.colliderB.events.emit("aftercollisionresolve",new jo(n.colliderB,n.colliderA,Ut.getOpposite(c),n.mtv.negate(),n))}this.lastFrameContacts.clear();for(let i=0;i<t.length;i++){const n=t[i];this.lastFrameContacts.set(n.id,n)}}warmStart(t){var i;for(let n=0;n<t.length;n++){const o=t[n],h=o.bodyA,c=o.bodyB;if(h&&c){const f=(i=this.idToContactConstraint.get(o.id))!==null&&i!==void 0?i:[];for(const g of f)if(this.config.warmStart){const v=o.normal.scale(g.normalImpulse),x=o.tangent.scale(g.tangentImpulse),b=v.add(x);h.applyImpulse(g.point,b.negate()),c.applyImpulse(g.point,b)}else g.normalImpulse=0,g.tangentImpulse=0}}}solvePosition(t){var i;for(let n=0;n<this.config.positionIterations;n++)for(let o=0;o<t.length;o++){const h=t[o],c=h.bodyA,f=h.bodyB;if(c&&f){if(c.collisionType===ut.Passive||f.collisionType===ut.Passive)continue;const g=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const v of g){const x=h.normal,b=Ei.FindContactSeparation(h,v.local),T=this.config.steeringFactor,P=-5,I=this.config.slop,F=bt(T*(b+I),P,0),R=x.scale(-F*v.normalMass);if(c.collisionType===ut.Active){const S=R.negate().scale(c.inverseMass);c.limitDegreeOfFreedom.includes(ti.X)&&(S.x=0),c.limitDegreeOfFreedom.includes(ti.Y)&&(S.y=0),c.globalPos=c.globalPos.add(S),c.limitDegreeOfFreedom.includes(ti.Rotation)||(c.rotation-=v.aToContact.cross(R)*c.inverseInertia)}if(f.collisionType===ut.Active){const S=R.scale(f.inverseMass);f.limitDegreeOfFreedom.includes(ti.X)&&(S.x=0),f.limitDegreeOfFreedom.includes(ti.Y)&&(S.y=0),f.globalPos=f.globalPos.add(S),f.limitDegreeOfFreedom.includes(ti.Rotation)||(f.rotation+=v.bToContact.cross(R)*f.inverseInertia)}}}}}solveVelocity(t){var i;for(let n=0;n<this.config.velocityIterations;n++)for(let o=0;o<t.length;o++){const h=t[o],c=h.bodyA,f=h.bodyB;if(c&&f){if(c.collisionType===ut.Passive||f.collisionType===ut.Passive)continue;const g=Math.min(c.friction,f.friction),v=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const x of v){let P=-x.getRelativeVelocity().dot(h.tangent)*x.tangentMass;const I=g*x.normalImpulse,F=bt(x.tangentImpulse+P,-I,I);P=F-x.tangentImpulse,x.tangentImpulse=F;const R=h.tangent.scale(P);c.applyImpulse(x.point,R.negate()),f.applyImpulse(x.point,R)}for(const x of v){const T=x.getRelativeVelocity().dot(h.normal);let P=-x.normalMass*(T-x.originalVelocityAndRestitution);const I=Math.max(x.normalImpulse+P,0);P=I-x.normalImpulse,x.normalImpulse=I;const F=h.normal.scale(P);c.applyImpulse(x.point,F.negate()),f.applyImpulse(x.point,F)}}}}}class ca extends ui{get _processor(){return this._physics.collisionProcessor}constructor(t,i){super(),this._physics=i,this.systemType=ai.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new dl(i.config.arcade),this._realisticSolver=new ul(i.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=n=>this._processor.track(n),this._untrackCollider=n=>this._processor.untrack(n),this.query=t.query([st,Mt,fe]),this.query.entityAdded$.subscribe(n=>{const o=n.get(fe);o.$colliderAdded.subscribe(this._trackCollider),o.$colliderRemoved.subscribe(this._untrackCollider);const h=o.get();h&&this._processor.track(h)}),this.query.entityRemoved$.subscribe(n=>{const o=n.get(fe),h=o.get();o&&h&&this._processor.untrack(h)}),this._motionSystem=t.get(la)}initialize(t,i){this._engine=i.engine}update(t){var i,n,o,h;if(!this._physics.config.enabled)return;let c=[];for(let b=0;b<this.query.entities.length;b++){const P=this.query.entities[b].get(fe),I=P?.get();if(P&&(!((i=P.owner)===null||i===void 0)&&i.isActive)&&I)if(P.update(),I instanceof Ce){const F=I.getColliders();I.compositeStrategy||(I.compositeStrategy=this._physics.config.colliders.compositeStrategy),c=c.concat(F)}else c.push(I)}this._processor.update(c,t);let f=this._processor.broadphase(c,t);this._currentFrameContacts.clear();let g=[];const v=this.getSolver(),x=this._physics.config.substep;for(let b=0;b<x;b++)if(b>0&&this._motionSystem.update(t),g.length&&(f=g.map(T=>new je(T.colliderA,T.colliderB))),f.length){g=this._processor.narrowphase(f,(h=(o=(n=this._engine)===null||n===void 0?void 0:n.debug)===null||o===void 0?void 0:o.stats)===null||h===void 0?void 0:h.currFrame),g=v.solve(g);for(const T of g){if(T.isCanceled())continue;const P=T.id.indexOf("|");if(P>0){const I=T.id.substring(P+1);this._currentFrameContacts.set(I,T)}else this._currentFrameContacts.set(T.id,T)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const b of this.query.entities){const T=b.get(fe);T&&T.processColliderRemoval()}}postupdate(){ue.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new dl(this._physics.config.arcade),this._realisticSolver=new ul(this._physics.config.realistic)),this._physics.config.solver===Cr.Realistic?this._realisticSolver:this._arcadeSolver}debug(t){this._processor.debug(t,0)}runContactStartEnd(){for(const[t,i]of this._currentFrameContacts)if(!this._lastFrameContacts.has(t)){const n=i.colliderA,o=i.colliderB,h=Ut.fromDirection(i.mtv),c=Ut.getOpposite(h);n.events.emit("collisionstart",new xr(n,o,h,i)),n.events.emit("contactstart",new qo(n,o,h,i)),o.events.emit("collisionstart",new xr(o,n,c,i)),o.events.emit("contactstart",new qo(o,n,c,i))}for(const[t,i]of this._lastFrameContacts)if(!this._currentFrameContacts.has(t)){const n=i.colliderA,o=i.colliderB,h=Ut.fromDirection(i.mtv),c=Ut.getOpposite(h);n.events.emit("collisionend",new br(n,o,h,i)),n.events.emit("contactend",new Xo(n,o,h,i)),o.events.emit("collisionend",new br(o,n,c,i)),o.events.emit("contactend",new Xo(o,n,c,i))}}}ca.priority=ji.Higher;function Gm(d,t,i,n){if(d.parent!==t.parent){const x=d.clone(),b=d.globalPos.clone(),T=d.globalScale.clone(),P=d.globalRotation;x.parent=t.parent,x.globalPos=b,x.globalScale=T,x.globalRotation=P,d=x}let o=t.pos,h=t.scale,c=t.rotation;o=t.pos.scale(i).add(d.pos.scale(1-i)),h=t.scale.scale(i).add(d.scale.scale(1-i));const f=(1-i)*Math.cos(d.rotation)+i*Math.cos(t.rotation),g=(1-i)*Math.sin(d.rotation)+i*Math.sin(t.rotation);c=Math.atan2(g,f);const v=n??new _s;return v.setTransform(o,c,h),v}class lc extends ui{get sortedTransforms(){return this._sortedTransforms}constructor(t){super(),this.world=t,this.systemType=ai.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new _s,this.query=this.world.query([st,se]),this.query.entityAdded$.subscribe(i=>{const n=i.get(st);this._sortedTransforms.push(n),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{const n=i.get(st);n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const o=this._sortedTransforms.indexOf(n);o>-1&&this._sortedTransforms.splice(o,1)})}initialize(t,i){this._camera=i.camera,this._engine=i.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>t.globalZ-i.globalZ),this._zHasChanged=!1)}update(t){this._token++;let i;Lt.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let n=0;n<this._sortedTransforms.length;n++){const o=this._sortedTransforms[n],h=o.owner;if(h.hasTag("ex.offscreen")||(i=h.get(se),!i.isVisible))continue;i.onPreTransformDraw&&i.onPreTransformDraw(this._graphicsContext,t),h.events.emit("pretransformdraw",new Ml(this._graphicsContext,t,h)),o.coordPlane===Me.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),o.coordPlane===Me.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),i.update(t,this._token);const c=h.get(aa);if(c){const f=k.One.sub(c.parallaxFactor),g=this._camera.drawPos.scale(f);this._graphicsContext.translate(g.x,g.y)}this._applyTransform(h),i.material&&(this._graphicsContext.material=i.material),i.onPreDraw&&i.onPreDraw(this._graphicsContext,t),h.events.emit("predraw",new Nn(this._graphicsContext,t,h)),this._applyOpacity(h),this._drawGraphicsComponent(i,o),i.onPostDraw&&i.onPostDraw(this._graphicsContext,t),h.events.emit("postdraw",new Gn(this._graphicsContext,t,h)),this._graphicsContext.restore(),o.coordPlane===Me.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),i.onPostTransformDraw&&i.onPostTransformDraw(this._graphicsContext,t),h.events.emit("posttransformdraw",new Fl(this._graphicsContext,t,h))}this._graphicsContext.restore()}_drawGraphicsComponent(t,i){var n,o;if(t.isVisible){const h=t.flipHorizontal,c=t.flipVertical,f=t.current,g=(n=t.currentOptions)!==null&&n!==void 0?n:{};if(f){let v=t.anchor,x=t.offset,b=1,T=1;g?.anchor&&(v=g.anchor),g?.offset&&(x=g.offset);const P=i.globalScale;b*=f.scale.x*P.x,T*=f.scale.y*P.y;const I=-f.width*v.x+x.x*b,F=-f.height*v.y+x.y*T,R=f.flipHorizontal,S=f.flipVertical;if((h||c)&&(f.flipHorizontal=h?!R:R,f.flipVertical=c?!S:S),f?.draw(this._graphicsContext,I,F),(h||c)&&(f.flipHorizontal=R,f.flipVertical=S),!((o=this._engine)===null||o===void 0)&&o.isDebug&&this._engine.debug.graphics.showBounds){const M=G(I,F);if(f instanceof Bn)for(const W of f.members){let U,V=k.Zero;W instanceof ie?U=W:(U=W.graphic,V=W.offset),f.useAnchor?U?.localBounds.translate(M.add(V)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):U?.localBounds.translate(V).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else f?.localBounds.translate(M).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(t){const i=t.getAncestors();for(let n=0;n<i.length;n++){const o=i[n],h=o?.get(st),c=o?.get(Ct);if(h){let f=h.get();if(c&&this._engine.fixedUpdateTimestep&&c.__oldTransformCaptured&&c.enableFixedUpdateInterpolate){const g=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;f=Gm(c.oldTransform,h.get(),g,this._targetInterpolationTransform)}this._graphicsContext.z=h.globalZ,this._graphicsContext.translate(f.pos.x,f.pos.y),this._graphicsContext.scale(f.scale.x,f.scale.y),this._graphicsContext.rotate(f.rotation)}}}_applyOpacity(t){var i;const n=t.getAncestors();for(let o=0;o<n.length;o++){const h=n[o],c=h?.get(se);this._graphicsContext.opacity*=(i=c?.opacity)!==null&&i!==void 0?i:1}}}lc.priority=ji.Average;class cc extends ui{constructor(t){super(),this.world=t,this.systemType=ai.Draw,this.query=this.world.query([st])}initialize(t,i){this._graphicsContext=i.engine.graphicsContext,this._camera=i.camera,this._engine=i.engine,this._collisionSystem=t.systemManager.get(ca)}update(){var t;if(!this._engine.isDebug)return;const i=this._engine.debug.filter;let n,o;const h=this._engine.debug.entity;let c;const f=this._engine.debug.transform;let g;const v=this._engine.debug.motion;let x;const b=this._engine.debug.collider,T=this._engine.debug.physics;let P;const I=this._engine.debug.graphics;let F,R;const S=this._engine.debug.body,M=this._engine.debug.camera;for(let W=0;W<this.query.entities.length;W++){const U=this.query.entities[W];if(U.hasTag("offscreen")||U instanceof sa||i.useFilter&&(!(i.ids.length===0||i.ids.includes(U.id))||!(i.nameQuery===""||U.name.includes(i.nameQuery))))continue;let V=k.Zero;const j=G(0,16);if(n=U.id,o=U.name,c=U.get(st),this._pushCameraTransform(c),this._graphicsContext.save(),c.coordPlane===Me.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=f.debugZIndex,this._applyTransform(U),c&&((f.showAll||f.showPosition)&&this._graphicsContext.debug.drawPoint(k.Zero,{size:4,color:f.positionColor}),(f.showAll||f.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${c.pos.toString(2)}`,V),V=V.add(j)),(f.showAll||f.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${c.z.toFixed(1)})`,V),V=V.add(j)),(h.showAll||h.showId)&&(this._graphicsContext.debug.drawText(`id(${n}) ${U.parent?"child of id("+((t=U.parent)===null||t===void 0?void 0:t.id)+")":""}`,V),V=V.add(j)),(h.showAll||h.showName)&&(this._graphicsContext.debug.drawText(`name(${o})`,V),V=V.add(j)),(f.showAll||f.showRotation)&&(this._graphicsContext.drawLine(k.Zero,k.fromAngle(c.rotation).scale(50).add(k.Zero),f.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${Mu(c.rotation).toFixed(2)})`,V),V=V.add(j)),(f.showAll||f.showScale)&&this._graphicsContext.drawLine(k.Zero,c.scale.add(k.Zero),f.scaleColor,2)),P=U.get(se),P&&(I.showAll||I.showBounds)&&P.localBounds.draw(this._graphicsContext,I.boundsColor),F=U.get(ha),F&&(F.useTransform||this._graphicsContext.restore(),F.draw(this._graphicsContext,this._engine.debug),F.useTransform||(this._graphicsContext.save(),this._applyTransform(U))),R=U.get(Ct),R&&((S.showAll||S.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${R.group.name})`,V),V=V.add(j)),(S.showAll||S.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${R.collisionType})`,V),V=V.add(j)),(S.showAll||S.showMass)&&(this._graphicsContext.debug.drawText(`mass(${R.mass})`,V),V=V.add(j)),(S.showAll||S.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${R.sleepMotion})`,V),V=V.add(j)),(S.showAll||S.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${R.canSleep?R.isSleeping:"cant sleep"})`,V),V=V.add(j))),this._graphicsContext.restore(),this._graphicsContext.save(),c.coordPlane===Me.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=f.debugZIndex,g=U.get(Mt),g&&((v.showAll||v.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${g.vel.toString(2)}`,V.add(c.globalPos)),this._graphicsContext.drawLine(c.globalPos,c.globalPos.add(g.vel),v.velocityColor,2),V=V.add(j)),(v.showAll||v.showAcceleration)&&this._graphicsContext.drawLine(c.globalPos,c.globalPos.add(g.acc),v.accelerationColor,2)),x=U.get(fe),x){const q=x.get();if((b.showAll||b.showGeometry)&&q&&q.debug(this._graphicsContext,b.geometryColor,{lineWidth:b.geometryLineWidth,pointSize:b.geometryPointSize}),b.showAll||b.showBounds){if(q instanceof Ce){const nt=q.getColliders();for(const ht of nt){const xt=ht.bounds,gt=G(xt.left,xt.top);this._graphicsContext.debug.drawRect(gt.x,gt.y,xt.width,xt.height,{color:b.boundsColor}),(b.showAll||b.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${ht.owner.id})`,gt)}x.bounds.draw(this._graphicsContext,b.boundsColor)}else if(q){const nt=x.bounds,ht=G(nt.left,nt.top);this._graphicsContext.debug.drawRect(ht.x,ht.y,nt.width,nt.height,{color:b.boundsColor}),(b.showAll||b.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${x.owner.id})`,ht)}}}this._graphicsContext.restore(),this._popCameraTransform(c)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(T.showAll||T.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),T.showAll||T.showCollisionContacts||T.showCollisionNormals)for(const[W,U]of this._engine.debug.stats.currFrame.physics.contacts){if(T.showAll||T.showCollisionContacts)for(const V of U.points)this._graphicsContext.debug.drawPoint(V,{size:T.contactSize,color:T.collisionContactColor});if(T.showAll||T.showCollisionNormals)for(const V of U.points)this._graphicsContext.debug.drawLine(V,U.normal.scale(30).add(V),{color:T.collisionNormalColor})}this._graphicsContext.restore(),M&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(M.showAll||M.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,M.focusColor),(M.showAll||M.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(t,i){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),Ae.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(t){const i=t.getAncestors();for(const n of i){const o=n?.get(st);o&&(this._graphicsContext.translate(o.pos.x,o.pos.y),this._graphicsContext.scale(o.scale.x,o.scale.y),this._graphicsContext.rotate(o.rotation))}}_pushCameraTransform(t){t.coordPlane===Me.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(t){t.coordPlane===Me.World&&this._graphicsContext.restore()}}cc.priority=ji.Lowest;class dc{constructor(t,i){this.object=t,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=i,this.bounds=t.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const t=this.object.bounds,i=Math.floor(t.left/this.gridSize),n=Math.floor(t.right/this.gridSize),o=Math.floor(t.bottom/this.gridSize),h=Math.floor(t.top/this.gridSize);return this.leftX!==i||this.rightX!==n||this.bottomY!==o||this.topY!==h}clear(){for(const t of this.cells){const i=t.proxies.indexOf(this);i>-1&&t.proxies.splice(i,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class Ni{constructor(){this.proxies=[]}configure(t,i){this.x=t,this.y=i,this.key=Ni.calculateHashKey(t,i)}static calculateHashKey(t,i){return`${t}+${i}`}}class uc{constructor(t){this.bounds=new lt,this._hashGridCellPool=new Fr(()=>new Ni,i=>(i.configure(0,0),i.proxies.length=0,i),1e3),this.gridSize=t.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,t.proxyFactory?this._buildProxy=i=>t.proxyFactory(i,this.gridSize):this._buildProxy=i=>new dc(i,this.gridSize)}query(t){const i=new Set;if(t instanceof lt){const n=t,o=Math.floor(n.left/this.gridSize),h=Math.floor(n.right/this.gridSize),c=Math.floor(n.bottom/this.gridSize),f=Math.floor(n.top/this.gridSize);for(let g=o;g<=h;g++)for(let v=f;v<=c;v++){const x=Ni.calculateHashKey(g,v),b=this.sparseHashGrid.get(x);if(b)for(let T=0;T<b.proxies.length;T++)b.proxies[T].updateBounds(),b.proxies[T].bounds.intersect(n)&&i.add(b.proxies[T].object)}}else{const n=t,o=Ni.calculateHashKey(Math.floor(n.x/this.gridSize),Math.floor(n.y/this.gridSize)),h=this.sparseHashGrid.get(o);if(h)for(let c=0;c<h.proxies.length;c++)h.proxies[c].updateBounds(),h.proxies[c].bounds.contains(n)&&i.add(h.proxies[c].object)}return Array.from(i)}get(t,i){const n=Ni.calculateHashKey(t,i);return this.sparseHashGrid.get(n)}_insert(t,i,n){const o=Ni.calculateHashKey(t,i);let h=this.sparseHashGrid.get(o);h||(h=this._hashGridCellPool.rent(),h.configure(t,i),this.sparseHashGrid.set(h.key,h)),h.proxies.push(n),n.cells.push(h),this.bounds.combine(n.bounds,this.bounds)}_remove(t,i,n){const o=Ni.calculateHashKey(t,i),h=this.sparseHashGrid.get(o);if(h){const c=h.proxies.indexOf(n);c>-1&&h.proxies.splice(c,1);const f=n.cells.indexOf(h);f>-1&&n.cells.splice(f,1),h.proxies.length===0&&(this._hashGridCellPool.return(h),this.sparseHashGrid.delete(o))}}track(t){const i=this._buildProxy(t);this.objectToProxy.set(t,i);for(let n=i.leftX;n<=i.rightX;n++)for(let o=i.topY;o<=i.bottomY;o++)this._insert(n,o,i)}untrack(t){const i=this.objectToProxy.get(t);i&&(i.clear(),this.objectToProxy.delete(t))}update(t){let i=0;for(const n of t){const o=this.objectToProxy.get(n);if(o&&o.hasChanged()){for(let h=o.leftX;h<=o.rightX;h++)for(let c=o.topY;c<=o.bottomY;c++)this._remove(h,c,o);o.update();for(let h=o.leftX;h<=o.rightX;h++)for(let c=o.topY;c<=o.bottomY;c++)this._insert(h,c,o);i++}}return i}debug(t,i){const n=K.Transparent,o=K.White;for(const h of this.sparseHashGrid.values())t.drawRectangle(G(h.x*this.gridSize,h.y*this.gridSize),this.gridSize,this.gridSize,n,o,2)}}class da extends ui{constructor(t){super(),this.world=t,this.systemType=ai.Update,this._graphicsHashGrid=new uc({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new hc,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([st,Fs]),this.query.entityAdded$.subscribe(i=>{const n=i.get(st),o=i.get(Fs);this._pointerEventDispatcher.addObject(i,c=>o&&o.localBounds?o.localBounds.transform(n.get().matrix).contains(n.coordPlane===Me.World?c.worldPos:c.screenPos):!1,()=>i.isActive),this._entityToPointer.set(i,o);const h=i.get(se);h&&(this._graphics.push(h),this._graphicsHashGrid.track(h)),this._sortedTransforms.push(n),this._sortedEntities.push(n.owner),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{this._pointerEventDispatcher.removeObject(i);const n=i.get(st);this._entityToPointer.delete(i);const o=i.get(se);if(o){const c=this._graphics.indexOf(o);c>-1&&this._graphics.splice(c,1),this._graphicsHashGrid.untrack(o)}n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const h=this._sortedTransforms.indexOf(n);h>-1&&(this._sortedTransforms.splice(h,1),this._sortedEntities.splice(h,1))})}initialize(t,i){this._engine=i.engine,this._scene=i}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>i.z-t.z),this._sortedEntities=this._sortedTransforms.map(t=>t.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[t,i]of this._engineReceiver.currentFramePointerCoords.entries()){const n=this._scene.physics.query(i.worldPos);for(let h=0;h<n.length;h++){const c=n[h],f=this._entityToPointer.get(c.owner);f&&(f.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(c.owner,t)}const o=this._graphicsHashGrid.query(i.worldPos);for(let h=0;h<o.length;h++){const c=o[h],f=this._entityToPointer.get(c.owner);f&&(f.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(c.owner,t)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(t=>t.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(t=>t.clear())}}da.priority=ji.Higher;class _c extends ui{constructor(t){super(),this.world=t,this.systemType=ai.Update,this._actions=[],this.query=this.world.query([Mn]),this.query.entityAdded$.subscribe(i=>this._actions.push(i.get(Mn))),this.query.entityRemoved$.subscribe(i=>{const n=i.get(Mn),o=this._actions.indexOf(n);o>-1&&this._actions.splice(o,1)})}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}}_c.priority=ji.Higher;class Sr extends fi{constructor(t){super(),this.elevation=0,this.columns=t.columns,this.rows=t.rows,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight}}class fc extends ui{constructor(t){super(),this.world=t,this.systemType=ai.Update,this.query=this.world.query([st,Sr])}update(){let t,i;for(let n=0;n<this.query.entities.length;n++){const o=this.query.entities[n];t=o.get(st),i=o.get(Sr);const c=Math.max(i.columns*i.tileWidth,i.rows*i.tileHeight)*i.elevation+t.pos.y;t.z=c}}}fc.priority=ji.Lower;class pc extends ui{constructor(t){super(),this.world=t,this.systemType=ai.Draw,this.query=this.world.query([st,se])}initialize(t,i){this._camera=i.camera,this._screen=i.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let t,i,n;for(let o=0;o<this.query.entities.length;o++){const h=this.query.entities[o];i=h.get(se),t=h.get(st),n=h.get(aa);let c;if(n){const g=k.One.sub(n.parallaxFactor);c=this._camera.pos.scale(g)}const f=this._isOffscreen(t,i,c);f&&!h.hasTag("ex.offscreen")&&(h.events.emit("exitviewport",new Xl(h)),h.addTag("ex.offscreen")),!f&&h.hasTag("ex.offscreen")&&(h.events.emit("enterviewport",new Yl(h)),h.removeTag("ex.offscreen"))}}_isOffscreen(t,i,n){if(i.forceOnScreen)return!1;if(t.coordPlane===Me.World){let o=i.localBounds;n&&(o=o.translate(n));const h=o.transform(t.get().matrix);return!this._worldBounds.overlaps(h)}else return!1}}pc.priority=ji.Higher;class G_ extends dc{constructor(t,i){var n,o;super(t,i),this.collider=t,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=i;const h=t.bounds;this.hasZeroBounds=h.hasZeroDimensions(),this.leftX=Math.floor(h.left/this.gridSize),this.rightX=Math.floor(h.right/this.gridSize),this.bottomY=Math.floor(h.bottom/this.gridSize),this.topY=Math.floor(h.top/this.gridSize),this.owner=t.owner,this.body=(n=this.owner)===null||n===void 0?void 0:n.get(Ct),this.collisionType=(o=this.body.collisionType)!==null&&o!==void 0?o:ut.PreventCollision}update(){var t,i;super.update(),this.body=(t=this.owner)===null||t===void 0?void 0:t.get(Ct),this.collisionType=(i=this.body.collisionType)!==null&&i!==void 0?i:ut.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class _l{constructor(t){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new ea(()=>new je({id:on("collider",0)},{id:on("collider",0)}),i=>(i.colliderA=null,i.colliderB=null,i),200),this.gridSize=t.size,this.hashGrid=new uc({size:this.gridSize,proxyFactory:(i,n)=>new G_(i,n)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(t){return this.hashGrid.query(t)}rayCast(t,i){var n,o,h;const c=[],f=(n=i?.maxDistance)!==null&&n!==void 0?n:1/0,g=i?.collisionGroup,v=g?g.category:(o=i?.collisionMask)!==null&&o!==void 0?o:fs.All.category,x=(h=i?.searchAllColliders)!==null&&h!==void 0?h:!1,b=t.dir.normalize(),T=b.y/b.x,P=b.x/b.y,I=Math.sqrt(1+T*T)*this.gridSize,F=Math.sqrt(1+P*P)*this.gridSize,R=t.pos.x/this.gridSize,S=t.pos.y/this.gridSize,M=G(1,1);let W=~~R,U=~~S,V=0,j=0;b.x<0?(M.x=-1,V=(R-W)*I):(M.x=1,V=(W+1-R)*I),b.y<0?(M.y=-1,j=(S-U)*F):(M.y=1,j=(U+1-S)*F);const q=new Set;let nt=!1,ht=9999;for(;!nt&&ht>0&&(ht--,!!this.hashGrid.bounds.contains(G(W*this.gridSize,U*this.gridSize)));){const xt=Ni.calculateHashKey(W,U),gt=this.hashGrid.sparseHashGrid.get(xt);if(gt){const yt=[];for(let St=0;St<gt.proxies.length;St++){const B=gt.proxies[St];if(!q.has(B.collider.id.value)){if(q.add(B.collider.id.value),i?.ignoreCollisionGroupAll&&B.body.group===fs.All)continue;const z=(v&B.body.group.category)!==0;if(B.body.group&&!z)continue;const $=B.collider.rayCast(t,f);$&&yt.push($)}}yt.sort((St,B)=>St.distance-B.distance);for(let St=0;St<yt.length;St++){const B=yt[St];if(i?.filter){if(i.filter(B)&&(c.push(B),!x)){nt=!0;break}}else if(c.push(B),!x){nt=!0;break}}}V<j?(W+=M.x,V+=I):(U+=M.y,j+=F)}return c.sort((xt,gt)=>xt.distance-gt.distance),!x&&c.length?[c[0]]:c}track(t){let i=[t];if(t instanceof Ce){const n=t.getColliders();for(const o of n)o.owner=t.owner;i=n}for(const n of i)this.hashGrid.track(n)}untrack(t){let i=[t];t instanceof Ce&&(i=t.getColliders());for(const n of i)this.hashGrid.untrack(n)}_canCollide(t,i){return!(t.collider.id===i.collider.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.hasZeroBounds||i.hasZeroBounds||!t.body.group.canCollide(i.body.group)||t.collisionType===ut.Fixed&&i.collisionType===ut.Fixed||t.collisionType===ut.PreventCollision||i.collisionType===ut.PreventCollision||!t.owner.isActive||!i.owner.isActive)}broadphase(t,i){const n=[];this._pairs.clear(),this._nonPairs.clear();let o=0;for(const h of this.hashGrid.objectToProxy.values())if(h.id=o++,!(!h.owner.isActive||h.collisionType===ut.PreventCollision))for(let c=0;c<h.cells.length;c++){const f=h.cells[c];for(let g=0;g<f.proxies.length;g++){const v=f.proxies[g];if(v.id===h.id)continue;const x=je.calculatePairHash(h.collider.id,v.collider.id);if(!this._nonPairs.has(x))if(!this._pairs.has(x)&&this._canCollide(h,v)&&h.object.bounds.overlaps(v.object.bounds)){const b=this._pairPool.get();b.colliderA=h.collider,b.colliderB=v.collider,b.id=x,this._pairs.add(x),n.push(b)}else this._nonPairs.add(x)}}return n}narrowphase(t,i){const n=[];for(let o=0;o<t.length;o++){const h=t[o].collide();for(let c=0;c<h.length;c++){const f=h[c];n.push(f),i&&i.physics.contacts.set(f.id,f)}}return this._pairPool.done(),i&&(i.physics.collisions+=n.length),n}update(t,i){return this.hashGrid.update(t)}debug(t,i){this.hashGrid.debug(t,i)}}class V_{get config(){return Ug(this._config,t=>{this.$configUpdate.notifyAll(t)})}set config(t){this._config=t,this.$configUpdate.notifyAll(t)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const t=this._collisionProcessor.getColliders();this._config.spatialPartition===kn.SparseHashGrid?this._collisionProcessor=new _l(this._config.sparseHashGrid):this._collisionProcessor=new $o(this._config);for(const i of t)this._collisionProcessor.track(i)}return this._collisionProcessor}constructor(t){this.$configUpdate=new Ye,this._configDirty=!1,this.config=t,this.$configUpdate.subscribe(i=>{this._configDirty=!0,Ct.updateDefaultPhysicsConfig(i.bodies)}),this._config.spatialPartition===kn.SparseHashGrid?this._collisionProcessor=new _l(this._config.sparseHashGrid):this._collisionProcessor=new $o(this._config)}rayCast(t,i){return this.collisionProcessor.rayCast(t,i)}query(t){return this._collisionProcessor.query(t)}}class ua{constructor(){this.events=new Zt,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(t){this._enabled=t}setMinimumGamepadConfiguration(t){this._enableAndUpdate(),this._minimumConfiguration=t}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(t){if(!this._minimumConfiguration)return!0;if(!t)return!1;const i=t.axes.filter(o=>typeof o!==void 0).length,n=t.buttons.filter(o=>typeof o!==void 0).length;return i>=this._minimumConfiguration.axis&&n>=this._minimumConfiguration.buttons&&t.connected}emit(t,i){this.events.emit(t,i)}on(t,i){return this._enableAndUpdate(),this.events.on(t,i)}once(t,i){return this._enableAndUpdate(),this.events.once(t,i)}off(t,i){this._enableAndUpdate(),this.events.off(t,i)}update(){var t,i;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const n=this._navigator.getGamepads();for(let o=0;o<n.length;o++){if(n[o]){const c=this.at(o);!this.at(o).connected&&this._isGamepadValid(n[o])&&(c.events.pipe(this.events),this.events.emit("connect",new zl(o,this.at(o)))),this.at(o).connected=!0}else{const c=this.at(o);c.connected&&(this.events.emit("disconnect",new Hl(o,c)),c.events.unpipe(this.events)),c.connected=!1;continue}if(this.at(o).update(),n[o].timestamp&&n[o].timestamp===this._gamePadTimeStamps[o])continue;this._gamePadTimeStamps[o]=n[o].timestamp,this.at(o).navigatorGamepad=n[o];const h=n[o];if(h){for(let c=0;c<h.buttons.length;c++){const f=h.buttons[c],g=f?.value;g!==((t=this._oldPads[o])===null||t===void 0?void 0:t.getButton(c))&&(f?.pressed?(this.at(o).updateButton(c,g),this.at(o).events.emit("button",new Ol(c in Er?c:Er.Unknown,c,g,this.at(o)))):this.at(o).updateButton(c,0))}for(let c=0;c<h.axes.length;c++){const f=h.axes[c];f!==((i=this._oldPads[o])===null||i===void 0?void 0:i.getAxes(c))&&(this.at(o).updateAxes(c,f),this.at(o).events.emit("axis",new Wl(c,f,this.at(o))))}}this._oldPads[o]=this._clonePad(n[o])}}at(t){if(this._enableAndUpdate(),t>=this._pads.length)for(let i=this._pads.length-1,n=t;i<n;i++)this._pads.push(new ko),this._oldPads.push(new ko);return this._pads[t]}getValidGamepads(){this._enableAndUpdate();const t=[];for(let i=0;i<this._pads.length;i++)this._isGamepadValid(this.at(i).navigatorGamepad)&&this.at(i).connected&&t.push(this.at(i));return t}count(){return this._pads.filter(t=>t.connected).length}_clonePads(t){const i=[];for(let n=0,o=t.length;n<o;n++)i.push(this._clonePad(t[n]));return i}_clonePad(t){let i,n;const o=new ko;if(!t)return o;for(i=0,n=t.buttons.length;i<n;i++)t.buttons[i]&&o.updateButton(i,t.buttons[i].value);for(i=0,n=t.axes.length;i<n;i++)o.updateAxes(i,t.axes[i]);return o}}ua.MinAxisMoveThreshold=.05;class ko{constructor(){this.events=new Zt,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let t=0;t<this._buttons.length;t++)this._buttons[t]=0;for(let t=0;t<this._axes.length;t++)this._axes[t]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(t,i=1){return this._buttons[t]>=i}isButtonHeld(t,i=1){return this._buttons[t]>=i}wasButtonPressed(t,i=1){return this._buttonsDown[t]>=i}wasButtonReleased(t){return!!this._buttonsUp[t]}getButton(t){return this._buttons[t]}getAxes(t){const i=this._axes[t];return Math.abs(i)<ua.MinAxisMoveThreshold?0:i}updateButton(t,i){i===0&&this._buttons[t]?this._buttonsUp[t]=1:this._buttonsDown[t]=i,this._buttons[t]=i}updateAxes(t,i){this._axes[t]=i}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}var Er;(function(d){d[d.Unknown=-1]="Unknown",d[d.Face1=0]="Face1",d[d.Face2=1]="Face2",d[d.Face3=2]="Face3",d[d.Face4=3]="Face4",d[d.LeftBumper=4]="LeftBumper",d[d.RightBumper=5]="RightBumper",d[d.LeftTrigger=6]="LeftTrigger",d[d.RightTrigger=7]="RightTrigger",d[d.Select=8]="Select",d[d.Start=9]="Start",d[d.LeftStick=10]="LeftStick",d[d.RightStick=11]="RightStick",d[d.DpadUp=12]="DpadUp",d[d.DpadDown=13]="DpadDown",d[d.DpadLeft=14]="DpadLeft",d[d.DpadRight=15]="DpadRight",d[d.CenterButton=16]="CenterButton",d[d.MiscButton1=17]="MiscButton1"})(Er||(Er={}));var fl;(function(d){d[d.LeftStickX=0]="LeftStickX",d[d.LeftStickY=1]="LeftStickY",d[d.RightStickX=2]="RightStickX",d[d.RightStickY=3]="RightStickY"})(fl||(fl={}));class q_{constructor(t){this.inputs=t,this._handlers=new Map}execute(){for(const[t,i]of this._handlers.entries()){const n=t(this.inputs);n&&i(n)}}on(t,i){this._handlers.set(t,i)}}function X_(){try{const d=()=>{};window.top.addEventListener("blur",d),window.top.removeEventListener("blur",d)}catch{return!0}return!1}var Ir;(function(d){d.Backquote="Backquote",d.Backslash="Backslash",d.BracketLeft="BracketLeft",d.BracketRight="BracketRight",d.Comma="Comma",d.Key0="Digit0",d.Key1="Digit1",d.Key2="Digit2",d.Key3="Digit3",d.Key4="Digit4",d.Key5="Digit5",d.Key6="Digit6",d.Key7="Digit7",d.Key8="Digit8",d.Key9="Digit9",d.Digit0="Digit0",d.Digit1="Digit1",d.Digit2="Digit2",d.Digit3="Digit3",d.Digit4="Digit4",d.Digit5="Digit5",d.Digit6="Digit6",d.Digit7="Digit7",d.Digit8="Digit8",d.Digit9="Digit9",d.Equal="Equal",d.IntlBackslash="IntlBackslash",d.IntlRo="IntlRo",d.IntlYen="IntlYen",d.A="KeyA",d.B="KeyB",d.C="KeyC",d.D="KeyD",d.E="KeyE",d.F="KeyF",d.G="KeyG",d.H="KeyH",d.I="KeyI",d.J="KeyJ",d.K="KeyK",d.L="KeyL",d.M="KeyM",d.N="KeyN",d.O="KeyO",d.P="KeyP",d.Q="KeyQ",d.R="KeyR",d.S="KeyS",d.T="KeyT",d.U="KeyU",d.V="KeyV",d.W="KeyW",d.X="KeyX",d.Y="KeyY",d.Z="KeyZ",d.KeyA="KeyA",d.KeyB="KeyB",d.KeyC="KeyC",d.KeyD="KeyD",d.KeyE="KeyE",d.KeyF="KeyF",d.KeyG="KeyG",d.KeyH="KeyH",d.KeyI="KeyI",d.KeyJ="KeyJ",d.KeyK="KeyK",d.KeyL="KeyL",d.KeyM="KeyM",d.KeyN="KeyN",d.KeyO="KeyO",d.KeyP="KeyP",d.KeyQ="KeyQ",d.KeyR="KeyR",d.KeyS="KeyS",d.KeyT="KeyT",d.KeyU="KeyU",d.KeyV="KeyV",d.KeyW="KeyW",d.KeyX="KeyX",d.KeyY="KeyY",d.KeyZ="KeyZ",d.Minus="Minus",d.Period="Period",d.Quote="Quote",d.Semicolon="Semicolon",d.Slash="Slash",d.AltLeft="AltLeft",d.AltRight="AltRight",d.Alt="Alt",d.AltGraph="AltGraph",d.Backspace="Backspace",d.CapsLock="CapsLock",d.ContextMenu="ContextMenu",d.ControlLeft="ControlLeft",d.ControlRight="ControlRight",d.Enter="Enter",d.MetaLeft="MetaLeft",d.MetaRight="MetaRight",d.ShiftLeft="ShiftLeft",d.ShiftRight="ShiftRight",d.Space="Space",d.Tab="Tab",d.Convert="Convert",d.KanaMode="KanaMode",d.NonConvert="NonConvert",d.Delete="Delete",d.End="End",d.Help="Help",d.Home="Home",d.Insert="Insert",d.PageDown="PageDown",d.PageUp="PageUp",d.Up="ArrowUp",d.Down="ArrowDown",d.Left="ArrowLeft",d.Right="ArrowRight",d.ArrowUp="ArrowUp",d.ArrowDown="ArrowDown",d.ArrowLeft="ArrowLeft",d.ArrowRight="ArrowRight",d.NumLock="NumLock",d.Numpad0="Numpad0",d.Numpad1="Numpad1",d.Numpad2="Numpad2",d.Numpad3="Numpad3",d.Numpad4="Numpad4",d.Numpad5="Numpad5",d.Numpad6="Numpad6",d.Numpad7="Numpad7",d.Numpad8="Numpad8",d.Numpad9="Numpad9",d.Num0="Numpad0",d.Num1="Numpad1",d.Num2="Numpad2",d.Num3="Numpad3",d.Num4="Numpad4",d.Num5="Numpad5",d.Num6="Numpad6",d.Num7="Numpad7",d.Num8="Numpad8",d.Num9="Numpad9",d.NumAdd="NumpadAdd",d.NumpadAdd="NumpadAdd",d.NumDecimal="NumpadDecimal",d.NumpadDecimal="NumpadDecimal",d.NumDivide="NumpadDivide",d.NumpadDivide="NumpadDivide",d.NumEnter="NumpadEnter",d.NumpadEnter="NumpadEnter",d.NumMultiply="NumpadMultiply",d.NumpadMultiply="NumpadMultiply",d.NumSubtract="NumpadSubtract",d.NumpadSubtract="NumpadSubtract",d.Esc="Escape",d.Escape="Escape",d.F1="F1",d.F2="F2",d.F3="F3",d.F4="F4",d.F5="F5",d.F6="F6",d.F7="F7",d.F8="F8",d.F9="F9",d.F10="F10",d.F11="F11",d.F12="F12",d.F13="F13",d.F14="F14",d.F15="F15",d.F16="F16",d.F17="F17",d.F18="F18",d.F19="F19",d.F20="F20",d.PrintScreen="PrintScreen",d.ScrollLock="ScrollLock",d.Pause="Pause",d.Unidentified="Unidentified"})(Ir||(Ir={}));class mr extends wt{constructor(t,i,n){super(),this.key=t,this.value=i,this.originalEvent=n}}class Y_{constructor(){this.events=new Zt,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=t=>{for(const i of this._keys){const n=new mr(i,t.key,t);this.events.emit("up",n),this.events.emit("release",n)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=t=>{if(!this._enabled)return;!t.metaKey&&(this._keys.includes(Ir.MetaLeft)||this._keys.includes(Ir.MetaRight))&&this._releaseAllKeys(t);const i=t.code;if(this._keys.indexOf(i)===-1){this._keys.push(i),this._keysDown.push(i);const n=new mr(i,t.key,t);this.events.emit("down",n),this.events.emit("press",n)}},this._handleKeyUp=t=>{if(!this._enabled)return;const i=t.code,n=this._keys.indexOf(i);this._keys.splice(n,1),this._keysUp.push(i);const o=new mr(i,t.key,t);this.events.emit("up",o),this.events.emit("release",o),t.key==="Meta"&&this._releaseAllKeys(t)}}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}init(t){let{global:i}=t;const{grabWindowFocus:n}=t;i||(X_()?(i=window,n&&window.focus(),ct.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):i=window.top),i.addEventListener("blur",()=>{this._keys.length=0}),i.addEventListener("keyup",this._handleKeyUp),i.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(t){this._enabled=t}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let t=0;t<this._keys.length;t++)this.events.emit("hold",new mr(this._keys[t]))}getKeys(){return this._keys}wasPressed(t){return this._enabled?this._keysDown.indexOf(t)>-1:!1}isHeld(t){return this._enabled?this._keys.indexOf(t)>-1:!1}wasReleased(t){return this._enabled?this._keysUp.indexOf(t)>-1:!1}triggerEvent(t,i,n){t==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:i,key:n??null})),t==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:i,key:n??null}))}}class Ln{static fromPagePosition(t,i,n){let o,h,c,f;arguments.length===3?(o=t,h=i,c=new k(o,h),f=n):(c=t,o=c.x,h=c.y,f=i);const g=f.screen.pageToScreenCoordinates(c),v=f.screen.screenToWorldCoordinates(g);return new Ln(v,c,g)}constructor(t,i,n){this.worldPos=t,this.pagePos=i,this.screenPos=n}}class vr{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(t,i,n,o,h,c){this.type=t,this.pointerId=i,this.button=n,this.pointerType=o,this.coordinates=h,this.nativeEvent=c,this.active=!0}}class j_{cancel(){this.active=!1}constructor(t,i,n,o,h,c,f,g,v,x,b,T){this.x=t,this.y=i,this.pageX=n,this.pageY=o,this.screenX=h,this.screenY=c,this.index=f,this.deltaX=g,this.deltaY=v,this.deltaZ=x,this.deltaMode=b,this.ev=T,this.active=!0}}class pl{constructor(){this.events=new Zt,this.lastPagePos=k.Zero,this.lastScreenPos=k.Zero,this.lastWorldPos=k.Zero,this._onPointerMove=t=>{this.lastPagePos=new k(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new k(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new k(t.worldPos.x,t.worldPos.y)},this._onPointerDown=t=>{this.lastPagePos=new k(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new k(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new k(t.worldPos.x,t.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_updateWorldPosition(t){const i=Ln.fromPagePosition(this.lastPagePos,t);this.lastScreenPos=i.screenPos,this.lastWorldPos=i.worldPos}}var Fn;(function(d){d.Pixel="Pixel",d.Line="Line",d.Page="Page"})(Fn||(Fn={}));var Is;(function(d){d[d.NoButton=-1]="NoButton",d[d.Left=0]="Left",d[d.Middle=1]="Middle",d[d.Right=2]="Right",d[d.Unknown=3]="Unknown"})(Is||(Is={}));var os;(function(d){d.Left="Left",d.Middle="Middle",d.Right="Right",d.Unknown="Unknown",d.NoButton="NoButton"})(os||(os={}));var as;(function(d){d.Touch="Touch",d.Mouse="Mouse",d.Pen="Pen",d.Unknown="Unknown"})(as||(as={}));function Vm(d){return globalThis.TouchEvent&&d instanceof globalThis.TouchEvent}function qm(d){return globalThis.PointerEvent&&d instanceof globalThis.PointerEvent}class _a{constructor(t,i){this.target=t,this.engine=i,this.events=new Zt,this.primary=new pl,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(t){this._enabled=t}recreate(t,i){const n=new _a(t,i);return n.primary=this.primary,n._pointers=this._pointers,n}at(t){if(t>=this._pointers.length)for(let i=this._pointers.length-1,n=t;i<n;i++)this._pointers.push(new pl);return this._pointers[t]}count(){return this._pointers.length}isDown(t){var i;return this._enabled&&(i=this.currentFramePointerDown.get(t))!==null&&i!==void 0?i:!1}wasDown(t){var i;return this._enabled&&(i=this.lastFramePointerDown.get(t))!==null&&i!==void 0?i:!1}isDragging(t){return this._enabled?this.isDown(t):!1}isDragStart(t){return this._enabled?this.isDown(t)&&!this.wasDown(t):!1}isDragEnd(t){return this._enabled?!this.isDown(t)&&this.wasDown(t):!1}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const t of this.currentFrameDown){if(!t.active)continue;this.emit("down",t),this.at(t.pointerId).emit("down",t),this.primary.emit("pointerdown",t)}for(const t of this.currentFrameUp){if(!t.active)continue;this.emit("up",t),this.at(t.pointerId).emit("up",t)}for(const t of this.currentFrameMove){if(!t.active)continue;this.emit("move",t),this.at(t.pointerId).emit("move",t)}for(const t of this.currentFrameCancel){if(!t.active)continue;this.emit("cancel",t),this.at(t.pointerId).emit("cancel",t)}for(const t of this.currentFrameWheel)t.active&&(this.emit("pointerwheel",t),this.emit("wheel",t),this.primary.emit("pointerwheel",t),this.primary.emit("wheel",t));if(this.engine.currentScene.camera.hasChanged())for(const t of this._pointers)t._updateWorldPosition(this.engine)}clear(){for(const t of this.currentFrameUp){this.currentFramePointerCoords.delete(t.pointerId);const i=this._activeNativePointerIdsToNormalized.entries();for(const[n,o]of i)o===t.pointerId&&this._activeNativePointerIdsToNormalized.delete(n)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(t){var i;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const n={passive:!(this.engine.pageScrollPreventionMode===Ds.All||this.engine.pageScrollPreventionMode===Ds.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,n):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,n):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,n),((i=t?.grabWindowFocus)!==null&&i!==void 0?i:!0)&&X_()){const h=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",h):(this.target.addEventListener("touchstart",h),this.target.addEventListener("mousedown",h))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(t){this._activeNativePointerIdsToNormalized.set(t,-1);const n=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((o,h)=>o-h).findIndex(o=>o===t);return this._activeNativePointerIdsToNormalized.set(t,n),n}_handle(t){if(!this._enabled)return;t.preventDefault();const i=new Map;let n,o;if(Vm(t)){n=os.Unknown,o=as.Touch;for(let h=0;h<t.changedTouches.length;h++){const c=t.changedTouches[h],f=Ln.fromPagePosition(c.pageX,c.pageY,this.engine),g=h+1,v=this._normalizePointerId(g);this.currentFramePointerCoords.set(v,f),i.set(v,f)}}else{n=this._nativeButtonToPointerButton(t.button),o=as.Mouse;const h=Ln.fromPagePosition(t.pageX,t.pageY,this.engine);let c=1;qm(t)&&(c=t.pointerId,o=this._stringToPointerType(t.pointerType));const f=this._normalizePointerId(c);this.currentFramePointerCoords.set(f,h),i.set(f,h)}for(const[h,c]of i.entries())switch(t.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new vr("down",h,n,o,c,t)),this.currentFramePointerDown.set(h,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new vr("up",h,n,o,c,t)),this.currentFramePointerDown.set(h,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new vr("move",h,n,o,c,t));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new vr("cancel",h,n,o,c,t));break}}_handleWheel(t){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Ds.All||this.engine.pageScrollPreventionMode===Ds.Canvas&&t.target===this.engine.canvas)&&t.preventDefault();const i=this.engine.screen.pageToScreenCoordinates(G(t.pageX,t.pageY)),n=this.engine.screen.screenToWorldCoordinates(i),o=-1/40,h=t.deltaX||t.wheelDeltaX*o||0,c=t.deltaY||t.wheelDeltaY*o||t.wheelDelta*o||t.detail||0,f=t.deltaZ||0;let g=Fn.Pixel;t.deltaMode&&(t.deltaMode===1?g=Fn.Line:t.deltaMode===2&&(g=Fn.Page));const v=new j_(n.x,n.y,t.pageX,t.pageY,i.x,i.y,0,h,c,f,g,t);this.currentFrameWheel.push(v)}triggerEvent(t,i){const n=this.engine.screen.worldToPageCoordinates(i);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+t,{pointerId:0,clientX:n.x,clientY:n.y})):this._handle(new window.MouseEvent("mouse"+t,{clientX:n.x,clientY:n.y}));const o=this.engine.currentScene.world.get(da);o.preupdate(this.engine.currentScene,1),o.update(1)}_nativeButtonToPointerButton(t){switch(t){case Is.NoButton:return os.NoButton;case Is.Left:return os.Left;case Is.Middle:return os.Middle;case Is.Right:return os.Right;case Is.Unknown:return os.Unknown;default:return ku(t)}}_stringToPointerType(t){switch(t){case"touch":return as.Touch;case"mouse":return as.Mouse;case"pen":return as.Pen;default:return as.Unknown}}}class gc{constructor(t){this._enabled=!0;const{pointerTarget:i,grabWindowFocus:n,engine:o}=t;this.keyboard=new Y_,this.pointers=new _a(i,o),this.gamepads=new ua,this.keyboard.init({grabWindowFocus:n}),this.pointers.init({grabWindowFocus:n}),this.gamepads.init(),this.inputMapper=new q_({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(t){this._enabled=t,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class Xm{}const Ym={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function Oi(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class ci{get actors(){return this.world.entityManager.entities.filter(t=>t instanceof Ze)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(t=>t instanceof L_)}get tileMaps(){return this.world.entityManager.entities.filter(t=>t instanceof S_)}get timers(){return this._timers}constructor(){this._logger=ct.getInstance(),this.events=new Zt,this.camera=new k_,this.world=new W_(this),this.physics=new V_(us()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(_c),this.world.add(new la(this.world,this.physics)),this.world.add(new ca(this.world,this.physics)),this.world.add(da),this.world.add(fc),this.world.add(pc),this.world.add(lc),this.world.add(cc)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}onPreLoad(t){}onTransition(t){}onInitialize(t){}onActivate(t){}onDeactivate(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreDraw(t,i){}onPostDraw(t,i){}_initializeChildren(){for(const t of this.entities)t._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(t){var i;if(!this.isInitialized){try{this.engine=t,this.physics.config=this.engine.physics,this.input=new gc({pointerTarget:t.pointerScope===an.Canvas?t.canvas:document,grabWindowFocus:t.grabWindowFocus,engine:t}),this.camera._initialize(t),this.world.systemManager.initialize(),await this.onInitialize(t),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,t),this.events.emit("initialize",new Vn(t,this))}catch(n){throw this._logger.error(`Error during scene initialization for scene ${(i=t.director)===null||i===void 0?void 0:i.getSceneName(this)}!`),n}this._isInitialized=!0}}async _activate(t){var i,n;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(t)}catch(o){throw this._logger.error(`Error during scene activation for scene ${(n=(i=this.engine)===null||i===void 0?void 0:i.director)===null||n===void 0?void 0:n.getSceneName(this)}!`),o}}async _deactivate(t){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(t)}_preupdate(t,i){this.emit("preupdate",new ks(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.emit("postupdate",new Ls(t,i,this)),this.onPostUpdate(t,i)}_predraw(t,i){this.emit("predraw",new Nn(t,i,this)),this.onPreDraw(t,i)}_postdraw(t,i){this.emit("postdraw",new Gn(t,i,this)),this.onPostDraw(t,i)}update(t,i){var n;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(n=t.director)===null||n===void 0?void 0:n.getSceneName(this)}!`);return}this._preupdate(t,i);let o,h;for(o=0,h=this._cancelQueue.length;o<h;o++)this.removeTimer(this._cancelQueue[o]);this._cancelQueue.length=0;for(const c of this._timers)c.update(i);this.world.update(ai.Update,i),this.camera&&this.camera.update(t,i),this._collectActorStats(t),this._postupdate(t,i),this.input.update()}draw(t,i){var n;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(t,i),this.world.update(ai.Draw,i),!((n=this.engine)===null||n===void 0)&&n.isDebug&&this.debugDraw(t),this._postdraw(t,i)}debugDraw(t){this.emit("predebugdraw",new Bl(t,this)),this.emit("postdebugdraw",new kl(t,this))}contains(t){return this.actors.indexOf(t)>-1}add(t){if(this.emit("entityadded",{target:t}),t instanceof nn){Bu(this._timers,t)||this.addTimer(t);return}this.world.add(t),t.scene=this}transfer(t){let i;t instanceof We&&t.scene&&t.scene!==this&&(i=t.scene,t.scene.world.remove(t,!1)),t instanceof nn&&t.scene&&(i=t.scene,t.scene.removeTimer(t)),i?.emit("entityremoved",{target:t}),this.add(t)}remove(t){this.emit("entityremoved",{target:t}),t instanceof We&&(t.isActive&&t.kill(),this.world.remove(t)),t instanceof nn&&this.removeTimer(t)}clear(t=!0){for(let i=this.entities.length-1;i>=0;i--)this.world.remove(this.entities[i],t);for(let i=this.timers.length-1;i>=0;i--)this.removeTimer(this.timers[i])}addTimer(t){return this._timers.push(t),t.scene=this,t}removeTimer(t){const i=this._timers.indexOf(t);return i!==-1&&this._timers.splice(i,1),t}cancelTimer(t){return this._cancelQueue.push(t),t}isTimerActive(t){return this._timers.indexOf(t)>-1&&!t.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(t){const i=this.actors;for(let n=0;n<i.length;n++){const o=i[n];o instanceof ac&&t.stats.currFrame.actors.ui++,t.stats.currFrame.actors.alive++;for(let h=0;h<o.children.length;h++){const c=o.children[h];P_(c)?t.stats.currFrame.actors.ui++:t.stats.currFrame.actors.alive++}}}}var rn;(function(d){d.Protanope="Protanope",d.Deuteranope="Deuteranope",d.Tritanope="Tritanope"})(rn||(rn={}));const jm=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class Z_{constructor(t,i){this._shader=new ei({gl:t,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:i}),this._shader.compile(),this._buffer=new Xi({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new ms({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class $_{constructor(t,i=!1){this._colorBlindnessMode=t,this._simulate=!1,this._simulate=i}initialize(t){this._shader=new Z_(t,jm),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(t){if(this._colorBlindnessMode=t,this._shader){const i=this._shader.getShader();i.use(),this._colorBlindnessMode===rn.Protanope?i.setUniformInt("u_type",0):this._colorBlindnessMode===rn.Deuteranope?i.setUniformInt("u_type",1):this._colorBlindnessMode===rn.Tritanope&&i.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(t){if(this._simulate=t,this._shader){const i=this._shader.getShader();i.use(),i.setUniformBoolean("u_simulate",t)}}get simulate(){return this._simulate}}class Q_{constructor(t){this._engine=t,this._colorBlindPostProcessor=new $_(rn.Protanope)}correct(t){this._engine.graphicsContext instanceof ds&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(t){this._engine.graphicsContext instanceof ds&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class K_{constructor(t){this.stats={currFrame:new Rr,prevFrame:new Rr},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:K.Yellow,showZIndex:!1,showScale:!1,scaleColor:K.Green,showRotation:!1,rotationColor:K.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:K.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:K.Blue,showOwner:!1,showGeometry:!0,geometryColor:K.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:K.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:K.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:K.Yellow,showAcceleration:!1,accelerationColor:K.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:K.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:K.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:K.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:K.Yellow,positionSize:1,showGrid:!1,gridColor:K.Red,gridWidth:1,showColliderGeometry:!0},this._engine=t,this.colorBlindMode=new Q_(this._engine)}useTestClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const n=t.toTestClock();return i&&n.start(),this._engine.clock=n,n}useStandardClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const n=t.toStandardClock();return i&&n.start(),this._engine.clock=n,n}}class Rr{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new fa,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(t){t?(this.id=t.id,this.elapsedMs=t.elapsedMs,this.fps=t.fps,this.actors.alive=t.actors.alive,this.actors.killed=t.actors.killed,this.actors.ui=t.actors.ui,this.duration.update=t.duration.update,this.duration.draw=t.duration.draw,this._physicsStats.reset(t.physics),this.graphics.drawCalls=t.graphics.drawCalls,this.graphics.drawnImages=t.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const t=new Rr;return t.reset(this),t}get id(){return this._id}set id(t){this._id=t}get elapsedMs(){return this._elapsedMs}set elapsedMs(t){this._elapsedMs=t}get fps(){return this._fps}set fps(t){this._fps=t}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class fa{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(t){t?(this.pairs=t.pairs,this.collisions=t.collisions,this.contacts=t.contacts,this.fastBodies=t.fastBodies,this.fastBodyCollisions=t.fastBodyCollisions,this.broadphase=t.broadphase,this.narrowphase=t.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const t=new fa;return t.reset(this),t}get pairs(){return this._pairs}set pairs(t){this._pairs=t}get collisions(){return this._collisions}set collisions(t){this._collisions=t}get contacts(){return this._contacts}set contacts(t){this._contacts=t}get fastBodies(){return this._fastBodies}set fastBodies(t){this._fastBodies=t}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(t){this._fastBodyCollisions=t}get broadphase(){return this._broadphase}set broadphase(t){this._broadphase=t}get narrowphase(){return this._narrowphase}set narrowphase(t){this._narrowphase=t}}class gl{on(t,i){this._nativeHandlers[t]&&this.off(t,this._nativeHandlers[t]),this._nativeHandlers[t]=this._decorate(i),this.nativeComponent.addEventListener(t,this._nativeHandlers[t])}off(t,i){i||(i=this._nativeHandlers[t]),this.nativeComponent.removeEventListener(t,i),this._nativeHandlers[t]=null}_decorate(t){return i=>{this._paused||t(i)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const t in this._nativeHandlers)this.off(t)}constructor(t){this.nativeComponent=t,this._paused=!1,this._nativeHandlers={}}}class J_{constructor(t,i){this._windowGlobal=t,this._documentGlobal=i,this._windowComponent=new gl(this._windowGlobal),this._documentComponent=new gl(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const tf={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:pe.Blended,canvasImageRendering:"auto"},ef={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:pe.Blended,canvasImageRendering:"auto"};class sf{constructor(t){var i;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=t.initialFps,this._samplePeriod=(i=t.samplePeriod)!==null&&i!==void 0?i:this._samplePeriod,this._currentFrameTime=1e3/t.initialFps,this._nowFn=t.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const t=this._nowFn();this._currentFrameTime=t-this._beginFrameTime,t>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(t-this._previousSampleTime),this._previousSampleTime=t,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class mc{constructor(t){var i,n,o;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=t,this.tick=t.tick,this._lastTime=(i=this.now())!==null&&i!==void 0?i:0,this._maxFps=(n=t.maxFps)!==null&&n!==void 0?n:this._maxFps,this._onFatalException=(o=t.onFatalException)!==null&&o!==void 0?o:this._onFatalException,this.fpsSampler=new sf({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new nf({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new vc({...this._options})}setFatalExceptionHandler(t){this._onFatalException=t}schedule(t,i=0,n="preframe"){const o=this._totalElapsed+i;this._scheduledCbs.push([t,o,n])}__runScheduledCbs(t="preframe"){for(let i=this._scheduledCbs.length-1;i>-1;i--)t===this._scheduledCbs[i][2]&&this._scheduledCbs[i][1]<=this._totalElapsed&&(this._scheduledCbs[i][0](this._elapsed),this._scheduledCbs.splice(i,1))}update(t){try{this.fpsSampler.start();const i=this.now();let n=i-this._lastTime||1;const o=1e3/this._maxFps;if(n>=o){let h=0;o!==0&&(h=n%o,n=n-h),n>200&&(n=1),this._elapsed=t||n,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(t||n),this.__runScheduledCbs("postframe"),o!==0?this._lastTime=i-h:this._lastTime=i,this.fpsSampler.end()}}catch(i){this._onFatalException(i),this.stop()}}}class vc extends mc{constructor(t){super(t),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const t=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(t),this.update()}catch(i){throw window.cancelAnimationFrame(this._requestId),i}};t()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class nf extends mc{constructor(t){super({...t}),this._logger=ct.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=t.defaultUpdateMs}now(){var t;return(t=this._currentTime)!==null&&t!==void 0?t:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(t){const i=t??this._updateMs;this._running?(this.update(i),this._currentTime+=i):this._logger.warn("The clock is not running, no step will be performed")}run(t,i){for(let n=0;n<t;n++)this.step(i??this._updateMs)}}var Zm=Te(296);class rf{constructor(){this._toasterCss=Zm.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(t){const i=document.createElement("span");return i.innerText=t,i}toast(t,i,n){this._initialize();const o=document.createElement("div");o.className="ex-toast-message";const h=t.split("[LINK]").map(x=>this._createFragment(x));if(i){const x=document.createElement("a");x.href=i,n?x.innerText=n:x.innerText=i,h.splice(1,0,x)}const c=document.createElement("div");h.forEach(x=>{c.appendChild(x)}),o.appendChild(c);const f=document.createElement("button");f.innerText="x",f.addEventListener("click",()=>{this._container.removeChild(o)}),o.appendChild(f);const g=x=>{if(x.key==="Escape")try{this._container.removeChild(o)}catch{}document.removeEventListener("keydown",g)};document.addEventListener("keydown",g);const v=this._container.firstChild;this._container.insertBefore(o,v)}}const $m={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class of{get isTransitioning(){return this._isTransitioning}constructor(t,i){this._engine=t,this.events=new Zt,this._logger=ct.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new ci,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const n in i){const o=i[n];this.add(n,o),n==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const t=this._deferredGoto;this._deferredGoto=void 0;const i=this._deferredTransition;this._deferredTransition=void 0;const n=this.getSceneInstance(t);n&&i&&i._addToTargetScene(this._engine,n),await this.swapScene(t),n&&i&&await this.playTransition(i,n)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(t,i){const n=i?.loader;n instanceof Ar?this.mainLoader=n:rl(n)?this.mainLoader=new n:this.mainLoader=new dn;let o;if(i?.inTransition){const{inTransition:h}=i;o=h}if(this.startScene=t,o){const h=this.getSceneInstance(this.startScene);h&&(o._addToTargetScene(this._engine,h),this.swapScene(this.startScene).then(()=>this.playTransition(o,h)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(t){return this._sceneToLoader.get(t)}_getInTransition(t){var i;const n=this.scenes[t];if(!(n instanceof ci||Oi(n)))return(i=n?.transitions)===null||i===void 0?void 0:i.in}_getOutTransition(t){var i;const n=this.scenes[t];if(!(n instanceof ci||Oi(n)))return(i=n?.transitions)===null||i===void 0?void 0:i.out}getDeferredScene(){const t=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&t?t:null}getSceneDefinition(t){const i=this.scenes[t];if(i instanceof ci||Oi(i))return i;if(i)return i.scene}getSceneName(t){for(const[i,n]of Object.entries(this.scenes))if(n instanceof ci){if(t===n)return i}else if(!Oi(n)&&t===n.scene)return i;for(const[i,n]of Object.entries(this.scenes))if(Oi(n)){if(t.constructor===n)return i}else if(!(n instanceof ci)&&t.constructor===n.scene)return i;return null}assertAdded(t){return this}assertRemoved(t){return this}add(t,i){if(!(i instanceof ci)&&!Oi(i)){const{loader:n,transitions:o}=i,{in:h,out:c}=o??{};this._sceneToTransition.set(t,{in:h,out:c}),rl(n)?this._sceneToLoader.set(t,new n):n&&this._sceneToLoader.set(t,n)}return this.scenes[t]&&this._logger.warn("Scene",t,"already exists overwriting"),this.scenes[t]=i,this.assertAdded(t)}remove(t){if(t instanceof ci||Oi(t)){const i=t;for(const n in this.scenes)if(this.scenes.hasOwnProperty(n)){const o=this.scenes[n];let h;if(o instanceof ci||Oi(o)?h=o:h=o.scene,h===i){if(n===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${n}`);this._sceneToInstance.delete(n),this._sceneToTransition.delete(n),this._sceneToLoader.delete(n),delete this.scenes[n]}}}if(typeof t=="string"){if(t===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${t}`);this._sceneToInstance.delete(t),this._sceneToTransition.delete(t),this._sceneToLoader.delete(t),delete this.scenes[t]}}async goToScene(t,i){var n,o,h,c,f,g;const v=this.getSceneInstance(t);if(!v){this._logger.warn(`Scene ${t} does not exist! Check the name, are you sure you added it?`);return}const x=this.currentScene,b=this.currentSceneName,T=(o=(n=this._engine.input)===null||n===void 0?void 0:n.enabled)!==null&&o!==void 0?o:!0;this._isTransitioning=!0;const P=(h=this.getSceneInstance(b))===null||h===void 0?void 0:h.onTransition("out"),I=v?.onTransition("in");i={sourceOut:(c=this._getOutTransition(this.currentSceneName))!==null&&c!==void 0?c:P,destinationIn:(f=this._getInTransition(t))!==null&&f!==void 0?f:I,...i};const{sourceOut:F,destinationIn:R,sceneActivationData:S}=i,M=F??this._getOutTransition(this.currentSceneName),W=R??this._getInTransition(t),U=M?.hideLoader||W?.hideLoader;U&&this.maybeLoadScene(t,U),this._emitEvent("navigationstart",b,t),M&&await this.playTransition(M,x),await this.maybeLoadScene(t,U),W&&await W.onPreviousSceneDeactivate(this.currentScene),W&&W._addToTargetScene(this._engine,v),await this.swapScene(t,S),this._emitEvent("navigation",b,t),W&&await this.playTransition(W,v),this._emitEvent("navigationend",b,t),(g=this._engine.input)===null||g===void 0||g.toggleEnabled(T),this._isTransitioning=!1}getSceneInstance(t){const i=this.getSceneDefinition(t);if(!i)return;if(this._sceneToInstance.has(t))return this._sceneToInstance.get(t);if(i instanceof ci)return this._sceneToInstance.set(t,i),i;const n=new i;return this._sceneToInstance.set(t,n),n}async maybeLoadScene(t,i=!1){var n;const o=(n=this._getLoader(t))!==null&&n!==void 0?n:new Ar,h=this.getSceneDefinition(t),c=this.getSceneInstance(t);h&&c&&!this._loadedScenes.has(c)&&(c.onPreLoad(o),c.events.emit("preload",{loader:o}),i?this._engine.load(o,i):await this._engine.load(o),this._loadedScenes.add(c))}async playTransition(t,i){var n,o,h,c,f,g,v;if(!this.isInitialized){this._deferredTransition=t;return}if(t){this.currentTransition=t;const x=(o=(n=i.input)===null||n===void 0?void 0:n.enabled)!==null&&o!==void 0?o:!0;(h=i.input)===null||h===void 0||h.toggleEnabled(!t.blockInput),(c=this._engine.input)===null||c===void 0||c.toggleEnabled(!t.blockInput),this.currentTransition._addToTargetScene(this._engine,i),await this.currentTransition._play(),(f=i.input)===null||f===void 0||f.toggleEnabled(x)}(g=this.currentTransition)===null||g===void 0||g.kill(),(v=this.currentTransition)===null||v===void 0||v.reset(),this.currentTransition=void 0}async swapScene(t,i){const n=this._engine;if(!this.isInitialized){this._deferredGoto=t;return}const o=this.getSceneInstance(t);if(o){const h=this.currentScene,c=o;if(this._logger.debug("Going to scene:",t),this.currentScene.isInitialized){const v={engine:n,previousScene:h,nextScene:c};await this.currentScene._deactivate(v),this.currentScene.events.emit("deactivate",new ql(v,this.currentScene)),this.currentScene.input.clear()}const f=this._sceneToLoader.get(t);await f?.areResourcesLoaded(),this.currentScene=c,this.currentSceneName=t,n.screen.setCurrentCamera(c.camera),await this.currentScene._initialize(n);const g={engine:n,previousScene:h,nextScene:c,data:i};await this.currentScene._activate(g),this.currentScene.events.emit("activate",new Vl(g,this.currentScene))}else this._logger.error("Scene",t,"does not exist!")}_emitEvent(t,i,n){const o=this.getSceneDefinition(i),h=this.getSceneDefinition(n);this.events.emit(t,{sourceScene:o,sourceName:i,destinationScene:h,destinationName:n})}}function af(){const d={scope:(t,i)=>{const n=d.value;d.value=t;try{return i()}catch(o){throw o}finally{d.value=n}},value:void 0};return d}function hf(d){return d.value}const ml={textureCollectInterval:6e4};class lf{constructor(t){this.options=t,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=i=>{if(this._running){for(const[n,[o,h]]of this._collectors.entries()){const c=this.options.getTimestamp();for(const[f,[g,v]]of this._collectionMap.entries()){if(n!==g||v+h>=c)continue;o(f)&&this._collectionMap.delete(f)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(t,i,n){this._collectors.set(t,[n,i])}addCollectableResource(t,i){this._collectionMap.set(i,[t,this.options.getTimestamp()])}touch(t){const i=this._collectionMap.get(t);i&&this._collectionMap.set(t,[i[0],this.options.getTimestamp()])}forceCollectAll(){for(const[t,[i]]of this._collectors.entries())for(const[n]of this._collectionMap.entries())i(n)&&this._collectionMap.delete(n)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}Ru();const Qm={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Ds;(function(d){d[d.None=0]="None",d[d.Canvas=1]="Canvas",d[d.All=2]="All"})(Ds||(Ds={}));class Je{static useEngine(){const t=hf(Je.Context);if(!t)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return t}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(t){this.graphicsContext.snapToPixel=t}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,n,o,h,c,f,g,v,x;this.scope=U=>Je.Context.scope(this,U),this.version=vl,this.events=new Zt,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=U=>{ct.getInstance().fatal(U,U.stack)},this._toaster=new rf,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=U=>{var V;U.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",U);const j=document.createElement("div");j.id="ex-webgl-graphics-context-lost",j.style.position="absolute",j.style.zIndex="99",j.style.left="50%",j.style.top="50%",j.style.display="flex",j.style.flexDirection="column",j.style.transform="translate(-50%, -50%)",j.style.backgroundColor="white",j.style.padding="10px",j.style.borderStyle="solid 1px";const q=document.createElement("div");if(q.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,j.appendChild(q),!((V=this.canvas)===null||V===void 0)&&V.parentElement){this.canvas.parentElement.appendChild(j);const nt=q.querySelector("#ex-webgl-graphics-reload");nt?.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new di,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],t={...Je._DEFAULT_ENGINE_OPTIONS,...t},this._originalOptions=t,Ie.freeze(),this.browser=new J_(window,document);const b=new Zu;if(!t.suppressMinimumBrowserFeatureDetection&&!(this._compatible=b.test())){const U=document.createElement("div");if(U.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(U),b.failedTests.forEach(function(V){const j=document.createElement("div");j.innerText="Browser feature missing "+V,document.body.appendChild(j)}),t.canvasElementId){const V=document.getElementById(t.canvasElementId);V&&V.parentElement.removeChild(V)}return}else this._compatible=!0;if(console.log&&!t.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${vl})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),t.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=ct.getInstance(),this._logger.defaultLevel===ge.Debug&&b.logBrowserFeatures(),this._logger.debug("Building engine..."),t.garbageCollection===!0?this.garbageCollectorConfig={...ml}:t.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...ml,...t.garbageCollection},this._garbageCollector=new lf({getTimestamp:Date.now}),this.canvasElementId=t.canvasElementId,t.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+t.canvasElementId),document.getElementById(t.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(t.canvasElementId)}else t.canvasElement?(this._logger.debug("Using Canvas element specified:",t.canvasElement),this.canvas=t.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!t.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",U=>{U.preventDefault()});let T=(i=t.displayMode)!==null&&i!==void 0?i:ye.Fixed;t.width&&t.height||t.viewport?(t.displayMode===void 0&&(T=ye.Fixed),this._logger.debug("Engine viewport is size "+t.width+" x "+t.height)):t.displayMode||(this._logger.debug("Engine viewport is fit"),T=ye.FitScreen),this.grabWindowFocus=t.grabWindowFocus,this.pointerScope=t.pointerScope,this._originalDisplayMode=T;let P,I,F,R,S,M;typeof t.antialiasing=="object"?{pixelArtSampler:P,nativeContextAntialiasing:F,multiSampleAntialiasing:M,filtering:S,canvasImageRendering:R}={...t.pixelArt?ef:tf,...t.antialiasing}:(P=!!t.pixelArt,F=!1,M=t.antialiasing,R=t.antialiasing?"auto":"pixelated",S=t.antialiasing?pe.Blended:pe.Pixel),F&&M&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),t.pixelArt&&(I=.25),(!t.antialiasing||S===pe.Pixel)&&(I=0),I=(o=(n=t.uvPadding)!==null&&n!==void 0?n:I)!==null&&o!==void 0?o:.01;let W=Ie.isEnabled("use-canvas-context");if(!W)try{this.graphicsContext=new ds({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:P,antialiasing:F,multiSampleAntialiasing:M,uvPadding:I,powerPreference:t.powerPreference,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(h=t.handleContextLost)!==null&&h!==void 0?h:this._handleWebGLContextLost,handleContextRestored:t.handleContextRestored})}catch(U){this._logger.warn(`Excalibur could not load webgl for some reason (${U.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),W=!0}W&&(this.graphicsContext=new Zo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:F,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting})),this.screen=new nl({canvas:this.canvas,context:this.graphicsContext,antialiasing:F,canvasImageRendering:R,browser:this.browser,viewport:(c=t.viewport)!==null&&c!==void 0?c:t.width&&t.height?{width:t.width,height:t.height}:sl.SVGA,resolution:t.resolution,displayMode:T,pixelRatio:t.suppressHiDPIScaling?1:(f=t.pixelRatio)!==null&&f!==void 0?f:null}),te.filtering=S,t.backgroundColor&&(this.backgroundColor=t.backgroundColor.clone()),this.maxFps=(g=t.maxFps)!==null&&g!==void 0?g:this.maxFps,this.fixedUpdateTimestep=(v=t.fixedUpdateTimestep)!==null&&v!==void 0?v:this.fixedUpdateTimestep,this.fixedUpdateFps=(x=t.fixedUpdateFps)!==null&&x!==void 0?x:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new vc({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:U=>this.onFatalException(U)}),this.enableCanvasTransparency=t.enableCanvasTransparency,typeof t.physics=="boolean"?this.physics={...us(),enabled:t.physics}:(this.physics={...us()},zo(this.physics,t.physics)),this.debug=new K_(this),this.director=new of(this,t.scenes),this._initialize(t),window.___EXCALIBUR_DEVTOOL=this,Je.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:t}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:i,showPlayerMessage:n}=this._originalOptions.configurePerformanceCanvas2DFallback;if(i===void 0&&(i=Je._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),n===void 0&&(n=Je._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!Ie.isEnabled("use-canvas-context")&&t&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===i.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let o=0;for(let c=0;c<this._fpsSamples.length;c++)o+=this._fpsSamples[c];const h=o/this._fpsSamples.length;this._fpsSamples.length===i.numberOfFrames&&h<=i.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),n&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var t,i,n;const o=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(o,this.canvas),this.canvas=o;const h={...this._originalOptions,antialiasing:this.screen.antialiasing},c=this._originalDisplayMode;this.graphicsContext=new Zo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:h.antialiasing,backgroundColor:h.backgroundColor,snapToPixel:h.snapToPixel,useDrawSorting:h.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new nl({canvas:this.canvas,context:this.graphicsContext,antialiasing:(t=h.antialiasing)!==null&&t!==void 0?t:!0,browser:this.browser,viewport:(i=h.viewport)!==null&&i!==void 0?i:h.width&&h.height?{width:h.width,height:h.height}:sl.SVGA,resolution:h.resolution,displayMode:c,pixelRatio:h.suppressHiDPIScaling?1:(n=h.pixelRatio)!==null&&n!==void 0?n:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const f=h&&h.pointerScope===an.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(f,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,Je.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(t){if(t<0){ct.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=t}addTimer(t){return this.currentScene.addTimer(t)}removeTimer(t){return this.currentScene.removeTimer(t)}addScene(t,i){return this.director.add(t,i),this}removeScene(t){this.director.remove(t)}add(t){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const i=this.director.getDeferredScene();i instanceof ci?i.add(t):this.currentScene.add(t)}remove(t){t instanceof We&&this.currentScene.remove(t),(t instanceof ci||Oi(t))&&this.removeScene(t),typeof t=="string"&&this.removeScene(t)}async goToScene(t,i){await this.scope(async()=>{await this.director.goToScene(t,i)})}screenToWorldCoordinates(t){return this.screen.screenToWorldCoordinates(t)}worldToScreenCoordinates(t){return this.screen.worldToScreenCoordinates(t)}_initialize(t){var i,n;this.pageScrollPreventionMode=t.scrollPreventionMode;const o=t&&t.pointerScope===an.Document?document:this.canvas,h=(n=(i=this._originalOptions)===null||i===void 0?void 0:i.grabWindowFocus)!==null&&n!==void 0?n:!0;this.input=new gc({pointerTarget:o,grabWindowFocus:h,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new Gl(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new Nl(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!t.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(t){this._inputEnabled=t,this.input.toggleEnabled(this._inputEnabled)}onInitialize(t){}get isInitialized(){return this._isInitialized}async _overrideInitialize(t){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(t),this.events.emit("initialize",new Vn(t,this)),this._isInitialized=!0)}_update(t){var i;if(this._isLoading){(i=this._loader)===null||i===void 0||i.onUpdate(this,t),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(t),this.currentScene.update(this,t),this.graphicsContext.updatePostProcessors(t),this.clock.__runScheduledCbs("postupdate"),this._postupdate(t),this.input.update()}_preupdate(t){this.emit("preupdate",new ks(this,t,this)),this.onPreUpdate(this,t)}onPreUpdate(t,i){}_postupdate(t){this.emit("postupdate",new Ls(this,t,this)),this.onPostUpdate(this,t)}onPostUpdate(t,i){}_draw(t){var i,n;if(this.graphicsContext.backgroundColor=(i=this.currentScene.backgroundColor)!==null&&i!==void 0?i:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,t),this._isLoading){this._hideLoader||((n=this._loader)===null||n===void 0||n.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,t),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,t),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(t,i){this.emit("predraw",new Nn(t,i,this)),this.onPreDraw(t,i)}onPreDraw(t,i){}_postdraw(t,i){this.emit("postdraw",new Gn(t,i,this)),this.onPostDraw(t,i)}onPostDraw(t,i){}showDebug(t){this._isDebug=t}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(t,i){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let n;return t instanceof Ar?n=t:typeof t=="string"&&(this.director.configureStart(t,i),n=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(n??new dn),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new Rl(this)),this._isReadyFuture.promise})}_mainloop(t){this.scope(()=>{this.emit("preframe",new Ll(this,this.stats.prevFrame));const i=t*this.timescale;this.currentFrameElapsedMs=i;const n=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=n,this.stats.currFrame.elapsedMs=i,this.stats.currFrame.fps=this.clock.fpsSampler.fps,jt.clear();const o=this.clock.now(),h=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=i;this._lagMs>=h;)this._update(h),this._lagMs-=h;else this._update(i);const c=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(i);const f=this.clock.now();this.stats.currFrame.duration.update=c-o,this.stats.currFrame.duration.draw=f-c,this.stats.currFrame.graphics.drawnImages=jt.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=jt.DrawCallCount,this.emit("postframe",new Ul(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new Dl(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(t=!1){return new Promise(n=>{this._screenShotRequests.push({preserveHiDPIResolution:t,resolve:n})})}_checkForScreenShots(){for(const t of this._screenShotRequests){const i=t.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,n=t.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,o=document.createElement("canvas");o.width=i,o.height=n;const h=o.getContext("2d");h.imageSmoothingEnabled=this.screen.antialiasing,h.drawImage(this.canvas,0,0,i,n);const c=new Image,f=o.toDataURL("image/png");c.onload=()=>{t.resolve(c)},c.src=f}this._screenShotRequests.length=0}async load(t,i=!1){await this.scope(async()=>{try{if(t.isLoaded())return;this._loader=t,this._isLoading=!0,this._hideLoader=i,t instanceof dn&&(t.suppressPlayButton=t.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await t.load()}catch(n){this._logger.error("Error loading resources, things may not behave properly",n),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}Je.Context=af();Je.InstanceCount=0;Je._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:an.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Ds.Canvas,backgroundColor:K.fromHex("#2185d0")};class Km extends Ze{set maxWidth(t){this._text.maxWidth=t}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(t){this._font=t,this._text.font=t}get text(){return this._text.text}set text(t){this._text.text=t}get color(){return this._text.color}set color(t){this._text&&(this._text.color=t)}get opacity(){return this.graphics.opacity}set opacity(t){this.graphics.opacity=t}get spriteFont(){return this._spriteFont}set spriteFont(t){t&&(this._spriteFont=t,this._text.font=this._spriteFont)}constructor(t){super(t),this._font=new hn,this._text=new Ur({text:"",font:this._font});const{text:i,pos:n,x:o,y:h,spriteFont:c,font:f,color:g,maxWidth:v}={text:"",...t};this.pos=n??(o&&h?G(o,h):this.pos),this.text=i??this.text,this.font=f??this.font,this.maxWidth=v??this.maxWidth,this.spriteFont=c??this.spriteFont,this._text.color=g??this.color;const x=this.get(se);x.anchor=k.Zero,x.use(this._text)}_initialize(t){super._initialize(t)}getTextWidth(){return this._text.width}}var Ms;(function(d){d.Circle="circle",d.Rectangle="rectangle"})(Ms||(Ms={}));class Jm extends Ze{constructor(t){var i,n;super({width:(i=t.width)!==null&&i!==void 0?i:0,height:(n=t.height)!==null&&n!==void 0?n:0}),this._particlesToEmit=0,this._particlePool=new Fr(()=>new sa({}),I=>I,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=Ms.Rectangle,this.radius=0,this.particle={life:2e3,transform:Ri.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:o,x:h,y:c,z:f,pos:g,isEmitting:v,emitRate:x,emitterType:b,radius:T,random:P}={...t};this.particle={...this.particle,...o},this.pos=g??G(h??0,c??0),this.z=f??0,this.isEmitting=v??this.isEmitting,this.emitRate=x??this.emitRate,this.emitterType=b??this.emitterType,this.radius=T??this.radius,this.body.collisionType=ut.PreventCollision,this.random=P??new zn}removeParticle(t){this.deadParticles.push(t)}emitParticles(t){var i;if(!(t<=0)){t=t|0;for(let n=0;n<t;n++){const o=this._createParticle();!((i=this===null||this===void 0?void 0:this.scene)===null||i===void 0)&&i.world&&(this.particle.transform===Ri.Global?this.scene.world.add(o):this.addChild(o)),this._activeParticles.push(o)}}}clearParticles(){for(let t=0;t<this._activeParticles.length;t++)this.removeParticle(this._activeParticles[t])}_createParticle(){let t=0,i=0;const n=Wi(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),o=Wi(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),h=this.particle.startSize||Wi(this.particle.minSize||5,this.particle.maxSize||5,this.random),c=o*Math.cos(n),f=o*Math.sin(n);if(this.emitterType===Ms.Rectangle)t=Wi(0,this.width,this.random),i=Wi(0,this.height,this.random);else if(this.emitterType===Ms.Circle){const v=Wi(0,this.radius,this.random);t=v*Math.cos(n),i=v*Math.sin(n)}const g=this._particlePool.rent();return g.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:G(t,i),vel:G(c,f),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:h,graphic:this.particle.graphic,fade:this.particle.fade}),g.registerEmitter(this),this.particle.randomRotation&&(g.transform.rotation=Wi(0,Math.PI*2,this.random)),this.particle.focus&&(g.focus=this.particle.focus.add(G(this.pos.x,this.pos.y)),g.focusAccel=this.particle.focusAccel),g}update(t,i){var n;super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let o=0;o<this.deadParticles.length;o++){!((n=this===null||this===void 0?void 0:this.scene)===null||n===void 0)&&n.world&&(this.scene.world.remove(this.deadParticles[o],!1),this._particlePool.return(this.deadParticles[o]));const h=this._activeParticles.indexOf(this.deadParticles[o]);h>-1&&this._activeParticles.splice(h,1)}this.deadParticles.length=0}}function tv(d,t){}class Ko{constructor(t,i,n){var o;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=t,this.particle=n,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=i,this._particleLife=(o=this.particle.life)!==null&&o!==void 0?o:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(t,i){if(this._initialized)return;const n=this.emitter.maxParticles,o=this._numInputFloats,h=this._particleData,c=4,f=t.createBuffer(),g=t.createVertexArray();t.bindVertexArray(g),t.bindBuffer(t.ARRAY_BUFFER,f),t.bufferData(t.ARRAY_BUFFER,n*o*c,t.DYNAMIC_DRAW),t.bufferSubData(t.ARRAY_BUFFER,0,h);let v=0;t.vertexAttribPointer(0,2,t.FLOAT,!1,o*c,0),v+=c*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*c,v),v+=c*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*c,v),v+=c*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(g),this._buffers.push(f),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null);const x=t.createBuffer(),b=t.createVertexArray();t.bindVertexArray(b),t.bindBuffer(t.ARRAY_BUFFER,x),t.bufferData(t.ARRAY_BUFFER,n*o*c,t.DYNAMIC_DRAW),v=0,t.vertexAttribPointer(0,2,t.FLOAT,!1,o*c,0),v+=c*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*c,v),v+=c*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*c,v),v+=c*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(b),this._buffers.push(x),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(t){const i=this._particleIndex,n=this.maxParticles*this._numInputFloats,o=t*this._numInputFloats+i;for(let h=i;h<o;h+=this._numInputFloats){const c=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||me),f=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),g=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),v=f*Math.cos(c),x=g*Math.sin(c);let b=0,T=0;if(this.emitter.emitterType===Ms.Rectangle)b=this._random.floating(-.5,.5)*this.emitter.width,T=this._random.floating(-.5,.5)*this.emitter.height;else{const F=this._random.floating(0,this.emitter.radius);b=F*Math.cos(c),T=F*Math.sin(c)}const P=this.emitter.transform.apply(G(b,T)),I=[this.particle.transform===Ri.Local?b:P.x,this.particle.transform===Ri.Local?T:P.y,v,x,this.particle.randomRotation?Wi(0,me,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(I,h%this._particleData.length)}o>=n?(this._wrappedParticles+=(o-n)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=t),this._particleIndex=o%n,this._emitted.push([this._particleLife,i])}_uploadEmitted(t){this._particleIndex!==this._uploadIndex&&(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),t.bindBuffer(t.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(t){var i;if(this._particleLife=(i=this.particle.life)!==null&&i!==void 0?i:this._particleLife,this._wrappedLife>0?this._wrappedLife-=t:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let n=this._emitted.length-1;n>=0;n--){const o=this._emitted[n];o[0]-=t,o[0]<=0&&this._emitted.splice(n,1)}this._emitted.sort((n,o)=>n[0]-o[0])}}draw(t){if(this._initialized){if(this._clearRequested?(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData),t.bindBuffer(t.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(t),t.bindVertexArray(this._currentVao),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const i=this._emitted[0][1]/this._numInputFloats;t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-i)*this._numInputFloats*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,i,this.maxParticles-i),t.endTransformFeedback(),t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,i),t.endTransformFeedback()}else t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,this.maxParticles),t.endTransformFeedback();t.bindVertexArray(null),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}Ko.GPU_MAX_PARTICLES=1e5;class ev extends Ze{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get z(){return this.transform.z}set z(t){this.transform.z=t}constructor(t){super({name:"GpuParticleEmitter",width:t.width,height:t.height}),this.particle={life:2e3,transform:Ri.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new se,this.isEmitting=!1,this.emitRate=1,this.emitterType=Ms.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:i,maxParticles:n,x:o,y:h,z:c,pos:f,isEmitting:g,emitRate:v,emitterType:x,radius:b,random:T}={...t};this.maxParticles=bt(n??this.maxParticles,0,Ko.GPU_MAX_PARTICLES),this.pos=f??G(o??0,h??0),this.z=c??0,this.isEmitting=g??this.isEmitting,this.emitRate=v??this.emitRate,this.emitterType=x??this.emitterType,this.radius=b??this.radius,this.particle={...this.particle,...i},this.random=T??new zn,this.renderer=new Ko(this,this.random,this.particle)}_initialize(t){super._initialize(t);const i=t.graphicsContext;this.renderer.initialize(i.__gl,i)}update(t,i){super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(i)}emitParticles(t){t<=0||this.renderer.emitParticles(t|0)}clearParticles(){this.renderer.clearParticles()}draw(t,i){t.draw("ex.particle",this.renderer,i)}}class cf extends We{getGraphics(){return this._graphics}addGraphic(t,i){this._graphics.push(t),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,i?.offset&&(this._gfx.offset=i.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let t=this._tileBounds.clone();for(const i of this._graphics){const n=G(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:i.height-this.map.tileHeight));t=t.combine(i.localBounds.translate(n))}return t}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&this._graphics.splice(i,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(G(this.x,this.y))}get center(){return this.pos.add(G(0,this.map.tileHeight/2))}constructor(t,i,n,o){super([new st,new se({offset:n??k.Zero,onPostDraw:(T,P)=>this.draw(T,P)}),new Sr(o)]),this.solid=!1,this.events=new Zt,this._tileBounds=new lt,this._graphics=[],this._colliders=[],this.data=new Map,this.x=t,this.y=i,this.map=o,this._transform=this.get(st),this._isometricEntityComponent=this.get(Sr);const h=this.map.tileWidth/2,c=this.map.tileHeight/2,f=(this.x-this.y)*h,g=(this.x+this.y)*c;this._transform.pos=G(f,g),this._isometricEntityComponent.elevation=o.elevation,this._gfx=this.get(se),this._gfx.isVisible=!1;const v=this.map.tileWidth,x=this.map.tileHeight,b=G(0,this.map.renderFromTopOfGraphic?x:0);this._gfx.localBounds=this._tileBounds=new lt({left:-v/2,top:-x,right:v/2,bottom:x}).translate(b)}draw(t,i){const n=this.map.tileWidth/2;t.save(),t.translate(-n,0);for(const o of this._graphics)o.draw(t,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:o.height-this.map.tileHeight));t.restore()}}class iv extends We{get visible(){return this.isVisible}set visible(t){this.isVisible=t}constructor(t){super([new st,new Ct({type:ut.Fixed}),new fe,new Fs,new ha((x,b)=>this.debug(x,b),!1)],t.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=G(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:i,tileWidth:n,tileHeight:o,columns:h,rows:c,renderFromTopOfGraphic:f,graphicsOffset:g,elevation:v}=t;this.transform=this.get(st),i&&(this.transform.pos=i),this.collider=this.get(fe),this.collider&&this.collider.set(this._composite=new Ce([])),this.pointer=this.get(Fs),this.renderFromTopOfGraphic=f??this.renderFromTopOfGraphic,this.graphicsOffset=g??this.graphicsOffset,this.elevation=v??this.elevation,this.tileWidth=n,this.tileHeight=o,this.columns=h,this.rows=c,this._pointerEventDispatcher=new hc,this.tiles=new Array(h*c);for(let x=0;x<c;x++)for(let b=0;b<h;b++){const T=new cf(b,x,this.graphicsOffset,this);this.tiles[b+x*h]=T,this.addChild(T),this._pointerEventDispatcher.addObject(T,P=>this.getTileByPoint(P.worldPos)===T,()=>!0)}this.pointer.localBounds=lt.fromDimension(n*h*this.transform.scale.x,o*c*this.transform.scale.y,G(.5,0))}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:k.Zero;{const n=t.offset;return this._originalOffsets.set(t,n),n}}updateColliders(){this._composite.clearColliders();const t=this.get(st).pos;for(const i of this.tiles)if(i.solid)for(const n of i.getColliders()){const o=this._getOrSetColliderOriginalOffset(n);n.offset=this.tileToWorld(G(i.x,i.y)).sub(t).add(o).sub(G(this.tileWidth/2,this.tileHeight)),n.owner=this,this._composite.addCollider(n)}this.collider.update()}worldToTile(t){t=t.sub(this.transform.globalPos);const i=this.tileWidth/2,n=this.tileHeight/2;return G(~~((t.x/i+t.y/n)/2),~~((t.y/n-t.x/i)/2))}tileToWorld(t){const i=this.tileWidth/2,n=this.tileHeight/2,o=(t.x-t.y)*i,h=(t.x+t.y)*n;return G(o,h).add(this.transform.pos)}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const i=this.worldToTile(t);return this.getTile(i.x,i.y)}_getMaxZIndex(){let t=Number.NEGATIVE_INFINITY;for(const i of this.tiles){const n=i.get(st).z;n>t&&(t=n)}return t}debug(t,i){const{showAll:n,showPosition:o,positionColor:h,positionSize:c,showGrid:f,gridColor:g,gridWidth:v,showColliderGeometry:x}=i.isometric,{geometryColor:b,geometryLineWidth:T,geometryPointSize:P}=i.collider;if(t.save(),t.z=this._getMaxZIndex()+.5,n||f){for(let I=0;I<this.rows+1;I++){const F=this.tileToWorld(G(0,I)),R=this.tileToWorld(G(this.columns,I));t.drawLine(F,R,g,v)}for(let I=0;I<this.columns+1;I++){const F=this.tileToWorld(G(I,0)),R=this.tileToWorld(G(I,this.rows));t.drawLine(F,R,g,v)}}if(n||o)for(const I of this.tiles)t.drawCircle(this.tileToWorld(G(I.x,I.y)),c,h);if(n||x){for(const I of this.tiles)if(I.solid)for(const F of I.getColliders())F.debug(t,b,{lineWidth:T,pointSize:P})}t.restore()}}class wc{constructor(t,i){this.id=zt(),this._stopped=!1,this._sequenceBuilder=i,this._sequenceContext=new Nr(t),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(t){this._actionQueue.update(t)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(t){return new wc(t,this._sequenceBuilder)}}class sv{constructor(t){this.id=zt(),this._actions=t}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}isComplete(t){return this._actions.every(i=>i.isComplete(t))}reset(){this._actions.forEach(t=>t.reset())}stop(){this._actions.forEach(t=>t.stop())}}class Rn{constructor(t,i){this.bounds=t,this.options=i,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...i},this.halfWidth=t.width/2,this.halfHeight=t.height/2}_split(){this._isDivided=!0;const t={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new Rn(new lt({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),t),this.topRight=new Rn(new lt({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),t),this.bottomLeft=new Rn(new lt({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),t),this.bottomRight=new Rn(new lt({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),t)}_insertIntoSubNodes(t){var i,n,o,h;!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.insert(t),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.topRight.insert(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.insert(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.insert(t)}insert(t){if(this._isDivided){this._insertIntoSubNodes(t);return}if(this.items.push(t),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const i of this.items)this._insertIntoSubNodes(i);this.items.length=0}}remove(t){var i,n,o,h;if(this.bounds.overlaps(t.bounds)){if(!this._isDivided){const c=this.items.indexOf(t);c>-1&&this.items.splice(c,1);return}!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.remove(t),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.topRight.remove(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.remove(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.remove(t)}}query(t){let i=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(t)&&(i=i.concat(this.topLeft.query(t))),this.topRight.bounds.overlaps(t)&&(i=i.concat(this.topRight.query(t))),this.bottomLeft.bounds.overlaps(t)&&(i=i.concat(this.bottomLeft.query(t))),this.bottomRight.bounds.overlaps(t)&&(i=i.concat(this.bottomRight.query(t)))),i=i.filter((n,o)=>i.indexOf(n)>=o),i}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let t=this.items;return this._isDivided&&(t=t.concat(this.topLeft.getAllItems()),t=t.concat(this.topRight.getAllItems()),t=t.concat(this.bottomLeft.getAllItems()),t=t.concat(this.bottomRight.getAllItems())),t=t.filter((i,n)=>t.indexOf(i)>=n),t}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(t){this.bounds.draw(t,K.Yellow),this._isDivided&&(this.topLeft.bounds.draw(t,K.Yellow),this.topRight.bounds.draw(t,K.Yellow),this.bottomLeft.bounds.draw(t,K.Yellow),this.bottomRight.bounds.draw(t,K.Yellow))}}function nv(d){return!!d._initialize}function rv(d){return!!d.onAdd}function ov(d){return!!d.onRemove}function av(d){return!!d.onInitialize}function hv(d){return!!d._preupdate}function lv(d){return!!d.onPreUpdate}function cv(d){return!!d.onPostUpdate}function dv(d){return!!d.onPostUpdate}function uv(d){return!!d.onAdd}function _v(d){return!!d.onRemove}function fv(d){return!!d.onPreDraw}function pv(d){return!!d.onPostDraw}class gv{constructor(t,i=!1){this.path=t,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new Br(t,"arraybuffer",i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){const t=await this._resource.load();this._stream=new df(t),this._gif=new uf(this._stream);const i=this._gif.images.map(n=>new Gi(n.src,!1));return await Promise.all(i.map(n=>n.load())),this.data=this._images=i,this._sprites=this._images.map(n=>n.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(t=0){var i;return(i=this._sprites[t])!==null&&i!==void 0?i:null}toSpriteSheet(){const t=this._sprites;return t.length?new en({sprites:t}):null}toAnimation(t){var i;const n=(i=this._gif)===null||i===void 0?void 0:i.images;if(n?.length){const o=n.map((h,c)=>{var f;return{graphic:this._sprites[c],duration:((f=this._gif)===null||f===void 0?void 0:f.frames[c].delayMs)||void 0}});return this._animation=new Ti({frames:o,frameDuration:t}),this._animation}return null}get readCheckBytes(){var t,i;return(i=(t=this._gif)===null||t===void 0?void 0:t.checkBytes)!==null&&i!==void 0?i:[]}}const Ro=d=>d.reduce(function(t,i){return t*2+i},0),Nh=d=>{const t=[];for(let i=7;i>=0;i--)t.push(!!(d&1<<i));return t};class df{constructor(t){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=i=>{const n=[];for(let o=0;o<i;o++)n.push(this.readByte());return n},this.read=i=>{let n="";for(let o=0;o<i;o++)n+=String.fromCharCode(this.readByte());return n},this.readUnsigned=()=>{const i=this.readBytes(2);return(i[1]<<8)+i[0]},this.data=new Uint8Array(t),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const mv=function(d,t){let i=0;const n=function(T){let P=0;for(let I=0;I<T;I++)t.charCodeAt(i>>3)&1<<(i&7)&&(P|=1<<I),i++;return P},o=[],h=1<<d,c=h+1;let f=d+1,g=[];const v=function(){g=[],f=d+1;for(let T=0;T<h;T++)g[T]=[T];g[h]=[],g[c]=null};let x=0,b=0;for(;;){if(b=x,x=n(f),x===h){v();continue}if(x===c)break;if(x<g.length)b!==h&&g.push(g[b].concat(g[x][0]));else{if(x!==g.length)throw new Error("Invalid LZW code.");g.push(g[b].concat(g[b][0]))}o.push.apply(o,g[x]),g.length===1<<f&&f<12&&f++}return o};class uf{constructor(t){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=i=>{const n=[];for(let o=0;o<i;o++){const h=this._st.readBytes(3);n.push(h)}return n},this.readSubBlocks=()=>{let i,n;n="";do i=this._st.readByte(),n+=this._st.read(i);while(i!==0);return n},this.parseHeader=()=>{const i={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(i.sig=this._st.read(3),i.ver=this._st.read(3),i.sig!=="GIF")throw new Error("Not a GIF file.");i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned(),this._currentFrameCanvas.width=i.width,this._currentFrameCanvas.height=i.height;const n=Nh(this._st.readByte());i.gctFlag=n.shift(),i.colorResolution=Ro(n.splice(0,3)),i.sortedFlag=n.shift(),i.globalColorTableSize=Ro(n.splice(0,3)),i.backgroundColorIndex=this._st.readByte(),i.pixelAspectRatio=this._st.readByte(),i.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<i.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(i)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=i=>{const n=g=>{this.checkBytes.push(this._st.readByte());const v=Nh(this._st.readByte());return g.reserved=v.splice(0,3),g.disposalMethod=Ro(v.splice(0,3)),g.userInputFlag=v.shift(),g.transparentColorFlag=v.shift(),g.delayTime=this._st.readUnsigned(),g.transparentColorIndex=this._st.readByte(),g.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(g)&&this.checkBytes.push(this._handler.gce),g},o=g=>{g.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(g)&&this.checkBytes.push(this._handler.com)},h=g=>{this.checkBytes.push(this._st.readByte()),g.ptHeader=this._st.readBytes(12),g.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(g)&&this.checkBytes.push(this._handler.pte)},c=g=>{const v=b=>{this.checkBytes.push(this._st.readByte()),b.unknown=this._st.readByte(),b.iterations=this._st.readUnsigned(),b.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(b)&&this.checkBytes.push(this._handler.app)},x=b=>{b.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[b.identifier]&&this._handler.app[b.identifier](b)&&this.checkBytes.push(this._handler.app[b.identifier])};switch(this.checkBytes.push(this._st.readByte()),g.identifier=this._st.read(8),g.authCode=this._st.read(3),g.identifier){case"NETSCAPE":v(g);break;default:x(g);break}},f=g=>{g.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(g)&&this.checkBytes.push(this._handler.unknown)};switch(i.label=this._st.readByte(),i.label){case 249:i.extType="gce",this._gce=n(i);break;case 254:i.extType="com",o(i);break;case 1:i.extType="pte",h(i);break;case 255:i.extType="app",c(i);break;default:i.extType="unknown",f(i);break}},this.parseImg=i=>{var n;const o=(f,g)=>{const v=new Array(f.length),x=f.length/g,b=(F,R)=>{const S=f.slice(R*g,(R+1)*g);v.splice.apply(v,[F*g,g].concat(S))},T=[0,4,2,1],P=[8,8,4,2];let I=0;for(let F=0;F<4;F++)for(let R=T[F];R<x;R+=P[F])b(R,I),I++;return v};i.leftPos=this._st.readUnsigned(),i.topPos=this._st.readUnsigned(),i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned();const h=Nh(this._st.readByte());i.lctFlag=h.shift(),i.interlaced=h.shift(),i.sorted=h.shift(),i.reserved=h.splice(0,2),i.lctSize=Ro(h.splice(0,3)),i.lctFlag&&(i.lctBytes=this.parseColorTableBytes(1<<i.lctSize+1)),i.lzwMinCodeSize=this._st.readByte();const c=this.readSubBlocks();i.pixels=mv(i.lzwMinCodeSize,c),i.interlaced&&(i.pixels=o(i.pixels,i.width)),!((n=this._gce)===null||n===void 0)&&n.delayTime&&(i.delayMs=this._gce.delayTime*10),this.frames.push(i),this.arrayToImage(i,i.lctFlag?i.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(i)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const i={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(i.sentinel)){case"!":i.type="ext",this.parseExt(i);break;case",":i.type="img",this.parseImg(i);break;case";":i.type="eof",this._handler.eof&&this._handler.eof(i)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+i.sentinel.toString(16))}i.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(i,n)=>{var o,h,c,f;const g=document.createElement("canvas");g.width=i.width,g.height=i.height;const v=g.getContext("2d"),x=v.getImageData(0,0,g.width,g.height);let b=-1;!((o=this._gce)===null||o===void 0)&&o.transparentColorFlag&&(b=this._gce.transparentColorIndex);for(let P=0;P<i.pixels.length;P++){const I=i.pixels[P],F=n[I];I===b?x.data.set([0,0,0,0],P*4):x.data.set([...F,255],P*4)}if(v.putImageData(x,0,0),((h=this._gce)===null||h===void 0?void 0:h.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((c=this._gce)===null||c===void 0?void 0:c.disposalMethod)===2&&(!((f=this._hdr)===null||f===void 0)&&f.gctFlag)){const P=n[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${P[0]}, ${P[1]}, ${P[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(g,i.leftPos,i.topPos,i.width,i.height);const T=new Image;T.src=this._currentFrameCanvas.toDataURL(),this.images.push(T)},this._st=t,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class vv{constructor(t,i,{bustCache:n,...o}={}){this.path=t,this.family=i,this._isLoaded=!1,this._resource=new Br(t,"blob",n),this._options=o}async load(){if(this.isLoaded())return this.data;try{const t=await this._resource.load(),i=URL.createObjectURL(t);this.data||(this.data=new FontFace(this.family,`url(${i})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(t){throw`Error loading FontSource from path '${this.path}' with error [${t.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(t){return new hn({family:this.family,...this._options,...t})}}const xu=af(),wv=/^\s*(?:function)?\*/;function bu(d){return typeof d!="function"?!1:wv.test(Function.prototype.toString.call(d))?!0:Object.getPrototypeOf?Object.getPrototypeOf(d)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function _f(...d){var t;const i=ct.getInstance();let n,o,h,c;bu(d[0])&&(o=globalThis,n=d[0],h=d[1]),bu(d[1])&&(o=d[0],n=d[1],h=d[2]),d[1]instanceof Je&&(o=d[0],c=d[1],n=d[2],h=d[3]),d[0]instanceof Je&&(o=globalThis,c=d[0],n=d[1],h=d[2]);const f=hf(xu),g=h?.timing,v=f?!1:(t=h?.autostart)!==null&&t!==void 0?t:!0;let x;try{x=c??Je.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let b=!1,T=!1,P=!1;const I=n.bind(o),F=I();let R;const S=new Promise((W,U)=>{R=V=>{try{if(P){T=!0,W();return}const{done:j,value:q}=xu.scope(!0,()=>F.next(V));if(j||P){T=!0,W();return}q instanceof Promise?q.then(()=>{x.clock.schedule(R,0,g)}):q===void 0||q===void 0?x.clock.schedule(R,0,g):x.clock.schedule(R,q||0,g)}catch(j){U(j);return}},v&&(b=!0,R(x.clock.elapsed()))}),M={isRunning:()=>b&&!P&&!T,isComplete:()=>T,cancel:()=>{P=!0},start:()=>(b?i.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(I)):(b=!0,R(x.clock.elapsed())),M),generator:F,done:S,then:S.then.bind(S),[Symbol.iterator]:()=>F};return M}class pa extends We{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(t){var i,n,o,h;super(),this._logger=ct.getInstance(),this.transform=new st,this.graphics=new se,this._completeFuture=new di,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=t.duration,this.easing=(i=t.easing)!==null&&i!==void 0?i:Wt.Linear,this.direction=(n=t.direction)!==null&&n!==void 0?n:"out",this.hideLoader=(o=t.hideLoader)!==null&&o!==void 0?o:!1,this.blockInput=(h=t.blockInput)!==null&&h!==void 0?h:!1,this.transform.coordPlane=Me.Screen,this.transform.pos=k.Zero,this.transform.z=1/0,this.graphics.anchor=k.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(t,i){this.complete||(this._currentDistance+=bt(i/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=bt(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=bt(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(t){}onStart(t){}onUpdate(t){}onEnd(t){}onReset(){}reset(){this.started=!1,this._completeFuture=new di,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(t,i){const n=i;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),n.world.entityManager.getById(this.id))return this._co;this._engine=t,n.add(this);const o=this;return this._co=_f(t,function*(){for(;!o.complete;){const h=yield;o.updateTransition(o._engine,h),o._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class xv extends pa{constructor(t){var i,n;super({...t,duration:(i=t.duration)!==null&&i!==void 0?i:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(n=t.color)!==null&&n!==void 0?n:K.Black}onInitialize(t){this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=new Hr({width:t.screen.resolution.width,height:t.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=t}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class bv extends pa{constructor(t){super({direction:"in",...t}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(t){this.image=await t.engine.screenshot(!0),await this.image.decode()}onInitialize(t){this.engine=t,this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=Gi.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=G(1/t.screen.pixelRatio,1/t.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class yv extends pa{constructor(t){var i;super({direction:"in",...t}),this._easing=Wt.Linear,this.name=`Slide#${this.id}`,this.slideDirection=t.slideDirection,this.transform.coordPlane=Me.World,this.graphics.forceOnScreen=!0,this._easing=(i=t.easingFunction)!==null&&i!==void 0?i:this._easing,this._vectorEasing=Wt.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(t){this._image=await t.engine.screenshot(!0),await this._image.decode(),this._screenCover=Gi.fromHtmlImageElement(this._image).toSprite()}onInitialize(t){switch(this._engine=t,this.slideDirection){case"up":{this._directionOffset=G(0,-t.screen.resolution.height);break}case"down":{this._directionOffset=G(0,t.screen.resolution.height);break}case"left":{this._directionOffset=G(-t.screen.resolution.width,0);break}case"right":{this._directionOffset=G(t.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=G(1/t.screen.pixelRatio,1/t.screen.pixelRatio)}onUpdate(t){this._camera.pos=this._vectorEasing(t,this._destinationCameraPosition,this._startCameraPosition,1)}}class xc extends ie{constructor(t){super(),this.color=K.Black,this.thickness=1;const{start:i,end:n,color:o,thickness:h}=t;this.start=i,this.end=n,this.color=o??this.color,this.thickness=h??this.thickness,this._localBounds=this._calculateBounds();const{width:c,height:f}=this._localBounds;this.width=c,this.height=f}get localBounds(){return this._localBounds}_calculateBounds(){const t=this.end.sub(this.start).normal(),i=this.thickness/2,n=[this.start.add(t.scale(i)),this.end.add(t.scale(i)),this.end.add(t.scale(-i)),this.start.add(t.scale(-i))];return lt.fromPoints(n)}_drawImage(t,i,n){t.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new xc({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class bc extends Wn{get points(){return this._points}set points(t){this._points=t;const i=this.minPoint;this.width=this._points.reduce((n,o)=>Math.max(o.x,n),0)-i.x,this.height=this._points.reduce((n,o)=>Math.max(o.y,n),0)-i.y,this.flagDirty()}get minPoint(){const t=this._points.reduce((n,o)=>Math.min(o.x,n),1/0),i=this._points.reduce((n,o)=>Math.min(o.y,n),1/0);return G(t,i)}constructor(t){super(t),this._points=[],this.points=t.points,this.filtering=pe.Blended,this.rasterize()}clone(){return new bc({points:this.points.map(t=>t.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){if(this.points&&this.points.length){t.beginPath();const i=this.minPoint.negate(),n=this.points[0].add(i);t.moveTo(n.x,n.y),this.points.forEach(o=>{t.lineTo(o.x+i.x,o.y+i.y)}),t.lineTo(n.x,n.y),t.closePath(),this.color&&t.fill(),this.strokeColor&&t.stroke()}}}var hs;(function(d){d.Stretch="stretch",d.Tile="tile",d.TileFit="tile-fit"})(hs||(hs={}));class yc extends ie{constructor(t){super(t),this._logger=ct.getInstance(),this._config=t,this._imgSource=t.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(t,i=!1){this._config.width=t,i&&this._initialize()}setTargetHeight(t,i=!1){this._config.height=t,i&&this._initialize()}setMargins(t,i,n,o,h=!1){this._config.sourceConfig.leftMargin=t,this._config.sourceConfig.topMargin=i,this._config.sourceConfig.rightMargin=n,this._config.sourceConfig.bottomMargin=o,h&&this._initialize()}setStretch(t,i,n=!1){t==="horizontal"?this._config.destinationConfig.horizontalStretch=i:t==="vertical"?this._config.destinationConfig.verticalStretch=i:(this._config.destinationConfig.horizontalStretch=i,this._config.destinationConfig.verticalStretch=i),n&&this._initialize()}getConfig(){return this._config}_drawTile(t,i,n,o,h,c,f){const g=c||0,v=f||0;let x,b,T,P;const I=this._getNumberOfTiles(i.width,n.x,o),F=this._getNumberOfTiles(i.height,n.y,h);for(let R=0;R<I;R++)for(let S=0;S<F;S++){let{tempSize:M,tempPosition:W}=this._calculateParams(R,I,i.width,n.x,this._config.destinationConfig.horizontalStretch);x=M,b=W,{tempSize:M,tempPosition:W}=this._calculateParams(S,F,i.height,n.y,this._config.destinationConfig.verticalStretch),T=M,P=W,t.drawImage(i,0,0,i.width,i.height,g+b,v+P,x,T)}}_drawImage(t,i,n){this._imgSource.isLoaded()?(this._drawTile(t,this._canvasA,new k(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(t,this._canvasB,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(t,this._canvasC,new k(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(t,this._canvasD,new k(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(t,this._canvasE,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasF,new k(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasG,new k(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasH,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasI,new k(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const t=this._canvasA.getContext("2d");t?.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const i=this._canvasB.getContext("2d");i?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const n=this._canvasC.getContext("2d");n?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const o=this._canvasD.getContext("2d");o?.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const h=this._canvasE.getContext("2d");h?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const c=this._canvasF.getContext("2d");c?.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const f=this._canvasG.getContext("2d");f?.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const g=this._canvasH.getContext("2d");g?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const v=this._canvasI.getContext("2d");v?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new yc(this._config)}_getNumberOfTiles(t,i,n){switch(n){case hs.Stretch:return 1;case hs.Tile:return Math.ceil(i/t);case hs.TileFit:return Math.ceil(i/t)}}_calculateParams(t,i,n,o,h){switch(h){case hs.Stretch:return{tempPosition:0,tempSize:o};case hs.Tile:return t===i-1?{tempPosition:t*n,tempSize:n-(i*n-o)}:{tempPosition:t*n,tempSize:n};case hs.TileFit:const c=o/i;return{tempPosition:t*c,tempSize:c}}}}class Ac extends Ti{constructor(t){super({...t,frames:t.animation.frames.slice(),strategy:t.animation.strategy,frameDuration:t.animation.frameDuration,speed:t.animation.speed,reverse:t.animation.isReversed}),this._ready=new di,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...t.sourceView},this._tiledWidth=t.width,this._tiledHeight=t.height;const i=[];for(let n=0;n<this.frames.length;n++){const o=this.frames[n].graphic;if(o&&o instanceof Si){const h=new kr({image:o.image,width:t.width,height:t.height,sourceView:{...o.sourceView},wrapping:t.wrapping,filtering:t.filtering});this.frames[n].graphic=h,h.ready.then(()=>{h.sourceView={...h.sourceView,...this._sourceView}}),i.push(h.ready)}}Promise.all(i).then(()=>this._ready.resolve())}static fromAnimation(t,i){return new Ac({width:t.width,height:t.height,...i,animation:t})}_updateSourceView(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof Si&&(i.sourceView={...i.sourceView,...this._sourceView})}}get sourceView(){return Pi(this._sourceView,()=>this._updateSourceView())}set sourceView(t){this._sourceView=Pi(t,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof Si&&(i.sourceView.height=this._tiledHeight||i.height,i.destSize.height=this._tiledHeight||i.height,i.sourceView.width=this._tiledWidth||i.width,i.destSize.width=this._tiledWidth||i.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(t){this._tiledWidth=t,this._updateWidthHeight()}set height(t){this._tiledHeight=t,this._updateWidthHeight()}}const ff=5,Un={},Av=()=>{for(const d in Un)Un[d]=0},Do=(d,t)=>{const i=Ie.isEnabled("suppress-obsolete-message");Un[d]<ff&&!i&&(ct.getInstance().warn(d),console.trace&&t.showStackTrace&&console.trace()),Un[d]++};function Cv(d){return d={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...d},function(t,i,n){if(n&&!(typeof n.value=="function"||typeof n.get=="function"||typeof n.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const h=`${`${t.name||""}${t.name&&i?".":""}${i||""}`} is marked obsolete: ${d.message}`+(d.alternateMethod?` Use ${d.alternateMethod} instead`:"");Un[h]||(Un[h]=0);const c=n?{...n}:t;if(!n){class f extends c{constructor(...v){Do(h,d),super(...v)}}return f}return n&&n.value?(c.value=function(){return Do(h,d),n.value.apply(this,arguments)},c):(n&&n.get&&(c.get=function(){return Do(h,d),n.get.apply(this,arguments)}),n&&n.set&&(c.set=function(){return Do(h,d),n.set.apply(this,arguments)}),c)}}class Tv{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const t=new di;return this._queue.push(t),t.promise}dequeue(t){this._queue.shift().resolve(t)}}class Pv{constructor(t){this._count=t,this._waitQueue=new Tv}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(t=1){if(t!==0){for(;t!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),t--;this._count+=t}}}const vl="0.30.3";Ru();C.eKr;C.yVm;C.a7j;C.U_w;C.JF2;C.htg;C.HXL;C.mcg;var un=C.Agj;C.J3_;C.Wgv;C.u6S;C.x7M;var Sv=C.X55;C.m3M;C.aE5;var Ev=C.YJU;C.eZi;C.GNv;C.Y56;C._0v;C.vhs;C.vrQ;C.Z8b;C.Yfw;C.IcQ;C.kgJ;C.GTT;C.ypY;C.i7d;C.fQ3;C.HlI;var pf=C.jlt;C.VQc;C.zD7;C.AUF;C.JoF;C.MlA;C.PZh;C.qA;var ga=C.CrD;C.dQK;C.D3r;C.Qpo;C.D9n;C.b6v;C.mvh;var _n=C.Bpo,Fe=C.Q1f;C.IKv;C.fcV;C.Glf;var gf=C.uAl;C.ElT;C.Z8r;C.QSL;C.sPV;C.nAn;C.zCU;C.QrV;C.fF9;C.Jqv;C.d_u;C.xI8;C.yar;C.SP7;C.oRy;C.f5X;C.V1c;C.Mlx;C.ZiM;C.ZCo;C.J5p;C.mL_;C.Guw;C.N5j;C.pgY;C.OP3;C.rl5;C.eod;var Iv=C.q5Z;C.YUC;C.saR;C.hvr;C.Qol;C.Wf4;C.JCs;C.gJV;C.fWD;C.Va_;var Rv=C.N$8;C._jQ;C.rxj;C.rhv;C.wCu;C.HAp;C.Zy1;C.bkB;C.wfL;C.sVA;C.$Gs;C.CJ0;C.NWh;C.tWi;C.xAj;C.zWh;C.i_4;C.iIx;C.Hxo;var mf=C.c9e,Gh=C.KQV;C.weH;C.jXp;C.zzY;C.yRQ;C.MtE;C.rPj;C.KLc;C.Fir;C.V5f;C.Xj7;C.Wud;C.FVg;C.g5Y;C.YQB;C.KPb;C.nHK;C.Jrb;C.TX_;C.Olt;C.r3n;C.Fvk;C.gpR;C.vYh;C.hnk;var In=C.D2R;C.n1o;C.h9O;C.X5j;C.p3P;C.RLG;C.fBU;C.Adb;var Ss=C.bEs;C.wCy;C.CbD;C.x_C;C.pGf;C.ibQ;C.shR;C.Yjk;var vf=C._u1;C.OBI;C.klh;C.s3S;C.D$R;C.xth;var Vh=C.JU7;C.h9x;C.N1A;C.e_k;var Dv=C.aHM;C.tlv;C.Vi9;C.ieR;C.$bb;C.VyI;C.imn;C.uqu;C.QnL;C.vnc;var Mv=C.wk_;C.GH0;C._1r;C.l0X;C.bT;C.HHX;C.jtW;C.tjk;C.rWe;C.j9l;C.l0$;C.sGJ;C.NVp;C.cPK;C.XoL;C.RmF;C.DXI;C.tCD;C.J3D;C.vCJ;C.e6k;C.f9l;C.v9m;C.yRJ;C.EU6;C.m3O;C.Ryz;C.OxP;C.LEs;C.Ec;C.Pi5;C.gmH;C.tS;C.XxX;C.bCz;C.nYS;C.yiT;C.NHl;C.mO8;C.PXI;C.bn5;C.Ywr;C.cMd;C.Bs6;C.G0k;C.pyn;C.QeM;C.aPX;C.ITP;C.BY0;C.MFw;C.sBn;C.S3L;C.XKQ;C.ESI;C.uxz;var qn=C.o8N;C.u_r;C.RlV;C.gVA;var Jo=C.M_G;C.BpG;C.GRB;C.kM6;C.dO8;C.jgM;C.FWq;C.s3j;C.hlw;C.L0q;C.B7e;C.PGN;C.H_X;C.S_d;C._Tq;C.U7E;C.IOH;var Fv=C.Z58;C.yh2;C.ff$;C.cWi;var Dr=C.NBt;C.oNz;C.QlU;C.Xey;C.jft;C._r8;C.bTC;C.Mtr;var wf=C.ypk;C.mnM;C.q7S;C.bAZ;C.ABN;C.VK6;C.Hj2;C.Df8;C.oOx;C.kxk;C.DT1;var ma=C.FLG;C.qN_;C.Z37;C.FtL;C.Z6X;C.iQT;C.ziO;C.OEF;C.uuE;C.tiv;C.T$Y;C.EYj;var qh=C.nOB;C.Tap;C.FAs;C.B_P;C.aA5;C.J3s;C.Y0Q;C.M4G;C.l$l;C.dLy;C.WZP;C.eB6;C.nFK;C.l9z;C.YOF;C.yhB;C.J0N;var De=C.Miz;C.Bj4;C.Rcs;C.vJ4;C.TqC;C.nM0;C.X1u;C.SpZ;C.DX8;C.Yx$;C.HK4;C.yt5;C.vAR;C.SE$;C.qE8;C.Pz7;C.sX_;C.JuI;C.pxT;C.Nl$;C.zDr;C.OwT;C.P$G;C.mHV;C.kEA;C.Fx_;C.WFC;C.vKu;C.aDq;C.jIg;C.UH3;C.AJO;C.U4;C.xAc;C._3Y;C.K6X;C.C1Y;C.Aw1;C.tm8;C.LBV;C.A8$;C.F5e;C.ran;C.c8L;C.o6M;C.hsx;C.l9E;C.aSf;C.CcK;C.nU8;C.td6;C.Zex;C.bkJ;C.mXP;C.vt$;C.hCA;C.pjR;C.U43;C.pSZ;C.y17;C.Ew7;C.hG1;C.jVr;C._SZ;C.xWn;var Bv=C.ehJ,Dt=C.t6s;C.Eyn;const xf={App:void 0},kv=`
<style> 
   canvas {
       user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -moz-user-select: none;

      -webkit-touch-callout: none; /* disables long-press context menu on iOS Safari */
   }
</style> 
<div \${==>App}> 
    <canvas id='cnv'> </canvas> 
</div>`,Lv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEQAAAAiCAYAAADmvn/1AAAAAXNSR0IArs4c6QAAAcBJREFUaIHt2L1qAkEYheFjiiBJ4yXYx8LKOk0uIb21VcpAUlhEsEwl5A4C6cVKglWEYEydIoWCWwpRMNWkWNbiyMfszLc7AZm3W3cchodh/wBlnXHTNHvnRjuPtlG7ZbqXNfU6Kr5/7IybBgA+lysAwHaxAQDM77bec/o0arcMACx/03UsVz8AgO7r2msdzn9iCC4UDENwvjC5B9sguLJgbBCcK4x1kCsEVxSMKwSXF0Y8qYXgfGG0EJwN5uDHoiG4vDBFQ3ASzP6gbAhOgikbgmOYSmgILoPpf12kCwwEwWUwcYfwDuEB8RoiFO8yQvE5RCg+qQrFdxmhY33bVXds30NOtBMMa0+Ym552GnVn721U367U83hvq/psagAgmSUAgF3ynZ64vwm6VSeNgQGARfIBAFhs1gCA291LmA9EDMGFgmEIzhcm92AbBFcWjA2Cc4WxDnKF4IqCcYXg8sKIJ7UQnC+MFoKzwRz8WDQElxemaAhOgtkflA3BSTBlQ3AMUwkNwWUwk+fTdIGBILgMJu4Q3iE8IF5DhOJdRig+hwjFJ1Wh+C4jdKxvu+rqs6nBw+O/fyCaNAamX71Wr+MPZlhfhBfdpjwAAAAASUVORK5CYII=",Uv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAAFACAYAAADNkKWqAAAAAXNSR0IArs4c6QAABW5JREFUeJzt3TFOHVcYhuFj6daRV0AdF9mCN4BckM4VC3DhjjKFy/S0kVyliBQXkTfAFigcicZiBRYbuCmSQeFcxndm7pyZc+Z/nsaIBn7J36sLjE1KK7u6udxf3Vzu1/481hL9fljTi7U+cN/of339cbXPaUnR74caLD62oa92thqC6PdDTRYb2dQv87YSguj3Q42Kj2uu72+1GoLo90PNio2q1Df2WwlB9PuhBbOPaamfaNYaguj3Q0tmG9Faj3LUEoLo90OLTh5PLc+wrRWC6PdDyyaPppbh55YKQfT7YQtGj6XW4edKhSD6/bAlg0fSyvBzc4Ug+v2wRUfH0erwc1NDEP1+2LLeUWxl+LmhIYh+P0RwMIatDj/XF4Lo90MkjyOIMvxcF4Lo90NEu6uby/2PZy/T3/ff1v5cVvHb1/f7lFLY+yGy3d3tQ7q7fUhvzs9SChSCu9uHJ39GvR8i23Vv/PX5PqUAIegbfvT7IaJd/o6thmDo8KPfD5EcBLCzlRBMHX70+yGC3gB2Wg3BXMOPfj9s2dEAdloJQanhR78ftujxGbCL64tRz8HVFoKpw//07tOL5H4I6eAvf2shmHv40e+HSHpHUHsISg8/+v0QwdEx1BaCpYcf/X7YssGjWDsEaw8/+v2wRaPHsXQIaht+9PthSyaPpHQIah9+9PthC04ey9whaG340e+Hls02mlND0Prwo98PLZp9PGNDMFWtwx9z/5vzs8d/YTJWrfdDS4qNqFQIWxn+kPunBLCV+6EFxcc0VwhbHf737h8TwFbvh5otNqqpIdzK8J+7f0gAt3I/1GjxcQ0N4VaH///7vxfArd4PNVltZH0hjDL8i+uL/XMBjHI/kFK6/HCzv/xwE/JXUqb/QrjUT86Bp1Z7tdEXvY+/vPYKCFjE4rHJw/fy1b8PBH/78vRLQSEESlssMnn4Hr7cppRS+uHVTykJIbCC4nE5Fr6cEAJLKRaVseHLCSFQ2uwxOTV8OSEESpktInOHLyeEwNxOjkfp8OWEEJjL5GgsHb6cEAKnGh2LtcOXE0JgqsGRqC18OSEExjoah9rDlxNCYKjeKLQWvpwQAsccxKD18OWEEOjzGIGthS8nhEBu9/6Pr/v0TBi68LUewr7wAezu//ycUkrp7OfzlDYUwmPh6+4B4tp1b2wlhMIHDLXL39FqCIUPGOsggJ1WQih8wFS9AezUGkLhA051NICdWkIofMBcHp+Bu3h7PepXM/aFsLPU/weYf7yxPv3+znOAENTB+GsLofABpfRGYO0QCh9Q2tEYLB1C4QOWMjgKpUMofMDSRsdh6VeEwgeUMjkSc4cwJ3xAaSfHotQrwrGEDxhrtmicGkLhA5Y2ezzGhnAq4QNOVSwipUIofMBcisdkrhAKHzC3xaIyNYTCB5SyeFyGhlD4gNJWi0xfCIUPCOPi7fV+qZ8cAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAhf4BDsJ9Emo7biEAAAAASUVORK5CYII=",zv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACgCAYAAACLz2ctAAAAAXNSR0IArs4c6QAAA61JREFUeJzt2j9oG1ccB/BfUkO2pMHgpeFi7Aa6eAhoNYSSzRZEQ4dCi2mHekiMs3QpOGOHeGmIPWQphHZKB4fY3kzByeAMxhm6FJoaWbhLIaR0brgufaoky7YUW4osfz4gJL27d+909+X9ERcBAHB8HvxxI3/X59Cq0mIpP+wzdFQKW+P7qXaUi9APF/DCtbET/xt63dnaL9+XZ+u6/ytj598qSEep2+h+5ZsjHaPZObRyXheujeUff/KhEHZYXQCXVytRWizlKYgfZe+3fcB0c1PddkLYbN+Z7NszreyXNM79lm4u7anfrKzRYPlc8eefXsZg+VzxsH15e2cbC4oTWSyvViIi4tfKXxHRXoiujJ2vq1ucyFqu30owDttv+oPHLR3jIBeujeXb5c2VwfK54nZ5c0Uv2Dl1AVy6uXQmha9WO8NpY6+5vFqJ4kR2lHPsqtqhN4XvXQzFp2VlvKcHTL1LcSKL3375OyL+D1XtHHE/qedLdVOP2krdiIPnfEeZD7Z64xqH3nc1FC/dXDrTeM6lxVLe6ihxUhz4Y9IFuDJ2vi5QXw7f27feQTe6GxfvOG7SyHBhcru8ubLfd7qktFjKm7262X632joup2XopIf5UxkAAE64bDTLs9HMRJ7uy0azfO7uk3x9Y0sI+1BP/qteG7Sp6YW4Pn4pbs/MxqvXOxERUfm90pPnTRd0cjhMx17f2Kr2eFcL43kq1xP2uYPClbbled6RENQGb31jq9rO+sZWfrUwXg3f+sZWPnf3iRD2ierDCNlolv/w4+OYml6IxpubjWb51PRC7LzciafPX8Tas922G2olMGvPdqvHfvr8RdyemY21Z7vx3f17cX38UnX7yqP5ttunNw1UP7wZKn7x6Vf/FQ5FxN7Hsu7ML8f18UttN5LC/flnN/Jm87cU8IcPbsXgxcsR8XW1ncb2Vh7Nx6vXO+aBfaKlmzgyXJhsVt7sCZHU07UTkBTA1Ms9fHCrum3w4uXq4iMRPpp624VC7SIjzQVr55rpPc/zvJOLIE6pkeHC5MhwYTKFsDZ8KZSpbO7uE4uQPjJw+C6dt13eXKkd5u/ML9dtn5pe2FNGf+ipudTIcGHyn/f+XI6on/s1+zzwZqjoKeWTr6cCGLH/gqeR8AEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCz+BWpwAcBUWVpgAAAADmVYSWZNTQAqAAAACAAAAAAAAADSU5MAAAAASUVORK5CYII=",Hv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAZFJREFUWIXl179OwlAUx/HvTXgIpEvjxsJkGGrcJeqIq0NZHQi7b0AcWGVghREJrIbgQJxYupkuIpuPcB3MvdbS0v9l8ExN07SfnHv66y2WaUjLNCRHKvH18iABru6GALy6H6JUgDPoSIBqo8YxIEK1f9hrcQyIsExDDnst7P6cY0A0QFXZEGGZhpyNbHabLQCLpUN3vCptaSrqoNqoaYT3AXZ//gcyG9kKIvOAVIJOOoOOrN8/iTIggQCFACgasjeEi6XD5UV970IFUZXXjIjH23MJ6IeGAYqC6GlvN0198hDAD8maI+LUPLsGqPI59ULiIOAnN7LkiB7CHSc3AJO1O/VeEAfifYXbTZPueCXiDmvl3X17BlCdSAtJmyN766Ig+sYRS2P35/qmu81WD7F/WOF3XhQYAnIgr474cwR+uuLvSOS7GtWRydolS47ETq24S5M0RxLndxTEizlUCpL6S5Z0WMMq8zc9KyS33U1aSO77vKSQwna8cSGF7/2jIKX9BYVBSv0NC4KUDgiD/N/6BqlKK1m+ta+tAAAAAElFTkSuQmCC",Ov="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAABG9JREFUeJztnL1P20AYh398CKQsdEJCgCFNVZEuDK4iEaljt7JlYOnQfyHq1qFi6Jp/gSFLB9SFTnRFiUSbNUioaT6KFMFElkhB0HSIzlzOZ/tIch+27pEixR+xLw/v3b1+HTMHg3AyzpC3vtPozKluiyiLuhtAS0sV8gCArDMAAFx0lkf7HMPbxzSZ2hpDxLHSgiAy+8cVAOaI1NIIJ+MMU4W8T1o6t+Tbt3l+N7ZMizRBotIGkKhzi663jieNhZUIjESaEI3KTsxGnYg4FhOjUekkEiXv+KDKXV/4uhd6vNoM2jYpSv5qdPSFyWv/bgMALo82AQAvP/wFAGy92PIkhnVnHVEo/YSi8n58+ucJY7k82sTbL/NGSlTShcPk0bCRR5ZZ0rkln8SsM9DSledlHpxEnwhnp9fe+8ujTVwebXrr6G1hpAr5wKsZWUiPwKgEGRilNYelGj6j69t2dnqNw59rcIsumud3XiTzolAHSrpwOreEvbUNVLtXgfu4RRffg7a9eTyOaUjrwk7GGbpFV+hLp3NLkfuJHCfrDJR3Y6ljIE21e4W9tQ3ferob8kQGyTWh+wIGVGN4mNhVg1AWgYA/CulJIa4oFQgEd+W4oqULexJzwbNyGKaMf4DGMZAXiWFpDhAu7qKzjKwzGOWdRRcoYajisk6KQCfjDIMqKDSsMF7XrnavIiOOyNPBzAWKyuMRFYEmonwSSRqJEVgr6SmrShkDdeR3qUIetVLFW1ZVF0xMBAIjiaLls1kxc4GdRmeuVqpJy9XIjSRTkBKBsiWahJYunCSxiRoDdWAFTkksBZo0kWgROM0NIfqnb+SlEy3VmGkSbV7hQKdEo7pwHGdnowRGobNsFYQUgdOUtKaBFFTdoqvs1qbUCAwa53iTiEj3DYu+xBRURWElxvXunNaKdFyl0SiZROI4u4oiRSAR1jy/U1Zc1VWRllK1pX+NPwt5InflgMdnSICYV6QnaTyJ1mm6eyIq0tMyScTqTK6lpjFhMpIysdiK9JRIu5Rj100qTeRziazGsMk06c5BTyPxaJ7fRaYn7HbVz4pouZRjvzT98KGINBYd6QtBWhrDi7TjgyryqZWxVxBR22l0pC8EqX8tdizsNDpzTsYZsmIq/d7YMm87HaWEWqmGfGpl7POqI1DZyZ5vv34HAPcLNyfvX2156xutW9++me1nY8uN1q1PMvAoutLvaXvcVfpJiTjAL29SeNIr/R4WH1b3/7R+BT2vIwWpeaCovN2d9Scdl41QYBSN9ws3J/Q5VSBNoMgX2d1Z9+Q9RSIvAp967lmh7VqYJyxKYrnejpSnGikCeRGw+LC6X663Ua63PVEfv1V8n+VJbLRuUa63sfiwus+bTCr9njcGhrVBBlImkajG3y/cnAAjqeR9FLQc9jP0NhoVE4q0WVj1YM6iajY2rh4YN6TmgbqiUGUuqDSRVoHqRFr5pZwsVIsjaLl+nJVMXdJotP/3M0BcqAnCLBaLxWKxWCwWi8VisVgsOvkPW9QWs7d38t4AAAAASUVORK5CYII=",Wv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAgCAYAAADaInAlAAAAAXNSR0IArs4c6QAAAppJREFUeJztmb9r20AUx7+pSvcQDxmNO7WbwBiDJ/8F3jN1655Vc1bvXTp3DXTXFBAikK2eHDJmSMheMO70xPP5TvdDd5JD3wcMtnT3vk/f93wSOkAQBEEQBEEQBEH4jzgLmTQZT/f89+PTfVAcIYyY/n8MES7yCrPlDgBQlxluMN93TSQkD6LvBhxKP4X/zhMm4+m+yCt8+5UBAP78+Htwvi4z3DzMk5phNOBhDiB9IYbUT+W/02BVnOizCYZuwCH1U/pvHUji1PFfv3/SindJwjWHoRpwSP3U/n9wGUTiJGwSV8fGgBvAdXU5zJY7FHl1dI9+r/qT8XR/e32X1P/WBqAEVF6f37Tfidvru6hFGKoB+yhACK7+06ctltMKQNRlhtV6ge1mhLrMUJcZtpsRVusF6jKzB/DkVBowVN+lACZoHvc1xH/bimRtgJDCkildDDDl4mPAeyiASbvIKxR51ej6QP7T/DaMDUBJ8ARoeePLnO7YdjNqEgi9J+oK4Ao34NQL4EpdZt7+z5Y763OJtgF48XkCAPDz6vdBcH6Mw59cfYtgKkCIAbFIVQAV1Xv1Gnz8d+GoAdoSqMsMF5fnR0H4MfWeGKsIIQ1I4065ACZ4fP7Sydd/2+rV+gyg625bwK7/vtgNGEpfBTBhmhfbf+NegG8BX5/fGnFOqAHqMktx+FKsQzWgSwF0Or76vjw+3Z/Ru/0C7quIzn+X19RHDUAJFKgOjAfQBKPEPn95wcXlOVbrRTOX/sHqPN+3YzajVUwG+NJ3AUw5AGg2eVRc/Xfx3XhSXYp5MNtuWNfdMr7pwmkaMLcbwMeH5MDzUPHRT7U3wH+b/HfRbh3AhYbY8zddaEwDYubVl74gCIIgCIIgCIIgCEII/wA4CPQArRf9NwAAAABJRU5ErkJggg==",Nv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAEBJREFUWIVjYBgFo2AUjIJRMApGwSgYBaNgFIyCkQ4YiVWopGDiQ4rB9x6c2UKxA0i1lBzHMFHDAkrAgEfBKAAAZe4MBrg/DiUAAAAASUVORK5CYII=",Gv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAQCAYAAACm53kpAAAAAXNSR0IArs4c6QAAAHpJREFUWIVjYBgFo2AUjIIRDBiROczMhv/pYenfv+cZsYkPqP3MzIb/6QWweXSg7GeBWf7nzzkGRkasEUN18P//fwYWFqP/sJiA2T/rWSBd7P/z5xzcfhZkCSVZVbo4ABe4/GkrfSySwiI2UrPAaCE4CkbBKBgFIxkAADT+0rfjVIbqAAAAAElFTkSuQmCC",Bs={tsetD1:new Ss(Lv),ground:new Ss(Uv),overlay:new Ss(zv),fence:new Ss(Hv),tree:new Ss(Ov),purpleGuy:new Ss(Wv),purpleShadow:new Ss(Nv),lifebar:new Ss(Gv)},Vv=ma.fromImageSource({image:Bs.tsetD1,grid:{rows:2,columns:2,spriteWidth:34,spriteHeight:17}}),Mo=ma.fromImageSource({image:Bs.ground,grid:{rows:10,columns:5,spriteWidth:64,spriteHeight:32}}),Hi=ma.fromImageSource({image:Bs.overlay,grid:{rows:10,columns:10,spriteHeight:16,spriteWidth:16}}),Fo=ma.fromImageSource({image:Bs.purpleGuy,grid:{rows:1,columns:4,spriteHeight:32,spriteWidth:32}}),bf=new Dv;for(let d of Object.values(Bs))bf.addResource(d);function Cc(d,t,i){const n=d%t,o=Math.floor(d/t);return n===0||n===t-1||o===0||o===i-1}function qv(d,t,i){const n=d%t,o=Math.floor(d/t);return n===1||n===t-2||o===1||o===i-2}function Xv(d){return Math.floor(55+d*25)}function Yv(d){const t=Math.max(3,Math.floor(d/15));let i=Array.from({length:t},(f,g)=>g+1);const n=i.reduce((f,g)=>f+g,0);let o=i.map(f=>Math.floor(f/n*d)),h=o.reduce((f,g)=>f+g,0),c=d-h;for(;c!==0;)for(let f=o.length-1;f>=0&&c!==0;f--)o[f]+=c>0?1:-1,c+=c>0?-1:1;return o}const Lo=new vf({pos:Dt(0,0),tileWidth:34,tileHeight:17,columns:6,rows:6});let yu=0;for(const d of Lo.tiles)Cc(yu,Lo.columns,Lo.rows)?(d.solid=!0,d.addCollider(wf.Polygon([Dt(0,26),Dt(34/2,9-17/2+17),Dt(34,26),Dt(34/2,9+17/2+17)]))):d.addGraphic(Vv.getSprite(0,0)),yu++;function jv(d){return Dt(0,d.rows*d.tileHeight/2)}Lo.updateColliders();class yf extends gf{config={updateInterval:100,moveTolerance:5,deadZone:10,maxDistance:100,autoRecenter:!0,recenterThreshold:90};upHandler;downHandler;moveHandler;cancelHandler;gestureStartPos=De.Zero;currentPos=De.Zero;moveDelta=De.Zero;lastDirection={x:0,y:0};isActive=!1;isDown=!1;lastEvent=null;updateInterval=null;lastState="idle";onJoystickChange=null;onAdd(t){this.owner=t}init(t={},i){if(this.config={...this.config,...t},i&&(this.onJoystickChange=i),!this.owner)return;const n=this.owner.scene?.engine.input.pointers.primary;n&&(this.downHandler=n.on("down",o=>this.onDown(o)),this.moveHandler=n.on("move",o=>this.onMove(o)),this.upHandler=n.on("up",o=>this.onUp(o)),this.notifyJoystickChange("idle"))}onRemove(){this.upHandler?.remove(),this.downHandler?.remove(),this.moveHandler?.remove(),this.cancelHandler?.remove(),this.clearUpdateInterval()}onDown(t){this.gestureStartPos=t.worldPos.clone(),this.currentPos=t.worldPos.clone(),this.moveDelta=De.Zero,this.lastDirection={x:0,y:0},this.isActive=!0,this.isDown=!0,this.lastEvent=t,this.clearUpdateInterval(),this.updateInterval=window.setInterval(()=>{this.processJoystickState()},this.config.updateInterval)}onMove(t){if(this.isDown&&(this.currentPos=t.worldPos.clone(),this.moveDelta=this.currentPos.sub(this.gestureStartPos),this.lastEvent=t,this.config.autoRecenter&&this.lastState==="active")){const i=this.moveDelta.magnitude;if(i>=this.config.deadZone){const n={x:this.moveDelta.x/i,y:this.moveDelta.y/i};if(Math.abs(this.lastDirection.x)>.01||Math.abs(this.lastDirection.y)>.01){const o=this.lastDirection.x*n.x+this.lastDirection.y*n.y;if(Math.acos(Math.max(-1,Math.min(1,o)))*(180/Math.PI)>this.config.recenterThreshold){const c=Math.min(i,this.config.maxDistance/2),f=new De(n.x*c,n.y*c);this.gestureStartPos=this.currentPos.sub(f),this.moveDelta=f,this.lastDirection=n}}}}}onUp(t){this.isDown&&(this.isDown=!1,this.isActive=!1,this.moveDelta=De.Zero,this.lastDirection={x:0,y:0},this.lastEvent=null,this.clearUpdateInterval(),this.notifyJoystickChange("idle"))}clearUpdateInterval(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null)}processJoystickState(){if(!this.isDown||!this.isActive)return;const t=this.moveDelta.magnitude;let i="idle";t>=this.config.deadZone&&(i="active");const n=Math.min(t,this.config.maxDistance);let o={x:0,y:0};t>0&&(o={x:this.moveDelta.x/t,y:this.moveDelta.y/t},this.lastDirection=o),(i!==this.lastState||i==="active")&&this.notifyJoystickChange(i,o,n),this.lastState=i}notifyJoystickChange(t,i={x:0,y:0},n=0){this.onJoystickChange&&this.onJoystickChange({direction:i,distance:n,state:t,rawEvent:this.lastEvent||void 0})}getJoystickState(){const t=this.moveDelta.magnitude,i=this.isDown&&t>=this.config.deadZone?"active":"idle";let n={x:0,y:0};return t>0&&(n={x:this.moveDelta.x/t,y:this.moveDelta.y/t}),{direction:n,distance:Math.min(t,this.config.maxDistance),state:i,rawEvent:this.lastEvent||void 0}}drawJoystick(t){if(!this.isDown)return;const i=this.gestureStartPos.x,n=this.gestureStartPos.y,o=this.currentPos.x,h=this.currentPos.y;t.beginPath(),t.arc(i,n,this.config.maxDistance,0,Math.PI*2),t.strokeStyle="rgba(255,255,255,0.5)",t.lineWidth=2,t.stroke(),t.beginPath(),t.moveTo(i,n),t.lineTo(o,h),t.strokeStyle="rgba(255,255,255,0.7)",t.lineWidth=3,t.stroke(),t.beginPath(),t.arc(o,h,20,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.8)",t.fill()}update(t,i){}}const Af=new ga("weapons",4,2),Zv=new ga("enemy",2,5),Cf=new ga("player",1,10),Tf=new ga("drops",8,1);class Pf extends Dr{constructor(t,i,n){const o=new Jo({width:t.x,height:t.y,color:Fe.Green}),h=new Jo({width:t.x,height:t.y,color:Fe.Red});super({name:"outerHealthBar",width:t.x,height:t.y,pos:i,z:1}),this.dims=t,this.position=i,this.maxVal=n,this.graphics.use(h),this.percent=100,this.child=new Dr({name:"innerHealthBar",width:t.x,height:t.y,pos:new De(0,0),z:1}),this.child.graphics.use(o),this.addChild(this.child)}percent;child;setPercent(t){this.percent=t,this.percent<0&&(this.percent=0),this.percent>100&&(this.percent=100),this.child.scale.x=this.percent/100,this.child.scale.y=1}}class gs{controller;signalName;sender;callback;constructor(t,i){this.signalName=t,i?this.sender=i:this.sender=""}send(t){let i;t?i=new CustomEvent(this.signalName,{detail:{who:this.sender,params:[...t]}}):i=new CustomEvent(this.signalName,{detail:{who:this.sender}}),document.dispatchEvent(i)}listen(t){this.callback=t,this.controller=new AbortController,document.addEventListener(this.signalName,i=>{this.callback&&this.callback(i)},{signal:this.controller.signal})}stopListening(){this.controller&&this.controller.abort(),this.controller=null}}const $v=300;class Qv extends un{damage;UISignal=new gs("stateUpdate");constructor(t,i,n){super({radius:2,color:Fe.Yellow,pos:t,anchor:De.Half,z:1e3,collisionType:_n.Passive,collisionGroup:Af}),this.damage=n,this.vel=i.pos.sub(this.pos).normalize().scale($v)}onCollisionStart(t,i,n,o){if(i.owner instanceof Mr){const h=i.owner;this.UISignal.send(["enemyDefeated",h.affinity]),h.checkDrop(),this.scene.enemyWaveManager?.enemyPool?.return(h),this.scene?.remove(h),this.kill()}}}class Sf extends un{constructor(t){super({radius:3,color:Fe.fromHex("#EEEEEE"),pos:t,collisionType:_n.Passive,collisionGroup:Tf,z:1e3})}}class Ef extends un{constructor(t){super({radius:3,color:Fe.fromHex("#050505"),pos:t,collisionType:_n.Passive,collisionGroup:Tf,z:1e3})}}class If extends gf{_heldKeys=[];_keyEnable=!1;constructor(){super()}onAdd(t){this.owner=t}init(){window.addEventListener("keydown",t=>{if(!this._heldKeys.includes(t.key)){if(!this.keyEnable)return;this._heldKeys.push(t.key)}}),window.addEventListener("keyup",t=>{this.keyEnable||(this.keyEnable=!0);const i=this._heldKeys.indexOf(t.key);i>-1&&this._heldKeys.splice(i,1)})}get keys(){return this._heldKeys}set keyEnable(t){this._keyEnable=t}get keyEnable(){return this._keyEnable}onRemove(t){window.removeEventListener("keydown",this.init),window.removeEventListener("keyup",this.init)}update(t,i){}}class Rf extends un{currentHP=20;maxHP=20;exp=0;isPlayerActive=!1;jc=new yf;kc=new If;partner;HealthBar;fireIntervalHandler;isJoystickActive=!0;isKeyboardActive=!1;UISignal=new gs("stateUpdate");speed=100;fireInterval=6e3;fireRange=100;fireDamage=1;constructor(){super({radius:10,color:Fe.White,pos:Dt(0,0),anchor:De.Half,z:1e3,collisionType:_n.Active,collisionGroup:Cf}),this.addComponent(this.jc),this.HealthBar=new Pf(new De(20,2),new De(-10,-15),20),this.addChild(this.HealthBar),this.fireIntervalHandler=setInterval(this.fire.bind(this),this.fireInterval)}onInitialize(t){this.jc.init({updateInterval:50,deadZone:15},i=>{this.isPlayerActive&&(i.state==="active"?(this.vel.x=i.direction.x*this.speed,this.vel.y=i.direction.y*this.speed):(this.vel.x=0,this.vel.y=0))}),this.kc.init()}onCollisionStart(t,i,n,o){i.owner instanceof Sf&&(i.owner.kill(),this.UISignal.send(["blessing"]),this.exp+=1)}registerPartner(t){this.partner=t,this.pos=t.pos.clone().add(Dt(0,-50))}fire(){let t=this.scene?.entities.filter(o=>o instanceof Mr),i,n=1/0;for(const o of t){let h=o,c=this.pos.distance(h.pos);c<n&&(n=c,i=h)}if(i){let o=new Qv(this.pos,i,this.fireDamage);this.scene?.add(o)}}onPreUpdate(t,i){const o=this.actions.getQueue().getActions().find(h=>h instanceof mf);if(!this.isPlayerActive&&this.partner&&this.partner.pos.distance(this.pos)>25&&!o?this.actions.follow(this.partner,50):this.isPlayerActive&&o&&this.actions.clearActions(),this.HealthBar?.setPercent(this.currentHP/this.maxHP*100),this.kc.keyEnable&&(this.isKeyboardActive=!0,this.isJoystickActive=!1),this.isPlayerActive&&this.isKeyboardActive){let h=this.kc.keys;h.includes("ArrowLeft")?this.vel.x=-this.speed:h.includes("ArrowRight")&&(this.vel.x=this.speed),h.includes("ArrowUp")?this.vel.y=-this.speed:h.includes("ArrowDown")&&(this.vel.y=this.speed),!h.includes("ArrowLeft")&&!h.includes("ArrowRight")&&(this.vel.x=0),!h.includes("ArrowUp")&&!h.includes("ArrowDown")&&(this.vel.y=0)}this.currentHP<=0&&(this.isPlayerActive&&this.scene.switchPlayerFocus(),this.fireIntervalHandler&&clearInterval(this.fireIntervalHandler),this.kill())}}const Kv=new Sv({strategy:Ev.Loop,frames:[{graphic:Fo.getSprite(0,0),duration:100},{graphic:Fo.getSprite(1,0),duration:100},{graphic:Fo.getSprite(2,0),duration:100},{graphic:Fo.getSprite(3,0),duration:100}]}),Xh=25,Au=new qn(Date.now()),Cu=new In({useAnchor:!0,members:[{graphic:Bs.purpleShadow.toSprite(),offset:Dt(0,0)},{graphic:Kv,offset:Dt(0,0)}]}),Jv=new pf({radius:7.5,color:Fe.Red,strokeColor:Fe.fromHex("#000000"),lineWidth:2}),tw=new pf({radius:7.5,color:Fe.Red,strokeColor:Fe.fromHex("#FFFFFF"),lineWidth:2});class Mr extends un{affinity="dark";lightTarget;darkTarget;currentTarget=void 0;constructor(t,i,n){super({radius:7.5,pos:t,anchor:De.Half,z:1e3,collisionType:_n.Active,collisionGroup:Zv}),this.lightTarget=i,this.darkTarget=n,this.graphics.add(Cu)}onCollisionStart(t,i,n,o){(i.owner instanceof Df||i.owner instanceof Rf)&&(this.scene.enemyWaveManager?.enemyPool?.return(this),this.scene?.remove(this),i.owner.currentHP-=2)}onInitialize(){}reset(){this.graphics.getNames().forEach(i=>this.graphics.remove(i)),Au.bool()?(this.affinity="light",this.graphics.add(tw)):(this.affinity="dark",this.graphics.add(Jv))}checkDrop(){if(Au.integer(0,100)<40){if(!this.scene)return;this.affinity=="dark"?this.scene.add(new Ef(this.pos)):this.scene.add(new Sf(this.pos))}}onPreUpdate(t,i){this.graphics.add(Cu);const o=this.actions.getQueue().getActions().find(c=>c instanceof Mv);let h;if(o)this.scene?.entities?.find(g=>g==this.currentTarget)||(this.lightTarget&&this.darkTarget?h=this.lightTarget.pos.distance(this.pos)<this.darkTarget.pos.distance(this.pos)?this.lightTarget:this.darkTarget:this.lightTarget?h=this.lightTarget:h=this.darkTarget,this.currentTarget=h,this.actions.clearActions(),this.actions.meet(h,Xh));else{if(this.lightTarget&&this.darkTarget?h=this.lightTarget.pos.distance(this.pos)<this.darkTarget.pos.distance(this.pos)?this.lightTarget:this.darkTarget:this.lightTarget?h=this.lightTarget:this.darkTarget&&(h=this.darkTarget),!h)return;this.currentTarget=h,this.actions.meet(h,Xh)}if(this.lightTarget&&this.darkTarget){let c=this.lightTarget.pos.distance(this.pos)<this.darkTarget.pos.distance(this.pos)?this.lightTarget:this.darkTarget;this.actions.meet(c,Xh)}}}let ew=.15;class iw extends un{angle=0;radius=20;angVel=ew;UISignal=new gs("stateUpdate");constructor(t){super({width:12,height:3,color:Fe.LightGray,pos:Dt(0,0).add(Dt(20,0)),rotation:Bv(0),collisionType:_n.Passive,collisionGroup:Af})}onCollisionStart(t,i,n,o){if(i.owner instanceof Mr){let h=i.owner;this.UISignal.send(["enemyDefeated",h.affinity]),h.checkDrop(),this.scene.enemyWaveManager?.enemyPool?.return(h),this.scene?.remove(h)}}onPreUpdate(t,i){this.angle+=this.angVel,this.angle>=Math.PI*2&&(this.angle=Math.PI*2,this.kill());const n=this.radius*Math.cos(this.angle),o=this.radius*Math.sin(this.angle);this.pos.setTo(n,o),this.rotation=this.angle}}class Df extends un{currentHP=20;maxHP=20;isPlayerActive=!0;partner;jc=new yf;kc=new If;HealthBar;speed=80;exp=0;fireIntervalHandler;fireInterval=2e3;fireDamage=3;isJoystickActive=!0;isKeyboardActive=!1;UISignal=new gs("stateUpdate");constructor(){super({radius:10,color:Fe.Black,pos:Dt(0,0),anchor:De.Half,z:1e3,collisionType:_n.Active,collisionGroup:Cf}),this.addComponent(this.jc),this.HealthBar=new Pf(new De(20,2),new De(-10,-15),20),this.addChild(this.HealthBar),this.fireIntervalHandler=setInterval(this.fire.bind(this),this.fireInterval)}onInitialize(t){this.jc.init({updateInterval:50,deadZone:15},i=>{!this.isPlayerActive||!this.isJoystickActive||(i.state==="active"?(this.vel.x=i.direction.x*this.speed,this.vel.y=i.direction.y*this.speed):(this.vel.x=0,this.vel.y=0))}),this.kc.init(),this.scene&&(this.scene.camera.strategy.lockToActor(this),this.scene.camera.zoom=1.5)}onCollisionStart(t,i,n,o){i.owner instanceof Ef&&(this.exp+=1,this.UISignal.send(["soul"]),i.owner.kill())}registerPartner(t){this.partner=t}fire(){let t=new iw(this.pos);this.addChild(t)}onPreUpdate(t,i){const o=this.actions.getQueue().getActions().find(h=>h instanceof mf);if(!this.isPlayerActive&&this.partner&&this.partner.pos.distance(this.pos)>25&&!o?this.actions.follow(this.partner,50):this.isPlayerActive&&o&&this.actions.clearActions(),this.HealthBar?.setPercent(this.currentHP/this.maxHP*100),this.kc.keyEnable&&(this.isKeyboardActive=!0,this.isJoystickActive=!1),this.isPlayerActive&&this.isKeyboardActive){let h=this.kc.keys;h.includes("ArrowLeft")?this.vel.x=-this.speed:h.includes("ArrowRight")&&(this.vel.x=this.speed),h.includes("ArrowUp")?this.vel.y=-this.speed:h.includes("ArrowDown")&&(this.vel.y=this.speed),!h.includes("ArrowLeft")&&!h.includes("ArrowRight")&&(this.vel.x=0),!h.includes("ArrowUp")&&!h.includes("ArrowDown")&&(this.vel.y=0)}this.currentHP<=0&&(this.isPlayerActive&&this.scene.switchPlayerFocus(),this.fireIntervalHandler&&clearInterval(this.fireIntervalHandler),this.kill())}}class sw{constructor(t,i,n=1){this.builder=t,this.cleaner=i,this.grow(n)}_pool=[];_size=0;grow(t){if(t>0){this._size+=t;for(let i=0;i<t;i++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}}class nw{rng=new qn(Date.now());getSpawnPositions(t,i){console.log("random");let n=[];for(let o=0;o<t;o++){let h=this.getRandomTile(i);n.push({x:h.x,y:h.y})}return n}getRandomTile(t){let i=t.columns*t.rows,n=this.rng.integer(0,i-1);for(;Cc(n,t.columns,t.rows);)n=this.rng.integer(0,i-1);return t.tiles[n].pos.clone()}}class rw{getSpawnPositions(t,i){console.log("circle");let n=i.columns,o=i.rows;const h=Math.ceil(n/2),c=Math.ceil(o/2),f=n/2-2;let g=[];for(let v=0;v<t;v++){const x=2*Math.PI*v/t,b=Math.floor(h+Math.cos(x)*f),P=Math.floor(c+Math.sin(x)*f)*n+b,I=i.tiles[P].pos.clone();g.push({x:I.x,y:I.y})}return g}}class ow{rng=new qn(Date.now());getSpawnPositions(t,i){console.log("edges");const n=[],o=i.tiles.filter((h,c)=>qv(c,i.columns,i.rows));for(let h=0;h<t;h++){const c=this.rng.pickOne(o);c&&n.push({x:c.pos.x,y:c.pos.y})}return n}}class aw{rng=new qn;getSpawnPositions(t,i){console.log("cluster");const n=[],o={tl:{x:Math.floor(i.columns/4),y:Math.floor(i.rows/4)},tr:{x:Math.floor(i.columns/4)*3,y:Math.floor(i.rows/4)},bl:{x:Math.floor(i.columns/4),y:Math.floor(i.rows/4)*3},br:{x:Math.floor(i.columns/4)*3,y:Math.floor(i.rows/4)*3}},h=["tl","tr","bl","br"],c=this.rng.pickOne(h),f=o[c],g=f.x,v=f.y,x=Math.floor(Math.sqrt(i.tiles.length)/4);for(let b=0;b<t;b++){let T=this.rng.integer(-x/2,x/2),P=this.rng.integer(-x/2,x/2),I=g+T;const R=(v+P)*i.columns+I,S=i.tiles[R];S&&n.push({x:S.pos.x,y:S.pos.y})}return n}}class hw{getSpawnPositions(t){return Array.from({length:t},()=>({x:Math.random()*800+800,y:Math.random()*600}))}}let Tu=18e3,lw=5;const cw={RANDOM:"RANDOM"},Yh={RANDOM:new nw,CIRCLE:new rw,EDGES:new ow,CLUSTER:new aw,RANDOM_OFFSCREEN:new hw};class dw{enemyPool;rng;lightPlayer;darkPlayer;spawnInterval=Tu;spawnEnabled=!1;scene;stateSignal=new gs("stateUpdate");burnDown=new gs("burnDown");map;enemyCount=0;waveNumber=0;batchSize=[];batchIndex=0;spawnStrategy=cw.RANDOM;lastBatchSpawnedFlag=!1;WaveTimer;isWaveActive=!1;duration=0;isStartDelayConsumed=!1;constructor(t,i,n,o){this.rng=new qn(Date.now()),this.lightPlayer=i,this.darkPlayer=n,this.scene=t,this.map=o,this.WaveTimer=setInterval(this.waveTik,1e3)}init(){this.enemyPool=new sw(this.makeEnemy,this.cleanUpEnemy,500),this.isWaveActive=!0}waveTik=()=>{this.isWaveActive&&(this.duration+=1,!this.isStartDelayConsumed&&this.duration>=lw&&(this.isStartDelayConsumed=!0,this.spawnEnemies()),this.isStartDelayConsumed&&(this.stateSignal.send(["waveDuration",this.duration]),this.burnDown.send()))};startWave(){this.waveNumber+=1,this.isWaveActive=!0,this.spawnEnabled=!0,this.duration=0,this.isStartDelayConsumed=!1,this.enemyCount=Xv(this.waveNumber),this.batchSize=Yv(this.enemyCount),this.spawnStrategy=this.rng.pickOne(Object.keys(Yh)),this.lastBatchSpawnedFlag=!1}endWave(){this.spawnEnabled=!1,this.isWaveActive=!1,this.duration=0,this.isStartDelayConsumed=!1}spawnEnemies(){if(this.lastBatchSpawnedFlag){this.scene.entities.filter(o=>o instanceof Mr).length==0&&this.endWave();return}let t=Yh[this.spawnStrategy].getSpawnPositions(this.batchSize[this.batchIndex],this.map);this.batchIndex+=1,this.spawnStrategy=this.rng.pickOne(Object.keys(Yh)),this.batchIndex==this.batchSize.length&&(this.lastBatchSpawnedFlag=!0);for(let i=0;i<t.length;i++){let n=t[i];if(n===void 0)continue;let o=this.map?.tiles.find(c=>c.pos.x===n.x&&c.pos.y===n.y);if(!o)continue;let h=this.enemyPool?.rent(!0);h.pos=o.pos.clone(),this.scene.add(h)}}makeEnemy=()=>new Mr(Dt(0,0),this.lightPlayer,this.darkPlayer);cleanUpEnemy(t){return t.reset(),t}update(t){this.spawnEnabled&&this.isStartDelayConsumed&&(this.spawnInterval-=t,this.spawnInterval<=0&&(this.spawnInterval=Tu,this.spawnEnemies()))}}class uw extends Dr{constructor(t){super({name:"StatusBar",width:t.x,height:15,x:0,y:0,color:Fe.Black,opacity:.5,z:999}),this.dims=t,this.timeLabel=new Vh({text:Pu(this.time),font:new Gh({size:12,family:"Arial",color:Fe.White,textAlign:qh.Center}),x:this.pos.x+this.width/2,y:0}),this.addChild(this.timeLabel),this.whiteKills=new Vh({anchor:De.Zero,text:`Light Kills: ${this.whites}`,font:new Gh({size:12,family:"Arial",color:Fe.White,textAlign:qh.Center}),x:this.pos.x+100,y:0}),this.addChild(this.whiteKills),this.blackKills=new Vh({anchor:De.Zero,text:`Dark Kills: ${this.blacks}`,font:new Gh({size:12,family:"Arial",color:Fe.White,textAlign:qh.Center}),x:0,y:0}),this.addChild(this.blackKills);let i=this.blackKills.getTextWidth();this.blackKills.pos.x=t.x-i;let n=this.timeLabel.getTextWidth();this.timeLabel.pos.x=this.width/2-n/2}time=0;whites=0;blacks=0;souls=0;blessings=0;timeLabel;whiteKills;blackKills;updateSignal=new gs("stateUpdate");onInitialize(t){this.updateSignal.listen(this.UIUpdate.bind(this))}onPreUpdate(t,i){let n=this.timeLabel.getTextWidth();this.timeLabel.pos.x=this.width/2-n/2,this.whiteKills.text=`Light Kills: ${this.whites}  Blessings: ${this.blessings}`,this.blackKills.text=`Dark Kills: ${this.blacks} Souls: ${this.souls}`;let o=this.blackKills.getTextWidth();this.blackKills.pos.x=this.width-5-o}UIUpdate(t){const[i,n]=t.detail.params;i==="waveDuration"?(this.time=n,this.timeLabel.text=Pu(this.time)):i==="enemyDefeated"?(n==="light"&&(this.whites+=1),n==="dark"&&(this.blacks+=1)):i=="soul"?this.souls++:i=="blessing"&&this.blessings++}}function Pu(d){const t=Math.floor(d/60),i=d%60;return`Time: ${t}:${i.toString().padStart(2,"0")}`}class _w extends Dr{constructor(t,i,n,o){const h=new Jo({width:t.x,height:t.y,color:Fe.Green}),c=new Jo({width:t.x,height:t.y,color:Fe.Red});super({name:"burnDownBar",width:t.x,height:t.y,pos:i,z:1001}),this.dims=t,this.position=i,this.graphics.use(c),this.percent=n,this.scene=o,this.currentVal=n,this.maxVal=n,this.child=new Dr({name:"innerHealthBar",width:t.x,height:t.y,pos:new De(0,0),z:1}),this.child.graphics.use(h),this.addChild(this.child),this.burnDownSignal.listen(()=>{this.currentVal--,this.percent=this.currentVal/this.maxVal*100,this.percent<0&&(this.percent=0),this.percent>100&&(this.percent=100),this.child.scale.x=this.percent/100,this.child.scale.y=1,this.percent<=0&&(this.scene.switchPlayerFocus(),this.currentVal=this.maxVal,this.percent=100,this.child.scale.x=this.percent/100,this.child.scale.y=1)})}burnDownSignal=new gs("burnDown");currentVal;maxVal;percent;child;scene}var jh={exports:{}},Zh={exports:{}};/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var Su;function fw(){return Su||(Su=1,function(d,t){(function(n,o){d.exports=o()})(self,()=>(()=>{var i={851:(u,e,s)=>{s.d(e,{A:()=>m});var r=s(1),a=s.n(r),l=s(935),_=s.n(l),p=_()(a());p.push([u.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const m=p},296:(u,e,s)=>{s.d(e,{A:()=>m});var r=s(1),a=s.n(r),l=s(935),_=s.n(l),p=_()(a());p.push([u.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const m=p},935:u=>{u.exports=function(e){var s=[];return s.toString=function(){return this.map(function(a){var l="",_=typeof a[5]<"u";return a[4]&&(l+="@supports (".concat(a[4],") {")),a[2]&&(l+="@media ".concat(a[2]," {")),_&&(l+="@layer".concat(a[5].length>0?" ".concat(a[5]):""," {")),l+=e(a),_&&(l+="}"),a[2]&&(l+="}"),a[4]&&(l+="}"),l}).join("")},s.i=function(a,l,_,p,m){typeof a=="string"&&(a=[[null,a,void 0]]);var w={};if(_)for(var y=0;y<this.length;y++){var A=this[y][0];A!=null&&(w[A]=!0)}for(var E=0;E<a.length;E++){var D=[].concat(a[E]);_&&w[D[0]]||(typeof m<"u"&&(typeof D[5]>"u"||(D[1]="@layer".concat(D[5].length>0?" ".concat(D[5]):""," {").concat(D[1],"}")),D[5]=m),l&&(D[2]&&(D[1]="@media ".concat(D[2]," {").concat(D[1],"}")),D[2]=l),p&&(D[4]?(D[1]="@supports (".concat(D[4],") {").concat(D[1],"}"),D[4]=p):D[4]="".concat(p)),s.push(D))}},s}},1:u=>{u.exports=function(e){var s=e[1],r=e[3];if(!r)return s;if(typeof btoa=="function"){var a=btoa(unescape(encodeURIComponent(JSON.stringify(r)))),l="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),_="/*# ".concat(l," */");return[s].concat([_]).join(`
`)}return[s].join(`
`)}}},n={};function o(u){var e=n[u];if(e!==void 0)return e.exports;var s=n[u]={id:u,exports:{}};return i[u](s,s.exports,o),s.exports}o.n=u=>{var e=u&&u.__esModule?()=>u.default:()=>u;return o.d(e,{a:e}),e},o.d=(u,e)=>{for(var s in e)o.o(e,s)&&!o.o(u,s)&&Object.defineProperty(u,s,{enumerable:!0,get:e[s]})},o.o=(u,e)=>Object.prototype.hasOwnProperty.call(u,e),o.r=u=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(u,"__esModule",{value:!0})};var h={};o.r(h),o.d(h,{ActionCompleteEvent:()=>Za,ActionContext:()=>ar,ActionQueue:()=>Gc,ActionSequence:()=>Fh,ActionStartEvent:()=>ja,ActionsComponent:()=>yn,ActionsSystem:()=>yh,ActivateEvent:()=>Na,Actor:()=>qe,ActorEvents:()=>Up,AddEvent:()=>$a,AddedComponent:()=>up,AffineMatrix:()=>he,Animation:()=>xi,AnimationDirection:()=>$n,AnimationEvents:()=>hp,AnimationStrategy:()=>wi,ArcadeSolver:()=>gh,AudioContextFactory:()=>tr,Axes:()=>Ph,Axis:()=>mo,BaseAlign:()=>Jr,BezierCurve:()=>or,Blink:()=>ud,BodyComponent:()=>At,BoundingBox:()=>at,BrowserComponent:()=>Ih,BrowserEvents:()=>Yd,Buttons:()=>dr,Camera:()=>Id,CameraEvents:()=>Op,Canvas:()=>co,Circle:()=>fo,CircleCollider:()=>Le,Clock:()=>Rh,ClosestLineJumpTable:()=>Bi,Collider:()=>ys,ColliderComponent:()=>de,CollisionContact:()=>Xs,CollisionEndEvent:()=>Jn,CollisionGroup:()=>ts,CollisionGroupManager:()=>Fi,CollisionJumpTable:()=>yi,CollisionPostSolveEvent:()=>ao,CollisionPreSolveEvent:()=>oo,CollisionStartEvent:()=>Kn,CollisionSystem:()=>wo,CollisionType:()=>dt,Color:()=>$,ColorBlindFlags:()=>qd,ColorBlindnessMode:()=>js,ColorBlindnessPostProcessor:()=>Vd,Component:()=>_i,CompositeCollider:()=>we,ConsoleAppender:()=>pi,ContactConstraintPoint:()=>Ld,ContactEndEvent:()=>ro,ContactSolveBias:()=>es,ContactStartEvent:()=>no,CoordPlane:()=>Pe,CrossFade:()=>xg,CurveBy:()=>vd,CurveTo:()=>md,DeactivateEvent:()=>Ga,Debug:()=>xe,DebugConfig:()=>Xd,DebugGraphicsComponent:()=>go,DebugSystem:()=>wh,DebugText:()=>wa,DefaultAntialiasOptions:()=>jd,DefaultGarbageCollectionOptions:()=>Mh,DefaultLoader:()=>er,DefaultPixelArtOptions:()=>Zd,DegreeOfFreedom:()=>Qe,Delay:()=>fd,Detector:()=>Wc,Die:()=>pd,Direction:()=>eo,Director:()=>Jd,DirectorEvents:()=>Zp,DisplayMode:()=>ve,DynamicTree:()=>nh,DynamicTreeCollisionProcessor:()=>_o,EX_VERSION:()=>Hh,EaseBy:()=>dd,EaseTo:()=>cd,EasingFunctions:()=>Ot,EdgeCollider:()=>si,ElasticToActorStrategy:()=>Pd,EmitterType:()=>Ps,Engine:()=>Ke,EngineEvents:()=>$p,EnterTriggerEvent:()=>Xa,EnterViewPortEvent:()=>qa,Entity:()=>ke,EntityEvents:()=>gp,EntityManager:()=>Dd,EventEmitter:()=>I,EventTypes:()=>io,Events:()=>g,ExResponse:()=>th,ExcaliburGraphicsContext2DCanvas:()=>lo,ExcaliburGraphicsContextWebGL:()=>Ji,ExitTriggerEvent:()=>Ya,ExitViewPortEvent:()=>Va,Fade:()=>_d,FadeInOut:()=>wg,Flags:()=>b,Flash:()=>gd,Follow:()=>uh,Font:()=>Hs,FontCache:()=>Ft,FontSource:()=>mg,FontStyle:()=>to,FontUnit:()=>Qr,FpsSampler:()=>$d,FrameStats:()=>pr,Future:()=>P,GameEvent:()=>mt,GameStartEvent:()=>Ea,GameStopEvent:()=>Ia,Gamepad:()=>yo,GamepadAxisEvent:()=>Ha,GamepadButtonEvent:()=>za,GamepadConnectEvent:()=>La,GamepadDisconnectEvent:()=>Ua,Gamepads:()=>bo,GarbageCollector:()=>iu,Gif:()=>pg,GifParser:()=>ru,GlobalCoordinates:()=>An,GpuParticleEmitter:()=>tg,GpuParticleRenderer:()=>To,Graphic:()=>Qt,GraphicsComponent:()=>Jt,GraphicsGroup:()=>pn,GraphicsSystem:()=>vh,HashColliderProxy:()=>Ud,HashGridCell:()=>Ui,HashGridProxy:()=>xh,HiddenEvent:()=>Wa,HorizontalFirst:()=>oh,ImageFiltering:()=>le,ImageSource:()=>Di,ImageSourceAttributeConstants:()=>Et,ImageWrapping:()=>Vt,InitializeEvent:()=>xn,InputHost:()=>Eh,InputMapper:()=>Hd,IsometricEntityComponent:()=>cr,IsometricEntitySystem:()=>Ah,IsometricMap:()=>eg,IsometricTile:()=>su,KeyEvent:()=>_r,Keyboard:()=>Wd,Keys:()=>ur,KillEvent:()=>so,Label:()=>Qp,LimitCameraBoundsStrategy:()=>Ed,Line:()=>kh,LineSegment:()=>re,Loader:()=>Vs,LoaderEvents:()=>Pp,LockCameraToActorAxisStrategy:()=>Td,LockCameraToActorStrategy:()=>Cd,LogLevel:()=>Ht,Logger:()=>ot,Material:()=>Fc,Matrix:()=>ii,MatrixLocations:()=>va,MediaEvent:()=>eh,Meet:()=>_h,MotionComponent:()=>Rt,MotionSystem:()=>vo,MoveBy:()=>ch,MoveByWithOptions:()=>$c,MoveTo:()=>dh,MoveToWithOptions:()=>Kc,NativePointerButton:()=>Cs,NativeSoundEvent:()=>Gs,NativeSoundProcessedEvent:()=>zc,NineSlice:()=>Uh,NineSliceStretch:()=>rs,None:()=>ah,Observable:()=>Ne,OffscreenSystem:()=>Ch,Pair:()=>Ve,ParallaxComponent:()=>po,ParallelActions:()=>ig,Particle:()=>ho,ParticleEmitter:()=>Kp,ParticleRenderer:()=>Lc,ParticleTransform:()=>bi,PhysicsStats:()=>Co,PhysicsWorld:()=>zd,PointerAbstraction:()=>Sh,PointerButton:()=>ss,PointerComponent:()=>As,PointerEvent:()=>fr,PointerEventReceiver:()=>Ao,PointerScope:()=>F,PointerSystem:()=>xo,PointerType:()=>ns,Polygon:()=>Lh,PolygonCollider:()=>Se,Pool:()=>$r,PostCollisionEvent:()=>Ws,PostDebugDrawEvent:()=>Fa,PostDrawEvent:()=>wn,PostFrameEvent:()=>ka,PostKillEvent:()=>Sa,PostTransformDrawEvent:()=>Da,PostUpdateEvent:()=>bs,PreCollisionEvent:()=>Os,PreDebugDrawEvent:()=>Ma,PreDrawEvent:()=>vn,PreFrameEvent:()=>Ba,PreKillEvent:()=>Pa,PreLoadEvent:()=>qp,PreTransformDrawEvent:()=>Ra,PreUpdateEvent:()=>xs,Projection:()=>ir,QuadIndexBuffer:()=>Zn,QuadTree:()=>Tn,Query:()=>hr,QueryManager:()=>Md,RadiusAroundActorStrategy:()=>Sd,Random:()=>M,Raster:()=>gn,Ray:()=>qs,RealisticSolver:()=>mh,Rectangle:()=>nr,RemoveEvent:()=>Qa,RemovedComponent:()=>fp,Repeat:()=>Vc,RepeatForever:()=>qc,Resolution:()=>Ka,Resource:()=>Yn,ResourceEvents:()=>kf,RotateBy:()=>id,RotateByWithOptions:()=>ed,RotateTo:()=>td,RotateToWithOptions:()=>Jc,RotationType:()=>R,ScaleBy:()=>hd,ScaleByWithOptions:()=>ad,ScaleTo:()=>rd,ScaleToWithOptions:()=>nd,Scene:()=>li,SceneEvents:()=>Xp,Screen:()=>Ja,ScreenAppender:()=>Zi,ScreenElement:()=>fh,ScreenEvents:()=>yp,ScreenShader:()=>Gd,ScrollPreventionMode:()=>Ts,Semaphore:()=>Tg,SeparatingAxis:()=>ce,SeparationInfo:()=>Nc,Shader:()=>$e,Shape:()=>Ue,Side:()=>Pt,Slide:()=>bg,SolverStrategy:()=>sr,Sound:()=>Hc,SoundEvents:()=>Tp,SparseHashGrid:()=>bh,SparseHashGridCollisionProcessor:()=>Th,SpatialPartitionStrategy:()=>bn,Sprite:()=>mi,SpriteFont:()=>jr,SpriteSheet:()=>zs,StandardClock:()=>Dh,StateMachine:()=>uo,StrategyContainer:()=>Ad,Stream:()=>nu,System:()=>hi,SystemManager:()=>Bd,SystemPriority:()=>Li,SystemType:()=>ni,TagQuery:()=>lr,TestClock:()=>Qd,Text:()=>Qn,TextAlign:()=>Kr,TextureLoader:()=>Kt,Tile:()=>yd,TileMap:()=>bd,TileMapEvents:()=>Hp,TiledAnimation:()=>zh,TiledSprite:()=>jn,Timer:()=>Ys,Toaster:()=>Kd,Transform:()=>Ki,TransformComponent:()=>et,Transition:()=>So,TreeNode:()=>sh,Trigger:()=>Rd,TriggerEvents:()=>Wp,TwoPI:()=>W,Util:()=>v,Vector:()=>B,VectorView:()=>ya,VertexBuffer:()=>Mi,VertexLayout:()=>Qi,VerticalFirst:()=>rh,VisibleEvent:()=>Oa,WebAudio:()=>Ns,WebAudioInstance:()=>Uc,WheelDeltaMode:()=>Cn,WheelEvent:()=>Nd,World:()=>kd,approximatelyEqual:()=>q,assert:()=>Jp,canonicalizeAngle:()=>nt,clamp:()=>j,coroutine:()=>hu,createId:()=>T,frac:()=>U,getDefaultPhysicsConfig:()=>is,hasGraphicsTick:()=>Ta,hasOnAdd:()=>dg,hasOnInitialize:()=>og,hasOnPostUpdate:()=>cg,hasOnPreUpdate:()=>hg,hasOnRemove:()=>ug,hasPostDraw:()=>fg,hasPreDraw:()=>_g,has_add:()=>ng,has_initialize:()=>sg,has_postupdate:()=>lg,has_preupdate:()=>ag,has_remove:()=>rg,inverseLerp:()=>Yc,inverseLerpVector:()=>jc,isActor:()=>Lp,isAddedComponent:()=>_p,isComponentCtor:()=>kc,isLoaderConstructor:()=>ih,isMoveByOptions:()=>Zc,isMoveToOptions:()=>Qc,isRemovedComponent:()=>pp,isRotateByOptions:()=>kp,isRotateToOptions:()=>Bp,isScaleByOptions:()=>od,isScaleToOptions:()=>sd,isSceneConstructor:()=>zi,isScreenElement:()=>wd,isSystemConstructor:()=>Fd,lerp:()=>Xc,lerpAngle:()=>lh,lerpVector:()=>rr,maxMessages:()=>lu,nextActionId:()=>Bt,obsolete:()=>Ag,parseImageFiltering:()=>fn,parseImageWrapping:()=>vi,pixelSnapEpsilon:()=>ft,randomInRange:()=>yt,randomIntInRange:()=>St,range:()=>gt,remap:()=>ki,remapVector:()=>Fp,resetObsoleteCounter:()=>yg,sign:()=>V,toDegrees:()=>ht,toRadians:()=>xt,vec:()=>z,webgl:()=>c});var c={};o.r(c),o.d(c,{getAttributeComponentSize:()=>Dc,getAttributePointerType:()=>Mc,getGLTypeFromSource:()=>Rc,getGlTypeSizeBytes:()=>xa,getMaxShaderComplexity:()=>ba,isAttributeInSource:()=>Ic});var f={};o.r(f),o.d(f,{circle:()=>dp,line:()=>Aa,point:()=>lp,roundRect:()=>Ca,vector:()=>cp});var g={};o.r(g),o.d(g,{ActionCompleteEvent:()=>Za,ActionStartEvent:()=>ja,ActivateEvent:()=>Na,AddEvent:()=>$a,CollisionEndEvent:()=>Jn,CollisionPostSolveEvent:()=>ao,CollisionPreSolveEvent:()=>oo,CollisionStartEvent:()=>Kn,ContactEndEvent:()=>ro,ContactStartEvent:()=>no,DeactivateEvent:()=>Ga,EnterTriggerEvent:()=>Xa,EnterViewPortEvent:()=>qa,EventTypes:()=>io,ExitTriggerEvent:()=>Ya,ExitViewPortEvent:()=>Va,GameEvent:()=>mt,GameStartEvent:()=>Ea,GameStopEvent:()=>Ia,GamepadAxisEvent:()=>Ha,GamepadButtonEvent:()=>za,GamepadConnectEvent:()=>La,GamepadDisconnectEvent:()=>Ua,HiddenEvent:()=>Wa,InitializeEvent:()=>xn,KillEvent:()=>so,PostCollisionEvent:()=>Ws,PostDebugDrawEvent:()=>Fa,PostDrawEvent:()=>wn,PostFrameEvent:()=>ka,PostKillEvent:()=>Sa,PostTransformDrawEvent:()=>Da,PostUpdateEvent:()=>bs,PreCollisionEvent:()=>Os,PreDebugDrawEvent:()=>Ma,PreDrawEvent:()=>vn,PreFrameEvent:()=>Ba,PreKillEvent:()=>Pa,PreTransformDrawEvent:()=>Ra,PreUpdateEvent:()=>xs,RemoveEvent:()=>Qa,VisibleEvent:()=>Oa});var v={};o.r(v),o.d(v,{ConsoleAppender:()=>pi,DrawUtil:()=>f,EasingFunctions:()=>Ot,LogLevel:()=>Ht,Logger:()=>ot,Observable:()=>Ne,ScreenAppender:()=>Zi,addItemToArray:()=>Gr,contains:()=>Vr,delay:()=>qr,fail:()=>Tc,getPosition:()=>vs,isObject:()=>Xr,mergeDeep:()=>Yr,omit:()=>Pc,removeItemFromArray:()=>$i});function x(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(u){window.setInterval(u,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const e=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(s){return new Promise((r,a)=>{e.call(this,s,r,a)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(u){const e=Date.now();return setTimeout(function(){u({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-e))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(u){clearTimeout(u)})}class b{static useCanvasGraphicsContext(){b.enable("use-canvas-context")}static useLegacyImageRenderer(){b.enable("use-legacy-image-renderer")}static freeze(){b._FROZEN=!0}static _reset(){b._FROZEN=!1,b._FLAGS={}}static enable(e){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");b._FLAGS[e]=!0}static disable(e){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");b._FLAGS[e]=!1}static isEnabled(e){return!!b._FLAGS[e]}static show(){return Object.keys(b._FLAGS)}}b._FROZEN=!1,b._FLAGS={};function T(u,e){return{type:u,value:e}}class P{constructor(){this._isCompleted=!1,this.promise=new Promise((e,s)=>{this._resolver=e,this._rejecter=s})}get isCompleted(){return this._isCompleted}resolve(e){this._isCompleted||(this._isCompleted=!0,this._resolver(e))}reject(e){this._isCompleted||(this._isCompleted=!0,this._rejecter(e))}}class I{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(e,s){var r;return this._empty=!1,this._listeners[e]=(r=this._listeners[e])!==null&&r!==void 0?r:[],this._listeners[e].push(s),{close:()=>this.off(e,s)}}once(e,s){var r;return this._empty=!1,this._listenersOnce[e]=(r=this._listenersOnce[e])!==null&&r!==void 0?r:[],this._listenersOnce[e].push(s),{close:()=>this.off(e,s)}}off(e,s){var r,a;if(s){const l=(r=this._listeners[e])===null||r===void 0?void 0:r.filter(p=>p!==s);this._listeners[e]=l;const _=(a=this._listenersOnce[e])===null||a===void 0?void 0:a.filter(p=>p!==s);this._listenersOnce[e]=_}else delete this._listeners[e]}emit(e,s){if(this._empty||this._paused)return;const r=this._listeners[e];if(r)for(let l=0;l<r.length;l++)r[l](s);const a=this._listenersOnce[e];if(this._listenersOnce[e]=[],a)for(let l=0;l<a.length;l++)a[l](s);for(let l=0;l<this._pipes.length;l++)this._pipes[l].emit(e,s)}pipe(e){if(this===e)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(e),{close:()=>{const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}}}unpipe(e){const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var F;(function(u){u.Canvas="Canvas",u.Document="Document"})(F||(F={}));var R;(function(u){u.ShortestPath="shortest-path",u.LongestPath="longest-path",u.Clockwise="clockwise",u.CounterClockwise="counter-clockwise"})(R||(R={}));const S=4294967295;class M{constructor(e){this.seed=e,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(e||Date.now())>>>0;for(let s=1;s<this._n;s++){const r=this._mt[s-1]^this._mt[s-1]>>>this._w-2;this._mt[s]=(this._f*((r&4294901760)>>>16)<<16)+this._f*(r&65535)+s>>>0}this._index=this._n}_twist(){const e=[0,this._a];let s=0,r=0;for(;r<this._n-this._m;r++)s=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+this._m]^s>>>1^e[s&1]&S;for(;r<this._n-1;r++)s=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+(this._m-this._n)]^s>>>1^e[s&1]&S;s=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^s>>>1^e[s&1]&S,this._index=0}nextInt(){this._index>=this._n&&this._twist();let e=this._mt[this._index++];return e^=e>>>this._u,e^=e<<this._s&this._b,e^=e<<this._t&this._c,e^=e>>>this._l,e>>>0}next(){return this.nextInt()*(1/4294967296)}floating(e,s){return(s-e)*this.next()+e}integer(e,s){return Math.floor((s-e+1)*this.next()+e)}bool(e=.5){return this.next()<=e}pickOne(e){return e[this.integer(0,e.length-1)]}pickSet(e,s,r=!1){return r?this._pickSetWithDuplicates(e,s):this._pickSetWithoutDuplicates(e,s)}_pickSetWithoutDuplicates(e,s){if(s>e.length||s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(s===e.length)return e;const r=new Array(s);let a=0;const l=e.slice(0);for(;a<s;){const _=this.integer(0,l.length-1);r[a++]=l[_],l.splice(_,1)}return r}_pickSetWithDuplicates(e,s){if(s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const r=new Array(s);for(let a=0;a<s;a++)r[a]=this.pickOne(e);return r}shuffle(e){const s=e.slice(0);let r;for(let a=0;a<s.length-2;a++){const l=this.integer(a,s.length-1);r=s[a],s[a]=s[l],s[l]=r}return s}range(e,s,r){const a=new Array(e);for(let l=0;l<e;l++)a[l]=this.integer(s,r);return a}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const W=Math.PI*2;function U(u){return u>=0?u-Math.floor(u):u-Math.ceil(u)}function V(u){return u===0?0:u<0?-1:1}function j(u,e,s){return Math.min(Math.max(e,u),s)}function q(u,e,s){return Math.abs(u-e)<s}function nt(u){let e=u;if(u>=W)for(;e>=W;)e-=W;if(u<0)for(;e<0;)e+=W;return e}function ht(u){return 180/Math.PI*u}function xt(u){return u/180*Math.PI}const gt=(u,e)=>Array.from(new Array(e-u+1),(s,r)=>r+u);function yt(u,e,s=new M){return s?s.floating(u,e):u+Math.random()*(e-u)}function St(u,e,s=new M){return s?s.integer(u,e):Math.round(yt(u,e))}class B{static get Zero(){return new B(0,0)}static get One(){return new B(1,1)}static get Half(){return new B(.5,.5)}static get Up(){return new B(0,-1)}static get Down(){return new B(0,1)}static get Left(){return new B(-1,0)}static get Right(){return new B(1,0)}static fromAngle(e){return new B(Math.cos(e),Math.sin(e))}static isValid(e){return!(e==null||isNaN(e.x)||isNaN(e.y)||e.x===1/0||e.y===1/0||e.x===-1/0||e.y===-1/0)}static distance(e,s){return Math.sqrt(Math.pow(e.x-s.x,2)+Math.pow(e.y-s.y,2))}static min(e,s){return new B(Math.min(e.x,s.x),Math.min(e.y,s.y))}static max(e,s){return new B(Math.max(e.x,s.x),Math.max(e.y,s.y))}constructor(e,s){this._x=0,this._y=0,this._x=e,this._y=s}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}setTo(e,s){this.x=e,this.y=s}equals(e,s=B.EQUALS_EPSILON){return Math.abs(this.x-e.x)<=s&&Math.abs(this.y-e.y)<=s}distance(e){if(!e)return Math.sqrt(this.x*this.x+this.y*this.y);const s=this.x-e.x,r=this.y-e.y;return Math.sqrt(s*s+r*r)}squareDistance(e){e||(e=B.Zero);const s=this.x-e.x,r=this.y-e.y;return s*s+r*r}clampMagnitude(e){const s=this.magnitude,r=j(s,0,e);return this.magnitude=r,this}get size(){return this.distance()}set size(e){const s=this.normalize().scale(e);this.setTo(s.x,s.y)}get magnitude(){return this.distance()}set magnitude(e){this.normalize().scale(e,this)}normalize(){const e=this.distance();return e===0?B.Zero:new B(this.x/e,this.y/e)}average(e){return this.add(e).scale(.5)}scale(e,s){const r=s||new B(0,0);return e instanceof B?(r.x=this.x*e.x,r.y=this.y*e.y):(r.x=this.x*e,r.y=this.y*e),r}add(e,s){return s?(s.x=this.x+e.x,s.y=this.y+e.y,s):new B(this.x+e.x,this.y+e.y)}sub(e,s){const r=s||new B(0,0),a=this.x-e.x,l=this.y-e.y;return r.x=a,r.y=l,r}addEqual(e){return this.setTo(this.x+e.x,this.y+e.y),this}subEqual(e){return this.setTo(this.x-e.x,this.y-e.y),this}scaleEqual(e){return this.setTo(this.x*e,this.y*e),this}dot(e){return this.x*e.x+this.y*e.y}cross(e){if(e instanceof B)return this.x*e.y-this.y*e.x;if(typeof e=="number")return new B(e*this.y,-e*this.x)}static cross(e,s){return new B(-e*s.y,e*s.x)}perpendicular(){return new B(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return nt(Math.atan2(this.y,this.x))}angleBetween(e,s){const r=this.toAngle(),a=nt(e);let l=0,_=0;switch(a>r?l=a-r:l=(W-r+a)%W,_=(l-W)%W,s){case R.ShortestPath:return Math.abs(l)<Math.abs(_)?l:_;case R.LongestPath:return Math.abs(l)>Math.abs(_)?l:_;case R.Clockwise:return l;case R.CounterClockwise:return _}}rotate(e,s,r){const a=r||new B(0,0);s||(s=new B(0,0));const l=Math.sin(e),_=Math.cos(e),p=_*(this.x-s.x)-l*(this.y-s.y)+s.x,m=l*(this.x-s.x)+_*(this.y-s.y)+s.y;return a.x=p,a.y=m,a}clone(e){const s=e??new B(0,0);return s.x=this.x,s.y=this.y,s}toString(e){return e?`(${this.x.toFixed(e)}, ${this.y.toFixed(e)})`:`(${this.x}, ${this.y})`}}B.EQUALS_EPSILON=.001;function z(u,e){return new B(u,e)}class ${constructor(e,s,r,a){this.r=e,this.g=s,this.b=r,this.a=a??1}static fromRGB(e,s,r,a){return new $(e,s,r,a)}static fromRGBString(e){const s=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let r=null;if(r=e.match(s)){const a=parseInt(r[1],10),l=parseInt(r[2],10),_=parseInt(r[3],10);let p=1;return r[4]&&(p=parseFloat(r[4])),new $(a,l,_,p)}else throw new Error("Invalid rgb/a string: "+e)}static fromHex(e){const s=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let r=null;if(r=e.match(s)){const a=parseInt(r[1],16),l=parseInt(r[2],16),_=parseInt(r[3],16);let p=1;return r[4]&&(p=parseInt(r[4],16)/255),new $(a,l,_,p)}else throw new Error("Invalid hex string: "+e)}static fromHSL(e,s,r,a=1){return new tt(e,s,r,a).toRGBA()}lighten(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.l+=(1-s.l)*e,s.toRGBA()}darken(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.l-=s.l*e,s.toRGBA()}saturate(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.s+=s.s*e,s.toRGBA()}desaturate(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.s-=s.s*e,s.toRGBA()}multiply(e){const s=e.r/255*this.r/255*255,r=e.g/255*this.g/255*255,a=e.b/255*this.b/255*255,l=e.a*this.a;return new $(s,r,a,l)}screen(e){const s=e.invert(),r=e.invert();return s.multiply(r).invert()}invert(){return new $(255-this.r,255-this.g,255-this.b,1-this.a)}average(e){const s=(e.r+this.r)/2,r=(e.g+this.g)/2,a=(e.b+this.b)/2,l=(e.a+this.a)/2;return new $(s,r,a,l)}equal(e){return this.toString()===e.toString()}toString(e="rgb"){switch(e){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(e){const s=Math.max(Math.round(e),0).toString(16);return s.length===1?"0"+s:s}toHex(){let e="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(e+=this._componentToHex(this.a*255)),e}toRGBA(){const e=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+e+", "+String(this.a)+")":"rgb("+e+")"}toHSLA(){return tt.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(e){const s=e||new $(this.r,this.g,this.b,this.a);return s.r=this.r,s.g=this.g,s.b=this.b,s.a=this.a,s}static get Black(){return $.fromHex("#000000")}static get White(){return $.fromHex("#FFFFFF")}static get Gray(){return $.fromHex("#808080")}static get LightGray(){return $.fromHex("#D3D3D3")}static get DarkGray(){return $.fromHex("#A9A9A9")}static get Yellow(){return $.fromHex("#FFFF00")}static get Orange(){return $.fromHex("#FFA500")}static get Red(){return $.fromHex("#FF0000")}static get Vermilion(){return $.fromHex("#FF5B31")}static get Rose(){return $.fromHex("#FF007F")}static get Pink(){return $.fromHex("#FFC0CB")}static get Magenta(){return $.fromHex("#FF00FF")}static get Violet(){return $.fromHex("#7F00FF")}static get Purple(){return $.fromHex("#800080")}static get Blue(){return $.fromHex("#0000FF")}static get Azure(){return $.fromHex("#007FFF")}static get Cyan(){return $.fromHex("#00FFFF")}static get Viridian(){return $.fromHex("#59978F")}static get Teal(){return $.fromHex("#008080")}static get Green(){return $.fromHex("#00FF00")}static get Chartreuse(){return $.fromHex("#7FFF00")}static get Transparent(){return $.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return $.fromHex("#176BAA")}static get Brown(){return $.fromHex("#964B00")}}class tt{constructor(e,s,r,a){this.h=e,this.s=s,this.l=r,this.a=a}static hue2rgb(e,s,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+(s-e)*6*r:r<1/2?s:r<2/3?e+(s-e)*(2/3-r)*6:e}static fromRGBA(e,s,r,a){e/=255,s/=255,r/=255;const l=Math.max(e,s,r),_=Math.min(e,s,r);let p,m;const w=(l+_)/2;if(l===_)p=m=0;else{const y=l-_;switch(m=w>.5?y/(2-l-_):y/(l+_),l){case e:p=(s-r)/y+(s<r?6:0);break;case s:p=(r-e)/y+2;break;case r:p=(e-s)/y+4;break}p/=6}return new tt(p,m,w,a)}toRGBA(){let e,s,r;if(this.s===0)e=s=r=this.l;else{const a=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,l=2*this.l-a;e=tt.hue2rgb(l,a,this.h+1/3),s=tt.hue2rgb(l,a,this.h),r=tt.hue2rgb(l,a,this.h-1/3)}return new $(e*255,s*255,r*255,this.a)}toString(){const e=this.h.toFixed(0),s=this.s.toFixed(0),r=this.l.toFixed(0),a=this.a.toFixed(0);return`hsla(${e}, ${s}, ${r}, ${a})`}}var Ht;(function(u){u[u.Debug=0]="Debug",u[u.Info=1]="Info",u[u.Warn=2]="Warn",u[u.Error=3]="Error",u[u.Fatal=4]="Fatal"})(Ht||(Ht={}));class ot{constructor(){if(this._appenders=[],this.defaultLevel=Ht.Info,this._logOnceSet=new Set,ot._INSTANCE)throw new Error("Logger is a singleton");return ot._INSTANCE=this,ot._INSTANCE.addAppender(new pi),ot._INSTANCE}static getInstance(){return ot._INSTANCE==null&&(ot._INSTANCE=new ot),ot._INSTANCE}addAppender(e){this._appenders.push(e)}clearAppenders(){this._appenders.length=0}_log(e,s){e==null&&(e=this.defaultLevel);const r=this._appenders.length;for(let a=0;a<r;a++)e>=this.defaultLevel&&this._appenders[a].log(e,s)}_logOnce(e,s){const r=e+s.join("+");this._logOnceSet.has(r)||(this._logOnceSet.add(r),this._log(e,s))}debug(...e){this._log(Ht.Debug,e)}debugOnce(...e){this._logOnce(Ht.Debug,e)}info(...e){this._log(Ht.Info,e)}infoOnce(...e){this._logOnce(Ht.Info,e)}warn(...e){this._log(Ht.Warn,e)}warnOnce(...e){this._logOnce(Ht.Warn,e)}error(...e){this._log(Ht.Error,e)}errorOnce(...e){this._logOnce(Ht.Error,e)}fatal(...e){this._log(Ht.Fatal,e)}fatalOnce(...e){this._logOnce(Ht.Fatal,e)}}ot._INSTANCE=null;class pi{log(e,s){if(!console&&!console.log&&console.warn&&console.error)return;const r=[];r.unshift.apply(r,s),r.unshift("["+Ht[e]+"] : "),e<Ht.Warn?console.log.apply?console.log.apply(console,r):console.log(r.join(" ")):e<Ht.Error?console.warn.apply?console.warn.apply(console,r):console.warn(r.join(" ")):console.error.apply?console.error.apply(console,r):console.error(r.join(" "))}}class Zi{constructor(e){var s,r;this._messages=[],this._pos=10,this._color=$.Black,this._options=e,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(r=(s=e.zIndex)===null||s===void 0?void 0:s.toString())!==null&&r!==void 0?r:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),e.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var e,s,r,a;const l=this._options;this.canvas.width=(e=l.width)!==null&&e!==void 0?e:l.engine.screen.resolution.width,this.canvas.height=(s=l.height)!==null&&s!==void 0?s:l.engine.screen.resolution.height,this.canvas.style.position="absolute";const _=l.engine.screen.screenToPageCoordinates(z(0,0));this.canvas.style.left=_.x+"px",this.canvas.style.top=_.y+"px",this._pos=(r=l.xPos)!==null&&r!==void 0?r:this._pos,this._color=(a=l.color)!==null&&a!==void 0?a:this._color}log(e,s){const r=s.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+Ht[e]+"] : "+r);let a=10;this._messages=this._messages.slice(0,1e3);for(let l=0;l<this._messages.length;l++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[l],this._pos,a),a+=10}}var Pt;(function(u){u.None="None",u.Top="Top",u.Bottom="Bottom",u.Left="Left",u.Right="Right"})(Pt||(Pt={})),function(u){function e(r){return r===u.Top?u.Bottom:r===u.Bottom?u.Top:r===u.Left?u.Right:r===u.Right?u.Left:u.None}u.getOpposite=e;function s(r){return Math.abs(r.x)>=Math.abs(r.y)?r.x<=0?u.Left:u.Right:r.y<=0?u.Top:u.Bottom}u.fromDirection=s}(Pt||(Pt={}));class at{constructor(e=0,s=0,r=0,a=0){this._points=[],typeof e=="object"?(this.left=e.left,this.top=e.top,this.right=e.right,this.bottom=e.bottom):typeof e=="number"&&(this.left=e,this.top=s,this.right=r,this.bottom=a)}clone(e){const s=e||new at(0,0,0,0);return s.left=this.left,s.right=this.right,s.top=this.top,s.bottom=this.bottom,s}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(e){return e&&e?Math.abs(e.x)>Math.abs(e.y)?e.x<0?Pt.Right:Pt.Left:e.y<0?Pt.Bottom:Pt.Top:Pt.None}static fromPoints(e){let s=1/0,r=1/0,a=-1/0,l=-1/0;for(let _=0;_<e.length;_++)e[_].x<s&&(s=e[_].x),e[_].x>a&&(a=e[_].x),e[_].y<r&&(r=e[_].y),e[_].y>l&&(l=e[_].y);return new at(s,r,a,l)}static fromDimension(e,s,r=B.Half,a=B.Zero){return new at(-e*r.x+a.x,-s*r.y+a.y,e-e*r.x+a.x,s-s*r.y+a.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new B((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new B(this.left,this.top)}get bottomRight(){return new B(this.right,this.bottom)}get topRight(){return new B(this.right,this.top)}get bottomLeft(){return new B(this.left,this.bottom)}translate(e){return new at(this.left+e.x,this.top+e.y,this.right+e.x,this.bottom+e.y)}rotate(e,s=B.Zero){const r=this.getPoints().map(a=>a.rotate(e,s));return at.fromPoints(r)}scale(e,s=B.Zero){const r=this.translate(s);return new at(r.left*e.x,r.top*e.y,r.right*e.x,r.bottom*e.y)}transform(e){const s=e.data[0]*this.left,r=e.data[1]*this.left,a=e.data[0]*this.right,l=e.data[1]*this.right,_=e.data[2]*this.top,p=e.data[3]*this.top,m=e.data[2]*this.bottom,w=e.data[3]*this.bottom,y=e.getPosition(),A=Math.min(s,a)+Math.min(_,m)+y.x,E=Math.min(r,l)+Math.min(p,w)+y.y,D=Math.max(s,a)+Math.max(_,m)+y.x,L=Math.max(r,l)+Math.max(p,w)+y.y;return new at({left:A,top:E,right:D,bottom:L})}getPerimeter(){const e=this.width,s=this.height;return 2*(e+s)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new B(this.left,this.top)),this._points.push(new B(this.right,this.top)),this._points.push(new B(this.right,this.bottom)),this._points.push(new B(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(e,s=1/0){let r=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,_=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,p=(this.left-e.pos.x)*l,m=(this.right-e.pos.x)*l;r=Math.min(p,m),a=Math.max(p,m);const w=(this.top-e.pos.y)*_,y=(this.bottom-e.pos.y)*_;return r=Math.max(r,Math.min(w,y)),a=Math.min(a,Math.max(w,y)),a>=Math.max(0,r)&&r<s}rayCastTime(e,s=1/0){let r=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,_=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,p=(this.left-e.pos.x)*l,m=(this.right-e.pos.x)*l;r=Math.min(p,m),a=Math.max(p,m);const w=(this.top-e.pos.y)*_,y=(this.bottom-e.pos.y)*_;return r=Math.max(r,Math.min(w,y)),a=Math.min(a,Math.max(w,y)),a>=Math.max(0,r)&&r<s?r:-1}contains(e){return e instanceof B?this.left<=e.x&&this.top<=e.y&&e.y<=this.bottom&&e.x<=this.right:e instanceof at?this.left<=e.left&&this.top<=e.top&&e.bottom<=this.bottom&&e.right<=this.right:!1}combine(e,s){const r=s||new at(0,0,0,0),a=Math.min(this.left,e.left),l=Math.min(this.top,e.top),_=Math.max(this.right,e.right),p=Math.max(this.bottom,e.bottom);return r.left=a,r.top=l,r.right=_,r.bottom=p,r}get dimensions(){return new B(this.width,this.height)}overlaps(e,s){const r=s||0;if(e.hasZeroDimensions())return this.contains(e);if(this.hasZeroDimensions())return e.contains(this);const a=this.combine(e);return a.width+r<e.width+this.width&&a.height+r<e.height+this.height}intersect(e){const s=this.combine(e);if(s.width<e.width+this.width&&s.height<e.height+this.height&&!s.dimensions.equals(e.dimensions)&&!s.dimensions.equals(this.dimensions)){let r=0;this.right>=e.left&&this.right<=e.right?r=e.left-this.right:r=e.right-this.left;let a=0;return this.top<=e.bottom&&this.top>=e.top?a=e.bottom-this.top:a=e.top-this.bottom,Math.abs(r)<Math.abs(a)?new B(r,0):new B(0,a)}else if(s.dimensions.equals(e.dimensions)||s.dimensions.equals(this.dimensions)){let r=0;this.width-e.width>=0?this.right-e.right<=e.left-this.left?r=e.left-this.right:r=e.right-this.left:e.right-this.right<=this.left-e.left?r=this.left-e.right:r=this.right-e.left;let a=0;return this.height-e.height>=0?this.bottom-e.bottom<=e.top-this.top?a=e.top-this.bottom:a=e.bottom-this.top:e.bottom-this.bottom<=this.top-e.top?a=this.top-e.bottom:a=this.bottom-e.top,Math.abs(r)<Math.abs(a)?new B(r,0):new B(0,a)}else return null}intersectWithSide(e){const s=this.intersect(e);return at.getSideFromIntersection(s)}draw(e,s=$.Yellow){e.debug.drawRect(this.left,this.top,this.width,this.height,{color:s})}}function vs(u){if(u&&u.getBoundingClientRect){const e=u.getBoundingClientRect();return z(e.x+window.scrollX,e.y+window.scrollY)}return B.Zero}function Gr(u,e){return e.indexOf(u)===-1?(e.push(u),!0):!1}function $i(u,e){let s=-1;return(s=e.indexOf(u))>-1?(e.splice(s,1),!0):!1}function Vr(u,e){for(let s=0;s<u.length;s++)if(u[s]===e)return!0;return!1}function Tc(u){throw new Error(u)}function qr(u,e){var s;const r=new P;return((s=e?.schedule.bind(e))!==null&&s!==void 0?s:setTimeout)(()=>{r.resolve()},u),r.promise}function Pc(u,e){const s={};for(const r in u)e.includes(r)||(s[r]=u[r]);return s}function Xr(u){return u&&typeof u=="object"&&!Array.isArray(u)}function Yr(u,...e){if(!e.length)return u;const s=e.shift();if(Xr(u)&&Xr(s))for(const r in s)Xr(s[r])?(u[r]||Object.assign(u,{[r]:{}}),Yr(u[r],s[r])):Object.assign(u,{[r]:s[r]});return Yr(u,...e)}var va;(function(u){u[u.X=12]="X",u[u.Y=13]="Y"})(va||(va={}));class ii{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(e,s,r,a,l,_){const p=new ii;return p.data[0]=2/(s-e),p.data[1]=0,p.data[2]=0,p.data[3]=0,p.data[4]=0,p.data[5]=2/(a-r),p.data[6]=0,p.data[7]=0,p.data[8]=0,p.data[9]=0,p.data[10]=-2/(_-l),p.data[11]=0,p.data[12]=-(s+e)/(s-e),p.data[13]=-(a+r)/(a-r),p.data[14]=-(_+l)/(_-l),p.data[15]=1,p}clone(e){const s=e||new ii;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s.data[6]=this.data[6],s.data[7]=this.data[7],s.data[8]=this.data[8],s.data[9]=this.data[9],s.data[10]=this.data[10],s.data[11]=this.data[11],s.data[12]=this.data[12],s.data[13]=this.data[13],s.data[14]=this.data[14],s.data[15]=this.data[15],s}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(e){const s=new ii;return s.data=e,s}static identity(){const e=new ii;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}static translation(e,s){const r=ii.identity();return r.data[12]=e,r.data[13]=s,r}static scale(e,s){const r=ii.identity();return r.data[0]=e,r.data[5]=s,r.data[10]=1,r.data[15]=1,r}static rotation(e){const s=ii.identity();return s.data[0]=Math.cos(e),s.data[4]=-Math.sin(e),s.data[1]=Math.sin(e),s.data[5]=Math.cos(e),s}multiply(e,s){if(e instanceof B){const r=s||new B(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[4]+this.data[12],_=a.x*this.data[1]+a.y*this.data[5]+this.data[13];return r.x=l,r.y=_,r}else{const r=s||new ii,a=e,l=this.data[0],_=this.data[1],p=this.data[2],m=this.data[3],w=this.data[4],y=this.data[5],A=this.data[6],E=this.data[7],D=this.data[8],L=this.data[9],O=this.data[10],X=this.data[11],H=this.data[12],N=this.data[13],Q=this.data[14],Y=this.data[15],J=a.data[0],rt=a.data[1],Z=a.data[2],_t=a.data[3],Tt=a.data[4],Gt=a.data[5],Xt=a.data[6],be=a.data[7],$t=a.data[8],kt=a.data[9],ze=a.data[10],Ee=a.data[11],it=a.data[12],Zs=a.data[13],$s=a.data[14],Qs=a.data[15];r.data[0]=l*J+w*rt+D*Z+H*_t,r.data[1]=_*J+y*rt+L*Z+N*_t,r.data[2]=p*J+A*rt+O*Z+Q*_t,r.data[3]=m*J+E*rt+X*Z+Y*_t,r.data[4]=l*Tt+w*Gt+D*Xt+H*be,r.data[5]=_*Tt+y*Gt+L*Xt+N*be,r.data[6]=p*Tt+A*Gt+O*Xt+Q*be,r.data[7]=m*Tt+E*Gt+X*Xt+Y*be,r.data[8]=l*$t+w*kt+D*ze+H*Ee,r.data[9]=_*$t+y*kt+L*ze+N*Ee,r.data[10]=p*$t+A*kt+O*ze+Q*Ee,r.data[11]=m*$t+E*kt+X*ze+Y*Ee,r.data[12]=l*it+w*Zs+D*$s+H*Qs,r.data[13]=_*it+y*Zs+L*$s+N*Qs,r.data[14]=p*it+A*Zs+O*$s+Q*Qs,r.data[15]=m*it+E*Zs+X*$s+Y*Qs;const Sn=this.getScale();return r._scaleSignX=V(Sn.x)*V(r._scaleSignX),r._scaleSignY=V(Sn.y)*V(r._scaleSignY),r}}translate(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],_=this.data[3],p=this.data[4],m=this.data[5],w=this.data[6],y=this.data[7],A=this.data[8],E=this.data[9],D=this.data[10],L=this.data[11],O=this.data[12],X=this.data[13],H=this.data[14],N=this.data[15],Q=0,Y=1;return this.data[12]=r*e+p*s+A*Q+O*Y,this.data[13]=a*e+m*s+E*Q+X*Y,this.data[14]=l*e+w*s+D*Q+H*Y,this.data[15]=_*e+y*s+L*Q+N*Y,this}setPosition(e,s){this.data[12]=e,this.data[13]=s}getPosition(){return z(this.data[12],this.data[13])}rotate(e){const s=this.data[0],r=this.data[1],a=this.data[2],l=this.data[3],_=this.data[4],p=this.data[5],m=this.data[6],w=this.data[7],y=Math.sin(e),A=Math.cos(e);return this.data[0]=A*s+y*_,this.data[1]=A*r+y*p,this.data[2]=A*a+y*m,this.data[3]=A*l+y*w,this.data[4]=A*_-y*s,this.data[5]=A*p-y*r,this.data[6]=A*m-y*a,this.data[7]=A*w-y*l,this}scale(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],_=this.data[3],p=this.data[4],m=this.data[5],w=this.data[6],y=this.data[7];return this.data[0]=r*e,this.data[1]=a*e,this.data[2]=l*e,this.data[3]=_*e,this.data[4]=p*s,this.data[5]=m*s,this.data[6]=w*s,this.data[7]=y*s,this}setRotation(e){const s=this.getScale(),r=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=r*s.y,this.data[4]=-r*s.x,this.data[5]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return nt(e)}getScaleX(){const e=z(this.data[0],this.data[4]).magnitude;return this._scaleSignX*e}getScaleY(){const e=z(this.data[1],this.data[5]).magnitude;return this._scaleSignY*e}getScale(){return z(this.getScaleX(),this.getScaleY())}setScaleX(e){if(this._scaleX===e)return;this._scaleSignX=V(e);const s=z(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[4]=s.y*e,this._scaleX=e}setScaleY(e){if(this._scaleY===e)return;this._scaleSignY=V(e);const s=z(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[5]=s.y*e,this._scaleY=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(e){const r=1/this.getBasisDeterminant(),a=this.data[0],l=this.data[4],_=this.data[1],p=this.data[5],m=e||ii.identity();m.data[0]=p*r,m.data[1]=-_*r,m.data[4]=-l*r,m.data[5]=a*r;const w=this.data[12],y=this.data[13];return m.data[12]=-(w*m.data[0]+y*m.data[4]),m.data[13]=-(w*m.data[1]+y*m.data[5]),m}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class he{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const e=new he;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}static translation(e,s){const r=he.identity();return r.data[4]=e,r.data[5]=s,r}static scale(e,s){const r=he.identity();return r.data[0]=e,r.data[3]=s,r._scale[0]=e,r._scale[1]=s,r}static rotation(e){const s=he.identity();return s.data[0]=Math.cos(e),s.data[1]=Math.sin(e),s.data[2]=-Math.sin(e),s.data[3]=Math.cos(e),s}setPosition(e,s){this.data[4]=e,this.data[5]=s}getPosition(){return z(this.data[4],this.data[5])}rotate(e){const s=this.data[0],r=this.data[1],a=this.data[2],l=this.data[3],_=Math.sin(e),p=Math.cos(e);return this.data[0]=p*s+_*a,this.data[1]=p*r+_*l,this.data[2]=p*a-_*s,this.data[3]=p*l-_*r,this}translate(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],_=this.data[3],p=this.data[4],m=this.data[5];return this.data[4]=r*e+l*s+p,this.data[5]=a*e+_*s+m,this}scale(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],_=this.data[3];return this.data[0]=r*e,this.data[1]=a*e,this.data[2]=l*s,this.data[3]=_*s,this._scale[0]=e,this._scale[1]=s,this._scaleSignX=V(e),this._scaleSignY=V(s),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(e){const s=this.determinant();let r=s;s!==0&&(r=1/s);const a=this.data[0],l=this.data[2],_=this.data[1],p=this.data[3],m=e||he.identity();m.data[0]=p*r,m.data[1]=-_*r,m.data[2]=-l*r,m.data[3]=a*r;const w=this.data[4],y=this.data[5];return m.data[4]=-(w*m.data[0]+y*m.data[2]),m.data[5]=-(w*m.data[1]+y*m.data[3]),m}multiply(e,s){if(e instanceof B){const r=s||new B(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[2]+this.data[4],_=a.x*this.data[1]+a.y*this.data[3]+this.data[5];return r.x=l,r.y=_,r}else{const r=s||new he,a=e,l=this.data[0],_=this.data[1],p=this.data[2],m=this.data[3],w=this.data[4],y=this.data[5],A=a.data[0],E=a.data[1],D=a.data[2],L=a.data[3],O=a.data[4],X=a.data[5];r.data[0]=l*A+p*E,r.data[1]=_*A+m*E,r.data[2]=l*D+p*L,r.data[3]=_*D+m*L,r.data[4]=l*O+p*X+w,r.data[5]=_*O+m*X+y;const H=this._scaleSignX,N=this._scaleSignY;return r._scaleSignX=H*V(r._scaleSignX),r._scaleSignY=N*V(r._scaleSignY),r}}multiplyQuadInPlace(e){const s=e[0]*this.data[0]+e[1]*this.data[2]+this.data[4],r=e[0]*this.data[1]+e[1]*this.data[3]+this.data[5];e[0]=s,e[1]=r;const a=e[2]*this.data[0]+e[3]*this.data[2]+this.data[4],l=e[2]*this.data[1]+e[3]*this.data[3]+this.data[5];e[2]=a,e[3]=l;const _=e[4]*this.data[0]+e[5]*this.data[2]+this.data[4],p=e[4]*this.data[1]+e[5]*this.data[3]+this.data[5];e[4]=_,e[5]=p;const m=e[6]*this.data[0]+e[7]*this.data[2]+this.data[4],w=e[6]*this.data[1]+e[7]*this.data[3]+this.data[5];e[6]=m,e[7]=w}to4x4(){const e=new ii;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=0,e.data[3]=0,e.data[4]=this.data[2],e.data[5]=this.data[3],e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=this.data[4],e.data[13]=this.data[5],e.data[14]=0,e.data[15]=1,e}setRotation(e){const s=this.getScale(),r=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=r*s.y,this.data[2]=-r*s.x,this.data[3]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return nt(e)}getScaleX(){const e=this.data[0]*this.data[0]+this.data[2]*this.data[2];return e===1?this._scaleSignX:this._scaleSignX*Math.sqrt(e)}getScaleY(){const e=this.data[1]*this.data[1]+this.data[3]*this.data[3];return e===1?this._scaleSignY:this._scaleSignY*Math.sqrt(e)}getScale(){return z(this.getScaleX(),this.getScaleY())}setScaleX(e){if(e===this._scale[0])return;this._scaleSignX=V(e);const s=z(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[2]=s.y*e,this._scale[0]=e}setScaleY(e){if(e===this._scale[1])return;this._scaleSignY=V(e);const s=z(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[3]=s.y*e,this._scale[1]=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}clone(e){const s=e||new he;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s._scaleSignX=this._scaleSignX,s._scaleSignY=this._scaleSignY,s}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}class Xn{constructor(e,s,r=1){this.builder=e,this.cleaner=s,this._pool=[],this._size=0,this.grow(r)}grow(e){if(e>0){this._size+=e;for(let s=0;s<e;s++)this._pool.push(this.builder())}}rent(e=!1){return this._pool.length===0&&this.grow(this._size),e?this.cleaner(this._pool.pop()):this._pool.pop()}return(e){this._pool.push(e)}}class Ff{constructor(){this._pool=new Xn(()=>he.identity(),e=>e.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(e,s){return this._currentTransform.translate(e,s)}rotate(e){return this._currentTransform.rotate(e)}scale(e,s){return this._currentTransform.scale(e,s)}reset(){this._currentTransform.reset()}set current(e){this._currentTransform=e}get current(){return this._currentTransform}}class Bf{constructor(){this.opacity=1,this.z=0,this.tint=$.White,this.material=null}}class Sc{constructor(){this._pool=new Xn(()=>new Bf,e=>(e.opacity=1,e.z=0,e.tint=$.White,e.material=null,e),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(e){var s;return e.opacity=this.current.opacity,e.z=this.current.z,e.tint=(s=this.current.tint)===null||s===void 0?void 0:s.clone(),e.material=this.current.material,e}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const kf={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class Yn{constructor(e,s,r=!1){this.path=e,this.responseType=s,this.bustCache=r,this.data=null,this.logger=ot.getInstance(),this.events=new I}isLoaded(){return this.data!==null}_cacheBust(e){return/\?\w*=\w*/.test(e)?e+="&__="+Date.now():e+="?__="+Date.now(),e}load(){return new Promise((e,s)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),e(this.data);return}const r=new XMLHttpRequest;r.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),r.responseType=this.responseType,r.addEventListener("loadstart",a=>this.events.emit("loadstart",a)),r.addEventListener("progress",a=>this.events.emit("progress",a)),r.addEventListener("error",a=>this.events.emit("error",a)),r.addEventListener("load",a=>this.events.emit("load",a)),r.addEventListener("load",()=>{if(r.status!==0&&r.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",r.status),this.events.emit("error",r.response),s(new Error(r.statusText));return}if(r.response instanceof Blob&&r.response.type==="text/html"){const a=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",r.response),s(new Error(a));return}this.data=r.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),e(this.data)}),r.send()})}}function gi(u,e){return u&&(u.__isProxy===void 0?new Proxy(u,{set:(s,r,a)=>(s[r]!==a&&(s[r]=a,typeof r=="string"&&r[0]!=="_"&&e(s)),!0),get:(s,r)=>r!=="__isProxy"?s[r]:!0}):u)}const Ec=(u=[],e,s)=>({get:(r,a)=>a==="__isProxy"?!0:typeof r[a]=="object"&&r[a]!=null?new Proxy(r[a],Ec([...u,a],e,s)):r[a],set:(r,a,l)=>(typeof a=="string"&&a[0]!=="_"&&e(s),r[a]=l,!0)});function Lf(u,e){return u&&(u.__isProxy===void 0?new Proxy(u,Ec([],e,u)):u)}class Qt{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(e){this._flipHorizontal=e,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(e){this._flipVertical=e,this._transformStale=!0}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._transformStale=!0}get scale(){return this._scale}set scale(e){this._scale=gi(e,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(e){e&&(this._origin=gi(e,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(e){var s,r,a,l,_,p,m;this.id=Qt._ID++,this.transform=he.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=B.One,this._width=0,this._height=0,e&&(this.origin=(s=e.origin)!==null&&s!==void 0?s:this.origin,this.flipHorizontal=(r=e.flipHorizontal)!==null&&r!==void 0?r:this.flipHorizontal,this.flipVertical=(a=e.flipVertical)!==null&&a!==void 0?a:this.flipVertical,this.rotation=(l=e.rotation)!==null&&l!==void 0?l:this.rotation,this.opacity=(_=e.opacity)!==null&&_!==void 0?_:this.opacity,this.scale=(p=e.scale)!==null&&p!==void 0?p:this.scale,this.tint=(m=e.tint)!==null&&m!==void 0?m:this.tint,e.width&&(this._width=e.width),e.height&&(this._height=e.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(e){this._width=e,this._transformStale=!0}set height(e){this._height=e,this._transformStale=!0}get localBounds(){return at.fromDimension(this.width,this.height,B.Zero)}draw(e,s,r){this._preDraw(e,s,r),this._drawImage(e,0,0),this._postDraw(e)}_preDraw(e,s,r){e.save(),e.translate(s,r),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),e.multiply(this.transform),e.opacity=e.opacity*this.opacity,this.tint&&(e.tint=this.tint)}_rotate(e){var s;const r=this.scale.x>0?1:-1,a=this.scale.y>0?1:-1,l=(s=this.origin)!==null&&s!==void 0?s:z(this.width/2,this.height/2);e.translate(l.x,l.y),e.rotate(this.rotation),e.scale(r,a),e.translate(-l.x,-l.y)}_flip(e){this.flipHorizontal&&(e.translate(this.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,this.height/this.scale.y),e.scale(1,-1))}_postDraw(e){this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore()}}Qt._ID=0;class mi extends Qt{static from(e,s){return new mi({image:e,...s})}constructor(e){var s,r;super(e),this._logger=ot.getInstance(),this._dirty=!0,this.image=e.image;const{width:a,height:l}=e;this.sourceView=(s=e.sourceView)!==null&&s!==void 0?s:{x:0,y:0,width:a??0,height:l??0},this.destSize=(r=e.destSize)!==null&&r!==void 0?r:{width:a??0,height:l??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(e){e/=Math.abs(this.scale.x),this.destSize.width=e,super.width=Math.ceil(this.destSize.width)}set height(e){e/=Math.abs(this.scale.y),this.destSize.height=e,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var e,s,r,a,l,_;const{width:p,height:m}=this.image;this.sourceView.width=((e=this.sourceView)===null||e===void 0?void 0:e.width)||p,this.sourceView.height=((s=this.sourceView)===null||s===void 0?void 0:s.height)||m,this.destSize.width=((r=this.destSize)===null||r===void 0?void 0:r.width)||((a=this.sourceView)===null||a===void 0?void 0:a.width)||p,this.destSize.height=((l=this.destSize)===null||l===void 0?void 0:l.height)||((_=this.sourceView)===null||_===void 0?void 0:_.height)||m,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(e,s,r){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(e,s,r)}_drawImage(e,s,r){this.image.isLoaded()?e.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,s,r,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new mi({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var le;(function(u){u.Pixel="Pixel",u.Blended="Blended"})(le||(le={}));function fn(u){switch(u){case le.Pixel:return le.Pixel;case le.Blended:return le.Blended;default:return}}var Vt;(function(u){u.Clamp="Clamp",u.Repeat="Repeat",u.Mirror="Mirror"})(Vt||(Vt={}));function vi(u){switch(u){case Vt.Clamp:return Vt.Clamp;case Vt.Repeat:return Vt.Repeat;case Vt.Mirror:return Vt.Mirror;default:return Vt.Clamp}}class Kt{constructor(e,s){var r;this._garbageCollector=s,this._textureMap=new Map,this._collect=a=>{var l;if(this._gl){const _=(l=a.dataset.originalSrc)!==null&&l!==void 0?l:a.constructor.name;return Kt._LOGGER.debug(`WebGL Texture for ${_} collected`),this.delete(a),!0}return!1},this._gl=e,Kt._MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE),this._garbageCollector&&(Kt._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(r=this._garbageCollector.garbageCollector)===null||r===void 0||r.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[e]of this._textureMap)this.delete(e);this._textureMap.clear(),this._gl=null}get(e){return this._textureMap.get(e)}has(e){return this._textureMap.has(e)}load(e,s,r=!1){var a,l;const _=this._gl;if(!_)return null;const{filtering:p,wrapping:m}={...s};let w=null;if(this.has(e)&&(w=this.get(e)),w)return r&&(_.bindTexture(_.TEXTURE_2D,w),_.texImage2D(_.TEXTURE_2D,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e)),(a=this._garbageCollector)===null||a===void 0||a.garbageCollector.touch(e),w;w=_.createTexture(),Kt.checkImageSizeSupportedAndLog(e),_.bindTexture(_.TEXTURE_2D,w),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let y;m&&(typeof m=="string"?y={x:m,y:m}:y={x:m.x,y:m.y});const{x:A,y:E}=y??Kt.wrapping;switch(A){case Vt.Clamp:_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_S,_.CLAMP_TO_EDGE);break;case Vt.Repeat:_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_S,_.REPEAT);break;case Vt.Mirror:_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_S,_.MIRRORED_REPEAT);break;default:_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_S,_.CLAMP_TO_EDGE)}switch(E){case Vt.Clamp:_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_T,_.CLAMP_TO_EDGE);break;case Vt.Repeat:_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_T,_.REPEAT);break;case Vt.Mirror:_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_T,_.MIRRORED_REPEAT);break;default:_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_T,_.CLAMP_TO_EDGE)}const D=p??Kt.filtering;return _.texParameteri(_.TEXTURE_2D,_.TEXTURE_MIN_FILTER,D===le.Pixel?_.NEAREST:_.LINEAR),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MAG_FILTER,D===le.Pixel?_.NEAREST:_.LINEAR),_.texImage2D(_.TEXTURE_2D,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e),this._textureMap.set(e,w),(l=this._garbageCollector)===null||l===void 0||l.garbageCollector.addCollectableResource("texture",e),w}delete(e){const s=this._gl;if(s&&this.has(e)){const r=this.get(e);r&&(this._textureMap.delete(e),s.deleteTexture(r))}}static checkImageSizeSupportedAndLog(e){var s;const r=(s=e.dataset.originalSrc)!==null&&s!==void 0?s:"internal canvas bitmap";return e.width>Kt._MAX_TEXTURE_SIZE||e.height>Kt._MAX_TEXTURE_SIZE?(Kt._LOGGER.error(`The image [${r}] provided to Excalibur is too large for the device's maximum texture size of (${Kt._MAX_TEXTURE_SIZE}x${Kt._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((e.width>4096||e.height>4096)&&Kt._LOGGER.warn(`The image [${r}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}Kt._LOGGER=ot.getInstance(),Kt.filtering=le.Blended,Kt.wrapping={x:Vt.Clamp,y:Vt.Clamp},Kt._MAX_TEXTURE_SIZE=4096;const Et={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class Di{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(e,s,r){this._logger=ot.getInstance(),this.data=new Image,this._readyFuture=new P,this.ready=this._readyFuture.promise,this.path=e;let a=!1,l;typeof s=="boolean"?a=s:{filtering:r,wrapping:l,bustCache:a}={...s},this._resource=new Yn(e,"blob",a),this.filtering=r??this.filtering,typeof l=="string"?this.wrapping={x:l,y:l}:this.wrapping=l??this.wrapping,e.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${e} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(e,s){const r=new Di("");if(r._src="image-element",r.data=e,r.data.setAttribute("data-original-src","image-element"),s?.filtering?r.data.setAttribute(Et.Filtering,s?.filtering):r.data.setAttribute(Et.Filtering,le.Blended),s?.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},r.data.setAttribute(Et.WrappingX,a.x),r.data.setAttribute(Et.WrappingY,a.y)}else r.data.setAttribute(Et.WrappingX,Vt.Clamp),r.data.setAttribute(Et.WrappingY,Vt.Clamp);return Kt.checkImageSizeSupportedAndLog(e),r._readyFuture.resolve(e),r}static fromHtmlCanvasElement(e,s){const r=new Di("");if(r._src="canvas-element-blob",r.data.setAttribute("data-original-src","canvas-element-blob"),s?.filtering?r.data.setAttribute(Et.Filtering,s?.filtering):r.data.setAttribute(Et.Filtering,le.Blended),s?.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},r.data.setAttribute(Et.WrappingX,a.x),r.data.setAttribute(Et.WrappingY,a.y)}else r.data.setAttribute(Et.WrappingX,Vt.Clamp),r.data.setAttribute(Et.WrappingY,Vt.Clamp);return Kt.checkImageSizeSupportedAndLog(e),e.toBlob(a=>{const l=URL.createObjectURL(a);r.image.onload=()=>{URL.revokeObjectURL(l),r.data=r.image,r._readyFuture.resolve(r.image)},r.image.src=l}),r}static fromSvgString(e,s){const r=new Blob([e],{type:"image/svg+xml"}),a=URL.createObjectURL(r);return new Di(a,s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){var e,s,r,a;if(this.isLoaded())return this.data;try{let l;if(this.path.includes("data:image/"))l=this.path;else{const m=await this._resource.load();l=URL.createObjectURL(m)}const _=new Image,p=new P;_.onload=()=>p.resolve(),_.src=l,_.setAttribute("data-original-src",this.path),await p.promise,this.data=_,Kt.checkImageSizeSupportedAndLog(this.data)}catch(l){throw`Error loading ImageSource from path '${this.path}' with error [${l.message}]`}return this.data.setAttribute(Et.Filtering,this.filtering),this.data.setAttribute(Et.WrappingX,(s=(e=this.wrapping)===null||e===void 0?void 0:e.x)!==null&&s!==void 0?s:Vt.Clamp),this.data.setAttribute(Et.WrappingY,(a=(r=this.wrapping)===null||r===void 0?void 0:r.y)!==null&&a!==void 0?a:Vt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(e){return mi.from(this,e)}unload(){this.data=new Image}}class jr extends Qt{constructor(e){super(e),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=ot.getInstance();const{alphabet:s,spriteSheet:r,caseInsensitive:a,spacing:l,shadow:_,lineHeight:p}=e;this.alphabet=s,this.spriteSheet=r,this.caseInsensitive=a??this.caseInsensitive,this.spacing=l??this.spacing,this.shadow=_??this.shadow,this.lineHeight=p??this.lineHeight}_getCharacterSprites(e){const s=[],r=this.caseInsensitive?e.toLocaleLowerCase():e,a=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let l=0;l<r.length;l++){const _=r[l];let p=a.indexOf(_);p===-1&&(p=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${_}' in configured alphabet '${a}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const m=this.spriteSheet.sprites[p];m?s.push(m):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${_}' at index '${p}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return s}measureText(e,s){const r=this._getLinesFromText(e,s),a=r.reduce((m,w)=>m.length>w.length?m:w),l=this._getCharacterSprites(a);let _=0,p=0;for(const m of l)_+=m.width+this.spacing,p=Math.max(p,m.height);return at.fromDimension(_*this.scale.x,p*r.length*this.scale.y,B.Zero)}_drawImage(e,s,r,a){var l;let _=0,p=0,m=0;const w=this._getLinesFromText(this._text,a);for(const y of w){for(const A of this._getCharacterSprites(y))A.draw(e,s+_,r+p),_+=A.width+this.spacing,m=Math.max(m,A.height);_=0,p+=(l=this.lineHeight)!==null&&l!==void 0?l:m}}render(e,s,r,a,l,_){this._text=s;const p=this.measureText(s,_);this.width=p.width,this.height=p.height,this.shadow&&(e.save(),e.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(e,a,l),this._drawImage(e,0,0,_),this._postDraw(e),e.restore()),this._preDraw(e,a,l),this._drawImage(e,0,0,_),this._postDraw(e)}clone(){return new jr({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(e,s){var r;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let _=a[l],p="";if(this.measureText(_).width>s){for(;this.measureText(_).width>s;)p=_[_.length-1]+p,_=_.slice(0,-1);a[l]=_,a[l+1]=p}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class jn extends mi{constructor(e){super({image:e.image,sourceView:e.sourceView,destSize:{width:e.width,height:e.height},flipHorizontal:e.flipHorizontal,flipVertical:e.flipVertical,rotation:e.rotation,scale:e.scale,opacity:e.opacity,tint:e.tint,origin:e.origin}),this._ready=new P,this.ready=this._ready.promise,this._options=e,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(e,s){return new jn({sourceView:{...e.sourceView},width:e.width,height:e.height,...s,image:e.image})}_applyTiling(){const{width:e,height:s,filtering:r,wrapping:a}={...this._options},l=document.createElement("canvas");l.width=this.sourceView.width,l.height=this.sourceView.height,l.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const p=Di.fromHtmlCanvasElement(l,{wrapping:a??Vt.Repeat,filtering:r});e&&(this.destSize.width=e,this.sourceView.width=e),s&&(this.destSize.height=s,this.sourceView.height=s),this.sourceView.x=0,this.sourceView.y=0,this.image=p,this.image.ready.then(()=>this._ready.resolve())}}class zs{constructor(e){this.sprites=[];const{sprites:s,rows:r,columns:a}=e;this.sprites=s,this.rows=r??1,this.columns=a??this.sprites.length}getSprite(e,s,r){var a,l,_,p,m,w,y,A,E;if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const D=e+s*this.columns,L=this.sprites[D];if(L){if(r){const O=L.clone();return O.flipHorizontal=(a=r.flipHorizontal)!==null&&a!==void 0?a:O.flipHorizontal,O.flipVertical=(l=r.flipVertical)!==null&&l!==void 0?l:O.flipVertical,O.width=(_=r.width)!==null&&_!==void 0?_:O.width,O.height=(p=r.height)!==null&&p!==void 0?p:O.height,O.rotation=(m=r.rotation)!==null&&m!==void 0?m:O.rotation,O.scale=(w=r.scale)!==null&&w!==void 0?w:O.scale,O.opacity=(y=r.opacity)!==null&&y!==void 0?y:O.opacity,O.tint=(A=r.tint)!==null&&A!==void 0?A:O.tint,O.origin=(E=r.origin)!==null&&E!==void 0?E:O.origin,O}return L}throw Error(`Invalid sprite coordinates (${e}, ${s})`)}getTiledSprite(e,s,r){if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const a=e+s*this.columns,l=this.sprites[a];if(l)return jn.fromSprite(l,r);throw Error(`Invalid sprite coordinates (${e}, ${s})`)}static fromImageSourceWithSourceViews(e){const s=e.sourceViews.map(r=>new mi({image:e.image,sourceView:r}));return new zs({sprites:s})}static fromImageSource(e){var s;const r=[];e.spacing=(s=e.spacing)!==null&&s!==void 0?s:{};const{image:a,grid:{rows:l,columns:_,spriteWidth:p,spriteHeight:m},spacing:{originOffset:w,margin:y}}=e,A={x:0,y:0,...w},E={x:0,y:0,...y};for(let D=0;D<_;D++)for(let L=0;L<l;L++)r[D+L*_]=new mi({image:a,sourceView:{x:D*p+E.x*D+A.x,y:L*m+E.y*L+A.y,width:p,height:m},destSize:{height:m,width:p}});return new zs({sprites:r,rows:l,columns:_})}clone(){return new zs({sprites:this.sprites.map(e=>e.clone()),rows:this.rows,columns:this.columns})}}const Uf="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class wa{constructor(){this.fontSheet=Uf,this.size=16,this.load()}load(){return this._imageSource=new Di(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=zs.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new jr({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(e,s,r){this._imageSource.isLoaded()&&this._spriteFont.render(e,s,null,r.x,r.y)}}class zf{constructor(e,s){this._gl=e,this._texture=s}use(){const e=this._gl;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._texture)}disable(){const e=this._gl;e.bindTexture(e.TEXTURE_2D,null)}}class Zr{constructor(e){var s,r;this.antialias=!1,this.samples=1,this._gl=e.gl,this.width=e.width,this.height=e.height,this.transparency=e.transparency,this.antialias=(s=e.antialias)!==null&&s!==void 0?s:this.antialias,this.samples=(r=e.samples)!==null&&r!==void 0?r:this._gl.getParameter(this._gl.MAX_SAMPLES);const a=this._gl;a.drawingBufferFormat?this.bufferFormat=a.drawingBufferFormat:this.transparency?this.bufferFormat=a.RGBA8:this.bufferFormat=a.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(e,s){const r=this._gl;this.width=e,this.height=s,r.bindTexture(r.TEXTURE_2D,this._frameTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.width,this.height,0,r.RGBA,r.UNSIGNED_BYTE,null),this._renderBuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,this._renderBuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,Math.min(this.samples,r.getParameter(r.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const e=this._gl;this._renderBuffer=e.createRenderbuffer(),this._renderFrameBuffer=e.createFramebuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._renderBuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,Math.min(this.samples,e.getParameter(e.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const e=this._gl;this._frameTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._frameTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const s=e.COLOR_ATTACHMENT0;this._frameBuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,s,e.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new zf(this._gl,this._frameTexture)}blitToScreen(){const e=this._gl;this._renderBuffer?(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)):(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.frameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const e=this._gl;e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.frameBuffer),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)}}copyToTexture(e){const s=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),s.bindFramebuffer(s.FRAMEBUFFER,this._frameBuffer),s.bindTexture(s.TEXTURE_2D,e),s.copyTexImage2D(s.TEXTURE_2D,0,s.RGBA,0,0,this.width,this.height,0)}use(){const e=this._gl;this.antialias?e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.viewport(0,0,this.width,this.height)}disable(){const e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null)}}const Hf=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,Of=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function xa(u,e){switch(e){case u.INT:case u.UNSIGNED_INT:case u.FLOAT:return 4;case u.SHORT:return 2;case u.UNSIGNED_SHORT:return 2;case u.BYTE:return 1;case u.UNSIGNED_BYTE:return 1;default:return 1}}function Ic(u,e){const s=`(?<type>[a-z0-9]+)\\s+${e};`,a=new RegExp(s,"g").exec(u);return a?.length>0}function Rc(u,e,s){var r;const a=`(?<type>[a-z0-9]+)\\s+${s};`,_=new RegExp(a,"g").exec(e);switch((r=_?.groups)===null||r===void 0?void 0:r.type){case"float":case"vec2":case"vec3":case"vec4":return u.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return u.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return u.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return u.BOOL;case"short":return u.SHORT;case"ushort":return u.UNSIGNED_SHORT;case"ubyte":return u.UNSIGNED_BYTE;case"byte":return u.BYTE;default:return u.FLOAT}}function Dc(u,e){switch(e){case u.LOW_FLOAT:case u.HIGH_FLOAT:case u.FLOAT:return 1;case u.FLOAT_VEC2:return 2;case u.FLOAT_VEC3:return 3;case u.FLOAT_VEC4:return 4;case u.BYTE:return 1;case u.UNSIGNED_BYTE:return 1;case u.UNSIGNED_SHORT:case u.SHORT:return 1;default:return 1}}function Mc(u,e){switch(e){case u.LOW_FLOAT:case u.HIGH_FLOAT:case u.FLOAT:case u.FLOAT_VEC2:case u.FLOAT_VEC3:case u.FLOAT_VEC4:return u.FLOAT;case u.BYTE:return u.BYTE;case u.UNSIGNED_BYTE:return u.UNSIGNED_BYTE;case u.SHORT:return u.SHORT;case u.UNSIGNED_SHORT:return u.UNSIGNED_SHORT;default:return u.FLOAT}}function ba(u,e){const s=a=>{const l=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let _="";for(let p=0;p<a;p++)p===0?_+=`if (index <= ${p}.5) {
`:_+=`   else if (index <= ${p}.5) {
`,_+=`      fragColor = vec4(1.0);
`,_+=`   }
`;return l.replace("%%complexity%%",_)};let r=!1;do{const a=s(e),l=u.createShader(u.FRAGMENT_SHADER);u.shaderSource(l,a),u.compileShader(l),r=u.getShaderParameter(l,u.COMPILE_STATUS),r||(e=e/2|0)}while(!r);return e}class $e{get compiled(){return this._compiled}constructor(e){this._logger=ot.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:s,vertexSource:r,fragmentSource:a,onPreLink:l,onPostCompile:_}=e;this._gl=s,this.vertexSource=r,this.fragmentSource=a,this._onPreLink=l,this._onPostCompile=_}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),$e._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return $e._ACTIVE_SHADER_INSTANCE===this}compile(){const e=this._gl,s=this._compileShader(e,this.vertexSource,e.VERTEX_SHADER),r=this._compileShader(e,this.fragmentSource,e.FRAGMENT_SHADER);this.program=this._createProgram(e,s,r);const a=this.getAttributes();for(const _ of a)this.attributes[_.name]=_;const l=this.getUniforms();for(const _ of l)this.uniforms[_.name]=_;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS),r=[];for(let a=0;a<s;a++){const l=e.getActiveUniform(this.program,a),_=e.getUniformLocation(this.program,l.name);r.push({name:l.name,glType:l.type,location:_})}return r}getAttributes(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES),r=[];for(let a=0;a<s;a++){const l=e.getActiveAttrib(this.program,a),_=e.getAttribLocation(this.program,l.name);r.push({name:l.name,glType:Mc(e,l.type),size:Dc(e,l.type),location:_,normalized:!1})}return r}setTexture(e,s){const r=this._gl;r.activeTexture(r.TEXTURE0+e),r.bindTexture(r.TEXTURE_2D,s)}setUniformInt(e,s){this.setUniform("uniform1i",e,~~s)}trySetUniformInt(e,s){return this.trySetUniform("uniform1i",e,~~s)}setUniformIntArray(e,s){this.setUniform("uniform1iv",e,s)}trySetUniformIntArray(e,s){return this.trySetUniform("uniform1iv",e,s)}setUniformBoolean(e,s){this.setUniform("uniform1i",e,s?1:0)}trySetUniformBoolean(e,s){return this.trySetUniform("uniform1i",e,s?1:0)}setUniformFloat(e,s){this.setUniform("uniform1f",e,s)}trySetUniformFloat(e,s){return this.trySetUniform("uniform1f",e,s)}setUniformFloatArray(e,s){this.setUniform("uniform1fv",e,s)}trySetUniformFloatArray(e,s){return this.trySetUniform("uniform1fv",e,s)}setUniformFloatVector(e,s){this.setUniform("uniform2f",e,s.x,s.y)}trySetUniformFloatVector(e,s){return this.trySetUniform("uniform2f",e,s.x,s.y)}setUniformFloatColor(e,s){this.setUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}trySetUniformFloatColor(e,s){return this.trySetUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}setUniformMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,s.data)}setUniformAffineMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,[s.data[0],s.data[1],0,0,s.data[2],s.data[3],0,0,0,0,1,0,s.data[4],s.data[5],0,1])}trySetUniformMatrix(e,s){return this.trySetUniform("uniformMatrix4fv",e,!1,s.data)}setUniform(e,s,...r){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${e}:${s}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const l=this._gl.getUniformLocation(this.program,s);if(l){const _=[l,...r];this._gl[e].apply(this._gl,_)}else throw Error(`Uniform ${e}:${s} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(e,s,...r){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${e}:${s}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const l=this._gl.getUniformLocation(this.program,s);if(l){const _=[l,...r];this._gl[e].apply(this._gl,_)}else return!1;return!0}_createProgram(e,s,r){const a=e.createProgram();if(a===null)throw Error("Could not create graphics shader program");if(e.attachShader(a,s),e.attachShader(a,r),this._onPreLink&&this._onPreLink(a),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw Error(`Could not link the program: [${e.getProgramInfoLog(a)}]`);return a}_compileShader(e,s,r){const a=e.VERTEX_SHADER===r?"vertex":"fragment",l=e.createShader(r);if(l===null)throw Error(`Could not build shader: [${s}]`);if(e.shaderSource(l,s),e.compileShader(l),!e.getShaderParameter(l,e.COMPILE_STATUS)){const p=e.getShaderInfoLog(l);throw Error(`Could not compile ${a} shader:

${p}${this._processSourceForError(s,p)}`)}return l}_processSourceForError(e,s){if(!e)return s;const r=e.split(`
`),a=s.search(/\d:\d/),l=s.indexOf(" ",a),[_,p]=s.slice(a,l).split(":").map(m=>Number(m));for(let m=0;m<r.length;m++)r[m]=`${m+1}: ${r[m]}${p===m+1?" <----- ERROR!":""}`;return`

Source:
`+r.join(`
`)}}$e._ACTIVE_SHADER_INSTANCE=null;class Mi{constructor(e){this.type="dynamic";const{gl:s,size:r,type:a,data:l}=e;if(this._gl=s,this.buffer=this._gl.createBuffer(),!l&&!r)throw Error("Must either provide data or a size to the VertexBuffer");l?this.bufferData=l:this.bufferData=new Float32Array(r),this.type=a??this.type,s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer)}unbind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,null)}upload(e){const s=this._gl;s.bindBuffer(s.ARRAY_BUFFER,this.buffer),e?s.bufferSubData(s.ARRAY_BUFFER,0,this.bufferData,0,e):s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class Qi{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(e){this._logger=ot.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:s,shader:r,vertexBuffer:a,attributes:l,suppressWarnings:_}=e;this._gl=s,this._vertexBuffer=a,this._attributes=l,this._shader=r,this._suppressWarnings=_,r&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(e){e&&this._shader!==e&&(this._shader=e,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const e=this._shader.attributes;for(const l of this._attributes){const _=e[l[0]];if(!_){if(!Ic(this._shader.vertexSource,l[0]))throw Error(`The attribute named: ${l[0]} size ${l[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${l[0]} size ${l[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${l[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${l[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const p=Rc(this._gl,this._shader.vertexSource,l[0]);this._layout.push({name:l[0],glType:p,size:l[1],location:-1,normalized:!1})}if(_){if(_.size!==l[1])throw Error(`VertexLayout size definition for attribute: [${l[0]}, ${l[1]}], doesn't match shader source size ${_.size}:
 ${this._shader.vertexSource}`);this._layout.push(_)}}let s=0;for(const l of this._layout){const _=xa(this._gl,l.glType);this._vertexTotalSizeBytes+=_*l.size,s+=l.size}this._vertexBuffer.bufferData.length%s!==0&&this._logger.warn(`The vertex component size (${s})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const r=this._gl;this._vao=r.createVertexArray(),r.bindVertexArray(this._vao),this._vertexBuffer.bind();let a=0;for(const l of this._layout)l.location!==-1&&(l.glType===r.INT?r.vertexAttribIPointer(l.location,l.size,l.glType,this.totalVertexSizeBytes,a):r.vertexAttribPointer(l.location,l.size,l.glType,l.normalized,this.totalVertexSizeBytes,a),r.enableVertexAttribArray(l.location)),a+=xa(r,l.glType)*l.size;r.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(e=!1,s){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const r=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),e&&this._vertexBuffer.upload(s),r.bindVertexArray(this._vao)}}class qt{static clear(){qt.DrawCallCount=0,qt.DrawnImagesCount=0}}qt.DrawCallCount=0,qt.DrawnImagesCount=0;class Wf{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=z(0,0),this._endScratch=z(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new $e({gl:e,vertexSource:Hf,fragmentSource:Of}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new Mi({gl:e,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new Qi({gl:e,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,r){this._isFull()&&this.flush(),this._lineCount++;const a=this._context.getTransform(),l=a.multiply(e,this._startScratch),_=a.multiply(s,this._endScratch),p=this._vertexBuffer.bufferData;p[this._vertexIndex++]=l.x,p[this._vertexIndex++]=l.y,p[this._vertexIndex++]=r.r/255,p[this._vertexIndex++]=r.g/255,p[this._vertexIndex++]=r.b/255,p[this._vertexIndex++]=r.a,p[this._vertexIndex++]=_.x,p[this._vertexIndex++]=_.y,p[this._vertexIndex++]=r.r/255,p[this._vertexIndex++]=r.g/255,p[this._vertexIndex++]=r.b/255,p[this._vertexIndex++]=r.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.LINES,0,this._lineCount*2),qt.DrawnImagesCount+=this._lineCount,qt.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const Nf=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,Gf=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class Vf{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new $e({gl:e,vertexSource:Nf,fragmentSource:Gf}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new Mi({gl:e,size:7*this._maxPoints,type:"dynamic"}),this._layout=new Qi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,r){this._isFull()&&this.flush(),this._pointCount++;const a=this._context.getTransform(),l=this._context.opacity,_=this._context.snapToPixel,p=a.multiply(e);_&&(p.x=~~(p.x+ft),p.y=~~(p.y+ft));const m=this._buffer.bufferData;m[this._vertexIndex++]=p.x,m[this._vertexIndex++]=p.y,m[this._vertexIndex++]=s.r/255,m[this._vertexIndex++]=s.g/255,m[this._vertexIndex++]=s.b/255,m[this._vertexIndex++]=s.a*l,m[this._vertexIndex++]=r*Math.max(a.getScaleX(),a.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.POINTS,0,this._pointCount),qt.DrawnImagesCount+=this._pointCount,qt.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const qf=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,Xf=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class Yf{constructor(e){this._gl=e,this._shader=new $e({gl:e,vertexSource:qf,fragmentSource:Xf}),this._shader.compile(),this._buffer=new Mi({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Qi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(e){const s=this._gl,r=e.getShader();r.use(),e.getLayout().use(),s.activeTexture(s.TEXTURE0),r.trySetUniformInt("u_image",0),e.onDraw&&e.onDraw(),s.drawArrays(s.TRIANGLES,0,6)}renderToScreen(){const e=this._gl;this._shader.use(),this._layout.use(),e.drawArrays(e.TRIANGLES,0,6)}}class Zn{constructor(e,s,r){this._logger=ot.getInstance(),this._gl=e,this.buffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer);const a=s*6;if(!r)this.bufferData=new Uint32Array(a);else{const p=Math.floor(16383.5);this.bufferGlType=e.UNSIGNED_SHORT,this.bufferData=new Uint16Array(a),s>p&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${p}) requested quads(${s})`)}let l=0;for(let _=0;_<a;_+=6)this.bufferData[_+0]=l+0,this.bufferData[_+1]=l+1,this.bufferData[_+2]=l+2,this.bufferData[_+3]=l+2,this.bufferData[_+4]=l+1,this.bufferData[_+5]=l+3,l+=4;e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const jf=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,Zf=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class $f{constructor(e){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=$.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=ba(e,r);this._maxTextures=Math.min(r,a);const l=this._transformFragmentSource(jf,this._maxTextures);this._shader=new $e({gl:e,fragmentSource:l,vertexSource:Zf}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((_,p)=>p)),this._buffer=new Mi({gl:e,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new Qi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new Zn(e,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let r=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_textureIndex <= ${l}.5) {
`:a+=`   else if (v_textureIndex <= ${l}.5) {
`,a+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return r=r.replace("%%texture_picker%%",a),r}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(Et.Filtering),r=s?fn(s):void 0,a=vi(e.getAttribute(Et.WrappingX)),l=vi(e.getAttribute(Et.WrappingY)),_=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},_);e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&(this._textures.push(p),this._textureToIndex.set(p,this._textureIndex++),this._images.add(e))}_bindTextures(e){for(let s=0;s<this._maxTextures;s++)e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_2D,this._textures[s]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const r=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(r))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,r,a,l,_,p,m,w){var y,A,E,D;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const L=this._getImageWidth(e),O=this._getImageHeight(e);let X=L||a||0,H=O||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(y=a??L)!==null&&y!==void 0?y:0,this._view[3]=(A=l??O)!==null&&A!==void 0?A:0,this._dest[0]=s??1,this._dest[1]=r??1,_!==void 0&&p!==void 0&&m!==void 0&&w!==void 0&&(this._view[0]=s??1,this._view[1]=r??1,this._view[2]=(E=a??L)!==null&&E!==void 0?E:0,this._view[3]=(D=l??O)!==null&&D!==void 0?D:0,this._dest[0]=_,this._dest[1]=p,X=m,H=w),s=this._view[0],r=this._view[1];const N=this._view[2],Q=this._view[3],Y=this._context.getTransform(),J=this._context.opacity,rt=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+X,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+H,this._quad[6]=this._dest[0]+X,this._quad[7]=this._dest[1]+H,Y.multiplyQuadInPlace(this._quad),rt&&(this._quad[0]=~~(this._quad[0]+V(this._quad[0])*ft),this._quad[1]=~~(this._quad[1]+V(this._quad[1])*ft),this._quad[2]=~~(this._quad[2]+V(this._quad[2])*ft),this._quad[3]=~~(this._quad[3]+V(this._quad[3])*ft),this._quad[4]=~~(this._quad[4]+V(this._quad[4])*ft),this._quad[5]=~~(this._quad[5]+V(this._quad[5])*ft),this._quad[6]=~~(this._quad[6]+V(this._quad[6])*ft),this._quad[7]=~~(this._quad[7]+V(this._quad[7])*ft));const Z=this._context.tint||this._defaultTint,_t=this._getTextureIdForImage(e),Tt=L||X,Gt=O||H,Xt=(s+this.uvPadding)/Tt,be=(r+this.uvPadding)/Gt,$t=(s+N-this.uvPadding)/Tt,kt=(r+Q-this.uvPadding)/Gt,ze=L,Ee=O,it=this._layout.vertexBuffer.bufferData;it[this._vertexIndex++]=this._quad[0],it[this._vertexIndex++]=this._quad[1],it[this._vertexIndex++]=J,it[this._vertexIndex++]=ze,it[this._vertexIndex++]=Ee,it[this._vertexIndex++]=Xt,it[this._vertexIndex++]=be,it[this._vertexIndex++]=_t,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a,it[this._vertexIndex++]=this._quad[4],it[this._vertexIndex++]=this._quad[5],it[this._vertexIndex++]=J,it[this._vertexIndex++]=ze,it[this._vertexIndex++]=Ee,it[this._vertexIndex++]=Xt,it[this._vertexIndex++]=kt,it[this._vertexIndex++]=_t,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a,it[this._vertexIndex++]=this._quad[2],it[this._vertexIndex++]=this._quad[3],it[this._vertexIndex++]=J,it[this._vertexIndex++]=ze,it[this._vertexIndex++]=Ee,it[this._vertexIndex++]=$t,it[this._vertexIndex++]=be,it[this._vertexIndex++]=_t,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a,it[this._vertexIndex++]=this._quad[6],it[this._vertexIndex++]=this._quad[7],it[this._vertexIndex++]=J,it[this._vertexIndex++]=ze,it[this._vertexIndex++]=Ee,it[this._vertexIndex++]=$t,it[this._vertexIndex++]=kt,it[this._vertexIndex++]=_t,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),this._quads.bind(),e.drawElements(e.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),qt.DrawnImagesCount+=this._imageCount,qt.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const Qf=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,Kf=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class Jf{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=$.Transparent,this._scratch1=z(0,0),this._scratch2=z(0,0),this._scratch3=z(0,0),this._scratch4=z(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new $e({gl:e,fragmentSource:Qf,vertexSource:Kf}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new Mi({gl:e,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new Qi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Zn(e,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...e){e[0]instanceof B&&e[1]instanceof B?this.drawLine.apply(this,e):this.drawRectangle.apply(this,e)}drawLine(e,s,r,a=1){this._isFull()&&this.flush(),this._rectangleCount++;const l=this._context.getTransform(),_=this._context.opacity,p=this._context.snapToPixel,m=s.sub(e),w=m.magnitude,y=m.normalize().perpendicular(),A=a/2,E=l.multiply(y.scale(A,this._scratch1).add(e,this._scratch1),this._scratch1),D=l.multiply(y.scale(-A,this._scratch2).add(e,this._scratch2),this._scratch2),L=l.multiply(y.scale(A,this._scratch3).add(s,this._scratch3),this._scratch3),O=l.multiply(y.scale(-A,this._scratch4).add(s,this._scratch4),this._scratch4);p&&(E.x=~~(E.x+ft),E.y=~~(E.y+ft),L.x=~~(L.x+ft),L.y=~~(L.y+ft),D.x=~~(D.x+ft),D.y=~~(D.y+ft),O.x=~~(O.x+ft),O.y=~~(O.y+ft));const X=0,H=0,N=1,Q=1,Y=this._transparent,J=0,rt=1,Z=this._layout.vertexBuffer.bufferData;Z[this._vertexIndex++]=E.x,Z[this._vertexIndex++]=E.y,Z[this._vertexIndex++]=X,Z[this._vertexIndex++]=H,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=_,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=J/rt,Z[this._vertexIndex++]=D.x,Z[this._vertexIndex++]=D.y,Z[this._vertexIndex++]=X,Z[this._vertexIndex++]=Q,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=_,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=J/rt,Z[this._vertexIndex++]=L.x,Z[this._vertexIndex++]=L.y,Z[this._vertexIndex++]=N,Z[this._vertexIndex++]=H,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=_,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=J/rt,Z[this._vertexIndex++]=O.x,Z[this._vertexIndex++]=O.y,Z[this._vertexIndex++]=N,Z[this._vertexIndex++]=Q,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=_,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=J/rt}drawRectangle(e,s,r,a,l=$.Transparent,_=0){this._isFull()&&this.flush(),this._rectangleCount++;const p=this._context.getTransform(),m=this._context.opacity,w=this._context.snapToPixel,y=p.multiply(e.add(z(0,0))),A=p.multiply(e.add(z(s,0))),E=p.multiply(e.add(z(s,r))),D=p.multiply(e.add(z(0,r)));w&&(y.x=~~(y.x+ft),y.y=~~(y.y+ft),A.x=~~(A.x+ft),A.y=~~(A.y+ft),D.x=~~(D.x+ft),D.y=~~(D.y+ft),E.x=~~(E.x+ft),E.y=~~(E.y+ft));const L=0,O=0,X=1,H=1,N=this._layout.vertexBuffer.bufferData;N[this._vertexIndex++]=y.x,N[this._vertexIndex++]=y.y,N[this._vertexIndex++]=L,N[this._vertexIndex++]=O,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=_,N[this._vertexIndex++]=D.x,N[this._vertexIndex++]=D.y,N[this._vertexIndex++]=L,N[this._vertexIndex++]=H,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=_,N[this._vertexIndex++]=A.x,N[this._vertexIndex++]=A.y,N[this._vertexIndex++]=X,N[this._vertexIndex++]=O,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=_,N[this._vertexIndex++]=E.x,N[this._vertexIndex++]=E.y,N[this._vertexIndex++]=X,N[this._vertexIndex++]=H,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=_}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),qt.DrawnImagesCount+=this._rectangleCount,qt.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const tp=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,ep=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class ip{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new $e({gl:e,fragmentSource:tp,vertexSource:ep}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new Mi({gl:e,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new Qi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Zn(e,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(e,s,r,a=$.Transparent,l=0){this._isFull()&&this.flush(),this._circleCount++;const _=this._context.getTransform(),p=this._context.opacity,m=this._context.snapToPixel,w=_.multiply(e.add(z(-s,-s))),y=_.multiply(e.add(z(s,-s))),A=_.multiply(e.add(z(s,s))),E=_.multiply(e.add(z(-s,s)));m&&(w.x=~~(w.x+ft),w.y=~~(w.y+ft),y.x=~~(y.x+ft),y.y=~~(y.y+ft),E.x=~~(E.x+ft),E.y=~~(E.y+ft),A.x=~~(A.x+ft),A.y=~~(A.y+ft));const D=0,L=0,O=1,X=1,H=this._layout.vertexBuffer.bufferData;H[this._vertexIndex++]=w.x,H[this._vertexIndex++]=w.y,H[this._vertexIndex++]=D,H[this._vertexIndex++]=L,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=E.x,H[this._vertexIndex++]=E.y,H[this._vertexIndex++]=D,H[this._vertexIndex++]=X,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=y.x,H[this._vertexIndex++]=y.y,H[this._vertexIndex++]=O,H[this._vertexIndex++]=L,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=A.x,H[this._vertexIndex++]=A.y,H[this._vertexIndex++]=O,H[this._vertexIndex++]=X,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),qt.DrawnImagesCount+=this._circleCount,qt.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class $r{constructor(e,s,r=100){this.builder=e,this.recycler=s,this.maxObjects=r,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=ot.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let e=0;e<this.maxObjects;e++)this.objects[e]=this.builder()}using(e){const s=e(this);return s?this.done(...s):this.done()}borrow(e){const s=this.get();e(s),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...e){this.index=0;for(const s of e){const r=this.objects.indexOf(s);this.objects[r]=this.builder(),this.totalAllocations++}return e}}class sp{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=he.identity(),this.state={z:0,opacity:1,tint:$.White,material:null},this.args=new Array(10)}}const np=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class Fc{constructor(e){this._logger=ot.getInstance(),this._color=$.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:s,name:r,vertexSource:a,fragmentSource:l,graphicsContext:_,images:p}=e;if(this._name=r??"anonymous material",this._vertexSource=a??np,this._fragmentSource=l,this._color=s??this._color,!_)throw Error(`Material ${r} must be provided an excalibur webgl graphics context`);if(_ instanceof Ji?(this._graphicsContext=_,this._initialize(_)):this._logger.warn(`Material ${r} was created in 2D Canvas mode, currently only WebGL is supported`),p)for(const m in p)this.addImageSource(m,p[m])}_initialize(e){if(this._initialized)return;const s=e.__gl;this._maxTextureSlots=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=e.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(e){this._color=e}get name(){var e;return(e=this._name)!==null&&e!==void 0?e:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(e){this._shader&&(this._shader.use(),e(this._shader))}getShader(){return this._shader}addImageSource(e,s){this._images.size<this._maxTextureSlots?this._images.set(e,s):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(e){const s=this._images.get(e);this._graphicsContext.textureLoader.delete(s.image),this._images.delete(e)}_loadImageSource(e){const s=e.image,r=s.getAttribute(Et.Filtering),a=r?fn(r):void 0,l=vi(s.getAttribute(Et.WrappingX)),_=vi(s.getAttribute(Et.WrappingY)),p=s.getAttribute("forceUpload")==="true",m=this._graphicsContext.textureLoader.load(s,{filtering:a,wrapping:{x:l,y:_}},p);return s.removeAttribute("forceUpload"),this._textures.has(e)||this._textures.set(e,m),m}uploadAndBind(e,s=2){let r=s;for(const[a,l]of this._images.entries()){if(!l.isLoaded()){this._logger.warnOnce(`Image named ${a} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const _=this._loadImageSource(l);e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,_),this._shader.trySetUniformInt(a,r),r++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class Bc{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(e,s){this._gl=e,this._context=s,this._buffer=new Mi({gl:e,size:6*4,type:"dynamic"}),this._layout=new Qi({gl:e,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new Zn(e,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(e,s,r,a,l,_,p,m,w){var y,A,E,D;const L=this._gl,O=this._context.material;if(!O)return;const X=this._context.getTransform(),H=this._context.opacity,N=O.getShader(),Q=this._layout.vertexBuffer.bufferData;let Y=0,J=e?.width||a||0,rt=e?.height||l||0,Z=[0,0,(y=a??e?.width)!==null&&y!==void 0?y:0,(A=l??e?.height)!==null&&A!==void 0?A:0],_t=[s??1,r??1];_!==void 0&&p!==void 0&&m!==void 0&&w!==void 0&&(Z=[s??1,r??1,(E=a??e?.width)!==null&&E!==void 0?E:0,(D=l??e?.height)!==null&&D!==void 0?D:0],_t=[_,p],J=m,rt=w),s=Z[0],r=Z[1];const Tt=Z[2],Gt=Z[3],Xt=z(_t[0],_t[1]),be=z(_t[0]+J,_t[1]),$t=z(_t[0],_t[1]+rt),kt=z(_t[0]+J,_t[1]+rt),ze=e.width||J,Ee=e.height||rt,it=s/ze,Zs=r/Ee,$s=(s+Tt-.01)/ze,Qs=(r+Gt-.01)/Ee,Sn=X.getPosition(),cu=Sn.add(kt),du=Sn.x/this._context.width,uu=Sn.y/this._context.height,_u=cu.x/this._context.width,fu=cu.y/this._context.height;Q[Y++]=Xt.x,Q[Y++]=Xt.y,Q[Y++]=it,Q[Y++]=Zs,Q[Y++]=du,Q[Y++]=uu,Q[Y++]=$t.x,Q[Y++]=$t.y,Q[Y++]=it,Q[Y++]=Qs,Q[Y++]=du,Q[Y++]=fu,Q[Y++]=be.x,Q[Y++]=be.y,Q[Y++]=$s,Q[Y++]=Zs,Q[Y++]=_u,Q[Y++]=uu,Q[Y++]=kt.x,Q[Y++]=kt.y,Q[Y++]=$s,Q[Y++]=Qs,Q[Y++]=_u,Q[Y++]=fu;const Pg=this._addImageAsTexture(e);O.use(),this._layout.shader=N,this._layout.use(!0),N.trySetUniformFloat("u_time_ms",performance.now()),N.trySetUniformFloat("u_opacity",H),N.trySetUniformFloatVector("u_resolution",z(this._context.width,this._context.height)),N.trySetUniformFloatVector("u_graphic_resolution",z(ze,Ee)),N.trySetUniformFloatVector("u_size",z(Tt,Gt)),N.trySetUniformMatrix("u_matrix",this._context.ortho),N.trySetUniformMatrix("u_transform",X.to4x4()),L.activeTexture(L.TEXTURE0+0),L.bindTexture(L.TEXTURE_2D,Pg),N.trySetUniformInt("u_graphic",0),L.activeTexture(L.TEXTURE0+1),L.bindTexture(L.TEXTURE_2D,this._context.materialScreenTexture),N.trySetUniformInt("u_screen_texture",1),O.uploadAndBind(L),this._quads.bind(),L.drawElements(L.TRIANGLES,6,this._quads.bufferGlType,0),qt.DrawnImagesCount++,qt.DrawCallCount++}_addImageAsTexture(e){const s=e.getAttribute(Et.Filtering),r=s?fn(s):void 0,a=vi(e.getAttribute(Et.WrappingX)),l=vi(e.getAttribute(Et.WrappingY)),_=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},_);return e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&this._textures.push(p),p}hasPendingDraws(){return!1}flush(){}}const rp=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,op=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var Pe;(function(u){u.World="world",u.Screen="screen"})(Pe||(Pe={}));class ya extends B{constructor(e){super(0,0),this._getX=e.getX,this._getY=e.getY,this._setX=e.setX,this._setY=e.setY}get x(){return this._x=this._getX()}set x(e){this._setX(e),this._x=e}get y(){return this._y=this._getY()}set y(e){this._setY(e),this._y=e}}class ws extends B{constructor(e,s){super(e.x,e.y),this.original=e,this.change=s}get x(){return this._x=this.original.x}set x(e){e!==this._x&&(this.change(e,this._y),this._x=this.original.x=e)}get y(){return this._y=this.original.y}set y(e){e!==this._y&&(this.change(this._x,e),this._y=this.original.y=e)}setTo(e,s){this.x=e,this.y=s}}class Ki{constructor(){this._parent=null,this._children=[],this._pos=new ws(z(0,0),()=>{this.flagDirty()}),this._globalPos=new ya({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:e=>{if(this.parent){const{x:s}=this.parent.inverse.multiply(z(e,this.pos.y));this.pos.x=s}else this.pos.x=e;e!==this.matrix.data[4]&&this.flagDirty()},setY:e=>{if(this.parent){const{y:s}=this.parent.inverse.multiply(z(this.pos.x,e));this.pos.y=s}else this.pos.y=e;e!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new ws(z(1,1),()=>{this.flagDirty()}),this._globalScale=new ya({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:e=>{if(this.parent){const s=this.parent.globalScale.x;this.scale.x=e/s}else this.scale.x=e},setY:e=>{if(this.parent){const s=this.parent.globalScale.y;this.scale.y=e/s}else this.scale.y=e}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=he.identity(),this._inverse=he.identity(),this._scratch=he.identity()}get parent(){return this._parent}set parent(e){if(this._parent){const s=this._parent._children.indexOf(this);s>-1&&this._parent._children.splice(s,1)}this._parent=e,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(e){this._pos.x=e.x,this._pos.y=e.y}get pos(){return this._pos}set globalPos(e){let s=e.clone();this.parent&&(s=this.parent.inverse.multiply(e)),s.equals(this._pos)||(this._pos=s,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(e){const s=nt(e);s!==this._rotation&&this.flagDirty(),this._rotation=s}get rotation(){return this._rotation}set globalRotation(e){let s=0;this.parent&&(s=this.parent.globalRotation);const r=nt(e+s);r!==this._rotation&&this.flagDirty(),this._rotation=r}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(e){this._scale.x=e.x,this._scale.y=e.y}get scale(){return this._scale}set globalScale(e){let s=z(1,1);this.parent&&(s=this.parent.globalScale),this.scale=e.scale(z(1/s.x,1/s.y))}get globalScale(){return this._globalScale}set z(e){this._z=e,this.flagDirty()}get z(){return this._z}set globalZ(e){this.parent?this.z=e-this.parent.globalZ:this.z=e}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let e=0;e<this._children.length;e++)this._children[e].flagDirty()}apply(e){return this.matrix.multiply(e)}applyInverse(e){return this.inverse.multiply(e)}setTransform(e,s,r){this._pos.x=e.x,this._pos.y=e.y,this._rotation=nt(s),this._scale.x=r.x,this._scale.y=r.y,this.flagDirty()}isMirrored(){const e=V(this.scale.x)>>>31,s=V(this.scale.y)>>>31;return!!(e^s)}clone(e){const s=e??new Ki;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.flagDirty(),s}cloneWithParent(e){const s=e??new Ki;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.parent=this.parent,s.flagDirty(),s}toString(){return this.matrix.toString()}}function kc(u){return!!u&&!!u.prototype&&!!u.prototype.constructor}function ap(u){return!!u?.clone}class _i{constructor(){this.owner=void 0}clone(){const e=new this.constructor;for(const s in this)if(this.hasOwnProperty(s)){const r=this[s];ap(r)&&s!=="owner"&&s!=="clone"?e[s]=r.clone():e[s]=r}return e}}class Ne{constructor(){this.observers=[],this.subscriptions=[]}register(e){this.observers.push(e)}subscribe(e){this.subscriptions.push(e)}unregister(e){const s=this.observers.indexOf(e);s!==-1&&this.observers.splice(s,1)}unsubscribe(e){const s=this.subscriptions.indexOf(e);s!==-1&&this.subscriptions.splice(s,1)}notifyAll(e){const s=this.observers.length;for(let a=0;a<s;a++)this.observers[a].notify(e);const r=this.subscriptions.length;for(let a=0;a<r;a++)this.subscriptions[a](e)}clear(){this.observers.length=0,this.subscriptions.length=0}}class et extends _i{constructor(){super(...arguments),this._logger=ot.getInstance(),this._parentComponent=null,this._transform=new Ki,this._addChildTransform=e=>{const s=e.get(et);s&&(s._transform.parent=this._transform,s._parentComponent=this)},this.zIndexChanged$=new Ne,this._coordPlane=Pe.World}get(){return this._transform}onAdd(e){for(const s of e.children)this._addChildTransform(s);e.childrenAdded$.subscribe(s=>this._addChildTransform(s)),e.childrenRemoved$.subscribe(s=>{const r=s.get(et);r&&(r._transform.parent=null,r._parentComponent=null)})}onRemove(e){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(e){const s=this._transform.z;this._transform.z=e,s!==e&&this.zIndexChanged$.notifyAll(e)}get globalZ(){return this._transform.globalZ}set globalZ(e){this._transform.globalZ=e}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(e){var s;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(s=this.owner)===null||s===void 0?void 0:s.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=e}get pos(){return this._transform.pos}set pos(e){this._transform.pos=e}get globalPos(){return this._transform.globalPos}set globalPos(e){this._transform.globalPos=e}get rotation(){return this._transform.rotation}set rotation(e){this._transform.rotation=e}get globalRotation(){return this._transform.globalRotation}set globalRotation(e){this._transform.globalRotation=e}get scale(){return this._transform.scale}set scale(e){this._transform.scale=e}get globalScale(){return this._transform.globalScale}set globalScale(e){this._transform.globalScale=e}applyInverse(e){return this._transform.applyInverse(e)}apply(e){return this._transform.apply(e)}clone(){const e=new et;return e._transform=this._transform.clone(),e}}var $n;(function(u){u.Forward="forward",u.Backward="backward"})($n||($n={}));var wi;(function(u){u.End="end",u.Loop="loop",u.PingPong="pingpong",u.Freeze="freeze"})(wi||(wi={}));const hp={Frame:"frame",Loop:"loop",End:"end"};class xi extends Qt{constructor(e){var s,r,a;super(e),this.events=new I,this.frames=[],this.strategy=wi.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=e.frames,this.speed=(s=e.speed)!==null&&s!==void 0?s:this.speed,this.strategy=(r=e.strategy)!==null&&r!==void 0?r:this.strategy,this.frameDuration=e.totalDuration?e.totalDuration/this.frames.length:(a=e.frameDuration)!==null&&a!==void 0?a:this.frameDuration,e.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new xi({frames:this.frames.map(e=>({...e})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.width*this.scale.x):0}get height(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.height*this.scale.y):0}static fromSpriteSheet(e,s,r,a=wi.Loop){const l=e.sprites.length-1,_=s.filter(p=>p<0||p>l);return _.length&&xi._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${_.join(",")} no frame will be shown`),new xi({frames:e.sprites.filter((p,m)=>s.indexOf(m)>-1).map(p=>({graphic:p,duration:r})),strategy:a})}static fromSpriteSheetCoordinates(e){var s;const{spriteSheet:r,frameCoordinates:a,durationPerFrame:l,durationPerFrameMs:_,speed:p,strategy:m,reverse:w}=e,y=(s=l??_)!==null&&s!==void 0?s:100,A=[];for(const E of a){const{x:D,y:L,duration:O,options:X}=E,H=r.getSprite(D,L,X);H?A.push({graphic:H,duration:O??y}):xi._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${D}, ${L}), please check your SpriteSheet to confirm that sprite exists`)}return new xi({frames:A,strategy:m,speed:p,reverse:w})}get speed(){return this._speed}set speed(e){this._speed=j(Math.abs(e),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?$n.Backward:$n.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const e=this.frames[this._currentFrame];e&&(this._timeLeftInFrame=e?.duration||this.frameDuration)}get canFinish(){switch(this.strategy){case wi.End:case wi.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(e,s){this._currentFrame=e,this._timeLeftInFrame=s??this.frameDuration;const r=this.frames[this._currentFrame];r&&!this._done&&(this._timeLeftInFrame=s??(r?.duration||this.frameDuration),this.events.emit("frame",{...r,frameIndex:this.currentFrameIndex}))}_nextFrame(){const e=this._currentFrame;if(this._done)return e;let s=-1;switch(this.strategy){case wi.Loop:{s=(e+1)%this.frames.length,s===0&&this.events.emit("loop",this);break}case wi.End:{s=e+1,s>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case wi.Freeze:{s=j(e+1,0,this.frames.length-1),s>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case wi.PingPong:{e+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),e+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),s=e+this._pingPongDirection%this.frames.length;break}}return s}tick(e,s=0){this._idempotencyToken!==s&&(this._idempotencyToken=s,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=e*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(e,s,r){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(e,s,r)}}xi._LOGGER=ot.getInstance();class pn extends Qt{constructor(e){var s;super(e),this._logger=ot.getInstance(),this.useAnchor=!0,this.members=[],this.members=e.members,this.useAnchor=(s=e.useAnchor)!==null&&s!==void 0?s:this.useAnchor,this._updateDimensions()}clone(){return new pn({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const e=this.localBounds;return this.width=e.width,this.height=e.height,e}get localBounds(){const e=new at;for(const s of this.members)if(s instanceof Qt)s.localBounds.combine(e,e);else{const{graphic:r,offset:a,useBounds:l}=s;r?(l===void 0?!0:l)&&r.localBounds.translate(a).combine(e,e):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(s)}.`)}return e}_isAnimationOrGroup(e){return e instanceof xi||e instanceof pn}tick(e,s){for(const r of this.members){let a;r instanceof Qt?a=r:a=r.graphic,this._isAnimationOrGroup(a)&&a.tick(e,s)}}reset(){for(const e of this.members){let s;e instanceof Qt?s=e:s=e.graphic,this._isAnimationOrGroup(s)&&s.reset()}}_preDraw(e,s,r){this._updateDimensions(),super._preDraw(e,this.useAnchor?s:0,this.useAnchor?r:0)}_drawImage(e,s,r){const a=B.Zero;for(const l of this.members){let _;l instanceof Qt?_=l:(_=l.graphic,l.offset.clone(a)),_&&(e.save(),e.translate(s,r),_.draw(e,a.x,a.y),this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore())}}}class gn extends Qt{constructor(e){var s,r,a,l,_,p,m,w,y,A;super(Pc({...e},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=gi($.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,e&&(this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this.color=(r=e.color)!==null&&r!==void 0?r:$.Black,this.strokeColor=e?.strokeColor,this.smoothing=(a=e.smoothing)!==null&&a!==void 0?a:this.smoothing,this.lineWidth=(l=e.lineWidth)!==null&&l!==void 0?l:this.lineWidth,this.lineDash=(_=e.lineDash)!==null&&_!==void 0?_:this.lineDash,this.lineCap=(p=e.lineCap)!==null&&p!==void 0?p:this.lineCap,this.padding=(m=e.padding)!==null&&m!==void 0?m:this.padding,this.filtering=(w=e.filtering)!==null&&w!==void 0?w:this.filtering),this._bitmap=document.createElement("canvas");const E=(y=e?.width)!==null&&y!==void 0?y:this._bitmap.width,D=(A=e?.height)!==null&&A!==void 0?A:this._bitmap.height;this.width=E,this.height=D;const L=this._bitmap.getContext("2d");if(L)this._ctx=L;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(e){e/=Math.abs(this.scale.x),this._bitmap.width=e,this._originalWidth=e,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(e){e/=Math.abs(this.scale.y),this._bitmap.height=e,this._originalHeight=e,this.flagDirty()}_getTotalWidth(){var e;return(((e=this._originalWidth)!==null&&e!==void 0?e:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var e;return(((e=this._originalHeight)!==null&&e!==void 0?e:this._bitmap.height)+this.padding*2)*1}get localBounds(){return at.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,B.Zero)}get smoothing(){return this._smoothing}set smoothing(e){this._smoothing=e,this.flagDirty()}get color(){return this._color}set color(e){this.flagDirty(),this._color=gi(e,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(e){this.flagDirty(),e&&(this._strokeColor=gi(e,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(e){this._lineDash=e,this.flagDirty()}get padding(){return this._padding}set padding(e){this._padding=e,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(e){var s,r,a,l;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),e.scale(this.quality,this.quality),e.translate(this.padding,this.padding),e.imageSmoothingEnabled=this.smoothing,e.lineWidth=this.lineWidth,e.setLineDash((s=this.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.lineCap=this.lineCap,e.strokeStyle=(a=(r=this.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&a!==void 0?a:"",e.fillStyle=(l=this.color)===null||l===void 0?void 0:l.toString()}_drawImage(e,s,r){this._dirty&&this.rasterize(),e.scale(1/this.quality,1/this.quality),e.drawImage(this._bitmap,s,r)}}var Qr;(function(u){u.Em="em",u.Rem="rem",u.Px="px",u.Pt="pt",u.Percent="%"})(Qr||(Qr={}));var Kr;(function(u){u.Left="left",u.Right="right",u.Center="center",u.Start="start",u.End="end"})(Kr||(Kr={}));var Jr;(function(u){u.Top="top",u.Hanging="hanging",u.Middle="middle",u.Alphabetic="alphabetic",u.Ideographic="ideographic",u.Bottom="bottom"})(Jr||(Jr={}));var to;(function(u){u.Normal="normal",u.Italic="italic",u.Oblique="oblique"})(to||(to={}));var eo;(function(u){u.LeftToRight="ltr",u.RightToLeft="rtl"})(eo||(eo={}));function Aa(u,e=$.Red,s,r,a,l,_=1,p="butt"){u.save(),u.beginPath(),u.lineWidth=_,u.lineCap=p,u.strokeStyle=e.toString(),u.moveTo(s,r),u.lineTo(a,l),u.closePath(),u.stroke(),u.restore()}function lp(u,e=$.Red,s){u.beginPath(),u.strokeStyle=e.toString(),u.arc(s.x,s.y,5,0,Math.PI*2),u.closePath(),u.stroke()}function cp(u,e,s,r,a=1){const l=e?e.toString():"blue",_=r.scale(a);u.beginPath(),u.strokeStyle=l,u.moveTo(s.x,s.y),u.lineTo(s.x+_.x,s.y+_.y),u.closePath(),u.stroke()}function Ca(u,e,s,r,a,l=5,_=$.White,p=null){let m;if(typeof l=="number")m={tl:l,tr:l,br:l,bl:l};else{const w={tl:0,tr:0,br:0,bl:0};for(const y in w)if(w.hasOwnProperty(y)){const A=y;m[A]=l[A]||w[A]}}u.beginPath(),u.moveTo(e+m.tl,s),u.lineTo(e+r-m.tr,s),u.quadraticCurveTo(e+r,s,e+r,s+m.tr),u.lineTo(e+r,s+a-m.br),u.quadraticCurveTo(e+r,s+a,e+r-m.br,s+a),u.lineTo(e+m.bl,s+a),u.quadraticCurveTo(e,s+a,e,s+a-m.bl),u.lineTo(e,s+m.tl),u.quadraticCurveTo(e,s,e+m.tl,s),u.closePath(),p&&(u.fillStyle=p.toString(),u.fill()),_&&(u.strokeStyle=_.toString(),u.stroke())}function dp(u,e,s,r,a=$.White,l=null){u.beginPath(),u.arc(e,s,r,0,Math.PI*2),u.closePath(),l&&(u.fillStyle=l.toString(),u.fill()),a&&(u.strokeStyle=a.toString(),u.stroke())}class mn{constructor(e,s,r,a){this.font=e,this.text=s,this.color=r,this.maxWidth=a,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const l=this.canvas.getContext("2d");if(!l)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=l,this.dimensions=this.measureText(s),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(e,s){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let r=null;s!=null?r=this._getLinesFromText(e,s):r=e.split(`
`);const a=r.reduce((E,D)=>E.length>D.length?E:D);this._applyFont(this.ctx);const l=this.ctx.measureText(a);let _=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);const p=_*r.length;_=p;const m=p-Math.abs(l.actualBoundingBoxAscent),w=0,y=0;return new at({left:w-Math.abs(l.actualBoundingBoxLeft)-this.font.padding,top:y-Math.abs(l.actualBoundingBoxAscent)-this.font.padding,bottom:y+m+this.font.padding,right:w+Math.abs(l.actualBoundingBoxRight)+this.font.padding})}_setDimension(e,s){let r=1;this.font.lineHeight&&(r=this.font.lineHeight/this.font.size),s.canvas.width=(e.width+this.font.padding*2)*2*this.font.quality,s.canvas.height=(e.height+this.font.padding*2)*2*this.font.quality*r}static getHashCode(e,s,r){var a;return s+"__hashcode__"+e.fontString+e.showDebug+e.textAlign+e.baseAlign+e.direction+e.lineHeight+JSON.stringify(e.shadow)+(e.padding.toString()+e.smoothing.toString()+e.lineWidth.toString()+e.lineDash.toString()+((a=e.strokeColor)===null||a===void 0?void 0:a.toString())+(r?r.toString():e.color.toString()))}getHashCode(e=!0){return mn.getHashCode(this.font,this.text,e?this.color:void 0)}_applyRasterProperties(e){var s,r,a;e.translate(this.font.padding,this.font.padding),e.imageSmoothingEnabled=this.font.smoothing,e.lineWidth=this.font.lineWidth,e.setLineDash((s=this.font.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.strokeStyle=(a=(r=this.font.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&a!==void 0?a:"",e.fillStyle=this.color.toString()}_applyFont(e){e.resetTransform(),e.translate(this.font.padding+e.canvas.width/2,this.font.padding+e.canvas.height/2),e.scale(this.font.quality,this.font.quality),e.textAlign=this.font.textAlign,e.textBaseline=this.font.baseAlign,e.font=this.font.fontString,e.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(e.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(e.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(e.shadowOffsetX=this.font.shadow.offset.x,e.shadowOffsetY=this.font.shadow.offset.y))}_drawText(e,s,r){this._applyRasterProperties(e),this._applyFont(e);for(let a=0;a<s.length;a++){const l=s[a];this.color&&e.fillText(l,0,a*r),this.font.strokeColor&&e.strokeText(l,0,a*r)}this.font.showDebug&&(Aa(e,$.Green,-e.canvas.width/2,0,e.canvas.width/2,0,2),Aa(e,$.Red,0,-e.canvas.height/2,0,e.canvas.height/2,2))}_splitTextBitmap(e){const s=[];let r=0,a=0;const l=Math.min(4096,e.canvas.width),_=Math.min(4096,e.canvas.height);for(;r<e.canvas.width;){for(;a<e.canvas.height;){const p=document.createElement("canvas");p.width=l,p.height=_;const m=p.getContext("2d");if(!m)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");m.drawImage(e.canvas,r,a,l,_,0,0,l,_),s.push({x:r,y:a,canvas:p}),a+=_}r+=l,a=0}return s}flagDirty(){this._dirty=!0}render(e,s,r,a){var l;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=e;const _=this.getHashCode();if(this._lastHashCode!==_&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,a),this._setDimension(this.dimensions,this.ctx);const p=this._getLinesFromText(this.text,a),m=(l=this.font.lineHeight)!==null&&l!==void 0?l:this.dimensions.height/p.length;if(this._drawText(this.ctx,p,m),e instanceof Ji)for(const w of this._textFragments)e.textureLoader.delete(w.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),e instanceof Ji)for(const w of this._textFragments)e.textureLoader.load(w.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=_,this._dirty=!1}for(const p of this._textFragments)e.drawImage(p.canvas,0,0,p.canvas.width,p.canvas.height,p.x/this.font.quality+s-this.ctx.canvas.width/this.font.quality/2,p.y/this.font.quality+r-this.ctx.canvas.height/this.font.quality/2,p.canvas.width/this.font.quality,p.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof Ji)for(const e of this._textFragments)this._ex.textureLoader.delete(e.canvas);this._textFragments.length=0}_getLinesFromText(e,s){var r;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let _=a[l],p="";if(this.measureText(_).width>s){for(;this.measureText(_).width>s;)p=_[_.length-1]+p,_=_.slice(0,-1);a[l]=_,a[l+1]=p}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class Ft{static measureText(e,s,r){const a=mn.getHashCode(s,e);if(Ft._MEASURE_CACHE.has(a))return Ft._MEASURE_CACHE.get(a);Ft._LOGGER.debug("Font text measurement cache miss");const l=s.measureTextWithoutCache(e,r);return Ft._MEASURE_CACHE.set(a,l),l}static getTextInstance(e,s,r){const a=mn.getHashCode(s,e,r);let l=Ft._TEXT_CACHE.get(a);return l||(l=new mn(s,e,r),Ft._TEXT_CACHE.set(a,l),Ft._LOGGER.debug("Font text instance cache miss")),Ft._TEXT_USAGE.set(l,performance.now()),l}static checkAndClearCache(){const e=[],s=new Set;for(const[a,l]of Ft._TEXT_USAGE.entries())if(l+Ft.FONT_TIMEOUT<performance.now())Ft._LOGGER.debug(`Text cache entry timed out ${a.text}`),e.push(a),a.dispose();else{const _=a.getHashCode(!1);s.add(_)}e.forEach(a=>{Ft._TEXT_USAGE.delete(a)}),this._TEXT_CACHE.clear();for(const[a]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(a.getHashCode(),a);const r=new Map;for(const a of s)Ft._MEASURE_CACHE.has(a)&&r.set(a,Ft._MEASURE_CACHE.get(a));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=r}static get cacheSize(){return Ft._TEXT_USAGE.size}static clearCache(){for(const[e]of Ft._TEXT_USAGE.entries())e.dispose();Ft._TEXT_USAGE.clear(),Ft._TEXT_CACHE.clear(),Ft._MEASURE_CACHE.clear()}}Ft.FONT_TIMEOUT=500,Ft._LOGGER=ot.getInstance(),Ft._TEXT_USAGE=new Map,Ft._TEXT_CACHE=new Map,Ft._MEASURE_CACHE=new Map;class Hs extends Qt{constructor(e={}){var s,r,a,l,_,p,m,w,y,A,E,D,L,O,X,H,N,Q,Y,J;super(e),this.filtering=le.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=$.Black,this.family="sans-serif",this.style=to.Normal,this.bold=!1,this.unit=Qr.Px,this.textAlign=Kr.Left,this.baseAlign=Jr.Top,this.direction=eo.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new at,this._textMeasurement=new mn(this,"",$.Black),this.smoothing=(s=e?.smoothing)!==null&&s!==void 0?s:this.smoothing,this.padding=(r=e?.padding)!==null&&r!==void 0?r:this.padding,this.color=(a=e?.color)!==null&&a!==void 0?a:this.color,this.strokeColor=(l=e?.strokeColor)!==null&&l!==void 0?l:this.strokeColor,this.lineDash=(_=e?.lineDash)!==null&&_!==void 0?_:this.lineDash,this.lineWidth=(p=e?.lineWidth)!==null&&p!==void 0?p:this.lineWidth,this.filtering=(m=e?.filtering)!==null&&m!==void 0?m:this.filtering,this.family=(w=e?.family)!==null&&w!==void 0?w:this.family,this.style=(y=e?.style)!==null&&y!==void 0?y:this.style,this.bold=(A=e?.bold)!==null&&A!==void 0?A:this.bold,this.size=(E=e?.size)!==null&&E!==void 0?E:this.size,this.unit=(D=e?.unit)!==null&&D!==void 0?D:this.unit,this.textAlign=(L=e?.textAlign)!==null&&L!==void 0?L:this.textAlign,this.baseAlign=(O=e?.baseAlign)!==null&&O!==void 0?O:this.baseAlign,this.direction=(X=e?.direction)!==null&&X!==void 0?X:this.direction,this.lineHeight=(H=e?.lineHeight)!==null&&H!==void 0?H:this.lineHeight,this.quality=(N=e?.quality)!==null&&N!==void 0?N:this.quality,e?.shadow&&(this.shadow={},this.shadow.blur=(Q=e.shadow.blur)!==null&&Q!==void 0?Q:this.shadow.blur,this.shadow.offset=(Y=e.shadow.offset)!==null&&Y!==void 0?Y:this.shadow.offset,this.shadow.color=(J=e.shadow.color)!==null&&J!==void 0?J:this.shadow.color)}clone(){return new Hs({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(e,s,r){}_rotate(e){var s;const r=(s=this.origin)!==null&&s!==void 0?s:this._textBounds.center;e.translate(r.x,r.y),e.rotate(this.rotation),e.translate(-r.x,-r.y)}_flip(e){this.flipHorizontal&&(e.translate(this._textBounds.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,-this._textBounds.height/2/this.scale.y),e.scale(1,-1))}measureTextWithoutCache(e,s){return this._textMeasurement.measureText(e,s)}measureText(e,s){return Ft.measureText(e,this,s)}_postDraw(e){e.restore()}render(e,s,r,a,l,_){const p=Ft.getTextInstance(s,this,r);this._textBounds=p.dimensions,this._preDraw(e,a,l),p.render(e,a,l,_),this._postDraw(e)}}class Qn extends Qt{constructor(e){var s,r;super(e),this._text="",this._textWidth=0,this._textHeight=0,this.font=(s=e.font)!==null&&s!==void 0?s:new Hs,this.color=(r=e.color)!==null&&r!==void 0?r:this.color,this.text=e.text,this.maxWidth=e.maxWidth}clone(){var e,s;return new Qn({text:this.text.slice(),color:(s=(e=this.color)===null||e===void 0?void 0:e.clone())!==null&&s!==void 0?s:$.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(e){this._text=e,this._calculateDimension()}get font(){return this._font}set font(e){this._font=e}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:e,height:s}=this.font.measureText(this._text,this.maxWidth);this._textWidth=e,this._textHeight=s}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(e){}_flip(e){}_preDraw(e,s,r){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(e,s,r)}_drawImage(e,s,r){var a;let l=$.Black;this.font instanceof Hs&&(l=(a=this.color)!==null&&a!==void 0?a:this.font.color);const{width:_,height:p}=this.font.measureText(this._text,this.maxWidth);this._textWidth=_,this._textHeight=p,this.font.render(e,this._text,l,s,r,this.maxWidth),this.font.showDebug&&(e.debug.drawRect(s-_,r-p,_*2,p*2),this.maxWidth!=null&&e.debug.drawRect(s,r,this.maxWidth,this.height,{color:$.Yellow}))}}function Ta(u){return!!u.tick}class Jt extends _i{get visible(){return this.isVisible}set visible(e){this.isVisible=e}get offset(){return this._offset}set offset(e){this._offset=new ws(e,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(e){this._anchor=new ws(e,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(e){if(e){this._color=e.clone();const s=this.graphics.current;(s instanceof gn||s instanceof Qn)&&(s.color=this._color)}}constructor(e){super(),this._logger=ot.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new ws(B.Zero,()=>this.recalculateBounds()),this._anchor=new ws(B.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,e={visible:this.isVisible,graphics:{},...e};const{current:s,anchor:r,color:a,opacity:l,visible:_,graphics:p,offset:m,copyGraphics:w,onPreDraw:y,onPostDraw:A,onPreTransformDraw:E,onPostTransformDraw:D}=e;for(const[L,O]of Object.entries(p))O instanceof Qt?this._graphics[L]=O:(this._graphics[L]=O.graphic,this._options[L]=O.options);this.offset=m??this.offset,this.opacity=l??this.opacity,this.anchor=r??this.anchor,this.color=a??this.color,this.copyGraphics=w??this.copyGraphics,this.onPreDraw=y??this.onPreDraw,this.onPostDraw=A??this.onPostDraw,this.onPreDraw=E??this.onPreTransformDraw,this.onPostTransformDraw=D??this.onPostTransformDraw,this.isVisible=!!_,this._current=s??this._current,s&&this._graphics[s]&&this.use(s)}getGraphic(e){return this._graphics[e]}getOptions(e){return this._options[e]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(e,s,r){let a="default",l=null,_;if(typeof e=="string"&&s instanceof Qt&&(a=e,l=s,_=r),e instanceof Qt&&!(s instanceof Qt)&&(l=e,_=s),!l)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[a]=this.copyGraphics?l.clone():l,this._options[a]=this.copyGraphics?{..._}:_,a==="default"&&this.use("default"),l}remove(e){delete this._graphics[e],delete this._options[e],this._current===e&&(this._current="default",this.recalculateBounds())}use(e,s){var r;if(e instanceof Qt){let a=e;this.copyGraphics&&(a=e.clone()),this._current="default",this._graphics[this._current]=a,this._options[this._current]=s}else this._current=e,this._options[this._current]=s,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(r=this.owner)===null||r===void 0?void 0:r.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(e){this._localBounds=e}recalculateBounds(){let e=new at;const s=this._graphics[this._current],r=this._options[this._current];if(!s){this._localBounds=e;return}let a=this.anchor,l=this.offset;r?.anchor&&(a=r.anchor),r?.offset&&(l=r.offset);const _=s.localBounds,p=-_.width*a.x+l.x,m=-_.height*a.y+l.y;s instanceof pn&&!s.useAnchor?e=s?.localBounds.combine(e):e=s?.localBounds.translate(z(p,m)).combine(e),this._localBounds=e}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let e=this.localBounds;if(this.owner){const s=this.owner.get(et);s&&(e=e.transform(s.get().matrix))}return e}update(e,s=0){const r=this.current;r&&Ta(r)&&r.tick(e,s)}clone(){const e=new Jt;return e._graphics={...this._graphics},e._options={...this._options},e.offset=this.offset.clone(),this.color&&(e.color=this.color.clone()),e.opacity=this.opacity,e.anchor=this.anchor.clone(),e.copyGraphics=this.copyGraphics,e.onPreDraw=this.onPreDraw,e.onPostDraw=this.onPostDraw,e.isVisible=this.isVisible,e}}var io;(function(u){u.Kill="kill",u.PreKill="prekill",u.PostKill="postkill",u.PreDraw="predraw",u.PostDraw="postdraw",u.PreDebugDraw="predebugdraw",u.PostDebugDraw="postdebugdraw",u.PreUpdate="preupdate",u.PostUpdate="postupdate",u.PreFrame="preframe",u.PostFrame="postframe",u.PreCollision="precollision",u.CollisionStart="collisionstart",u.CollisionEnd="collisionend",u.PostCollision="postcollision",u.Initialize="initialize",u.Activate="activate",u.Deactivate="deactivate",u.ExitViewport="exitviewport",u.EnterViewport="enterviewport",u.ExitTrigger="exit",u.EnterTrigger="enter",u.Connect="connect",u.Disconnect="disconnect",u.Button="button",u.Axis="axis",u.Visible="visible",u.Hidden="hidden",u.Start="start",u.Stop="stop",u.PointerUp="pointerup",u.PointerDown="pointerdown",u.PointerMove="pointermove",u.PointerEnter="pointerenter",u.PointerLeave="pointerleave",u.PointerCancel="pointercancel",u.PointerWheel="pointerwheel",u.Up="up",u.Down="down",u.Move="move",u.Enter="enter",u.Leave="leave",u.Cancel="cancel",u.Wheel="wheel",u.Press="press",u.Release="release",u.Hold="hold",u.PointerDragStart="pointerdragstart",u.PointerDragEnd="pointerdragend",u.PointerDragEnter="pointerdragenter",u.PointerDragLeave="pointerdragleave",u.PointerDragMove="pointerdragmove",u.ActionStart="actionstart",u.ActionComplete="actioncomplete",u.Add="add",u.Remove="remove"})(io||(io={}));class mt{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(e){this._bubbles=e}stopPropagation(){this.bubbles=!1}}class so extends mt{constructor(e){super(),this.self=e,this.target=e}}class Pa extends mt{constructor(e){super(),this.self=e,this.target=e}}class Sa extends mt{constructor(e){super(),this.self=e,this.target=e}}class Ea extends mt{constructor(e){super(),this.self=e,this.target=e}}class Ia extends mt{constructor(e){super(),this.self=e,this.target=e}}class vn extends mt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class wn extends mt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class Ra extends mt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class Da extends mt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class Ma extends mt{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class Fa extends mt{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class xs extends mt{constructor(e,s,r){super(),this.engine=e,this.elapsed=s,this.self=r,this.target=r}}class bs extends mt{constructor(e,s,r){super(),this.engine=e,this.elapsed=s,this.self=r,this.target=r}}class Ba extends mt{constructor(e,s){super(),this.engine=e,this.prevStats=s,this.target=e}}class ka extends mt{constructor(e,s){super(),this.engine=e,this.stats=s,this.target=e}}class La extends mt{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class Ua extends mt{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class za extends mt{constructor(e,s,r,a){super(),this.button=e,this.index=s,this.value=r,this.self=a,this.target=a}}class Ha extends mt{constructor(e,s,r){super(),this.axis=e,this.value=s,this.self=r,this.target=r}}class Oa extends mt{constructor(e){super(),this.self=e,this.target=e}}class Wa extends mt{constructor(e){super(),this.self=e,this.target=e}}class Os extends mt{constructor(e,s,r,a,l){super(),this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l,this.target=e}}class Ws extends mt{constructor(e,s,r,a,l){super(),this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l,this.target=e}}class no{constructor(e,s,r,a){this.self=e,this.other=s,this.side=r,this.contact=a}}class ro{constructor(e,s,r,a){this.self=e,this.other=s,this.side=r,this.lastContact=a}}class oo{constructor(e,s,r,a,l){this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l}}class ao{constructor(e,s,r,a,l){this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l}}class Kn extends mt{constructor(e,s,r,a){super(),this.self=e,this.other=s,this.side=r,this.contact=a,this.target=e}}class Jn extends mt{constructor(e,s,r,a){super(),this.self=e,this.other=s,this.side=r,this.lastContact=a,this.target=e}}class xn extends mt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class Na extends mt{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class Ga extends mt{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class Va extends mt{constructor(e){super(),this.self=e,this.target=e}}class qa extends mt{constructor(e){super(),this.self=e,this.target=e}}class Xa extends mt{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class Ya extends mt{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class ja extends mt{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class Za extends mt{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class $a extends mt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class Qa extends mt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class up{constructor(e){this.data=e,this.type="Component Added"}}function _p(u){return!!u&&u.type==="Component Added"}class fp{constructor(e){this.data=e,this.type="Component Removed"}}function pp(u){return!!u&&u.type==="Component Removed"}const gp={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class ke{constructor(e,s){this.id=ke._ID++,this.name=`Entity#${this.id}`,this.events=new I,this._tags=new Set,this.componentAdded$=new Ne,this.componentRemoved$=new Ne,this.tagAdded$=new Ne,this.tagRemoved$=new Ne,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new Ne,this.childrenRemoved$=new Ne,this._children=[],this._isInitialized=!1,this._isAdded=!1;let r,a;if(Array.isArray(e))r=e,a=s;else if(e&&typeof e=="object"){const{components:l,name:_,silenceWarnings:p}=e;r=l??[],a=_}if(a&&(this.name=a),r)for(const l of r)this.addComponent(l)}get active(){return this.isActive}set active(e){this.isActive=e}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new so(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(e){return this._tags.has(e)}addTag(e){return this._tags.add(e),this.tagAdded$.notifyAll(e),this}removeTag(e){return this._tags.delete(e),this.tagRemoved$.notifyAll(e),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(e){for(let s=0;s<e.length;s++)if(!this.components.has(e[s]))return!1;return!0}hasAllTags(e){for(let s=0;s<e.length;s++)if(!this.tags.has(e[s]))return!1;return!0}get(e){return this.components.get(e)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(e){if(e.parent===null){if(this.getAncestors().includes(e))throw new Error("Cycle detected, cannot add entity");this._children.push(e),e._parent=this,this.childrenAdded$.notifyAll(e)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(e){return e.parent===this&&($i(e,this._children),e._parent=null,this.childrenRemoved$.notifyAll(e)),this}removeAllChildren(){for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);return this}getAncestors(){const e=[this];let s=this.parent;for(;s;)e.push(s),s=s.parent;return e.reverse()}getDescendants(){let e=[this],s=[this];for(;s.length>0;){const r=s.pop();r&&(s=s.concat(r.children),e=e.concat(r.children))}return e}clone(){const e=new ke;for(const s of this.types){const r=this.get(s);r&&e.addComponent(r.clone())}for(const s of this.children)e.addChild(s.clone());return e}addTemplate(e,s=!1){for(const r of e.getComponents())this.addComponent(r.clone(),s);for(const r of e.children)this.addChild(r.clone().addTemplate(r));return this}_getClassHierarchyRoot(e){var s,r;let a=e,l=(s=Object.getPrototypeOf(a.prototype))===null||s===void 0?void 0:s.constructor;for(;l&&l!==Object&&l!==_i;)a=l,l=(r=Object.getPrototypeOf(a.prototype))===null||r===void 0?void 0:r.constructor;return a}addComponent(e,s=!1){if(this.has(e.constructor))if(s)this.removeComponent(e.constructor,!0);else return this;if(e.dependencies&&e.dependencies.length)for(const a of e.dependencies)this.addComponent(new a);e.owner=this;const r=this._getClassHierarchyRoot(e.constructor);return this.components.set(r,e),this.components.set(e.constructor,e),this.componentValues.push(e),e.onAdd&&e.onAdd(this),this.componentAdded$.notifyAll(e),this}removeComponent(e,s=!1){let r;if(kc(e)?r=e:r=e.constructor,s){const a=this.components.get(r);if(a){this.componentRemoved$.notifyAll(a),a.owner=void 0,a.onRemove&&a.onRemove(this);const _=this.componentValues.indexOf(a);_>-1&&this.componentValues.splice(_,1)}const l=this._getClassHierarchyRoot(r);this.components.delete(l),this.components.delete(r)}else this._componentsToRemove.push(r);return this}clearComponents(){const e=this.types;for(const s of e)this.removeComponent(s)}processComponentRemoval(){for(const e of this._componentsToRemove)this.removeComponent(e,!0);this._componentsToRemove.length=0}has(e){return this.components.has(e)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(e){this.isInitialized||(this.onInitialize(e),this.events.emit("initialize",new xn(e,this)),this._isInitialized=!0)}_add(e){!this.isAdded&&this.isActive&&(this.onAdd(e),this.events.emit("add",new $a(e,this)),this._isAdded=!0)}_remove(e){this.isAdded&&!this.isActive&&(this.onRemove(e),this.events.emit("remove",new Qa(e,this)),this._isAdded=!1)}_preupdate(e,s){this.events.emit("preupdate",new xs(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new bs(e,s,this)),this.onPostUpdate(e,s)}onInitialize(e){}onAdd(e){}onRemove(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s);for(const r of this.children)r.update(e,s);this._postupdate(e,s),this._remove(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}ke._ID=0;class Rt extends _i{constructor(){super(...arguments),this.vel=B.Zero,this.acc=B.Zero,this.scaleFactor=B.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class Ge{static integrate(e,s,r,a){const l=a/1e3;s.vel.addEqual(r.scale(l,Ge._ACC)),e.pos.add(s.vel.scale(l,Ge._VEL),Ge._POS).addEqual(r.scale(.5*l*l,Ge._VEL_ACC)),s.angularVelocity+=s.torque*(1/s.inertia)*l;const _=e.rotation+s.angularVelocity*l;e.scale.add(s.scaleFactor.scale(l,this._SCALE_FACTOR),Ge._SCALE),e.get().setTransform(Ge._POS,_,Ge._SCALE)}}Ge._POS=new B(0,0),Ge._SCALE=new B(1,1),Ge._ACC=new B(0,0),Ge._VEL=new B(0,0),Ge._VEL_ACC=new B(0,0),Ge._SCALE_FACTOR=new B(0,0);class ho extends ke{constructor(e){super({silenceWarnings:!0}),this.beginColor=$.White,this.endColor=$.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=$.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=bi.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new et),this.addComponent(this.motion=new Rt),this.addComponent(this.graphics=new Jt),this.configure(e)}registerEmitter(e){if(this._emitter=e,this.particleTransform===bi.Global){const s=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(s),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(e){var s,r,a,l,_,p,m,w,y,A,E,D,L,O;this.particleTransform=(s=e.transform)!==null&&s!==void 0?s:this.particleTransform,this.life=(r=e.life)!==null&&r!==void 0?r:this.life,this.fade=(a=e.fade)!==null&&a!==void 0?a:this.fade,this.size=(l=e.size)!==null&&l!==void 0?l:this.size,this.endColor=(_=e.endColor)!==null&&_!==void 0?_:this.endColor.clone(),this.beginColor=(p=e.beginColor)!==null&&p!==void 0?p:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=e.graphic,this.graphics.opacity=(m=e.opacity)!==null&&m!==void 0?m:this.graphics.opacity,this.transform.pos=(w=e.pos)!==null&&w!==void 0?w:this.transform.pos,this.transform.rotation=(y=e.rotation)!==null&&y!==void 0?y:0,this.transform.scale=z(1,1),this.motion.vel=(A=e.vel)!==null&&A!==void 0?A:this.motion.vel,this.motion.angularVelocity=(E=e.angularVelocity)!==null&&E!==void 0?E:0,this.motion.acc=(D=e.acc)!==null&&D!==void 0?D:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(L=e.startSize)!==null&&L!==void 0?L:0,this.endSize=(O=e.endSize)!==null&&O!==void 0?O:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=at.fromDimension(this.size,this.size,B.Half),this.graphics.onPostDraw=X=>{X.save(),X.debug.drawPoint(z(0,0),{color:this._currentColor,size:this.size}),X.restore()})}kill(){var e;!((e=this._emitter)===null||e===void 0)&&e.isActive?this._emitter.removeParticle(this):super.kill()}update(e,s){this.life=this.life-s,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=j(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=j(this.sizeRate*s+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=j(this._currentColor.r+this._rRate*s,0,255),this._currentColor.g=j(this._currentColor.g+this._gRate*s,0,255),this._currentColor.b=j(this._currentColor.b+this._bRate*s,0,255),this._currentColor.a=this.graphics.opacity;let r=this.motion.acc;this.focus&&(r=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(s/1e3)),Ge.integrate(this.transform,this.motion,r,s)}}ho.DefaultConfig={beginColor:$.White,endColor:$.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var bi;(function(u){u.Global="global",u.Local="local"})(bi||(bi={}));class Lc{constructor(){this.type="ex.particle",this.priority=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new $e({gl:e,vertexSource:rp,fragmentSource:op,onPreLink:r=>{e.transformFeedbackVaryings(r,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],e.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(e){const s=e.getAttribute(Et.Filtering),r=s?fn(s):void 0,a=vi(e.getAttribute(Et.WrappingX)),l=vi(e.getAttribute(Et.WrappingY)),_=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},_);return e.removeAttribute("forceUpload"),p}draw(e,s){var r,a,l,_,p,m,w,y,A;const E=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const D=e.particle.transform===bi.Local?this._context.getTransform():this._context.getTransform().multiply(e.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",D),this._shader.setUniformBoolean("fade",!!e.particle.fade),this._shader.setUniformBoolean("useTexture",!!e.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(r=e.particle.life)!==null&&r!==void 0?r:2e3),this._shader.setUniformFloat("deltaMs",s),this._shader.setUniformFloatVector("gravity",(a=e.particle.acc)!==null&&a!==void 0?a:z(0,0)),this._shader.setUniformFloatColor("beginColor",(l=e.particle.beginColor)!==null&&l!==void 0?l:$.Transparent),this._shader.setUniformFloatColor("endColor",(_=e.particle.endColor)!==null&&_!==void 0?_:$.Transparent);let L=(p=e.particle.startSize)!==null&&p!==void 0?p:0,O=(m=e.particle.endSize)!==null&&m!==void 0?m:0;const X=(w=e.particle.size)!==null&&w!==void 0?w:0;if(X>0&&(L=X,O=X),this._shader.setUniformFloat("startSize",L??10),this._shader.setUniformFloat("endSize",O??10),this._shader.setUniformFloat("startOpacity",(y=e.particle.opacity)!==null&&y!==void 0?y:1),e.particle.focus&&(this._shader.setUniformFloatVector("focus",e.particle.focus),this._shader.setUniformFloat("focusAccel",(A=e.particle.focusAccel)!==null&&A!==void 0?A:0)),e.particle.graphic){const H=e.particle.graphic,N=this._getTexture(H.image.image);E.activeTexture(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,N),this._shader.setUniformInt("graphic",0)}e.draw(E)}hasPendingDraws(){return!1}flush(){}dispose(){}}const mp=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,vp=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class wp{constructor(e){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=$.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=ba(e,r);this._maxTextures=Math.min(r,a);const l=this._transformFragmentSource(mp,this._maxTextures);this._shader=new $e({gl:e,fragmentSource:l,vertexSource:vp}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((A,E)=>E)),this._vao=e.createVertexArray(),e.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._meshBuffer),e.bufferData(e.ARRAY_BUFFER,this._quadMesh,e.STATIC_DRAW),e.vertexAttribPointer(0,2,e.FLOAT,!1,16,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,16,8),e.enableVertexAttribArray(1),e.bindBuffer(e.ARRAY_BUFFER,null);const _=this._components;this._transformData=new Mi({gl:e,size:_*this._maxImages,type:"dynamic"}),this._transformData.bind();let p=0,m=2;const w=4,y=_*4;e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(2),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(3),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(4),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(5),p+=2*w,e.vertexAttribPointer(m++,1,e.FLOAT,!1,y,p),e.enableVertexAttribArray(6),p+=1*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(7),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(8),p+=2*w,e.vertexAttribPointer(m++,1,e.FLOAT,!1,y,p),e.enableVertexAttribArray(9),p+=1*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(10),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(11),p+=2*w,e.vertexAttribPointer(m++,4,e.FLOAT,!1,y,p),e.enableVertexAttribArray(12),p+=4*w,e.vertexAttribDivisor(2,1),e.vertexAttribDivisor(3,1),e.vertexAttribDivisor(4,1),e.vertexAttribDivisor(5,1),e.vertexAttribDivisor(6,1),e.vertexAttribDivisor(7,1),e.vertexAttribDivisor(8,1),e.vertexAttribDivisor(9,1),e.vertexAttribDivisor(10,1),e.vertexAttribDivisor(11,1),e.vertexAttribDivisor(12,1),e.bindVertexArray(null)}_bindData(e){const s=this._components;this._transformData.bind(),this._transformData.upload(s*this._imageCount),e.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let r=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_texture_index <= ${l}.5) {
`:a+=`   else if (v_texture_index <= ${l}.5) {
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return r=r.replace("%%texture_picker%%",a),r}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(Et.Filtering),r=s?fn(s):void 0,a=vi(e.getAttribute(Et.WrappingX)),l=vi(e.getAttribute(Et.WrappingY)),_=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},_);e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&(this._textures.push(p),this._textureToIndex.set(p,this._textureIndex++),this._images.add(e))}_bindTextures(e){const s=Math.min(this._textureIndex,this._maxTextures);for(let r=0;r<s;r++)e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,this._textures[r]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const r=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(r))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,r,a,l,_,p,m,w){var y,A,E,D;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const L=this._getImageWidth(e),O=this._getImageHeight(e);let X=L||a||0,H=O||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(y=a??L)!==null&&y!==void 0?y:0,this._view[3]=(A=l??O)!==null&&A!==void 0?A:0,this._dest[0]=s??1,this._dest[1]=r??1,_!==void 0&&p!==void 0&&m!==void 0&&w!==void 0&&(this._view[0]=s??1,this._view[1]=r??1,this._view[2]=(E=a??L)!==null&&E!==void 0?E:0,this._view[3]=(D=l??O)!==null&&D!==void 0?D:0,this._dest[0]=_,this._dest[1]=p,X=m,H=w),s=this._view[0],r=this._view[1];const N=this._view[2],Q=this._view[3],Y=this._context.getTransform(),J=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+ft),this._dest[1]=~~(this._dest[1]+ft));const Z=this._context.tint||this._defaultTint,_t=this._getTextureIdForImage(e),Tt=L||X,Gt=O||H,Xt=(s+this.uvPadding)/Tt,be=(r+this.uvPadding)/Gt,$t=(s+N-this.uvPadding)/Tt,kt=(r+Q-this.uvPadding)/Gt,ze=L,Ee=O,it=this._transformData.bufferData;it[this._vertexIndex++]=this._dest[0],it[this._vertexIndex++]=this._dest[1],it[this._vertexIndex++]=Y.data[0],it[this._vertexIndex++]=Y.data[1],it[this._vertexIndex++]=Y.data[2],it[this._vertexIndex++]=Y.data[3],it[this._vertexIndex++]=Y.data[4],it[this._vertexIndex++]=Y.data[5],it[this._vertexIndex++]=J,it[this._vertexIndex++]=X,it[this._vertexIndex++]=H,it[this._vertexIndex++]=ze,it[this._vertexIndex++]=Ee,it[this._vertexIndex++]=_t,it[this._vertexIndex++]=Xt,it[this._vertexIndex++]=be,it[this._vertexIndex++]=$t,it[this._vertexIndex++]=kt,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._bindData(e),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),e.drawArraysInstanced(e.TRIANGLES,0,6,this._imageCount),qt.DrawnImagesCount+=this._imageCount,qt.DrawCallCount++,e.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const ft=1e-4;class xp{constructor(e){this._webglCtx=e,this._debugText=new wa}drawRect(e,s,r,a,l={color:$.Black}){this.drawLine(z(e,s),z(e+r,s),{...l}),this.drawLine(z(e+r,s),z(e+r,s+a),{...l}),this.drawLine(z(e+r,s+a),z(e,s+a),{...l}),this.drawLine(z(e,s+a),z(e,s),{...l})}drawLine(e,s,r){var a;this._webglCtx.draw("ex.line",e,s,(a=r?.color)!==null&&a!==void 0?a:$.Black)}drawPoint(e,s={color:$.Black,size:5}){this._webglCtx.draw("ex.point",e,s.color,s.size)}drawText(e,s){this._debugText.write(this._webglCtx,e,s)}}class Ji{get z(){return this._state.current.z}set z(e){this._state.current.z=e}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(e){let s=!0;return(e.width>4096||e.height>4096)&&(s=!1),s}constructor(e){this._logger=ot.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=b.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new $r(()=>new sp,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new Ff,this._state=new Sc,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=$.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new xp(this),this._totalPostProcessorTime=0;const{canvasElement:s,context:r,enableTransparency:a,antialiasing:l,uvPadding:_,multiSampleAntialiasing:p,pixelArtSampler:m,powerPreference:w,snapToPixel:y,backgroundColor:A,useDrawSorting:E,garbageCollector:D,handleContextLost:L,handleContextRestored:O}=e;if(this.__gl=r??s.getContext("webgl2",{antialias:l??this.smoothing,premultipliedAlpha:!1,alpha:a??this.transparency,depth:!1,powerPreference:w??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");L&&this.__gl.canvas.addEventListener("webglcontextlost",L,!1),O&&this.__gl.canvas.addEventListener("webglcontextrestored",O,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new Kt(this.__gl,D),this.snapToPixel=y??this.snapToPixel,this.smoothing=l??this.smoothing,this.transparency=a??this.transparency,this.pixelArtSampler=m??this.pixelArtSampler,this.uvPadding=_??this.uvPadding,this.multiSampleAntialiasing=typeof p=="boolean"?p:this.multiSampleAntialiasing,this.samples=typeof p=="object"?p.samples:void 0,this.backgroundColor=A??this.backgroundColor,this.useDrawSorting=E??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const e of this._renderers.values())e.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const e=this.__gl;if(this._ortho=ii.ortho(0,e.canvas.width,e.canvas.height,0,400,-400),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.depthMask(!1),this.register(new $f({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new Bc),this.register(new Jf),this.register(new ip),this.register(new Vf),this.register(new Wf),this.lazyRegister("ex.particle",()=>new Lc),this.register(new wp({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=e.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");e.bindTexture(e.TEXTURE_2D,this.materialScreenTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.bindTexture(e.TEXTURE_2D,null),this._screenRenderer=new Yf(e),this._renderTarget=new Zr({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),this._postProcessTargets=[new Zr({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),new Zr({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height})],this._msaaTarget=new Zr({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(e){this._renderers.set(e.type,e),e.initialize(this.__gl,this)}lazyRegister(e,s){this._lazyRenderersFactory.set(e,s)}get(e){let s=this._renderers.get(e);if(!s){const r=this._lazyRenderersFactory.get(e);r&&(this._logger.debug("lazy init renderer:",e),s=r(),this.register(s))}return s}_isCurrentRenderer(e){return!this._currentRenderer||this._currentRenderer===e}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(e,...s){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${e}, the webgl context is lost`);return}const r=this.get(e);if(r)if(this.useDrawSorting){const a=this._drawCallPool.get();a.z=this._state.current.z,a.priority=r.priority,a.renderer=e,this.getTransform().clone(a.transform),a.state.z=this._state.current.z,a.state.opacity=this._state.current.opacity,a.state.tint=this._state.current.tint,a.state.material=this._state.current.material,a.args[0]=s[0],a.args[1]=s[1],a.args[2]=s[2],a.args[3]=s[3],a.args[4]=s[4],a.args[5]=s[5],a.args[6]=s[6],a.args[7]=s[7],a.args[8]=s[8],a.args[9]=s[9],this._drawCalls[this._drawCallIndex++]=a}else this._currentRenderer||(this._currentRenderer=r),this._isCurrentRenderer(r)||this._currentRenderer.flush(),r.draw(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9]),this._currentRenderer=r;else throw Error(`No renderer with name ${e} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(e){const s=this.__gl;this._ortho=this._ortho=ii.ortho(0,e.width,e.height,0,400,-400),this._renderTarget.setResolution(s.canvas.width,s.canvas.height),this._msaaTarget.setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[0].setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[1].setResolution(s.canvas.width,s.canvas.height)}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}drawImage(e,s,r,a,l,_,p,m,w){if(!(a===0||l===0)){{if(m===0||w===0)return;if(this._getImageWidth(e)===0||this._getImageHeight(e)===0)return}if(!e){ot.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",e,s,r,a,l,_,p,m,w):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,e,s,r,a,l,_,p,m,w):this.draw(this.imageRenderer,e,s,r,a,l,_,p,m,w)}}drawLine(e,s,r,a=1){this.draw("ex.rectangle",e,s,r,a)}drawRectangle(e,s,r,a,l,_){this.draw("ex.rectangle",e,s,r,a,l,_)}drawCircle(e,s,r,a,l){this.draw("ex.circle",e,s,r,a,l)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(e,s){this._transform.translate(this.snapToPixel?~~(e+ft):e,this.snapToPixel?~~(s+ft):s)}rotate(e){this._transform.rotate(e)}scale(e,s){this._transform.scale(e,s)}transform(e){this._transform.current=e}getTransform(){return this._transform.current}multiply(e){this._transform.current.multiply(e,this._transform.current)}addPostProcessor(e){this._postprocessors.push(e),e.initialize(this.__gl)}removePostProcessor(e){const s=this._postprocessors.indexOf(e);s!==-1&&this._postprocessors.splice(s,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(e){for(const s of this._postprocessors){const r=s.getShader();r.use();const a=r.getUniforms();this._totalPostProcessorTime+=e,a.find(l=>l.name==="u_time_ms")&&r.setUniformFloat("u_time_ms",this._totalPostProcessorTime),a.find(l=>l.name==="u_elapsed_ms")&&r.setUniformFloat("u_elapsed_ms",e),a.find(l=>l.name==="u_resolution")&&r.setUniformFloatVector("u_resolution",z(this.width,this.height)),s.onUpdate&&s.onUpdate(e)}}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return new Fc({...e,graphicsContext:this})}createShader(e){const s=this.__gl,{vertexSource:r,fragmentSource:a}=e,l=new $e({gl:s,vertexSource:r,fragmentSource:a});return l.compile(),l}clear(){const e=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT)}flush(){var e;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let s=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(s.use(),this.useDrawSorting){for(let _=this._drawCallIndex;_<this._drawCalls.length;_++)this._drawCalls[_]=null;const r=new Map;for(const[_]of this._renderers){let p=0;for(p=0;p<this._drawCallIndex&&this._drawCalls[p].renderer!==_;p++);r.set(_,p)}this._drawCalls.sort((_,p)=>{if(_===null||p===null)return 0;const m=_.z-p.z,w=r.get(_.renderer)-r.get(p.renderer),y=_.priority-p.priority;return m===0?y===0?w:y:m});const a=this._transform.current,l=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let _=this._drawCalls[0].renderer,p=this.get(_);for(let m=0;m<this._drawCallIndex;m++)this._transform.current=this._drawCalls[m].transform,this._state.current=this._drawCalls[m].state,this._drawCalls[m].renderer!==_&&(p.flush(),_=this._drawCalls[m].renderer,p=this.get(_)),p instanceof Bc&&(!((e=this.material)===null||e===void 0)&&e.isUsingScreenTexture)&&(s.copyToTexture(this.materialScreenTexture),s.use()),p.draw(...this._drawCalls[m].args);p.hasPendingDraws()&&p.flush()}this._transform.current=a,this._state.current=l,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const r of this._renderers.values())r.hasPendingDraws()&&r.flush();s.disable(),this._postprocessors.length>0&&s.toRenderSource().use();for(let r=0;r<this._postprocessors.length;r++)s=this._postProcessTargets[r%2],this._postProcessTargets[r%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[r]),this._postProcessTargets[r%2].toRenderSource().use();s.blitToScreen()}}const ne=1e-4;class bp{constructor(e){this._ex=e,this._debugText=new wa}drawRect(e,s,r,a){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(e+ne):e,this._ex.snapToPixel?~~(s+ne):s,this._ex.snapToPixel?~~(r+ne):r,this._ex.snapToPixel?~~(a+ne):a),this._ex.__ctx.restore()}drawLine(e,s,r={color:$.Black}){var a,l;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(l=(a=r.color)===null||a===void 0?void 0:a.toString())!==null&&l!==void 0?l:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(e.x+ne):e.x,this._ex.snapToPixel?~~(e.y+ne):e.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(s.x+ne):s.x,this._ex.snapToPixel?~~(s.y+ne):s.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(e,s={color:$.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=s.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(e.x+ne):e.x,this._ex.snapToPixel?~~(e.y+ne):e.y,s.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(e,s){this._debugText.write(this._ex,e,s)}}class lo{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(e){this.__ctx.imageSmoothingEnabled=e}constructor(e){this.useDrawSorting=!1,this.z=0,this.backgroundColor=$.ExcaliburBlue,this._state=new Sc,this.snapToPixel=!1,this.debug=new bp(this);const{canvasElement:s,context:r,enableTransparency:a,snapToPixel:l,antialiasing:_,backgroundColor:p}=e;if(this.__ctx=r??s.getContext("2d",{alpha:a??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=p??this.backgroundColor,this.snapToPixel=l??this.snapToPixel,this.smoothing=_??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(e){}drawImage(e,s,r,a,l,_,p,m,w){if(a===0||l===0)return;if(m===0||w===0)return;if(e.width===0||e.height===0)return;this.__ctx.globalAlpha=this.opacity;const y=[e,s,r,a,l,_,p,m,w].filter(A=>A!==void 0).map(A=>typeof A=="number"&&this.snapToPixel?~~A:A);this.__ctx.drawImage.apply(this.__ctx,y),qt.DrawCallCount++,qt.DrawnImagesCount=1}drawLine(e,s,r,a=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=r.toString(),this.__ctx.moveTo(this.snapToPixel?~~(e.x+ne):e.x,this.snapToPixel?~~(e.y+ne):e.y),this.__ctx.lineTo(this.snapToPixel?~~(s.x+ne):s.x,this.snapToPixel?~~(s.y+ne):s.y),this.__ctx.lineWidth=a,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(e,s,r,a){this.__ctx.save(),this.__ctx.fillStyle=a.toString(),this.__ctx.fillRect(this.snapToPixel?~~(e.x+ne):e.x,this.snapToPixel?~~(e.y+ne):e.y,this.snapToPixel?~~(s+ne):s,this.snapToPixel?~~(r+ne):r),this.__ctx.restore()}drawCircle(e,s,r,a,l){this.__ctx.save(),this.__ctx.beginPath(),a&&(this.__ctx.strokeStyle=a.toString()),l&&(this.__ctx.lineWidth=l),this.__ctx.fillStyle=r.toString(),this.__ctx.arc(this.snapToPixel?~~(e.x+ne):e.x,this.snapToPixel?~~(e.y+ne):e.y,s,0,Math.PI*2),this.__ctx.fill(),a&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(e,s){this.__ctx.translate(this.snapToPixel?~~(e+ne):e,this.snapToPixel?~~(s+ne):s)}rotate(e){this.__ctx.rotate(e)}scale(e,s){this.__ctx.scale(e,s)}getTransform(){throw new Error("Not implemented")}multiply(e){this.__ctx.setTransform(this.__ctx.getTransform().multiply(e.toDOMMatrix()))}addPostProcessor(e){}removePostProcessor(e){}clearPostProcessors(){}updatePostProcessors(e){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),qt.clear()}flush(){}dispose(){this.__ctx=void 0}}var ve;(function(u){u.Fixed="Fixed",u.FitContainerAndFill="FitContainerAndFill",u.FitScreenAndFill="FitScreenAndFill",u.FitContainerAndZoom="FitContainerAndZoom",u.FitScreenAndZoom="FitScreenAndZoom",u.FitScreen="FitScreen",u.FillScreen="FillScreen",u.FitContainer="FitContainer",u.FillContainer="FillContainer"})(ve||(ve={}));class Ka{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const yp={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class Ja{constructor(e){var s,r,a,l;this.events=new I,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=ot.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const _=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(_),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new at,this._unsafeArea=new at,this.viewport=e.viewport,this.resolution=(s=e.resolution)!==null&&s!==void 0?s:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(r=e.displayMode)!==null&&r!==void 0?r:ve.Fixed,this._canvas=e.canvas,this.graphicsContext=e.context,this._antialiasing=(a=e.antialiasing)!==null&&a!==void 0?a:this._antialiasing,this._canvasImageRendering=(l=e.canvasImageRendering)!==null&&l!==void 0?l:this._canvasImageRendering,this._browser=e.browser,this._pixelRatioOverride=e.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const e=this.worldToPageCoordinates(B.Zero);return this.worldToPageCoordinates(z(1,0)).sub(e).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(e){this._pixelRatioOverride=e}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case ve.FillContainer:case ve.FitContainer:case ve.FitContainerAndFill:case ve.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(e){this._resolution=e}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(e){this._viewport=e}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(e){this._camera=e}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof Ji&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let a=Math.max(1,this.pixelRatio-.5),l=!1;for(;a>1&&!l;){a=Math.max(1,a-.5);const _=this._resolution.width*a,p=this._resolution.height*a;l=this.graphicsContext.checkIfResolutionSupported({width:_,height:p})}this.pixelRatioOverride=a,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const e=this.viewport.widthUnit==="percent"?"%":"px",s=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+e,this._canvas.style.height=this.viewport.height+s,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof lo&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(e){this._antialiasing=e,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(e){return this.enterFullscreen(e)}enterFullscreen(e){var s,r,a,l,_,p;if(e){const m=document.getElementById(e);if(m?.requestFullscreen||m?.webkitRequestFullscreen){if(m.getAttribute("ex-fullscreen-listener")||(m.setAttribute("ex-fullscreen-listener","true"),m.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),m.requestFullscreen)return(s=m.requestFullscreen())!==null&&s!==void 0?s:Promise.resolve();if(m.webkitRequestFullscreen)return(r=m.webkitRequestFullscreen())!==null&&r!==void 0?r:Promise.resolve()}}return!((a=this._canvas)===null||a===void 0)&&a.requestFullscreen?(_=(l=this._canvas)===null||l===void 0?void 0:l.requestFullscreen())!==null&&_!==void 0?_:Promise.resolve():this._canvas.webkitRequestFullscreen?(p=this._canvas.webkitRequestFullscreen())!==null&&p!==void 0?p:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(e){return{width:e.widthUnit==="percent"?this.canvas.offsetWidth:e.width,height:e.heightUnit==="percent"?this.canvas.offsetHeight:e.height}}pageToScreenCoordinates(e){let s=e.x,r=e.y;this._isFullscreen||(s-=vs(this._canvas).x,r-=vs(this._canvas).y);const a=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,_=(window.innerHeight-l)/2;r=(r-_)/l*a.height,s=s/window.innerWidth*a.width}else{const l=window.innerHeight*this.aspectRatio,_=(window.innerWidth-l)/2;s=(s-_)/l*a.width,r=r/window.innerHeight*a.height}return s=s/a.width*this.resolution.width,r=r/a.height*this.resolution.height,s=s-this.contentArea.left,r=r-this.contentArea.top,new B(s,r)}screenToPageCoordinates(e){let s=e.x,r=e.y;const a=this._viewportToPixels(this.viewport);if(s=s/this.resolution.width*a.width,r=r/this.resolution.height*a.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,_=(window.innerHeight-l)/2;r=r/a.height*l+_,s=s/a.width*window.innerWidth}else{const l=window.innerHeight*this.aspectRatio,_=(window.innerWidth-l)/2;s=s/a.width*l+_,r=r/a.height*window.innerHeight}return this._isFullscreen||(s+=vs(this._canvas).x,r+=vs(this._canvas).y),new B(s,r)}screenToWorldCoordinates(e){return e=e.add(z(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(e):e.sub(z(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(e){return this._camera?this._camera.transform.multiply(e):e.add(z(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(e){const s=this.pageToScreenCoordinates(e);return this.screenToWorldCoordinates(s)}worldToPageCoordinates(e){const s=this.worldToScreenCoordinates(e);return this.screenToPageCoordinates(s)}getWorldBounds(){return at.fromDimension(this.resolution.width,this.resolution.height,B.Half).scale(z(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return at.fromDimension(this.resolution.width,this.resolution.height,B.Zero,B.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return z(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=this.aspectRatio;let s=0,r=0;window.innerWidth/e<window.innerHeight?(s=window.innerWidth,r=window.innerWidth/e):(s=window.innerHeight*e,r=window.innerHeight),this.viewport={width:s,height:r},this._contentArea=at.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this._unsafeArea=at.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndFill(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(e,s,r){if(this.viewport=r??{width:e,height:s},e/s<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:e*this._contentResolution.width/e,height:e*this._contentResolution.width/e*s/e};const a=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new at({top:a,left:0,right:this._contentResolution.width,bottom:this.resolution.height-a}),this._unsafeArea=new at({top:-a,left:0,right:this._contentResolution.width,bottom:this.resolution.height+a})}else{this.resolution={width:s*this._contentResolution.height/s*e/s,height:s*this._contentResolution.height/s};const a=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new at({top:0,left:a,right:this.resolution.width-a,bottom:this._contentResolution.height}),this._unsafeArea=new at({top:0,left:-a,right:this.resolution.width+a,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndZoom(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const e=this.canvas.parentElement;e.style.overflow="hidden";const{offsetWidth:s,offsetHeight:r}=this.canvas;this._computeFitAndZoom(s,r),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(e,s){const r=this.aspectRatio;let a=0,l=0;e/r<s?(a=e,l=e/r):(a=s*r,l=s);const _=e/a,p=s/l,m=Math.max(_,p),w=a*m,y=l*m;w>e?this.canvas.style.left=-(w-e)/2+"px":this.canvas.style.left="",y>s?this.canvas.style.top=-(y-s)/2+"px":this.canvas.style.top="",this.viewport={width:w,height:y};const A=at.fromDimension(this.viewport.width,this.viewport.height,B.Zero);if(this.viewport.width>e){const E=(this.viewport.width-e)/this.viewport.width*this.resolution.width;A.top=0,A.left=E/2,A.right=this.resolution.width-E/2,A.bottom=this.resolution.height}if(this.viewport.height>s){const E=(this.viewport.height-s)/this.viewport.height*this.resolution.height;A.top=E/2,A.left=0,A.bottom=this.resolution.height-E/2,A.right=this.resolution.width}this._contentArea=A}_computeFitContainer(){const e=this.aspectRatio;let s=0,r=0,a="pixel",l="pixel";const _=this.canvas.parentElement;_.clientWidth/e<_.clientHeight?(this.canvas.style.width="100%",s=100,a="percent",r=this.canvas.offsetWidth/e):(this.canvas.style.height="100%",r=100,l="percent",s=this.canvas.offsetHeight*e),this.viewport={width:s,widthUnit:a,height:r,heightUnit:l},this._contentArea=at.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(e){this.displayMode===ve.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===ve.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:e.innerWidth,height:e.innerHeight},this.viewport=this.resolution),this._contentArea=at.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.displayMode===ve.FitScreen&&this._computeFit(),this.displayMode===ve.FitContainer&&this._computeFitContainer(),this.displayMode===ve.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===ve.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===ve.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===ve.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class tr{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function Ap(u){return!!u.playbackState}class Ns{static unlock(){return new Promise((s,r)=>{if(Ns._UNLOCKED||!tr.create())return s(!0);const a=setTimeout(()=>{ot.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),s(!1)},200),l=tr.create();l.resume().then(()=>{const _=l.createBuffer(1,1,22050),p=l.createBufferSource();let m=!1;p.buffer=_,p.connect(l.destination),p.onended=()=>m=!0,p.start(0),setTimeout(()=>{Ap(p)?(p.playbackState===p.PLAYING_STATE||p.playbackState===p.FINISHED_STATE)&&(Ns._UNLOCKED=!0):(l.currentTime>0||m)&&(Ns._UNLOCKED=!0)},0),clearTimeout(a),s(!0)},()=>{r()})})}static isUnlocked(){return this._UNLOCKED}}Ns._UNLOCKED=!1;class co extends gn{get ctx(){return this._ctx}constructor(e={}){super(e),this._options=e}clone(){return new co({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){var s,r;!((s=this._options)===null||s===void 0)&&s.draw&&((r=this._options)===null||r===void 0||r.draw(e)),this._options.cache||this.flagDirty()}}class th{}th.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class uo{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(e){this._currentState=e}static create(e,s){const r=new uo;r.data=s;for(const a in e.states)r.states.set(a,{name:a,...e.states[a]});for(const a of r.states.values())for(const l of a.transitions)if(l!=="*"&&!r.states.has(l))throw Error(`Invalid state machine, state [${a.name}] has a transition to another state that doesn't exist [${l}]`);return r.currentState=r.startState=r.states.get(e.start),r}in(e){return this.currentState.name===e}go(e,s){var r,a;if(this.currentState.transitions.includes(e)||this.currentState.transitions.includes("*")){const l=this.states.get(e);return this.currentState.onExit&&((r=this.currentState)===null||r===void 0?void 0:r.onExit({to:l.name,data:this.data}))===!1||l?.onEnter&&l?.onEnter({from:this.currentState.name,eventData:s,data:this.data})===!1?!1:(this.currentState=l,!((a=this.currentState)===null||a===void 0)&&a.onState&&this.currentState.onState(),!0)}return!1}update(e){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,e)}save(e){localStorage.setItem(e,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(e){const s=JSON.parse(localStorage.getItem(e));this.currentState=this.states.get(s.currentState),this.data=s.data}}class Uc{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(e){this._loop=e,this._instance&&(this._instance.loop=e,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(e){e=j(e,0,1),this._volume=e,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(e,this._audioContext.currentTime,.1):this._volumeNode.gain.value=e}get volume(){return this._volume}get duration(){var e;return(e=this._duration)!==null&&e!==void 0?e:this.getTotalPlaybackDuration()}set duration(e){this._duration=e}constructor(e){this._src=e,this._audioContext=tr.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new P,this._stateMachine=uo.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:s})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,s.pausedAt*this._playbackRate):this._instance.start(0,s.pausedAt*this._playbackRate,this.duration),s.startedAt=this._audioContext.currentTime-s.pausedAt,s.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:s})=>{s==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:s,data:r})=>{r.pausedAt=(s??0)/this._playbackRate,r.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:s})=>{s.pausedAt=0,s.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:s})=>{s.pausedAt=this._audioContext.currentTime-s.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(e=()=>{}){return this._playStarted=e,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(e){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",e)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:e,startedAt:s}=this._stateMachine.data;return e?e*this._playbackRate:s?(this._audioContext.currentTime-s)*this._playbackRate:0}set playbackRate(e){this._instance.playbackRate.value=this._playbackRate=e}get playbackRate(){return this._instance.playbackRate.value}}class eh extends mt{set bubbles(e){}get bubbles(){return!1}get _path(){return null}set _path(e){}constructor(e,s="MediaEvent"){super(),this.target=e,this._name=s}stopPropagation(){}action(){}propagate(){}layPath(e){}}class Gs extends eh{constructor(e,s){super(e,"NativeSoundEvent"),this.track=s}}class zc extends eh{constructor(e,s){super(e,"NativeSoundProcessedEvent"),this._processedData=s,this.data=this._processedData}}function Cp(u){try{const e=new Audio,s=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,r=u.match(s)[1];return!!e.canPlayType("audio/"+r)}catch(e){return ot.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",e),!1}}const Tp={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class Hc{set loop(e){this._loop=e;for(const s of this._tracks)s.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(e){this._volume=e;for(const s of this._tracks)s.volume=this._volume;this.events.emit("volumechange",new Gs(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(e){this._duration=e}get instances(){return this._tracks}get path(){return this._resource.path}set path(e){this._resource.path=e}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}constructor(...e){this.events=new I,this.logger=ot.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=tr.create(),this._resource=new Yn("",th.type.arraybuffer);for(const s of e)if(Cp(s)){this.path=s;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",e.join(", ")),this.logger.warn("Attempting to use",e[0]),this.path=e[0])}isLoaded(){return!!this.data}async load(){var e,s;if(this.data)return this.data;const r=await this._resource.load(),a=await this.decodeAudio(r.slice(0));return this._duration=(s=(e=this._duration)!==null&&e!==void 0?e:a?.duration)!==null&&s!==void 0?s:void 0,this.events.emit("processed",new zc(this,a)),this.data=a}async decodeAudio(e){try{return await this._audioContext.decodeAudioData(e.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(e){e&&(this._engine=e,this._engine.on("hidden",()=>{e.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{e.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(e=>e.isPlaying())}isPaused(){return this._tracks.some(e=>e.isPaused())}isStopped(){return this._tracks.some(e=>e.isStopped())}play(e){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=e||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const e of this._tracks)e.pause();this.events.emit("pause",new Gs(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const e of this._tracks)e.stop();this.events.emit("stop",new Gs(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._tracks.forEach(s=>{s.playbackRate=this._playbackRate})}seek(e,s=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[s].seek(e)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(e=0){return this._tracks.length?this._tracks[e].getPlaybackPosition():0}getTrackId(e){return this._tracks.indexOf(e)}async _resumePlayback(){if(this.isPaused()){const e=[];for(const s of this._tracks)e.push(s.play().then(()=>(this._tracks.splice(this.getTrackId(s),1),!0)));this.events.emit("resume",new Gs(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(e)}return!0}async _startPlayback(){const e=this._getTrackInstance(this.data),s=await e.play(()=>{this.events.emit("playbackstart",new Gs(this,e)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new Gs(this,e));const r=this.getTrackId(e);return r!==-1&&this._tracks.splice(r,1),s}_getTrackInstance(e){var s;const r=new Uc(e);return r.loop=this.loop,r.volume=this.volume,r.duration=(s=this.duration)!==null&&s!==void 0?s:0,r.playbackRate=this._playbackRate,this._tracks.push(r),r}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const Pp={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function ih(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class er{get resources(){return this._resources}constructor(e){var s;this.events=new I,this.canvas=new co({filtering:le.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new P,e&&(!((s=e.loadables)===null||s===void 0)&&s.length)&&this.addResources(e.loadables)}onInitialize(e){this.engine=e,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await qr(500,this.engine.clock)}addResource(e){this._resources.push(e)}addResources(e){let s=0;const r=e.length;for(s;s<r;s++)this.addResource(e[s])}markResourceComplete(){this._numLoaded++}get progress(){const e=this._resources.length;return e>0?j(this._numLoaded,0,e)/e:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(e,s){this._totalTimeMs+=s}onDraw(e){const s=this._totalTimeMs/1e3;e.fillStyle=$.Black.toRGBA(),e.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),e.save(),e.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const r=s*10;e.strokeStyle="white",e.lineWidth=10,e.lineCap="round",e.arc(0,0,40,r,r+Math.PI*3/2),e.stroke(),e.fillStyle="white",e.font="16px sans-serif";const a=(this.progress*100).toFixed(0)+"%",l=e.measureText(a),_=Math.abs(l.actualBoundingBoxLeft)+Math.abs(l.actualBoundingBoxRight),p=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);e.fillText(a,-_/2,p/2),e.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async e=>{this.events.emit("loadresourcestart",e),await e.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",e)})}));for(const e of this._resources)e instanceof Hc&&e.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await Ns.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const Sp="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var Ep=o(851);class Vs extends er{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const e=document.getElementById("excalibur-play-root");return e&&(this._playButtonRootElement=e),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(e){const s=Array.isArray(e)?{loadables:e}:e;super(s),this._logger=ot.getInstance(),this._originalOptions={loadables:[]},this.events=new I,this._playButtonShown=!1,this.logo=Sp,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=$.White,this.backgroundColor="#176BAA",this._imageLoaded=new P,this.suppressPlayButton=!1,this._playButtonStyles=Ep.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let r=document.getElementById("excalibur-play");return r||(r=document.createElement("button")),r.id="excalibur-play",r.textContent=this.playButtonText,r.style.display="none",r},this._originalOptions={...Vs._DEFAULT_LOADER_OPTIONS,...s}}onInitialize(e){this.engine=e,this.screen=e.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var e,s;if(this.suppressPlayButton)this.hidePlayButton(),await qr(500,(e=this.engine)===null||e===void 0?void 0:e.clock);else{const r=()=>{try{this._positionPlayButton()}catch{}};return!((s=this.engine)===null||s===void 0)&&s.browser&&this.engine.browser.window.on("resize",r),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",l=>{l.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(l=>{const _=p=>{var m;if(p.stopPropagation(),this.hidePlayButton(),!((m=this.engine)===null||m===void 0)&&m.browser&&this.engine.browser.window.off("resize",r),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(w){this._logger.error("could not go fullscreen",w)}l()};this._playButton.addEventListener("click",_),this._playButton.addEventListener("touchend",_),this._playButton.addEventListener("pointerup",_),this.engine&&this.engine.input.gamepads.once("button",()=>_(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var e;await qr(200,(e=this.engine)===null||e===void 0?void 0:e.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const e=this._image;await this._imageLoaded.promise,await e?.decode()}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:e,y:s,width:r,height:a}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const l=this._playButton.clientWidth,_=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${e+r/2-l/2}px`,this._playButtonRootElement.style.top=`${s+a/2-_/2+100}px`)}}}onDraw(e){const s=this.engine.canvasHeight/this.engine.pixelRatio,r=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),e.fillStyle=this.backgroundColor,e.fillRect(0,0,r,s);let a=s/2;const l=Math.min(this.logoWidth,r*.75);let _=r/2-l/2;this.logoPosition&&(_=this.logoPosition.x,a=this.logoPosition.y);const p=Math.floor(l*(this.logoHeight/this.logoWidth)),m=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,_,a,l,p):e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,_,a-p-20,l,p),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=m;return}let w=_,y=a;this.loadingBarPosition&&(w=this.loadingBarPosition.x,y=this.loadingBarPosition.y),e.lineWidth=2,Ca(e,w,y,l,20,10,this.loadingBarColor);const A=l*this.progress,E=5,D=A-E*2,L=20-E*2;Ca(e,w+E,y+E,D>10?D:10,L,5,null,this.loadingBarColor),this.engine.screen.antialiasing=m}}Vs._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const Oc={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class Wc{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("2d"))},arrayBufferSupport:function(){const e=new XMLHttpRequest;e.open("GET","/");try{e.responseType="arraybuffer"}catch{return!1}return e.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const e=document.createElement("a").style;return e.cssText="background-color:rgba(150,255,150,.5)",(""+e.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let e=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const s=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],r=this.getBrowserFeatures();for(const a of Object.keys(Oc))r[a]?(e+="(%c%c)",s.push("font-weight: bold; color: green"),s.push("font-weight: normal; color: inherit")):(e+="(%c%c)",s.push("font-weight: bold; color: red"),s.push("font-weight: normal; color: inherit")),e+=" "+Oc[a]+`
`;s.unshift(e),console.log.apply(console,s)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let e=!1;for(const s in this._criticalTests)this._criticalTests[s].call(this)||(this.failedTests.push(s),ot.getInstance().error("Critical browser feature missing, Excalibur requires:",s),e=!0);if(e)return!1;for(const s in this._warningTest)this._warningTest[s]()||ot.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",s);return!0}}var dt;(function(u){u.PreventCollision="PreventCollision",u.Passive="Passive",u.Active="Active",u.Fixed="Fixed"})(dt||(dt={}));class Fi{static create(e,s){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(e)){const a=this._GROUPS.get(e);if(a.mask===s)return a;throw new Error(`Collision group ${e} already exists with a different mask!`)}const r=new ts(e,this._CURRENT_BIT,s!==void 0?s:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(e,r),r}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(e){return this._GROUPS.get(e)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}Fi._STARTING_BIT=1,Fi._MAX_GROUPS=32,Fi._CURRENT_GROUP=1,Fi._CURRENT_BIT=Fi._STARTING_BIT,Fi._GROUPS=new Map;class ts{constructor(e,s,r){this._name=e,this._category=s,this._mask=r}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(e){const s=this.category&e.mask,r=this.mask&e.category;return s!==0&&r!==0}invert(){const e=Fi.create("~("+this.name+")",~this.mask|0);return e._category=~this.category,e}static combine(e){const s=e.map(l=>l.name).join("+"),a=~e.reduce((l,_)=>_.category|l,0);return Fi.create(s,a)}static collidesWith(e){const s=`collidesWith(${e.map(a=>a.name).join("+")})`,r=e.reduce((a,l)=>l.category|a,0);return Fi.create(s,r)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}ts.All=new ts("Collide with all groups",-1,-1);class Ve{constructor(e,s){this.colliderA=e,this.colliderB=s,this.id=null,this.id=Ve.calculatePairHash(e.id,s.id)}static canCollide(e,s){var r,a;if(e.id===s.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.localBounds.hasZeroDimensions()||s.localBounds.hasZeroDimensions())return!1;const l=(r=e?.owner)===null||r===void 0?void 0:r.get(At),_=(a=s?.owner)===null||a===void 0?void 0:a.get(At);return!(!l||!_||!l.group.canCollide(_.group)||l.collisionType===dt.Fixed&&_.collisionType===dt.Fixed||_.collisionType===dt.PreventCollision||l.collisionType===dt.PreventCollision||!l.isActive||!_.isActive)}get canCollide(){const e=this.colliderA,s=this.colliderB;return Ve.canCollide(e,s)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(e){return e===this.colliderA||e===this.colliderB}static calculatePairHash(e,s){return e.value<s.value?`#${e.value}+${s.value}`:`#${s.value}+${e.value}`}}class ir{constructor(e,s){this.min=e,this.max=s}overlaps(e){return this.max>e.min&&e.max>this.min}getOverlap(e){return this.overlaps(e)?this.max>e.max?e.max-this.min:this.max-e.min:0}}class sh{constructor(e){this.parent=e,this.parent=e||null,this.data=null,this.bounds=new at,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class nh{constructor(e,s=new at(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=e,this.worldBounds=s,this.root=null,this.nodes={}}_insert(e){if(this.root===null){this.root=e,this.root.parent=null;return}const s=e.bounds;let r=this.root;for(;!r.isLeaf();){const p=r.left,m=r.right,w=r.bounds.getPerimeter(),A=r.bounds.combine(s).getPerimeter(),E=2*A,D=2*(A-w);let L=0;const O=s.combine(p.bounds);let X,H;p.isLeaf()?L=O.getPerimeter()+D:(H=p.bounds.getPerimeter(),X=O.getPerimeter(),L=X-H+D);let N=0;const Q=s.combine(m.bounds);if(m.isLeaf()?N=Q.getPerimeter()+D:(H=m.bounds.getPerimeter(),X=Q.getPerimeter(),N=X-H+D),E<L&&E<N)break;L<N?r=p:r=m}const a=r.parent,l=new sh(a);l.bounds=s.combine(r.bounds),l.height=r.height+1,a!==null?(a.left===r?a.left=l:a.right=l,l.left=r,l.right=e,r.parent=l,e.parent=l):(l.left=r,l.right=e,r.parent=l,e.parent=l,this.root=l);let _=e.parent;for(;_;){if(_=this._balance(_),!_.left)throw new Error("Parent of current leaf cannot have a null left child"+_);if(!_.right)throw new Error("Parent of current leaf cannot have a null right child"+_);_.height=1+Math.max(_.left.height,_.right.height),_.bounds=_.left.bounds.combine(_.right.bounds),_=_.parent}}_remove(e){if(e===this.root){this.root=null;return}const s=e.parent,r=s.parent;let a;if(s.left===e?a=s.right:a=s.left,r){r.left===s?r.left=a:r.right=a,a.parent=r;let l=r;for(;l;)l=this._balance(l),l.bounds=l.left.bounds.combine(l.right.bounds),l.height=1+Math.max(l.left.height,l.right.height),l=l.parent}else this.root=a,a.parent=null}trackCollider(e){const s=new sh;s.data=e,s.bounds=e.bounds,s.bounds.left-=2,s.bounds.top-=2,s.bounds.right+=2,s.bounds.bottom+=2,this.nodes[e.id.value]=s,this._insert(s)}updateCollider(e){var s;const r=this.nodes[e.id.value];if(!r)return!1;const a=e.bounds;if(!this.worldBounds.contains(a))return ot.getInstance().warn("Collider with id "+e.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(e),!1;if(r.bounds.contains(a))return!1;if(this._remove(r),a.left-=this._config.boundsPadding,a.top-=this._config.boundsPadding,a.right+=this._config.boundsPadding,a.bottom+=this._config.boundsPadding,e.owner){const l=(s=e.owner)===null||s===void 0?void 0:s.get(At);if(l){const _=l.vel.x*32/1e3*this._config.velocityMultiplier,p=l.vel.y*32/1e3*this._config.velocityMultiplier;_<0?a.left+=_:a.right+=_,p<0?a.top+=p:a.bottom+=p}}return r.bounds=a,this._insert(r),!0}untrackCollider(e){const s=this.nodes[e.id.value];s&&(this._remove(s),this.nodes[e.id.value]=null,delete this.nodes[e.id.value])}_balance(e){if(e===null)throw new Error("Cannot balance at null node");if(e.isLeaf()||e.height<2)return e;const s=e.left,r=e.right,a=e,l=s,_=r,p=s.left,m=s.right,w=r.left,y=r.right,A=_.height-l.height;if(A>1)return _.left=a,_.parent=a.parent,a.parent=_,_.parent?_.parent.left===a?_.parent.left=_:_.parent.right=_:this.root=_,w.height>y.height?(_.right=w,a.right=y,y.parent=a,a.bounds=l.bounds.combine(y.bounds),_.bounds=a.bounds.combine(w.bounds),a.height=1+Math.max(l.height,y.height),_.height=1+Math.max(a.height,w.height)):(_.right=y,a.right=w,w.parent=a,a.bounds=l.bounds.combine(w.bounds),_.bounds=a.bounds.combine(y.bounds),a.height=1+Math.max(l.height,w.height),_.height=1+Math.max(a.height,y.height)),_;if(A<-1){if(l.left=a,l.parent=a.parent,a.parent=l,l.parent)if(l.parent.left===a)l.parent.left=l;else{if(l.parent.right!==a)throw"Error rotating Dynamic Tree";l.parent.right=l}else this.root=l;return p.height>m.height?(l.right=p,a.left=m,m.parent=a,a.bounds=_.bounds.combine(m.bounds),l.bounds=a.bounds.combine(p.bounds),a.height=1+Math.max(_.height,m.height),l.height=1+Math.max(a.height,p.height)):(l.right=m,a.left=p,p.parent=a,a.bounds=_.bounds.combine(p.bounds),l.bounds=a.bounds.combine(m.bounds),a.height=1+Math.max(_.height,p.height),l.height=1+Math.max(a.height,m.height)),l}return e}getHeight(){return this.root===null?0:this.root.height}query(e,s){const r=e.bounds,a=l=>{if(l&&l.bounds.overlaps(r))if(l.isLeaf()&&l.data!==e){if(s.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}rayCastQuery(e,s=1/0,r){const a=l=>{if(l&&l.bounds.rayCast(e,s))if(l.isLeaf()){if(r.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}getNodes(){const e=s=>s?[s].concat(e(s.left),e(s.right)):[];return e(this.root)}debug(e){const s=r=>{r&&(r.isLeaf()?r.bounds.draw(e,$.Green):r.bounds.draw(e,$.White),r.left&&s(r.left),r.right&&s(r.right))};s(this.root)}}class qs{constructor(e,s){this.pos=e,this.dir=s.normalize()}intersect(e){const s=e.begin.sub(this.pos);if(this.dir.cross(e.getSlope())===0&&s.cross(this.dir)!==0)return-1;const r=this.dir.cross(e.getSlope());if(r===0)return-1;const a=s.cross(e.getSlope())/r;if(a>=0){const l=s.cross(this.dir)/r/e.getLength();if(l>=0&&l<=1)return a}return-1}intersectPoint(e){const s=this.intersect(e);return s<0?null:this.getPoint(s)}getPoint(e){return this.pos.add(this.dir.scale(e))}}class _o{constructor(e){this._config=e,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new nh(e.dynamicTree)}getColliders(){return this._colliders}query(e){const s=[];return e instanceof at?this._dynamicCollisionTree.query({id:T("collider",-1),owner:null,bounds:e},r=>(s.push(r),!1)):this._dynamicCollisionTree.query({id:T("collider",-1),owner:null,bounds:new at(e.x,e.y,e.x,e.y)},r=>(s.push(r),!1)),s}rayCast(e,s){var r,a,l;const _=[],p=(r=s?.maxDistance)!==null&&r!==void 0?r:1/0,m=s?.collisionGroup,w=m?m.category:(a=s?.collisionMask)!==null&&a!==void 0?a:ts.All.category,y=(l=s?.searchAllColliders)!==null&&l!==void 0?l:!1;return this._dynamicCollisionTree.rayCastQuery(e,p,A=>{const D=A.owner.get(At);if(s?.ignoreCollisionGroupAll&&D.group===ts.All)return!1;const L=(w&D.group.category)!==0;if(D?.group&&!L)return!1;const O=A.rayCast(e,p);if(O){if(s?.filter){if(s.filter(O)&&(_.push(O),!y))return!0}else if(_.push(O),!y)return!0}return!1}),_}track(e){if(!e){ot.getInstance().warn("Cannot track null collider");return}if(e instanceof we){const s=e.getColliders();for(const r of s)r.owner=e.owner,this._colliders.push(r),this._dynamicCollisionTree.trackCollider(r)}else this._colliders.push(e),this._dynamicCollisionTree.trackCollider(e)}untrack(e){if(!e){ot.getInstance().warn("Cannot untrack a null collider");return}if(e instanceof we){const s=e.getColliders();for(const r of s){const a=this._colliders.indexOf(r);a!==-1&&this._colliders.splice(a,1),this._dynamicCollisionTree.untrackCollider(r)}}else{const s=this._colliders.indexOf(e);s!==-1&&this._colliders.splice(s,1),this._dynamicCollisionTree.untrackCollider(e)}}_pairExists(e,s){const r=Ve.calculatePairHash(e.id,s.id);return this._pairs.has(r)}broadphase(e,s,r){const a=s/1e3,l=e.filter(p=>{var m,w;const y=(m=p.owner)===null||m===void 0?void 0:m.get(At);return((w=p.owner)===null||w===void 0?void 0:w.isActive)&&y.collisionType!==dt.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let _;for(let p=0,m=l.length;p<m;p++)_=l[p],this._dynamicCollisionTree.query(_,w=>{if(!this._pairExists(_,w)&&Ve.canCollide(_,w)){const y=new Ve(_,w);this._pairs.add(y.id),this._collisionPairCache.push(y)}return!1});if(r&&(r.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const p of l){const m=p.owner.get(At);if(m.collisionType!==dt.Active)continue;const w=m.vel.magnitude*a+m.acc.magnitude*.5*a*a,y=Math.min(p.bounds.height,p.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||w>y/2){r&&r.physics.fastBodies++;const A=m.globalPos.sub(m.oldPos),E=p.center,D=p.getFurthestPoint(m.vel),L=D.sub(A),O=new qs(L,m.vel);O.pos=O.pos.add(O.dir.scale(-2*this._config.continuous.surfaceEpsilon));let X,H=new B(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(O,w+this._config.continuous.surfaceEpsilon*2,N=>{if(!this._pairExists(p,N)&&Ve.canCollide(p,N)){const Q=N.rayCast(O,w+this._config.continuous.surfaceEpsilon*10);if(Q){const Y=Q.point.sub(L);Y.magnitude<H.magnitude&&(H=Y,X=N)}}return!1}),X&&B.isValid(H)){const N=new Ve(p,X);this._pairs.has(N.id)||(this._pairs.add(N.id),this._collisionPairCache.push(N));const Q=E.sub(D);m.globalPos=L.add(Q).add(H).add(O.dir.scale(10*this._config.continuous.surfaceEpsilon)),p.update(m.transform.get()),r&&r.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(e,s){let r=[];for(let a=0;a<e.length;a++){const l=e[a].collide();if(r=r.concat(l),s&&l.length>0)for(const _ of l)s.physics.contacts.set(_.id,_)}return s&&(s.physics.collisions+=r.length),r}update(e){let s=0;const r=e.length;for(let a=0;a<r;a++)this._dynamicCollisionTree.updateCollider(e[a])&&s++;return s}debug(e){this._dynamicCollisionTree.debug(e)}}class ys{constructor(){this.id=T("collider",ys._ID++),this.composite=null,this.events=new I,this.offset=B.Zero}touching(e){return!!this.collide(e)}}ys._ID=0;var sr;(function(u){u.Arcade="arcade",u.Realistic="realistic"})(sr||(sr={}));var es;(function(u){u.None="none",u.VerticalFirst="vertical-first",u.HorizontalFirst="horizontal-first"})(es||(es={}));const rh={vertical:1,horizontal:2},oh={horizontal:1,vertical:2},ah={horizontal:0,vertical:0};var bn;(function(u){u.DynamicTree="dynamic-tree",u.SparseHashGrid="sparse-hash-grid"})(bn||(bn={}));const is=()=>({enabled:!0,gravity:z(0,0).clone(),solver:sr.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:bn.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:es.None},realistic:{contactSolveBias:es.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class we extends ys{set compositeStrategy(e){this._compositeStrategy=e}get compositeStrategy(){return this._compositeStrategy}constructor(e){super(),this._collisionProcessor=new _o({...is()}),this._dynamicAABBTree=new nh({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const s of e)this.addCollider(s)}clearColliders(){this._colliders=[]}addCollider(e){let s;e instanceof we?(s=e.getColliders(),s.forEach(r=>r.offset.addEqual(e.offset))):s=[e];for(const r of s)r.events.pipe(this.events),r.composite=this,this._colliders.push(r),this._collisionProcessor.track(r),this._dynamicAABBTree.trackCollider(r)}removeCollider(e){e.events.pipe(this.events),e.composite=null,$i(e,this._colliders),this._collisionProcessor.untrack(e),this._dynamicAABBTree.untrackCollider(e)}getColliders(){return this._colliders}get worldPos(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:B.Zero).add(this.offset)}get center(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:B.Zero).add(this.offset)}get bounds(){var e,s;const r=this.getColliders();return r.reduce((l,_)=>l.combine(_.bounds),(s=(e=r[0])===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new at().translate(this.worldPos)).translate(this.offset)}get localBounds(){var e,s;const r=this.getColliders();return r.reduce((l,_)=>l.combine(_.localBounds),(s=(e=r[0])===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new at)}get axes(){const e=this.getColliders();let s=[];for(const r of e)s=s.concat(r.axes);return s}getFurthestPoint(e){const s=this.getColliders(),r=[];for(const _ of s)r.push(_.getFurthestPoint(e));let a=r[0],l=-Number.MAX_VALUE;for(const _ of r){const p=_.dot(e);p>l&&(a=_,l=p)}return a}getInertia(e){const s=this.getColliders();let r=0;for(const a of s)r+=a.getInertia(e);return r}collide(e){let s=[e];e instanceof we&&(s=e.getColliders());const r=[];for(const l of s)this._dynamicAABBTree.query(l,_=>(r.push(new Ve(l,_)),!1));let a=[];for(const l of r)a=a.concat(l.collide());return a}getClosestLineBetween(e){const s=this.getColliders(),r=[];if(e instanceof we){const a=e.getColliders();for(const l of s)for(const _ of a){const p=l.getClosestLineBetween(_);p&&r.push(p)}}else for(const a of s){const l=e.getClosestLineBetween(a);l&&r.push(l)}if(r.length){let a=r[0].getLength(),l=r[0];for(const _ of r){const p=_.getLength();p<a&&(a=p,l=_)}return l}return null}contains(e){const s=this.getColliders();for(const r of s)if(r.contains(e))return!0;return!1}rayCast(e,s){const r=this.getColliders(),a=[];for(const l of r){const _=l.rayCast(e,s);_&&a.push(_)}if(a.length){let l=a[0],_=l.point.dot(e.dir);for(const p of a){const m=e.dir.dot(p.point);m<_&&(l=p,_=m)}return l}return null}project(e){const s=this.getColliders(),r=[];for(const a of s){const l=a.project(e);l&&r.push(l)}if(r.length){const a=new ir(r[0].min,r[0].max);for(const l of r)a.min=Math.min(l.min,a.min),a.max=Math.max(l.max,a.max);return a}return null}update(e){if(e){const s=this.getColliders();for(const r of s)r.owner=this.owner,r.update(e)}}debug(e,s,r){const a=this.getColliders();e.save(),e.translate(this.offset.x,this.offset.y);for(const l of a)l.debug(e,s,r);e.restore()}clone(){const e=new we(this._colliders.map(s=>s.clone()));return e.offset=this.offset.clone(),e}}class re{constructor(e,s){this.begin=e,this.end=s}clone(e){const s=e||new re(this.begin.clone(),this.end.clone());return s.begin=this.begin.clone(s.begin),s.end=this.end.clone(s.end),s}transform(e,s){const r=s||new re(B.Zero,B.Zero);return r.begin=e.multiply(this.begin,r.begin),r.end=e.multiply(this.end,r.end),r}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const e=this.begin,s=this.end,r=e.distance(s);return this._slope=s.sub(e).scale(1/r)}getEdge(){const e=this.begin;return this.end.sub(e)}getLength(){const e=this.begin,s=this.end;return e.distance(s)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new re(this.end,this.begin)}below(e){return(this.end.x-this.begin.x)*(e.y-this.begin.y)-(this.end.y-this.begin.y)*(e.x-this.begin.x)>=0}clip(e,s,r=!0){let a=e;r&&(a=a.normalize());const l=a.dot(this.begin)-s,_=a.dot(this.end)-s,p=[];if(l<=0&&p.push(this.begin),_<=0&&p.push(this.end),l*_<0){const m=l/(l-_);p.push(this.begin.add(this.end.sub(this.begin).scale(m)))}return p.length!==2?null:new re(p[0],p[1])}distanceToPoint(e,s=!1){const r=e.x,a=e.y,l=this.getLength(),_=this.end.y-this.begin.y,p=this.end.x-this.begin.x,m=(_*r-p*a+this.end.x*this.begin.y-this.end.y*this.begin.x)/l;return s?m:Math.abs(m)}findVectorToPoint(e){const s=this.begin.sub(e),r=this.getSlope();return s.sub(r.scale(s.dot(r)))}findPoint(e=null,s=null){const r=this.slope,a=this.intercept;if(e!==null)return new B(e,r*e+a);if(s!==null)return new B((s-a)/r,s);throw new Error("You must provide an X or a Y value")}hasPoint(){let e,s=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")e=new B(arguments[0],arguments[1]),s=arguments[2]||0;else if(arguments[0]instanceof B)e=arguments[0],s=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const r=e.x-this.begin.x,a=e.y-this.begin.y,l=this.end.x-this.begin.x,_=this.end.y-this.begin.y,p=r*_-a*l;return Math.abs(p)>s?!1:Math.abs(l)>=Math.abs(_)?l>0?this.begin.x<=e.x&&e.x<=this.end.x:this.end.x<=e.x&&e.x<=this.begin.x:_>0?this.begin.y<=e.y&&e.y<=this.end.y:this.end.y<=e.y&&e.y<=this.begin.y}}function hh(u,e){const r=u.dir(),a=e.dir(),l=r.dot(r),_=a.dot(a);if(l<1e-9&&_<1e-9)return new re(u.begin,e.begin);if(l<1e-9){const X=j(a.dot(u.begin.sub(e.begin))/_,0,1),H=e.begin.add(a.scale(X));return new re(u.begin,H)}if(_<1e-9){const X=j(r.dot(e.begin.sub(u.begin))/l,0,1),H=u.begin.add(r.scale(X));return new re(H,e.begin)}const p=u.begin.sub(e.begin),m=l,w=_,y=a.dot(p),A=m*w-Math.pow(r.dot(a),2);let E=0,D=0;Math.abs(A)>1e-9?E=j((r.dot(a)*y-w*r.dot(p))/A,0,1):E=j(r.dot(p)/m,0,1),Math.abs(w)>1e-9?D=j((r.dot(a)*E+y)/w,0,1):D=0;const L=u.begin.add(r.scale(E)),O=e.begin.add(a.scale(D));return new re(L,O)}const Bi={PolygonPolygonClosestLine(u,e){const s=u.getSides(),r=e.getSides();let a=Number.MAX_VALUE,l=null;for(let _=0;_<s.length;_++)for(let p=0;p<r.length;p++){const m=hh(s[_],r[p]),w=m.getLength();w<a&&(a=w,l=m)}return l},PolygonEdgeClosestLine(u,e){const r=e.worldPos.sub(u.worldPos),a=new qs(u.worldPos,r),l=u.rayCast(a).point.add(a.dir.scale(.1)),_=u.getClosestFace(l),p=e.asLine();return hh(_.face,p)},PolygonCircleClosestLine(u,e){const s=e.worldPos,r=s.sub(u.worldPos),a=new qs(u.worldPos,r.normalize()),l=u.rayCast(a).point.add(a.dir.scale(.1)),_=u.getClosestFace(l),p=_.face.begin,m=_.face.getEdge();let w=(m.x*(s.x-p.x)+m.y*(s.y-p.y))/(m.x*m.x+m.y*m.y);w>1?w=1:w<0&&(w=0);const y=Math.sqrt(Math.pow(p.x+m.x*w-s.x,2)+Math.pow(p.y+m.y*w-s.y,2))-e.radius,A=(p.x+m.x*w-s.x)*e.radius/(e.radius+y),E=(p.y+m.y*w-s.y)*e.radius/(e.radius+y);return new re(m.scale(w).add(p),new B(s.x+A,s.y+E))},CircleCircleClosestLine(u,e){const r=e.worldPos.sub(u.worldPos),l=u.worldPos.sub(e.worldPos),_=new qs(u.worldPos,r),p=new qs(e.worldPos,l),m=u.rayCast(_),w=e.rayCast(p);return new re(m.point,w.point)},CircleEdgeClosestLine(u,e){const s=u.worldPos,r=e.asLine(),a=r.begin,l=r.getEdge(),_=a,p=l;let m=(p.x*(s.x-_.x)+p.y*(s.y-_.y))/(p.x*p.x+p.y*p.y);m>1?m=1:m<0&&(m=0);const w=Math.sqrt(Math.pow(_.x+p.x*m-s.x,2)+Math.pow(_.y+p.y*m-s.y,2))-u.radius,y=(_.x+p.x*m-s.x)*u.radius/(u.radius+w),A=(_.y+p.y*m-s.y)*u.radius/(u.radius+w);return new re(p.scale(m).add(_),new B(s.x+y,s.y+A))},EdgeEdgeClosestLine(u,e){const s=u.asLine(),r=e.asLine();return hh(s,r)}};class Le extends ys{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var e;if(this._radius)return this._radius;const s=this._transform,r=(e=s?.globalScale)!==null&&e!==void 0?e:B.One;return this._radius=this._naturalRadius*Math.min(r.x,r.y)}set radius(e){var s;const r=this._transform,a=(s=r?.globalScale)!==null&&s!==void 0?s:B.One;this._naturalRadius=e/Math.min(a.x,a.y),this._localBoundsDirty=!0,this._radius=e}constructor(e){super(),this.offset=B.Zero,this._globalMatrix=he.identity(),this._localBoundsDirty=!0,this.offset=e.offset||B.Zero,this.radius=e.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new Le({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(e){var s,r;return((r=(s=this._transform)===null||s===void 0?void 0:s.pos)!==null&&r!==void 0?r:this.offset).distance(e)<=this.radius}rayCast(e,s=1/0){var r,a;const l=this.center,_=e.dir,p=e.pos,m=l.sub(p),w=_.scale(m.dot(_)),A=m.sub(w).magnitude;if(A>this.radius)return null;{let E=0;if(q(A,this.radius,1e-4)){if(E=-_.dot(p.sub(l)),E>0&&E<s){const D=e.getPoint(E);return{point:D,normal:D.sub(l).normalize(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(At),distance:E}}return null}else{const D=Math.sqrt(Math.pow(_.dot(p.sub(l)),2)-Math.pow(p.sub(l).distance(),2)+Math.pow(this.radius,2)),L=-_.dot(p.sub(l))+D,O=-_.dot(p.sub(l))-D,X=[];L>=0&&X.push(L),O>=0&&X.push(O);const H=Math.min(...X);if(H<=s){const N=e.getPoint(H);return{point:N,normal:N.sub(l).normalize(),collider:this,body:(a=this.owner)===null||a===void 0?void 0:a.get(At),distance:H}}return null}}}getClosestLineBetween(e){if(e instanceof Le)return Bi.CircleCircleClosestLine(this,e);if(e instanceof Se)return Bi.PolygonCircleClosestLine(e,this).flip();if(e instanceof si)return Bi.CircleEdgeClosestLine(this,e).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof Le)return yi.CollideCircleCircle(this,e);if(e instanceof Se)return yi.CollideCirclePolygon(this,e);if(e instanceof si)return yi.CollideCircleEdge(this,e);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){return this.center.add(e.normalize().scale(this.radius))}getFurthestLocalPoint(e){return e.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new at(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(e){return e*this.radius*this.radius/2}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(e){const s=[],a=this.center.dot(e);return s.push(a),s.push(a+this.radius),s.push(a-this.radius),new ir(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s,r){var a,l,_,p;const{lineWidth:m}={lineWidth:1,...r},w=this._transform,y=(a=w?.globalScale)!==null&&a!==void 0?a:B.One,A=(l=w?.globalRotation)!==null&&l!==void 0?l:0,E=(_=w?.globalPos)!==null&&_!==void 0?_:B.Zero;e.save(),e.translate(E.x,E.y),e.rotate(A),e.scale(y.x,y.y),e.drawCircle((p=this.offset)!==null&&p!==void 0?p:B.Zero,this._naturalRadius,$.Transparent,s,m),e.restore()}}class Xs{constructor(e,s,r,a,l,_,p,m){var w,y,A,E,D,L;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=e,this.colliderB=s,this.mtv=r,this.normal=a,this.tangent=l,this.points=_,this.localPoints=p,this.info=m,this.id=Ve.calculatePairHash(e.id,s.id),e.composite||s.composite){const O=((w=e.composite)===null||w===void 0?void 0:w.compositeStrategy)==="separate"?e.id:(A=(y=e.composite)===null||y===void 0?void 0:y.id)!==null&&A!==void 0?A:e.id,X=((E=s.composite)===null||E===void 0?void 0:E.compositeStrategy)==="separate"?s.id:(L=(D=s.composite)===null||D===void 0?void 0:D.id)!==null&&L!==void 0?L:s.id;this.id+="|"+Ve.calculatePairHash(O,X)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(At)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(At))}matchAwake(){const e=this.bodyA,s=this.bodyB;e&&s&&e.isSleeping!==s.isSleeping&&(e.isSleeping&&e.collisionType!==dt.Fixed&&s.sleepMotion>=e.wakeThreshold&&(e.isSleeping=!1),s.isSleeping&&s.collisionType!==dt.Fixed&&e.sleepMotion>=s.wakeThreshold&&(s.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(e){if(e!==this.colliderA&&e!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(e===this.colliderA)return this;const s=this.colliderA,r=this.colliderB;return this.colliderB=s,this.colliderA=r,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class Nc{constructor(){this.axis=z(0,0),this.localAxis=z(0,0),this.side=new re(z(0,0),z(0,0)),this.localSide=new re(z(0,0),z(0,0)),this.point=z(0,0),this.localPoint=z(0,0)}}class ce{static findPolygonPolygonSeparation(e,s){if(s.transform.matrix.determinant()===0)return ce.findPolygonPolygonSeparationDegenerate(e,s);let r=-Number.MAX_VALUE,a=-1,l;const _=s.transform.inverse.multiply(e.transform.matrix,ce._SCRATCH_MATRIX),p=_.getRotation(),m=e.normals,w=e.points,y=s.points;for(let D=0;D<w.length;D++){const L=m[D].rotate(p,ce._ZERO,ce._SCRATCH_NORMAL),O=_.multiply(w[D],ce._SCRATCH_POINT);let X=Number.MAX_VALUE,H;for(let N=0;N<y.length;N++){const Q=L.dot(y[N].sub(O,ce._SCRATCH_SUB_POINT));Q<X&&(X=Q,H=y[N])}X>r&&(r=X,a=D,l=H)}const A=(a+1)%w.length,E=ce.SeparationPool.get();return E.collider=e,E.separation=r,r>0||(m[a].clone(E.localAxis),m[a].rotate(e.transform.rotation,ce._ZERO,E.axis),e.transform.matrix.multiply(w[a],E.side.begin),e.transform.matrix.multiply(w[A],E.side.end),s.transform.matrix.multiply(l,E.point),E.sideId=a,l.clone(E.localPoint),w[a].clone(E.localSide.begin),w[A].clone(E.localSide.end)),E}static findCirclePolygonSeparation(e,s){const r=s.axes,l=s.center.sub(e.worldPos),_=s.getFurthestPoint(l.negate());r.push(_.sub(e.worldPos).normalize());let p=Number.MAX_VALUE,m=null,w=-1;for(let y=0;y<r.length;y++){const A=s.project(r[y]),E=e.project(r[y]),D=A.getOverlap(E);if(D<=0)return null;D<p&&(p=D,m=r[y],w=y)}return w<0?null:m.normalize().scale(p)}static findPolygonPolygonSeparationDegenerate(e,s){let r=-Number.MAX_VALUE,a=null,l=null,_=-1,p=null;const m=e.getSides(),w=e.getLocalSides();for(let y=0;y<m.length;y++){const A=m[y],E=A.normal(),D=s.getFurthestPoint(E.negate()),L=A.distanceToPoint(D,!0);L>r&&(r=L,a=A,l=E,_=y,p=D)}return{collider:e,separation:l?r:99,axis:l,side:a,localSide:w[_],sideId:_,point:p,localPoint:l?s.getFurthestLocalPoint(l.negate()):null}}}ce.SeparationPool=new $r(()=>new Nc,u=>u,500),ce._ZERO=z(0,0),ce._SCRATCH_POINT=z(0,0),ce._SCRATCH_SUB_POINT=z(0,0),ce._SCRATCH_NORMAL=z(0,0),ce._SCRATCH_MATRIX=he.identity(),ce.SeparationPool.disableWarnings=!0;const Ip=B.Zero,Rp=B.Zero,Dp=he.identity(),yi={CollideCircleCircle(u,e){const s=u.worldPos,r=e.worldPos,a=u.radius+e.radius,l=s.distance(r);if(l>a)return[];const _=a-l,p=r.sub(s).normalize(),m=p.perpendicular(),w=p.scale(_),y=u.getFurthestPoint(p),A=u.getFurthestLocalPoint(p),E={collider:u,separation:_,axis:p,point:y};return[new Xs(u,e,w,p,m,[y],[A],E)]},CollideCirclePolygon(u,e){var s,r;let a=ce.findCirclePolygonSeparation(u,e);if(!a)return[];a=a.dot(e.center.sub(u.center))<0?a.negate():a;const _=u.getFurthestPoint(a),m=((r=(s=u.owner)===null||s===void 0?void 0:s.get(et))!==null&&r!==void 0?r:new et).applyInverse(_),w=a.normalize(),y={collider:u,separation:-a.magnitude,axis:w,point:_,localPoint:m,side:e.findSide(w.negate()),localSide:e.findLocalSide(w.negate())};return[new Xs(u,e,a,w,w.perpendicular(),[_],[m],y)]},CollideCircleEdge(u,e){const s=u.center,r=e.asLine(),a=r.end.sub(r.begin),l=a.dot(r.end.sub(s)),_=a.dot(s.sub(r.begin)),p=e.asLine(),m=e.asLocalLine();if(_<=0){const H=r.begin.sub(s),N=H.dot(H);if(N>u.radius*u.radius)return[];const Q=H.normalize(),Y=u.radius-Math.sqrt(N),J={collider:u,separation:Y,axis:Q,point:p.begin,side:p,localSide:m};return[new Xs(u,e,Q.scale(Y),Q,Q.perpendicular(),[p.begin],[m.begin],J)]}if(l<=0){const H=r.end.sub(s),N=H.dot(H);if(N>u.radius*u.radius)return[];const Q=H.normalize(),Y=u.radius-Math.sqrt(N),J={collider:u,separation:Y,axis:Q,point:p.end,side:p,localSide:m};return[new Xs(u,e,Q.scale(Y),Q,Q.perpendicular(),[p.end],[m.end],J)]}const w=a.dot(a),y=r.begin.scale(l).add(r.end.scale(_)).scale(1/w),A=s.sub(y),E=A.dot(A);if(E>u.radius*u.radius)return[];let D=a.perpendicular();D.dot(s.sub(r.begin))<0&&(D.x=-D.x,D.y=-D.y),D=D.normalize();const L=u.radius-Math.sqrt(E),O=D.scale(L),X={collider:u,separation:L,axis:D,point:y,side:p,localSide:m};return[new Xs(u,e,O,D.negate(),D.negate().perpendicular(),[y],[y.sub(e.worldPos)],X)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(u,e){var s;const r=u.center,l=e.center.sub(r).normalize(),_=new Se({points:[e.begin,e.end,e.end.add(l.scale(100)),e.begin.add(l.scale(100))],offset:e.offset});_.owner=e.owner,((s=e.owner)===null||s===void 0?void 0:s.get(et))&&_.update(e.owner.get(et).get());const m=this.CollidePolygonPolygon(u,_);return m.length&&(m[0].colliderB=e,m[0].id=Ve.calculatePairHash(u.id,e.id)),m},CollidePolygonPolygon(u,e){const s=ce.findPolygonPolygonSeparation(u,e);if(s.separation>0)return[];const r=ce.findPolygonPolygonSeparation(e,u);if(r.separation>0)return[];const a=s.separation>r.separation?s:r,l=a.collider===u?e:u,_=a.collider===u?u:e,p=l.transform.inverse.multiply(_.transform.matrix,Dp),m=p.getRotation(),w=_.normals[a.sideId].rotate(m,Ip,Rp);let y=Number.MAX_VALUE,A=0;for(let H=0;H<l.normals.length;H++){const N=w.dot(l.normals[H]);N<y&&(y=N,A=H)}if(!a.localSide||!a.localAxis||!a.axis)return[];const E=a.localSide.transform(p),D=a.localAxis.perpendicular().negate().rotate(m),O=new re(l.points[A],l.points[(A+1)%l.points.length]).clip(D.negate(),-D.dot(E.begin),!1);let X=null;if(O&&(X=O.clip(D,D.dot(E.end),!1)),X){const H=[],N=[],Q=X.getPoints();for(let rt=0;rt<Q.length;rt++){const Z=Q[rt];E.below(Z)&&(H.push(Z),N.push(l.transform.apply(Z)))}let Y=a.axis,J=Y.perpendicular();return e.center.sub(u.center).dot(Y)<0&&(Y=Y.negate(),J=Y.perpendicular()),[new Xs(u,e,Y.scale(-a.separation),Y,J,N,H,a)]}return[]},FindContactSeparation(u,e){var s,r,a,l;const _=u.colliderA,p=(r=(s=u.bodyA)===null||s===void 0?void 0:s.transform)!==null&&r!==void 0?r:new et,m=u.colliderB,w=(l=(a=u.bodyB)===null||a===void 0?void 0:a.transform)!==null&&l!==void 0?l:new et;if(_ instanceof Le&&m instanceof Le){const y=_.radius+m.radius,A=p.pos.distance(w.pos);return-(y-A)}if(_ instanceof Se&&m instanceof Se&&u.info.localSide){let y,A;return u.info.collider===_?(y=new re(p.apply(u.info.localSide.begin).add(_.offset),p.apply(u.info.localSide.end).add(_.offset)),A=w.apply(e).add(m.offset)):(y=new re(w.apply(u.info.localSide.begin).add(m.offset),w.apply(u.info.localSide.end).add(m.offset)),A=p.apply(e).add(_.offset)),y.distanceToPoint(A,!0)}if(_ instanceof Se&&m instanceof Le||m instanceof Se&&_ instanceof Le){const y=p.apply(e);if(u.info.side)return u.info.side.distanceToPoint(y,!0)}if(_ instanceof si&&m instanceof Se||m instanceof si&&_ instanceof Se){let y;if(u.info.collider===_?y=w.apply(e):y=p.apply(e),u.info.side)return u.info.side.distanceToPoint(y,!0)}if(_ instanceof Le&&m instanceof si||m instanceof Le&&_ instanceof si){const y=w.apply(e);let A;_ instanceof Le&&(A=_.getFurthestPoint(u.normal));const E=y.distance(A);if(u.info.side)return E>0?-E:0}return 0}};class si extends ys{constructor(e){var s;super(),this._globalMatrix=he.identity(),this.begin=e.begin||B.Zero,this.end=e.end||B.Zero,this.offset=(s=e.offset)!==null&&s!==void 0?s:B.Zero}clone(){return new si({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var e;const s=this._transform;return(e=s?.globalPos.add(this.offset))!==null&&e!==void 0?e:this.offset}get center(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.average(s)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const e=this._getTransformedBegin(),s=this._getTransformedEnd(),r=e.distance(s);return s.sub(e).scale(1/r)}getLength(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.distance(s)}contains(){return!1}rayCast(e,s=1/0){var r;const a=this._getTransformedBegin().sub(e.pos);if(e.dir.cross(this.getSlope())===0&&a.cross(e.dir)!==0)return null;const l=e.dir.cross(this.getSlope());if(l===0)return null;const _=a.cross(this.getSlope())/l;if(_>=0&&_<=s){const p=a.cross(e.dir)/l/this.getLength();if(p>=0&&p<=1)return{distance:_,normal:this.asLine().normal(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(At),point:e.getPoint(_)}}return null}getClosestLineBetween(e){if(e instanceof Le)return Bi.CircleEdgeClosestLine(e,this);if(e instanceof Se)return Bi.PolygonEdgeClosestLine(e,this).flip();if(e instanceof si)return Bi.EdgeEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof Le)return yi.CollideCircleEdge(e,this);if(e instanceof Se)return yi.CollidePolygonEdge(e,this);if(e instanceof si)return yi.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this._getTransformedBegin(),r=this._getTransformedEnd();return e.dot(s)>0?s:r}_boundsFromBeginEnd(e,s,r=10){return new at(Math.min(e.x,s.x)-r,Math.min(e.y,s.y)-r,Math.max(e.x,s.x)+r,Math.max(e.y,s.y)+r)}get bounds(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return this._boundsFromBeginEnd(e,s)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new re(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new re(this.begin,this.end)}get axes(){const s=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),r=[];return r.push(s),r.push(s.negate()),r.push(s.normal()),r.push(s.normal().negate()),r}getInertia(e){const s=this.end.sub(this.begin).distance()/2;return e*s*s}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(e){const s=[],r=[this._getTransformedBegin(),this._getTransformedEnd()],a=r.length;for(let l=0;l<a;l++)s.push(r[l].dot(e));return new ir(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s){const r=this._getTransformedBegin(),a=this._getTransformedEnd();e.drawLine(r,a,s,2),e.drawCircle(r,2,s),e.drawCircle(a,2,s)}}class xe{static registerGraphicsContext(e){xe._ctx=e}static draw(e){this._drawCalls.push(e)}static drawPoint(e,s){xe.draw(r=>{r.debug.drawPoint(e,s)})}static drawLine(e,s,r){xe.draw(a=>{a.debug.drawLine(e,s,r)})}static drawLines(e,s){e.length>1&&xe.draw(r=>{for(let a=0;a<e.length-1;a++)r.debug.drawLine(e[a],e[a+1],s)})}static drawText(e,s){xe.draw(r=>{r.debug.drawText(e,s)})}static drawPolygon(e,s){e.length>1&&xe.draw(r=>{const a=e[0],l=[...e,a];for(let _=0;_<l.length-1;_++)r.debug.drawLine(l[_],l[_+1],s)})}static drawCircle(e,s,r){const{color:a,strokeColor:l,width:_}={color:$.Black,strokeColor:void 0,width:void 0,...r};xe.draw(p=>{p.drawCircle(e,s,a,l,_)})}static drawBounds(e,s){xe.draw(r=>{r.debug.drawRect(e.left,e.top,e.width,e.height,s)})}static drawRay(e,s){const{distance:r,color:a}={color:$.Blue,distance:10,...s};xe.draw(l=>{const _=e.pos,p=e.pos.add(e.dir.scale(r));l.debug.drawLine(_,p,{color:a})})}static flush(e){e.save(),e.z=xe.z;for(const s of xe._drawCalls)s(e);e.restore(),xe.clear()}static clear(){xe._drawCalls.length=0}}xe._drawCalls=[],xe.z=1/0;class Se extends ys{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(e){if(e.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=e,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const e=[];for(let s=0;s<this._points.length;s++)e.push(this._points[(s+1)%this._points.length].sub(this._points[s]).normal());this._normals=e}get points(){return this._points}get transform(){return this._transform}constructor(e){var s;super(),this._logger=ot.getInstance(),this._transform=new Ki,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(s=e.offset)!==null&&s!==void 0?s:B.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=e.points,this.isConvex()||e.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(e){this._isCounterClockwiseWinding(e)||e.reverse()}_isCounterClockwiseWinding(e){let s=0;for(let r=0;r<e.length;r++)s+=(e[(r+1)%e.length].x-e[r].x)*(e[(r+1)%e.length].y+e[r].y);return s<0}isConvex(){if(this.points.length<3)return!1;let e=this.points[this.points.length-2],s=this.points[this.points.length-1],r=Math.atan2(s.y-e.y,s.x-e.x),a=0,l=0,_=0;for(const[p,m]of this.points.entries()){if(e=s,a=r,s=m,r=Math.atan2(s.y-e.y,s.x-e.x),e.equals(s))return!1;let w=r-a;if(w<=-Math.PI?w+=Math.PI*2:w>Math.PI&&(w-=Math.PI*2),p===0){if(w===0)return!1;l=w>0?1:-1}else if(l*w<=0)return!1;_+=w}return Math.abs(Math.round(_/(Math.PI*2)))===1}tessellate(){const e=[];for(let s=1;s<this.points.length-2;s++)e.push([this.points[0],this.points[s+1],this.points[s+2]]);return e.push([this.points[0],this.points[1],this.points[2]]),new we(e.map(s=>Ue.Polygon(s)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const e=[],s=[...this.points].reverse();let r=s.length;function a(A){return A===0?r-1:A-1}function l(A){return A===r-1?0:A+1}function _(A){const E=a(A),D=l(A),L=s[E],O=s[A],X=s[D],H=L.sub(O),N=X.sub(O);return!(H.cross(N)<0)}const p=s.map((A,E)=>_(E));function m(A,E,D,L){const O=D.sub(E),X=L.sub(D),H=E.sub(L),N=A.sub(E),Q=A.sub(D),Y=A.sub(L),J=O.cross(N),rt=X.cross(Q),Z=H.cross(Y);return!(J>0||rt>0||Z>0)}function w(){for(let A=0;A<r;A++)if(p[A]){const E=a(A),D=l(A),L=s[E],O=s[A],X=s[D];let H=!0;for(let N=0;N<r;N++){if(N===A||N===E||N===D)continue;const Q=s[N];if(m(Q,L,O,X)){H=!1;break}}if(H)return A}for(let A=0;A<r;A++)if(p[A])return A;return 0}function y(A){const E=a(A),D=l(A),L=s[E],O=s[A],X=s[D];e.push([L,O,X]),s.splice(A,1),p.splice(A,1),r--}for(;r>3;){const A=w();y(A);for(let E=0;E<r;E++)p[E]=_(E)}return e.push([s[0],s[1],s[2]]),new we(e.map(A=>Ue.Polygon(A,B.Zero,!0)))}clone(){return new Se({offset:this.offset.clone(),points:this.points.map(e=>e.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const e=this.points,s=e.length;this._transformedPoints.length=0;for(let r=0;r<s;r++)this._transformedPoints[r]=this._transform.apply(e[r].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const e=[],s=this.getTransformedPoints(),r=s.length;for(let a=0;a<r;a++)e.push(new re(s[a],s[(a+1)%r]));this._sides=e,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const e=[],s=this.points,r=s.length;for(let a=0;a<r;a++)e.push(new re(s[a],s[(a+1)%r]));this._localSides=e,this._localSidesDirty=!1}return this._localSides}findSide(e){const s=this.getSides();let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const _=s[l],m=_.normal().dot(e);m>a&&(r=_,a=m)}return r}findLocalSide(e){const s=this.getLocalSides();let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const _=s[l],m=_.normal().dot(e);m>a&&(r=_,a=m)}return r}get axes(){const e=[],s=this.getSides();for(let r=0;r<s.length;r++)e.push(s[r].normal());return e}update(e){e&&(e.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(s=>z(s.x*V(this._transform.scale.x),s.y*V(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(e){const s=this._transform.applyInverse(e),r=new qs(s,new B(1,0));let a=0;const l=this.getLocalSides();for(let _=0;_<l.length;_++){const p=l[_];r.intersect(p)>=0&&a++}return a%2!==0}getClosestLineBetween(e){if(e instanceof Le)return Bi.PolygonCircleClosestLine(this,e);if(e instanceof Se)return Bi.PolygonPolygonClosestLine(this,e);if(e instanceof si)return Bi.PolygonEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof Le)return yi.CollideCirclePolygon(e,this);if(e instanceof Se)return yi.CollidePolygonPolygon(this,e);if(e instanceof si)return yi.CollidePolygonEdge(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this.getTransformedPoints();let r=null,a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const _=e.dot(s[l]);_>a&&(a=_,r=s[l])}return r}getFurthestLocalPoint(e){const s=this.points;let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const _=e.dot(s[l]);_>a&&(a=_,r=s[l])}return r}getClosestFace(e){const s=this.getSides();let r=Number.POSITIVE_INFINITY,a=-1,l=-1;for(let _=0;_<s.length;_++){const p=s[_].distanceToPoint(e);p<r&&(r=p,a=_,l=p)}return a!==-1?{distance:s[a].normal().scale(l),face:s[a]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=at.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(e){if(this._cachedMass===e&&this._cachedInertia)return this._cachedInertia;let s=0,r=0;const a=this.points;for(let l=0;l<a.length;l++){const _=(l+1)%a.length,p=a[_].cross(a[l]);s+=p*(a[l].dot(a[l])+a[l].dot(a[_])+a[_].dot(a[_])),r+=p}return this._cachedMass=e,this._cachedInertia=e/6*(s/r)}rayCast(e,s=1/0){var r;const a=this.getSides(),l=a.length;let _=Number.MAX_VALUE,p,m=-1;for(let w=0;w<l;w++){const y=e.intersect(a[w]);y>=0&&y<_&&y<=s&&(_=y,p=a[w],m=w)}return m>=0?{collider:this,distance:_,body:(r=this.owner)===null||r===void 0?void 0:r.get(At),point:e.getPoint(_),normal:p.normal()}:null}project(e){const s=this.getTransformedPoints(),r=s.length;let a=Number.MAX_VALUE,l=-Number.MAX_VALUE;for(let _=0;_<r;_++){const p=s[_].dot(e);a=Math.min(a,p),l=Math.max(l,p)}return new ir(a,l)}debug(e,s,r){const a=this.getTransformedPoints();xe.drawPolygon(a,{color:s})}}class Ue{static Box(e,s,r=B.Half,a=B.Zero){return new Se({points:new at(-e*r.x,-s*r.y,e-e*r.x,s-s*r.y).getPoints(),offset:a})}static Polygon(e,s=B.Zero,r=!1){return new Se({points:e,offset:s,suppressConvexWarning:r})}static Circle(e,s=B.Zero){return new Le({radius:e,offset:s})}static Edge(e,s){return new si({begin:e,end:s})}static Capsule(e,s,r=B.Zero){const a=ot.getInstance();return e===s&&a.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),s>=e?new we([Ue.Circle(e/2,z(0,-s/2+e/2).add(r)),Ue.Box(e,s-e,B.Half,r),Ue.Circle(e/2,z(0,s/2-e/2).add(r))]):new we([Ue.Circle(s/2,z(-e/2+s/2,0).add(r)),Ue.Box(e-s,s,B.Half,r),Ue.Circle(s/2,z(e/2-s/2,0).add(r))])}}class de extends _i{constructor(e){super(),this.events=new I,this.$colliderAdded=new Ne,this.$colliderRemoved=new Ne,this._collidersToRemove=[],this.set(e)}get(){return this._collider}set(e){return this.clear(),e&&(this._collider=e,this._collider.owner=this.owner,e.events.pipe(this.events),this.$colliderAdded.notifyAll(e),this.update()),e}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const e of this._collidersToRemove)e.events.unpipe(this.events),this.$colliderRemoved.notifyAll(e),e.owner=null}clone(){return new de(this._collider.clone())}get bounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new at}get localBounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new at}update(){var e;const s=(e=this.owner)===null||e===void 0?void 0:e.get(et);this._collider&&(this._collider.owner=this.owner,s&&this._collider.update(s.get()))}collide(e){let s=this._collider,r=e._collider;if(!s||!r)return[];let a=!1;if(r instanceof we&&(s=r,r=this._collider,a=!0),this._collider){const l=s.collide(r);return l?(a&&l.forEach(_=>{_.mtv=_.mtv.negate(),_.normal=_.normal.negate(),_.tangent=_.normal.perpendicular(),_.colliderA=this._collider,_.colliderB=e._collider}),l):[]}return[]}onAdd(e){this._collider&&this.update(),this.events.on("precollision",s=>{const r=s;e.events.emit("precollision",new Os(r.self,r.other,r.side,r.intersection,r.contact)),e instanceof qe&&e.onPreCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("postcollision",s=>{const r=s;e.events.emit("postcollision",new Ws(r.self,r.other,r.side,r.intersection,r.contact)),e instanceof qe&&e.onPostCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("collisionstart",s=>{const r=s;e.events.emit("collisionstart",new Kn(r.self,r.other,r.side,r.contact)),e instanceof qe&&e.onCollisionStart(r.self,r.other,r.side,r.contact)}),this.events.on("collisionend",s=>{const r=s;e.events.emit("collisionend",new Jn(r.self,r.other,r.side,r.lastContact)),e instanceof qe&&e.onCollisionEnd(r.self,r.other,r.side,r.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(e,s,r=B.Half,a=B.Zero){const l=Ue.Box(e,s,r,a);return this.set(l)}usePolygonCollider(e,s=B.Zero){const r=Ue.Polygon(e,s);return this.set(r)}useCircleCollider(e,s=B.Zero){const r=Ue.Circle(e,s);return this.set(r)}useEdgeCollider(e,s){const r=Ue.Edge(e,s);return this.set(r)}useCompositeCollider(e){return this.set(new we(e))}}var Qe;(function(u){u.Rotation="rotation",u.X="x",u.Y="y"})(Qe||(Qe={}));class At extends _i{constructor(e){var s,r,a;super(),this.dependencies=[et,Rt],this.id=T("body",At._ID++),this.events=new I,this.oldTransform=new Ki,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=dt.PreventCollision,this.group=ts.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=B.Zero,this.oldVel=new B(0,0),this.oldAcc=B.Zero,this._impulseScratch=z(0,0),this._distanceFromCenterScratch=z(0,0),e?(this.collisionType=(s=e.type)!==null&&s!==void 0?s:this.collisionType,this.group=(r=e.group)!==null&&r!==void 0?r:this.group,this.useGravity=(a=e.useGravity)!==null&&a!==void 0?a:this.useGravity,this._bodyConfig={...is().bodies,...e.config}):this._bodyConfig={...is().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=At._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(e){this._bodyConfig={...is().bodies,...e},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(e){At._DEFAULT_CONFIG=e}get mass(){return this._mass}set mass(e){this._mass=e,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===dt.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(e){this.isSleeping=e}set isSleeping(e){this._sleeping=e,e?(this.vel=B.Zero,this.acc=B.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const e=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),s=this._bodyConfig.sleepBias;this.sleepMotion=s*this.sleepMotion+(1-s)*e,this.sleepMotion=j(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const e=this.owner.get(de);if(e){e.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),e.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const s=e.get();if(s)return this._cachedInertia=s.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===dt.Fixed?0:1/this.inertia}get active(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get isActive(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get center(){return this.globalPos}onAdd(e){var s,r;this.transform=(s=this.owner)===null||s===void 0?void 0:s.get(et),this.motion=(r=this.owner)===null||r===void 0?void 0:r.get(Rt)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get globalPos(){return this.transform.globalPos}set globalPos(e){this.transform.globalPos=e}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e}get torque(){return this.motion.torque}set torque(e){this.motion.torque=e}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(e){this.transform.globalRotation=e}get scale(){return this.transform.globalScale}set scale(e){this.transform.globalScale=e}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(e){this.motion.scaleFactor=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}applyImpulse(e,s){if(this.collisionType!==dt.Active)return;const r=s.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(Qe.X)>-1&&(r.x=0),this.limitDegreeOfFreedom.indexOf(Qe.Y)>-1&&(r.y=0),this.vel.addEqual(r),!this.limitDegreeOfFreedom.includes(Qe.Rotation)){const a=e.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*a.cross(s)}}applyLinearImpulse(e){if(this.collisionType!==dt.Active)return;const s=e.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(Qe.X)&&(s.x=0),this.limitDegreeOfFreedom.includes(Qe.Y)&&(s.y=0),this.vel=this.vel.add(s)}applyAngularImpulse(e,s){if(this.collisionType===dt.Active&&!this.limitDegreeOfFreedom.includes(Qe.Rotation)){const r=e.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*r.cross(s)}}captureOldTransform(){this.__oldTransformCaptured=!0;const e=this.transform.get();e.clone(this.oldTransform),this.oldTransform.parent=e.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}At._ID=0,At._DEFAULT_CONFIG={...is().bodies};class nr extends gn{constructor(e){super(e),this.width=e.width,this.height=e.height,this.rasterize()}clone(){return new nr({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.color&&e.fillRect(0,0,this.width,this.height),this.strokeColor&&e.strokeRect(0,0,this.width,this.height)}}class fo extends gn{get radius(){return this._radius}set radius(e){this._radius=e,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(e){var s,r,a;super(e),this._radius=0;const l=(s=e.lineWidth)!==null&&s!==void 0?s:e.strokeColor?1:0;this.padding=(r=e.padding)!==null&&r!==void 0?r:2+l/2,this.radius=e.radius,this.filtering=(a=e.filtering)!==null&&a!==void 0?a:le.Blended,this.rasterize()}clone(){return new fo({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.radius>0&&(e.beginPath(),e.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&e.fill(),this.strokeColor&&e.stroke())}}class As extends _i{constructor(e){var s,r;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(s=e?.useColliderShape)!==null&&s!==void 0?s:this.useColliderShape,this.useGraphicsBounds=(r=e?.useGraphicsBounds)!==null&&r!==void 0?r:this.useGraphicsBounds,this.localBounds=e?.localBounds}}class Ot{static CreateReversibleEasingFunction(e){return(s,r,a,l)=>a<r?r-(e(s,a,r,l)-a):e(s,r,a,l)}static CreateVectorEasingFunction(e){return(s,r,a,l)=>new B(e(s,r.x,a.x,l),e(s,r.y,a.y,l))}}Ot.Linear=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,s*u/r+e)),Ot.EaseInQuad=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,s*u*u+e)),Ot.EaseOutQuad=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,-s*u*(u-2)+e)),Ot.EaseInOutQuad=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r/2,u<1?s/2*u*u+e:(u--,-s/2*(u*(u-2)-1)+e))),Ot.EaseInCubic=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,s*u*u*u+e)),Ot.EaseOutCubic=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,u--,s*(u*u*u+1)+e)),Ot.EaseInOutCubic=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r/2,u<1?s/2*u*u*u+e:(u-=2,s/2*(u*u*u+2)+e)));class Gc{constructor(e){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=e}add(e){this._actions.push(e)}remove(e){const s=this._actions.indexOf(e);this._actions.splice(s,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const e=this._actions.length;for(let s=0;s<e;s++)this._actions[s].reset();this._completedActions=[]}update(e){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new ja(this._currentAction,this._entity))),this._currentAction.update(e),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new Za(this._currentAction,this._entity));const s=this._actions.shift();s&&this._completedActions.push(s)}}}let Mp=0;function Bt(){return Mp++}class Vc{constructor(e,s,r){this.id=Bt(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new ar(e),this._actionQueue=this._repeatContext.getQueue(),this._repeat=r,this._originalRepeat=r,this._repeatBuilder(this._repeatContext),this._repeat--}update(e){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(e)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class qc{constructor(e,s){this.id=Bt(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new ar(e),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(e){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(e))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function Xc(u,e,s){return(1-s)*u+e*s}function lh(u,e,s,r){const a=(u-e+W)%W>=Math.PI,l=Math.abs(e-u),_=W-l;let p=0,m=0;l>_?(p=_,m=l):(p=l,m=_);let w=0,y=1;switch(s){case R.ShortestPath:w=p,y=a?1:-1;break;case R.LongestPath:w=m,y=a?-1:1;break;case R.Clockwise:y=1,w=a?p:m;break;case R.CounterClockwise:y=-1,w=a?m:p;break}return u+y*(w*r)}function rr(u,e,s){return u.scale(1-s).add(e.scale(s))}function Yc(u,e,s){return(s-u)/(e-u)}function jc(u,e,s){const r=s.sub(u),a=e.sub(u),l=r.x/a.x,_=r.y/a.y;return Math.min(l,_)}function ki(u,e,s,r,a){const l=Yc(u,e,a);return Xc(s,r,l)}function Fp(u,e,s,r,a){const l=jc(u,e,a);return rr(s,r,l)}function Zc(u){return u.offset instanceof B&&typeof u.duration=="number"}class $c{constructor(e,s){var r;if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._easing=Ot.Linear,this._offset=s.offset,this._easing=(r=s.easing)!==null&&r!==void 0?r:this._easing,this._tx=e.get(et),this._motion=e.get(Rt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=e;const s=j(ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),_=(a-r.x)/(e/1e3),p=(l-r.y)/(e/1e3);this._motion.vel.x=_,this._motion.vel.y=p,this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=z(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class ch{constructor(e,s,r,a){if(this.id=Bt(),this._started=!1,this._stopped=!1,this._entity=e,this._tx=e.get(et),this._motion=e.get(Rt),this._speed=a,this._offset=new B(s,r),a<=0)throw ot.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+a),new Error("Speed must be greater than 0 pixels per second")}update(e){this._started||(this._started=!0,this._start=new B(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(e){const s=e.get(et);return this._stopped||s.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Qc(u){return u.pos instanceof B&&typeof u.duration=="number"}class Kc{constructor(e,s){var r;if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._easing=Ot.Linear,this._end=s.pos,this._easing=(r=s.easing)!==null&&r!==void 0?r:this._easing,this._tx=e.get(et),this._motion=e.get(Rt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=e;const s=j(ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),_=(a-r.x)/(e/1e3),p=(l-r.y)/(e/1e3);this._motion.vel.x=_,this._motion.vel.y=p,this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=z(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class dh{constructor(e,s,r,a){this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Rt),this._end=new B(s,r),this._speed=a}update(e){this._started||(this._started=!0,this._start=new B(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const s=this._dir.scale(this._speed);this._motion.vel=z(s.x,s.y),this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){const s=e.get(et);return this._stopped||new B(s.pos.x,s.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Bp(u){return typeof u.angle=="number"&&typeof u.duration=="number"}class Jc{constructor(e,s){var r;if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=s.angle,this._tx=e.get(et),this._motion=e.get(Rt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(r=s.rotationType)!==null&&r!==void 0?r:R.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=e;const s=j(ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=lh(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(r-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class td{constructor(e,s,r,a){this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Rt),this._end=s,this._speed=r,this._rotationType=a||R.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const s=Math.abs(this._end-this._start),r=W-s;switch(s>r?(this._shortDistance=r,this._longDistance=s):(this._shortDistance=s,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+W)%W>=Math.PI,this._rotationType){case R.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case R.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case R.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case R.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function kp(u){return typeof u.angleRadiansOffset=="number"&&typeof u.duration=="number"}class ed{constructor(e,s){var r;if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=s.angleRadiansOffset,this._tx=e.get(et),this._motion=e.get(Rt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(r=s.rotationType)!==null&&r!==void 0?r:R.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._endAngle=nt(this._startAngle+this._offset),this._started=!0),this._currentMs-=e;const s=j(ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=lh(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(r-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class id{constructor(e,s,r,a){this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Rt),this._speed=r,this._offset=s,this._rotationType=a||R.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const s=Math.abs(this._end-this._start),r=W-s;switch(s>r?(this._shortDistance=r,this._longDistance=s):(this._shortDistance=s,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+W)%W>=Math.PI,this._rotationType){case R.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case R.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case R.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case R.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function sd(u){return typeof u.scale=="object"&&typeof u.duration=="number"}class nd{constructor(e,s){if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._endScale=z(1,1),this._startScale=z(1,1),this._endScale=s.scale,this._tx=e.get(et),this._motion=e.get(Rt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=e;const s=j(ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=rr(this._startScale,this._endScale,s),a=this._tx.scale,l=r.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=B.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class rd{constructor(e,s,r,a,l){this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Rt),this._endX=s,this._endY=r,this._speedX=a,this._speedY=l}update(e){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*s}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*s}this.isComplete()&&(this._tx.scale=z(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function od(u){return typeof u.scaleOffset=="object"&&typeof u.duration=="number"}class ad{constructor(e,s){if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._endScale=z(1,1),this._scaleOffset=z(0,0),this._startScale=z(1,1),this._scaleOffset=s.scaleOffset,this._tx=e.get(et),this._motion=e.get(Rt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=e;const s=j(ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=rr(this._startScale,this._endScale,s),a=this._tx.scale,l=r.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=B.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class hd{constructor(e,s,r,a){this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Rt),this._offset=new B(s,r),this._speedX=this._speedY=a}update(e){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class ld{constructor(e){this.id=Bt(),this._hasBeenCalled=!1,this._method=e}update(e){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class cd{constructor(e,s,r,a,l){this.easingFcn=l,this.id=Bt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new B(0,0),this._lerpEnd=new B(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Rt),this._lerpDuration=a,this._lerpEnd=new B(s,r)}_initialize(){this._lerpStart=new B(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=z((s-this._tx.pos.x)/(e/1e3),(r-this._tx.pos.y)/(e/1e3))):(this._tx.pos=z(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=B.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=z(0,0),this._stopped=!0}}class dd{constructor(e,s,r,a,l){this.easingFcn=l,this.id=Bt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new B(0,0),this._lerpEnd=new B(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Rt),this._lerpDuration=a,this._offset=new B(s,r)}_initialize(){this._lerpStart=new B(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=z((s-this._tx.pos.x)/(e/1e3),(r-this._tx.pos.y)/(e/1e3))):(this._tx.pos=z(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=B.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=z(0,0),this._stopped=!0}}class ud{constructor(e,s,r,a=1){this.id=Bt(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=e.get(Jt),this._timeVisible=s,this._timeNotVisible=r,this._duration=(s+r)*a}update(e){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=e,this._totalTime+=e,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class _d{constructor(e,s,r){this.id=Bt(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=e.get(Jt),this._endOpacity=s,this._remainingTime=this._originalTime=r}update(e){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*e)/this._remainingTime),this._remainingTime-=e,this.isComplete()&&(this._graphics.opacity=this._endOpacity),ot.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class fd{constructor(e){this.id=Bt(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=e}update(e){this._started||(this._started=!0),this._elapsedTime+=e}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class pd{constructor(e){this.id=Bt(),this._stopped=!1,this._entity=e}update(e){this._entity.get(yn).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class uh{constructor(e,s,r){this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Rt),this._followTx=s.get(et),this._followMotion=s.get(Rt),this._current=new B(this._tx.pos.x,this._tx.pos.y),this._end=new B(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=r!==void 0?r:this._current.distance(this._end),this._speed=0}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(s!==0&&(this._speed=s),this._current=z(this._tx.pos.x,this._tx.pos.y),this._end=z(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const r=this._dir.scale(this._speed);this._motion.vel=z(r.x,r.y)}else this._motion.vel=z(0,0);this.isComplete()&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}stop(){this._motion.vel=z(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class _h{constructor(e,s,r){this.id=Bt(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=e.get(et),this._motion=e.get(Rt),this._meetTx=s.get(et),this._meetMotion=s.get(Rt),this._current=new B(this._tx.pos.x,this._tx.pos.y),this._end=new B(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=r||0,r!==void 0&&(this._speedWasSpecified=!0)}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));s!==0&&!this._speedWasSpecified&&(this._speed=s),this._current=z(this._tx.pos.x,this._tx.pos.y),this._end=z(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const r=this._dir.scale(this._speed);this._motion.vel=z(r.x,r.y),this.isComplete()&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class gd{constructor(e,s,r=1e3){var a;this.id=Bt(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=e.get(Jt),this._duration=r,this._entity=e,this._material=(a=e.scene)===null||a===void 0?void 0:a.engine.graphicsContext.createMaterial({name:"flash-material",color:s,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=r}update(e){var s;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=e,this._graphics&&((s=this._material)===null||s===void 0||s.update(r=>{r.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class or{constructor(e){var s;if(this._distLookup=[],this.quality=4,e.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...e.controlPoints],this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(e){this._controlPoints=[...e],this._calculateLookup()}setControlPoint(e,s){this._controlPoints[e]=s,this._calculateLookup()}_calculateLookup(){let e=0;this._distLookup.length=0;let s=this.controlPoints[0];const r=this.controlPoints.length*this.quality;for(let a=0;a<r;a++){const l=a/(r-1),_=this.getPoint(l),p=s.distance(_);e+=p,this._distLookup.push(e),s=_}this._arcLength=e}_getTimeGivenDistance(e){const s=this._distLookup.length,r=this.arcLength;if(e>=0&&e<r){for(let a=0;a<s-1;a++)if(this._distLookup[a]<=e&&e<this._distLookup[a+1])return ki(this._distLookup[a],this._distLookup[a+1],a/(s-1),(a+1)/(s-1),e)}return e/r}getPoint(e){const s=[...this.controlPoints];for(let r=1;r<s.length;r++)for(let a=0;a<s.length-r;a++)s[a]=rr(s[a],s[a+1],e);return s[0]}getTangent(e){const s=e*e,r=this.controlPoints[0],a=this.controlPoints[1],l=this.controlPoints[2],_=this.controlPoints[3];return r.scale(-3*s+6*e-3).add(a.scale(9*s-12*e+3).add(l.scale(-9*s+6*e).add(_.scale(3*s)))).normalize()}getUniformTangent(e){const s=e*this.arcLength,r=this._getTimeGivenDistance(s);return this.getTangent(r)}getNormal(e){return this.getTangent(e).normal()}getUniformNormal(e){return this.getUniformTangent(e).normal()}getUniformPoint(e){const s=e*this.arcLength,r=this._getTimeGivenDistance(s);return this.getPoint(r)}clone(){return new or({controlPoints:[...this.controlPoints],quality:this.quality})}}class md{constructor(e,s){var r;if(this.id=Bt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(et),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new or({controlPoints:[z(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(r=s.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=e;const s=j(ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class vd{constructor(e,s){var r;if(this.id=Bt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(et),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new or({controlPoints:[z(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(r=s.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=e;const s=j(ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class ar{constructor(e){this._entity=e,this._queue=new Gc(e)}getQueue(){return this._queue}update(e){this._queue.update(e)}clearActions(){this._queue.clearActions()}runAction(e){return e.reset(),this._queue.add(e),this}curveBy(e){return this._queue.add(new vd(this._entity,e)),this}curveTo(e){return this._queue.add(new md(this._entity,e)),this}easeTo(...e){var s,r;let a=0,l=0,_=0,p=Ot.Linear;return e[0]instanceof B?(a=e[0].x,l=e[0].y,_=e[1],p=(s=e[2])!==null&&s!==void 0?s:p):(a=e[0],l=e[1],_=e[2],p=(r=e[3])!==null&&r!==void 0?r:p),this._queue.add(new cd(this._entity,a,l,_,p)),this}easeBy(...e){var s,r;let a=0,l=0,_=0,p=Ot.Linear;return e[0]instanceof B?(a=e[0].x,l=e[0].y,_=e[1],p=(s=e[2])!==null&&s!==void 0?s:p):(a=e[0],l=e[1],_=e[2],p=(r=e[3])!==null&&r!==void 0?r:p),this._queue.add(new dd(this._entity,a,l,_,p)),this}moveTo(e,s,r){let a=0,l=0,_=0;return e instanceof B?(a=e.x,l=e.y,_=+(s??0),this._queue.add(new dh(this._entity,a,l,_))):typeof e=="number"&&typeof s=="number"&&typeof r=="number"?(a=e,l=s,_=r,this._queue.add(new dh(this._entity,a,l,_))):Qc(e)&&this._queue.add(new Kc(this._entity,e)),this}moveBy(e,s,r){let a=0,l=0,_=0;return e instanceof B&&typeof s=="number"?(a=e.x,l=e.y,_=s,this._queue.add(new ch(this._entity,a,l,_))):typeof e=="number"&&typeof s=="number"&&typeof r=="number"?(a=e,l=s,_=r,this._queue.add(new ch(this._entity,a,l,_))):Zc(e)&&this._queue.add(new $c(this._entity,e)),this}rotateTo(e,s,r){return typeof e=="number"&&typeof s=="number"?this._queue.add(new td(this._entity,e,s,r)):typeof e=="object"&&this._queue.add(new Jc(this._entity,e)),this}rotateBy(e,s,r){return typeof e=="object"?this._queue.add(new ed(this._entity,e)):this._queue.add(new id(this._entity,e,s,r)),this}scaleTo(e,s,r,a){let l=1,_=1,p=0,m=0;return sd(e)?(this._queue.add(new nd(this._entity,e)),this):(e instanceof B&&s instanceof B&&(l=e.x,_=e.y,p=s.x,m=s.y),typeof e=="number"&&typeof s=="number"&&(l=e,_=s,p=r,m=a),this._queue.add(new rd(this._entity,l,_,p,m)),this)}scaleBy(e,s,r){if(od(e))return this._queue.add(new ad(this._entity,e)),this;let a=1,l=1;return e instanceof B&&(a=e.x,l=e.y,r=s),typeof e=="number"&&typeof s=="number"&&(a=e,l=s),this._queue.add(new hd(this._entity,a,l,r)),this}blink(e,s,r=1){return this._queue.add(new ud(this._entity,e,s,r)),this}fade(e,s){return this._queue.add(new _d(this._entity,e,s)),this}flash(e,s=1e3){return this._queue.add(new gd(this._entity,e,s)),this}delay(e){return this._queue.add(new fd(e)),this}die(){return this._queue.add(new pd(this._entity)),this}callMethod(e){return this._queue.add(new ld(e)),this}repeat(e,s){return s?(this._queue.add(new Vc(this._entity,e,s)),this):(this.repeatForever(e),this)}repeatForever(e){return this._queue.add(new qc(this._entity,e)),this}follow(e,s){return s===void 0?this._queue.add(new uh(this._entity,e)):this._queue.add(new uh(this._entity,e,s)),this}meet(e,s){return s===void 0?this._queue.add(new _h(this._entity,e)):this._queue.add(new _h(this._entity,e,s)),this}toPromise(){return new Promise(s=>{this._queue.add(new ld(()=>{s()}))})}}class yn extends _i{constructor(){super(...arguments),this.dependencies=[et,Rt],this._ctx=null}onAdd(e){this._ctx=new ar(e)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(e){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(e)}update(e){var s;return(s=this._ctx)===null||s===void 0?void 0:s.update(e)}clearActions(){var e;(e=this._ctx)===null||e===void 0||e.clearActions()}curveBy(e){return this._getCtx().curveBy.apply(this._ctx,[e])}curveTo(e){return this._getCtx().curveTo.apply(this._ctx,[e])}easeTo(...e){return this._getCtx().easeTo.apply(this._ctx,e)}easeBy(...e){return this._getCtx().easeBy.apply(this._ctx,e)}moveTo(e,s,r){return this._getCtx().moveTo.apply(this._ctx,[e,s,r])}moveBy(e,s,r){return this._getCtx().moveBy.apply(this._ctx,[e,s,r])}rotateTo(e,s,r){return this._getCtx().rotateTo.apply(this._ctx,[e,s,r])}rotateBy(e,s,r){return this._getCtx().rotateBy.apply(this._ctx,[e,s,r])}scaleTo(e,s,r,a){return this._getCtx().scaleTo.apply(this._ctx,[e,s,r,a])}scaleBy(e,s,r){return this._getCtx().scaleBy.apply(this._ctx,[e,s,r])}blink(e,s,r){return this._getCtx().blink(e,s,r)}fade(e,s){return this._getCtx().fade(e,s)}flash(e,s=1e3){return this._getCtx().flash(e,s)}delay(e){return this._getCtx().delay(e)}die(){return this._getCtx().die()}callMethod(e){return this._getCtx().callMethod(e)}repeat(e,s){return this._getCtx().repeat(e,s)}repeatForever(e){return this._getCtx().repeatForever(e)}follow(e,s){return this._getCtx().follow(e,s)}meet(e,s){return this._getCtx().meet(e,s)}toPromise(){return this._getCtx().toPromise()}}function Lp(u){return u instanceof qe}const Up={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class qe extends ke{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(e){this.body.oldPos.setTo(e.x,e.y)}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e.clone()}get oldVel(){return this.body.oldVel}set oldVel(e){this.body.oldVel.setTo(e.x,e.y)}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e.clone()}set oldAcc(e){this.body.oldAcc.setTo(e.x,e.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(e){this.transform.rotation=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}get scale(){return this.get(et).scale}set scale(e){this.get(et).scale=e}get anchor(){return this._anchor}set anchor(e){this._anchor=gi(e,s=>this._handleAnchorChange(s)),this._handleAnchorChange(e)}_handleAnchorChange(e){this.graphics&&(this.graphics.anchor=e)}get offset(){return this._offset}set offset(e){this._offset=gi(e,s=>this._handleOffsetChange(s)),this._handleOffsetChange(e)}_handleOffsetChange(e){this.graphics&&(this.graphics.offset=e)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(e){e&&(e&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!e&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=e)}get color(){return this.graphics.color}set color(e){this.graphics.color=e}constructor(e){super(),this.events=new I,this._anchor=gi(B.Half,Tt=>this._handleAnchorChange(Tt)),this._offset=gi(B.Zero,Tt=>this._handleOffsetChange(Tt)),this.logger=ot.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=Tt=>{this._dragging&&(this.pos=Tt.worldPos)},this._pointerDragLeaveHandler=Tt=>{this._dragging&&(this.pos=Tt.worldPos)};const{name:s,x:r,y:a,pos:l,coordPlane:_,scale:p,width:m,height:w,radius:y,collider:A,vel:E,acc:D,rotation:L,angularVelocity:O,z:X,color:H,visible:N,opacity:Q,anchor:Y,offset:J,collisionType:rt,collisionGroup:Z,silenceWarnings:_t}={...e};this.name=s??this.name,this.anchor=Y??qe.defaults.anchor.clone(),this.offset=J??B.Zero,this.transform=new et,this.addComponent(this.transform),this.pos=l??z(r??0,a??0),this.rotation=L??0,this.scale=p??z(1,1),this.z=X??0,this.transform.coordPlane=_??Pe.World,this._silenceWarnings=_t??!1,this.pointer=new As,this.addComponent(this.pointer),this.graphics=new Jt({anchor:this.anchor,offset:this.offset,opacity:Q}),this.addComponent(this.graphics),this.motion=new Rt,this.addComponent(this.motion),this.vel=E??B.Zero,this.acc=D??B.Zero,this.angularVelocity=O??0,this.actions=new yn,this.addComponent(this.actions),this.body=new At,this.addComponent(this.body),this.body.collisionType=rt??dt.Passive,Z&&(this.body.group=Z),H&&(this.color=H),A?(this.collider=new de(A),this.addComponent(this.collider)):y?(this.collider=new de(Ue.Circle(y)),this.addComponent(this.collider),H&&this.graphics.add(new fo({color:H,radius:y}))):m>0&&w>0?(this.collider=new de(Ue.Box(m,w,this.anchor)),this.addComponent(this.collider),H&&m&&w&&this.graphics.add(new nr({color:H,width:m,height:w}))):(this.collider=new de,this.addComponent(this.collider)),this.graphics.isVisible=N??!0}clone(){const e=new qe({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});e.clearComponents(),e.processComponentRemoval(),e.addComponent(e.transform=this.transform.clone(),!0),e.addComponent(e.pointer=this.pointer.clone(),!0),e.addComponent(e.graphics=this.graphics.clone(),!0),e.addComponent(e.motion=this.motion.clone(),!0),e.addComponent(e.actions=this.actions.clone(),!0),e.addComponent(e.body=this.body.clone(),!0),e.addComponent(e.collider=this.collider.clone(),!0);const s=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],r=this.getComponents();for(const a of r)s.includes(a)||e.addComponent(a.clone(),!0);return e}onInitialize(e){}_initialize(e){super._initialize(e);for(const s of this.children)s._initialize(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_prekill(e){this.events.emit("prekill",new Pa(this)),this.onPreKill(e)}onPreKill(e){}_postkill(e){this.events.emit("postkill",new Sa(this)),this.onPostKill(e)}onPostKill(e){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new so(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(et).z}set z(e){this.get(et).z=e}get center(){const e=this.getGlobalPos();return new B(e.x+this.width/2-this.anchor.x*this.width,e.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new B(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(et).globalRotation}get globalRotation(){return this.get(et).globalRotation}getGlobalPos(){return this.get(et).globalPos}get globalPos(){return this.get(et).globalPos}getGlobalScale(){return this.get(et).globalScale}get globalScale(){return this.get(et).globalScale}get globalZ(){return this.get(et).globalZ}contains(e,s,r=!1){const a=z(e,s),l=this.get(de);l.update();const _=l.get();if(!_)return!1;const p=_.contains(a);return r?p||this.children.some(m=>m.contains(e,s,!0)):p}within(e,s){const r=this.get(de),a=e.get(de),l=r.get(),_=a.get();return l&&_?l.getClosestLineBetween(_).getLength()<=s:!1}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s),this._postupdate(e,s),this._remove(e)}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreCollisionResolve(e,s,r,a){}onPostCollisionResolve(e,s,r,a){}onCollisionStart(e,s,r,a){}onCollisionEnd(e,s,r,a){}_preupdate(e,s){this.events.emit("preupdate",new xs(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new bs(e,s,this)),this.onPostUpdate(e,s)}}qe.defaults={anchor:B.Half};function wd(u){return u instanceof fh}class fh extends qe{constructor(e){var s,r;super({...e}),this.get(et).coordPlane=Pe.Screen,this.anchor=(s=e?.anchor)!==null&&s!==void 0?s:z(0,0),this.body.collisionType=(r=e?.collisionType)!==null&&r!==void 0?r:dt.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!e?.collider&&e?.width>0&&e?.height>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(e){this._engine=e,super._initialize(e)}contains(e,s,r=!0){if(r)return super.contains(e,s);const a=this._engine.worldToScreenCoordinates(new B(e,s));return super.contains(a.x,a.y)}}class Ys{get complete(){return this._complete}constructor(e){var s;this._logger=ot.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const r=(s=e.action)!==null&&s!==void 0?s:e.fcn,a=e.interval,l=e.repeats,_=e.numberOfRepeats,p=e.randomRange,m=e.random;if(_&&_>=0&&(this.maxNumberOfRepeats=_,!l))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=Ys._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=a,p){if(p[0]>p[1])throw new Error("min value must be lower than max value for range");this.random=m??new M,this.randomRange=p,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=l||this.repeats,r&&this.on(r)}on(e){this._callbacks.push(e)}off(e){const s=this._callbacks.indexOf(e);this._callbacks.splice(s,1)}update(e){this._running&&(this._totalTimeAlive+=e,this._elapsedTime+=e,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(s=>{s.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(e,s){if(e&&e>=0&&(this._baseInterval=this.interval=e),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=s,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}Ys._MAX_ID=0;class po extends _i{constructor(e){super(),this.parallaxFactor=z(1,1),this.parallaxFactor=e??this.parallaxFactor}}class go extends _i{constructor(e,s=!0){super(),this.draw=e,this.useTransform=s}}function xd(u){return u&&u._dispatchPointerEvents&&u._processPointerToObject}class zp{get events(){return this.object.events}init(e,s,r){this.object=e,this.contains=s,this.active=r}}class ph{constructor(){this._proxyPool=new Xn(()=>new zp,e=>e,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(e,s,r){const a=this._proxyPool.rent(!1);a.init(e,s,r),this._proxies.push(a),this._objectToProxy.set(e,a)}_getProxy(e){const s=this._objectToProxy.get(e);if(s)return s;throw new Error("No PointerTargetProxy for object")}removeObject(e){const s=this._objectToProxy.get(e);if(s){const r=this._proxies.indexOf(s);r>-1&&this._proxies.splice(r,1),this._proxyPool.return(s)}}_objectCurrentlyUnderPointer(e,s){return!!(this._currentFrameObjectToPointers.has(e)&&this._currentFrameObjectToPointers.get(e).includes(s))}_objectWasUnderPointer(e,s){return!!(this._lastFrameObjectToPointers.has(e)&&this._lastFrameObjectToPointers.get(e).includes(s))}_entered(e,s){return this._objectCurrentlyUnderPointer(e,s)&&!this._lastFrameObjectToPointers.has(e)}_left(e,s){return!this._currentFrameObjectToPointers.has(e)&&this._objectWasUnderPointer(e,s)}addPointerToObject(e,s){const r=this._objectToProxy.get(e);r&&this._addPointerToProxy(r,s)}_addPointerToProxy(e,s){if(!this._currentFrameObjectToPointers.has(e)){this._currentFrameObjectToPointers.set(e,[s]);return}const r=this._currentFrameObjectToPointers.get(e);this._currentFrameObjectToPointers.set(e,r.concat(s))}dispatchEvents(e,s){const r=new Set(this._lastFrameObjectToPointers.keys()),a=new Set(this._currentFrameObjectToPointers.keys());let l,_,p;for(let m=0;m<s.length;m++){const w=s[m],y=this._getProxy(w);if(xd(w)&&w._dispatchPointerEvents(e),r.has(y)||a.has(y)){p=this._processDownAndEmit(e,y),_=this._processUpAndEmit(e,y),l=this._processMoveAndEmit(e,y);const A=[...l.values(),...p.values(),..._.values()];this._processEnterLeaveAndEmit(e,y,A),this._processCancelAndEmit(e,y),this._processWheelAndEmit(e,y)}}}processPointerToObject(e,s){for(let r=0;r<s.length;r++){const a=s[r],l=this._getProxy(a);xd(a)&&a._processPointerToObject(e);for(const[_,p]of e.currentFramePointerCoords.entries())l.contains(p)&&this._addPointerToProxy(l,_)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(e,s){const r=new Map;for(const a of e.currentFrameDown)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerdown",a),e.isDragStart(a.pointerId)&&s.events.emit("pointerdragstart",a)),r.set(a.pointerId,a);return r}_processUpAndEmit(e,s){const r=new Map;for(const a of e.currentFrameUp)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerup",a),e.isDragEnd(a.pointerId)&&s.events.emit("pointerdragend",a)),r.set(a.pointerId,a);return r}_processMoveAndEmit(e,s){const r=new Map;for(const a of e.currentFrameMove)a.active&&s.active()&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointermove",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragmove",a)),r.set(a.pointerId,a);return r}_processEnterLeaveAndEmit(e,s,r){for(const a of r){if(a.active&&s.active()&&this._entered(s,a.pointerId)){s.events.emit("pointerenter",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragenter",a);break}if(a.active&&s.active()&&(this._left(s,a.pointerId)||this._objectCurrentlyUnderPointer(s,a.pointerId)&&a.type==="up")){s.events.emit("pointerleave",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragleave",a);break}}}_processCancelAndEmit(e,s){for(const r of e.currentFrameCancel)r.active&&s.active()&&this._objectCurrentlyUnderPointer(s,r.pointerId)&&s.events.emit("pointercancel",r)}_processWheelAndEmit(e,s){for(const r of e.currentFrameWheel)r.active&&s.active()&&this._objectCurrentlyUnderPointer(s,0)&&s.events.emit("pointerwheel",r)}}const Hp={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class bd extends ke{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let e=0;e<this.tiles.length;e++)this.tiles[e]&&this.tiles[e].flagDirty()}get x(){var e;return(e=this.transform.pos.x)!==null&&e!==void 0?e:0}set x(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.get(et).pos=z(e,this.y))}get y(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.pos.y)!==null&&s!==void 0?s:0}set y(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.transform.pos=z(this.x,e))}get z(){var e;return(e=this.transform.z)!==null&&e!==void 0?e:0}set z(e){this.transform&&(this.transform.z=e)}get rotation(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.rotation)!==null&&s!==void 0?s:0}set rotation(e){this.transform&&(this.transform.rotation=e)}get scale(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.scale)!==null&&s!==void 0?s:B.One}set scale(e){var s;!((s=this.transform)===null||s===void 0)&&s.scale&&(this.transform.scale=e)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get vel(){return this._motion.vel}set vel(e){this._motion.vel=e}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,r,a;super([],e.name),this.events=new I,this._token=0,this.logger=ot.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(s=e.meshingLookBehind)!==null&&s!==void 0?s:this.meshingLookBehind,this.addComponent(new et),this.addComponent(new Rt),this.addComponent(new At({type:dt.Fixed})),this.addComponent(new Jt({onPostDraw:(_,p)=>this.draw(_,p)})),this.addComponent(new go((_,p)=>this.debug(_,p),!1)),this.addComponent(new de),this.addComponent(new As),this.pointer=this.get(As),this._graphics=this.get(Jt),this.transform=this.get(et),this._motion=this.get(Rt),this.collider=this.get(de),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(r=e.pos)!==null&&r!==void 0?r:B.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(a=e.renderFromTopOfGraphic)!==null&&a!==void 0?a:this.renderFromTopOfGraphic,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight,this.rows=e.rows,this.columns=e.columns,this._pointerEventDispatcher=new ph,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let l=[];for(let _=0;_<this.columns;_++){for(let p=0;p<this.rows;p++){const m=new yd({x:_,y:p,map:this});m.map=this,this.tiles[_+p*this.columns]=m,this._pointerEventDispatcher.addObject(m,w=>m.bounds.contains(w.worldPos),()=>!0),l.push(m),this._rows[p]||(this._rows[p]=[]),this._rows[p].push(m)}this._cols[_]=l,l=[]}this._graphics.localBounds=new at({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(e){super._initialize(e),this._engine=e}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:B.Zero;{const r=e.offset;return this._originalOffsets.set(e,r),r}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const e=[];this._composite=this.collider.useCompositeCollider([]);let s=null;const r=(l,_)=>l&&_?l.top===_.top&&l.bottom===_.bottom&&l.right===_.left:!1,a=(l,_,p=this.meshingLookBehind)=>{if(!l)return!1;for(let m=_.length-1;m>=0;m--){if(p--<0)return!1;const w=_[m];if(r(w,l))return _[m]=w.combine(l),!0}return!1};for(let l=0;l<this.columns;l++){for(let _=0;_<this.rows;_++){const p=this.tiles[l+_*this.columns];if(p.solid)if(p.getColliders().length>0){for(const m of p.getColliders()){const w=this._getOrSetColliderOriginalOffset(m);m.offset=z(p.x*this.tileWidth*this.scale.x,p.y*this.tileHeight*this.scale.y).add(w),m.owner=this,this._composite.addCollider(m)}s&&!a(s,e)&&e.push(s),s=null}else s?s=s.combine(p.defaultGeometry):s=p.defaultGeometry;else s&&!a(s,e)&&e.push(s),s=null}s&&!a(s,e)&&e.push(s),s=null}for(const l of e){const _=Ue.Box(l.width,l.height,B.Zero,z(l.left-this.pos.x,l.top-this.pos.y));_.owner=this,this._composite.addCollider(_)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(e){var s;return(s=this.tiles[e])!==null&&s!==void 0?s:null}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const{x:s,y:r}=this._getTileCoordinates(e),a=this.getTile(s,r);return s>=0&&r>=0&&s<this.columns&&r<this.rows&&a?a:null}_getTileCoordinates(e){e=this.transform.applyInverse(e);const s=Math.floor(e.x/this.tileWidth),r=Math.floor(e.y/this.tileHeight);return{x:s,y:r}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let e=this._engine.screen.getWorldBounds();const s=this.get(po);if(s&&this.isInitialized){let D=this.pos;const L=B.One.sub(s.parallaxFactor),O=this._engine.currentScene.camera.pos.scale(L);D=D.sub(O),e=e.translate(D)}const r=this.transform.coordPlane===Pe.Screen?this._engine.screen.getScreenBounds():e,a=this._getTileCoordinates(r.topLeft),l=this._getTileCoordinates(r.topRight),_=this._getTileCoordinates(r.bottomRight),p=this._getTileCoordinates(r.bottomLeft),m=Math.min(j(a.x,0,this.columns-1),j(l.x,0,this.columns-1)),w=Math.min(j(a.y,0,this.rows-1),j(l.y,0,this.rows-1)),y=Math.max(j(_.x,0,this.columns-1),j(p.x,0,this.columns-1)),A=Math.max(j(_.y,0,this.rows-1),j(p.y,0,this.rows-1)),E=[];for(let D=m;D<=y;D++)for(let L=w;L<=A;L++)E.push(this.getTile(D,L));return E}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(e,s){this._initialize(e),this.onPreUpdate(e,s),this.emit("preupdate",new xs(e,s,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(e,s),this.emit("postupdate",new bs(e,s,this))}draw(e,s){if(!this.isInitialized)return;this.emit("predraw",new vn(e,s,this));let r,a,l;const _=this.getOnScreenTiles();for(let p=0;p<_.length;p++){const m=_[p],w=m.getGraphicsOffsets();for(r=m.getGraphics(),a=0,l=r.length;a<l;a++){const y=r[a],A=w[a];if(y){Ta(y)&&y?.tick(s,this._token);const E=this.renderFromTopOfGraphic?0:y.height-this.tileHeight;y.draw(e,m.x*this.tileWidth+A.x,m.y*this.tileHeight-E+A.y)}}}this.emit("postdraw",new wn(e,s,this))}debug(e,s){const{showAll:r,showGrid:a,gridColor:l,gridWidth:_,showSolidBounds:p,solidBoundsColor:m,showColliderGeometry:w}=s.tilemap,{geometryColor:y,geometryLineWidth:A,geometryPointSize:E}=s.collider,D=this.tileWidth*this.columns*this.scale.x,L=this.tileHeight*this.rows*this.scale.y,O=this.pos;if(a||r){for(let X=0;X<this.rows+1;X++){const H=z(0,X*this.tileHeight*this.scale.y);e.drawLine(O.add(H),O.add(z(D,H.y)),l,_)}for(let X=0;X<this.columns+1;X++){const H=z(X*this.tileWidth*this.scale.x,0);e.drawLine(O.add(H),O.add(z(H.x,L)),l,_)}}if(r||p||w){const X=this._composite.getColliders();e.save(),e.translate(this.pos.x,this.pos.y),e.scale(this.scale.x,this.scale.y);for(const H of X){const N=H.localBounds,Q=H.worldPos.sub(this.pos);p&&e.drawRectangle(Q,N.width,N.height,m)}if(e.restore(),w)for(const H of X)H.debug(e,y,{lineWidth:A,pointSize:E})}if(r||p){if(e.save(),e.z=999,p)for(let X=0;X<this.tiles.length;X++)this.tiles[X].bounds.draw(e);e.restore()}}}class yd{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(e){var s;(s=this.map)===null||s===void 0||s.flagCollidersDirty(),this._solid=e}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(e,s){this._graphics.push(e),s?.offset?this._offsets.push(s.offset):this._offsets.push(B.Zero)}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&(this._graphics.splice(s,1),this._offsets.splice(s,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(e){var s,r;this._posDirty=!1,this.events=new I,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=e.x,this.y=e.y,this.map=e.map,this._width=e.map.tileWidth*this.map.scale.x,this._height=e.map.tileHeight*this.map.scale.y,this.solid=(s=e.solid)!==null&&s!==void 0?s:this.solid,this._graphics=(r=e.graphics)!==null&&r!==void 0?r:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const e=this.map.pos.add(z(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new at(e.x,e.y,e.x+this.map.tileWidth,e.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(z(this.x*this._width,this.y*this._height)),this._bounds=new at(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new B(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}class Ad{constructor(e){this.camera=e}lockToActor(e){this.camera.addStrategy(new Cd(e))}lockToActorAxis(e,s){this.camera.addStrategy(new Td(e,s))}elasticToActor(e,s,r){this.camera.addStrategy(new Pd(e,s,r))}radiusAroundActor(e,s){this.camera.addStrategy(new Sd(e,s))}limitCameraBounds(e){this.camera.addStrategy(new Ed(e))}}var mo;(function(u){u[u.X=0]="X",u[u.Y=1]="Y"})(mo||(mo={}));class Cd{constructor(e){this.target=e,this.action=(s,r,a,l)=>s.center}}class Td{constructor(e,s){this.target=e,this.axis=s,this.action=(r,a,l,_)=>{const p=r.center,m=a.getFocus();return this.axis===mo.X?new B(p.x,m.y):new B(m.x,p.y)}}}class Pd{constructor(e,s,r){this.target=e,this.cameraElasticity=s,this.cameraFriction=r,this.action=(a,l,_,p)=>{const m=a.center;let w=l.getFocus(),y=l.vel.clone();const A=m.sub(w).scale(this.cameraElasticity);y=y.add(A);const E=y.scale(-1).scale(this.cameraFriction);return y=y.add(E),w=w.add(y),w}}}class Sd{constructor(e,s){this.target=e,this.radius=s,this.action=(r,a,l,_)=>{const p=r.center,m=a.getFocus(),w=p.sub(m),y=w.magnitude;if(y>=this.radius){const A=y-this.radius;return m.add(w.normalize().scale(A))}return m}}}class Ed{constructor(e){this.target=e,this.boundSizeChecked=!1,this.action=(s,r,a,l)=>{const _=r.getFocus();this.boundSizeChecked||((s.bottom-s.top<a.drawHeight||s.right-s.left<a.drawWidth)&&ot.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let p=_.x,m=_.y;return _.x<s.left+a.halfDrawWidth?p=s.left+a.halfDrawWidth:_.x>s.right-a.halfDrawWidth&&(p=s.right-a.halfDrawWidth),_.y<s.top+a.halfDrawHeight?m=s.top+a.halfDrawHeight:_.y>s.bottom-a.halfDrawHeight&&(m=s.bottom-a.halfDrawHeight),z(p,m)}}}const Op={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class Id{constructor(){this.events=new I,this.transform=he.identity(),this.inverse=he.identity(),this._cameraStrategies=[],this.strategy=new Ad(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new ws(B.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=B.Zero,this.acc=B.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Ot.EaseInOutCubic,this._easing=Ot.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=z(0,0)}get zoom(){return this._z}set zoom(e){this._z=e,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(e){this._angularVelocity=e}get pos(){return this._pos}set pos(e){this._posChanged=!0,this._pos=new ws(e,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(e){!this._follow&&!this._cameraMoving&&(this.pos=z(e,this.pos.y))}get y(){return this.pos.y}set y(e){!this._follow&&!this._cameraMoving&&(this.pos=z(this.pos.x,e))}get dx(){return this.vel.x}set dx(e){this.vel=z(e,this.vel.y)}get dy(){return this.vel.y}set dy(e){this.vel=z(this.vel.x,e)}get ax(){return this.acc.x}set ax(e){this.acc=z(e,this.acc.y)}get ay(){return this.acc.y}set ay(e){this.acc=z(this.acc.x,e)}getFocus(){return this.pos}move(e,s,r=Ot.EaseInOutCubic){if(typeof r!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(e):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(e),this._lerpPromise=new Promise(a=>{this._lerpResolve=a}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=s,this._lerpEnd=e,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=r,this._lerpPromise)}shake(e,s,r){this._isShaking=!0,this._shakeMagnitudeX=e,this._shakeMagnitudeY=s,this._shakeDuration=r}zoomOverTime(e,s=0,r=Ot.EaseInOutCubic){if(this._zoomPromise=new Promise(a=>{this._zoomResolve=a}),s)this._isZooming=!0,this._zoomEasing=r,this._currentZoomTime=0,this._zoomDuration=s,this._zoomStart=this.zoom,this._zoomEnd=e;else return this._isZooming=!1,this.zoom=e,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new at(0,0,0,0)}addStrategy(e){this._cameraStrategies.push(e)}removeStrategy(e){$i(e,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(e,s){this.events.emit("preupdate",new xs(e,s,this)),this.onPreUpdate(e,s)}onPreUpdate(e,s){}_postupdate(e,s){this.events.emit("postupdate",new bs(e,s,this)),this.onPostUpdate(e,s)}onPostUpdate(e,s){}get isInitialized(){return this._isInitialized}_initialize(e){if(!this.isInitialized){this._engine=e,this._screen=e.screen;const s=this._screen.contentArea;let r=z(s.width/2,s.height/2);if(!this._engine.loadingComplete){const a=this._screen.peekResolution();a&&(r=z(a.width/2,a.height/2))}this._halfWidth=r.x,this._halfHeight=r.y,this._posChanged||(this.pos=r),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(e,e.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(e),this.events.emit("initialize",new xn(e,this)),this._isInitialized=!0}}onInitialize(e){}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}runStrategies(e,s){for(const r of this._cameraStrategies)this.pos=r.action.call(r,r.target,this,e,s)}updateViewport(){this._viewport=new at(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(e,s){if(this._initialize(e),this._preupdate(e,s),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(s/1e3)),this.zoom+=this.dz*s/1e3,this.vel=this.vel.add(this.acc.scale(s/1e3)),this.dz+=this.az*s/1e3,this.rotation+=this.angularVelocity*s/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const r=this._zoomEasing,a=r(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=a,this._currentZoomTime+=s}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const a=Ot.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=a,this._currentLerpTime+=s}else{this.pos=this._lerpEnd;const r=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(r)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=s,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(e,s),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(e,s),this._posChanged=!1}draw(e){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const s=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,r=this.pos.scale(s).add(this._oldPos.scale(1-s));r.clone(this.drawPos),this.updateTransform(r)}if(e.snapToPixel){const s=this.drawPos.clone(this._snapPos);s.x=~~(s.x+ft*V(s.x)),s.y=~~(s.y+ft*V(s.y)),s.clone(this.drawPos),this.updateTransform(s)}e.multiply(this.transform)}updateTransform(e){const s=this._screen.resolution.width/this.zoom,r=this._screen.resolution.height/this.zoom,a=z(-e.x+s/2+this._xShake,-e.y+r/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(s/2,r/2),this.transform.rotate(this.rotation),this.transform.translate(-s/2,-r/2),this.transform.translate(a.x,a.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const Wp={ExitTrigger:"exit",EnterTrigger:"enter"};class Rd extends qe{constructor(e){var s,r,a,l;super({...e}),this.events=new I,this.filter=(s=e.filter)!==null&&s!==void 0?s:()=>!0,this.repeat=(r=e.repeat)!==null&&r!==void 0?r:-1,this.action=(a=e.action)!==null&&a!==void 0?a:()=>{},this.target=e.target,this.graphics.isVisible=(l=e.visible)!==null&&l!==void 0?l:!1,this.body.collisionType=dt.Passive,this.events.on("collisionstart",({other:_})=>{this._matchesTarget(_.owner)&&(this.events.emit("enter",new Xa(this,_.owner)),this._dispatchAction(_.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:_})=>{this._matchesTarget(_.owner)&&this.events.emit("exit",new Ya(this,_.owner))})}_matchesTarget(e){return this.filter(e)&&(this.target===void 0||this.target===e)}_dispatchAction(e){this.repeat!==0&&(this.action.call(this,e),this.repeat--)}}const Li={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var ni;(function(u){u.Update="update",u.Draw="draw"})(ni||(ni={}));class hi{}hi.priority=Li.Average;class Dd{constructor(e){this._world=e,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>s=>{this.addEntity(s)},this._createChildRemovedHandler=()=>s=>{this.removeEntity(s,!1)},this._entitiesToRemove=[]}updateEntities(e,s){for(let r=0;r<this.entities.length;r++){const a=this.entities[r];a.update(e.engine,s),a.isActive||this.removeEntity(a)}}findEntitiesForRemoval(){for(let e=0;e<this.entities.length;e++){const s=this.entities[e];s.isActive||this.removeEntity(s)}}addEntity(e){if(e.isActive=!0,e.scene=this._world.scene,e&&!this._entityIndex[e.id]){this._entityIndex[e.id]=e,this.entities.push(e),this._world.queryManager.addEntity(e),e.children.forEach(a=>{a.scene=e.scene,this.addEntity(a)});const s=this._createChildAddedHandler();this._childAddedHandlerMap.set(e,s);const r=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(e,r),e.childrenAdded$.subscribe(s),e.childrenRemoved$.subscribe(r)}}removeEntity(e,s=!0){var r,a;let l=0;e instanceof ke?l=e.id:l=e;const _=this._entityIndex[l];if(_&&_.isActive&&(_.isActive=!1),_&&s){this._entitiesToRemove.push(_);return}if(delete this._entityIndex[l],_){_.scene=null,$i(_,this.entities),this._world.queryManager.removeEntity(_),_.children.forEach(w=>{w.scene=null,this.removeEntity(w,s)});const p=this._childAddedHandlerMap.get(_);p&&_.childrenAdded$.unsubscribe(p);const m=this._childRemovedHandlerMap.get(_);m&&_.childrenRemoved$.unsubscribe(m),!((a=(r=this._world)===null||r===void 0?void 0:r.scene)===null||a===void 0)&&a.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let e=0;e<this._entitiesToRemove.length;e++){const s=this._entitiesToRemove[e];s.isActive||this.removeEntity(s,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let e=0;e<this.entities.length;e++)this.entities[e].processComponentRemoval()}getById(e){return this._entityIndex[e]}getByName(e){return this.entities.filter(s=>s.name===e)}clear(){for(let e=this.entities.length-1;e>=0;e--)this.removeEntity(this.entities[e])}}class hr{constructor(e){if(this.requiredComponents=e,this.components=new Set,this.entities=[],this.entityAdded$=new Ne,this.entityRemoved$=new Ne,e.length===0)throw new Error("Cannot create query without components");for(const s of e)this.components.add(s);this.id=hr.createId(e)}static createId(e){return e.slice().map(s=>s.name).sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAll(Array.from(this.components))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class lr{constructor(e){if(this.requiredTags=e,this.tags=new Set,this.entities=[],this.entityAdded$=new Ne,this.entityRemoved$=new Ne,e.length===0)throw new Error("Cannot create tag query without tags");for(const s of e)this.tags.add(s);this.id=lr.createId(e)}static createId(e){return e.slice().sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAllTags(Array.from(this.tags))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class Md{constructor(e){this._world=e,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=s=>r=>{this.addComponent(s,r)},this._createRemoveComponentHandler=s=>r=>{this.removeComponent(s,r)},this._createAddTagHandler=s=>r=>{this.addTag(s,r)},this._createRemoveTagHandler=s=>r=>{this.removeTag(s,r)}}createQuery(e){const s=hr.createId(e);if(this._queries.has(s))return this._queries.get(s);const r=new hr(e);this._queries.set(r.id,r);for(const a of e){const l=this._componentToQueriesIndex.get(a);l?l.push(r):this._componentToQueriesIndex.set(a,[r])}for(const a of this._world.entities)this.addEntity(a);return r}createTagQuery(e){const s=lr.createId(e);if(this._tagQueries.has(s))return this._tagQueries.get(s);const r=new lr(e);this._tagQueries.set(r.id,r);for(const a of e){const l=this._tagToQueriesIndex.get(a);l?l.push(r):this._tagToQueriesIndex.set(a,[r])}for(const a of this._world.entities)this.addEntity(a);return r}addEntity(e){const s=this._addComponentHandlers.get(e),r=this._removeComponentHandlers.get(e),a=s??this._createAddComponentHandler(e),l=r??this._createRemoveComponentHandler(e);this._addComponentHandlers.set(e,a),this._removeComponentHandlers.set(e,l);const _=this._addTagHandlers.get(e),p=this._removeTagHandlers.get(e),m=_??this._createAddTagHandler(e),w=p??this._createRemoveTagHandler(e);this._addTagHandlers.set(e,m),this._removeTagHandlers.set(e,w);for(const y of this._queries.values())y.checkAndAdd(e);for(const y of this._tagQueries.values())y.checkAndAdd(e);e.componentAdded$.subscribe(a),e.componentRemoved$.subscribe(l),e.tagAdded$.subscribe(m),e.tagRemoved$.subscribe(w)}removeEntity(e){const s=this._addComponentHandlers.get(e),r=this._removeComponentHandlers.get(e);for(const _ of this._queries.values())_.removeEntity(e);s&&e.componentAdded$.unsubscribe(s),r&&e.componentRemoved$.unsubscribe(r);const a=this._addTagHandlers.get(e),l=this._removeTagHandlers.get(e);for(const _ of this._tagQueries.values())_.removeEntity(e);a&&e.tagAdded$.unsubscribe(a),l&&e.tagRemoved$.unsubscribe(l)}addComponent(e,s){var r;const a=(r=this._componentToQueriesIndex.get(s.constructor))!==null&&r!==void 0?r:[];for(const l of a)l.checkAndAdd(e)}removeComponent(e,s){var r;const a=(r=this._componentToQueriesIndex.get(s.constructor))!==null&&r!==void 0?r:[];for(const l of a)l.removeEntity(e)}addTag(e,s){var r;const a=(r=this._tagToQueriesIndex.get(s))!==null&&r!==void 0?r:[];for(const l of a)l.checkAndAdd(e)}removeTag(e,s){var r;const a=(r=this._tagToQueriesIndex.get(s))!==null&&r!==void 0?r:[];for(const l of a)l.removeEntity(e)}}function Fd(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class Bd{constructor(e){this._world=e,this.systems=[],this.initialized=!1}get(e){return this.systems.find(s=>s instanceof e)}addSystem(e){let s;e instanceof hi?s=e:s=new e(this._world),this.systems.push(s),this.systems.sort((r,a)=>r.constructor.priority-a.constructor.priority),this.initialized&&s.initialize&&s.initialize(this._world,this._world.scene)}removeSystem(e){$i(e,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const e of this.systems)e.initialize&&e.initialize(this._world,this._world.scene)}}updateSystems(e,s,r){const a=this.systems.filter(l=>l.systemType===e);for(const l of a)l.preupdate&&l.preupdate(s,r);for(const l of a)l.update(r);for(const l of a)l.postupdate&&l.postupdate(s,r)}clear(){for(let e=this.systems.length-1;e>=0;e--)this.removeSystem(this.systems[e])}}class kd{constructor(e){this.scene=e,this._logger=ot.getInstance(),this.queryManager=new Md(this),this.entityManager=new Dd(this),this.systemManager=new Bd(this)}query(e){return this.queryManager.createQuery(e)}queryTags(e){return this.queryManager.createTagQuery(e)}update(e,s){e===ni.Update&&this.entityManager.updateEntities(this.scene,s),this.systemManager.updateSystems(e,this.scene,s),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(e){if(e instanceof ke){this.entityManager.addEntity(e);return}if(e instanceof hi||Fd(e)){this.systemManager.addSystem(e);return}this._logger.warn(`Could not add entity/system ${e.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(e){return this.systemManager.get(e)}remove(e,s=!0){if(e instanceof ke){this.entityManager.removeEntity(e,s);return}if(e instanceof hi){this.systemManager.removeSystem(e);return}this._logger.warn(`Could not remove entity/system ${e.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class vo extends hi{constructor(e,s){super(),this.world=e,this.physics=s,this.systemType=ni.Update,this._physicsConfigDirty=!1,s.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([et,Rt])}update(e){let s,r;const a=this.query.entities,l=this.physics.config.substep;for(let _=0;_<a.length;_++){s=a[_].get(et),r=a[_].get(Rt);const p=a[_].get(At);if(this._physicsConfigDirty&&p&&p.updatePhysicsConfig(this.physics.config.bodies),p?.isSleeping)continue;const m=r.acc.clone();p?.collisionType===dt.Active&&p?.useGravity&&m.addEqual(this.physics.config.gravity),a[_].parent||this.captureOldTransformWithChildren(a[_]),Ge.integrate(s,r,m,e/l)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(e){var s;(s=e.get(At))===null||s===void 0||s.captureOldTransform();for(let r=0;r<e.children.length;r++)this.captureOldTransformWithChildren(e.children[r])}}vo.priority=Li.Higher;class gh{constructor(e){this.config=e,this.directionMap=new Map,this.distanceMap=new Map}solve(e){this.preSolve(e),e=e.filter(r=>!r.isCanceled());let s;switch(this.config.contactSolveBias){case es.HorizontalFirst:{s=oh;break}case es.VerticalFirst:{s=rh;break}default:s=ah}e.sort((r,a)=>{const l=this.directionMap.get(r.id),_=this.directionMap.get(a.id),p=this.distanceMap.get(r.id),m=this.distanceMap.get(a.id);return s[l]-s[_]||p-m});for(const r of e)this.solvePosition(r),this.solveVelocity(r);return this.postSolve(e),e}preSolve(e){for(let r=0;r<e.length;r++){const a=e[r];if(Math.abs(a.mtv.x)<1e-4&&Math.abs(a.mtv.y)<1e-4){a.cancel();continue}const l=Pt.fromDirection(a.mtv),_=a.mtv.negate(),p=Math.abs(a.info.separation);this.distanceMap.set(a.id,p),this.directionMap.set(a.id,l===Pt.Left||l===Pt.Right?"horizontal":"vertical"),a.colliderA.events.emit("precollision",new Os(a.colliderA,a.colliderB,l,_,a)),a.colliderB.events.emit("precollision",new Os(a.colliderB,a.colliderA,Pt.getOpposite(l),_.negate(),a))}}postSolve(e){var s,r;for(let a=0;a<e.length;a++){const l=e[a];if(l.isCanceled())continue;const _=l.colliderA,p=l.colliderB,m=(s=_.owner)===null||s===void 0?void 0:s.get(At),w=(r=p.owner)===null||r===void 0?void 0:r.get(At);if(m&&w&&(m.collisionType===dt.Passive||w.collisionType===dt.Passive))continue;const y=Pt.fromDirection(l.mtv),A=l.mtv.negate();l.colliderA.events.emit("postcollision",new Ws(l.colliderA,l.colliderB,y,A,l)),l.colliderB.events.emit("postcollision",new Ws(l.colliderB,l.colliderA,Pt.getOpposite(y),A.negate(),l))}}solvePosition(e){var s,r;if(!e.colliderA.bounds.overlaps(e.colliderB.bounds,1e-4)){e.cancel();return}if(Math.abs(e.mtv.x)<1e-4&&Math.abs(e.mtv.y)<1e-4){e.cancel();return}let l=e.mtv;const _=e.colliderA,p=e.colliderB,m=(s=_.owner)===null||s===void 0?void 0:s.get(At),w=(r=p.owner)===null||r===void 0?void 0:r.get(At);if(m&&w){if(m.collisionType===dt.Passive||w.collisionType===dt.Passive)return;m.collisionType===dt.Active&&w.collisionType===dt.Active&&(l=l.scale(.5)),m.collisionType===dt.Active&&(m.globalPos.x-=l.x,m.globalPos.y-=l.y,_.update(m.transform.get())),w.collisionType===dt.Active&&(w.globalPos.x+=l.x,w.globalPos.y+=l.y,p.update(w.transform.get()))}}solveVelocity(e){var s,r;if(e.isCanceled())return;const a=e.colliderA,l=e.colliderB,_=(s=a.owner)===null||s===void 0?void 0:s.get(At),p=(r=l.owner)===null||r===void 0?void 0:r.get(At);if(_&&p){if(_.collisionType===dt.Passive||p.collisionType===dt.Passive)return;const m=e.normal,w=m.negate();if(_.collisionType===dt.Active&&_.vel.normalize().dot(w)<0){const y=m.scale(m.dot(_.vel.negate()));_.vel=_.vel.add(y)}if(p.collisionType===dt.Active&&p.vel.normalize().dot(m)<0){const y=w.scale(w.dot(p.vel.negate()));p.vel=p.vel.add(y)}}}}class Ld{constructor(e,s,r){this.point=e,this.local=s,this.contact=r,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new B(0,0),this.bToContact=new B(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const e=this.contact.bodyA,s=this.contact.colliderA,r=this.contact.bodyB,a=this.contact.colliderB;if(e&&r){const l=this.contact.normal,_=this.contact.tangent;this.aToContact=this.point.sub(s.center),this.bToContact=this.point.sub(a.center);const p=this.aToContact.cross(l),m=this.bToContact.cross(l);this.normalMass=e.inverseMass+r.inverseMass+e.inverseInertia*p*p+r.inverseInertia*m*m;const w=this.aToContact.cross(_),y=this.bToContact.cross(_);this.tangentMass=e.inverseMass+r.inverseMass+e.inverseInertia*w*w+r.inverseInertia*y*y}return this}getRelativeVelocity(){const e=this.contact.bodyA,s=this.contact.bodyB;if(e&&s){const r=e.vel.add(B.cross(e.angularVelocity,this.aToContact));return s.vel.add(B.cross(s.angularVelocity,this.bToContact)).sub(r)}return B.Zero}}class mh{constructor(e){this.config=e,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(e){var s;return(s=this.idToContactConstraint.get(e))!==null&&s!==void 0?s:[]}solve(e){this.preSolve(e),e=e.filter(r=>!r.isCanceled());let s;switch(this.config.contactSolveBias){case es.HorizontalFirst:{s=oh;break}case es.VerticalFirst:{s=rh;break}default:s=ah}return e.sort((r,a)=>{const l=this.directionMap.get(r.id),_=this.directionMap.get(a.id),p=this.distanceMap.get(r.id),m=this.distanceMap.get(a.id);return s[l]-s[_]||p-m}),this.solveVelocity(e),this.solvePosition(e),this.postSolve(e),e}preSolve(e){var s,r,a,l;for(let m=0;m<e.length;m++){const w=e[m];if(Math.abs(w.mtv.x)<1e-4&&Math.abs(w.mtv.y)<1e-4){w.cancel();continue}const y=Pt.fromDirection(w.mtv),A=Math.abs(((s=w?.info)===null||s===void 0?void 0:s.separation)||0);this.distanceMap.set(w.id,A),this.directionMap.set(w.id,y===Pt.Left||y===Pt.Right?"horizontal":"vertical"),w.colliderA.events.emit("precollision",new Os(w.colliderA,w.colliderB,y,w.mtv,w)),w.colliderA.events.emit("beforecollisionresolve",new oo(w.colliderA,w.colliderB,y,w.mtv,w)),w.colliderB.events.emit("precollision",new Os(w.colliderB,w.colliderA,Pt.getOpposite(y),w.mtv.negate(),w)),w.colliderB.events.emit("beforecollisionresolve",new oo(w.colliderB,w.colliderA,Pt.getOpposite(y),w.mtv.negate(),w)),w.matchAwake()}const p=Array.from(this.idToContactConstraint.keys());for(let m=0;m<e.length;m++){const w=e[m],y=p.indexOf(w.id);y>-1&&p.splice(y,1);const A=(r=this.idToContactConstraint.get(w.id))!==null&&r!==void 0?r:[];let E=0;const D=w.bodyA,L=w.colliderA,O=w.bodyB,X=w.colliderB;if(D&&O)for(let H=0;H<w.points.length;H++){const N=w.points[H],Q=w.normal,Y=w.tangent,J=N.sub(L.center),rt=N.sub(X.center),Z=J.cross(Q),_t=rt.cross(Q),Tt=D.inverseMass+O.inverseMass+D.inverseInertia*Z*Z+O.inverseInertia*_t*_t,Gt=J.cross(Y),Xt=rt.cross(Y),be=D.inverseMass+O.inverseMass+D.inverseInertia*Gt*Gt+O.inverseInertia*Xt*Xt;A[E]&&((l=(a=A[E])===null||a===void 0?void 0:a.point)===null||l===void 0?void 0:l.squareDistance(N))<4?(A[E].point=N,A[E].local=w.localPoints[E]):A[E]=new Ld(N,w.localPoints[E],w),A[E].aToContact=J,A[E].bToContact=rt,A[E].normalMass=1/Tt,A[E].tangentMass=1/be;const $t=D.bounciness>O.bounciness?D.bounciness:O.bounciness,kt=w.normal.dot(A[E].getRelativeVelocity());A[E].originalVelocityAndRestitution=0,kt<-.1&&(A[E].originalVelocityAndRestitution=-$t*kt),E++}this.idToContactConstraint.set(w.id,A)}for(const m of p)this.idToContactConstraint.delete(m);if(this.config.warmStart)this.warmStart(e);else for(let m=0;m<e.length;m++){const w=e[m],y=this.getContactConstraints(w.id);for(const A of y)A.normalImpulse=0,A.tangentImpulse=0}}postSolve(e){for(let s=0;s<e.length;s++){const r=e[s],a=r.bodyA,l=r.bodyB;if(a&&l){if(a.collisionType===dt.Passive||l.collisionType===dt.Passive)continue;a.updateMotion(),l.updateMotion()}const _=Pt.fromDirection(r.mtv);r.colliderA.events.emit("postcollision",new Ws(r.colliderA,r.colliderB,_,r.mtv,r)),r.colliderA.events.emit("aftercollisionresolve",new ao(r.colliderA,r.colliderB,_,r.mtv,r)),r.colliderB.events.emit("postcollision",new Ws(r.colliderB,r.colliderA,Pt.getOpposite(_),r.mtv.negate(),r)),r.colliderB.events.emit("aftercollisionresolve",new ao(r.colliderB,r.colliderA,Pt.getOpposite(_),r.mtv.negate(),r))}this.lastFrameContacts.clear();for(let s=0;s<e.length;s++){const r=e[s];this.lastFrameContacts.set(r.id,r)}}warmStart(e){var s;for(let r=0;r<e.length;r++){const a=e[r],l=a.bodyA,_=a.bodyB;if(l&&_){const p=(s=this.idToContactConstraint.get(a.id))!==null&&s!==void 0?s:[];for(const m of p)if(this.config.warmStart){const w=a.normal.scale(m.normalImpulse),y=a.tangent.scale(m.tangentImpulse),A=w.add(y);l.applyImpulse(m.point,A.negate()),_.applyImpulse(m.point,A)}else m.normalImpulse=0,m.tangentImpulse=0}}}solvePosition(e){var s;for(let r=0;r<this.config.positionIterations;r++)for(let a=0;a<e.length;a++){const l=e[a],_=l.bodyA,p=l.bodyB;if(_&&p){if(_.collisionType===dt.Passive||p.collisionType===dt.Passive)continue;const m=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const w of m){const y=l.normal,A=yi.FindContactSeparation(l,w.local),E=this.config.steeringFactor,D=-5,L=this.config.slop,O=j(E*(A+L),D,0),X=y.scale(-O*w.normalMass);if(_.collisionType===dt.Active){const H=X.negate().scale(_.inverseMass);_.limitDegreeOfFreedom.includes(Qe.X)&&(H.x=0),_.limitDegreeOfFreedom.includes(Qe.Y)&&(H.y=0),_.globalPos=_.globalPos.add(H),_.limitDegreeOfFreedom.includes(Qe.Rotation)||(_.rotation-=w.aToContact.cross(X)*_.inverseInertia)}if(p.collisionType===dt.Active){const H=X.scale(p.inverseMass);p.limitDegreeOfFreedom.includes(Qe.X)&&(H.x=0),p.limitDegreeOfFreedom.includes(Qe.Y)&&(H.y=0),p.globalPos=p.globalPos.add(H),p.limitDegreeOfFreedom.includes(Qe.Rotation)||(p.rotation+=w.bToContact.cross(X)*p.inverseInertia)}}}}}solveVelocity(e){var s;for(let r=0;r<this.config.velocityIterations;r++)for(let a=0;a<e.length;a++){const l=e[a],_=l.bodyA,p=l.bodyB;if(_&&p){if(_.collisionType===dt.Passive||p.collisionType===dt.Passive)continue;const m=Math.min(_.friction,p.friction),w=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const y of w){let D=-y.getRelativeVelocity().dot(l.tangent)*y.tangentMass;const L=m*y.normalImpulse,O=j(y.tangentImpulse+D,-L,L);D=O-y.tangentImpulse,y.tangentImpulse=O;const X=l.tangent.scale(D);_.applyImpulse(y.point,X.negate()),p.applyImpulse(y.point,X)}for(const y of w){const E=y.getRelativeVelocity().dot(l.normal);let D=-y.normalMass*(E-y.originalVelocityAndRestitution);const L=Math.max(y.normalImpulse+D,0);D=L-y.normalImpulse,y.normalImpulse=L;const O=l.normal.scale(D);_.applyImpulse(y.point,O.negate()),p.applyImpulse(y.point,O)}}}}}class wo extends hi{get _processor(){return this._physics.collisionProcessor}constructor(e,s){super(),this._physics=s,this.systemType=ni.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new gh(s.config.arcade),this._realisticSolver=new mh(s.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=r=>this._processor.track(r),this._untrackCollider=r=>this._processor.untrack(r),this.query=e.query([et,Rt,de]),this.query.entityAdded$.subscribe(r=>{const a=r.get(de);a.$colliderAdded.subscribe(this._trackCollider),a.$colliderRemoved.subscribe(this._untrackCollider);const l=a.get();l&&this._processor.track(l)}),this.query.entityRemoved$.subscribe(r=>{const a=r.get(de),l=a.get();a&&l&&this._processor.untrack(l)}),this._motionSystem=e.get(vo)}initialize(e,s){this._engine=s.engine}update(e){var s,r,a,l;if(!this._physics.config.enabled)return;let _=[];for(let A=0;A<this.query.entities.length;A++){const D=this.query.entities[A].get(de),L=D?.get();if(D&&(!((s=D.owner)===null||s===void 0)&&s.isActive)&&L)if(D.update(),L instanceof we){const O=L.getColliders();L.compositeStrategy||(L.compositeStrategy=this._physics.config.colliders.compositeStrategy),_=_.concat(O)}else _.push(L)}this._processor.update(_,e);let p=this._processor.broadphase(_,e);this._currentFrameContacts.clear();let m=[];const w=this.getSolver(),y=this._physics.config.substep;for(let A=0;A<y;A++)if(A>0&&this._motionSystem.update(e),m.length&&(p=m.map(E=>new Ve(E.colliderA,E.colliderB))),p.length){m=this._processor.narrowphase(p,(l=(a=(r=this._engine)===null||r===void 0?void 0:r.debug)===null||a===void 0?void 0:a.stats)===null||l===void 0?void 0:l.currFrame),m=w.solve(m);for(const E of m){if(E.isCanceled())continue;const D=E.id.indexOf("|");if(D>0){const L=E.id.substring(D+1);this._currentFrameContacts.set(L,E)}else this._currentFrameContacts.set(E.id,E)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const A of this.query.entities){const E=A.get(de);E&&E.processColliderRemoval()}}postupdate(){ce.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new gh(this._physics.config.arcade),this._realisticSolver=new mh(this._physics.config.realistic)),this._physics.config.solver===sr.Realistic?this._realisticSolver:this._arcadeSolver}debug(e){this._processor.debug(e,0)}runContactStartEnd(){for(const[e,s]of this._currentFrameContacts)if(!this._lastFrameContacts.has(e)){const r=s.colliderA,a=s.colliderB,l=Pt.fromDirection(s.mtv),_=Pt.getOpposite(l);r.events.emit("collisionstart",new Kn(r,a,l,s)),r.events.emit("contactstart",new no(r,a,l,s)),a.events.emit("collisionstart",new Kn(a,r,_,s)),a.events.emit("contactstart",new no(a,r,_,s))}for(const[e,s]of this._lastFrameContacts)if(!this._currentFrameContacts.has(e)){const r=s.colliderA,a=s.colliderB,l=Pt.fromDirection(s.mtv),_=Pt.getOpposite(l);r.events.emit("collisionend",new Jn(r,a,l,s)),r.events.emit("contactend",new ro(r,a,l,s)),a.events.emit("collisionend",new Jn(a,r,_,s)),a.events.emit("contactend",new ro(a,r,_,s))}}}wo.priority=Li.Higher;function Np(u,e,s,r){if(u.parent!==e.parent){const y=u.clone(),A=u.globalPos.clone(),E=u.globalScale.clone(),D=u.globalRotation;y.parent=e.parent,y.globalPos=A,y.globalScale=E,y.globalRotation=D,u=y}let a=e.pos,l=e.scale,_=e.rotation;a=e.pos.scale(s).add(u.pos.scale(1-s)),l=e.scale.scale(s).add(u.scale.scale(1-s));const p=(1-s)*Math.cos(u.rotation)+s*Math.cos(e.rotation),m=(1-s)*Math.sin(u.rotation)+s*Math.sin(e.rotation);_=Math.atan2(m,p);const w=r??new Ki;return w.setTransform(a,_,l),w}class vh extends hi{get sortedTransforms(){return this._sortedTransforms}constructor(e){super(),this.world=e,this.systemType=ni.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new Ki,this.query=this.world.query([et,Jt]),this.query.entityAdded$.subscribe(s=>{const r=s.get(et);this._sortedTransforms.push(r),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{const r=s.get(et);r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const a=this._sortedTransforms.indexOf(r);a>-1&&this._sortedTransforms.splice(a,1)})}initialize(e,s){this._camera=s.camera,this._engine=s.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>e.globalZ-s.globalZ),this._zHasChanged=!1)}update(e){this._token++;let s;Ft.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let r=0;r<this._sortedTransforms.length;r++){const a=this._sortedTransforms[r],l=a.owner;if(l.hasTag("ex.offscreen")||(s=l.get(Jt),!s.isVisible))continue;s.onPreTransformDraw&&s.onPreTransformDraw(this._graphicsContext,e),l.events.emit("pretransformdraw",new Ra(this._graphicsContext,e,l)),a.coordPlane===Pe.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),a.coordPlane===Pe.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),s.update(e,this._token);const _=l.get(po);if(_){const p=B.One.sub(_.parallaxFactor),m=this._camera.drawPos.scale(p);this._graphicsContext.translate(m.x,m.y)}this._applyTransform(l),s.material&&(this._graphicsContext.material=s.material),s.onPreDraw&&s.onPreDraw(this._graphicsContext,e),l.events.emit("predraw",new vn(this._graphicsContext,e,l)),this._applyOpacity(l),this._drawGraphicsComponent(s,a),s.onPostDraw&&s.onPostDraw(this._graphicsContext,e),l.events.emit("postdraw",new wn(this._graphicsContext,e,l)),this._graphicsContext.restore(),a.coordPlane===Pe.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),s.onPostTransformDraw&&s.onPostTransformDraw(this._graphicsContext,e),l.events.emit("posttransformdraw",new Da(this._graphicsContext,e,l))}this._graphicsContext.restore()}_drawGraphicsComponent(e,s){var r,a;if(e.isVisible){const l=e.flipHorizontal,_=e.flipVertical,p=e.current,m=(r=e.currentOptions)!==null&&r!==void 0?r:{};if(p){let w=e.anchor,y=e.offset,A=1,E=1;m?.anchor&&(w=m.anchor),m?.offset&&(y=m.offset);const D=s.globalScale;A*=p.scale.x*D.x,E*=p.scale.y*D.y;const L=-p.width*w.x+y.x*A,O=-p.height*w.y+y.y*E,X=p.flipHorizontal,H=p.flipVertical;if((l||_)&&(p.flipHorizontal=l?!X:X,p.flipVertical=_?!H:H),p?.draw(this._graphicsContext,L,O),(l||_)&&(p.flipHorizontal=X,p.flipVertical=H),!((a=this._engine)===null||a===void 0)&&a.isDebug&&this._engine.debug.graphics.showBounds){const N=z(L,O);if(p instanceof pn)for(const Q of p.members){let Y,J=B.Zero;Q instanceof Qt?Y=Q:(Y=Q.graphic,J=Q.offset),p.useAnchor?Y?.localBounds.translate(N.add(J)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):Y?.localBounds.translate(J).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else p?.localBounds.translate(N).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(e){const s=e.getAncestors();for(let r=0;r<s.length;r++){const a=s[r],l=a?.get(et),_=a?.get(At);if(l){let p=l.get();if(_&&this._engine.fixedUpdateTimestep&&_.__oldTransformCaptured&&_.enableFixedUpdateInterpolate){const m=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;p=Np(_.oldTransform,l.get(),m,this._targetInterpolationTransform)}this._graphicsContext.z=l.globalZ,this._graphicsContext.translate(p.pos.x,p.pos.y),this._graphicsContext.scale(p.scale.x,p.scale.y),this._graphicsContext.rotate(p.rotation)}}}_applyOpacity(e){var s;const r=e.getAncestors();for(let a=0;a<r.length;a++){const l=r[a],_=l?.get(Jt);this._graphicsContext.opacity*=(s=_?.opacity)!==null&&s!==void 0?s:1}}}vh.priority=Li.Average;class wh extends hi{constructor(e){super(),this.world=e,this.systemType=ni.Draw,this.query=this.world.query([et])}initialize(e,s){this._graphicsContext=s.engine.graphicsContext,this._camera=s.camera,this._engine=s.engine,this._collisionSystem=e.systemManager.get(wo)}update(){var e;if(!this._engine.isDebug)return;const s=this._engine.debug.filter;let r,a;const l=this._engine.debug.entity;let _;const p=this._engine.debug.transform;let m;const w=this._engine.debug.motion;let y;const A=this._engine.debug.collider,E=this._engine.debug.physics;let D;const L=this._engine.debug.graphics;let O,X;const H=this._engine.debug.body,N=this._engine.debug.camera;for(let Q=0;Q<this.query.entities.length;Q++){const Y=this.query.entities[Q];if(Y.hasTag("offscreen")||Y instanceof ho||s.useFilter&&(!(s.ids.length===0||s.ids.includes(Y.id))||!(s.nameQuery===""||Y.name.includes(s.nameQuery))))continue;let J=B.Zero;const rt=z(0,16);if(r=Y.id,a=Y.name,_=Y.get(et),this._pushCameraTransform(_),this._graphicsContext.save(),_.coordPlane===Pe.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=p.debugZIndex,this._applyTransform(Y),_&&((p.showAll||p.showPosition)&&this._graphicsContext.debug.drawPoint(B.Zero,{size:4,color:p.positionColor}),(p.showAll||p.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${_.pos.toString(2)}`,J),J=J.add(rt)),(p.showAll||p.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${_.z.toFixed(1)})`,J),J=J.add(rt)),(l.showAll||l.showId)&&(this._graphicsContext.debug.drawText(`id(${r}) ${Y.parent?"child of id("+((e=Y.parent)===null||e===void 0?void 0:e.id)+")":""}`,J),J=J.add(rt)),(l.showAll||l.showName)&&(this._graphicsContext.debug.drawText(`name(${a})`,J),J=J.add(rt)),(p.showAll||p.showRotation)&&(this._graphicsContext.drawLine(B.Zero,B.fromAngle(_.rotation).scale(50).add(B.Zero),p.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${ht(_.rotation).toFixed(2)})`,J),J=J.add(rt)),(p.showAll||p.showScale)&&this._graphicsContext.drawLine(B.Zero,_.scale.add(B.Zero),p.scaleColor,2)),D=Y.get(Jt),D&&(L.showAll||L.showBounds)&&D.localBounds.draw(this._graphicsContext,L.boundsColor),O=Y.get(go),O&&(O.useTransform||this._graphicsContext.restore(),O.draw(this._graphicsContext,this._engine.debug),O.useTransform||(this._graphicsContext.save(),this._applyTransform(Y))),X=Y.get(At),X&&((H.showAll||H.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${X.group.name})`,J),J=J.add(rt)),(H.showAll||H.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${X.collisionType})`,J),J=J.add(rt)),(H.showAll||H.showMass)&&(this._graphicsContext.debug.drawText(`mass(${X.mass})`,J),J=J.add(rt)),(H.showAll||H.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${X.sleepMotion})`,J),J=J.add(rt)),(H.showAll||H.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${X.canSleep?X.isSleeping:"cant sleep"})`,J),J=J.add(rt))),this._graphicsContext.restore(),this._graphicsContext.save(),_.coordPlane===Pe.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=p.debugZIndex,m=Y.get(Rt),m&&((w.showAll||w.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${m.vel.toString(2)}`,J.add(_.globalPos)),this._graphicsContext.drawLine(_.globalPos,_.globalPos.add(m.vel),w.velocityColor,2),J=J.add(rt)),(w.showAll||w.showAcceleration)&&this._graphicsContext.drawLine(_.globalPos,_.globalPos.add(m.acc),w.accelerationColor,2)),y=Y.get(de),y){const Z=y.get();if((A.showAll||A.showGeometry)&&Z&&Z.debug(this._graphicsContext,A.geometryColor,{lineWidth:A.geometryLineWidth,pointSize:A.geometryPointSize}),A.showAll||A.showBounds){if(Z instanceof we){const _t=Z.getColliders();for(const Tt of _t){const Gt=Tt.bounds,Xt=z(Gt.left,Gt.top);this._graphicsContext.debug.drawRect(Xt.x,Xt.y,Gt.width,Gt.height,{color:A.boundsColor}),(A.showAll||A.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${Tt.owner.id})`,Xt)}y.bounds.draw(this._graphicsContext,A.boundsColor)}else if(Z){const _t=y.bounds,Tt=z(_t.left,_t.top);this._graphicsContext.debug.drawRect(Tt.x,Tt.y,_t.width,_t.height,{color:A.boundsColor}),(A.showAll||A.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${y.owner.id})`,Tt)}}}this._graphicsContext.restore(),this._popCameraTransform(_)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(E.showAll||E.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),E.showAll||E.showCollisionContacts||E.showCollisionNormals)for(const[Q,Y]of this._engine.debug.stats.currFrame.physics.contacts){if(E.showAll||E.showCollisionContacts)for(const J of Y.points)this._graphicsContext.debug.drawPoint(J,{size:E.contactSize,color:E.collisionContactColor});if(E.showAll||E.showCollisionNormals)for(const J of Y.points)this._graphicsContext.debug.drawLine(J,Y.normal.scale(30).add(J),{color:E.collisionNormalColor})}this._graphicsContext.restore(),N&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(N.showAll||N.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,N.focusColor),(N.showAll||N.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(e,s){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),xe.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(e){const s=e.getAncestors();for(const r of s){const a=r?.get(et);a&&(this._graphicsContext.translate(a.pos.x,a.pos.y),this._graphicsContext.scale(a.scale.x,a.scale.y),this._graphicsContext.rotate(a.rotation))}}_pushCameraTransform(e){e.coordPlane===Pe.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(e){e.coordPlane===Pe.World&&this._graphicsContext.restore()}}wh.priority=Li.Lowest;class xh{constructor(e,s){this.object=e,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=s,this.bounds=e.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const e=this.object.bounds,s=Math.floor(e.left/this.gridSize),r=Math.floor(e.right/this.gridSize),a=Math.floor(e.bottom/this.gridSize),l=Math.floor(e.top/this.gridSize);return this.leftX!==s||this.rightX!==r||this.bottomY!==a||this.topY!==l}clear(){for(const e of this.cells){const s=e.proxies.indexOf(this);s>-1&&e.proxies.splice(s,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class Ui{constructor(){this.proxies=[]}configure(e,s){this.x=e,this.y=s,this.key=Ui.calculateHashKey(e,s)}static calculateHashKey(e,s){return`${e}+${s}`}}class bh{constructor(e){this.bounds=new at,this._hashGridCellPool=new Xn(()=>new Ui,s=>(s.configure(0,0),s.proxies.length=0,s),1e3),this.gridSize=e.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,e.proxyFactory?this._buildProxy=s=>e.proxyFactory(s,this.gridSize):this._buildProxy=s=>new xh(s,this.gridSize)}query(e){const s=new Set;if(e instanceof at){const r=e,a=Math.floor(r.left/this.gridSize),l=Math.floor(r.right/this.gridSize),_=Math.floor(r.bottom/this.gridSize),p=Math.floor(r.top/this.gridSize);for(let m=a;m<=l;m++)for(let w=p;w<=_;w++){const y=Ui.calculateHashKey(m,w),A=this.sparseHashGrid.get(y);if(A)for(let E=0;E<A.proxies.length;E++)A.proxies[E].updateBounds(),A.proxies[E].bounds.intersect(r)&&s.add(A.proxies[E].object)}}else{const r=e,a=Ui.calculateHashKey(Math.floor(r.x/this.gridSize),Math.floor(r.y/this.gridSize)),l=this.sparseHashGrid.get(a);if(l)for(let _=0;_<l.proxies.length;_++)l.proxies[_].updateBounds(),l.proxies[_].bounds.contains(r)&&s.add(l.proxies[_].object)}return Array.from(s)}get(e,s){const r=Ui.calculateHashKey(e,s);return this.sparseHashGrid.get(r)}_insert(e,s,r){const a=Ui.calculateHashKey(e,s);let l=this.sparseHashGrid.get(a);l||(l=this._hashGridCellPool.rent(),l.configure(e,s),this.sparseHashGrid.set(l.key,l)),l.proxies.push(r),r.cells.push(l),this.bounds.combine(r.bounds,this.bounds)}_remove(e,s,r){const a=Ui.calculateHashKey(e,s),l=this.sparseHashGrid.get(a);if(l){const _=l.proxies.indexOf(r);_>-1&&l.proxies.splice(_,1);const p=r.cells.indexOf(l);p>-1&&r.cells.splice(p,1),l.proxies.length===0&&(this._hashGridCellPool.return(l),this.sparseHashGrid.delete(a))}}track(e){const s=this._buildProxy(e);this.objectToProxy.set(e,s);for(let r=s.leftX;r<=s.rightX;r++)for(let a=s.topY;a<=s.bottomY;a++)this._insert(r,a,s)}untrack(e){const s=this.objectToProxy.get(e);s&&(s.clear(),this.objectToProxy.delete(e))}update(e){let s=0;for(const r of e){const a=this.objectToProxy.get(r);if(a&&a.hasChanged()){for(let l=a.leftX;l<=a.rightX;l++)for(let _=a.topY;_<=a.bottomY;_++)this._remove(l,_,a);a.update();for(let l=a.leftX;l<=a.rightX;l++)for(let _=a.topY;_<=a.bottomY;_++)this._insert(l,_,a);s++}}return s}debug(e,s){const r=$.Transparent,a=$.White;for(const l of this.sparseHashGrid.values())e.drawRectangle(z(l.x*this.gridSize,l.y*this.gridSize),this.gridSize,this.gridSize,r,a,2)}}class xo extends hi{constructor(e){super(),this.world=e,this.systemType=ni.Update,this._graphicsHashGrid=new bh({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new ph,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([et,As]),this.query.entityAdded$.subscribe(s=>{const r=s.get(et),a=s.get(As);this._pointerEventDispatcher.addObject(s,_=>a&&a.localBounds?a.localBounds.transform(r.get().matrix).contains(r.coordPlane===Pe.World?_.worldPos:_.screenPos):!1,()=>s.isActive),this._entityToPointer.set(s,a);const l=s.get(Jt);l&&(this._graphics.push(l),this._graphicsHashGrid.track(l)),this._sortedTransforms.push(r),this._sortedEntities.push(r.owner),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{this._pointerEventDispatcher.removeObject(s);const r=s.get(et);this._entityToPointer.delete(s);const a=s.get(Jt);if(a){const _=this._graphics.indexOf(a);_>-1&&this._graphics.splice(_,1),this._graphicsHashGrid.untrack(a)}r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const l=this._sortedTransforms.indexOf(r);l>-1&&(this._sortedTransforms.splice(l,1),this._sortedEntities.splice(l,1))})}initialize(e,s){this._engine=s.engine,this._scene=s}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>s.z-e.z),this._sortedEntities=this._sortedTransforms.map(e=>e.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[e,s]of this._engineReceiver.currentFramePointerCoords.entries()){const r=this._scene.physics.query(s.worldPos);for(let l=0;l<r.length;l++){const _=r[l],p=this._entityToPointer.get(_.owner);p&&(p.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(_.owner,e)}const a=this._graphicsHashGrid.query(s.worldPos);for(let l=0;l<a.length;l++){const _=a[l],p=this._entityToPointer.get(_.owner);p&&(p.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(_.owner,e)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(e=>e.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(e=>e.clear())}}xo.priority=Li.Higher;class yh extends hi{constructor(e){super(),this.world=e,this.systemType=ni.Update,this._actions=[],this.query=this.world.query([yn]),this.query.entityAdded$.subscribe(s=>this._actions.push(s.get(yn))),this.query.entityRemoved$.subscribe(s=>{const r=s.get(yn),a=this._actions.indexOf(r);a>-1&&this._actions.splice(a,1)})}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}}yh.priority=Li.Higher;class cr extends _i{constructor(e){super(),this.elevation=0,this.columns=e.columns,this.rows=e.rows,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight}}class Ah extends hi{constructor(e){super(),this.world=e,this.systemType=ni.Update,this.query=this.world.query([et,cr])}update(){let e,s;for(let r=0;r<this.query.entities.length;r++){const a=this.query.entities[r];e=a.get(et),s=a.get(cr);const _=Math.max(s.columns*s.tileWidth,s.rows*s.tileHeight)*s.elevation+e.pos.y;e.z=_}}}Ah.priority=Li.Lower;class Ch extends hi{constructor(e){super(),this.world=e,this.systemType=ni.Draw,this.query=this.world.query([et,Jt])}initialize(e,s){this._camera=s.camera,this._screen=s.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let e,s,r;for(let a=0;a<this.query.entities.length;a++){const l=this.query.entities[a];s=l.get(Jt),e=l.get(et),r=l.get(po);let _;if(r){const m=B.One.sub(r.parallaxFactor);_=this._camera.pos.scale(m)}const p=this._isOffscreen(e,s,_);p&&!l.hasTag("ex.offscreen")&&(l.events.emit("exitviewport",new Va(l)),l.addTag("ex.offscreen")),!p&&l.hasTag("ex.offscreen")&&(l.events.emit("enterviewport",new qa(l)),l.removeTag("ex.offscreen"))}}_isOffscreen(e,s,r){if(s.forceOnScreen)return!1;if(e.coordPlane===Pe.World){let a=s.localBounds;r&&(a=a.translate(r));const l=a.transform(e.get().matrix);return!this._worldBounds.overlaps(l)}else return!1}}Ch.priority=Li.Higher;class Ud extends xh{constructor(e,s){var r,a;super(e,s),this.collider=e,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=s;const l=e.bounds;this.hasZeroBounds=l.hasZeroDimensions(),this.leftX=Math.floor(l.left/this.gridSize),this.rightX=Math.floor(l.right/this.gridSize),this.bottomY=Math.floor(l.bottom/this.gridSize),this.topY=Math.floor(l.top/this.gridSize),this.owner=e.owner,this.body=(r=this.owner)===null||r===void 0?void 0:r.get(At),this.collisionType=(a=this.body.collisionType)!==null&&a!==void 0?a:dt.PreventCollision}update(){var e,s;super.update(),this.body=(e=this.owner)===null||e===void 0?void 0:e.get(At),this.collisionType=(s=this.body.collisionType)!==null&&s!==void 0?s:dt.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class Th{constructor(e){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new $r(()=>new Ve({id:T("collider",0)},{id:T("collider",0)}),s=>(s.colliderA=null,s.colliderB=null,s),200),this.gridSize=e.size,this.hashGrid=new bh({size:this.gridSize,proxyFactory:(s,r)=>new Ud(s,r)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(e){return this.hashGrid.query(e)}rayCast(e,s){var r,a,l;const _=[],p=(r=s?.maxDistance)!==null&&r!==void 0?r:1/0,m=s?.collisionGroup,w=m?m.category:(a=s?.collisionMask)!==null&&a!==void 0?a:ts.All.category,y=(l=s?.searchAllColliders)!==null&&l!==void 0?l:!1,A=e.dir.normalize(),E=A.y/A.x,D=A.x/A.y,L=Math.sqrt(1+E*E)*this.gridSize,O=Math.sqrt(1+D*D)*this.gridSize,X=e.pos.x/this.gridSize,H=e.pos.y/this.gridSize,N=z(1,1);let Q=~~X,Y=~~H,J=0,rt=0;A.x<0?(N.x=-1,J=(X-Q)*L):(N.x=1,J=(Q+1-X)*L),A.y<0?(N.y=-1,rt=(H-Y)*O):(N.y=1,rt=(Y+1-H)*O);const Z=new Set;let _t=!1,Tt=9999;for(;!_t&&Tt>0&&(Tt--,!!this.hashGrid.bounds.contains(z(Q*this.gridSize,Y*this.gridSize)));){const Gt=Ui.calculateHashKey(Q,Y),Xt=this.hashGrid.sparseHashGrid.get(Gt);if(Xt){const be=[];for(let $t=0;$t<Xt.proxies.length;$t++){const kt=Xt.proxies[$t];if(!Z.has(kt.collider.id.value)){if(Z.add(kt.collider.id.value),s?.ignoreCollisionGroupAll&&kt.body.group===ts.All)continue;const ze=(w&kt.body.group.category)!==0;if(kt.body.group&&!ze)continue;const Ee=kt.collider.rayCast(e,p);Ee&&be.push(Ee)}}be.sort(($t,kt)=>$t.distance-kt.distance);for(let $t=0;$t<be.length;$t++){const kt=be[$t];if(s?.filter){if(s.filter(kt)&&(_.push(kt),!y)){_t=!0;break}}else if(_.push(kt),!y){_t=!0;break}}}J<rt?(Q+=N.x,J+=L):(Y+=N.y,rt+=O)}return _.sort((Gt,Xt)=>Gt.distance-Xt.distance),!y&&_.length?[_[0]]:_}track(e){let s=[e];if(e instanceof we){const r=e.getColliders();for(const a of r)a.owner=e.owner;s=r}for(const r of s)this.hashGrid.track(r)}untrack(e){let s=[e];e instanceof we&&(s=e.getColliders());for(const r of s)this.hashGrid.untrack(r)}_canCollide(e,s){return!(e.collider.id===s.collider.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.hasZeroBounds||s.hasZeroBounds||!e.body.group.canCollide(s.body.group)||e.collisionType===dt.Fixed&&s.collisionType===dt.Fixed||e.collisionType===dt.PreventCollision||s.collisionType===dt.PreventCollision||!e.owner.isActive||!s.owner.isActive)}broadphase(e,s){const r=[];this._pairs.clear(),this._nonPairs.clear();let a=0;for(const l of this.hashGrid.objectToProxy.values())if(l.id=a++,!(!l.owner.isActive||l.collisionType===dt.PreventCollision))for(let _=0;_<l.cells.length;_++){const p=l.cells[_];for(let m=0;m<p.proxies.length;m++){const w=p.proxies[m];if(w.id===l.id)continue;const y=Ve.calculatePairHash(l.collider.id,w.collider.id);if(!this._nonPairs.has(y))if(!this._pairs.has(y)&&this._canCollide(l,w)&&l.object.bounds.overlaps(w.object.bounds)){const A=this._pairPool.get();A.colliderA=l.collider,A.colliderB=w.collider,A.id=y,this._pairs.add(y),r.push(A)}else this._nonPairs.add(y)}}return r}narrowphase(e,s){const r=[];for(let a=0;a<e.length;a++){const l=e[a].collide();for(let _=0;_<l.length;_++){const p=l[_];r.push(p),s&&s.physics.contacts.set(p.id,p)}}return this._pairPool.done(),s&&(s.physics.collisions+=r.length),r}update(e,s){return this.hashGrid.update(e)}debug(e,s){this.hashGrid.debug(e,s)}}class zd{get config(){return Lf(this._config,e=>{this.$configUpdate.notifyAll(e)})}set config(e){this._config=e,this.$configUpdate.notifyAll(e)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const e=this._collisionProcessor.getColliders();this._config.spatialPartition===bn.SparseHashGrid?this._collisionProcessor=new Th(this._config.sparseHashGrid):this._collisionProcessor=new _o(this._config);for(const s of e)this._collisionProcessor.track(s)}return this._collisionProcessor}constructor(e){this.$configUpdate=new Ne,this._configDirty=!1,this.config=e,this.$configUpdate.subscribe(s=>{this._configDirty=!0,At.updateDefaultPhysicsConfig(s.bodies)}),this._config.spatialPartition===bn.SparseHashGrid?this._collisionProcessor=new Th(this._config.sparseHashGrid):this._collisionProcessor=new _o(this._config)}rayCast(e,s){return this.collisionProcessor.rayCast(e,s)}query(e){return this._collisionProcessor.query(e)}}class bo{constructor(){this.events=new I,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(e){this._enabled=e}setMinimumGamepadConfiguration(e){this._enableAndUpdate(),this._minimumConfiguration=e}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(e){if(!this._minimumConfiguration)return!0;if(!e)return!1;const s=e.axes.filter(a=>typeof a!==void 0).length,r=e.buttons.filter(a=>typeof a!==void 0).length;return s>=this._minimumConfiguration.axis&&r>=this._minimumConfiguration.buttons&&e.connected}emit(e,s){this.events.emit(e,s)}on(e,s){return this._enableAndUpdate(),this.events.on(e,s)}once(e,s){return this._enableAndUpdate(),this.events.once(e,s)}off(e,s){this._enableAndUpdate(),this.events.off(e,s)}update(){var e,s;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const r=this._navigator.getGamepads();for(let a=0;a<r.length;a++){if(r[a]){const _=this.at(a);!this.at(a).connected&&this._isGamepadValid(r[a])&&(_.events.pipe(this.events),this.events.emit("connect",new La(a,this.at(a)))),this.at(a).connected=!0}else{const _=this.at(a);_.connected&&(this.events.emit("disconnect",new Ua(a,_)),_.events.unpipe(this.events)),_.connected=!1;continue}if(this.at(a).update(),r[a].timestamp&&r[a].timestamp===this._gamePadTimeStamps[a])continue;this._gamePadTimeStamps[a]=r[a].timestamp,this.at(a).navigatorGamepad=r[a];const l=r[a];if(l){for(let _=0;_<l.buttons.length;_++){const p=l.buttons[_],m=p?.value;m!==((e=this._oldPads[a])===null||e===void 0?void 0:e.getButton(_))&&(p?.pressed?(this.at(a).updateButton(_,m),this.at(a).events.emit("button",new za(_ in dr?_:dr.Unknown,_,m,this.at(a)))):this.at(a).updateButton(_,0))}for(let _=0;_<l.axes.length;_++){const p=l.axes[_];p!==((s=this._oldPads[a])===null||s===void 0?void 0:s.getAxes(_))&&(this.at(a).updateAxes(_,p),this.at(a).events.emit("axis",new Ha(_,p,this.at(a))))}}this._oldPads[a]=this._clonePad(r[a])}}at(e){if(this._enableAndUpdate(),e>=this._pads.length)for(let s=this._pads.length-1,r=e;s<r;s++)this._pads.push(new yo),this._oldPads.push(new yo);return this._pads[e]}getValidGamepads(){this._enableAndUpdate();const e=[];for(let s=0;s<this._pads.length;s++)this._isGamepadValid(this.at(s).navigatorGamepad)&&this.at(s).connected&&e.push(this.at(s));return e}count(){return this._pads.filter(e=>e.connected).length}_clonePads(e){const s=[];for(let r=0,a=e.length;r<a;r++)s.push(this._clonePad(e[r]));return s}_clonePad(e){let s,r;const a=new yo;if(!e)return a;for(s=0,r=e.buttons.length;s<r;s++)e.buttons[s]&&a.updateButton(s,e.buttons[s].value);for(s=0,r=e.axes.length;s<r;s++)a.updateAxes(s,e.axes[s]);return a}}bo.MinAxisMoveThreshold=.05;class yo{constructor(){this.events=new I,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let e=0;e<this._buttons.length;e++)this._buttons[e]=0;for(let e=0;e<this._axes.length;e++)this._axes[e]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(e,s=1){return this._buttons[e]>=s}isButtonHeld(e,s=1){return this._buttons[e]>=s}wasButtonPressed(e,s=1){return this._buttonsDown[e]>=s}wasButtonReleased(e){return!!this._buttonsUp[e]}getButton(e){return this._buttons[e]}getAxes(e){const s=this._axes[e];return Math.abs(s)<bo.MinAxisMoveThreshold?0:s}updateButton(e,s){s===0&&this._buttons[e]?this._buttonsUp[e]=1:this._buttonsDown[e]=s,this._buttons[e]=s}updateAxes(e,s){this._axes[e]=s}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}var dr;(function(u){u[u.Unknown=-1]="Unknown",u[u.Face1=0]="Face1",u[u.Face2=1]="Face2",u[u.Face3=2]="Face3",u[u.Face4=3]="Face4",u[u.LeftBumper=4]="LeftBumper",u[u.RightBumper=5]="RightBumper",u[u.LeftTrigger=6]="LeftTrigger",u[u.RightTrigger=7]="RightTrigger",u[u.Select=8]="Select",u[u.Start=9]="Start",u[u.LeftStick=10]="LeftStick",u[u.RightStick=11]="RightStick",u[u.DpadUp=12]="DpadUp",u[u.DpadDown=13]="DpadDown",u[u.DpadLeft=14]="DpadLeft",u[u.DpadRight=15]="DpadRight",u[u.CenterButton=16]="CenterButton",u[u.MiscButton1=17]="MiscButton1"})(dr||(dr={}));var Ph;(function(u){u[u.LeftStickX=0]="LeftStickX",u[u.LeftStickY=1]="LeftStickY",u[u.RightStickX=2]="RightStickX",u[u.RightStickY=3]="RightStickY"})(Ph||(Ph={}));class Hd{constructor(e){this.inputs=e,this._handlers=new Map}execute(){for(const[e,s]of this._handlers.entries()){const r=e(this.inputs);r&&s(r)}}on(e,s){this._handlers.set(e,s)}}function Od(){try{const u=()=>{};window.top.addEventListener("blur",u),window.top.removeEventListener("blur",u)}catch{return!0}return!1}var ur;(function(u){u.Backquote="Backquote",u.Backslash="Backslash",u.BracketLeft="BracketLeft",u.BracketRight="BracketRight",u.Comma="Comma",u.Key0="Digit0",u.Key1="Digit1",u.Key2="Digit2",u.Key3="Digit3",u.Key4="Digit4",u.Key5="Digit5",u.Key6="Digit6",u.Key7="Digit7",u.Key8="Digit8",u.Key9="Digit9",u.Digit0="Digit0",u.Digit1="Digit1",u.Digit2="Digit2",u.Digit3="Digit3",u.Digit4="Digit4",u.Digit5="Digit5",u.Digit6="Digit6",u.Digit7="Digit7",u.Digit8="Digit8",u.Digit9="Digit9",u.Equal="Equal",u.IntlBackslash="IntlBackslash",u.IntlRo="IntlRo",u.IntlYen="IntlYen",u.A="KeyA",u.B="KeyB",u.C="KeyC",u.D="KeyD",u.E="KeyE",u.F="KeyF",u.G="KeyG",u.H="KeyH",u.I="KeyI",u.J="KeyJ",u.K="KeyK",u.L="KeyL",u.M="KeyM",u.N="KeyN",u.O="KeyO",u.P="KeyP",u.Q="KeyQ",u.R="KeyR",u.S="KeyS",u.T="KeyT",u.U="KeyU",u.V="KeyV",u.W="KeyW",u.X="KeyX",u.Y="KeyY",u.Z="KeyZ",u.KeyA="KeyA",u.KeyB="KeyB",u.KeyC="KeyC",u.KeyD="KeyD",u.KeyE="KeyE",u.KeyF="KeyF",u.KeyG="KeyG",u.KeyH="KeyH",u.KeyI="KeyI",u.KeyJ="KeyJ",u.KeyK="KeyK",u.KeyL="KeyL",u.KeyM="KeyM",u.KeyN="KeyN",u.KeyO="KeyO",u.KeyP="KeyP",u.KeyQ="KeyQ",u.KeyR="KeyR",u.KeyS="KeyS",u.KeyT="KeyT",u.KeyU="KeyU",u.KeyV="KeyV",u.KeyW="KeyW",u.KeyX="KeyX",u.KeyY="KeyY",u.KeyZ="KeyZ",u.Minus="Minus",u.Period="Period",u.Quote="Quote",u.Semicolon="Semicolon",u.Slash="Slash",u.AltLeft="AltLeft",u.AltRight="AltRight",u.Alt="Alt",u.AltGraph="AltGraph",u.Backspace="Backspace",u.CapsLock="CapsLock",u.ContextMenu="ContextMenu",u.ControlLeft="ControlLeft",u.ControlRight="ControlRight",u.Enter="Enter",u.MetaLeft="MetaLeft",u.MetaRight="MetaRight",u.ShiftLeft="ShiftLeft",u.ShiftRight="ShiftRight",u.Space="Space",u.Tab="Tab",u.Convert="Convert",u.KanaMode="KanaMode",u.NonConvert="NonConvert",u.Delete="Delete",u.End="End",u.Help="Help",u.Home="Home",u.Insert="Insert",u.PageDown="PageDown",u.PageUp="PageUp",u.Up="ArrowUp",u.Down="ArrowDown",u.Left="ArrowLeft",u.Right="ArrowRight",u.ArrowUp="ArrowUp",u.ArrowDown="ArrowDown",u.ArrowLeft="ArrowLeft",u.ArrowRight="ArrowRight",u.NumLock="NumLock",u.Numpad0="Numpad0",u.Numpad1="Numpad1",u.Numpad2="Numpad2",u.Numpad3="Numpad3",u.Numpad4="Numpad4",u.Numpad5="Numpad5",u.Numpad6="Numpad6",u.Numpad7="Numpad7",u.Numpad8="Numpad8",u.Numpad9="Numpad9",u.Num0="Numpad0",u.Num1="Numpad1",u.Num2="Numpad2",u.Num3="Numpad3",u.Num4="Numpad4",u.Num5="Numpad5",u.Num6="Numpad6",u.Num7="Numpad7",u.Num8="Numpad8",u.Num9="Numpad9",u.NumAdd="NumpadAdd",u.NumpadAdd="NumpadAdd",u.NumDecimal="NumpadDecimal",u.NumpadDecimal="NumpadDecimal",u.NumDivide="NumpadDivide",u.NumpadDivide="NumpadDivide",u.NumEnter="NumpadEnter",u.NumpadEnter="NumpadEnter",u.NumMultiply="NumpadMultiply",u.NumpadMultiply="NumpadMultiply",u.NumSubtract="NumpadSubtract",u.NumpadSubtract="NumpadSubtract",u.Esc="Escape",u.Escape="Escape",u.F1="F1",u.F2="F2",u.F3="F3",u.F4="F4",u.F5="F5",u.F6="F6",u.F7="F7",u.F8="F8",u.F9="F9",u.F10="F10",u.F11="F11",u.F12="F12",u.F13="F13",u.F14="F14",u.F15="F15",u.F16="F16",u.F17="F17",u.F18="F18",u.F19="F19",u.F20="F20",u.PrintScreen="PrintScreen",u.ScrollLock="ScrollLock",u.Pause="Pause",u.Unidentified="Unidentified"})(ur||(ur={}));class _r extends mt{constructor(e,s,r){super(),this.key=e,this.value=s,this.originalEvent=r}}class Wd{constructor(){this.events=new I,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=e=>{for(const s of this._keys){const r=new _r(s,e.key,e);this.events.emit("up",r),this.events.emit("release",r)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=e=>{if(!this._enabled)return;!e.metaKey&&(this._keys.includes(ur.MetaLeft)||this._keys.includes(ur.MetaRight))&&this._releaseAllKeys(e);const s=e.code;if(this._keys.indexOf(s)===-1){this._keys.push(s),this._keysDown.push(s);const r=new _r(s,e.key,e);this.events.emit("down",r),this.events.emit("press",r)}},this._handleKeyUp=e=>{if(!this._enabled)return;const s=e.code,r=this._keys.indexOf(s);this._keys.splice(r,1),this._keysUp.push(s);const a=new _r(s,e.key,e);this.events.emit("up",a),this.events.emit("release",a),e.key==="Meta"&&this._releaseAllKeys(e)}}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}init(e){let{global:s}=e;const{grabWindowFocus:r}=e;s||(Od()?(s=window,r&&window.focus(),ot.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):s=window.top),s.addEventListener("blur",()=>{this._keys.length=0}),s.addEventListener("keyup",this._handleKeyUp),s.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(e){this._enabled=e}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let e=0;e<this._keys.length;e++)this.events.emit("hold",new _r(this._keys[e]))}getKeys(){return this._keys}wasPressed(e){return this._enabled?this._keysDown.indexOf(e)>-1:!1}isHeld(e){return this._enabled?this._keys.indexOf(e)>-1:!1}wasReleased(e){return this._enabled?this._keysUp.indexOf(e)>-1:!1}triggerEvent(e,s,r){e==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:s,key:r??null})),e==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:s,key:r??null}))}}class An{static fromPagePosition(e,s,r){let a,l,_,p;arguments.length===3?(a=e,l=s,_=new B(a,l),p=r):(_=e,a=_.x,l=_.y,p=s);const m=p.screen.pageToScreenCoordinates(_),w=p.screen.screenToWorldCoordinates(m);return new An(w,_,m)}constructor(e,s,r){this.worldPos=e,this.pagePos=s,this.screenPos=r}}class fr{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(e,s,r,a,l,_){this.type=e,this.pointerId=s,this.button=r,this.pointerType=a,this.coordinates=l,this.nativeEvent=_,this.active=!0}}class Nd{cancel(){this.active=!1}constructor(e,s,r,a,l,_,p,m,w,y,A,E){this.x=e,this.y=s,this.pageX=r,this.pageY=a,this.screenX=l,this.screenY=_,this.index=p,this.deltaX=m,this.deltaY=w,this.deltaZ=y,this.deltaMode=A,this.ev=E,this.active=!0}}class Sh{constructor(){this.events=new I,this.lastPagePos=B.Zero,this.lastScreenPos=B.Zero,this.lastWorldPos=B.Zero,this._onPointerMove=e=>{this.lastPagePos=new B(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new B(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new B(e.worldPos.x,e.worldPos.y)},this._onPointerDown=e=>{this.lastPagePos=new B(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new B(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new B(e.worldPos.x,e.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_updateWorldPosition(e){const s=An.fromPagePosition(this.lastPagePos,e);this.lastScreenPos=s.screenPos,this.lastWorldPos=s.worldPos}}var Cn;(function(u){u.Pixel="Pixel",u.Line="Line",u.Page="Page"})(Cn||(Cn={}));var Cs;(function(u){u[u.NoButton=-1]="NoButton",u[u.Left=0]="Left",u[u.Middle=1]="Middle",u[u.Right=2]="Right",u[u.Unknown=3]="Unknown"})(Cs||(Cs={}));var ss;(function(u){u.Left="Left",u.Middle="Middle",u.Right="Right",u.Unknown="Unknown",u.NoButton="NoButton"})(ss||(ss={}));var ns;(function(u){u.Touch="Touch",u.Mouse="Mouse",u.Pen="Pen",u.Unknown="Unknown"})(ns||(ns={}));function Gp(u){return globalThis.TouchEvent&&u instanceof globalThis.TouchEvent}function Vp(u){return globalThis.PointerEvent&&u instanceof globalThis.PointerEvent}class Ao{constructor(e,s){this.target=e,this.engine=s,this.events=new I,this.primary=new Sh,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(e){this._enabled=e}recreate(e,s){const r=new Ao(e,s);return r.primary=this.primary,r._pointers=this._pointers,r}at(e){if(e>=this._pointers.length)for(let s=this._pointers.length-1,r=e;s<r;s++)this._pointers.push(new Sh);return this._pointers[e]}count(){return this._pointers.length}isDown(e){var s;return this._enabled&&(s=this.currentFramePointerDown.get(e))!==null&&s!==void 0?s:!1}wasDown(e){var s;return this._enabled&&(s=this.lastFramePointerDown.get(e))!==null&&s!==void 0?s:!1}isDragging(e){return this._enabled?this.isDown(e):!1}isDragStart(e){return this._enabled?this.isDown(e)&&!this.wasDown(e):!1}isDragEnd(e){return this._enabled?!this.isDown(e)&&this.wasDown(e):!1}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const e of this.currentFrameDown){if(!e.active)continue;this.emit("down",e),this.at(e.pointerId).emit("down",e),this.primary.emit("pointerdown",e)}for(const e of this.currentFrameUp){if(!e.active)continue;this.emit("up",e),this.at(e.pointerId).emit("up",e)}for(const e of this.currentFrameMove){if(!e.active)continue;this.emit("move",e),this.at(e.pointerId).emit("move",e)}for(const e of this.currentFrameCancel){if(!e.active)continue;this.emit("cancel",e),this.at(e.pointerId).emit("cancel",e)}for(const e of this.currentFrameWheel)e.active&&(this.emit("pointerwheel",e),this.emit("wheel",e),this.primary.emit("pointerwheel",e),this.primary.emit("wheel",e));if(this.engine.currentScene.camera.hasChanged())for(const e of this._pointers)e._updateWorldPosition(this.engine)}clear(){for(const e of this.currentFrameUp){this.currentFramePointerCoords.delete(e.pointerId);const s=this._activeNativePointerIdsToNormalized.entries();for(const[r,a]of s)a===e.pointerId&&this._activeNativePointerIdsToNormalized.delete(r)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(e){var s;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const r={passive:!(this.engine.pageScrollPreventionMode===Ts.All||this.engine.pageScrollPreventionMode===Ts.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,r):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,r):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,r),((s=e?.grabWindowFocus)!==null&&s!==void 0?s:!0)&&Od()){const l=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",l):(this.target.addEventListener("touchstart",l),this.target.addEventListener("mousedown",l))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(e){this._activeNativePointerIdsToNormalized.set(e,-1);const r=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((a,l)=>a-l).findIndex(a=>a===e);return this._activeNativePointerIdsToNormalized.set(e,r),r}_handle(e){if(!this._enabled)return;e.preventDefault();const s=new Map;let r,a;if(Gp(e)){r=ss.Unknown,a=ns.Touch;for(let l=0;l<e.changedTouches.length;l++){const _=e.changedTouches[l],p=An.fromPagePosition(_.pageX,_.pageY,this.engine),m=l+1,w=this._normalizePointerId(m);this.currentFramePointerCoords.set(w,p),s.set(w,p)}}else{r=this._nativeButtonToPointerButton(e.button),a=ns.Mouse;const l=An.fromPagePosition(e.pageX,e.pageY,this.engine);let _=1;Vp(e)&&(_=e.pointerId,a=this._stringToPointerType(e.pointerType));const p=this._normalizePointerId(_);this.currentFramePointerCoords.set(p,l),s.set(p,l)}for(const[l,_]of s.entries())switch(e.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new fr("down",l,r,a,_,e)),this.currentFramePointerDown.set(l,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new fr("up",l,r,a,_,e)),this.currentFramePointerDown.set(l,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new fr("move",l,r,a,_,e));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new fr("cancel",l,r,a,_,e));break}}_handleWheel(e){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Ts.All||this.engine.pageScrollPreventionMode===Ts.Canvas&&e.target===this.engine.canvas)&&e.preventDefault();const s=this.engine.screen.pageToScreenCoordinates(z(e.pageX,e.pageY)),r=this.engine.screen.screenToWorldCoordinates(s),a=-1/40,l=e.deltaX||e.wheelDeltaX*a||0,_=e.deltaY||e.wheelDeltaY*a||e.wheelDelta*a||e.detail||0,p=e.deltaZ||0;let m=Cn.Pixel;e.deltaMode&&(e.deltaMode===1?m=Cn.Line:e.deltaMode===2&&(m=Cn.Page));const w=new Nd(r.x,r.y,e.pageX,e.pageY,s.x,s.y,0,l,_,p,m,e);this.currentFrameWheel.push(w)}triggerEvent(e,s){const r=this.engine.screen.worldToPageCoordinates(s);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+e,{pointerId:0,clientX:r.x,clientY:r.y})):this._handle(new window.MouseEvent("mouse"+e,{clientX:r.x,clientY:r.y}));const a=this.engine.currentScene.world.get(xo);a.preupdate(this.engine.currentScene,1),a.update(1)}_nativeButtonToPointerButton(e){switch(e){case Cs.NoButton:return ss.NoButton;case Cs.Left:return ss.Left;case Cs.Middle:return ss.Middle;case Cs.Right:return ss.Right;case Cs.Unknown:return ss.Unknown;default:return Tc(e)}}_stringToPointerType(e){switch(e){case"touch":return ns.Touch;case"mouse":return ns.Mouse;case"pen":return ns.Pen;default:return ns.Unknown}}}class Eh{constructor(e){this._enabled=!0;const{pointerTarget:s,grabWindowFocus:r,engine:a}=e;this.keyboard=new Wd,this.pointers=new Ao(s,a),this.gamepads=new bo,this.keyboard.init({grabWindowFocus:r}),this.pointers.init({grabWindowFocus:r}),this.gamepads.init(),this.inputMapper=new Hd({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(e){this._enabled=e,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class qp{}const Xp={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function zi(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class li{get actors(){return this.world.entityManager.entities.filter(e=>e instanceof qe)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(e=>e instanceof Rd)}get tileMaps(){return this.world.entityManager.entities.filter(e=>e instanceof bd)}get timers(){return this._timers}constructor(){this._logger=ot.getInstance(),this.events=new I,this.camera=new Id,this.world=new kd(this),this.physics=new zd(is()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(yh),this.world.add(new vo(this.world,this.physics)),this.world.add(new wo(this.world,this.physics)),this.world.add(xo),this.world.add(Ah),this.world.add(Ch),this.world.add(vh),this.world.add(wh)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}onPreLoad(e){}onTransition(e){}onInitialize(e){}onActivate(e){}onDeactivate(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreDraw(e,s){}onPostDraw(e,s){}_initializeChildren(){for(const e of this.entities)e._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(e){var s;if(!this.isInitialized){try{this.engine=e,this.physics.config=this.engine.physics,this.input=new Eh({pointerTarget:e.pointerScope===F.Canvas?e.canvas:document,grabWindowFocus:e.grabWindowFocus,engine:e}),this.camera._initialize(e),this.world.systemManager.initialize(),await this.onInitialize(e),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,e),this.events.emit("initialize",new xn(e,this))}catch(r){throw this._logger.error(`Error during scene initialization for scene ${(s=e.director)===null||s===void 0?void 0:s.getSceneName(this)}!`),r}this._isInitialized=!0}}async _activate(e){var s,r;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(e)}catch(a){throw this._logger.error(`Error during scene activation for scene ${(r=(s=this.engine)===null||s===void 0?void 0:s.director)===null||r===void 0?void 0:r.getSceneName(this)}!`),a}}async _deactivate(e){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(e)}_preupdate(e,s){this.emit("preupdate",new xs(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.emit("postupdate",new bs(e,s,this)),this.onPostUpdate(e,s)}_predraw(e,s){this.emit("predraw",new vn(e,s,this)),this.onPreDraw(e,s)}_postdraw(e,s){this.emit("postdraw",new wn(e,s,this)),this.onPostDraw(e,s)}update(e,s){var r;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(r=e.director)===null||r===void 0?void 0:r.getSceneName(this)}!`);return}this._preupdate(e,s);let a,l;for(a=0,l=this._cancelQueue.length;a<l;a++)this.removeTimer(this._cancelQueue[a]);this._cancelQueue.length=0;for(const _ of this._timers)_.update(s);this.world.update(ni.Update,s),this.camera&&this.camera.update(e,s),this._collectActorStats(e),this._postupdate(e,s),this.input.update()}draw(e,s){var r;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(e,s),this.world.update(ni.Draw,s),!((r=this.engine)===null||r===void 0)&&r.isDebug&&this.debugDraw(e),this._postdraw(e,s)}debugDraw(e){this.emit("predebugdraw",new Ma(e,this)),this.emit("postdebugdraw",new Fa(e,this))}contains(e){return this.actors.indexOf(e)>-1}add(e){if(this.emit("entityadded",{target:e}),e instanceof Ys){Vr(this._timers,e)||this.addTimer(e);return}this.world.add(e),e.scene=this}transfer(e){let s;e instanceof ke&&e.scene&&e.scene!==this&&(s=e.scene,e.scene.world.remove(e,!1)),e instanceof Ys&&e.scene&&(s=e.scene,e.scene.removeTimer(e)),s?.emit("entityremoved",{target:e}),this.add(e)}remove(e){this.emit("entityremoved",{target:e}),e instanceof ke&&(e.isActive&&e.kill(),this.world.remove(e)),e instanceof Ys&&this.removeTimer(e)}clear(e=!0){for(let s=this.entities.length-1;s>=0;s--)this.world.remove(this.entities[s],e);for(let s=this.timers.length-1;s>=0;s--)this.removeTimer(this.timers[s])}addTimer(e){return this._timers.push(e),e.scene=this,e}removeTimer(e){const s=this._timers.indexOf(e);return s!==-1&&this._timers.splice(s,1),e}cancelTimer(e){return this._cancelQueue.push(e),e}isTimerActive(e){return this._timers.indexOf(e)>-1&&!e.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(e){const s=this.actors;for(let r=0;r<s.length;r++){const a=s[r];a instanceof fh&&e.stats.currFrame.actors.ui++,e.stats.currFrame.actors.alive++;for(let l=0;l<a.children.length;l++){const _=a.children[l];wd(_)?e.stats.currFrame.actors.ui++:e.stats.currFrame.actors.alive++}}}}var js;(function(u){u.Protanope="Protanope",u.Deuteranope="Deuteranope",u.Tritanope="Tritanope"})(js||(js={}));const Yp=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class Gd{constructor(e,s){this._shader=new $e({gl:e,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:s}),this._shader.compile(),this._buffer=new Mi({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Qi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class Vd{constructor(e,s=!1){this._colorBlindnessMode=e,this._simulate=!1,this._simulate=s}initialize(e){this._shader=new Gd(e,Yp),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(e){if(this._colorBlindnessMode=e,this._shader){const s=this._shader.getShader();s.use(),this._colorBlindnessMode===js.Protanope?s.setUniformInt("u_type",0):this._colorBlindnessMode===js.Deuteranope?s.setUniformInt("u_type",1):this._colorBlindnessMode===js.Tritanope&&s.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(e){if(this._simulate=e,this._shader){const s=this._shader.getShader();s.use(),s.setUniformBoolean("u_simulate",e)}}get simulate(){return this._simulate}}class qd{constructor(e){this._engine=e,this._colorBlindPostProcessor=new Vd(js.Protanope)}correct(e){this._engine.graphicsContext instanceof Ji&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(e){this._engine.graphicsContext instanceof Ji&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class Xd{constructor(e){this.stats={currFrame:new pr,prevFrame:new pr},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:$.Yellow,showZIndex:!1,showScale:!1,scaleColor:$.Green,showRotation:!1,rotationColor:$.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:$.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:$.Blue,showOwner:!1,showGeometry:!0,geometryColor:$.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:$.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:$.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:$.Yellow,showAcceleration:!1,accelerationColor:$.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:$.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:$.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:$.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:$.Yellow,positionSize:1,showGrid:!1,gridColor:$.Red,gridWidth:1,showColliderGeometry:!0},this._engine=e,this.colorBlindMode=new qd(this._engine)}useTestClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const r=e.toTestClock();return s&&r.start(),this._engine.clock=r,r}useStandardClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const r=e.toStandardClock();return s&&r.start(),this._engine.clock=r,r}}class pr{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new Co,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(e){e?(this.id=e.id,this.elapsedMs=e.elapsedMs,this.fps=e.fps,this.actors.alive=e.actors.alive,this.actors.killed=e.actors.killed,this.actors.ui=e.actors.ui,this.duration.update=e.duration.update,this.duration.draw=e.duration.draw,this._physicsStats.reset(e.physics),this.graphics.drawCalls=e.graphics.drawCalls,this.graphics.drawnImages=e.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const e=new pr;return e.reset(this),e}get id(){return this._id}set id(e){this._id=e}get elapsedMs(){return this._elapsedMs}set elapsedMs(e){this._elapsedMs=e}get fps(){return this._fps}set fps(e){this._fps=e}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class Co{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(e){e?(this.pairs=e.pairs,this.collisions=e.collisions,this.contacts=e.contacts,this.fastBodies=e.fastBodies,this.fastBodyCollisions=e.fastBodyCollisions,this.broadphase=e.broadphase,this.narrowphase=e.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const e=new Co;return e.reset(this),e}get pairs(){return this._pairs}set pairs(e){this._pairs=e}get collisions(){return this._collisions}set collisions(e){this._collisions=e}get contacts(){return this._contacts}set contacts(e){this._contacts=e}get fastBodies(){return this._fastBodies}set fastBodies(e){this._fastBodies=e}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(e){this._fastBodyCollisions=e}get broadphase(){return this._broadphase}set broadphase(e){this._broadphase=e}get narrowphase(){return this._narrowphase}set narrowphase(e){this._narrowphase=e}}class Ih{on(e,s){this._nativeHandlers[e]&&this.off(e,this._nativeHandlers[e]),this._nativeHandlers[e]=this._decorate(s),this.nativeComponent.addEventListener(e,this._nativeHandlers[e])}off(e,s){s||(s=this._nativeHandlers[e]),this.nativeComponent.removeEventListener(e,s),this._nativeHandlers[e]=null}_decorate(e){return s=>{this._paused||e(s)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const e in this._nativeHandlers)this.off(e)}constructor(e){this.nativeComponent=e,this._paused=!1,this._nativeHandlers={}}}class Yd{constructor(e,s){this._windowGlobal=e,this._documentGlobal=s,this._windowComponent=new Ih(this._windowGlobal),this._documentComponent=new Ih(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const jd={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:le.Blended,canvasImageRendering:"auto"},Zd={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:le.Blended,canvasImageRendering:"auto"};class $d{constructor(e){var s;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=e.initialFps,this._samplePeriod=(s=e.samplePeriod)!==null&&s!==void 0?s:this._samplePeriod,this._currentFrameTime=1e3/e.initialFps,this._nowFn=e.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const e=this._nowFn();this._currentFrameTime=e-this._beginFrameTime,e>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(e-this._previousSampleTime),this._previousSampleTime=e,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class Rh{constructor(e){var s,r,a;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=e,this.tick=e.tick,this._lastTime=(s=this.now())!==null&&s!==void 0?s:0,this._maxFps=(r=e.maxFps)!==null&&r!==void 0?r:this._maxFps,this._onFatalException=(a=e.onFatalException)!==null&&a!==void 0?a:this._onFatalException,this.fpsSampler=new $d({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new Qd({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new Dh({...this._options})}setFatalExceptionHandler(e){this._onFatalException=e}schedule(e,s=0,r="preframe"){const a=this._totalElapsed+s;this._scheduledCbs.push([e,a,r])}__runScheduledCbs(e="preframe"){for(let s=this._scheduledCbs.length-1;s>-1;s--)e===this._scheduledCbs[s][2]&&this._scheduledCbs[s][1]<=this._totalElapsed&&(this._scheduledCbs[s][0](this._elapsed),this._scheduledCbs.splice(s,1))}update(e){try{this.fpsSampler.start();const s=this.now();let r=s-this._lastTime||1;const a=1e3/this._maxFps;if(r>=a){let l=0;a!==0&&(l=r%a,r=r-l),r>200&&(r=1),this._elapsed=e||r,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(e||r),this.__runScheduledCbs("postframe"),a!==0?this._lastTime=s-l:this._lastTime=s,this.fpsSampler.end()}}catch(s){this._onFatalException(s),this.stop()}}}class Dh extends Rh{constructor(e){super(e),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const e=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(e),this.update()}catch(s){throw window.cancelAnimationFrame(this._requestId),s}};e()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class Qd extends Rh{constructor(e){super({...e}),this._logger=ot.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=e.defaultUpdateMs}now(){var e;return(e=this._currentTime)!==null&&e!==void 0?e:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(e){const s=e??this._updateMs;this._running?(this.update(s),this._currentTime+=s):this._logger.warn("The clock is not running, no step will be performed")}run(e,s){for(let r=0;r<e;r++)this.step(s??this._updateMs)}}var jp=o(296);class Kd{constructor(){this._toasterCss=jp.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(e){const s=document.createElement("span");return s.innerText=e,s}toast(e,s,r){this._initialize();const a=document.createElement("div");a.className="ex-toast-message";const l=e.split("[LINK]").map(y=>this._createFragment(y));if(s){const y=document.createElement("a");y.href=s,r?y.innerText=r:y.innerText=s,l.splice(1,0,y)}const _=document.createElement("div");l.forEach(y=>{_.appendChild(y)}),a.appendChild(_);const p=document.createElement("button");p.innerText="x",p.addEventListener("click",()=>{this._container.removeChild(a)}),a.appendChild(p);const m=y=>{if(y.key==="Escape")try{this._container.removeChild(a)}catch{}document.removeEventListener("keydown",m)};document.addEventListener("keydown",m);const w=this._container.firstChild;this._container.insertBefore(a,w)}}const Zp={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class Jd{get isTransitioning(){return this._isTransitioning}constructor(e,s){this._engine=e,this.events=new I,this._logger=ot.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new li,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const r in s){const a=s[r];this.add(r,a),r==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const e=this._deferredGoto;this._deferredGoto=void 0;const s=this._deferredTransition;this._deferredTransition=void 0;const r=this.getSceneInstance(e);r&&s&&s._addToTargetScene(this._engine,r),await this.swapScene(e),r&&s&&await this.playTransition(s,r)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(e,s){const r=s?.loader;r instanceof er?this.mainLoader=r:ih(r)?this.mainLoader=new r:this.mainLoader=new Vs;let a;if(s?.inTransition){const{inTransition:l}=s;a=l}if(this.startScene=e,a){const l=this.getSceneInstance(this.startScene);l&&(a._addToTargetScene(this._engine,l),this.swapScene(this.startScene).then(()=>this.playTransition(a,l)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(e){return this._sceneToLoader.get(e)}_getInTransition(e){var s;const r=this.scenes[e];if(!(r instanceof li||zi(r)))return(s=r?.transitions)===null||s===void 0?void 0:s.in}_getOutTransition(e){var s;const r=this.scenes[e];if(!(r instanceof li||zi(r)))return(s=r?.transitions)===null||s===void 0?void 0:s.out}getDeferredScene(){const e=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&e?e:null}getSceneDefinition(e){const s=this.scenes[e];if(s instanceof li||zi(s))return s;if(s)return s.scene}getSceneName(e){for(const[s,r]of Object.entries(this.scenes))if(r instanceof li){if(e===r)return s}else if(!zi(r)&&e===r.scene)return s;for(const[s,r]of Object.entries(this.scenes))if(zi(r)){if(e.constructor===r)return s}else if(!(r instanceof li)&&e.constructor===r.scene)return s;return null}assertAdded(e){return this}assertRemoved(e){return this}add(e,s){if(!(s instanceof li)&&!zi(s)){const{loader:r,transitions:a}=s,{in:l,out:_}=a??{};this._sceneToTransition.set(e,{in:l,out:_}),ih(r)?this._sceneToLoader.set(e,new r):r&&this._sceneToLoader.set(e,r)}return this.scenes[e]&&this._logger.warn("Scene",e,"already exists overwriting"),this.scenes[e]=s,this.assertAdded(e)}remove(e){if(e instanceof li||zi(e)){const s=e;for(const r in this.scenes)if(this.scenes.hasOwnProperty(r)){const a=this.scenes[r];let l;if(a instanceof li||zi(a)?l=a:l=a.scene,l===s){if(r===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${r}`);this._sceneToInstance.delete(r),this._sceneToTransition.delete(r),this._sceneToLoader.delete(r),delete this.scenes[r]}}}if(typeof e=="string"){if(e===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${e}`);this._sceneToInstance.delete(e),this._sceneToTransition.delete(e),this._sceneToLoader.delete(e),delete this.scenes[e]}}async goToScene(e,s){var r,a,l,_,p,m;const w=this.getSceneInstance(e);if(!w){this._logger.warn(`Scene ${e} does not exist! Check the name, are you sure you added it?`);return}const y=this.currentScene,A=this.currentSceneName,E=(a=(r=this._engine.input)===null||r===void 0?void 0:r.enabled)!==null&&a!==void 0?a:!0;this._isTransitioning=!0;const D=(l=this.getSceneInstance(A))===null||l===void 0?void 0:l.onTransition("out"),L=w?.onTransition("in");s={sourceOut:(_=this._getOutTransition(this.currentSceneName))!==null&&_!==void 0?_:D,destinationIn:(p=this._getInTransition(e))!==null&&p!==void 0?p:L,...s};const{sourceOut:O,destinationIn:X,sceneActivationData:H}=s,N=O??this._getOutTransition(this.currentSceneName),Q=X??this._getInTransition(e),Y=N?.hideLoader||Q?.hideLoader;Y&&this.maybeLoadScene(e,Y),this._emitEvent("navigationstart",A,e),N&&await this.playTransition(N,y),await this.maybeLoadScene(e,Y),Q&&await Q.onPreviousSceneDeactivate(this.currentScene),Q&&Q._addToTargetScene(this._engine,w),await this.swapScene(e,H),this._emitEvent("navigation",A,e),Q&&await this.playTransition(Q,w),this._emitEvent("navigationend",A,e),(m=this._engine.input)===null||m===void 0||m.toggleEnabled(E),this._isTransitioning=!1}getSceneInstance(e){const s=this.getSceneDefinition(e);if(!s)return;if(this._sceneToInstance.has(e))return this._sceneToInstance.get(e);if(s instanceof li)return this._sceneToInstance.set(e,s),s;const r=new s;return this._sceneToInstance.set(e,r),r}async maybeLoadScene(e,s=!1){var r;const a=(r=this._getLoader(e))!==null&&r!==void 0?r:new er,l=this.getSceneDefinition(e),_=this.getSceneInstance(e);l&&_&&!this._loadedScenes.has(_)&&(_.onPreLoad(a),_.events.emit("preload",{loader:a}),s?this._engine.load(a,s):await this._engine.load(a),this._loadedScenes.add(_))}async playTransition(e,s){var r,a,l,_,p,m,w;if(!this.isInitialized){this._deferredTransition=e;return}if(e){this.currentTransition=e;const y=(a=(r=s.input)===null||r===void 0?void 0:r.enabled)!==null&&a!==void 0?a:!0;(l=s.input)===null||l===void 0||l.toggleEnabled(!e.blockInput),(_=this._engine.input)===null||_===void 0||_.toggleEnabled(!e.blockInput),this.currentTransition._addToTargetScene(this._engine,s),await this.currentTransition._play(),(p=s.input)===null||p===void 0||p.toggleEnabled(y)}(m=this.currentTransition)===null||m===void 0||m.kill(),(w=this.currentTransition)===null||w===void 0||w.reset(),this.currentTransition=void 0}async swapScene(e,s){const r=this._engine;if(!this.isInitialized){this._deferredGoto=e;return}const a=this.getSceneInstance(e);if(a){const l=this.currentScene,_=a;if(this._logger.debug("Going to scene:",e),this.currentScene.isInitialized){const w={engine:r,previousScene:l,nextScene:_};await this.currentScene._deactivate(w),this.currentScene.events.emit("deactivate",new Ga(w,this.currentScene)),this.currentScene.input.clear()}const p=this._sceneToLoader.get(e);await p?.areResourcesLoaded(),this.currentScene=_,this.currentSceneName=e,r.screen.setCurrentCamera(_.camera),await this.currentScene._initialize(r);const m={engine:r,previousScene:l,nextScene:_,data:s};await this.currentScene._activate(m),this.currentScene.events.emit("activate",new Na(m,this.currentScene))}else this._logger.error("Scene",e,"does not exist!")}_emitEvent(e,s,r){const a=this.getSceneDefinition(s),l=this.getSceneDefinition(r);this.events.emit(e,{sourceScene:a,sourceName:s,destinationScene:l,destinationName:r})}}function tu(){const u={scope:(e,s)=>{const r=u.value;u.value=e;try{return s()}catch(a){throw a}finally{u.value=r}},value:void 0};return u}function eu(u){return u.value}const Mh={textureCollectInterval:6e4};class iu{constructor(e){this.options=e,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=s=>{if(this._running){for(const[r,[a,l]]of this._collectors.entries()){const _=this.options.getTimestamp();for(const[p,[m,w]]of this._collectionMap.entries()){if(r!==m||w+l>=_)continue;a(p)&&this._collectionMap.delete(p)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(e,s,r){this._collectors.set(e,[r,s])}addCollectableResource(e,s){this._collectionMap.set(s,[e,this.options.getTimestamp()])}touch(e){const s=this._collectionMap.get(e);s&&this._collectionMap.set(e,[s[0],this.options.getTimestamp()])}forceCollectAll(){for(const[e,[s]]of this._collectors.entries())for(const[r]of this._collectionMap.entries())s(r)&&this._collectionMap.delete(r)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}x();const $p={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Ts;(function(u){u[u.None=0]="None",u[u.Canvas=1]="Canvas",u[u.All=2]="All"})(Ts||(Ts={}));class Ke{static useEngine(){const e=eu(Ke.Context);if(!e)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return e}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(e){this.graphicsContext.snapToPixel=e}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,r,a,l,_,p,m,w,y;this.scope=Y=>Ke.Context.scope(this,Y),this.version=Hh,this.events=new I,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=Y=>{ot.getInstance().fatal(Y,Y.stack)},this._toaster=new Kd,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=Y=>{var J;Y.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",Y);const rt=document.createElement("div");rt.id="ex-webgl-graphics-context-lost",rt.style.position="absolute",rt.style.zIndex="99",rt.style.left="50%",rt.style.top="50%",rt.style.display="flex",rt.style.flexDirection="column",rt.style.transform="translate(-50%, -50%)",rt.style.backgroundColor="white",rt.style.padding="10px",rt.style.borderStyle="solid 1px";const Z=document.createElement("div");if(Z.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,rt.appendChild(Z),!((J=this.canvas)===null||J===void 0)&&J.parentElement){this.canvas.parentElement.appendChild(rt);const _t=Z.querySelector("#ex-webgl-graphics-reload");_t?.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new P,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],e={...Ke._DEFAULT_ENGINE_OPTIONS,...e},this._originalOptions=e,b.freeze(),this.browser=new Yd(window,document);const A=new Wc;if(!e.suppressMinimumBrowserFeatureDetection&&!(this._compatible=A.test())){const Y=document.createElement("div");if(Y.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(Y),A.failedTests.forEach(function(J){const rt=document.createElement("div");rt.innerText="Browser feature missing "+J,document.body.appendChild(rt)}),e.canvasElementId){const J=document.getElementById(e.canvasElementId);J&&J.parentElement.removeChild(J)}return}else this._compatible=!0;if(console.log&&!e.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${Hh})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),e.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=ot.getInstance(),this._logger.defaultLevel===Ht.Debug&&A.logBrowserFeatures(),this._logger.debug("Building engine..."),e.garbageCollection===!0?this.garbageCollectorConfig={...Mh}:e.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...Mh,...e.garbageCollection},this._garbageCollector=new iu({getTimestamp:Date.now}),this.canvasElementId=e.canvasElementId,e.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+e.canvasElementId),document.getElementById(e.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(e.canvasElementId)}else e.canvasElement?(this._logger.debug("Using Canvas element specified:",e.canvasElement),this.canvas=e.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!e.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",Y=>{Y.preventDefault()});let E=(s=e.displayMode)!==null&&s!==void 0?s:ve.Fixed;e.width&&e.height||e.viewport?(e.displayMode===void 0&&(E=ve.Fixed),this._logger.debug("Engine viewport is size "+e.width+" x "+e.height)):e.displayMode||(this._logger.debug("Engine viewport is fit"),E=ve.FitScreen),this.grabWindowFocus=e.grabWindowFocus,this.pointerScope=e.pointerScope,this._originalDisplayMode=E;let D,L,O,X,H,N;typeof e.antialiasing=="object"?{pixelArtSampler:D,nativeContextAntialiasing:O,multiSampleAntialiasing:N,filtering:H,canvasImageRendering:X}={...e.pixelArt?Zd:jd,...e.antialiasing}:(D=!!e.pixelArt,O=!1,N=e.antialiasing,X=e.antialiasing?"auto":"pixelated",H=e.antialiasing?le.Blended:le.Pixel),O&&N&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),e.pixelArt&&(L=.25),(!e.antialiasing||H===le.Pixel)&&(L=0),L=(a=(r=e.uvPadding)!==null&&r!==void 0?r:L)!==null&&a!==void 0?a:.01;let Q=b.isEnabled("use-canvas-context");if(!Q)try{this.graphicsContext=new Ji({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:D,antialiasing:O,multiSampleAntialiasing:N,uvPadding:L,powerPreference:e.powerPreference,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(l=e.handleContextLost)!==null&&l!==void 0?l:this._handleWebGLContextLost,handleContextRestored:e.handleContextRestored})}catch(Y){this._logger.warn(`Excalibur could not load webgl for some reason (${Y.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),Q=!0}Q&&(this.graphicsContext=new lo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:O,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting})),this.screen=new Ja({canvas:this.canvas,context:this.graphicsContext,antialiasing:O,canvasImageRendering:X,browser:this.browser,viewport:(_=e.viewport)!==null&&_!==void 0?_:e.width&&e.height?{width:e.width,height:e.height}:Ka.SVGA,resolution:e.resolution,displayMode:E,pixelRatio:e.suppressHiDPIScaling?1:(p=e.pixelRatio)!==null&&p!==void 0?p:null}),Kt.filtering=H,e.backgroundColor&&(this.backgroundColor=e.backgroundColor.clone()),this.maxFps=(m=e.maxFps)!==null&&m!==void 0?m:this.maxFps,this.fixedUpdateTimestep=(w=e.fixedUpdateTimestep)!==null&&w!==void 0?w:this.fixedUpdateTimestep,this.fixedUpdateFps=(y=e.fixedUpdateFps)!==null&&y!==void 0?y:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new Dh({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:Y=>this.onFatalException(Y)}),this.enableCanvasTransparency=e.enableCanvasTransparency,typeof e.physics=="boolean"?this.physics={...is(),enabled:e.physics}:(this.physics={...is()},Yr(this.physics,e.physics)),this.debug=new Xd(this),this.director=new Jd(this,e.scenes),this._initialize(e),window.___EXCALIBUR_DEVTOOL=this,Ke.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:e}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:s,showPlayerMessage:r}=this._originalOptions.configurePerformanceCanvas2DFallback;if(s===void 0&&(s=Ke._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),r===void 0&&(r=Ke._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!b.isEnabled("use-canvas-context")&&e&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===s.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let a=0;for(let _=0;_<this._fpsSamples.length;_++)a+=this._fpsSamples[_];const l=a/this._fpsSamples.length;this._fpsSamples.length===s.numberOfFrames&&l<=s.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),r&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var e,s,r;const a=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(a,this.canvas),this.canvas=a;const l={...this._originalOptions,antialiasing:this.screen.antialiasing},_=this._originalDisplayMode;this.graphicsContext=new lo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:l.antialiasing,backgroundColor:l.backgroundColor,snapToPixel:l.snapToPixel,useDrawSorting:l.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new Ja({canvas:this.canvas,context:this.graphicsContext,antialiasing:(e=l.antialiasing)!==null&&e!==void 0?e:!0,browser:this.browser,viewport:(s=l.viewport)!==null&&s!==void 0?s:l.width&&l.height?{width:l.width,height:l.height}:Ka.SVGA,resolution:l.resolution,displayMode:_,pixelRatio:l.suppressHiDPIScaling?1:(r=l.pixelRatio)!==null&&r!==void 0?r:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const p=l&&l.pointerScope===F.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(p,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,Ke.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(e){if(e<0){ot.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=e}addTimer(e){return this.currentScene.addTimer(e)}removeTimer(e){return this.currentScene.removeTimer(e)}addScene(e,s){return this.director.add(e,s),this}removeScene(e){this.director.remove(e)}add(e){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const s=this.director.getDeferredScene();s instanceof li?s.add(e):this.currentScene.add(e)}remove(e){e instanceof ke&&this.currentScene.remove(e),(e instanceof li||zi(e))&&this.removeScene(e),typeof e=="string"&&this.removeScene(e)}async goToScene(e,s){await this.scope(async()=>{await this.director.goToScene(e,s)})}screenToWorldCoordinates(e){return this.screen.screenToWorldCoordinates(e)}worldToScreenCoordinates(e){return this.screen.worldToScreenCoordinates(e)}_initialize(e){var s,r;this.pageScrollPreventionMode=e.scrollPreventionMode;const a=e&&e.pointerScope===F.Document?document:this.canvas,l=(r=(s=this._originalOptions)===null||s===void 0?void 0:s.grabWindowFocus)!==null&&r!==void 0?r:!0;this.input=new Eh({pointerTarget:a,grabWindowFocus:l,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new Wa(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new Oa(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!e.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(e){this._inputEnabled=e,this.input.toggleEnabled(this._inputEnabled)}onInitialize(e){}get isInitialized(){return this._isInitialized}async _overrideInitialize(e){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(e),this.events.emit("initialize",new xn(e,this)),this._isInitialized=!0)}_update(e){var s;if(this._isLoading){(s=this._loader)===null||s===void 0||s.onUpdate(this,e),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(e),this.currentScene.update(this,e),this.graphicsContext.updatePostProcessors(e),this.clock.__runScheduledCbs("postupdate"),this._postupdate(e),this.input.update()}_preupdate(e){this.emit("preupdate",new xs(this,e,this)),this.onPreUpdate(this,e)}onPreUpdate(e,s){}_postupdate(e){this.emit("postupdate",new bs(this,e,this)),this.onPostUpdate(this,e)}onPostUpdate(e,s){}_draw(e){var s,r;if(this.graphicsContext.backgroundColor=(s=this.currentScene.backgroundColor)!==null&&s!==void 0?s:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,e),this._isLoading){this._hideLoader||((r=this._loader)===null||r===void 0||r.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,e),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,e),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(e,s){this.emit("predraw",new vn(e,s,this)),this.onPreDraw(e,s)}onPreDraw(e,s){}_postdraw(e,s){this.emit("postdraw",new wn(e,s,this)),this.onPostDraw(e,s)}onPostDraw(e,s){}showDebug(e){this._isDebug=e}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(e,s){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let r;return e instanceof er?r=e:typeof e=="string"&&(this.director.configureStart(e,s),r=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(r??new Vs),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new Ea(this)),this._isReadyFuture.promise})}_mainloop(e){this.scope(()=>{this.emit("preframe",new Ba(this,this.stats.prevFrame));const s=e*this.timescale;this.currentFrameElapsedMs=s;const r=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=r,this.stats.currFrame.elapsedMs=s,this.stats.currFrame.fps=this.clock.fpsSampler.fps,qt.clear();const a=this.clock.now(),l=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=s;this._lagMs>=l;)this._update(l),this._lagMs-=l;else this._update(s);const _=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(s);const p=this.clock.now();this.stats.currFrame.duration.update=_-a,this.stats.currFrame.duration.draw=p-_,this.stats.currFrame.graphics.drawnImages=qt.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=qt.DrawCallCount,this.emit("postframe",new ka(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new Ia(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(e=!1){return new Promise(r=>{this._screenShotRequests.push({preserveHiDPIResolution:e,resolve:r})})}_checkForScreenShots(){for(const e of this._screenShotRequests){const s=e.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,r=e.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,a=document.createElement("canvas");a.width=s,a.height=r;const l=a.getContext("2d");l.imageSmoothingEnabled=this.screen.antialiasing,l.drawImage(this.canvas,0,0,s,r);const _=new Image,p=a.toDataURL("image/png");_.onload=()=>{e.resolve(_)},_.src=p}this._screenShotRequests.length=0}async load(e,s=!1){await this.scope(async()=>{try{if(e.isLoaded())return;this._loader=e,this._isLoading=!0,this._hideLoader=s,e instanceof Vs&&(e.suppressPlayButton=e.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await e.load()}catch(r){this._logger.error("Error loading resources, things may not behave properly",r),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}Ke.Context=tu(),Ke.InstanceCount=0,Ke._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:F.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Ts.Canvas,backgroundColor:$.fromHex("#2185d0")};class Qp extends qe{set maxWidth(e){this._text.maxWidth=e}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(e){this._font=e,this._text.font=e}get text(){return this._text.text}set text(e){this._text.text=e}get color(){return this._text.color}set color(e){this._text&&(this._text.color=e)}get opacity(){return this.graphics.opacity}set opacity(e){this.graphics.opacity=e}get spriteFont(){return this._spriteFont}set spriteFont(e){e&&(this._spriteFont=e,this._text.font=this._spriteFont)}constructor(e){super(e),this._font=new Hs,this._text=new Qn({text:"",font:this._font});const{text:s,pos:r,x:a,y:l,spriteFont:_,font:p,color:m,maxWidth:w}={text:"",...e};this.pos=r??(a&&l?z(a,l):this.pos),this.text=s??this.text,this.font=p??this.font,this.maxWidth=w??this.maxWidth,this.spriteFont=_??this.spriteFont,this._text.color=m??this.color;const y=this.get(Jt);y.anchor=B.Zero,y.use(this._text)}_initialize(e){super._initialize(e)}getTextWidth(){return this._text.width}}var Ps;(function(u){u.Circle="circle",u.Rectangle="rectangle"})(Ps||(Ps={}));class Kp extends qe{constructor(e){var s,r;super({width:(s=e.width)!==null&&s!==void 0?s:0,height:(r=e.height)!==null&&r!==void 0?r:0}),this._particlesToEmit=0,this._particlePool=new Xn(()=>new ho({}),L=>L,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=Ps.Rectangle,this.radius=0,this.particle={life:2e3,transform:bi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:a,x:l,y:_,z:p,pos:m,isEmitting:w,emitRate:y,emitterType:A,radius:E,random:D}={...e};this.particle={...this.particle,...a},this.pos=m??z(l??0,_??0),this.z=p??0,this.isEmitting=w??this.isEmitting,this.emitRate=y??this.emitRate,this.emitterType=A??this.emitterType,this.radius=E??this.radius,this.body.collisionType=dt.PreventCollision,this.random=D??new M}removeParticle(e){this.deadParticles.push(e)}emitParticles(e){var s;if(!(e<=0)){e=e|0;for(let r=0;r<e;r++){const a=this._createParticle();!((s=this===null||this===void 0?void 0:this.scene)===null||s===void 0)&&s.world&&(this.particle.transform===bi.Global?this.scene.world.add(a):this.addChild(a)),this._activeParticles.push(a)}}}clearParticles(){for(let e=0;e<this._activeParticles.length;e++)this.removeParticle(this._activeParticles[e])}_createParticle(){let e=0,s=0;const r=yt(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),a=yt(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),l=this.particle.startSize||yt(this.particle.minSize||5,this.particle.maxSize||5,this.random),_=a*Math.cos(r),p=a*Math.sin(r);if(this.emitterType===Ps.Rectangle)e=yt(0,this.width,this.random),s=yt(0,this.height,this.random);else if(this.emitterType===Ps.Circle){const w=yt(0,this.radius,this.random);e=w*Math.cos(r),s=w*Math.sin(r)}const m=this._particlePool.rent();return m.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:z(e,s),vel:z(_,p),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:l,graphic:this.particle.graphic,fade:this.particle.fade}),m.registerEmitter(this),this.particle.randomRotation&&(m.transform.rotation=yt(0,Math.PI*2,this.random)),this.particle.focus&&(m.focus=this.particle.focus.add(z(this.pos.x,this.pos.y)),m.focusAccel=this.particle.focusAccel),m}update(e,s){var r;super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let a=0;a<this.deadParticles.length;a++){!((r=this===null||this===void 0?void 0:this.scene)===null||r===void 0)&&r.world&&(this.scene.world.remove(this.deadParticles[a],!1),this._particlePool.return(this.deadParticles[a]));const l=this._activeParticles.indexOf(this.deadParticles[a]);l>-1&&this._activeParticles.splice(l,1)}this.deadParticles.length=0}}function Jp(u,e){}class To{constructor(e,s,r){var a;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=e,this.particle=r,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=s,this._particleLife=(a=this.particle.life)!==null&&a!==void 0?a:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(e,s){if(this._initialized)return;const r=this.emitter.maxParticles,a=this._numInputFloats,l=this._particleData,_=4,p=e.createBuffer(),m=e.createVertexArray();e.bindVertexArray(m),e.bindBuffer(e.ARRAY_BUFFER,p),e.bufferData(e.ARRAY_BUFFER,r*a*_,e.DYNAMIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,l);let w=0;e.vertexAttribPointer(0,2,e.FLOAT,!1,a*_,0),w+=_*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*_,w),w+=_*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*_,w),w+=_*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*_,w),w+=_*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*_,w),w+=_*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(m),this._buffers.push(p),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null);const y=e.createBuffer(),A=e.createVertexArray();e.bindVertexArray(A),e.bindBuffer(e.ARRAY_BUFFER,y),e.bufferData(e.ARRAY_BUFFER,r*a*_,e.DYNAMIC_DRAW),w=0,e.vertexAttribPointer(0,2,e.FLOAT,!1,a*_,0),w+=_*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*_,w),w+=_*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*_,w),w+=_*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*_,w),w+=_*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*_,w),w+=_*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(A),this._buffers.push(y),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(e){const s=this._particleIndex,r=this.maxParticles*this._numInputFloats,a=e*this._numInputFloats+s;for(let l=s;l<a;l+=this._numInputFloats){const _=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||W),p=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),m=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),w=p*Math.cos(_),y=m*Math.sin(_);let A=0,E=0;if(this.emitter.emitterType===Ps.Rectangle)A=this._random.floating(-.5,.5)*this.emitter.width,E=this._random.floating(-.5,.5)*this.emitter.height;else{const O=this._random.floating(0,this.emitter.radius);A=O*Math.cos(_),E=O*Math.sin(_)}const D=this.emitter.transform.apply(z(A,E)),L=[this.particle.transform===bi.Local?A:D.x,this.particle.transform===bi.Local?E:D.y,w,y,this.particle.randomRotation?yt(0,W,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(L,l%this._particleData.length)}a>=r?(this._wrappedParticles+=(a-r)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=e),this._particleIndex=a%r,this._emitted.push([this._particleLife,s])}_uploadEmitted(e){this._particleIndex!==this._uploadIndex&&(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),e.bindBuffer(e.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(e){var s;if(this._particleLife=(s=this.particle.life)!==null&&s!==void 0?s:this._particleLife,this._wrappedLife>0?this._wrappedLife-=e:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let r=this._emitted.length-1;r>=0;r--){const a=this._emitted[r];a[0]-=e,a[0]<=0&&this._emitted.splice(r,1)}this._emitted.sort((r,a)=>r[0]-a[0])}}draw(e){if(this._initialized){if(this._clearRequested?(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData),e.bindBuffer(e.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(e),e.bindVertexArray(this._currentVao),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const s=this._emitted[0][1]/this._numInputFloats;e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-s)*this._numInputFloats*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,s,this.maxParticles-s),e.endTransformFeedback(),e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,s),e.endTransformFeedback()}else e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,this.maxParticles),e.endTransformFeedback();e.bindVertexArray(null),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}To.GPU_MAX_PARTICLES=1e5;class tg extends qe{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get z(){return this.transform.z}set z(e){this.transform.z=e}constructor(e){super({name:"GpuParticleEmitter",width:e.width,height:e.height}),this.particle={life:2e3,transform:bi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new Jt,this.isEmitting=!1,this.emitRate=1,this.emitterType=Ps.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:s,maxParticles:r,x:a,y:l,z:_,pos:p,isEmitting:m,emitRate:w,emitterType:y,radius:A,random:E}={...e};this.maxParticles=j(r??this.maxParticles,0,To.GPU_MAX_PARTICLES),this.pos=p??z(a??0,l??0),this.z=_??0,this.isEmitting=m??this.isEmitting,this.emitRate=w??this.emitRate,this.emitterType=y??this.emitterType,this.radius=A??this.radius,this.particle={...this.particle,...s},this.random=E??new M,this.renderer=new To(this,this.random,this.particle)}_initialize(e){super._initialize(e);const s=e.graphicsContext;this.renderer.initialize(s.__gl,s)}update(e,s){super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(s)}emitParticles(e){e<=0||this.renderer.emitParticles(e|0)}clearParticles(){this.renderer.clearParticles()}draw(e,s){e.draw("ex.particle",this.renderer,s)}}class su extends ke{getGraphics(){return this._graphics}addGraphic(e,s){this._graphics.push(e),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,s?.offset&&(this._gfx.offset=s.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let e=this._tileBounds.clone();for(const s of this._graphics){const r=z(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:s.height-this.map.tileHeight));e=e.combine(s.localBounds.translate(r))}return e}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&this._graphics.splice(s,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(z(this.x,this.y))}get center(){return this.pos.add(z(0,this.map.tileHeight/2))}constructor(e,s,r,a){super([new et,new Jt({offset:r??B.Zero,onPostDraw:(E,D)=>this.draw(E,D)}),new cr(a)]),this.solid=!1,this.events=new I,this._tileBounds=new at,this._graphics=[],this._colliders=[],this.data=new Map,this.x=e,this.y=s,this.map=a,this._transform=this.get(et),this._isometricEntityComponent=this.get(cr);const l=this.map.tileWidth/2,_=this.map.tileHeight/2,p=(this.x-this.y)*l,m=(this.x+this.y)*_;this._transform.pos=z(p,m),this._isometricEntityComponent.elevation=a.elevation,this._gfx=this.get(Jt),this._gfx.isVisible=!1;const w=this.map.tileWidth,y=this.map.tileHeight,A=z(0,this.map.renderFromTopOfGraphic?y:0);this._gfx.localBounds=this._tileBounds=new at({left:-w/2,top:-y,right:w/2,bottom:y}).translate(A)}draw(e,s){const r=this.map.tileWidth/2;e.save(),e.translate(-r,0);for(const a of this._graphics)a.draw(e,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:a.height-this.map.tileHeight));e.restore()}}class eg extends ke{get visible(){return this.isVisible}set visible(e){this.isVisible=e}constructor(e){super([new et,new At({type:dt.Fixed}),new de,new As,new go((y,A)=>this.debug(y,A),!1)],e.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=z(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:s,tileWidth:r,tileHeight:a,columns:l,rows:_,renderFromTopOfGraphic:p,graphicsOffset:m,elevation:w}=e;this.transform=this.get(et),s&&(this.transform.pos=s),this.collider=this.get(de),this.collider&&this.collider.set(this._composite=new we([])),this.pointer=this.get(As),this.renderFromTopOfGraphic=p??this.renderFromTopOfGraphic,this.graphicsOffset=m??this.graphicsOffset,this.elevation=w??this.elevation,this.tileWidth=r,this.tileHeight=a,this.columns=l,this.rows=_,this._pointerEventDispatcher=new ph,this.tiles=new Array(l*_);for(let y=0;y<_;y++)for(let A=0;A<l;A++){const E=new su(A,y,this.graphicsOffset,this);this.tiles[A+y*l]=E,this.addChild(E),this._pointerEventDispatcher.addObject(E,D=>this.getTileByPoint(D.worldPos)===E,()=>!0)}this.pointer.localBounds=at.fromDimension(r*l*this.transform.scale.x,a*_*this.transform.scale.y,z(.5,0))}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:B.Zero;{const r=e.offset;return this._originalOffsets.set(e,r),r}}updateColliders(){this._composite.clearColliders();const e=this.get(et).pos;for(const s of this.tiles)if(s.solid)for(const r of s.getColliders()){const a=this._getOrSetColliderOriginalOffset(r);r.offset=this.tileToWorld(z(s.x,s.y)).sub(e).add(a).sub(z(this.tileWidth/2,this.tileHeight)),r.owner=this,this._composite.addCollider(r)}this.collider.update()}worldToTile(e){e=e.sub(this.transform.globalPos);const s=this.tileWidth/2,r=this.tileHeight/2;return z(~~((e.x/s+e.y/r)/2),~~((e.y/r-e.x/s)/2))}tileToWorld(e){const s=this.tileWidth/2,r=this.tileHeight/2,a=(e.x-e.y)*s,l=(e.x+e.y)*r;return z(a,l).add(this.transform.pos)}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const s=this.worldToTile(e);return this.getTile(s.x,s.y)}_getMaxZIndex(){let e=Number.NEGATIVE_INFINITY;for(const s of this.tiles){const r=s.get(et).z;r>e&&(e=r)}return e}debug(e,s){const{showAll:r,showPosition:a,positionColor:l,positionSize:_,showGrid:p,gridColor:m,gridWidth:w,showColliderGeometry:y}=s.isometric,{geometryColor:A,geometryLineWidth:E,geometryPointSize:D}=s.collider;if(e.save(),e.z=this._getMaxZIndex()+.5,r||p){for(let L=0;L<this.rows+1;L++){const O=this.tileToWorld(z(0,L)),X=this.tileToWorld(z(this.columns,L));e.drawLine(O,X,m,w)}for(let L=0;L<this.columns+1;L++){const O=this.tileToWorld(z(L,0)),X=this.tileToWorld(z(L,this.rows));e.drawLine(O,X,m,w)}}if(r||a)for(const L of this.tiles)e.drawCircle(this.tileToWorld(z(L.x,L.y)),_,l);if(r||y){for(const L of this.tiles)if(L.solid)for(const O of L.getColliders())O.debug(e,A,{lineWidth:E,pointSize:D})}e.restore()}}class Fh{constructor(e,s){this.id=Bt(),this._stopped=!1,this._sequenceBuilder=s,this._sequenceContext=new ar(e),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(e){this._actionQueue.update(e)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(e){return new Fh(e,this._sequenceBuilder)}}class ig{constructor(e){this.id=Bt(),this._actions=e}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}isComplete(e){return this._actions.every(s=>s.isComplete(e))}reset(){this._actions.forEach(e=>e.reset())}stop(){this._actions.forEach(e=>e.stop())}}class Tn{constructor(e,s){this.bounds=e,this.options=s,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...s},this.halfWidth=e.width/2,this.halfHeight=e.height/2}_split(){this._isDivided=!0;const e={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new Tn(new at({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),e),this.topRight=new Tn(new at({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),e),this.bottomLeft=new Tn(new at({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),e),this.bottomRight=new Tn(new at({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),e)}_insertIntoSubNodes(e){var s,r,a,l;!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.insert(e),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(e.bounds)&&this.topRight.insert(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.insert(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.insert(e)}insert(e){if(this._isDivided){this._insertIntoSubNodes(e);return}if(this.items.push(e),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const s of this.items)this._insertIntoSubNodes(s);this.items.length=0}}remove(e){var s,r,a,l;if(this.bounds.overlaps(e.bounds)){if(!this._isDivided){const _=this.items.indexOf(e);_>-1&&this.items.splice(_,1);return}!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.remove(e),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(e.bounds)&&this.topRight.remove(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.remove(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.remove(e)}}query(e){let s=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(e)&&(s=s.concat(this.topLeft.query(e))),this.topRight.bounds.overlaps(e)&&(s=s.concat(this.topRight.query(e))),this.bottomLeft.bounds.overlaps(e)&&(s=s.concat(this.bottomLeft.query(e))),this.bottomRight.bounds.overlaps(e)&&(s=s.concat(this.bottomRight.query(e)))),s=s.filter((r,a)=>s.indexOf(r)>=a),s}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let e=this.items;return this._isDivided&&(e=e.concat(this.topLeft.getAllItems()),e=e.concat(this.topRight.getAllItems()),e=e.concat(this.bottomLeft.getAllItems()),e=e.concat(this.bottomRight.getAllItems())),e=e.filter((s,r)=>e.indexOf(s)>=r),e}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(e){this.bounds.draw(e,$.Yellow),this._isDivided&&(this.topLeft.bounds.draw(e,$.Yellow),this.topRight.bounds.draw(e,$.Yellow),this.bottomLeft.bounds.draw(e,$.Yellow),this.bottomRight.bounds.draw(e,$.Yellow))}}function sg(u){return!!u._initialize}function ng(u){return!!u.onAdd}function rg(u){return!!u.onRemove}function og(u){return!!u.onInitialize}function ag(u){return!!u._preupdate}function hg(u){return!!u.onPreUpdate}function lg(u){return!!u.onPostUpdate}function cg(u){return!!u.onPostUpdate}function dg(u){return!!u.onAdd}function ug(u){return!!u.onRemove}function _g(u){return!!u.onPreDraw}function fg(u){return!!u.onPostDraw}class pg{constructor(e,s=!1){this.path=e,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new Yn(e,"arraybuffer",s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){const e=await this._resource.load();this._stream=new nu(e),this._gif=new ru(this._stream);const s=this._gif.images.map(r=>new Di(r.src,!1));return await Promise.all(s.map(r=>r.load())),this.data=this._images=s,this._sprites=this._images.map(r=>r.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(e=0){var s;return(s=this._sprites[e])!==null&&s!==void 0?s:null}toSpriteSheet(){const e=this._sprites;return e.length?new zs({sprites:e}):null}toAnimation(e){var s;const r=(s=this._gif)===null||s===void 0?void 0:s.images;if(r?.length){const a=r.map((l,_)=>{var p;return{graphic:this._sprites[_],duration:((p=this._gif)===null||p===void 0?void 0:p.frames[_].delayMs)||void 0}});return this._animation=new xi({frames:a,frameDuration:e}),this._animation}return null}get readCheckBytes(){var e,s;return(s=(e=this._gif)===null||e===void 0?void 0:e.checkBytes)!==null&&s!==void 0?s:[]}}const Po=u=>u.reduce(function(e,s){return e*2+s},0),Bh=u=>{const e=[];for(let s=7;s>=0;s--)e.push(!!(u&1<<s));return e};class nu{constructor(e){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=s=>{const r=[];for(let a=0;a<s;a++)r.push(this.readByte());return r},this.read=s=>{let r="";for(let a=0;a<s;a++)r+=String.fromCharCode(this.readByte());return r},this.readUnsigned=()=>{const s=this.readBytes(2);return(s[1]<<8)+s[0]},this.data=new Uint8Array(e),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const gg=function(u,e){let s=0;const r=function(E){let D=0;for(let L=0;L<E;L++)e.charCodeAt(s>>3)&1<<(s&7)&&(D|=1<<L),s++;return D},a=[],l=1<<u,_=l+1;let p=u+1,m=[];const w=function(){m=[],p=u+1;for(let E=0;E<l;E++)m[E]=[E];m[l]=[],m[_]=null};let y=0,A=0;for(;;){if(A=y,y=r(p),y===l){w();continue}if(y===_)break;if(y<m.length)A!==l&&m.push(m[A].concat(m[y][0]));else{if(y!==m.length)throw new Error("Invalid LZW code.");m.push(m[A].concat(m[A][0]))}a.push.apply(a,m[y]),m.length===1<<p&&p<12&&p++}return a};class ru{constructor(e){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=s=>{const r=[];for(let a=0;a<s;a++){const l=this._st.readBytes(3);r.push(l)}return r},this.readSubBlocks=()=>{let s,r;r="";do s=this._st.readByte(),r+=this._st.read(s);while(s!==0);return r},this.parseHeader=()=>{const s={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(s.sig=this._st.read(3),s.ver=this._st.read(3),s.sig!=="GIF")throw new Error("Not a GIF file.");s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned(),this._currentFrameCanvas.width=s.width,this._currentFrameCanvas.height=s.height;const r=Bh(this._st.readByte());s.gctFlag=r.shift(),s.colorResolution=Po(r.splice(0,3)),s.sortedFlag=r.shift(),s.globalColorTableSize=Po(r.splice(0,3)),s.backgroundColorIndex=this._st.readByte(),s.pixelAspectRatio=this._st.readByte(),s.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<s.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(s)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=s=>{const r=m=>{this.checkBytes.push(this._st.readByte());const w=Bh(this._st.readByte());return m.reserved=w.splice(0,3),m.disposalMethod=Po(w.splice(0,3)),m.userInputFlag=w.shift(),m.transparentColorFlag=w.shift(),m.delayTime=this._st.readUnsigned(),m.transparentColorIndex=this._st.readByte(),m.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(m)&&this.checkBytes.push(this._handler.gce),m},a=m=>{m.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(m)&&this.checkBytes.push(this._handler.com)},l=m=>{this.checkBytes.push(this._st.readByte()),m.ptHeader=this._st.readBytes(12),m.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(m)&&this.checkBytes.push(this._handler.pte)},_=m=>{const w=A=>{this.checkBytes.push(this._st.readByte()),A.unknown=this._st.readByte(),A.iterations=this._st.readUnsigned(),A.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(A)&&this.checkBytes.push(this._handler.app)},y=A=>{A.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[A.identifier]&&this._handler.app[A.identifier](A)&&this.checkBytes.push(this._handler.app[A.identifier])};switch(this.checkBytes.push(this._st.readByte()),m.identifier=this._st.read(8),m.authCode=this._st.read(3),m.identifier){case"NETSCAPE":w(m);break;default:y(m);break}},p=m=>{m.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(m)&&this.checkBytes.push(this._handler.unknown)};switch(s.label=this._st.readByte(),s.label){case 249:s.extType="gce",this._gce=r(s);break;case 254:s.extType="com",a(s);break;case 1:s.extType="pte",l(s);break;case 255:s.extType="app",_(s);break;default:s.extType="unknown",p(s);break}},this.parseImg=s=>{var r;const a=(p,m)=>{const w=new Array(p.length),y=p.length/m,A=(O,X)=>{const H=p.slice(X*m,(X+1)*m);w.splice.apply(w,[O*m,m].concat(H))},E=[0,4,2,1],D=[8,8,4,2];let L=0;for(let O=0;O<4;O++)for(let X=E[O];X<y;X+=D[O])A(X,L),L++;return w};s.leftPos=this._st.readUnsigned(),s.topPos=this._st.readUnsigned(),s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned();const l=Bh(this._st.readByte());s.lctFlag=l.shift(),s.interlaced=l.shift(),s.sorted=l.shift(),s.reserved=l.splice(0,2),s.lctSize=Po(l.splice(0,3)),s.lctFlag&&(s.lctBytes=this.parseColorTableBytes(1<<s.lctSize+1)),s.lzwMinCodeSize=this._st.readByte();const _=this.readSubBlocks();s.pixels=gg(s.lzwMinCodeSize,_),s.interlaced&&(s.pixels=a(s.pixels,s.width)),!((r=this._gce)===null||r===void 0)&&r.delayTime&&(s.delayMs=this._gce.delayTime*10),this.frames.push(s),this.arrayToImage(s,s.lctFlag?s.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(s)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const s={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(s.sentinel)){case"!":s.type="ext",this.parseExt(s);break;case",":s.type="img",this.parseImg(s);break;case";":s.type="eof",this._handler.eof&&this._handler.eof(s)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+s.sentinel.toString(16))}s.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(s,r)=>{var a,l,_,p;const m=document.createElement("canvas");m.width=s.width,m.height=s.height;const w=m.getContext("2d"),y=w.getImageData(0,0,m.width,m.height);let A=-1;!((a=this._gce)===null||a===void 0)&&a.transparentColorFlag&&(A=this._gce.transparentColorIndex);for(let D=0;D<s.pixels.length;D++){const L=s.pixels[D],O=r[L];L===A?y.data.set([0,0,0,0],D*4):y.data.set([...O,255],D*4)}if(w.putImageData(y,0,0),((l=this._gce)===null||l===void 0?void 0:l.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((_=this._gce)===null||_===void 0?void 0:_.disposalMethod)===2&&(!((p=this._hdr)===null||p===void 0)&&p.gctFlag)){const D=r[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${D[0]}, ${D[1]}, ${D[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(m,s.leftPos,s.topPos,s.width,s.height);const E=new Image;E.src=this._currentFrameCanvas.toDataURL(),this.images.push(E)},this._st=e,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class mg{constructor(e,s,{bustCache:r,...a}={}){this.path=e,this.family=s,this._isLoaded=!1,this._resource=new Yn(e,"blob",r),this._options=a}async load(){if(this.isLoaded())return this.data;try{const e=await this._resource.load(),s=URL.createObjectURL(e);this.data||(this.data=new FontFace(this.family,`url(${s})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(e){throw`Error loading FontSource from path '${this.path}' with error [${e.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(e){return new Hs({family:this.family,...this._options,...e})}}const ou=tu(),vg=/^\s*(?:function)?\*/;function au(u){return typeof u!="function"?!1:vg.test(Function.prototype.toString.call(u))?!0:Object.getPrototypeOf?Object.getPrototypeOf(u)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function hu(...u){var e;const s=ot.getInstance();let r,a,l,_;au(u[0])&&(a=globalThis,r=u[0],l=u[1]),au(u[1])&&(a=u[0],r=u[1],l=u[2]),u[1]instanceof Ke&&(a=u[0],_=u[1],r=u[2],l=u[3]),u[0]instanceof Ke&&(a=globalThis,_=u[0],r=u[1],l=u[2]);const p=eu(ou),m=l?.timing,w=p?!1:(e=l?.autostart)!==null&&e!==void 0?e:!0;let y;try{y=_??Ke.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let A=!1,E=!1,D=!1;const L=r.bind(a),O=L();let X;const H=new Promise((Q,Y)=>{X=J=>{try{if(D){E=!0,Q();return}const{done:rt,value:Z}=ou.scope(!0,()=>O.next(J));if(rt||D){E=!0,Q();return}Z instanceof Promise?Z.then(()=>{y.clock.schedule(X,0,m)}):Z===void 0||Z===void 0?y.clock.schedule(X,0,m):y.clock.schedule(X,Z||0,m)}catch(rt){Y(rt);return}},w&&(A=!0,X(y.clock.elapsed()))}),N={isRunning:()=>A&&!D&&!E,isComplete:()=>E,cancel:()=>{D=!0},start:()=>(A?s.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(L)):(A=!0,X(y.clock.elapsed())),N),generator:O,done:H,then:H.then.bind(H),[Symbol.iterator]:()=>O};return N}class So extends ke{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(e){var s,r,a,l;super(),this._logger=ot.getInstance(),this.transform=new et,this.graphics=new Jt,this._completeFuture=new P,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=e.duration,this.easing=(s=e.easing)!==null&&s!==void 0?s:Ot.Linear,this.direction=(r=e.direction)!==null&&r!==void 0?r:"out",this.hideLoader=(a=e.hideLoader)!==null&&a!==void 0?a:!1,this.blockInput=(l=e.blockInput)!==null&&l!==void 0?l:!1,this.transform.coordPlane=Pe.Screen,this.transform.pos=B.Zero,this.transform.z=1/0,this.graphics.anchor=B.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(e,s){this.complete||(this._currentDistance+=j(s/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=j(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=j(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(e){}onStart(e){}onUpdate(e){}onEnd(e){}onReset(){}reset(){this.started=!1,this._completeFuture=new P,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(e,s){const r=s;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),r.world.entityManager.getById(this.id))return this._co;this._engine=e,r.add(this);const a=this;return this._co=hu(e,function*(){for(;!a.complete;){const l=yield;a.updateTransition(a._engine,l),a._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class wg extends So{constructor(e){var s,r;super({...e,duration:(s=e.duration)!==null&&s!==void 0?s:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(r=e.color)!==null&&r!==void 0?r:$.Black}onInitialize(e){this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=new nr({width:e.screen.resolution.width,height:e.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=e}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class xg extends So{constructor(e){super({direction:"in",...e}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(e){this.image=await e.engine.screenshot(!0),await this.image.decode()}onInitialize(e){this.engine=e,this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=Di.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=z(1/e.screen.pixelRatio,1/e.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class bg extends So{constructor(e){var s;super({direction:"in",...e}),this._easing=Ot.Linear,this.name=`Slide#${this.id}`,this.slideDirection=e.slideDirection,this.transform.coordPlane=Pe.World,this.graphics.forceOnScreen=!0,this._easing=(s=e.easingFunction)!==null&&s!==void 0?s:this._easing,this._vectorEasing=Ot.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(e){this._image=await e.engine.screenshot(!0),await this._image.decode(),this._screenCover=Di.fromHtmlImageElement(this._image).toSprite()}onInitialize(e){switch(this._engine=e,this.slideDirection){case"up":{this._directionOffset=z(0,-e.screen.resolution.height);break}case"down":{this._directionOffset=z(0,e.screen.resolution.height);break}case"left":{this._directionOffset=z(-e.screen.resolution.width,0);break}case"right":{this._directionOffset=z(e.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=z(1/e.screen.pixelRatio,1/e.screen.pixelRatio)}onUpdate(e){this._camera.pos=this._vectorEasing(e,this._destinationCameraPosition,this._startCameraPosition,1)}}class kh extends Qt{constructor(e){super(),this.color=$.Black,this.thickness=1;const{start:s,end:r,color:a,thickness:l}=e;this.start=s,this.end=r,this.color=a??this.color,this.thickness=l??this.thickness,this._localBounds=this._calculateBounds();const{width:_,height:p}=this._localBounds;this.width=_,this.height=p}get localBounds(){return this._localBounds}_calculateBounds(){const e=this.end.sub(this.start).normal(),s=this.thickness/2,r=[this.start.add(e.scale(s)),this.end.add(e.scale(s)),this.end.add(e.scale(-s)),this.start.add(e.scale(-s))];return at.fromPoints(r)}_drawImage(e,s,r){e.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new kh({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class Lh extends gn{get points(){return this._points}set points(e){this._points=e;const s=this.minPoint;this.width=this._points.reduce((r,a)=>Math.max(a.x,r),0)-s.x,this.height=this._points.reduce((r,a)=>Math.max(a.y,r),0)-s.y,this.flagDirty()}get minPoint(){const e=this._points.reduce((r,a)=>Math.min(a.x,r),1/0),s=this._points.reduce((r,a)=>Math.min(a.y,r),1/0);return z(e,s)}constructor(e){super(e),this._points=[],this.points=e.points,this.filtering=le.Blended,this.rasterize()}clone(){return new Lh({points:this.points.map(e=>e.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){if(this.points&&this.points.length){e.beginPath();const s=this.minPoint.negate(),r=this.points[0].add(s);e.moveTo(r.x,r.y),this.points.forEach(a=>{e.lineTo(a.x+s.x,a.y+s.y)}),e.lineTo(r.x,r.y),e.closePath(),this.color&&e.fill(),this.strokeColor&&e.stroke()}}}var rs;(function(u){u.Stretch="stretch",u.Tile="tile",u.TileFit="tile-fit"})(rs||(rs={}));class Uh extends Qt{constructor(e){super(e),this._logger=ot.getInstance(),this._config=e,this._imgSource=e.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(e,s=!1){this._config.width=e,s&&this._initialize()}setTargetHeight(e,s=!1){this._config.height=e,s&&this._initialize()}setMargins(e,s,r,a,l=!1){this._config.sourceConfig.leftMargin=e,this._config.sourceConfig.topMargin=s,this._config.sourceConfig.rightMargin=r,this._config.sourceConfig.bottomMargin=a,l&&this._initialize()}setStretch(e,s,r=!1){e==="horizontal"?this._config.destinationConfig.horizontalStretch=s:e==="vertical"?this._config.destinationConfig.verticalStretch=s:(this._config.destinationConfig.horizontalStretch=s,this._config.destinationConfig.verticalStretch=s),r&&this._initialize()}getConfig(){return this._config}_drawTile(e,s,r,a,l,_,p){const m=_||0,w=p||0;let y,A,E,D;const L=this._getNumberOfTiles(s.width,r.x,a),O=this._getNumberOfTiles(s.height,r.y,l);for(let X=0;X<L;X++)for(let H=0;H<O;H++){let{tempSize:N,tempPosition:Q}=this._calculateParams(X,L,s.width,r.x,this._config.destinationConfig.horizontalStretch);y=N,A=Q,{tempSize:N,tempPosition:Q}=this._calculateParams(H,O,s.height,r.y,this._config.destinationConfig.verticalStretch),E=N,D=Q,e.drawImage(s,0,0,s.width,s.height,m+A,w+D,y,E)}}_drawImage(e,s,r){this._imgSource.isLoaded()?(this._drawTile(e,this._canvasA,new B(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(e,this._canvasB,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(e,this._canvasC,new B(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(e,this._canvasD,new B(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(e,this._canvasE,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasF,new B(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasG,new B(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasH,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasI,new B(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const e=this._canvasA.getContext("2d");e?.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const s=this._canvasB.getContext("2d");s?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const r=this._canvasC.getContext("2d");r?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const a=this._canvasD.getContext("2d");a?.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const l=this._canvasE.getContext("2d");l?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const _=this._canvasF.getContext("2d");_?.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const p=this._canvasG.getContext("2d");p?.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const m=this._canvasH.getContext("2d");m?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const w=this._canvasI.getContext("2d");w?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new Uh(this._config)}_getNumberOfTiles(e,s,r){switch(r){case rs.Stretch:return 1;case rs.Tile:return Math.ceil(s/e);case rs.TileFit:return Math.ceil(s/e)}}_calculateParams(e,s,r,a,l){switch(l){case rs.Stretch:return{tempPosition:0,tempSize:a};case rs.Tile:return e===s-1?{tempPosition:e*r,tempSize:r-(s*r-a)}:{tempPosition:e*r,tempSize:r};case rs.TileFit:const _=a/s;return{tempPosition:e*_,tempSize:_}}}}class zh extends xi{constructor(e){super({...e,frames:e.animation.frames.slice(),strategy:e.animation.strategy,frameDuration:e.animation.frameDuration,speed:e.animation.speed,reverse:e.animation.isReversed}),this._ready=new P,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...e.sourceView},this._tiledWidth=e.width,this._tiledHeight=e.height;const s=[];for(let r=0;r<this.frames.length;r++){const a=this.frames[r].graphic;if(a&&a instanceof mi){const l=new jn({image:a.image,width:e.width,height:e.height,sourceView:{...a.sourceView},wrapping:e.wrapping,filtering:e.filtering});this.frames[r].graphic=l,l.ready.then(()=>{l.sourceView={...l.sourceView,...this._sourceView}}),s.push(l.ready)}}Promise.all(s).then(()=>this._ready.resolve())}static fromAnimation(e,s){return new zh({width:e.width,height:e.height,...s,animation:e})}_updateSourceView(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof mi&&(s.sourceView={...s.sourceView,...this._sourceView})}}get sourceView(){return gi(this._sourceView,()=>this._updateSourceView())}set sourceView(e){this._sourceView=gi(e,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof mi&&(s.sourceView.height=this._tiledHeight||s.height,s.destSize.height=this._tiledHeight||s.height,s.sourceView.width=this._tiledWidth||s.width,s.destSize.width=this._tiledWidth||s.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(e){this._tiledWidth=e,this._updateWidthHeight()}set height(e){this._tiledHeight=e,this._updateWidthHeight()}}const lu=5,Pn={},yg=()=>{for(const u in Pn)Pn[u]=0},Eo=(u,e)=>{const s=b.isEnabled("suppress-obsolete-message");Pn[u]<lu&&!s&&(ot.getInstance().warn(u),console.trace&&e.showStackTrace&&console.trace()),Pn[u]++};function Ag(u){return u={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...u},function(e,s,r){if(r&&!(typeof r.value=="function"||typeof r.get=="function"||typeof r.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const l=`${`${e.name||""}${e.name&&s?".":""}${s||""}`} is marked obsolete: ${u.message}`+(u.alternateMethod?` Use ${u.alternateMethod} instead`:"");Pn[l]||(Pn[l]=0);const _=r?{...r}:e;if(!r){class p extends _{constructor(...w){Eo(l,u),super(...w)}}return p}return r&&r.value?(_.value=function(){return Eo(l,u),r.value.apply(this,arguments)},_):(r&&r.get&&(_.get=function(){return Eo(l,u),r.get.apply(this,arguments)}),r&&r.set&&(_.set=function(){return Eo(l,u),r.set.apply(this,arguments)}),_)}}class Cg{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const e=new P;return this._queue.push(e),e.promise}dequeue(e){this._queue.shift().resolve(e)}}class Tg{constructor(e){this._count=e,this._waitQueue=new Cg}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(e=1){if(e!==0){for(;e!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),e--;this._count+=e}}}const Hh="0.30.3";return x(),h})())}(Zh)),Zh.exports}/*! For license information please see excalibur-perlin.min.js.LICENSE.txt */var Eu;function pw(){return Eu||(Eu=1,function(d,t){(function(i,n){d.exports=n(fw())})(self,i=>(()=>{var n={"./src/perlin-noise.ts":(f,g,v)=>{v.r(g),v.d(g,{PerlinDrawer2D:()=>I,PerlinGenerator:()=>P});var x=v("excalibur");function b(F,R,S){return R+F*(S-R)}function T(F){return F*F*F*(F*(6*F-15)+10)}class P{constructor(R){var S,M,W,U;this._perm=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],this._p=new Uint8Array(512),this._defaultPerlinOptions={octaves:1,frequency:1,amplitude:1,persistance:.5},this.persistance=.5,this.amplitude=1,this.frequency=1,this.octaves=1,R={...this._defaultPerlinOptions,...R},this.persistance=(S=R.persistance)!==null&&S!==void 0?S:this.persistance,this.amplitude=(M=R.amplitude)!==null&&M!==void 0?M:this.amplitude,this.frequency=(W=R.frequency)!==null&&W!==void 0?W:this.frequency,this.octaves=(U=R.octaves)!==null&&U!==void 0?U:this.octaves,R.seed?this._random=new x.Random(R.seed):this._random=new x.Random,this._perm=this._random.shuffle(this._perm);for(let V=0;V<512;V++)this._p[V]=255&this._perm[V%256]}noise(){let R=this.amplitude,S=this.frequency,M=0,W=0;for(let U=0;U<this.octaves;U++){switch(arguments.length){case 1:M+=this._noise1d(arguments[0]*S)*R;break;case 2:M+=this._noise2d(arguments[0]*S,arguments[1]*S)*R;break;case 3:M+=this._noise3d(arguments[0]*S,arguments[1]*S,arguments[2]*S)*R;break;default:throw new Error("Invalid arguments for perlin noise")}W+=R,R*=this.persistance,S*=2}return M/W}sequence(R,S){S||(S=1/R);const M=new Array(R);for(let W=0;W<R;W++)M[W]=this.noise(W*S);return M}grid(R,S,M){M||(M=1/Math.min(R,S));const W=new Array(R*S);for(let U=0;U<S;U++)for(let V=0;V<R;V++)W[V+U*R]=this.noise(V*M,U*M);return W}_gradient3d(R,S,M,W){const U=15&R,V=U<8?S:M,j=U<4?M:U===12||U===14?S:W;return((1&U)==0?V:-V)+((2&U)==0?j:-j)}_gradient2d(R,S,M){const W=(1&R)==0?S:M;return(2&R)==0?-W:W}_gradient1d(R,S){return(1&R)==0?-S:S}_noise1d(R){const S=255&Math.floor(R);return(b(T(R-=Math.floor(R)),this._gradient1d(this._p[S],R),this._gradient1d(this._p[S+1],R-1))+1)/2}_noise2d(R,S){const M=255&Math.floor(R),W=255&Math.floor(S);R-=Math.floor(R),S-=Math.floor(S);const U=T(R),V=T(S),j=this._p[M]+W,q=this._p[M+1]+W;return(b(V,b(U,this._gradient2d(this._p[j],R,S),this._gradient2d(this._p[q],R-1,S)),b(U,this._gradient2d(this._p[j+1],R,S-1),this._gradient2d(this._p[q+1],R-1,S-1)))+1)/2}_noise3d(R,S,M){const W=255&Math.floor(R),U=255&Math.floor(S),V=255&Math.floor(M);R-=Math.floor(R),S-=Math.floor(S),M-=Math.floor(M);const j=T(R),q=T(S),nt=T(M),ht=this._p[W]+U,xt=this._p[W+1]+U,gt=this._p[ht]+V,yt=this._p[xt]+V,St=this._p[ht+1]+V,B=this._p[xt+1]+V;return(b(nt,b(q,b(j,this._gradient3d(this._p[gt],R,S,M),this._gradient3d(this._p[yt],R-1,S,M)),b(j,this._gradient3d(this._p[St],R,S-1,M),this._gradient3d(this._p[B],R-1,S-1,M))),b(q,b(j,this._gradient3d(this._p[gt+1],R,S,M-1),this._gradient3d(this._p[yt+1],R-1,S,M-1)),b(j,this._gradient3d(this._p[St+1],R,S-1,M-1),this._gradient3d(this._p[B+1],R-1,S-1,M-1))))+1)/2}}class I{constructor(R,S){this.generator=R,this.colorFcn=M=>M<.5?x.Color.Black:x.Color.White,S&&(this.colorFcn=S)}image(R,S){const M=document.createElement("img"),W=document.createElement("canvas");W.width=R,W.height=S;const U=W.getContext("2d");return this.draw(U,0,0,R,S),M.src=W.toDataURL(),M}draw(R,S,M,W,U){const V=this.generator.grid(W,U),j=R.getImageData(S,M,W,U);for(let q=0;q<U;q++)for(let nt=0;nt<W;nt++){const ht=4*(nt+q*j.width),xt=V[nt+W*q],gt=this.colorFcn(xt);j.data[ht]=gt.r,j.data[ht+1]=gt.g,j.data[ht+2]=gt.b,j.data[ht+3]=Math.floor(255*gt.a)}R.putImageData(j,S,M)}}},excalibur:f=>{f.exports=i}},o={};function h(f){var g=o[f];if(g!==void 0)return g.exports;var v=o[f]={exports:{}};return n[f](v,v.exports,h),v.exports}h.n=f=>{var g=f&&f.__esModule?()=>f.default:()=>f;return h.d(g,{a:g}),g},h.d=(f,g)=>{for(var v in g)h.o(g,v)&&!h.o(f,v)&&Object.defineProperty(f,v,{enumerable:!0,get:g[v]})},h.o=(f,g)=>Object.prototype.hasOwnProperty.call(f,g),h.r=f=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(f,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(f,"__esModule",{value:!0})};var c={};return(()=>{h.r(c),h.d(c,{PerlinDrawer2D:()=>f.PerlinDrawer2D,PerlinGenerator:()=>f.PerlinGenerator});var f=h("./src/perlin-noise.ts")})(),c})())}(jh)),jh.exports}var gw=pw();const mw=new gw.PerlinGenerator({seed:Date.now(),octaves:3,frequency:24,amplitude:.91,persistance:.95}),Es=new vf({pos:Dt(0,0),tileWidth:64,tileHeight:32,columns:25,rows:25});let En=0,vw=[Hi.getSprite(0,0),Hi.getSprite(1,0),Hi.getSprite(2,0),Hi.getSprite(3,0),Hi.getSprite(4,0),Hi.getSprite(5,0),Hi.getSprite(6,0),Hi.getSprite(0,1),Hi.getSprite(1,1),Hi.getSprite(2,1)];for(const d of Es.tiles){if(Cc(En,Es.columns,Es.rows)){if(console.log("edge tile",d),d.x==0){let t=new In({useAnchor:!0,members:[{graphic:Mo.getSprite(0,0),offset:Dt(0,16)},{graphic:Bs.tree.toSprite(),offset:Dt(-6,-24)}]});console.log("adding tree graphics"),d.addGraphic(t)}else if(d.y==0&&d.x!=0||d.y==Es.rows-1&&d.x!=0){console.log("top edge tile",En);const t=Bs.fence.toSprite();let i=new In({useAnchor:!0,members:[{graphic:Mo.getSprite(0,0),offset:Dt(0,-32)},{graphic:t,offset:Dt(0,-32)}]});console.log("adding top edge graphic"),d.addGraphic(i)}else{console.log("right edge tile",En);let t=new In({useAnchor:!0,members:[{graphic:Mo.getSprite(0,0),offset:Dt(0,-32)}]});console.log("adding top edge graphic"),d.addGraphic(t)}d.solid=!0,d.addCollider(wf.Polygon([Dt(0,17),Dt(32,1),Dt(63,17),Dt(32,33)]))}else{console.log("not edge tile",En);let t=Mo.getSprite(0,0);const n=mw.grid(Es.columns,Es.rows)[En];let o=new qn;if(n>.55){const h=o.pickOne(vw);let c=o.integer(16,32),f=-32;console.log(c,f);let g=new In({useAnchor:!0,members:[{graphic:t,offset:Dt(0,-32)},{graphic:h,offset:Dt(c,f)}]});console.log("adding normal tile graphic with overlay"),d.addGraphic(g)}else{console.log("adding normal tile graphic");let h=new In({useAnchor:!0,members:[{graphic:t,offset:Dt(0,-32)}]});console.log("adding normal tile graphic with overlay"),d.addGraphic(h)}}En++}Es.updateColliders();class ww extends Fv{gameUI;arena;darkPlayer;lightPlayer;statusBar;burnDown;enemyWaveManager;gameState={waveNumber:0,enemiesRemaining:0,darkEnemiesDefeated:0,lightEnemiesDefeated:0,darkExp:0,lightExp:0,gameDuration:0};stateSignal=new gs("stateUpdate");constructor(){super()}onActivate(t){this.gameUI=vt.create(xf.App,new Iu,Iu.template),this.gameUI.model.register(this),this.arena=Es,this.add(this.arena),this.darkPlayer=new Df,this.add(this.darkPlayer),this.darkPlayer.pos=jv(this.arena),this.lightPlayer=new Rf,this.add(this.lightPlayer),this.darkPlayer.registerPartner(this.lightPlayer),this.lightPlayer.registerPartner(this.darkPlayer),this.enemyWaveManager=new dw(this,this.lightPlayer,this.darkPlayer,this.arena),this.enemyWaveManager?.init();const i=this.engine.screen.contentArea.width,n=this.engine.screen.contentArea.height;this.statusBar=new uw(Dt(i,n)),this.add(this.statusBar),this.stateSignal.listen(this.stateUpdate.bind(this)),this.burnDown=new _w(Dt(i,20),Dt(0,n-20),60,this),this.add(this.burnDown),this.enemyWaveManager?.startWave()}onDeactivate(t){this.gameUI?.destroy(),this.gameUI=void 0,this.darkPlayer?.kill(),this.lightPlayer?.kill(),this.enemyWaveManager?.endWave()}onPreUpdate(t,i){this.enemyWaveManager?.update(i)}stateUpdate(t){const[i,n]=t.detail.params;this.gameState[i]=n}switchPlayerFocus(){this.darkPlayer?.isPlayerActive&&!this.lightPlayer?.isPlayerActive?(this.darkPlayer.isPlayerActive=!1,this.lightPlayer.isPlayerActive=!0,this.camera.strategy.lockToActor(this.lightPlayer)):(this.darkPlayer.isPlayerActive=!0,this.lightPlayer.isPlayerActive=!1,this.camera.strategy.lockToActor(this.darkPlayer))}}class Iu{startbutton=()=>{this.owner?.enemyWaveManager?.startWave()};stopbutton=()=>{this.owner?.enemyWaveManager?.endWave()};switchButton=()=>{this.owner?.switchPlayerFocus()};register=t=>{this.owner=t};owner;static template=`
    <style> 
        #gameUI{
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
         user-select: none;
         -webkit-user-select: none;
        -ms-user-select: none;
        -moz-user-select: none;

        -webkit-touch-callout: none; /* disables long-press context menu on iOS Safari */
        }

        #gameUI button{
          pointer-events: all;
        }
    </style> 
    <div id='gameUI'> 
         
    </div>`}await vt.create(document.body,xf,kv).attached;const Mf=new Rv({resolution:{width:640,height:360},viewport:{width:640,height:360},canvasElementId:"cnv",displayMode:Iv.FitScreenAndZoom,pixelArt:!0,scenes:{game:{scene:new ww}},pixelRatio:2});await Mf.start(bf);Mf.goToScene("game");
