(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const h of o)if(h.type==="childList")for(const c of h.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function i(o){const h={};return o.integrity&&(h.integrity=o.integrity),o.referrerPolicy&&(h.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?h.credentials="include":o.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function n(o){if(o.ep)return;o.ep=!0;const h=i(o);fetch(o.href,h)}})();class Fs{constructor(){this.state="created",this.host=null,this.bindings=[],this.views=[],this.animations=[],this.animationQueue=[],this.destroyed="",this.moved=""}static create(t,i={},n,o={parent:null,prepare:!0,sibling:null}){const h=new Fs;if(h.model=i,h.element=n??t,h.parent=o.parent??Ct,h.host=o.host??h.parent.host,h.sibling=o.sibling??null,n instanceof HTMLTemplateElement||n?.tagName==="TEMPLATE"){const c=n.content.cloneNode(!0);if(c.children.length===1)return Ct.create(t,i,c.firstElementChild,o);h.views=[...c.children].map(g=>Ct.create(t,i,g,{...o,parent:h})),h.state="rendered"}else h.bindings.push(...Ct.parse(h.element,i,h,o.parent));return h.parentElement=n!=null?t:t.ownerDocument.documentElement,h.views.length>1?(h.attached=Promise.all(h.views.map(c=>c.attached)),h.detached=Promise.all(h.views.map(c=>c.detached))):(h.attached=new Promise(c=>{h.t=c}),h.detached=new Promise(c=>{h.i=c})),h}get lastElement(){return this.render==null&&(this.render=!(this.element.hasAttribute?.("PUI-UNRENDERED")??!1)),this.render?this.element:this.bindings.flatMap(n=>n.views).slice(-1)[0]?.lastElement}destroy(){this.views.forEach(t=>t.destroy()),this.element.classList?.add("pui-removing"),this.destroyed="queue",Ct.destroyed.push(this)}terminate(){Promise.all(this.getAnimations()).then(()=>{const t=this.element.parentElement;t?.removeChild(this.element),this.i?.(),this.dispatchEvent(t,"removed"),this.bindings.forEach(n=>n.unbind());const i=this.parent.views.findIndex(n=>n===this);i>-1&&this.parent.views.splice(i,1)}),this.destroyed="destroyed"}move(t){this.moved="queue",this.element.classList?.add("pui-moving"),this.sibling=t}play(t,i){return typeof t=="string"&&(t=this.animations.find(n=>n.name===t).clone()),t.element=i,t.state="pending",this.animationQueue.push(t),this.updateAnimations(performance.now()),t}updateFromUI(){this.views.forEach(t=>t.updateFromUI()),this.bindings.forEach(t=>t.updateFromUI())}updateToUI(){const t=this.state==="created";switch(t||(this.views.forEach(i=>i.updateToUI()),this.bindings.forEach(i=>i.updateToUI())),this.state){case"created":if(this.element.classList?.add("pui-adding"),this.render=!(this.element.hasAttribute?.("PUI-UNRENDERED")??!1),this.render){const i=this.parent?.parent;let o=(i?.render??!1?this.sibling:i?.sibling)??null;o=(o instanceof Fs?o.lastElement:o)??null;const h=this.parentElement??Ct.parentElement(this.element,this.parent);h.insertBefore(this.element,o?.nextSibling??null),this.dispatchEvent(h,"added")}this.t(),this.state="attaching";break;case"attaching":this.getAnimations(!1).length===0&&(this.element.classList?.remove("pui-adding"),this.state="attached");break;case"attached":this.state="rendered";break}t&&(this.views.forEach(i=>i.updateToUI()),this.bindings.forEach(i=>i.updateToUI()))}updateAtEvents(){this.views.forEach(t=>t.updateAtEvents()),this.bindings.forEach(t=>t.updateAtEvents())}updateAnimations(t){for(;this.animationQueue[0]?.state==="finished";)this.animationQueue.shift().destroy();for(let i=0;i<this.animationQueue.length;i++){const n=this.animationQueue[i];n.state==="pending"&&(n.isBlocked(t)||(n.state="playing",n.startTime=t,n.animation=n.element.animate(n.keyframes,n.options),n.finished=n.animation.finished,n.finished.then(()=>{n.state="finished",this.updateAnimations(performance.now())})))}}updateMove(){switch(this.moved){case"queue":this.moved="move";break;case"move":if(this.getAnimations().length===0){const t=this.parentElement??Ct.parentElement(this.element,this.parent);let i=(this.sibling instanceof Fs?this.sibling.lastElement:this.sibling)??null;if(this.render)t.insertBefore(this.element,i?.nextSibling??null);else{const n=this.bindings.flatMap(o=>o.views);for(const o of n)t.insertBefore(o.element,i?.nextSibling??null),i=o.element}this.element.classList?.remove("pui-moving"),this.moved="",this.sibling=null}break}this.bindings.forEach(t=>t.updateMove()),this.views.forEach(t=>t.updateMove())}getAnimations(t=!0){return(this.element.getAnimations?.({subtree:t})??[]).filter(i=>i.playState!=="finished"&&i.effect?.getTiming().iterations!==1/0).map(i=>i.finished)}dispatchEvent(t,i){if(t!=null){const n=new CustomEvent(`pui-${i}`,{detail:{model:this.model.$model??this.model,context:this.model,element:this.element,view:this},bubbles:!0,cancelable:!0});t.dispatchEvent(n)}}}class sc{constructor(){this.fromUI=!1,this.toUI=!0,this.atEvent=!1,this.oneTime=!1,this.views=[],this.firstUpdate=!0,this.events=[],this.triggerAtEvent=t=>{t.type==="change"?this.events.push(t):Ct.resolveValue(this.object,this.property).call(this.object.$model,t,this.object.$model,this.element,this.attribute,this.object)},this.twoWayBindingEvent=t=>{const{target:i,property:n}=Ct.resolveProperty(this.object,this.property),o=t.detail;if(o!==this.lastUIValue){let h=o;h!==void 0&&h!==this.lastValue&&Ct.resolveValue(this.object,this.property)==="number"&&!isNaN(h)&&(h=+h),i[n]=h}},this.id=++Ct.id}get element(){return this.$element==null&&(this.$element=typeof this.selector=="string"?this.context.querySelector(this.selector):this.selector),this.$element}set element(t){this.$element=t}static create(t){const i=new sc,n=t.property?.split(":")??[],o=n.shift(),h=typeof t.attribute!="boolean"?(t.attribute??"innerText").split(":"):[],c=typeof t.attribute!="boolean"?h.shift():t.attribute;if(i.parent=t.parent??Ct,i.object="$model"in t.object?t.object:{$model:t.object},i.object.$parent==null){const g=i.parent.parent?.object?.$parent;g!=null&&(i.object.$parent=g)}return i.property=o,i.propertyArguments=n,i.context=t.context??document,i.selector=t.selector,i.attribute=c,i.attributeArguments=h,i.value=t.value??i.value,i.template=t.template??i.template,i.fromUI=t.fromUI??i.fromUI,i.toUI=t.toUI??i.toUI,i.atEvent=t.atEvent??i.atEvent,i.oneTime=t.oneTime??i.oneTime,i.addListener(),typeof i.fromUI!="boolean"&&(i.fromUI=i.fromUI.bind(i)),typeof i.toUI!="boolean"&&(i.toUI=i.toUI.bind(i)),i}destroy(){this.element=null,this.removeListener(),this.views.forEach(t=>t.destroy())}unbind(){Ct.unbind(this)}addListener(){this.atEvent&&(this.toUI=!1,this.fromUI=!1,this.element.addEventListener(this.attribute,this.triggerAtEvent)),this.toUI&&this.fromUI&&customElements.get(this.element.tagName.toLowerCase())!=null&&this.element.addEventListener(this.attribute,this.twoWayBindingEvent)}removeListener(){this.atEvent&&this.element.removeEventListener(this.attribute,this.triggerAtEvent),this.toUI&&this.fromUI&&customElements.get(this.element.tagName.toLowerCase())!=null&&this.element.removeEventListener(this.attribute,this.twoWayBindingEvent)}updateFromUI(){if(this.fromUI===!1||this.firstUpdate){this.firstUpdate=!1,this.views.forEach(o=>o.updateFromUI());return}const{target:t,property:i}=Ct.resolveProperty(this.element,this.attribute),n=t[i];if(n!==this.lastUIValue){let o=this.fromUI!==!0?this.fromUI(n,this.lastUIValue,this.property,this.object):n;if(this.lastUIValue=n,o!==void 0&&o!==this.lastValue){this.lastValue=o;const{target:h,property:c}=Ct.resolveProperty(this.object,this.property);Ct.resolveValue(this.object,this.property)==="number"&&!isNaN(o)&&(o=+o),h[c]=o}else this.lastValue=o;this.parent.host?.dispatchEvent(new CustomEvent(i,{detail:o}))}this.views.forEach(o=>o.updateFromUI())}updateToUI(){if(this.toUI===!1){this.views.forEach(i=>i.updateToUI());return}let t=Ct.resolveValue(this.object,this.property);if(this.template!=null)if(this.template instanceof HTMLElement)if(typeof this.attribute=="boolean"){if(t=(t??!1)!==!1,t!==this.lastValue){const i=this.toUI!==!0?this.toUI(t,this.lastValue,this.property,this.object,this.value):t;i!==void 0&&i!==this.lastUIValue&&(i===this.attribute?this.views.push(Fs.create(this.element.parentElement,this.object,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:this.element})):this.views.pop()?.destroy(),this.lastValue=t,this.lastUIValue=i)}}else{let i=!1,n=!1;t==null&&(t=[]);const o=this.propertyArguments[0],h=this.lastValue??[];if(t.length!==h.length)i=!0;else for(let A=0,S=t.length;A<S;A++){let P,I;o==null?t[A]!==h[A]&&(i=!0,n=!0):(P=Ct.resolveValue(t[A]??{},o),I=Ct.resolveValue(h[A]??{},o),P!==I&&(i=!0),t[A]!==h[A]&&(n=!0))}if(!i)if(n){const A=this.toUI!==!0?this.toUI(t,h,this.property,this.object,this.value):t;return this.updateViews(t,A)}else return this.updateViews();const c=this.toUI!==!0?this.toUI(t,h,this.property,this.object,this.value):t;if(c==null)return this.updateViews();const g=this.lastUIValue??[];let _=0;for(let A=0,S=c.length,P=0;A<S;A++,P++){let I,F;if(o==null?(I=c[A],F=g[P]):(I=Ct.resolveValue(c[A]??{},o),F=Ct.resolveValue(g[P]??{},o)),I===F)_++;else break}if(_===c.length&&c.length===g.length)return this.updateViews(t,c);const v=this.views.splice(0,_);let x=v[v.length-1];for(let A=_,S=c.length,P=_;A<S;A++,P++){const I=c[A],F=this.views.shift();if(F==null){const L={$model:{[this.attribute]:I},$parent:this.object},G=Fs.create(this.element.parentElement,L,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:x??this.element});v.push(G),x=G;continue}const R=o==null?I:Ct.resolveValue(I??{},o),E=F?.model.$model[this.attribute],M=o==null?E:Ct.resolveValue(E??{},o);if(R===M){v.push(F),F.move(x??this.element),x=F;continue}if(!c.slice(A).map(L=>o==null?L:Ct.resolveValue(L??{},o)).includes(M)){F.destroy(),A--,x=F;continue}this.views.unshift(F);let V=!1;for(let L=0,G=this.views.length;L<G;L++){const j=this.views[L],X=j?.model.$model[this.attribute],rt=o==null?X:Ct.resolveValue(X??{},o);if(R===rt){v.push(...this.views.splice(L,1)),j.move(x??this.element),V=!0,x=j;break}}if(!V){const L={$model:{[this.attribute]:I},$parent:this.object},G=Fs.create(this.element.parentElement,L,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:x??this.element});v.push(G),x=G}}return this.views.forEach(A=>A.destroy()),this.views=v,this.updateViews(t,c)}else{const i=Ct.resolveValue(this.object,this.attribute);if((t??i)==null||(t??i)!==this.lastValue){this.lastUIValue!=null&&(this.lastUIValue.destroy(),this.lastUIValue=null);const n=t==null?i:i.create(t),o=i.template;this.lastValue=t??i;const h=this.element.nodeType===8?this.element.parentElement:this.element,c=this.element.nodeType===8?this.element:null;if(this.lastUIValue=Ct.create(h,n,o,{parent:this,prepare:!0,sibling:c}),this.attributeArguments[0]!=null&&t!=null){const{target:g,property:_}=Ct.resolveProperty(this.object,this.attributeArguments[0]);g[_]=this.lastUIValue}this.views.push(this.lastUIValue)}}else if(t!==this.lastValue){const i=this.toUI!==!0?this.toUI(t,this.lastValue,this.property,this.object,this.value):t;if(i!==void 0&&i!==this.lastUIValue){const{target:n,property:o}=Ct.resolveProperty(this.element,this.attribute);n[o]=i,"setAttribute"in this.element&&this.element.setAttribute(this.attribute,i),this.lastValue=t,this.lastUIValue=i}}this.updateViews()}updateAtEvents(){let t=this.events.shift();for(;t!=null;)Ct.resolveValue(this.object,this.property).call(this.object.$model,t,this.object.$model,this.element,this.attribute,this.object),t=this.events.shift();this.views.forEach(i=>i.updateAtEvents())}updateMove(){this.views.forEach(t=>t.updateMove())}updateViews(t,i){t==null?this.views.forEach(n=>n.updateToUI()):(this.views.forEach((n,o)=>{const h=i[o];typeof h=="object"&&(h.$index=o),n.model.$model[this.attribute]=h,n.model.$index=o,n.updateToUI()}),this.lastValue=[...t],this.lastUIValue=[...i]),this.oneTime&&(this.toUI=!1,this.fromUI=!1)}}var Rl;class He{static initialize(t=!0){if(!this.initialized&&(this.initialized=!0,this.initializeLoadPromise(),t!==!1)){if(t===!0){const i=()=>{this.update(),requestAnimationFrame(i)};requestAnimationFrame(i);return}setInterval(()=>this.update(),1e3/t)}}static import(t){this.initializeLoadPromise(),document.body.insertAdjacentHTML("afterbegin",`<object type="text/pui" data="${t}"></object>`)}static ready(){return this.initialize(),this.loadPromise.then(()=>(this.hoist()&&document.head.insertAdjacentHTML("beforeend",'<style> object[type="text/pui"] { height: 0; position: absolute; } </style>'),this.registrations))}static create(t=document.body,i={},n=null,o={parent:null,prepare:!0,sibling:null}){if(typeof t=="string"&&(t=document.querySelector(t)),(typeof i=="string"||i instanceof HTMLElement)&&(console.warn("Old parameter order to UI.create!"),[i,n]=[n,i]),typeof n=="string"){const c=t?.ownerDocument?.defaultView!=null?t.ownerDocument:document;if(n.startsWith("#"))n=c.querySelector(n).cloneNode(!0);else{const g=c.createElement("template");g.innerHTML=o.prepare?this.prepare(n):n,n=g}}const h=Fs.create(t,i,n,o);return h.parent===Ct&&this.views.push(h),this.initialize(),h}static play(t,i){return typeof t=="string"?(t=this.globals.animations.find(n=>n.name===t).clone(),t.play(i)):t.play()}static queue(t){this.h.push(t),this.initialize()}static register(t,i){if(typeof t=="string"){this.registrations[t]=i;return}this.registerWebComponent(i,t)}static parse(t,i,n,o){const h=[];if(t instanceof Comment)return[];if(t instanceof HTMLTemplateElement||t.tagName==="TEMPLATE")return[];if(t.nodeType===3){let c=t.textContent,g=c.match(this.regexValue);for(;g!=null;){const _=g[1];let v=g[2];c=g[3];let x=!1;v.startsWith("|")&&(x=!0,v=v.slice(1).trimStart());const A=v.match(this.regexConditionalValue);let S,P=!0;if(v.startsWith("(")){const F=`_pui${this.bindingCounter++}`;Object.defineProperty(i,F,{get:new Function(`return ${v}`)}),v=F}else A&&(v=A[3],S=`${A[2]}${A[1]}`,P=function(F,R,E,M,V){const L=V[0]==="=";return V=V.slice(2,-1),!!F===L?V:""});let I=t.cloneNode();t.textContent=_,this.parentElement(t,o).insertBefore(I,t.nextSibling),h.push(this.bind({selector:I,attribute:"textContent",object:i,property:v,parent:n,oneTime:x,value:S,toUI:P})),t=I,I=t.cloneNode(),I.textContent=c,this.parentElement(t,o).insertBefore(I,t.nextSibling),t=I,g=c.match(this.regexValue)}}else{const c=t.getAttribute("pui")??"";if(c.trim().length>0){const g=c.split(";");for(let _ of g)_=_.trim(),_.length>0&&t.setAttribute(`pui.${this.bindingCounter++}`,_)}if(t.removeAttribute("pui"),h.push(...Object.keys(t.attributes??[]).reverse().map(g=>{const _=[];if(t instanceof Comment)return[];const v=t.attributes[g];if(v.name.startsWith("pui.")){const P=v.value.match(this.regexAttribute);let[I,F,R,E,M]=P,V,L,G=!1;if(R!=="@"){const j=F.match(/^'(.*?)'$/);if(j!=null)V=j[1],t.setAttribute("value",V),F=t.nodeName.toLowerCase()==="option"?"selected":"checked",E=X=>X?V:void 0,R=X=>X===V;else if(F==="")if(E===">"){const[X,rt]=M.split(":");if(X.length>0){const{target:lt,property:yt}=this.resolveProperty(i,X);lt[yt]=t}return(rt??"").length>0&&Ct.queue(()=>{const{target:lt,property:yt}=this.resolveProperty(i,rt);lt[yt]=n}),[]}else({element:t,template:L}=this.replaceWithComment(t,n,o,v.name)),F=R==="=",R=!0,E==="|"&&(G=!0);else if(E==="="&&R==="="){if(!t.tagName.includes("-")){t.setAttribute("pui-unrendered","");const X=this.parentNode(t,o);X.nodeType!==8?{element:t,template:L}=this.replaceWithComment(t,n,o,v.name,L):t=X}L=F,R=!0}else E==="*"?{element:t,template:L}=this.replaceWithComment(t,n,o,v.name):E==="|"?G=!0:F!=="checked"&&t.setAttribute(F,t.getAttribute?.(F)??"")}return[this.bind({selector:t,attribute:F,value:V,object:i,property:M,template:L,toUI:typeof R=="string"?R==="<":R,fromUI:typeof E=="string"?E===">":E,atEvent:R==="@",parent:n,oneTime:G})]}const x=[v.value];let A=0,S=x[A].match(this.regexValue);for(;S!=null;){let{before:P,property:I,after:F}=S.groups,R=!1;I.startsWith("|")&&(R=!0,I=I.slice(1).trimStart());const E=I.match(this.regexConditionalValue);let M;E&&(I=E[3],M=`${E[2]}${E[1]}`),_.push(this.bind({selector:t,attribute:v.name,object:i,property:I,oneTime:R,toUI(V,L,G,j,X){if(this.oneTime){const lt=x.indexOf(G);lt>-1&&(x[lt]=Ct.resolveValue(j,G),x[lt-1]+=x[lt]+x[lt+1],x.splice(lt,2))}const rt=x.map((lt,yt)=>{if(yt%2===0)return lt;const wt=lt.match(Ct.regexSplitConditionalValue);if(wt){const Pt=lt===`${G}${X}`?V:Ct.resolveValue(j,wt[1]),Dt=wt[2]==="=";return!!Pt===Dt?wt[3].slice(1,-1):""}return lt===G?V:Ct.resolveValue(j,lt)}).join("");return t.setAttribute(v.name,rt),rt},parent:n,value:M})),x[A++]=P,x[A++]=`${I}${M??""}`,x[A]=F,S=x[A].match(this.regexValue)}return _}).flat()),t instanceof Comment)return h.filter(g=>g.template!=null?!0:(g.unbind(),!1));if(!this.leaveAttributes)for(let g=Object.keys(t.attributes??[]).length-1;g>=0;g--){const _=t.attributes[Object.keys(t.attributes??[])[g]];_.name.startsWith("pui.")&&t.removeAttribute(_.name)}h.push(...Array.from(t.childNodes).map(g=>this.parse(g,i,n,o)).flat())}return h}static bind(t){return sc.create(t)}static unbind(t){if(t.destroy(),t.parent!==Ct){const i=t.parent.bindings,n=i.indexOf(t);n>-1&&i.splice(n,1)}}static update(){this.u.forEach(i=>i()),this.u=this.h,this.h=[],this.views.forEach(i=>i.updateToUI()),this.views.forEach(i=>i.updateFromUI()),this.views.forEach(i=>i.updateAtEvents());const t=performance.now();[...this.views,this.globals].forEach(i=>i.updateAnimations(t)),this.views.forEach(i=>{i.updateMove()});for(let i=0;i<this.destroyed.length;i++){const n=this.destroyed[i];switch(n.destroyed){case"queue":n.state==="rendered"?n.destroyed="destroy":n.updateToUI();break;case"destroy":{n.terminate();const o=this.destroyed.findIndex(h=>n===h);o>-1&&(this.destroyed.splice(o,1),i--)}}}}static resolveProperty(t,i){i=i.replace("[",".").replace("]",".");const n=i.split(".").filter(h=>(h??"").length>0);for(;n[0]==="$parent"&&t.$parent!=null;)t=t.$parent,n.shift();let o=t;if(n[0]==="$index"&&this.objectHas(o,"$index"))return{target:o,property:n[0]};for(this.objectHas(o,"$model")&&(o=t.$model);n.length>1;)o=o[n.shift()];return{target:o,property:n[0]}}static resolveValue(t,i){let n=0;do{const{target:o,property:h}=this.resolveProperty(t,i);if(o!=null&&this.objectHas(o,h))return o[h];t=t.$parent}while(t!=null&&n++<1e3);if(i in this.registrations)return this.registrations[i]}static initializeLoadPromise(){this.loadPromise==null&&(this.loadPromise=new Promise(t=>this.loadResolve=t),document.defaultView?.addEventListener("load",this.loaded))}static hoist(t=document,i=document){t!==i&&((i.querySelectorAll("style")??[]).forEach(h=>{t.head.appendChild(h.cloneNode(!0))}),(i.querySelectorAll("template")??[]).forEach(h=>{t.head.appendChild(h.cloneNode(!0))}));const n=i.querySelectorAll('object[type="text/pui"]')??[];let o=n.length>0;return n.forEach(h=>{o=this.hoist(t,h.contentDocument)||o}),o}static objectHas(t,i){try{return i in t}catch{return!1}}static replaceWithComment(t,i,n,o,h){const c=document.createComment(o);return this.parentNode(t,n).insertBefore(c,t),this.parentNode(t,n).removeChild(t),t.removeAttribute(o),h=h??t,t=c,t.parentNode instanceof DocumentFragment&&(i.element=t),{element:t,template:h}}static parentElement(t,i){const n=t.parentElement;if(n!=null)return n;for(;i!=null&&(i.element==null||i.element===t);)i=i.parent;return i?.element}static parentNode(t,i){const n=t.parentNode;if(n!=null)return n;for(;i!=null&&(i.element==null||i.element===t);)i=i.parent;return i?.element}static prepare(t){let i=t;t="";let n=i.match(this.regexReplace);for(;n!=null;){const[o,h,c,g]=n;c.match(/\S\s*===/)?t+=`${h.trimEnd()}br PUI.${this.bindingCounter++}="${c}"`:t+=`${h} PUI.${this.bindingCounter++}="${c}" `,i=g,n=i.match(this.regexReplace)}return t+=i,t}static parseAttribute(t,i,n,o,h,c){const g=c.match(this.regexAttribute);let[_,v,x,A,S]=g,P,I,F=!1;if(x!=="@"){const R=v.match(/^'(.*?)'$/);if(R!=null)P=R[1],t.setAttribute("value",P),v=t.nodeName.toLowerCase()==="option"?"selected":"checked",A=E=>E?P:void 0,x=E=>E===P;else if(v==="")if(A===">"){const{target:E,property:M}=this.resolveProperty(i,S);return E[M]=t,[]}else({element:t,template:I}=this.replaceWithComment(t,n,o,h)),v=x==="=",x=!0,A==="|"&&(F=!0);else if(A==="="&&x==="="){const E=this.parentNode(t,o);E.nodeType!==8?{element:t,template:I}=this.replaceWithComment(t,n,o,h,I):t=E,I=v,F=!0,x=!0}else A==="*"?{element:t,template:I}=this.replaceWithComment(t,n,o,h):A==="|"?F=!0:v!=="checked"&&t.setAttribute(v,"")}return[this.bind({selector:t,attribute:v,value:P,object:i,property:S,template:I,toUI:typeof x=="string"?x==="<":x,fromUI:typeof A=="string"?A===">":A,atEvent:x==="@",parent:n,oneTime:F})]}static registerWebComponent(t,i){t??(t=i.webComponent);class n extends HTMLElement{constructor(){super(),this.webComponentComponent=i,this.webComponentUIView=null,this.attachShadow({mode:"open"})}connectedCallback(){this.initialize()}disconnectedCallback(){this.terminate()}attributeChangedCallback(c,g,_){this.initialize(),this.webComponentUIView.model[c]=_}initialize(){if(this.webComponentUIView==null){const c="create"in this.webComponentComponent?this.webComponentComponent.create():new this.webComponentComponent;c.webComponentHost=this,this.webComponentUIView=Ct.create(this.shadowRoot,c,this.webComponentComponent.template,{host:this.shadowRoot?.host})}}terminate(){this.webComponentUIView!=null&&this.webComponentUIView.destroy()}}n.observedAttributes=i.observedAttributes??[],n.observedProperties=i.observedProperties??n.observedAttributes;const o=[...new Set([...n.observedAttributes,...n.observedProperties])];for(const h of o)Object.defineProperty(n.prototype,h,{configurable:!0,enumerable:!1,get(){return this.webComponentUIView.model[h]},set(c){n.observedAttributes.includes(h)?this.setAttribute(h,c):(this.initialize(),this.webComponentUIView.model[h]=c)}});return customElements.define(t,n),n}}Rl=He;He.initialized=!1;He.id=0;He.views=[];He.destroyed=[];He.globals=new Fs;He.registrations={};He.leaveAttributes=!1;He.regexReplace=/([\S\s]*?)\\?\$\{([^}]*?[<=@!]=[*=>|][^}]*?)\}([\S\s]*)/m;He.regexAttribute=/^\s*(\S*?)\s*([<=@!])=([*=>|])\s*(\S*?)\s*$/;He.regexValue=/(?<before>[\S\s]*?)\\?\$\{\s*(?<property>[\s\S]*?)\s*\}(?<after>[\S\s]*)/m;He.regexConditionalValue=/^\s*(.+?)\s*([=!])\s*(\S+)/;He.regexSplitConditionalValue=/^(.+?)([=!])(.*)/;He.bindingCounter=0;He.u=[];He.h=[];He.loaded=()=>{Rl.loadResolve(),document.defaultView?.removeEventListener("load",Rl.loaded)};function Hm(){let d=window,t=window;for(;;)try{if(d.parent===d){t=d;break}else d.parent.UI!=="guarantee-condition-always-true"&&(d=d.parent)}catch{break}return t}const Dl=Hm();"UI"in Dl||(Dl.UI=He);const Ct=Dl.UI;/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var Om={851:(d,t,i)=>{i.d(t,{A:()=>_});var n=i(1),o=i.n(n),h=i(935),c=i.n(h),g=c()(o());g.push([d.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const _=g},296:(d,t,i)=>{i.d(t,{A:()=>_});var n=i(1),o=i.n(n),h=i(935),c=i.n(h),g=c()(o());g.push([d.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const _=g},935:d=>{d.exports=function(t){var i=[];return i.toString=function(){return this.map(function(o){var h="",c=typeof o[5]<"u";return o[4]&&(h+="@supports (".concat(o[4],") {")),o[2]&&(h+="@media ".concat(o[2]," {")),c&&(h+="@layer".concat(o[5].length>0?" ".concat(o[5]):""," {")),h+=t(o),c&&(h+="}"),o[2]&&(h+="}"),o[4]&&(h+="}"),h}).join("")},i.i=function(o,h,c,g,_){typeof o=="string"&&(o=[[null,o,void 0]]);var v={};if(c)for(var x=0;x<this.length;x++){var A=this[x][0];A!=null&&(v[A]=!0)}for(var S=0;S<o.length;S++){var P=[].concat(o[S]);c&&v[P[0]]||(typeof _<"u"&&(typeof P[5]>"u"||(P[1]="@layer".concat(P[5].length>0?" ".concat(P[5]):""," {").concat(P[1],"}")),P[5]=_),h&&(P[2]&&(P[1]="@media ".concat(P[2]," {").concat(P[1],"}")),P[2]=h),g&&(P[4]?(P[1]="@supports (".concat(P[4],") {").concat(P[1],"}"),P[4]=g):P[4]="".concat(g)),i.push(P))}},i}},1:d=>{d.exports=function(t){var i=t[1],n=t[3];if(!n)return i;if(typeof btoa=="function"){var o=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),h="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(o),c="/*# ".concat(h," */");return[i].concat([c]).join(`
`)}return[i].join(`
`)}}},sf={};function Fe(d){var t=sf[d];if(t!==void 0)return t.exports;var i=sf[d]={id:d,exports:{}};return Om[d](i,i.exports,Fe),i.exports}Fe.n=d=>{var t=d&&d.__esModule?()=>d.default:()=>d;return Fe.d(t,{a:t}),t};Fe.d=(d,t)=>{for(var i in t)Fe.o(t,i)&&!Fe.o(d,i)&&Object.defineProperty(d,i,{enumerable:!0,get:t[i]})};Fe.o=(d,t)=>Object.prototype.hasOwnProperty.call(d,t);Fe.r=d=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(d,"__esModule",{value:!0})};var C={};Fe.d(C,{eKr:()=>kc,yVm:()=>vo,a7j:()=>Wf,U_w:()=>sd,JF2:()=>Bc,htg:()=>sr,HXL:()=>Jc,mcg:()=>Tc,Agj:()=>si,J3_:()=>Zv,Wgv:()=>Lc,u6S:()=>Sv,x7M:()=>xe,X55:()=>Wi,m3M:()=>Qr,aE5:()=>Av,YJU:()=>Oi,eZi:()=>Xl,GNv:()=>Kr,Y56:()=>jl,_0v:()=>Ea,vhs:()=>ma,vrQ:()=>mo,Z8b:()=>cg,Yfw:()=>Tt,IcQ:()=>ct,kgJ:()=>Zl,GTT:()=>Gg,ypY:()=>no,i7d:()=>Pg,fQ3:()=>$v,HlI:()=>Ua,jlt:()=>Ha,VQc:()=>qe,zD7:()=>ed,AUF:()=>ds,JoF:()=>on,MlA:()=>Ae,PZh:()=>bn,qA:()=>Jr,CrD:()=>Us,dQK:()=>cs,D3r:()=>Xi,Qpo:()=>Ca,D9n:()=>ya,b6v:()=>Zr,mvh:()=>Na,Bpo:()=>gt,Q1f:()=>$,IKv:()=>Wg,fcV:()=>Mn,Glf:()=>Vg,uAl:()=>Di,ElT:()=>De,Z8r:()=>hc,QSL:()=>Mg,sPV:()=>ba,nAn:()=>zs,zCU:()=>Aa,QrV:()=>ze,fF9:()=>Mw,Jqv:()=>_g,d_u:()=>pg,xI8:()=>Ic,yar:()=>Re,SP7:()=>Ng,oRy:()=>Va,f5X:()=>jc,V1c:()=>lc,Mlx:()=>Xg,ZiM:()=>Jl,ZCo:()=>$r,J5p:()=>qg,mL_:()=>li,Guw:()=>ug,N5j:()=>Of,pgY:()=>fg,OP3:()=>wa,rl5:()=>Zg,eod:()=>hw,q5Z:()=>Ie,YUC:()=>Oc,saR:()=>Pa,hvr:()=>Kl,Qol:()=>lg,Wf4:()=>hg,JCs:()=>Gt,gJV:()=>wi,fWD:()=>yg,Va_:()=>en,N$8:()=>hi,_jQ:()=>lw,rxj:()=>Fc,rhv:()=>Dc,wCu:()=>Qe,HAp:()=>Iv,Zy1:()=>Tg,bkB:()=>$t,wfL:()=>xa,sVA:()=>oc,$Gs:()=>zc,CJ0:()=>Sa,NWh:()=>Bs,tWi:()=>Mc,xAj:()=>Rc,zWh:()=>dg,i_4:()=>Fw,iIx:()=>Le,Hxo:()=>gg,c9e:()=>Nl,KQV:()=>Ln,weH:()=>Ht,jXp:()=>Rw,zzY:()=>va,yRQ:()=>pa,MtE:()=>Yg,rPj:()=>oo,KLc:()=>Pi,Fir:()=>bt,V5f:()=>gc,Xj7:()=>pc,Wud:()=>da,FVg:()=>Sc,g5Y:()=>Cc,YQB:()=>bc,KPb:()=>yc,nHK:()=>Xa,Jrb:()=>$g,TX_:()=>Tw,Olt:()=>ip,r3n:()=>ar,Fvk:()=>fw,gpR:()=>Ta,vYh:()=>he,hnk:()=>ce,D2R:()=>rr,n1o:()=>Yc,h9O:()=>Bg,X5j:()=>rs,p3P:()=>Qc,RLG:()=>Ec,fBU:()=>Wc,Adb:()=>be,bEs:()=>ls,wCy:()=>Mt,CbD:()=>Jt,x_C:()=>mr,pGf:()=>td,ibQ:()=>Lg,shR:()=>so,Yjk:()=>Kc,_u1:()=>gw,OBI:()=>tp,klh:()=>Xr,s3S:()=>zg,D$R:()=>ro,xth:()=>ka,JU7:()=>cw,h9x:()=>Sg,N1A:()=>nd,e_k:()=>ge,aHM:()=>Hn,tlv:()=>Hv,Vi9:()=>bg,ieR:()=>Ag,$bb:()=>ye,VyI:()=>ut,imn:()=>Bf,uqu:()=>vi,QnL:()=>Fl,vnc:()=>Hc,wk_:()=>Gl,GH0:()=>kt,_1r:()=>Wa,l0X:()=>Vl,bT:()=>Qf,HHX:()=>Wl,jtW:()=>Jf,tjk:()=>Ks,rWe:()=>An,j9l:()=>zf,l0$:()=>od,sGJ:()=>Rs,NVp:()=>Nc,cPK:()=>ei,XoL:()=>$c,RmF:()=>ii,DXI:()=>Oa,tCD:()=>pw,J3D:()=>La,vCJ:()=>dw,e6k:()=>Lf,f9l:()=>Yi,v9m:()=>Ya,yRJ:()=>kg,EU6:()=>Ql,m3O:()=>Ts,Ryz:()=>sn,OxP:()=>qr,LEs:()=>qa,Ec:()=>kn,Pi5:()=>Ga,gmH:()=>Is,tS:()=>rd,XxX:()=>Ue,bCz:()=>Ba,nYS:()=>zn,yiT:()=>wc,NHl:()=>_r,mO8:()=>Ac,PXI:()=>fc,bn5:()=>mc,Ywr:()=>rn,cMd:()=>Un,Bs6:()=>vc,G0k:()=>pr,pyn:()=>xc,QeM:()=>uc,aPX:()=>nw,ITP:()=>_c,BY0:()=>nn,MFw:()=>go,sBn:()=>uo,S3L:()=>er,XKQ:()=>eo,ESI:()=>Ig,uxz:()=>Cg,o8N:()=>dr,u_r:()=>gr,RlV:()=>In,gVA:()=>ql,M_G:()=>po,BpG:()=>Uc,GRB:()=>Ev,kM6:()=>Nf,dO8:()=>Gf,jgM:()=>Ul,FWq:()=>lo,s3j:()=>jm,hlw:()=>eg,L0q:()=>tg,B7e:()=>$f,PGN:()=>Kf,H_X:()=>ae,S_d:()=>ag,_Tq:()=>og,U7E:()=>ng,IOH:()=>sg,Z58:()=>Si,yh2:()=>rw,ff$:()=>zl,cWi:()=>Cf,NBt:()=>Xc,oNz:()=>kv,QlU:()=>Og,Xey:()=>tn,jft:()=>zw,_r8:()=>we,bTC:()=>Vf,Mtr:()=>gi,ypk:()=>Ye,mnM:()=>Ot,q7S:()=>Bw,bAZ:()=>to,ABN:()=>Hf,VK6:()=>zv,Hj2:()=>Zc,Df8:()=>Yl,oOx:()=>or,kxk:()=>Gi,DT1:()=>Ma,FLG:()=>Rn,qN_:()=>id,Z37:()=>za,FtL:()=>xg,Z6X:()=>ep,iQT:()=>Ei,ziO:()=>Dg,OEF:()=>ps,uuE:()=>bi,tiv:()=>io,T$Y:()=>jg,EYj:()=>fo,nOB:()=>_a,Tap:()=>oe,FAs:()=>wg,B_P:()=>vg,aA5:()=>Kv,J3s:()=>ad,Y0Q:()=>co,M4G:()=>Fn,l$l:()=>Qg,dLy:()=>Ls,WZP:()=>nt,eB6:()=>ja,nFK:()=>Ol,l9z:()=>Eg,YOF:()=>tw,yhB:()=>Ce,J0N:()=>ac,Miz:()=>k,Bj4:()=>Bl,Rcs:()=>fs,vJ4:()=>Hs,TqC:()=>Vc,nM0:()=>Pc,X1u:()=>Dn,SpZ:()=>Uf,DX8:()=>nr,Yx$:()=>Hg,HK4:()=>Fg,yt5:()=>bf,vAR:()=>uw,SE$:()=>Ms,qE8:()=>St,Pz7:()=>sp,sX_:()=>Bn,JuI:()=>Vm,pxT:()=>ks,Nl$:()=>dc,zDr:()=>Cw,OwT:()=>ww,P$G:()=>yw,mHV:()=>Aw,kEA:()=>Sw,Fx_:()=>Ew,WFC:()=>Pw,vKu:()=>mw,aDq:()=>_w,jIg:()=>bw,UH3:()=>xw,AJO:()=>vw,U4:()=>qf,xAc:()=>Yf,_3Y:()=>Qv,K6X:()=>Pv,C1Y:()=>kf,Aw1:()=>Hl,tm8:()=>jf,LBV:()=>Zf,A8$:()=>Tv,F5e:()=>jv,ran:()=>Yv,c8L:()=>rg,o6M:()=>ig,hsx:()=>ss,l9E:()=>mg,aSf:()=>Rg,CcK:()=>Xf,nU8:()=>Gc,td6:()=>_o,Zex:()=>np,bkJ:()=>Vt,mXP:()=>Lw,vt$:()=>fr,hCA:()=>qi,pjR:()=>vt,U43:()=>ns,pSZ:()=>Gm,y17:()=>Nm,Ew7:()=>gs,hG1:()=>qv,jVr:()=>kw,_SZ:()=>Xt,xWn:()=>yf,ehJ:()=>Wm,t6s:()=>N,Eyn:()=>nc});var nc={};Fe.r(nc);Fe.d(nc,{getAttributeComponentSize:()=>Ff,getAttributePointerType:()=>Mf,getGLTypeFromSource:()=>Df,getGlTypeSizeBytes:()=>Ml,getMaxShaderComplexity:()=>cc,isAttributeInSource:()=>Rf});var rc={};Fe.r(rc);Fe.d(rc,{circle:()=>Cv,line:()=>kl,point:()=>bv,roundRect:()=>Ll,vector:()=>yv});var oc={};Fe.r(oc);Fe.d(oc,{ActionCompleteEvent:()=>kc,ActionStartEvent:()=>Bc,ActivateEvent:()=>Tc,AddEvent:()=>Lc,CollisionEndEvent:()=>Jr,CollisionPostSolveEvent:()=>Ca,CollisionPreSolveEvent:()=>ya,CollisionStartEvent:()=>Zr,ContactEndEvent:()=>ba,ContactStartEvent:()=>Aa,DeactivateEvent:()=>Ic,EnterTriggerEvent:()=>Fc,EnterViewPortEvent:()=>Dc,EventTypes:()=>xa,ExitTriggerEvent:()=>Mc,ExitViewPortEvent:()=>Rc,GameEvent:()=>bt,GameStartEvent:()=>gc,GameStopEvent:()=>pc,GamepadAxisEvent:()=>Sc,GamepadButtonEvent:()=>Cc,GamepadConnectEvent:()=>bc,GamepadDisconnectEvent:()=>yc,HiddenEvent:()=>Ec,InitializeEvent:()=>mr,KillEvent:()=>ka,PostCollisionEvent:()=>zn,PostDebugDrawEvent:()=>wc,PostDrawEvent:()=>_r,PostFrameEvent:()=>Ac,PostKillEvent:()=>fc,PostTransformDrawEvent:()=>mc,PostUpdateEvent:()=>rn,PreCollisionEvent:()=>Un,PreDebugDrawEvent:()=>vc,PreDrawEvent:()=>pr,PreFrameEvent:()=>xc,PreKillEvent:()=>uc,PreTransformDrawEvent:()=>_c,PreUpdateEvent:()=>nn,RemoveEvent:()=>Uc,VisibleEvent:()=>Pc});var ac={};Fe.r(ac);Fe.d(ac,{ConsoleAppender:()=>hc,DrawUtil:()=>rc,EasingFunctions:()=>Gt,LogLevel:()=>ye,Logger:()=>ut,Observable:()=>ei,ScreenAppender:()=>Cf,addItemToArray:()=>Xm,contains:()=>Sf,delay:()=>fa,fail:()=>Pf,getPosition:()=>Gr,isObject:()=>ca,mergeDeep:()=>ga,omit:()=>Ef,removeItemFromArray:()=>ur});function Af(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(d){window.setInterval(d,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const t=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(i){return new Promise((n,o)=>{t.call(this,i,n,o)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(d){const t=Date.now();return setTimeout(function(){d({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(d){clearTimeout(d)})}class Le{static useCanvasGraphicsContext(){Le.enable("use-canvas-context")}static useLegacyImageRenderer(){Le.enable("use-legacy-image-renderer")}static freeze(){Le._FROZEN=!0}static _reset(){Le._FROZEN=!1,Le._FLAGS={}}static enable(t){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");Le._FLAGS[t]=!0}static disable(t){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");Le._FLAGS[t]=!1}static isEnabled(t){return!!Le._FLAGS[t]}static show(){return Object.keys(Le._FLAGS)}}Le._FROZEN=!1;Le._FLAGS={};function Bn(d,t){return{type:d,value:t}}class Pi{constructor(){this._isCompleted=!1,this.promise=new Promise((t,i)=>{this._resolver=t,this._rejecter=i})}get isCompleted(){return this._isCompleted}resolve(t){this._isCompleted||(this._isCompleted=!0,this._resolver(t))}reject(t){this._isCompleted||(this._isCompleted=!0,this._rejecter(t))}}class $t{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(t,i){var n;return this._empty=!1,this._listeners[t]=(n=this._listeners[t])!==null&&n!==void 0?n:[],this._listeners[t].push(i),{close:()=>this.off(t,i)}}once(t,i){var n;return this._empty=!1,this._listenersOnce[t]=(n=this._listenersOnce[t])!==null&&n!==void 0?n:[],this._listenersOnce[t].push(i),{close:()=>this.off(t,i)}}off(t,i){var n,o;if(i){const h=(n=this._listeners[t])===null||n===void 0?void 0:n.filter(g=>g!==i);this._listeners[t]=h;const c=(o=this._listenersOnce[t])===null||o===void 0?void 0:o.filter(g=>g!==i);this._listenersOnce[t]=c}else delete this._listeners[t]}emit(t,i){if(this._empty||this._paused)return;const n=this._listeners[t];if(n)for(let h=0;h<n.length;h++)n[h](i);const o=this._listenersOnce[t];if(this._listenersOnce[t]=[],o)for(let h=0;h<o.length;h++)o[h](i);for(let h=0;h<this._pipes.length;h++)this._pipes[h].emit(t,i)}pipe(t){if(this===t)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(t),{close:()=>{const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}}}unpipe(t){const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var kn;(function(d){d.Canvas="Canvas",d.Document="Document"})(kn||(kn={}));var ae;(function(d){d.ShortestPath="shortest-path",d.LongestPath="longest-path",d.Clockwise="clockwise",d.CounterClockwise="counter-clockwise"})(ae||(ae={}));const wl=4294967295;class dr{constructor(t){this.seed=t,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(t||Date.now())>>>0;for(let i=1;i<this._n;i++){const n=this._mt[i-1]^this._mt[i-1]>>>this._w-2;this._mt[i]=(this._f*((n&4294901760)>>>16)<<16)+this._f*(n&65535)+i>>>0}this._index=this._n}_twist(){const t=[0,this._a];let i=0,n=0;for(;n<this._n-this._m;n++)i=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+this._m]^i>>>1^t[i&1]&wl;for(;n<this._n-1;n++)i=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+(this._m-this._n)]^i>>>1^t[i&1]&wl;i=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^i>>>1^t[i&1]&wl,this._index=0}nextInt(){this._index>=this._n&&this._twist();let t=this._mt[this._index++];return t^=t>>>this._u,t^=t<<this._s&this._b,t^=t<<this._t&this._c,t^=t>>>this._l,t>>>0}next(){return this.nextInt()*(1/4294967296)}floating(t,i){return(i-t)*this.next()+t}integer(t,i){return Math.floor((i-t+1)*this.next()+t)}bool(t=.5){return this.next()<=t}pickOne(t){return t[this.integer(0,t.length-1)]}pickSet(t,i,n=!1){return n?this._pickSetWithDuplicates(t,i):this._pickSetWithoutDuplicates(t,i)}_pickSetWithoutDuplicates(t,i){if(i>t.length||i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(i===t.length)return t;const n=new Array(i);let o=0;const h=t.slice(0);for(;o<i;){const c=this.integer(0,h.length-1);n[o++]=h[c],h.splice(c,1)}return n}_pickSetWithDuplicates(t,i){if(i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const n=new Array(i);for(let o=0;o<i;o++)n[o]=this.pickOne(t);return n}shuffle(t){const i=t.slice(0);let n;for(let o=0;o<i.length-2;o++){const h=this.integer(o,i.length-1);n=i[o],i[o]=i[h],i[h]=n}return i}range(t,i,n){const o=new Array(t);for(let h=0;h<t;h++)o[h]=this.integer(i,n);return o}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const Ce=Math.PI*2;function Vm(d){return d>=0?d-Math.floor(d):d-Math.ceil(d)}function Xt(d){return d===0?0:d<0?-1:1}function St(d,t,i){return Math.min(Math.max(t,d),i)}function bf(d,t,i){return Math.abs(d-t)<i}function Ms(d){let t=d;if(d>=Ce)for(;t>=Ce;)t-=Ce;if(d<0)for(;t<0;)t+=Ce;return t}function yf(d){return 180/Math.PI*d}function Wm(d){return d/180*Math.PI}const Nm=(d,t)=>Array.from(new Array(t-d+1),(i,n)=>n+d);function ns(d,t,i=new dr){return i?i.floating(d,t):d+Math.random()*(t-d)}function Gm(d,t,i=new dr){return i?i.integer(d,t):Math.round(ns(d,t))}class k{static get Zero(){return new k(0,0)}static get One(){return new k(1,1)}static get Half(){return new k(.5,.5)}static get Up(){return new k(0,-1)}static get Down(){return new k(0,1)}static get Left(){return new k(-1,0)}static get Right(){return new k(1,0)}static fromAngle(t){return new k(Math.cos(t),Math.sin(t))}static isValid(t){return!(t==null||isNaN(t.x)||isNaN(t.y)||t.x===1/0||t.y===1/0||t.x===-1/0||t.y===-1/0)}static distance(t,i){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))}static min(t,i){return new k(Math.min(t.x,i.x),Math.min(t.y,i.y))}static max(t,i){return new k(Math.max(t.x,i.x),Math.max(t.y,i.y))}constructor(t,i){this._x=0,this._y=0,this._x=t,this._y=i}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}setTo(t,i){this.x=t,this.y=i}equals(t,i=k.EQUALS_EPSILON){return Math.abs(this.x-t.x)<=i&&Math.abs(this.y-t.y)<=i}distance(t){if(!t)return Math.sqrt(this.x*this.x+this.y*this.y);const i=this.x-t.x,n=this.y-t.y;return Math.sqrt(i*i+n*n)}squareDistance(t){t||(t=k.Zero);const i=this.x-t.x,n=this.y-t.y;return i*i+n*n}clampMagnitude(t){const i=this.magnitude,n=St(i,0,t);return this.magnitude=n,this}get size(){return this.distance()}set size(t){const i=this.normalize().scale(t);this.setTo(i.x,i.y)}get magnitude(){return this.distance()}set magnitude(t){this.normalize().scale(t,this)}normalize(){const t=this.distance();return t===0?k.Zero:new k(this.x/t,this.y/t)}average(t){return this.add(t).scale(.5)}scale(t,i){const n=i||new k(0,0);return t instanceof k?(n.x=this.x*t.x,n.y=this.y*t.y):(n.x=this.x*t,n.y=this.y*t),n}add(t,i){return i?(i.x=this.x+t.x,i.y=this.y+t.y,i):new k(this.x+t.x,this.y+t.y)}sub(t,i){const n=i||new k(0,0),o=this.x-t.x,h=this.y-t.y;return n.x=o,n.y=h,n}addEqual(t){return this.setTo(this.x+t.x,this.y+t.y),this}subEqual(t){return this.setTo(this.x-t.x,this.y-t.y),this}scaleEqual(t){return this.setTo(this.x*t,this.y*t),this}dot(t){return this.x*t.x+this.y*t.y}cross(t){if(t instanceof k)return this.x*t.y-this.y*t.x;if(typeof t=="number")return new k(t*this.y,-t*this.x)}static cross(t,i){return new k(-t*i.y,t*i.x)}perpendicular(){return new k(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return Ms(Math.atan2(this.y,this.x))}angleBetween(t,i){const n=this.toAngle(),o=Ms(t);let h=0,c=0;switch(o>n?h=o-n:h=(Ce-n+o)%Ce,c=(h-Ce)%Ce,i){case ae.ShortestPath:return Math.abs(h)<Math.abs(c)?h:c;case ae.LongestPath:return Math.abs(h)>Math.abs(c)?h:c;case ae.Clockwise:return h;case ae.CounterClockwise:return c}}rotate(t,i,n){const o=n||new k(0,0);i||(i=new k(0,0));const h=Math.sin(t),c=Math.cos(t),g=c*(this.x-i.x)-h*(this.y-i.y)+i.x,_=h*(this.x-i.x)+c*(this.y-i.y)+i.y;return o.x=g,o.y=_,o}clone(t){const i=t??new k(0,0);return i.x=this.x,i.y=this.y,i}toString(t){return t?`(${this.x.toFixed(t)}, ${this.y.toFixed(t)})`:`(${this.x}, ${this.y})`}}k.EQUALS_EPSILON=.001;function N(d,t){return new k(d,t)}class ${constructor(t,i,n,o){this.r=t,this.g=i,this.b=n,this.a=o??1}static fromRGB(t,i,n,o){return new $(t,i,n,o)}static fromRGBString(t){const i=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let n=null;if(n=t.match(i)){const o=parseInt(n[1],10),h=parseInt(n[2],10),c=parseInt(n[3],10);let g=1;return n[4]&&(g=parseFloat(n[4])),new $(o,h,c,g)}else throw new Error("Invalid rgb/a string: "+t)}static fromHex(t){const i=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let n=null;if(n=t.match(i)){const o=parseInt(n[1],16),h=parseInt(n[2],16),c=parseInt(n[3],16);let g=1;return n[4]&&(g=parseInt(n[4],16)/255),new $(o,h,c,g)}else throw new Error("Invalid hex string: "+t)}static fromHSL(t,i,n,o=1){return new Vi(t,i,n,o).toRGBA()}lighten(t=.1){const i=Vi.fromRGBA(this.r,this.g,this.b,this.a);return i.l+=(1-i.l)*t,i.toRGBA()}darken(t=.1){const i=Vi.fromRGBA(this.r,this.g,this.b,this.a);return i.l-=i.l*t,i.toRGBA()}saturate(t=.1){const i=Vi.fromRGBA(this.r,this.g,this.b,this.a);return i.s+=i.s*t,i.toRGBA()}desaturate(t=.1){const i=Vi.fromRGBA(this.r,this.g,this.b,this.a);return i.s-=i.s*t,i.toRGBA()}multiply(t){const i=t.r/255*this.r/255*255,n=t.g/255*this.g/255*255,o=t.b/255*this.b/255*255,h=t.a*this.a;return new $(i,n,o,h)}screen(t){const i=t.invert(),n=t.invert();return i.multiply(n).invert()}invert(){return new $(255-this.r,255-this.g,255-this.b,1-this.a)}average(t){const i=(t.r+this.r)/2,n=(t.g+this.g)/2,o=(t.b+this.b)/2,h=(t.a+this.a)/2;return new $(i,n,o,h)}equal(t){return this.toString()===t.toString()}toString(t="rgb"){switch(t){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(t){const i=Math.max(Math.round(t),0).toString(16);return i.length===1?"0"+i:i}toHex(){let t="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(t+=this._componentToHex(this.a*255)),t}toRGBA(){const t=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+t+", "+String(this.a)+")":"rgb("+t+")"}toHSLA(){return Vi.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(t){const i=t||new $(this.r,this.g,this.b,this.a);return i.r=this.r,i.g=this.g,i.b=this.b,i.a=this.a,i}static get Black(){return $.fromHex("#000000")}static get White(){return $.fromHex("#FFFFFF")}static get Gray(){return $.fromHex("#808080")}static get LightGray(){return $.fromHex("#D3D3D3")}static get DarkGray(){return $.fromHex("#A9A9A9")}static get Yellow(){return $.fromHex("#FFFF00")}static get Orange(){return $.fromHex("#FFA500")}static get Red(){return $.fromHex("#FF0000")}static get Vermilion(){return $.fromHex("#FF5B31")}static get Rose(){return $.fromHex("#FF007F")}static get Pink(){return $.fromHex("#FFC0CB")}static get Magenta(){return $.fromHex("#FF00FF")}static get Violet(){return $.fromHex("#7F00FF")}static get Purple(){return $.fromHex("#800080")}static get Blue(){return $.fromHex("#0000FF")}static get Azure(){return $.fromHex("#007FFF")}static get Cyan(){return $.fromHex("#00FFFF")}static get Viridian(){return $.fromHex("#59978F")}static get Teal(){return $.fromHex("#008080")}static get Green(){return $.fromHex("#00FF00")}static get Chartreuse(){return $.fromHex("#7FFF00")}static get Transparent(){return $.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return $.fromHex("#176BAA")}static get Brown(){return $.fromHex("#964B00")}}class Vi{constructor(t,i,n,o){this.h=t,this.s=i,this.l=n,this.a=o}static hue2rgb(t,i,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+(i-t)*6*n:n<1/2?i:n<2/3?t+(i-t)*(2/3-n)*6:t}static fromRGBA(t,i,n,o){t/=255,i/=255,n/=255;const h=Math.max(t,i,n),c=Math.min(t,i,n);let g,_;const v=(h+c)/2;if(h===c)g=_=0;else{const x=h-c;switch(_=v>.5?x/(2-h-c):x/(h+c),h){case t:g=(i-n)/x+(i<n?6:0);break;case i:g=(n-t)/x+2;break;case n:g=(t-i)/x+4;break}g/=6}return new Vi(g,_,v,o)}toRGBA(){let t,i,n;if(this.s===0)t=i=n=this.l;else{const o=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,h=2*this.l-o;t=Vi.hue2rgb(h,o,this.h+1/3),i=Vi.hue2rgb(h,o,this.h),n=Vi.hue2rgb(h,o,this.h-1/3)}return new $(t*255,i*255,n*255,this.a)}toString(){const t=this.h.toFixed(0),i=this.s.toFixed(0),n=this.l.toFixed(0),o=this.a.toFixed(0);return`hsla(${t}, ${i}, ${n}, ${o})`}}var ye;(function(d){d[d.Debug=0]="Debug",d[d.Info=1]="Info",d[d.Warn=2]="Warn",d[d.Error=3]="Error",d[d.Fatal=4]="Fatal"})(ye||(ye={}));class ut{constructor(){if(this._appenders=[],this.defaultLevel=ye.Info,this._logOnceSet=new Set,ut._INSTANCE)throw new Error("Logger is a singleton");return ut._INSTANCE=this,ut._INSTANCE.addAppender(new hc),ut._INSTANCE}static getInstance(){return ut._INSTANCE==null&&(ut._INSTANCE=new ut),ut._INSTANCE}addAppender(t){this._appenders.push(t)}clearAppenders(){this._appenders.length=0}_log(t,i){t==null&&(t=this.defaultLevel);const n=this._appenders.length;for(let o=0;o<n;o++)t>=this.defaultLevel&&this._appenders[o].log(t,i)}_logOnce(t,i){const n=t+i.join("+");this._logOnceSet.has(n)||(this._logOnceSet.add(n),this._log(t,i))}debug(...t){this._log(ye.Debug,t)}debugOnce(...t){this._logOnce(ye.Debug,t)}info(...t){this._log(ye.Info,t)}infoOnce(...t){this._logOnce(ye.Info,t)}warn(...t){this._log(ye.Warn,t)}warnOnce(...t){this._logOnce(ye.Warn,t)}error(...t){this._log(ye.Error,t)}errorOnce(...t){this._logOnce(ye.Error,t)}fatal(...t){this._log(ye.Fatal,t)}fatalOnce(...t){this._logOnce(ye.Fatal,t)}}ut._INSTANCE=null;class hc{log(t,i){if(!console&&!console.log&&console.warn&&console.error)return;const n=[];n.unshift.apply(n,i),n.unshift("["+ye[t]+"] : "),t<ye.Warn?console.log.apply?console.log.apply(console,n):console.log(n.join(" ")):t<ye.Error?console.warn.apply?console.warn.apply(console,n):console.warn(n.join(" ")):console.error.apply?console.error.apply(console,n):console.error(n.join(" "))}}class Cf{constructor(t){var i,n;this._messages=[],this._pos=10,this._color=$.Black,this._options=t,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(n=(i=t.zIndex)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),t.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var t,i,n,o;const h=this._options;this.canvas.width=(t=h.width)!==null&&t!==void 0?t:h.engine.screen.resolution.width,this.canvas.height=(i=h.height)!==null&&i!==void 0?i:h.engine.screen.resolution.height,this.canvas.style.position="absolute";const c=h.engine.screen.screenToPageCoordinates(N(0,0));this.canvas.style.left=c.x+"px",this.canvas.style.top=c.y+"px",this._pos=(n=h.xPos)!==null&&n!==void 0?n:this._pos,this._color=(o=h.color)!==null&&o!==void 0?o:this._color}log(t,i){const n=i.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+ye[t]+"] : "+n);let o=10;this._messages=this._messages.slice(0,1e3);for(let h=0;h<this._messages.length;h++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[h],this._pos,o),o+=10}}var Ot;(function(d){d.None="None",d.Top="Top",d.Bottom="Bottom",d.Left="Left",d.Right="Right"})(Ot||(Ot={}));(function(d){function t(n){return n===d.Top?d.Bottom:n===d.Bottom?d.Top:n===d.Left?d.Right:n===d.Right?d.Left:d.None}d.getOpposite=t;function i(n){return Math.abs(n.x)>=Math.abs(n.y)?n.x<=0?d.Left:d.Right:n.y<=0?d.Top:d.Bottom}d.fromDirection=i})(Ot||(Ot={}));class ct{constructor(t=0,i=0,n=0,o=0){this._points=[],typeof t=="object"?(this.left=t.left,this.top=t.top,this.right=t.right,this.bottom=t.bottom):typeof t=="number"&&(this.left=t,this.top=i,this.right=n,this.bottom=o)}clone(t){const i=t||new ct(0,0,0,0);return i.left=this.left,i.right=this.right,i.top=this.top,i.bottom=this.bottom,i}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(t){return t&&t?Math.abs(t.x)>Math.abs(t.y)?t.x<0?Ot.Right:Ot.Left:t.y<0?Ot.Bottom:Ot.Top:Ot.None}static fromPoints(t){let i=1/0,n=1/0,o=-1/0,h=-1/0;for(let c=0;c<t.length;c++)t[c].x<i&&(i=t[c].x),t[c].x>o&&(o=t[c].x),t[c].y<n&&(n=t[c].y),t[c].y>h&&(h=t[c].y);return new ct(i,n,o,h)}static fromDimension(t,i,n=k.Half,o=k.Zero){return new ct(-t*n.x+o.x,-i*n.y+o.y,t-t*n.x+o.x,i-i*n.y+o.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new k((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new k(this.left,this.top)}get bottomRight(){return new k(this.right,this.bottom)}get topRight(){return new k(this.right,this.top)}get bottomLeft(){return new k(this.left,this.bottom)}translate(t){return new ct(this.left+t.x,this.top+t.y,this.right+t.x,this.bottom+t.y)}rotate(t,i=k.Zero){const n=this.getPoints().map(o=>o.rotate(t,i));return ct.fromPoints(n)}scale(t,i=k.Zero){const n=this.translate(i);return new ct(n.left*t.x,n.top*t.y,n.right*t.x,n.bottom*t.y)}transform(t){const i=t.data[0]*this.left,n=t.data[1]*this.left,o=t.data[0]*this.right,h=t.data[1]*this.right,c=t.data[2]*this.top,g=t.data[3]*this.top,_=t.data[2]*this.bottom,v=t.data[3]*this.bottom,x=t.getPosition(),A=Math.min(i,o)+Math.min(c,_)+x.x,S=Math.min(n,h)+Math.min(g,v)+x.y,P=Math.max(i,o)+Math.max(c,_)+x.x,I=Math.max(n,h)+Math.max(g,v)+x.y;return new ct({left:A,top:S,right:P,bottom:I})}getPerimeter(){const t=this.width,i=this.height;return 2*(t+i)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new k(this.left,this.top)),this._points.push(new k(this.right,this.top)),this._points.push(new k(this.right,this.bottom)),this._points.push(new k(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(t,i=1/0){let n=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,c=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,g=(this.left-t.pos.x)*h,_=(this.right-t.pos.x)*h;n=Math.min(g,_),o=Math.max(g,_);const v=(this.top-t.pos.y)*c,x=(this.bottom-t.pos.y)*c;return n=Math.max(n,Math.min(v,x)),o=Math.min(o,Math.max(v,x)),o>=Math.max(0,n)&&n<i}rayCastTime(t,i=1/0){let n=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,c=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,g=(this.left-t.pos.x)*h,_=(this.right-t.pos.x)*h;n=Math.min(g,_),o=Math.max(g,_);const v=(this.top-t.pos.y)*c,x=(this.bottom-t.pos.y)*c;return n=Math.max(n,Math.min(v,x)),o=Math.min(o,Math.max(v,x)),o>=Math.max(0,n)&&n<i?n:-1}contains(t){return t instanceof k?this.left<=t.x&&this.top<=t.y&&t.y<=this.bottom&&t.x<=this.right:t instanceof ct?this.left<=t.left&&this.top<=t.top&&t.bottom<=this.bottom&&t.right<=this.right:!1}combine(t,i){const n=i||new ct(0,0,0,0),o=Math.min(this.left,t.left),h=Math.min(this.top,t.top),c=Math.max(this.right,t.right),g=Math.max(this.bottom,t.bottom);return n.left=o,n.top=h,n.right=c,n.bottom=g,n}get dimensions(){return new k(this.width,this.height)}overlaps(t,i){const n=i||0;if(t.hasZeroDimensions())return this.contains(t);if(this.hasZeroDimensions())return t.contains(this);const o=this.combine(t);return o.width+n<t.width+this.width&&o.height+n<t.height+this.height}intersect(t){const i=this.combine(t);if(i.width<t.width+this.width&&i.height<t.height+this.height&&!i.dimensions.equals(t.dimensions)&&!i.dimensions.equals(this.dimensions)){let n=0;this.right>=t.left&&this.right<=t.right?n=t.left-this.right:n=t.right-this.left;let o=0;return this.top<=t.bottom&&this.top>=t.top?o=t.bottom-this.top:o=t.top-this.bottom,Math.abs(n)<Math.abs(o)?new k(n,0):new k(0,o)}else if(i.dimensions.equals(t.dimensions)||i.dimensions.equals(this.dimensions)){let n=0;this.width-t.width>=0?this.right-t.right<=t.left-this.left?n=t.left-this.right:n=t.right-this.left:t.right-this.right<=this.left-t.left?n=this.left-t.right:n=this.right-t.left;let o=0;return this.height-t.height>=0?this.bottom-t.bottom<=t.top-this.top?o=t.top-this.bottom:o=t.bottom-this.top:t.bottom-this.bottom<=this.top-t.top?o=this.top-t.bottom:o=this.bottom-t.top,Math.abs(n)<Math.abs(o)?new k(n,0):new k(0,o)}else return null}intersectWithSide(t){const i=this.intersect(t);return ct.getSideFromIntersection(i)}draw(t,i=$.Yellow){t.debug.drawRect(this.left,this.top,this.width,this.height,{color:i})}}function Gr(d){if(d&&d.getBoundingClientRect){const t=d.getBoundingClientRect();return N(t.x+window.scrollX,t.y+window.scrollY)}return k.Zero}function Xm(d,t){return t.indexOf(d)===-1?(t.push(d),!0):!1}function ur(d,t){let i=-1;return(i=t.indexOf(d))>-1?(t.splice(i,1),!0):!1}function Sf(d,t){for(let i=0;i<d.length;i++)if(d[i]===t)return!0;return!1}function Pf(d){throw new Error(d)}function fa(d,t){var i;const n=new Pi;return((i=t?.schedule.bind(t))!==null&&i!==void 0?i:setTimeout)(()=>{n.resolve()},d),n.promise}function Ef(d,t){const i={};for(const n in d)t.includes(n)||(i[n]=d[n]);return i}function ca(d){return d&&typeof d=="object"&&!Array.isArray(d)}function ga(d,...t){if(!t.length)return d;const i=t.shift();if(ca(d)&&ca(i))for(const n in i)ca(i[n])?(d[n]||Object.assign(d,{[n]:{}}),ga(d[n],i[n])):Object.assign(d,{[n]:i[n]});return ga(d,...t)}var Fl;(function(d){d[d.X=12]="X",d[d.Y=13]="Y"})(Fl||(Fl={}));class vi{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(t,i,n,o,h,c){const g=new vi;return g.data[0]=2/(i-t),g.data[1]=0,g.data[2]=0,g.data[3]=0,g.data[4]=0,g.data[5]=2/(o-n),g.data[6]=0,g.data[7]=0,g.data[8]=0,g.data[9]=0,g.data[10]=-2/(c-h),g.data[11]=0,g.data[12]=-(i+t)/(i-t),g.data[13]=-(o+n)/(o-n),g.data[14]=-(c+h)/(c-h),g.data[15]=1,g}clone(t){const i=t||new vi;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i.data[6]=this.data[6],i.data[7]=this.data[7],i.data[8]=this.data[8],i.data[9]=this.data[9],i.data[10]=this.data[10],i.data[11]=this.data[11],i.data[12]=this.data[12],i.data[13]=this.data[13],i.data[14]=this.data[14],i.data[15]=this.data[15],i}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(t){const i=new vi;return i.data=t,i}static identity(){const t=new vi;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}static translation(t,i){const n=vi.identity();return n.data[12]=t,n.data[13]=i,n}static scale(t,i){const n=vi.identity();return n.data[0]=t,n.data[5]=i,n.data[10]=1,n.data[15]=1,n}static rotation(t){const i=vi.identity();return i.data[0]=Math.cos(t),i.data[4]=-Math.sin(t),i.data[1]=Math.sin(t),i.data[5]=Math.cos(t),i}multiply(t,i){if(t instanceof k){const n=i||new k(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[4]+this.data[12],c=o.x*this.data[1]+o.y*this.data[5]+this.data[13];return n.x=h,n.y=c,n}else{const n=i||new vi,o=t,h=this.data[0],c=this.data[1],g=this.data[2],_=this.data[3],v=this.data[4],x=this.data[5],A=this.data[6],S=this.data[7],P=this.data[8],I=this.data[9],F=this.data[10],R=this.data[11],E=this.data[12],M=this.data[13],V=this.data[14],L=this.data[15],G=o.data[0],j=o.data[1],X=o.data[2],rt=o.data[3],lt=o.data[4],yt=o.data[5],wt=o.data[6],Pt=o.data[7],Dt=o.data[8],B=o.data[9],z=o.data[10],Z=o.data[11],et=o.data[12],Wt=o.data[13],at=o.data[14],Fi=o.data[15];n.data[0]=h*G+v*j+P*X+E*rt,n.data[1]=c*G+x*j+I*X+M*rt,n.data[2]=g*G+A*j+F*X+V*rt,n.data[3]=_*G+S*j+R*X+L*rt,n.data[4]=h*lt+v*yt+P*wt+E*Pt,n.data[5]=c*lt+x*yt+I*wt+M*Pt,n.data[6]=g*lt+A*yt+F*wt+V*Pt,n.data[7]=_*lt+S*yt+R*wt+L*Pt,n.data[8]=h*Dt+v*B+P*z+E*Z,n.data[9]=c*Dt+x*B+I*z+M*Z,n.data[10]=g*Dt+A*B+F*z+V*Z,n.data[11]=_*Dt+S*B+R*z+L*Z,n.data[12]=h*et+v*Wt+P*at+E*Fi,n.data[13]=c*et+x*Wt+I*at+M*Fi,n.data[14]=g*et+A*Wt+F*at+V*Fi,n.data[15]=_*et+S*Wt+R*at+L*Fi;const _s=this.getScale();return n._scaleSignX=Xt(_s.x)*Xt(n._scaleSignX),n._scaleSignY=Xt(_s.y)*Xt(n._scaleSignY),n}}translate(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],g=this.data[4],_=this.data[5],v=this.data[6],x=this.data[7],A=this.data[8],S=this.data[9],P=this.data[10],I=this.data[11],F=this.data[12],R=this.data[13],E=this.data[14],M=this.data[15],V=0,L=1;return this.data[12]=n*t+g*i+A*V+F*L,this.data[13]=o*t+_*i+S*V+R*L,this.data[14]=h*t+v*i+P*V+E*L,this.data[15]=c*t+x*i+I*V+M*L,this}setPosition(t,i){this.data[12]=t,this.data[13]=i}getPosition(){return N(this.data[12],this.data[13])}rotate(t){const i=this.data[0],n=this.data[1],o=this.data[2],h=this.data[3],c=this.data[4],g=this.data[5],_=this.data[6],v=this.data[7],x=Math.sin(t),A=Math.cos(t);return this.data[0]=A*i+x*c,this.data[1]=A*n+x*g,this.data[2]=A*o+x*_,this.data[3]=A*h+x*v,this.data[4]=A*c-x*i,this.data[5]=A*g-x*n,this.data[6]=A*_-x*o,this.data[7]=A*v-x*h,this}scale(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],g=this.data[4],_=this.data[5],v=this.data[6],x=this.data[7];return this.data[0]=n*t,this.data[1]=o*t,this.data[2]=h*t,this.data[3]=c*t,this.data[4]=g*i,this.data[5]=_*i,this.data[6]=v*i,this.data[7]=x*i,this}setRotation(t){const i=this.getScale(),n=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=n*i.y,this.data[4]=-n*i.x,this.data[5]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return Ms(t)}getScaleX(){const t=N(this.data[0],this.data[4]).magnitude;return this._scaleSignX*t}getScaleY(){const t=N(this.data[1],this.data[5]).magnitude;return this._scaleSignY*t}getScale(){return N(this.getScaleX(),this.getScaleY())}setScaleX(t){if(this._scaleX===t)return;this._scaleSignX=Xt(t);const i=N(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[4]=i.y*t,this._scaleX=t}setScaleY(t){if(this._scaleY===t)return;this._scaleSignY=Xt(t);const i=N(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[5]=i.y*t,this._scaleY=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(t){const n=1/this.getBasisDeterminant(),o=this.data[0],h=this.data[4],c=this.data[1],g=this.data[5],_=t||vi.identity();_.data[0]=g*n,_.data[1]=-c*n,_.data[4]=-h*n,_.data[5]=o*n;const v=this.data[12],x=this.data[13];return _.data[12]=-(v*_.data[0]+x*_.data[4]),_.data[13]=-(v*_.data[1]+x*_.data[5]),_}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class xe{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const t=new xe;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}static translation(t,i){const n=xe.identity();return n.data[4]=t,n.data[5]=i,n}static scale(t,i){const n=xe.identity();return n.data[0]=t,n.data[3]=i,n._scale[0]=t,n._scale[1]=i,n}static rotation(t){const i=xe.identity();return i.data[0]=Math.cos(t),i.data[1]=Math.sin(t),i.data[2]=-Math.sin(t),i.data[3]=Math.cos(t),i}setPosition(t,i){this.data[4]=t,this.data[5]=i}getPosition(){return N(this.data[4],this.data[5])}rotate(t){const i=this.data[0],n=this.data[1],o=this.data[2],h=this.data[3],c=Math.sin(t),g=Math.cos(t);return this.data[0]=g*i+c*o,this.data[1]=g*n+c*h,this.data[2]=g*o-c*i,this.data[3]=g*h-c*n,this}translate(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],g=this.data[4],_=this.data[5];return this.data[4]=n*t+h*i+g,this.data[5]=o*t+c*i+_,this}scale(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3];return this.data[0]=n*t,this.data[1]=o*t,this.data[2]=h*i,this.data[3]=c*i,this._scale[0]=t,this._scale[1]=i,this._scaleSignX=Xt(t),this._scaleSignY=Xt(i),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(t){const i=this.determinant();let n=i;i!==0&&(n=1/i);const o=this.data[0],h=this.data[2],c=this.data[1],g=this.data[3],_=t||xe.identity();_.data[0]=g*n,_.data[1]=-c*n,_.data[2]=-h*n,_.data[3]=o*n;const v=this.data[4],x=this.data[5];return _.data[4]=-(v*_.data[0]+x*_.data[2]),_.data[5]=-(v*_.data[1]+x*_.data[3]),_}multiply(t,i){if(t instanceof k){const n=i||new k(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[2]+this.data[4],c=o.x*this.data[1]+o.y*this.data[3]+this.data[5];return n.x=h,n.y=c,n}else{const n=i||new xe,o=t,h=this.data[0],c=this.data[1],g=this.data[2],_=this.data[3],v=this.data[4],x=this.data[5],A=o.data[0],S=o.data[1],P=o.data[2],I=o.data[3],F=o.data[4],R=o.data[5];n.data[0]=h*A+g*S,n.data[1]=c*A+_*S,n.data[2]=h*P+g*I,n.data[3]=c*P+_*I,n.data[4]=h*F+g*R+v,n.data[5]=c*F+_*R+x;const E=this._scaleSignX,M=this._scaleSignY;return n._scaleSignX=E*Xt(n._scaleSignX),n._scaleSignY=M*Xt(n._scaleSignY),n}}multiplyQuadInPlace(t){const i=t[0]*this.data[0]+t[1]*this.data[2]+this.data[4],n=t[0]*this.data[1]+t[1]*this.data[3]+this.data[5];t[0]=i,t[1]=n;const o=t[2]*this.data[0]+t[3]*this.data[2]+this.data[4],h=t[2]*this.data[1]+t[3]*this.data[3]+this.data[5];t[2]=o,t[3]=h;const c=t[4]*this.data[0]+t[5]*this.data[2]+this.data[4],g=t[4]*this.data[1]+t[5]*this.data[3]+this.data[5];t[4]=c,t[5]=g;const _=t[6]*this.data[0]+t[7]*this.data[2]+this.data[4],v=t[6]*this.data[1]+t[7]*this.data[3]+this.data[5];t[6]=_,t[7]=v}to4x4(){const t=new vi;return t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=0,t.data[3]=0,t.data[4]=this.data[2],t.data[5]=this.data[3],t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=this.data[4],t.data[13]=this.data[5],t.data[14]=0,t.data[15]=1,t}setRotation(t){const i=this.getScale(),n=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=n*i.y,this.data[2]=-n*i.x,this.data[3]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return Ms(t)}getScaleX(){const t=this.data[0]*this.data[0]+this.data[2]*this.data[2];return t===1?this._scaleSignX:this._scaleSignX*Math.sqrt(t)}getScaleY(){const t=this.data[1]*this.data[1]+this.data[3]*this.data[3];return t===1?this._scaleSignY:this._scaleSignY*Math.sqrt(t)}getScale(){return N(this.getScaleX(),this.getScaleY())}setScaleX(t){if(t===this._scale[0])return;this._scaleSignX=Xt(t);const i=N(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[2]=i.y*t,this._scale[0]=t}setScaleY(t){if(t===this._scale[1])return;this._scaleSignY=Xt(t);const i=N(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[3]=i.y*t,this._scale[1]=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}clone(t){const i=t||new xe;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i._scaleSignX=this._scaleSignX,i._scaleSignY=this._scaleSignY,i}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}let ho=class{constructor(t,i,n=1){this.builder=t,this.cleaner=i,this._pool=[],this._size=0,this.grow(n)}grow(t){if(t>0){this._size+=t;for(let i=0;i<t;i++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}};class qm{constructor(){this._pool=new ho(()=>xe.identity(),t=>t.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(t,i){return this._currentTransform.translate(t,i)}rotate(t){return this._currentTransform.rotate(t)}scale(t,i){return this._currentTransform.scale(t,i)}reset(){this._currentTransform.reset()}set current(t){this._currentTransform=t}get current(){return this._currentTransform}}class Ym{constructor(){this.opacity=1,this.z=0,this.tint=$.White,this.material=null}}class Tf{constructor(){this._pool=new ho(()=>new Ym,t=>(t.opacity=1,t.z=0,t.tint=$.White,t.material=null,t),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(t){var i;return t.opacity=this.current.opacity,t.z=this.current.z,t.tint=(i=this.current.tint)===null||i===void 0?void 0:i.clone(),t.material=this.current.material,t}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const jm={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class lo{constructor(t,i,n=!1){this.path=t,this.responseType=i,this.bustCache=n,this.data=null,this.logger=ut.getInstance(),this.events=new $t}isLoaded(){return this.data!==null}_cacheBust(t){return/\?\w*=\w*/.test(t)?t+="&__="+Date.now():t+="?__="+Date.now(),t}load(){return new Promise((t,i)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),t(this.data);return}const n=new XMLHttpRequest;n.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),n.responseType=this.responseType,n.addEventListener("loadstart",o=>this.events.emit("loadstart",o)),n.addEventListener("progress",o=>this.events.emit("progress",o)),n.addEventListener("error",o=>this.events.emit("error",o)),n.addEventListener("load",o=>this.events.emit("load",o)),n.addEventListener("load",()=>{if(n.status!==0&&n.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",n.status),this.events.emit("error",n.response),i(new Error(n.statusText));return}if(n.response instanceof Blob&&n.response.type==="text/html"){const o=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",n.response),i(new Error(o));return}this.data=n.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),t(this.data)}),n.send()})}}function Ni(d,t){return d&&(d.__isProxy===void 0?new Proxy(d,{set:(i,n,o)=>(i[n]!==o&&(i[n]=o,typeof n=="string"&&n[0]!=="_"&&t(i)),!0),get:(i,n)=>n!=="__isProxy"?i[n]:!0}):d)}const If=(d=[],t,i)=>({get:(n,o)=>o==="__isProxy"?!0:typeof n[o]=="object"&&n[o]!=null?new Proxy(n[o],If([...d,o],t,i)):n[o],set:(n,o,h)=>(typeof o=="string"&&o[0]!=="_"&&t(i),n[o]=h,!0)});function Qm(d,t){return d&&(d.__isProxy===void 0?new Proxy(d,If([],t,d)):d)}class he{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(t){this._flipHorizontal=t,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(t){this._flipVertical=t,this._transformStale=!0}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._transformStale=!0}get scale(){return this._scale}set scale(t){this._scale=Ni(t,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(t){t&&(this._origin=Ni(t,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(t){var i,n,o,h,c,g,_;this.id=he._ID++,this.transform=xe.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=k.One,this._width=0,this._height=0,t&&(this.origin=(i=t.origin)!==null&&i!==void 0?i:this.origin,this.flipHorizontal=(n=t.flipHorizontal)!==null&&n!==void 0?n:this.flipHorizontal,this.flipVertical=(o=t.flipVertical)!==null&&o!==void 0?o:this.flipVertical,this.rotation=(h=t.rotation)!==null&&h!==void 0?h:this.rotation,this.opacity=(c=t.opacity)!==null&&c!==void 0?c:this.opacity,this.scale=(g=t.scale)!==null&&g!==void 0?g:this.scale,this.tint=(_=t.tint)!==null&&_!==void 0?_:this.tint,t.width&&(this._width=t.width),t.height&&(this._height=t.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(t){this._width=t,this._transformStale=!0}set height(t){this._height=t,this._transformStale=!0}get localBounds(){return ct.fromDimension(this.width,this.height,k.Zero)}draw(t,i,n){this._preDraw(t,i,n),this._drawImage(t,0,0),this._postDraw(t)}_preDraw(t,i,n){t.save(),t.translate(i,n),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),t.multiply(this.transform),t.opacity=t.opacity*this.opacity,this.tint&&(t.tint=this.tint)}_rotate(t){var i;const n=this.scale.x>0?1:-1,o=this.scale.y>0?1:-1,h=(i=this.origin)!==null&&i!==void 0?i:N(this.width/2,this.height/2);t.translate(h.x,h.y),t.rotate(this.rotation),t.scale(n,o),t.translate(-h.x,-h.y)}_flip(t){this.flipHorizontal&&(t.translate(this.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,this.height/this.scale.y),t.scale(1,-1))}_postDraw(t){this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore()}}he._ID=0;class Gi extends he{static from(t,i){return new Gi({image:t,...i})}constructor(t){var i,n;super(t),this._logger=ut.getInstance(),this._dirty=!0,this.image=t.image;const{width:o,height:h}=t;this.sourceView=(i=t.sourceView)!==null&&i!==void 0?i:{x:0,y:0,width:o??0,height:h??0},this.destSize=(n=t.destSize)!==null&&n!==void 0?n:{width:o??0,height:h??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(t){t/=Math.abs(this.scale.x),this.destSize.width=t,super.width=Math.ceil(this.destSize.width)}set height(t){t/=Math.abs(this.scale.y),this.destSize.height=t,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var t,i,n,o,h,c;const{width:g,height:_}=this.image;this.sourceView.width=((t=this.sourceView)===null||t===void 0?void 0:t.width)||g,this.sourceView.height=((i=this.sourceView)===null||i===void 0?void 0:i.height)||_,this.destSize.width=((n=this.destSize)===null||n===void 0?void 0:n.width)||((o=this.sourceView)===null||o===void 0?void 0:o.width)||g,this.destSize.height=((h=this.destSize)===null||h===void 0?void 0:h.height)||((c=this.sourceView)===null||c===void 0?void 0:c.height)||_,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(t,i,n){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(t,i,n)}_drawImage(t,i,n){this.image.isLoaded()?t.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,i,n,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new Gi({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var be;(function(d){d.Pixel="Pixel",d.Blended="Blended"})(be||(be={}));function fr(d){switch(d){case be.Pixel:return be.Pixel;case be.Blended:return be.Blended;default:return}}var Jt;(function(d){d.Clamp="Clamp",d.Repeat="Repeat",d.Mirror="Mirror"})(Jt||(Jt={}));function qi(d){switch(d){case Jt.Clamp:return Jt.Clamp;case Jt.Repeat:return Jt.Repeat;case Jt.Mirror:return Jt.Mirror;default:return Jt.Clamp}}class oe{constructor(t,i){var n;this._garbageCollector=i,this._textureMap=new Map,this._collect=o=>{var h;if(this._gl){const c=(h=o.dataset.originalSrc)!==null&&h!==void 0?h:o.constructor.name;return oe._LOGGER.debug(`WebGL Texture for ${c} collected`),this.delete(o),!0}return!1},this._gl=t,oe._MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),this._garbageCollector&&(oe._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(n=this._garbageCollector.garbageCollector)===null||n===void 0||n.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[t]of this._textureMap)this.delete(t);this._textureMap.clear(),this._gl=null}get(t){return this._textureMap.get(t)}has(t){return this._textureMap.has(t)}load(t,i,n=!1){var o,h;const c=this._gl;if(!c)return null;const{filtering:g,wrapping:_}={...i};let v=null;if(this.has(t)&&(v=this.get(t)),v)return n&&(c.bindTexture(c.TEXTURE_2D,v),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t)),(o=this._garbageCollector)===null||o===void 0||o.garbageCollector.touch(t),v;v=c.createTexture(),oe.checkImageSizeSupportedAndLog(t),c.bindTexture(c.TEXTURE_2D,v),c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let x;_&&(typeof _=="string"?x={x:_,y:_}:x={x:_.x,y:_.y});const{x:A,y:S}=x??oe.wrapping;switch(A){case Jt.Clamp:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);break;case Jt.Repeat:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT);break;case Jt.Mirror:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.MIRRORED_REPEAT);break;default:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE)}switch(S){case Jt.Clamp:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);break;case Jt.Repeat:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT);break;case Jt.Mirror:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.MIRRORED_REPEAT);break;default:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE)}const P=g??oe.filtering;return c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,P===be.Pixel?c.NEAREST:c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,P===be.Pixel?c.NEAREST:c.LINEAR),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t),this._textureMap.set(t,v),(h=this._garbageCollector)===null||h===void 0||h.garbageCollector.addCollectableResource("texture",t),v}delete(t){const i=this._gl;if(i&&this.has(t)){const n=this.get(t);n&&(this._textureMap.delete(t),i.deleteTexture(n))}}static checkImageSizeSupportedAndLog(t){var i;const n=(i=t.dataset.originalSrc)!==null&&i!==void 0?i:"internal canvas bitmap";return t.width>oe._MAX_TEXTURE_SIZE||t.height>oe._MAX_TEXTURE_SIZE?(oe._LOGGER.error(`The image [${n}] provided to Excalibur is too large for the device's maximum texture size of (${oe._MAX_TEXTURE_SIZE}x${oe._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((t.width>4096||t.height>4096)&&oe._LOGGER.warn(`The image [${n}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}oe._LOGGER=ut.getInstance();oe.filtering=be.Blended;oe.wrapping={x:Jt.Clamp,y:Jt.Clamp};oe._MAX_TEXTURE_SIZE=4096;const Mt={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class ls{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(t,i,n){this._logger=ut.getInstance(),this.data=new Image,this._readyFuture=new Pi,this.ready=this._readyFuture.promise,this.path=t;let o=!1,h;typeof i=="boolean"?o=i:{filtering:n,wrapping:h,bustCache:o}={...i},this._resource=new lo(t,"blob",o),this.filtering=n??this.filtering,typeof h=="string"?this.wrapping={x:h,y:h}:this.wrapping=h??this.wrapping,t.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${t} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(t,i){const n=new ls("");if(n._src="image-element",n.data=t,n.data.setAttribute("data-original-src","image-element"),i?.filtering?n.data.setAttribute(Mt.Filtering,i?.filtering):n.data.setAttribute(Mt.Filtering,be.Blended),i?.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},n.data.setAttribute(Mt.WrappingX,o.x),n.data.setAttribute(Mt.WrappingY,o.y)}else n.data.setAttribute(Mt.WrappingX,Jt.Clamp),n.data.setAttribute(Mt.WrappingY,Jt.Clamp);return oe.checkImageSizeSupportedAndLog(t),n._readyFuture.resolve(t),n}static fromHtmlCanvasElement(t,i){const n=new ls("");if(n._src="canvas-element-blob",n.data.setAttribute("data-original-src","canvas-element-blob"),i?.filtering?n.data.setAttribute(Mt.Filtering,i?.filtering):n.data.setAttribute(Mt.Filtering,be.Blended),i?.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},n.data.setAttribute(Mt.WrappingX,o.x),n.data.setAttribute(Mt.WrappingY,o.y)}else n.data.setAttribute(Mt.WrappingX,Jt.Clamp),n.data.setAttribute(Mt.WrappingY,Jt.Clamp);return oe.checkImageSizeSupportedAndLog(t),t.toBlob(o=>{const h=URL.createObjectURL(o);n.image.onload=()=>{URL.revokeObjectURL(h),n.data=n.image,n._readyFuture.resolve(n.image)},n.image.src=h}),n}static fromSvgString(t,i){const n=new Blob([t],{type:"image/svg+xml"}),o=URL.createObjectURL(n);return new ls(o,i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){var t,i,n,o;if(this.isLoaded())return this.data;try{let h;if(this.path.includes("data:image/"))h=this.path;else{const _=await this._resource.load();h=URL.createObjectURL(_)}const c=new Image,g=new Pi;c.onload=()=>g.resolve(),c.src=h,c.setAttribute("data-original-src",this.path),await g.promise,this.data=c,oe.checkImageSizeSupportedAndLog(this.data)}catch(h){throw`Error loading ImageSource from path '${this.path}' with error [${h.message}]`}return this.data.setAttribute(Mt.Filtering,this.filtering),this.data.setAttribute(Mt.WrappingX,(i=(t=this.wrapping)===null||t===void 0?void 0:t.x)!==null&&i!==void 0?i:Jt.Clamp),this.data.setAttribute(Mt.WrappingY,(o=(n=this.wrapping)===null||n===void 0?void 0:n.y)!==null&&o!==void 0?o:Jt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(t){return Gi.from(this,t)}unload(){this.data=new Image}}class Ma extends he{constructor(t){super(t),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=ut.getInstance();const{alphabet:i,spriteSheet:n,caseInsensitive:o,spacing:h,shadow:c,lineHeight:g}=t;this.alphabet=i,this.spriteSheet=n,this.caseInsensitive=o??this.caseInsensitive,this.spacing=h??this.spacing,this.shadow=c??this.shadow,this.lineHeight=g??this.lineHeight}_getCharacterSprites(t){const i=[],n=this.caseInsensitive?t.toLocaleLowerCase():t,o=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let h=0;h<n.length;h++){const c=n[h];let g=o.indexOf(c);g===-1&&(g=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${c}' in configured alphabet '${o}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const _=this.spriteSheet.sprites[g];_?i.push(_):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${c}' at index '${g}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return i}measureText(t,i){const n=this._getLinesFromText(t,i),o=n.reduce((_,v)=>_.length>v.length?_:v),h=this._getCharacterSprites(o);let c=0,g=0;for(const _ of h)c+=_.width+this.spacing,g=Math.max(g,_.height);return ct.fromDimension(c*this.scale.x,g*n.length*this.scale.y,k.Zero)}_drawImage(t,i,n,o){var h;let c=0,g=0,_=0;const v=this._getLinesFromText(this._text,o);for(const x of v){for(const A of this._getCharacterSprites(x))A.draw(t,i+c,n+g),c+=A.width+this.spacing,_=Math.max(_,A.height);c=0,g+=(h=this.lineHeight)!==null&&h!==void 0?h:_}}render(t,i,n,o,h,c){this._text=i;const g=this.measureText(i,c);this.width=g.width,this.height=g.height,this.shadow&&(t.save(),t.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(t,o,h),this._drawImage(t,0,0,c),this._postDraw(t),t.restore()),this._preDraw(t,o,h),this._drawImage(t,0,0,c),this._postDraw(t)}clone(){return new Ma({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(t,i){var n;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let c=o[h],g="";if(this.measureText(c).width>i){for(;this.measureText(c).width>i;)g=c[c.length-1]+g,c=c.slice(0,-1);o[h]=c,o[h+1]=g}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class co extends Gi{constructor(t){super({image:t.image,sourceView:t.sourceView,destSize:{width:t.width,height:t.height},flipHorizontal:t.flipHorizontal,flipVertical:t.flipVertical,rotation:t.rotation,scale:t.scale,opacity:t.opacity,tint:t.tint,origin:t.origin}),this._ready=new Pi,this.ready=this._ready.promise,this._options=t,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(t,i){return new co({sourceView:{...t.sourceView},width:t.width,height:t.height,...i,image:t.image})}_applyTiling(){const{width:t,height:i,filtering:n,wrapping:o}={...this._options},h=document.createElement("canvas");h.width=this.sourceView.width,h.height=this.sourceView.height,h.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const g=ls.fromHtmlCanvasElement(h,{wrapping:o??Jt.Repeat,filtering:n});t&&(this.destSize.width=t,this.sourceView.width=t),i&&(this.destSize.height=i,this.sourceView.height=i),this.sourceView.x=0,this.sourceView.y=0,this.image=g,this.image.ready.then(()=>this._ready.resolve())}}class Rn{constructor(t){this.sprites=[];const{sprites:i,rows:n,columns:o}=t;this.sprites=i,this.rows=n??1,this.columns=o??this.sprites.length}getSprite(t,i,n){var o,h,c,g,_,v,x,A,S;if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const P=t+i*this.columns,I=this.sprites[P];if(I){if(n){const F=I.clone();return F.flipHorizontal=(o=n.flipHorizontal)!==null&&o!==void 0?o:F.flipHorizontal,F.flipVertical=(h=n.flipVertical)!==null&&h!==void 0?h:F.flipVertical,F.width=(c=n.width)!==null&&c!==void 0?c:F.width,F.height=(g=n.height)!==null&&g!==void 0?g:F.height,F.rotation=(_=n.rotation)!==null&&_!==void 0?_:F.rotation,F.scale=(v=n.scale)!==null&&v!==void 0?v:F.scale,F.opacity=(x=n.opacity)!==null&&x!==void 0?x:F.opacity,F.tint=(A=n.tint)!==null&&A!==void 0?A:F.tint,F.origin=(S=n.origin)!==null&&S!==void 0?S:F.origin,F}return I}throw Error(`Invalid sprite coordinates (${t}, ${i})`)}getTiledSprite(t,i,n){if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const o=t+i*this.columns,h=this.sprites[o];if(h)return co.fromSprite(h,n);throw Error(`Invalid sprite coordinates (${t}, ${i})`)}static fromImageSourceWithSourceViews(t){const i=t.sourceViews.map(n=>new Gi({image:t.image,sourceView:n}));return new Rn({sprites:i})}static fromImageSource(t){var i;const n=[];t.spacing=(i=t.spacing)!==null&&i!==void 0?i:{};const{image:o,grid:{rows:h,columns:c,spriteWidth:g,spriteHeight:_},spacing:{originOffset:v,margin:x}}=t,A={x:0,y:0,...v},S={x:0,y:0,...x};for(let P=0;P<c;P++)for(let I=0;I<h;I++)n[P+I*c]=new Gi({image:o,sourceView:{x:P*g+S.x*P+A.x,y:I*_+S.y*I+A.y,width:g,height:_},destSize:{height:_,width:g}});return new Rn({sprites:n,rows:h,columns:c})}clone(){return new Rn({sprites:this.sprites.map(t=>t.clone()),rows:this.rows,columns:this.columns})}}const Zm="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class lc{constructor(){this.fontSheet=Zm,this.size=16,this.load()}load(){return this._imageSource=new ls(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=Rn.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new Ma({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(t,i,n){this._imageSource.isLoaded()&&this._spriteFont.render(t,i,null,n.x,n.y)}}class Jm{constructor(t,i){this._gl=t,this._texture=i}use(){const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture)}disable(){const t=this._gl;t.bindTexture(t.TEXTURE_2D,null)}}class ra{constructor(t){var i,n;this.antialias=!1,this.samples=1,this._gl=t.gl,this.width=t.width,this.height=t.height,this.transparency=t.transparency,this.antialias=(i=t.antialias)!==null&&i!==void 0?i:this.antialias,this.samples=(n=t.samples)!==null&&n!==void 0?n:this._gl.getParameter(this._gl.MAX_SAMPLES);const o=this._gl;o.drawingBufferFormat?this.bufferFormat=o.drawingBufferFormat:this.transparency?this.bufferFormat=o.RGBA8:this.bufferFormat=o.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(t,i){const n=this._gl;this.width=t,this.height=i,n.bindTexture(n.TEXTURE_2D,this._frameTexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.width,this.height,0,n.RGBA,n.UNSIGNED_BYTE,null),this._renderBuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,this._renderBuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,Math.min(this.samples,n.getParameter(n.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const t=this._gl;this._renderBuffer=t.createRenderbuffer(),this._renderFrameBuffer=t.createFramebuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._renderBuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,Math.min(this.samples,t.getParameter(t.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const t=this._gl;this._frameTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._frameTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const i=t.COLOR_ATTACHMENT0;this._frameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,i,t.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new Jm(this._gl,this._frameTexture)}blitToScreen(){const t=this._gl;this._renderBuffer?(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)):(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.frameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const t=this._gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.frameBuffer),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)}}copyToTexture(t){const i=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this._frameBuffer),i.bindTexture(i.TEXTURE_2D,t),i.copyTexImage2D(i.TEXTURE_2D,0,i.RGBA,0,0,this.width,this.height,0)}use(){const t=this._gl;this.antialias?t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.viewport(0,0,this.width,this.height)}disable(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null)}}const Km=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,$m=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function Ml(d,t){switch(t){case d.INT:case d.UNSIGNED_INT:case d.FLOAT:return 4;case d.SHORT:return 2;case d.UNSIGNED_SHORT:return 2;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;default:return 1}}function Rf(d,t){const i=`(?<type>[a-z0-9]+)\\s+${t};`,o=new RegExp(i,"g").exec(d);return o?.length>0}function Df(d,t,i){var n;const o=`(?<type>[a-z0-9]+)\\s+${i};`,c=new RegExp(o,"g").exec(t);switch((n=c?.groups)===null||n===void 0?void 0:n.type){case"float":case"vec2":case"vec3":case"vec4":return d.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return d.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return d.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return d.BOOL;case"short":return d.SHORT;case"ushort":return d.UNSIGNED_SHORT;case"ubyte":return d.UNSIGNED_BYTE;case"byte":return d.BYTE;default:return d.FLOAT}}function Ff(d,t){switch(t){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:return 1;case d.FLOAT_VEC2:return 2;case d.FLOAT_VEC3:return 3;case d.FLOAT_VEC4:return 4;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;case d.UNSIGNED_SHORT:case d.SHORT:return 1;default:return 1}}function Mf(d,t){switch(t){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:case d.FLOAT_VEC2:case d.FLOAT_VEC3:case d.FLOAT_VEC4:return d.FLOAT;case d.BYTE:return d.BYTE;case d.UNSIGNED_BYTE:return d.UNSIGNED_BYTE;case d.SHORT:return d.SHORT;case d.UNSIGNED_SHORT:return d.UNSIGNED_SHORT;default:return d.FLOAT}}function cc(d,t){const i=o=>{const h=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let c="";for(let g=0;g<o;g++)g===0?c+=`if (index <= ${g}.5) {
`:c+=`   else if (index <= ${g}.5) {
`,c+=`      fragColor = vec4(1.0);
`,c+=`   }
`;return h.replace("%%complexity%%",c)};let n=!1;do{const o=i(t),h=d.createShader(d.FRAGMENT_SHADER);d.shaderSource(h,o),d.compileShader(h),n=d.getShaderParameter(h,d.COMPILE_STATUS),n||(t=t/2|0)}while(!n);return t}class gi{get compiled(){return this._compiled}constructor(t){this._logger=ut.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:i,vertexSource:n,fragmentSource:o,onPreLink:h,onPostCompile:c}=t;this._gl=i,this.vertexSource=n,this.fragmentSource=o,this._onPreLink=h,this._onPostCompile=c}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),gi._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return gi._ACTIVE_SHADER_INSTANCE===this}compile(){const t=this._gl,i=this._compileShader(t,this.vertexSource,t.VERTEX_SHADER),n=this._compileShader(t,this.fragmentSource,t.FRAGMENT_SHADER);this.program=this._createProgram(t,i,n);const o=this.getAttributes();for(const c of o)this.attributes[c.name]=c;const h=this.getUniforms();for(const c of h)this.uniforms[c.name]=c;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS),n=[];for(let o=0;o<i;o++){const h=t.getActiveUniform(this.program,o),c=t.getUniformLocation(this.program,h.name);n.push({name:h.name,glType:h.type,location:c})}return n}getAttributes(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES),n=[];for(let o=0;o<i;o++){const h=t.getActiveAttrib(this.program,o),c=t.getAttribLocation(this.program,h.name);n.push({name:h.name,glType:Mf(t,h.type),size:Ff(t,h.type),location:c,normalized:!1})}return n}setTexture(t,i){const n=this._gl;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,i)}setUniformInt(t,i){this.setUniform("uniform1i",t,~~i)}trySetUniformInt(t,i){return this.trySetUniform("uniform1i",t,~~i)}setUniformIntArray(t,i){this.setUniform("uniform1iv",t,i)}trySetUniformIntArray(t,i){return this.trySetUniform("uniform1iv",t,i)}setUniformBoolean(t,i){this.setUniform("uniform1i",t,i?1:0)}trySetUniformBoolean(t,i){return this.trySetUniform("uniform1i",t,i?1:0)}setUniformFloat(t,i){this.setUniform("uniform1f",t,i)}trySetUniformFloat(t,i){return this.trySetUniform("uniform1f",t,i)}setUniformFloatArray(t,i){this.setUniform("uniform1fv",t,i)}trySetUniformFloatArray(t,i){return this.trySetUniform("uniform1fv",t,i)}setUniformFloatVector(t,i){this.setUniform("uniform2f",t,i.x,i.y)}trySetUniformFloatVector(t,i){return this.trySetUniform("uniform2f",t,i.x,i.y)}setUniformFloatColor(t,i){this.setUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}trySetUniformFloatColor(t,i){return this.trySetUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}setUniformMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,i.data)}setUniformAffineMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,[i.data[0],i.data[1],0,0,i.data[2],i.data[3],0,0,0,0,1,0,i.data[4],i.data[5],0,1])}trySetUniformMatrix(t,i){return this.trySetUniform("uniformMatrix4fv",t,!1,i.data)}setUniform(t,i,...n){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${t}:${i}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const h=this._gl.getUniformLocation(this.program,i);if(h){const c=[h,...n];this._gl[t].apply(this._gl,c)}else throw Error(`Uniform ${t}:${i} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(t,i,...n){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${t}:${i}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const h=this._gl.getUniformLocation(this.program,i);if(h){const c=[h,...n];this._gl[t].apply(this._gl,c)}else return!1;return!0}_createProgram(t,i,n){const o=t.createProgram();if(o===null)throw Error("Could not create graphics shader program");if(t.attachShader(o,i),t.attachShader(o,n),this._onPreLink&&this._onPreLink(o),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw Error(`Could not link the program: [${t.getProgramInfoLog(o)}]`);return o}_compileShader(t,i,n){const o=t.VERTEX_SHADER===n?"vertex":"fragment",h=t.createShader(n);if(h===null)throw Error(`Could not build shader: [${i}]`);if(t.shaderSource(h,i),t.compileShader(h),!t.getShaderParameter(h,t.COMPILE_STATUS)){const g=t.getShaderInfoLog(h);throw Error(`Could not compile ${o} shader:

${g}${this._processSourceForError(i,g)}`)}return h}_processSourceForError(t,i){if(!t)return i;const n=t.split(`
`),o=i.search(/\d:\d/),h=i.indexOf(" ",o),[c,g]=i.slice(o,h).split(":").map(_=>Number(_));for(let _=0;_<n.length;_++)n[_]=`${_+1}: ${n[_]}${g===_+1?" <----- ERROR!":""}`;return`

Source:
`+n.join(`
`)}}gi._ACTIVE_SHADER_INSTANCE=null;class fs{constructor(t){this.type="dynamic";const{gl:i,size:n,type:o,data:h}=t;if(this._gl=i,this.buffer=this._gl.createBuffer(),!h&&!n)throw Error("Must either provide data or a size to the VertexBuffer");h?this.bufferData=h:this.bufferData=new Float32Array(n),this.type=o??this.type,i.bindBuffer(i.ARRAY_BUFFER,this.buffer),i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this.buffer)}unbind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,null)}upload(t){const i=this._gl;i.bindBuffer(i.ARRAY_BUFFER,this.buffer),t?i.bufferSubData(i.ARRAY_BUFFER,0,this.bufferData,0,t):i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class Hs{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(t){this._logger=ut.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:i,shader:n,vertexBuffer:o,attributes:h,suppressWarnings:c}=t;this._gl=i,this._vertexBuffer=o,this._attributes=h,this._shader=n,this._suppressWarnings=c,n&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(t){t&&this._shader!==t&&(this._shader=t,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const t=this._shader.attributes;for(const h of this._attributes){const c=t[h[0]];if(!c){if(!Rf(this._shader.vertexSource,h[0]))throw Error(`The attribute named: ${h[0]} size ${h[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${h[0]} size ${h[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${h[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${h[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const g=Df(this._gl,this._shader.vertexSource,h[0]);this._layout.push({name:h[0],glType:g,size:h[1],location:-1,normalized:!1})}if(c){if(c.size!==h[1])throw Error(`VertexLayout size definition for attribute: [${h[0]}, ${h[1]}], doesn't match shader source size ${c.size}:
 ${this._shader.vertexSource}`);this._layout.push(c)}}let i=0;for(const h of this._layout){const c=Ml(this._gl,h.glType);this._vertexTotalSizeBytes+=c*h.size,i+=h.size}this._vertexBuffer.bufferData.length%i!==0&&this._logger.warn(`The vertex component size (${i})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const n=this._gl;this._vao=n.createVertexArray(),n.bindVertexArray(this._vao),this._vertexBuffer.bind();let o=0;for(const h of this._layout)h.location!==-1&&(h.glType===n.INT?n.vertexAttribIPointer(h.location,h.size,h.glType,this.totalVertexSizeBytes,o):n.vertexAttribPointer(h.location,h.size,h.glType,h.normalized,this.totalVertexSizeBytes,o),n.enableVertexAttribArray(h.location)),o+=Ml(n,h.glType)*h.size;n.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(t=!1,i){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const n=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),t&&this._vertexBuffer.upload(i),n.bindVertexArray(this._vao)}}class Kt{static clear(){Kt.DrawCallCount=0,Kt.DrawnImagesCount=0}}Kt.DrawCallCount=0;Kt.DrawnImagesCount=0;class tv{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=N(0,0),this._endScratch=N(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new gi({gl:t,vertexSource:Km,fragmentSource:$m}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new fs({gl:t,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new Hs({gl:t,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,n){this._isFull()&&this.flush(),this._lineCount++;const o=this._context.getTransform(),h=o.multiply(t,this._startScratch),c=o.multiply(i,this._endScratch),g=this._vertexBuffer.bufferData;g[this._vertexIndex++]=h.x,g[this._vertexIndex++]=h.y,g[this._vertexIndex++]=n.r/255,g[this._vertexIndex++]=n.g/255,g[this._vertexIndex++]=n.b/255,g[this._vertexIndex++]=n.a,g[this._vertexIndex++]=c.x,g[this._vertexIndex++]=c.y,g[this._vertexIndex++]=n.r/255,g[this._vertexIndex++]=n.g/255,g[this._vertexIndex++]=n.b/255,g[this._vertexIndex++]=n.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.LINES,0,this._lineCount*2),Kt.DrawnImagesCount+=this._lineCount,Kt.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const ev=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,iv=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class sv{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new gi({gl:t,vertexSource:ev,fragmentSource:iv}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new fs({gl:t,size:7*this._maxPoints,type:"dynamic"}),this._layout=new Hs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,n){this._isFull()&&this.flush(),this._pointCount++;const o=this._context.getTransform(),h=this._context.opacity,c=this._context.snapToPixel,g=o.multiply(t);c&&(g.x=~~(g.x+vt),g.y=~~(g.y+vt));const _=this._buffer.bufferData;_[this._vertexIndex++]=g.x,_[this._vertexIndex++]=g.y,_[this._vertexIndex++]=i.r/255,_[this._vertexIndex++]=i.g/255,_[this._vertexIndex++]=i.b/255,_[this._vertexIndex++]=i.a*h,_[this._vertexIndex++]=n*Math.max(o.getScaleX(),o.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.POINTS,0,this._pointCount),Kt.DrawnImagesCount+=this._pointCount,Kt.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const nv=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,rv=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class ov{constructor(t){this._gl=t,this._shader=new gi({gl:t,vertexSource:nv,fragmentSource:rv}),this._shader.compile(),this._buffer=new fs({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Hs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(t){const i=this._gl,n=t.getShader();n.use(),t.getLayout().use(),i.activeTexture(i.TEXTURE0),n.trySetUniformInt("u_image",0),t.onDraw&&t.onDraw(),i.drawArrays(i.TRIANGLES,0,6)}renderToScreen(){const t=this._gl;this._shader.use(),this._layout.use(),t.drawArrays(t.TRIANGLES,0,6)}}class uo{constructor(t,i,n){this._logger=ut.getInstance(),this._gl=t,this.buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer);const o=i*6;if(!n)this.bufferData=new Uint32Array(o);else{const g=Math.floor(16383.5);this.bufferGlType=t.UNSIGNED_SHORT,this.bufferData=new Uint16Array(o),i>g&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${g}) requested quads(${i})`)}let h=0;for(let c=0;c<o;c+=6)this.bufferData[c+0]=h+0,this.bufferData[c+1]=h+1,this.bufferData[c+2]=h+2,this.bufferData[c+3]=h+2,this.bufferData[c+4]=h+1,this.bufferData[c+5]=h+3,h+=4;t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const av=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,hv=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class lv{constructor(t){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=$.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=cc(t,n);this._maxTextures=Math.min(n,o);const h=this._transformFragmentSource(av,this._maxTextures);this._shader=new gi({gl:t,fragmentSource:h,vertexSource:hv}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((c,g)=>g)),this._buffer=new fs({gl:t,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new Hs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new uo(t,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let n=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_textureIndex <= ${h}.5) {
`:o+=`   else if (v_textureIndex <= ${h}.5) {
`,o+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return n=n.replace("%%texture_picker%%",o),n}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(Mt.Filtering),n=i?fr(i):void 0,o=qi(t.getAttribute(Mt.WrappingX)),h=qi(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);t.removeAttribute("forceUpload"),this._textures.indexOf(g)===-1&&(this._textures.push(g),this._textureToIndex.set(g,this._textureIndex++),this._images.add(t))}_bindTextures(t){for(let i=0;i<this._maxTextures;i++)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,this._textures[i]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const n=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(n))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,n,o,h,c,g,_,v){var x,A,S,P;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const I=this._getImageWidth(t),F=this._getImageHeight(t);let R=I||o||0,E=F||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(x=o??I)!==null&&x!==void 0?x:0,this._view[3]=(A=h??F)!==null&&A!==void 0?A:0,this._dest[0]=i??1,this._dest[1]=n??1,c!==void 0&&g!==void 0&&_!==void 0&&v!==void 0&&(this._view[0]=i??1,this._view[1]=n??1,this._view[2]=(S=o??I)!==null&&S!==void 0?S:0,this._view[3]=(P=h??F)!==null&&P!==void 0?P:0,this._dest[0]=c,this._dest[1]=g,R=_,E=v),i=this._view[0],n=this._view[1];const M=this._view[2],V=this._view[3],L=this._context.getTransform(),G=this._context.opacity,j=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+R,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+E,this._quad[6]=this._dest[0]+R,this._quad[7]=this._dest[1]+E,L.multiplyQuadInPlace(this._quad),j&&(this._quad[0]=~~(this._quad[0]+Xt(this._quad[0])*vt),this._quad[1]=~~(this._quad[1]+Xt(this._quad[1])*vt),this._quad[2]=~~(this._quad[2]+Xt(this._quad[2])*vt),this._quad[3]=~~(this._quad[3]+Xt(this._quad[3])*vt),this._quad[4]=~~(this._quad[4]+Xt(this._quad[4])*vt),this._quad[5]=~~(this._quad[5]+Xt(this._quad[5])*vt),this._quad[6]=~~(this._quad[6]+Xt(this._quad[6])*vt),this._quad[7]=~~(this._quad[7]+Xt(this._quad[7])*vt));const X=this._context.tint||this._defaultTint,rt=this._getTextureIdForImage(t),lt=I||R,yt=F||E,wt=(i+this.uvPadding)/lt,Pt=(n+this.uvPadding)/yt,Dt=(i+M-this.uvPadding)/lt,B=(n+V-this.uvPadding)/yt,z=I,Z=F,et=this._layout.vertexBuffer.bufferData;et[this._vertexIndex++]=this._quad[0],et[this._vertexIndex++]=this._quad[1],et[this._vertexIndex++]=G,et[this._vertexIndex++]=z,et[this._vertexIndex++]=Z,et[this._vertexIndex++]=wt,et[this._vertexIndex++]=Pt,et[this._vertexIndex++]=rt,et[this._vertexIndex++]=X.r/255,et[this._vertexIndex++]=X.g/255,et[this._vertexIndex++]=X.b/255,et[this._vertexIndex++]=X.a,et[this._vertexIndex++]=this._quad[4],et[this._vertexIndex++]=this._quad[5],et[this._vertexIndex++]=G,et[this._vertexIndex++]=z,et[this._vertexIndex++]=Z,et[this._vertexIndex++]=wt,et[this._vertexIndex++]=B,et[this._vertexIndex++]=rt,et[this._vertexIndex++]=X.r/255,et[this._vertexIndex++]=X.g/255,et[this._vertexIndex++]=X.b/255,et[this._vertexIndex++]=X.a,et[this._vertexIndex++]=this._quad[2],et[this._vertexIndex++]=this._quad[3],et[this._vertexIndex++]=G,et[this._vertexIndex++]=z,et[this._vertexIndex++]=Z,et[this._vertexIndex++]=Dt,et[this._vertexIndex++]=Pt,et[this._vertexIndex++]=rt,et[this._vertexIndex++]=X.r/255,et[this._vertexIndex++]=X.g/255,et[this._vertexIndex++]=X.b/255,et[this._vertexIndex++]=X.a,et[this._vertexIndex++]=this._quad[6],et[this._vertexIndex++]=this._quad[7],et[this._vertexIndex++]=G,et[this._vertexIndex++]=z,et[this._vertexIndex++]=Z,et[this._vertexIndex++]=Dt,et[this._vertexIndex++]=B,et[this._vertexIndex++]=rt,et[this._vertexIndex++]=X.r/255,et[this._vertexIndex++]=X.g/255,et[this._vertexIndex++]=X.b/255,et[this._vertexIndex++]=X.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),this._quads.bind(),t.drawElements(t.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),Kt.DrawnImagesCount+=this._imageCount,Kt.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const cv=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,dv=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class uv{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=$.Transparent,this._scratch1=N(0,0),this._scratch2=N(0,0),this._scratch3=N(0,0),this._scratch4=N(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new gi({gl:t,fragmentSource:cv,vertexSource:dv}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new fs({gl:t,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new Hs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new uo(t,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...t){t[0]instanceof k&&t[1]instanceof k?this.drawLine.apply(this,t):this.drawRectangle.apply(this,t)}drawLine(t,i,n,o=1){this._isFull()&&this.flush(),this._rectangleCount++;const h=this._context.getTransform(),c=this._context.opacity,g=this._context.snapToPixel,_=i.sub(t),v=_.magnitude,x=_.normalize().perpendicular(),A=o/2,S=h.multiply(x.scale(A,this._scratch1).add(t,this._scratch1),this._scratch1),P=h.multiply(x.scale(-A,this._scratch2).add(t,this._scratch2),this._scratch2),I=h.multiply(x.scale(A,this._scratch3).add(i,this._scratch3),this._scratch3),F=h.multiply(x.scale(-A,this._scratch4).add(i,this._scratch4),this._scratch4);g&&(S.x=~~(S.x+vt),S.y=~~(S.y+vt),I.x=~~(I.x+vt),I.y=~~(I.y+vt),P.x=~~(P.x+vt),P.y=~~(P.y+vt),F.x=~~(F.x+vt),F.y=~~(F.y+vt));const R=0,E=0,M=1,V=1,L=this._transparent,G=0,j=1,X=this._layout.vertexBuffer.bufferData;X[this._vertexIndex++]=S.x,X[this._vertexIndex++]=S.y,X[this._vertexIndex++]=R,X[this._vertexIndex++]=E,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=L.r/255,X[this._vertexIndex++]=L.g/255,X[this._vertexIndex++]=L.b/255,X[this._vertexIndex++]=L.a,X[this._vertexIndex++]=G/j,X[this._vertexIndex++]=P.x,X[this._vertexIndex++]=P.y,X[this._vertexIndex++]=R,X[this._vertexIndex++]=V,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=L.r/255,X[this._vertexIndex++]=L.g/255,X[this._vertexIndex++]=L.b/255,X[this._vertexIndex++]=L.a,X[this._vertexIndex++]=G/j,X[this._vertexIndex++]=I.x,X[this._vertexIndex++]=I.y,X[this._vertexIndex++]=M,X[this._vertexIndex++]=E,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=L.r/255,X[this._vertexIndex++]=L.g/255,X[this._vertexIndex++]=L.b/255,X[this._vertexIndex++]=L.a,X[this._vertexIndex++]=G/j,X[this._vertexIndex++]=F.x,X[this._vertexIndex++]=F.y,X[this._vertexIndex++]=M,X[this._vertexIndex++]=V,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=L.r/255,X[this._vertexIndex++]=L.g/255,X[this._vertexIndex++]=L.b/255,X[this._vertexIndex++]=L.a,X[this._vertexIndex++]=G/j}drawRectangle(t,i,n,o,h=$.Transparent,c=0){this._isFull()&&this.flush(),this._rectangleCount++;const g=this._context.getTransform(),_=this._context.opacity,v=this._context.snapToPixel,x=g.multiply(t.add(N(0,0))),A=g.multiply(t.add(N(i,0))),S=g.multiply(t.add(N(i,n))),P=g.multiply(t.add(N(0,n)));v&&(x.x=~~(x.x+vt),x.y=~~(x.y+vt),A.x=~~(A.x+vt),A.y=~~(A.y+vt),P.x=~~(P.x+vt),P.y=~~(P.y+vt),S.x=~~(S.x+vt),S.y=~~(S.y+vt));const I=0,F=0,R=1,E=1,M=this._layout.vertexBuffer.bufferData;M[this._vertexIndex++]=x.x,M[this._vertexIndex++]=x.y,M[this._vertexIndex++]=I,M[this._vertexIndex++]=F,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=_,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=P.x,M[this._vertexIndex++]=P.y,M[this._vertexIndex++]=I,M[this._vertexIndex++]=E,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=_,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=A.x,M[this._vertexIndex++]=A.y,M[this._vertexIndex++]=R,M[this._vertexIndex++]=F,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=_,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=S.x,M[this._vertexIndex++]=S.y,M[this._vertexIndex++]=R,M[this._vertexIndex++]=E,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=_,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),Kt.DrawnImagesCount+=this._rectangleCount,Kt.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const fv=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,gv=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class pv{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new gi({gl:t,fragmentSource:fv,vertexSource:gv}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new fs({gl:t,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new Hs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new uo(t,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(t,i,n,o=$.Transparent,h=0){this._isFull()&&this.flush(),this._circleCount++;const c=this._context.getTransform(),g=this._context.opacity,_=this._context.snapToPixel,v=c.multiply(t.add(N(-i,-i))),x=c.multiply(t.add(N(i,-i))),A=c.multiply(t.add(N(i,i))),S=c.multiply(t.add(N(-i,i)));_&&(v.x=~~(v.x+vt),v.y=~~(v.y+vt),x.x=~~(x.x+vt),x.y=~~(x.y+vt),S.x=~~(S.x+vt),S.y=~~(S.y+vt),A.x=~~(A.x+vt),A.y=~~(A.y+vt));const P=0,I=0,F=1,R=1,E=this._layout.vertexBuffer.bufferData;E[this._vertexIndex++]=v.x,E[this._vertexIndex++]=v.y,E[this._vertexIndex++]=P,E[this._vertexIndex++]=I,E[this._vertexIndex++]=g,E[this._vertexIndex++]=n.r/255,E[this._vertexIndex++]=n.g/255,E[this._vertexIndex++]=n.b/255,E[this._vertexIndex++]=n.a,E[this._vertexIndex++]=o.r/255,E[this._vertexIndex++]=o.g/255,E[this._vertexIndex++]=o.b/255,E[this._vertexIndex++]=o.a,E[this._vertexIndex++]=h/i,E[this._vertexIndex++]=S.x,E[this._vertexIndex++]=S.y,E[this._vertexIndex++]=P,E[this._vertexIndex++]=R,E[this._vertexIndex++]=g,E[this._vertexIndex++]=n.r/255,E[this._vertexIndex++]=n.g/255,E[this._vertexIndex++]=n.b/255,E[this._vertexIndex++]=n.a,E[this._vertexIndex++]=o.r/255,E[this._vertexIndex++]=o.g/255,E[this._vertexIndex++]=o.b/255,E[this._vertexIndex++]=o.a,E[this._vertexIndex++]=h/i,E[this._vertexIndex++]=x.x,E[this._vertexIndex++]=x.y,E[this._vertexIndex++]=F,E[this._vertexIndex++]=I,E[this._vertexIndex++]=g,E[this._vertexIndex++]=n.r/255,E[this._vertexIndex++]=n.g/255,E[this._vertexIndex++]=n.b/255,E[this._vertexIndex++]=n.a,E[this._vertexIndex++]=o.r/255,E[this._vertexIndex++]=o.g/255,E[this._vertexIndex++]=o.b/255,E[this._vertexIndex++]=o.a,E[this._vertexIndex++]=h/i,E[this._vertexIndex++]=A.x,E[this._vertexIndex++]=A.y,E[this._vertexIndex++]=F,E[this._vertexIndex++]=R,E[this._vertexIndex++]=g,E[this._vertexIndex++]=n.r/255,E[this._vertexIndex++]=n.g/255,E[this._vertexIndex++]=n.b/255,E[this._vertexIndex++]=n.a,E[this._vertexIndex++]=o.r/255,E[this._vertexIndex++]=o.g/255,E[this._vertexIndex++]=o.b/255,E[this._vertexIndex++]=o.a,E[this._vertexIndex++]=h/i}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),Kt.DrawnImagesCount+=this._circleCount,Kt.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class Ba{constructor(t,i,n=100){this.builder=t,this.recycler=i,this.maxObjects=n,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=ut.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let t=0;t<this.maxObjects;t++)this.objects[t]=this.builder()}using(t){const i=t(this);return i?this.done(...i):this.done()}borrow(t){const i=this.get();t(i),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...t){this.index=0;for(const i of t){const n=this.objects.indexOf(i);this.objects[n]=this.builder(),this.totalAllocations++}return t}}class _v{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=xe.identity(),this.state={z:0,opacity:1,tint:$.White,material:null},this.args=new Array(10)}}const mv=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class Bf{constructor(t){this._logger=ut.getInstance(),this._color=$.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:i,name:n,vertexSource:o,fragmentSource:h,graphicsContext:c,images:g}=t;if(this._name=n??"anonymous material",this._vertexSource=o??mv,this._fragmentSource=h,this._color=i??this._color,!c)throw Error(`Material ${n} must be provided an excalibur webgl graphics context`);if(c instanceof Bs?(this._graphicsContext=c,this._initialize(c)):this._logger.warn(`Material ${n} was created in 2D Canvas mode, currently only WebGL is supported`),g)for(const _ in g)this.addImageSource(_,g[_])}_initialize(t){if(this._initialized)return;const i=t.__gl;this._maxTextureSlots=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=t.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(t){this._color=t}get name(){var t;return(t=this._name)!==null&&t!==void 0?t:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(t){this._shader&&(this._shader.use(),t(this._shader))}getShader(){return this._shader}addImageSource(t,i){this._images.size<this._maxTextureSlots?this._images.set(t,i):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(t){const i=this._images.get(t);this._graphicsContext.textureLoader.delete(i.image),this._images.delete(t)}_loadImageSource(t){const i=t.image,n=i.getAttribute(Mt.Filtering),o=n?fr(n):void 0,h=qi(i.getAttribute(Mt.WrappingX)),c=qi(i.getAttribute(Mt.WrappingY)),g=i.getAttribute("forceUpload")==="true",_=this._graphicsContext.textureLoader.load(i,{filtering:o,wrapping:{x:h,y:c}},g);return i.removeAttribute("forceUpload"),this._textures.has(t)||this._textures.set(t,_),_}uploadAndBind(t,i=2){let n=i;for(const[o,h]of this._images.entries()){if(!h.isLoaded()){this._logger.warnOnce(`Image named ${o} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const c=this._loadImageSource(h);t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,c),this._shader.trySetUniformInt(o,n),n++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class nf{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(t,i){this._gl=t,this._context=i,this._buffer=new fs({gl:t,size:6*4,type:"dynamic"}),this._layout=new Hs({gl:t,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new uo(t,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(t,i,n,o,h,c,g,_,v){var x,A,S,P;const I=this._gl,F=this._context.material;if(!F)return;const R=this._context.getTransform(),E=this._context.opacity,M=F.getShader(),V=this._layout.vertexBuffer.bufferData;let L=0,G=t?.width||o||0,j=t?.height||h||0,X=[0,0,(x=o??t?.width)!==null&&x!==void 0?x:0,(A=h??t?.height)!==null&&A!==void 0?A:0],rt=[i??1,n??1];c!==void 0&&g!==void 0&&_!==void 0&&v!==void 0&&(X=[i??1,n??1,(S=o??t?.width)!==null&&S!==void 0?S:0,(P=h??t?.height)!==null&&P!==void 0?P:0],rt=[c,g],G=_,j=v),i=X[0],n=X[1];const lt=X[2],yt=X[3],wt=N(rt[0],rt[1]),Pt=N(rt[0]+G,rt[1]),Dt=N(rt[0],rt[1]+j),B=N(rt[0]+G,rt[1]+j),z=t.width||G,Z=t.height||j,et=i/z,Wt=n/Z,at=(i+lt-.01)/z,Fi=(n+yt-.01)/Z,_s=R.getPosition(),Rt=_s.add(B),ht=_s.x/this._context.width,Os=_s.y/this._context.height,xo=Rt.x/this._context.width,ms=Rt.y/this._context.height;V[L++]=wt.x,V[L++]=wt.y,V[L++]=et,V[L++]=Wt,V[L++]=ht,V[L++]=Os,V[L++]=Dt.x,V[L++]=Dt.y,V[L++]=et,V[L++]=Fi,V[L++]=ht,V[L++]=ms,V[L++]=Pt.x,V[L++]=Pt.y,V[L++]=at,V[L++]=Wt,V[L++]=xo,V[L++]=Os,V[L++]=B.x,V[L++]=B.y,V[L++]=at,V[L++]=Fi,V[L++]=xo,V[L++]=ms;const Ao=this._addImageAsTexture(t);F.use(),this._layout.shader=M,this._layout.use(!0),M.trySetUniformFloat("u_time_ms",performance.now()),M.trySetUniformFloat("u_opacity",E),M.trySetUniformFloatVector("u_resolution",N(this._context.width,this._context.height)),M.trySetUniformFloatVector("u_graphic_resolution",N(z,Z)),M.trySetUniformFloatVector("u_size",N(lt,yt)),M.trySetUniformMatrix("u_matrix",this._context.ortho),M.trySetUniformMatrix("u_transform",R.to4x4()),I.activeTexture(I.TEXTURE0+0),I.bindTexture(I.TEXTURE_2D,Ao),M.trySetUniformInt("u_graphic",0),I.activeTexture(I.TEXTURE0+1),I.bindTexture(I.TEXTURE_2D,this._context.materialScreenTexture),M.trySetUniformInt("u_screen_texture",1),F.uploadAndBind(I),this._quads.bind(),I.drawElements(I.TRIANGLES,6,this._quads.bufferGlType,0),Kt.DrawnImagesCount++,Kt.DrawCallCount++}_addImageAsTexture(t){const i=t.getAttribute(Mt.Filtering),n=i?fr(i):void 0,o=qi(t.getAttribute(Mt.WrappingX)),h=qi(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);return t.removeAttribute("forceUpload"),this._textures.indexOf(g)===-1&&this._textures.push(g),g}hasPendingDraws(){return!1}flush(){}}const vv=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,wv=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var ze;(function(d){d.World="world",d.Screen="screen"})(ze||(ze={}));class Bl extends k{constructor(t){super(0,0),this._getX=t.getX,this._getY=t.getY,this._setX=t.setX,this._setY=t.setY}get x(){return this._x=this._getX()}set x(t){this._setX(t),this._x=t}get y(){return this._y=this._getY()}set y(t){this._setY(t),this._y=t}}class $s extends k{constructor(t,i){super(t.x,t.y),this.original=t,this.change=i}get x(){return this._x=this.original.x}set x(t){t!==this._x&&(this.change(t,this._y),this._x=this.original.x=t)}get y(){return this._y=this.original.y}set y(t){t!==this._y&&(this.change(this._x,t),this._y=this.original.y=t)}setTo(t,i){this.x=t,this.y=i}}class Ls{constructor(){this._parent=null,this._children=[],this._pos=new $s(N(0,0),()=>{this.flagDirty()}),this._globalPos=new Bl({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:t=>{if(this.parent){const{x:i}=this.parent.inverse.multiply(N(t,this.pos.y));this.pos.x=i}else this.pos.x=t;t!==this.matrix.data[4]&&this.flagDirty()},setY:t=>{if(this.parent){const{y:i}=this.parent.inverse.multiply(N(this.pos.x,t));this.pos.y=i}else this.pos.y=t;t!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new $s(N(1,1),()=>{this.flagDirty()}),this._globalScale=new Bl({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:t=>{if(this.parent){const i=this.parent.globalScale.x;this.scale.x=t/i}else this.scale.x=t},setY:t=>{if(this.parent){const i=this.parent.globalScale.y;this.scale.y=t/i}else this.scale.y=t}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=xe.identity(),this._inverse=xe.identity(),this._scratch=xe.identity()}get parent(){return this._parent}set parent(t){if(this._parent){const i=this._parent._children.indexOf(this);i>-1&&this._parent._children.splice(i,1)}this._parent=t,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(t){this._pos.x=t.x,this._pos.y=t.y}get pos(){return this._pos}set globalPos(t){let i=t.clone();this.parent&&(i=this.parent.inverse.multiply(t)),i.equals(this._pos)||(this._pos=i,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(t){const i=Ms(t);i!==this._rotation&&this.flagDirty(),this._rotation=i}get rotation(){return this._rotation}set globalRotation(t){let i=0;this.parent&&(i=this.parent.globalRotation);const n=Ms(t+i);n!==this._rotation&&this.flagDirty(),this._rotation=n}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(t){this._scale.x=t.x,this._scale.y=t.y}get scale(){return this._scale}set globalScale(t){let i=N(1,1);this.parent&&(i=this.parent.globalScale),this.scale=t.scale(N(1/i.x,1/i.y))}get globalScale(){return this._globalScale}set z(t){this._z=t,this.flagDirty()}get z(){return this._z}set globalZ(t){this.parent?this.z=t-this.parent.globalZ:this.z=t}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let t=0;t<this._children.length;t++)this._children[t].flagDirty()}apply(t){return this.matrix.multiply(t)}applyInverse(t){return this.inverse.multiply(t)}setTransform(t,i,n){this._pos.x=t.x,this._pos.y=t.y,this._rotation=Ms(i),this._scale.x=n.x,this._scale.y=n.y,this.flagDirty()}isMirrored(){const t=Xt(this.scale.x)>>>31,i=Xt(this.scale.y)>>>31;return!!(t^i)}clone(t){const i=t??new Ls;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.flagDirty(),i}cloneWithParent(t){const i=t??new Ls;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.parent=this.parent,i.flagDirty(),i}toString(){return this.matrix.toString()}}function kf(d){return!!d&&!!d.prototype&&!!d.prototype.constructor}function xv(d){return!!d?.clone}class Di{constructor(){this.owner=void 0}clone(){const t=new this.constructor;for(const i in this)if(this.hasOwnProperty(i)){const n=this[i];xv(n)&&i!=="owner"&&i!=="clone"?t[i]=n.clone():t[i]=n}return t}}class ei{constructor(){this.observers=[],this.subscriptions=[]}register(t){this.observers.push(t)}subscribe(t){this.subscriptions.push(t)}unregister(t){const i=this.observers.indexOf(t);i!==-1&&this.observers.splice(i,1)}unsubscribe(t){const i=this.subscriptions.indexOf(t);i!==-1&&this.subscriptions.splice(i,1)}notifyAll(t){const i=this.observers.length;for(let o=0;o<i;o++)this.observers[o].notify(t);const n=this.subscriptions.length;for(let o=0;o<n;o++)this.subscriptions[o](t)}clear(){this.observers.length=0,this.subscriptions.length=0}}class nt extends Di{constructor(){super(...arguments),this._logger=ut.getInstance(),this._parentComponent=null,this._transform=new Ls,this._addChildTransform=t=>{const i=t.get(nt);i&&(i._transform.parent=this._transform,i._parentComponent=this)},this.zIndexChanged$=new ei,this._coordPlane=ze.World}get(){return this._transform}onAdd(t){for(const i of t.children)this._addChildTransform(i);t.childrenAdded$.subscribe(i=>this._addChildTransform(i)),t.childrenRemoved$.subscribe(i=>{const n=i.get(nt);n&&(n._transform.parent=null,n._parentComponent=null)})}onRemove(t){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(t){const i=this._transform.z;this._transform.z=t,i!==t&&this.zIndexChanged$.notifyAll(t)}get globalZ(){return this._transform.globalZ}set globalZ(t){this._transform.globalZ=t}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(t){var i;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(i=this.owner)===null||i===void 0?void 0:i.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=t}get pos(){return this._transform.pos}set pos(t){this._transform.pos=t}get globalPos(){return this._transform.globalPos}set globalPos(t){this._transform.globalPos=t}get rotation(){return this._transform.rotation}set rotation(t){this._transform.rotation=t}get globalRotation(){return this._transform.globalRotation}set globalRotation(t){this._transform.globalRotation=t}get scale(){return this._transform.scale}set scale(t){this._transform.scale=t}get globalScale(){return this._transform.globalScale}set globalScale(t){this._transform.globalScale=t}applyInverse(t){return this._transform.applyInverse(t)}apply(t){return this._transform.apply(t)}clone(){const t=new nt;return t._transform=this._transform.clone(),t}}var Qr;(function(d){d.Forward="forward",d.Backward="backward"})(Qr||(Qr={}));var Oi;(function(d){d.End="end",d.Loop="loop",d.PingPong="pingpong",d.Freeze="freeze"})(Oi||(Oi={}));const Av={Frame:"frame",Loop:"loop",End:"end"};class Wi extends he{constructor(t){var i,n,o;super(t),this.events=new $t,this.frames=[],this.strategy=Oi.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=t.frames,this.speed=(i=t.speed)!==null&&i!==void 0?i:this.speed,this.strategy=(n=t.strategy)!==null&&n!==void 0?n:this.strategy,this.frameDuration=t.totalDuration?t.totalDuration/this.frames.length:(o=t.frameDuration)!==null&&o!==void 0?o:this.frameDuration,t.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new Wi({frames:this.frames.map(t=>({...t})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.width*this.scale.x):0}get height(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.height*this.scale.y):0}static fromSpriteSheet(t,i,n,o=Oi.Loop){const h=t.sprites.length-1,c=i.filter(g=>g<0||g>h);return c.length&&Wi._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${c.join(",")} no frame will be shown`),new Wi({frames:t.sprites.filter((g,_)=>i.indexOf(_)>-1).map(g=>({graphic:g,duration:n})),strategy:o})}static fromSpriteSheetCoordinates(t){var i;const{spriteSheet:n,frameCoordinates:o,durationPerFrame:h,durationPerFrameMs:c,speed:g,strategy:_,reverse:v}=t,x=(i=h??c)!==null&&i!==void 0?i:100,A=[];for(const S of o){const{x:P,y:I,duration:F,options:R}=S,E=n.getSprite(P,I,R);E?A.push({graphic:E,duration:F??x}):Wi._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${P}, ${I}), please check your SpriteSheet to confirm that sprite exists`)}return new Wi({frames:A,strategy:_,speed:g,reverse:v})}get speed(){return this._speed}set speed(t){this._speed=St(Math.abs(t),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?Qr.Backward:Qr.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const t=this.frames[this._currentFrame];t&&(this._timeLeftInFrame=t?.duration||this.frameDuration)}get canFinish(){switch(this.strategy){case Oi.End:case Oi.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(t,i){this._currentFrame=t,this._timeLeftInFrame=i??this.frameDuration;const n=this.frames[this._currentFrame];n&&!this._done&&(this._timeLeftInFrame=i??(n?.duration||this.frameDuration),this.events.emit("frame",{...n,frameIndex:this.currentFrameIndex}))}_nextFrame(){const t=this._currentFrame;if(this._done)return t;let i=-1;switch(this.strategy){case Oi.Loop:{i=(t+1)%this.frames.length,i===0&&this.events.emit("loop",this);break}case Oi.End:{i=t+1,i>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case Oi.Freeze:{i=St(t+1,0,this.frames.length-1),i>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case Oi.PingPong:{t+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),t+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),i=t+this._pingPongDirection%this.frames.length;break}}return i}tick(t,i=0){this._idempotencyToken!==i&&(this._idempotencyToken=i,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=t*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(t,i,n){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(t,i,n)}}Wi._LOGGER=ut.getInstance();class rr extends he{constructor(t){var i;super(t),this._logger=ut.getInstance(),this.useAnchor=!0,this.members=[],this.members=t.members,this.useAnchor=(i=t.useAnchor)!==null&&i!==void 0?i:this.useAnchor,this._updateDimensions()}clone(){return new rr({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const t=this.localBounds;return this.width=t.width,this.height=t.height,t}get localBounds(){const t=new ct;for(const i of this.members)if(i instanceof he)i.localBounds.combine(t,t);else{const{graphic:n,offset:o,useBounds:h}=i;n?(h===void 0?!0:h)&&n.localBounds.translate(o).combine(t,t):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(i)}.`)}return t}_isAnimationOrGroup(t){return t instanceof Wi||t instanceof rr}tick(t,i){for(const n of this.members){let o;n instanceof he?o=n:o=n.graphic,this._isAnimationOrGroup(o)&&o.tick(t,i)}}reset(){for(const t of this.members){let i;t instanceof he?i=t:i=t.graphic,this._isAnimationOrGroup(i)&&i.reset()}}_preDraw(t,i,n){this._updateDimensions(),super._preDraw(t,this.useAnchor?i:0,this.useAnchor?n:0)}_drawImage(t,i,n){const o=k.Zero;for(const h of this.members){let c;h instanceof he?c=h:(c=h.graphic,h.offset.clone(o)),c&&(t.save(),t.translate(i,n),c.draw(t,o.x,o.y),this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore())}}}class gr extends he{constructor(t){var i,n,o,h,c,g,_,v,x,A;super(Ef({...t},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=Ni($.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,t&&(this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this.color=(n=t.color)!==null&&n!==void 0?n:$.Black,this.strokeColor=t?.strokeColor,this.smoothing=(o=t.smoothing)!==null&&o!==void 0?o:this.smoothing,this.lineWidth=(h=t.lineWidth)!==null&&h!==void 0?h:this.lineWidth,this.lineDash=(c=t.lineDash)!==null&&c!==void 0?c:this.lineDash,this.lineCap=(g=t.lineCap)!==null&&g!==void 0?g:this.lineCap,this.padding=(_=t.padding)!==null&&_!==void 0?_:this.padding,this.filtering=(v=t.filtering)!==null&&v!==void 0?v:this.filtering),this._bitmap=document.createElement("canvas");const S=(x=t?.width)!==null&&x!==void 0?x:this._bitmap.width,P=(A=t?.height)!==null&&A!==void 0?A:this._bitmap.height;this.width=S,this.height=P;const I=this._bitmap.getContext("2d");if(I)this._ctx=I;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(t){t/=Math.abs(this.scale.x),this._bitmap.width=t,this._originalWidth=t,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(t){t/=Math.abs(this.scale.y),this._bitmap.height=t,this._originalHeight=t,this.flagDirty()}_getTotalWidth(){var t;return(((t=this._originalWidth)!==null&&t!==void 0?t:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var t;return(((t=this._originalHeight)!==null&&t!==void 0?t:this._bitmap.height)+this.padding*2)*1}get localBounds(){return ct.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,k.Zero)}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this.flagDirty()}get color(){return this._color}set color(t){this.flagDirty(),this._color=Ni(t,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(t){this.flagDirty(),t&&(this._strokeColor=Ni(t,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(t){this._lineDash=t,this.flagDirty()}get padding(){return this._padding}set padding(t){this._padding=t,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(t){var i,n,o,h;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),t.scale(this.quality,this.quality),t.translate(this.padding,this.padding),t.imageSmoothingEnabled=this.smoothing,t.lineWidth=this.lineWidth,t.setLineDash((i=this.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.lineCap=this.lineCap,t.strokeStyle=(o=(n=this.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&o!==void 0?o:"",t.fillStyle=(h=this.color)===null||h===void 0?void 0:h.toString()}_drawImage(t,i,n){this._dirty&&this.rasterize(),t.scale(1/this.quality,1/this.quality),t.drawImage(this._bitmap,i,n)}}var pa;(function(d){d.Em="em",d.Rem="rem",d.Px="px",d.Pt="pt",d.Percent="%"})(pa||(pa={}));var _a;(function(d){d.Left="left",d.Right="right",d.Center="center",d.Start="start",d.End="end"})(_a||(_a={}));var ma;(function(d){d.Top="top",d.Hanging="hanging",d.Middle="middle",d.Alphabetic="alphabetic",d.Ideographic="ideographic",d.Bottom="bottom"})(ma||(ma={}));var va;(function(d){d.Normal="normal",d.Italic="italic",d.Oblique="oblique"})(va||(va={}));var wa;(function(d){d.LeftToRight="ltr",d.RightToLeft="rtl"})(wa||(wa={}));function kl(d,t=$.Red,i,n,o,h,c=1,g="butt"){d.save(),d.beginPath(),d.lineWidth=c,d.lineCap=g,d.strokeStyle=t.toString(),d.moveTo(i,n),d.lineTo(o,h),d.closePath(),d.stroke(),d.restore()}function bv(d,t=$.Red,i){d.beginPath(),d.strokeStyle=t.toString(),d.arc(i.x,i.y,5,0,Math.PI*2),d.closePath(),d.stroke()}function yv(d,t,i,n,o=1){const h=t?t.toString():"blue",c=n.scale(o);d.beginPath(),d.strokeStyle=h,d.moveTo(i.x,i.y),d.lineTo(i.x+c.x,i.y+c.y),d.closePath(),d.stroke()}function Ll(d,t,i,n,o,h=5,c=$.White,g=null){let _;if(typeof h=="number")_={tl:h,tr:h,br:h,bl:h};else{const v={tl:0,tr:0,br:0,bl:0};for(const x in v)if(v.hasOwnProperty(x)){const A=x;_[A]=h[A]||v[A]}}d.beginPath(),d.moveTo(t+_.tl,i),d.lineTo(t+n-_.tr,i),d.quadraticCurveTo(t+n,i,t+n,i+_.tr),d.lineTo(t+n,i+o-_.br),d.quadraticCurveTo(t+n,i+o,t+n-_.br,i+o),d.lineTo(t+_.bl,i+o),d.quadraticCurveTo(t,i+o,t,i+o-_.bl),d.lineTo(t,i+_.tl),d.quadraticCurveTo(t,i,t+_.tl,i),d.closePath(),g&&(d.fillStyle=g.toString(),d.fill()),c&&(d.strokeStyle=c.toString(),d.stroke())}function Cv(d,t,i,n,o=$.White,h=null){d.beginPath(),d.arc(t,i,n,0,Math.PI*2),d.closePath(),h&&(d.fillStyle=h.toString(),d.fill()),o&&(d.strokeStyle=o.toString(),d.stroke())}class ir{constructor(t,i,n,o){this.font=t,this.text=i,this.color=n,this.maxWidth=o,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const h=this.canvas.getContext("2d");if(!h)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=h,this.dimensions=this.measureText(i),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(t,i){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let n=null;i!=null?n=this._getLinesFromText(t,i):n=t.split(`
`);const o=n.reduce((S,P)=>S.length>P.length?S:P);this._applyFont(this.ctx);const h=this.ctx.measureText(o);let c=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);const g=c*n.length;c=g;const _=g-Math.abs(h.actualBoundingBoxAscent),v=0,x=0;return new ct({left:v-Math.abs(h.actualBoundingBoxLeft)-this.font.padding,top:x-Math.abs(h.actualBoundingBoxAscent)-this.font.padding,bottom:x+_+this.font.padding,right:v+Math.abs(h.actualBoundingBoxRight)+this.font.padding})}_setDimension(t,i){let n=1;this.font.lineHeight&&(n=this.font.lineHeight/this.font.size),i.canvas.width=(t.width+this.font.padding*2)*2*this.font.quality,i.canvas.height=(t.height+this.font.padding*2)*2*this.font.quality*n}static getHashCode(t,i,n){var o;return i+"__hashcode__"+t.fontString+t.showDebug+t.textAlign+t.baseAlign+t.direction+t.lineHeight+JSON.stringify(t.shadow)+(t.padding.toString()+t.smoothing.toString()+t.lineWidth.toString()+t.lineDash.toString()+((o=t.strokeColor)===null||o===void 0?void 0:o.toString())+(n?n.toString():t.color.toString()))}getHashCode(t=!0){return ir.getHashCode(this.font,this.text,t?this.color:void 0)}_applyRasterProperties(t){var i,n,o;t.translate(this.font.padding,this.font.padding),t.imageSmoothingEnabled=this.font.smoothing,t.lineWidth=this.font.lineWidth,t.setLineDash((i=this.font.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.strokeStyle=(o=(n=this.font.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&o!==void 0?o:"",t.fillStyle=this.color.toString()}_applyFont(t){t.resetTransform(),t.translate(this.font.padding+t.canvas.width/2,this.font.padding+t.canvas.height/2),t.scale(this.font.quality,this.font.quality),t.textAlign=this.font.textAlign,t.textBaseline=this.font.baseAlign,t.font=this.font.fontString,t.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(t.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(t.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(t.shadowOffsetX=this.font.shadow.offset.x,t.shadowOffsetY=this.font.shadow.offset.y))}_drawText(t,i,n){this._applyRasterProperties(t),this._applyFont(t);for(let o=0;o<i.length;o++){const h=i[o];this.color&&t.fillText(h,0,o*n),this.font.strokeColor&&t.strokeText(h,0,o*n)}this.font.showDebug&&(kl(t,$.Green,-t.canvas.width/2,0,t.canvas.width/2,0,2),kl(t,$.Red,0,-t.canvas.height/2,0,t.canvas.height/2,2))}_splitTextBitmap(t){const i=[];let n=0,o=0;const h=Math.min(4096,t.canvas.width),c=Math.min(4096,t.canvas.height);for(;n<t.canvas.width;){for(;o<t.canvas.height;){const g=document.createElement("canvas");g.width=h,g.height=c;const _=g.getContext("2d");if(!_)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");_.drawImage(t.canvas,n,o,h,c,0,0,h,c),i.push({x:n,y:o,canvas:g}),o+=c}n+=h,o=0}return i}flagDirty(){this._dirty=!0}render(t,i,n,o){var h;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=t;const c=this.getHashCode();if(this._lastHashCode!==c&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,o),this._setDimension(this.dimensions,this.ctx);const g=this._getLinesFromText(this.text,o),_=(h=this.font.lineHeight)!==null&&h!==void 0?h:this.dimensions.height/g.length;if(this._drawText(this.ctx,g,_),t instanceof Bs)for(const v of this._textFragments)t.textureLoader.delete(v.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),t instanceof Bs)for(const v of this._textFragments)t.textureLoader.load(v.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=c,this._dirty=!1}for(const g of this._textFragments)t.drawImage(g.canvas,0,0,g.canvas.width,g.canvas.height,g.x/this.font.quality+i-this.ctx.canvas.width/this.font.quality/2,g.y/this.font.quality+n-this.ctx.canvas.height/this.font.quality/2,g.canvas.width/this.font.quality,g.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof Bs)for(const t of this._textFragments)this._ex.textureLoader.delete(t.canvas);this._textFragments.length=0}_getLinesFromText(t,i){var n;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let c=o[h],g="";if(this.measureText(c).width>i){for(;this.measureText(c).width>i;)g=c[c.length-1]+g,c=c.slice(0,-1);o[h]=c,o[h+1]=g}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class Ht{static measureText(t,i,n){const o=ir.getHashCode(i,t);if(Ht._MEASURE_CACHE.has(o))return Ht._MEASURE_CACHE.get(o);Ht._LOGGER.debug("Font text measurement cache miss");const h=i.measureTextWithoutCache(t,n);return Ht._MEASURE_CACHE.set(o,h),h}static getTextInstance(t,i,n){const o=ir.getHashCode(i,t,n);let h=Ht._TEXT_CACHE.get(o);return h||(h=new ir(i,t,n),Ht._TEXT_CACHE.set(o,h),Ht._LOGGER.debug("Font text instance cache miss")),Ht._TEXT_USAGE.set(h,performance.now()),h}static checkAndClearCache(){const t=[],i=new Set;for(const[o,h]of Ht._TEXT_USAGE.entries())if(h+Ht.FONT_TIMEOUT<performance.now())Ht._LOGGER.debug(`Text cache entry timed out ${o.text}`),t.push(o),o.dispose();else{const c=o.getHashCode(!1);i.add(c)}t.forEach(o=>{Ht._TEXT_USAGE.delete(o)}),this._TEXT_CACHE.clear();for(const[o]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(o.getHashCode(),o);const n=new Map;for(const o of i)Ht._MEASURE_CACHE.has(o)&&n.set(o,Ht._MEASURE_CACHE.get(o));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=n}static get cacheSize(){return Ht._TEXT_USAGE.size}static clearCache(){for(const[t]of Ht._TEXT_USAGE.entries())t.dispose();Ht._TEXT_USAGE.clear(),Ht._TEXT_CACHE.clear(),Ht._MEASURE_CACHE.clear()}}Ht.FONT_TIMEOUT=500;Ht._LOGGER=ut.getInstance();Ht._TEXT_USAGE=new Map;Ht._TEXT_CACHE=new Map;Ht._MEASURE_CACHE=new Map;class Ln extends he{constructor(t={}){var i,n,o,h,c,g,_,v,x,A,S,P,I,F,R,E,M,V,L,G;super(t),this.filtering=be.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=$.Black,this.family="sans-serif",this.style=va.Normal,this.bold=!1,this.unit=pa.Px,this.textAlign=_a.Left,this.baseAlign=ma.Top,this.direction=wa.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new ct,this._textMeasurement=new ir(this,"",$.Black),this.smoothing=(i=t?.smoothing)!==null&&i!==void 0?i:this.smoothing,this.padding=(n=t?.padding)!==null&&n!==void 0?n:this.padding,this.color=(o=t?.color)!==null&&o!==void 0?o:this.color,this.strokeColor=(h=t?.strokeColor)!==null&&h!==void 0?h:this.strokeColor,this.lineDash=(c=t?.lineDash)!==null&&c!==void 0?c:this.lineDash,this.lineWidth=(g=t?.lineWidth)!==null&&g!==void 0?g:this.lineWidth,this.filtering=(_=t?.filtering)!==null&&_!==void 0?_:this.filtering,this.family=(v=t?.family)!==null&&v!==void 0?v:this.family,this.style=(x=t?.style)!==null&&x!==void 0?x:this.style,this.bold=(A=t?.bold)!==null&&A!==void 0?A:this.bold,this.size=(S=t?.size)!==null&&S!==void 0?S:this.size,this.unit=(P=t?.unit)!==null&&P!==void 0?P:this.unit,this.textAlign=(I=t?.textAlign)!==null&&I!==void 0?I:this.textAlign,this.baseAlign=(F=t?.baseAlign)!==null&&F!==void 0?F:this.baseAlign,this.direction=(R=t?.direction)!==null&&R!==void 0?R:this.direction,this.lineHeight=(E=t?.lineHeight)!==null&&E!==void 0?E:this.lineHeight,this.quality=(M=t?.quality)!==null&&M!==void 0?M:this.quality,t?.shadow&&(this.shadow={},this.shadow.blur=(V=t.shadow.blur)!==null&&V!==void 0?V:this.shadow.blur,this.shadow.offset=(L=t.shadow.offset)!==null&&L!==void 0?L:this.shadow.offset,this.shadow.color=(G=t.shadow.color)!==null&&G!==void 0?G:this.shadow.color)}clone(){return new Ln({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(t,i,n){}_rotate(t){var i;const n=(i=this.origin)!==null&&i!==void 0?i:this._textBounds.center;t.translate(n.x,n.y),t.rotate(this.rotation),t.translate(-n.x,-n.y)}_flip(t){this.flipHorizontal&&(t.translate(this._textBounds.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,-this._textBounds.height/2/this.scale.y),t.scale(1,-1))}measureTextWithoutCache(t,i){return this._textMeasurement.measureText(t,i)}measureText(t,i){return Ht.measureText(t,this,i)}_postDraw(t){t.restore()}render(t,i,n,o,h,c){const g=Ht.getTextInstance(i,this,n);this._textBounds=g.dimensions,this._preDraw(t,o,h),g.render(t,o,h,c),this._postDraw(t)}}class fo extends he{constructor(t){var i,n;super(t),this._text="",this._textWidth=0,this._textHeight=0,this.font=(i=t.font)!==null&&i!==void 0?i:new Ln,this.color=(n=t.color)!==null&&n!==void 0?n:this.color,this.text=t.text,this.maxWidth=t.maxWidth}clone(){var t,i;return new fo({text:this.text.slice(),color:(i=(t=this.color)===null||t===void 0?void 0:t.clone())!==null&&i!==void 0?i:$.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(t){this._text=t,this._calculateDimension()}get font(){return this._font}set font(t){this._font=t}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:t,height:i}=this.font.measureText(this._text,this.maxWidth);this._textWidth=t,this._textHeight=i}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(t){}_flip(t){}_preDraw(t,i,n){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(t,i,n)}_drawImage(t,i,n){var o;let h=$.Black;this.font instanceof Ln&&(h=(o=this.color)!==null&&o!==void 0?o:this.font.color);const{width:c,height:g}=this.font.measureText(this._text,this.maxWidth);this._textWidth=c,this._textHeight=g,this.font.render(t,this._text,h,i,n,this.maxWidth),this.font.showDebug&&(t.debug.drawRect(i-c,n-g,c*2,g*2),this.maxWidth!=null&&t.debug.drawRect(i,n,this.maxWidth,this.height,{color:$.Yellow}))}}function dc(d){return!!d.tick}class ce extends Di{get visible(){return this.isVisible}set visible(t){this.isVisible=t}get offset(){return this._offset}set offset(t){this._offset=new $s(t,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(t){this._anchor=new $s(t,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(t){if(t){this._color=t.clone();const i=this.graphics.current;(i instanceof gr||i instanceof fo)&&(i.color=this._color)}}constructor(t){super(),this._logger=ut.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new $s(k.Zero,()=>this.recalculateBounds()),this._anchor=new $s(k.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,t={visible:this.isVisible,graphics:{},...t};const{current:i,anchor:n,color:o,opacity:h,visible:c,graphics:g,offset:_,copyGraphics:v,onPreDraw:x,onPostDraw:A,onPreTransformDraw:S,onPostTransformDraw:P}=t;for(const[I,F]of Object.entries(g))F instanceof he?this._graphics[I]=F:(this._graphics[I]=F.graphic,this._options[I]=F.options);this.offset=_??this.offset,this.opacity=h??this.opacity,this.anchor=n??this.anchor,this.color=o??this.color,this.copyGraphics=v??this.copyGraphics,this.onPreDraw=x??this.onPreDraw,this.onPostDraw=A??this.onPostDraw,this.onPreDraw=S??this.onPreTransformDraw,this.onPostTransformDraw=P??this.onPostTransformDraw,this.isVisible=!!c,this._current=i??this._current,i&&this._graphics[i]&&this.use(i)}getGraphic(t){return this._graphics[t]}getOptions(t){return this._options[t]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(t,i,n){let o="default",h=null,c;if(typeof t=="string"&&i instanceof he&&(o=t,h=i,c=n),t instanceof he&&!(i instanceof he)&&(h=t,c=i),!h)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[o]=this.copyGraphics?h.clone():h,this._options[o]=this.copyGraphics?{...c}:c,o==="default"&&this.use("default"),h}remove(t){delete this._graphics[t],delete this._options[t],this._current===t&&(this._current="default",this.recalculateBounds())}use(t,i){var n;if(t instanceof he){let o=t;this.copyGraphics&&(o=t.clone()),this._current="default",this._graphics[this._current]=o,this._options[this._current]=i}else this._current=t,this._options[this._current]=i,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(n=this.owner)===null||n===void 0?void 0:n.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(t){this._localBounds=t}recalculateBounds(){let t=new ct;const i=this._graphics[this._current],n=this._options[this._current];if(!i){this._localBounds=t;return}let o=this.anchor,h=this.offset;n?.anchor&&(o=n.anchor),n?.offset&&(h=n.offset);const c=i.localBounds,g=-c.width*o.x+h.x,_=-c.height*o.y+h.y;i instanceof rr&&!i.useAnchor?t=i?.localBounds.combine(t):t=i?.localBounds.translate(N(g,_)).combine(t),this._localBounds=t}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let t=this.localBounds;if(this.owner){const i=this.owner.get(nt);i&&(t=t.transform(i.get().matrix))}return t}update(t,i=0){const n=this.current;n&&dc(n)&&n.tick(t,i)}clone(){const t=new ce;return t._graphics={...this._graphics},t._options={...this._options},t.offset=this.offset.clone(),this.color&&(t.color=this.color.clone()),t.opacity=this.opacity,t.anchor=this.anchor.clone(),t.copyGraphics=this.copyGraphics,t.onPreDraw=this.onPreDraw,t.onPostDraw=this.onPostDraw,t.isVisible=this.isVisible,t}}var xa;(function(d){d.Kill="kill",d.PreKill="prekill",d.PostKill="postkill",d.PreDraw="predraw",d.PostDraw="postdraw",d.PreDebugDraw="predebugdraw",d.PostDebugDraw="postdebugdraw",d.PreUpdate="preupdate",d.PostUpdate="postupdate",d.PreFrame="preframe",d.PostFrame="postframe",d.PreCollision="precollision",d.CollisionStart="collisionstart",d.CollisionEnd="collisionend",d.PostCollision="postcollision",d.Initialize="initialize",d.Activate="activate",d.Deactivate="deactivate",d.ExitViewport="exitviewport",d.EnterViewport="enterviewport",d.ExitTrigger="exit",d.EnterTrigger="enter",d.Connect="connect",d.Disconnect="disconnect",d.Button="button",d.Axis="axis",d.Visible="visible",d.Hidden="hidden",d.Start="start",d.Stop="stop",d.PointerUp="pointerup",d.PointerDown="pointerdown",d.PointerMove="pointermove",d.PointerEnter="pointerenter",d.PointerLeave="pointerleave",d.PointerCancel="pointercancel",d.PointerWheel="pointerwheel",d.Up="up",d.Down="down",d.Move="move",d.Enter="enter",d.Leave="leave",d.Cancel="cancel",d.Wheel="wheel",d.Press="press",d.Release="release",d.Hold="hold",d.PointerDragStart="pointerdragstart",d.PointerDragEnd="pointerdragend",d.PointerDragEnter="pointerdragenter",d.PointerDragLeave="pointerdragleave",d.PointerDragMove="pointerdragmove",d.ActionStart="actionstart",d.ActionComplete="actioncomplete",d.Add="add",d.Remove="remove"})(xa||(xa={}));class bt{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(t){this._bubbles=t}stopPropagation(){this.bubbles=!1}}class ka extends bt{constructor(t){super(),this.self=t,this.target=t}}class uc extends bt{constructor(t){super(),this.self=t,this.target=t}}class fc extends bt{constructor(t){super(),this.self=t,this.target=t}}class gc extends bt{constructor(t){super(),this.self=t,this.target=t}}class pc extends bt{constructor(t){super(),this.self=t,this.target=t}}class pr extends bt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class _r extends bt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class _c extends bt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class mc extends bt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class vc extends bt{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class wc extends bt{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class nn extends bt{constructor(t,i,n){super(),this.engine=t,this.elapsed=i,this.self=n,this.target=n}}class rn extends bt{constructor(t,i,n){super(),this.engine=t,this.elapsed=i,this.self=n,this.target=n}}class xc extends bt{constructor(t,i){super(),this.engine=t,this.prevStats=i,this.target=t}}class Ac extends bt{constructor(t,i){super(),this.engine=t,this.stats=i,this.target=t}}class bc extends bt{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class yc extends bt{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class Cc extends bt{constructor(t,i,n,o){super(),this.button=t,this.index=i,this.value=n,this.self=o,this.target=o}}class Sc extends bt{constructor(t,i,n){super(),this.axis=t,this.value=i,this.self=n,this.target=n}}class Pc extends bt{constructor(t){super(),this.self=t,this.target=t}}class Ec extends bt{constructor(t){super(),this.self=t,this.target=t}}class Un extends bt{constructor(t,i,n,o,h){super(),this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h,this.target=t}}class zn extends bt{constructor(t,i,n,o,h){super(),this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h,this.target=t}}class Aa{constructor(t,i,n,o){this.self=t,this.other=i,this.side=n,this.contact=o}}class ba{constructor(t,i,n,o){this.self=t,this.other=i,this.side=n,this.lastContact=o}}class ya{constructor(t,i,n,o,h){this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h}}class Ca{constructor(t,i,n,o,h){this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h}}class Zr extends bt{constructor(t,i,n,o){super(),this.self=t,this.other=i,this.side=n,this.contact=o,this.target=t}}class Jr extends bt{constructor(t,i,n,o){super(),this.self=t,this.other=i,this.side=n,this.lastContact=o,this.target=t}}class mr extends bt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class Tc extends bt{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class Ic extends bt{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class Rc extends bt{constructor(t){super(),this.self=t,this.target=t}}class Dc extends bt{constructor(t){super(),this.self=t,this.target=t}}class Fc extends bt{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class Mc extends bt{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class Bc extends bt{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class kc extends bt{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class Lc extends bt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class Uc extends bt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class Sv{constructor(t){this.data=t,this.type="Component Added"}}function Pv(d){return!!d&&d.type==="Component Added"}class Ev{constructor(t){this.data=t,this.type="Component Removed"}}function Tv(d){return!!d&&d.type==="Component Removed"}const Iv={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class Qe{constructor(t,i){this.id=Qe._ID++,this.name=`Entity#${this.id}`,this.events=new $t,this._tags=new Set,this.componentAdded$=new ei,this.componentRemoved$=new ei,this.tagAdded$=new ei,this.tagRemoved$=new ei,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new ei,this.childrenRemoved$=new ei,this._children=[],this._isInitialized=!1,this._isAdded=!1;let n,o;if(Array.isArray(t))n=t,o=i;else if(t&&typeof t=="object"){const{components:h,name:c,silenceWarnings:g}=t;n=h??[],o=c}if(o&&(this.name=o),n)for(const h of n)this.addComponent(h)}get active(){return this.isActive}set active(t){this.isActive=t}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new ka(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(t){return this._tags.has(t)}addTag(t){return this._tags.add(t),this.tagAdded$.notifyAll(t),this}removeTag(t){return this._tags.delete(t),this.tagRemoved$.notifyAll(t),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(t){for(let i=0;i<t.length;i++)if(!this.components.has(t[i]))return!1;return!0}hasAllTags(t){for(let i=0;i<t.length;i++)if(!this.tags.has(t[i]))return!1;return!0}get(t){return this.components.get(t)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(t){if(t.parent===null){if(this.getAncestors().includes(t))throw new Error("Cycle detected, cannot add entity");this._children.push(t),t._parent=this,this.childrenAdded$.notifyAll(t)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(t){return t.parent===this&&(ur(t,this._children),t._parent=null,this.childrenRemoved$.notifyAll(t)),this}removeAllChildren(){for(let t=this.children.length-1;t>=0;t--)this.removeChild(this.children[t]);return this}getAncestors(){const t=[this];let i=this.parent;for(;i;)t.push(i),i=i.parent;return t.reverse()}getDescendants(){let t=[this],i=[this];for(;i.length>0;){const n=i.pop();n&&(i=i.concat(n.children),t=t.concat(n.children))}return t}clone(){const t=new Qe;for(const i of this.types){const n=this.get(i);n&&t.addComponent(n.clone())}for(const i of this.children)t.addChild(i.clone());return t}addTemplate(t,i=!1){for(const n of t.getComponents())this.addComponent(n.clone(),i);for(const n of t.children)this.addChild(n.clone().addTemplate(n));return this}_getClassHierarchyRoot(t){var i,n;let o=t,h=(i=Object.getPrototypeOf(o.prototype))===null||i===void 0?void 0:i.constructor;for(;h&&h!==Object&&h!==Di;)o=h,h=(n=Object.getPrototypeOf(o.prototype))===null||n===void 0?void 0:n.constructor;return o}addComponent(t,i=!1){if(this.has(t.constructor))if(i)this.removeComponent(t.constructor,!0);else return this;if(t.dependencies&&t.dependencies.length)for(const o of t.dependencies)this.addComponent(new o);t.owner=this;const n=this._getClassHierarchyRoot(t.constructor);return this.components.set(n,t),this.components.set(t.constructor,t),this.componentValues.push(t),t.onAdd&&t.onAdd(this),this.componentAdded$.notifyAll(t),this}removeComponent(t,i=!1){let n;if(kf(t)?n=t:n=t.constructor,i){const o=this.components.get(n);if(o){this.componentRemoved$.notifyAll(o),o.owner=void 0,o.onRemove&&o.onRemove(this);const c=this.componentValues.indexOf(o);c>-1&&this.componentValues.splice(c,1)}const h=this._getClassHierarchyRoot(n);this.components.delete(h),this.components.delete(n)}else this._componentsToRemove.push(n);return this}clearComponents(){const t=this.types;for(const i of t)this.removeComponent(i)}processComponentRemoval(){for(const t of this._componentsToRemove)this.removeComponent(t,!0);this._componentsToRemove.length=0}has(t){return this.components.has(t)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(t){this.isInitialized||(this.onInitialize(t),this.events.emit("initialize",new mr(t,this)),this._isInitialized=!0)}_add(t){!this.isAdded&&this.isActive&&(this.onAdd(t),this.events.emit("add",new Lc(t,this)),this._isAdded=!0)}_remove(t){this.isAdded&&!this.isActive&&(this.onRemove(t),this.events.emit("remove",new Uc(t,this)),this._isAdded=!1)}_preupdate(t,i){this.events.emit("preupdate",new nn(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new rn(t,i,this)),this.onPostUpdate(t,i)}onInitialize(t){}onAdd(t){}onRemove(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i);for(const n of this.children)n.update(t,i);this._postupdate(t,i),this._remove(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}Qe._ID=0;class kt extends Di{constructor(){super(...arguments),this.vel=k.Zero,this.acc=k.Zero,this.scaleFactor=k.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class ti{static integrate(t,i,n,o){const h=o/1e3;i.vel.addEqual(n.scale(h,ti._ACC)),t.pos.add(i.vel.scale(h,ti._VEL),ti._POS).addEqual(n.scale(.5*h*h,ti._VEL_ACC)),i.angularVelocity+=i.torque*(1/i.inertia)*h;const c=t.rotation+i.angularVelocity*h;t.scale.add(i.scaleFactor.scale(h,this._SCALE_FACTOR),ti._SCALE),t.get().setTransform(ti._POS,c,ti._SCALE)}}ti._POS=new k(0,0);ti._SCALE=new k(1,1);ti._ACC=new k(0,0);ti._VEL=new k(0,0);ti._VEL_ACC=new k(0,0);ti._SCALE_FACTOR=new k(0,0);class La extends Qe{constructor(t){super({silenceWarnings:!0}),this.beginColor=$.White,this.endColor=$.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=$.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=Yi.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new nt),this.addComponent(this.motion=new kt),this.addComponent(this.graphics=new ce),this.configure(t)}registerEmitter(t){if(this._emitter=t,this.particleTransform===Yi.Global){const i=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(i),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(t){var i,n,o,h,c,g,_,v,x,A,S,P,I,F;this.particleTransform=(i=t.transform)!==null&&i!==void 0?i:this.particleTransform,this.life=(n=t.life)!==null&&n!==void 0?n:this.life,this.fade=(o=t.fade)!==null&&o!==void 0?o:this.fade,this.size=(h=t.size)!==null&&h!==void 0?h:this.size,this.endColor=(c=t.endColor)!==null&&c!==void 0?c:this.endColor.clone(),this.beginColor=(g=t.beginColor)!==null&&g!==void 0?g:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=t.graphic,this.graphics.opacity=(_=t.opacity)!==null&&_!==void 0?_:this.graphics.opacity,this.transform.pos=(v=t.pos)!==null&&v!==void 0?v:this.transform.pos,this.transform.rotation=(x=t.rotation)!==null&&x!==void 0?x:0,this.transform.scale=N(1,1),this.motion.vel=(A=t.vel)!==null&&A!==void 0?A:this.motion.vel,this.motion.angularVelocity=(S=t.angularVelocity)!==null&&S!==void 0?S:0,this.motion.acc=(P=t.acc)!==null&&P!==void 0?P:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(I=t.startSize)!==null&&I!==void 0?I:0,this.endSize=(F=t.endSize)!==null&&F!==void 0?F:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=ct.fromDimension(this.size,this.size,k.Half),this.graphics.onPostDraw=R=>{R.save(),R.debug.drawPoint(N(0,0),{color:this._currentColor,size:this.size}),R.restore()})}kill(){var t;!((t=this._emitter)===null||t===void 0)&&t.isActive?this._emitter.removeParticle(this):super.kill()}update(t,i){this.life=this.life-i,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=St(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=St(this.sizeRate*i+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=St(this._currentColor.r+this._rRate*i,0,255),this._currentColor.g=St(this._currentColor.g+this._gRate*i,0,255),this._currentColor.b=St(this._currentColor.b+this._bRate*i,0,255),this._currentColor.a=this.graphics.opacity;let n=this.motion.acc;this.focus&&(n=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(i/1e3)),ti.integrate(this.transform,this.motion,n,i)}}La.DefaultConfig={beginColor:$.White,endColor:$.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var Yi;(function(d){d.Global="global",d.Local="local"})(Yi||(Yi={}));class Lf{constructor(){this.type="ex.particle",this.priority=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new gi({gl:t,vertexSource:vv,fragmentSource:wv,onPreLink:n=>{t.transformFeedbackVaryings(n,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],t.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(t){const i=t.getAttribute(Mt.Filtering),n=i?fr(i):void 0,o=qi(t.getAttribute(Mt.WrappingX)),h=qi(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);return t.removeAttribute("forceUpload"),g}draw(t,i){var n,o,h,c,g,_,v,x,A;const S=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const P=t.particle.transform===Yi.Local?this._context.getTransform():this._context.getTransform().multiply(t.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",P),this._shader.setUniformBoolean("fade",!!t.particle.fade),this._shader.setUniformBoolean("useTexture",!!t.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(n=t.particle.life)!==null&&n!==void 0?n:2e3),this._shader.setUniformFloat("deltaMs",i),this._shader.setUniformFloatVector("gravity",(o=t.particle.acc)!==null&&o!==void 0?o:N(0,0)),this._shader.setUniformFloatColor("beginColor",(h=t.particle.beginColor)!==null&&h!==void 0?h:$.Transparent),this._shader.setUniformFloatColor("endColor",(c=t.particle.endColor)!==null&&c!==void 0?c:$.Transparent);let I=(g=t.particle.startSize)!==null&&g!==void 0?g:0,F=(_=t.particle.endSize)!==null&&_!==void 0?_:0;const R=(v=t.particle.size)!==null&&v!==void 0?v:0;if(R>0&&(I=R,F=R),this._shader.setUniformFloat("startSize",I??10),this._shader.setUniformFloat("endSize",F??10),this._shader.setUniformFloat("startOpacity",(x=t.particle.opacity)!==null&&x!==void 0?x:1),t.particle.focus&&(this._shader.setUniformFloatVector("focus",t.particle.focus),this._shader.setUniformFloat("focusAccel",(A=t.particle.focusAccel)!==null&&A!==void 0?A:0)),t.particle.graphic){const E=t.particle.graphic,M=this._getTexture(E.image.image);S.activeTexture(S.TEXTURE0),S.bindTexture(S.TEXTURE_2D,M),this._shader.setUniformInt("graphic",0)}t.draw(S)}hasPendingDraws(){return!1}flush(){}dispose(){}}const Rv=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,Dv=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class Fv{constructor(t){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=$.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=cc(t,n);this._maxTextures=Math.min(n,o);const h=this._transformFragmentSource(Rv,this._maxTextures);this._shader=new gi({gl:t,fragmentSource:h,vertexSource:Dv}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((A,S)=>S)),this._vao=t.createVertexArray(),t.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._meshBuffer),t.bufferData(t.ARRAY_BUFFER,this._quadMesh,t.STATIC_DRAW),t.vertexAttribPointer(0,2,t.FLOAT,!1,16,0),t.enableVertexAttribArray(0),t.vertexAttribPointer(1,2,t.FLOAT,!1,16,8),t.enableVertexAttribArray(1),t.bindBuffer(t.ARRAY_BUFFER,null);const c=this._components;this._transformData=new fs({gl:t,size:c*this._maxImages,type:"dynamic"}),this._transformData.bind();let g=0,_=2;const v=4,x=c*4;t.vertexAttribPointer(_++,2,t.FLOAT,!1,x,g),t.enableVertexAttribArray(2),g+=2*v,t.vertexAttribPointer(_++,2,t.FLOAT,!1,x,g),t.enableVertexAttribArray(3),g+=2*v,t.vertexAttribPointer(_++,2,t.FLOAT,!1,x,g),t.enableVertexAttribArray(4),g+=2*v,t.vertexAttribPointer(_++,2,t.FLOAT,!1,x,g),t.enableVertexAttribArray(5),g+=2*v,t.vertexAttribPointer(_++,1,t.FLOAT,!1,x,g),t.enableVertexAttribArray(6),g+=1*v,t.vertexAttribPointer(_++,2,t.FLOAT,!1,x,g),t.enableVertexAttribArray(7),g+=2*v,t.vertexAttribPointer(_++,2,t.FLOAT,!1,x,g),t.enableVertexAttribArray(8),g+=2*v,t.vertexAttribPointer(_++,1,t.FLOAT,!1,x,g),t.enableVertexAttribArray(9),g+=1*v,t.vertexAttribPointer(_++,2,t.FLOAT,!1,x,g),t.enableVertexAttribArray(10),g+=2*v,t.vertexAttribPointer(_++,2,t.FLOAT,!1,x,g),t.enableVertexAttribArray(11),g+=2*v,t.vertexAttribPointer(_++,4,t.FLOAT,!1,x,g),t.enableVertexAttribArray(12),g+=4*v,t.vertexAttribDivisor(2,1),t.vertexAttribDivisor(3,1),t.vertexAttribDivisor(4,1),t.vertexAttribDivisor(5,1),t.vertexAttribDivisor(6,1),t.vertexAttribDivisor(7,1),t.vertexAttribDivisor(8,1),t.vertexAttribDivisor(9,1),t.vertexAttribDivisor(10,1),t.vertexAttribDivisor(11,1),t.vertexAttribDivisor(12,1),t.bindVertexArray(null)}_bindData(t){const i=this._components;this._transformData.bind(),this._transformData.upload(i*this._imageCount),t.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let n=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_texture_index <= ${h}.5) {
`:o+=`   else if (v_texture_index <= ${h}.5) {
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return n=n.replace("%%texture_picker%%",o),n}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(Mt.Filtering),n=i?fr(i):void 0,o=qi(t.getAttribute(Mt.WrappingX)),h=qi(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);t.removeAttribute("forceUpload"),this._textures.indexOf(g)===-1&&(this._textures.push(g),this._textureToIndex.set(g,this._textureIndex++),this._images.add(t))}_bindTextures(t){const i=Math.min(this._textureIndex,this._maxTextures);for(let n=0;n<i;n++)t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,this._textures[n]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const n=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(n))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,n,o,h,c,g,_,v){var x,A,S,P;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const I=this._getImageWidth(t),F=this._getImageHeight(t);let R=I||o||0,E=F||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(x=o??I)!==null&&x!==void 0?x:0,this._view[3]=(A=h??F)!==null&&A!==void 0?A:0,this._dest[0]=i??1,this._dest[1]=n??1,c!==void 0&&g!==void 0&&_!==void 0&&v!==void 0&&(this._view[0]=i??1,this._view[1]=n??1,this._view[2]=(S=o??I)!==null&&S!==void 0?S:0,this._view[3]=(P=h??F)!==null&&P!==void 0?P:0,this._dest[0]=c,this._dest[1]=g,R=_,E=v),i=this._view[0],n=this._view[1];const M=this._view[2],V=this._view[3],L=this._context.getTransform(),G=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+vt),this._dest[1]=~~(this._dest[1]+vt));const X=this._context.tint||this._defaultTint,rt=this._getTextureIdForImage(t),lt=I||R,yt=F||E,wt=(i+this.uvPadding)/lt,Pt=(n+this.uvPadding)/yt,Dt=(i+M-this.uvPadding)/lt,B=(n+V-this.uvPadding)/yt,z=I,Z=F,et=this._transformData.bufferData;et[this._vertexIndex++]=this._dest[0],et[this._vertexIndex++]=this._dest[1],et[this._vertexIndex++]=L.data[0],et[this._vertexIndex++]=L.data[1],et[this._vertexIndex++]=L.data[2],et[this._vertexIndex++]=L.data[3],et[this._vertexIndex++]=L.data[4],et[this._vertexIndex++]=L.data[5],et[this._vertexIndex++]=G,et[this._vertexIndex++]=R,et[this._vertexIndex++]=E,et[this._vertexIndex++]=z,et[this._vertexIndex++]=Z,et[this._vertexIndex++]=rt,et[this._vertexIndex++]=wt,et[this._vertexIndex++]=Pt,et[this._vertexIndex++]=Dt,et[this._vertexIndex++]=B,et[this._vertexIndex++]=X.r/255,et[this._vertexIndex++]=X.g/255,et[this._vertexIndex++]=X.b/255,et[this._vertexIndex++]=X.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._bindData(t),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),t.drawArraysInstanced(t.TRIANGLES,0,6,this._imageCount),Kt.DrawnImagesCount+=this._imageCount,Kt.DrawCallCount++,t.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const vt=1e-4;class Mv{constructor(t){this._webglCtx=t,this._debugText=new lc}drawRect(t,i,n,o,h={color:$.Black}){this.drawLine(N(t,i),N(t+n,i),{...h}),this.drawLine(N(t+n,i),N(t+n,i+o),{...h}),this.drawLine(N(t+n,i+o),N(t,i+o),{...h}),this.drawLine(N(t,i+o),N(t,i),{...h})}drawLine(t,i,n){var o;this._webglCtx.draw("ex.line",t,i,(o=n?.color)!==null&&o!==void 0?o:$.Black)}drawPoint(t,i={color:$.Black,size:5}){this._webglCtx.draw("ex.point",t,i.color,i.size)}drawText(t,i){this._debugText.write(this._webglCtx,t,i)}}class Bs{get z(){return this._state.current.z}set z(t){this._state.current.z=t}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(t){let i=!0;return(t.width>4096||t.height>4096)&&(i=!1),i}constructor(t){this._logger=ut.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=Le.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new Ba(()=>new _v,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new qm,this._state=new Tf,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=$.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new Mv(this),this._totalPostProcessorTime=0;const{canvasElement:i,context:n,enableTransparency:o,antialiasing:h,uvPadding:c,multiSampleAntialiasing:g,pixelArtSampler:_,powerPreference:v,snapToPixel:x,backgroundColor:A,useDrawSorting:S,garbageCollector:P,handleContextLost:I,handleContextRestored:F}=t;if(this.__gl=n??i.getContext("webgl2",{antialias:h??this.smoothing,premultipliedAlpha:!1,alpha:o??this.transparency,depth:!1,powerPreference:v??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");I&&this.__gl.canvas.addEventListener("webglcontextlost",I,!1),F&&this.__gl.canvas.addEventListener("webglcontextrestored",F,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new oe(this.__gl,P),this.snapToPixel=x??this.snapToPixel,this.smoothing=h??this.smoothing,this.transparency=o??this.transparency,this.pixelArtSampler=_??this.pixelArtSampler,this.uvPadding=c??this.uvPadding,this.multiSampleAntialiasing=typeof g=="boolean"?g:this.multiSampleAntialiasing,this.samples=typeof g=="object"?g.samples:void 0,this.backgroundColor=A??this.backgroundColor,this.useDrawSorting=S??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const t of this._renderers.values())t.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const t=this.__gl;if(this._ortho=vi.ortho(0,t.canvas.width,t.canvas.height,0,400,-400),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!1),this.register(new lv({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new nf),this.register(new uv),this.register(new pv),this.register(new sv),this.register(new tv),this.lazyRegister("ex.particle",()=>new Lf),this.register(new Fv({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=t.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");t.bindTexture(t.TEXTURE_2D,this.materialScreenTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),this._screenRenderer=new ov(t),this._renderTarget=new ra({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),this._postProcessTargets=[new ra({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),new ra({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height})],this._msaaTarget=new ra({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(t){this._renderers.set(t.type,t),t.initialize(this.__gl,this)}lazyRegister(t,i){this._lazyRenderersFactory.set(t,i)}get(t){let i=this._renderers.get(t);if(!i){const n=this._lazyRenderersFactory.get(t);n&&(this._logger.debug("lazy init renderer:",t),i=n(),this.register(i))}return i}_isCurrentRenderer(t){return!this._currentRenderer||this._currentRenderer===t}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(t,...i){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${t}, the webgl context is lost`);return}const n=this.get(t);if(n)if(this.useDrawSorting){const o=this._drawCallPool.get();o.z=this._state.current.z,o.priority=n.priority,o.renderer=t,this.getTransform().clone(o.transform),o.state.z=this._state.current.z,o.state.opacity=this._state.current.opacity,o.state.tint=this._state.current.tint,o.state.material=this._state.current.material,o.args[0]=i[0],o.args[1]=i[1],o.args[2]=i[2],o.args[3]=i[3],o.args[4]=i[4],o.args[5]=i[5],o.args[6]=i[6],o.args[7]=i[7],o.args[8]=i[8],o.args[9]=i[9],this._drawCalls[this._drawCallIndex++]=o}else this._currentRenderer||(this._currentRenderer=n),this._isCurrentRenderer(n)||this._currentRenderer.flush(),n.draw(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9]),this._currentRenderer=n;else throw Error(`No renderer with name ${t} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(t){const i=this.__gl;this._ortho=this._ortho=vi.ortho(0,t.width,t.height,0,400,-400),this._renderTarget.setResolution(i.canvas.width,i.canvas.height),this._msaaTarget.setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[0].setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[1].setResolution(i.canvas.width,i.canvas.height)}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}drawImage(t,i,n,o,h,c,g,_,v){if(!(o===0||h===0)){{if(_===0||v===0)return;if(this._getImageWidth(t)===0||this._getImageHeight(t)===0)return}if(!t){ut.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",t,i,n,o,h,c,g,_,v):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,t,i,n,o,h,c,g,_,v):this.draw(this.imageRenderer,t,i,n,o,h,c,g,_,v)}}drawLine(t,i,n,o=1){this.draw("ex.rectangle",t,i,n,o)}drawRectangle(t,i,n,o,h,c){this.draw("ex.rectangle",t,i,n,o,h,c)}drawCircle(t,i,n,o,h){this.draw("ex.circle",t,i,n,o,h)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(t,i){this._transform.translate(this.snapToPixel?~~(t+vt):t,this.snapToPixel?~~(i+vt):i)}rotate(t){this._transform.rotate(t)}scale(t,i){this._transform.scale(t,i)}transform(t){this._transform.current=t}getTransform(){return this._transform.current}multiply(t){this._transform.current.multiply(t,this._transform.current)}addPostProcessor(t){this._postprocessors.push(t),t.initialize(this.__gl)}removePostProcessor(t){const i=this._postprocessors.indexOf(t);i!==-1&&this._postprocessors.splice(i,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(t){for(const i of this._postprocessors){const n=i.getShader();n.use();const o=n.getUniforms();this._totalPostProcessorTime+=t,o.find(h=>h.name==="u_time_ms")&&n.setUniformFloat("u_time_ms",this._totalPostProcessorTime),o.find(h=>h.name==="u_elapsed_ms")&&n.setUniformFloat("u_elapsed_ms",t),o.find(h=>h.name==="u_resolution")&&n.setUniformFloatVector("u_resolution",N(this.width,this.height)),i.onUpdate&&i.onUpdate(t)}}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return new Bf({...t,graphicsContext:this})}createShader(t){const i=this.__gl,{vertexSource:n,fragmentSource:o}=t,h=new gi({gl:i,vertexSource:n,fragmentSource:o});return h.compile(),h}clear(){const t=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT)}flush(){var t;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let i=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(i.use(),this.useDrawSorting){for(let c=this._drawCallIndex;c<this._drawCalls.length;c++)this._drawCalls[c]=null;const n=new Map;for(const[c]of this._renderers){let g=0;for(g=0;g<this._drawCallIndex&&this._drawCalls[g].renderer!==c;g++);n.set(c,g)}this._drawCalls.sort((c,g)=>{if(c===null||g===null)return 0;const _=c.z-g.z,v=n.get(c.renderer)-n.get(g.renderer),x=c.priority-g.priority;return _===0?x===0?v:x:_});const o=this._transform.current,h=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let c=this._drawCalls[0].renderer,g=this.get(c);for(let _=0;_<this._drawCallIndex;_++)this._transform.current=this._drawCalls[_].transform,this._state.current=this._drawCalls[_].state,this._drawCalls[_].renderer!==c&&(g.flush(),c=this._drawCalls[_].renderer,g=this.get(c)),g instanceof nf&&(!((t=this.material)===null||t===void 0)&&t.isUsingScreenTexture)&&(i.copyToTexture(this.materialScreenTexture),i.use()),g.draw(...this._drawCalls[_].args);g.hasPendingDraws()&&g.flush()}this._transform.current=o,this._state.current=h,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const n of this._renderers.values())n.hasPendingDraws()&&n.flush();i.disable(),this._postprocessors.length>0&&i.toRenderSource().use();for(let n=0;n<this._postprocessors.length;n++)i=this._postProcessTargets[n%2],this._postProcessTargets[n%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[n]),this._postProcessTargets[n%2].toRenderSource().use();i.blitToScreen()}}const fe=1e-4;class Bv{constructor(t){this._ex=t,this._debugText=new lc}drawRect(t,i,n,o){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(t+fe):t,this._ex.snapToPixel?~~(i+fe):i,this._ex.snapToPixel?~~(n+fe):n,this._ex.snapToPixel?~~(o+fe):o),this._ex.__ctx.restore()}drawLine(t,i,n={color:$.Black}){var o,h;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(h=(o=n.color)===null||o===void 0?void 0:o.toString())!==null&&h!==void 0?h:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(t.x+fe):t.x,this._ex.snapToPixel?~~(t.y+fe):t.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(i.x+fe):i.x,this._ex.snapToPixel?~~(i.y+fe):i.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(t,i={color:$.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=i.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(t.x+fe):t.x,this._ex.snapToPixel?~~(t.y+fe):t.y,i.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(t,i){this._debugText.write(this._ex,t,i)}}class Sa{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(t){this.__ctx.imageSmoothingEnabled=t}constructor(t){this.useDrawSorting=!1,this.z=0,this.backgroundColor=$.ExcaliburBlue,this._state=new Tf,this.snapToPixel=!1,this.debug=new Bv(this);const{canvasElement:i,context:n,enableTransparency:o,snapToPixel:h,antialiasing:c,backgroundColor:g}=t;if(this.__ctx=n??i.getContext("2d",{alpha:o??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=g??this.backgroundColor,this.snapToPixel=h??this.snapToPixel,this.smoothing=c??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(t){}drawImage(t,i,n,o,h,c,g,_,v){if(o===0||h===0)return;if(_===0||v===0)return;if(t.width===0||t.height===0)return;this.__ctx.globalAlpha=this.opacity;const x=[t,i,n,o,h,c,g,_,v].filter(A=>A!==void 0).map(A=>typeof A=="number"&&this.snapToPixel?~~A:A);this.__ctx.drawImage.apply(this.__ctx,x),Kt.DrawCallCount++,Kt.DrawnImagesCount=1}drawLine(t,i,n,o=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=n.toString(),this.__ctx.moveTo(this.snapToPixel?~~(t.x+fe):t.x,this.snapToPixel?~~(t.y+fe):t.y),this.__ctx.lineTo(this.snapToPixel?~~(i.x+fe):i.x,this.snapToPixel?~~(i.y+fe):i.y),this.__ctx.lineWidth=o,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(t,i,n,o){this.__ctx.save(),this.__ctx.fillStyle=o.toString(),this.__ctx.fillRect(this.snapToPixel?~~(t.x+fe):t.x,this.snapToPixel?~~(t.y+fe):t.y,this.snapToPixel?~~(i+fe):i,this.snapToPixel?~~(n+fe):n),this.__ctx.restore()}drawCircle(t,i,n,o,h){this.__ctx.save(),this.__ctx.beginPath(),o&&(this.__ctx.strokeStyle=o.toString()),h&&(this.__ctx.lineWidth=h),this.__ctx.fillStyle=n.toString(),this.__ctx.arc(this.snapToPixel?~~(t.x+fe):t.x,this.snapToPixel?~~(t.y+fe):t.y,i,0,Math.PI*2),this.__ctx.fill(),o&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(t,i){this.__ctx.translate(this.snapToPixel?~~(t+fe):t,this.snapToPixel?~~(i+fe):i)}rotate(t){this.__ctx.rotate(t)}scale(t,i){this.__ctx.scale(t,i)}getTransform(){throw new Error("Not implemented")}multiply(t){this.__ctx.setTransform(this.__ctx.getTransform().multiply(t.toDOMMatrix()))}addPostProcessor(t){}removePostProcessor(t){}clearPostProcessors(){}updatePostProcessors(t){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),Kt.clear()}flush(){}dispose(){this.__ctx=void 0}}var Ie;(function(d){d.Fixed="Fixed",d.FitContainerAndFill="FitContainerAndFill",d.FitScreenAndFill="FitScreenAndFill",d.FitContainerAndZoom="FitContainerAndZoom",d.FitScreenAndZoom="FitScreenAndZoom",d.FitScreen="FitScreen",d.FillScreen="FillScreen",d.FitContainer="FitContainer",d.FillContainer="FillContainer"})(Ie||(Ie={}));class Ul{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const kv={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class zl{constructor(t){var i,n,o,h;this.events=new $t,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=ut.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const c=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(c),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new ct,this._unsafeArea=new ct,this.viewport=t.viewport,this.resolution=(i=t.resolution)!==null&&i!==void 0?i:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(n=t.displayMode)!==null&&n!==void 0?n:Ie.Fixed,this._canvas=t.canvas,this.graphicsContext=t.context,this._antialiasing=(o=t.antialiasing)!==null&&o!==void 0?o:this._antialiasing,this._canvasImageRendering=(h=t.canvasImageRendering)!==null&&h!==void 0?h:this._canvasImageRendering,this._browser=t.browser,this._pixelRatioOverride=t.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const t=this.worldToPageCoordinates(k.Zero);return this.worldToPageCoordinates(N(1,0)).sub(t).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(t){this._pixelRatioOverride=t}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case Ie.FillContainer:case Ie.FitContainer:case Ie.FitContainerAndFill:case Ie.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(t){this._resolution=t}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(t){this._viewport=t}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(t){this._camera=t}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof Bs&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let o=Math.max(1,this.pixelRatio-.5),h=!1;for(;o>1&&!h;){o=Math.max(1,o-.5);const c=this._resolution.width*o,g=this._resolution.height*o;h=this.graphicsContext.checkIfResolutionSupported({width:c,height:g})}this.pixelRatioOverride=o,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const t=this.viewport.widthUnit==="percent"?"%":"px",i=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+t,this._canvas.style.height=this.viewport.height+i,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof Sa&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(t){this._antialiasing=t,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(t){return this.enterFullscreen(t)}enterFullscreen(t){var i,n,o,h,c,g;if(t){const _=document.getElementById(t);if(_?.requestFullscreen||_?.webkitRequestFullscreen){if(_.getAttribute("ex-fullscreen-listener")||(_.setAttribute("ex-fullscreen-listener","true"),_.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),_.requestFullscreen)return(i=_.requestFullscreen())!==null&&i!==void 0?i:Promise.resolve();if(_.webkitRequestFullscreen)return(n=_.webkitRequestFullscreen())!==null&&n!==void 0?n:Promise.resolve()}}return!((o=this._canvas)===null||o===void 0)&&o.requestFullscreen?(c=(h=this._canvas)===null||h===void 0?void 0:h.requestFullscreen())!==null&&c!==void 0?c:Promise.resolve():this._canvas.webkitRequestFullscreen?(g=this._canvas.webkitRequestFullscreen())!==null&&g!==void 0?g:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(t){return{width:t.widthUnit==="percent"?this.canvas.offsetWidth:t.width,height:t.heightUnit==="percent"?this.canvas.offsetHeight:t.height}}pageToScreenCoordinates(t){let i=t.x,n=t.y;this._isFullscreen||(i-=Gr(this._canvas).x,n-=Gr(this._canvas).y);const o=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,c=(window.innerHeight-h)/2;n=(n-c)/h*o.height,i=i/window.innerWidth*o.width}else{const h=window.innerHeight*this.aspectRatio,c=(window.innerWidth-h)/2;i=(i-c)/h*o.width,n=n/window.innerHeight*o.height}return i=i/o.width*this.resolution.width,n=n/o.height*this.resolution.height,i=i-this.contentArea.left,n=n-this.contentArea.top,new k(i,n)}screenToPageCoordinates(t){let i=t.x,n=t.y;const o=this._viewportToPixels(this.viewport);if(i=i/this.resolution.width*o.width,n=n/this.resolution.height*o.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,c=(window.innerHeight-h)/2;n=n/o.height*h+c,i=i/o.width*window.innerWidth}else{const h=window.innerHeight*this.aspectRatio,c=(window.innerWidth-h)/2;i=i/o.width*h+c,n=n/o.height*window.innerHeight}return this._isFullscreen||(i+=Gr(this._canvas).x,n+=Gr(this._canvas).y),new k(i,n)}screenToWorldCoordinates(t){return t=t.add(N(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(t):t.sub(N(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(t){return this._camera?this._camera.transform.multiply(t):t.add(N(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(t){const i=this.pageToScreenCoordinates(t);return this.screenToWorldCoordinates(i)}worldToPageCoordinates(t){const i=this.worldToScreenCoordinates(t);return this.screenToPageCoordinates(i)}getWorldBounds(){return ct.fromDimension(this.resolution.width,this.resolution.height,k.Half).scale(N(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero,k.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return N(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=this.aspectRatio;let i=0,n=0;window.innerWidth/t<window.innerHeight?(i=window.innerWidth,n=window.innerWidth/t):(i=window.innerHeight*t,n=window.innerHeight),this.viewport={width:i,height:n},this._contentArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this._unsafeArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndFill(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(t,i,n){if(this.viewport=n??{width:t,height:i},t/i<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:t*this._contentResolution.width/t,height:t*this._contentResolution.width/t*i/t};const o=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new ct({top:o,left:0,right:this._contentResolution.width,bottom:this.resolution.height-o}),this._unsafeArea=new ct({top:-o,left:0,right:this._contentResolution.width,bottom:this.resolution.height+o})}else{this.resolution={width:i*this._contentResolution.height/i*t/i,height:i*this._contentResolution.height/i};const o=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new ct({top:0,left:o,right:this.resolution.width-o,bottom:this._contentResolution.height}),this._unsafeArea=new ct({top:0,left:-o,right:this.resolution.width+o,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndZoom(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const t=this.canvas.parentElement;t.style.overflow="hidden";const{offsetWidth:i,offsetHeight:n}=this.canvas;this._computeFitAndZoom(i,n),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(t,i){const n=this.aspectRatio;let o=0,h=0;t/n<i?(o=t,h=t/n):(o=i*n,h=i);const c=t/o,g=i/h,_=Math.max(c,g),v=o*_,x=h*_;v>t?this.canvas.style.left=-(v-t)/2+"px":this.canvas.style.left="",x>i?this.canvas.style.top=-(x-i)/2+"px":this.canvas.style.top="",this.viewport={width:v,height:x};const A=ct.fromDimension(this.viewport.width,this.viewport.height,k.Zero);if(this.viewport.width>t){const S=(this.viewport.width-t)/this.viewport.width*this.resolution.width;A.top=0,A.left=S/2,A.right=this.resolution.width-S/2,A.bottom=this.resolution.height}if(this.viewport.height>i){const S=(this.viewport.height-i)/this.viewport.height*this.resolution.height;A.top=S/2,A.left=0,A.bottom=this.resolution.height-S/2,A.right=this.resolution.width}this._contentArea=A}_computeFitContainer(){const t=this.aspectRatio;let i=0,n=0,o="pixel",h="pixel";const c=this.canvas.parentElement;c.clientWidth/t<c.clientHeight?(this.canvas.style.width="100%",i=100,o="percent",n=this.canvas.offsetWidth/t):(this.canvas.style.height="100%",n=100,h="percent",i=this.canvas.offsetHeight*t),this.viewport={width:i,widthUnit:o,height:n,heightUnit:h},this._contentArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(t){this.displayMode===Ie.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===Ie.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:t.innerWidth,height:t.innerHeight},this.viewport=this.resolution),this._contentArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.displayMode===Ie.FitScreen&&this._computeFit(),this.displayMode===Ie.FitContainer&&this._computeFitContainer(),this.displayMode===Ie.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===Ie.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===Ie.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===Ie.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class Kr{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function Lv(d){return!!d.playbackState}class Dn{static unlock(){return new Promise((i,n)=>{if(Dn._UNLOCKED||!Kr.create())return i(!0);const o=setTimeout(()=>{ut.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),i(!1)},200),h=Kr.create();h.resume().then(()=>{const c=h.createBuffer(1,1,22050),g=h.createBufferSource();let _=!1;g.buffer=c,g.connect(h.destination),g.onended=()=>_=!0,g.start(0),setTimeout(()=>{Lv(g)?(g.playbackState===g.PLAYING_STATE||g.playbackState===g.FINISHED_STATE)&&(Dn._UNLOCKED=!0):(h.currentTime>0||_)&&(Dn._UNLOCKED=!0)},0),clearTimeout(o),i(!0)},()=>{n()})})}static isUnlocked(){return this._UNLOCKED}}Dn._UNLOCKED=!1;class Ua extends gr{get ctx(){return this._ctx}constructor(t={}){super(t),this._options=t}clone(){return new Ua({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){var i,n;!((i=this._options)===null||i===void 0)&&i.draw&&((n=this._options)===null||n===void 0||n.draw(t)),this._options.cache||this.flagDirty()}}class zc{}zc.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class za{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(t){this._currentState=t}static create(t,i){const n=new za;n.data=i;for(const o in t.states)n.states.set(o,{name:o,...t.states[o]});for(const o of n.states.values())for(const h of o.transitions)if(h!=="*"&&!n.states.has(h))throw Error(`Invalid state machine, state [${o.name}] has a transition to another state that doesn't exist [${h}]`);return n.currentState=n.startState=n.states.get(t.start),n}in(t){return this.currentState.name===t}go(t,i){var n,o;if(this.currentState.transitions.includes(t)||this.currentState.transitions.includes("*")){const h=this.states.get(t);return this.currentState.onExit&&((n=this.currentState)===null||n===void 0?void 0:n.onExit({to:h.name,data:this.data}))===!1||h?.onEnter&&h?.onEnter({from:this.currentState.name,eventData:i,data:this.data})===!1?!1:(this.currentState=h,!((o=this.currentState)===null||o===void 0)&&o.onState&&this.currentState.onState(),!0)}return!1}update(t){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,t)}save(t){localStorage.setItem(t,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(t){const i=JSON.parse(localStorage.getItem(t));this.currentState=this.states.get(i.currentState),this.data=i.data}}class Uf{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(t){this._loop=t,this._instance&&(this._instance.loop=t,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(t){t=St(t,0,1),this._volume=t,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(t,this._audioContext.currentTime,.1):this._volumeNode.gain.value=t}get volume(){return this._volume}get duration(){var t;return(t=this._duration)!==null&&t!==void 0?t:this.getTotalPlaybackDuration()}set duration(t){this._duration=t}constructor(t){this._src=t,this._audioContext=Kr.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new Pi,this._stateMachine=za.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:i})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,i.pausedAt*this._playbackRate):this._instance.start(0,i.pausedAt*this._playbackRate,this.duration),i.startedAt=this._audioContext.currentTime-i.pausedAt,i.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:i})=>{i==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:i,data:n})=>{n.pausedAt=(i??0)/this._playbackRate,n.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:i})=>{i.pausedAt=0,i.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:i})=>{i.pausedAt=this._audioContext.currentTime-i.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(t=()=>{}){return this._playStarted=t,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(t){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",t)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:t,startedAt:i}=this._stateMachine.data;return t?t*this._playbackRate:i?(this._audioContext.currentTime-i)*this._playbackRate:0}set playbackRate(t){this._instance.playbackRate.value=this._playbackRate=t}get playbackRate(){return this._instance.playbackRate.value}}class Hc extends bt{set bubbles(t){}get bubbles(){return!1}get _path(){return null}set _path(t){}constructor(t,i="MediaEvent"){super(),this.target=t,this._name=i}stopPropagation(){}action(){}propagate(){}layPath(t){}}class An extends Hc{constructor(t,i){super(t,"NativeSoundEvent"),this.track=i}}class zf extends Hc{constructor(t,i){super(t,"NativeSoundProcessedEvent"),this._processedData=i,this.data=this._processedData}}function Uv(d){try{const t=new Audio,i=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,n=d.match(i)[1];return!!t.canPlayType("audio/"+n)}catch(t){return ut.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",t),!1}}const zv={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class Hf{set loop(t){this._loop=t;for(const i of this._tracks)i.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(t){this._volume=t;for(const i of this._tracks)i.volume=this._volume;this.events.emit("volumechange",new An(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(t){this._duration=t}get instances(){return this._tracks}get path(){return this._resource.path}set path(t){this._resource.path=t}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}constructor(...t){this.events=new $t,this.logger=ut.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=Kr.create(),this._resource=new lo("",zc.type.arraybuffer);for(const i of t)if(Uv(i)){this.path=i;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",t.join(", ")),this.logger.warn("Attempting to use",t[0]),this.path=t[0])}isLoaded(){return!!this.data}async load(){var t,i;if(this.data)return this.data;const n=await this._resource.load(),o=await this.decodeAudio(n.slice(0));return this._duration=(i=(t=this._duration)!==null&&t!==void 0?t:o?.duration)!==null&&i!==void 0?i:void 0,this.events.emit("processed",new zf(this,o)),this.data=o}async decodeAudio(t){try{return await this._audioContext.decodeAudioData(t.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(t){t&&(this._engine=t,this._engine.on("hidden",()=>{t.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{t.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(t=>t.isPlaying())}isPaused(){return this._tracks.some(t=>t.isPaused())}isStopped(){return this._tracks.some(t=>t.isStopped())}play(t){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=t||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const t of this._tracks)t.pause();this.events.emit("pause",new An(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const t of this._tracks)t.stop();this.events.emit("stop",new An(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._tracks.forEach(i=>{i.playbackRate=this._playbackRate})}seek(t,i=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[i].seek(t)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(t=0){return this._tracks.length?this._tracks[t].getPlaybackPosition():0}getTrackId(t){return this._tracks.indexOf(t)}async _resumePlayback(){if(this.isPaused()){const t=[];for(const i of this._tracks)t.push(i.play().then(()=>(this._tracks.splice(this.getTrackId(i),1),!0)));this.events.emit("resume",new An(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(t)}return!0}async _startPlayback(){const t=this._getTrackInstance(this.data),i=await t.play(()=>{this.events.emit("playbackstart",new An(this,t)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new An(this,t));const n=this.getTrackId(t);return n!==-1&&this._tracks.splice(n,1),i}_getTrackInstance(t){var i;const n=new Uf(t);return n.loop=this.loop,n.volume=this.volume,n.duration=(i=this.duration)!==null&&i!==void 0?i:0,n.playbackRate=this._playbackRate,this._tracks.push(n),n}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const Hv={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function Hl(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class $r{get resources(){return this._resources}constructor(t){var i;this.events=new $t,this.canvas=new Ua({filtering:be.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new Pi,t&&(!((i=t.loadables)===null||i===void 0)&&i.length)&&this.addResources(t.loadables)}onInitialize(t){this.engine=t,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await fa(500,this.engine.clock)}addResource(t){this._resources.push(t)}addResources(t){let i=0;const n=t.length;for(i;i<n;i++)this.addResource(t[i])}markResourceComplete(){this._numLoaded++}get progress(){const t=this._resources.length;return t>0?St(this._numLoaded,0,t)/t:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(t,i){this._totalTimeMs+=i}onDraw(t){const i=this._totalTimeMs/1e3;t.fillStyle=$.Black.toRGBA(),t.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),t.save(),t.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const n=i*10;t.strokeStyle="white",t.lineWidth=10,t.lineCap="round",t.arc(0,0,40,n,n+Math.PI*3/2),t.stroke(),t.fillStyle="white",t.font="16px sans-serif";const o=(this.progress*100).toFixed(0)+"%",h=t.measureText(o),c=Math.abs(h.actualBoundingBoxLeft)+Math.abs(h.actualBoundingBoxRight),g=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);t.fillText(o,-c/2,g/2),t.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async t=>{this.events.emit("loadresourcestart",t),await t.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",t)})}));for(const t of this._resources)t instanceof Hf&&t.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await Dn.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const Ov="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var Vv=Fe(851);class Hn extends $r{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const t=document.getElementById("excalibur-play-root");return t&&(this._playButtonRootElement=t),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(t){const i=Array.isArray(t)?{loadables:t}:t;super(i),this._logger=ut.getInstance(),this._originalOptions={loadables:[]},this.events=new $t,this._playButtonShown=!1,this.logo=Ov,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=$.White,this.backgroundColor="#176BAA",this._imageLoaded=new Pi,this.suppressPlayButton=!1,this._playButtonStyles=Vv.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let n=document.getElementById("excalibur-play");return n||(n=document.createElement("button")),n.id="excalibur-play",n.textContent=this.playButtonText,n.style.display="none",n},this._originalOptions={...Hn._DEFAULT_LOADER_OPTIONS,...i}}onInitialize(t){this.engine=t,this.screen=t.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var t,i;if(this.suppressPlayButton)this.hidePlayButton(),await fa(500,(t=this.engine)===null||t===void 0?void 0:t.clock);else{const n=()=>{try{this._positionPlayButton()}catch{}};return!((i=this.engine)===null||i===void 0)&&i.browser&&this.engine.browser.window.on("resize",n),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",h=>{h.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(h=>{const c=g=>{var _;if(g.stopPropagation(),this.hidePlayButton(),!((_=this.engine)===null||_===void 0)&&_.browser&&this.engine.browser.window.off("resize",n),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(v){this._logger.error("could not go fullscreen",v)}h()};this._playButton.addEventListener("click",c),this._playButton.addEventListener("touchend",c),this._playButton.addEventListener("pointerup",c),this.engine&&this.engine.input.gamepads.once("button",()=>c(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var t;await fa(200,(t=this.engine)===null||t===void 0?void 0:t.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const t=this._image;await this._imageLoaded.promise,await t?.decode()}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:t,y:i,width:n,height:o}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const h=this._playButton.clientWidth,c=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${t+n/2-h/2}px`,this._playButtonRootElement.style.top=`${i+o/2-c/2+100}px`)}}}onDraw(t){const i=this.engine.canvasHeight/this.engine.pixelRatio,n=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),t.fillStyle=this.backgroundColor,t.fillRect(0,0,n,i);let o=i/2;const h=Math.min(this.logoWidth,n*.75);let c=n/2-h/2;this.logoPosition&&(c=this.logoPosition.x,o=this.logoPosition.y);const g=Math.floor(h*(this.logoHeight/this.logoWidth)),_=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,c,o,h,g):t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,c,o-g-20,h,g),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=_;return}let v=c,x=o;this.loadingBarPosition&&(v=this.loadingBarPosition.x,x=this.loadingBarPosition.y),t.lineWidth=2,Ll(t,v,x,h,20,10,this.loadingBarColor);const A=h*this.progress,S=5,P=A-S*2,I=20-S*2;Ll(t,v+S,x+S,P>10?P:10,I,5,null,this.loadingBarColor),this.engine.screen.antialiasing=_}}Hn._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const rf={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class Of{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("2d"))},arrayBufferSupport:function(){const t=new XMLHttpRequest;t.open("GET","/");try{t.responseType="arraybuffer"}catch{return!1}return t.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const t=document.createElement("a").style;return t.cssText="background-color:rgba(150,255,150,.5)",(""+t.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let t=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const i=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],n=this.getBrowserFeatures();for(const o of Object.keys(rf))n[o]?(t+="(%c✓%c)",i.push("font-weight: bold; color: green"),i.push("font-weight: normal; color: inherit")):(t+="(%c✗%c)",i.push("font-weight: bold; color: red"),i.push("font-weight: normal; color: inherit")),t+=" "+rf[o]+`
`;i.unshift(t),console.log.apply(console,i)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let t=!1;for(const i in this._criticalTests)this._criticalTests[i].call(this)||(this.failedTests.push(i),ut.getInstance().error("Critical browser feature missing, Excalibur requires:",i),t=!0);if(t)return!1;for(const i in this._warningTest)this._warningTest[i]()||ut.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",i);return!0}}var gt;(function(d){d.PreventCollision="PreventCollision",d.Passive="Passive",d.Active="Active",d.Fixed="Fixed"})(gt||(gt={}));class cs{static create(t,i){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(t)){const o=this._GROUPS.get(t);if(o.mask===i)return o;throw new Error(`Collision group ${t} already exists with a different mask!`)}const n=new Us(t,this._CURRENT_BIT,i!==void 0?i:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(t,n),n}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(t){return this._GROUPS.get(t)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}cs._STARTING_BIT=1;cs._MAX_GROUPS=32;cs._CURRENT_GROUP=1;cs._CURRENT_BIT=cs._STARTING_BIT;cs._GROUPS=new Map;class Us{constructor(t,i,n){this._name=t,this._category=i,this._mask=n}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(t){const i=this.category&t.mask,n=this.mask&t.category;return i!==0&&n!==0}invert(){const t=cs.create("~("+this.name+")",~this.mask|0);return t._category=~this.category,t}static combine(t){const i=t.map(h=>h.name).join("+"),o=~t.reduce((h,c)=>c.category|h,0);return cs.create(i,o)}static collidesWith(t){const i=`collidesWith(${t.map(o=>o.name).join("+")})`,n=t.reduce((o,h)=>h.category|o,0);return cs.create(i,n)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}Us.All=new Us("Collide with all groups",-1,-1);class ii{constructor(t,i){this.colliderA=t,this.colliderB=i,this.id=null,this.id=ii.calculatePairHash(t.id,i.id)}static canCollide(t,i){var n,o;if(t.id===i.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.localBounds.hasZeroDimensions()||i.localBounds.hasZeroDimensions())return!1;const h=(n=t?.owner)===null||n===void 0?void 0:n.get(Tt),c=(o=i?.owner)===null||o===void 0?void 0:o.get(Tt);return!(!h||!c||!h.group.canCollide(c.group)||h.collisionType===gt.Fixed&&c.collisionType===gt.Fixed||c.collisionType===gt.PreventCollision||h.collisionType===gt.PreventCollision||!h.isActive||!c.isActive)}get canCollide(){const t=this.colliderA,i=this.colliderB;return ii.canCollide(t,i)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(t){return t===this.colliderA||t===this.colliderB}static calculatePairHash(t,i){return t.value<i.value?`#${t.value}+${i.value}`:`#${i.value}+${t.value}`}}class go{constructor(t,i){this.min=t,this.max=i}overlaps(t){return this.max>t.min&&t.max>this.min}getOverlap(t){return this.overlaps(t)?this.max>t.max?t.max-this.min:this.max-t.min:0}}class Ol{constructor(t){this.parent=t,this.parent=t||null,this.data=null,this.bounds=new ct,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class Oc{constructor(t,i=new ct(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=t,this.worldBounds=i,this.root=null,this.nodes={}}_insert(t){if(this.root===null){this.root=t,this.root.parent=null;return}const i=t.bounds;let n=this.root;for(;!n.isLeaf();){const g=n.left,_=n.right,v=n.bounds.getPerimeter(),A=n.bounds.combine(i).getPerimeter(),S=2*A,P=2*(A-v);let I=0;const F=i.combine(g.bounds);let R,E;g.isLeaf()?I=F.getPerimeter()+P:(E=g.bounds.getPerimeter(),R=F.getPerimeter(),I=R-E+P);let M=0;const V=i.combine(_.bounds);if(_.isLeaf()?M=V.getPerimeter()+P:(E=_.bounds.getPerimeter(),R=V.getPerimeter(),M=R-E+P),S<I&&S<M)break;I<M?n=g:n=_}const o=n.parent,h=new Ol(o);h.bounds=i.combine(n.bounds),h.height=n.height+1,o!==null?(o.left===n?o.left=h:o.right=h,h.left=n,h.right=t,n.parent=h,t.parent=h):(h.left=n,h.right=t,n.parent=h,t.parent=h,this.root=h);let c=t.parent;for(;c;){if(c=this._balance(c),!c.left)throw new Error("Parent of current leaf cannot have a null left child"+c);if(!c.right)throw new Error("Parent of current leaf cannot have a null right child"+c);c.height=1+Math.max(c.left.height,c.right.height),c.bounds=c.left.bounds.combine(c.right.bounds),c=c.parent}}_remove(t){if(t===this.root){this.root=null;return}const i=t.parent,n=i.parent;let o;if(i.left===t?o=i.right:o=i.left,n){n.left===i?n.left=o:n.right=o,o.parent=n;let h=n;for(;h;)h=this._balance(h),h.bounds=h.left.bounds.combine(h.right.bounds),h.height=1+Math.max(h.left.height,h.right.height),h=h.parent}else this.root=o,o.parent=null}trackCollider(t){const i=new Ol;i.data=t,i.bounds=t.bounds,i.bounds.left-=2,i.bounds.top-=2,i.bounds.right+=2,i.bounds.bottom+=2,this.nodes[t.id.value]=i,this._insert(i)}updateCollider(t){var i;const n=this.nodes[t.id.value];if(!n)return!1;const o=t.bounds;if(!this.worldBounds.contains(o))return ut.getInstance().warn("Collider with id "+t.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(t),!1;if(n.bounds.contains(o))return!1;if(this._remove(n),o.left-=this._config.boundsPadding,o.top-=this._config.boundsPadding,o.right+=this._config.boundsPadding,o.bottom+=this._config.boundsPadding,t.owner){const h=(i=t.owner)===null||i===void 0?void 0:i.get(Tt);if(h){const c=h.vel.x*32/1e3*this._config.velocityMultiplier,g=h.vel.y*32/1e3*this._config.velocityMultiplier;c<0?o.left+=c:o.right+=c,g<0?o.top+=g:o.bottom+=g}}return n.bounds=o,this._insert(n),!0}untrackCollider(t){const i=this.nodes[t.id.value];i&&(this._remove(i),this.nodes[t.id.value]=null,delete this.nodes[t.id.value])}_balance(t){if(t===null)throw new Error("Cannot balance at null node");if(t.isLeaf()||t.height<2)return t;const i=t.left,n=t.right,o=t,h=i,c=n,g=i.left,_=i.right,v=n.left,x=n.right,A=c.height-h.height;if(A>1)return c.left=o,c.parent=o.parent,o.parent=c,c.parent?c.parent.left===o?c.parent.left=c:c.parent.right=c:this.root=c,v.height>x.height?(c.right=v,o.right=x,x.parent=o,o.bounds=h.bounds.combine(x.bounds),c.bounds=o.bounds.combine(v.bounds),o.height=1+Math.max(h.height,x.height),c.height=1+Math.max(o.height,v.height)):(c.right=x,o.right=v,v.parent=o,o.bounds=h.bounds.combine(v.bounds),c.bounds=o.bounds.combine(x.bounds),o.height=1+Math.max(h.height,v.height),c.height=1+Math.max(o.height,x.height)),c;if(A<-1){if(h.left=o,h.parent=o.parent,o.parent=h,h.parent)if(h.parent.left===o)h.parent.left=h;else{if(h.parent.right!==o)throw"Error rotating Dynamic Tree";h.parent.right=h}else this.root=h;return g.height>_.height?(h.right=g,o.left=_,_.parent=o,o.bounds=c.bounds.combine(_.bounds),h.bounds=o.bounds.combine(g.bounds),o.height=1+Math.max(c.height,_.height),h.height=1+Math.max(o.height,g.height)):(h.right=_,o.left=g,g.parent=o,o.bounds=c.bounds.combine(g.bounds),h.bounds=o.bounds.combine(_.bounds),o.height=1+Math.max(c.height,g.height),h.height=1+Math.max(o.height,_.height)),h}return t}getHeight(){return this.root===null?0:this.root.height}query(t,i){const n=t.bounds,o=h=>{if(h&&h.bounds.overlaps(n))if(h.isLeaf()&&h.data!==t){if(i.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}rayCastQuery(t,i=1/0,n){const o=h=>{if(h&&h.bounds.rayCast(t,i))if(h.isLeaf()){if(n.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}getNodes(){const t=i=>i?[i].concat(t(i.left),t(i.right)):[];return t(this.root)}debug(t){const i=n=>{n&&(n.isLeaf()?n.bounds.draw(t,$.Green):n.bounds.draw(t,$.White),n.left&&i(n.left),n.right&&i(n.right))};i(this.root)}}class In{constructor(t,i){this.pos=t,this.dir=i.normalize()}intersect(t){const i=t.begin.sub(this.pos);if(this.dir.cross(t.getSlope())===0&&i.cross(this.dir)!==0)return-1;const n=this.dir.cross(t.getSlope());if(n===0)return-1;const o=i.cross(t.getSlope())/n;if(o>=0){const h=i.cross(this.dir)/n/t.getLength();if(h>=0&&h<=1)return o}return-1}intersectPoint(t){const i=this.intersect(t);return i<0?null:this.getPoint(i)}getPoint(t){return this.pos.add(this.dir.scale(t))}}class Pa{constructor(t){this._config=t,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new Oc(t.dynamicTree)}getColliders(){return this._colliders}query(t){const i=[];return t instanceof ct?this._dynamicCollisionTree.query({id:Bn("collider",-1),owner:null,bounds:t},n=>(i.push(n),!1)):this._dynamicCollisionTree.query({id:Bn("collider",-1),owner:null,bounds:new ct(t.x,t.y,t.x,t.y)},n=>(i.push(n),!1)),i}rayCast(t,i){var n,o,h;const c=[],g=(n=i?.maxDistance)!==null&&n!==void 0?n:1/0,_=i?.collisionGroup,v=_?_.category:(o=i?.collisionMask)!==null&&o!==void 0?o:Us.All.category,x=(h=i?.searchAllColliders)!==null&&h!==void 0?h:!1;return this._dynamicCollisionTree.rayCastQuery(t,g,A=>{const P=A.owner.get(Tt);if(i?.ignoreCollisionGroupAll&&P.group===Us.All)return!1;const I=(v&P.group.category)!==0;if(P?.group&&!I)return!1;const F=A.rayCast(t,g);if(F){if(i?.filter){if(i.filter(F)&&(c.push(F),!x))return!0}else if(c.push(F),!x)return!0}return!1}),c}track(t){if(!t){ut.getInstance().warn("Cannot track null collider");return}if(t instanceof De){const i=t.getColliders();for(const n of i)n.owner=t.owner,this._colliders.push(n),this._dynamicCollisionTree.trackCollider(n)}else this._colliders.push(t),this._dynamicCollisionTree.trackCollider(t)}untrack(t){if(!t){ut.getInstance().warn("Cannot untrack a null collider");return}if(t instanceof De){const i=t.getColliders();for(const n of i){const o=this._colliders.indexOf(n);o!==-1&&this._colliders.splice(o,1),this._dynamicCollisionTree.untrackCollider(n)}}else{const i=this._colliders.indexOf(t);i!==-1&&this._colliders.splice(i,1),this._dynamicCollisionTree.untrackCollider(t)}}_pairExists(t,i){const n=ii.calculatePairHash(t.id,i.id);return this._pairs.has(n)}broadphase(t,i,n){const o=i/1e3,h=t.filter(g=>{var _,v;const x=(_=g.owner)===null||_===void 0?void 0:_.get(Tt);return((v=g.owner)===null||v===void 0?void 0:v.isActive)&&x.collisionType!==gt.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let c;for(let g=0,_=h.length;g<_;g++)c=h[g],this._dynamicCollisionTree.query(c,v=>{if(!this._pairExists(c,v)&&ii.canCollide(c,v)){const x=new ii(c,v);this._pairs.add(x.id),this._collisionPairCache.push(x)}return!1});if(n&&(n.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const g of h){const _=g.owner.get(Tt);if(_.collisionType!==gt.Active)continue;const v=_.vel.magnitude*o+_.acc.magnitude*.5*o*o,x=Math.min(g.bounds.height,g.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||v>x/2){n&&n.physics.fastBodies++;const A=_.globalPos.sub(_.oldPos),S=g.center,P=g.getFurthestPoint(_.vel),I=P.sub(A),F=new In(I,_.vel);F.pos=F.pos.add(F.dir.scale(-2*this._config.continuous.surfaceEpsilon));let R,E=new k(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(F,v+this._config.continuous.surfaceEpsilon*2,M=>{if(!this._pairExists(g,M)&&ii.canCollide(g,M)){const V=M.rayCast(F,v+this._config.continuous.surfaceEpsilon*10);if(V){const L=V.point.sub(I);L.magnitude<E.magnitude&&(E=L,R=M)}}return!1}),R&&k.isValid(E)){const M=new ii(g,R);this._pairs.has(M.id)||(this._pairs.add(M.id),this._collisionPairCache.push(M));const V=S.sub(P);_.globalPos=I.add(V).add(E).add(F.dir.scale(10*this._config.continuous.surfaceEpsilon)),g.update(_.transform.get()),n&&n.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(t,i){let n=[];for(let o=0;o<t.length;o++){const h=t[o].collide();if(n=n.concat(h),i&&h.length>0)for(const c of h)i.physics.contacts.set(c.id,c)}return i&&(i.physics.collisions+=n.length),n}update(t){let i=0;const n=t.length;for(let o=0;o<n;o++)this._dynamicCollisionTree.updateCollider(t[o])&&i++;return i}debug(t){this._dynamicCollisionTree.debug(t)}}class on{constructor(){this.id=Bn("collider",on._ID++),this.composite=null,this.events=new $t,this.offset=k.Zero}touching(t){return!!this.collide(t)}}on._ID=0;var to;(function(d){d.Arcade="arcade",d.Realistic="realistic"})(to||(to={}));var zs;(function(d){d.None="none",d.VerticalFirst="vertical-first",d.HorizontalFirst="horizontal-first"})(zs||(zs={}));const Vc={vertical:1,horizontal:2},Wc={horizontal:1,vertical:2},Nc={horizontal:0,vertical:0};var or;(function(d){d.DynamicTree="dynamic-tree",d.SparseHashGrid="sparse-hash-grid"})(or||(or={}));const ks=()=>({enabled:!0,gravity:N(0,0).clone(),solver:to.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:or.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:zs.None},realistic:{contactSolveBias:zs.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class De extends on{set compositeStrategy(t){this._compositeStrategy=t}get compositeStrategy(){return this._compositeStrategy}constructor(t){super(),this._collisionProcessor=new Pa({...ks()}),this._dynamicAABBTree=new Oc({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const i of t)this.addCollider(i)}clearColliders(){this._colliders=[]}addCollider(t){let i;t instanceof De?(i=t.getColliders(),i.forEach(n=>n.offset.addEqual(t.offset))):i=[t];for(const n of i)n.events.pipe(this.events),n.composite=this,this._colliders.push(n),this._collisionProcessor.track(n),this._dynamicAABBTree.trackCollider(n)}removeCollider(t){t.events.pipe(this.events),t.composite=null,ur(t,this._colliders),this._collisionProcessor.untrack(t),this._dynamicAABBTree.untrackCollider(t)}getColliders(){return this._colliders}get worldPos(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:k.Zero).add(this.offset)}get center(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:k.Zero).add(this.offset)}get bounds(){var t,i;const n=this.getColliders();return n.reduce((h,c)=>h.combine(c.bounds),(i=(t=n[0])===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new ct().translate(this.worldPos)).translate(this.offset)}get localBounds(){var t,i;const n=this.getColliders();return n.reduce((h,c)=>h.combine(c.localBounds),(i=(t=n[0])===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new ct)}get axes(){const t=this.getColliders();let i=[];for(const n of t)i=i.concat(n.axes);return i}getFurthestPoint(t){const i=this.getColliders(),n=[];for(const c of i)n.push(c.getFurthestPoint(t));let o=n[0],h=-Number.MAX_VALUE;for(const c of n){const g=c.dot(t);g>h&&(o=c,h=g)}return o}getInertia(t){const i=this.getColliders();let n=0;for(const o of i)n+=o.getInertia(t);return n}collide(t){let i=[t];t instanceof De&&(i=t.getColliders());const n=[];for(const h of i)this._dynamicAABBTree.query(h,c=>(n.push(new ii(h,c)),!1));let o=[];for(const h of n)o=o.concat(h.collide());return o}getClosestLineBetween(t){const i=this.getColliders(),n=[];if(t instanceof De){const o=t.getColliders();for(const h of i)for(const c of o){const g=h.getClosestLineBetween(c);g&&n.push(g)}}else for(const o of i){const h=t.getClosestLineBetween(o);h&&n.push(h)}if(n.length){let o=n[0].getLength(),h=n[0];for(const c of n){const g=c.getLength();g<o&&(o=g,h=c)}return h}return null}contains(t){const i=this.getColliders();for(const n of i)if(n.contains(t))return!0;return!1}rayCast(t,i){const n=this.getColliders(),o=[];for(const h of n){const c=h.rayCast(t,i);c&&o.push(c)}if(o.length){let h=o[0],c=h.point.dot(t.dir);for(const g of o){const _=t.dir.dot(g.point);_<c&&(h=g,c=_)}return h}return null}project(t){const i=this.getColliders(),n=[];for(const o of i){const h=o.project(t);h&&n.push(h)}if(n.length){const o=new go(n[0].min,n[0].max);for(const h of n)o.min=Math.min(h.min,o.min),o.max=Math.max(h.max,o.max);return o}return null}update(t){if(t){const i=this.getColliders();for(const n of i)n.owner=this.owner,n.update(t)}}debug(t,i,n){const o=this.getColliders();t.save(),t.translate(this.offset.x,this.offset.y);for(const h of o)h.debug(t,i,n);t.restore()}clone(){const t=new De(this._colliders.map(i=>i.clone()));return t.offset=this.offset.clone(),t}}class ge{constructor(t,i){this.begin=t,this.end=i}clone(t){const i=t||new ge(this.begin.clone(),this.end.clone());return i.begin=this.begin.clone(i.begin),i.end=this.end.clone(i.end),i}transform(t,i){const n=i||new ge(k.Zero,k.Zero);return n.begin=t.multiply(this.begin,n.begin),n.end=t.multiply(this.end,n.end),n}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const t=this.begin,i=this.end,n=t.distance(i);return this._slope=i.sub(t).scale(1/n)}getEdge(){const t=this.begin;return this.end.sub(t)}getLength(){const t=this.begin,i=this.end;return t.distance(i)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new ge(this.end,this.begin)}below(t){return(this.end.x-this.begin.x)*(t.y-this.begin.y)-(this.end.y-this.begin.y)*(t.x-this.begin.x)>=0}clip(t,i,n=!0){let o=t;n&&(o=o.normalize());const h=o.dot(this.begin)-i,c=o.dot(this.end)-i,g=[];if(h<=0&&g.push(this.begin),c<=0&&g.push(this.end),h*c<0){const _=h/(h-c);g.push(this.begin.add(this.end.sub(this.begin).scale(_)))}return g.length!==2?null:new ge(g[0],g[1])}distanceToPoint(t,i=!1){const n=t.x,o=t.y,h=this.getLength(),c=this.end.y-this.begin.y,g=this.end.x-this.begin.x,_=(c*n-g*o+this.end.x*this.begin.y-this.end.y*this.begin.x)/h;return i?_:Math.abs(_)}findVectorToPoint(t){const i=this.begin.sub(t),n=this.getSlope();return i.sub(n.scale(i.dot(n)))}findPoint(t=null,i=null){const n=this.slope,o=this.intercept;if(t!==null)return new k(t,n*t+o);if(i!==null)return new k((i-o)/n,i);throw new Error("You must provide an X or a Y value")}hasPoint(){let t,i=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")t=new k(arguments[0],arguments[1]),i=arguments[2]||0;else if(arguments[0]instanceof k)t=arguments[0],i=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const n=t.x-this.begin.x,o=t.y-this.begin.y,h=this.end.x-this.begin.x,c=this.end.y-this.begin.y,g=n*c-o*h;return Math.abs(g)>i?!1:Math.abs(h)>=Math.abs(c)?h>0?this.begin.x<=t.x&&t.x<=this.end.x:this.end.x<=t.x&&t.x<=this.begin.x:c>0?this.begin.y<=t.y&&t.y<=this.end.y:this.end.y<=t.y&&t.y<=this.begin.y}}function xl(d,t){const n=d.dir(),o=t.dir(),h=n.dot(n),c=o.dot(o);if(h<1e-9&&c<1e-9)return new ge(d.begin,t.begin);if(h<1e-9){const R=St(o.dot(d.begin.sub(t.begin))/c,0,1),E=t.begin.add(o.scale(R));return new ge(d.begin,E)}if(c<1e-9){const R=St(n.dot(t.begin.sub(d.begin))/h,0,1),E=d.begin.add(n.scale(R));return new ge(E,t.begin)}const g=d.begin.sub(t.begin),_=h,v=c,x=o.dot(g),A=_*v-Math.pow(n.dot(o),2);let S=0,P=0;Math.abs(A)>1e-9?S=St((n.dot(o)*x-v*n.dot(g))/A,0,1):S=St(n.dot(g)/_,0,1),Math.abs(v)>1e-9?P=St((n.dot(o)*S+x)/v,0,1):P=0;const I=d.begin.add(n.scale(S)),F=t.begin.add(o.scale(P));return new ge(I,F)}const ds={PolygonPolygonClosestLine(d,t){const i=d.getSides(),n=t.getSides();let o=Number.MAX_VALUE,h=null;for(let c=0;c<i.length;c++)for(let g=0;g<n.length;g++){const _=xl(i[c],n[g]),v=_.getLength();v<o&&(o=v,h=_)}return h},PolygonEdgeClosestLine(d,t){const n=t.worldPos.sub(d.worldPos),o=new In(d.worldPos,n),h=d.rayCast(o).point.add(o.dir.scale(.1)),c=d.getClosestFace(h),g=t.asLine();return xl(c.face,g)},PolygonCircleClosestLine(d,t){const i=t.worldPos,n=i.sub(d.worldPos),o=new In(d.worldPos,n.normalize()),h=d.rayCast(o).point.add(o.dir.scale(.1)),c=d.getClosestFace(h),g=c.face.begin,_=c.face.getEdge();let v=(_.x*(i.x-g.x)+_.y*(i.y-g.y))/(_.x*_.x+_.y*_.y);v>1?v=1:v<0&&(v=0);const x=Math.sqrt(Math.pow(g.x+_.x*v-i.x,2)+Math.pow(g.y+_.y*v-i.y,2))-t.radius,A=(g.x+_.x*v-i.x)*t.radius/(t.radius+x),S=(g.y+_.y*v-i.y)*t.radius/(t.radius+x);return new ge(_.scale(v).add(g),new k(i.x+A,i.y+S))},CircleCircleClosestLine(d,t){const n=t.worldPos.sub(d.worldPos),h=d.worldPos.sub(t.worldPos),c=new In(d.worldPos,n),g=new In(t.worldPos,h),_=d.rayCast(c),v=t.rayCast(g);return new ge(_.point,v.point)},CircleEdgeClosestLine(d,t){const i=d.worldPos,n=t.asLine(),o=n.begin,h=n.getEdge(),c=o,g=h;let _=(g.x*(i.x-c.x)+g.y*(i.y-c.y))/(g.x*g.x+g.y*g.y);_>1?_=1:_<0&&(_=0);const v=Math.sqrt(Math.pow(c.x+g.x*_-i.x,2)+Math.pow(c.y+g.y*_-i.y,2))-d.radius,x=(c.x+g.x*_-i.x)*d.radius/(d.radius+v),A=(c.y+g.y*_-i.y)*d.radius/(d.radius+v);return new ge(g.scale(_).add(c),new k(i.x+x,i.y+A))},EdgeEdgeClosestLine(d,t){const i=d.asLine(),n=t.asLine();return xl(i,n)}};class qe extends on{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var t;if(this._radius)return this._radius;const i=this._transform,n=(t=i?.globalScale)!==null&&t!==void 0?t:k.One;return this._radius=this._naturalRadius*Math.min(n.x,n.y)}set radius(t){var i;const n=this._transform,o=(i=n?.globalScale)!==null&&i!==void 0?i:k.One;this._naturalRadius=t/Math.min(o.x,o.y),this._localBoundsDirty=!0,this._radius=t}constructor(t){super(),this.offset=k.Zero,this._globalMatrix=xe.identity(),this._localBoundsDirty=!0,this.offset=t.offset||k.Zero,this.radius=t.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new qe({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(t){var i,n;return((n=(i=this._transform)===null||i===void 0?void 0:i.pos)!==null&&n!==void 0?n:this.offset).distance(t)<=this.radius}rayCast(t,i=1/0){var n,o;const h=this.center,c=t.dir,g=t.pos,_=h.sub(g),v=c.scale(_.dot(c)),A=_.sub(v).magnitude;if(A>this.radius)return null;{let S=0;if(bf(A,this.radius,1e-4)){if(S=-c.dot(g.sub(h)),S>0&&S<i){const P=t.getPoint(S);return{point:P,normal:P.sub(h).normalize(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(Tt),distance:S}}return null}else{const P=Math.sqrt(Math.pow(c.dot(g.sub(h)),2)-Math.pow(g.sub(h).distance(),2)+Math.pow(this.radius,2)),I=-c.dot(g.sub(h))+P,F=-c.dot(g.sub(h))-P,R=[];I>=0&&R.push(I),F>=0&&R.push(F);const E=Math.min(...R);if(E<=i){const M=t.getPoint(E);return{point:M,normal:M.sub(h).normalize(),collider:this,body:(o=this.owner)===null||o===void 0?void 0:o.get(Tt),distance:E}}return null}}}getClosestLineBetween(t){if(t instanceof qe)return ds.CircleCircleClosestLine(this,t);if(t instanceof Ue)return ds.PolygonCircleClosestLine(t,this).flip();if(t instanceof wi)return ds.CircleEdgeClosestLine(this,t).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof qe)return Xi.CollideCircleCircle(this,t);if(t instanceof Ue)return Xi.CollideCirclePolygon(this,t);if(t instanceof wi)return Xi.CollideCircleEdge(this,t);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){return this.center.add(t.normalize().scale(this.radius))}getFurthestLocalPoint(t){return t.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new ct(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(t){return t*this.radius*this.radius/2}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(t){const i=[],o=this.center.dot(t);return i.push(o),i.push(o+this.radius),i.push(o-this.radius),new go(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i,n){var o,h,c,g;const{lineWidth:_}={lineWidth:1,...n},v=this._transform,x=(o=v?.globalScale)!==null&&o!==void 0?o:k.One,A=(h=v?.globalRotation)!==null&&h!==void 0?h:0,S=(c=v?.globalPos)!==null&&c!==void 0?c:k.Zero;t.save(),t.translate(S.x,S.y),t.rotate(A),t.scale(x.x,x.y),t.drawCircle((g=this.offset)!==null&&g!==void 0?g:k.Zero,this._naturalRadius,$.Transparent,i,_),t.restore()}}class bn{constructor(t,i,n,o,h,c,g,_){var v,x,A,S,P,I;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=t,this.colliderB=i,this.mtv=n,this.normal=o,this.tangent=h,this.points=c,this.localPoints=g,this.info=_,this.id=ii.calculatePairHash(t.id,i.id),t.composite||i.composite){const F=((v=t.composite)===null||v===void 0?void 0:v.compositeStrategy)==="separate"?t.id:(A=(x=t.composite)===null||x===void 0?void 0:x.id)!==null&&A!==void 0?A:t.id,R=((S=i.composite)===null||S===void 0?void 0:S.compositeStrategy)==="separate"?i.id:(I=(P=i.composite)===null||P===void 0?void 0:P.id)!==null&&I!==void 0?I:i.id;this.id+="|"+ii.calculatePairHash(F,R)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(Tt)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(Tt))}matchAwake(){const t=this.bodyA,i=this.bodyB;t&&i&&t.isSleeping!==i.isSleeping&&(t.isSleeping&&t.collisionType!==gt.Fixed&&i.sleepMotion>=t.wakeThreshold&&(t.isSleeping=!1),i.isSleeping&&i.collisionType!==gt.Fixed&&t.sleepMotion>=i.wakeThreshold&&(i.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(t){if(t!==this.colliderA&&t!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(t===this.colliderA)return this;const i=this.colliderA,n=this.colliderB;return this.colliderB=i,this.colliderA=n,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class Vf{constructor(){this.axis=N(0,0),this.localAxis=N(0,0),this.side=new ge(N(0,0),N(0,0)),this.localSide=new ge(N(0,0),N(0,0)),this.point=N(0,0),this.localPoint=N(0,0)}}class we{static findPolygonPolygonSeparation(t,i){if(i.transform.matrix.determinant()===0)return we.findPolygonPolygonSeparationDegenerate(t,i);let n=-Number.MAX_VALUE,o=-1,h;const c=i.transform.inverse.multiply(t.transform.matrix,we._SCRATCH_MATRIX),g=c.getRotation(),_=t.normals,v=t.points,x=i.points;for(let P=0;P<v.length;P++){const I=_[P].rotate(g,we._ZERO,we._SCRATCH_NORMAL),F=c.multiply(v[P],we._SCRATCH_POINT);let R=Number.MAX_VALUE,E;for(let M=0;M<x.length;M++){const V=I.dot(x[M].sub(F,we._SCRATCH_SUB_POINT));V<R&&(R=V,E=x[M])}R>n&&(n=R,o=P,h=E)}const A=(o+1)%v.length,S=we.SeparationPool.get();return S.collider=t,S.separation=n,n>0||(_[o].clone(S.localAxis),_[o].rotate(t.transform.rotation,we._ZERO,S.axis),t.transform.matrix.multiply(v[o],S.side.begin),t.transform.matrix.multiply(v[A],S.side.end),i.transform.matrix.multiply(h,S.point),S.sideId=o,h.clone(S.localPoint),v[o].clone(S.localSide.begin),v[A].clone(S.localSide.end)),S}static findCirclePolygonSeparation(t,i){const n=i.axes,h=i.center.sub(t.worldPos),c=i.getFurthestPoint(h.negate());n.push(c.sub(t.worldPos).normalize());let g=Number.MAX_VALUE,_=null,v=-1;for(let x=0;x<n.length;x++){const A=i.project(n[x]),S=t.project(n[x]),P=A.getOverlap(S);if(P<=0)return null;P<g&&(g=P,_=n[x],v=x)}return v<0?null:_.normalize().scale(g)}static findPolygonPolygonSeparationDegenerate(t,i){let n=-Number.MAX_VALUE,o=null,h=null,c=-1,g=null;const _=t.getSides(),v=t.getLocalSides();for(let x=0;x<_.length;x++){const A=_[x],S=A.normal(),P=i.getFurthestPoint(S.negate()),I=A.distanceToPoint(P,!0);I>n&&(n=I,o=A,h=S,c=x,g=P)}return{collider:t,separation:h?n:99,axis:h,side:o,localSide:v[c],sideId:c,point:g,localPoint:h?i.getFurthestLocalPoint(h.negate()):null}}}we.SeparationPool=new Ba(()=>new Vf,d=>d,500);we._ZERO=N(0,0);we._SCRATCH_POINT=N(0,0);we._SCRATCH_SUB_POINT=N(0,0);we._SCRATCH_NORMAL=N(0,0);we._SCRATCH_MATRIX=xe.identity();we.SeparationPool.disableWarnings=!0;const Wv=k.Zero,Nv=k.Zero,Gv=xe.identity(),Xi={CollideCircleCircle(d,t){const i=d.worldPos,n=t.worldPos,o=d.radius+t.radius,h=i.distance(n);if(h>o)return[];const c=o-h,g=n.sub(i).normalize(),_=g.perpendicular(),v=g.scale(c),x=d.getFurthestPoint(g),A=d.getFurthestLocalPoint(g),S={collider:d,separation:c,axis:g,point:x};return[new bn(d,t,v,g,_,[x],[A],S)]},CollideCirclePolygon(d,t){var i,n;let o=we.findCirclePolygonSeparation(d,t);if(!o)return[];o=o.dot(t.center.sub(d.center))<0?o.negate():o;const c=d.getFurthestPoint(o),_=((n=(i=d.owner)===null||i===void 0?void 0:i.get(nt))!==null&&n!==void 0?n:new nt).applyInverse(c),v=o.normalize(),x={collider:d,separation:-o.magnitude,axis:v,point:c,localPoint:_,side:t.findSide(v.negate()),localSide:t.findLocalSide(v.negate())};return[new bn(d,t,o,v,v.perpendicular(),[c],[_],x)]},CollideCircleEdge(d,t){const i=d.center,n=t.asLine(),o=n.end.sub(n.begin),h=o.dot(n.end.sub(i)),c=o.dot(i.sub(n.begin)),g=t.asLine(),_=t.asLocalLine();if(c<=0){const E=n.begin.sub(i),M=E.dot(E);if(M>d.radius*d.radius)return[];const V=E.normalize(),L=d.radius-Math.sqrt(M),G={collider:d,separation:L,axis:V,point:g.begin,side:g,localSide:_};return[new bn(d,t,V.scale(L),V,V.perpendicular(),[g.begin],[_.begin],G)]}if(h<=0){const E=n.end.sub(i),M=E.dot(E);if(M>d.radius*d.radius)return[];const V=E.normalize(),L=d.radius-Math.sqrt(M),G={collider:d,separation:L,axis:V,point:g.end,side:g,localSide:_};return[new bn(d,t,V.scale(L),V,V.perpendicular(),[g.end],[_.end],G)]}const v=o.dot(o),x=n.begin.scale(h).add(n.end.scale(c)).scale(1/v),A=i.sub(x),S=A.dot(A);if(S>d.radius*d.radius)return[];let P=o.perpendicular();P.dot(i.sub(n.begin))<0&&(P.x=-P.x,P.y=-P.y),P=P.normalize();const I=d.radius-Math.sqrt(S),F=P.scale(I),R={collider:d,separation:I,axis:P,point:x,side:g,localSide:_};return[new bn(d,t,F,P.negate(),P.negate().perpendicular(),[x],[x.sub(t.worldPos)],R)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(d,t){var i;const n=d.center,h=t.center.sub(n).normalize(),c=new Ue({points:[t.begin,t.end,t.end.add(h.scale(100)),t.begin.add(h.scale(100))],offset:t.offset});c.owner=t.owner,((i=t.owner)===null||i===void 0?void 0:i.get(nt))&&c.update(t.owner.get(nt).get());const _=this.CollidePolygonPolygon(d,c);return _.length&&(_[0].colliderB=t,_[0].id=ii.calculatePairHash(d.id,t.id)),_},CollidePolygonPolygon(d,t){const i=we.findPolygonPolygonSeparation(d,t);if(i.separation>0)return[];const n=we.findPolygonPolygonSeparation(t,d);if(n.separation>0)return[];const o=i.separation>n.separation?i:n,h=o.collider===d?t:d,c=o.collider===d?d:t,g=h.transform.inverse.multiply(c.transform.matrix,Gv),_=g.getRotation(),v=c.normals[o.sideId].rotate(_,Wv,Nv);let x=Number.MAX_VALUE,A=0;for(let E=0;E<h.normals.length;E++){const M=v.dot(h.normals[E]);M<x&&(x=M,A=E)}if(!o.localSide||!o.localAxis||!o.axis)return[];const S=o.localSide.transform(g),P=o.localAxis.perpendicular().negate().rotate(_),F=new ge(h.points[A],h.points[(A+1)%h.points.length]).clip(P.negate(),-P.dot(S.begin),!1);let R=null;if(F&&(R=F.clip(P,P.dot(S.end),!1)),R){const E=[],M=[],V=R.getPoints();for(let j=0;j<V.length;j++){const X=V[j];S.below(X)&&(E.push(X),M.push(h.transform.apply(X)))}let L=o.axis,G=L.perpendicular();return t.center.sub(d.center).dot(L)<0&&(L=L.negate(),G=L.perpendicular()),[new bn(d,t,L.scale(-o.separation),L,G,M,E,o)]}return[]},FindContactSeparation(d,t){var i,n,o,h;const c=d.colliderA,g=(n=(i=d.bodyA)===null||i===void 0?void 0:i.transform)!==null&&n!==void 0?n:new nt,_=d.colliderB,v=(h=(o=d.bodyB)===null||o===void 0?void 0:o.transform)!==null&&h!==void 0?h:new nt;if(c instanceof qe&&_ instanceof qe){const x=c.radius+_.radius,A=g.pos.distance(v.pos);return-(x-A)}if(c instanceof Ue&&_ instanceof Ue&&d.info.localSide){let x,A;return d.info.collider===c?(x=new ge(g.apply(d.info.localSide.begin).add(c.offset),g.apply(d.info.localSide.end).add(c.offset)),A=v.apply(t).add(_.offset)):(x=new ge(v.apply(d.info.localSide.begin).add(_.offset),v.apply(d.info.localSide.end).add(_.offset)),A=g.apply(t).add(c.offset)),x.distanceToPoint(A,!0)}if(c instanceof Ue&&_ instanceof qe||_ instanceof Ue&&c instanceof qe){const x=g.apply(t);if(d.info.side)return d.info.side.distanceToPoint(x,!0)}if(c instanceof wi&&_ instanceof Ue||_ instanceof wi&&c instanceof Ue){let x;if(d.info.collider===c?x=v.apply(t):x=g.apply(t),d.info.side)return d.info.side.distanceToPoint(x,!0)}if(c instanceof qe&&_ instanceof wi||_ instanceof qe&&c instanceof wi){const x=v.apply(t);let A;c instanceof qe&&(A=c.getFurthestPoint(d.normal));const S=x.distance(A);if(d.info.side)return S>0?-S:0}return 0}};class wi extends on{constructor(t){var i;super(),this._globalMatrix=xe.identity(),this.begin=t.begin||k.Zero,this.end=t.end||k.Zero,this.offset=(i=t.offset)!==null&&i!==void 0?i:k.Zero}clone(){return new wi({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var t;const i=this._transform;return(t=i?.globalPos.add(this.offset))!==null&&t!==void 0?t:this.offset}get center(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.average(i)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const t=this._getTransformedBegin(),i=this._getTransformedEnd(),n=t.distance(i);return i.sub(t).scale(1/n)}getLength(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.distance(i)}contains(){return!1}rayCast(t,i=1/0){var n;const o=this._getTransformedBegin().sub(t.pos);if(t.dir.cross(this.getSlope())===0&&o.cross(t.dir)!==0)return null;const h=t.dir.cross(this.getSlope());if(h===0)return null;const c=o.cross(this.getSlope())/h;if(c>=0&&c<=i){const g=o.cross(t.dir)/h/this.getLength();if(g>=0&&g<=1)return{distance:c,normal:this.asLine().normal(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(Tt),point:t.getPoint(c)}}return null}getClosestLineBetween(t){if(t instanceof qe)return ds.CircleEdgeClosestLine(t,this);if(t instanceof Ue)return ds.PolygonEdgeClosestLine(t,this).flip();if(t instanceof wi)return ds.EdgeEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof qe)return Xi.CollideCircleEdge(t,this);if(t instanceof Ue)return Xi.CollidePolygonEdge(t,this);if(t instanceof wi)return Xi.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this._getTransformedBegin(),n=this._getTransformedEnd();return t.dot(i)>0?i:n}_boundsFromBeginEnd(t,i,n=10){return new ct(Math.min(t.x,i.x)-n,Math.min(t.y,i.y)-n,Math.max(t.x,i.x)+n,Math.max(t.y,i.y)+n)}get bounds(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return this._boundsFromBeginEnd(t,i)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new ge(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new ge(this.begin,this.end)}get axes(){const i=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),n=[];return n.push(i),n.push(i.negate()),n.push(i.normal()),n.push(i.normal().negate()),n}getInertia(t){const i=this.end.sub(this.begin).distance()/2;return t*i*i}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(t){const i=[],n=[this._getTransformedBegin(),this._getTransformedEnd()],o=n.length;for(let h=0;h<o;h++)i.push(n[h].dot(t));return new go(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i){const n=this._getTransformedBegin(),o=this._getTransformedEnd();t.drawLine(n,o,i,2),t.drawCircle(n,2,i),t.drawCircle(o,2,i)}}class Re{static registerGraphicsContext(t){Re._ctx=t}static draw(t){this._drawCalls.push(t)}static drawPoint(t,i){Re.draw(n=>{n.debug.drawPoint(t,i)})}static drawLine(t,i,n){Re.draw(o=>{o.debug.drawLine(t,i,n)})}static drawLines(t,i){t.length>1&&Re.draw(n=>{for(let o=0;o<t.length-1;o++)n.debug.drawLine(t[o],t[o+1],i)})}static drawText(t,i){Re.draw(n=>{n.debug.drawText(t,i)})}static drawPolygon(t,i){t.length>1&&Re.draw(n=>{const o=t[0],h=[...t,o];for(let c=0;c<h.length-1;c++)n.debug.drawLine(h[c],h[c+1],i)})}static drawCircle(t,i,n){const{color:o,strokeColor:h,width:c}={color:$.Black,strokeColor:void 0,width:void 0,...n};Re.draw(g=>{g.drawCircle(t,i,o,h,c)})}static drawBounds(t,i){Re.draw(n=>{n.debug.drawRect(t.left,t.top,t.width,t.height,i)})}static drawRay(t,i){const{distance:n,color:o}={color:$.Blue,distance:10,...i};Re.draw(h=>{const c=t.pos,g=t.pos.add(t.dir.scale(n));h.debug.drawLine(c,g,{color:o})})}static flush(t){t.save(),t.z=Re.z;for(const i of Re._drawCalls)i(t);t.restore(),Re.clear()}static clear(){Re._drawCalls.length=0}}Re._drawCalls=[];Re.z=1/0;class Ue extends on{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(t){if(t.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=t,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const t=[];for(let i=0;i<this._points.length;i++)t.push(this._points[(i+1)%this._points.length].sub(this._points[i]).normal());this._normals=t}get points(){return this._points}get transform(){return this._transform}constructor(t){var i;super(),this._logger=ut.getInstance(),this._transform=new Ls,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(i=t.offset)!==null&&i!==void 0?i:k.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=t.points,this.isConvex()||t.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(t){this._isCounterClockwiseWinding(t)||t.reverse()}_isCounterClockwiseWinding(t){let i=0;for(let n=0;n<t.length;n++)i+=(t[(n+1)%t.length].x-t[n].x)*(t[(n+1)%t.length].y+t[n].y);return i<0}isConvex(){if(this.points.length<3)return!1;let t=this.points[this.points.length-2],i=this.points[this.points.length-1],n=Math.atan2(i.y-t.y,i.x-t.x),o=0,h=0,c=0;for(const[g,_]of this.points.entries()){if(t=i,o=n,i=_,n=Math.atan2(i.y-t.y,i.x-t.x),t.equals(i))return!1;let v=n-o;if(v<=-Math.PI?v+=Math.PI*2:v>Math.PI&&(v-=Math.PI*2),g===0){if(v===0)return!1;h=v>0?1:-1}else if(h*v<=0)return!1;c+=v}return Math.abs(Math.round(c/(Math.PI*2)))===1}tessellate(){const t=[];for(let i=1;i<this.points.length-2;i++)t.push([this.points[0],this.points[i+1],this.points[i+2]]);return t.push([this.points[0],this.points[1],this.points[2]]),new De(t.map(i=>Ye.Polygon(i)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const t=[],i=[...this.points].reverse();let n=i.length;function o(A){return A===0?n-1:A-1}function h(A){return A===n-1?0:A+1}function c(A){const S=o(A),P=h(A),I=i[S],F=i[A],R=i[P],E=I.sub(F),M=R.sub(F);return!(E.cross(M)<0)}const g=i.map((A,S)=>c(S));function _(A,S,P,I){const F=P.sub(S),R=I.sub(P),E=S.sub(I),M=A.sub(S),V=A.sub(P),L=A.sub(I),G=F.cross(M),j=R.cross(V),X=E.cross(L);return!(G>0||j>0||X>0)}function v(){for(let A=0;A<n;A++)if(g[A]){const S=o(A),P=h(A),I=i[S],F=i[A],R=i[P];let E=!0;for(let M=0;M<n;M++){if(M===A||M===S||M===P)continue;const V=i[M];if(_(V,I,F,R)){E=!1;break}}if(E)return A}for(let A=0;A<n;A++)if(g[A])return A;return 0}function x(A){const S=o(A),P=h(A),I=i[S],F=i[A],R=i[P];t.push([I,F,R]),i.splice(A,1),g.splice(A,1),n--}for(;n>3;){const A=v();x(A);for(let S=0;S<n;S++)g[S]=c(S)}return t.push([i[0],i[1],i[2]]),new De(t.map(A=>Ye.Polygon(A,k.Zero,!0)))}clone(){return new Ue({offset:this.offset.clone(),points:this.points.map(t=>t.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const t=this.points,i=t.length;this._transformedPoints.length=0;for(let n=0;n<i;n++)this._transformedPoints[n]=this._transform.apply(t[n].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const t=[],i=this.getTransformedPoints(),n=i.length;for(let o=0;o<n;o++)t.push(new ge(i[o],i[(o+1)%n]));this._sides=t,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const t=[],i=this.points,n=i.length;for(let o=0;o<n;o++)t.push(new ge(i[o],i[(o+1)%n]));this._localSides=t,this._localSidesDirty=!1}return this._localSides}findSide(t){const i=this.getSides();let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=i[h],_=c.normal().dot(t);_>o&&(n=c,o=_)}return n}findLocalSide(t){const i=this.getLocalSides();let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=i[h],_=c.normal().dot(t);_>o&&(n=c,o=_)}return n}get axes(){const t=[],i=this.getSides();for(let n=0;n<i.length;n++)t.push(i[n].normal());return t}update(t){t&&(t.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(i=>N(i.x*Xt(this._transform.scale.x),i.y*Xt(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(t){const i=this._transform.applyInverse(t),n=new In(i,new k(1,0));let o=0;const h=this.getLocalSides();for(let c=0;c<h.length;c++){const g=h[c];n.intersect(g)>=0&&o++}return o%2!==0}getClosestLineBetween(t){if(t instanceof qe)return ds.PolygonCircleClosestLine(this,t);if(t instanceof Ue)return ds.PolygonPolygonClosestLine(this,t);if(t instanceof wi)return ds.PolygonEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof qe)return Xi.CollideCirclePolygon(t,this);if(t instanceof Ue)return Xi.CollidePolygonPolygon(this,t);if(t instanceof wi)return Xi.CollidePolygonEdge(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this.getTransformedPoints();let n=null,o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=t.dot(i[h]);c>o&&(o=c,n=i[h])}return n}getFurthestLocalPoint(t){const i=this.points;let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=t.dot(i[h]);c>o&&(o=c,n=i[h])}return n}getClosestFace(t){const i=this.getSides();let n=Number.POSITIVE_INFINITY,o=-1,h=-1;for(let c=0;c<i.length;c++){const g=i[c].distanceToPoint(t);g<n&&(n=g,o=c,h=g)}return o!==-1?{distance:i[o].normal().scale(h),face:i[o]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=ct.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(t){if(this._cachedMass===t&&this._cachedInertia)return this._cachedInertia;let i=0,n=0;const o=this.points;for(let h=0;h<o.length;h++){const c=(h+1)%o.length,g=o[c].cross(o[h]);i+=g*(o[h].dot(o[h])+o[h].dot(o[c])+o[c].dot(o[c])),n+=g}return this._cachedMass=t,this._cachedInertia=t/6*(i/n)}rayCast(t,i=1/0){var n;const o=this.getSides(),h=o.length;let c=Number.MAX_VALUE,g,_=-1;for(let v=0;v<h;v++){const x=t.intersect(o[v]);x>=0&&x<c&&x<=i&&(c=x,g=o[v],_=v)}return _>=0?{collider:this,distance:c,body:(n=this.owner)===null||n===void 0?void 0:n.get(Tt),point:t.getPoint(c),normal:g.normal()}:null}project(t){const i=this.getTransformedPoints(),n=i.length;let o=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let c=0;c<n;c++){const g=i[c].dot(t);o=Math.min(o,g),h=Math.max(h,g)}return new go(o,h)}debug(t,i,n){const o=this.getTransformedPoints();Re.drawPolygon(o,{color:i})}}class Ye{static Box(t,i,n=k.Half,o=k.Zero){return new Ue({points:new ct(-t*n.x,-i*n.y,t-t*n.x,i-i*n.y).getPoints(),offset:o})}static Polygon(t,i=k.Zero,n=!1){return new Ue({points:t,offset:i,suppressConvexWarning:n})}static Circle(t,i=k.Zero){return new qe({radius:t,offset:i})}static Edge(t,i){return new wi({begin:t,end:i})}static Capsule(t,i,n=k.Zero){const o=ut.getInstance();return t===i&&o.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),i>=t?new De([Ye.Circle(t/2,N(0,-i/2+t/2).add(n)),Ye.Box(t,i-t,k.Half,n),Ye.Circle(t/2,N(0,i/2-t/2).add(n))]):new De([Ye.Circle(i/2,N(-t/2+i/2,0).add(n)),Ye.Box(t-i,i,k.Half,n),Ye.Circle(i/2,N(t/2-i/2,0).add(n))])}}class Ae extends Di{constructor(t){super(),this.events=new $t,this.$colliderAdded=new ei,this.$colliderRemoved=new ei,this._collidersToRemove=[],this.set(t)}get(){return this._collider}set(t){return this.clear(),t&&(this._collider=t,this._collider.owner=this.owner,t.events.pipe(this.events),this.$colliderAdded.notifyAll(t),this.update()),t}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const t of this._collidersToRemove)t.events.unpipe(this.events),this.$colliderRemoved.notifyAll(t),t.owner=null}clone(){return new Ae(this._collider.clone())}get bounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new ct}get localBounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new ct}update(){var t;const i=(t=this.owner)===null||t===void 0?void 0:t.get(nt);this._collider&&(this._collider.owner=this.owner,i&&this._collider.update(i.get()))}collide(t){let i=this._collider,n=t._collider;if(!i||!n)return[];let o=!1;if(n instanceof De&&(i=n,n=this._collider,o=!0),this._collider){const h=i.collide(n);return h?(o&&h.forEach(c=>{c.mtv=c.mtv.negate(),c.normal=c.normal.negate(),c.tangent=c.normal.perpendicular(),c.colliderA=this._collider,c.colliderB=t._collider}),h):[]}return[]}onAdd(t){this._collider&&this.update(),this.events.on("precollision",i=>{const n=i;t.events.emit("precollision",new Un(n.self,n.other,n.side,n.intersection,n.contact)),t instanceof si&&t.onPreCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("postcollision",i=>{const n=i;t.events.emit("postcollision",new zn(n.self,n.other,n.side,n.intersection,n.contact)),t instanceof si&&t.onPostCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("collisionstart",i=>{const n=i;t.events.emit("collisionstart",new Zr(n.self,n.other,n.side,n.contact)),t instanceof si&&t.onCollisionStart(n.self,n.other,n.side,n.contact)}),this.events.on("collisionend",i=>{const n=i;t.events.emit("collisionend",new Jr(n.self,n.other,n.side,n.lastContact)),t instanceof si&&t.onCollisionEnd(n.self,n.other,n.side,n.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(t,i,n=k.Half,o=k.Zero){const h=Ye.Box(t,i,n,o);return this.set(h)}usePolygonCollider(t,i=k.Zero){const n=Ye.Polygon(t,i);return this.set(n)}useCircleCollider(t,i=k.Zero){const n=Ye.Circle(t,i);return this.set(n)}useEdgeCollider(t,i){const n=Ye.Edge(t,i);return this.set(n)}useCompositeCollider(t){return this.set(new De(t))}}var li;(function(d){d.Rotation="rotation",d.X="x",d.Y="y"})(li||(li={}));class Tt extends Di{constructor(t){var i,n,o;super(),this.dependencies=[nt,kt],this.id=Bn("body",Tt._ID++),this.events=new $t,this.oldTransform=new Ls,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=gt.PreventCollision,this.group=Us.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=k.Zero,this.oldVel=new k(0,0),this.oldAcc=k.Zero,this._impulseScratch=N(0,0),this._distanceFromCenterScratch=N(0,0),t?(this.collisionType=(i=t.type)!==null&&i!==void 0?i:this.collisionType,this.group=(n=t.group)!==null&&n!==void 0?n:this.group,this.useGravity=(o=t.useGravity)!==null&&o!==void 0?o:this.useGravity,this._bodyConfig={...ks().bodies,...t.config}):this._bodyConfig={...ks().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=Tt._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(t){this._bodyConfig={...ks().bodies,...t},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(t){Tt._DEFAULT_CONFIG=t}get mass(){return this._mass}set mass(t){this._mass=t,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===gt.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(t){this.isSleeping=t}set isSleeping(t){this._sleeping=t,t?(this.vel=k.Zero,this.acc=k.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const t=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),i=this._bodyConfig.sleepBias;this.sleepMotion=i*this.sleepMotion+(1-i)*t,this.sleepMotion=St(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const t=this.owner.get(Ae);if(t){t.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),t.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const i=t.get();if(i)return this._cachedInertia=i.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===gt.Fixed?0:1/this.inertia}get active(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get isActive(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get center(){return this.globalPos}onAdd(t){var i,n;this.transform=(i=this.owner)===null||i===void 0?void 0:i.get(nt),this.motion=(n=this.owner)===null||n===void 0?void 0:n.get(kt)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get globalPos(){return this.transform.globalPos}set globalPos(t){this.transform.globalPos=t}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t}get torque(){return this.motion.torque}set torque(t){this.motion.torque=t}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(t){this.transform.globalRotation=t}get scale(){return this.transform.globalScale}set scale(t){this.transform.globalScale=t}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(t){this.motion.scaleFactor=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}applyImpulse(t,i){if(this.collisionType!==gt.Active)return;const n=i.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(li.X)>-1&&(n.x=0),this.limitDegreeOfFreedom.indexOf(li.Y)>-1&&(n.y=0),this.vel.addEqual(n),!this.limitDegreeOfFreedom.includes(li.Rotation)){const o=t.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*o.cross(i)}}applyLinearImpulse(t){if(this.collisionType!==gt.Active)return;const i=t.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(li.X)&&(i.x=0),this.limitDegreeOfFreedom.includes(li.Y)&&(i.y=0),this.vel=this.vel.add(i)}applyAngularImpulse(t,i){if(this.collisionType===gt.Active&&!this.limitDegreeOfFreedom.includes(li.Rotation)){const n=t.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*n.cross(i)}}captureOldTransform(){this.__oldTransformCaptured=!0;const t=this.transform.get();t.clone(this.oldTransform),this.oldTransform.parent=t.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}Tt._ID=0;Tt._DEFAULT_CONFIG={...ks().bodies};class po extends gr{constructor(t){super(t),this.width=t.width,this.height=t.height,this.rasterize()}clone(){return new po({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.color&&t.fillRect(0,0,this.width,this.height),this.strokeColor&&t.strokeRect(0,0,this.width,this.height)}}class Ha extends gr{get radius(){return this._radius}set radius(t){this._radius=t,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(t){var i,n,o;super(t),this._radius=0;const h=(i=t.lineWidth)!==null&&i!==void 0?i:t.strokeColor?1:0;this.padding=(n=t.padding)!==null&&n!==void 0?n:2+h/2,this.radius=t.radius,this.filtering=(o=t.filtering)!==null&&o!==void 0?o:be.Blended,this.rasterize()}clone(){return new Ha({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.radius>0&&(t.beginPath(),t.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&t.fill(),this.strokeColor&&t.stroke())}}class sn extends Di{constructor(t){var i,n;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(i=t?.useColliderShape)!==null&&i!==void 0?i:this.useColliderShape,this.useGraphicsBounds=(n=t?.useGraphicsBounds)!==null&&n!==void 0?n:this.useGraphicsBounds,this.localBounds=t?.localBounds}}class Gt{static CreateReversibleEasingFunction(t){return(i,n,o,h)=>o<n?n-(t(i,o,n,h)-o):t(i,n,o,h)}static CreateVectorEasingFunction(t){return(i,n,o,h)=>new k(t(i,n.x,o.x,h),t(i,n.y,o.y,h))}}Gt.Linear=Gt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,i*d/n+t));Gt.EaseInQuad=Gt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,i*d*d+t));Gt.EaseOutQuad=Gt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,-i*d*(d-2)+t));Gt.EaseInOutQuad=Gt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n/2,d<1?i/2*d*d+t:(d--,-i/2*(d*(d-2)-1)+t)));Gt.EaseInCubic=Gt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,i*d*d*d+t));Gt.EaseOutCubic=Gt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,d--,i*(d*d*d+1)+t));Gt.EaseInOutCubic=Gt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n/2,d<1?i/2*d*d*d+t:(d-=2,i/2*(d*d*d+2)+t)));class Wf{constructor(t){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=t}add(t){this._actions.push(t)}remove(t){const i=this._actions.indexOf(t);this._actions.splice(i,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const t=this._actions.length;for(let i=0;i<t;i++)this._actions[i].reset();this._completedActions=[]}update(t){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new Bc(this._currentAction,this._entity))),this._currentAction.update(t),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new kc(this._currentAction,this._entity));const i=this._actions.shift();i&&this._completedActions.push(i)}}}let Xv=0;function Vt(){return Xv++}class Nf{constructor(t,i,n){this.id=Vt(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new vo(t),this._actionQueue=this._repeatContext.getQueue(),this._repeat=n,this._originalRepeat=n,this._repeatBuilder(this._repeatContext),this._repeat--}update(t){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(t)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class Gf{constructor(t,i){this.id=Vt(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new vo(t),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(t){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(t))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function Xf(d,t,i){return(1-i)*d+t*i}function Gc(d,t,i,n){const o=(d-t+Ce)%Ce>=Math.PI,h=Math.abs(t-d),c=Ce-h;let g=0,_=0;h>c?(g=c,_=h):(g=h,_=c);let v=0,x=1;switch(i){case ae.ShortestPath:v=g,x=o?1:-1;break;case ae.LongestPath:v=_,x=o?-1:1;break;case ae.Clockwise:x=1,v=o?g:_;break;case ae.CounterClockwise:x=-1,v=o?_:g;break}return d+x*(v*n)}function _o(d,t,i){return d.scale(1-i).add(t.scale(i))}function qf(d,t,i){return(i-d)/(t-d)}function Yf(d,t,i){const n=i.sub(d),o=t.sub(d),h=n.x/o.x,c=n.y/o.y;return Math.min(h,c)}function gs(d,t,i,n,o){const h=qf(d,t,o);return Xf(i,n,h)}function qv(d,t,i,n,o){const h=Yf(d,t,o);return _o(i,n,h)}function jf(d){return d.offset instanceof k&&typeof d.duration=="number"}class Qf{constructor(t,i){var n;if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._easing=Gt.Linear,this._offset=i.offset,this._easing=(n=i.easing)!==null&&n!==void 0?n:this._easing,this._tx=t.get(nt),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=t;const i=St(gs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),c=(o-n.x)/(t/1e3),g=(h-n.y)/(t/1e3);this._motion.vel.x=c,this._motion.vel.y=g,this.isComplete(this.entity)&&(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=N(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Vl{constructor(t,i,n,o){if(this.id=Vt(),this._started=!1,this._stopped=!1,this._entity=t,this._tx=t.get(nt),this._motion=t.get(kt),this._speed=o,this._offset=new k(i,n),o<=0)throw ut.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+o),new Error("Speed must be greater than 0 pixels per second")}update(t){this._started||(this._started=!0,this._start=new k(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(t){const i=t.get(nt);return this._stopped||i.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=N(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Zf(d){return d.pos instanceof k&&typeof d.duration=="number"}class Jf{constructor(t,i){var n;if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._easing=Gt.Linear,this._end=i.pos,this._easing=(n=i.easing)!==null&&n!==void 0?n:this._easing,this._tx=t.get(nt),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=t;const i=St(gs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),c=(o-n.x)/(t/1e3),g=(h-n.y)/(t/1e3);this._motion.vel.x=c,this._motion.vel.y=g,this.isComplete(this.entity)&&(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=N(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Wl{constructor(t,i,n,o){this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(kt),this._end=new k(i,n),this._speed=o}update(t){this._started||(this._started=!0,this._start=new k(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const i=this._dir.scale(this._speed);this._motion.vel=N(i.x,i.y),this.isComplete(this.entity)&&(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0))}isComplete(t){const i=t.get(nt);return this._stopped||new k(i.pos.x,i.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=N(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Yv(d){return typeof d.angle=="number"&&typeof d.duration=="number"}class Kf{constructor(t,i){var n;if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=i.angle,this._tx=t.get(nt),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(n=i.rotationType)!==null&&n!==void 0?n:ae.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=t;const i=St(gs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Gc(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(n-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class $f{constructor(t,i,n,o){this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(kt),this._end=i,this._speed=n,this._rotationType=o||ae.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const i=Math.abs(this._end-this._start),n=Ce-i;switch(i>n?(this._shortDistance=n,this._longDistance=i):(this._shortDistance=i,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+Ce)%Ce>=Math.PI,this._rotationType){case ae.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case ae.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case ae.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case ae.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function jv(d){return typeof d.angleRadiansOffset=="number"&&typeof d.duration=="number"}class tg{constructor(t,i){var n;if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=i.angleRadiansOffset,this._tx=t.get(nt),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(n=i.rotationType)!==null&&n!==void 0?n:ae.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._endAngle=Ms(this._startAngle+this._offset),this._started=!0),this._currentMs-=t;const i=St(gs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Gc(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(n-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class eg{constructor(t,i,n,o){this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(kt),this._speed=n,this._offset=i,this._rotationType=o||ae.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const i=Math.abs(this._end-this._start),n=Ce-i;switch(i>n?(this._shortDistance=n,this._longDistance=i):(this._shortDistance=i,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+Ce)%Ce>=Math.PI,this._rotationType){case ae.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case ae.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case ae.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case ae.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function ig(d){return typeof d.scale=="object"&&typeof d.duration=="number"}class sg{constructor(t,i){if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._endScale=N(1,1),this._startScale=N(1,1),this._endScale=i.scale,this._tx=t.get(nt),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=t;const i=St(gs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=_o(this._startScale,this._endScale,i),o=this._tx.scale,h=n.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=k.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class ng{constructor(t,i,n,o,h){this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(kt),this._endX=i,this._endY=n,this._speedX=o,this._speedY=h}update(t){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*i}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*i}this.isComplete()&&(this._tx.scale=N(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function rg(d){return typeof d.scaleOffset=="object"&&typeof d.duration=="number"}class og{constructor(t,i){if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._endScale=N(1,1),this._scaleOffset=N(0,0),this._startScale=N(1,1),this._scaleOffset=i.scaleOffset,this._tx=t.get(nt),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=t;const i=St(gs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=_o(this._startScale,this._endScale,i),o=this._tx.scale,h=n.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=k.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class ag{constructor(t,i,n,o){this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(kt),this._offset=new k(i,n),this._speedX=this._speedY=o}update(t){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class of{constructor(t){this.id=Vt(),this._hasBeenCalled=!1,this._method=t}update(t){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class hg{constructor(t,i,n,o,h){this.easingFcn=h,this.id=Vt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new k(0,0),this._lerpEnd=new k(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(kt),this._lerpDuration=o,this._lerpEnd=new k(i,n)}_initialize(){this._lerpStart=new k(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=N((i-this._tx.pos.x)/(t/1e3),(n-this._tx.pos.y)/(t/1e3))):(this._tx.pos=N(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=k.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=N(0,0),this._stopped=!0}}class lg{constructor(t,i,n,o,h){this.easingFcn=h,this.id=Vt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new k(0,0),this._lerpEnd=new k(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(kt),this._lerpDuration=o,this._offset=new k(i,n)}_initialize(){this._lerpStart=new k(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=N((i-this._tx.pos.x)/(t/1e3),(n-this._tx.pos.y)/(t/1e3))):(this._tx.pos=N(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=k.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=N(0,0),this._stopped=!0}}class cg{constructor(t,i,n,o=1){this.id=Vt(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=t.get(ce),this._timeVisible=i,this._timeNotVisible=n,this._duration=(i+n)*o}update(t){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=t,this._totalTime+=t,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class dg{constructor(t,i,n){this.id=Vt(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=t.get(ce),this._endOpacity=i,this._remainingTime=this._originalTime=n}update(t){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*t)/this._remainingTime),this._remainingTime-=t,this.isComplete()&&(this._graphics.opacity=this._endOpacity),ut.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class ug{constructor(t){this.id=Vt(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=t}update(t){this._started||(this._started=!0),this._elapsedTime+=t}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class fg{constructor(t){this.id=Vt(),this._stopped=!1,this._entity=t}update(t){this._entity.get(sr).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class Nl{constructor(t,i,n){this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(kt),this._followTx=i.get(nt),this._followMotion=i.get(kt),this._current=new k(this._tx.pos.x,this._tx.pos.y),this._end=new k(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=n!==void 0?n:this._current.distance(this._end),this._speed=0}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(i!==0&&(this._speed=i),this._current=N(this._tx.pos.x,this._tx.pos.y),this._end=N(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const n=this._dir.scale(this._speed);this._motion.vel=N(n.x,n.y)}else this._motion.vel=N(0,0);this.isComplete()&&(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0))}stop(){this._motion.vel=N(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class Gl{constructor(t,i,n){this.id=Vt(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=t.get(nt),this._motion=t.get(kt),this._meetTx=i.get(nt),this._meetMotion=i.get(kt),this._current=new k(this._tx.pos.x,this._tx.pos.y),this._end=new k(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=n||0,n!==void 0&&(this._speedWasSpecified=!0)}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));i!==0&&!this._speedWasSpecified&&(this._speed=i),this._current=N(this._tx.pos.x,this._tx.pos.y),this._end=N(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const n=this._dir.scale(this._speed);this._motion.vel=N(n.x,n.y),this.isComplete()&&(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=N(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class gg{constructor(t,i,n=1e3){var o;this.id=Vt(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=t.get(ce),this._duration=n,this._entity=t,this._material=(o=t.scene)===null||o===void 0?void 0:o.engine.graphicsContext.createMaterial({name:"flash-material",color:i,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=n}update(t){var i;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=t,this._graphics&&((i=this._material)===null||i===void 0||i.update(n=>{n.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class mo{constructor(t){var i;if(this._distLookup=[],this.quality=4,t.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...t.controlPoints],this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(t){this._controlPoints=[...t],this._calculateLookup()}setControlPoint(t,i){this._controlPoints[t]=i,this._calculateLookup()}_calculateLookup(){let t=0;this._distLookup.length=0;let i=this.controlPoints[0];const n=this.controlPoints.length*this.quality;for(let o=0;o<n;o++){const h=o/(n-1),c=this.getPoint(h),g=i.distance(c);t+=g,this._distLookup.push(t),i=c}this._arcLength=t}_getTimeGivenDistance(t){const i=this._distLookup.length,n=this.arcLength;if(t>=0&&t<n){for(let o=0;o<i-1;o++)if(this._distLookup[o]<=t&&t<this._distLookup[o+1])return gs(this._distLookup[o],this._distLookup[o+1],o/(i-1),(o+1)/(i-1),t)}return t/n}getPoint(t){const i=[...this.controlPoints];for(let n=1;n<i.length;n++)for(let o=0;o<i.length-n;o++)i[o]=_o(i[o],i[o+1],t);return i[0]}getTangent(t){const i=t*t,n=this.controlPoints[0],o=this.controlPoints[1],h=this.controlPoints[2],c=this.controlPoints[3];return n.scale(-3*i+6*t-3).add(o.scale(9*i-12*t+3).add(h.scale(-9*i+6*t).add(c.scale(3*i)))).normalize()}getUniformTangent(t){const i=t*this.arcLength,n=this._getTimeGivenDistance(i);return this.getTangent(n)}getNormal(t){return this.getTangent(t).normal()}getUniformNormal(t){return this.getUniformTangent(t).normal()}getUniformPoint(t){const i=t*this.arcLength,n=this._getTimeGivenDistance(i);return this.getPoint(n)}clone(){return new mo({controlPoints:[...this.controlPoints],quality:this.quality})}}class pg{constructor(t,i){var n;if(this.id=Vt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(nt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new mo({controlPoints:[N(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(n=i.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=t;const i=St(gs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class _g{constructor(t,i){var n;if(this.id=Vt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(nt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new mo({controlPoints:[N(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(n=i.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=t;const i=St(gs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class vo{constructor(t){this._entity=t,this._queue=new Wf(t)}getQueue(){return this._queue}update(t){this._queue.update(t)}clearActions(){this._queue.clearActions()}runAction(t){return t.reset(),this._queue.add(t),this}curveBy(t){return this._queue.add(new _g(this._entity,t)),this}curveTo(t){return this._queue.add(new pg(this._entity,t)),this}easeTo(...t){var i,n;let o=0,h=0,c=0,g=Gt.Linear;return t[0]instanceof k?(o=t[0].x,h=t[0].y,c=t[1],g=(i=t[2])!==null&&i!==void 0?i:g):(o=t[0],h=t[1],c=t[2],g=(n=t[3])!==null&&n!==void 0?n:g),this._queue.add(new hg(this._entity,o,h,c,g)),this}easeBy(...t){var i,n;let o=0,h=0,c=0,g=Gt.Linear;return t[0]instanceof k?(o=t[0].x,h=t[0].y,c=t[1],g=(i=t[2])!==null&&i!==void 0?i:g):(o=t[0],h=t[1],c=t[2],g=(n=t[3])!==null&&n!==void 0?n:g),this._queue.add(new lg(this._entity,o,h,c,g)),this}moveTo(t,i,n){let o=0,h=0,c=0;return t instanceof k?(o=t.x,h=t.y,c=+(i??0),this._queue.add(new Wl(this._entity,o,h,c))):typeof t=="number"&&typeof i=="number"&&typeof n=="number"?(o=t,h=i,c=n,this._queue.add(new Wl(this._entity,o,h,c))):Zf(t)&&this._queue.add(new Jf(this._entity,t)),this}moveBy(t,i,n){let o=0,h=0,c=0;return t instanceof k&&typeof i=="number"?(o=t.x,h=t.y,c=i,this._queue.add(new Vl(this._entity,o,h,c))):typeof t=="number"&&typeof i=="number"&&typeof n=="number"?(o=t,h=i,c=n,this._queue.add(new Vl(this._entity,o,h,c))):jf(t)&&this._queue.add(new Qf(this._entity,t)),this}rotateTo(t,i,n){return typeof t=="number"&&typeof i=="number"?this._queue.add(new $f(this._entity,t,i,n)):typeof t=="object"&&this._queue.add(new Kf(this._entity,t)),this}rotateBy(t,i,n){return typeof t=="object"?this._queue.add(new tg(this._entity,t)):this._queue.add(new eg(this._entity,t,i,n)),this}scaleTo(t,i,n,o){let h=1,c=1,g=0,_=0;return ig(t)?(this._queue.add(new sg(this._entity,t)),this):(t instanceof k&&i instanceof k&&(h=t.x,c=t.y,g=i.x,_=i.y),typeof t=="number"&&typeof i=="number"&&(h=t,c=i,g=n,_=o),this._queue.add(new ng(this._entity,h,c,g,_)),this)}scaleBy(t,i,n){if(rg(t))return this._queue.add(new og(this._entity,t)),this;let o=1,h=1;return t instanceof k&&(o=t.x,h=t.y,n=i),typeof t=="number"&&typeof i=="number"&&(o=t,h=i),this._queue.add(new ag(this._entity,o,h,n)),this}blink(t,i,n=1){return this._queue.add(new cg(this._entity,t,i,n)),this}fade(t,i){return this._queue.add(new dg(this._entity,t,i)),this}flash(t,i=1e3){return this._queue.add(new gg(this._entity,t,i)),this}delay(t){return this._queue.add(new ug(t)),this}die(){return this._queue.add(new fg(this._entity)),this}callMethod(t){return this._queue.add(new of(t)),this}repeat(t,i){return i?(this._queue.add(new Nf(this._entity,t,i)),this):(this.repeatForever(t),this)}repeatForever(t){return this._queue.add(new Gf(this._entity,t)),this}follow(t,i){return i===void 0?this._queue.add(new Nl(this._entity,t)):this._queue.add(new Nl(this._entity,t,i)),this}meet(t,i){return i===void 0?this._queue.add(new Gl(this._entity,t)):this._queue.add(new Gl(this._entity,t,i)),this}toPromise(){return new Promise(i=>{this._queue.add(new of(()=>{i()}))})}}class sr extends Di{constructor(){super(...arguments),this.dependencies=[nt,kt],this._ctx=null}onAdd(t){this._ctx=new vo(t)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(t){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(t)}update(t){var i;return(i=this._ctx)===null||i===void 0?void 0:i.update(t)}clearActions(){var t;(t=this._ctx)===null||t===void 0||t.clearActions()}curveBy(t){return this._getCtx().curveBy.apply(this._ctx,[t])}curveTo(t){return this._getCtx().curveTo.apply(this._ctx,[t])}easeTo(...t){return this._getCtx().easeTo.apply(this._ctx,t)}easeBy(...t){return this._getCtx().easeBy.apply(this._ctx,t)}moveTo(t,i,n){return this._getCtx().moveTo.apply(this._ctx,[t,i,n])}moveBy(t,i,n){return this._getCtx().moveBy.apply(this._ctx,[t,i,n])}rotateTo(t,i,n){return this._getCtx().rotateTo.apply(this._ctx,[t,i,n])}rotateBy(t,i,n){return this._getCtx().rotateBy.apply(this._ctx,[t,i,n])}scaleTo(t,i,n,o){return this._getCtx().scaleTo.apply(this._ctx,[t,i,n,o])}scaleBy(t,i,n){return this._getCtx().scaleBy.apply(this._ctx,[t,i,n])}blink(t,i,n){return this._getCtx().blink(t,i,n)}fade(t,i){return this._getCtx().fade(t,i)}flash(t,i=1e3){return this._getCtx().flash(t,i)}delay(t){return this._getCtx().delay(t)}die(){return this._getCtx().die()}callMethod(t){return this._getCtx().callMethod(t)}repeat(t,i){return this._getCtx().repeat(t,i)}repeatForever(t){return this._getCtx().repeatForever(t)}follow(t,i){return this._getCtx().follow(t,i)}meet(t,i){return this._getCtx().meet(t,i)}toPromise(){return this._getCtx().toPromise()}}function Qv(d){return d instanceof si}const Zv={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class si extends Qe{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(t){this.body.oldPos.setTo(t.x,t.y)}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t.clone()}get oldVel(){return this.body.oldVel}set oldVel(t){this.body.oldVel.setTo(t.x,t.y)}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t.clone()}set oldAcc(t){this.body.oldAcc.setTo(t.x,t.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(t){this.transform.rotation=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}get scale(){return this.get(nt).scale}set scale(t){this.get(nt).scale=t}get anchor(){return this._anchor}set anchor(t){this._anchor=Ni(t,i=>this._handleAnchorChange(i)),this._handleAnchorChange(t)}_handleAnchorChange(t){this.graphics&&(this.graphics.anchor=t)}get offset(){return this._offset}set offset(t){this._offset=Ni(t,i=>this._handleOffsetChange(i)),this._handleOffsetChange(t)}_handleOffsetChange(t){this.graphics&&(this.graphics.offset=t)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(t){t&&(t&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!t&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=t)}get color(){return this.graphics.color}set color(t){this.graphics.color=t}constructor(t){super(),this.events=new $t,this._anchor=Ni(k.Half,lt=>this._handleAnchorChange(lt)),this._offset=Ni(k.Zero,lt=>this._handleOffsetChange(lt)),this.logger=ut.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=lt=>{this._dragging&&(this.pos=lt.worldPos)},this._pointerDragLeaveHandler=lt=>{this._dragging&&(this.pos=lt.worldPos)};const{name:i,x:n,y:o,pos:h,coordPlane:c,scale:g,width:_,height:v,radius:x,collider:A,vel:S,acc:P,rotation:I,angularVelocity:F,z:R,color:E,visible:M,opacity:V,anchor:L,offset:G,collisionType:j,collisionGroup:X,silenceWarnings:rt}={...t};this.name=i??this.name,this.anchor=L??si.defaults.anchor.clone(),this.offset=G??k.Zero,this.transform=new nt,this.addComponent(this.transform),this.pos=h??N(n??0,o??0),this.rotation=I??0,this.scale=g??N(1,1),this.z=R??0,this.transform.coordPlane=c??ze.World,this._silenceWarnings=rt??!1,this.pointer=new sn,this.addComponent(this.pointer),this.graphics=new ce({anchor:this.anchor,offset:this.offset,opacity:V}),this.addComponent(this.graphics),this.motion=new kt,this.addComponent(this.motion),this.vel=S??k.Zero,this.acc=P??k.Zero,this.angularVelocity=F??0,this.actions=new sr,this.addComponent(this.actions),this.body=new Tt,this.addComponent(this.body),this.body.collisionType=j??gt.Passive,X&&(this.body.group=X),E&&(this.color=E),A?(this.collider=new Ae(A),this.addComponent(this.collider)):x?(this.collider=new Ae(Ye.Circle(x)),this.addComponent(this.collider),E&&this.graphics.add(new Ha({color:E,radius:x}))):_>0&&v>0?(this.collider=new Ae(Ye.Box(_,v,this.anchor)),this.addComponent(this.collider),E&&_&&v&&this.graphics.add(new po({color:E,width:_,height:v}))):(this.collider=new Ae,this.addComponent(this.collider)),this.graphics.isVisible=M??!0}clone(){const t=new si({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});t.clearComponents(),t.processComponentRemoval(),t.addComponent(t.transform=this.transform.clone(),!0),t.addComponent(t.pointer=this.pointer.clone(),!0),t.addComponent(t.graphics=this.graphics.clone(),!0),t.addComponent(t.motion=this.motion.clone(),!0),t.addComponent(t.actions=this.actions.clone(),!0),t.addComponent(t.body=this.body.clone(),!0),t.addComponent(t.collider=this.collider.clone(),!0);const i=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],n=this.getComponents();for(const o of n)i.includes(o)||t.addComponent(o.clone(),!0);return t}onInitialize(t){}_initialize(t){super._initialize(t);for(const i of this.children)i._initialize(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_prekill(t){this.events.emit("prekill",new uc(this)),this.onPreKill(t)}onPreKill(t){}_postkill(t){this.events.emit("postkill",new fc(this)),this.onPostKill(t)}onPostKill(t){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new ka(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(nt).z}set z(t){this.get(nt).z=t}get center(){const t=this.getGlobalPos();return new k(t.x+this.width/2-this.anchor.x*this.width,t.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new k(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(nt).globalRotation}get globalRotation(){return this.get(nt).globalRotation}getGlobalPos(){return this.get(nt).globalPos}get globalPos(){return this.get(nt).globalPos}getGlobalScale(){return this.get(nt).globalScale}get globalScale(){return this.get(nt).globalScale}get globalZ(){return this.get(nt).globalZ}contains(t,i,n=!1){const o=N(t,i),h=this.get(Ae);h.update();const c=h.get();if(!c)return!1;const g=c.contains(o);return n?g||this.children.some(_=>_.contains(t,i,!0)):g}within(t,i){const n=this.get(Ae),o=t.get(Ae),h=n.get(),c=o.get();return h&&c?h.getClosestLineBetween(c).getLength()<=i:!1}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i),this._postupdate(t,i),this._remove(t)}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreCollisionResolve(t,i,n,o){}onPostCollisionResolve(t,i,n,o){}onCollisionStart(t,i,n,o){}onCollisionEnd(t,i,n,o){}_preupdate(t,i){this.events.emit("preupdate",new nn(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new rn(t,i,this)),this.onPostUpdate(t,i)}}si.defaults={anchor:k.Half};function mg(d){return d instanceof Xc}class Xc extends si{constructor(t){var i,n;super({...t}),this.get(nt).coordPlane=ze.Screen,this.anchor=(i=t?.anchor)!==null&&i!==void 0?i:N(0,0),this.body.collisionType=(n=t?.collisionType)!==null&&n!==void 0?n:gt.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!t?.collider&&t?.width>0&&t?.height>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(t){this._engine=t,super._initialize(t)}contains(t,i,n=!0){if(n)return super.contains(t,i);const o=this._engine.worldToScreenCoordinates(new k(t,i));return super.contains(o.x,o.y)}}class Fn{get complete(){return this._complete}constructor(t){var i;this._logger=ut.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const n=(i=t.action)!==null&&i!==void 0?i:t.fcn,o=t.interval,h=t.repeats,c=t.numberOfRepeats,g=t.randomRange,_=t.random;if(c&&c>=0&&(this.maxNumberOfRepeats=c,!h))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=Fn._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=o,g){if(g[0]>g[1])throw new Error("min value must be lower than max value for range");this.random=_??new dr,this.randomRange=g,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=h||this.repeats,n&&this.on(n)}on(t){this._callbacks.push(t)}off(t){const i=this._callbacks.indexOf(t);this._callbacks.splice(i,1)}update(t){this._running&&(this._totalTimeAlive+=t,this._elapsedTime+=t,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(i=>{i.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(t,i){if(t&&t>=0&&(this._baseInterval=this.interval=t),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=i,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}Fn._MAX_ID=0;class Oa extends Di{constructor(t){super(),this.parallaxFactor=N(1,1),this.parallaxFactor=t??this.parallaxFactor}}class Va extends Di{constructor(t,i=!0){super(),this.draw=t,this.useTransform=i}}function af(d){return d&&d._dispatchPointerEvents&&d._processPointerToObject}class Jv{get events(){return this.object.events}init(t,i,n){this.object=t,this.contains=i,this.active=n}}class qc{constructor(){this._proxyPool=new ho(()=>new Jv,t=>t,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(t,i,n){const o=this._proxyPool.rent(!1);o.init(t,i,n),this._proxies.push(o),this._objectToProxy.set(t,o)}_getProxy(t){const i=this._objectToProxy.get(t);if(i)return i;throw new Error("No PointerTargetProxy for object")}removeObject(t){const i=this._objectToProxy.get(t);if(i){const n=this._proxies.indexOf(i);n>-1&&this._proxies.splice(n,1),this._proxyPool.return(i)}}_objectCurrentlyUnderPointer(t,i){return!!(this._currentFrameObjectToPointers.has(t)&&this._currentFrameObjectToPointers.get(t).includes(i))}_objectWasUnderPointer(t,i){return!!(this._lastFrameObjectToPointers.has(t)&&this._lastFrameObjectToPointers.get(t).includes(i))}_entered(t,i){return this._objectCurrentlyUnderPointer(t,i)&&!this._lastFrameObjectToPointers.has(t)}_left(t,i){return!this._currentFrameObjectToPointers.has(t)&&this._objectWasUnderPointer(t,i)}addPointerToObject(t,i){const n=this._objectToProxy.get(t);n&&this._addPointerToProxy(n,i)}_addPointerToProxy(t,i){if(!this._currentFrameObjectToPointers.has(t)){this._currentFrameObjectToPointers.set(t,[i]);return}const n=this._currentFrameObjectToPointers.get(t);this._currentFrameObjectToPointers.set(t,n.concat(i))}dispatchEvents(t,i){const n=new Set(this._lastFrameObjectToPointers.keys()),o=new Set(this._currentFrameObjectToPointers.keys());let h,c,g;for(let _=0;_<i.length;_++){const v=i[_],x=this._getProxy(v);if(af(v)&&v._dispatchPointerEvents(t),n.has(x)||o.has(x)){g=this._processDownAndEmit(t,x),c=this._processUpAndEmit(t,x),h=this._processMoveAndEmit(t,x);const A=[...h.values(),...g.values(),...c.values()];this._processEnterLeaveAndEmit(t,x,A),this._processCancelAndEmit(t,x),this._processWheelAndEmit(t,x)}}}processPointerToObject(t,i){for(let n=0;n<i.length;n++){const o=i[n],h=this._getProxy(o);af(o)&&o._processPointerToObject(t);for(const[c,g]of t.currentFramePointerCoords.entries())h.contains(g)&&this._addPointerToProxy(h,c)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(t,i){const n=new Map;for(const o of t.currentFrameDown)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerdown",o),t.isDragStart(o.pointerId)&&i.events.emit("pointerdragstart",o)),n.set(o.pointerId,o);return n}_processUpAndEmit(t,i){const n=new Map;for(const o of t.currentFrameUp)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerup",o),t.isDragEnd(o.pointerId)&&i.events.emit("pointerdragend",o)),n.set(o.pointerId,o);return n}_processMoveAndEmit(t,i){const n=new Map;for(const o of t.currentFrameMove)o.active&&i.active()&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointermove",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragmove",o)),n.set(o.pointerId,o);return n}_processEnterLeaveAndEmit(t,i,n){for(const o of n){if(o.active&&i.active()&&this._entered(i,o.pointerId)){i.events.emit("pointerenter",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragenter",o);break}if(o.active&&i.active()&&(this._left(i,o.pointerId)||this._objectCurrentlyUnderPointer(i,o.pointerId)&&o.type==="up")){i.events.emit("pointerleave",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragleave",o);break}}}_processCancelAndEmit(t,i){for(const n of t.currentFrameCancel)n.active&&i.active()&&this._objectCurrentlyUnderPointer(i,n.pointerId)&&i.events.emit("pointercancel",n)}_processWheelAndEmit(t,i){for(const n of t.currentFrameWheel)n.active&&i.active()&&this._objectCurrentlyUnderPointer(i,0)&&i.events.emit("pointerwheel",n)}}const Kv={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class vg extends Qe{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let t=0;t<this.tiles.length;t++)this.tiles[t]&&this.tiles[t].flagDirty()}get x(){var t;return(t=this.transform.pos.x)!==null&&t!==void 0?t:0}set x(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.get(nt).pos=N(t,this.y))}get y(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.pos.y)!==null&&i!==void 0?i:0}set y(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.transform.pos=N(this.x,t))}get z(){var t;return(t=this.transform.z)!==null&&t!==void 0?t:0}set z(t){this.transform&&(this.transform.z=t)}get rotation(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.rotation)!==null&&i!==void 0?i:0}set rotation(t){this.transform&&(this.transform.rotation=t)}get scale(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.scale)!==null&&i!==void 0?i:k.One}set scale(t){var i;!((i=this.transform)===null||i===void 0)&&i.scale&&(this.transform.scale=t)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get vel(){return this._motion.vel}set vel(t){this._motion.vel=t}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,n,o;super([],t.name),this.events=new $t,this._token=0,this.logger=ut.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(i=t.meshingLookBehind)!==null&&i!==void 0?i:this.meshingLookBehind,this.addComponent(new nt),this.addComponent(new kt),this.addComponent(new Tt({type:gt.Fixed})),this.addComponent(new ce({onPostDraw:(c,g)=>this.draw(c,g)})),this.addComponent(new Va((c,g)=>this.debug(c,g),!1)),this.addComponent(new Ae),this.addComponent(new sn),this.pointer=this.get(sn),this._graphics=this.get(ce),this.transform=this.get(nt),this._motion=this.get(kt),this.collider=this.get(Ae),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(n=t.pos)!==null&&n!==void 0?n:k.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(o=t.renderFromTopOfGraphic)!==null&&o!==void 0?o:this.renderFromTopOfGraphic,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight,this.rows=t.rows,this.columns=t.columns,this._pointerEventDispatcher=new qc,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let h=[];for(let c=0;c<this.columns;c++){for(let g=0;g<this.rows;g++){const _=new wg({x:c,y:g,map:this});_.map=this,this.tiles[c+g*this.columns]=_,this._pointerEventDispatcher.addObject(_,v=>_.bounds.contains(v.worldPos),()=>!0),h.push(_),this._rows[g]||(this._rows[g]=[]),this._rows[g].push(_)}this._cols[c]=h,h=[]}this._graphics.localBounds=new ct({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(t){super._initialize(t),this._engine=t}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:k.Zero;{const n=t.offset;return this._originalOffsets.set(t,n),n}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const t=[];this._composite=this.collider.useCompositeCollider([]);let i=null;const n=(h,c)=>h&&c?h.top===c.top&&h.bottom===c.bottom&&h.right===c.left:!1,o=(h,c,g=this.meshingLookBehind)=>{if(!h)return!1;for(let _=c.length-1;_>=0;_--){if(g--<0)return!1;const v=c[_];if(n(v,h))return c[_]=v.combine(h),!0}return!1};for(let h=0;h<this.columns;h++){for(let c=0;c<this.rows;c++){const g=this.tiles[h+c*this.columns];if(g.solid)if(g.getColliders().length>0){for(const _ of g.getColliders()){const v=this._getOrSetColliderOriginalOffset(_);_.offset=N(g.x*this.tileWidth*this.scale.x,g.y*this.tileHeight*this.scale.y).add(v),_.owner=this,this._composite.addCollider(_)}i&&!o(i,t)&&t.push(i),i=null}else i?i=i.combine(g.defaultGeometry):i=g.defaultGeometry;else i&&!o(i,t)&&t.push(i),i=null}i&&!o(i,t)&&t.push(i),i=null}for(const h of t){const c=Ye.Box(h.width,h.height,k.Zero,N(h.left-this.pos.x,h.top-this.pos.y));c.owner=this,this._composite.addCollider(c)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(t){var i;return(i=this.tiles[t])!==null&&i!==void 0?i:null}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const{x:i,y:n}=this._getTileCoordinates(t),o=this.getTile(i,n);return i>=0&&n>=0&&i<this.columns&&n<this.rows&&o?o:null}_getTileCoordinates(t){t=this.transform.applyInverse(t);const i=Math.floor(t.x/this.tileWidth),n=Math.floor(t.y/this.tileHeight);return{x:i,y:n}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let t=this._engine.screen.getWorldBounds();const i=this.get(Oa);if(i&&this.isInitialized){let P=this.pos;const I=k.One.sub(i.parallaxFactor),F=this._engine.currentScene.camera.pos.scale(I);P=P.sub(F),t=t.translate(P)}const n=this.transform.coordPlane===ze.Screen?this._engine.screen.getScreenBounds():t,o=this._getTileCoordinates(n.topLeft),h=this._getTileCoordinates(n.topRight),c=this._getTileCoordinates(n.bottomRight),g=this._getTileCoordinates(n.bottomLeft),_=Math.min(St(o.x,0,this.columns-1),St(h.x,0,this.columns-1)),v=Math.min(St(o.y,0,this.rows-1),St(h.y,0,this.rows-1)),x=Math.max(St(c.x,0,this.columns-1),St(g.x,0,this.columns-1)),A=Math.max(St(c.y,0,this.rows-1),St(g.y,0,this.rows-1)),S=[];for(let P=_;P<=x;P++)for(let I=v;I<=A;I++)S.push(this.getTile(P,I));return S}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(t,i){this._initialize(t),this.onPreUpdate(t,i),this.emit("preupdate",new nn(t,i,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(t,i),this.emit("postupdate",new rn(t,i,this))}draw(t,i){if(!this.isInitialized)return;this.emit("predraw",new pr(t,i,this));let n,o,h;const c=this.getOnScreenTiles();for(let g=0;g<c.length;g++){const _=c[g],v=_.getGraphicsOffsets();for(n=_.getGraphics(),o=0,h=n.length;o<h;o++){const x=n[o],A=v[o];if(x){dc(x)&&x?.tick(i,this._token);const S=this.renderFromTopOfGraphic?0:x.height-this.tileHeight;x.draw(t,_.x*this.tileWidth+A.x,_.y*this.tileHeight-S+A.y)}}}this.emit("postdraw",new _r(t,i,this))}debug(t,i){const{showAll:n,showGrid:o,gridColor:h,gridWidth:c,showSolidBounds:g,solidBoundsColor:_,showColliderGeometry:v}=i.tilemap,{geometryColor:x,geometryLineWidth:A,geometryPointSize:S}=i.collider,P=this.tileWidth*this.columns*this.scale.x,I=this.tileHeight*this.rows*this.scale.y,F=this.pos;if(o||n){for(let R=0;R<this.rows+1;R++){const E=N(0,R*this.tileHeight*this.scale.y);t.drawLine(F.add(E),F.add(N(P,E.y)),h,c)}for(let R=0;R<this.columns+1;R++){const E=N(R*this.tileWidth*this.scale.x,0);t.drawLine(F.add(E),F.add(N(E.x,I)),h,c)}}if(n||g||v){const R=this._composite.getColliders();t.save(),t.translate(this.pos.x,this.pos.y),t.scale(this.scale.x,this.scale.y);for(const E of R){const M=E.localBounds,V=E.worldPos.sub(this.pos);g&&t.drawRectangle(V,M.width,M.height,_)}if(t.restore(),v)for(const E of R)E.debug(t,x,{lineWidth:A,pointSize:S})}if(n||g){if(t.save(),t.z=999,g)for(let R=0;R<this.tiles.length;R++)this.tiles[R].bounds.draw(t);t.restore()}}}class wg{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(t){var i;(i=this.map)===null||i===void 0||i.flagCollidersDirty(),this._solid=t}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(t,i){this._graphics.push(t),i?.offset?this._offsets.push(i.offset):this._offsets.push(k.Zero)}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&(this._graphics.splice(i,1),this._offsets.splice(i,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(t){var i,n;this._posDirty=!1,this.events=new $t,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=t.x,this.y=t.y,this.map=t.map,this._width=t.map.tileWidth*this.map.scale.x,this._height=t.map.tileHeight*this.map.scale.y,this.solid=(i=t.solid)!==null&&i!==void 0?i:this.solid,this._graphics=(n=t.graphics)!==null&&n!==void 0?n:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const t=this.map.pos.add(N(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new ct(t.x,t.y,t.x+this.map.tileWidth,t.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(N(this.x*this._width,this.y*this._height)),this._bounds=new ct(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new k(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}class xg{constructor(t){this.camera=t}lockToActor(t){this.camera.addStrategy(new Ag(t))}lockToActorAxis(t,i){this.camera.addStrategy(new bg(t,i))}elasticToActor(t,i,n){this.camera.addStrategy(new yg(t,i,n))}radiusAroundActor(t,i){this.camera.addStrategy(new Cg(t,i))}limitCameraBounds(t){this.camera.addStrategy(new Sg(t))}}var Ea;(function(d){d[d.X=0]="X",d[d.Y=1]="Y"})(Ea||(Ea={}));class Ag{constructor(t){this.target=t,this.action=(i,n,o,h)=>i.center}}class bg{constructor(t,i){this.target=t,this.axis=i,this.action=(n,o,h,c)=>{const g=n.center,_=o.getFocus();return this.axis===Ea.X?new k(g.x,_.y):new k(_.x,g.y)}}}class yg{constructor(t,i,n){this.target=t,this.cameraElasticity=i,this.cameraFriction=n,this.action=(o,h,c,g)=>{const _=o.center;let v=h.getFocus(),x=h.vel.clone();const A=_.sub(v).scale(this.cameraElasticity);x=x.add(A);const S=x.scale(-1).scale(this.cameraFriction);return x=x.add(S),v=v.add(x),v}}}class Cg{constructor(t,i){this.target=t,this.radius=i,this.action=(n,o,h,c)=>{const g=n.center,_=o.getFocus(),v=g.sub(_),x=v.magnitude;if(x>=this.radius){const A=x-this.radius;return _.add(v.normalize().scale(A))}return _}}}class Sg{constructor(t){this.target=t,this.boundSizeChecked=!1,this.action=(i,n,o,h)=>{const c=n.getFocus();this.boundSizeChecked||((i.bottom-i.top<o.drawHeight||i.right-i.left<o.drawWidth)&&ut.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let g=c.x,_=c.y;return c.x<i.left+o.halfDrawWidth?g=i.left+o.halfDrawWidth:c.x>i.right-o.halfDrawWidth&&(g=i.right-o.halfDrawWidth),c.y<i.top+o.halfDrawHeight?_=i.top+o.halfDrawHeight:c.y>i.bottom-o.halfDrawHeight&&(_=i.bottom-o.halfDrawHeight),N(g,_)}}}const $v={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class Pg{constructor(){this.events=new $t,this.transform=xe.identity(),this.inverse=xe.identity(),this._cameraStrategies=[],this.strategy=new xg(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new $s(k.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=k.Zero,this.acc=k.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Gt.EaseInOutCubic,this._easing=Gt.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=N(0,0)}get zoom(){return this._z}set zoom(t){this._z=t,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(t){this._angularVelocity=t}get pos(){return this._pos}set pos(t){this._posChanged=!0,this._pos=new $s(t,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(t){!this._follow&&!this._cameraMoving&&(this.pos=N(t,this.pos.y))}get y(){return this.pos.y}set y(t){!this._follow&&!this._cameraMoving&&(this.pos=N(this.pos.x,t))}get dx(){return this.vel.x}set dx(t){this.vel=N(t,this.vel.y)}get dy(){return this.vel.y}set dy(t){this.vel=N(this.vel.x,t)}get ax(){return this.acc.x}set ax(t){this.acc=N(t,this.acc.y)}get ay(){return this.acc.y}set ay(t){this.acc=N(this.acc.x,t)}getFocus(){return this.pos}move(t,i,n=Gt.EaseInOutCubic){if(typeof n!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(t):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(t),this._lerpPromise=new Promise(o=>{this._lerpResolve=o}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=i,this._lerpEnd=t,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=n,this._lerpPromise)}shake(t,i,n){this._isShaking=!0,this._shakeMagnitudeX=t,this._shakeMagnitudeY=i,this._shakeDuration=n}zoomOverTime(t,i=0,n=Gt.EaseInOutCubic){if(this._zoomPromise=new Promise(o=>{this._zoomResolve=o}),i)this._isZooming=!0,this._zoomEasing=n,this._currentZoomTime=0,this._zoomDuration=i,this._zoomStart=this.zoom,this._zoomEnd=t;else return this._isZooming=!1,this.zoom=t,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new ct(0,0,0,0)}addStrategy(t){this._cameraStrategies.push(t)}removeStrategy(t){ur(t,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(t,i){this.events.emit("preupdate",new nn(t,i,this)),this.onPreUpdate(t,i)}onPreUpdate(t,i){}_postupdate(t,i){this.events.emit("postupdate",new rn(t,i,this)),this.onPostUpdate(t,i)}onPostUpdate(t,i){}get isInitialized(){return this._isInitialized}_initialize(t){if(!this.isInitialized){this._engine=t,this._screen=t.screen;const i=this._screen.contentArea;let n=N(i.width/2,i.height/2);if(!this._engine.loadingComplete){const o=this._screen.peekResolution();o&&(n=N(o.width/2,o.height/2))}this._halfWidth=n.x,this._halfHeight=n.y,this._posChanged||(this.pos=n),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(t,t.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(t),this.events.emit("initialize",new mr(t,this)),this._isInitialized=!0}}onInitialize(t){}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}runStrategies(t,i){for(const n of this._cameraStrategies)this.pos=n.action.call(n,n.target,this,t,i)}updateViewport(){this._viewport=new ct(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(t,i){if(this._initialize(t),this._preupdate(t,i),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(i/1e3)),this.zoom+=this.dz*i/1e3,this.vel=this.vel.add(this.acc.scale(i/1e3)),this.dz+=this.az*i/1e3,this.rotation+=this.angularVelocity*i/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const n=this._zoomEasing,o=n(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=o,this._currentZoomTime+=i}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const o=Gt.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=o,this._currentLerpTime+=i}else{this.pos=this._lerpEnd;const n=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(n)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=i,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(t,i),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(t,i),this._posChanged=!1}draw(t){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const i=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,n=this.pos.scale(i).add(this._oldPos.scale(1-i));n.clone(this.drawPos),this.updateTransform(n)}if(t.snapToPixel){const i=this.drawPos.clone(this._snapPos);i.x=~~(i.x+vt*Xt(i.x)),i.y=~~(i.y+vt*Xt(i.y)),i.clone(this.drawPos),this.updateTransform(i)}t.multiply(this.transform)}updateTransform(t){const i=this._screen.resolution.width/this.zoom,n=this._screen.resolution.height/this.zoom,o=N(-t.x+i/2+this._xShake,-t.y+n/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(i/2,n/2),this.transform.rotate(this.rotation),this.transform.translate(-i/2,-n/2),this.transform.translate(o.x,o.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const tw={ExitTrigger:"exit",EnterTrigger:"enter"};class Eg extends si{constructor(t){var i,n,o,h;super({...t}),this.events=new $t,this.filter=(i=t.filter)!==null&&i!==void 0?i:()=>!0,this.repeat=(n=t.repeat)!==null&&n!==void 0?n:-1,this.action=(o=t.action)!==null&&o!==void 0?o:()=>{},this.target=t.target,this.graphics.isVisible=(h=t.visible)!==null&&h!==void 0?h:!1,this.body.collisionType=gt.Passive,this.events.on("collisionstart",({other:c})=>{this._matchesTarget(c.owner)&&(this.events.emit("enter",new Fc(this,c.owner)),this._dispatchAction(c.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:c})=>{this._matchesTarget(c.owner)&&this.events.emit("exit",new Mc(this,c.owner))})}_matchesTarget(t){return this.filter(t)&&(this.target===void 0||this.target===t)}_dispatchAction(t){this.repeat!==0&&(this.action.call(this,t),this.repeat--)}}const ps={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var bi;(function(d){d.Update="update",d.Draw="draw"})(bi||(bi={}));class Ei{}Ei.priority=ps.Average;class Tg{constructor(t){this._world=t,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>i=>{this.addEntity(i)},this._createChildRemovedHandler=()=>i=>{this.removeEntity(i,!1)},this._entitiesToRemove=[]}updateEntities(t,i){for(let n=0;n<this.entities.length;n++){const o=this.entities[n];o.update(t.engine,i),o.isActive||this.removeEntity(o)}}findEntitiesForRemoval(){for(let t=0;t<this.entities.length;t++){const i=this.entities[t];i.isActive||this.removeEntity(i)}}addEntity(t){if(t.isActive=!0,t.scene=this._world.scene,t&&!this._entityIndex[t.id]){this._entityIndex[t.id]=t,this.entities.push(t),this._world.queryManager.addEntity(t),t.children.forEach(o=>{o.scene=t.scene,this.addEntity(o)});const i=this._createChildAddedHandler();this._childAddedHandlerMap.set(t,i);const n=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(t,n),t.childrenAdded$.subscribe(i),t.childrenRemoved$.subscribe(n)}}removeEntity(t,i=!0){var n,o;let h=0;t instanceof Qe?h=t.id:h=t;const c=this._entityIndex[h];if(c&&c.isActive&&(c.isActive=!1),c&&i){this._entitiesToRemove.push(c);return}if(delete this._entityIndex[h],c){c.scene=null,ur(c,this.entities),this._world.queryManager.removeEntity(c),c.children.forEach(v=>{v.scene=null,this.removeEntity(v,i)});const g=this._childAddedHandlerMap.get(c);g&&c.childrenAdded$.unsubscribe(g);const _=this._childRemovedHandlerMap.get(c);_&&c.childrenRemoved$.unsubscribe(_),!((o=(n=this._world)===null||n===void 0?void 0:n.scene)===null||o===void 0)&&o.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let t=0;t<this._entitiesToRemove.length;t++){const i=this._entitiesToRemove[t];i.isActive||this.removeEntity(i,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let t=0;t<this.entities.length;t++)this.entities[t].processComponentRemoval()}getById(t){return this._entityIndex[t]}getByName(t){return this.entities.filter(i=>i.name===t)}clear(){for(let t=this.entities.length-1;t>=0;t--)this.removeEntity(this.entities[t])}}class eo{constructor(t){if(this.requiredComponents=t,this.components=new Set,this.entities=[],this.entityAdded$=new ei,this.entityRemoved$=new ei,t.length===0)throw new Error("Cannot create query without components");for(const i of t)this.components.add(i);this.id=eo.createId(t)}static createId(t){return t.slice().map(i=>i.name).sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAll(Array.from(this.components))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class io{constructor(t){if(this.requiredTags=t,this.tags=new Set,this.entities=[],this.entityAdded$=new ei,this.entityRemoved$=new ei,t.length===0)throw new Error("Cannot create tag query without tags");for(const i of t)this.tags.add(i);this.id=io.createId(t)}static createId(t){return t.slice().sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAllTags(Array.from(this.tags))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class Ig{constructor(t){this._world=t,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=i=>n=>{this.addComponent(i,n)},this._createRemoveComponentHandler=i=>n=>{this.removeComponent(i,n)},this._createAddTagHandler=i=>n=>{this.addTag(i,n)},this._createRemoveTagHandler=i=>n=>{this.removeTag(i,n)}}createQuery(t){const i=eo.createId(t);if(this._queries.has(i))return this._queries.get(i);const n=new eo(t);this._queries.set(n.id,n);for(const o of t){const h=this._componentToQueriesIndex.get(o);h?h.push(n):this._componentToQueriesIndex.set(o,[n])}for(const o of this._world.entities)this.addEntity(o);return n}createTagQuery(t){const i=io.createId(t);if(this._tagQueries.has(i))return this._tagQueries.get(i);const n=new io(t);this._tagQueries.set(n.id,n);for(const o of t){const h=this._tagToQueriesIndex.get(o);h?h.push(n):this._tagToQueriesIndex.set(o,[n])}for(const o of this._world.entities)this.addEntity(o);return n}addEntity(t){const i=this._addComponentHandlers.get(t),n=this._removeComponentHandlers.get(t),o=i??this._createAddComponentHandler(t),h=n??this._createRemoveComponentHandler(t);this._addComponentHandlers.set(t,o),this._removeComponentHandlers.set(t,h);const c=this._addTagHandlers.get(t),g=this._removeTagHandlers.get(t),_=c??this._createAddTagHandler(t),v=g??this._createRemoveTagHandler(t);this._addTagHandlers.set(t,_),this._removeTagHandlers.set(t,v);for(const x of this._queries.values())x.checkAndAdd(t);for(const x of this._tagQueries.values())x.checkAndAdd(t);t.componentAdded$.subscribe(o),t.componentRemoved$.subscribe(h),t.tagAdded$.subscribe(_),t.tagRemoved$.subscribe(v)}removeEntity(t){const i=this._addComponentHandlers.get(t),n=this._removeComponentHandlers.get(t);for(const c of this._queries.values())c.removeEntity(t);i&&t.componentAdded$.unsubscribe(i),n&&t.componentRemoved$.unsubscribe(n);const o=this._addTagHandlers.get(t),h=this._removeTagHandlers.get(t);for(const c of this._tagQueries.values())c.removeEntity(t);o&&t.tagAdded$.unsubscribe(o),h&&t.tagRemoved$.unsubscribe(h)}addComponent(t,i){var n;const o=(n=this._componentToQueriesIndex.get(i.constructor))!==null&&n!==void 0?n:[];for(const h of o)h.checkAndAdd(t)}removeComponent(t,i){var n;const o=(n=this._componentToQueriesIndex.get(i.constructor))!==null&&n!==void 0?n:[];for(const h of o)h.removeEntity(t)}addTag(t,i){var n;const o=(n=this._tagToQueriesIndex.get(i))!==null&&n!==void 0?n:[];for(const h of o)h.checkAndAdd(t)}removeTag(t,i){var n;const o=(n=this._tagToQueriesIndex.get(i))!==null&&n!==void 0?n:[];for(const h of o)h.removeEntity(t)}}function Rg(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class Dg{constructor(t){this._world=t,this.systems=[],this.initialized=!1}get(t){return this.systems.find(i=>i instanceof t)}addSystem(t){let i;t instanceof Ei?i=t:i=new t(this._world),this.systems.push(i),this.systems.sort((n,o)=>n.constructor.priority-o.constructor.priority),this.initialized&&i.initialize&&i.initialize(this._world,this._world.scene)}removeSystem(t){ur(t,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const t of this.systems)t.initialize&&t.initialize(this._world,this._world.scene)}}updateSystems(t,i,n){const o=this.systems.filter(h=>h.systemType===t);for(const h of o)h.preupdate&&h.preupdate(i,n);for(const h of o)h.update(n);for(const h of o)h.postupdate&&h.postupdate(i,n)}clear(){for(let t=this.systems.length-1;t>=0;t--)this.removeSystem(this.systems[t])}}class Fg{constructor(t){this.scene=t,this._logger=ut.getInstance(),this.queryManager=new Ig(this),this.entityManager=new Tg(this),this.systemManager=new Dg(this)}query(t){return this.queryManager.createQuery(t)}queryTags(t){return this.queryManager.createTagQuery(t)}update(t,i){t===bi.Update&&this.entityManager.updateEntities(this.scene,i),this.systemManager.updateSystems(t,this.scene,i),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(t){if(t instanceof Qe){this.entityManager.addEntity(t);return}if(t instanceof Ei||Rg(t)){this.systemManager.addSystem(t);return}this._logger.warn(`Could not add entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(t){return this.systemManager.get(t)}remove(t,i=!0){if(t instanceof Qe){this.entityManager.removeEntity(t,i);return}if(t instanceof Ei){this.systemManager.removeSystem(t);return}this._logger.warn(`Could not remove entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class Wa extends Ei{constructor(t,i){super(),this.world=t,this.physics=i,this.systemType=bi.Update,this._physicsConfigDirty=!1,i.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([nt,kt])}update(t){let i,n;const o=this.query.entities,h=this.physics.config.substep;for(let c=0;c<o.length;c++){i=o[c].get(nt),n=o[c].get(kt);const g=o[c].get(Tt);if(this._physicsConfigDirty&&g&&g.updatePhysicsConfig(this.physics.config.bodies),g?.isSleeping)continue;const _=n.acc.clone();g?.collisionType===gt.Active&&g?.useGravity&&_.addEqual(this.physics.config.gravity),o[c].parent||this.captureOldTransformWithChildren(o[c]),ti.integrate(i,n,_,t/h)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(t){var i;(i=t.get(Tt))===null||i===void 0||i.captureOldTransform();for(let n=0;n<t.children.length;n++)this.captureOldTransformWithChildren(t.children[n])}}Wa.priority=ps.Higher;class Xl{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map}solve(t){this.preSolve(t),t=t.filter(n=>!n.isCanceled());let i;switch(this.config.contactSolveBias){case zs.HorizontalFirst:{i=Wc;break}case zs.VerticalFirst:{i=Vc;break}default:i=Nc}t.sort((n,o)=>{const h=this.directionMap.get(n.id),c=this.directionMap.get(o.id),g=this.distanceMap.get(n.id),_=this.distanceMap.get(o.id);return i[h]-i[c]||g-_});for(const n of t)this.solvePosition(n),this.solveVelocity(n);return this.postSolve(t),t}preSolve(t){for(let n=0;n<t.length;n++){const o=t[n];if(Math.abs(o.mtv.x)<1e-4&&Math.abs(o.mtv.y)<1e-4){o.cancel();continue}const h=Ot.fromDirection(o.mtv),c=o.mtv.negate(),g=Math.abs(o.info.separation);this.distanceMap.set(o.id,g),this.directionMap.set(o.id,h===Ot.Left||h===Ot.Right?"horizontal":"vertical"),o.colliderA.events.emit("precollision",new Un(o.colliderA,o.colliderB,h,c,o)),o.colliderB.events.emit("precollision",new Un(o.colliderB,o.colliderA,Ot.getOpposite(h),c.negate(),o))}}postSolve(t){var i,n;for(let o=0;o<t.length;o++){const h=t[o];if(h.isCanceled())continue;const c=h.colliderA,g=h.colliderB,_=(i=c.owner)===null||i===void 0?void 0:i.get(Tt),v=(n=g.owner)===null||n===void 0?void 0:n.get(Tt);if(_&&v&&(_.collisionType===gt.Passive||v.collisionType===gt.Passive))continue;const x=Ot.fromDirection(h.mtv),A=h.mtv.negate();h.colliderA.events.emit("postcollision",new zn(h.colliderA,h.colliderB,x,A,h)),h.colliderB.events.emit("postcollision",new zn(h.colliderB,h.colliderA,Ot.getOpposite(x),A.negate(),h))}}solvePosition(t){var i,n;if(!t.colliderA.bounds.overlaps(t.colliderB.bounds,1e-4)){t.cancel();return}if(Math.abs(t.mtv.x)<1e-4&&Math.abs(t.mtv.y)<1e-4){t.cancel();return}let h=t.mtv;const c=t.colliderA,g=t.colliderB,_=(i=c.owner)===null||i===void 0?void 0:i.get(Tt),v=(n=g.owner)===null||n===void 0?void 0:n.get(Tt);if(_&&v){if(_.collisionType===gt.Passive||v.collisionType===gt.Passive)return;_.collisionType===gt.Active&&v.collisionType===gt.Active&&(h=h.scale(.5)),_.collisionType===gt.Active&&(_.globalPos.x-=h.x,_.globalPos.y-=h.y,c.update(_.transform.get())),v.collisionType===gt.Active&&(v.globalPos.x+=h.x,v.globalPos.y+=h.y,g.update(v.transform.get()))}}solveVelocity(t){var i,n;if(t.isCanceled())return;const o=t.colliderA,h=t.colliderB,c=(i=o.owner)===null||i===void 0?void 0:i.get(Tt),g=(n=h.owner)===null||n===void 0?void 0:n.get(Tt);if(c&&g){if(c.collisionType===gt.Passive||g.collisionType===gt.Passive)return;const _=t.normal,v=_.negate();if(c.collisionType===gt.Active&&c.vel.normalize().dot(v)<0){const x=_.scale(_.dot(c.vel.negate()));c.vel=c.vel.add(x)}if(g.collisionType===gt.Active&&g.vel.normalize().dot(_)<0){const x=v.scale(v.dot(g.vel.negate()));g.vel=g.vel.add(x)}}}}class Mg{constructor(t,i,n){this.point=t,this.local=i,this.contact=n,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new k(0,0),this.bToContact=new k(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const t=this.contact.bodyA,i=this.contact.colliderA,n=this.contact.bodyB,o=this.contact.colliderB;if(t&&n){const h=this.contact.normal,c=this.contact.tangent;this.aToContact=this.point.sub(i.center),this.bToContact=this.point.sub(o.center);const g=this.aToContact.cross(h),_=this.bToContact.cross(h);this.normalMass=t.inverseMass+n.inverseMass+t.inverseInertia*g*g+n.inverseInertia*_*_;const v=this.aToContact.cross(c),x=this.bToContact.cross(c);this.tangentMass=t.inverseMass+n.inverseMass+t.inverseInertia*v*v+n.inverseInertia*x*x}return this}getRelativeVelocity(){const t=this.contact.bodyA,i=this.contact.bodyB;if(t&&i){const n=t.vel.add(k.cross(t.angularVelocity,this.aToContact));return i.vel.add(k.cross(i.angularVelocity,this.bToContact)).sub(n)}return k.Zero}}class ql{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(t){var i;return(i=this.idToContactConstraint.get(t))!==null&&i!==void 0?i:[]}solve(t){this.preSolve(t),t=t.filter(n=>!n.isCanceled());let i;switch(this.config.contactSolveBias){case zs.HorizontalFirst:{i=Wc;break}case zs.VerticalFirst:{i=Vc;break}default:i=Nc}return t.sort((n,o)=>{const h=this.directionMap.get(n.id),c=this.directionMap.get(o.id),g=this.distanceMap.get(n.id),_=this.distanceMap.get(o.id);return i[h]-i[c]||g-_}),this.solveVelocity(t),this.solvePosition(t),this.postSolve(t),t}preSolve(t){var i,n,o,h;for(let _=0;_<t.length;_++){const v=t[_];if(Math.abs(v.mtv.x)<1e-4&&Math.abs(v.mtv.y)<1e-4){v.cancel();continue}const x=Ot.fromDirection(v.mtv),A=Math.abs(((i=v?.info)===null||i===void 0?void 0:i.separation)||0);this.distanceMap.set(v.id,A),this.directionMap.set(v.id,x===Ot.Left||x===Ot.Right?"horizontal":"vertical"),v.colliderA.events.emit("precollision",new Un(v.colliderA,v.colliderB,x,v.mtv,v)),v.colliderA.events.emit("beforecollisionresolve",new ya(v.colliderA,v.colliderB,x,v.mtv,v)),v.colliderB.events.emit("precollision",new Un(v.colliderB,v.colliderA,Ot.getOpposite(x),v.mtv.negate(),v)),v.colliderB.events.emit("beforecollisionresolve",new ya(v.colliderB,v.colliderA,Ot.getOpposite(x),v.mtv.negate(),v)),v.matchAwake()}const g=Array.from(this.idToContactConstraint.keys());for(let _=0;_<t.length;_++){const v=t[_],x=g.indexOf(v.id);x>-1&&g.splice(x,1);const A=(n=this.idToContactConstraint.get(v.id))!==null&&n!==void 0?n:[];let S=0;const P=v.bodyA,I=v.colliderA,F=v.bodyB,R=v.colliderB;if(P&&F)for(let E=0;E<v.points.length;E++){const M=v.points[E],V=v.normal,L=v.tangent,G=M.sub(I.center),j=M.sub(R.center),X=G.cross(V),rt=j.cross(V),lt=P.inverseMass+F.inverseMass+P.inverseInertia*X*X+F.inverseInertia*rt*rt,yt=G.cross(L),wt=j.cross(L),Pt=P.inverseMass+F.inverseMass+P.inverseInertia*yt*yt+F.inverseInertia*wt*wt;A[S]&&((h=(o=A[S])===null||o===void 0?void 0:o.point)===null||h===void 0?void 0:h.squareDistance(M))<4?(A[S].point=M,A[S].local=v.localPoints[S]):A[S]=new Mg(M,v.localPoints[S],v),A[S].aToContact=G,A[S].bToContact=j,A[S].normalMass=1/lt,A[S].tangentMass=1/Pt;const Dt=P.bounciness>F.bounciness?P.bounciness:F.bounciness,B=v.normal.dot(A[S].getRelativeVelocity());A[S].originalVelocityAndRestitution=0,B<-.1&&(A[S].originalVelocityAndRestitution=-Dt*B),S++}this.idToContactConstraint.set(v.id,A)}for(const _ of g)this.idToContactConstraint.delete(_);if(this.config.warmStart)this.warmStart(t);else for(let _=0;_<t.length;_++){const v=t[_],x=this.getContactConstraints(v.id);for(const A of x)A.normalImpulse=0,A.tangentImpulse=0}}postSolve(t){for(let i=0;i<t.length;i++){const n=t[i],o=n.bodyA,h=n.bodyB;if(o&&h){if(o.collisionType===gt.Passive||h.collisionType===gt.Passive)continue;o.updateMotion(),h.updateMotion()}const c=Ot.fromDirection(n.mtv);n.colliderA.events.emit("postcollision",new zn(n.colliderA,n.colliderB,c,n.mtv,n)),n.colliderA.events.emit("aftercollisionresolve",new Ca(n.colliderA,n.colliderB,c,n.mtv,n)),n.colliderB.events.emit("postcollision",new zn(n.colliderB,n.colliderA,Ot.getOpposite(c),n.mtv.negate(),n)),n.colliderB.events.emit("aftercollisionresolve",new Ca(n.colliderB,n.colliderA,Ot.getOpposite(c),n.mtv.negate(),n))}this.lastFrameContacts.clear();for(let i=0;i<t.length;i++){const n=t[i];this.lastFrameContacts.set(n.id,n)}}warmStart(t){var i;for(let n=0;n<t.length;n++){const o=t[n],h=o.bodyA,c=o.bodyB;if(h&&c){const g=(i=this.idToContactConstraint.get(o.id))!==null&&i!==void 0?i:[];for(const _ of g)if(this.config.warmStart){const v=o.normal.scale(_.normalImpulse),x=o.tangent.scale(_.tangentImpulse),A=v.add(x);h.applyImpulse(_.point,A.negate()),c.applyImpulse(_.point,A)}else _.normalImpulse=0,_.tangentImpulse=0}}}solvePosition(t){var i;for(let n=0;n<this.config.positionIterations;n++)for(let o=0;o<t.length;o++){const h=t[o],c=h.bodyA,g=h.bodyB;if(c&&g){if(c.collisionType===gt.Passive||g.collisionType===gt.Passive)continue;const _=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const v of _){const x=h.normal,A=Xi.FindContactSeparation(h,v.local),S=this.config.steeringFactor,P=-5,I=this.config.slop,F=St(S*(A+I),P,0),R=x.scale(-F*v.normalMass);if(c.collisionType===gt.Active){const E=R.negate().scale(c.inverseMass);c.limitDegreeOfFreedom.includes(li.X)&&(E.x=0),c.limitDegreeOfFreedom.includes(li.Y)&&(E.y=0),c.globalPos=c.globalPos.add(E),c.limitDegreeOfFreedom.includes(li.Rotation)||(c.rotation-=v.aToContact.cross(R)*c.inverseInertia)}if(g.collisionType===gt.Active){const E=R.scale(g.inverseMass);g.limitDegreeOfFreedom.includes(li.X)&&(E.x=0),g.limitDegreeOfFreedom.includes(li.Y)&&(E.y=0),g.globalPos=g.globalPos.add(E),g.limitDegreeOfFreedom.includes(li.Rotation)||(g.rotation+=v.bToContact.cross(R)*g.inverseInertia)}}}}}solveVelocity(t){var i;for(let n=0;n<this.config.velocityIterations;n++)for(let o=0;o<t.length;o++){const h=t[o],c=h.bodyA,g=h.bodyB;if(c&&g){if(c.collisionType===gt.Passive||g.collisionType===gt.Passive)continue;const _=Math.min(c.friction,g.friction),v=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const x of v){let P=-x.getRelativeVelocity().dot(h.tangent)*x.tangentMass;const I=_*x.normalImpulse,F=St(x.tangentImpulse+P,-I,I);P=F-x.tangentImpulse,x.tangentImpulse=F;const R=h.tangent.scale(P);c.applyImpulse(x.point,R.negate()),g.applyImpulse(x.point,R)}for(const x of v){const S=x.getRelativeVelocity().dot(h.normal);let P=-x.normalMass*(S-x.originalVelocityAndRestitution);const I=Math.max(x.normalImpulse+P,0);P=I-x.normalImpulse,x.normalImpulse=I;const F=h.normal.scale(P);c.applyImpulse(x.point,F.negate()),g.applyImpulse(x.point,F)}}}}}class Na extends Ei{get _processor(){return this._physics.collisionProcessor}constructor(t,i){super(),this._physics=i,this.systemType=bi.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new Xl(i.config.arcade),this._realisticSolver=new ql(i.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=n=>this._processor.track(n),this._untrackCollider=n=>this._processor.untrack(n),this.query=t.query([nt,kt,Ae]),this.query.entityAdded$.subscribe(n=>{const o=n.get(Ae);o.$colliderAdded.subscribe(this._trackCollider),o.$colliderRemoved.subscribe(this._untrackCollider);const h=o.get();h&&this._processor.track(h)}),this.query.entityRemoved$.subscribe(n=>{const o=n.get(Ae),h=o.get();o&&h&&this._processor.untrack(h)}),this._motionSystem=t.get(Wa)}initialize(t,i){this._engine=i.engine}update(t){var i,n,o,h;if(!this._physics.config.enabled)return;let c=[];for(let A=0;A<this.query.entities.length;A++){const P=this.query.entities[A].get(Ae),I=P?.get();if(P&&(!((i=P.owner)===null||i===void 0)&&i.isActive)&&I)if(P.update(),I instanceof De){const F=I.getColliders();I.compositeStrategy||(I.compositeStrategy=this._physics.config.colliders.compositeStrategy),c=c.concat(F)}else c.push(I)}this._processor.update(c,t);let g=this._processor.broadphase(c,t);this._currentFrameContacts.clear();let _=[];const v=this.getSolver(),x=this._physics.config.substep;for(let A=0;A<x;A++)if(A>0&&this._motionSystem.update(t),_.length&&(g=_.map(S=>new ii(S.colliderA,S.colliderB))),g.length){_=this._processor.narrowphase(g,(h=(o=(n=this._engine)===null||n===void 0?void 0:n.debug)===null||o===void 0?void 0:o.stats)===null||h===void 0?void 0:h.currFrame),_=v.solve(_);for(const S of _){if(S.isCanceled())continue;const P=S.id.indexOf("|");if(P>0){const I=S.id.substring(P+1);this._currentFrameContacts.set(I,S)}else this._currentFrameContacts.set(S.id,S)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const A of this.query.entities){const S=A.get(Ae);S&&S.processColliderRemoval()}}postupdate(){we.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new Xl(this._physics.config.arcade),this._realisticSolver=new ql(this._physics.config.realistic)),this._physics.config.solver===to.Realistic?this._realisticSolver:this._arcadeSolver}debug(t){this._processor.debug(t,0)}runContactStartEnd(){for(const[t,i]of this._currentFrameContacts)if(!this._lastFrameContacts.has(t)){const n=i.colliderA,o=i.colliderB,h=Ot.fromDirection(i.mtv),c=Ot.getOpposite(h);n.events.emit("collisionstart",new Zr(n,o,h,i)),n.events.emit("contactstart",new Aa(n,o,h,i)),o.events.emit("collisionstart",new Zr(o,n,c,i)),o.events.emit("contactstart",new Aa(o,n,c,i))}for(const[t,i]of this._lastFrameContacts)if(!this._currentFrameContacts.has(t)){const n=i.colliderA,o=i.colliderB,h=Ot.fromDirection(i.mtv),c=Ot.getOpposite(h);n.events.emit("collisionend",new Jr(n,o,h,i)),n.events.emit("contactend",new ba(n,o,h,i)),o.events.emit("collisionend",new Jr(o,n,c,i)),o.events.emit("contactend",new ba(o,n,c,i))}}}Na.priority=ps.Higher;function ew(d,t,i,n){if(d.parent!==t.parent){const x=d.clone(),A=d.globalPos.clone(),S=d.globalScale.clone(),P=d.globalRotation;x.parent=t.parent,x.globalPos=A,x.globalScale=S,x.globalRotation=P,d=x}let o=t.pos,h=t.scale,c=t.rotation;o=t.pos.scale(i).add(d.pos.scale(1-i)),h=t.scale.scale(i).add(d.scale.scale(1-i));const g=(1-i)*Math.cos(d.rotation)+i*Math.cos(t.rotation),_=(1-i)*Math.sin(d.rotation)+i*Math.sin(t.rotation);c=Math.atan2(_,g);const v=n??new Ls;return v.setTransform(o,c,h),v}class Yc extends Ei{get sortedTransforms(){return this._sortedTransforms}constructor(t){super(),this.world=t,this.systemType=bi.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new Ls,this.query=this.world.query([nt,ce]),this.query.entityAdded$.subscribe(i=>{const n=i.get(nt);this._sortedTransforms.push(n),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{const n=i.get(nt);n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const o=this._sortedTransforms.indexOf(n);o>-1&&this._sortedTransforms.splice(o,1)})}initialize(t,i){this._camera=i.camera,this._engine=i.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>t.globalZ-i.globalZ),this._zHasChanged=!1)}update(t){this._token++;let i;Ht.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let n=0;n<this._sortedTransforms.length;n++){const o=this._sortedTransforms[n],h=o.owner;if(h.hasTag("ex.offscreen")||(i=h.get(ce),!i.isVisible))continue;i.onPreTransformDraw&&i.onPreTransformDraw(this._graphicsContext,t),h.events.emit("pretransformdraw",new _c(this._graphicsContext,t,h)),o.coordPlane===ze.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),o.coordPlane===ze.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),i.update(t,this._token);const c=h.get(Oa);if(c){const g=k.One.sub(c.parallaxFactor),_=this._camera.drawPos.scale(g);this._graphicsContext.translate(_.x,_.y)}this._applyTransform(h),i.material&&(this._graphicsContext.material=i.material),i.onPreDraw&&i.onPreDraw(this._graphicsContext,t),h.events.emit("predraw",new pr(this._graphicsContext,t,h)),this._applyOpacity(h),this._drawGraphicsComponent(i,o),i.onPostDraw&&i.onPostDraw(this._graphicsContext,t),h.events.emit("postdraw",new _r(this._graphicsContext,t,h)),this._graphicsContext.restore(),o.coordPlane===ze.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),i.onPostTransformDraw&&i.onPostTransformDraw(this._graphicsContext,t),h.events.emit("posttransformdraw",new mc(this._graphicsContext,t,h))}this._graphicsContext.restore()}_drawGraphicsComponent(t,i){var n,o;if(t.isVisible){const h=t.flipHorizontal,c=t.flipVertical,g=t.current,_=(n=t.currentOptions)!==null&&n!==void 0?n:{};if(g){let v=t.anchor,x=t.offset,A=1,S=1;_?.anchor&&(v=_.anchor),_?.offset&&(x=_.offset);const P=i.globalScale;A*=g.scale.x*P.x,S*=g.scale.y*P.y;const I=-g.width*v.x+x.x*A,F=-g.height*v.y+x.y*S,R=g.flipHorizontal,E=g.flipVertical;if((h||c)&&(g.flipHorizontal=h?!R:R,g.flipVertical=c?!E:E),g?.draw(this._graphicsContext,I,F),(h||c)&&(g.flipHorizontal=R,g.flipVertical=E),!((o=this._engine)===null||o===void 0)&&o.isDebug&&this._engine.debug.graphics.showBounds){const M=N(I,F);if(g instanceof rr)for(const V of g.members){let L,G=k.Zero;V instanceof he?L=V:(L=V.graphic,G=V.offset),g.useAnchor?L?.localBounds.translate(M.add(G)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):L?.localBounds.translate(G).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else g?.localBounds.translate(M).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(t){const i=t.getAncestors();for(let n=0;n<i.length;n++){const o=i[n],h=o?.get(nt),c=o?.get(Tt);if(h){let g=h.get();if(c&&this._engine.fixedUpdateTimestep&&c.__oldTransformCaptured&&c.enableFixedUpdateInterpolate){const _=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;g=ew(c.oldTransform,h.get(),_,this._targetInterpolationTransform)}this._graphicsContext.z=h.globalZ,this._graphicsContext.translate(g.pos.x,g.pos.y),this._graphicsContext.scale(g.scale.x,g.scale.y),this._graphicsContext.rotate(g.rotation)}}}_applyOpacity(t){var i;const n=t.getAncestors();for(let o=0;o<n.length;o++){const h=n[o],c=h?.get(ce);this._graphicsContext.opacity*=(i=c?.opacity)!==null&&i!==void 0?i:1}}}Yc.priority=ps.Average;class jc extends Ei{constructor(t){super(),this.world=t,this.systemType=bi.Draw,this.query=this.world.query([nt])}initialize(t,i){this._graphicsContext=i.engine.graphicsContext,this._camera=i.camera,this._engine=i.engine,this._collisionSystem=t.systemManager.get(Na)}update(){var t;if(!this._engine.isDebug)return;const i=this._engine.debug.filter;let n,o;const h=this._engine.debug.entity;let c;const g=this._engine.debug.transform;let _;const v=this._engine.debug.motion;let x;const A=this._engine.debug.collider,S=this._engine.debug.physics;let P;const I=this._engine.debug.graphics;let F,R;const E=this._engine.debug.body,M=this._engine.debug.camera;for(let V=0;V<this.query.entities.length;V++){const L=this.query.entities[V];if(L.hasTag("offscreen")||L instanceof La||i.useFilter&&(!(i.ids.length===0||i.ids.includes(L.id))||!(i.nameQuery===""||L.name.includes(i.nameQuery))))continue;let G=k.Zero;const j=N(0,16);if(n=L.id,o=L.name,c=L.get(nt),this._pushCameraTransform(c),this._graphicsContext.save(),c.coordPlane===ze.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=g.debugZIndex,this._applyTransform(L),c&&((g.showAll||g.showPosition)&&this._graphicsContext.debug.drawPoint(k.Zero,{size:4,color:g.positionColor}),(g.showAll||g.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${c.pos.toString(2)}`,G),G=G.add(j)),(g.showAll||g.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${c.z.toFixed(1)})`,G),G=G.add(j)),(h.showAll||h.showId)&&(this._graphicsContext.debug.drawText(`id(${n}) ${L.parent?"child of id("+((t=L.parent)===null||t===void 0?void 0:t.id)+")":""}`,G),G=G.add(j)),(h.showAll||h.showName)&&(this._graphicsContext.debug.drawText(`name(${o})`,G),G=G.add(j)),(g.showAll||g.showRotation)&&(this._graphicsContext.drawLine(k.Zero,k.fromAngle(c.rotation).scale(50).add(k.Zero),g.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${yf(c.rotation).toFixed(2)})`,G),G=G.add(j)),(g.showAll||g.showScale)&&this._graphicsContext.drawLine(k.Zero,c.scale.add(k.Zero),g.scaleColor,2)),P=L.get(ce),P&&(I.showAll||I.showBounds)&&P.localBounds.draw(this._graphicsContext,I.boundsColor),F=L.get(Va),F&&(F.useTransform||this._graphicsContext.restore(),F.draw(this._graphicsContext,this._engine.debug),F.useTransform||(this._graphicsContext.save(),this._applyTransform(L))),R=L.get(Tt),R&&((E.showAll||E.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${R.group.name})`,G),G=G.add(j)),(E.showAll||E.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${R.collisionType})`,G),G=G.add(j)),(E.showAll||E.showMass)&&(this._graphicsContext.debug.drawText(`mass(${R.mass})`,G),G=G.add(j)),(E.showAll||E.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${R.sleepMotion})`,G),G=G.add(j)),(E.showAll||E.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${R.canSleep?R.isSleeping:"cant sleep"})`,G),G=G.add(j))),this._graphicsContext.restore(),this._graphicsContext.save(),c.coordPlane===ze.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=g.debugZIndex,_=L.get(kt),_&&((v.showAll||v.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${_.vel.toString(2)}`,G.add(c.globalPos)),this._graphicsContext.drawLine(c.globalPos,c.globalPos.add(_.vel),v.velocityColor,2),G=G.add(j)),(v.showAll||v.showAcceleration)&&this._graphicsContext.drawLine(c.globalPos,c.globalPos.add(_.acc),v.accelerationColor,2)),x=L.get(Ae),x){const X=x.get();if((A.showAll||A.showGeometry)&&X&&X.debug(this._graphicsContext,A.geometryColor,{lineWidth:A.geometryLineWidth,pointSize:A.geometryPointSize}),A.showAll||A.showBounds){if(X instanceof De){const rt=X.getColliders();for(const lt of rt){const yt=lt.bounds,wt=N(yt.left,yt.top);this._graphicsContext.debug.drawRect(wt.x,wt.y,yt.width,yt.height,{color:A.boundsColor}),(A.showAll||A.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${lt.owner.id})`,wt)}x.bounds.draw(this._graphicsContext,A.boundsColor)}else if(X){const rt=x.bounds,lt=N(rt.left,rt.top);this._graphicsContext.debug.drawRect(lt.x,lt.y,rt.width,rt.height,{color:A.boundsColor}),(A.showAll||A.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${x.owner.id})`,lt)}}}this._graphicsContext.restore(),this._popCameraTransform(c)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(S.showAll||S.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),S.showAll||S.showCollisionContacts||S.showCollisionNormals)for(const[V,L]of this._engine.debug.stats.currFrame.physics.contacts){if(S.showAll||S.showCollisionContacts)for(const G of L.points)this._graphicsContext.debug.drawPoint(G,{size:S.contactSize,color:S.collisionContactColor});if(S.showAll||S.showCollisionNormals)for(const G of L.points)this._graphicsContext.debug.drawLine(G,L.normal.scale(30).add(G),{color:S.collisionNormalColor})}this._graphicsContext.restore(),M&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(M.showAll||M.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,M.focusColor),(M.showAll||M.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(t,i){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),Re.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(t){const i=t.getAncestors();for(const n of i){const o=n?.get(nt);o&&(this._graphicsContext.translate(o.pos.x,o.pos.y),this._graphicsContext.scale(o.scale.x,o.scale.y),this._graphicsContext.rotate(o.rotation))}}_pushCameraTransform(t){t.coordPlane===ze.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(t){t.coordPlane===ze.World&&this._graphicsContext.restore()}}jc.priority=ps.Lowest;class Qc{constructor(t,i){this.object=t,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=i,this.bounds=t.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const t=this.object.bounds,i=Math.floor(t.left/this.gridSize),n=Math.floor(t.right/this.gridSize),o=Math.floor(t.bottom/this.gridSize),h=Math.floor(t.top/this.gridSize);return this.leftX!==i||this.rightX!==n||this.bottomY!==o||this.topY!==h}clear(){for(const t of this.cells){const i=t.proxies.indexOf(this);i>-1&&t.proxies.splice(i,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class rs{constructor(){this.proxies=[]}configure(t,i){this.x=t,this.y=i,this.key=rs.calculateHashKey(t,i)}static calculateHashKey(t,i){return`${t}+${i}`}}class Zc{constructor(t){this.bounds=new ct,this._hashGridCellPool=new ho(()=>new rs,i=>(i.configure(0,0),i.proxies.length=0,i),1e3),this.gridSize=t.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,t.proxyFactory?this._buildProxy=i=>t.proxyFactory(i,this.gridSize):this._buildProxy=i=>new Qc(i,this.gridSize)}query(t){const i=new Set;if(t instanceof ct){const n=t,o=Math.floor(n.left/this.gridSize),h=Math.floor(n.right/this.gridSize),c=Math.floor(n.bottom/this.gridSize),g=Math.floor(n.top/this.gridSize);for(let _=o;_<=h;_++)for(let v=g;v<=c;v++){const x=rs.calculateHashKey(_,v),A=this.sparseHashGrid.get(x);if(A)for(let S=0;S<A.proxies.length;S++)A.proxies[S].updateBounds(),A.proxies[S].bounds.intersect(n)&&i.add(A.proxies[S].object)}}else{const n=t,o=rs.calculateHashKey(Math.floor(n.x/this.gridSize),Math.floor(n.y/this.gridSize)),h=this.sparseHashGrid.get(o);if(h)for(let c=0;c<h.proxies.length;c++)h.proxies[c].updateBounds(),h.proxies[c].bounds.contains(n)&&i.add(h.proxies[c].object)}return Array.from(i)}get(t,i){const n=rs.calculateHashKey(t,i);return this.sparseHashGrid.get(n)}_insert(t,i,n){const o=rs.calculateHashKey(t,i);let h=this.sparseHashGrid.get(o);h||(h=this._hashGridCellPool.rent(),h.configure(t,i),this.sparseHashGrid.set(h.key,h)),h.proxies.push(n),n.cells.push(h),this.bounds.combine(n.bounds,this.bounds)}_remove(t,i,n){const o=rs.calculateHashKey(t,i),h=this.sparseHashGrid.get(o);if(h){const c=h.proxies.indexOf(n);c>-1&&h.proxies.splice(c,1);const g=n.cells.indexOf(h);g>-1&&n.cells.splice(g,1),h.proxies.length===0&&(this._hashGridCellPool.return(h),this.sparseHashGrid.delete(o))}}track(t){const i=this._buildProxy(t);this.objectToProxy.set(t,i);for(let n=i.leftX;n<=i.rightX;n++)for(let o=i.topY;o<=i.bottomY;o++)this._insert(n,o,i)}untrack(t){const i=this.objectToProxy.get(t);i&&(i.clear(),this.objectToProxy.delete(t))}update(t){let i=0;for(const n of t){const o=this.objectToProxy.get(n);if(o&&o.hasChanged()){for(let h=o.leftX;h<=o.rightX;h++)for(let c=o.topY;c<=o.bottomY;c++)this._remove(h,c,o);o.update();for(let h=o.leftX;h<=o.rightX;h++)for(let c=o.topY;c<=o.bottomY;c++)this._insert(h,c,o);i++}}return i}debug(t,i){const n=$.Transparent,o=$.White;for(const h of this.sparseHashGrid.values())t.drawRectangle(N(h.x*this.gridSize,h.y*this.gridSize),this.gridSize,this.gridSize,n,o,2)}}class Ga extends Ei{constructor(t){super(),this.world=t,this.systemType=bi.Update,this._graphicsHashGrid=new Zc({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new qc,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([nt,sn]),this.query.entityAdded$.subscribe(i=>{const n=i.get(nt),o=i.get(sn);this._pointerEventDispatcher.addObject(i,c=>o&&o.localBounds?o.localBounds.transform(n.get().matrix).contains(n.coordPlane===ze.World?c.worldPos:c.screenPos):!1,()=>i.isActive),this._entityToPointer.set(i,o);const h=i.get(ce);h&&(this._graphics.push(h),this._graphicsHashGrid.track(h)),this._sortedTransforms.push(n),this._sortedEntities.push(n.owner),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{this._pointerEventDispatcher.removeObject(i);const n=i.get(nt);this._entityToPointer.delete(i);const o=i.get(ce);if(o){const c=this._graphics.indexOf(o);c>-1&&this._graphics.splice(c,1),this._graphicsHashGrid.untrack(o)}n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const h=this._sortedTransforms.indexOf(n);h>-1&&(this._sortedTransforms.splice(h,1),this._sortedEntities.splice(h,1))})}initialize(t,i){this._engine=i.engine,this._scene=i}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>i.z-t.z),this._sortedEntities=this._sortedTransforms.map(t=>t.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[t,i]of this._engineReceiver.currentFramePointerCoords.entries()){const n=this._scene.physics.query(i.worldPos);for(let h=0;h<n.length;h++){const c=n[h],g=this._entityToPointer.get(c.owner);g&&(g.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(c.owner,t)}const o=this._graphicsHashGrid.query(i.worldPos);for(let h=0;h<o.length;h++){const c=o[h],g=this._entityToPointer.get(c.owner);g&&(g.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(c.owner,t)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(t=>t.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(t=>t.clear())}}Ga.priority=ps.Higher;class Jc extends Ei{constructor(t){super(),this.world=t,this.systemType=bi.Update,this._actions=[],this.query=this.world.query([sr]),this.query.entityAdded$.subscribe(i=>this._actions.push(i.get(sr))),this.query.entityRemoved$.subscribe(i=>{const n=i.get(sr),o=this._actions.indexOf(n);o>-1&&this._actions.splice(o,1)})}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}}Jc.priority=ps.Higher;class so extends Di{constructor(t){super(),this.elevation=0,this.columns=t.columns,this.rows=t.rows,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight}}class Kc extends Ei{constructor(t){super(),this.world=t,this.systemType=bi.Update,this.query=this.world.query([nt,so])}update(){let t,i;for(let n=0;n<this.query.entities.length;n++){const o=this.query.entities[n];t=o.get(nt),i=o.get(so);const c=Math.max(i.columns*i.tileWidth,i.rows*i.tileHeight)*i.elevation+t.pos.y;t.z=c}}}Kc.priority=ps.Lower;class $c extends Ei{constructor(t){super(),this.world=t,this.systemType=bi.Draw,this.query=this.world.query([nt,ce])}initialize(t,i){this._camera=i.camera,this._screen=i.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let t,i,n;for(let o=0;o<this.query.entities.length;o++){const h=this.query.entities[o];i=h.get(ce),t=h.get(nt),n=h.get(Oa);let c;if(n){const _=k.One.sub(n.parallaxFactor);c=this._camera.pos.scale(_)}const g=this._isOffscreen(t,i,c);g&&!h.hasTag("ex.offscreen")&&(h.events.emit("exitviewport",new Rc(h)),h.addTag("ex.offscreen")),!g&&h.hasTag("ex.offscreen")&&(h.events.emit("enterviewport",new Dc(h)),h.removeTag("ex.offscreen"))}}_isOffscreen(t,i,n){if(i.forceOnScreen)return!1;if(t.coordPlane===ze.World){let o=i.localBounds;n&&(o=o.translate(n));const h=o.transform(t.get().matrix);return!this._worldBounds.overlaps(h)}else return!1}}$c.priority=ps.Higher;class Bg extends Qc{constructor(t,i){var n,o;super(t,i),this.collider=t,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=i;const h=t.bounds;this.hasZeroBounds=h.hasZeroDimensions(),this.leftX=Math.floor(h.left/this.gridSize),this.rightX=Math.floor(h.right/this.gridSize),this.bottomY=Math.floor(h.bottom/this.gridSize),this.topY=Math.floor(h.top/this.gridSize),this.owner=t.owner,this.body=(n=this.owner)===null||n===void 0?void 0:n.get(Tt),this.collisionType=(o=this.body.collisionType)!==null&&o!==void 0?o:gt.PreventCollision}update(){var t,i;super.update(),this.body=(t=this.owner)===null||t===void 0?void 0:t.get(Tt),this.collisionType=(i=this.body.collisionType)!==null&&i!==void 0?i:gt.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class Yl{constructor(t){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new Ba(()=>new ii({id:Bn("collider",0)},{id:Bn("collider",0)}),i=>(i.colliderA=null,i.colliderB=null,i),200),this.gridSize=t.size,this.hashGrid=new Zc({size:this.gridSize,proxyFactory:(i,n)=>new Bg(i,n)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(t){return this.hashGrid.query(t)}rayCast(t,i){var n,o,h;const c=[],g=(n=i?.maxDistance)!==null&&n!==void 0?n:1/0,_=i?.collisionGroup,v=_?_.category:(o=i?.collisionMask)!==null&&o!==void 0?o:Us.All.category,x=(h=i?.searchAllColliders)!==null&&h!==void 0?h:!1,A=t.dir.normalize(),S=A.y/A.x,P=A.x/A.y,I=Math.sqrt(1+S*S)*this.gridSize,F=Math.sqrt(1+P*P)*this.gridSize,R=t.pos.x/this.gridSize,E=t.pos.y/this.gridSize,M=N(1,1);let V=~~R,L=~~E,G=0,j=0;A.x<0?(M.x=-1,G=(R-V)*I):(M.x=1,G=(V+1-R)*I),A.y<0?(M.y=-1,j=(E-L)*F):(M.y=1,j=(L+1-E)*F);const X=new Set;let rt=!1,lt=9999;for(;!rt&&lt>0&&(lt--,!!this.hashGrid.bounds.contains(N(V*this.gridSize,L*this.gridSize)));){const yt=rs.calculateHashKey(V,L),wt=this.hashGrid.sparseHashGrid.get(yt);if(wt){const Pt=[];for(let Dt=0;Dt<wt.proxies.length;Dt++){const B=wt.proxies[Dt];if(!X.has(B.collider.id.value)){if(X.add(B.collider.id.value),i?.ignoreCollisionGroupAll&&B.body.group===Us.All)continue;const z=(v&B.body.group.category)!==0;if(B.body.group&&!z)continue;const Z=B.collider.rayCast(t,g);Z&&Pt.push(Z)}}Pt.sort((Dt,B)=>Dt.distance-B.distance);for(let Dt=0;Dt<Pt.length;Dt++){const B=Pt[Dt];if(i?.filter){if(i.filter(B)&&(c.push(B),!x)){rt=!0;break}}else if(c.push(B),!x){rt=!0;break}}}G<j?(V+=M.x,G+=I):(L+=M.y,j+=F)}return c.sort((yt,wt)=>yt.distance-wt.distance),!x&&c.length?[c[0]]:c}track(t){let i=[t];if(t instanceof De){const n=t.getColliders();for(const o of n)o.owner=t.owner;i=n}for(const n of i)this.hashGrid.track(n)}untrack(t){let i=[t];t instanceof De&&(i=t.getColliders());for(const n of i)this.hashGrid.untrack(n)}_canCollide(t,i){return!(t.collider.id===i.collider.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.hasZeroBounds||i.hasZeroBounds||!t.body.group.canCollide(i.body.group)||t.collisionType===gt.Fixed&&i.collisionType===gt.Fixed||t.collisionType===gt.PreventCollision||i.collisionType===gt.PreventCollision||!t.owner.isActive||!i.owner.isActive)}broadphase(t,i){const n=[];this._pairs.clear(),this._nonPairs.clear();let o=0;for(const h of this.hashGrid.objectToProxy.values())if(h.id=o++,!(!h.owner.isActive||h.collisionType===gt.PreventCollision))for(let c=0;c<h.cells.length;c++){const g=h.cells[c];for(let _=0;_<g.proxies.length;_++){const v=g.proxies[_];if(v.id===h.id)continue;const x=ii.calculatePairHash(h.collider.id,v.collider.id);if(!this._nonPairs.has(x))if(!this._pairs.has(x)&&this._canCollide(h,v)&&h.object.bounds.overlaps(v.object.bounds)){const A=this._pairPool.get();A.colliderA=h.collider,A.colliderB=v.collider,A.id=x,this._pairs.add(x),n.push(A)}else this._nonPairs.add(x)}}return n}narrowphase(t,i){const n=[];for(let o=0;o<t.length;o++){const h=t[o].collide();for(let c=0;c<h.length;c++){const g=h[c];n.push(g),i&&i.physics.contacts.set(g.id,g)}}return this._pairPool.done(),i&&(i.physics.collisions+=n.length),n}update(t,i){return this.hashGrid.update(t)}debug(t,i){this.hashGrid.debug(t,i)}}class kg{get config(){return Qm(this._config,t=>{this.$configUpdate.notifyAll(t)})}set config(t){this._config=t,this.$configUpdate.notifyAll(t)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const t=this._collisionProcessor.getColliders();this._config.spatialPartition===or.SparseHashGrid?this._collisionProcessor=new Yl(this._config.sparseHashGrid):this._collisionProcessor=new Pa(this._config);for(const i of t)this._collisionProcessor.track(i)}return this._collisionProcessor}constructor(t){this.$configUpdate=new ei,this._configDirty=!1,this.config=t,this.$configUpdate.subscribe(i=>{this._configDirty=!0,Tt.updateDefaultPhysicsConfig(i.bodies)}),this._config.spatialPartition===or.SparseHashGrid?this._collisionProcessor=new Yl(this._config.sparseHashGrid):this._collisionProcessor=new Pa(this._config)}rayCast(t,i){return this.collisionProcessor.rayCast(t,i)}query(t){return this._collisionProcessor.query(t)}}class Xa{constructor(){this.events=new $t,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(t){this._enabled=t}setMinimumGamepadConfiguration(t){this._enableAndUpdate(),this._minimumConfiguration=t}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(t){if(!this._minimumConfiguration)return!0;if(!t)return!1;const i=t.axes.filter(o=>typeof o!==void 0).length,n=t.buttons.filter(o=>typeof o!==void 0).length;return i>=this._minimumConfiguration.axis&&n>=this._minimumConfiguration.buttons&&t.connected}emit(t,i){this.events.emit(t,i)}on(t,i){return this._enableAndUpdate(),this.events.on(t,i)}once(t,i){return this._enableAndUpdate(),this.events.once(t,i)}off(t,i){this._enableAndUpdate(),this.events.off(t,i)}update(){var t,i;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const n=this._navigator.getGamepads();for(let o=0;o<n.length;o++){if(n[o]){const c=this.at(o);!this.at(o).connected&&this._isGamepadValid(n[o])&&(c.events.pipe(this.events),this.events.emit("connect",new bc(o,this.at(o)))),this.at(o).connected=!0}else{const c=this.at(o);c.connected&&(this.events.emit("disconnect",new yc(o,c)),c.events.unpipe(this.events)),c.connected=!1;continue}if(this.at(o).update(),n[o].timestamp&&n[o].timestamp===this._gamePadTimeStamps[o])continue;this._gamePadTimeStamps[o]=n[o].timestamp,this.at(o).navigatorGamepad=n[o];const h=n[o];if(h){for(let c=0;c<h.buttons.length;c++){const g=h.buttons[c],_=g?.value;_!==((t=this._oldPads[o])===null||t===void 0?void 0:t.getButton(c))&&(g?.pressed?(this.at(o).updateButton(c,_),this.at(o).events.emit("button",new Cc(c in no?c:no.Unknown,c,_,this.at(o)))):this.at(o).updateButton(c,0))}for(let c=0;c<h.axes.length;c++){const g=h.axes[c];g!==((i=this._oldPads[o])===null||i===void 0?void 0:i.getAxes(c))&&(this.at(o).updateAxes(c,g),this.at(o).events.emit("axis",new Sc(c,g,this.at(o))))}}this._oldPads[o]=this._clonePad(n[o])}}at(t){if(this._enableAndUpdate(),t>=this._pads.length)for(let i=this._pads.length-1,n=t;i<n;i++)this._pads.push(new da),this._oldPads.push(new da);return this._pads[t]}getValidGamepads(){this._enableAndUpdate();const t=[];for(let i=0;i<this._pads.length;i++)this._isGamepadValid(this.at(i).navigatorGamepad)&&this.at(i).connected&&t.push(this.at(i));return t}count(){return this._pads.filter(t=>t.connected).length}_clonePads(t){const i=[];for(let n=0,o=t.length;n<o;n++)i.push(this._clonePad(t[n]));return i}_clonePad(t){let i,n;const o=new da;if(!t)return o;for(i=0,n=t.buttons.length;i<n;i++)t.buttons[i]&&o.updateButton(i,t.buttons[i].value);for(i=0,n=t.axes.length;i<n;i++)o.updateAxes(i,t.axes[i]);return o}}Xa.MinAxisMoveThreshold=.05;class da{constructor(){this.events=new $t,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let t=0;t<this._buttons.length;t++)this._buttons[t]=0;for(let t=0;t<this._axes.length;t++)this._axes[t]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(t,i=1){return this._buttons[t]>=i}isButtonHeld(t,i=1){return this._buttons[t]>=i}wasButtonPressed(t,i=1){return this._buttonsDown[t]>=i}wasButtonReleased(t){return!!this._buttonsUp[t]}getButton(t){return this._buttons[t]}getAxes(t){const i=this._axes[t];return Math.abs(i)<Xa.MinAxisMoveThreshold?0:i}updateButton(t,i){i===0&&this._buttons[t]?this._buttonsUp[t]=1:this._buttonsDown[t]=i,this._buttons[t]=i}updateAxes(t,i){this._axes[t]=i}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}var no;(function(d){d[d.Unknown=-1]="Unknown",d[d.Face1=0]="Face1",d[d.Face2=1]="Face2",d[d.Face3=2]="Face3",d[d.Face4=3]="Face4",d[d.LeftBumper=4]="LeftBumper",d[d.RightBumper=5]="RightBumper",d[d.LeftTrigger=6]="LeftTrigger",d[d.RightTrigger=7]="RightTrigger",d[d.Select=8]="Select",d[d.Start=9]="Start",d[d.LeftStick=10]="LeftStick",d[d.RightStick=11]="RightStick",d[d.DpadUp=12]="DpadUp",d[d.DpadDown=13]="DpadDown",d[d.DpadLeft=14]="DpadLeft",d[d.DpadRight=15]="DpadRight",d[d.CenterButton=16]="CenterButton",d[d.MiscButton1=17]="MiscButton1"})(no||(no={}));var jl;(function(d){d[d.LeftStickX=0]="LeftStickX",d[d.LeftStickY=1]="LeftStickY",d[d.RightStickX=2]="RightStickX",d[d.RightStickY=3]="RightStickY"})(jl||(jl={}));class Lg{constructor(t){this.inputs=t,this._handlers=new Map}execute(){for(const[t,i]of this._handlers.entries()){const n=t(this.inputs);n&&i(n)}}on(t,i){this._handlers.set(t,i)}}function Ug(){try{const d=()=>{};window.top.addEventListener("blur",d),window.top.removeEventListener("blur",d)}catch{return!0}return!1}var ro;(function(d){d.Backquote="Backquote",d.Backslash="Backslash",d.BracketLeft="BracketLeft",d.BracketRight="BracketRight",d.Comma="Comma",d.Key0="Digit0",d.Key1="Digit1",d.Key2="Digit2",d.Key3="Digit3",d.Key4="Digit4",d.Key5="Digit5",d.Key6="Digit6",d.Key7="Digit7",d.Key8="Digit8",d.Key9="Digit9",d.Digit0="Digit0",d.Digit1="Digit1",d.Digit2="Digit2",d.Digit3="Digit3",d.Digit4="Digit4",d.Digit5="Digit5",d.Digit6="Digit6",d.Digit7="Digit7",d.Digit8="Digit8",d.Digit9="Digit9",d.Equal="Equal",d.IntlBackslash="IntlBackslash",d.IntlRo="IntlRo",d.IntlYen="IntlYen",d.A="KeyA",d.B="KeyB",d.C="KeyC",d.D="KeyD",d.E="KeyE",d.F="KeyF",d.G="KeyG",d.H="KeyH",d.I="KeyI",d.J="KeyJ",d.K="KeyK",d.L="KeyL",d.M="KeyM",d.N="KeyN",d.O="KeyO",d.P="KeyP",d.Q="KeyQ",d.R="KeyR",d.S="KeyS",d.T="KeyT",d.U="KeyU",d.V="KeyV",d.W="KeyW",d.X="KeyX",d.Y="KeyY",d.Z="KeyZ",d.KeyA="KeyA",d.KeyB="KeyB",d.KeyC="KeyC",d.KeyD="KeyD",d.KeyE="KeyE",d.KeyF="KeyF",d.KeyG="KeyG",d.KeyH="KeyH",d.KeyI="KeyI",d.KeyJ="KeyJ",d.KeyK="KeyK",d.KeyL="KeyL",d.KeyM="KeyM",d.KeyN="KeyN",d.KeyO="KeyO",d.KeyP="KeyP",d.KeyQ="KeyQ",d.KeyR="KeyR",d.KeyS="KeyS",d.KeyT="KeyT",d.KeyU="KeyU",d.KeyV="KeyV",d.KeyW="KeyW",d.KeyX="KeyX",d.KeyY="KeyY",d.KeyZ="KeyZ",d.Minus="Minus",d.Period="Period",d.Quote="Quote",d.Semicolon="Semicolon",d.Slash="Slash",d.AltLeft="AltLeft",d.AltRight="AltRight",d.Alt="Alt",d.AltGraph="AltGraph",d.Backspace="Backspace",d.CapsLock="CapsLock",d.ContextMenu="ContextMenu",d.ControlLeft="ControlLeft",d.ControlRight="ControlRight",d.Enter="Enter",d.MetaLeft="MetaLeft",d.MetaRight="MetaRight",d.ShiftLeft="ShiftLeft",d.ShiftRight="ShiftRight",d.Space="Space",d.Tab="Tab",d.Convert="Convert",d.KanaMode="KanaMode",d.NonConvert="NonConvert",d.Delete="Delete",d.End="End",d.Help="Help",d.Home="Home",d.Insert="Insert",d.PageDown="PageDown",d.PageUp="PageUp",d.Up="ArrowUp",d.Down="ArrowDown",d.Left="ArrowLeft",d.Right="ArrowRight",d.ArrowUp="ArrowUp",d.ArrowDown="ArrowDown",d.ArrowLeft="ArrowLeft",d.ArrowRight="ArrowRight",d.NumLock="NumLock",d.Numpad0="Numpad0",d.Numpad1="Numpad1",d.Numpad2="Numpad2",d.Numpad3="Numpad3",d.Numpad4="Numpad4",d.Numpad5="Numpad5",d.Numpad6="Numpad6",d.Numpad7="Numpad7",d.Numpad8="Numpad8",d.Numpad9="Numpad9",d.Num0="Numpad0",d.Num1="Numpad1",d.Num2="Numpad2",d.Num3="Numpad3",d.Num4="Numpad4",d.Num5="Numpad5",d.Num6="Numpad6",d.Num7="Numpad7",d.Num8="Numpad8",d.Num9="Numpad9",d.NumAdd="NumpadAdd",d.NumpadAdd="NumpadAdd",d.NumDecimal="NumpadDecimal",d.NumpadDecimal="NumpadDecimal",d.NumDivide="NumpadDivide",d.NumpadDivide="NumpadDivide",d.NumEnter="NumpadEnter",d.NumpadEnter="NumpadEnter",d.NumMultiply="NumpadMultiply",d.NumpadMultiply="NumpadMultiply",d.NumSubtract="NumpadSubtract",d.NumpadSubtract="NumpadSubtract",d.Esc="Escape",d.Escape="Escape",d.F1="F1",d.F2="F2",d.F3="F3",d.F4="F4",d.F5="F5",d.F6="F6",d.F7="F7",d.F8="F8",d.F9="F9",d.F10="F10",d.F11="F11",d.F12="F12",d.F13="F13",d.F14="F14",d.F15="F15",d.F16="F16",d.F17="F17",d.F18="F18",d.F19="F19",d.F20="F20",d.PrintScreen="PrintScreen",d.ScrollLock="ScrollLock",d.Pause="Pause",d.Unidentified="Unidentified"})(ro||(ro={}));class Xr extends bt{constructor(t,i,n){super(),this.key=t,this.value=i,this.originalEvent=n}}class zg{constructor(){this.events=new $t,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=t=>{for(const i of this._keys){const n=new Xr(i,t.key,t);this.events.emit("up",n),this.events.emit("release",n)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=t=>{if(!this._enabled)return;!t.metaKey&&(this._keys.includes(ro.MetaLeft)||this._keys.includes(ro.MetaRight))&&this._releaseAllKeys(t);const i=t.code;if(this._keys.indexOf(i)===-1){this._keys.push(i),this._keysDown.push(i);const n=new Xr(i,t.key,t);this.events.emit("down",n),this.events.emit("press",n)}},this._handleKeyUp=t=>{if(!this._enabled)return;const i=t.code,n=this._keys.indexOf(i);this._keys.splice(n,1),this._keysUp.push(i);const o=new Xr(i,t.key,t);this.events.emit("up",o),this.events.emit("release",o),t.key==="Meta"&&this._releaseAllKeys(t)}}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}init(t){let{global:i}=t;const{grabWindowFocus:n}=t;i||(Ug()?(i=window,n&&window.focus(),ut.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):i=window.top),i.addEventListener("blur",()=>{this._keys.length=0}),i.addEventListener("keyup",this._handleKeyUp),i.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(t){this._enabled=t}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let t=0;t<this._keys.length;t++)this.events.emit("hold",new Xr(this._keys[t]))}getKeys(){return this._keys}wasPressed(t){return this._enabled?this._keysDown.indexOf(t)>-1:!1}isHeld(t){return this._enabled?this._keys.indexOf(t)>-1:!1}wasReleased(t){return this._enabled?this._keysUp.indexOf(t)>-1:!1}triggerEvent(t,i,n){t==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:i,key:n??null})),t==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:i,key:n??null}))}}class ar{static fromPagePosition(t,i,n){let o,h,c,g;arguments.length===3?(o=t,h=i,c=new k(o,h),g=n):(c=t,o=c.x,h=c.y,g=i);const _=g.screen.pageToScreenCoordinates(c),v=g.screen.screenToWorldCoordinates(_);return new ar(v,c,_)}constructor(t,i,n){this.worldPos=t,this.pagePos=i,this.screenPos=n}}class qr{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(t,i,n,o,h,c){this.type=t,this.pointerId=i,this.button=n,this.pointerType=o,this.coordinates=h,this.nativeEvent=c,this.active=!0}}class Hg{cancel(){this.active=!1}constructor(t,i,n,o,h,c,g,_,v,x,A,S){this.x=t,this.y=i,this.pageX=n,this.pageY=o,this.screenX=h,this.screenY=c,this.index=g,this.deltaX=_,this.deltaY=v,this.deltaZ=x,this.deltaMode=A,this.ev=S,this.active=!0}}class Ql{constructor(){this.events=new $t,this.lastPagePos=k.Zero,this.lastScreenPos=k.Zero,this.lastWorldPos=k.Zero,this._onPointerMove=t=>{this.lastPagePos=new k(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new k(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new k(t.worldPos.x,t.worldPos.y)},this._onPointerDown=t=>{this.lastPagePos=new k(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new k(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new k(t.worldPos.x,t.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_updateWorldPosition(t){const i=ar.fromPagePosition(this.lastPagePos,t);this.lastScreenPos=i.screenPos,this.lastWorldPos=i.worldPos}}var nr;(function(d){d.Pixel="Pixel",d.Line="Line",d.Page="Page"})(nr||(nr={}));var Ks;(function(d){d[d.NoButton=-1]="NoButton",d[d.Left=0]="Left",d[d.Middle=1]="Middle",d[d.Right=2]="Right",d[d.Unknown=3]="Unknown"})(Ks||(Ks={}));var Ts;(function(d){d.Left="Left",d.Middle="Middle",d.Right="Right",d.Unknown="Unknown",d.NoButton="NoButton"})(Ts||(Ts={}));var Is;(function(d){d.Touch="Touch",d.Mouse="Mouse",d.Pen="Pen",d.Unknown="Unknown"})(Is||(Is={}));function iw(d){return globalThis.TouchEvent&&d instanceof globalThis.TouchEvent}function sw(d){return globalThis.PointerEvent&&d instanceof globalThis.PointerEvent}class qa{constructor(t,i){this.target=t,this.engine=i,this.events=new $t,this.primary=new Ql,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(t){this._enabled=t}recreate(t,i){const n=new qa(t,i);return n.primary=this.primary,n._pointers=this._pointers,n}at(t){if(t>=this._pointers.length)for(let i=this._pointers.length-1,n=t;i<n;i++)this._pointers.push(new Ql);return this._pointers[t]}count(){return this._pointers.length}isDown(t){var i;return this._enabled&&(i=this.currentFramePointerDown.get(t))!==null&&i!==void 0?i:!1}wasDown(t){var i;return this._enabled&&(i=this.lastFramePointerDown.get(t))!==null&&i!==void 0?i:!1}isDragging(t){return this._enabled?this.isDown(t):!1}isDragStart(t){return this._enabled?this.isDown(t)&&!this.wasDown(t):!1}isDragEnd(t){return this._enabled?!this.isDown(t)&&this.wasDown(t):!1}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const t of this.currentFrameDown){if(!t.active)continue;this.emit("down",t),this.at(t.pointerId).emit("down",t),this.primary.emit("pointerdown",t)}for(const t of this.currentFrameUp){if(!t.active)continue;this.emit("up",t),this.at(t.pointerId).emit("up",t)}for(const t of this.currentFrameMove){if(!t.active)continue;this.emit("move",t),this.at(t.pointerId).emit("move",t)}for(const t of this.currentFrameCancel){if(!t.active)continue;this.emit("cancel",t),this.at(t.pointerId).emit("cancel",t)}for(const t of this.currentFrameWheel)t.active&&(this.emit("pointerwheel",t),this.emit("wheel",t),this.primary.emit("pointerwheel",t),this.primary.emit("wheel",t));if(this.engine.currentScene.camera.hasChanged())for(const t of this._pointers)t._updateWorldPosition(this.engine)}clear(){for(const t of this.currentFrameUp){this.currentFramePointerCoords.delete(t.pointerId);const i=this._activeNativePointerIdsToNormalized.entries();for(const[n,o]of i)o===t.pointerId&&this._activeNativePointerIdsToNormalized.delete(n)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(t){var i;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const n={passive:!(this.engine.pageScrollPreventionMode===tn.All||this.engine.pageScrollPreventionMode===tn.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,n):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,n):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,n),((i=t?.grabWindowFocus)!==null&&i!==void 0?i:!0)&&Ug()){const h=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",h):(this.target.addEventListener("touchstart",h),this.target.addEventListener("mousedown",h))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(t){this._activeNativePointerIdsToNormalized.set(t,-1);const n=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((o,h)=>o-h).findIndex(o=>o===t);return this._activeNativePointerIdsToNormalized.set(t,n),n}_handle(t){if(!this._enabled)return;t.preventDefault();const i=new Map;let n,o;if(iw(t)){n=Ts.Unknown,o=Is.Touch;for(let h=0;h<t.changedTouches.length;h++){const c=t.changedTouches[h],g=ar.fromPagePosition(c.pageX,c.pageY,this.engine),_=h+1,v=this._normalizePointerId(_);this.currentFramePointerCoords.set(v,g),i.set(v,g)}}else{n=this._nativeButtonToPointerButton(t.button),o=Is.Mouse;const h=ar.fromPagePosition(t.pageX,t.pageY,this.engine);let c=1;sw(t)&&(c=t.pointerId,o=this._stringToPointerType(t.pointerType));const g=this._normalizePointerId(c);this.currentFramePointerCoords.set(g,h),i.set(g,h)}for(const[h,c]of i.entries())switch(t.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new qr("down",h,n,o,c,t)),this.currentFramePointerDown.set(h,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new qr("up",h,n,o,c,t)),this.currentFramePointerDown.set(h,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new qr("move",h,n,o,c,t));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new qr("cancel",h,n,o,c,t));break}}_handleWheel(t){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===tn.All||this.engine.pageScrollPreventionMode===tn.Canvas&&t.target===this.engine.canvas)&&t.preventDefault();const i=this.engine.screen.pageToScreenCoordinates(N(t.pageX,t.pageY)),n=this.engine.screen.screenToWorldCoordinates(i),o=-1/40,h=t.deltaX||t.wheelDeltaX*o||0,c=t.deltaY||t.wheelDeltaY*o||t.wheelDelta*o||t.detail||0,g=t.deltaZ||0;let _=nr.Pixel;t.deltaMode&&(t.deltaMode===1?_=nr.Line:t.deltaMode===2&&(_=nr.Page));const v=new Hg(n.x,n.y,t.pageX,t.pageY,i.x,i.y,0,h,c,g,_,t);this.currentFrameWheel.push(v)}triggerEvent(t,i){const n=this.engine.screen.worldToPageCoordinates(i);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+t,{pointerId:0,clientX:n.x,clientY:n.y})):this._handle(new window.MouseEvent("mouse"+t,{clientX:n.x,clientY:n.y}));const o=this.engine.currentScene.world.get(Ga);o.preupdate(this.engine.currentScene,1),o.update(1)}_nativeButtonToPointerButton(t){switch(t){case Ks.NoButton:return Ts.NoButton;case Ks.Left:return Ts.Left;case Ks.Middle:return Ts.Middle;case Ks.Right:return Ts.Right;case Ks.Unknown:return Ts.Unknown;default:return Pf(t)}}_stringToPointerType(t){switch(t){case"touch":return Is.Touch;case"mouse":return Is.Mouse;case"pen":return Is.Pen;default:return Is.Unknown}}}class td{constructor(t){this._enabled=!0;const{pointerTarget:i,grabWindowFocus:n,engine:o}=t;this.keyboard=new zg,this.pointers=new qa(i,o),this.gamepads=new Xa,this.keyboard.init({grabWindowFocus:n}),this.pointers.init({grabWindowFocus:n}),this.gamepads.init(),this.inputMapper=new Lg({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(t){this._enabled=t,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class nw{}const rw={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function ss(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class Si{get actors(){return this.world.entityManager.entities.filter(t=>t instanceof si)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(t=>t instanceof Eg)}get tileMaps(){return this.world.entityManager.entities.filter(t=>t instanceof vg)}get timers(){return this._timers}constructor(){this._logger=ut.getInstance(),this.events=new $t,this.camera=new Pg,this.world=new Fg(this),this.physics=new kg(ks()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(Jc),this.world.add(new Wa(this.world,this.physics)),this.world.add(new Na(this.world,this.physics)),this.world.add(Ga),this.world.add(Kc),this.world.add($c),this.world.add(Yc),this.world.add(jc)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}onPreLoad(t){}onTransition(t){}onInitialize(t){}onActivate(t){}onDeactivate(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreDraw(t,i){}onPostDraw(t,i){}_initializeChildren(){for(const t of this.entities)t._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(t){var i;if(!this.isInitialized){try{this.engine=t,this.physics.config=this.engine.physics,this.input=new td({pointerTarget:t.pointerScope===kn.Canvas?t.canvas:document,grabWindowFocus:t.grabWindowFocus,engine:t}),this.camera._initialize(t),this.world.systemManager.initialize(),await this.onInitialize(t),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,t),this.events.emit("initialize",new mr(t,this))}catch(n){throw this._logger.error(`Error during scene initialization for scene ${(i=t.director)===null||i===void 0?void 0:i.getSceneName(this)}!`),n}this._isInitialized=!0}}async _activate(t){var i,n;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(t)}catch(o){throw this._logger.error(`Error during scene activation for scene ${(n=(i=this.engine)===null||i===void 0?void 0:i.director)===null||n===void 0?void 0:n.getSceneName(this)}!`),o}}async _deactivate(t){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(t)}_preupdate(t,i){this.emit("preupdate",new nn(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.emit("postupdate",new rn(t,i,this)),this.onPostUpdate(t,i)}_predraw(t,i){this.emit("predraw",new pr(t,i,this)),this.onPreDraw(t,i)}_postdraw(t,i){this.emit("postdraw",new _r(t,i,this)),this.onPostDraw(t,i)}update(t,i){var n;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(n=t.director)===null||n===void 0?void 0:n.getSceneName(this)}!`);return}this._preupdate(t,i);let o,h;for(o=0,h=this._cancelQueue.length;o<h;o++)this.removeTimer(this._cancelQueue[o]);this._cancelQueue.length=0;for(const c of this._timers)c.update(i);this.world.update(bi.Update,i),this.camera&&this.camera.update(t,i),this._collectActorStats(t),this._postupdate(t,i),this.input.update()}draw(t,i){var n;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(t,i),this.world.update(bi.Draw,i),!((n=this.engine)===null||n===void 0)&&n.isDebug&&this.debugDraw(t),this._postdraw(t,i)}debugDraw(t){this.emit("predebugdraw",new vc(t,this)),this.emit("postdebugdraw",new wc(t,this))}contains(t){return this.actors.indexOf(t)>-1}add(t){if(this.emit("entityadded",{target:t}),t instanceof Fn){Sf(this._timers,t)||this.addTimer(t);return}this.world.add(t),t.scene=this}transfer(t){let i;t instanceof Qe&&t.scene&&t.scene!==this&&(i=t.scene,t.scene.world.remove(t,!1)),t instanceof Fn&&t.scene&&(i=t.scene,t.scene.removeTimer(t)),i?.emit("entityremoved",{target:t}),this.add(t)}remove(t){this.emit("entityremoved",{target:t}),t instanceof Qe&&(t.isActive&&t.kill(),this.world.remove(t)),t instanceof Fn&&this.removeTimer(t)}clear(t=!0){for(let i=this.entities.length-1;i>=0;i--)this.world.remove(this.entities[i],t);for(let i=this.timers.length-1;i>=0;i--)this.removeTimer(this.timers[i])}addTimer(t){return this._timers.push(t),t.scene=this,t}removeTimer(t){const i=this._timers.indexOf(t);return i!==-1&&this._timers.splice(i,1),t}cancelTimer(t){return this._cancelQueue.push(t),t}isTimerActive(t){return this._timers.indexOf(t)>-1&&!t.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(t){const i=this.actors;for(let n=0;n<i.length;n++){const o=i[n];o instanceof Xc&&t.stats.currFrame.actors.ui++,t.stats.currFrame.actors.alive++;for(let h=0;h<o.children.length;h++){const c=o.children[h];mg(c)?t.stats.currFrame.actors.ui++:t.stats.currFrame.actors.alive++}}}}var Mn;(function(d){d.Protanope="Protanope",d.Deuteranope="Deuteranope",d.Tritanope="Tritanope"})(Mn||(Mn={}));const ow=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class Og{constructor(t,i){this._shader=new gi({gl:t,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:i}),this._shader.compile(),this._buffer=new fs({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Hs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class Vg{constructor(t,i=!1){this._colorBlindnessMode=t,this._simulate=!1,this._simulate=i}initialize(t){this._shader=new Og(t,ow),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(t){if(this._colorBlindnessMode=t,this._shader){const i=this._shader.getShader();i.use(),this._colorBlindnessMode===Mn.Protanope?i.setUniformInt("u_type",0):this._colorBlindnessMode===Mn.Deuteranope?i.setUniformInt("u_type",1):this._colorBlindnessMode===Mn.Tritanope&&i.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(t){if(this._simulate=t,this._shader){const i=this._shader.getShader();i.use(),i.setUniformBoolean("u_simulate",t)}}get simulate(){return this._simulate}}class Wg{constructor(t){this._engine=t,this._colorBlindPostProcessor=new Vg(Mn.Protanope)}correct(t){this._engine.graphicsContext instanceof Bs&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(t){this._engine.graphicsContext instanceof Bs&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class Ng{constructor(t){this.stats={currFrame:new oo,prevFrame:new oo},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:$.Yellow,showZIndex:!1,showScale:!1,scaleColor:$.Green,showRotation:!1,rotationColor:$.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:$.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:$.Blue,showOwner:!1,showGeometry:!0,geometryColor:$.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:$.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:$.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:$.Yellow,showAcceleration:!1,accelerationColor:$.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:$.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:$.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:$.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:$.Yellow,positionSize:1,showGrid:!1,gridColor:$.Red,gridWidth:1,showColliderGeometry:!0},this._engine=t,this.colorBlindMode=new Wg(this._engine)}useTestClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const n=t.toTestClock();return i&&n.start(),this._engine.clock=n,n}useStandardClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const n=t.toStandardClock();return i&&n.start(),this._engine.clock=n,n}}class oo{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new Ya,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(t){t?(this.id=t.id,this.elapsedMs=t.elapsedMs,this.fps=t.fps,this.actors.alive=t.actors.alive,this.actors.killed=t.actors.killed,this.actors.ui=t.actors.ui,this.duration.update=t.duration.update,this.duration.draw=t.duration.draw,this._physicsStats.reset(t.physics),this.graphics.drawCalls=t.graphics.drawCalls,this.graphics.drawnImages=t.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const t=new oo;return t.reset(this),t}get id(){return this._id}set id(t){this._id=t}get elapsedMs(){return this._elapsedMs}set elapsedMs(t){this._elapsedMs=t}get fps(){return this._fps}set fps(t){this._fps=t}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class Ya{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(t){t?(this.pairs=t.pairs,this.collisions=t.collisions,this.contacts=t.contacts,this.fastBodies=t.fastBodies,this.fastBodyCollisions=t.fastBodyCollisions,this.broadphase=t.broadphase,this.narrowphase=t.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const t=new Ya;return t.reset(this),t}get pairs(){return this._pairs}set pairs(t){this._pairs=t}get collisions(){return this._collisions}set collisions(t){this._collisions=t}get contacts(){return this._contacts}set contacts(t){this._contacts=t}get fastBodies(){return this._fastBodies}set fastBodies(t){this._fastBodies=t}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(t){this._fastBodyCollisions=t}get broadphase(){return this._broadphase}set broadphase(t){this._broadphase=t}get narrowphase(){return this._narrowphase}set narrowphase(t){this._narrowphase=t}}class Zl{on(t,i){this._nativeHandlers[t]&&this.off(t,this._nativeHandlers[t]),this._nativeHandlers[t]=this._decorate(i),this.nativeComponent.addEventListener(t,this._nativeHandlers[t])}off(t,i){i||(i=this._nativeHandlers[t]),this.nativeComponent.removeEventListener(t,i),this._nativeHandlers[t]=null}_decorate(t){return i=>{this._paused||t(i)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const t in this._nativeHandlers)this.off(t)}constructor(t){this.nativeComponent=t,this._paused=!1,this._nativeHandlers={}}}class Gg{constructor(t,i){this._windowGlobal=t,this._documentGlobal=i,this._windowComponent=new Zl(this._windowGlobal),this._documentComponent=new Zl(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const Xg={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:be.Blended,canvasImageRendering:"auto"},qg={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:be.Blended,canvasImageRendering:"auto"};class Yg{constructor(t){var i;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=t.initialFps,this._samplePeriod=(i=t.samplePeriod)!==null&&i!==void 0?i:this._samplePeriod,this._currentFrameTime=1e3/t.initialFps,this._nowFn=t.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const t=this._nowFn();this._currentFrameTime=t-this._beginFrameTime,t>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(t-this._previousSampleTime),this._previousSampleTime=t,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class ed{constructor(t){var i,n,o;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=t,this.tick=t.tick,this._lastTime=(i=this.now())!==null&&i!==void 0?i:0,this._maxFps=(n=t.maxFps)!==null&&n!==void 0?n:this._maxFps,this._onFatalException=(o=t.onFatalException)!==null&&o!==void 0?o:this._onFatalException,this.fpsSampler=new Yg({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new jg({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new id({...this._options})}setFatalExceptionHandler(t){this._onFatalException=t}schedule(t,i=0,n="preframe"){const o=this._totalElapsed+i;this._scheduledCbs.push([t,o,n])}__runScheduledCbs(t="preframe"){for(let i=this._scheduledCbs.length-1;i>-1;i--)t===this._scheduledCbs[i][2]&&this._scheduledCbs[i][1]<=this._totalElapsed&&(this._scheduledCbs[i][0](this._elapsed),this._scheduledCbs.splice(i,1))}update(t){try{this.fpsSampler.start();const i=this.now();let n=i-this._lastTime||1;const o=1e3/this._maxFps;if(n>=o){let h=0;o!==0&&(h=n%o,n=n-h),n>200&&(n=1),this._elapsed=t||n,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(t||n),this.__runScheduledCbs("postframe"),o!==0?this._lastTime=i-h:this._lastTime=i,this.fpsSampler.end()}}catch(i){this._onFatalException(i),this.stop()}}}class id extends ed{constructor(t){super(t),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const t=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(t),this.update()}catch(i){throw window.cancelAnimationFrame(this._requestId),i}};t()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class jg extends ed{constructor(t){super({...t}),this._logger=ut.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=t.defaultUpdateMs}now(){var t;return(t=this._currentTime)!==null&&t!==void 0?t:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(t){const i=t??this._updateMs;this._running?(this.update(i),this._currentTime+=i):this._logger.warn("The clock is not running, no step will be performed")}run(t,i){for(let n=0;n<t;n++)this.step(i??this._updateMs)}}var aw=Fe(296);class Qg{constructor(){this._toasterCss=aw.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(t){const i=document.createElement("span");return i.innerText=t,i}toast(t,i,n){this._initialize();const o=document.createElement("div");o.className="ex-toast-message";const h=t.split("[LINK]").map(x=>this._createFragment(x));if(i){const x=document.createElement("a");x.href=i,n?x.innerText=n:x.innerText=i,h.splice(1,0,x)}const c=document.createElement("div");h.forEach(x=>{c.appendChild(x)}),o.appendChild(c);const g=document.createElement("button");g.innerText="x",g.addEventListener("click",()=>{this._container.removeChild(o)}),o.appendChild(g);const _=x=>{if(x.key==="Escape")try{this._container.removeChild(o)}catch{}document.removeEventListener("keydown",_)};document.addEventListener("keydown",_);const v=this._container.firstChild;this._container.insertBefore(o,v)}}const hw={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class Zg{get isTransitioning(){return this._isTransitioning}constructor(t,i){this._engine=t,this.events=new $t,this._logger=ut.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new Si,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const n in i){const o=i[n];this.add(n,o),n==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const t=this._deferredGoto;this._deferredGoto=void 0;const i=this._deferredTransition;this._deferredTransition=void 0;const n=this.getSceneInstance(t);n&&i&&i._addToTargetScene(this._engine,n),await this.swapScene(t),n&&i&&await this.playTransition(i,n)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(t,i){const n=i?.loader;n instanceof $r?this.mainLoader=n:Hl(n)?this.mainLoader=new n:this.mainLoader=new Hn;let o;if(i?.inTransition){const{inTransition:h}=i;o=h}if(this.startScene=t,o){const h=this.getSceneInstance(this.startScene);h&&(o._addToTargetScene(this._engine,h),this.swapScene(this.startScene).then(()=>this.playTransition(o,h)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(t){return this._sceneToLoader.get(t)}_getInTransition(t){var i;const n=this.scenes[t];if(!(n instanceof Si||ss(n)))return(i=n?.transitions)===null||i===void 0?void 0:i.in}_getOutTransition(t){var i;const n=this.scenes[t];if(!(n instanceof Si||ss(n)))return(i=n?.transitions)===null||i===void 0?void 0:i.out}getDeferredScene(){const t=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&t?t:null}getSceneDefinition(t){const i=this.scenes[t];if(i instanceof Si||ss(i))return i;if(i)return i.scene}getSceneName(t){for(const[i,n]of Object.entries(this.scenes))if(n instanceof Si){if(t===n)return i}else if(!ss(n)&&t===n.scene)return i;for(const[i,n]of Object.entries(this.scenes))if(ss(n)){if(t.constructor===n)return i}else if(!(n instanceof Si)&&t.constructor===n.scene)return i;return null}assertAdded(t){return this}assertRemoved(t){return this}add(t,i){if(!(i instanceof Si)&&!ss(i)){const{loader:n,transitions:o}=i,{in:h,out:c}=o??{};this._sceneToTransition.set(t,{in:h,out:c}),Hl(n)?this._sceneToLoader.set(t,new n):n&&this._sceneToLoader.set(t,n)}return this.scenes[t]&&this._logger.warn("Scene",t,"already exists overwriting"),this.scenes[t]=i,this.assertAdded(t)}remove(t){if(t instanceof Si||ss(t)){const i=t;for(const n in this.scenes)if(this.scenes.hasOwnProperty(n)){const o=this.scenes[n];let h;if(o instanceof Si||ss(o)?h=o:h=o.scene,h===i){if(n===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${n}`);this._sceneToInstance.delete(n),this._sceneToTransition.delete(n),this._sceneToLoader.delete(n),delete this.scenes[n]}}}if(typeof t=="string"){if(t===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${t}`);this._sceneToInstance.delete(t),this._sceneToTransition.delete(t),this._sceneToLoader.delete(t),delete this.scenes[t]}}async goToScene(t,i){var n,o,h,c,g,_;const v=this.getSceneInstance(t);if(!v){this._logger.warn(`Scene ${t} does not exist! Check the name, are you sure you added it?`);return}const x=this.currentScene,A=this.currentSceneName,S=(o=(n=this._engine.input)===null||n===void 0?void 0:n.enabled)!==null&&o!==void 0?o:!0;this._isTransitioning=!0;const P=(h=this.getSceneInstance(A))===null||h===void 0?void 0:h.onTransition("out"),I=v?.onTransition("in");i={sourceOut:(c=this._getOutTransition(this.currentSceneName))!==null&&c!==void 0?c:P,destinationIn:(g=this._getInTransition(t))!==null&&g!==void 0?g:I,...i};const{sourceOut:F,destinationIn:R,sceneActivationData:E}=i,M=F??this._getOutTransition(this.currentSceneName),V=R??this._getInTransition(t),L=M?.hideLoader||V?.hideLoader;L&&this.maybeLoadScene(t,L),this._emitEvent("navigationstart",A,t),M&&await this.playTransition(M,x),await this.maybeLoadScene(t,L),V&&await V.onPreviousSceneDeactivate(this.currentScene),V&&V._addToTargetScene(this._engine,v),await this.swapScene(t,E),this._emitEvent("navigation",A,t),V&&await this.playTransition(V,v),this._emitEvent("navigationend",A,t),(_=this._engine.input)===null||_===void 0||_.toggleEnabled(S),this._isTransitioning=!1}getSceneInstance(t){const i=this.getSceneDefinition(t);if(!i)return;if(this._sceneToInstance.has(t))return this._sceneToInstance.get(t);if(i instanceof Si)return this._sceneToInstance.set(t,i),i;const n=new i;return this._sceneToInstance.set(t,n),n}async maybeLoadScene(t,i=!1){var n;const o=(n=this._getLoader(t))!==null&&n!==void 0?n:new $r,h=this.getSceneDefinition(t),c=this.getSceneInstance(t);h&&c&&!this._loadedScenes.has(c)&&(c.onPreLoad(o),c.events.emit("preload",{loader:o}),i?this._engine.load(o,i):await this._engine.load(o),this._loadedScenes.add(c))}async playTransition(t,i){var n,o,h,c,g,_,v;if(!this.isInitialized){this._deferredTransition=t;return}if(t){this.currentTransition=t;const x=(o=(n=i.input)===null||n===void 0?void 0:n.enabled)!==null&&o!==void 0?o:!0;(h=i.input)===null||h===void 0||h.toggleEnabled(!t.blockInput),(c=this._engine.input)===null||c===void 0||c.toggleEnabled(!t.blockInput),this.currentTransition._addToTargetScene(this._engine,i),await this.currentTransition._play(),(g=i.input)===null||g===void 0||g.toggleEnabled(x)}(_=this.currentTransition)===null||_===void 0||_.kill(),(v=this.currentTransition)===null||v===void 0||v.reset(),this.currentTransition=void 0}async swapScene(t,i){const n=this._engine;if(!this.isInitialized){this._deferredGoto=t;return}const o=this.getSceneInstance(t);if(o){const h=this.currentScene,c=o;if(this._logger.debug("Going to scene:",t),this.currentScene.isInitialized){const v={engine:n,previousScene:h,nextScene:c};await this.currentScene._deactivate(v),this.currentScene.events.emit("deactivate",new Ic(v,this.currentScene)),this.currentScene.input.clear()}const g=this._sceneToLoader.get(t);await g?.areResourcesLoaded(),this.currentScene=c,this.currentSceneName=t,n.screen.setCurrentCamera(c.camera),await this.currentScene._initialize(n);const _={engine:n,previousScene:h,nextScene:c,data:i};await this.currentScene._activate(_),this.currentScene.events.emit("activate",new Tc(_,this.currentScene))}else this._logger.error("Scene",t,"does not exist!")}_emitEvent(t,i,n){const o=this.getSceneDefinition(i),h=this.getSceneDefinition(n);this.events.emit(t,{sourceScene:o,sourceName:i,destinationScene:h,destinationName:n})}}function Jg(){const d={scope:(t,i)=>{const n=d.value;d.value=t;try{return i()}catch(o){throw o}finally{d.value=n}},value:void 0};return d}function Kg(d){return d.value}const Jl={textureCollectInterval:6e4};class $g{constructor(t){this.options=t,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=i=>{if(this._running){for(const[n,[o,h]]of this._collectors.entries()){const c=this.options.getTimestamp();for(const[g,[_,v]]of this._collectionMap.entries()){if(n!==_||v+h>=c)continue;o(g)&&this._collectionMap.delete(g)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(t,i,n){this._collectors.set(t,[n,i])}addCollectableResource(t,i){this._collectionMap.set(i,[t,this.options.getTimestamp()])}touch(t){const i=this._collectionMap.get(t);i&&this._collectionMap.set(t,[i[0],this.options.getTimestamp()])}forceCollectAll(){for(const[t,[i]]of this._collectors.entries())for(const[n]of this._collectionMap.entries())i(n)&&this._collectionMap.delete(n)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}Af();const lw={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var tn;(function(d){d[d.None=0]="None",d[d.Canvas=1]="Canvas",d[d.All=2]="All"})(tn||(tn={}));class hi{static useEngine(){const t=Kg(hi.Context);if(!t)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return t}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(t){this.graphicsContext.snapToPixel=t}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,n,o,h,c,g,_,v,x;this.scope=L=>hi.Context.scope(this,L),this.version=Kl,this.events=new $t,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=L=>{ut.getInstance().fatal(L,L.stack)},this._toaster=new Qg,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=L=>{var G;L.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",L);const j=document.createElement("div");j.id="ex-webgl-graphics-context-lost",j.style.position="absolute",j.style.zIndex="99",j.style.left="50%",j.style.top="50%",j.style.display="flex",j.style.flexDirection="column",j.style.transform="translate(-50%, -50%)",j.style.backgroundColor="white",j.style.padding="10px",j.style.borderStyle="solid 1px";const X=document.createElement("div");if(X.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,j.appendChild(X),!((G=this.canvas)===null||G===void 0)&&G.parentElement){this.canvas.parentElement.appendChild(j);const rt=X.querySelector("#ex-webgl-graphics-reload");rt?.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new Pi,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],t={...hi._DEFAULT_ENGINE_OPTIONS,...t},this._originalOptions=t,Le.freeze(),this.browser=new Gg(window,document);const A=new Of;if(!t.suppressMinimumBrowserFeatureDetection&&!(this._compatible=A.test())){const L=document.createElement("div");if(L.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(L),A.failedTests.forEach(function(G){const j=document.createElement("div");j.innerText="Browser feature missing "+G,document.body.appendChild(j)}),t.canvasElementId){const G=document.getElementById(t.canvasElementId);G&&G.parentElement.removeChild(G)}return}else this._compatible=!0;if(console.log&&!t.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${Kl})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),t.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=ut.getInstance(),this._logger.defaultLevel===ye.Debug&&A.logBrowserFeatures(),this._logger.debug("Building engine..."),t.garbageCollection===!0?this.garbageCollectorConfig={...Jl}:t.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...Jl,...t.garbageCollection},this._garbageCollector=new $g({getTimestamp:Date.now}),this.canvasElementId=t.canvasElementId,t.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+t.canvasElementId),document.getElementById(t.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(t.canvasElementId)}else t.canvasElement?(this._logger.debug("Using Canvas element specified:",t.canvasElement),this.canvas=t.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!t.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",L=>{L.preventDefault()});let S=(i=t.displayMode)!==null&&i!==void 0?i:Ie.Fixed;t.width&&t.height||t.viewport?(t.displayMode===void 0&&(S=Ie.Fixed),this._logger.debug("Engine viewport is size "+t.width+" x "+t.height)):t.displayMode||(this._logger.debug("Engine viewport is fit"),S=Ie.FitScreen),this.grabWindowFocus=t.grabWindowFocus,this.pointerScope=t.pointerScope,this._originalDisplayMode=S;let P,I,F,R,E,M;typeof t.antialiasing=="object"?{pixelArtSampler:P,nativeContextAntialiasing:F,multiSampleAntialiasing:M,filtering:E,canvasImageRendering:R}={...t.pixelArt?qg:Xg,...t.antialiasing}:(P=!!t.pixelArt,F=!1,M=t.antialiasing,R=t.antialiasing?"auto":"pixelated",E=t.antialiasing?be.Blended:be.Pixel),F&&M&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),t.pixelArt&&(I=.25),(!t.antialiasing||E===be.Pixel)&&(I=0),I=(o=(n=t.uvPadding)!==null&&n!==void 0?n:I)!==null&&o!==void 0?o:.01;let V=Le.isEnabled("use-canvas-context");if(!V)try{this.graphicsContext=new Bs({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:P,antialiasing:F,multiSampleAntialiasing:M,uvPadding:I,powerPreference:t.powerPreference,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(h=t.handleContextLost)!==null&&h!==void 0?h:this._handleWebGLContextLost,handleContextRestored:t.handleContextRestored})}catch(L){this._logger.warn(`Excalibur could not load webgl for some reason (${L.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),V=!0}V&&(this.graphicsContext=new Sa({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:F,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting})),this.screen=new zl({canvas:this.canvas,context:this.graphicsContext,antialiasing:F,canvasImageRendering:R,browser:this.browser,viewport:(c=t.viewport)!==null&&c!==void 0?c:t.width&&t.height?{width:t.width,height:t.height}:Ul.SVGA,resolution:t.resolution,displayMode:S,pixelRatio:t.suppressHiDPIScaling?1:(g=t.pixelRatio)!==null&&g!==void 0?g:null}),oe.filtering=E,t.backgroundColor&&(this.backgroundColor=t.backgroundColor.clone()),this.maxFps=(_=t.maxFps)!==null&&_!==void 0?_:this.maxFps,this.fixedUpdateTimestep=(v=t.fixedUpdateTimestep)!==null&&v!==void 0?v:this.fixedUpdateTimestep,this.fixedUpdateFps=(x=t.fixedUpdateFps)!==null&&x!==void 0?x:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new id({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:L=>this.onFatalException(L)}),this.enableCanvasTransparency=t.enableCanvasTransparency,typeof t.physics=="boolean"?this.physics={...ks(),enabled:t.physics}:(this.physics={...ks()},ga(this.physics,t.physics)),this.debug=new Ng(this),this.director=new Zg(this,t.scenes),this._initialize(t),window.___EXCALIBUR_DEVTOOL=this,hi.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:t}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:i,showPlayerMessage:n}=this._originalOptions.configurePerformanceCanvas2DFallback;if(i===void 0&&(i=hi._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),n===void 0&&(n=hi._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!Le.isEnabled("use-canvas-context")&&t&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===i.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let o=0;for(let c=0;c<this._fpsSamples.length;c++)o+=this._fpsSamples[c];const h=o/this._fpsSamples.length;this._fpsSamples.length===i.numberOfFrames&&h<=i.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),n&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var t,i,n;const o=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(o,this.canvas),this.canvas=o;const h={...this._originalOptions,antialiasing:this.screen.antialiasing},c=this._originalDisplayMode;this.graphicsContext=new Sa({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:h.antialiasing,backgroundColor:h.backgroundColor,snapToPixel:h.snapToPixel,useDrawSorting:h.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new zl({canvas:this.canvas,context:this.graphicsContext,antialiasing:(t=h.antialiasing)!==null&&t!==void 0?t:!0,browser:this.browser,viewport:(i=h.viewport)!==null&&i!==void 0?i:h.width&&h.height?{width:h.width,height:h.height}:Ul.SVGA,resolution:h.resolution,displayMode:c,pixelRatio:h.suppressHiDPIScaling?1:(n=h.pixelRatio)!==null&&n!==void 0?n:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const g=h&&h.pointerScope===kn.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(g,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,hi.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(t){if(t<0){ut.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=t}addTimer(t){return this.currentScene.addTimer(t)}removeTimer(t){return this.currentScene.removeTimer(t)}addScene(t,i){return this.director.add(t,i),this}removeScene(t){this.director.remove(t)}add(t){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const i=this.director.getDeferredScene();i instanceof Si?i.add(t):this.currentScene.add(t)}remove(t){t instanceof Qe&&this.currentScene.remove(t),(t instanceof Si||ss(t))&&this.removeScene(t),typeof t=="string"&&this.removeScene(t)}async goToScene(t,i){await this.scope(async()=>{await this.director.goToScene(t,i)})}screenToWorldCoordinates(t){return this.screen.screenToWorldCoordinates(t)}worldToScreenCoordinates(t){return this.screen.worldToScreenCoordinates(t)}_initialize(t){var i,n;this.pageScrollPreventionMode=t.scrollPreventionMode;const o=t&&t.pointerScope===kn.Document?document:this.canvas,h=(n=(i=this._originalOptions)===null||i===void 0?void 0:i.grabWindowFocus)!==null&&n!==void 0?n:!0;this.input=new td({pointerTarget:o,grabWindowFocus:h,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new Ec(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new Pc(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!t.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(t){this._inputEnabled=t,this.input.toggleEnabled(this._inputEnabled)}onInitialize(t){}get isInitialized(){return this._isInitialized}async _overrideInitialize(t){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(t),this.events.emit("initialize",new mr(t,this)),this._isInitialized=!0)}_update(t){var i;if(this._isLoading){(i=this._loader)===null||i===void 0||i.onUpdate(this,t),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(t),this.currentScene.update(this,t),this.graphicsContext.updatePostProcessors(t),this.clock.__runScheduledCbs("postupdate"),this._postupdate(t),this.input.update()}_preupdate(t){this.emit("preupdate",new nn(this,t,this)),this.onPreUpdate(this,t)}onPreUpdate(t,i){}_postupdate(t){this.emit("postupdate",new rn(this,t,this)),this.onPostUpdate(this,t)}onPostUpdate(t,i){}_draw(t){var i,n;if(this.graphicsContext.backgroundColor=(i=this.currentScene.backgroundColor)!==null&&i!==void 0?i:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,t),this._isLoading){this._hideLoader||((n=this._loader)===null||n===void 0||n.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,t),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,t),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(t,i){this.emit("predraw",new pr(t,i,this)),this.onPreDraw(t,i)}onPreDraw(t,i){}_postdraw(t,i){this.emit("postdraw",new _r(t,i,this)),this.onPostDraw(t,i)}onPostDraw(t,i){}showDebug(t){this._isDebug=t}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(t,i){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let n;return t instanceof $r?n=t:typeof t=="string"&&(this.director.configureStart(t,i),n=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(n??new Hn),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new gc(this)),this._isReadyFuture.promise})}_mainloop(t){this.scope(()=>{this.emit("preframe",new xc(this,this.stats.prevFrame));const i=t*this.timescale;this.currentFrameElapsedMs=i;const n=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=n,this.stats.currFrame.elapsedMs=i,this.stats.currFrame.fps=this.clock.fpsSampler.fps,Kt.clear();const o=this.clock.now(),h=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=i;this._lagMs>=h;)this._update(h),this._lagMs-=h;else this._update(i);const c=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(i);const g=this.clock.now();this.stats.currFrame.duration.update=c-o,this.stats.currFrame.duration.draw=g-c,this.stats.currFrame.graphics.drawnImages=Kt.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=Kt.DrawCallCount,this.emit("postframe",new Ac(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new pc(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(t=!1){return new Promise(n=>{this._screenShotRequests.push({preserveHiDPIResolution:t,resolve:n})})}_checkForScreenShots(){for(const t of this._screenShotRequests){const i=t.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,n=t.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,o=document.createElement("canvas");o.width=i,o.height=n;const h=o.getContext("2d");h.imageSmoothingEnabled=this.screen.antialiasing,h.drawImage(this.canvas,0,0,i,n);const c=new Image,g=o.toDataURL("image/png");c.onload=()=>{t.resolve(c)},c.src=g}this._screenShotRequests.length=0}async load(t,i=!1){await this.scope(async()=>{try{if(t.isLoaded())return;this._loader=t,this._isLoading=!0,this._hideLoader=i,t instanceof Hn&&(t.suppressPlayButton=t.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await t.load()}catch(n){this._logger.error("Error loading resources, things may not behave properly",n),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}hi.Context=Jg();hi.InstanceCount=0;hi._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:kn.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:tn.Canvas,backgroundColor:$.fromHex("#2185d0")};class cw extends si{set maxWidth(t){this._text.maxWidth=t}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(t){this._font=t,this._text.font=t}get text(){return this._text.text}set text(t){this._text.text=t}get color(){return this._text.color}set color(t){this._text&&(this._text.color=t)}get opacity(){return this.graphics.opacity}set opacity(t){this.graphics.opacity=t}get spriteFont(){return this._spriteFont}set spriteFont(t){t&&(this._spriteFont=t,this._text.font=this._spriteFont)}constructor(t){super(t),this._font=new Ln,this._text=new fo({text:"",font:this._font});const{text:i,pos:n,x:o,y:h,spriteFont:c,font:g,color:_,maxWidth:v}={text:"",...t};this.pos=n??(o&&h?N(o,h):this.pos),this.text=i??this.text,this.font=g??this.font,this.maxWidth=v??this.maxWidth,this.spriteFont=c??this.spriteFont,this._text.color=_??this.color;const x=this.get(ce);x.anchor=k.Zero,x.use(this._text)}_initialize(t){super._initialize(t)}getTextWidth(){return this._text.width}}var en;(function(d){d.Circle="circle",d.Rectangle="rectangle"})(en||(en={}));class dw extends si{constructor(t){var i,n;super({width:(i=t.width)!==null&&i!==void 0?i:0,height:(n=t.height)!==null&&n!==void 0?n:0}),this._particlesToEmit=0,this._particlePool=new ho(()=>new La({}),I=>I,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=en.Rectangle,this.radius=0,this.particle={life:2e3,transform:Yi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:o,x:h,y:c,z:g,pos:_,isEmitting:v,emitRate:x,emitterType:A,radius:S,random:P}={...t};this.particle={...this.particle,...o},this.pos=_??N(h??0,c??0),this.z=g??0,this.isEmitting=v??this.isEmitting,this.emitRate=x??this.emitRate,this.emitterType=A??this.emitterType,this.radius=S??this.radius,this.body.collisionType=gt.PreventCollision,this.random=P??new dr}removeParticle(t){this.deadParticles.push(t)}emitParticles(t){var i;if(!(t<=0)){t=t|0;for(let n=0;n<t;n++){const o=this._createParticle();!((i=this===null||this===void 0?void 0:this.scene)===null||i===void 0)&&i.world&&(this.particle.transform===Yi.Global?this.scene.world.add(o):this.addChild(o)),this._activeParticles.push(o)}}}clearParticles(){for(let t=0;t<this._activeParticles.length;t++)this.removeParticle(this._activeParticles[t])}_createParticle(){let t=0,i=0;const n=ns(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),o=ns(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),h=this.particle.startSize||ns(this.particle.minSize||5,this.particle.maxSize||5,this.random),c=o*Math.cos(n),g=o*Math.sin(n);if(this.emitterType===en.Rectangle)t=ns(0,this.width,this.random),i=ns(0,this.height,this.random);else if(this.emitterType===en.Circle){const v=ns(0,this.radius,this.random);t=v*Math.cos(n),i=v*Math.sin(n)}const _=this._particlePool.rent();return _.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:N(t,i),vel:N(c,g),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:h,graphic:this.particle.graphic,fade:this.particle.fade}),_.registerEmitter(this),this.particle.randomRotation&&(_.transform.rotation=ns(0,Math.PI*2,this.random)),this.particle.focus&&(_.focus=this.particle.focus.add(N(this.pos.x,this.pos.y)),_.focusAccel=this.particle.focusAccel),_}update(t,i){var n;super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let o=0;o<this.deadParticles.length;o++){!((n=this===null||this===void 0?void 0:this.scene)===null||n===void 0)&&n.world&&(this.scene.world.remove(this.deadParticles[o],!1),this._particlePool.return(this.deadParticles[o]));const h=this._activeParticles.indexOf(this.deadParticles[o]);h>-1&&this._activeParticles.splice(h,1)}this.deadParticles.length=0}}function uw(d,t){}class Ta{constructor(t,i,n){var o;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=t,this.particle=n,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=i,this._particleLife=(o=this.particle.life)!==null&&o!==void 0?o:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(t,i){if(this._initialized)return;const n=this.emitter.maxParticles,o=this._numInputFloats,h=this._particleData,c=4,g=t.createBuffer(),_=t.createVertexArray();t.bindVertexArray(_),t.bindBuffer(t.ARRAY_BUFFER,g),t.bufferData(t.ARRAY_BUFFER,n*o*c,t.DYNAMIC_DRAW),t.bufferSubData(t.ARRAY_BUFFER,0,h);let v=0;t.vertexAttribPointer(0,2,t.FLOAT,!1,o*c,0),v+=c*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*c,v),v+=c*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*c,v),v+=c*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(_),this._buffers.push(g),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null);const x=t.createBuffer(),A=t.createVertexArray();t.bindVertexArray(A),t.bindBuffer(t.ARRAY_BUFFER,x),t.bufferData(t.ARRAY_BUFFER,n*o*c,t.DYNAMIC_DRAW),v=0,t.vertexAttribPointer(0,2,t.FLOAT,!1,o*c,0),v+=c*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*c,v),v+=c*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*c,v),v+=c*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(A),this._buffers.push(x),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(t){const i=this._particleIndex,n=this.maxParticles*this._numInputFloats,o=t*this._numInputFloats+i;for(let h=i;h<o;h+=this._numInputFloats){const c=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||Ce),g=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),_=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),v=g*Math.cos(c),x=_*Math.sin(c);let A=0,S=0;if(this.emitter.emitterType===en.Rectangle)A=this._random.floating(-.5,.5)*this.emitter.width,S=this._random.floating(-.5,.5)*this.emitter.height;else{const F=this._random.floating(0,this.emitter.radius);A=F*Math.cos(c),S=F*Math.sin(c)}const P=this.emitter.transform.apply(N(A,S)),I=[this.particle.transform===Yi.Local?A:P.x,this.particle.transform===Yi.Local?S:P.y,v,x,this.particle.randomRotation?ns(0,Ce,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(I,h%this._particleData.length)}o>=n?(this._wrappedParticles+=(o-n)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=t),this._particleIndex=o%n,this._emitted.push([this._particleLife,i])}_uploadEmitted(t){this._particleIndex!==this._uploadIndex&&(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),t.bindBuffer(t.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(t){var i;if(this._particleLife=(i=this.particle.life)!==null&&i!==void 0?i:this._particleLife,this._wrappedLife>0?this._wrappedLife-=t:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let n=this._emitted.length-1;n>=0;n--){const o=this._emitted[n];o[0]-=t,o[0]<=0&&this._emitted.splice(n,1)}this._emitted.sort((n,o)=>n[0]-o[0])}}draw(t){if(this._initialized){if(this._clearRequested?(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData),t.bindBuffer(t.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(t),t.bindVertexArray(this._currentVao),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const i=this._emitted[0][1]/this._numInputFloats;t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-i)*this._numInputFloats*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,i,this.maxParticles-i),t.endTransformFeedback(),t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,i),t.endTransformFeedback()}else t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,this.maxParticles),t.endTransformFeedback();t.bindVertexArray(null),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}Ta.GPU_MAX_PARTICLES=1e5;class fw extends si{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get z(){return this.transform.z}set z(t){this.transform.z=t}constructor(t){super({name:"GpuParticleEmitter",width:t.width,height:t.height}),this.particle={life:2e3,transform:Yi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new ce,this.isEmitting=!1,this.emitRate=1,this.emitterType=en.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:i,maxParticles:n,x:o,y:h,z:c,pos:g,isEmitting:_,emitRate:v,emitterType:x,radius:A,random:S}={...t};this.maxParticles=St(n??this.maxParticles,0,Ta.GPU_MAX_PARTICLES),this.pos=g??N(o??0,h??0),this.z=c??0,this.isEmitting=_??this.isEmitting,this.emitRate=v??this.emitRate,this.emitterType=x??this.emitterType,this.radius=A??this.radius,this.particle={...this.particle,...i},this.random=S??new dr,this.renderer=new Ta(this,this.random,this.particle)}_initialize(t){super._initialize(t);const i=t.graphicsContext;this.renderer.initialize(i.__gl,i)}update(t,i){super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(i)}emitParticles(t){t<=0||this.renderer.emitParticles(t|0)}clearParticles(){this.renderer.clearParticles()}draw(t,i){t.draw("ex.particle",this.renderer,i)}}class tp extends Qe{getGraphics(){return this._graphics}addGraphic(t,i){this._graphics.push(t),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,i?.offset&&(this._gfx.offset=i.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let t=this._tileBounds.clone();for(const i of this._graphics){const n=N(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:i.height-this.map.tileHeight));t=t.combine(i.localBounds.translate(n))}return t}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&this._graphics.splice(i,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(N(this.x,this.y))}get center(){return this.pos.add(N(0,this.map.tileHeight/2))}constructor(t,i,n,o){super([new nt,new ce({offset:n??k.Zero,onPostDraw:(S,P)=>this.draw(S,P)}),new so(o)]),this.solid=!1,this.events=new $t,this._tileBounds=new ct,this._graphics=[],this._colliders=[],this.data=new Map,this.x=t,this.y=i,this.map=o,this._transform=this.get(nt),this._isometricEntityComponent=this.get(so);const h=this.map.tileWidth/2,c=this.map.tileHeight/2,g=(this.x-this.y)*h,_=(this.x+this.y)*c;this._transform.pos=N(g,_),this._isometricEntityComponent.elevation=o.elevation,this._gfx=this.get(ce),this._gfx.isVisible=!1;const v=this.map.tileWidth,x=this.map.tileHeight,A=N(0,this.map.renderFromTopOfGraphic?x:0);this._gfx.localBounds=this._tileBounds=new ct({left:-v/2,top:-x,right:v/2,bottom:x}).translate(A)}draw(t,i){const n=this.map.tileWidth/2;t.save(),t.translate(-n,0);for(const o of this._graphics)o.draw(t,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:o.height-this.map.tileHeight));t.restore()}}class gw extends Qe{get visible(){return this.isVisible}set visible(t){this.isVisible=t}constructor(t){super([new nt,new Tt({type:gt.Fixed}),new Ae,new sn,new Va((x,A)=>this.debug(x,A),!1)],t.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=N(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:i,tileWidth:n,tileHeight:o,columns:h,rows:c,renderFromTopOfGraphic:g,graphicsOffset:_,elevation:v}=t;this.transform=this.get(nt),i&&(this.transform.pos=i),this.collider=this.get(Ae),this.collider&&this.collider.set(this._composite=new De([])),this.pointer=this.get(sn),this.renderFromTopOfGraphic=g??this.renderFromTopOfGraphic,this.graphicsOffset=_??this.graphicsOffset,this.elevation=v??this.elevation,this.tileWidth=n,this.tileHeight=o,this.columns=h,this.rows=c,this._pointerEventDispatcher=new qc,this.tiles=new Array(h*c);for(let x=0;x<c;x++)for(let A=0;A<h;A++){const S=new tp(A,x,this.graphicsOffset,this);this.tiles[A+x*h]=S,this.addChild(S),this._pointerEventDispatcher.addObject(S,P=>this.getTileByPoint(P.worldPos)===S,()=>!0)}this.pointer.localBounds=ct.fromDimension(n*h*this.transform.scale.x,o*c*this.transform.scale.y,N(.5,0))}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:k.Zero;{const n=t.offset;return this._originalOffsets.set(t,n),n}}updateColliders(){this._composite.clearColliders();const t=this.get(nt).pos;for(const i of this.tiles)if(i.solid)for(const n of i.getColliders()){const o=this._getOrSetColliderOriginalOffset(n);n.offset=this.tileToWorld(N(i.x,i.y)).sub(t).add(o).sub(N(this.tileWidth/2,this.tileHeight)),n.owner=this,this._composite.addCollider(n)}this.collider.update()}worldToTile(t){t=t.sub(this.transform.globalPos);const i=this.tileWidth/2,n=this.tileHeight/2;return N(~~((t.x/i+t.y/n)/2),~~((t.y/n-t.x/i)/2))}tileToWorld(t){const i=this.tileWidth/2,n=this.tileHeight/2,o=(t.x-t.y)*i,h=(t.x+t.y)*n;return N(o,h).add(this.transform.pos)}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const i=this.worldToTile(t);return this.getTile(i.x,i.y)}_getMaxZIndex(){let t=Number.NEGATIVE_INFINITY;for(const i of this.tiles){const n=i.get(nt).z;n>t&&(t=n)}return t}debug(t,i){const{showAll:n,showPosition:o,positionColor:h,positionSize:c,showGrid:g,gridColor:_,gridWidth:v,showColliderGeometry:x}=i.isometric,{geometryColor:A,geometryLineWidth:S,geometryPointSize:P}=i.collider;if(t.save(),t.z=this._getMaxZIndex()+.5,n||g){for(let I=0;I<this.rows+1;I++){const F=this.tileToWorld(N(0,I)),R=this.tileToWorld(N(this.columns,I));t.drawLine(F,R,_,v)}for(let I=0;I<this.columns+1;I++){const F=this.tileToWorld(N(I,0)),R=this.tileToWorld(N(I,this.rows));t.drawLine(F,R,_,v)}}if(n||o)for(const I of this.tiles)t.drawCircle(this.tileToWorld(N(I.x,I.y)),c,h);if(n||x){for(const I of this.tiles)if(I.solid)for(const F of I.getColliders())F.debug(t,A,{lineWidth:S,pointSize:P})}t.restore()}}class sd{constructor(t,i){this.id=Vt(),this._stopped=!1,this._sequenceBuilder=i,this._sequenceContext=new vo(t),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(t){this._actionQueue.update(t)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(t){return new sd(t,this._sequenceBuilder)}}class pw{constructor(t){this.id=Vt(),this._actions=t}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}isComplete(t){return this._actions.every(i=>i.isComplete(t))}reset(){this._actions.forEach(t=>t.reset())}stop(){this._actions.forEach(t=>t.stop())}}class er{constructor(t,i){this.bounds=t,this.options=i,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...i},this.halfWidth=t.width/2,this.halfHeight=t.height/2}_split(){this._isDivided=!0;const t={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new er(new ct({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),t),this.topRight=new er(new ct({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),t),this.bottomLeft=new er(new ct({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),t),this.bottomRight=new er(new ct({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),t)}_insertIntoSubNodes(t){var i,n,o,h;!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.insert(t),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.topRight.insert(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.insert(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.insert(t)}insert(t){if(this._isDivided){this._insertIntoSubNodes(t);return}if(this.items.push(t),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const i of this.items)this._insertIntoSubNodes(i);this.items.length=0}}remove(t){var i,n,o,h;if(this.bounds.overlaps(t.bounds)){if(!this._isDivided){const c=this.items.indexOf(t);c>-1&&this.items.splice(c,1);return}!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.remove(t),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.topRight.remove(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.remove(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.remove(t)}}query(t){let i=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(t)&&(i=i.concat(this.topLeft.query(t))),this.topRight.bounds.overlaps(t)&&(i=i.concat(this.topRight.query(t))),this.bottomLeft.bounds.overlaps(t)&&(i=i.concat(this.bottomLeft.query(t))),this.bottomRight.bounds.overlaps(t)&&(i=i.concat(this.bottomRight.query(t)))),i=i.filter((n,o)=>i.indexOf(n)>=o),i}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let t=this.items;return this._isDivided&&(t=t.concat(this.topLeft.getAllItems()),t=t.concat(this.topRight.getAllItems()),t=t.concat(this.bottomLeft.getAllItems()),t=t.concat(this.bottomRight.getAllItems())),t=t.filter((i,n)=>t.indexOf(i)>=n),t}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(t){this.bounds.draw(t,$.Yellow),this._isDivided&&(this.topLeft.bounds.draw(t,$.Yellow),this.topRight.bounds.draw(t,$.Yellow),this.bottomLeft.bounds.draw(t,$.Yellow),this.bottomRight.bounds.draw(t,$.Yellow))}}function _w(d){return!!d._initialize}function mw(d){return!!d.onAdd}function vw(d){return!!d.onRemove}function ww(d){return!!d.onInitialize}function xw(d){return!!d._preupdate}function Aw(d){return!!d.onPreUpdate}function bw(d){return!!d.onPostUpdate}function yw(d){return!!d.onPostUpdate}function Cw(d){return!!d.onAdd}function Sw(d){return!!d.onRemove}function Pw(d){return!!d.onPreDraw}function Ew(d){return!!d.onPostDraw}class Tw{constructor(t,i=!1){this.path=t,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new lo(t,"arraybuffer",i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){const t=await this._resource.load();this._stream=new ep(t),this._gif=new ip(this._stream);const i=this._gif.images.map(n=>new ls(n.src,!1));return await Promise.all(i.map(n=>n.load())),this.data=this._images=i,this._sprites=this._images.map(n=>n.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(t=0){var i;return(i=this._sprites[t])!==null&&i!==void 0?i:null}toSpriteSheet(){const t=this._sprites;return t.length?new Rn({sprites:t}):null}toAnimation(t){var i;const n=(i=this._gif)===null||i===void 0?void 0:i.images;if(n?.length){const o=n.map((h,c)=>{var g;return{graphic:this._sprites[c],duration:((g=this._gif)===null||g===void 0?void 0:g.frames[c].delayMs)||void 0}});return this._animation=new Wi({frames:o,frameDuration:t}),this._animation}return null}get readCheckBytes(){var t,i;return(i=(t=this._gif)===null||t===void 0?void 0:t.checkBytes)!==null&&i!==void 0?i:[]}}const oa=d=>d.reduce(function(t,i){return t*2+i},0),Al=d=>{const t=[];for(let i=7;i>=0;i--)t.push(!!(d&1<<i));return t};class ep{constructor(t){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=i=>{const n=[];for(let o=0;o<i;o++)n.push(this.readByte());return n},this.read=i=>{let n="";for(let o=0;o<i;o++)n+=String.fromCharCode(this.readByte());return n},this.readUnsigned=()=>{const i=this.readBytes(2);return(i[1]<<8)+i[0]},this.data=new Uint8Array(t),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const Iw=function(d,t){let i=0;const n=function(S){let P=0;for(let I=0;I<S;I++)t.charCodeAt(i>>3)&1<<(i&7)&&(P|=1<<I),i++;return P},o=[],h=1<<d,c=h+1;let g=d+1,_=[];const v=function(){_=[],g=d+1;for(let S=0;S<h;S++)_[S]=[S];_[h]=[],_[c]=null};let x=0,A=0;for(;;){if(A=x,x=n(g),x===h){v();continue}if(x===c)break;if(x<_.length)A!==h&&_.push(_[A].concat(_[x][0]));else{if(x!==_.length)throw new Error("Invalid LZW code.");_.push(_[A].concat(_[A][0]))}o.push.apply(o,_[x]),_.length===1<<g&&g<12&&g++}return o};class ip{constructor(t){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=i=>{const n=[];for(let o=0;o<i;o++){const h=this._st.readBytes(3);n.push(h)}return n},this.readSubBlocks=()=>{let i,n;n="";do i=this._st.readByte(),n+=this._st.read(i);while(i!==0);return n},this.parseHeader=()=>{const i={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(i.sig=this._st.read(3),i.ver=this._st.read(3),i.sig!=="GIF")throw new Error("Not a GIF file.");i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned(),this._currentFrameCanvas.width=i.width,this._currentFrameCanvas.height=i.height;const n=Al(this._st.readByte());i.gctFlag=n.shift(),i.colorResolution=oa(n.splice(0,3)),i.sortedFlag=n.shift(),i.globalColorTableSize=oa(n.splice(0,3)),i.backgroundColorIndex=this._st.readByte(),i.pixelAspectRatio=this._st.readByte(),i.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<i.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(i)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=i=>{const n=_=>{this.checkBytes.push(this._st.readByte());const v=Al(this._st.readByte());return _.reserved=v.splice(0,3),_.disposalMethod=oa(v.splice(0,3)),_.userInputFlag=v.shift(),_.transparentColorFlag=v.shift(),_.delayTime=this._st.readUnsigned(),_.transparentColorIndex=this._st.readByte(),_.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(_)&&this.checkBytes.push(this._handler.gce),_},o=_=>{_.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(_)&&this.checkBytes.push(this._handler.com)},h=_=>{this.checkBytes.push(this._st.readByte()),_.ptHeader=this._st.readBytes(12),_.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(_)&&this.checkBytes.push(this._handler.pte)},c=_=>{const v=A=>{this.checkBytes.push(this._st.readByte()),A.unknown=this._st.readByte(),A.iterations=this._st.readUnsigned(),A.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(A)&&this.checkBytes.push(this._handler.app)},x=A=>{A.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[A.identifier]&&this._handler.app[A.identifier](A)&&this.checkBytes.push(this._handler.app[A.identifier])};switch(this.checkBytes.push(this._st.readByte()),_.identifier=this._st.read(8),_.authCode=this._st.read(3),_.identifier){case"NETSCAPE":v(_);break;default:x(_);break}},g=_=>{_.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(_)&&this.checkBytes.push(this._handler.unknown)};switch(i.label=this._st.readByte(),i.label){case 249:i.extType="gce",this._gce=n(i);break;case 254:i.extType="com",o(i);break;case 1:i.extType="pte",h(i);break;case 255:i.extType="app",c(i);break;default:i.extType="unknown",g(i);break}},this.parseImg=i=>{var n;const o=(g,_)=>{const v=new Array(g.length),x=g.length/_,A=(F,R)=>{const E=g.slice(R*_,(R+1)*_);v.splice.apply(v,[F*_,_].concat(E))},S=[0,4,2,1],P=[8,8,4,2];let I=0;for(let F=0;F<4;F++)for(let R=S[F];R<x;R+=P[F])A(R,I),I++;return v};i.leftPos=this._st.readUnsigned(),i.topPos=this._st.readUnsigned(),i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned();const h=Al(this._st.readByte());i.lctFlag=h.shift(),i.interlaced=h.shift(),i.sorted=h.shift(),i.reserved=h.splice(0,2),i.lctSize=oa(h.splice(0,3)),i.lctFlag&&(i.lctBytes=this.parseColorTableBytes(1<<i.lctSize+1)),i.lzwMinCodeSize=this._st.readByte();const c=this.readSubBlocks();i.pixels=Iw(i.lzwMinCodeSize,c),i.interlaced&&(i.pixels=o(i.pixels,i.width)),!((n=this._gce)===null||n===void 0)&&n.delayTime&&(i.delayMs=this._gce.delayTime*10),this.frames.push(i),this.arrayToImage(i,i.lctFlag?i.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(i)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const i={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(i.sentinel)){case"!":i.type="ext",this.parseExt(i);break;case",":i.type="img",this.parseImg(i);break;case";":i.type="eof",this._handler.eof&&this._handler.eof(i)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+i.sentinel.toString(16))}i.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(i,n)=>{var o,h,c,g;const _=document.createElement("canvas");_.width=i.width,_.height=i.height;const v=_.getContext("2d"),x=v.getImageData(0,0,_.width,_.height);let A=-1;!((o=this._gce)===null||o===void 0)&&o.transparentColorFlag&&(A=this._gce.transparentColorIndex);for(let P=0;P<i.pixels.length;P++){const I=i.pixels[P],F=n[I];I===A?x.data.set([0,0,0,0],P*4):x.data.set([...F,255],P*4)}if(v.putImageData(x,0,0),((h=this._gce)===null||h===void 0?void 0:h.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((c=this._gce)===null||c===void 0?void 0:c.disposalMethod)===2&&(!((g=this._hdr)===null||g===void 0)&&g.gctFlag)){const P=n[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${P[0]}, ${P[1]}, ${P[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(_,i.leftPos,i.topPos,i.width,i.height);const S=new Image;S.src=this._currentFrameCanvas.toDataURL(),this.images.push(S)},this._st=t,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class Rw{constructor(t,i,{bustCache:n,...o}={}){this.path=t,this.family=i,this._isLoaded=!1,this._resource=new lo(t,"blob",n),this._options=o}async load(){if(this.isLoaded())return this.data;try{const t=await this._resource.load(),i=URL.createObjectURL(t);this.data||(this.data=new FontFace(this.family,`url(${i})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(t){throw`Error loading FontSource from path '${this.path}' with error [${t.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(t){return new Ln({family:this.family,...this._options,...t})}}const hf=Jg(),Dw=/^\s*(?:function)?\*/;function lf(d){return typeof d!="function"?!1:Dw.test(Function.prototype.toString.call(d))?!0:Object.getPrototypeOf?Object.getPrototypeOf(d)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function sp(...d){var t;const i=ut.getInstance();let n,o,h,c;lf(d[0])&&(o=globalThis,n=d[0],h=d[1]),lf(d[1])&&(o=d[0],n=d[1],h=d[2]),d[1]instanceof hi&&(o=d[0],c=d[1],n=d[2],h=d[3]),d[0]instanceof hi&&(o=globalThis,c=d[0],n=d[1],h=d[2]);const g=Kg(hf),_=h?.timing,v=g?!1:(t=h?.autostart)!==null&&t!==void 0?t:!0;let x;try{x=c??hi.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let A=!1,S=!1,P=!1;const I=n.bind(o),F=I();let R;const E=new Promise((V,L)=>{R=G=>{try{if(P){S=!0,V();return}const{done:j,value:X}=hf.scope(!0,()=>F.next(G));if(j||P){S=!0,V();return}X instanceof Promise?X.then(()=>{x.clock.schedule(R,0,_)}):X===void 0||X===void 0?x.clock.schedule(R,0,_):x.clock.schedule(R,X||0,_)}catch(j){L(j);return}},v&&(A=!0,R(x.clock.elapsed()))}),M={isRunning:()=>A&&!P&&!S,isComplete:()=>S,cancel:()=>{P=!0},start:()=>(A?i.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(I)):(A=!0,R(x.clock.elapsed())),M),generator:F,done:E,then:E.then.bind(E),[Symbol.iterator]:()=>F};return M}class ja extends Qe{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(t){var i,n,o,h;super(),this._logger=ut.getInstance(),this.transform=new nt,this.graphics=new ce,this._completeFuture=new Pi,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=t.duration,this.easing=(i=t.easing)!==null&&i!==void 0?i:Gt.Linear,this.direction=(n=t.direction)!==null&&n!==void 0?n:"out",this.hideLoader=(o=t.hideLoader)!==null&&o!==void 0?o:!1,this.blockInput=(h=t.blockInput)!==null&&h!==void 0?h:!1,this.transform.coordPlane=ze.Screen,this.transform.pos=k.Zero,this.transform.z=1/0,this.graphics.anchor=k.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(t,i){this.complete||(this._currentDistance+=St(i/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=St(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=St(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(t){}onStart(t){}onUpdate(t){}onEnd(t){}onReset(){}reset(){this.started=!1,this._completeFuture=new Pi,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(t,i){const n=i;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),n.world.entityManager.getById(this.id))return this._co;this._engine=t,n.add(this);const o=this;return this._co=sp(t,function*(){for(;!o.complete;){const h=yield;o.updateTransition(o._engine,h),o._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class Fw extends ja{constructor(t){var i,n;super({...t,duration:(i=t.duration)!==null&&i!==void 0?i:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(n=t.color)!==null&&n!==void 0?n:$.Black}onInitialize(t){this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=new po({width:t.screen.resolution.width,height:t.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=t}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class Mw extends ja{constructor(t){super({direction:"in",...t}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(t){this.image=await t.engine.screenshot(!0),await this.image.decode()}onInitialize(t){this.engine=t,this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=ls.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=N(1/t.screen.pixelRatio,1/t.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class Bw extends ja{constructor(t){var i;super({direction:"in",...t}),this._easing=Gt.Linear,this.name=`Slide#${this.id}`,this.slideDirection=t.slideDirection,this.transform.coordPlane=ze.World,this.graphics.forceOnScreen=!0,this._easing=(i=t.easingFunction)!==null&&i!==void 0?i:this._easing,this._vectorEasing=Gt.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(t){this._image=await t.engine.screenshot(!0),await this._image.decode(),this._screenCover=ls.fromHtmlImageElement(this._image).toSprite()}onInitialize(t){switch(this._engine=t,this.slideDirection){case"up":{this._directionOffset=N(0,-t.screen.resolution.height);break}case"down":{this._directionOffset=N(0,t.screen.resolution.height);break}case"left":{this._directionOffset=N(-t.screen.resolution.width,0);break}case"right":{this._directionOffset=N(t.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=N(1/t.screen.pixelRatio,1/t.screen.pixelRatio)}onUpdate(t){this._camera.pos=this._vectorEasing(t,this._destinationCameraPosition,this._startCameraPosition,1)}}class nd extends he{constructor(t){super(),this.color=$.Black,this.thickness=1;const{start:i,end:n,color:o,thickness:h}=t;this.start=i,this.end=n,this.color=o??this.color,this.thickness=h??this.thickness,this._localBounds=this._calculateBounds();const{width:c,height:g}=this._localBounds;this.width=c,this.height=g}get localBounds(){return this._localBounds}_calculateBounds(){const t=this.end.sub(this.start).normal(),i=this.thickness/2,n=[this.start.add(t.scale(i)),this.end.add(t.scale(i)),this.end.add(t.scale(-i)),this.start.add(t.scale(-i))];return ct.fromPoints(n)}_drawImage(t,i,n){t.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new nd({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class rd extends gr{get points(){return this._points}set points(t){this._points=t;const i=this.minPoint;this.width=this._points.reduce((n,o)=>Math.max(o.x,n),0)-i.x,this.height=this._points.reduce((n,o)=>Math.max(o.y,n),0)-i.y,this.flagDirty()}get minPoint(){const t=this._points.reduce((n,o)=>Math.min(o.x,n),1/0),i=this._points.reduce((n,o)=>Math.min(o.y,n),1/0);return N(t,i)}constructor(t){super(t),this._points=[],this.points=t.points,this.filtering=be.Blended,this.rasterize()}clone(){return new rd({points:this.points.map(t=>t.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){if(this.points&&this.points.length){t.beginPath();const i=this.minPoint.negate(),n=this.points[0].add(i);t.moveTo(n.x,n.y),this.points.forEach(o=>{t.lineTo(o.x+i.x,o.y+i.y)}),t.lineTo(n.x,n.y),t.closePath(),this.color&&t.fill(),this.strokeColor&&t.stroke()}}}var Rs;(function(d){d.Stretch="stretch",d.Tile="tile",d.TileFit="tile-fit"})(Rs||(Rs={}));class od extends he{constructor(t){super(t),this._logger=ut.getInstance(),this._config=t,this._imgSource=t.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(t,i=!1){this._config.width=t,i&&this._initialize()}setTargetHeight(t,i=!1){this._config.height=t,i&&this._initialize()}setMargins(t,i,n,o,h=!1){this._config.sourceConfig.leftMargin=t,this._config.sourceConfig.topMargin=i,this._config.sourceConfig.rightMargin=n,this._config.sourceConfig.bottomMargin=o,h&&this._initialize()}setStretch(t,i,n=!1){t==="horizontal"?this._config.destinationConfig.horizontalStretch=i:t==="vertical"?this._config.destinationConfig.verticalStretch=i:(this._config.destinationConfig.horizontalStretch=i,this._config.destinationConfig.verticalStretch=i),n&&this._initialize()}getConfig(){return this._config}_drawTile(t,i,n,o,h,c,g){const _=c||0,v=g||0;let x,A,S,P;const I=this._getNumberOfTiles(i.width,n.x,o),F=this._getNumberOfTiles(i.height,n.y,h);for(let R=0;R<I;R++)for(let E=0;E<F;E++){let{tempSize:M,tempPosition:V}=this._calculateParams(R,I,i.width,n.x,this._config.destinationConfig.horizontalStretch);x=M,A=V,{tempSize:M,tempPosition:V}=this._calculateParams(E,F,i.height,n.y,this._config.destinationConfig.verticalStretch),S=M,P=V,t.drawImage(i,0,0,i.width,i.height,_+A,v+P,x,S)}}_drawImage(t,i,n){this._imgSource.isLoaded()?(this._drawTile(t,this._canvasA,new k(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(t,this._canvasB,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(t,this._canvasC,new k(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(t,this._canvasD,new k(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(t,this._canvasE,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasF,new k(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasG,new k(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasH,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasI,new k(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const t=this._canvasA.getContext("2d");t?.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const i=this._canvasB.getContext("2d");i?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const n=this._canvasC.getContext("2d");n?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const o=this._canvasD.getContext("2d");o?.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const h=this._canvasE.getContext("2d");h?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const c=this._canvasF.getContext("2d");c?.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const g=this._canvasG.getContext("2d");g?.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const _=this._canvasH.getContext("2d");_?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const v=this._canvasI.getContext("2d");v?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new od(this._config)}_getNumberOfTiles(t,i,n){switch(n){case Rs.Stretch:return 1;case Rs.Tile:return Math.ceil(i/t);case Rs.TileFit:return Math.ceil(i/t)}}_calculateParams(t,i,n,o,h){switch(h){case Rs.Stretch:return{tempPosition:0,tempSize:o};case Rs.Tile:return t===i-1?{tempPosition:t*n,tempSize:n-(i*n-o)}:{tempPosition:t*n,tempSize:n};case Rs.TileFit:const c=o/i;return{tempPosition:t*c,tempSize:c}}}}class ad extends Wi{constructor(t){super({...t,frames:t.animation.frames.slice(),strategy:t.animation.strategy,frameDuration:t.animation.frameDuration,speed:t.animation.speed,reverse:t.animation.isReversed}),this._ready=new Pi,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...t.sourceView},this._tiledWidth=t.width,this._tiledHeight=t.height;const i=[];for(let n=0;n<this.frames.length;n++){const o=this.frames[n].graphic;if(o&&o instanceof Gi){const h=new co({image:o.image,width:t.width,height:t.height,sourceView:{...o.sourceView},wrapping:t.wrapping,filtering:t.filtering});this.frames[n].graphic=h,h.ready.then(()=>{h.sourceView={...h.sourceView,...this._sourceView}}),i.push(h.ready)}}Promise.all(i).then(()=>this._ready.resolve())}static fromAnimation(t,i){return new ad({width:t.width,height:t.height,...i,animation:t})}_updateSourceView(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof Gi&&(i.sourceView={...i.sourceView,...this._sourceView})}}get sourceView(){return Ni(this._sourceView,()=>this._updateSourceView())}set sourceView(t){this._sourceView=Ni(t,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof Gi&&(i.sourceView.height=this._tiledHeight||i.height,i.destSize.height=this._tiledHeight||i.height,i.sourceView.width=this._tiledWidth||i.width,i.destSize.width=this._tiledWidth||i.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(t){this._tiledWidth=t,this._updateWidthHeight()}set height(t){this._tiledHeight=t,this._updateWidthHeight()}}const np=5,hr={},kw=()=>{for(const d in hr)hr[d]=0},aa=(d,t)=>{const i=Le.isEnabled("suppress-obsolete-message");hr[d]<np&&!i&&(ut.getInstance().warn(d),console.trace&&t.showStackTrace&&console.trace()),hr[d]++};function Lw(d){return d={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...d},function(t,i,n){if(n&&!(typeof n.value=="function"||typeof n.get=="function"||typeof n.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const h=`${`${t.name||""}${t.name&&i?".":""}${i||""}`} is marked obsolete: ${d.message}`+(d.alternateMethod?` Use ${d.alternateMethod} instead`:"");hr[h]||(hr[h]=0);const c=n?{...n}:t;if(!n){class g extends c{constructor(...v){aa(h,d),super(...v)}}return g}return n&&n.value?(c.value=function(){return aa(h,d),n.value.apply(this,arguments)},c):(n&&n.get&&(c.get=function(){return aa(h,d),n.get.apply(this,arguments)}),n&&n.set&&(c.set=function(){return aa(h,d),n.set.apply(this,arguments)}),c)}}class Uw{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const t=new Pi;return this._queue.push(t),t.promise}dequeue(t){this._queue.shift().resolve(t)}}class zw{constructor(t){this._count=t,this._waitQueue=new Uw}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(t=1){if(t!==0){for(;t!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),t--;this._count+=t}}}const Kl="0.30.3";Af();C.eKr;C.yVm;C.a7j;C.U_w;C.JF2;C.htg;C.HXL;C.mcg;var xi=C.Agj;C.J3_;C.Wgv;C.u6S;C.x7M;var ee=C.X55;C.m3M;C.aE5;var ie=C.YJU;C.eZi;C.GNv;C.Y56;C._0v;C.vhs;C.vrQ;C.Z8b;C.Yfw;C.IcQ;C.kgJ;C.GTT;C.ypY;C.i7d;C.fQ3;C.HlI;C.jlt;C.VQc;C.zD7;C.AUF;C.JoF;C.MlA;C.PZh;C.qA;var Qa=C.CrD;C.dQK;C.D3r;C.Qpo;C.D9n;C.b6v;C.mvh;var us=C.Bpo,le=C.Q1f;C.IKv;C.fcV;C.Glf;var hd=C.uAl;C.ElT;C.Z8r;C.QSL;C.sPV;C.nAn;C.zCU;C.QrV;C.fF9;C.Jqv;C.d_u;C.xI8;C.yar;C.SP7;C.oRy;C.f5X;C.V1c;C.Mlx;C.ZiM;C.ZCo;C.J5p;C.mL_;C.Guw;C.N5j;C.pgY;C.OP3;C.rl5;C.eod;var Hw=C.q5Z;C.YUC;C.saR;C.hvr;C.Qol;C.Wf4;var cf=C.JCs;C.gJV;C.fWD;C.Va_;var Ow=C.N$8;C._jQ;C.rxj;C.rhv;C.wCu;C.HAp;C.Zy1;C.bkB;C.wfL;C.sVA;C.$Gs;C.CJ0;C.NWh;C.tWi;C.xAj;C.zWh;C.i_4;C.iIx;C.Hxo;var rp=C.c9e,os=C.KQV;C.weH;C.jXp;C.zzY;C.yRQ;C.MtE;C.rPj;C.KLc;C.Fir;C.V5f;C.Xj7;C.Wud;C.FVg;C.g5Y;C.YQB;C.KPb;C.nHK;C.Jrb;C.TX_;C.Olt;C.r3n;C.Fvk;C.gpR;C.vYh;C.hnk;var Ds=C.D2R;C.n1o;C.h9O;C.X5j;C.p3P;C.RLG;C.fBU;C.Adb;var pt=C.bEs;C.wCy;C.CbD;C.x_C;C.pGf;C.ibQ;C.shR;C.Yjk;var Vw=C._u1;C.OBI;C.klh;C.s3S;C.D$R;C.xth;var as=C.JU7;C.h9x;C.N1A;C.e_k;var Ww=C.aHM;C.tlv;C.Vi9;C.ieR;C.$bb;C.VyI;C.imn;C.uqu;C.QnL;C.vnc;var Nw=C.wk_;C.GH0;C._1r;C.l0X;C.bT;C.HHX;C.jtW;C.tjk;C.rWe;C.j9l;var df=C.l0$,ha=C.sGJ;C.NVp;C.cPK;C.XoL;C.RmF;C.DXI;C.tCD;C.J3D;C.vCJ;C.e6k;C.f9l;C.v9m;C.yRJ;C.EU6;C.m3O;C.Ryz;C.OxP;C.LEs;C.Ec;C.Pi5;C.gmH;C.tS;C.XxX;C.bCz;C.nYS;C.yiT;C.NHl;C.mO8;C.PXI;C.bn5;C.Ywr;C.cMd;C.Bs6;C.G0k;C.pyn;C.QeM;C.aPX;C.ITP;C.BY0;C.MFw;C.sBn;C.S3L;C.XKQ;C.ESI;C.uxz;var vr=C.o8N;C.u_r;C.RlV;C.gVA;var Qs=C.M_G;C.BpG;C.GRB;C.kM6;C.dO8;C.jgM;C.FWq;C.s3j;C.hlw;C.L0q;C.B7e;C.PGN;C.H_X;C.S_d;C._Tq;C.U7E;C.IOH;var ld=C.Z58;C.yh2;C.ff$;C.cWi;var Ai=C.NBt;C.oNz;C.QlU;C.Xey;C.jft;C._r8;C.bTC;C.Mtr;var Gw=C.ypk;C.mnM;C.q7S;C.bAZ;var Es=C.ABN;C.VK6;C.Hj2;C.Df8;C.oOx;C.kxk;C.DT1;var Oe=C.FLG;C.qN_;C.Z37;C.FtL;C.Z6X;C.iQT;C.ziO;C.OEF;C.uuE;C.tiv;C.T$Y;C.EYj;var hs=C.nOB;C.Tap;C.FAs;C.B_P;C.aA5;C.J3s;C.Y0Q;var Ia=C.M4G;C.l$l;C.dLy;C.WZP;C.eB6;C.nFK;C.l9z;C.YOF;C.yhB;C.J0N;var At=C.Miz;C.Bj4;C.Rcs;C.vJ4;C.TqC;C.nM0;C.X1u;C.SpZ;C.DX8;C.Yx$;C.HK4;C.yt5;C.vAR;C.SE$;C.qE8;C.Pz7;C.sX_;C.JuI;C.pxT;C.Nl$;C.zDr;C.OwT;C.P$G;C.mHV;C.kEA;C.Fx_;C.WFC;C.vKu;C.aDq;C.jIg;C.UH3;C.AJO;C.U4;C.xAc;C._3Y;C.K6X;C.C1Y;C.Aw1;C.tm8;C.LBV;C.A8$;C.F5e;C.ran;C.c8L;C.o6M;C.hsx;C.l9E;C.aSf;C.CcK;C.nU8;C.td6;C.Zex;C.bkJ;C.mXP;C.vt$;C.hCA;C.pjR;C.U43;C.pSZ;C.y17;C.Ew7;C.hG1;C.jVr;C._SZ;C.xWn;var uf=C.ehJ,K=C.t6s;C.Eyn;const Xw={App:void 0},qw=`
<style> 
   canvas {
       user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -moz-user-select: none;

      -webkit-touch-callout: none; /* disables long-press context menu on iOS Safari */
   }
</style> 
<div \${==>App}> 
    <canvas id='cnv'> </canvas> 
</div>`;class op extends hd{config={updateInterval:100,moveTolerance:5,deadZone:10,maxDistance:100,autoRecenter:!0,recenterThreshold:90};upHandler;downHandler;moveHandler;cancelHandler;gestureStartPos=At.Zero;currentPos=At.Zero;moveDelta=At.Zero;lastDirection={x:0,y:0};isActive=!1;isDown=!1;lastEvent=null;updateInterval=null;lastState="idle";onJoystickChange=null;onAdd(t){this.owner=t}init(t={},i){if(this.config={...this.config,...t},i&&(this.onJoystickChange=i),!this.owner)return;const n=this.owner.scene?.engine.input.pointers.primary;n&&(this.downHandler=n.on("down",o=>this.onDown(o)),this.moveHandler=n.on("move",o=>this.onMove(o)),this.upHandler=n.on("up",o=>this.onUp(o)),this.notifyJoystickChange("idle"))}onRemove(t){console.log("closing tc"),this.upHandler?.close(),this.downHandler?.close(),this.moveHandler?.close(),this.clearUpdateInterval()}onDown(t){console.log("tc pointerdown"),this.gestureStartPos=t.worldPos.clone(),this.currentPos=t.worldPos.clone(),this.moveDelta=At.Zero,this.lastDirection={x:0,y:0},this.isActive=!0,this.isDown=!0,this.lastEvent=t,this.clearUpdateInterval(),this.updateInterval=window.setInterval(()=>{this.processJoystickState()},this.config.updateInterval)}onMove(t){if(this.isDown&&(this.currentPos=t.worldPos.clone(),this.moveDelta=this.currentPos.sub(this.gestureStartPos),this.lastEvent=t,this.config.autoRecenter&&this.lastState==="active")){const i=this.moveDelta.magnitude;if(i>=this.config.deadZone){const n={x:this.moveDelta.x/i,y:this.moveDelta.y/i};if(Math.abs(this.lastDirection.x)>.01||Math.abs(this.lastDirection.y)>.01){const o=this.lastDirection.x*n.x+this.lastDirection.y*n.y;if(Math.acos(Math.max(-1,Math.min(1,o)))*(180/Math.PI)>this.config.recenterThreshold){const c=Math.min(i,this.config.maxDistance/2),g=new At(n.x*c,n.y*c);this.gestureStartPos=this.currentPos.sub(g),this.moveDelta=g,this.lastDirection=n}}}}}onUp(t){console.log("tc pointerup"),this.isDown&&(this.isDown=!1,this.isActive=!1,this.moveDelta=At.Zero,this.lastDirection={x:0,y:0},this.lastEvent=null,this.clearUpdateInterval(),this.notifyJoystickChange("idle"))}clearUpdateInterval(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null)}processJoystickState(){if(!this.isDown||!this.isActive)return;const t=this.moveDelta.magnitude;let i="idle";t>=this.config.deadZone&&(i="active");const n=Math.min(t,this.config.maxDistance);let o={x:0,y:0};t>0&&(o={x:this.moveDelta.x/t,y:this.moveDelta.y/t},this.lastDirection=o),(i!==this.lastState||i==="active")&&this.notifyJoystickChange(i,o,n),this.lastState=i}notifyJoystickChange(t,i={x:0,y:0},n=0){this.onJoystickChange&&this.onJoystickChange({direction:i,distance:n,state:t,rawEvent:this.lastEvent||void 0})}getJoystickState(){const t=this.moveDelta.magnitude,i=this.isDown&&t>=this.config.deadZone?"active":"idle";let n={x:0,y:0};return t>0&&(n={x:this.moveDelta.x/t,y:this.moveDelta.y/t}),{direction:n,distance:Math.min(t,this.config.maxDistance),state:i,rawEvent:this.lastEvent||void 0}}drawJoystick(t){if(!this.isDown)return;const i=this.gestureStartPos.x,n=this.gestureStartPos.y,o=this.currentPos.x,h=this.currentPos.y;t.beginPath(),t.arc(i,n,this.config.maxDistance,0,Math.PI*2),t.strokeStyle="rgba(255,255,255,0.5)",t.lineWidth=2,t.stroke(),t.beginPath(),t.moveTo(i,n),t.lineTo(o,h),t.strokeStyle="rgba(255,255,255,0.7)",t.lineWidth=3,t.stroke(),t.beginPath(),t.arc(o,h,20,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.8)",t.fill()}update(t,i){}}const cd=new Qa("weapons",4,2),Yw=new Qa("enemy",2,5),ap=new Qa("player",1,10),hp=new Qa("drops",8,1),jw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEQAAAAiCAYAAADmvn/1AAAAAXNSR0IArs4c6QAAAcBJREFUaIHt2L1qAkEYheFjiiBJ4yXYx8LKOk0uIb21VcpAUlhEsEwl5A4C6cVKglWEYEydIoWCWwpRMNWkWNbiyMfszLc7AZm3W3cchodh/wBlnXHTNHvnRjuPtlG7ZbqXNfU6Kr5/7IybBgA+lysAwHaxAQDM77bec/o0arcMACx/03UsVz8AgO7r2msdzn9iCC4UDENwvjC5B9sguLJgbBCcK4x1kCsEVxSMKwSXF0Y8qYXgfGG0EJwN5uDHoiG4vDBFQ3ASzP6gbAhOgikbgmOYSmgILoPpf12kCwwEwWUwcYfwDuEB8RoiFO8yQvE5RCg+qQrFdxmhY33bVXds30NOtBMMa0+Ym552GnVn721U367U83hvq/psagAgmSUAgF3ynZ64vwm6VSeNgQGARfIBAFhs1gCA291LmA9EDMGFgmEIzhcm92AbBFcWjA2Cc4WxDnKF4IqCcYXg8sKIJ7UQnC+MFoKzwRz8WDQElxemaAhOgtkflA3BSTBlQ3AMUwkNwWUwk+fTdIGBILgMJu4Q3iE8IF5DhOJdRig+hwjFJ1Wh+C4jdKxvu+rqs6nBw+O/fyCaNAamX71Wr+MPZlhfhBfdpjwAAAAASUVORK5CYII=",Qw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAAFACAYAAADNkKWqAAAAAXNSR0IArs4c6QAABchJREFUeJzt3b1uVEcch+FB2TriClyHIlcQiRtAFE5H5QugoKNMQZf0bqNQpYgUiogb8C24IBENQkpP3EebAh2DZzk5XzNzZs55ngbLBd6/xO/V2l7jEFb2/Ori+Pzq4rj241jL3u+HNd1b6wP3jf6nhy9Xe0wl7f1+qEHxsY19trPVEOz9fqhJsZHN/TRvKyHY+/1Qo+zjSvX1rVZDsPf7oWbZRpXrC/uthGDv90MLko8p1/DvfXX3of743S9VhqDUd3SFEJZLNqJS4YvVEsK1XsoihDDf4vGkHv5Q8PqsFcJaXsMnhDDd7NHUEr5YqRDWEr6YEMJ4k8dSa/hiuUJYa/hiQgjDRo+klfDFUoWwlfDFhBD6DY6j1fDF5oaw1fDFhBBO9Y5iK+E7/nv3jLEh2Er4YkIIn5yMYavhi/WFYKvhiwkhfBbAvYQv1oVgL+GLCSF7dnh+dXH85ux++PP9h2R/6Vrxm+Pnd8+OIYSk9wNtOLy9vglvr2/C40dnIYTlIWjlmd/b65s7f6a6vxXd3bBnh+6NP16/DyHMD0Fr4Ystvb8VwgefHOJ3TA1B6+GLbTWEwgenTgLYGQrB1sIX20oIhQ/69QawE4fgr7//yfuIepQKX6zVEAofDBsMYGetEK4VvlgrIRQ+GO/289jzy/NJpckdwlLhe/X01b0Q5t9fSwiX3g97dPKPf+0Qlg5frLUQCh/M1zuCUiGcGrxO7uHXHkLhg+UGx5ArhLWGL1ZbCIUP0hk9ilQhbCV8sbVDuPb9sEWTx1E6BLUNf+/3w5bMHknuENQ+/L3fD1uweCypQ9Da8Pd+P7Qs2WiWhqD14e/9fmhR8vFMDcFctQ5/yv2PH53d/oTJVLXeDy3JNqJcIWxl+GPunxPAVu6HFmQfU6oQtjr8/7t/SgBbvR9qVmxUc0O4leF/6f4xAdzK/VCj4uMaG8KtDv/z+/8vgFu9H2qy2sj6QriX4Z9fnh+/FMC93A+EEC5eXB0vXlzt8ldShvAxhKW+cw7ctdqzjb7ovfzhoWdAQBHFYxOH7/6Djy8I/vDm7qeCQgjkViwycfhu3lyHEEL4+sG3IQQhBMrLHpeh8MWEECglW1Smhi8mhEBuyWOyNHwxIQRySRaR1OGLCSGQ2uJ45A5fTAiBVGZHo3T4YkIILDU5FmuHLyaEwFyjI1Fb+GJCCEw1GIfawxcTQmCs3ii0Fr6YEAJDTmLQevhiQgj0uY3A1sIXE0Igdnj227tjCKdh6MLXegj7wgdweP/76xBCCGffPwohbCeEQ+Hr7gH269C9sZUQCh8w1iF+R6shFD5gqpMAdloJofABc/UGsFNrCIUPWGowgJ1aQih8QCq3r4E7f3I56Vcz9oWwU+r/A4w/3lSvfn3qdYCwUyfjry2Ewgfk0huBtUMofEBugzEoHULhA0oZHYXcIRQ+oLTJcSj9jFD4gFxmRyJ1CGPCB+S2OBa5nhFOJXzAVMmisTSEwgeUljweU0M4l/ABS2WLSK4QCh+QSvaYpAqh8AGpFYvK3BAKH5BL8biMDaHwAbmtFpm+EAofsBvnTy6Ppb5zDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFfoPOgenF1SuIsUAAAAASUVORK5CYII=",Zw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACgCAYAAACLz2ctAAAAAXNSR0IArs4c6QAAAxFJREFUeJzt2jFoJFUYB/Avx0G6RAhcozzCrYFrtjtLIYhdbuC2sBCU4ywuRRR7CwsLGyvxIlwjiFpZ7EGS7hD0CgXDWdgIxrBZzl7sj7G5ibubzWY2O7uT3P5+sGR3M2/m7cw/771vshEAANV58PftvO4+lNXabuVnPYepKsI2+HOuTXISXoQTuLzevPSf4aK70vviq86HfcP/WnPpXEGapO2gL7ofTbSPYX0o06/l9Wb+xluvCuGU9QVwZ68bre1WXgTxRnpp7B0WF7doO04Ih237Qfp0ocx2hcG1X3urfaL9sPcGrXQWsx++P4iVzmJ21rac35XBN7KNFDt73YiI+KP7T0SMF6K15lJf22wjlW5fJhhnbbf58sNS+xhleb2ZH3b2d1c6i9lhZ3/XKDg9fQFsb7UXivD1Gmc6HRw1d/a6kW2kSfo4U71TbxG+OqbieamMT4yAxeiSbaT48/d/I+L/UPWuEU9TjHxF22JELdM2YvSab5L1YNkLNzj11jUVt7faC4N9bm238rKzxGUx8sMUJ2CtudQXqPdWPz+13agLPYuTV8VFur5689ZhZ3/3tNfMSGu7lQ97zPL4szpWVeZl6uQCc1MZgEsqNVKeGsm0xeylRsrzPM9//PmJEM6BE/cB65QaKb+zeT9++uW3ePT4ad3dYQYuVACZPxfqrvr11Zu3nj99LSJ+jYhwA5g+CgSmZlS4it8pEKjS8RowNVL+zbcP487m/RgMV1EcHB0cnbtAqDKwRuEXx3EArz67lt19+1723ZefZFefXRv6zY+PP9s510GKcFcRmtRI+dHBUVS1P+pVqgjpKQ76DCsQilB0/+pWXuAUI/Gbr78Sjx4/ja8fvD+V4zA7lV683oC8+87tysPx/A/huEKOUCVTIWs7aqHCnl+1/yekigqby6v2Bfw4BU4hNVKu+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAoBL/AZhvdR1TSKf6AAAAAElFTkSuQmCC",Jw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAZFJREFUWIXl179OwlAUx/HvTXgIpEvjxsJkGGrcJeqIq0NZHQi7b0AcWGVghREJrIbgQJxYupkuIpuPcB3MvdbS0v9l8ExN07SfnHv66y2WaUjLNCRHKvH18iABru6GALy6H6JUgDPoSIBqo8YxIEK1f9hrcQyIsExDDnst7P6cY0A0QFXZEGGZhpyNbHabLQCLpUN3vCptaSrqoNqoaYT3AXZ//gcyG9kKIvOAVIJOOoOOrN8/iTIggQCFACgasjeEi6XD5UV970IFUZXXjIjH23MJ6IeGAYqC6GlvN0198hDAD8maI+LUPLsGqPI59ULiIOAnN7LkiB7CHSc3AJO1O/VeEAfifYXbTZPueCXiDmvl3X17BlCdSAtJmyN766Ig+sYRS2P35/qmu81WD7F/WOF3XhQYAnIgr474cwR+uuLvSOS7GtWRydolS47ETq24S5M0RxLndxTEizlUCpL6S5Z0WMMq8zc9KyS33U1aSO77vKSQwna8cSGF7/2jIKX9BYVBSv0NC4KUDgiD/N/6BqlKK1m+ta+tAAAAAElFTkSuQmCC",Kw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAABG9JREFUeJztnL1P20AYh398CKQsdEJCgCFNVZEuDK4iEaljt7JlYOnQfyHq1qFi6Jp/gSFLB9SFTnRFiUSbNUioaT6KFMFElkhB0HSIzlzOZ/tIch+27pEixR+xLw/v3b1+HTMHg3AyzpC3vtPozKluiyiLuhtAS0sV8gCArDMAAFx0lkf7HMPbxzSZ2hpDxLHSgiAy+8cVAOaI1NIIJ+MMU4W8T1o6t+Tbt3l+N7ZMizRBotIGkKhzi663jieNhZUIjESaEI3KTsxGnYg4FhOjUekkEiXv+KDKXV/4uhd6vNoM2jYpSv5qdPSFyWv/bgMALo82AQAvP/wFAGy92PIkhnVnHVEo/YSi8n58+ucJY7k82sTbL/NGSlTShcPk0bCRR5ZZ0rkln8SsM9DSledlHpxEnwhnp9fe+8ujTVwebXrr6G1hpAr5wKsZWUiPwKgEGRilNYelGj6j69t2dnqNw59rcIsumud3XiTzolAHSrpwOreEvbUNVLtXgfu4RRffg7a9eTyOaUjrwk7GGbpFV+hLp3NLkfuJHCfrDJR3Y6ljIE21e4W9tQ3ferob8kQGyTWh+wIGVGN4mNhVg1AWgYA/CulJIa4oFQgEd+W4oqULexJzwbNyGKaMf4DGMZAXiWFpDhAu7qKzjKwzGOWdRRcoYajisk6KQCfjDIMqKDSsMF7XrnavIiOOyNPBzAWKyuMRFYEmonwSSRqJEVgr6SmrShkDdeR3qUIetVLFW1ZVF0xMBAIjiaLls1kxc4GdRmeuVqpJy9XIjSRTkBKBsiWahJYunCSxiRoDdWAFTkksBZo0kWgROM0NIfqnb+SlEy3VmGkSbV7hQKdEo7pwHGdnowRGobNsFYQUgdOUtKaBFFTdoqvs1qbUCAwa53iTiEj3DYu+xBRURWElxvXunNaKdFyl0SiZROI4u4oiRSAR1jy/U1Zc1VWRllK1pX+NPwt5InflgMdnSICYV6QnaTyJ1mm6eyIq0tMyScTqTK6lpjFhMpIysdiK9JRIu5Rj100qTeRziazGsMk06c5BTyPxaJ7fRaYn7HbVz4pouZRjvzT98KGINBYd6QtBWhrDi7TjgyryqZWxVxBR22l0pC8EqX8tdizsNDpzTsYZsmIq/d7YMm87HaWEWqmGfGpl7POqI1DZyZ5vv34HAPcLNyfvX2156xutW9++me1nY8uN1q1PMvAoutLvaXvcVfpJiTjAL29SeNIr/R4WH1b3/7R+BT2vIwWpeaCovN2d9Scdl41QYBSN9ws3J/Q5VSBNoMgX2d1Z9+Q9RSIvAp967lmh7VqYJyxKYrnejpSnGikCeRGw+LC6X663Ua63PVEfv1V8n+VJbLRuUa63sfiwus+bTCr9njcGhrVBBlImkajG3y/cnAAjqeR9FLQc9jP0NhoVE4q0WVj1YM6iajY2rh4YN6TmgbqiUGUuqDSRVoHqRFr5pZwsVIsjaLl+nJVMXdJotP/3M0BcqAnCLBaLxWKxWCwWi8VisVgsOvkPW9QWs7d38t4AAAAASUVORK5CYII=",$w="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAABgCAYAAACaJ3mZAAAAAXNSR0IArs4c6QAADHZJREFUeJztXT1oJMcS/vT2kGMhwykUOow5ZQvyIhAXbG4QzoSjwxcoV7rB4UCpAmcX2CgyysyC8w2MYFkJFBjuIcQTCs9wx8USXvYFo5qtre3u6b/50/UH4k6jmema7q+runu6vgESEhISEhISEhISEhIqxErdBiS0D1ubOzP+++3dpTePnoWbk/ClgIg36I7R608BAJNRB8fYnQF+RPRibswekOCOOup/a3NnNuiO8fqsAwB4/+5h4e+TUQfHV7vOtjidrO0BV7sAqiNi3R2grvLrqn9JPkIMElqfWFYPcEHdHaDO8uuqfyqXnnf7cFVZvq8dVieV2QNsUXcHqLP8uup/a3NnNjw6d75u/2TP2ob/2BhBPYA/sKoH9PpTDLrjpRAVClUDUE8su+y6y29C/QMZqXT49OHzwjnDo3Nsbe7M6Md030ICAsjdL5A9uM79ynNjoO4GqLN88kB11D89w2SUdbrh0Tn2T/bw6cNnTEadhR8gI5/KWxbVh5GA3AX79ADTvV1QVweokwASZXkgFajTDbpjAHMSAsBPv3+/dL48RvbQ9SZYeUDAvweEoCkdwLd8XwIA1XkgF9D9eSej//Oy//ffr/O/FUWFQgJy9gNuPSCkASR8GqCtBKjSA+nKJvDZPgD89uOf+XH6Gx3jsC1bS0BuCG8EbhT/v6oHUCX6hgFeNsG1AdpGABPK8EA6cIJxEq5vrC2dy4/RsxNk+0koCSh7Ab+RSw+gv7tWgI4APg0QC5NRpxICVO2BdNARp4hQrnW/9C5YVQFU6GTUQa9v0wO+Vl4fgqzs6UIDEPQN8EgAjHGM3ZnN2pTp+XlZtuX7QpKcwr1r/bvW/e3d5Qq92x3AnsSfPnzOycfLLlqkN25G4C54kYT6ig31PrE7gC/qIgC/TlWHZdc/MCcLEVGCiPni5Uesb6zlk6/bu8sVaj/bRXEtAV0fQNUDAP8GUBGA7ufSAG0jQNUeqMgW1fGcmFfL53H7bcpcIiDdYIDxUvihh7HtAfw61wooamgJXQO4ogkEqNID+aDonlE2I8hQyB+maDdI6G4R/tKfI+8A3eIG4Of72MDtkHApv6x3w/x3Xf23YZuc0UD+oHU8jK6i626AustPSEhISEhISEhISEhISEhISEhISEhISEgoH2VknyUkWGFrc2f26w//Rks5SEiwxtbmzuzvX+5n0/vZ7O9f7hMJA5DUsTyRbfV6iLLb+0uGdVpmQgbTNrUEd7TWA07vZ7Nvvv0OQPXbnkJ3WyfM4UXAuuXRCMOj82CBRB8k4sVD6/QByYab64sFiYwq5OG4DYPueKm8Ojaibm3uWGX7tR607DC9n+WzP/5T9pIEqRz8+sO/+QxU2lHlsoiqHL40U4UdNBt/8rNwSb6qSagiv6r8sm0wEYt3jqo6JNVDm9cjG68PqBNnlKBxWRnycGTD8Ojc+vnK1OoDsjC/f7KH04Npq2fiTvqAk1FHK09WBgF05OfYPlzF9uEqXrz8uCDhEaPhqfyb64vCDnB7d7nCs/CAakjYZvIBDvqAk1EHL15+zBucUCYBADP5qbxvvv0Or94+L4X8UhVV1+ByfbAsjyzRZvIBDgvRvf4Ur94+B629cWmysghQRH4dQuXhTMMOnUeTHrCsDvnUULgO6KpQACwSAAjvpb3+FNuHGflvri+wfbj6SIysgW+uLxbO5/JwAKyFiWSZwPyVG8E25K1vrGF9o1zv9xTgpA8ILDe26lgMfUBZLsfpwRTbh6u5h/rr53+Wxoi+8nA6z2tznU4SLaZg51PzpEoPqNcHfMCnD5+xvrGGXj87/v7dND/GQQSYjDoYdO3l0WT53AOryA+UJw+XlbuWk9vnWYBwjyylSnw8elOx5AF1AomAn0Kma/jWkZ97OpoYqHSbY8iTeYsaPY4BZR0AYR7ZdiZO57fJSxonIVKiFZg3zv7JXnQC2JJftSRD2s0SLmTSDTs4TGNAujZWh+STIdvzXdYqmwAtAX0mHqEEUJWvIz8wVybdP9nDT79/jzd/PMu9EJ+l20wcTLLERCJa13NBqEemIQQtQdk8i4+ddcFbH3DQHePFy48AEF0f0LaxSBxcJ5DIj5nu46PKqsLx1S6G/WwCEyrYySdD2UToufH7JPNnmObj5q2r5m9UaJw+IA87SvI/2vT6rIPOVyvRvolG91V5XDrOO5rJbp1eIH8W204hO6Np1w+RlshPtpTxAcNY99SuA0pPIr2M6aYhxnEPTOAVTja9+Sp+z7bxvEWzYNngoR5ZrsPakFeuQcYkTL4VLdJMvNHuuUqBTFvPS8fK/ionsDgU4Avjb/54ZvTABPKWqr2LoTbqPDAQSaL3S4TtsKOK7wKrhgJFIZWPG/l1BF8S2jw7le26Mbi1OSFlIGTYEdMGdLH0lajjq9188qcLf6pvk4Tmr/BNGacHU6vQ+/hZM6sQnbLiBG7vLlfopy4bjq92lasIx1e7Ru/CF8L59SHkI49atARE+xP5JgybtcgUghsK15CvylMJXY0AFj9BZjMDJ+yf7FmNPRMBE5agWjqiCZFqAsSv4xs5CCYSphCcoAWfCNHapiknZtAd5+Hf9mVC8oAJSqjCd9F6oo6cTX8bk5CQUDfasnslISGhLpgGwGUlo/tck7zZE8TW5s5sej9TNm4Z6gCm8oquiWnLUyd065ZhVLt9Tw/Kyz6j8nRE4ES9ub6Iagutqz3ltM7WEVClNlBm8rfcXczJSKSjdNHTg2k0W4h8lJH3VEnYan3AshqEiEXo9acY9uc7PQhEuuHROd6/e8gzBWOUT+Tju6BtX/LrEufjWBcXTgTk6YEL+oAVC0T2+lMMMF4gQwzIhpNb4Hv9KW7OLvK/xSSdLYpIqN0X2NBUTusQrEsP7PWnTqpRPpAeicotI/GGxlw66MSZCNJLqmBbTzoRKF1dk+fMlCSy0E0J/K6poDbnxbiHFQF1Qj0cZUmz8fspPZImWT0UJpLZgtvOx4029cSz+lS/m+7BQzf9a9s+tvYV3cN2zNp4fUAbjxTT64TqP1MdkHfmnYiOm3aHyJ0oRDyb4QbtyeNKDi4g4rw+63hPevj41YYLQfqAPDG9bDkyW48U4nVo02cMEkoiEvF8wDekymMyShAJ90/28vJsPSedS53aB67CmYWzKSnU8+rtcwAZIfZP9vIQ+NfP/+SpgMAiOX0Hv7rURALf9sOT0DlyPRXLPIWiMl3B7bJNDuJe0CSEbjpPdS+C6lyZDBWazmmbiaedBctewiXSgHk4IabfXF9gXaFQBfiL6cgkeQ4iH/2b665g3iDU4HWpBNiGTgmemyLrje92DhGAUiHm909s7VCGYJmXKsEH/irBHC5lAbiJ8diCk08ep/BHjV+2jK1JR4bgmhppm5fC60BVz7rQrbtX1d9AMapjFekD0oPp9AGBsDGhKnxwlC1/awPZCagRKSeiLO/LiUVLLbr6sElo4verUnfaeiFapQ847GdvAHT6gDJFsCrIXlxGZcrQT6DfM42Y+bAg9qI5x/t3D0tvTSRs6oBCf5UL1oXqWKH6gDFcusrDSNDMj8ZdPg1e5HGlVkwTPtlFdRMyc+Wo+m1JoToWoFKLmgvwyDU6LkfmIo9mAl/iUYUZGoRTWfxZfMtUgQ/SyZai5acYpPCRvGgLlCGYSEhSYzZQyZGFfkNOKhVwwSLT+C+GKLpqgqMKu/IcGvtxhITfhaUWFh7p+GTkfetGwEoln+CqDxijx/IKVwkFccQcZ8klCe7xTOTPNgvM7QzxyHJIULTU0oSPJ7rCSEDem1USabjKziuSI4sBTm6dhl8smEK+iXx0XezhAC118c2u+VDJsGDdBlFzoz4gAOVWqzL1AXWQ61uqNwz0r+0qvIRPyC/qAHHeAnUWvouisldHvtdnHeAgjp6fb72a0MheIcFf5hN0r9zobzEqm99bNR40IXT8q/L2tq/H5LUxJoP0Wja24mrj5dkk+VRhjY8PY6HKkG8Dl3L5SkYWvsOWaPiE5zEFwWtsqfKgrcgJkeSTr6m4pFosaTVVyOdrjCbC8/fPoa8g+XjU55VmjH2N/C0JpSDcXF842UKbiuU1jQ/BdeSfFIV88o6662MMB+QMeCEFouCe2m35gUMTlU02IZnIx/du0jWND8FVz95sQr7JrljDATnLdfm8Q1nDBm6T65Yt3ZuaxnvAqiH32AH1rqNJr2Pr/QA3r+lqE+AmnEmQdiQCCjQl5ZRD7ni2Ob8qVX8bkD1125FQIXg6Qt22APrJ2P8Bnh00kNVFA+AAAAAASUVORK5CYII=",t0=""+new URL("purple-guy-dark-sheet-32px-xTOPnWXu.png",import.meta.url).href,e0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAABgCAYAAACaJ3mZAAAAAXNSR0IArs4c6QAADwlJREFUeJztXUFoHEcWfcoYReCTscHegxYhk/Vah7ATZCEYjBm0x2yGgCBmCcJJDkJg2CB808H4oJsZ7GVho8MuJoSggyCI3WM2gzFahrFBmxgky8bGrA+xiY1FYEMsezJ7GP2ePzVV3b+6q6dbcj0YNOqp7l9d9er/quqq14CHh4eHh4dHBEZHxltJfvfwiI3RkfHWyx8nWpxk6nf1dwnesM1Ekt89kiHr8v/9n+a7bN29U++yyX+XQkzA0ZHx1tZ3b/SwPux318i6ArK0n2X5j46Mt4bLF/CXT8/02OX//+uv0xguX7DKg5UHTKMFSJF1A8jaPpBt+T+qXQYADJcvYOu7N3D3Th2bWz/g7p168Nnc+iFIJ4WIgGm2ABtkWQFZ2s9D+Q+XL+D8lesAgIHBf2Nz6wdjOhuIPWBaLUCCrCsga/tAtuXP7QPA1NwKiu8M4/yV65iaW8HQwSEMHRzC+SvXre0fkCa0aQFpFMKj2mXg0zMYLl/A11erQR7u3qkHaVKvgAztZ1X+oyPjrYXi7j1ud47PvDeN4796itMXjwKffYAbl57g/uYRoDiNxfVJ8fXFBHxUuxy416m5Fax9/iFKM18AANY+/xAAUJr5Yt9VQF7sZ1H+oyPjrdX5NQBNQ4pD2FjaAQAcPnYIh4/tpluX2xiQZCJoAQqOn9xtAUCnBQBYXJ/Eg4e3Iq8tBYU03r+IqoD9Yj/L8u8QsBvPHj/H4WOHer5zVKql4HtYXkQE1GUiDJVqaV9UQNb24xLARflTo1so1jFRbnu2Rq2AxfVJqOVBxygd5YHODyuP0BActwBW59dQqZZarkjAb6wbyUNAGEwhqHPPh3Dj0pNd2+7tq+AEuL9JR4/g4y+7CUDlTyls60FtdI1aIaQOevHs8XMA6CGqDlbzgI1aAZVqCfc3j6BRK6BRK+D+5hFUqiU0agWbS4kQ1gB03wmr82upjESl90/26RPHFp2XtFwXinVnZUEk5GTUHaNIMFFuYqLcDM1DJAHjFACRIkkFmPJi0wD2KgHIA5EHoTxICWDjgUy21etTHv7+x38Gx+k3OsYhtW0kIM+IbQFQC6BCjEOCJATgFbDXCBAFCQFsPJAJ/PqchLoBBz+mRqSo+tMSUNfxjtMC6HfbAkhKAF4BrmBz/0kIEOWBpEhKfpO9qHzYln3PIERXAGS03RmVtIAj2vOTgDrCnAAEcwjYJQDqWMSkaFAUdv82IPtxoTYy6nLYlr9t3h88vDWwiMn2CBhyEj97/DwgH7dNk9KxRsHcu3ST0FywSb2P6wYQF1kRgJ+nK8O0yx/okIWIqIKIefzkUxw+diiYcnnw8NYA1R+RL6rRGwloewO6FgDErwAdAeh6NhWw1wjQbw8UlRfd8YCY673peP4lNnsISBdYQL0n/NDNSFsAP8+2AOLMPekqwBZ5IEA/PVAcRF3TxqYxoRoK+c2oHWrVYNTvUeCz8BxBAyhGVwBPHycPPB8qbOynQQBp+adh2zVCM8hvNIubMRV01hWQtX0PDw8PDw8PDw8PDw8PDw8PDw8PDw8Pj/2CpCua04QXY9rniCv5Ffc8Wxt/e/9VqjZeB1htSsoCqt6KtMLTFkpanV/DueVCahugXhfkVh9Qp8dCgkCSPKQtlNSoFbCxtJPKbsDXCbnWB1QFeQDgN781644QQdMWSjItU/OwR671AVU9FgBYXf0HAKD5otWz75aIQCS1lQqTgjYbee+XHLnWB+QeTOf5VufXgh1nZHPo4BD+++g/saTCdNDdC+0P8egTqIJvf/t968xHy62XP060Xv38qnX72+9br35+FXxuf/t9IjUAk236e6BwoHXmo+XW6Mh4q/mi1br95xfBJ40RqWk0bRoBu753aR77ac81xCE4LYXMKPD+1a+Hf4eZ7WmQXMfY7GCQLu4G7CjouhUPHt4aMPX9VI+cJmg0vpdJKOo850EebaFYx7nldtjbWNrB2OxgIEzE4WozDu92VCp/6PpNd23Ko6okRftEws6Nm7/V+TWMzQ7i2tnmnh0MRQpUqgVLXmej+H4nUfF/wdfGtp1CptQ+kc8E2kU3UW46U6fiqqgz29PBwEOyyZ1viL97p46puRV8fbWKE2+PO1ENe/Dw1kClWmot1MLlz/IOUQjmrXpjacfoeXhaF+Dk19kE2g1ibHYQx08+DfLgKizxbkdUA6CwzEHdgqm5FTyqXcaJt39xSpSwrsBegVgfsFEr4PjJpxibbQsyEiHIIz57/ASN2hFMlJtO9QG7N5h3k7BRK2BsFnjrxCnc27qJwwaSxsXM9nQX8cZmB1GpngoNwSTHwT3yYvVyaiTZy+QDLAYhE+UmTl88irdOnALQPRXx1olTOH3xqHPv10v+wa6BhwlJ5eFMnndjacc40FE9YBoeeT8isg9oq1AAdBMASN5KJ8pNjM0eDTxdZwDSruB7Wze70nN5OABiYSLVJtDreaUhr0sx1cMIK31AoLeydcdc6AOqdjmunW1ibHYw8FA3Lj3p6SPGlYczeV7JeSZJNJeCnfvNk2o9oFkfcCfQR54ot49vLDW1OtFEgEat0BaqtvBCKvmJSDryA+nJw7XtdnSo49wLkNwjq1IlcTx6XtHjAU0CiUA8hUzb8G0iP/d0NDDgrwIguJAniy1qtNsH1OlWJ/HIC8U67m3djByJU/q95CVDByE69VGqnEq15JwAUvLrpmSePX6uJY4NmUzdDo6wPiCd66pBqnOwkvT8+bjYUIYwEjDOwCMpAXT2TeQHOsqolWoJH3/5Lj756kDghfgoXTJwCJMlJhLRvJ4Nknpk6kLQ/KvkXuLkMyvE1gdcKNZx/ORTAHCuDyitrI+/fDewq+Zfvaew68RRZdVhcX0Sq+X2ACapYCcfDNH8q2kyvvsemkG/eXTdzVOXNJE7fUAedrTk383TueUCCm8OOH8bks7j0nHe0MLybdIL5PcibRRqYwx71k2kJfJTXlyTcHTEHbGN84CqJ1G9TNhFk2SOe2ACL3DK0ydvum/ZEs8bNQpWKzypR1bnYSXkVecgXRKG8uZqJJ5r99xPgUyp56VjaYpfcm+sPmNv1Ar45KsDkatxKC292sv1+/NMHhhwJNH7OkLa7UizMZiIBCAypPJ+Iz+PEJeEknsn27bL4cTvC34dkKTb4TIPKKLnLVGL65PB4M8U/nTvJkn6tgC+HO7a2aYo9NosRsn9vuB+48HDWwP0ySoPi+uT2lmExfXJUO/CJ8L5+UnIRx41agpod31i1yIMyVykD8E5hW3IDwYHFrMVEvtqSI8agRMq1ZKo7+kJ6NED3dQRDYh0AyB+Hl/IQQgjoQ/BHkbwgRDNbZrCKpGWwr/0YYL3gB5a6MJ31HyiiZx5fxrj4eGRNfbK6hUPj9cXUa007VYc1gFOw3bcDU3em6UAnU6K+j1NVVLSg9Fdv/mi5VwbJsxe1Dku87LfCZ1reTYddKt9r51Nb/cZ13rREYET9d7WTad5oXm1/bytM9fybDroRIhc7kc22SNwMhLpaLvotbNNZ3nh2i/A/t1bLF6MwHVSvr5aDRSyuGRuWqqkJqQZ7vkOvIlyE6vlzkoPApFudX4NG0s7wU5BF/aJfHwVtPQhv2njvJvcuYWYgDbybGmTMBD+cSiCBPRWnLoEfqLcxL3lm8FvLkknRRQJjesCc7qVU9wH5KSamltB8Z1hnL9yHVNzKxg6OIShg0POVElVqB4JSG/jDfW5TDCJMxFUL6mD1HObRKBMu97Ic7aVJNqhmzbw224FlaRzcQ0xAReKdcxsTwefpfd+xjeffYBvPvsAL356iRc/vcTM9jQAtxp4/Ea0HsmwWT0pwkgmhTpLQB8JGVQZYPX/sGvw0E1/pSSU5i/qGtI+ayQB1SXi/KMK96ShUirxSC69TlLtZyoDKjPeiOh42OoQdSUKEU/S3aA1eVzJwQZEnCTvP+H9VwkXxPqAOokLuln+voy0RqRSj5TE69CiTxckVIlIxIsDviBVPaZGCSJhpVoK7Ek9J6VN8v4Tsi9VbY0cTalCPacvdvQBK9VSEAJvXHoSbAUEumUz4oZk09ZEAl/2wzehcwR6KsJ9ClE2bcHzJd0cxL2gmp5v/AlLp7sWQZdWjXRJt3NKd+IZR8FqK+ESaUAnnBDTdQKRScV01E3yHES+LmletDfNA90VnpVKgDR0quB7U9Ry46udkwhA6ZB0/4gun1HQhmDeGnSZ4R1/nWAOl7IA7MR4pODkU49T+KPKT1vGNkxHhmC7NVK6L4WXga6cTaHbdK1+v/8kVB0rSh+QbsykDwgk6xPqwgdHmk9ApFAbAVUi7YlIy/tyYtFUi6k8JBua+PX6qTstnojW6QOulttPAEz6gOoWwX5BbcVpFKYa+gn0f1sjptMtcD1pzhH22gqCpAwo9PdzwjpSHSupPqALl67zMCpo5Ef9rjgVHuVxVa2YPLyui8rG1Zs7+/20JFIdC9CpRXUEeNQ5Oi5HZiOPFgY+xaMLM9QJJ1v8XuLa1IF30tWpqbCRelLEkbzYK9CGYCIhSY1JoJMjIzLELThVqYALFoX1/1yIousGOLqwq6ahvh9HkvDbNdXCwiMdb9RiXzoXEKnkE2z1AV20WF7gOqEgDpf9LHVKgnu8MPK3Fwt08pnEI6tdgqiplrA5Qxu7/UQoAXlr1kmk0SuxouTIXICT26Th5wphIT+MfHSe6+4ATXXxxa5BVylkwnoviJqH6gMCHbL1Sx/QBHV+S/eEgf5KZ+FVxAn5UQ3AzVOgQtd7UXT5NZHv3HIBOOtGzy9uuYYhl61CBX+YTzA9cqPfXBQ2v7auPxiGpP1fnbeXPh5Tz3UxGKTHsq4VV3Mvz6aSTxfWeP/QFfoZ8iWwsctnMtrhO9kUDR/w7G5BiNW31HnQPaENo5JPfUzFJdVcSavpQj6fYwwjPH/+nPQRJO+Pxnmk6WJdI39KQlsQ7m3dtMoLLSpWz8l9CNY92+yXTVPIJ+9oOt9Fd0AdAfNwGnVN47L8hF0TXZ4kIZnIx9du0jm5D8H9Hr1JQn5Yvlx1B9RRrs3rHdLqNvA82S7ZMj2pyb0H7DfUNXZAtvNoqteRej/Azmva5gmwE84kqPnwBFSQRciPgrriWZK+X6r+ElB+ss6HRx8RpuaQBUz5+D+9k03LCHiklgAAAABJRU5ErkJggg==",i0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAEBJREFUWIVjYBgFo2AUjIJRMApGwSgYBaNgFIyCkQ4YiVWopGDiQ4rB9x6c2UKxA0i1lBzHMFHDAkrAgEfBKAAAZe4MBrg/DiUAAAAASUVORK5CYII=",s0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAYAAAB3AH1ZAAAAAXNSR0IArs4c6QAAAEhJREFUSIljYBgFo2CAASMyh5nZ8D89LP379zwjhiAzs+F/egEMj8IsZ2BgoAtGdgQLskOUZFVpHvw4wUBFweBJhKNgFAwUAAB2WQDMTpagjAAAAABJRU5ErkJggg==",n0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAABACAMAAAB7sojtAAAABGdBTUEAALGPC/xhBQAAAMBQTFRFE2SIFGWGFH2qE2SGE2WGFXupE2WHFXyoEmWIE2WHFXyoFX2oAAAALq3jIpXFKKHUFXSbFGuPFXWdFG6TNbv0Jp3PFXqjMrXtH6fhIKniNLnyM7nyIKnjMrfxMLXvJa3mKbDpJ6/oJq7nLbPsJq3nJa3nIqvkK7HrLLPsLrTuLLLsMrfwLbPtJKzlH6jiM7jxIanjMbfwMLbvKK/pIqrkJKzmLrTtL7XuKrHqK7LrJ67oI6vlKbDqFGWHNr33Fn2oEt7TigAAAA10Uk5TTz8/769fn89v37+fAH/YHM0AAAEYSURBVGje3drHdcNQDERRWFkklCXSWbYl55wT+dF/V+bCBz083Arm7UdUW3mWGVCW5S1V0dzAcpWu2XhUJqByNDbrSt9WCWtlfTEr03IfaZlKsyYgpQOolP4DHqHiBBxBecAtlAc8Q8UJeIGKE3AM5QGfUHECrqE84AMqTsAdlAdsoDzgCsoDbqA84BsqTsAllAd8QcUJqKDiBJxAecArVJyAUygP+IGKE3AG5QFbKA84h/KANZQHvEPFCbiH8oBfqDgBF1Ae8AYVJ+AJKk7AIZQH7EF5wANUjICiuZxVu0hVczkrZM4+/c1lZjah7p+YzaSeko+v01ra9aKgzi8WdVs6NVpHdtgBItoj7+8173UdDKnzhwPVPwRCH/15giO3AAAAAElFTkSuQmCC",r0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAABACAMAAAB7sojtAAAABGdBTUEAALGPC/xhBQAAAKVQTFRFFnyoFXyoFXyoFH2qFXupFn2oFX2oAAAAIpXFLq3jNbv0KKHUKLDqJp3PMrXtNLnyM7nyMrfxJKzlK7HrLbPsMrfwJq7nLbPtJa3mMLXvKbDpJq3nIqvkLrTuJ6/oLLPsLLLsJa3nIKnjIKniH6fhM7jxMLbvKK/pKbDqL7XuJ67oLrTtKrHqIqrkJKzmK7LrI6vlMbfwIanjH6jiHqfhNr33Fn2oU/4/+wAAAAh0Uk5Tr8+/P1/fnwDVUD04AAABAklEQVRo3u3aR1IDURAE0da4lh1hhLfCI7z5ff+jMQuizkB28E5QuS9zr7uqCqCq6mp38y7AOrcmYjzpC1A/GUc0NopFwVrEyCL6Ml0iTUsfMQSUsgVVym/ALVSegG0oBexBKeADKk/AHVSegCMoBTxC5Qk4g1LAE1SegAMoBaygFHABpYBLKAW8QeUJ2IVSwDNUnoAHqDwBx1AKuIfKE3AOpYANVJ6AfSgFnEApYA2lgEMoBbxC5QnYgVLAO1SegFMoBbxA5Qn4hMoTcAWlgGsoBXxB5Qm4gVLAN9R/wJ8IaIfb5Zy5fz7cLlsz9vHVrI6YUffPImr++du9aanz28b9ByOQclrdOBB9AAAAAElFTkSuQmCC",o0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAGpJREFUaIHt1cEJgCAYgNFqkmiGxmjcxmiGaJROQURBqRXie2fR/zuoVQUAAAAAAJSmTrlZ1/bD3bXzMo0pzowOeDL0lZiY4IAUgx+FhAQFvDH85mlE89YgX8k+oMw7sJftK3Tmj38AgCgrkfgcDGGvEREAAAAASUVORK5CYII=",a0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAABu5JREFUeJztnTFoG1cYx/9uC6GlZOlgYjpIVigYmiXIghgOy1s8ZCqRkqUcXUKQh2wpKQQagosL3hJChhZtyaljCO4WGUEKsrcUCqWKNDV4KIRSCpnUIf1e3p3vbJ39dO/7zPcDYaE75P/73v9937u7dzpAURRFURRFURRFURRFURRFURRFURRFURSmzJeqY3plbS9ak6IoyjR4z+WXzZeq47mFZWyd2c3cvnVml3USlV4ApOtXlONQtP+dJdD5UnU8W6oAAFZfVfFytDuT3OflaHdm9VUVs6UKy4EsvQBI1w9oAfCN5Pj78L/TGaiN3RGHdQoHpBcA6foBLQC+kRx/X/7/wMWX2Pz52zaoIWnsjQau/+VU4GiSPEjTP/EAgNlvnLaPTygB/fB6E6uvqqnbt87sYhVVltqlx9+mKP87S6D/B9N0Qr0W7NtnfaOFWzfvI+q0UzuIA9ILgHT9hBYAv0iLP1G0/50lUNtAe6MBwjcR2sE9s319oxX7G3V4GUh6AZCun9AC4Bep8fflf+eH8PVagC6A1REw92KI4FwZAHDr5n3X/8op0guAdP1aAPwiPf6+/O80gbbfRAj775IoAESdNgCkmoqqNKfOkFoACKn6tQD4RXr8iaL97zSBhqeaqNcCRJ12LGE2G6ExD4DYe0qwHJBeAKTrB7QA+EZq/AE//neaQPdGA6AWoNkI0e339m3PSqJckF4ApOvXAuAX6fH34X+n60APOvcjATo/1WyEqdtp9pB8zwXp+u0BYNNshHj+7DHqtQD1WoDnzx6j2Qgz2+mL9psI3X4P9VpgxkLUaSPqtNHt92Iv4N2aUZ+abaTH34f/p7aQnmg2QkSdNpZWrmBp5Qq6/R6WVq6gUl5kdy5IegGQrl8LgF+kx9+H/51fhacKTPReDDG3sGwOZYhoNGCVPLOgAmCfklha6RmzcW+DJP0nogAIPoUlPf5pTNv/U1lIT0m02+/h/Q8/NftQI9KuUHJBegGQrj+JFgC/SIo/ULz/nc5AKYkCbwW+ZYC5hWX0XgxNw7r9HrvASy8A0vUTWgD8IjX+vvw/tQAcdnKcU/Bt0nTPLSwDgDFRt9/DL91I9TvGXgqUHADBuXJsAHA7f36QdgD7ExAz/YDs+BNF+38qAbA7AgDbansQyXV9NtzbMcmVXa5t0ALgF8nxJ4r0v9MgkPDZUsUkndlSxUyZ7auTHM1D2B2Qpp+T9jSzSIr/UZfxcNFPHNSOtAS0x+wQGMjfFxz0+/b/sb8kLdlkLU61l0dwrGJ2AQCwL/Cknxbq+tafNE+e+H/3/Zr32EvXb5M86rJJWx4kRb/dH7Z+DjNoDv5xsg70wd0bGAx3sDcaGPGD4Q4e3L1h3g+GO2Z/TsnT/gHc2VLFVC9qS9RpYzDciQWfQ/K0OUr8OSFZf3IxfL0WGP/QS5J+ADHt5P+k/q++/KJwrVn49I+TBLp5/TUq5UUjdDDcQaW8iM3rr2P70eLbei3AhXqTzR0YdgfQbMHuACC+cJib/qPEnxNS9VPiOWwAExL0Z/kfiOv/5tuvC1abjU//OLsT6XzrKSrlRfM633pqtnFbMJwkbwdwwT6Ekhh/6fqJw/xzEvVXyotFy9wHB/84vZXzfOspfnyyHRNvQw3hdAhP5OkAjvqBfPHniDT9kw5gQvVPFx/+cX4v/PLnH+HRtUsH7sP1R2Un7QCu+gHZ8Qdk6z/MP8RJ0O/7AlIWRfvHaQJ9dO0Stn/9F1cfPtm3jXv1IibpAK5Ij790/UC2f1T/9PHhH6cJNE14Es7Va5IO4LB8I4s88ef4qOmT7B9C9U8PH/459r3wL0e7MyhhfPYOcPr2ZfP533d+wh+ftGO/i2j2Z8rVh0+wdjF9G1f9R4n/fKk6bjZChL01hKeagMcnRKp/+CBRv2//OFlIb6/8zyK5D5eOoBnY2b9CnL59GWsXP8a9n/8xHUBw1j9J/ClxAvEFxesbLVTKi97bk2cm7FtrkvlSdXyYfwhu2oF8+gF+bZjEO/Zt2S71H+uLaPDWawHWN1r4fWmGZjSxQ0X7zh6a9XA4FLD1p929IEk/kVVp8+xbNPOlqpkBpw0GSvhhbw2fPR+zSPhJTtrvD9hwjf8kE4Jp+97JDHQw3DFPG7SxZz0EPZ+EUydI10+6iCx9yR9I4aAfiA9gOrVAA9X+HOB7HzlxUFskarY/B/jEP+/kAZjOkZeTIOR5uBS3B1EB8vUDb3XZ5zWzTM5R/4V6c5y8O8QeqMkixkm7TdqgBvgknSykxj/vhGDSMZIHFoFQ3GAbnYvJJyHrEFJSGwiJbZGomcg7IZA6RhRFURRFURRFURRFURRFURRFURRFURRFURRFURRFURRFURSFBf8B2OyFPQlBC5sAAAAASUVORK5CYII=",h0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAAQlJREFUeJzt2cFJxEAYBeBfsJCQGtLJ3vewVQiCIihaxR62HmsQO4kHGRG87Qaev34fBHIKL28mkzCpAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+mKdlTWe4hPxZ8n+63uIi5/h+A2/vr1epHP/ZGAP9Z+g/a4v+YwvoYb/7Oj+eau02ibq/ALr3f9jv6niqtguQ/rO26j+2gN4+3FRV1dP9SyrCRbo/AN37H/mr9J+g/7B5Wtah437KyP5499wyf/f+R379Z+g/bJ6WdRzpLOfoPgD6z9J/1lb9t/rs/k2674H+BX7CZOkfAAAAAAAAAAAAAAAAAAAAAAAAAAAAoIEPAh/lWUHyS2gAAAAASUVORK5CYII=",l0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAASJJREFUeJzt2DFKxEAUgOEX8A62Y/YCFrGwEXtLCzsLDyGKhVgIHsDawvPsGZa9ybMaWRthZckw5vuqSaqfZBgeEwEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAb4bWAWOZsq4323Xznn3pb6vX/rFMudmuh177q6X3Hx02Zz9jmfLu9vr7+eMzsqef0GN/ZmZExOrkLCIi9M9rt9/+md+h+5sdoHXzPL08RETE6/Nbq5Q/6bV/GIbh8f49j8sqri5O9c9Mf1u99/8wlinHMmW1O073oNf+88ubrO3656e/rUP2Nx+3l36H0kK9f6vr+l7/PGpzr3eg/+H799wPi9fLtAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMv0BWVfKARXfrX4AAAAAElFTkSuQmCC",c0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAABQCAYAAAA3ICPMAAAAAXNSR0IArs4c6QAAB0xJREFUeJzt3b9u21YUx/HDosiUdIxlx4MsIwgCuJ5Ej9kzuMoTGCj6Dn6BZso7FAXyBFU9eCzgpYWpJbaBICj8Z3BsOWOTKQs72Ee5ovhXpHV5ye8HCOBISsL8nNzDy3t5KAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQNN5tg/A1Ov2Q/367GJUq2OrKzIDYMv3tg8g6vQ8EBGR9TU/FGFQzIPMANhgtYDo2bM54J0cjUVkelBkQPyGzKoVhmEY97rneeQHZPjO1h/c6/bD5898ebKyOjUoDgbbU587PQ+mLtO0WVZmJ0djOTkak1kFwju2j8NVN+PP5NcCCy8g5sD2/kMgH68uZz6zsdlZ6DHVXZ7McD8oJPP7dPMlcYaHZljoJaxetx+engeyvuaHw+He1HuDwfbMPzTz0kxbL8sUzUxEJrOQtmZWhOd5Xp5BTj/Dpa18ljqPvJvx51CE7JrMyhqIDoRBcCgiIr6/NXlNZx9aPHArLTOUowMbhaR6n26+yOOlhyJCdk1kbRHdHAhNv//259TPo++3WVJm+rois/lQSKqlsxCziIiQXZNYW0TXQU4Hv43NjmxsduTnX36a+UybnV2MvPU1XzY2O+L7W+L7WxIEh1NFQ183sZg+vyIDG2sk6ZY6jxKzJDv3Wd3Gq4PexmZH1td8OT0P5ORoTOHIYOYzGGxPLmWRW3WKzEb0c5xRJ4vOQkxk5y4rM5DoVl21vuYnvofk3AaDbXK7J0VnI/d5LK5Km4UosnPTwqt+r9sPzy5GXvTSivmauTiss5O27yYiN/vyDHKcScfTHVlJsxARsnPRwmcg5oCmN8WZojuLoovqbVU0N1TPu5P2Gc6k4+ks5NPNl8TPkJ17atcLyxQEh/L69a+cRReg26CZfQC4b7UsIFo4RGgMmJdZOETIzSYWheMlbes1kZ1baldAdDGYAbAYCsdicJmlnDxFBO6oVQFh8Mt2l1H4/JkvsiIiIrQrqSHOpOdHdu6wdiMhgHbKs6AON1BAgHvC5a75kZ0brF7Cev8hsPnHO43s4DLWQprB6gxkf3kkb16sZn8QM8jODZxJZ0u6lEV29We1gLy87suP//5h8xCcRXaLx4BWrTwtTlBvVi9hvXmxKi8PbB6Bm7R9yfHTVyLXl5M2J7aPq+mSdgYldTzme5JO25uIJDdbZEdWvVktILsHl7Kz8lXeXj2weRjOIj/79ImRcXgiZDKzeIik98hCfVktIAx+5ZCffXfPa4l73DAzkARFiwezkPqy9k3Raf+bF6uye3DJf7aCyK86ZR+6ZRaPIDicPJeFrgqzysw8KCL1Y3URXQc/zIf8yut1+6HuZttZ+SoiMtndtr88EpHb7sdJP0z6lEjzaZHPn/k8FfKOWTweLz2keDSAtUtYZxcjb1ck1K9tHYeryK86uweXk2K8s/JVdg8uZX95JLpJ4b/P17l/L33ksCrya5ssWjyKoHjUF98YtF6Vl7BMTb6EpZnl+buVKR4izSkgRTJzRWP+IoAtcU+EbPIiepH1N4rHraauWdaqGy9Qd0mzlbQnQpq/pikDR571N4rHtCauWdJMESjo9DyQ4XAvtmiY6x+9bj/sdfvhcLgnSfeKuErXi5JQPGZlZeYiZiBACdEtvHGvN1HaPUhli0dTNfG+LWYgQAF3Nw5OHiGcx8Zmp3HPqH979SC2mWcVxaOJsw+R5MxcRgEBKqI3EDadFkJt5qlrPBSPdPvLo7nXQOrayJMCAhRkzkKiMxGziOj7TZt9qOOnryY3W1I8spl5FVHX4iHCNl5gbnrmndJMUUSas/PKFN2N9vc/f4lIuTWPJheQaF55/01o8ahrNiyiA3PSQWB9zW9lO/cnK6vyw6PlydMxKR7ponllqfPMQ1FAgJKaXijyoHhUyywedc6HAgLAmjoPjovmwowjigICIJeYO+pDWbntOLy+5he+WbLJxaNI94G0wlH3jCggAFJFNwvo5gDMKpqVi7MOEwUEQCLzkb0nR+PKft+6n1nPo2hWWcXDhYwoIABi6YCYt3B4nuflOaN2YWAsqmhWTcGNhABy02ecqI9Xl1PbUrMu2TSxeCQpk5UrOTEDATAj64xauwybBoPt8PQ8mGtB3WVtzooZCIDcktrY63tpXDmrrsq8WbmUEwUEQKYgOIxtVx99PYlLg2JZZbNyCQUEwIyktvXRQdD3t8T3tyavnxyNRS/NqLYVj7ivRb412kwrIq5lxRoIgExprep1QGxLO/s0bcuJAgKgEHN30XC4NzUgDgbbU4vCrp1RV6lITiJuZuXcAQNYnLgdRoPB9qQ9R7RNuTo9D5wcEOdVNKezi5HX6/bDs4uRV/eW7WmYgQAoxWxTrgOmg2PhvYu2czd7ZLlYPAAgU6/bD9Xxu+vw+N11aJ5R97r9MGkm0ibkBAAxdPBTDITx2pYT0yYAuRVpU95m5AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaKf/AazGqgAsxibiAAAAAElFTkSuQmCC",d0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAACQdJREFUeJztnVFoW9cZx/9ORTEUP4UUmvTGRpjUEfaQjRimTiPLXkgfWpwy0TSQGQqZwSHZTBF1MIHNEIIdxOaRgcEYBm7p8iBIQvJSmCN7NHPYhCPqoNid0ZzcpS/GLysDk3ncPlyd63uvrhQ7utL5jvP9QMj36kr6n//5zqfvnCPbAMMwDMMwDMMwDMMwDMMwDMMwDMMwDMMwxAg2RQw/r2N2B/vPvMooHf/Bpojxv//81PASZz9X7jrZqNwB7D9TKSr7LzP+9/n1Qj/79WcAigV/t/zAcU5cR4lgU8RY+XafZ3C421PqOtmw/3JRPQGp7r+s+K84gQabIoYWS+CPQ1HHObfJ4nh2Mg4tliDXCaomIPZfPpyA5CE7/n2pQPV0EgCgxRLQYgmsfLvP+vnxyjq+W35g3R6vrFvXU0B2B/gB+y8fTkDykBn/viRQLZbAhYl561gEib1T3NdTQuUEBLD/MuEEJB+Z8V/nx4uIILJzf+YsAKCr/8uiYz2dRH4t48t7V4qXdoHogKPvHLDOPV5Zx4WJefJtYP9rg0iEt2/fsQbxX/7wO8cgduvv6/sQAMjoV9l/QG78V/wi9k/Sax9u4Z2O99B+bhJ/++Zf6Gh/C/Vv1AOA4/iwFiZjPqB+AhI/s/+1hxOQXJSO/2BTxIh+esOIfnrD+Mc/t4xgU8RY+tNFI/BawNjaNI8DrwWKjilNX8R0K9gUMVIXw5b+vy/oxtbmlqXffkxFP/tPA3s/iJvQ7XVMSb/K/lOI/4AfLzI7GcdDHQiFWvx4uZph/+RNjsRx+kQnbneYj3W0v4UjLZ3Wte5jSrD/8hCDUU8nd1UBUWAv+A/IjX9fEqidQ81tjuOH04MAYAXSjfOt+PyO3+9aGaomIC/Y/9rBCYgetY5/X3bhewdTAIBcbhmAKbr+jXo81bM4eub36BtdwGEtjMNaGD0fn/fjLauGVwfY23PjfKskZaVh/+UyOxkHsHcTEHX/ZcZ/RRVofi1Th3TSAIDT6ST6Dz4HYHbCw+lBtJ+btDK/4M3u82SmMILewRSSI/FCBxy3OgAAjp55gCMtnZbmno8HgDtTEtVuw/7TQ8UZgKr+U4h/377G1H/wOX7+S3PX8VBzG97sNjP9+yc/QS63jFCoxXFPYhcMzl28/oPP8avxCwCAZ6tLaD836fkcMrt4Bdh/OXhN4TNfDDi0b/530zF1z3wxgMgvpkjoB9T2XyAz/n37XfiZ719H3+gC+kYX8Gx1CYApPhxuB4CieyoII0UHCO0ieN4/+QkOa2HHPUXY/9qTX8vU6ekk9HQSp090FlVAAKyppLiJgU0Flf23Iyv+fdlE0hq7Hcd9o3MAtsU+1bMYG88WHj3jx1v6zsz3r2NmdAEAcPs35jnRAbncctE9Nex9wP7Xjvxaps5eAT1bXcKh5jZHAvKqgKihqv8CWfHv+y48YDZGa+zG2PgwAKDr2JD12Nj4MLk1ONU/APJrmTqtsduair3If4rwB4BcVPbfPX5rGf++rWNEownHl1Nnvx5D78lL2yeCESRH4kicM8/pT+ZIraO49QPA/W8mADg7QJyjtA7kpV0l/730A+X93/r/FgntQGEt1DaI9SdzeKpncWl4HIBz0F4aHsdXX/2ZjPeA+v7vNP4F92fO+qbftzXQ+fmkQ9BDHeagnR5ziLcfU/mNBqBYf3J6DF3HhraDp9CWrv4vrXOU9LvZif+Umf262H/AHMyUZjDRaMLwqoC6jg1hbHwYY+PDVjvEuad61vvFJFAqearifyl6B1OmZnEDgHwGyGd81e/rFH5+Plnn1SHJkbjzRD7j59v6gmcgFao21aHsf6kBbH0AOLRvV9DBpohBqYpzY1ZAthPBCJDPoOvYEPQncwBAWr9K/nvlneRIHImrqZL6/cK3ChRwDobE1ZTnNYmrKRFAZPAaxKX0q5JQhX53O6j57678BV76qWkHSuu3V0DJ6TEzbhSo/AWq+F+KWumvzhqoK1BE0klcTTn+liCVT7CiBFpCP+BsAxX9QHn/7ajov8D9dyhZvz+8jH4q2u1Y7aih/qrswgtEGe1VzVHqgHJLD2791P6YrKDUNEbg7gNV/BfsVf3RhoD1vPkf5GzM7FY/Je/LUQv9VUugQry9EadPmL+RoUIHuPVTHsBA8YaW11IDxcq5FOWWSijotyc+L3ay1BNtCBgXP/oAAHD95l1/hL0k7iSqylJVEYXqs1b6fVkDdQxej/K5VBVKhRfpF6iUgOxQ9l5Qai0RoKs/1hZCrC0EfX8YWJxwPOZee3MTbQgYs+ubAIBHq/nqCq0Qqv7bscawxwZpNfX7uokEwGpAKdHkk4+HfhWnL6r5H20IGFicsBKRl35tIwttI+t4jrjVTGiB+R+26tJLOVy+t4hrx9/2vMbdBq2x29GGWwNxPFrNI72UkzZ9F6jmv5v8WqbO0p/POIu21Fkgddb6P09+6vblX3q4vwdnPuCs5KguoKuu347XOpb+ZA5aLEG6eo42BIxYWwitzUF8/td/bw/SDvMrP1pjt3m/kcXFjz6wpruz65u4NWBO1a7fvCslCYlKsveA+Vd/9P3b3zG0dBfuATjaEGsLAYD0BPoi/wUU/ReUawMWJ6qmu6IGu9fdtI2sI+gFIvj1/WFcO/42Tk2lcKSlU/pgVl2/G+vDYHHCMZABs22z65skdYvgB4DW5iBOTaXQe6DemYw2soi1hZBeyjkGgJj+ykpC9oHrHoz2+NI2stZjv333J4bQDMjbPBKo7L+gXBv6Dz6vmu6XfqJYAD81lcKVng60NgcBbGd0d/CIIHu0mi+69mU1VILq+kth35h4tJrH5XuLuDUQx/Wbd2HfsKCoGyhfHdgHiYBCEtrtTjqFnXc3KvsvKNUGAKiW7op34a/0dODyvUVc6elwnLdXOVqhYSLrU1o0V12/F0KfaJdI+JR1i0DuPVBfNEgd1yzlDK/nUWCnWihpFuwl/91tqKbuiipQr/OlhO32+mqjuv5y7GRxnKJuAcUK7VViL/i/F9rAMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzzivMjXk4u1W//VMIAAAAASUVORK5CYII=",u0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAA6BJREFUeJzt3LFOFFEUxvFvjW9hNm4mlFKYTAGdxlDTkFCRWJHYWG1FQ2ioprIx0cbE1oYHMAuJCQWTUGAJ45IJtY8wFsMdF9zsztzZZe6R/68xrnt3v3vO4Q4woAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwFTRIC66zvCYWa+/9fzoVtfz86TN4mgQF/3XQ69NRIO46HrzLkfXGXxZr7/1/C5H1xnasJw/hPnxPkDvv3mTMG7jvptflBAa4Mt6/a3nn8xhcX5cBqv5Q5mfpz6LokFc9J+/kiR9/7ilN+9u/2GUFNk47c1b3389VLK3pZd9lWtrrlukNoVzDZDUWfY29ZfUaf3/x/mJBnHtDF3Pj8tw/+9W8oc0P40P0Cp8FFePJXtbkqRhlkpSozDJ3pbXujamNaAvFfkoUegH0CLqXw2/Hr7+/+v8SDJzAbCcP7T5aXSATgt/nksv++WfimL1y4dnh8lSDQ//brz2ugWwfABZr7/1/FJ4H8BNWc4f4vy0uok0aXj4rQrzEOt8zGqAy9B//mr+l/dZquHht7JpTdYtkYX6LyMH81Of9fyzdDU/fgdoecWpnOdSPkqUjxKvlwuBhQ/givX6W88/han5WWCOxz7//p+BZqnyUaLtjTVtb6zp6teZjvbXa23i5CTpKUu1vbH29/n3irJUATXAm+X6376f2fzW58d6fimY+Wl0gGbjtJdfHyu/Pq4eO9pf19WvM/3+8VnPVlar5816nWgQF/n1caNNL1wgDWjCev2t57/D4PzcYTB/iPPT+C78RLhCkp6trOr3j8+6ubzQ5sHp3PXRIC7Sr7v/PJ5fH9e+A+7r9vULSXJ3IY/21/Xi7YeJBpw2asDPL++1eZBUr7dslusv2c5vfX6s55fCmx/vL+Hdm91cXkgqNzIt2LR18c4n3VxeNLpqLEo2TnvuSibdbUC882nueteA+3t9qAPIsVr/yRySvfzW58d6fieU+Wl1Fz4bp73Ng9Oq8G4zs7gGuOB11ixDKA1ow3L9Jdv5rc+P9fzuPbueH6/fRJqUjdNeNIgLt4l5hSwbUH76Xadhy1Q2QIV0qvTrbqMGOF0eQJLt+ku281ufH+v5pe7n58GvGpPcz411cfWalqNuFvd8N3SbB/O/bxSiUOrvK5T81ufHen5foczPo9X1f6gA26zPj/X8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaOsPJX9bKo9VcbIAAAAASUVORK5CYII=",f0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAAzVJREFUeJzt2r9rGmEcx/GPpf+FSEQc61C4IW4pIWR0CWQSOgShSyeHkEVcOjl1KZil4FTo4lxKOgQs5KCDHY0xBOfMneygd57eacL98PLo+7X46+Hx+3yf733P3EUCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkJRC3pqkHcMuI//YZWnU/6u4JirkrUnuXd3og9j02Mk/ojA5/2nVfywNdDloEzfC5Aa0Lv+mrMfk/DtMj93U/KdZ/6+jTlDIW5Pc3oEk6eeXEx1+mH1w1ZoMR3bGGSNJzuugOZznq8YkKWgDvLGnEdNzrcu/JH378VunR/vkP2FOA/LWvSlMzn/a9R+pgbrBFyz3vdbFiSTp9KrlBnZ7d6O/Xz+q0pRvM5wxdqcmSbKq/jFJSnsDongq/5J0erS/kP/lGMl/dDSg3a3/0A00KPg/D9Lb3PRRkrqNst68/6zH60tliyVJPd8c3UZZ2WJJVrWtbqMcNpxQwmzASzkBhM3/cvGYln+JE0BcTM5/1Pp34o5a/7HdRPKqf/ouScoWS3q8vtR40JdVbfvG5fYOZgubL2RT1m2Ao9so6/buxrMB/jm6jbLsTk1Wta3xoL+ByJ+2zfn3HgBp539hDbN1tC5O3CYkzRtQt1F2Y16eQ5o2ILtT29g1yG3I/yqbrP/oDXRoL7w8PD5333MSmi2W3DOU18P9L3dx2WJpJzcgMvIviRNAnEzIvyvl+o/nF+jQloa26mfnbmDDkZ2pNHtu4oOCc8Y4dnEDYkH+OQGEtQ35D1H/w5GdiaP+Q18DnZ1JJ9K0EKRp4J7PNBzZmULemjiLCLo28pwxiZsVTP1s+jjfAE2knuxObU0DkvsnV9B13sRC3vH8O3Gmlf95IPbCr9DD43P3+XjQV7ZYmjWgkq+JThvQP1Waq2tsIwzM/0up/1gOlqf+TemlcuJetQHeMcvvB82zbkySyP/m8++9ebTMaUDe65vjQV+VZs8Xn/8mTHuja5DMzH/Q96fx3UYdcEkxtQFtC1PzTwMCgIiC7q4DAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOL1HyL1Aqy//oIZAAAAAElFTkSuQmCC",g0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAgCAYAAADaInAlAAAAAXNSR0IArs4c6QAAAgtJREFUeJztmj1Ow0AQhWeRKc0BKKNUUcIBaIw7pFgKuQAnIHeg4QRwDKQIKdSRzxCUClHmAm4oLA0F2cjkh6zXaz/bma9K5bd+82bsdZZIEARBEARBODkUegEuCHyP9e84SVtxT0IOmJkD3+PX+zvOhqFKULpF9c9ciSMNUEqpOEnVx+cXTcYRrBhoH2z0nQSgyAJcwcw8XywJFYI4SVU46MECaKtfOADMzERE4aBHSAOIfk1AhgCpDdHXxdcEvseP11fQZzFqHdoLlAe2+tYTgJlZKbXzxo3uAgRZL9BTKK++ZyNyqPibLdhiyUREk3FENJ1x1VuzOEkVeg1NIfcEOFT8OhIOo9I19vnRpCmQKwCmxUcboJm/z2j0sirt+sf8qCKA/2GibxwAm85HG0BE9PZwSUS7L6xVUHYAXegbBcB27KMN6Hc7G32llHIZAhNPwmG0CSACE32nH4LqxuhlVVoBTAKFbgBnE8B191TF0+33HwOqvo9WTQBb8+puQBGOedKaCaAxDUHgexwOetTvduh5OoP9RZs1gNdUvYVFNoCJfu53gKY9DrQBao3r6+/zA90AefStvgTqm942VO/30d2PLkCTsN4FbCcfXXzkVMp6gQ5fXv3Ci2Nmvrk4JyJ85xPhCoBuAFt9ZwtEn8urQwGa1Pmtow5nEZp4JKxVnLwBgiAIgiAIhvwA7Cn27X2XP3EAAAAASUVORK5CYII=",p0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAI5JREFUOI1jYBgFlANXDZv/rho2/0nR01LXDlfPuHLpmv8MDAwMc5onMDAwMDDsvnGEkZBmVXVVhts3bzPUNFUyMjIwMDDADIEZVOwlynD9ySsGTRkxDPoMjxmDiIgIg6CwIMPtm7cZmLDZcv3JK7w0AwMDw/u378n3goiICMObN28YapoqGSkOxFFABQAAAr9HnRBKjFsAAAAASUVORK5CYII=",_0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAHFJREFUGJWF0DsOQEAURuFzbUGiUii1OoUN2alliESjMoUg86AaGcI47f3yF1cIWubx0JvCmh2ANK/E3+QNeQiQFbVc8AuFOAGIIV8C/KILxlrm4b74hZw1/4vOGvSqIHzP1HfHc0mvirJp5QY9fkMAJw9eXg2Xm1L2AAAAAElFTkSuQmCC",m0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAIRJREFUGJV90DEKg0AQRuE34kHEVtJJihwgd/DO9nZik6QKIQTBZd1dq5FJjL52Pn7YFUyXc5M+45N5djg30g+t6C2zCFgRQFnUaQMBXu87ewnAqbpu1mz90Ep+BGwZcIj0lu+BEDwxhu9F+w2Kfvu7qEsxBm6PTtBXa2VRJ++nFSoCWACc8UydDDmB8AAAAABJRU5ErkJggg==",v0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAgCAYAAACinX6EAAAAAXNSR0IArs4c6QAABFdJREFUaIHtWU1oG0cYfSsFH3IziUlyEMjSRSq6CHaFQdRhocdSQwgklOJDQsjFJkHoJkMpRLdiCim0OdiENu0xYOgxxU2KymK5CIKIvBZ2HHJJUUwKvhkW9aDMamb0zeyfemn6gdDO3/fmvfnmb9dADBsOh0Mq3zAMI46/qJbLmiT+4dFuZPzQDVSklY6nLIaKtMrCihFYKSrxCYCEQkQlLluQENrCqKE+7akRNdTjTI2UqkAmYxiGkZ+3tGRYuVwnThRRZA6Pdo0woS3X0UURKQDfYUYolzWH7vOU4Ex+5stlIaKIIHe4O+ghfewGtksfu+gOeshlzaEslkqECQFk8nzZJ3dqQif39xzBMV9OWRgR5I6u3lpBaa6I/slJ4Mj3T06M0lwRq7dWSMJUniCAinwuaw4zdh3f3r1MOmLpX7+7ioxd99MUYZ0IvF82ek7nCSyzMBFt/I/Pt8wCnM4TJWE5zxdAN/IA8Hr7awBAxq7DfZ7C/p6DnjvA/p7j/3ruwK9HTSOdCBR5Zu3dPYF4323DMguwzAL6bhu8EKwub7rpoFwEZcvYdax883REaOYP9NyBst7By7afnsZ5wDIL/n/fbePhdQ9rixtYW9zAw+setmotoQ4vQqhtMGj0mWIZu+7ntX74AtXlR/4zAFSXH+G3zWvQ+aKwdKPPwhoAfv7pR8HXiwenQvres5uB5GWsM3IFqkGj7IwSf4/zlz+7ivylt/j4ywvA99fw+1d/4XLzgpZ8Eltb3MCLB6f46PYMQJCHFP5hT4KBAgBAxfYUJbN+R3jy+XkrjNtYRhEHgKX1aix/KV3457LmcKvWmmh0/Oad8FxanfHT3fun2Kq1lPuuvBgGhX+j7GBtcQMAsLOdJvF58lu1FhplR4kvL4ahIoDZznYazc4CGmUHB71R3o3H45Hv3qdHJ4nx0VexPSytVwX8ZudTv5wNVsX2gE44/4EC7GynySlw43FaSG9e8VCxR89shNgoxLmmUvhL61UsvfoTTSxo20TBV26D/OLHQo91RCafn7cEkQ565wEAjbKjDUedUfgA0Dx7dqJud9AT0lHwSQGElf+9sU7wezzeh/3m579M+GiUHV+UqCKo8BtlB6W54gROaa4IuX5Y/IkpIINXbM8nLy92zM5dnPWfR+F3nmwfxnT4zc449MeLs4cGxmSj4qd0R1TmtGJ7QtjrFjsWfqqtU951dDc2Hp8mL9YLgy/vOso1gHfAj/zmFdrx8Zt3pNJRRl+Fz29zcqgnxSePwiwMK7YnkGcHHNaJfPEtzl2c9Tt4eLRrUPO32VnwV+IwR2EenzrgJMGXscjwZyLwC15+3iKdIMQbGB15qg0jIhNPik8dupTnABV5ClDV0Wnav4Uf+O5uWpeaoBsnNO8Bp4GvOnKHuq4mtSg+dXeDuKbzGfh6O6kIcXxNU4QgX0rn1GvxKMBJ2wctdNNq/8F/GPn/01hYRx/sx1HK/kufx/8BIGcdX7vyn5QAAAAASUVORK5CYII=",w0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYAAAAAwCAYAAAAYeq1+AAAAAXNSR0IArs4c6QAACNxJREFUeJztnU9u2zoQxicP7xhZJM4VHCBdtL1C212aKzRddBHkCA9ZeBHnCq4BB0hzhbYLGWiuUDeAdQ+9RUKDlflnhhyKpDMfUCC1JOrHj0MOKUsygEgkEolEIpFIJBKJRCKRSCR6aRodjLvRwbjLzSESKUk8ptFeysL1Rls9PiQ9VwqF8qvjctc5hH90MO5+//kFy+USzk7Ps9bhJfqfkoXKUAq/ismjw+OgOADxP17UDDw6GHdd13Xr9bprmoY0oyxhBhrKr46j1plbFH7lt87eNE03mUyy1aE0/2uOf8VCZQjl55TOsVgsOj1WXT6Vwg+F+0+aFWIysAL9/ecXtG0LbdvCer0GAIDLiysATzZLNQPFZmAMv0uKHQCgaRq4uf46aPYO4Z/Np3B7ewv3dz9gNp9u2Nu2hfu7Hyz8Nftfc/yr8tq2haZpUB7G8IPmAVfcfP/5DZqmgeVyCfd3P+D3n18AAJt2Pjs9Z+XnVOn+/0upwH9XF3B5ceXMRKqj6PBt2/a3W8vQO/Cnzx/h5hrISydbHY4Oj61l6R3XxT+bT+Hk5GTDqKQGUH3w0Y+LFWYA1QcqCr9ih+fO9OnzR/bBv1b/dyH+1eCjyu0PoLpOTk5Q/K521BJYNPvq8WHv7ev33bsPbzYxenR4DAAA/11dADzHBBc/MCcwKNx/bwKgVkB91u986v/L5fKvIFfK3YFVEPn41WxjNp9C0zSbbSUMoLP5NIi/z3lzDawzuNr9rzn+MQOoOqe+AvTx25JYigSm2KAXkyqW3n14E8yvl6dPQoZMYDn9R18C0iugZKpAf7vKZKozKpNtHViBc3VgzBISerNgF79err6vaRv3AOpaQs7m062lMJa/zzn0Eh4K9h8qj39wtLXJQ/0zH7+ulJcQ1erXtgrW25vK3+8zqS4hqr9L8x+dALAVwBznOzZHBzYZVcJdKJQBdDKZRPPrnSzkzgVbmbX67+KoKf5dA6jrOBOf2vbp80eAASZwfW8osezjf/XqFUDmBBbDDwNMIDYgoXdChBzHfReEqUzsnQTUb+9Nf8dodDDuvnz5snX3w2Kx6BaLxWZbyfy1+x9SXgnxb/KccqyL39euEdhWXm7+yWTyV/8xfVYyf6z/qC+BVRYJyWLU65gpZqBgWF4BcobF+UVujFzXQPuf66Lw9/0OaW+bavV/V+I/VC7+1Gym+lPbwMff/77L9FlOpfb/n9gCSpepAw9xLu7zmRp79fiwp/5xnCOFdsX/GuUaQFOfsxbvU/afGvx3JgCOCnDMQNEFJFCJM1DK8Vh+26wqdxvk9F/iP5//rlk+xZfQFVgJ3sMA/idfAaiHGHKIowNj+UsdQMX/l+k/1wBK4S8xgYn/7vNYEwBXBUz3SlPOlzuIsPwpxDGAYvhLuNZsUy7/Jf6flMN/TDxifaHwl5jAUvuffAXQv/VvKHF1YAx/yQMoh/8hHUH8f1KO+OccQLH8pSYw8T/Af+wBrv1GxJeRcfBwlsnJj92HyufbjuHnaOtQPt/2XP7XHv9D82PKwvBQ93Xtn4ufsn8J/idZAYy0p1fVlxiz+TT4vmxqFovNwBT+Emef3P4DsQ3E/3zxT/HDVi6Vv7Q2SBH/lHPX5P/WcwAhFTDt33+TnU2lBY8Slh8ryv3LlAHUdf+/j18FVMgMLXWb5fJf4v9JnP5TvIfAGXe/bAp/iW0wlP+ol8HFSs9koRq6A+uy8Zc8gOoy8atZRojUy6xMEv+3NVT8cw6gulz8XINnTDzCU0x6J0OhypHAdKX0/68EwFWB1fMb8NS7XmzvpSi1A2P4Sx5Asf4D8T7joe4Jz+V/zfHPOYBS4gcrSrLHSu27v7+/dS4sf4kJbEj/WTrUcwXIL8OK6cC2xgwq0JJQMPwhAev6oQ9qQLr2d/Gr7d9/fiMP7Db+mv2vPf5j/Njf34e3r9+TX8aXor1TxSNHf/P1tRr937oExJGBdX3/+Q3evn7vLYNyPpNSLSFt/KvHh72jw+OggLUpxRKS4r/veqPtrZ2wI/5DxfEf44dp8FGy8adaAYfEo0su/zlXYLX6v0kAqSpwe3trPKaWDmzjN52vxAHUxb96fNg7Oz3v+u8W78v2Tn7bvliV5P8uxj/HAErxn8JmUkg8gmN2Dw7+WhJYav+dKwCOCvgAS+/AvllX6QMottPp1xtNZfjYd9H/muIfEg2gNv5UCYwSjz522/GU7ZR9a/TfOBNVFbAFJLYC2GtwlPP57oLQzad04NBriGq/2AEUMl0D7e+rfmQCiB0NdsD/fh1qi3+9TI4BFHMNOqS9sXUARzz62LH8nP1NL7cW/61BGVsBtcRaLpewXq/h8uLKuW9pHZjCDwUOoFT+fj2UqHce1Oy/Xlat8a+XCREDKJY/RQIz1UMXNo59/CUnsKH8Nz4HsHp82FM/NhKTgRU8ZunkOx82cDiXkFh+vRz1YxL9zynsXEtICn8Ir+34Wv3Xj6k1/vtsfT8oZWH4uS4husqnHqPk409xCVEvGyrw3/ogGEcFKE+xldiBQ57CK2kAzfUq3Jr975dTY/xzHY/lT5HAOIThLzmBDeF/skYJXbqVwpGbn2MJ2f9M/B9OL5U/9hIil6j8nJcQOVS7/zB6fpudUsxDCzlUCv+o90PwWI5S+EMl/Hn1UvlD+loKDeU/e3ZQoKan4ly3+5Ui4c8r4c8r4c+roflZC9MfrmgtLzA6Oz0HKHQ5LPx5Jfx5Jfx5lYOfzQQXvOnLDOxtiUNJ+PNK+PNK+PMqF390ARzXpnI2hPALf4yEX/hjlJs/6vcA9AdYQnV5cRV1fIyEX/hjJPzCH6MS+IMyR8pvx4fIxsJvl/D7Jfx2Cb9fJfGTVwCjg3Gn3yvLqZvrr0nK1SX8dgm/X8Jvl/D7VRp/9Hs5UihVFhZ+nITfLOHHSfjNKpEfvQIYHYy7dx/eBENRdH8H7D/SLPx4Cf+2hB8v4d9WqfxBj+QPrZjGEP54CX9eCX9evWR+kUgkEolEIpFIJBKJRCKRSCQSiUQikUgkElWk/wFLjIZEUKFiEgAAAABJRU5ErkJggg==",x0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAALpJREFUSIm9VckNwzAMq4ru4Wm8lAfIUpkmk7ivAIFrUqQe1dPmIfmQ4iVEH23u1s/jioxLAUjYMdpuqMKK0c/CThxlqGCDEZQzznixAz0BfbRZMbo5b4XQR5vVewmW/bqHMAh/HlfQCpCYU1Gw7Fl2LIknLq1gFUIVIY5lwIyQScnAiU+F5Lwsy6DSVdN/4AqvWmkF7kdbg/Yit/nZvegGofdvVVDJWOH9d+AwohLSyKwY2UNfNVLu6AtJL5wohWOTxAAAAABJRU5ErkJggg==",A0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAuhJREFUaIHtmDFo1FAYx/+1glTUxeG4o2Du4lKwS7lmkXBxER2cxAQXCS4O16FTaysULEel+5XidpvNOcpxbpcjcMJdtgpdTJNBKreKKA4SB32vaZqc1fcVj5IfhHu59/He933v+9738oCMjIyMM0VJKofsSeunnO8c5WAlqRwWZipo593U/nbeJTVigmqgklQOc5KMyalpHOx1sR+4iWMzuWHgpcr8DedFB0iDOlTSIDfgYK+LnCSn9g8Dj3Q+shBCJDwAQFPUY/0bm1WsLm/BajZIwgeUSRxVfhh4MJ2FI/0bm1X+a+gmWYiRh5CmqLAB3A2Awq4PdbYIAFhd3qKeCqA2oPHdgtk/NAIArGYDABLzgq2CSDiR1gHzggFNUbnSDEM30evsQFNUaIqKXmcHhm7C0E3hOUkNGAYerGYjVTGWB/G2CKQG5CSZbHc5KaSVmLUN3YTddzA5NQ11tgir2TiWA6weiBpMlsT7gTsR3UoZzq6PwkyF70YMi+goQRpCiHhWU1T8+PbxSJ/dd2D3HdL5TiVe40WqMFMBAL4Kdt/BO9simfvUEu5PlZYq2U9tBaK5QJWwSQgncZKn2XmftVldsJpIXBURw4Q8Elc+J8mJlZgRLXBxmX81gmQX2q4twvMHvBIDgOcPsF1b5G3PH3B5u+/g8aP7/PlvsI/325frYUkqh1HS/l9ZqocrS3X+Xlt7kXoBcBKEViC67HPVFuTiPH/mqi0ul3SUlovzAIBnz5+KqEB7nJ6rtrBw5xLqb78k9jNDWDFjRogkMfkHTeXGRdy8dgsPX75JlaG6kQD1UeLVk3vovv+aqHzc+1SQGjDK6wxK74MihPYDdwISwuvrwJW1B/z/z+uv8eHq4TGaba/U1Vh4sOhN2yjiMmORA0x5TVHh+QO08y5yksy9zpRk74ZucpmxuFb5rWC40dn5dWH1qQzg+Eowz1uBB+h19DarfAsdC0Zdp4vIZmRkZGRkZIw7PwFWwmQPmkz7+wAAAABJRU5ErkJggg==",b0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAA/pJREFUaIHtl19oW1Ucxz91QQpjT4LQ1dOGSxg1tJCEi3TM2aRV5oOQiUUd2KIwBxvrVuSywRAkUEYrQZ0KhWww2WQ6CMiYb3Omg0mCBhdI6bIS47pL9jLKQF9kFq4PN/f23iQVk3scIvf7cvI7+f3O+f0/vws+fPjw8b+AElQNmXyPFUpQNf787TmjnXLOvb/j6xZPyDroxePvQRuFVysF157FJwueDVCCqiESGp/Pjrn2mr1s0dcXJxEJTVoqBWQcoufSMDuGSGgAfHfmI9vTt+88YLVSsHlv33lg8kuClBQSCY2jn9ywaUt5Z1Sa+WWhR8YhVho58cOFtwDYM/1lC63n0tTuFqXc7RlWvitB1cjORIzy+RkjsC1g/JjXjY0/NozAtkAL/Z/pQpbnRULj8rUCJ65ullQs2seuodEtaVmQUgPXFycBCIeHZBzXEaR0ISf6QyMu+ta5wwD0bu8F4Osjw5y4Ku8+KRGYOJwFYGWlAg2le7f3ck8v8eyBj0mm8gyICAMiwvjrR2RcacNzJ3AW5PTORxxbOApAvVomenCxrcyAiEjrQp4OsYpYz6WZ3vmI1941+35/aISn46anX973JisrFcLhIddqwashXadQcyu8cP9Jkqk8yVSeerVsKx+JRAFaVqt7eW2pXRWxElQNMRiHRgeaMOsUPZdGDMZJppZcyt7TS8wvlBrSBwBIn5okKjBlc2mj20h0bICtvKLae+lTZhvVakX0tSXEYBwxGGd+4SQAe56ftXnnF04yICIuWa1WBOjKiI4MaKf8LR2iwlxRVASgry2xWikwsc8prJrKHjTJN14a5fK1gv2fMH91bIS07wHtdNZWBjYNSp+bd0eriW6W6xTdPWS1YksUrBG53aRppZhLXhI6CpezeGmkioVffv2J5S+OkUzlockQpwHa6WzL94BIaNCon05TqKMINA43ACxDrnywm+G3P+XhzbONMSLfEgU7TcCl/KbRaZyO+dcMwP3wGDQerYc3z1Kvlm3vA+ztq5N853hbI4oXD7Wc24338VLE1mXWo9UfGnEp5lTeVrLhfXUqQ71adkSt+xfZ0zRau1vsSaYwIE/x4iHbmGZcOX8G6Ldpp6FbyfxTeG6jlufUqQzJVN7OZWfKNPOrUxnUqYzXq0HWNNq2ABWVvX11m7x06auWNLHmIC8Dnedp1EmL9RLEZu1xwoK+toRYL6E/FeHDF55hfybLrqFRKSN11weM7QgYM6++wv5MlrnxGMMhBYDPvvmWG79v9DiNE+slEiNhhkMKy9VaC68XAzx/Us6Nx3j/+5+ZG4+59p3eFTsCBsBytYZzlQFPEWi3v5VHO+X34cOHDx8+fPh4DPgLH7O+nPtWwn0AAAAASUVORK5CYII=",y0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAA8lJREFUaIHtWDFoE1EY/s4USwVBsYNIF+uk6HpQ8eJlKc3gUBCC6NAtiKFLIWqFgIEqJnQp55Ch4FCxmRwcLrgkJuBw4FRpp+ISSgOKXapEEp9D73++u9wl95I2VbgPjpZ7/12/7/+/9/6/B4QIESJEiBAh/iOYAKPLb32YfE7IBJsAW4ovYHLKf31yavgiAsEE2JSeYDfiC77ZF+OGJWKk3wf/lSxLC3hiLiOrJ3zXM5Vi1+fdwuOAIstBhNTDJsCIvK5qHevPXjzA4sOXiOZSHcSI+M5sC2qsDQCwyhFceDsykJDAm1gkn6kUMVdLdZCnn9W04ci0CbCd2Rammwxz6xH+jBprY2KliZ3ZVt+WlLaQrmrI2iJqZ75Au3YRALD48KVnPJEXiV9JnsRm4ZdDiIUWzLcjTLYSUgJeNYuYs/6KiACI5g4q4d4XUYG8Gmtjs9DGleRJAHCQH1SEVB+YG01AVzVOmlBNG/hYXoeuatBVDR/L66imDU6MsFn45UleFCELKQGZShHRXIqTc4P2AezKTKw0O2K+7X73/J0wsdKU2g9SArJ6ou/TwipHUJ8fxfbWOKxyBFY5gu2tcdTnR2GVIwHe4A2pPWCf8awq3KumDURzKVy3avze9VgNGZu0rC2oKlSFXgkLXAF6kXuz1ja+YCm+wP2vqxoylSJ2ZluALQKCv0VBXve2t8YBu18EOV6lLASh0+qqhvbPumOtYtUQzaU4eQKJGFvc5YSJNN0TITa7XiL68rP7hUvxBcAeM0Tyaqzt8HcvO33b/c4r4O7Wflbqew7xywoJEMkGFeG2GwII6GsaFccKeAxw/WxcyryIIKdTzwp4ZTqrJzjprJ7ggx01OPKwSICGNqrQpctfce78WdTnRwH7kKDOLaJb9nsKcJMnsu5OTKAG597IIole47TsuB1IwIm1NUzfvYuS8jd8hjG8f/0av+/dwww7+Js00FWsWoetBp37/RDoGF2+v4eSomCGMX6VFAXL9/cccTRK6KrG4z5lnh8Fb46uAsSsreYbKCkKv1bzDR7nNUpTtZ48fXTIlJ2QamSr+QbGNvYd5EWIFoItoqQoR2Yf9NOJb149hTfJW11jMpUi4oBC1yAEe0FKwJvkLXz4/AN3Cu861tzZHxakBHgRd4OyPwipQ4cJsOnTBrudb7DKxj67nW+w6dMGo49Yj9NG18+NR4lAnVjsvH5wxwyrCl0tROTpXJ+cOiBKc5D7f4Rq2uAx/8qXO5gAY4w5bCLaxX3vcdpgjLFjsZMvZPx9XHshRIgQIY4HfwAAqOz+tklkrgAAAABJRU5ErkJggg==",C0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAQJJREFUWIXtls0NgyAUx/+0xiU6ThfoyRV6781bb3jpAF3CdIfO0gG8mjSvh0pFQATUEBp/CRHkCe+LJ0BkmPri/jqR6J8PD21+aXZrb7ApMAWTYz5FlxOq/FiemNbVZH094KysK94hIKUNu/1YlrkB4GZZZOpRGzmGhDXMB5BNzA83JgLa9o0834MxyHPMouRFGZfSZ9FPgb8CRfGzXkYLriNaCJScWCPsdgWsGCyfS2I5QATUdUQFIiKqW1B7AsS1AvolGQ8I6OppPQfoaCkTyXkAABqXfODDuDdji0X3wJzSZvz7Vd2zdNwjaQ8ICP2Nx9lyQXQPLEnQleCvPLARxAd9AZHBGwzNIwAAAABJRU5ErkJggg==",S0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAA7VJREFUWIXtl89rXFUUxz/3/ZiZxKntIgSr7ThJhErSpimChkaxVYqSlQj+QOtCjXbhHyAiLairgnTjqhIRxUWzMuLKGjShzRChqLXNTAO1SV6qMYk0STOZzHvz3r0uknmZycyb/By68cDA5d0z3/M953zvue/BPTax9sH5v15Q+fWph3pL9nfatGoHWM+MnQST9oISf18DQDQc3VD1tkUgl11Q8pceNMBoaEFNXvP31GhCbYSEKOz5elaoiV8/PKGOvH0GZ2KEUKwZzxrBwyMUay7+k24gYo8HEtmWBqavJgjFDwEglU0o1oxjJXHGCiohDOTNSyr72/dlE90ygbG0hOwdpi5/C5m7mPUxWJpDRqI+Kfvf2wihQNPIZZfK4mz5GJ55pV29cfRRJIJIzS76plwEEV7r7EBKCcCN3s850vURuVwOc3cddipB5Ng7RZhbFuHHPUPiuf2G0nWD9rP9Puhbp88BMPT+MfVY5+ukb10l2ngYMvNlcbZ1Cjo+vRxYofaz/cLuPKmijYcrYtzzQVTVUWsPdCvAP5pSgjY5jHhyVQdVq0A+eKG5t5Mlfjs6iguDlwwkwNjXDJPDmyegRhNlh8hG530lq9gCNZpQ8tZg4KiW1hW1llwlf00D9rXy5Sfv+T6BBPI9FKJ8ksqIIDzHJwogh75RuYlUYEKOtUkNOFay9HIBlB5CuFnfZ/hiD9lLX6mcnSXU0AqeWwm2yNY9BY6VxB4vEI4R9jMva56LEsGw9tgfmyPAShscKwkzFqxkDpAbv16WsFASlFeyJ6Xk+g8Xip4FtkDoIUQui9RWOTpLabAKerySqRIaOGkwwoUAZXHvb2rDm1ytYGAFjAebGO7vZVGazC1kgtwAOHjiJVJ931X0AYjUxwHoOv3Z+pNQGCbxVz9g/OIX7NkV5Z/ZzIr76u/mjxdI9vUA0Pz8y/66RO1C4EX2kLEXqdv/SPFWEAF7oFsRrUMPmQx+fY6mtieYSV0p8jnw7IsYawSXF6ARa0Fj+bi7ZpRMapD76vaiL84U3QUVCZgNbciZCTxP4C5NY6BhCIm3/L6BGT8EqnjuFArTfPjgCisXe34eOz1LreZhdrzpxw0U4c9/znOc3wk1tKDPTqHX7MVdmEN7II6WF5hScHd6ebm7HqEKggJSD6PhkhsbQSiPsFKYTxW/EW1oltsD3cp1XWobW8vuO1aS8NNdPlZ+MqZtD3NhBpG5g5SSmuPvlsTb1GWS+el8cb2FB0qn9plTVf+E+9+qZv8BLaSEjQIODXEAAAAASUVORK5CYII=",P0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAA11JREFUWIXtls1vFVUYxn/vOTO3rRITIUYTN7Iz6UpBWqMNSSHEKIZu0EQXfi0MuUBBF7b8AYQNtKOicaEsBK0mJrBADca7QZKmAXa90bAgLIwrwqYKvXfOeV3M3LkzvXM/KBoX8qzmnPN+POe87zznwH8MWTvx2e9T2vp+9/GzHev/NMy/neA+gX6QfM37Id8TYk1XP3V+4N4JBjUswIju+WmmdOnsrgj4c+BQ6yMA/FFfKV+IR+6KwEC/oQ1EnYbgGpl9IIE6HHt+nuXa+Rssz5/BOsGJgrbjhgHaNBYarrQsfZuwwpC+fGGW0UN7YYiEnLHqjCffBoEbRsRignaeEQJ96cIRpn78ABuGpT3TuwQPP6Yvfvc2187fSHbjhmjaVQ2cY3ftCKSl2LB5E7tr72Vu53YeVcGwis98nzz4CvX5b1RdXDiJniXY/8Q5mukup35oJ2xhsRp1cB4/OZ19r1y/CcDy3AKEjjC2NJ3rTaAMJhR9Zu5AIbHXvzDyAABbnnqdy1dPgwqxgzBsE1m5fpPf5r4m9uW/Zn8hEtT6ttliNcJ7nyUHuHz1NCKCmCR5I3c6GzZvwhmPCSqlPTAAAeHpqJok3xfhUSbG3ymY7NgxWxi/MDlDgzsZCeUhTNwsDd//L/AVAGr7IrwBg3Jp6fOchSf2tws+tdoxKgzj8QCMzb9JLOXC2ZdAw24EYEgbmDRgyy0byTDNkvgG025UfQQTdrLoTcCIjkV7IalEat52yd8GoXhUu18ro+/vwrvO9YGl2JiA57a9xcWlU20K0uIpjD17mAdHRjL7Wu0YE88f4OIvH2VzohbFrY8AGC4tncqOPY9a7SieGOMrhTPNJ08YOFhzCH174Mr+L9KvuIuDSatd6RmtfuIrwqBS6t0dXsWbO+kgWHN4veGBVU0EqaWIjUajQ4z660DaaeMnp7Hp1M6J8rdAC5OTM3hg+yeJGi5/uoCILbUdSIptILp1PpHixWoEvgkmzNZ9yU7yUlw/sYBq+XU88NPJgm79+GA2XqxGOBSLsm3LGyxd+RKPx2AKyX89/i2OZtc8d/fuFxR5lLEPX+1q0qp3fe4MigVfvvP1EUgfo6IGbxyj068V1urR94jeAk2VsssNeE8E8jC2U/zU31vM+/j/4W8T90THLuTz5AAAAABJRU5ErkJggg==",E0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAACxJREFUOI1jYBgFo2AUMDAwMDDiklBSMElDF7v34MwsogzAphmXIRS7gGIAACcyDARxUxk1AAAADmVYSWZNTQAqAAAACAAAAAAAAADSU5MAAAAASUVORK5CYII=",T0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAQCAYAAACBSfjBAAAAAXNSR0IArs4c6QAAAqxJREFUWIXtl01IG0EYhp+VtgQtFLxEC4E1gVaKCrWr2IDU1B4aaKmH1rSeclQQ+oM3C6WgtxwsFOwxp9IEDxa8tlEECSbtIU3RLN0YENSoCIWiSNHtYc26+d+DNQZ8YJmd75sZZl7eL5mFc04WuyiplcxXG4KxYxclVVmJ4GjqIJmKCrmDzeQTsRqutx3qebsoqcb33LyRxluDpsRd//Yhb26luJAbkJ0CVtEDoBoPaRcl1So6kJ0CIBVd8N7zV4BPnyMvh7nW3KWvZcwbabw1qK5FJ01t+qqEelZEzBPQvS4BCgC3ezxZjkinFNxFxLOLkmpzjfD+xR0ehXx5pZrpf5l8TO8QEPKphVxYbdQUCnr6vSgrEdIphZ7ObtIphYXQJzz93pKLrYY0Z9lcIyRiNcjLYZYSW8jLYf1ZSmzp44xsr8lau7mnP39G+5CdQlZse3NPH3sWKChgBmUlktWWw+YaYXhiDgDh0gJLia2i48ywFvpsalwlKSmgo6kjqy1FMhUVjM7qHZriZruN4Yk5eoemsNRZsNRZGJ6YYzXkK/gnksHy7hk7fbV6f6evlnBLe/nTVIC830Cr6CAQ9BMI+rGKDj3mdD0lnVLw9HsJBP0FF7tx+T7jL58cB4q8j0biJIkW3VQ1OC9DloBHrlCtooOezm5mF+eZXZwH0PpAIOgv6Z621uKmjv04NLWp+uldQHOe/KuZrvh3ukzNPH1KlvBJYla8aiOvhAH8+wG8i9q1JcPsUbzYNQZgJj4mPGxFHf/4FtDceLB/wE/52LCjA2+YiY8VdHA8tkFDwxW9Xz+9m+e8jY3f5c50quQJmExFBTeSCkpuqapupJLlC5qIDGgiaq4zJ16GsyZQOf7bRfZBy+u8z7Jy4l1svGvqU+7v+teqv4Cfc87J8A91AS7TrQNZcQAAAABJRU5ErkJggg==",I0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAQCAYAAADeWHeIAAAAAXNSR0IArs4c6QAAAHtJREFUaIHt2LERg0AMRNGVUQkeZ5ATcv3XAKGbuRscGLVwCvRfqGhntNGaHsty3EIZY1wmSSb9n9/7mZsIU7k3jXGZx/M/7z07Eybq/Sv3dnsctm3NzIMkr+wAyEUBiqMAxVGA4ihAcewARcUOYHFgCawllkAAAAAU9AOxxh7Hp5aGdAAAAABJRU5ErkJggg==",R0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAHCAYAAADJTCeUAAAAAXNSR0IArs4c6QAAACFJREFUCJljSDvw/j/Toz1vGJgYGBigxINr56EsBS1DBgDNQgirkuOzpAAAAABJRU5ErkJggg==",D0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAHCAYAAADJTCeUAAAAAXNSR0IArs4c6QAAACdJREFUCJlj+N+v+Z/hvzPDfyYGBgYGJgYGBgaGJwKaEC7Df2eG/wC26QlbSztwcgAAAABJRU5ErkJggg==",F0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAHCAYAAADJTCeUAAAAAXNSR0IArs4c6QAAABRJREFUCJlj+P///38mBgYGBpwEAIJzBAn3xZTnAAAAAElFTkSuQmCC",M0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAHFJREFUOI1jYBgFjHCWrNR/knQ+fsbIwMDAwIIsdvPRI4L61MOCGBhOnIHzEQY8fsaoLif3/+ajRwz6DO8Yyhi4GLoYvpHkKAiQlfp/8/+f/xz/X2FghlC//8R5FYshxGvGYgjpmpEMIV8zsiGjAC8AABuXSEe8+vBUAAAAAElFTkSuQmCC",B0=""+new URL("sfx-enemy-kill-BneAiP4n.mp3",import.meta.url).href,k0="data:audio/mpeg;base64,SUQzBAAAAAAAIlRTU0UAAAAOAAADTGF2ZjYxLjEuMTAwAAAAAAAAAAAAAAD/+0DAAAAAAAAAAAAAAAAAAAAAAABJbmZvAAAADwAAAAwAAAqBACUlJSUlJSUlOTk5OTk5OTlMTExMTExMTGBgYGBgYGBgYHR0dHR0dHR0iIiIiIiIiIicnJycnJycnJywsLCwsLCwsMTExMTExMTE2NjY2NjY2NjY7Ozs7Ozs7Oz//////////wAAAABMYXZjNjEuMy4AAAAAAAAAAAAAAAAkA78AAAAAAAAKgVBvV3QAAAAAAP/7UMQAAAjccxBUYwABkZfq9x6AAAAUMgQIYeAwGFsAwvYw8mTYHAZMmTJp7BMnsRnvf/3u9a78Z72Caegg638H3g/y5/4gBD//D9YfEZ8ochj3cH3w+Xfwx/ggWKRU5FaLRWLBWazWAg/jneiChEansyMCdO+lFBEW14/NOBwckIeSeHESl90MJY0kekIluMMowxHGjn79E4qrLHvPVe9p74cVp2Mo3f0kAglBe9zX06GnAGs0Sw3/pOJ9xRzFxZVR851MJT+NhhogAkDSEAb/+1LEB4IMaG9YHYeAAWuW7ej2DTClrB2XIAIIWDYPLEiAg7AaY/zrvdHw26tlZV+xv6QlZEy/Y7RYUalYfmh5j0GvEZ4LBCOFQmwbeoqKLI7xfA7QTVF3U0p4fh+q1ep1NTqdWXfl6uPANhOSOTBbRSSuPgtx+ACAhthaJSE0Szc8VZA3+U0yUetYWpXbKF60eptpTJ7kDObYwehEIOwgiYsIzu6vllWSmbgmJhxpwJGgi4ROBmfV/dgD2pZ9TW/7U6U0qoEgFJuS07IKNMBriv/7UsQGAAvoq2zsMGjBbZwv/YYMtD6kzJNXdKDy1AHcukgmL0cC14qwQSAPSIhEQzr5e9OERtlJSSEMheNl4qlaXkXmCMPPBlqXvWZOFz51zbmspMbBVszfF6aF60ZNgq1j0vTJW0qFoMjBlNka2aXa8yGQDNZdWIsHAHJou00ORwFwcp7R3VKz48xtcEzDx6IMKFCWttKt70tHDU4iVSJkaQ/2p//aVa9zk8r/CfOZLg1mTKhv1hJVgb0fOI967fIjf2WNhvRRxtuOXgNykJEm//tSxAaADBR9d6ewZ2F2Cy309gzsTsRIS0MoVDuyPp2B0Wk5LJ9nLbvNMib3ATdxa2hdaVjNXErS3Qm2Gech8a9Q9J4JDjwMU2Pl0YoauScO7K7zbIpYcQ4eVZovHLmgCsaq6Ig6x9lgYDPZRKSLTdMGh0lvQwGGA4oSB8tENgSQZnBirjVLSUqeWrZHpXHFl3JwDVwSSiWiR7DwhYFhRsfQhYcZNYjWHGg6cFmLpC84CcQoxRKR0z2s9D9xdTWEBzjW/0IOKggLM2UG3JJaTCX/+1LEBQALsJltp6RugXEV7bDzDdxHESCvHGSBXotRH+jjYNBJHpR66mxE6GWiPbkqpbSD0ndeE0PhFTNtCU6UzJM4lHlRYkBghxbA4jFAgQPaicQJODNWqse+1tLA4is0Xqn1OowN2NZEenSXPRUHW2uzPHaHKTk9zlSCKcG86C7oFtYlACG0pZqCE3SugrbaXqpHpwjy/NzKpkVpNfpZ9tJTuLzowIv6eRdrTEg+o0GLjiL22LcorzDQVCRFgmDvCblKqg0ACq4KVIJgKUvxof/7UsQGAAtwXVzHmA8BVwzs9MSM5MUWkNUJoLUI9WWMtFECJGW5YMRk1UUSJN/lV5k0UFr0hkKPAx8WNWh5BuPETy0MmKXyREktLYFO4u4bqi5xJo6+6S1akgOzNhg0SEBrDtiw0bto67I2k2Dx8WgFBKGwNmg0kJwGEwKhESwIHSWTVBVQYGFp/AyKQuGyI7jh1EjkCxkKPC4pJJUbh1xVRYyYMVVCJb9UpS8yj802TZeStxAR3eRs42oAhIQelQDuXA0xplAbjqSCE6Nz4uH+//tSxAsACki9VSewY8FPjKpw8w2Q0LUKU9QvgpzoWKHQ9SbLj8JCtPMquSGpGbHECn3g/3Mz2hTLXYwRBQSnbcjO6rlY70kVB3FI5O3/7af6wUg4kx1VVj0LseBoKItWY5WpbSzs53sU8jBEvjFwp7rFgrpCSVOIqFkDIRDwPWuGyxU6hs8K1EQobFDZu+qzs0sXJO6Eqe6tU9kUXPNpXNJOyOoJ1QlegKSiaKFiGAsFQFXU4zITUmxGOkPT8fVq2FaLZZ5rjDG0VRTPmoZCN17/+1LEFYAKPG1NR7BhwUaL6KWGDDBRpYqG1FxGFxCBg6aBk45LzBl6ZMLoj49VG/JO2JH0fZ/klv3p6tgEuiCksQwtpoFzQKnx7HQfCYIpKeJY6pjI+FsoEwfGCv6q0CrJFL6aiVjSYHWSHJNKk44CkgdWUxCdk6nqVTN+BTbEcs0R56n7ve5T12NiyrL1FKBAAhAaLDUB4FlweoiUaGEY1gUQIFCqSqeXz5cUIioLCAcDAYeTFwo5AoCALisYIFLtRI1C2KEvc3Giuo7NaNtaXv/7UsQhgAl8Nz8MMSCBUJDn5PYMcCqkbdxhVf+73E/PgrKUE3UgfhfA4JRMHcdRJA6oqIIwEkssHCViAiCq8EvAw8lOK5IOTEDBlcnvHBEubLRmHqJGh18kxwyt+ofvoTYBL2kdhG9aw2i+ocgl97P/6CVNACYelgOwWUtx0F5RA7DsbiUE5gDc9HqIcUiCYwkAY1pV+Yci0WbWsc+FlBwMhsJsU80YLAYMCtwdPJal6FPU+lHkcRYbcEEZ1J1IiArTQwO21lBVNNKqkQVFkHwG//tSxC+ACnxfNwewxwFJlubwww3kCkfA1aoX3SoRygZjq64WK0KK5RK3LQ3pobSOGLL1TqalDNtTZf7DbOkGLrl9UtcjzuWOAnmizmq4FslWGtSlnlwbkVPBWiPVAQmAFQ6LwHozFIvAUTgBIgSH2zA+5dCs2JCY0FS1GpRROPoyuSLVJ4CjAKCr1QlEYKuW1Z1ocAwiEolAJbUJXBIdi+8YWXuy3w0LUfv1aqAqyABMiXH8LkXLLGhCKgSNYiVZmSnkqlyxwTYzPRUFGWzO18z/+1LEOgIJ+FkipiTHASSQYxj0jGijNRjZtmhBg8qG0PMioFZiw5/JXS3NK87yXHKpan0Xo++/XbRSBJZQwEOdCRIFSISPSQifKhIGjx2GsRNWdkcRZ46sZPSLT3lSwC55ZZ+ieOnZ5p1Q/vlXrdaHQk8ZLIiERCXw7h28egKCdDI1kpGTLLZUcj9llsdDJlkpGTKwMGCcMmf/4SFxGZBYWFWf/U2LCzP4tioqKCxrFjTxUUFqhb+sVaaAoVDFTEFNRTMuMTAwVVVVVVVVVVVVVf/7UsRLgwhoBwhBCGABAY5VADAOQFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",L0=""+new URL("sfx-shoot-arrow-DFaw4xCo.mp3",import.meta.url).href,U0=""+new URL("sfx-player-hurt-CCE8627I.mp3",import.meta.url).href,z0=""+new URL("sfx-pickup-general-DW7SsHNM.mp3",import.meta.url).href,H0=""+new URL("sfx-death-TOGcuXFX.mp3",import.meta.url).href,O0=""+new URL("sfx-player-switch-YecUMPyN.mp3",import.meta.url).href,V0=""+new URL("sfx-uptick-score-etZC3nDz.mp3",import.meta.url).href,W0=""+new URL("sfx-final-score-uptick-Cl8CKwQ2.mp3",import.meta.url).href,N0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAY5JREFUOI2Vk71LW2EUxn9vclF6ExQNZnK4BMGh1KFenCRgC6WTk/9Ah+5uljpr083BTp3cHUQ6lW4VDGIRCrYE6pKPUoxftCZtPt77OESlxnv9OON5f885D+ecF4CM56uZddT4uqlm1lHG80VXXDDB4U81s44SyZRCgbAit4q7QTV+68/TB8p4vjKer9qUK6l9s/j/IuXnacnaSydWihSbsCKJZEqFyTjpl3EA9t9bRjcstdPDUD40EsmUVEIqoW+vpiJtO1EPJys9BENvABiZWLpzYwCCSlytf29ly0a2bBSU0e7rJ6EuzIWAwQUA7MEi1sTojZ0gxTqQgFSOVjUHgLZ7+bE1wsPcZ3M5lNp6WgDusxdIA53k0fx5lwCCHuo7/QDs5ccYW/xkiNqCGnMdu7+WzydVp/5liMT0/jU+1p0orvpXxQBtF3e8Sm2t//Y7aP19J+doFuW9q+BEEUwbM2yjbyGoxKXvAzpdeXStU/XjjGzB1e784+hTbpX6pPqHSMAWXOl45+a/cN84A5Ff2SbYY29NAAAAAElFTkSuQmCC",G0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASAAAAAbCAYAAADcSVJaAAAAAXNSR0IArs4c6QAABJZJREFUeJzt219IW2cYx/GvIsxVezGYk7opMRmdlnVEiNJ1C4nrxubF8GJFd1FGLqwQKyhDWtqb4Y3SEUYDFqHKCGUXjfRGvOjG1mkJRVGpo0L9Q2PCXCeuq85aq0KHu4jvMSd/unoitanPB8I5J+d9zvvmqD/eczwBIYQQQgghhBBCCCGEEEIIIYQQQgghxEvHbLJtqFey/c97TEKIF9ezZkKidpmxDQpKHVw7MJr0ANcOjEoICSGASCZM3c7UZUKifEjUDqICyGyybeSbLABUzdmYCY9mxB5kJjyaUTVnI99kkRASQgDwcdPX2rrZZNuYnhxKGEjR7ZSsZAeVgBFCPI3ZZNsorGzheudxDpZ44jIjdruj2UEjQL9nQ01wsmIb/jlxAzUTSmQ+HIzrINFsSQjx8pvt9zAx5aC3t097b2LqPoWVLQD84v1ON/OZ7fcAkeyYCY9mZJhNto1gaITuC5do93Zp4eOssMd11nb+FOfOXMTf4+Ns00kA6prrsRSXSwgJsYeoyUdhZQsdzQ5K38nT9k1M3U9a13jhBrP9HoKhESzF5VuXYNHhMx8O4lr347N3aIVt50/plu3eLi2EhBB7jwqRRuDm5RMAfPDVD5BgW5nt9+hyI+4ekLPCzgBQFYaC8RD2w8UAnDtzcec/gRAi7d28fIK1lTVujc1x9MNIXkRvj3W7mboV4HRfJG7avV3UNdcDMQHkW/fjGt4KIQB/jw8g4X2hdm8X7d4uQG5aC7GXHSw5wvTkUNLt031Z+H8eoqXtKgCW4nIgJoBcr9TirLDj7/HpAqe2xqXd/wF06yqg3irKw4jc3BxDdVv1uSnWp9q/8fpUx55q/ztTn77nP1Iv4zfC+l7lttofOlQCwPXO4xxzX9Xe1z2IOB8O4u/xUVvjSngQdf8ndt2odD35O1Ev4SPjT/fxK1ca3uX32d/IzslmrNvNWLdbt/3m24eT1upmQPkmC+sP53ZkUP8n3U++hE/6nv9IvYzfqP379X1/VNNAUd8lAKpbB5meHGJsc58Knzt3JgF0sx+ICaDoZ3yU2hoX/h4fA8MB7b2jlQGtrboTLoTYm95wNui2s3OyARjrdmvv9X7zPtWfHNG2VW5ol2DqX2OxN5sD4yEKSh04K+y6V3SNEGLv+uzTLykqtOqWAGV1nQDcuzsOwLefPwH0uZEZcyxtZuOssPPv6h+6fQPDAd1MSAghrNayuKUKoXt3x6luHaS6dZBFsztu0qK7BFM7v+/9NepyLEhBqYPAeEib+SQKobXVJ9sa9NrqEgA5+17dVp2yurJguBbg8fIqALkGj/F4aQUwNv6VxeVIbc4+Q30DPFqInD+j43/092JkDAbrl/96kFL9w82l0fqlzaXRz6/qjf4M/lH1Bvtf3FwaHb+qN9r/QtT6do/xIGr9bNNJ7VGcaFZrGT/+dIXq1sGnXillQOQZnmBoJGmjRPd4VHtLcTmv5732rGOPk0qIpFKrGP0F2IkxpBJAym6O/0WoT/nzp/gz2PXx78DfgNFjHPuiXpcDiSTLFfX1Le37W/IgoRDieZHvjgohdt1/5zCXzKRuqYYAAAAASUVORK5CYII=",X0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAFCAYAAAB8ZH1oAAAAAXNSR0IArs4c6QAAAElJREFUCJljZGBgYGDKrP/PgAf8m97IyALj/J3WwFB+5yOGop6+flQBpsz6///////PcBmBcdrE5h8HV8zmH4fXOQxs/nFYFQEAe5Yn3JE1KAQAAAAASUVORK5CYII=",q0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAATZJREFUOI2Nkr9Kw2AUxU8kRa0ubWxaXAzBoe4ZnALSRd9A8AV8GLf6EL6Bk7MdXJSCGaw6iFhiLWra/MF4HEpCki9f6t2+y/mdez7uBQCYhsXIVhneXTOyVZqGRRQq0fxOXhnZKjc2NZYKykyWwkUhwy9+99ZpGhZNw+LsoE7ypxrOmrwc6mQcp0liUgorMpOy/uPzjaAXGgk8cvpgOFiIarvY2jmF73uYe5+K1MA0LD7cnkBZ3Qe984WgfgwA4PwCAKDtXWHqvqXcihCpAlbWjvDxdIZGq0PBwDQsjpx+JQwADC5zA3MJlsGRPygGhip8oWJyTQHc5lCe4L+xc0z20Wh1OLnvSWG3OUS3PQaAdBPCFqpgANjWtdwahUNKVuSM27l+V58gCgLMvHf5IZUZJZWdmq0/O1nBCzb5m9IAAAAASUVORK5CYII=",Y0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAStJREFUOI2VkjtLA1EQhc/KNj4aCS6a6nKLVNrdxmZB00SSHyCW/gDLYAr/iqBITOcf8FGmSXFRK4uQQqL4QNSNSRbXY7Vh9+4jZMrhfGfOMAMAkELRd22Ob9v0XZtSKMKoUPP33qfv2lxcKjBVkGYyFTaFHH/xuzxPKRSlUBxsLZD8zYejJo8VhwyCSZKAzIStLJO0frfXSegTjRC+vLnA1XUbALCxXkK1VsVw6OHH+7QyDaRQbBzVUd7ejMEAcHf/AACoHx7g4/V5ws2ZCfLg4pqDs5MWlldWmTCQQtGMbcIA0H96iQ2MJZgVTl1hGqy1zjaYZXLCoNvrWDu1Si6stUazdZy/Qh4MAEWnEDtj4pHCE+3t7sf6zfNT+KMRBt5b9iOlGYUVnRqtfxL3wpjNmXk0AAAAAElFTkSuQmCC",j0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABwCAYAAADhTnWjAAAAAXNSR0IArs4c6QAAC/NJREFUeJztnHtsFMcdx78XUcdpC0qFkGOD0fnOAuMHwujONqFgXEqBEuoauXZSwHVVVORCAmosSAkNgVLUIKdNCgiFQLhegxJTK44BC5qUGPM2d4ojbPwgPvuKzcOyotDQNOAQbf84Zj27t7u3e/u4PbMfaXW3M7Ozu9/f/H7zOhuwsLCwsLCwsLCwsLCwMBSbksIMwzBhFdhsknUMD99mr0lIeFy0rFQ5Ok8uUvcyE2OUFP766/+outnw8G1GSJhoBB4tPCK3oJhISsXjl3+YxQcUekA0JCQ8bhMSXSidlOeX5Zdpbf1I+weNEbLipJxWGinmRluHHCPFM7JDEE00LTCSaKNJVCVENAC/Bba2foT8/GU2vhHUeIlS8YeHbzNih5J6zEDEF+e/FC2WVJ7cOrUIXdE8g1mQ9AC1Ixw5ZeKx1WqJ4lGQGsGkhrJyW+5oGgEBEiFIjdDRTrbkXBdvISYSUY2ClCLXmA9jOBJsTUonP7m5PwhLIy1VTFSp/EjXyoHvKQzAAIDtwTuT80hpeiOrDyBDT7F8NSMVsRmxljAAQ4tMvstN0xNZIUhKfEBZxygUw42I6wzA0C3cLAh6gNKRRn7+MltLy3uCLye3LqFyWo54hMKMEPxQZWFhYTGK0X1LElC/pajFlqSaOqJZD5M7gTR0S9IiHMO3JC246L4lqWRWLTSjVnu93DrErtUb3bcklWwpCu0TqL1ebh1KlkS07AMM25J8GIhmxy9iCBLbkmxpeY+h3VbJmr7afsMs/Y4W/aLiPoCsC+XnL9NlEU2td8m53kwerHg/VovYKoXW1wvVofTnL0rjvJJNJEO3JAHlIxitrzcbum9Jym0NaluT2l9vxI0HWGg7KRU0gNotSSUjIr0RehezjKKAGG1JWoxg+JakBRdTb0kaeX00dVtYWFhYWFhYWFhYWFhYKMNhdwnOnh12F0MOo5/JaAz5CxkhHHYXczzZL2qE48l+pEwrFM0fLcRsydhhdzFJdicGgwH0Bv2Cz+Gwu5iUaYX45qsByXLxjCk2ZLRs5Q67i5FjKLnl9EZTA9BCKnm5JLtTNO9GZ7NkPv/+3ZcfwdTp4eLSgkuVMxpN+gDSYQb6fAj0+WRd0xv02waDAZSXVeJ807uYlzcn7ABCxlESfn647rfsM9HPd7XrIieNlIs1qg1AC99++RbaL98KyxcKMQ67iykvq8SOV9YAAPtJqDyzFoPBAICQESKFKYfdxaQWVWP3+kLJe5Pzk3tLkVpUHfNOXlUIIuLTFBcvBe3qE1MmYdzYZAAQdPdNG/eE1XumrQ+1N11IsjsxL28OTl06I+t5+ptqgPWFSC2qBgD86/U/sy29s3sIDQ1H2bKd3UOh8jFG0z4ge/oTYWnXbwzgOgbYc7rF8YUlLT5lWiFHfM+9WiyGK+L9ifDEC7r6CrF7/Uj+tKkT2O+d3UNILaqOuRGiNgBp/STk0OITkekWBwDFxUuZQJ8PzjQ3SPghHkC+1x72sOVrD3tQXlaJyksAEJB8nt6g34amGmYtL/2cdwUAYHbF22Hn/U01MR/aauYB7ZdvIXv6E6CNAgA+3yUAgNudxzEIHfP58Z9QXlbJMYgUxOj9TTVo2DILAJC7ai/On+3DzNxkJH4nEQA455NTZyh4Q33QZBTk812Cz3cJBw8cwcEDRzh5bnceWyYaPhu6GnEYSjrg1KJq1H54EcVbL7B5M3OTMSWjQPScUDh2DFM4dozhHbImHuB257EC//JXP2HT2y/f4ngAjTPNzQr7ZFGoLyDD0jNtfWy58ROmsH1DJE7uLUVrP5CZmaH4HZrv3LfRRmi+c988/ytCDkRgEoqcae4Hc4I80WvIWJ9w5rFJHPEB6XnAhtO/YACgruJKWN0T03PQur+KDT2t+6sAgHNOe4rD7mKag37by09OZ7LTHUD9McYII2i+FFFcvFQyjz9sJSMh2hjffDXAngu1fiI8n/lVdajZVIqOji4Ac1kjAMC0Z/6CKRkFbNyfmJ4D4EJYHU1tHQCAZ0ueMsQIqirnj4SAEQP0Bv02/iSHpJHWPGteOUOEJi3/Rmcz+NeQ72LCA1wvyMzMgPd3cwEA13vakLtqr+A1k1NncOYs5Hvh2DFMUU4mstMd2FV/TNdwpNoDDh44wonvDQ1HOV5AJmKd3aGWTws6GAygViK+k7JSwgMh8cmYnhYfACv+ooVPo6OjC5mZGZxPIZrv3LehrYMB9PcEVaOg3qDftn37H6Ie4fQG/TbaIEl2J3sAIeHlig+EJmIdHV1wrdwH18p9bJlFC5/GjBm5ABD2GeuNH9Ue8MAIDABs3vz7sNEOjdiLlpdVAgj1B/T6j1DnWurNEqy7ZlMpyheEhpfEIK6VoVkuEVuMQJ8P7Z7nULx15F/ZnOrzYd64bwHQ1ws0rZC/HE2vBXV2+zjjebrTFZtslZdVcoxCoI3AN9LVrouYX1XHnkstNTRsmYXsyr/i87NvAgBcK/ehYcusBx00UPLj32DbCxsw1N2hW1+g6ShIzrTec68Wi2+6cAojRiAjI2eaG3u3r8ePli+HM83NGibQ58MHhw6havNrYfWVerM4YYhMsoghSDqf/qYaTEzPwedn38T1njZ2SEoMcr2nDQDQ1HgML55IxK56+ToowdAdscFgAJ6y3cBhDys+fxni1arbqNrs5gxXnWlupH9WCYyPfI/aDy8CCBmCfBeivKkG13vaMDE9BxPTc+D/ew5cK/eh3fMcmwYARUueQsPaDgAfK3tZmRi+KS8Wbuhl6ZlrGuFMc7PHzDWNbJ5QH1DqzWJDTfWOOk5e+YKCsINQvPUC21mTFk+nASEPKN59Q+Fbykd3D6CXo4l4dRVXcOrSGczLm4NNG/cILsbNXNOItYu+i90n/ivrPqFQVINr/Z+gGqGOuHxBAbovP4I/LrqLF08ksp9TpxdwDEkEJ2lvLK6Ha+U+pGIUeMDOuZNwPNnPSSv1ZkVc33ln9VIUZn9b8f1mV7yNc94VOOddgWv9n+Cx732M7S0dnE8+fK9afbyETdPbA3Q3QM6n72PxTeHNFLIMIbQr9swbR9Hc/j+8s1p8aUOM2d9fjwtdd9nj7peh40LXXXZfQAkNa1MUXyMXXQxAT6AW33Rh59xJYWXkeAEQMoQcyHC0v6kG/f8+hepVL3DyW/tD/QHpK4TmGDQtSw6BXo7Ib1wu6zmUomkfIDRrrUgZxobTA0LFUerNQm2FB0BozJ9kd6IHHqRvA8a99DO23Bfb/oGe8R7RSVhdxRVc7bqI939dyqbtqn8N1atC32v2/wnVMxPx82dfwcsvrWPLTMkoEK1T6v12zv2bZvMBTSoSWy4grawiZRjeGwmiEyiy5CwFKcMXrGXJIZwcusuK397TC2BkVZOmKCcTAJCd7gAA/HRfHeZPSER+43LUVVxh65bb+rUwhKoQ9FZwHfNWcJ2g+He67gEIdcLeGwmcvLqKK0iyO3E82c8uQ5BZ8sJN6ew5KRPo82Fe3hzR5Qkx8TNfLWUPOp2Uoz2m1JuFliWHDAs9BFUh6GjjNQDA0iWTAQBd124DGBEfADacHsDOuZOw4fQA7nTdw9iMRwEA55vexaaNc0TnBcQjFsOF8gdDVWeahzUQfR8iKMAVn4Y1wvN1KMrJRHtPL+sJ9PPKEf/Tti9ENVGKKhcq2VPCaf3EEL4PBtm0f+7oAQCOcFLpQkQq2/H8yOSLL7zS8iRPSHy+8PVr6lWHIE0NQFi6ZDJutn6JgSHuJIq0frrFRYNW9USqnyDW4rUwgC4zYbHQRBib8WjU4tHi8IUClBtFqA6ClqFGDF2XIqQMQb94JNGkRFJTVgwjhCcYshoqxyPMgJHCEzSZB4j1BWKIGSJWRCt8zDthPvFmiFgKT9Blp9/shjCD8ARdf3RkNkOYSXiCIb9/jLUhzCg8wdDfxhttCDMLT4jJHyfobYh4EJ4Q078O0doQ8SQ8IeZ/qAyoN0Q8Ck+I+QPQKDVEtJhBeIJpHoRGL0OYSXiC6R6IRitDmFF4gmkfjCZaQ5hZeILpH5BGriHiQXhC3DwojZgh4kn4UUHJnhLGqJGThYWFhYWFhYWFxSji/82BEZt6g0JXAAAAAElFTkSuQmCC",Q0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADkAAAALCAYAAADFqiUjAAAAAXNSR0IArs4c6QAAAYhJREFUSIndVjFLAzEU/lIkY7mh0MVB6NBJlE5K/8C5icPBdereH+AP6ORUENzdupQidHEQikNdBOvRyUHo5tqhg97Q1+nVNL6kOTf9IOTy3pcv77sLySkURJ4viJ+1jpQ01jpSJt/FCxmbWr4apLUZpaImpYV3FcKYTB62uPY8KS/pMHfXekFI0zalaXtrcp4viJspHtrbOq4iXfPM2Hg8EOcUMkhEokmpWLMoqcCQl+PSkUyGcgsb/PPotioE/HODz9fH1G1VaJZ9eA0e3RNx47Hd23mJ79Mrom9D2v5bp+v55Qx3V4fo929/nJYmslipLFZOjp3fxbU5Pn5InqF1pLSOVAkApk85yv1XfD6eIT7ZRy9pOr9kvQok0++3mMVKJVMiXrhelfkct/N2jPm2ntmbeR82B9Kg0aC3U9DFQZl6SZN8BgF5u0l9aN6O+bapT8d3Ve0BwOyrgeH8RQ3nE58/AMByRKh1VgQA7zcltRzRJv6bfK2zIo4xn2MmX9JhE/wD4bp317GwFi+3R9f+AAAAAElFTkSuQmCC";function lp(d,t,i){const n=d%t,o=Math.floor(d/t);return n===0||n===t-1||o===0||o===i-1}function Z0(d,t){const i=[];if(d<=2||t<=2)return i;for(let n=1;n<d-1;n++)i.push(1*d+n);for(let n=2;n<t-2+1;n++)i.push(n*d+1),i.push(n*d+(d-2));for(let n=1;n<d-1;n++)i.push((t-2)*d+n);return i}function J0(d){const n=Math.floor(Math.random()*25)+1;return Math.floor(75+d*25+n)}function K0(d){const t=Math.floor(Math.random()*6)+5,i=4,o=Math.floor(d*.35),h=d-o,c=Array.from({length:i},()=>Math.floor(o/i));let g=c.reduce((L,G)=>L+G,0),_=o-g,v=0;for(;_!==0;)c[v%i]+=_>0?1:-1,_+=_>0?-1:1,v++;const x=t-i,A=1.5,S=1.5,P=Array.from({length:x},(L,G)=>A+G*S),I=P.reduce((L,G)=>L+G,0);let F=P.map(L=>Math.floor(L/I*h)),R=F.reduce((L,G)=>L+G,0),E=h-R,M=0;for(;E!==0;)F[M%x]+=E>0?1:-1,E+=E>0?-1:1,M++;return[...c,...F]}function $0(d){return K(0,d.rows*d.tileHeight/2)}function tx(d){localStorage.setItem("Axe&ArrowHighscore",d.toString())}function Za(){return localStorage.getItem("Axe&ArrowHighscore")}class ex extends Ww{logoImage=new pt(j0);excaliburImage=new pt(Q0);pxScale=3;highScore="0";constructor(){super()}initLoadingScreen(){this.logoImage.load(),this.excaliburImage.load(),this.highScore=Za()??"0"}onDraw(t){const{width:i,height:n}=t.canvas,o=this.engine.canvasHeight/this.engine.pixelRatio,h=this.engine.canvasWidth/this.engine.pixelRatio;if(t.fillStyle="#0f0b0e",t.fillRect(0,0,i,n),t.imageSmoothingEnabled=!1,this.logoImage.isLoaded()){const c=96*this.pxScale,g=112*this.pxScale;t.drawImage(this.logoImage.image,h/2-c/2,50,c,g)}if(this.excaliburImage.isLoaded()){const c=57*this.pxScale,g=11*this.pxScale;150*this.pxScale,t.drawImage(this.excaliburImage.image,h/2-c/2,o-g-20,c,g)}this.highScore&&(t.font="16px Arial",t.fillStyle="white",t.textAlign="center",t.textBaseline="middle",t.fillText(`High Score: ${this.highScore}`,100,100))}}const dt={tsetD1:new pt(jw),ground:new pt(Qw),overlay:new pt(Zw),fence:new pt(Jw),tree:new pt(Kw),purpleGuy:new pt($w),purpleShadow:new pt(i0),lifebar:new pt(s0),buttonUp:new pt(n0),buttonDown:new pt(r0),playerShadow:new pt(o0),swordPlayerBody:new pt(a0),swordPlayerHands:new pt(h0),swordPlayerHandArmed:new pt(l0),sword:new pt(c0),arrowPlayerBody:new pt(d0),arrowPlayerHands:new pt(u0),arrowPlayerHandsArmed:new pt(f0),bow:new pt(g0),arrow:new pt(p0),blessing:new pt(_0),soul:new pt(m0),cancel:new pt(v0),scale:new pt(w0),goLabel:new pt(x0),swordPlayerIcon:new pt(A0),bowPlayerIcon:new pt(b0),swordPlayerIconDamaged:new pt(y0),heart:new pt(C0),flex:new pt(S0),clock:new pt(P0),pickupshadow:new pt(E0),pickupSS:new pt(T0),timebar:new pt(I0),bluetik:new pt(R0),redtik:new pt(D0),whitetik:new pt(F0),activePlayerTik:new pt(M0),spectrum:new pt(G0),cursor:new pt(X0),goldmedal:new pt(q0),silvermedal:new pt(Y0),purpleGuyDark:new pt(t0),purpleGuyLight:new pt(e0),goldstar:new pt(N0),sfxEnemyKilled:new Es(B0),sfxSwordSwing:new Es(k0),sfxShootArrow:new Es(L0),sfxPlayerHurt:new Es(U0),sfxGeneralPickup:new Es(z0),sfxDeath:new Es(H0),sfxPlayerSwitch:new Es(O0),sfxUptickScore:new Es(V0),sfxFinalScoreUptick:new Es(W0)},Ri=.3,Ra=Oe.fromImageSource({image:dt.pickupSS,grid:{rows:1,columns:2,spriteHeight:16,spriteWidth:16}}),Ii=Oe.fromImageSource({image:dt.scale,grid:{rows:1,columns:8,spriteHeight:48,spriteWidth:48}}),Da=Oe.fromImageSource({image:dt.cancel,grid:{rows:1,columns:2,spriteHeight:32,spriteWidth:32}});Oe.fromImageSource({image:dt.tsetD1,grid:{rows:2,columns:2,spriteWidth:34,spriteHeight:17}});const la=Oe.fromImageSource({image:dt.ground,grid:{rows:10,columns:5,spriteWidth:64,spriteHeight:38}}),is=Oe.fromImageSource({image:dt.overlay,grid:{rows:10,columns:10,spriteHeight:16,spriteWidth:16}}),je=Oe.fromImageSource({image:dt.purpleGuy,grid:{rows:3,columns:5,spriteHeight:32,spriteWidth:32}}),ci=Oe.fromImageSource({image:dt.purpleGuyDark,grid:{rows:3,columns:5,spriteHeight:32,spriteWidth:32}}),di=Oe.fromImageSource({image:dt.purpleGuyLight,grid:{rows:3,columns:5,spriteHeight:32,spriteWidth:32}}),cp=Oe.fromImageSource({image:dt.playerShadow,grid:{rows:1,columns:1,spriteHeight:48,spriteWidth:48}}),yn=Oe.fromImageSource({image:dt.swordPlayerBody,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),Cn=Oe.fromImageSource({image:dt.swordPlayerHands,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),Sn=Oe.fromImageSource({image:dt.swordPlayerHandArmed,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),tr=Oe.fromImageSource({image:dt.sword,grid:{rows:1,columns:5,spriteHeight:80,spriteWidth:80}}),Pn=Oe.fromImageSource({image:dt.arrowPlayerBody,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),En=Oe.fromImageSource({image:dt.arrowPlayerHands,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),Tn=Oe.fromImageSource({image:dt.arrowPlayerHandsArmed,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),Yr=Oe.fromImageSource({image:dt.bow,grid:{rows:1,columns:4,spriteHeight:32,spriteWidth:32}}),dd=new ex;dd.initLoadingScreen();for(let d of Object.values(dt))dd.addResource(d);const ff=le.fromHex("#99e550"),gf=le.fromHex("#6cd705"),ix=le.fromHex("#ffe105"),sx=le.fromHex("#f5c100"),nx=le.fromHex("#ff2b05"),rx=le.fromHex("#d41c00");class dp extends Ai{constructor(t,i,n){const o=new Qs({width:26,height:1,color:ff}),h=new Qs({width:26,height:1,color:gf});super({name:"outerHealthBar",width:t.x,height:t.y,pos:i,z:1}),this.dims=t,this.position=i,this.maxVal=n,this.graphics.use(dt.lifebar.toSprite()),this.percent=100,this.child1=new Ai({name:"innerHealthBar",width:10,height:t.y,pos:new At(3,7),z:1}),this.child2=new Ai({name:"innerHealthBar2",width:10,height:t.y,pos:new At(3,8),z:1}),this.child1.graphics.use(o),this.child2.graphics.use(h),this.addChild(this.child1),this.addChild(this.child2)}percent;child1;child2;greenRectHighlight=new Qs({width:26,height:1,color:ff});greenRectLowLight=new Qs({width:26,height:1,color:gf});yellowRectHighlight=new Qs({width:26,height:1,color:ix});yellowRectLowLight=new Qs({width:26,height:1,color:sx});redRectHighlight=new Qs({width:26,height:1,color:nx});redRectLowLight=new Qs({width:26,height:1,color:rx});setPercent(t){this.percent=t,this.percent<0&&(this.percent=0),this.percent>100&&(this.percent=100),this.percent>40&&(this.child1.graphics.use(this.greenRectHighlight),this.child2.graphics.use(this.greenRectLowLight)),this.percent<=40&&(this.child1.graphics.use(this.yellowRectHighlight),this.child2.graphics.use(this.yellowRectLowLight)),this.percent<=15&&(this.child1.graphics.use(this.redRectHighlight),this.child2.graphics.use(this.redRectLowLight)),this.child1.scale.x=this.percent/100,this.child1.scale.y=1,this.child2.scale.x=this.percent/100,this.child2.scale.y=1}}class $l extends xi{bouncingchild;lightPlayerInstance=null;lifetime=1e4;constructor(t){super({radius:8,pos:t,collisionType:us.Passive,collisionGroup:hp,z:1e3}),this.bouncingchild=new up(Ra.getSprite(1,0)),this.addChild(this.bouncingchild),this.graphics.use(dt.pickupshadow.toSprite()),setInterval(()=>this.lifeTik(),1e3)}lifeTik(){this.lifetime-=1e3,this.lifetime<=4e3&&this.actions.blink(400,400),this.lifetime<=0&&this.kill()}comeToActor(t){this.actions.clearActions(),this.actions.meet(t,150)}onPreUpdate(t,i){this.bouncingchild.graphics.isVisible=this.graphics.isVisible}}class tc extends xi{bouncingchild;lifetime=1e4;constructor(t){super({radius:8,pos:t,collisionType:us.Passive,collisionGroup:hp,z:1e3}),this.bouncingchild=new up(Ra.getSprite(0,0)),this.addChild(this.bouncingchild),this.graphics.use(dt.pickupshadow.toSprite()),setInterval(()=>this.lifeTik(),1e3)}lifeTik(){this.lifetime-=1e3,this.lifetime<=4e3&&this.actions.blink(400,400),this.lifetime<=0&&this.kill()}comeToActor(t){this.actions.clearActions(),this.actions.meet(t,150)}onPreUpdate(t,i){this.bouncingchild.graphics.isVisible=this.graphics.isVisible}}class up extends xi{constructor(t){super({radius:3,pos:K(0,-20),z:1001}),this.graphics.use(t),this.actions.repeatForever(i=>{i.moveBy({offset:K(0,10),duration:1500,easing:cf.EaseInOutCubic}).moveBy({offset:K(0,-10),duration:1500,easing:cf.EaseInOutCubic})})}}class fp extends hd{_heldKeys=[];_keyEnable=!1;constructor(){super()}onAdd(t){this.owner=t}init(){window.addEventListener("keydown",t=>{if(!this._heldKeys.includes(t.code)){if(!this.keyEnable)return;this._heldKeys.push(t.code)}}),window.addEventListener("keyup",t=>{this.keyEnable||(this.keyEnable=!0);const i=this._heldKeys.indexOf(t.code);i>-1&&this._heldKeys.splice(i,1)})}get keys(){return this._heldKeys}set keyEnable(t){this._keyEnable=t}get keyEnable(){return this._keyEnable}onRemove(t){window.removeEventListener("keydown",this.init),window.removeEventListener("keyup",this.init)}update(t,i){}}class qt{controller;signalName;sender;callback;constructor(t,i){this.signalName=t,i?this.sender=i:this.sender=""}send(t){let i;t?i=new CustomEvent(this.signalName,{detail:{who:this.sender,params:[...t]}}):i=new CustomEvent(this.signalName,{detail:{who:this.sender}}),document.dispatchEvent(i)}listen(t){this.callback=t,this.controller=new AbortController,document.addEventListener(this.signalName,i=>{this.callback&&this.callback(i)},{signal:this.controller.signal})}stopListening(){this.controller&&this.controller.abort(),this.controller=null}}class wo extends hd{type="animation";currentName="";_currentAnimationName=null;_animations;_speed=1;_frameDuration=new WeakMap;constructor(t){super(),this._animations=t}set(t,i=0,n){const o=this.owner.graphics.current;this.currentName=t;const h=this._animations[t];this.is(t)||(i?h.goToFrame(i,n):h.reset(),o&&(h.scale.setTo(o.scale.x,o.scale.y),h.opacity=o.opacity),this.owner.graphics.use(h))}reset(){const t=this._animations[this.currentName];t.goToFrame(0),t.reset()}tint(t){this.current!==void 0&&(t===null?this.current.tint=le.White:this.current.tint=t)}get(t){return this._animations[t]}get current(){return this.owner.graphics.current}get currentFrame(){return this._animations[this.currentName].currentFrameIndex}is(t){return this.get(this._currentAnimationName)===this.get(t)}set speed(t){this._speed=t}get speed(){return this._speed}}const ui=75,lr=450,ox=50,ax=50,hx=50,lx=50,cx=50,gp=new ee({strategy:ie.Loop,frames:[{graphic:yn.getSprite(0,0),duration:lr},{graphic:yn.getSprite(1,0),duration:lr}]}),pp=gp.clone();pp.flipHorizontal=!0;const _p=new ee({strategy:ie.Loop,frames:[{graphic:yn.getSprite(2,0),duration:ui},{graphic:yn.getSprite(3,0),duration:ui},{graphic:yn.getSprite(4,0),duration:ui},{graphic:yn.getSprite(5,0),duration:ui},{graphic:yn.getSprite(6,0),duration:ui}]}),mp=_p.clone();mp.flipHorizontal=!0;const vp=new ee({strategy:ie.Loop,frames:[{graphic:Cn.getSprite(0,0),duration:lr},{graphic:Cn.getSprite(1,0),duration:lr}]}),wp=vp.clone();wp.flipHorizontal=!0;const xp=new ee({strategy:ie.Loop,frames:[{graphic:Cn.getSprite(2,0),duration:ui},{graphic:Cn.getSprite(3,0),duration:ui},{graphic:Cn.getSprite(4,0),duration:ui},{graphic:Cn.getSprite(5,0),duration:ui},{graphic:Cn.getSprite(6,0),duration:ui}]}),Ap=xp.clone();Ap.flipHorizontal=!0;const bp=new ee({strategy:ie.Loop,frames:[{graphic:Sn.getSprite(0,0),duration:lr},{graphic:Sn.getSprite(1,0),duration:lr}]}),yp=bp.clone();yp.flipHorizontal=!0;const Cp=new ee({strategy:ie.Loop,frames:[{graphic:Sn.getSprite(2,0),duration:ui},{graphic:Sn.getSprite(3,0),duration:ui},{graphic:Sn.getSprite(4,0),duration:ui},{graphic:Sn.getSprite(5,0),duration:ui},{graphic:Sn.getSprite(6,0),duration:ui}]}),Sp=Cp.clone();Sp.flipHorizontal=!0;const ec=new ee({strategy:ie.End,frames:[{graphic:tr.getSprite(0,0),duration:ox},{graphic:tr.getSprite(1,0),duration:ax},{graphic:tr.getSprite(2,0),duration:hx},{graphic:tr.getSprite(3,0),duration:lx},{graphic:tr.getSprite(4,0),duration:cx}]}),ic=ec.clone();ic.flipHorizontal=!0;class Pp extends xi{ac;_directionfacing="Right";animationSet;_walkState="idle";_attackState="Normal";_oldStates="idleNormalRight";_currentStates="idleNormalRight";constructor(t){super({width:19,height:30,z:1001}),this.animationSet=t}onInitialize(t){this.ac=new wo(this.animationSet),this.addComponent(this.ac),this.ac.set("idleNormalRight"),this._oldStates="idleNormalRight",this._currentStates="idleNormalRight"}set direction(t){this.ac&&(this._directionfacing=t,this._currentStates=this._walkState+this._attackState+this._directionfacing)}set attackState(t){this.ac&&(this._attackState=t,this._currentStates=this._walkState+this._attackState+this._directionfacing)}set walkState(t){this.ac&&(this._walkState=t,this._currentStates=this._walkState+this._attackState+this._directionfacing)}onPreUpdate(t,i){this.ac&&this._oldStates!==this._currentStates&&(this._oldStates=this._currentStates,this.ac.set(this._currentStates))}}const dx=300;class Nr extends xi{constructor(t,i,n,o,h){super({width:16,height:4,rotation:0,pos:t,anchor:At.Half,z:1001,collisionType:us.Passive,collisionGroup:cd}),this.playSFX=h,this.owner=o,this.damage=n,this.vel=i.sub(this.pos).normalize().scale(dx),this.rotation=this.vel.toAngle(),this.graphics.use(dt.arrow.toSprite())}name="LightBullet";damage;owner;UISignal=new qt("stateUpdate");enemyDefeatedSignal=new qt("enemyDefeated");onInitialize(t){this.events.on("exitviewport",()=>{this.kill()}),this.playSFX&&dt.sfxShootArrow.play(Ri)}onCollisionStart(t,i,n,o){if(i.owner instanceof ao){const h=i.owner;if(h.state=="death")return;h.pain("arrow"),this.owner.numenemies++,this.owner.isPlayerActive&&this.owner.numEnemiesWhileActive++,this.enemyDefeatedSignal.send(["enemyDefeatedSignal",h.affinity,"bow"])}}}class ux extends xi{ac;directionfacing="Right";state="attack";animationSet;resetCallback=void 0;constructor(t,i,n){super({z:1001,collisionType:us.Passive,collisionGroup:cd}),this.resetCallback=n,this.directionfacing=i,this.pos=K(0,0),this.animationSet=t,this.animationSet.attackLeft.events.on("end",()=>{this.kill(),this.resetCallback&&this.resetCallback()}),this.animationSet.attackRight.events.on("end",()=>{this.kill(),this.resetCallback&&this.resetCallback()})}onInitialize(t){this.ac=new wo(this.animationSet),this.addComponent(this.ac);const i=this.state+this.directionfacing;this.ac.set(i)}onPreKill(t){this.animationSet.attackLeft.events.off("end"),this.animationSet.attackRight.events.off("end")}get animationframe(){return this.ac?.currentFrame}onPreUpdate(t,i){}}const fi=75,cr=150,fx=750,gx=100,px=100,_x=700,Ep=new ee({strategy:ie.Loop,frames:[{graphic:Pn.getSprite(0,0),duration:cr},{graphic:Pn.getSprite(1,0),duration:cr}]}),Tp=Ep.clone();Tp.flipHorizontal=!0;const Ip=new ee({strategy:ie.Loop,frames:[{graphic:Pn.getSprite(2,0),duration:fi},{graphic:Pn.getSprite(3,0),duration:fi},{graphic:Pn.getSprite(4,0),duration:fi},{graphic:Pn.getSprite(5,0),duration:fi},{graphic:Pn.getSprite(6,0),duration:fi}]}),Rp=Ip.clone();Rp.flipHorizontal=!0;const Dp=new ee({strategy:ie.Loop,frames:[{graphic:En.getSprite(0,0),duration:cr},{graphic:En.getSprite(1,0),duration:cr}]}),Fp=Dp.clone();Fp.flipHorizontal=!0;const Mp=new ee({strategy:ie.Loop,frames:[{graphic:En.getSprite(2,0),duration:fi},{graphic:En.getSprite(3,0),duration:fi},{graphic:En.getSprite(4,0),duration:fi},{graphic:En.getSprite(5,0),duration:fi},{graphic:En.getSprite(6,0),duration:fi}]}),Bp=Mp.clone();Bp.flipHorizontal=!0;const kp=new ee({strategy:ie.Loop,frames:[{graphic:Tn.getSprite(0,0),duration:cr},{graphic:Tn.getSprite(1,0),duration:cr}]}),Lp=kp.clone();Lp.flipHorizontal=!0;const Up=new ee({strategy:ie.Loop,frames:[{graphic:Tn.getSprite(2,0),duration:fi},{graphic:Tn.getSprite(3,0),duration:fi},{graphic:Tn.getSprite(4,0),duration:fi},{graphic:Tn.getSprite(5,0),duration:fi},{graphic:Tn.getSprite(6,0),duration:fi}]}),zp=Up.clone();zp.flipHorizontal=!0;const Hp=new ee({strategy:ie.End,frames:[{graphic:Yr.getSprite(0,0),duration:fx},{graphic:Yr.getSprite(1,0),duration:gx},{graphic:Yr.getSprite(2,0),duration:px},{graphic:Yr.getSprite(3,0),duration:_x}]}),Op=Hp.clone();Op.flipHorizontal=!0;class Vp extends xi{name="LightPlayer";currentHP=15;maxHP=15;regenRate=1e3;attackPower=1;pickupDistance=50;speed=100;fireInterval=3e3;exp=0;isPlayerActive=!1;jc=new op;kc=new fp;ac=new wo({idleLeft:Tp,idleRight:Ep,walkLeft:Rp,walkRight:Ip});partner;HealthBar;fireIntervalHandler;isJoystickActive=!0;isKeyboardActive=!1;UISignal=new qt("stateUpdate");gamePausedSignal=new qt("pauseGame");progressionSignal=new qt("progressionUpdate");waveResetSignal=new qt("waveReset");numenemies=0;numEnemiesWhileActive=0;directionFacing="Right";isWalking=!1;oldXVelocity=0;oldDirectionFacing="Right";weaponChild;closestEnemy;timer=void 0;switchLock=!1;handChild=new Pp({idleNormalLeft:Fp,idleNormalRight:Dp,walkNormalLeft:Bp,walkNormalRight:Mp,idleAttackLeft:Lp,idleAttackRight:kp,walkAttackLeft:zp,walkAttackRight:Up});fireRange=100;fireDamage=1;isFiring=!1;isWaveActive=!1;isAlive=!0;constructor(){super({radius:10,color:le.White,pos:K(0,0),anchor:At.Half,z:1e3,collisionType:us.Active,collisionGroup:ap}),this.addComponent(this.ac),this.ac.set("idleRight"),this.HealthBar=new dp(new At(32,16),new At(-16,-32),20),this.addChild(this.HealthBar),this.handChild.walkState="idle",this.handChild.attackState="Normal",this.handChild.direction="Right",this.addChild(this.handChild);const t=new xi({width:48,height:48});t.graphics.use(cp.sprites[0]),this.addChild(t);class i extends xi{owner;wasActive=!0;constructor(o){super({pos:K(0,-32),z:1002,scale:K(.8,.8)}),this.owner=o,this.graphics.use(dt.activePlayerTik.toSprite())}onPreUpdate(o,h){this.owner.isPlayerActive===!0?this.wasActive||(this.graphics.use(dt.activePlayerTik.toSprite()),this.wasActive=!0):this.wasActive&&(this.wasActive=!1,this.graphics.hide())}}this.addChild(new i(this)),this.waveResetSignal.listen(n=>this.numenemies=0),this.gamePausedSignal.listen(n=>{this.isWaveActive=!n.detail.params[0]}),this.progressionSignal.listen(n=>{switch(n.detail.params[0]){case"constitution":this.maxHP+=10,this.maxHP>35&&(this.maxHP=35),this.currentHP=this.maxHP,this.regenRate=Math.floor(this.regenRate*.95);break;case"speed":this.fireInterval=Math.floor(this.fireInterval*.75),this.timer?.cancel(),this.timer=new Ia({fcn:()=>this.fire(),repeats:!0,interval:this.fireInterval}),this.scene.add(this.timer),this.timer.start(),this.speed+=25;break;case"strength":this.attackPower+=1,this.pickupDistance=Math.floor(this.pickupDistance*1.05);break}})}onInitialize(t){this.kc.init(),this.timer=new Ia({fcn:()=>this.fire(),repeats:!0,interval:this.fireInterval}),t.currentScene.add(this.timer),this.timer.start()}onCollisionStart(t,i,n,o){i.owner instanceof $l&&(i.owner.kill(),this.UISignal.send(["blessing"]),this.exp+=1,dt.sfxGeneralPickup.play(Ri))}get direction(){return this.directionFacing}registerPartner(t){this.partner=t,this.pos=t.pos.clone().add(K(0,-50))}fire(){if(!this.isWaveActive)return;let t=this.scene?.entities.filter(o=>o instanceof ao),i,n=1/0;for(const o of t){let h=o,c=this.pos.distance(h.pos);c<n&&(n=c,i=h)}i&&(this.closestEnemy=i,this.weaponChild=new ux({attackLeft:Op,attackRight:Hp},this.directionFacing,this.releaseWeapon),this.addChild(this.weaponChild),this.isFiring=!0,this.handChild.attackState="Attack")}releaseWeapon=()=>{this.handChild.attackState="Normal"};disableTouch(){this.removeComponent(this.jc)}enableTouch(){this.addComponent(this.jc)}joystickCallback=t=>{!this.isPlayerActive||!this.isJoystickActive||(t.state==="hold"&&(this.switchLock=!0,this.scene.switchPlayerFocus()),t.state==="active"?(t.direction.x<0?this.directionFacing="Left":this.directionFacing="Right",this.vel.x=t.direction.x*this.speed,this.vel.y=t.direction.y*this.speed,this.isWalking===!1&&(this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`))):(this.vel.x=0,this.vel.y=0,this.isWalking===!0&&(this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))))};onPreUpdate(t,i){if(!this.isWaveActive)return;if(this.isFiring&&this.closestEnemy&&this.weaponChild&&this.weaponChild.animationframe==1){let g=this.closestEnemy.pos.sub(this.pos).toAngle(),_=uf(7.5),v=uf(15),x=new Nr(this.pos,this.closestEnemy.pos,this.fireDamage,this,!0);if(this.scene?.add(x),this.attackPower>=2){let A=g+_,S=g-_,P=this.pos.add(K(Math.cos(A),Math.sin(A))),I=this.pos.add(K(Math.cos(S),Math.sin(S))),F=new Nr(this.pos,P,this.fireDamage,this,!1),R=new Nr(this.pos,I,this.fireDamage,this,!1);this.scene?.add(F),this.scene?.add(R)}if(this.attackPower>=3){let A=g+v,S=g-v,P=this.pos.add(K(Math.cos(A),Math.sin(A))),I=this.pos.add(K(Math.cos(S),Math.sin(S))),F=new Nr(this.pos,P,this.fireDamage,this,!1),R=new Nr(this.pos,I,this.fireDamage,this,!1);this.scene?.add(F),this.scene?.add(R)}this.closestEnemy=void 0,this.isFiring=!1}const o=this.actions.getQueue().getActions().find(c=>c instanceof rp);if(!this.isPlayerActive&&this.partner&&this.partner.pos.distance(this.pos)>25&&!o?this.actions.follow(this.partner,50):this.isPlayerActive&&o&&this.actions.clearActions(),!this.isPlayerActive){let c=!1;this.partner.isWalking&&this.isWalking===!1?(this.isWalking=!0,c=!0):!this.partner.isWalking&&this.isWalking===!0&&(this.isWalking=!1,c=!0),this.partner.directionFacing!=this.directionFacing&&(this.directionFacing=this.partner.directionFacing,this.handChild.direction=this.directionFacing,c=!0),c&&(this.isWalking?this.ac.set(`walk${this.directionFacing}`):this.ac.set(`idle${this.directionFacing}`))}if(this.HealthBar?.setPercent(this.currentHP/this.maxHP*100),this.kc.keyEnable&&(this.isKeyboardActive=!0,this.isJoystickActive=!1),this.isPlayerActive&&this.isKeyboardActive){let c=this.kc.keys;c.includes("ArrowLeft")||c.includes("KeyA")?this.vel.x=-this.speed:(c.includes("ArrowRight")||c.includes("KeyD"))&&(this.vel.x=this.speed),c.includes("ArrowUp")||c.includes("KeyW")?this.vel.y=-this.speed:(c.includes("ArrowDown")||c.includes("KeyS"))&&(this.vel.y=this.speed),c.includes("Space")&&!this.switchLock&&this.isPlayerActive&&(this.switchLock=!0,this.scene.switchPlayerFocus()),!c.includes("ArrowLeft")&&!c.includes("KeyA")&&!c.includes("ArrowRight")&&!c.includes("KeyD")&&(this.vel.x=0),!c.includes("ArrowUp")&&!c.includes("KeyW")&&!c.includes("ArrowDown")&&!c.includes("KeyS")&&(this.vel.y=0),this.vel.x!=0||this.vel.y!=0?this.isWalking===!1?(this.vel.x>0?this.directionFacing="Right":this.directionFacing="Left",this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`)):this.oldXVelocity<=0&&this.vel.x>0?(this.directionFacing="Right",this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`),this.handChild.direction=this.directionFacing):this.oldXVelocity>=0&&this.vel.x<0&&(this.directionFacing="Left",this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`),this.handChild.direction=this.directionFacing):this.isWalking===!0&&(this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))}const h=this.scene?.entities.filter(c=>c instanceof $l);if(h)for(let c=0;c<h.length;c++)this.pos.distance(h[c].pos)<this.pickupDistance&&h[c].comeToActor(this);this.currentHP<=0&&(this.timer?.cancel(),this.isPlayerActive&&this.partner?.isAlive&&this.scene.switchPlayerFocus(),this.fireIntervalHandler&&clearInterval(this.fireIntervalHandler),dt.sfxDeath.play(Ri),this.isAlive=!1,this.kill())}}new ee({strategy:ie.Loop,frames:[{graphic:je.getSprite(0,0),duration:100},{graphic:je.getSprite(1,0),duration:100},{graphic:je.getSprite(2,0),duration:100},{graphic:je.getSprite(3,0),duration:100},{graphic:je.getSprite(4,0),duration:100}]});const mx=new ee({strategy:ie.End,frames:[{graphic:je.getSprite(0,1),duration:100},{graphic:je.getSprite(1,1),duration:100},{graphic:je.getSprite(2,1),duration:100},{graphic:je.getSprite(3,1),duration:100},{graphic:je.getSprite(4,1),duration:100}]}),vx=new ee({strategy:ie.End,frames:[{graphic:je.getSprite(0,2),duration:100},{graphic:je.getSprite(1,2),duration:100},{graphic:je.getSprite(2,2),duration:100},{graphic:je.getSprite(3,2),duration:100},{graphic:je.getSprite(4,2),duration:100}]}),bl=new ee({strategy:ie.Loop,frames:[{graphic:ci.getSprite(0,0),duration:100},{graphic:ci.getSprite(1,0),duration:100},{graphic:ci.getSprite(2,0),duration:100},{graphic:ci.getSprite(3,0),duration:100},{graphic:ci.getSprite(4,0),duration:100}]});new ee({strategy:ie.End,frames:[{graphic:ci.getSprite(0,1),duration:100},{graphic:ci.getSprite(1,1),duration:100},{graphic:ci.getSprite(2,1),duration:100},{graphic:ci.getSprite(3,1),duration:100},{graphic:ci.getSprite(4,1),duration:100}]});new ee({strategy:ie.End,frames:[{graphic:ci.getSprite(0,2),duration:100},{graphic:ci.getSprite(1,2),duration:100},{graphic:ci.getSprite(2,2),duration:100},{graphic:ci.getSprite(3,2),duration:100},{graphic:ci.getSprite(4,2),duration:100}]});const yl=new ee({strategy:ie.Loop,frames:[{graphic:di.getSprite(0,0),duration:100},{graphic:di.getSprite(1,0),duration:100},{graphic:di.getSprite(2,0),duration:100},{graphic:di.getSprite(3,0),duration:100},{graphic:di.getSprite(4,0),duration:100}]});new ee({strategy:ie.End,frames:[{graphic:di.getSprite(0,1),duration:100},{graphic:di.getSprite(1,1),duration:100},{graphic:di.getSprite(2,1),duration:100},{graphic:di.getSprite(3,1),duration:100},{graphic:di.getSprite(4,1),duration:100}]});new ee({strategy:ie.End,frames:[{graphic:di.getSprite(0,2),duration:100},{graphic:di.getSprite(1,2),duration:100},{graphic:di.getSprite(2,2),duration:100},{graphic:di.getSprite(3,2),duration:100},{graphic:di.getSprite(4,2),duration:100}]});function wx(d){const t={fragmentSource:`#version 300 es
    precision mediump float;

    in vec2 v_uv;
    out vec4 fragColor;

    uniform vec2 u_graphic_resolution;
    uniform sampler2D u_graphic;

    // Inigo Quilez pixel-art UV snapping
    vec2 uv_iq(in vec2 uv, in vec2 texture_size) {
      vec2 pixel = uv * texture_size;
      vec2 seam = floor(pixel + 0.5);
      vec2 dudv = fwidth(pixel);
      pixel = seam + clamp((pixel - seam) / dudv, -0.5, 0.5);
      return pixel / texture_size;
    }

    void main() {
      vec2 newUv = uv_iq(v_uv, u_graphic_resolution);
      vec4 texColor = texture(u_graphic, newUv);

      if (texColor.a < 0.01) {
        discard; // respect alpha mask
      }

      fragColor = vec4(1.0, 1.0, 1.0, texColor.a);
    }
  `};return d.graphicsContext.createMaterial(t)}const pf=(d,t,i,n)=>{t.graphics.material=wx(d),d.clock.schedule(()=>{t.graphics.material=null,n&&n()},i)},Cl=new vr(Date.now());class ao extends xi{name="Enemy";lightGG;darkGG;currentGraphic;currentHP=1;maxHP=1;attackPower=1;speed=25;_waveLevel=1;affinity="dark";state="default";lightTarget;darkTarget;currentTarget=void 0;UISignal=new qt("stateUpdate");progressionSignal=new qt("progressionUpdate");swordDeathAnimation=mx.clone();arrowDeathAnimation=vx.clone();startingGraphic;startingAnimation;startingCollider;constructor(t,i,n){super({radius:7.5,pos:t,anchor:At.Half,z:1e3,collisionType:us.Active,collisionGroup:Yw}),this.darkGG=new Ds({useAnchor:!0,members:[{graphic:dt.purpleShadow.toSprite(),offset:K(0,0)},{graphic:bl,offset:K(0,0)}]}),this.lightGG=new Ds({useAnchor:!0,members:[{graphic:dt.purpleShadow.toSprite(),offset:K(0,0)},{graphic:yl,offset:K(0,0)}]});let o;Cl.bool()?(this.affinity="light",this.currentGraphic=this.lightGG.clone(),this.graphics.use(this.currentGraphic),o=yl,this.startingAnimation=yl.clone()):(this.affinity="dark",this.currentGraphic=this.darkGG.clone(),this.graphics.use(this.currentGraphic),o=bl,this.startingAnimation=bl.clone()),this.startingGraphic=this.currentGraphic.clone(),this.startingCollider=this.collider.clone();const h=Math.floor(Math.random()*5);o.goToFrame(h),this.lightTarget=i,this.darkTarget=n}set waveLevel(t){this._waveLevel!==t&&(this._waveLevel=t,this.maxHP=t,this.speed=this.speed+t*2,this.attackPower+=t/2,this.scale)}onCollisionStart(t,i,n,o){if(this.state!=="death"&&(i.owner instanceof ua||i.owner instanceof Vp)){this.scene.enemyWaveManager?.enemyPool?.return(this),this.scene?.remove(this),i.owner.currentHP-=this.attackPower;const h=i.owner.scene?.engine;h&&(pf(h,i.owner,150),dt.sfxPlayerHurt.play(Ri)),this.UISignal.send(["playerDamaged"])}}onInitialize(){this.swordDeathAnimation.events.on("end",()=>{}),this.arrowDeathAnimation.events.on("end",()=>{})}setAffinity(t){this.affinity=t,t=="dark"?this.currentGraphic=this.darkGG.clone():this.currentGraphic=this.lightGG.clone(),this.graphics.use(this.currentGraphic)}reset(){this.graphics.getNames().forEach(i=>this.graphics.remove(i)),this.swordDeathAnimation.reset(),this.arrowDeathAnimation.reset(),this.state="default",this.collider=this.startingCollider.clone(),this.body.collisionType=us.Active,Cl.bool()?this.setAffinity("light"):this.setAffinity("dark")}checkDrop(){if(Cl.integer(0,100)<40){if(!this.scene)return;this.affinity=="dark"?this.scene.add(new tc(this.pos)):this.scene.add(new $l(this.pos))}}pain(t){this.actions.clearActions(),this.state="death",this.collider.clear(),this.body.collisionType=us.Passive,dt.sfxEnemyKilled.play(Ri);const i=this.scene?.engine;i&&pf(i,this,300,()=>{this.currentGraphic.members[1]=t==="sword"?this.swordDeathAnimation:this.arrowDeathAnimation})}onPreUpdate(t,i){if(this.state==="death"){this.swordDeathAnimation.done&&(this.checkDrop(),this.UISignal.send(["enemyDefeated",this.affinity]),this.actions.clearActions(),this.scene?.remove(this),this.scene.enemyWaveManager?.enemyPool?.return(this)),this.arrowDeathAnimation.done&&(this.checkDrop(),this.UISignal.send(["enemyDefeated",this.affinity]),this.actions.clearActions(),this.scene?.remove(this),this.scene.enemyWaveManager?.enemyPool?.return(this));return}this.graphics.use(this.currentGraphic);const o=this.actions.getQueue().getActions().find(c=>c instanceof Nw);let h;if(o){if(this.currentTarget?.isAlive)return;this.actions.clearActions(),this.lightTarget?.isAlive?this.currentTarget=this.lightTarget:this.darkTarget?.isAlive&&(this.currentTarget=this.darkTarget),this.actions.meet(this.currentTarget,this.speed)}else{if(this.lightTarget?.isAlive&&this.darkTarget?.isAlive?h=this.lightTarget.pos.distance(this.pos)<this.darkTarget.pos.distance(this.pos)?this.lightTarget:this.darkTarget:this.lightTarget?.isAlive?h=this.lightTarget:this.darkTarget?.isAlive&&(h=this.darkTarget),!h)return;this.currentTarget=h,this.actions.meet(h,this.speed)}}}class _f extends xi{name="WeaponActor";ac;directionfacing="Right";state="attack";animationSet;resetCallback=void 0;leftVector=K(-25,0);rightVector=K(25,0);UISignal=new qt("stateUpdate");enemyDefeatedSignal=new qt("enemyDefeated");waveResetSignal=new qt("waveReset");isColliding=!1;others=[];numenemies=0;isPlayerActive;constructor(t,i,n,o,h){super({width:42,height:30,z:1001,collisionType:us.Passive,collisionGroup:cd}),this.scene=h,this.resetCallback=o,this.directionfacing=i,this.directionfacing=="Left"?this.pos=this.leftVector:this.pos=this.rightVector,this.pos=this.rightVector,this.animationSet=t,this.animationSet.attackLeft.events.on("end",()=>this.killMyWeapon.bind(this)),this.animationSet.attackRight.events.on("end",this.killMyWeapon.bind(this)),this.isPlayerActive=n}killMyWeapon(){this.resetCallback&&this.resetCallback(),this.kill()}onPreKill(t){this.animationSet.attackLeft.events.off("end"),this.animationSet.attackRight.events.off("end")}makeBig(){this.scale=K(1.5,1.5)}onInitialize(t){this.directionfacing=="Left"?this.pos=new At(this.leftVector.x+4,this.leftVector.y+2):this.pos=new At(this.rightVector.x-4,this.rightVector.y+2),this.ac=new wo(this.animationSet),this.addComponent(this.ac);const i=this.state+this.directionfacing;this.ac.set(i);const n=Ri-.25;dt.sfxSwordSwing.play(this.isPlayerActive?Ri:n)}onCollisionStart(t,i,n,o){i.owner instanceof ao&&(this.isColliding=!0,this.others.push(i.owner))}onCollisionEnd(t,i,n,o){if(i.owner instanceof ao){let h=this.others.findIndex(c=>c==i.owner);h!=-1&&this.others.splice(h,1),this.others.length==0&&(this.isColliding=!1)}}onPreUpdate(t,i){this.isColliding&&this.ac?.currentFrame==2&&this.others.forEach(n=>{n.state!="death"&&(this.parent.numenemies++,this.parent.isPlayerActive&&this.parent.numEnemiesWhileActive++,this.enemyDefeatedSignal.send(["enemyDefeated",n.affinity,"axe"]),n.pain("sword"))})}}class ua extends xi{name="DarkPlayer";currentHP=25;maxHP=25;regenRate=1e3;attackPower=1;pickupDistance=50;speed=80;fireInterval=1e3;isPlayerActive=!0;partner;isWalking=!1;oldXVelocity=0;timer=void 0;switchLock=!1;jc=new op;kc=new fp;ac=new wo({idleLeft:pp,idleRight:gp,walkLeft:mp,walkRight:_p});directionFacing="Right";handChild=new Pp({idleNormalLeft:wp,idleNormalRight:vp,walkNormalLeft:Ap,walkNormalRight:xp,idleAttackLeft:yp,idleAttackRight:bp,walkAttackLeft:Sp,walkAttackRight:Cp});HealthBar;exp=0;fireIntervalHandler;weaponchild;weaponchild2;fireDamage=3;isJoystickActive=!0;isKeyboardActive=!1;UISignal=new qt("stateUpdate");gamePausedSignal=new qt("pauseGame");progressionSignal=new qt("progressionUpdate");oldDirectionFacing="Right";isWaveActive=!1;waveResetSignal=new qt("waveReset");numenemies=0;numEnemiesWhileActive=0;isAlive=!0;constructor(){super({width:19,height:30,pos:K(0,0),anchor:At.Half,z:1001,collisionType:us.Active,collisionGroup:ap}),this.addComponent(this.ac),this.ac.set("idleRight"),this.HealthBar=new dp(new At(32,16),new At(-16,-32),20),this.addChild(this.HealthBar),this.handChild.walkState="idle",this.handChild.attackState="Normal",this.handChild.direction="Right",this.addChild(this.handChild);const t=new xi({width:48,height:48});t.graphics.use(cp.sprites[0]),this.addChild(t);class i extends xi{owner;wasActive=!1;constructor(o){super({pos:K(0,-32),z:1002,scale:K(.8,.8)}),this.owner=o,this.graphics.use(dt.activePlayerTik.toSprite())}onPreUpdate(o,h){this.owner.isPlayerActive===!0?this.wasActive||(this.graphics.use(dt.activePlayerTik.toSprite()),this.wasActive=!0):this.wasActive&&(this.wasActive=!1,this.graphics.hide())}}this.addChild(new i(this)),this.waveResetSignal.listen(n=>this.numenemies=0),this.gamePausedSignal.listen(n=>{this.isWaveActive=!n.detail.params[0]}),this.progressionSignal.listen(n=>{switch(n.detail.params[0]){case"constitution":this.maxHP+=10,this.maxHP>50&&(this.maxHP=50),this.currentHP=this.maxHP;break;case"speed":this.fireInterval=Math.floor(this.fireInterval*.75),this.speed+=25,this.timer?.cancel(),this.timer=new Ia({fcn:()=>this.fire(),repeats:!0,interval:this.fireInterval}),this.scene?.add(this.timer),this.timer.start();break;case"strength":this.attackPower++,this.pickupDistance=Math.floor(this.pickupDistance*1.05);break}})}onInitialize(t){this.kc.init(),this.scene&&(this.scene.camera.strategy.lockToActor(this),this.scene.camera.zoom=1.5,this.timer=new Ia({fcn:()=>this.fire(),repeats:!0,interval:this.fireInterval}),t.currentScene.add(this.timer),this.timer.start())}onCollisionStart(t,i,n,o){i.owner instanceof tc&&(this.exp+=1,this.UISignal.send(["soul"]),i.owner.kill(),dt.sfxGeneralPickup.play(Ri))}registerPartner(t){this.partner=t}get direction(){return this.directionFacing}disableTouch(){this.removeComponent(this.jc,!0)}enableTouch(){this.addComponent(this.jc,!0)}joystickCallback=t=>{!this.isPlayerActive||!this.isJoystickActive||(t.state==="hold"&&(this.switchLock=!0,this.scene.switchPlayerFocus()),t.state==="active"?(t.direction.x<0?this.directionFacing="Left":this.directionFacing="Right",this.vel.x=t.direction.x*this.speed,this.vel.y=t.direction.y*this.speed,this.isWalking===!1&&(this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`))):(this.vel.x=0,this.vel.y=0,this.isWalking===!0&&(this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))))};fire(){if(this.isWaveActive){if(this.weaponchild=new _f({attackLeft:ic,attackRight:ec},this.directionFacing,this.isPlayerActive,this.releaseWeapon,this.scene),this.addChild(this.weaponchild),this.handChild.attackState="Attack",this.handChild.direction=this.directionFacing,this.attackPower>=2){let t=this.directionFacing=="Left"?"Right":"Left";this.weaponchild2=new _f({attackLeft:ic,attackRight:ec},t,this.isPlayerActive,this.releaseWeapon,this.scene),this.addChild(this.weaponchild2)}this.attackPower>2&&(this.weaponchild.makeBig(),this.weaponchild2.makeBig())}}releaseWeapon=()=>{this.handChild.attackState="Normal"};onPreUpdate(t,i){if(!this.isWaveActive)return;const o=this.actions.getQueue().getActions().find(c=>c instanceof rp);if(!this.isPlayerActive&&this.partner&&this.partner.pos.distance(this.pos)>25&&!o?this.actions.follow(this.partner,50):this.isPlayerActive&&o&&this.actions.clearActions(),!this.isPlayerActive){let c=!1;this.partner.isWalking&&this.isWalking===!1?(this.isWalking=!0,c=!0):!this.partner.isWalking&&this.isWalking===!0&&(this.isWalking=!1,c=!0),this.partner.directionFacing!=this.directionFacing&&(this.directionFacing=this.partner.directionFacing,this.handChild.direction=this.directionFacing,c=!0),c&&(this.isWalking?this.ac.set(`walk${this.directionFacing}`):this.ac.set(`idle${this.directionFacing}`))}if(this.HealthBar?.setPercent(this.currentHP/this.maxHP*100),this.kc.keyEnable&&(this.isKeyboardActive=!0,this.isJoystickActive=!1),this.isPlayerActive&&this.isKeyboardActive){let c=this.kc.keys;c.includes("ArrowLeft")||c.includes("KeyA")?this.vel.x=-this.speed:(c.includes("ArrowRight")||c.includes("KeyD"))&&(this.vel.x=this.speed),c.includes("ArrowUp")||c.includes("KeyW")?this.vel.y=-this.speed:(c.includes("ArrowDown")||c.includes("KeyS"))&&(this.vel.y=this.speed),c.includes("Space")&&!this.switchLock&&this.isPlayerActive&&(this.switchLock=!0,this.scene.switchPlayerFocus()),!c.includes("ArrowLeft")&&!c.includes("KeyA")&&!c.includes("ArrowRight")&&!c.includes("KeyD")&&(this.vel.x=0),!c.includes("ArrowUp")&&!c.includes("KeyW")&&!c.includes("ArrowDown")&&!c.includes("KeyS")&&(this.vel.y=0),this.vel.x!=0||this.vel.y!=0?this.isWalking===!1?(this.vel.x>0?this.directionFacing="Right":this.vel.x<0&&(this.directionFacing="Left"),this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`)):this.oldXVelocity<=0&&this.vel.x>0?(this.directionFacing="Right",this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`)):this.oldXVelocity>=0&&this.vel.x<0&&(this.directionFacing="Left",this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`)):this.isWalking===!0&&(this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))}const h=this.scene?.entities.filter(c=>c instanceof tc);if(h)for(let c=0;c<h.length;c++)this.pos.distance(h[c].pos)<this.pickupDistance&&h[c].comeToActor(this);this.currentHP<=0&&(this.timer?.cancel(),this.isPlayerActive&&this.partner?.isAlive&&this.scene.switchPlayerFocus(),this.fireIntervalHandler&&clearInterval(this.fireIntervalHandler),dt.sfxDeath.play(Ri),this.isAlive=!1,this.kill())}}class xx{constructor(t,i,n=1){this.builder=t,this.cleaner=i,this.grow(n)}_pool=[];_size=0;grow(t){if(t>0){this._size+=t;for(let i=0;i<t;i++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}}class Ax{rng=new vr(Date.now());getSpawnPositions(t,i){let n=[];for(let o=0;o<t;o++){let h=this.getRandomTile(i);n.push({x:h.x,y:h.y})}return n}getRandomTile(t){let i=t.columns*t.rows,n=this.rng.integer(0,i-1);for(;lp(n,t.columns,t.rows);)n=this.rng.integer(0,i-1);return t.tiles[n].pos.clone()}}class bx{getSpawnPositions(t,i){let n=i.columns,o=i.rows;const h=Math.ceil(n/2),c=Math.ceil(o/2),g=n/2-2;let _=[];for(let v=0;v<t;v++){const x=2*Math.PI*v/t,A=Math.floor(h+Math.cos(x)*g),P=Math.floor(c+Math.sin(x)*g)*n+A,I=i.tiles[P].pos.clone();_.push({x:I.x,y:I.y})}return _}}class yx{rng=new vr(Date.now());getSpawnPositions(t,i){const n=[];let o=Z0(i.columns,i.rows);const h=i.tiles.filter((c,g)=>o.includes(g));for(let c=0;c<t;c++){const g=this.rng.pickOne(h);g&&n.push({x:g.pos.x,y:g.pos.y})}return n}}class Cx{rng=new vr;getSpawnPositions(t,i){const n=[],o={tl:{x:Math.floor(i.columns/4),y:Math.floor(i.rows/4)},tr:{x:Math.floor(i.columns/4)*3,y:Math.floor(i.rows/4)},bl:{x:Math.floor(i.columns/4),y:Math.floor(i.rows/4)*3},br:{x:Math.floor(i.columns/4)*3,y:Math.floor(i.rows/4)*3}},h=["tl","tr","bl","br"],c=this.rng.pickOne(h),g=o[c],_=g.x,v=g.y,x=Math.floor(Math.sqrt(i.tiles.length)/4);for(let A=0;A<t;A++){let S=this.rng.integer(-x/2,x/2),P=this.rng.integer(-x/2,x/2),I=_+S;const R=(v+P)*i.columns+I,E=i.tiles[R];E&&n.push({x:E.pos.x,y:E.pos.y})}return n}}let mf=1e4,Sx=3;const Px={EDGES:"EDGES"},Sl={RANDOM:new Ax,CIRCLE:new bx,EDGES:new yx,CLUSTER:new Cx};class Ex{enemyPool;rng;lightPlayer;darkPlayer;spawnInterval=mf;spawnEnabled=!1;scene;stateSignal=new qt("stateUpdate");burnDown=new qt("burnDown");gamePausedSignal=new qt("pauseGame");map;enemyCount=0;waveNumber=0;batchSize=[];batchIndex=0;spawnStrategy=Px.EDGES;lastBatchSpawnedFlag=!1;endOfWaveInterval;monitorSpawning=!1;enemyKillCount=0;enemyRemovedCount=0;WaveTimer;isWaveActive=!1;duration=0;isStartDelayConsumed=!1;constructor(t,i,n,o){this.rng=new vr(Date.now()),this.lightPlayer=i,this.darkPlayer=n,this.scene=t,this.map=o,this.WaveTimer=setInterval(this.waveTik,1e3),this.endOfWaveInterval=setInterval(this.endOfWave,1e3)}endOfWave=(t=!1)=>{(this.monitorSpawning&&this.lastBatchSpawnedFlag&&this.isWaveActive||t)&&this.enemyKillCount+this.enemyRemovedCount>=this.enemyCount&&(this.isWaveActive=!1,this.monitorSpawning=!1,this.endWave())};init(){this.enemyPool=new xx(this.makeEnemy,this.cleanUpEnemy,500),this.isWaveActive=!1,this.stateSignal.listen(t=>{const[i,n]=t.detail.params;i==="enemyDefeated"?this.enemyKillCount+=1:i==="playerDamaged"&&(this.enemyRemovedCount+=1)})}waveTik=()=>{this.lastBatchSpawnedFlag||this.isWaveActive&&(this.duration+=1,!this.isStartDelayConsumed&&this.duration>=Sx&&(this.isStartDelayConsumed=!0,this.spawnEnemies()),this.isStartDelayConsumed&&(this.stateSignal.send(["waveDuration",this.duration]),this.burnDown.send()))};startWave(){this.enemyKillCount=0,this.enemyRemovedCount=0,this.waveNumber+=1,this.isWaveActive=!0,this.spawnEnabled=!0,this.duration=0,this.isStartDelayConsumed=!1,this.enemyCount=J0(this.waveNumber),this.batchSize=K0(this.enemyCount),this.lastBatchSpawnedFlag=!1,this.batchIndex=0,this.monitorSpawning=!1,this.stateSignal.send(["batchsize",this.enemyCount]),this.spawnStrategy=this.rng.pickOne(Object.keys(Sl)),this.gamePausedSignal.send([!1])}endWave(){this.spawnEnabled=!1,this.isWaveActive=!1,this.duration=0,this.isStartDelayConsumed=!1,this.scene.showEndOfWaveModal(),this.gamePausedSignal.send([!0])}spawnEnemies(){let t=Sl[this.spawnStrategy].getSpawnPositions(this.batchSize[this.batchIndex],this.map);this.batchIndex+=1,this.spawnStrategy=this.rng.pickOne(Object.keys(Sl));for(let i=0;i<t.length;i++){let n=t[i];if(n===void 0)continue;let o=this.map?.tiles.find(c=>c.pos.x===n.x&&c.pos.y===n.y);if(!o)continue;let h=this.enemyPool?.rent(!0);h.waveLevel=this.waveNumber,this.lightPlayer.isAlive?this.darkPlayer.isAlive||h.setAffinity("light"):h.setAffinity("dark"),h.pos=o.pos.clone(),this.scene.add(h),this.monitorSpawning=!0}this.batchIndex==this.batchSize.length&&(this.lastBatchSpawnedFlag=!0)}makeEnemy=()=>new ao(K(0,0),this.lightPlayer,this.darkPlayer);cleanUpEnemy(t){return t.reset(),t}update(t){this.spawnEnabled&&this.isStartDelayConsumed&&!this.lastBatchSpawnedFlag&&(this.spawnInterval-=t,this.spawnInterval<=0&&(this.spawnInterval=mf,this.spawnEnemies()))}}var Pl={exports:{}},El={exports:{}};/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var vf;function Tx(){return vf||(vf=1,function(d,t){(function(n,o){d.exports=o()})(self,()=>(()=>{var i={851:(u,e,s)=>{s.d(e,{A:()=>m});var r=s(1),a=s.n(r),l=s(935),f=s.n(l),p=f()(a());p.push([u.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const m=p},296:(u,e,s)=>{s.d(e,{A:()=>m});var r=s(1),a=s.n(r),l=s(935),f=s.n(l),p=f()(a());p.push([u.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const m=p},935:u=>{u.exports=function(e){var s=[];return s.toString=function(){return this.map(function(a){var l="",f=typeof a[5]<"u";return a[4]&&(l+="@supports (".concat(a[4],") {")),a[2]&&(l+="@media ".concat(a[2]," {")),f&&(l+="@layer".concat(a[5].length>0?" ".concat(a[5]):""," {")),l+=e(a),f&&(l+="}"),a[2]&&(l+="}"),a[4]&&(l+="}"),l}).join("")},s.i=function(a,l,f,p,m){typeof a=="string"&&(a=[[null,a,void 0]]);var w={};if(f)for(var b=0;b<this.length;b++){var y=this[b][0];y!=null&&(w[y]=!0)}for(var T=0;T<a.length;T++){var D=[].concat(a[T]);f&&w[D[0]]||(typeof m<"u"&&(typeof D[5]>"u"||(D[1]="@layer".concat(D[5].length>0?" ".concat(D[5]):""," {").concat(D[1],"}")),D[5]=m),l&&(D[2]&&(D[1]="@media ".concat(D[2]," {").concat(D[1],"}")),D[2]=l),p&&(D[4]?(D[1]="@supports (".concat(D[4],") {").concat(D[1],"}"),D[4]=p):D[4]="".concat(p)),s.push(D))}},s}},1:u=>{u.exports=function(e){var s=e[1],r=e[3];if(!r)return s;if(typeof btoa=="function"){var a=btoa(unescape(encodeURIComponent(JSON.stringify(r)))),l="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),f="/*# ".concat(l," */");return[s].concat([f]).join(`
`)}return[s].join(`
`)}}},n={};function o(u){var e=n[u];if(e!==void 0)return e.exports;var s=n[u]={id:u,exports:{}};return i[u](s,s.exports,o),s.exports}o.n=u=>{var e=u&&u.__esModule?()=>u.default:()=>u;return o.d(e,{a:e}),e},o.d=(u,e)=>{for(var s in e)o.o(e,s)&&!o.o(u,s)&&Object.defineProperty(u,s,{enumerable:!0,get:e[s]})},o.o=(u,e)=>Object.prototype.hasOwnProperty.call(u,e),o.r=u=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(u,"__esModule",{value:!0})};var h={};o.r(h),o.d(h,{ActionCompleteEvent:()=>Th,ActionContext:()=>Br,ActionQueue:()=>Rd,ActionSequence:()=>ul,ActionStartEvent:()=>Eh,ActionsComponent:()=>jn,ActionsSystem:()=>el,ActivateEvent:()=>Ah,Actor:()=>$e,ActorEvents:()=>Q_,AddEvent:()=>Ih,AddedComponent:()=>C_,AffineMatrix:()=>pe,Animation:()=>Ui,AnimationDirection:()=>yr,AnimationEvents:()=>x_,AnimationStrategy:()=>Li,ArcadeSolver:()=>Qh,AudioContextFactory:()=>Er,Axes:()=>rl,Axis:()=>Yo,BaseAlign:()=>Ro,BezierCurve:()=>Mr,Blink:()=>$d,BodyComponent:()=>Et,BoundingBox:()=>ht,BrowserComponent:()=>hl,BrowserEvents:()=>Bu,Buttons:()=>zr,Camera:()=>_u,CameraEvents:()=>K_,Canvas:()=>Vo,Circle:()=>Go,CircleCollider:()=>We,Clock:()=>ll,ClosestLineJumpTable:()=>Ji,Collider:()=>Gs,ColliderComponent:()=>ve,CollisionContact:()=>pn,CollisionEndEvent:()=>Pr,CollisionGroup:()=>As,CollisionGroupManager:()=>Zi,CollisionJumpTable:()=>Hi,CollisionPostSolveEvent:()=>zo,CollisionPreSolveEvent:()=>Uo,CollisionStartEvent:()=>Sr,CollisionSystem:()=>Qo,CollisionType:()=>ft,Color:()=>Z,ColorBlindFlags:()=>Fu,ColorBlindnessMode:()=>mn,ColorBlindnessPostProcessor:()=>Du,Component:()=>Ti,CompositeCollider:()=>Pe,ConsoleAppender:()=>Fi,ContactConstraintPoint:()=>yu,ContactEndEvent:()=>Lo,ContactSolveBias:()=>bs,ContactStartEvent:()=>ko,CoordPlane:()=>Me,CrossFade:()=>Fm,CurveBy:()=>ru,CurveTo:()=>nu,DeactivateEvent:()=>bh,Debug:()=>Ee,DebugConfig:()=>Mu,DebugGraphicsComponent:()=>qo,DebugSystem:()=>Kh,DebugText:()=>Ka,DefaultAntialiasOptions:()=>ku,DefaultGarbageCollectionOptions:()=>dl,DefaultLoader:()=>Tr,DefaultPixelArtOptions:()=>Lu,DegreeOfFreedom:()=>ri,Delay:()=>eu,Detector:()=>Td,Die:()=>iu,Direction:()=>Fo,Director:()=>Ou,DirectorEvents:()=>am,DisplayMode:()=>Se,DynamicTree:()=>Uh,DynamicTreeCollisionProcessor:()=>No,EX_VERSION:()=>vl,EaseBy:()=>Kd,EaseTo:()=>Jd,EasingFunctions:()=>Nt,EdgeCollider:()=>_i,ElasticToActorStrategy:()=>fu,EmitterType:()=>js,Engine:()=>oi,EngineEvents:()=>hm,EnterTriggerEvent:()=>Sh,EnterViewPortEvent:()=>Ch,Entity:()=>Ve,EntityEvents:()=>T_,EntityManager:()=>vu,EventEmitter:()=>I,EventTypes:()=>Mo,Events:()=>_,ExResponse:()=>Mh,ExcaliburGraphicsContext2DCanvas:()=>Oo,ExcaliburGraphicsContextWebGL:()=>xs,ExitTriggerEvent:()=>Ph,ExitViewPortEvent:()=>yh,Fade:()=>tu,FadeInOut:()=>Dm,Flags:()=>A,Flash:()=>su,Follow:()=>Xh,Font:()=>hn,FontCache:()=>Lt,FontSource:()=>Im,FontStyle:()=>Do,FontUnit:()=>To,FpsSampler:()=>Uu,FrameStats:()=>Wr,Future:()=>P,GameEvent:()=>xt,GameStartEvent:()=>ah,GameStopEvent:()=>hh,Gamepad:()=>Ko,GamepadAxisEvent:()=>vh,GamepadButtonEvent:()=>mh,GamepadConnectEvent:()=>ph,GamepadDisconnectEvent:()=>_h,Gamepads:()=>Jo,GarbageCollector:()=>Nu,Gif:()=>Em,GifParser:()=>qu,GlobalCoordinates:()=>Qn,GpuParticleEmitter:()=>um,GpuParticleRenderer:()=>ea,Graphic:()=>se,GraphicsComponent:()=>re,GraphicsGroup:()=>Vn,GraphicsSystem:()=>Jh,HashColliderProxy:()=>Cu,HashGridCell:()=>ts,HashGridProxy:()=>$h,HiddenEvent:()=>xh,HorizontalFirst:()=>Hh,ImageFiltering:()=>_e,ImageSource:()=>ji,ImageSourceAttributeConstants:()=>Ft,ImageWrapping:()=>jt,InitializeEvent:()=>qn,InputHost:()=>al,InputMapper:()=>Pu,IsometricEntityComponent:()=>Ur,IsometricEntitySystem:()=>il,IsometricMap:()=>fm,IsometricTile:()=>Gu,KeyEvent:()=>Or,Keyboard:()=>Tu,Keys:()=>Hr,KillEvent:()=>Bo,Label:()=>lm,LimitCameraBoundsStrategy:()=>pu,Line:()=>gl,LineSegment:()=>ue,Loader:()=>fn,LoaderEvents:()=>z_,LockCameraToActorAxisStrategy:()=>uu,LockCameraToActorStrategy:()=>du,LogLevel:()=>Wt,Logger:()=>at,Material:()=>xd,Matrix:()=>pi,MatrixLocations:()=>Ja,MediaEvent:()=>Bh,Meet:()=>qh,MotionComponent:()=>Bt,MotionSystem:()=>jo,MoveBy:()=>Nh,MoveByWithOptions:()=>Ud,MoveTo:()=>Gh,MoveToWithOptions:()=>Hd,NativePointerButton:()=>qs,NativeSoundEvent:()=>un,NativeSoundProcessedEvent:()=>Sd,NineSlice:()=>_l,NineSliceStretch:()=>Ps,None:()=>Oh,Observable:()=>Ze,OffscreenSystem:()=>sl,Pair:()=>Ke,ParallaxComponent:()=>Xo,ParallelActions:()=>gm,Particle:()=>Ho,ParticleEmitter:()=>cm,ParticleRenderer:()=>yd,ParticleTransform:()=>zi,PhysicsStats:()=>ta,PhysicsWorld:()=>Su,PointerAbstraction:()=>ol,PointerButton:()=>Cs,PointerComponent:()=>Xs,PointerEvent:()=>Vr,PointerEventReceiver:()=>$o,PointerScope:()=>F,PointerSystem:()=>Zo,PointerType:()=>Ss,Polygon:()=>pl,PolygonCollider:()=>Be,Pool:()=>Eo,PostCollisionEvent:()=>cn,PostDebugDrawEvent:()=>uh,PostDrawEvent:()=>Xn,PostFrameEvent:()=>gh,PostKillEvent:()=>oh,PostTransformDrawEvent:()=>ch,PostUpdateEvent:()=>Ns,PreCollisionEvent:()=>ln,PreDebugDrawEvent:()=>dh,PreDrawEvent:()=>Gn,PreFrameEvent:()=>fh,PreKillEvent:()=>rh,PreLoadEvent:()=>sm,PreTransformDrawEvent:()=>lh,PreUpdateEvent:()=>Ws,Projection:()=>Ir,QuadIndexBuffer:()=>br,QuadTree:()=>Jn,Query:()=>kr,QueryManager:()=>wu,RadiusAroundActorStrategy:()=>gu,Random:()=>M,Raster:()=>Wn,Ray:()=>gn,RealisticSolver:()=>Zh,Rectangle:()=>Dr,RemoveEvent:()=>Rh,RemovedComponent:()=>P_,Repeat:()=>Dd,RepeatForever:()=>Fd,Resolution:()=>Dh,Resource:()=>xr,ResourceEvents:()=>Yp,RotateBy:()=>Nd,RotateByWithOptions:()=>Wd,RotateTo:()=>Vd,RotateToWithOptions:()=>Od,RotationType:()=>R,ScaleBy:()=>Qd,ScaleByWithOptions:()=>jd,ScaleTo:()=>qd,ScaleToWithOptions:()=>Xd,Scene:()=>Ci,SceneEvents:()=>nm,Screen:()=>Fh,ScreenAppender:()=>_s,ScreenElement:()=>Yh,ScreenEvents:()=>B_,ScreenShader:()=>Ru,ScrollPreventionMode:()=>Ys,Semaphore:()=>Um,SeparatingAxis:()=>me,SeparationInfo:()=>Id,Shader:()=>ni,Shape:()=>Ne,Side:()=>Rt,Slide:()=>Mm,SolverStrategy:()=>Rr,Sound:()=>Pd,SoundEvents:()=>U_,SparseHashGrid:()=>tl,SparseHashGridCollisionProcessor:()=>nl,SpatialPartitionStrategy:()=>Yn,Sprite:()=>Bi,SpriteFont:()=>So,SpriteSheet:()=>an,StandardClock:()=>cl,StateMachine:()=>Wo,StrategyContainer:()=>cu,Stream:()=>Xu,System:()=>yi,SystemManager:()=>Au,SystemPriority:()=>$i,SystemType:()=>mi,TagQuery:()=>Lr,TestClock:()=>zu,Text:()=>Cr,TextAlign:()=>Io,TextureLoader:()=>ne,Tile:()=>lu,TileMap:()=>hu,TileMapEvents:()=>J_,TiledAnimation:()=>ml,TiledSprite:()=>Ar,Timer:()=>_n,Toaster:()=>Hu,Transform:()=>ws,TransformComponent:()=>it,Transition:()=>sa,TreeNode:()=>Lh,Trigger:()=>mu,TriggerEvents:()=>$_,TwoPI:()=>V,Util:()=>v,Vector:()=>B,VectorView:()=>eh,VertexBuffer:()=>Qi,VertexLayout:()=>vs,VerticalFirst:()=>zh,VisibleEvent:()=>wh,WebAudio:()=>dn,WebAudioInstance:()=>Cd,WheelDeltaMode:()=>Zn,WheelEvent:()=>Iu,World:()=>bu,approximatelyEqual:()=>X,assert:()=>dm,canonicalizeAngle:()=>rt,clamp:()=>j,coroutine:()=>Qu,createId:()=>S,frac:()=>L,getDefaultPhysicsConfig:()=>ys,hasGraphicsTick:()=>nh,hasOnAdd:()=>ym,hasOnInitialize:()=>vm,hasOnPostUpdate:()=>bm,hasOnPreUpdate:()=>xm,hasOnRemove:()=>Cm,hasPostDraw:()=>Pm,hasPreDraw:()=>Sm,has_add:()=>_m,has_initialize:()=>pm,has_postupdate:()=>Am,has_preupdate:()=>wm,has_remove:()=>mm,inverseLerp:()=>Bd,inverseLerpVector:()=>kd,isActor:()=>j_,isAddedComponent:()=>S_,isComponentCtor:()=>bd,isLoaderConstructor:()=>kh,isMoveByOptions:()=>Ld,isMoveToOptions:()=>zd,isRemovedComponent:()=>E_,isRotateByOptions:()=>Y_,isRotateToOptions:()=>q_,isScaleByOptions:()=>Yd,isScaleToOptions:()=>Gd,isSceneConstructor:()=>es,isScreenElement:()=>ou,isSystemConstructor:()=>xu,lerp:()=>Md,lerpAngle:()=>Wh,lerpVector:()=>Fr,maxMessages:()=>Zu,nextActionId:()=>Ut,obsolete:()=>km,parseImageFiltering:()=>On,parseImageWrapping:()=>ki,pixelSnapEpsilon:()=>mt,randomInRange:()=>Pt,randomIntInRange:()=>Dt,range:()=>wt,remap:()=>Ki,remapVector:()=>X_,resetObsoleteCounter:()=>Bm,sign:()=>G,toDegrees:()=>lt,toRadians:()=>yt,vec:()=>z,webgl:()=>c});var c={};o.r(c),o.d(c,{getAttributeComponentSize:()=>vd,getAttributePointerType:()=>wd,getGLTypeFromSource:()=>md,getGlTypeSizeBytes:()=>$a,getMaxShaderComplexity:()=>th,isAttributeInSource:()=>_d});var g={};o.r(g),o.d(g,{circle:()=>y_,line:()=>ih,point:()=>A_,roundRect:()=>sh,vector:()=>b_});var _={};o.r(_),o.d(_,{ActionCompleteEvent:()=>Th,ActionStartEvent:()=>Eh,ActivateEvent:()=>Ah,AddEvent:()=>Ih,CollisionEndEvent:()=>Pr,CollisionPostSolveEvent:()=>zo,CollisionPreSolveEvent:()=>Uo,CollisionStartEvent:()=>Sr,ContactEndEvent:()=>Lo,ContactStartEvent:()=>ko,DeactivateEvent:()=>bh,EnterTriggerEvent:()=>Sh,EnterViewPortEvent:()=>Ch,EventTypes:()=>Mo,ExitTriggerEvent:()=>Ph,ExitViewPortEvent:()=>yh,GameEvent:()=>xt,GameStartEvent:()=>ah,GameStopEvent:()=>hh,GamepadAxisEvent:()=>vh,GamepadButtonEvent:()=>mh,GamepadConnectEvent:()=>ph,GamepadDisconnectEvent:()=>_h,HiddenEvent:()=>xh,InitializeEvent:()=>qn,KillEvent:()=>Bo,PostCollisionEvent:()=>cn,PostDebugDrawEvent:()=>uh,PostDrawEvent:()=>Xn,PostFrameEvent:()=>gh,PostKillEvent:()=>oh,PostTransformDrawEvent:()=>ch,PostUpdateEvent:()=>Ns,PreCollisionEvent:()=>ln,PreDebugDrawEvent:()=>dh,PreDrawEvent:()=>Gn,PreFrameEvent:()=>fh,PreKillEvent:()=>rh,PreTransformDrawEvent:()=>lh,PreUpdateEvent:()=>Ws,RemoveEvent:()=>Rh,VisibleEvent:()=>wh});var v={};o.r(v),o.d(v,{ConsoleAppender:()=>Fi,DrawUtil:()=>g,EasingFunctions:()=>Nt,LogLevel:()=>Wt,Logger:()=>at,Observable:()=>Ze,ScreenAppender:()=>_s,addItemToArray:()=>xo,contains:()=>Ao,delay:()=>bo,fail:()=>ud,getPosition:()=>Os,isObject:()=>yo,mergeDeep:()=>Co,omit:()=>fd,removeItemFromArray:()=>ms});function x(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(u){window.setInterval(u,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const e=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(s){return new Promise((r,a)=>{e.call(this,s,r,a)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(u){const e=Date.now();return setTimeout(function(){u({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-e))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(u){clearTimeout(u)})}class A{static useCanvasGraphicsContext(){A.enable("use-canvas-context")}static useLegacyImageRenderer(){A.enable("use-legacy-image-renderer")}static freeze(){A._FROZEN=!0}static _reset(){A._FROZEN=!1,A._FLAGS={}}static enable(e){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");A._FLAGS[e]=!0}static disable(e){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");A._FLAGS[e]=!1}static isEnabled(e){return!!A._FLAGS[e]}static show(){return Object.keys(A._FLAGS)}}A._FROZEN=!1,A._FLAGS={};function S(u,e){return{type:u,value:e}}class P{constructor(){this._isCompleted=!1,this.promise=new Promise((e,s)=>{this._resolver=e,this._rejecter=s})}get isCompleted(){return this._isCompleted}resolve(e){this._isCompleted||(this._isCompleted=!0,this._resolver(e))}reject(e){this._isCompleted||(this._isCompleted=!0,this._rejecter(e))}}class I{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(e,s){var r;return this._empty=!1,this._listeners[e]=(r=this._listeners[e])!==null&&r!==void 0?r:[],this._listeners[e].push(s),{close:()=>this.off(e,s)}}once(e,s){var r;return this._empty=!1,this._listenersOnce[e]=(r=this._listenersOnce[e])!==null&&r!==void 0?r:[],this._listenersOnce[e].push(s),{close:()=>this.off(e,s)}}off(e,s){var r,a;if(s){const l=(r=this._listeners[e])===null||r===void 0?void 0:r.filter(p=>p!==s);this._listeners[e]=l;const f=(a=this._listenersOnce[e])===null||a===void 0?void 0:a.filter(p=>p!==s);this._listenersOnce[e]=f}else delete this._listeners[e]}emit(e,s){if(this._empty||this._paused)return;const r=this._listeners[e];if(r)for(let l=0;l<r.length;l++)r[l](s);const a=this._listenersOnce[e];if(this._listenersOnce[e]=[],a)for(let l=0;l<a.length;l++)a[l](s);for(let l=0;l<this._pipes.length;l++)this._pipes[l].emit(e,s)}pipe(e){if(this===e)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(e),{close:()=>{const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}}}unpipe(e){const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var F;(function(u){u.Canvas="Canvas",u.Document="Document"})(F||(F={}));var R;(function(u){u.ShortestPath="shortest-path",u.LongestPath="longest-path",u.Clockwise="clockwise",u.CounterClockwise="counter-clockwise"})(R||(R={}));const E=4294967295;class M{constructor(e){this.seed=e,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(e||Date.now())>>>0;for(let s=1;s<this._n;s++){const r=this._mt[s-1]^this._mt[s-1]>>>this._w-2;this._mt[s]=(this._f*((r&4294901760)>>>16)<<16)+this._f*(r&65535)+s>>>0}this._index=this._n}_twist(){const e=[0,this._a];let s=0,r=0;for(;r<this._n-this._m;r++)s=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+this._m]^s>>>1^e[s&1]&E;for(;r<this._n-1;r++)s=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+(this._m-this._n)]^s>>>1^e[s&1]&E;s=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^s>>>1^e[s&1]&E,this._index=0}nextInt(){this._index>=this._n&&this._twist();let e=this._mt[this._index++];return e^=e>>>this._u,e^=e<<this._s&this._b,e^=e<<this._t&this._c,e^=e>>>this._l,e>>>0}next(){return this.nextInt()*(1/4294967296)}floating(e,s){return(s-e)*this.next()+e}integer(e,s){return Math.floor((s-e+1)*this.next()+e)}bool(e=.5){return this.next()<=e}pickOne(e){return e[this.integer(0,e.length-1)]}pickSet(e,s,r=!1){return r?this._pickSetWithDuplicates(e,s):this._pickSetWithoutDuplicates(e,s)}_pickSetWithoutDuplicates(e,s){if(s>e.length||s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(s===e.length)return e;const r=new Array(s);let a=0;const l=e.slice(0);for(;a<s;){const f=this.integer(0,l.length-1);r[a++]=l[f],l.splice(f,1)}return r}_pickSetWithDuplicates(e,s){if(s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const r=new Array(s);for(let a=0;a<s;a++)r[a]=this.pickOne(e);return r}shuffle(e){const s=e.slice(0);let r;for(let a=0;a<s.length-2;a++){const l=this.integer(a,s.length-1);r=s[a],s[a]=s[l],s[l]=r}return s}range(e,s,r){const a=new Array(e);for(let l=0;l<e;l++)a[l]=this.integer(s,r);return a}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const V=Math.PI*2;function L(u){return u>=0?u-Math.floor(u):u-Math.ceil(u)}function G(u){return u===0?0:u<0?-1:1}function j(u,e,s){return Math.min(Math.max(e,u),s)}function X(u,e,s){return Math.abs(u-e)<s}function rt(u){let e=u;if(u>=V)for(;e>=V;)e-=V;if(u<0)for(;e<0;)e+=V;return e}function lt(u){return 180/Math.PI*u}function yt(u){return u/180*Math.PI}const wt=(u,e)=>Array.from(new Array(e-u+1),(s,r)=>r+u);function Pt(u,e,s=new M){return s?s.floating(u,e):u+Math.random()*(e-u)}function Dt(u,e,s=new M){return s?s.integer(u,e):Math.round(Pt(u,e))}class B{static get Zero(){return new B(0,0)}static get One(){return new B(1,1)}static get Half(){return new B(.5,.5)}static get Up(){return new B(0,-1)}static get Down(){return new B(0,1)}static get Left(){return new B(-1,0)}static get Right(){return new B(1,0)}static fromAngle(e){return new B(Math.cos(e),Math.sin(e))}static isValid(e){return!(e==null||isNaN(e.x)||isNaN(e.y)||e.x===1/0||e.y===1/0||e.x===-1/0||e.y===-1/0)}static distance(e,s){return Math.sqrt(Math.pow(e.x-s.x,2)+Math.pow(e.y-s.y,2))}static min(e,s){return new B(Math.min(e.x,s.x),Math.min(e.y,s.y))}static max(e,s){return new B(Math.max(e.x,s.x),Math.max(e.y,s.y))}constructor(e,s){this._x=0,this._y=0,this._x=e,this._y=s}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}setTo(e,s){this.x=e,this.y=s}equals(e,s=B.EQUALS_EPSILON){return Math.abs(this.x-e.x)<=s&&Math.abs(this.y-e.y)<=s}distance(e){if(!e)return Math.sqrt(this.x*this.x+this.y*this.y);const s=this.x-e.x,r=this.y-e.y;return Math.sqrt(s*s+r*r)}squareDistance(e){e||(e=B.Zero);const s=this.x-e.x,r=this.y-e.y;return s*s+r*r}clampMagnitude(e){const s=this.magnitude,r=j(s,0,e);return this.magnitude=r,this}get size(){return this.distance()}set size(e){const s=this.normalize().scale(e);this.setTo(s.x,s.y)}get magnitude(){return this.distance()}set magnitude(e){this.normalize().scale(e,this)}normalize(){const e=this.distance();return e===0?B.Zero:new B(this.x/e,this.y/e)}average(e){return this.add(e).scale(.5)}scale(e,s){const r=s||new B(0,0);return e instanceof B?(r.x=this.x*e.x,r.y=this.y*e.y):(r.x=this.x*e,r.y=this.y*e),r}add(e,s){return s?(s.x=this.x+e.x,s.y=this.y+e.y,s):new B(this.x+e.x,this.y+e.y)}sub(e,s){const r=s||new B(0,0),a=this.x-e.x,l=this.y-e.y;return r.x=a,r.y=l,r}addEqual(e){return this.setTo(this.x+e.x,this.y+e.y),this}subEqual(e){return this.setTo(this.x-e.x,this.y-e.y),this}scaleEqual(e){return this.setTo(this.x*e,this.y*e),this}dot(e){return this.x*e.x+this.y*e.y}cross(e){if(e instanceof B)return this.x*e.y-this.y*e.x;if(typeof e=="number")return new B(e*this.y,-e*this.x)}static cross(e,s){return new B(-e*s.y,e*s.x)}perpendicular(){return new B(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return rt(Math.atan2(this.y,this.x))}angleBetween(e,s){const r=this.toAngle(),a=rt(e);let l=0,f=0;switch(a>r?l=a-r:l=(V-r+a)%V,f=(l-V)%V,s){case R.ShortestPath:return Math.abs(l)<Math.abs(f)?l:f;case R.LongestPath:return Math.abs(l)>Math.abs(f)?l:f;case R.Clockwise:return l;case R.CounterClockwise:return f}}rotate(e,s,r){const a=r||new B(0,0);s||(s=new B(0,0));const l=Math.sin(e),f=Math.cos(e),p=f*(this.x-s.x)-l*(this.y-s.y)+s.x,m=l*(this.x-s.x)+f*(this.y-s.y)+s.y;return a.x=p,a.y=m,a}clone(e){const s=e??new B(0,0);return s.x=this.x,s.y=this.y,s}toString(e){return e?`(${this.x.toFixed(e)}, ${this.y.toFixed(e)})`:`(${this.x}, ${this.y})`}}B.EQUALS_EPSILON=.001;function z(u,e){return new B(u,e)}class Z{constructor(e,s,r,a){this.r=e,this.g=s,this.b=r,this.a=a??1}static fromRGB(e,s,r,a){return new Z(e,s,r,a)}static fromRGBString(e){const s=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let r=null;if(r=e.match(s)){const a=parseInt(r[1],10),l=parseInt(r[2],10),f=parseInt(r[3],10);let p=1;return r[4]&&(p=parseFloat(r[4])),new Z(a,l,f,p)}else throw new Error("Invalid rgb/a string: "+e)}static fromHex(e){const s=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let r=null;if(r=e.match(s)){const a=parseInt(r[1],16),l=parseInt(r[2],16),f=parseInt(r[3],16);let p=1;return r[4]&&(p=parseInt(r[4],16)/255),new Z(a,l,f,p)}else throw new Error("Invalid hex string: "+e)}static fromHSL(e,s,r,a=1){return new et(e,s,r,a).toRGBA()}lighten(e=.1){const s=et.fromRGBA(this.r,this.g,this.b,this.a);return s.l+=(1-s.l)*e,s.toRGBA()}darken(e=.1){const s=et.fromRGBA(this.r,this.g,this.b,this.a);return s.l-=s.l*e,s.toRGBA()}saturate(e=.1){const s=et.fromRGBA(this.r,this.g,this.b,this.a);return s.s+=s.s*e,s.toRGBA()}desaturate(e=.1){const s=et.fromRGBA(this.r,this.g,this.b,this.a);return s.s-=s.s*e,s.toRGBA()}multiply(e){const s=e.r/255*this.r/255*255,r=e.g/255*this.g/255*255,a=e.b/255*this.b/255*255,l=e.a*this.a;return new Z(s,r,a,l)}screen(e){const s=e.invert(),r=e.invert();return s.multiply(r).invert()}invert(){return new Z(255-this.r,255-this.g,255-this.b,1-this.a)}average(e){const s=(e.r+this.r)/2,r=(e.g+this.g)/2,a=(e.b+this.b)/2,l=(e.a+this.a)/2;return new Z(s,r,a,l)}equal(e){return this.toString()===e.toString()}toString(e="rgb"){switch(e){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(e){const s=Math.max(Math.round(e),0).toString(16);return s.length===1?"0"+s:s}toHex(){let e="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(e+=this._componentToHex(this.a*255)),e}toRGBA(){const e=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+e+", "+String(this.a)+")":"rgb("+e+")"}toHSLA(){return et.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(e){const s=e||new Z(this.r,this.g,this.b,this.a);return s.r=this.r,s.g=this.g,s.b=this.b,s.a=this.a,s}static get Black(){return Z.fromHex("#000000")}static get White(){return Z.fromHex("#FFFFFF")}static get Gray(){return Z.fromHex("#808080")}static get LightGray(){return Z.fromHex("#D3D3D3")}static get DarkGray(){return Z.fromHex("#A9A9A9")}static get Yellow(){return Z.fromHex("#FFFF00")}static get Orange(){return Z.fromHex("#FFA500")}static get Red(){return Z.fromHex("#FF0000")}static get Vermilion(){return Z.fromHex("#FF5B31")}static get Rose(){return Z.fromHex("#FF007F")}static get Pink(){return Z.fromHex("#FFC0CB")}static get Magenta(){return Z.fromHex("#FF00FF")}static get Violet(){return Z.fromHex("#7F00FF")}static get Purple(){return Z.fromHex("#800080")}static get Blue(){return Z.fromHex("#0000FF")}static get Azure(){return Z.fromHex("#007FFF")}static get Cyan(){return Z.fromHex("#00FFFF")}static get Viridian(){return Z.fromHex("#59978F")}static get Teal(){return Z.fromHex("#008080")}static get Green(){return Z.fromHex("#00FF00")}static get Chartreuse(){return Z.fromHex("#7FFF00")}static get Transparent(){return Z.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return Z.fromHex("#176BAA")}static get Brown(){return Z.fromHex("#964B00")}}class et{constructor(e,s,r,a){this.h=e,this.s=s,this.l=r,this.a=a}static hue2rgb(e,s,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+(s-e)*6*r:r<1/2?s:r<2/3?e+(s-e)*(2/3-r)*6:e}static fromRGBA(e,s,r,a){e/=255,s/=255,r/=255;const l=Math.max(e,s,r),f=Math.min(e,s,r);let p,m;const w=(l+f)/2;if(l===f)p=m=0;else{const b=l-f;switch(m=w>.5?b/(2-l-f):b/(l+f),l){case e:p=(s-r)/b+(s<r?6:0);break;case s:p=(r-e)/b+2;break;case r:p=(e-s)/b+4;break}p/=6}return new et(p,m,w,a)}toRGBA(){let e,s,r;if(this.s===0)e=s=r=this.l;else{const a=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,l=2*this.l-a;e=et.hue2rgb(l,a,this.h+1/3),s=et.hue2rgb(l,a,this.h),r=et.hue2rgb(l,a,this.h-1/3)}return new Z(e*255,s*255,r*255,this.a)}toString(){const e=this.h.toFixed(0),s=this.s.toFixed(0),r=this.l.toFixed(0),a=this.a.toFixed(0);return`hsla(${e}, ${s}, ${r}, ${a})`}}var Wt;(function(u){u[u.Debug=0]="Debug",u[u.Info=1]="Info",u[u.Warn=2]="Warn",u[u.Error=3]="Error",u[u.Fatal=4]="Fatal"})(Wt||(Wt={}));class at{constructor(){if(this._appenders=[],this.defaultLevel=Wt.Info,this._logOnceSet=new Set,at._INSTANCE)throw new Error("Logger is a singleton");return at._INSTANCE=this,at._INSTANCE.addAppender(new Fi),at._INSTANCE}static getInstance(){return at._INSTANCE==null&&(at._INSTANCE=new at),at._INSTANCE}addAppender(e){this._appenders.push(e)}clearAppenders(){this._appenders.length=0}_log(e,s){e==null&&(e=this.defaultLevel);const r=this._appenders.length;for(let a=0;a<r;a++)e>=this.defaultLevel&&this._appenders[a].log(e,s)}_logOnce(e,s){const r=e+s.join("+");this._logOnceSet.has(r)||(this._logOnceSet.add(r),this._log(e,s))}debug(...e){this._log(Wt.Debug,e)}debugOnce(...e){this._logOnce(Wt.Debug,e)}info(...e){this._log(Wt.Info,e)}infoOnce(...e){this._logOnce(Wt.Info,e)}warn(...e){this._log(Wt.Warn,e)}warnOnce(...e){this._logOnce(Wt.Warn,e)}error(...e){this._log(Wt.Error,e)}errorOnce(...e){this._logOnce(Wt.Error,e)}fatal(...e){this._log(Wt.Fatal,e)}fatalOnce(...e){this._logOnce(Wt.Fatal,e)}}at._INSTANCE=null;class Fi{log(e,s){if(!console&&!console.log&&console.warn&&console.error)return;const r=[];r.unshift.apply(r,s),r.unshift("["+Wt[e]+"] : "),e<Wt.Warn?console.log.apply?console.log.apply(console,r):console.log(r.join(" ")):e<Wt.Error?console.warn.apply?console.warn.apply(console,r):console.warn(r.join(" ")):console.error.apply?console.error.apply(console,r):console.error(r.join(" "))}}class _s{constructor(e){var s,r;this._messages=[],this._pos=10,this._color=Z.Black,this._options=e,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(r=(s=e.zIndex)===null||s===void 0?void 0:s.toString())!==null&&r!==void 0?r:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),e.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var e,s,r,a;const l=this._options;this.canvas.width=(e=l.width)!==null&&e!==void 0?e:l.engine.screen.resolution.width,this.canvas.height=(s=l.height)!==null&&s!==void 0?s:l.engine.screen.resolution.height,this.canvas.style.position="absolute";const f=l.engine.screen.screenToPageCoordinates(z(0,0));this.canvas.style.left=f.x+"px",this.canvas.style.top=f.y+"px",this._pos=(r=l.xPos)!==null&&r!==void 0?r:this._pos,this._color=(a=l.color)!==null&&a!==void 0?a:this._color}log(e,s){const r=s.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+Wt[e]+"] : "+r);let a=10;this._messages=this._messages.slice(0,1e3);for(let l=0;l<this._messages.length;l++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[l],this._pos,a),a+=10}}var Rt;(function(u){u.None="None",u.Top="Top",u.Bottom="Bottom",u.Left="Left",u.Right="Right"})(Rt||(Rt={})),function(u){function e(r){return r===u.Top?u.Bottom:r===u.Bottom?u.Top:r===u.Left?u.Right:r===u.Right?u.Left:u.None}u.getOpposite=e;function s(r){return Math.abs(r.x)>=Math.abs(r.y)?r.x<=0?u.Left:u.Right:r.y<=0?u.Top:u.Bottom}u.fromDirection=s}(Rt||(Rt={}));class ht{constructor(e=0,s=0,r=0,a=0){this._points=[],typeof e=="object"?(this.left=e.left,this.top=e.top,this.right=e.right,this.bottom=e.bottom):typeof e=="number"&&(this.left=e,this.top=s,this.right=r,this.bottom=a)}clone(e){const s=e||new ht(0,0,0,0);return s.left=this.left,s.right=this.right,s.top=this.top,s.bottom=this.bottom,s}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(e){return e&&e?Math.abs(e.x)>Math.abs(e.y)?e.x<0?Rt.Right:Rt.Left:e.y<0?Rt.Bottom:Rt.Top:Rt.None}static fromPoints(e){let s=1/0,r=1/0,a=-1/0,l=-1/0;for(let f=0;f<e.length;f++)e[f].x<s&&(s=e[f].x),e[f].x>a&&(a=e[f].x),e[f].y<r&&(r=e[f].y),e[f].y>l&&(l=e[f].y);return new ht(s,r,a,l)}static fromDimension(e,s,r=B.Half,a=B.Zero){return new ht(-e*r.x+a.x,-s*r.y+a.y,e-e*r.x+a.x,s-s*r.y+a.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new B((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new B(this.left,this.top)}get bottomRight(){return new B(this.right,this.bottom)}get topRight(){return new B(this.right,this.top)}get bottomLeft(){return new B(this.left,this.bottom)}translate(e){return new ht(this.left+e.x,this.top+e.y,this.right+e.x,this.bottom+e.y)}rotate(e,s=B.Zero){const r=this.getPoints().map(a=>a.rotate(e,s));return ht.fromPoints(r)}scale(e,s=B.Zero){const r=this.translate(s);return new ht(r.left*e.x,r.top*e.y,r.right*e.x,r.bottom*e.y)}transform(e){const s=e.data[0]*this.left,r=e.data[1]*this.left,a=e.data[0]*this.right,l=e.data[1]*this.right,f=e.data[2]*this.top,p=e.data[3]*this.top,m=e.data[2]*this.bottom,w=e.data[3]*this.bottom,b=e.getPosition(),y=Math.min(s,a)+Math.min(f,m)+b.x,T=Math.min(r,l)+Math.min(p,w)+b.y,D=Math.max(s,a)+Math.max(f,m)+b.x,U=Math.max(r,l)+Math.max(p,w)+b.y;return new ht({left:y,top:T,right:D,bottom:U})}getPerimeter(){const e=this.width,s=this.height;return 2*(e+s)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new B(this.left,this.top)),this._points.push(new B(this.right,this.top)),this._points.push(new B(this.right,this.bottom)),this._points.push(new B(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(e,s=1/0){let r=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,f=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,p=(this.left-e.pos.x)*l,m=(this.right-e.pos.x)*l;r=Math.min(p,m),a=Math.max(p,m);const w=(this.top-e.pos.y)*f,b=(this.bottom-e.pos.y)*f;return r=Math.max(r,Math.min(w,b)),a=Math.min(a,Math.max(w,b)),a>=Math.max(0,r)&&r<s}rayCastTime(e,s=1/0){let r=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,f=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,p=(this.left-e.pos.x)*l,m=(this.right-e.pos.x)*l;r=Math.min(p,m),a=Math.max(p,m);const w=(this.top-e.pos.y)*f,b=(this.bottom-e.pos.y)*f;return r=Math.max(r,Math.min(w,b)),a=Math.min(a,Math.max(w,b)),a>=Math.max(0,r)&&r<s?r:-1}contains(e){return e instanceof B?this.left<=e.x&&this.top<=e.y&&e.y<=this.bottom&&e.x<=this.right:e instanceof ht?this.left<=e.left&&this.top<=e.top&&e.bottom<=this.bottom&&e.right<=this.right:!1}combine(e,s){const r=s||new ht(0,0,0,0),a=Math.min(this.left,e.left),l=Math.min(this.top,e.top),f=Math.max(this.right,e.right),p=Math.max(this.bottom,e.bottom);return r.left=a,r.top=l,r.right=f,r.bottom=p,r}get dimensions(){return new B(this.width,this.height)}overlaps(e,s){const r=s||0;if(e.hasZeroDimensions())return this.contains(e);if(this.hasZeroDimensions())return e.contains(this);const a=this.combine(e);return a.width+r<e.width+this.width&&a.height+r<e.height+this.height}intersect(e){const s=this.combine(e);if(s.width<e.width+this.width&&s.height<e.height+this.height&&!s.dimensions.equals(e.dimensions)&&!s.dimensions.equals(this.dimensions)){let r=0;this.right>=e.left&&this.right<=e.right?r=e.left-this.right:r=e.right-this.left;let a=0;return this.top<=e.bottom&&this.top>=e.top?a=e.bottom-this.top:a=e.top-this.bottom,Math.abs(r)<Math.abs(a)?new B(r,0):new B(0,a)}else if(s.dimensions.equals(e.dimensions)||s.dimensions.equals(this.dimensions)){let r=0;this.width-e.width>=0?this.right-e.right<=e.left-this.left?r=e.left-this.right:r=e.right-this.left:e.right-this.right<=this.left-e.left?r=this.left-e.right:r=this.right-e.left;let a=0;return this.height-e.height>=0?this.bottom-e.bottom<=e.top-this.top?a=e.top-this.bottom:a=e.bottom-this.top:e.bottom-this.bottom<=this.top-e.top?a=this.top-e.bottom:a=this.bottom-e.top,Math.abs(r)<Math.abs(a)?new B(r,0):new B(0,a)}else return null}intersectWithSide(e){const s=this.intersect(e);return ht.getSideFromIntersection(s)}draw(e,s=Z.Yellow){e.debug.drawRect(this.left,this.top,this.width,this.height,{color:s})}}function Os(u){if(u&&u.getBoundingClientRect){const e=u.getBoundingClientRect();return z(e.x+window.scrollX,e.y+window.scrollY)}return B.Zero}function xo(u,e){return e.indexOf(u)===-1?(e.push(u),!0):!1}function ms(u,e){let s=-1;return(s=e.indexOf(u))>-1?(e.splice(s,1),!0):!1}function Ao(u,e){for(let s=0;s<u.length;s++)if(u[s]===e)return!0;return!1}function ud(u){throw new Error(u)}function bo(u,e){var s;const r=new P;return((s=e?.schedule.bind(e))!==null&&s!==void 0?s:setTimeout)(()=>{r.resolve()},u),r.promise}function fd(u,e){const s={};for(const r in u)e.includes(r)||(s[r]=u[r]);return s}function yo(u){return u&&typeof u=="object"&&!Array.isArray(u)}function Co(u,...e){if(!e.length)return u;const s=e.shift();if(yo(u)&&yo(s))for(const r in s)yo(s[r])?(u[r]||Object.assign(u,{[r]:{}}),Co(u[r],s[r])):Object.assign(u,{[r]:s[r]});return Co(u,...e)}var Ja;(function(u){u[u.X=12]="X",u[u.Y=13]="Y"})(Ja||(Ja={}));class pi{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(e,s,r,a,l,f){const p=new pi;return p.data[0]=2/(s-e),p.data[1]=0,p.data[2]=0,p.data[3]=0,p.data[4]=0,p.data[5]=2/(a-r),p.data[6]=0,p.data[7]=0,p.data[8]=0,p.data[9]=0,p.data[10]=-2/(f-l),p.data[11]=0,p.data[12]=-(s+e)/(s-e),p.data[13]=-(a+r)/(a-r),p.data[14]=-(f+l)/(f-l),p.data[15]=1,p}clone(e){const s=e||new pi;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s.data[6]=this.data[6],s.data[7]=this.data[7],s.data[8]=this.data[8],s.data[9]=this.data[9],s.data[10]=this.data[10],s.data[11]=this.data[11],s.data[12]=this.data[12],s.data[13]=this.data[13],s.data[14]=this.data[14],s.data[15]=this.data[15],s}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(e){const s=new pi;return s.data=e,s}static identity(){const e=new pi;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}static translation(e,s){const r=pi.identity();return r.data[12]=e,r.data[13]=s,r}static scale(e,s){const r=pi.identity();return r.data[0]=e,r.data[5]=s,r.data[10]=1,r.data[15]=1,r}static rotation(e){const s=pi.identity();return s.data[0]=Math.cos(e),s.data[4]=-Math.sin(e),s.data[1]=Math.sin(e),s.data[5]=Math.cos(e),s}multiply(e,s){if(e instanceof B){const r=s||new B(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[4]+this.data[12],f=a.x*this.data[1]+a.y*this.data[5]+this.data[13];return r.x=l,r.y=f,r}else{const r=s||new pi,a=e,l=this.data[0],f=this.data[1],p=this.data[2],m=this.data[3],w=this.data[4],b=this.data[5],y=this.data[6],T=this.data[7],D=this.data[8],U=this.data[9],O=this.data[10],q=this.data[11],H=this.data[12],W=this.data[13],J=this.data[14],Y=this.data[15],tt=a.data[0],ot=a.data[1],Q=a.data[2],_t=a.data[3],It=a.data[4],Yt=a.data[5],Zt=a.data[6],Te=a.data[7],te=a.data[8],zt=a.data[9],Ge=a.data[10],ke=a.data[11],st=a.data[12],vn=a.data[13],wn=a.data[14],xn=a.data[15];r.data[0]=l*tt+w*ot+D*Q+H*_t,r.data[1]=f*tt+b*ot+U*Q+W*_t,r.data[2]=p*tt+y*ot+O*Q+J*_t,r.data[3]=m*tt+T*ot+q*Q+Y*_t,r.data[4]=l*It+w*Yt+D*Zt+H*Te,r.data[5]=f*It+b*Yt+U*Zt+W*Te,r.data[6]=p*It+y*Yt+O*Zt+J*Te,r.data[7]=m*It+T*Yt+q*Zt+Y*Te,r.data[8]=l*te+w*zt+D*Ge+H*ke,r.data[9]=f*te+b*zt+U*Ge+W*ke,r.data[10]=p*te+y*zt+O*Ge+J*ke,r.data[11]=m*te+T*zt+q*Ge+Y*ke,r.data[12]=l*st+w*vn+D*wn+H*xn,r.data[13]=f*st+b*vn+U*wn+W*xn,r.data[14]=p*st+y*vn+O*wn+J*xn,r.data[15]=m*st+T*vn+q*wn+Y*xn;const $n=this.getScale();return r._scaleSignX=G($n.x)*G(r._scaleSignX),r._scaleSignY=G($n.y)*G(r._scaleSignY),r}}translate(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],p=this.data[4],m=this.data[5],w=this.data[6],b=this.data[7],y=this.data[8],T=this.data[9],D=this.data[10],U=this.data[11],O=this.data[12],q=this.data[13],H=this.data[14],W=this.data[15],J=0,Y=1;return this.data[12]=r*e+p*s+y*J+O*Y,this.data[13]=a*e+m*s+T*J+q*Y,this.data[14]=l*e+w*s+D*J+H*Y,this.data[15]=f*e+b*s+U*J+W*Y,this}setPosition(e,s){this.data[12]=e,this.data[13]=s}getPosition(){return z(this.data[12],this.data[13])}rotate(e){const s=this.data[0],r=this.data[1],a=this.data[2],l=this.data[3],f=this.data[4],p=this.data[5],m=this.data[6],w=this.data[7],b=Math.sin(e),y=Math.cos(e);return this.data[0]=y*s+b*f,this.data[1]=y*r+b*p,this.data[2]=y*a+b*m,this.data[3]=y*l+b*w,this.data[4]=y*f-b*s,this.data[5]=y*p-b*r,this.data[6]=y*m-b*a,this.data[7]=y*w-b*l,this}scale(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],p=this.data[4],m=this.data[5],w=this.data[6],b=this.data[7];return this.data[0]=r*e,this.data[1]=a*e,this.data[2]=l*e,this.data[3]=f*e,this.data[4]=p*s,this.data[5]=m*s,this.data[6]=w*s,this.data[7]=b*s,this}setRotation(e){const s=this.getScale(),r=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=r*s.y,this.data[4]=-r*s.x,this.data[5]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return rt(e)}getScaleX(){const e=z(this.data[0],this.data[4]).magnitude;return this._scaleSignX*e}getScaleY(){const e=z(this.data[1],this.data[5]).magnitude;return this._scaleSignY*e}getScale(){return z(this.getScaleX(),this.getScaleY())}setScaleX(e){if(this._scaleX===e)return;this._scaleSignX=G(e);const s=z(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[4]=s.y*e,this._scaleX=e}setScaleY(e){if(this._scaleY===e)return;this._scaleSignY=G(e);const s=z(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[5]=s.y*e,this._scaleY=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(e){const r=1/this.getBasisDeterminant(),a=this.data[0],l=this.data[4],f=this.data[1],p=this.data[5],m=e||pi.identity();m.data[0]=p*r,m.data[1]=-f*r,m.data[4]=-l*r,m.data[5]=a*r;const w=this.data[12],b=this.data[13];return m.data[12]=-(w*m.data[0]+b*m.data[4]),m.data[13]=-(w*m.data[1]+b*m.data[5]),m}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class pe{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const e=new pe;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}static translation(e,s){const r=pe.identity();return r.data[4]=e,r.data[5]=s,r}static scale(e,s){const r=pe.identity();return r.data[0]=e,r.data[3]=s,r._scale[0]=e,r._scale[1]=s,r}static rotation(e){const s=pe.identity();return s.data[0]=Math.cos(e),s.data[1]=Math.sin(e),s.data[2]=-Math.sin(e),s.data[3]=Math.cos(e),s}setPosition(e,s){this.data[4]=e,this.data[5]=s}getPosition(){return z(this.data[4],this.data[5])}rotate(e){const s=this.data[0],r=this.data[1],a=this.data[2],l=this.data[3],f=Math.sin(e),p=Math.cos(e);return this.data[0]=p*s+f*a,this.data[1]=p*r+f*l,this.data[2]=p*a-f*s,this.data[3]=p*l-f*r,this}translate(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],p=this.data[4],m=this.data[5];return this.data[4]=r*e+l*s+p,this.data[5]=a*e+f*s+m,this}scale(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3];return this.data[0]=r*e,this.data[1]=a*e,this.data[2]=l*s,this.data[3]=f*s,this._scale[0]=e,this._scale[1]=s,this._scaleSignX=G(e),this._scaleSignY=G(s),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(e){const s=this.determinant();let r=s;s!==0&&(r=1/s);const a=this.data[0],l=this.data[2],f=this.data[1],p=this.data[3],m=e||pe.identity();m.data[0]=p*r,m.data[1]=-f*r,m.data[2]=-l*r,m.data[3]=a*r;const w=this.data[4],b=this.data[5];return m.data[4]=-(w*m.data[0]+b*m.data[2]),m.data[5]=-(w*m.data[1]+b*m.data[3]),m}multiply(e,s){if(e instanceof B){const r=s||new B(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[2]+this.data[4],f=a.x*this.data[1]+a.y*this.data[3]+this.data[5];return r.x=l,r.y=f,r}else{const r=s||new pe,a=e,l=this.data[0],f=this.data[1],p=this.data[2],m=this.data[3],w=this.data[4],b=this.data[5],y=a.data[0],T=a.data[1],D=a.data[2],U=a.data[3],O=a.data[4],q=a.data[5];r.data[0]=l*y+p*T,r.data[1]=f*y+m*T,r.data[2]=l*D+p*U,r.data[3]=f*D+m*U,r.data[4]=l*O+p*q+w,r.data[5]=f*O+m*q+b;const H=this._scaleSignX,W=this._scaleSignY;return r._scaleSignX=H*G(r._scaleSignX),r._scaleSignY=W*G(r._scaleSignY),r}}multiplyQuadInPlace(e){const s=e[0]*this.data[0]+e[1]*this.data[2]+this.data[4],r=e[0]*this.data[1]+e[1]*this.data[3]+this.data[5];e[0]=s,e[1]=r;const a=e[2]*this.data[0]+e[3]*this.data[2]+this.data[4],l=e[2]*this.data[1]+e[3]*this.data[3]+this.data[5];e[2]=a,e[3]=l;const f=e[4]*this.data[0]+e[5]*this.data[2]+this.data[4],p=e[4]*this.data[1]+e[5]*this.data[3]+this.data[5];e[4]=f,e[5]=p;const m=e[6]*this.data[0]+e[7]*this.data[2]+this.data[4],w=e[6]*this.data[1]+e[7]*this.data[3]+this.data[5];e[6]=m,e[7]=w}to4x4(){const e=new pi;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=0,e.data[3]=0,e.data[4]=this.data[2],e.data[5]=this.data[3],e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=this.data[4],e.data[13]=this.data[5],e.data[14]=0,e.data[15]=1,e}setRotation(e){const s=this.getScale(),r=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=r*s.y,this.data[2]=-r*s.x,this.data[3]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return rt(e)}getScaleX(){const e=this.data[0]*this.data[0]+this.data[2]*this.data[2];return e===1?this._scaleSignX:this._scaleSignX*Math.sqrt(e)}getScaleY(){const e=this.data[1]*this.data[1]+this.data[3]*this.data[3];return e===1?this._scaleSignY:this._scaleSignY*Math.sqrt(e)}getScale(){return z(this.getScaleX(),this.getScaleY())}setScaleX(e){if(e===this._scale[0])return;this._scaleSignX=G(e);const s=z(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[2]=s.y*e,this._scale[0]=e}setScaleY(e){if(e===this._scale[1])return;this._scaleSignY=G(e);const s=z(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[3]=s.y*e,this._scale[1]=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}clone(e){const s=e||new pe;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s._scaleSignX=this._scaleSignX,s._scaleSignY=this._scaleSignY,s}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}class wr{constructor(e,s,r=1){this.builder=e,this.cleaner=s,this._pool=[],this._size=0,this.grow(r)}grow(e){if(e>0){this._size+=e;for(let s=0;s<e;s++)this._pool.push(this.builder())}}rent(e=!1){return this._pool.length===0&&this.grow(this._size),e?this.cleaner(this._pool.pop()):this._pool.pop()}return(e){this._pool.push(e)}}class Xp{constructor(){this._pool=new wr(()=>pe.identity(),e=>e.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(e,s){return this._currentTransform.translate(e,s)}rotate(e){return this._currentTransform.rotate(e)}scale(e,s){return this._currentTransform.scale(e,s)}reset(){this._currentTransform.reset()}set current(e){this._currentTransform=e}get current(){return this._currentTransform}}class qp{constructor(){this.opacity=1,this.z=0,this.tint=Z.White,this.material=null}}class gd{constructor(){this._pool=new wr(()=>new qp,e=>(e.opacity=1,e.z=0,e.tint=Z.White,e.material=null,e),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(e){var s;return e.opacity=this.current.opacity,e.z=this.current.z,e.tint=(s=this.current.tint)===null||s===void 0?void 0:s.clone(),e.material=this.current.material,e}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const Yp={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class xr{constructor(e,s,r=!1){this.path=e,this.responseType=s,this.bustCache=r,this.data=null,this.logger=at.getInstance(),this.events=new I}isLoaded(){return this.data!==null}_cacheBust(e){return/\?\w*=\w*/.test(e)?e+="&__="+Date.now():e+="?__="+Date.now(),e}load(){return new Promise((e,s)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),e(this.data);return}const r=new XMLHttpRequest;r.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),r.responseType=this.responseType,r.addEventListener("loadstart",a=>this.events.emit("loadstart",a)),r.addEventListener("progress",a=>this.events.emit("progress",a)),r.addEventListener("error",a=>this.events.emit("error",a)),r.addEventListener("load",a=>this.events.emit("load",a)),r.addEventListener("load",()=>{if(r.status!==0&&r.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",r.status),this.events.emit("error",r.response),s(new Error(r.statusText));return}if(r.response instanceof Blob&&r.response.type==="text/html"){const a=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",r.response),s(new Error(a));return}this.data=r.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),e(this.data)}),r.send()})}}function Mi(u,e){return u&&(u.__isProxy===void 0?new Proxy(u,{set:(s,r,a)=>(s[r]!==a&&(s[r]=a,typeof r=="string"&&r[0]!=="_"&&e(s)),!0),get:(s,r)=>r!=="__isProxy"?s[r]:!0}):u)}const pd=(u=[],e,s)=>({get:(r,a)=>a==="__isProxy"?!0:typeof r[a]=="object"&&r[a]!=null?new Proxy(r[a],pd([...u,a],e,s)):r[a],set:(r,a,l)=>(typeof a=="string"&&a[0]!=="_"&&e(s),r[a]=l,!0)});function jp(u,e){return u&&(u.__isProxy===void 0?new Proxy(u,pd([],e,u)):u)}class se{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(e){this._flipHorizontal=e,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(e){this._flipVertical=e,this._transformStale=!0}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._transformStale=!0}get scale(){return this._scale}set scale(e){this._scale=Mi(e,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(e){e&&(this._origin=Mi(e,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(e){var s,r,a,l,f,p,m;this.id=se._ID++,this.transform=pe.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=B.One,this._width=0,this._height=0,e&&(this.origin=(s=e.origin)!==null&&s!==void 0?s:this.origin,this.flipHorizontal=(r=e.flipHorizontal)!==null&&r!==void 0?r:this.flipHorizontal,this.flipVertical=(a=e.flipVertical)!==null&&a!==void 0?a:this.flipVertical,this.rotation=(l=e.rotation)!==null&&l!==void 0?l:this.rotation,this.opacity=(f=e.opacity)!==null&&f!==void 0?f:this.opacity,this.scale=(p=e.scale)!==null&&p!==void 0?p:this.scale,this.tint=(m=e.tint)!==null&&m!==void 0?m:this.tint,e.width&&(this._width=e.width),e.height&&(this._height=e.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(e){this._width=e,this._transformStale=!0}set height(e){this._height=e,this._transformStale=!0}get localBounds(){return ht.fromDimension(this.width,this.height,B.Zero)}draw(e,s,r){this._preDraw(e,s,r),this._drawImage(e,0,0),this._postDraw(e)}_preDraw(e,s,r){e.save(),e.translate(s,r),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),e.multiply(this.transform),e.opacity=e.opacity*this.opacity,this.tint&&(e.tint=this.tint)}_rotate(e){var s;const r=this.scale.x>0?1:-1,a=this.scale.y>0?1:-1,l=(s=this.origin)!==null&&s!==void 0?s:z(this.width/2,this.height/2);e.translate(l.x,l.y),e.rotate(this.rotation),e.scale(r,a),e.translate(-l.x,-l.y)}_flip(e){this.flipHorizontal&&(e.translate(this.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,this.height/this.scale.y),e.scale(1,-1))}_postDraw(e){this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore()}}se._ID=0;class Bi extends se{static from(e,s){return new Bi({image:e,...s})}constructor(e){var s,r;super(e),this._logger=at.getInstance(),this._dirty=!0,this.image=e.image;const{width:a,height:l}=e;this.sourceView=(s=e.sourceView)!==null&&s!==void 0?s:{x:0,y:0,width:a??0,height:l??0},this.destSize=(r=e.destSize)!==null&&r!==void 0?r:{width:a??0,height:l??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(e){e/=Math.abs(this.scale.x),this.destSize.width=e,super.width=Math.ceil(this.destSize.width)}set height(e){e/=Math.abs(this.scale.y),this.destSize.height=e,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var e,s,r,a,l,f;const{width:p,height:m}=this.image;this.sourceView.width=((e=this.sourceView)===null||e===void 0?void 0:e.width)||p,this.sourceView.height=((s=this.sourceView)===null||s===void 0?void 0:s.height)||m,this.destSize.width=((r=this.destSize)===null||r===void 0?void 0:r.width)||((a=this.sourceView)===null||a===void 0?void 0:a.width)||p,this.destSize.height=((l=this.destSize)===null||l===void 0?void 0:l.height)||((f=this.sourceView)===null||f===void 0?void 0:f.height)||m,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(e,s,r){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(e,s,r)}_drawImage(e,s,r){this.image.isLoaded()?e.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,s,r,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new Bi({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var _e;(function(u){u.Pixel="Pixel",u.Blended="Blended"})(_e||(_e={}));function On(u){switch(u){case _e.Pixel:return _e.Pixel;case _e.Blended:return _e.Blended;default:return}}var jt;(function(u){u.Clamp="Clamp",u.Repeat="Repeat",u.Mirror="Mirror"})(jt||(jt={}));function ki(u){switch(u){case jt.Clamp:return jt.Clamp;case jt.Repeat:return jt.Repeat;case jt.Mirror:return jt.Mirror;default:return jt.Clamp}}class ne{constructor(e,s){var r;this._garbageCollector=s,this._textureMap=new Map,this._collect=a=>{var l;if(this._gl){const f=(l=a.dataset.originalSrc)!==null&&l!==void 0?l:a.constructor.name;return ne._LOGGER.debug(`WebGL Texture for ${f} collected`),this.delete(a),!0}return!1},this._gl=e,ne._MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE),this._garbageCollector&&(ne._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(r=this._garbageCollector.garbageCollector)===null||r===void 0||r.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[e]of this._textureMap)this.delete(e);this._textureMap.clear(),this._gl=null}get(e){return this._textureMap.get(e)}has(e){return this._textureMap.has(e)}load(e,s,r=!1){var a,l;const f=this._gl;if(!f)return null;const{filtering:p,wrapping:m}={...s};let w=null;if(this.has(e)&&(w=this.get(e)),w)return r&&(f.bindTexture(f.TEXTURE_2D,w),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,e)),(a=this._garbageCollector)===null||a===void 0||a.garbageCollector.touch(e),w;w=f.createTexture(),ne.checkImageSizeSupportedAndLog(e),f.bindTexture(f.TEXTURE_2D,w),f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let b;m&&(typeof m=="string"?b={x:m,y:m}:b={x:m.x,y:m.y});const{x:y,y:T}=b??ne.wrapping;switch(y){case jt.Clamp:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);break;case jt.Repeat:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT);break;case jt.Mirror:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.MIRRORED_REPEAT);break;default:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE)}switch(T){case jt.Clamp:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);break;case jt.Repeat:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT);break;case jt.Mirror:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.MIRRORED_REPEAT);break;default:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE)}const D=p??ne.filtering;return f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,D===_e.Pixel?f.NEAREST:f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,D===_e.Pixel?f.NEAREST:f.LINEAR),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,e),this._textureMap.set(e,w),(l=this._garbageCollector)===null||l===void 0||l.garbageCollector.addCollectableResource("texture",e),w}delete(e){const s=this._gl;if(s&&this.has(e)){const r=this.get(e);r&&(this._textureMap.delete(e),s.deleteTexture(r))}}static checkImageSizeSupportedAndLog(e){var s;const r=(s=e.dataset.originalSrc)!==null&&s!==void 0?s:"internal canvas bitmap";return e.width>ne._MAX_TEXTURE_SIZE||e.height>ne._MAX_TEXTURE_SIZE?(ne._LOGGER.error(`The image [${r}] provided to Excalibur is too large for the device's maximum texture size of (${ne._MAX_TEXTURE_SIZE}x${ne._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((e.width>4096||e.height>4096)&&ne._LOGGER.warn(`The image [${r}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}ne._LOGGER=at.getInstance(),ne.filtering=_e.Blended,ne.wrapping={x:jt.Clamp,y:jt.Clamp},ne._MAX_TEXTURE_SIZE=4096;const Ft={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class ji{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(e,s,r){this._logger=at.getInstance(),this.data=new Image,this._readyFuture=new P,this.ready=this._readyFuture.promise,this.path=e;let a=!1,l;typeof s=="boolean"?a=s:{filtering:r,wrapping:l,bustCache:a}={...s},this._resource=new xr(e,"blob",a),this.filtering=r??this.filtering,typeof l=="string"?this.wrapping={x:l,y:l}:this.wrapping=l??this.wrapping,e.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${e} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(e,s){const r=new ji("");if(r._src="image-element",r.data=e,r.data.setAttribute("data-original-src","image-element"),s?.filtering?r.data.setAttribute(Ft.Filtering,s?.filtering):r.data.setAttribute(Ft.Filtering,_e.Blended),s?.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},r.data.setAttribute(Ft.WrappingX,a.x),r.data.setAttribute(Ft.WrappingY,a.y)}else r.data.setAttribute(Ft.WrappingX,jt.Clamp),r.data.setAttribute(Ft.WrappingY,jt.Clamp);return ne.checkImageSizeSupportedAndLog(e),r._readyFuture.resolve(e),r}static fromHtmlCanvasElement(e,s){const r=new ji("");if(r._src="canvas-element-blob",r.data.setAttribute("data-original-src","canvas-element-blob"),s?.filtering?r.data.setAttribute(Ft.Filtering,s?.filtering):r.data.setAttribute(Ft.Filtering,_e.Blended),s?.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},r.data.setAttribute(Ft.WrappingX,a.x),r.data.setAttribute(Ft.WrappingY,a.y)}else r.data.setAttribute(Ft.WrappingX,jt.Clamp),r.data.setAttribute(Ft.WrappingY,jt.Clamp);return ne.checkImageSizeSupportedAndLog(e),e.toBlob(a=>{const l=URL.createObjectURL(a);r.image.onload=()=>{URL.revokeObjectURL(l),r.data=r.image,r._readyFuture.resolve(r.image)},r.image.src=l}),r}static fromSvgString(e,s){const r=new Blob([e],{type:"image/svg+xml"}),a=URL.createObjectURL(r);return new ji(a,s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){var e,s,r,a;if(this.isLoaded())return this.data;try{let l;if(this.path.includes("data:image/"))l=this.path;else{const m=await this._resource.load();l=URL.createObjectURL(m)}const f=new Image,p=new P;f.onload=()=>p.resolve(),f.src=l,f.setAttribute("data-original-src",this.path),await p.promise,this.data=f,ne.checkImageSizeSupportedAndLog(this.data)}catch(l){throw`Error loading ImageSource from path '${this.path}' with error [${l.message}]`}return this.data.setAttribute(Ft.Filtering,this.filtering),this.data.setAttribute(Ft.WrappingX,(s=(e=this.wrapping)===null||e===void 0?void 0:e.x)!==null&&s!==void 0?s:jt.Clamp),this.data.setAttribute(Ft.WrappingY,(a=(r=this.wrapping)===null||r===void 0?void 0:r.y)!==null&&a!==void 0?a:jt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(e){return Bi.from(this,e)}unload(){this.data=new Image}}class So extends se{constructor(e){super(e),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=at.getInstance();const{alphabet:s,spriteSheet:r,caseInsensitive:a,spacing:l,shadow:f,lineHeight:p}=e;this.alphabet=s,this.spriteSheet=r,this.caseInsensitive=a??this.caseInsensitive,this.spacing=l??this.spacing,this.shadow=f??this.shadow,this.lineHeight=p??this.lineHeight}_getCharacterSprites(e){const s=[],r=this.caseInsensitive?e.toLocaleLowerCase():e,a=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let l=0;l<r.length;l++){const f=r[l];let p=a.indexOf(f);p===-1&&(p=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${f}' in configured alphabet '${a}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const m=this.spriteSheet.sprites[p];m?s.push(m):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${f}' at index '${p}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return s}measureText(e,s){const r=this._getLinesFromText(e,s),a=r.reduce((m,w)=>m.length>w.length?m:w),l=this._getCharacterSprites(a);let f=0,p=0;for(const m of l)f+=m.width+this.spacing,p=Math.max(p,m.height);return ht.fromDimension(f*this.scale.x,p*r.length*this.scale.y,B.Zero)}_drawImage(e,s,r,a){var l;let f=0,p=0,m=0;const w=this._getLinesFromText(this._text,a);for(const b of w){for(const y of this._getCharacterSprites(b))y.draw(e,s+f,r+p),f+=y.width+this.spacing,m=Math.max(m,y.height);f=0,p+=(l=this.lineHeight)!==null&&l!==void 0?l:m}}render(e,s,r,a,l,f){this._text=s;const p=this.measureText(s,f);this.width=p.width,this.height=p.height,this.shadow&&(e.save(),e.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(e,a,l),this._drawImage(e,0,0,f),this._postDraw(e),e.restore()),this._preDraw(e,a,l),this._drawImage(e,0,0,f),this._postDraw(e)}clone(){return new So({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(e,s){var r;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let f=a[l],p="";if(this.measureText(f).width>s){for(;this.measureText(f).width>s;)p=f[f.length-1]+p,f=f.slice(0,-1);a[l]=f,a[l+1]=p}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class Ar extends Bi{constructor(e){super({image:e.image,sourceView:e.sourceView,destSize:{width:e.width,height:e.height},flipHorizontal:e.flipHorizontal,flipVertical:e.flipVertical,rotation:e.rotation,scale:e.scale,opacity:e.opacity,tint:e.tint,origin:e.origin}),this._ready=new P,this.ready=this._ready.promise,this._options=e,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(e,s){return new Ar({sourceView:{...e.sourceView},width:e.width,height:e.height,...s,image:e.image})}_applyTiling(){const{width:e,height:s,filtering:r,wrapping:a}={...this._options},l=document.createElement("canvas");l.width=this.sourceView.width,l.height=this.sourceView.height,l.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const p=ji.fromHtmlCanvasElement(l,{wrapping:a??jt.Repeat,filtering:r});e&&(this.destSize.width=e,this.sourceView.width=e),s&&(this.destSize.height=s,this.sourceView.height=s),this.sourceView.x=0,this.sourceView.y=0,this.image=p,this.image.ready.then(()=>this._ready.resolve())}}class an{constructor(e){this.sprites=[];const{sprites:s,rows:r,columns:a}=e;this.sprites=s,this.rows=r??1,this.columns=a??this.sprites.length}getSprite(e,s,r){var a,l,f,p,m,w,b,y,T;if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const D=e+s*this.columns,U=this.sprites[D];if(U){if(r){const O=U.clone();return O.flipHorizontal=(a=r.flipHorizontal)!==null&&a!==void 0?a:O.flipHorizontal,O.flipVertical=(l=r.flipVertical)!==null&&l!==void 0?l:O.flipVertical,O.width=(f=r.width)!==null&&f!==void 0?f:O.width,O.height=(p=r.height)!==null&&p!==void 0?p:O.height,O.rotation=(m=r.rotation)!==null&&m!==void 0?m:O.rotation,O.scale=(w=r.scale)!==null&&w!==void 0?w:O.scale,O.opacity=(b=r.opacity)!==null&&b!==void 0?b:O.opacity,O.tint=(y=r.tint)!==null&&y!==void 0?y:O.tint,O.origin=(T=r.origin)!==null&&T!==void 0?T:O.origin,O}return U}throw Error(`Invalid sprite coordinates (${e}, ${s})`)}getTiledSprite(e,s,r){if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const a=e+s*this.columns,l=this.sprites[a];if(l)return Ar.fromSprite(l,r);throw Error(`Invalid sprite coordinates (${e}, ${s})`)}static fromImageSourceWithSourceViews(e){const s=e.sourceViews.map(r=>new Bi({image:e.image,sourceView:r}));return new an({sprites:s})}static fromImageSource(e){var s;const r=[];e.spacing=(s=e.spacing)!==null&&s!==void 0?s:{};const{image:a,grid:{rows:l,columns:f,spriteWidth:p,spriteHeight:m},spacing:{originOffset:w,margin:b}}=e,y={x:0,y:0,...w},T={x:0,y:0,...b};for(let D=0;D<f;D++)for(let U=0;U<l;U++)r[D+U*f]=new Bi({image:a,sourceView:{x:D*p+T.x*D+y.x,y:U*m+T.y*U+y.y,width:p,height:m},destSize:{height:m,width:p}});return new an({sprites:r,rows:l,columns:f})}clone(){return new an({sprites:this.sprites.map(e=>e.clone()),rows:this.rows,columns:this.columns})}}const Qp="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class Ka{constructor(){this.fontSheet=Qp,this.size=16,this.load()}load(){return this._imageSource=new ji(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=an.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new So({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(e,s,r){this._imageSource.isLoaded()&&this._spriteFont.render(e,s,null,r.x,r.y)}}class Zp{constructor(e,s){this._gl=e,this._texture=s}use(){const e=this._gl;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._texture)}disable(){const e=this._gl;e.bindTexture(e.TEXTURE_2D,null)}}class Po{constructor(e){var s,r;this.antialias=!1,this.samples=1,this._gl=e.gl,this.width=e.width,this.height=e.height,this.transparency=e.transparency,this.antialias=(s=e.antialias)!==null&&s!==void 0?s:this.antialias,this.samples=(r=e.samples)!==null&&r!==void 0?r:this._gl.getParameter(this._gl.MAX_SAMPLES);const a=this._gl;a.drawingBufferFormat?this.bufferFormat=a.drawingBufferFormat:this.transparency?this.bufferFormat=a.RGBA8:this.bufferFormat=a.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(e,s){const r=this._gl;this.width=e,this.height=s,r.bindTexture(r.TEXTURE_2D,this._frameTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.width,this.height,0,r.RGBA,r.UNSIGNED_BYTE,null),this._renderBuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,this._renderBuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,Math.min(this.samples,r.getParameter(r.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const e=this._gl;this._renderBuffer=e.createRenderbuffer(),this._renderFrameBuffer=e.createFramebuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._renderBuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,Math.min(this.samples,e.getParameter(e.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const e=this._gl;this._frameTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._frameTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const s=e.COLOR_ATTACHMENT0;this._frameBuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,s,e.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new Zp(this._gl,this._frameTexture)}blitToScreen(){const e=this._gl;this._renderBuffer?(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)):(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.frameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const e=this._gl;e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.frameBuffer),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)}}copyToTexture(e){const s=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),s.bindFramebuffer(s.FRAMEBUFFER,this._frameBuffer),s.bindTexture(s.TEXTURE_2D,e),s.copyTexImage2D(s.TEXTURE_2D,0,s.RGBA,0,0,this.width,this.height,0)}use(){const e=this._gl;this.antialias?e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.viewport(0,0,this.width,this.height)}disable(){const e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null)}}const Jp=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,Kp=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function $a(u,e){switch(e){case u.INT:case u.UNSIGNED_INT:case u.FLOAT:return 4;case u.SHORT:return 2;case u.UNSIGNED_SHORT:return 2;case u.BYTE:return 1;case u.UNSIGNED_BYTE:return 1;default:return 1}}function _d(u,e){const s=`(?<type>[a-z0-9]+)\\s+${e};`,a=new RegExp(s,"g").exec(u);return a?.length>0}function md(u,e,s){var r;const a=`(?<type>[a-z0-9]+)\\s+${s};`,f=new RegExp(a,"g").exec(e);switch((r=f?.groups)===null||r===void 0?void 0:r.type){case"float":case"vec2":case"vec3":case"vec4":return u.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return u.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return u.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return u.BOOL;case"short":return u.SHORT;case"ushort":return u.UNSIGNED_SHORT;case"ubyte":return u.UNSIGNED_BYTE;case"byte":return u.BYTE;default:return u.FLOAT}}function vd(u,e){switch(e){case u.LOW_FLOAT:case u.HIGH_FLOAT:case u.FLOAT:return 1;case u.FLOAT_VEC2:return 2;case u.FLOAT_VEC3:return 3;case u.FLOAT_VEC4:return 4;case u.BYTE:return 1;case u.UNSIGNED_BYTE:return 1;case u.UNSIGNED_SHORT:case u.SHORT:return 1;default:return 1}}function wd(u,e){switch(e){case u.LOW_FLOAT:case u.HIGH_FLOAT:case u.FLOAT:case u.FLOAT_VEC2:case u.FLOAT_VEC3:case u.FLOAT_VEC4:return u.FLOAT;case u.BYTE:return u.BYTE;case u.UNSIGNED_BYTE:return u.UNSIGNED_BYTE;case u.SHORT:return u.SHORT;case u.UNSIGNED_SHORT:return u.UNSIGNED_SHORT;default:return u.FLOAT}}function th(u,e){const s=a=>{const l=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let f="";for(let p=0;p<a;p++)p===0?f+=`if (index <= ${p}.5) {
`:f+=`   else if (index <= ${p}.5) {
`,f+=`      fragColor = vec4(1.0);
`,f+=`   }
`;return l.replace("%%complexity%%",f)};let r=!1;do{const a=s(e),l=u.createShader(u.FRAGMENT_SHADER);u.shaderSource(l,a),u.compileShader(l),r=u.getShaderParameter(l,u.COMPILE_STATUS),r||(e=e/2|0)}while(!r);return e}class ni{get compiled(){return this._compiled}constructor(e){this._logger=at.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:s,vertexSource:r,fragmentSource:a,onPreLink:l,onPostCompile:f}=e;this._gl=s,this.vertexSource=r,this.fragmentSource=a,this._onPreLink=l,this._onPostCompile=f}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),ni._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return ni._ACTIVE_SHADER_INSTANCE===this}compile(){const e=this._gl,s=this._compileShader(e,this.vertexSource,e.VERTEX_SHADER),r=this._compileShader(e,this.fragmentSource,e.FRAGMENT_SHADER);this.program=this._createProgram(e,s,r);const a=this.getAttributes();for(const f of a)this.attributes[f.name]=f;const l=this.getUniforms();for(const f of l)this.uniforms[f.name]=f;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS),r=[];for(let a=0;a<s;a++){const l=e.getActiveUniform(this.program,a),f=e.getUniformLocation(this.program,l.name);r.push({name:l.name,glType:l.type,location:f})}return r}getAttributes(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES),r=[];for(let a=0;a<s;a++){const l=e.getActiveAttrib(this.program,a),f=e.getAttribLocation(this.program,l.name);r.push({name:l.name,glType:wd(e,l.type),size:vd(e,l.type),location:f,normalized:!1})}return r}setTexture(e,s){const r=this._gl;r.activeTexture(r.TEXTURE0+e),r.bindTexture(r.TEXTURE_2D,s)}setUniformInt(e,s){this.setUniform("uniform1i",e,~~s)}trySetUniformInt(e,s){return this.trySetUniform("uniform1i",e,~~s)}setUniformIntArray(e,s){this.setUniform("uniform1iv",e,s)}trySetUniformIntArray(e,s){return this.trySetUniform("uniform1iv",e,s)}setUniformBoolean(e,s){this.setUniform("uniform1i",e,s?1:0)}trySetUniformBoolean(e,s){return this.trySetUniform("uniform1i",e,s?1:0)}setUniformFloat(e,s){this.setUniform("uniform1f",e,s)}trySetUniformFloat(e,s){return this.trySetUniform("uniform1f",e,s)}setUniformFloatArray(e,s){this.setUniform("uniform1fv",e,s)}trySetUniformFloatArray(e,s){return this.trySetUniform("uniform1fv",e,s)}setUniformFloatVector(e,s){this.setUniform("uniform2f",e,s.x,s.y)}trySetUniformFloatVector(e,s){return this.trySetUniform("uniform2f",e,s.x,s.y)}setUniformFloatColor(e,s){this.setUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}trySetUniformFloatColor(e,s){return this.trySetUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}setUniformMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,s.data)}setUniformAffineMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,[s.data[0],s.data[1],0,0,s.data[2],s.data[3],0,0,0,0,1,0,s.data[4],s.data[5],0,1])}trySetUniformMatrix(e,s){return this.trySetUniform("uniformMatrix4fv",e,!1,s.data)}setUniform(e,s,...r){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${e}:${s}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const l=this._gl.getUniformLocation(this.program,s);if(l){const f=[l,...r];this._gl[e].apply(this._gl,f)}else throw Error(`Uniform ${e}:${s} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(e,s,...r){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${e}:${s}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const l=this._gl.getUniformLocation(this.program,s);if(l){const f=[l,...r];this._gl[e].apply(this._gl,f)}else return!1;return!0}_createProgram(e,s,r){const a=e.createProgram();if(a===null)throw Error("Could not create graphics shader program");if(e.attachShader(a,s),e.attachShader(a,r),this._onPreLink&&this._onPreLink(a),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw Error(`Could not link the program: [${e.getProgramInfoLog(a)}]`);return a}_compileShader(e,s,r){const a=e.VERTEX_SHADER===r?"vertex":"fragment",l=e.createShader(r);if(l===null)throw Error(`Could not build shader: [${s}]`);if(e.shaderSource(l,s),e.compileShader(l),!e.getShaderParameter(l,e.COMPILE_STATUS)){const p=e.getShaderInfoLog(l);throw Error(`Could not compile ${a} shader:

${p}${this._processSourceForError(s,p)}`)}return l}_processSourceForError(e,s){if(!e)return s;const r=e.split(`
`),a=s.search(/\d:\d/),l=s.indexOf(" ",a),[f,p]=s.slice(a,l).split(":").map(m=>Number(m));for(let m=0;m<r.length;m++)r[m]=`${m+1}: ${r[m]}${p===m+1?" <----- ERROR!":""}`;return`

Source:
`+r.join(`
`)}}ni._ACTIVE_SHADER_INSTANCE=null;class Qi{constructor(e){this.type="dynamic";const{gl:s,size:r,type:a,data:l}=e;if(this._gl=s,this.buffer=this._gl.createBuffer(),!l&&!r)throw Error("Must either provide data or a size to the VertexBuffer");l?this.bufferData=l:this.bufferData=new Float32Array(r),this.type=a??this.type,s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer)}unbind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,null)}upload(e){const s=this._gl;s.bindBuffer(s.ARRAY_BUFFER,this.buffer),e?s.bufferSubData(s.ARRAY_BUFFER,0,this.bufferData,0,e):s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class vs{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(e){this._logger=at.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:s,shader:r,vertexBuffer:a,attributes:l,suppressWarnings:f}=e;this._gl=s,this._vertexBuffer=a,this._attributes=l,this._shader=r,this._suppressWarnings=f,r&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(e){e&&this._shader!==e&&(this._shader=e,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const e=this._shader.attributes;for(const l of this._attributes){const f=e[l[0]];if(!f){if(!_d(this._shader.vertexSource,l[0]))throw Error(`The attribute named: ${l[0]} size ${l[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${l[0]} size ${l[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${l[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${l[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const p=md(this._gl,this._shader.vertexSource,l[0]);this._layout.push({name:l[0],glType:p,size:l[1],location:-1,normalized:!1})}if(f){if(f.size!==l[1])throw Error(`VertexLayout size definition for attribute: [${l[0]}, ${l[1]}], doesn't match shader source size ${f.size}:
 ${this._shader.vertexSource}`);this._layout.push(f)}}let s=0;for(const l of this._layout){const f=$a(this._gl,l.glType);this._vertexTotalSizeBytes+=f*l.size,s+=l.size}this._vertexBuffer.bufferData.length%s!==0&&this._logger.warn(`The vertex component size (${s})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const r=this._gl;this._vao=r.createVertexArray(),r.bindVertexArray(this._vao),this._vertexBuffer.bind();let a=0;for(const l of this._layout)l.location!==-1&&(l.glType===r.INT?r.vertexAttribIPointer(l.location,l.size,l.glType,this.totalVertexSizeBytes,a):r.vertexAttribPointer(l.location,l.size,l.glType,l.normalized,this.totalVertexSizeBytes,a),r.enableVertexAttribArray(l.location)),a+=$a(r,l.glType)*l.size;r.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(e=!1,s){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const r=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),e&&this._vertexBuffer.upload(s),r.bindVertexArray(this._vao)}}class Qt{static clear(){Qt.DrawCallCount=0,Qt.DrawnImagesCount=0}}Qt.DrawCallCount=0,Qt.DrawnImagesCount=0;class $p{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=z(0,0),this._endScratch=z(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new ni({gl:e,vertexSource:Jp,fragmentSource:Kp}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new Qi({gl:e,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new vs({gl:e,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,r){this._isFull()&&this.flush(),this._lineCount++;const a=this._context.getTransform(),l=a.multiply(e,this._startScratch),f=a.multiply(s,this._endScratch),p=this._vertexBuffer.bufferData;p[this._vertexIndex++]=l.x,p[this._vertexIndex++]=l.y,p[this._vertexIndex++]=r.r/255,p[this._vertexIndex++]=r.g/255,p[this._vertexIndex++]=r.b/255,p[this._vertexIndex++]=r.a,p[this._vertexIndex++]=f.x,p[this._vertexIndex++]=f.y,p[this._vertexIndex++]=r.r/255,p[this._vertexIndex++]=r.g/255,p[this._vertexIndex++]=r.b/255,p[this._vertexIndex++]=r.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.LINES,0,this._lineCount*2),Qt.DrawnImagesCount+=this._lineCount,Qt.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const t_=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,e_=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class i_{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new ni({gl:e,vertexSource:t_,fragmentSource:e_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new Qi({gl:e,size:7*this._maxPoints,type:"dynamic"}),this._layout=new vs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,r){this._isFull()&&this.flush(),this._pointCount++;const a=this._context.getTransform(),l=this._context.opacity,f=this._context.snapToPixel,p=a.multiply(e);f&&(p.x=~~(p.x+mt),p.y=~~(p.y+mt));const m=this._buffer.bufferData;m[this._vertexIndex++]=p.x,m[this._vertexIndex++]=p.y,m[this._vertexIndex++]=s.r/255,m[this._vertexIndex++]=s.g/255,m[this._vertexIndex++]=s.b/255,m[this._vertexIndex++]=s.a*l,m[this._vertexIndex++]=r*Math.max(a.getScaleX(),a.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.POINTS,0,this._pointCount),Qt.DrawnImagesCount+=this._pointCount,Qt.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const s_=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,n_=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class r_{constructor(e){this._gl=e,this._shader=new ni({gl:e,vertexSource:s_,fragmentSource:n_}),this._shader.compile(),this._buffer=new Qi({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new vs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(e){const s=this._gl,r=e.getShader();r.use(),e.getLayout().use(),s.activeTexture(s.TEXTURE0),r.trySetUniformInt("u_image",0),e.onDraw&&e.onDraw(),s.drawArrays(s.TRIANGLES,0,6)}renderToScreen(){const e=this._gl;this._shader.use(),this._layout.use(),e.drawArrays(e.TRIANGLES,0,6)}}class br{constructor(e,s,r){this._logger=at.getInstance(),this._gl=e,this.buffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer);const a=s*6;if(!r)this.bufferData=new Uint32Array(a);else{const p=Math.floor(16383.5);this.bufferGlType=e.UNSIGNED_SHORT,this.bufferData=new Uint16Array(a),s>p&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${p}) requested quads(${s})`)}let l=0;for(let f=0;f<a;f+=6)this.bufferData[f+0]=l+0,this.bufferData[f+1]=l+1,this.bufferData[f+2]=l+2,this.bufferData[f+3]=l+2,this.bufferData[f+4]=l+1,this.bufferData[f+5]=l+3,l+=4;e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const o_=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,a_=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class h_{constructor(e){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=Z.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=th(e,r);this._maxTextures=Math.min(r,a);const l=this._transformFragmentSource(o_,this._maxTextures);this._shader=new ni({gl:e,fragmentSource:l,vertexSource:a_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((f,p)=>p)),this._buffer=new Qi({gl:e,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new vs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new br(e,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let r=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_textureIndex <= ${l}.5) {
`:a+=`   else if (v_textureIndex <= ${l}.5) {
`,a+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return r=r.replace("%%texture_picker%%",a),r}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(Ft.Filtering),r=s?On(s):void 0,a=ki(e.getAttribute(Ft.WrappingX)),l=ki(e.getAttribute(Ft.WrappingY)),f=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&(this._textures.push(p),this._textureToIndex.set(p,this._textureIndex++),this._images.add(e))}_bindTextures(e){for(let s=0;s<this._maxTextures;s++)e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_2D,this._textures[s]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const r=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(r))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,r,a,l,f,p,m,w){var b,y,T,D;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const U=this._getImageWidth(e),O=this._getImageHeight(e);let q=U||a||0,H=O||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(b=a??U)!==null&&b!==void 0?b:0,this._view[3]=(y=l??O)!==null&&y!==void 0?y:0,this._dest[0]=s??1,this._dest[1]=r??1,f!==void 0&&p!==void 0&&m!==void 0&&w!==void 0&&(this._view[0]=s??1,this._view[1]=r??1,this._view[2]=(T=a??U)!==null&&T!==void 0?T:0,this._view[3]=(D=l??O)!==null&&D!==void 0?D:0,this._dest[0]=f,this._dest[1]=p,q=m,H=w),s=this._view[0],r=this._view[1];const W=this._view[2],J=this._view[3],Y=this._context.getTransform(),tt=this._context.opacity,ot=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+q,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+H,this._quad[6]=this._dest[0]+q,this._quad[7]=this._dest[1]+H,Y.multiplyQuadInPlace(this._quad),ot&&(this._quad[0]=~~(this._quad[0]+G(this._quad[0])*mt),this._quad[1]=~~(this._quad[1]+G(this._quad[1])*mt),this._quad[2]=~~(this._quad[2]+G(this._quad[2])*mt),this._quad[3]=~~(this._quad[3]+G(this._quad[3])*mt),this._quad[4]=~~(this._quad[4]+G(this._quad[4])*mt),this._quad[5]=~~(this._quad[5]+G(this._quad[5])*mt),this._quad[6]=~~(this._quad[6]+G(this._quad[6])*mt),this._quad[7]=~~(this._quad[7]+G(this._quad[7])*mt));const Q=this._context.tint||this._defaultTint,_t=this._getTextureIdForImage(e),It=U||q,Yt=O||H,Zt=(s+this.uvPadding)/It,Te=(r+this.uvPadding)/Yt,te=(s+W-this.uvPadding)/It,zt=(r+J-this.uvPadding)/Yt,Ge=U,ke=O,st=this._layout.vertexBuffer.bufferData;st[this._vertexIndex++]=this._quad[0],st[this._vertexIndex++]=this._quad[1],st[this._vertexIndex++]=tt,st[this._vertexIndex++]=Ge,st[this._vertexIndex++]=ke,st[this._vertexIndex++]=Zt,st[this._vertexIndex++]=Te,st[this._vertexIndex++]=_t,st[this._vertexIndex++]=Q.r/255,st[this._vertexIndex++]=Q.g/255,st[this._vertexIndex++]=Q.b/255,st[this._vertexIndex++]=Q.a,st[this._vertexIndex++]=this._quad[4],st[this._vertexIndex++]=this._quad[5],st[this._vertexIndex++]=tt,st[this._vertexIndex++]=Ge,st[this._vertexIndex++]=ke,st[this._vertexIndex++]=Zt,st[this._vertexIndex++]=zt,st[this._vertexIndex++]=_t,st[this._vertexIndex++]=Q.r/255,st[this._vertexIndex++]=Q.g/255,st[this._vertexIndex++]=Q.b/255,st[this._vertexIndex++]=Q.a,st[this._vertexIndex++]=this._quad[2],st[this._vertexIndex++]=this._quad[3],st[this._vertexIndex++]=tt,st[this._vertexIndex++]=Ge,st[this._vertexIndex++]=ke,st[this._vertexIndex++]=te,st[this._vertexIndex++]=Te,st[this._vertexIndex++]=_t,st[this._vertexIndex++]=Q.r/255,st[this._vertexIndex++]=Q.g/255,st[this._vertexIndex++]=Q.b/255,st[this._vertexIndex++]=Q.a,st[this._vertexIndex++]=this._quad[6],st[this._vertexIndex++]=this._quad[7],st[this._vertexIndex++]=tt,st[this._vertexIndex++]=Ge,st[this._vertexIndex++]=ke,st[this._vertexIndex++]=te,st[this._vertexIndex++]=zt,st[this._vertexIndex++]=_t,st[this._vertexIndex++]=Q.r/255,st[this._vertexIndex++]=Q.g/255,st[this._vertexIndex++]=Q.b/255,st[this._vertexIndex++]=Q.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),this._quads.bind(),e.drawElements(e.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),Qt.DrawnImagesCount+=this._imageCount,Qt.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const l_=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,c_=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class d_{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=Z.Transparent,this._scratch1=z(0,0),this._scratch2=z(0,0),this._scratch3=z(0,0),this._scratch4=z(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new ni({gl:e,fragmentSource:l_,vertexSource:c_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new Qi({gl:e,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new vs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new br(e,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...e){e[0]instanceof B&&e[1]instanceof B?this.drawLine.apply(this,e):this.drawRectangle.apply(this,e)}drawLine(e,s,r,a=1){this._isFull()&&this.flush(),this._rectangleCount++;const l=this._context.getTransform(),f=this._context.opacity,p=this._context.snapToPixel,m=s.sub(e),w=m.magnitude,b=m.normalize().perpendicular(),y=a/2,T=l.multiply(b.scale(y,this._scratch1).add(e,this._scratch1),this._scratch1),D=l.multiply(b.scale(-y,this._scratch2).add(e,this._scratch2),this._scratch2),U=l.multiply(b.scale(y,this._scratch3).add(s,this._scratch3),this._scratch3),O=l.multiply(b.scale(-y,this._scratch4).add(s,this._scratch4),this._scratch4);p&&(T.x=~~(T.x+mt),T.y=~~(T.y+mt),U.x=~~(U.x+mt),U.y=~~(U.y+mt),D.x=~~(D.x+mt),D.y=~~(D.y+mt),O.x=~~(O.x+mt),O.y=~~(O.y+mt));const q=0,H=0,W=1,J=1,Y=this._transparent,tt=0,ot=1,Q=this._layout.vertexBuffer.bufferData;Q[this._vertexIndex++]=T.x,Q[this._vertexIndex++]=T.y,Q[this._vertexIndex++]=q,Q[this._vertexIndex++]=H,Q[this._vertexIndex++]=w,Q[this._vertexIndex++]=a,Q[this._vertexIndex++]=f,Q[this._vertexIndex++]=r.r/255,Q[this._vertexIndex++]=r.g/255,Q[this._vertexIndex++]=r.b/255,Q[this._vertexIndex++]=r.a,Q[this._vertexIndex++]=Y.r/255,Q[this._vertexIndex++]=Y.g/255,Q[this._vertexIndex++]=Y.b/255,Q[this._vertexIndex++]=Y.a,Q[this._vertexIndex++]=tt/ot,Q[this._vertexIndex++]=D.x,Q[this._vertexIndex++]=D.y,Q[this._vertexIndex++]=q,Q[this._vertexIndex++]=J,Q[this._vertexIndex++]=w,Q[this._vertexIndex++]=a,Q[this._vertexIndex++]=f,Q[this._vertexIndex++]=r.r/255,Q[this._vertexIndex++]=r.g/255,Q[this._vertexIndex++]=r.b/255,Q[this._vertexIndex++]=r.a,Q[this._vertexIndex++]=Y.r/255,Q[this._vertexIndex++]=Y.g/255,Q[this._vertexIndex++]=Y.b/255,Q[this._vertexIndex++]=Y.a,Q[this._vertexIndex++]=tt/ot,Q[this._vertexIndex++]=U.x,Q[this._vertexIndex++]=U.y,Q[this._vertexIndex++]=W,Q[this._vertexIndex++]=H,Q[this._vertexIndex++]=w,Q[this._vertexIndex++]=a,Q[this._vertexIndex++]=f,Q[this._vertexIndex++]=r.r/255,Q[this._vertexIndex++]=r.g/255,Q[this._vertexIndex++]=r.b/255,Q[this._vertexIndex++]=r.a,Q[this._vertexIndex++]=Y.r/255,Q[this._vertexIndex++]=Y.g/255,Q[this._vertexIndex++]=Y.b/255,Q[this._vertexIndex++]=Y.a,Q[this._vertexIndex++]=tt/ot,Q[this._vertexIndex++]=O.x,Q[this._vertexIndex++]=O.y,Q[this._vertexIndex++]=W,Q[this._vertexIndex++]=J,Q[this._vertexIndex++]=w,Q[this._vertexIndex++]=a,Q[this._vertexIndex++]=f,Q[this._vertexIndex++]=r.r/255,Q[this._vertexIndex++]=r.g/255,Q[this._vertexIndex++]=r.b/255,Q[this._vertexIndex++]=r.a,Q[this._vertexIndex++]=Y.r/255,Q[this._vertexIndex++]=Y.g/255,Q[this._vertexIndex++]=Y.b/255,Q[this._vertexIndex++]=Y.a,Q[this._vertexIndex++]=tt/ot}drawRectangle(e,s,r,a,l=Z.Transparent,f=0){this._isFull()&&this.flush(),this._rectangleCount++;const p=this._context.getTransform(),m=this._context.opacity,w=this._context.snapToPixel,b=p.multiply(e.add(z(0,0))),y=p.multiply(e.add(z(s,0))),T=p.multiply(e.add(z(s,r))),D=p.multiply(e.add(z(0,r)));w&&(b.x=~~(b.x+mt),b.y=~~(b.y+mt),y.x=~~(y.x+mt),y.y=~~(y.y+mt),D.x=~~(D.x+mt),D.y=~~(D.y+mt),T.x=~~(T.x+mt),T.y=~~(T.y+mt));const U=0,O=0,q=1,H=1,W=this._layout.vertexBuffer.bufferData;W[this._vertexIndex++]=b.x,W[this._vertexIndex++]=b.y,W[this._vertexIndex++]=U,W[this._vertexIndex++]=O,W[this._vertexIndex++]=s,W[this._vertexIndex++]=r,W[this._vertexIndex++]=m,W[this._vertexIndex++]=a.r/255,W[this._vertexIndex++]=a.g/255,W[this._vertexIndex++]=a.b/255,W[this._vertexIndex++]=a.a,W[this._vertexIndex++]=l.r/255,W[this._vertexIndex++]=l.g/255,W[this._vertexIndex++]=l.b/255,W[this._vertexIndex++]=l.a,W[this._vertexIndex++]=f,W[this._vertexIndex++]=D.x,W[this._vertexIndex++]=D.y,W[this._vertexIndex++]=U,W[this._vertexIndex++]=H,W[this._vertexIndex++]=s,W[this._vertexIndex++]=r,W[this._vertexIndex++]=m,W[this._vertexIndex++]=a.r/255,W[this._vertexIndex++]=a.g/255,W[this._vertexIndex++]=a.b/255,W[this._vertexIndex++]=a.a,W[this._vertexIndex++]=l.r/255,W[this._vertexIndex++]=l.g/255,W[this._vertexIndex++]=l.b/255,W[this._vertexIndex++]=l.a,W[this._vertexIndex++]=f,W[this._vertexIndex++]=y.x,W[this._vertexIndex++]=y.y,W[this._vertexIndex++]=q,W[this._vertexIndex++]=O,W[this._vertexIndex++]=s,W[this._vertexIndex++]=r,W[this._vertexIndex++]=m,W[this._vertexIndex++]=a.r/255,W[this._vertexIndex++]=a.g/255,W[this._vertexIndex++]=a.b/255,W[this._vertexIndex++]=a.a,W[this._vertexIndex++]=l.r/255,W[this._vertexIndex++]=l.g/255,W[this._vertexIndex++]=l.b/255,W[this._vertexIndex++]=l.a,W[this._vertexIndex++]=f,W[this._vertexIndex++]=T.x,W[this._vertexIndex++]=T.y,W[this._vertexIndex++]=q,W[this._vertexIndex++]=H,W[this._vertexIndex++]=s,W[this._vertexIndex++]=r,W[this._vertexIndex++]=m,W[this._vertexIndex++]=a.r/255,W[this._vertexIndex++]=a.g/255,W[this._vertexIndex++]=a.b/255,W[this._vertexIndex++]=a.a,W[this._vertexIndex++]=l.r/255,W[this._vertexIndex++]=l.g/255,W[this._vertexIndex++]=l.b/255,W[this._vertexIndex++]=l.a,W[this._vertexIndex++]=f}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),Qt.DrawnImagesCount+=this._rectangleCount,Qt.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const u_=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,f_=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class g_{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new ni({gl:e,fragmentSource:u_,vertexSource:f_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new Qi({gl:e,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new vs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new br(e,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(e,s,r,a=Z.Transparent,l=0){this._isFull()&&this.flush(),this._circleCount++;const f=this._context.getTransform(),p=this._context.opacity,m=this._context.snapToPixel,w=f.multiply(e.add(z(-s,-s))),b=f.multiply(e.add(z(s,-s))),y=f.multiply(e.add(z(s,s))),T=f.multiply(e.add(z(-s,s)));m&&(w.x=~~(w.x+mt),w.y=~~(w.y+mt),b.x=~~(b.x+mt),b.y=~~(b.y+mt),T.x=~~(T.x+mt),T.y=~~(T.y+mt),y.x=~~(y.x+mt),y.y=~~(y.y+mt));const D=0,U=0,O=1,q=1,H=this._layout.vertexBuffer.bufferData;H[this._vertexIndex++]=w.x,H[this._vertexIndex++]=w.y,H[this._vertexIndex++]=D,H[this._vertexIndex++]=U,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=T.x,H[this._vertexIndex++]=T.y,H[this._vertexIndex++]=D,H[this._vertexIndex++]=q,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=b.x,H[this._vertexIndex++]=b.y,H[this._vertexIndex++]=O,H[this._vertexIndex++]=U,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=y.x,H[this._vertexIndex++]=y.y,H[this._vertexIndex++]=O,H[this._vertexIndex++]=q,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),Qt.DrawnImagesCount+=this._circleCount,Qt.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class Eo{constructor(e,s,r=100){this.builder=e,this.recycler=s,this.maxObjects=r,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=at.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let e=0;e<this.maxObjects;e++)this.objects[e]=this.builder()}using(e){const s=e(this);return s?this.done(...s):this.done()}borrow(e){const s=this.get();e(s),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...e){this.index=0;for(const s of e){const r=this.objects.indexOf(s);this.objects[r]=this.builder(),this.totalAllocations++}return e}}class p_{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=pe.identity(),this.state={z:0,opacity:1,tint:Z.White,material:null},this.args=new Array(10)}}const __=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class xd{constructor(e){this._logger=at.getInstance(),this._color=Z.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:s,name:r,vertexSource:a,fragmentSource:l,graphicsContext:f,images:p}=e;if(this._name=r??"anonymous material",this._vertexSource=a??__,this._fragmentSource=l,this._color=s??this._color,!f)throw Error(`Material ${r} must be provided an excalibur webgl graphics context`);if(f instanceof xs?(this._graphicsContext=f,this._initialize(f)):this._logger.warn(`Material ${r} was created in 2D Canvas mode, currently only WebGL is supported`),p)for(const m in p)this.addImageSource(m,p[m])}_initialize(e){if(this._initialized)return;const s=e.__gl;this._maxTextureSlots=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=e.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(e){this._color=e}get name(){var e;return(e=this._name)!==null&&e!==void 0?e:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(e){this._shader&&(this._shader.use(),e(this._shader))}getShader(){return this._shader}addImageSource(e,s){this._images.size<this._maxTextureSlots?this._images.set(e,s):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(e){const s=this._images.get(e);this._graphicsContext.textureLoader.delete(s.image),this._images.delete(e)}_loadImageSource(e){const s=e.image,r=s.getAttribute(Ft.Filtering),a=r?On(r):void 0,l=ki(s.getAttribute(Ft.WrappingX)),f=ki(s.getAttribute(Ft.WrappingY)),p=s.getAttribute("forceUpload")==="true",m=this._graphicsContext.textureLoader.load(s,{filtering:a,wrapping:{x:l,y:f}},p);return s.removeAttribute("forceUpload"),this._textures.has(e)||this._textures.set(e,m),m}uploadAndBind(e,s=2){let r=s;for(const[a,l]of this._images.entries()){if(!l.isLoaded()){this._logger.warnOnce(`Image named ${a} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const f=this._loadImageSource(l);e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,f),this._shader.trySetUniformInt(a,r),r++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class Ad{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(e,s){this._gl=e,this._context=s,this._buffer=new Qi({gl:e,size:6*4,type:"dynamic"}),this._layout=new vs({gl:e,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new br(e,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(e,s,r,a,l,f,p,m,w){var b,y,T,D;const U=this._gl,O=this._context.material;if(!O)return;const q=this._context.getTransform(),H=this._context.opacity,W=O.getShader(),J=this._layout.vertexBuffer.bufferData;let Y=0,tt=e?.width||a||0,ot=e?.height||l||0,Q=[0,0,(b=a??e?.width)!==null&&b!==void 0?b:0,(y=l??e?.height)!==null&&y!==void 0?y:0],_t=[s??1,r??1];f!==void 0&&p!==void 0&&m!==void 0&&w!==void 0&&(Q=[s??1,r??1,(T=a??e?.width)!==null&&T!==void 0?T:0,(D=l??e?.height)!==null&&D!==void 0?D:0],_t=[f,p],tt=m,ot=w),s=Q[0],r=Q[1];const It=Q[2],Yt=Q[3],Zt=z(_t[0],_t[1]),Te=z(_t[0]+tt,_t[1]),te=z(_t[0],_t[1]+ot),zt=z(_t[0]+tt,_t[1]+ot),Ge=e.width||tt,ke=e.height||ot,st=s/Ge,vn=r/ke,wn=(s+It-.01)/Ge,xn=(r+Yt-.01)/ke,$n=q.getPosition(),Ju=$n.add(zt),Ku=$n.x/this._context.width,$u=$n.y/this._context.height,tf=Ju.x/this._context.width,ef=Ju.y/this._context.height;J[Y++]=Zt.x,J[Y++]=Zt.y,J[Y++]=st,J[Y++]=vn,J[Y++]=Ku,J[Y++]=$u,J[Y++]=te.x,J[Y++]=te.y,J[Y++]=st,J[Y++]=xn,J[Y++]=Ku,J[Y++]=ef,J[Y++]=Te.x,J[Y++]=Te.y,J[Y++]=wn,J[Y++]=vn,J[Y++]=tf,J[Y++]=$u,J[Y++]=zt.x,J[Y++]=zt.y,J[Y++]=wn,J[Y++]=xn,J[Y++]=tf,J[Y++]=ef;const zm=this._addImageAsTexture(e);O.use(),this._layout.shader=W,this._layout.use(!0),W.trySetUniformFloat("u_time_ms",performance.now()),W.trySetUniformFloat("u_opacity",H),W.trySetUniformFloatVector("u_resolution",z(this._context.width,this._context.height)),W.trySetUniformFloatVector("u_graphic_resolution",z(Ge,ke)),W.trySetUniformFloatVector("u_size",z(It,Yt)),W.trySetUniformMatrix("u_matrix",this._context.ortho),W.trySetUniformMatrix("u_transform",q.to4x4()),U.activeTexture(U.TEXTURE0+0),U.bindTexture(U.TEXTURE_2D,zm),W.trySetUniformInt("u_graphic",0),U.activeTexture(U.TEXTURE0+1),U.bindTexture(U.TEXTURE_2D,this._context.materialScreenTexture),W.trySetUniformInt("u_screen_texture",1),O.uploadAndBind(U),this._quads.bind(),U.drawElements(U.TRIANGLES,6,this._quads.bufferGlType,0),Qt.DrawnImagesCount++,Qt.DrawCallCount++}_addImageAsTexture(e){const s=e.getAttribute(Ft.Filtering),r=s?On(s):void 0,a=ki(e.getAttribute(Ft.WrappingX)),l=ki(e.getAttribute(Ft.WrappingY)),f=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);return e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&this._textures.push(p),p}hasPendingDraws(){return!1}flush(){}}const m_=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,v_=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var Me;(function(u){u.World="world",u.Screen="screen"})(Me||(Me={}));class eh extends B{constructor(e){super(0,0),this._getX=e.getX,this._getY=e.getY,this._setX=e.setX,this._setY=e.setY}get x(){return this._x=this._getX()}set x(e){this._setX(e),this._x=e}get y(){return this._y=this._getY()}set y(e){this._setY(e),this._y=e}}class Vs extends B{constructor(e,s){super(e.x,e.y),this.original=e,this.change=s}get x(){return this._x=this.original.x}set x(e){e!==this._x&&(this.change(e,this._y),this._x=this.original.x=e)}get y(){return this._y=this.original.y}set y(e){e!==this._y&&(this.change(this._x,e),this._y=this.original.y=e)}setTo(e,s){this.x=e,this.y=s}}class ws{constructor(){this._parent=null,this._children=[],this._pos=new Vs(z(0,0),()=>{this.flagDirty()}),this._globalPos=new eh({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:e=>{if(this.parent){const{x:s}=this.parent.inverse.multiply(z(e,this.pos.y));this.pos.x=s}else this.pos.x=e;e!==this.matrix.data[4]&&this.flagDirty()},setY:e=>{if(this.parent){const{y:s}=this.parent.inverse.multiply(z(this.pos.x,e));this.pos.y=s}else this.pos.y=e;e!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new Vs(z(1,1),()=>{this.flagDirty()}),this._globalScale=new eh({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:e=>{if(this.parent){const s=this.parent.globalScale.x;this.scale.x=e/s}else this.scale.x=e},setY:e=>{if(this.parent){const s=this.parent.globalScale.y;this.scale.y=e/s}else this.scale.y=e}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=pe.identity(),this._inverse=pe.identity(),this._scratch=pe.identity()}get parent(){return this._parent}set parent(e){if(this._parent){const s=this._parent._children.indexOf(this);s>-1&&this._parent._children.splice(s,1)}this._parent=e,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(e){this._pos.x=e.x,this._pos.y=e.y}get pos(){return this._pos}set globalPos(e){let s=e.clone();this.parent&&(s=this.parent.inverse.multiply(e)),s.equals(this._pos)||(this._pos=s,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(e){const s=rt(e);s!==this._rotation&&this.flagDirty(),this._rotation=s}get rotation(){return this._rotation}set globalRotation(e){let s=0;this.parent&&(s=this.parent.globalRotation);const r=rt(e+s);r!==this._rotation&&this.flagDirty(),this._rotation=r}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(e){this._scale.x=e.x,this._scale.y=e.y}get scale(){return this._scale}set globalScale(e){let s=z(1,1);this.parent&&(s=this.parent.globalScale),this.scale=e.scale(z(1/s.x,1/s.y))}get globalScale(){return this._globalScale}set z(e){this._z=e,this.flagDirty()}get z(){return this._z}set globalZ(e){this.parent?this.z=e-this.parent.globalZ:this.z=e}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let e=0;e<this._children.length;e++)this._children[e].flagDirty()}apply(e){return this.matrix.multiply(e)}applyInverse(e){return this.inverse.multiply(e)}setTransform(e,s,r){this._pos.x=e.x,this._pos.y=e.y,this._rotation=rt(s),this._scale.x=r.x,this._scale.y=r.y,this.flagDirty()}isMirrored(){const e=G(this.scale.x)>>>31,s=G(this.scale.y)>>>31;return!!(e^s)}clone(e){const s=e??new ws;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.flagDirty(),s}cloneWithParent(e){const s=e??new ws;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.parent=this.parent,s.flagDirty(),s}toString(){return this.matrix.toString()}}function bd(u){return!!u&&!!u.prototype&&!!u.prototype.constructor}function w_(u){return!!u?.clone}class Ti{constructor(){this.owner=void 0}clone(){const e=new this.constructor;for(const s in this)if(this.hasOwnProperty(s)){const r=this[s];w_(r)&&s!=="owner"&&s!=="clone"?e[s]=r.clone():e[s]=r}return e}}class Ze{constructor(){this.observers=[],this.subscriptions=[]}register(e){this.observers.push(e)}subscribe(e){this.subscriptions.push(e)}unregister(e){const s=this.observers.indexOf(e);s!==-1&&this.observers.splice(s,1)}unsubscribe(e){const s=this.subscriptions.indexOf(e);s!==-1&&this.subscriptions.splice(s,1)}notifyAll(e){const s=this.observers.length;for(let a=0;a<s;a++)this.observers[a].notify(e);const r=this.subscriptions.length;for(let a=0;a<r;a++)this.subscriptions[a](e)}clear(){this.observers.length=0,this.subscriptions.length=0}}class it extends Ti{constructor(){super(...arguments),this._logger=at.getInstance(),this._parentComponent=null,this._transform=new ws,this._addChildTransform=e=>{const s=e.get(it);s&&(s._transform.parent=this._transform,s._parentComponent=this)},this.zIndexChanged$=new Ze,this._coordPlane=Me.World}get(){return this._transform}onAdd(e){for(const s of e.children)this._addChildTransform(s);e.childrenAdded$.subscribe(s=>this._addChildTransform(s)),e.childrenRemoved$.subscribe(s=>{const r=s.get(it);r&&(r._transform.parent=null,r._parentComponent=null)})}onRemove(e){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(e){const s=this._transform.z;this._transform.z=e,s!==e&&this.zIndexChanged$.notifyAll(e)}get globalZ(){return this._transform.globalZ}set globalZ(e){this._transform.globalZ=e}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(e){var s;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(s=this.owner)===null||s===void 0?void 0:s.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=e}get pos(){return this._transform.pos}set pos(e){this._transform.pos=e}get globalPos(){return this._transform.globalPos}set globalPos(e){this._transform.globalPos=e}get rotation(){return this._transform.rotation}set rotation(e){this._transform.rotation=e}get globalRotation(){return this._transform.globalRotation}set globalRotation(e){this._transform.globalRotation=e}get scale(){return this._transform.scale}set scale(e){this._transform.scale=e}get globalScale(){return this._transform.globalScale}set globalScale(e){this._transform.globalScale=e}applyInverse(e){return this._transform.applyInverse(e)}apply(e){return this._transform.apply(e)}clone(){const e=new it;return e._transform=this._transform.clone(),e}}var yr;(function(u){u.Forward="forward",u.Backward="backward"})(yr||(yr={}));var Li;(function(u){u.End="end",u.Loop="loop",u.PingPong="pingpong",u.Freeze="freeze"})(Li||(Li={}));const x_={Frame:"frame",Loop:"loop",End:"end"};class Ui extends se{constructor(e){var s,r,a;super(e),this.events=new I,this.frames=[],this.strategy=Li.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=e.frames,this.speed=(s=e.speed)!==null&&s!==void 0?s:this.speed,this.strategy=(r=e.strategy)!==null&&r!==void 0?r:this.strategy,this.frameDuration=e.totalDuration?e.totalDuration/this.frames.length:(a=e.frameDuration)!==null&&a!==void 0?a:this.frameDuration,e.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new Ui({frames:this.frames.map(e=>({...e})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.width*this.scale.x):0}get height(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.height*this.scale.y):0}static fromSpriteSheet(e,s,r,a=Li.Loop){const l=e.sprites.length-1,f=s.filter(p=>p<0||p>l);return f.length&&Ui._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${f.join(",")} no frame will be shown`),new Ui({frames:e.sprites.filter((p,m)=>s.indexOf(m)>-1).map(p=>({graphic:p,duration:r})),strategy:a})}static fromSpriteSheetCoordinates(e){var s;const{spriteSheet:r,frameCoordinates:a,durationPerFrame:l,durationPerFrameMs:f,speed:p,strategy:m,reverse:w}=e,b=(s=l??f)!==null&&s!==void 0?s:100,y=[];for(const T of a){const{x:D,y:U,duration:O,options:q}=T,H=r.getSprite(D,U,q);H?y.push({graphic:H,duration:O??b}):Ui._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${D}, ${U}), please check your SpriteSheet to confirm that sprite exists`)}return new Ui({frames:y,strategy:m,speed:p,reverse:w})}get speed(){return this._speed}set speed(e){this._speed=j(Math.abs(e),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?yr.Backward:yr.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const e=this.frames[this._currentFrame];e&&(this._timeLeftInFrame=e?.duration||this.frameDuration)}get canFinish(){switch(this.strategy){case Li.End:case Li.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(e,s){this._currentFrame=e,this._timeLeftInFrame=s??this.frameDuration;const r=this.frames[this._currentFrame];r&&!this._done&&(this._timeLeftInFrame=s??(r?.duration||this.frameDuration),this.events.emit("frame",{...r,frameIndex:this.currentFrameIndex}))}_nextFrame(){const e=this._currentFrame;if(this._done)return e;let s=-1;switch(this.strategy){case Li.Loop:{s=(e+1)%this.frames.length,s===0&&this.events.emit("loop",this);break}case Li.End:{s=e+1,s>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case Li.Freeze:{s=j(e+1,0,this.frames.length-1),s>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case Li.PingPong:{e+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),e+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),s=e+this._pingPongDirection%this.frames.length;break}}return s}tick(e,s=0){this._idempotencyToken!==s&&(this._idempotencyToken=s,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=e*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(e,s,r){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(e,s,r)}}Ui._LOGGER=at.getInstance();class Vn extends se{constructor(e){var s;super(e),this._logger=at.getInstance(),this.useAnchor=!0,this.members=[],this.members=e.members,this.useAnchor=(s=e.useAnchor)!==null&&s!==void 0?s:this.useAnchor,this._updateDimensions()}clone(){return new Vn({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const e=this.localBounds;return this.width=e.width,this.height=e.height,e}get localBounds(){const e=new ht;for(const s of this.members)if(s instanceof se)s.localBounds.combine(e,e);else{const{graphic:r,offset:a,useBounds:l}=s;r?(l===void 0?!0:l)&&r.localBounds.translate(a).combine(e,e):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(s)}.`)}return e}_isAnimationOrGroup(e){return e instanceof Ui||e instanceof Vn}tick(e,s){for(const r of this.members){let a;r instanceof se?a=r:a=r.graphic,this._isAnimationOrGroup(a)&&a.tick(e,s)}}reset(){for(const e of this.members){let s;e instanceof se?s=e:s=e.graphic,this._isAnimationOrGroup(s)&&s.reset()}}_preDraw(e,s,r){this._updateDimensions(),super._preDraw(e,this.useAnchor?s:0,this.useAnchor?r:0)}_drawImage(e,s,r){const a=B.Zero;for(const l of this.members){let f;l instanceof se?f=l:(f=l.graphic,l.offset.clone(a)),f&&(e.save(),e.translate(s,r),f.draw(e,a.x,a.y),this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore())}}}class Wn extends se{constructor(e){var s,r,a,l,f,p,m,w,b,y;super(fd({...e},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=Mi(Z.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,e&&(this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this.color=(r=e.color)!==null&&r!==void 0?r:Z.Black,this.strokeColor=e?.strokeColor,this.smoothing=(a=e.smoothing)!==null&&a!==void 0?a:this.smoothing,this.lineWidth=(l=e.lineWidth)!==null&&l!==void 0?l:this.lineWidth,this.lineDash=(f=e.lineDash)!==null&&f!==void 0?f:this.lineDash,this.lineCap=(p=e.lineCap)!==null&&p!==void 0?p:this.lineCap,this.padding=(m=e.padding)!==null&&m!==void 0?m:this.padding,this.filtering=(w=e.filtering)!==null&&w!==void 0?w:this.filtering),this._bitmap=document.createElement("canvas");const T=(b=e?.width)!==null&&b!==void 0?b:this._bitmap.width,D=(y=e?.height)!==null&&y!==void 0?y:this._bitmap.height;this.width=T,this.height=D;const U=this._bitmap.getContext("2d");if(U)this._ctx=U;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(e){e/=Math.abs(this.scale.x),this._bitmap.width=e,this._originalWidth=e,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(e){e/=Math.abs(this.scale.y),this._bitmap.height=e,this._originalHeight=e,this.flagDirty()}_getTotalWidth(){var e;return(((e=this._originalWidth)!==null&&e!==void 0?e:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var e;return(((e=this._originalHeight)!==null&&e!==void 0?e:this._bitmap.height)+this.padding*2)*1}get localBounds(){return ht.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,B.Zero)}get smoothing(){return this._smoothing}set smoothing(e){this._smoothing=e,this.flagDirty()}get color(){return this._color}set color(e){this.flagDirty(),this._color=Mi(e,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(e){this.flagDirty(),e&&(this._strokeColor=Mi(e,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(e){this._lineDash=e,this.flagDirty()}get padding(){return this._padding}set padding(e){this._padding=e,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(e){var s,r,a,l;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),e.scale(this.quality,this.quality),e.translate(this.padding,this.padding),e.imageSmoothingEnabled=this.smoothing,e.lineWidth=this.lineWidth,e.setLineDash((s=this.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.lineCap=this.lineCap,e.strokeStyle=(a=(r=this.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&a!==void 0?a:"",e.fillStyle=(l=this.color)===null||l===void 0?void 0:l.toString()}_drawImage(e,s,r){this._dirty&&this.rasterize(),e.scale(1/this.quality,1/this.quality),e.drawImage(this._bitmap,s,r)}}var To;(function(u){u.Em="em",u.Rem="rem",u.Px="px",u.Pt="pt",u.Percent="%"})(To||(To={}));var Io;(function(u){u.Left="left",u.Right="right",u.Center="center",u.Start="start",u.End="end"})(Io||(Io={}));var Ro;(function(u){u.Top="top",u.Hanging="hanging",u.Middle="middle",u.Alphabetic="alphabetic",u.Ideographic="ideographic",u.Bottom="bottom"})(Ro||(Ro={}));var Do;(function(u){u.Normal="normal",u.Italic="italic",u.Oblique="oblique"})(Do||(Do={}));var Fo;(function(u){u.LeftToRight="ltr",u.RightToLeft="rtl"})(Fo||(Fo={}));function ih(u,e=Z.Red,s,r,a,l,f=1,p="butt"){u.save(),u.beginPath(),u.lineWidth=f,u.lineCap=p,u.strokeStyle=e.toString(),u.moveTo(s,r),u.lineTo(a,l),u.closePath(),u.stroke(),u.restore()}function A_(u,e=Z.Red,s){u.beginPath(),u.strokeStyle=e.toString(),u.arc(s.x,s.y,5,0,Math.PI*2),u.closePath(),u.stroke()}function b_(u,e,s,r,a=1){const l=e?e.toString():"blue",f=r.scale(a);u.beginPath(),u.strokeStyle=l,u.moveTo(s.x,s.y),u.lineTo(s.x+f.x,s.y+f.y),u.closePath(),u.stroke()}function sh(u,e,s,r,a,l=5,f=Z.White,p=null){let m;if(typeof l=="number")m={tl:l,tr:l,br:l,bl:l};else{const w={tl:0,tr:0,br:0,bl:0};for(const b in w)if(w.hasOwnProperty(b)){const y=b;m[y]=l[y]||w[y]}}u.beginPath(),u.moveTo(e+m.tl,s),u.lineTo(e+r-m.tr,s),u.quadraticCurveTo(e+r,s,e+r,s+m.tr),u.lineTo(e+r,s+a-m.br),u.quadraticCurveTo(e+r,s+a,e+r-m.br,s+a),u.lineTo(e+m.bl,s+a),u.quadraticCurveTo(e,s+a,e,s+a-m.bl),u.lineTo(e,s+m.tl),u.quadraticCurveTo(e,s,e+m.tl,s),u.closePath(),p&&(u.fillStyle=p.toString(),u.fill()),f&&(u.strokeStyle=f.toString(),u.stroke())}function y_(u,e,s,r,a=Z.White,l=null){u.beginPath(),u.arc(e,s,r,0,Math.PI*2),u.closePath(),l&&(u.fillStyle=l.toString(),u.fill()),a&&(u.strokeStyle=a.toString(),u.stroke())}class Nn{constructor(e,s,r,a){this.font=e,this.text=s,this.color=r,this.maxWidth=a,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const l=this.canvas.getContext("2d");if(!l)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=l,this.dimensions=this.measureText(s),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(e,s){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let r=null;s!=null?r=this._getLinesFromText(e,s):r=e.split(`
`);const a=r.reduce((T,D)=>T.length>D.length?T:D);this._applyFont(this.ctx);const l=this.ctx.measureText(a);let f=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);const p=f*r.length;f=p;const m=p-Math.abs(l.actualBoundingBoxAscent),w=0,b=0;return new ht({left:w-Math.abs(l.actualBoundingBoxLeft)-this.font.padding,top:b-Math.abs(l.actualBoundingBoxAscent)-this.font.padding,bottom:b+m+this.font.padding,right:w+Math.abs(l.actualBoundingBoxRight)+this.font.padding})}_setDimension(e,s){let r=1;this.font.lineHeight&&(r=this.font.lineHeight/this.font.size),s.canvas.width=(e.width+this.font.padding*2)*2*this.font.quality,s.canvas.height=(e.height+this.font.padding*2)*2*this.font.quality*r}static getHashCode(e,s,r){var a;return s+"__hashcode__"+e.fontString+e.showDebug+e.textAlign+e.baseAlign+e.direction+e.lineHeight+JSON.stringify(e.shadow)+(e.padding.toString()+e.smoothing.toString()+e.lineWidth.toString()+e.lineDash.toString()+((a=e.strokeColor)===null||a===void 0?void 0:a.toString())+(r?r.toString():e.color.toString()))}getHashCode(e=!0){return Nn.getHashCode(this.font,this.text,e?this.color:void 0)}_applyRasterProperties(e){var s,r,a;e.translate(this.font.padding,this.font.padding),e.imageSmoothingEnabled=this.font.smoothing,e.lineWidth=this.font.lineWidth,e.setLineDash((s=this.font.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.strokeStyle=(a=(r=this.font.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&a!==void 0?a:"",e.fillStyle=this.color.toString()}_applyFont(e){e.resetTransform(),e.translate(this.font.padding+e.canvas.width/2,this.font.padding+e.canvas.height/2),e.scale(this.font.quality,this.font.quality),e.textAlign=this.font.textAlign,e.textBaseline=this.font.baseAlign,e.font=this.font.fontString,e.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(e.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(e.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(e.shadowOffsetX=this.font.shadow.offset.x,e.shadowOffsetY=this.font.shadow.offset.y))}_drawText(e,s,r){this._applyRasterProperties(e),this._applyFont(e);for(let a=0;a<s.length;a++){const l=s[a];this.color&&e.fillText(l,0,a*r),this.font.strokeColor&&e.strokeText(l,0,a*r)}this.font.showDebug&&(ih(e,Z.Green,-e.canvas.width/2,0,e.canvas.width/2,0,2),ih(e,Z.Red,0,-e.canvas.height/2,0,e.canvas.height/2,2))}_splitTextBitmap(e){const s=[];let r=0,a=0;const l=Math.min(4096,e.canvas.width),f=Math.min(4096,e.canvas.height);for(;r<e.canvas.width;){for(;a<e.canvas.height;){const p=document.createElement("canvas");p.width=l,p.height=f;const m=p.getContext("2d");if(!m)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");m.drawImage(e.canvas,r,a,l,f,0,0,l,f),s.push({x:r,y:a,canvas:p}),a+=f}r+=l,a=0}return s}flagDirty(){this._dirty=!0}render(e,s,r,a){var l;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=e;const f=this.getHashCode();if(this._lastHashCode!==f&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,a),this._setDimension(this.dimensions,this.ctx);const p=this._getLinesFromText(this.text,a),m=(l=this.font.lineHeight)!==null&&l!==void 0?l:this.dimensions.height/p.length;if(this._drawText(this.ctx,p,m),e instanceof xs)for(const w of this._textFragments)e.textureLoader.delete(w.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),e instanceof xs)for(const w of this._textFragments)e.textureLoader.load(w.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=f,this._dirty=!1}for(const p of this._textFragments)e.drawImage(p.canvas,0,0,p.canvas.width,p.canvas.height,p.x/this.font.quality+s-this.ctx.canvas.width/this.font.quality/2,p.y/this.font.quality+r-this.ctx.canvas.height/this.font.quality/2,p.canvas.width/this.font.quality,p.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof xs)for(const e of this._textFragments)this._ex.textureLoader.delete(e.canvas);this._textFragments.length=0}_getLinesFromText(e,s){var r;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let f=a[l],p="";if(this.measureText(f).width>s){for(;this.measureText(f).width>s;)p=f[f.length-1]+p,f=f.slice(0,-1);a[l]=f,a[l+1]=p}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class Lt{static measureText(e,s,r){const a=Nn.getHashCode(s,e);if(Lt._MEASURE_CACHE.has(a))return Lt._MEASURE_CACHE.get(a);Lt._LOGGER.debug("Font text measurement cache miss");const l=s.measureTextWithoutCache(e,r);return Lt._MEASURE_CACHE.set(a,l),l}static getTextInstance(e,s,r){const a=Nn.getHashCode(s,e,r);let l=Lt._TEXT_CACHE.get(a);return l||(l=new Nn(s,e,r),Lt._TEXT_CACHE.set(a,l),Lt._LOGGER.debug("Font text instance cache miss")),Lt._TEXT_USAGE.set(l,performance.now()),l}static checkAndClearCache(){const e=[],s=new Set;for(const[a,l]of Lt._TEXT_USAGE.entries())if(l+Lt.FONT_TIMEOUT<performance.now())Lt._LOGGER.debug(`Text cache entry timed out ${a.text}`),e.push(a),a.dispose();else{const f=a.getHashCode(!1);s.add(f)}e.forEach(a=>{Lt._TEXT_USAGE.delete(a)}),this._TEXT_CACHE.clear();for(const[a]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(a.getHashCode(),a);const r=new Map;for(const a of s)Lt._MEASURE_CACHE.has(a)&&r.set(a,Lt._MEASURE_CACHE.get(a));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=r}static get cacheSize(){return Lt._TEXT_USAGE.size}static clearCache(){for(const[e]of Lt._TEXT_USAGE.entries())e.dispose();Lt._TEXT_USAGE.clear(),Lt._TEXT_CACHE.clear(),Lt._MEASURE_CACHE.clear()}}Lt.FONT_TIMEOUT=500,Lt._LOGGER=at.getInstance(),Lt._TEXT_USAGE=new Map,Lt._TEXT_CACHE=new Map,Lt._MEASURE_CACHE=new Map;class hn extends se{constructor(e={}){var s,r,a,l,f,p,m,w,b,y,T,D,U,O,q,H,W,J,Y,tt;super(e),this.filtering=_e.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=Z.Black,this.family="sans-serif",this.style=Do.Normal,this.bold=!1,this.unit=To.Px,this.textAlign=Io.Left,this.baseAlign=Ro.Top,this.direction=Fo.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new ht,this._textMeasurement=new Nn(this,"",Z.Black),this.smoothing=(s=e?.smoothing)!==null&&s!==void 0?s:this.smoothing,this.padding=(r=e?.padding)!==null&&r!==void 0?r:this.padding,this.color=(a=e?.color)!==null&&a!==void 0?a:this.color,this.strokeColor=(l=e?.strokeColor)!==null&&l!==void 0?l:this.strokeColor,this.lineDash=(f=e?.lineDash)!==null&&f!==void 0?f:this.lineDash,this.lineWidth=(p=e?.lineWidth)!==null&&p!==void 0?p:this.lineWidth,this.filtering=(m=e?.filtering)!==null&&m!==void 0?m:this.filtering,this.family=(w=e?.family)!==null&&w!==void 0?w:this.family,this.style=(b=e?.style)!==null&&b!==void 0?b:this.style,this.bold=(y=e?.bold)!==null&&y!==void 0?y:this.bold,this.size=(T=e?.size)!==null&&T!==void 0?T:this.size,this.unit=(D=e?.unit)!==null&&D!==void 0?D:this.unit,this.textAlign=(U=e?.textAlign)!==null&&U!==void 0?U:this.textAlign,this.baseAlign=(O=e?.baseAlign)!==null&&O!==void 0?O:this.baseAlign,this.direction=(q=e?.direction)!==null&&q!==void 0?q:this.direction,this.lineHeight=(H=e?.lineHeight)!==null&&H!==void 0?H:this.lineHeight,this.quality=(W=e?.quality)!==null&&W!==void 0?W:this.quality,e?.shadow&&(this.shadow={},this.shadow.blur=(J=e.shadow.blur)!==null&&J!==void 0?J:this.shadow.blur,this.shadow.offset=(Y=e.shadow.offset)!==null&&Y!==void 0?Y:this.shadow.offset,this.shadow.color=(tt=e.shadow.color)!==null&&tt!==void 0?tt:this.shadow.color)}clone(){return new hn({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(e,s,r){}_rotate(e){var s;const r=(s=this.origin)!==null&&s!==void 0?s:this._textBounds.center;e.translate(r.x,r.y),e.rotate(this.rotation),e.translate(-r.x,-r.y)}_flip(e){this.flipHorizontal&&(e.translate(this._textBounds.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,-this._textBounds.height/2/this.scale.y),e.scale(1,-1))}measureTextWithoutCache(e,s){return this._textMeasurement.measureText(e,s)}measureText(e,s){return Lt.measureText(e,this,s)}_postDraw(e){e.restore()}render(e,s,r,a,l,f){const p=Lt.getTextInstance(s,this,r);this._textBounds=p.dimensions,this._preDraw(e,a,l),p.render(e,a,l,f),this._postDraw(e)}}class Cr extends se{constructor(e){var s,r;super(e),this._text="",this._textWidth=0,this._textHeight=0,this.font=(s=e.font)!==null&&s!==void 0?s:new hn,this.color=(r=e.color)!==null&&r!==void 0?r:this.color,this.text=e.text,this.maxWidth=e.maxWidth}clone(){var e,s;return new Cr({text:this.text.slice(),color:(s=(e=this.color)===null||e===void 0?void 0:e.clone())!==null&&s!==void 0?s:Z.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(e){this._text=e,this._calculateDimension()}get font(){return this._font}set font(e){this._font=e}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:e,height:s}=this.font.measureText(this._text,this.maxWidth);this._textWidth=e,this._textHeight=s}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(e){}_flip(e){}_preDraw(e,s,r){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(e,s,r)}_drawImage(e,s,r){var a;let l=Z.Black;this.font instanceof hn&&(l=(a=this.color)!==null&&a!==void 0?a:this.font.color);const{width:f,height:p}=this.font.measureText(this._text,this.maxWidth);this._textWidth=f,this._textHeight=p,this.font.render(e,this._text,l,s,r,this.maxWidth),this.font.showDebug&&(e.debug.drawRect(s-f,r-p,f*2,p*2),this.maxWidth!=null&&e.debug.drawRect(s,r,this.maxWidth,this.height,{color:Z.Yellow}))}}function nh(u){return!!u.tick}class re extends Ti{get visible(){return this.isVisible}set visible(e){this.isVisible=e}get offset(){return this._offset}set offset(e){this._offset=new Vs(e,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(e){this._anchor=new Vs(e,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(e){if(e){this._color=e.clone();const s=this.graphics.current;(s instanceof Wn||s instanceof Cr)&&(s.color=this._color)}}constructor(e){super(),this._logger=at.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new Vs(B.Zero,()=>this.recalculateBounds()),this._anchor=new Vs(B.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,e={visible:this.isVisible,graphics:{},...e};const{current:s,anchor:r,color:a,opacity:l,visible:f,graphics:p,offset:m,copyGraphics:w,onPreDraw:b,onPostDraw:y,onPreTransformDraw:T,onPostTransformDraw:D}=e;for(const[U,O]of Object.entries(p))O instanceof se?this._graphics[U]=O:(this._graphics[U]=O.graphic,this._options[U]=O.options);this.offset=m??this.offset,this.opacity=l??this.opacity,this.anchor=r??this.anchor,this.color=a??this.color,this.copyGraphics=w??this.copyGraphics,this.onPreDraw=b??this.onPreDraw,this.onPostDraw=y??this.onPostDraw,this.onPreDraw=T??this.onPreTransformDraw,this.onPostTransformDraw=D??this.onPostTransformDraw,this.isVisible=!!f,this._current=s??this._current,s&&this._graphics[s]&&this.use(s)}getGraphic(e){return this._graphics[e]}getOptions(e){return this._options[e]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(e,s,r){let a="default",l=null,f;if(typeof e=="string"&&s instanceof se&&(a=e,l=s,f=r),e instanceof se&&!(s instanceof se)&&(l=e,f=s),!l)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[a]=this.copyGraphics?l.clone():l,this._options[a]=this.copyGraphics?{...f}:f,a==="default"&&this.use("default"),l}remove(e){delete this._graphics[e],delete this._options[e],this._current===e&&(this._current="default",this.recalculateBounds())}use(e,s){var r;if(e instanceof se){let a=e;this.copyGraphics&&(a=e.clone()),this._current="default",this._graphics[this._current]=a,this._options[this._current]=s}else this._current=e,this._options[this._current]=s,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(r=this.owner)===null||r===void 0?void 0:r.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(e){this._localBounds=e}recalculateBounds(){let e=new ht;const s=this._graphics[this._current],r=this._options[this._current];if(!s){this._localBounds=e;return}let a=this.anchor,l=this.offset;r?.anchor&&(a=r.anchor),r?.offset&&(l=r.offset);const f=s.localBounds,p=-f.width*a.x+l.x,m=-f.height*a.y+l.y;s instanceof Vn&&!s.useAnchor?e=s?.localBounds.combine(e):e=s?.localBounds.translate(z(p,m)).combine(e),this._localBounds=e}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let e=this.localBounds;if(this.owner){const s=this.owner.get(it);s&&(e=e.transform(s.get().matrix))}return e}update(e,s=0){const r=this.current;r&&nh(r)&&r.tick(e,s)}clone(){const e=new re;return e._graphics={...this._graphics},e._options={...this._options},e.offset=this.offset.clone(),this.color&&(e.color=this.color.clone()),e.opacity=this.opacity,e.anchor=this.anchor.clone(),e.copyGraphics=this.copyGraphics,e.onPreDraw=this.onPreDraw,e.onPostDraw=this.onPostDraw,e.isVisible=this.isVisible,e}}var Mo;(function(u){u.Kill="kill",u.PreKill="prekill",u.PostKill="postkill",u.PreDraw="predraw",u.PostDraw="postdraw",u.PreDebugDraw="predebugdraw",u.PostDebugDraw="postdebugdraw",u.PreUpdate="preupdate",u.PostUpdate="postupdate",u.PreFrame="preframe",u.PostFrame="postframe",u.PreCollision="precollision",u.CollisionStart="collisionstart",u.CollisionEnd="collisionend",u.PostCollision="postcollision",u.Initialize="initialize",u.Activate="activate",u.Deactivate="deactivate",u.ExitViewport="exitviewport",u.EnterViewport="enterviewport",u.ExitTrigger="exit",u.EnterTrigger="enter",u.Connect="connect",u.Disconnect="disconnect",u.Button="button",u.Axis="axis",u.Visible="visible",u.Hidden="hidden",u.Start="start",u.Stop="stop",u.PointerUp="pointerup",u.PointerDown="pointerdown",u.PointerMove="pointermove",u.PointerEnter="pointerenter",u.PointerLeave="pointerleave",u.PointerCancel="pointercancel",u.PointerWheel="pointerwheel",u.Up="up",u.Down="down",u.Move="move",u.Enter="enter",u.Leave="leave",u.Cancel="cancel",u.Wheel="wheel",u.Press="press",u.Release="release",u.Hold="hold",u.PointerDragStart="pointerdragstart",u.PointerDragEnd="pointerdragend",u.PointerDragEnter="pointerdragenter",u.PointerDragLeave="pointerdragleave",u.PointerDragMove="pointerdragmove",u.ActionStart="actionstart",u.ActionComplete="actioncomplete",u.Add="add",u.Remove="remove"})(Mo||(Mo={}));class xt{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(e){this._bubbles=e}stopPropagation(){this.bubbles=!1}}class Bo extends xt{constructor(e){super(),this.self=e,this.target=e}}class rh extends xt{constructor(e){super(),this.self=e,this.target=e}}class oh extends xt{constructor(e){super(),this.self=e,this.target=e}}class ah extends xt{constructor(e){super(),this.self=e,this.target=e}}class hh extends xt{constructor(e){super(),this.self=e,this.target=e}}class Gn extends xt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class Xn extends xt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class lh extends xt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class ch extends xt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class dh extends xt{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class uh extends xt{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class Ws extends xt{constructor(e,s,r){super(),this.engine=e,this.elapsed=s,this.self=r,this.target=r}}class Ns extends xt{constructor(e,s,r){super(),this.engine=e,this.elapsed=s,this.self=r,this.target=r}}class fh extends xt{constructor(e,s){super(),this.engine=e,this.prevStats=s,this.target=e}}class gh extends xt{constructor(e,s){super(),this.engine=e,this.stats=s,this.target=e}}class ph extends xt{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class _h extends xt{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class mh extends xt{constructor(e,s,r,a){super(),this.button=e,this.index=s,this.value=r,this.self=a,this.target=a}}class vh extends xt{constructor(e,s,r){super(),this.axis=e,this.value=s,this.self=r,this.target=r}}class wh extends xt{constructor(e){super(),this.self=e,this.target=e}}class xh extends xt{constructor(e){super(),this.self=e,this.target=e}}class ln extends xt{constructor(e,s,r,a,l){super(),this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l,this.target=e}}class cn extends xt{constructor(e,s,r,a,l){super(),this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l,this.target=e}}class ko{constructor(e,s,r,a){this.self=e,this.other=s,this.side=r,this.contact=a}}class Lo{constructor(e,s,r,a){this.self=e,this.other=s,this.side=r,this.lastContact=a}}class Uo{constructor(e,s,r,a,l){this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l}}class zo{constructor(e,s,r,a,l){this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l}}class Sr extends xt{constructor(e,s,r,a){super(),this.self=e,this.other=s,this.side=r,this.contact=a,this.target=e}}class Pr extends xt{constructor(e,s,r,a){super(),this.self=e,this.other=s,this.side=r,this.lastContact=a,this.target=e}}class qn extends xt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class Ah extends xt{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class bh extends xt{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class yh extends xt{constructor(e){super(),this.self=e,this.target=e}}class Ch extends xt{constructor(e){super(),this.self=e,this.target=e}}class Sh extends xt{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class Ph extends xt{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class Eh extends xt{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class Th extends xt{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class Ih extends xt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class Rh extends xt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class C_{constructor(e){this.data=e,this.type="Component Added"}}function S_(u){return!!u&&u.type==="Component Added"}class P_{constructor(e){this.data=e,this.type="Component Removed"}}function E_(u){return!!u&&u.type==="Component Removed"}const T_={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class Ve{constructor(e,s){this.id=Ve._ID++,this.name=`Entity#${this.id}`,this.events=new I,this._tags=new Set,this.componentAdded$=new Ze,this.componentRemoved$=new Ze,this.tagAdded$=new Ze,this.tagRemoved$=new Ze,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new Ze,this.childrenRemoved$=new Ze,this._children=[],this._isInitialized=!1,this._isAdded=!1;let r,a;if(Array.isArray(e))r=e,a=s;else if(e&&typeof e=="object"){const{components:l,name:f,silenceWarnings:p}=e;r=l??[],a=f}if(a&&(this.name=a),r)for(const l of r)this.addComponent(l)}get active(){return this.isActive}set active(e){this.isActive=e}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new Bo(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(e){return this._tags.has(e)}addTag(e){return this._tags.add(e),this.tagAdded$.notifyAll(e),this}removeTag(e){return this._tags.delete(e),this.tagRemoved$.notifyAll(e),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(e){for(let s=0;s<e.length;s++)if(!this.components.has(e[s]))return!1;return!0}hasAllTags(e){for(let s=0;s<e.length;s++)if(!this.tags.has(e[s]))return!1;return!0}get(e){return this.components.get(e)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(e){if(e.parent===null){if(this.getAncestors().includes(e))throw new Error("Cycle detected, cannot add entity");this._children.push(e),e._parent=this,this.childrenAdded$.notifyAll(e)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(e){return e.parent===this&&(ms(e,this._children),e._parent=null,this.childrenRemoved$.notifyAll(e)),this}removeAllChildren(){for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);return this}getAncestors(){const e=[this];let s=this.parent;for(;s;)e.push(s),s=s.parent;return e.reverse()}getDescendants(){let e=[this],s=[this];for(;s.length>0;){const r=s.pop();r&&(s=s.concat(r.children),e=e.concat(r.children))}return e}clone(){const e=new Ve;for(const s of this.types){const r=this.get(s);r&&e.addComponent(r.clone())}for(const s of this.children)e.addChild(s.clone());return e}addTemplate(e,s=!1){for(const r of e.getComponents())this.addComponent(r.clone(),s);for(const r of e.children)this.addChild(r.clone().addTemplate(r));return this}_getClassHierarchyRoot(e){var s,r;let a=e,l=(s=Object.getPrototypeOf(a.prototype))===null||s===void 0?void 0:s.constructor;for(;l&&l!==Object&&l!==Ti;)a=l,l=(r=Object.getPrototypeOf(a.prototype))===null||r===void 0?void 0:r.constructor;return a}addComponent(e,s=!1){if(this.has(e.constructor))if(s)this.removeComponent(e.constructor,!0);else return this;if(e.dependencies&&e.dependencies.length)for(const a of e.dependencies)this.addComponent(new a);e.owner=this;const r=this._getClassHierarchyRoot(e.constructor);return this.components.set(r,e),this.components.set(e.constructor,e),this.componentValues.push(e),e.onAdd&&e.onAdd(this),this.componentAdded$.notifyAll(e),this}removeComponent(e,s=!1){let r;if(bd(e)?r=e:r=e.constructor,s){const a=this.components.get(r);if(a){this.componentRemoved$.notifyAll(a),a.owner=void 0,a.onRemove&&a.onRemove(this);const f=this.componentValues.indexOf(a);f>-1&&this.componentValues.splice(f,1)}const l=this._getClassHierarchyRoot(r);this.components.delete(l),this.components.delete(r)}else this._componentsToRemove.push(r);return this}clearComponents(){const e=this.types;for(const s of e)this.removeComponent(s)}processComponentRemoval(){for(const e of this._componentsToRemove)this.removeComponent(e,!0);this._componentsToRemove.length=0}has(e){return this.components.has(e)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(e){this.isInitialized||(this.onInitialize(e),this.events.emit("initialize",new qn(e,this)),this._isInitialized=!0)}_add(e){!this.isAdded&&this.isActive&&(this.onAdd(e),this.events.emit("add",new Ih(e,this)),this._isAdded=!0)}_remove(e){this.isAdded&&!this.isActive&&(this.onRemove(e),this.events.emit("remove",new Rh(e,this)),this._isAdded=!1)}_preupdate(e,s){this.events.emit("preupdate",new Ws(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new Ns(e,s,this)),this.onPostUpdate(e,s)}onInitialize(e){}onAdd(e){}onRemove(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s);for(const r of this.children)r.update(e,s);this._postupdate(e,s),this._remove(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}Ve._ID=0;class Bt extends Ti{constructor(){super(...arguments),this.vel=B.Zero,this.acc=B.Zero,this.scaleFactor=B.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class Je{static integrate(e,s,r,a){const l=a/1e3;s.vel.addEqual(r.scale(l,Je._ACC)),e.pos.add(s.vel.scale(l,Je._VEL),Je._POS).addEqual(r.scale(.5*l*l,Je._VEL_ACC)),s.angularVelocity+=s.torque*(1/s.inertia)*l;const f=e.rotation+s.angularVelocity*l;e.scale.add(s.scaleFactor.scale(l,this._SCALE_FACTOR),Je._SCALE),e.get().setTransform(Je._POS,f,Je._SCALE)}}Je._POS=new B(0,0),Je._SCALE=new B(1,1),Je._ACC=new B(0,0),Je._VEL=new B(0,0),Je._VEL_ACC=new B(0,0),Je._SCALE_FACTOR=new B(0,0);class Ho extends Ve{constructor(e){super({silenceWarnings:!0}),this.beginColor=Z.White,this.endColor=Z.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=Z.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=zi.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new it),this.addComponent(this.motion=new Bt),this.addComponent(this.graphics=new re),this.configure(e)}registerEmitter(e){if(this._emitter=e,this.particleTransform===zi.Global){const s=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(s),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(e){var s,r,a,l,f,p,m,w,b,y,T,D,U,O;this.particleTransform=(s=e.transform)!==null&&s!==void 0?s:this.particleTransform,this.life=(r=e.life)!==null&&r!==void 0?r:this.life,this.fade=(a=e.fade)!==null&&a!==void 0?a:this.fade,this.size=(l=e.size)!==null&&l!==void 0?l:this.size,this.endColor=(f=e.endColor)!==null&&f!==void 0?f:this.endColor.clone(),this.beginColor=(p=e.beginColor)!==null&&p!==void 0?p:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=e.graphic,this.graphics.opacity=(m=e.opacity)!==null&&m!==void 0?m:this.graphics.opacity,this.transform.pos=(w=e.pos)!==null&&w!==void 0?w:this.transform.pos,this.transform.rotation=(b=e.rotation)!==null&&b!==void 0?b:0,this.transform.scale=z(1,1),this.motion.vel=(y=e.vel)!==null&&y!==void 0?y:this.motion.vel,this.motion.angularVelocity=(T=e.angularVelocity)!==null&&T!==void 0?T:0,this.motion.acc=(D=e.acc)!==null&&D!==void 0?D:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(U=e.startSize)!==null&&U!==void 0?U:0,this.endSize=(O=e.endSize)!==null&&O!==void 0?O:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=ht.fromDimension(this.size,this.size,B.Half),this.graphics.onPostDraw=q=>{q.save(),q.debug.drawPoint(z(0,0),{color:this._currentColor,size:this.size}),q.restore()})}kill(){var e;!((e=this._emitter)===null||e===void 0)&&e.isActive?this._emitter.removeParticle(this):super.kill()}update(e,s){this.life=this.life-s,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=j(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=j(this.sizeRate*s+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=j(this._currentColor.r+this._rRate*s,0,255),this._currentColor.g=j(this._currentColor.g+this._gRate*s,0,255),this._currentColor.b=j(this._currentColor.b+this._bRate*s,0,255),this._currentColor.a=this.graphics.opacity;let r=this.motion.acc;this.focus&&(r=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(s/1e3)),Je.integrate(this.transform,this.motion,r,s)}}Ho.DefaultConfig={beginColor:Z.White,endColor:Z.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var zi;(function(u){u.Global="global",u.Local="local"})(zi||(zi={}));class yd{constructor(){this.type="ex.particle",this.priority=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new ni({gl:e,vertexSource:m_,fragmentSource:v_,onPreLink:r=>{e.transformFeedbackVaryings(r,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],e.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(e){const s=e.getAttribute(Ft.Filtering),r=s?On(s):void 0,a=ki(e.getAttribute(Ft.WrappingX)),l=ki(e.getAttribute(Ft.WrappingY)),f=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);return e.removeAttribute("forceUpload"),p}draw(e,s){var r,a,l,f,p,m,w,b,y;const T=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const D=e.particle.transform===zi.Local?this._context.getTransform():this._context.getTransform().multiply(e.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",D),this._shader.setUniformBoolean("fade",!!e.particle.fade),this._shader.setUniformBoolean("useTexture",!!e.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(r=e.particle.life)!==null&&r!==void 0?r:2e3),this._shader.setUniformFloat("deltaMs",s),this._shader.setUniformFloatVector("gravity",(a=e.particle.acc)!==null&&a!==void 0?a:z(0,0)),this._shader.setUniformFloatColor("beginColor",(l=e.particle.beginColor)!==null&&l!==void 0?l:Z.Transparent),this._shader.setUniformFloatColor("endColor",(f=e.particle.endColor)!==null&&f!==void 0?f:Z.Transparent);let U=(p=e.particle.startSize)!==null&&p!==void 0?p:0,O=(m=e.particle.endSize)!==null&&m!==void 0?m:0;const q=(w=e.particle.size)!==null&&w!==void 0?w:0;if(q>0&&(U=q,O=q),this._shader.setUniformFloat("startSize",U??10),this._shader.setUniformFloat("endSize",O??10),this._shader.setUniformFloat("startOpacity",(b=e.particle.opacity)!==null&&b!==void 0?b:1),e.particle.focus&&(this._shader.setUniformFloatVector("focus",e.particle.focus),this._shader.setUniformFloat("focusAccel",(y=e.particle.focusAccel)!==null&&y!==void 0?y:0)),e.particle.graphic){const H=e.particle.graphic,W=this._getTexture(H.image.image);T.activeTexture(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,W),this._shader.setUniformInt("graphic",0)}e.draw(T)}hasPendingDraws(){return!1}flush(){}dispose(){}}const I_=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,R_=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class D_{constructor(e){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=Z.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=th(e,r);this._maxTextures=Math.min(r,a);const l=this._transformFragmentSource(I_,this._maxTextures);this._shader=new ni({gl:e,fragmentSource:l,vertexSource:R_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((y,T)=>T)),this._vao=e.createVertexArray(),e.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._meshBuffer),e.bufferData(e.ARRAY_BUFFER,this._quadMesh,e.STATIC_DRAW),e.vertexAttribPointer(0,2,e.FLOAT,!1,16,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,16,8),e.enableVertexAttribArray(1),e.bindBuffer(e.ARRAY_BUFFER,null);const f=this._components;this._transformData=new Qi({gl:e,size:f*this._maxImages,type:"dynamic"}),this._transformData.bind();let p=0,m=2;const w=4,b=f*4;e.vertexAttribPointer(m++,2,e.FLOAT,!1,b,p),e.enableVertexAttribArray(2),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,b,p),e.enableVertexAttribArray(3),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,b,p),e.enableVertexAttribArray(4),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,b,p),e.enableVertexAttribArray(5),p+=2*w,e.vertexAttribPointer(m++,1,e.FLOAT,!1,b,p),e.enableVertexAttribArray(6),p+=1*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,b,p),e.enableVertexAttribArray(7),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,b,p),e.enableVertexAttribArray(8),p+=2*w,e.vertexAttribPointer(m++,1,e.FLOAT,!1,b,p),e.enableVertexAttribArray(9),p+=1*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,b,p),e.enableVertexAttribArray(10),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,b,p),e.enableVertexAttribArray(11),p+=2*w,e.vertexAttribPointer(m++,4,e.FLOAT,!1,b,p),e.enableVertexAttribArray(12),p+=4*w,e.vertexAttribDivisor(2,1),e.vertexAttribDivisor(3,1),e.vertexAttribDivisor(4,1),e.vertexAttribDivisor(5,1),e.vertexAttribDivisor(6,1),e.vertexAttribDivisor(7,1),e.vertexAttribDivisor(8,1),e.vertexAttribDivisor(9,1),e.vertexAttribDivisor(10,1),e.vertexAttribDivisor(11,1),e.vertexAttribDivisor(12,1),e.bindVertexArray(null)}_bindData(e){const s=this._components;this._transformData.bind(),this._transformData.upload(s*this._imageCount),e.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let r=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_texture_index <= ${l}.5) {
`:a+=`   else if (v_texture_index <= ${l}.5) {
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return r=r.replace("%%texture_picker%%",a),r}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(Ft.Filtering),r=s?On(s):void 0,a=ki(e.getAttribute(Ft.WrappingX)),l=ki(e.getAttribute(Ft.WrappingY)),f=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&(this._textures.push(p),this._textureToIndex.set(p,this._textureIndex++),this._images.add(e))}_bindTextures(e){const s=Math.min(this._textureIndex,this._maxTextures);for(let r=0;r<s;r++)e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,this._textures[r]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const r=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(r))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,r,a,l,f,p,m,w){var b,y,T,D;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const U=this._getImageWidth(e),O=this._getImageHeight(e);let q=U||a||0,H=O||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(b=a??U)!==null&&b!==void 0?b:0,this._view[3]=(y=l??O)!==null&&y!==void 0?y:0,this._dest[0]=s??1,this._dest[1]=r??1,f!==void 0&&p!==void 0&&m!==void 0&&w!==void 0&&(this._view[0]=s??1,this._view[1]=r??1,this._view[2]=(T=a??U)!==null&&T!==void 0?T:0,this._view[3]=(D=l??O)!==null&&D!==void 0?D:0,this._dest[0]=f,this._dest[1]=p,q=m,H=w),s=this._view[0],r=this._view[1];const W=this._view[2],J=this._view[3],Y=this._context.getTransform(),tt=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+mt),this._dest[1]=~~(this._dest[1]+mt));const Q=this._context.tint||this._defaultTint,_t=this._getTextureIdForImage(e),It=U||q,Yt=O||H,Zt=(s+this.uvPadding)/It,Te=(r+this.uvPadding)/Yt,te=(s+W-this.uvPadding)/It,zt=(r+J-this.uvPadding)/Yt,Ge=U,ke=O,st=this._transformData.bufferData;st[this._vertexIndex++]=this._dest[0],st[this._vertexIndex++]=this._dest[1],st[this._vertexIndex++]=Y.data[0],st[this._vertexIndex++]=Y.data[1],st[this._vertexIndex++]=Y.data[2],st[this._vertexIndex++]=Y.data[3],st[this._vertexIndex++]=Y.data[4],st[this._vertexIndex++]=Y.data[5],st[this._vertexIndex++]=tt,st[this._vertexIndex++]=q,st[this._vertexIndex++]=H,st[this._vertexIndex++]=Ge,st[this._vertexIndex++]=ke,st[this._vertexIndex++]=_t,st[this._vertexIndex++]=Zt,st[this._vertexIndex++]=Te,st[this._vertexIndex++]=te,st[this._vertexIndex++]=zt,st[this._vertexIndex++]=Q.r/255,st[this._vertexIndex++]=Q.g/255,st[this._vertexIndex++]=Q.b/255,st[this._vertexIndex++]=Q.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._bindData(e),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),e.drawArraysInstanced(e.TRIANGLES,0,6,this._imageCount),Qt.DrawnImagesCount+=this._imageCount,Qt.DrawCallCount++,e.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const mt=1e-4;class F_{constructor(e){this._webglCtx=e,this._debugText=new Ka}drawRect(e,s,r,a,l={color:Z.Black}){this.drawLine(z(e,s),z(e+r,s),{...l}),this.drawLine(z(e+r,s),z(e+r,s+a),{...l}),this.drawLine(z(e+r,s+a),z(e,s+a),{...l}),this.drawLine(z(e,s+a),z(e,s),{...l})}drawLine(e,s,r){var a;this._webglCtx.draw("ex.line",e,s,(a=r?.color)!==null&&a!==void 0?a:Z.Black)}drawPoint(e,s={color:Z.Black,size:5}){this._webglCtx.draw("ex.point",e,s.color,s.size)}drawText(e,s){this._debugText.write(this._webglCtx,e,s)}}class xs{get z(){return this._state.current.z}set z(e){this._state.current.z=e}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(e){let s=!0;return(e.width>4096||e.height>4096)&&(s=!1),s}constructor(e){this._logger=at.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=A.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new Eo(()=>new p_,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new Xp,this._state=new gd,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=Z.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new F_(this),this._totalPostProcessorTime=0;const{canvasElement:s,context:r,enableTransparency:a,antialiasing:l,uvPadding:f,multiSampleAntialiasing:p,pixelArtSampler:m,powerPreference:w,snapToPixel:b,backgroundColor:y,useDrawSorting:T,garbageCollector:D,handleContextLost:U,handleContextRestored:O}=e;if(this.__gl=r??s.getContext("webgl2",{antialias:l??this.smoothing,premultipliedAlpha:!1,alpha:a??this.transparency,depth:!1,powerPreference:w??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");U&&this.__gl.canvas.addEventListener("webglcontextlost",U,!1),O&&this.__gl.canvas.addEventListener("webglcontextrestored",O,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new ne(this.__gl,D),this.snapToPixel=b??this.snapToPixel,this.smoothing=l??this.smoothing,this.transparency=a??this.transparency,this.pixelArtSampler=m??this.pixelArtSampler,this.uvPadding=f??this.uvPadding,this.multiSampleAntialiasing=typeof p=="boolean"?p:this.multiSampleAntialiasing,this.samples=typeof p=="object"?p.samples:void 0,this.backgroundColor=y??this.backgroundColor,this.useDrawSorting=T??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const e of this._renderers.values())e.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const e=this.__gl;if(this._ortho=pi.ortho(0,e.canvas.width,e.canvas.height,0,400,-400),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.depthMask(!1),this.register(new h_({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new Ad),this.register(new d_),this.register(new g_),this.register(new i_),this.register(new $p),this.lazyRegister("ex.particle",()=>new yd),this.register(new D_({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=e.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");e.bindTexture(e.TEXTURE_2D,this.materialScreenTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.bindTexture(e.TEXTURE_2D,null),this._screenRenderer=new r_(e),this._renderTarget=new Po({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),this._postProcessTargets=[new Po({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),new Po({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height})],this._msaaTarget=new Po({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(e){this._renderers.set(e.type,e),e.initialize(this.__gl,this)}lazyRegister(e,s){this._lazyRenderersFactory.set(e,s)}get(e){let s=this._renderers.get(e);if(!s){const r=this._lazyRenderersFactory.get(e);r&&(this._logger.debug("lazy init renderer:",e),s=r(),this.register(s))}return s}_isCurrentRenderer(e){return!this._currentRenderer||this._currentRenderer===e}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(e,...s){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${e}, the webgl context is lost`);return}const r=this.get(e);if(r)if(this.useDrawSorting){const a=this._drawCallPool.get();a.z=this._state.current.z,a.priority=r.priority,a.renderer=e,this.getTransform().clone(a.transform),a.state.z=this._state.current.z,a.state.opacity=this._state.current.opacity,a.state.tint=this._state.current.tint,a.state.material=this._state.current.material,a.args[0]=s[0],a.args[1]=s[1],a.args[2]=s[2],a.args[3]=s[3],a.args[4]=s[4],a.args[5]=s[5],a.args[6]=s[6],a.args[7]=s[7],a.args[8]=s[8],a.args[9]=s[9],this._drawCalls[this._drawCallIndex++]=a}else this._currentRenderer||(this._currentRenderer=r),this._isCurrentRenderer(r)||this._currentRenderer.flush(),r.draw(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9]),this._currentRenderer=r;else throw Error(`No renderer with name ${e} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(e){const s=this.__gl;this._ortho=this._ortho=pi.ortho(0,e.width,e.height,0,400,-400),this._renderTarget.setResolution(s.canvas.width,s.canvas.height),this._msaaTarget.setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[0].setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[1].setResolution(s.canvas.width,s.canvas.height)}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}drawImage(e,s,r,a,l,f,p,m,w){if(!(a===0||l===0)){{if(m===0||w===0)return;if(this._getImageWidth(e)===0||this._getImageHeight(e)===0)return}if(!e){at.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",e,s,r,a,l,f,p,m,w):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,e,s,r,a,l,f,p,m,w):this.draw(this.imageRenderer,e,s,r,a,l,f,p,m,w)}}drawLine(e,s,r,a=1){this.draw("ex.rectangle",e,s,r,a)}drawRectangle(e,s,r,a,l,f){this.draw("ex.rectangle",e,s,r,a,l,f)}drawCircle(e,s,r,a,l){this.draw("ex.circle",e,s,r,a,l)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(e,s){this._transform.translate(this.snapToPixel?~~(e+mt):e,this.snapToPixel?~~(s+mt):s)}rotate(e){this._transform.rotate(e)}scale(e,s){this._transform.scale(e,s)}transform(e){this._transform.current=e}getTransform(){return this._transform.current}multiply(e){this._transform.current.multiply(e,this._transform.current)}addPostProcessor(e){this._postprocessors.push(e),e.initialize(this.__gl)}removePostProcessor(e){const s=this._postprocessors.indexOf(e);s!==-1&&this._postprocessors.splice(s,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(e){for(const s of this._postprocessors){const r=s.getShader();r.use();const a=r.getUniforms();this._totalPostProcessorTime+=e,a.find(l=>l.name==="u_time_ms")&&r.setUniformFloat("u_time_ms",this._totalPostProcessorTime),a.find(l=>l.name==="u_elapsed_ms")&&r.setUniformFloat("u_elapsed_ms",e),a.find(l=>l.name==="u_resolution")&&r.setUniformFloatVector("u_resolution",z(this.width,this.height)),s.onUpdate&&s.onUpdate(e)}}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return new xd({...e,graphicsContext:this})}createShader(e){const s=this.__gl,{vertexSource:r,fragmentSource:a}=e,l=new ni({gl:s,vertexSource:r,fragmentSource:a});return l.compile(),l}clear(){const e=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT)}flush(){var e;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let s=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(s.use(),this.useDrawSorting){for(let f=this._drawCallIndex;f<this._drawCalls.length;f++)this._drawCalls[f]=null;const r=new Map;for(const[f]of this._renderers){let p=0;for(p=0;p<this._drawCallIndex&&this._drawCalls[p].renderer!==f;p++);r.set(f,p)}this._drawCalls.sort((f,p)=>{if(f===null||p===null)return 0;const m=f.z-p.z,w=r.get(f.renderer)-r.get(p.renderer),b=f.priority-p.priority;return m===0?b===0?w:b:m});const a=this._transform.current,l=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let f=this._drawCalls[0].renderer,p=this.get(f);for(let m=0;m<this._drawCallIndex;m++)this._transform.current=this._drawCalls[m].transform,this._state.current=this._drawCalls[m].state,this._drawCalls[m].renderer!==f&&(p.flush(),f=this._drawCalls[m].renderer,p=this.get(f)),p instanceof Ad&&(!((e=this.material)===null||e===void 0)&&e.isUsingScreenTexture)&&(s.copyToTexture(this.materialScreenTexture),s.use()),p.draw(...this._drawCalls[m].args);p.hasPendingDraws()&&p.flush()}this._transform.current=a,this._state.current=l,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const r of this._renderers.values())r.hasPendingDraws()&&r.flush();s.disable(),this._postprocessors.length>0&&s.toRenderSource().use();for(let r=0;r<this._postprocessors.length;r++)s=this._postProcessTargets[r%2],this._postProcessTargets[r%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[r]),this._postProcessTargets[r%2].toRenderSource().use();s.blitToScreen()}}const de=1e-4;class M_{constructor(e){this._ex=e,this._debugText=new Ka}drawRect(e,s,r,a){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(e+de):e,this._ex.snapToPixel?~~(s+de):s,this._ex.snapToPixel?~~(r+de):r,this._ex.snapToPixel?~~(a+de):a),this._ex.__ctx.restore()}drawLine(e,s,r={color:Z.Black}){var a,l;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(l=(a=r.color)===null||a===void 0?void 0:a.toString())!==null&&l!==void 0?l:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(e.x+de):e.x,this._ex.snapToPixel?~~(e.y+de):e.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(s.x+de):s.x,this._ex.snapToPixel?~~(s.y+de):s.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(e,s={color:Z.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=s.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(e.x+de):e.x,this._ex.snapToPixel?~~(e.y+de):e.y,s.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(e,s){this._debugText.write(this._ex,e,s)}}class Oo{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(e){this.__ctx.imageSmoothingEnabled=e}constructor(e){this.useDrawSorting=!1,this.z=0,this.backgroundColor=Z.ExcaliburBlue,this._state=new gd,this.snapToPixel=!1,this.debug=new M_(this);const{canvasElement:s,context:r,enableTransparency:a,snapToPixel:l,antialiasing:f,backgroundColor:p}=e;if(this.__ctx=r??s.getContext("2d",{alpha:a??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=p??this.backgroundColor,this.snapToPixel=l??this.snapToPixel,this.smoothing=f??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(e){}drawImage(e,s,r,a,l,f,p,m,w){if(a===0||l===0)return;if(m===0||w===0)return;if(e.width===0||e.height===0)return;this.__ctx.globalAlpha=this.opacity;const b=[e,s,r,a,l,f,p,m,w].filter(y=>y!==void 0).map(y=>typeof y=="number"&&this.snapToPixel?~~y:y);this.__ctx.drawImage.apply(this.__ctx,b),Qt.DrawCallCount++,Qt.DrawnImagesCount=1}drawLine(e,s,r,a=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=r.toString(),this.__ctx.moveTo(this.snapToPixel?~~(e.x+de):e.x,this.snapToPixel?~~(e.y+de):e.y),this.__ctx.lineTo(this.snapToPixel?~~(s.x+de):s.x,this.snapToPixel?~~(s.y+de):s.y),this.__ctx.lineWidth=a,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(e,s,r,a){this.__ctx.save(),this.__ctx.fillStyle=a.toString(),this.__ctx.fillRect(this.snapToPixel?~~(e.x+de):e.x,this.snapToPixel?~~(e.y+de):e.y,this.snapToPixel?~~(s+de):s,this.snapToPixel?~~(r+de):r),this.__ctx.restore()}drawCircle(e,s,r,a,l){this.__ctx.save(),this.__ctx.beginPath(),a&&(this.__ctx.strokeStyle=a.toString()),l&&(this.__ctx.lineWidth=l),this.__ctx.fillStyle=r.toString(),this.__ctx.arc(this.snapToPixel?~~(e.x+de):e.x,this.snapToPixel?~~(e.y+de):e.y,s,0,Math.PI*2),this.__ctx.fill(),a&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(e,s){this.__ctx.translate(this.snapToPixel?~~(e+de):e,this.snapToPixel?~~(s+de):s)}rotate(e){this.__ctx.rotate(e)}scale(e,s){this.__ctx.scale(e,s)}getTransform(){throw new Error("Not implemented")}multiply(e){this.__ctx.setTransform(this.__ctx.getTransform().multiply(e.toDOMMatrix()))}addPostProcessor(e){}removePostProcessor(e){}clearPostProcessors(){}updatePostProcessors(e){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),Qt.clear()}flush(){}dispose(){this.__ctx=void 0}}var Se;(function(u){u.Fixed="Fixed",u.FitContainerAndFill="FitContainerAndFill",u.FitScreenAndFill="FitScreenAndFill",u.FitContainerAndZoom="FitContainerAndZoom",u.FitScreenAndZoom="FitScreenAndZoom",u.FitScreen="FitScreen",u.FillScreen="FillScreen",u.FitContainer="FitContainer",u.FillContainer="FillContainer"})(Se||(Se={}));class Dh{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const B_={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class Fh{constructor(e){var s,r,a,l;this.events=new I,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=at.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const f=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(f),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new ht,this._unsafeArea=new ht,this.viewport=e.viewport,this.resolution=(s=e.resolution)!==null&&s!==void 0?s:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(r=e.displayMode)!==null&&r!==void 0?r:Se.Fixed,this._canvas=e.canvas,this.graphicsContext=e.context,this._antialiasing=(a=e.antialiasing)!==null&&a!==void 0?a:this._antialiasing,this._canvasImageRendering=(l=e.canvasImageRendering)!==null&&l!==void 0?l:this._canvasImageRendering,this._browser=e.browser,this._pixelRatioOverride=e.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const e=this.worldToPageCoordinates(B.Zero);return this.worldToPageCoordinates(z(1,0)).sub(e).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(e){this._pixelRatioOverride=e}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case Se.FillContainer:case Se.FitContainer:case Se.FitContainerAndFill:case Se.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(e){this._resolution=e}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(e){this._viewport=e}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(e){this._camera=e}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof xs&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let a=Math.max(1,this.pixelRatio-.5),l=!1;for(;a>1&&!l;){a=Math.max(1,a-.5);const f=this._resolution.width*a,p=this._resolution.height*a;l=this.graphicsContext.checkIfResolutionSupported({width:f,height:p})}this.pixelRatioOverride=a,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const e=this.viewport.widthUnit==="percent"?"%":"px",s=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+e,this._canvas.style.height=this.viewport.height+s,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof Oo&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(e){this._antialiasing=e,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(e){return this.enterFullscreen(e)}enterFullscreen(e){var s,r,a,l,f,p;if(e){const m=document.getElementById(e);if(m?.requestFullscreen||m?.webkitRequestFullscreen){if(m.getAttribute("ex-fullscreen-listener")||(m.setAttribute("ex-fullscreen-listener","true"),m.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),m.requestFullscreen)return(s=m.requestFullscreen())!==null&&s!==void 0?s:Promise.resolve();if(m.webkitRequestFullscreen)return(r=m.webkitRequestFullscreen())!==null&&r!==void 0?r:Promise.resolve()}}return!((a=this._canvas)===null||a===void 0)&&a.requestFullscreen?(f=(l=this._canvas)===null||l===void 0?void 0:l.requestFullscreen())!==null&&f!==void 0?f:Promise.resolve():this._canvas.webkitRequestFullscreen?(p=this._canvas.webkitRequestFullscreen())!==null&&p!==void 0?p:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(e){return{width:e.widthUnit==="percent"?this.canvas.offsetWidth:e.width,height:e.heightUnit==="percent"?this.canvas.offsetHeight:e.height}}pageToScreenCoordinates(e){let s=e.x,r=e.y;this._isFullscreen||(s-=Os(this._canvas).x,r-=Os(this._canvas).y);const a=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,f=(window.innerHeight-l)/2;r=(r-f)/l*a.height,s=s/window.innerWidth*a.width}else{const l=window.innerHeight*this.aspectRatio,f=(window.innerWidth-l)/2;s=(s-f)/l*a.width,r=r/window.innerHeight*a.height}return s=s/a.width*this.resolution.width,r=r/a.height*this.resolution.height,s=s-this.contentArea.left,r=r-this.contentArea.top,new B(s,r)}screenToPageCoordinates(e){let s=e.x,r=e.y;const a=this._viewportToPixels(this.viewport);if(s=s/this.resolution.width*a.width,r=r/this.resolution.height*a.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,f=(window.innerHeight-l)/2;r=r/a.height*l+f,s=s/a.width*window.innerWidth}else{const l=window.innerHeight*this.aspectRatio,f=(window.innerWidth-l)/2;s=s/a.width*l+f,r=r/a.height*window.innerHeight}return this._isFullscreen||(s+=Os(this._canvas).x,r+=Os(this._canvas).y),new B(s,r)}screenToWorldCoordinates(e){return e=e.add(z(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(e):e.sub(z(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(e){return this._camera?this._camera.transform.multiply(e):e.add(z(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(e){const s=this.pageToScreenCoordinates(e);return this.screenToWorldCoordinates(s)}worldToPageCoordinates(e){const s=this.worldToScreenCoordinates(e);return this.screenToPageCoordinates(s)}getWorldBounds(){return ht.fromDimension(this.resolution.width,this.resolution.height,B.Half).scale(z(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero,B.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return z(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=this.aspectRatio;let s=0,r=0;window.innerWidth/e<window.innerHeight?(s=window.innerWidth,r=window.innerWidth/e):(s=window.innerHeight*e,r=window.innerHeight),this.viewport={width:s,height:r},this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this._unsafeArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndFill(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(e,s,r){if(this.viewport=r??{width:e,height:s},e/s<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:e*this._contentResolution.width/e,height:e*this._contentResolution.width/e*s/e};const a=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new ht({top:a,left:0,right:this._contentResolution.width,bottom:this.resolution.height-a}),this._unsafeArea=new ht({top:-a,left:0,right:this._contentResolution.width,bottom:this.resolution.height+a})}else{this.resolution={width:s*this._contentResolution.height/s*e/s,height:s*this._contentResolution.height/s};const a=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new ht({top:0,left:a,right:this.resolution.width-a,bottom:this._contentResolution.height}),this._unsafeArea=new ht({top:0,left:-a,right:this.resolution.width+a,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndZoom(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const e=this.canvas.parentElement;e.style.overflow="hidden";const{offsetWidth:s,offsetHeight:r}=this.canvas;this._computeFitAndZoom(s,r),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(e,s){const r=this.aspectRatio;let a=0,l=0;e/r<s?(a=e,l=e/r):(a=s*r,l=s);const f=e/a,p=s/l,m=Math.max(f,p),w=a*m,b=l*m;w>e?this.canvas.style.left=-(w-e)/2+"px":this.canvas.style.left="",b>s?this.canvas.style.top=-(b-s)/2+"px":this.canvas.style.top="",this.viewport={width:w,height:b};const y=ht.fromDimension(this.viewport.width,this.viewport.height,B.Zero);if(this.viewport.width>e){const T=(this.viewport.width-e)/this.viewport.width*this.resolution.width;y.top=0,y.left=T/2,y.right=this.resolution.width-T/2,y.bottom=this.resolution.height}if(this.viewport.height>s){const T=(this.viewport.height-s)/this.viewport.height*this.resolution.height;y.top=T/2,y.left=0,y.bottom=this.resolution.height-T/2,y.right=this.resolution.width}this._contentArea=y}_computeFitContainer(){const e=this.aspectRatio;let s=0,r=0,a="pixel",l="pixel";const f=this.canvas.parentElement;f.clientWidth/e<f.clientHeight?(this.canvas.style.width="100%",s=100,a="percent",r=this.canvas.offsetWidth/e):(this.canvas.style.height="100%",r=100,l="percent",s=this.canvas.offsetHeight*e),this.viewport={width:s,widthUnit:a,height:r,heightUnit:l},this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(e){this.displayMode===Se.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===Se.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:e.innerWidth,height:e.innerHeight},this.viewport=this.resolution),this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.displayMode===Se.FitScreen&&this._computeFit(),this.displayMode===Se.FitContainer&&this._computeFitContainer(),this.displayMode===Se.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===Se.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===Se.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===Se.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class Er{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function k_(u){return!!u.playbackState}class dn{static unlock(){return new Promise((s,r)=>{if(dn._UNLOCKED||!Er.create())return s(!0);const a=setTimeout(()=>{at.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),s(!1)},200),l=Er.create();l.resume().then(()=>{const f=l.createBuffer(1,1,22050),p=l.createBufferSource();let m=!1;p.buffer=f,p.connect(l.destination),p.onended=()=>m=!0,p.start(0),setTimeout(()=>{k_(p)?(p.playbackState===p.PLAYING_STATE||p.playbackState===p.FINISHED_STATE)&&(dn._UNLOCKED=!0):(l.currentTime>0||m)&&(dn._UNLOCKED=!0)},0),clearTimeout(a),s(!0)},()=>{r()})})}static isUnlocked(){return this._UNLOCKED}}dn._UNLOCKED=!1;class Vo extends Wn{get ctx(){return this._ctx}constructor(e={}){super(e),this._options=e}clone(){return new Vo({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){var s,r;!((s=this._options)===null||s===void 0)&&s.draw&&((r=this._options)===null||r===void 0||r.draw(e)),this._options.cache||this.flagDirty()}}class Mh{}Mh.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class Wo{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(e){this._currentState=e}static create(e,s){const r=new Wo;r.data=s;for(const a in e.states)r.states.set(a,{name:a,...e.states[a]});for(const a of r.states.values())for(const l of a.transitions)if(l!=="*"&&!r.states.has(l))throw Error(`Invalid state machine, state [${a.name}] has a transition to another state that doesn't exist [${l}]`);return r.currentState=r.startState=r.states.get(e.start),r}in(e){return this.currentState.name===e}go(e,s){var r,a;if(this.currentState.transitions.includes(e)||this.currentState.transitions.includes("*")){const l=this.states.get(e);return this.currentState.onExit&&((r=this.currentState)===null||r===void 0?void 0:r.onExit({to:l.name,data:this.data}))===!1||l?.onEnter&&l?.onEnter({from:this.currentState.name,eventData:s,data:this.data})===!1?!1:(this.currentState=l,!((a=this.currentState)===null||a===void 0)&&a.onState&&this.currentState.onState(),!0)}return!1}update(e){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,e)}save(e){localStorage.setItem(e,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(e){const s=JSON.parse(localStorage.getItem(e));this.currentState=this.states.get(s.currentState),this.data=s.data}}class Cd{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(e){this._loop=e,this._instance&&(this._instance.loop=e,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(e){e=j(e,0,1),this._volume=e,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(e,this._audioContext.currentTime,.1):this._volumeNode.gain.value=e}get volume(){return this._volume}get duration(){var e;return(e=this._duration)!==null&&e!==void 0?e:this.getTotalPlaybackDuration()}set duration(e){this._duration=e}constructor(e){this._src=e,this._audioContext=Er.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new P,this._stateMachine=Wo.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:s})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,s.pausedAt*this._playbackRate):this._instance.start(0,s.pausedAt*this._playbackRate,this.duration),s.startedAt=this._audioContext.currentTime-s.pausedAt,s.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:s})=>{s==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:s,data:r})=>{r.pausedAt=(s??0)/this._playbackRate,r.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:s})=>{s.pausedAt=0,s.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:s})=>{s.pausedAt=this._audioContext.currentTime-s.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(e=()=>{}){return this._playStarted=e,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(e){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",e)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:e,startedAt:s}=this._stateMachine.data;return e?e*this._playbackRate:s?(this._audioContext.currentTime-s)*this._playbackRate:0}set playbackRate(e){this._instance.playbackRate.value=this._playbackRate=e}get playbackRate(){return this._instance.playbackRate.value}}class Bh extends xt{set bubbles(e){}get bubbles(){return!1}get _path(){return null}set _path(e){}constructor(e,s="MediaEvent"){super(),this.target=e,this._name=s}stopPropagation(){}action(){}propagate(){}layPath(e){}}class un extends Bh{constructor(e,s){super(e,"NativeSoundEvent"),this.track=s}}class Sd extends Bh{constructor(e,s){super(e,"NativeSoundProcessedEvent"),this._processedData=s,this.data=this._processedData}}function L_(u){try{const e=new Audio,s=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,r=u.match(s)[1];return!!e.canPlayType("audio/"+r)}catch(e){return at.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",e),!1}}const U_={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class Pd{set loop(e){this._loop=e;for(const s of this._tracks)s.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(e){this._volume=e;for(const s of this._tracks)s.volume=this._volume;this.events.emit("volumechange",new un(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(e){this._duration=e}get instances(){return this._tracks}get path(){return this._resource.path}set path(e){this._resource.path=e}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}constructor(...e){this.events=new I,this.logger=at.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=Er.create(),this._resource=new xr("",Mh.type.arraybuffer);for(const s of e)if(L_(s)){this.path=s;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",e.join(", ")),this.logger.warn("Attempting to use",e[0]),this.path=e[0])}isLoaded(){return!!this.data}async load(){var e,s;if(this.data)return this.data;const r=await this._resource.load(),a=await this.decodeAudio(r.slice(0));return this._duration=(s=(e=this._duration)!==null&&e!==void 0?e:a?.duration)!==null&&s!==void 0?s:void 0,this.events.emit("processed",new Sd(this,a)),this.data=a}async decodeAudio(e){try{return await this._audioContext.decodeAudioData(e.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(e){e&&(this._engine=e,this._engine.on("hidden",()=>{e.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{e.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(e=>e.isPlaying())}isPaused(){return this._tracks.some(e=>e.isPaused())}isStopped(){return this._tracks.some(e=>e.isStopped())}play(e){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=e||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const e of this._tracks)e.pause();this.events.emit("pause",new un(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const e of this._tracks)e.stop();this.events.emit("stop",new un(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._tracks.forEach(s=>{s.playbackRate=this._playbackRate})}seek(e,s=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[s].seek(e)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(e=0){return this._tracks.length?this._tracks[e].getPlaybackPosition():0}getTrackId(e){return this._tracks.indexOf(e)}async _resumePlayback(){if(this.isPaused()){const e=[];for(const s of this._tracks)e.push(s.play().then(()=>(this._tracks.splice(this.getTrackId(s),1),!0)));this.events.emit("resume",new un(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(e)}return!0}async _startPlayback(){const e=this._getTrackInstance(this.data),s=await e.play(()=>{this.events.emit("playbackstart",new un(this,e)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new un(this,e));const r=this.getTrackId(e);return r!==-1&&this._tracks.splice(r,1),s}_getTrackInstance(e){var s;const r=new Cd(e);return r.loop=this.loop,r.volume=this.volume,r.duration=(s=this.duration)!==null&&s!==void 0?s:0,r.playbackRate=this._playbackRate,this._tracks.push(r),r}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const z_={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function kh(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class Tr{get resources(){return this._resources}constructor(e){var s;this.events=new I,this.canvas=new Vo({filtering:_e.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new P,e&&(!((s=e.loadables)===null||s===void 0)&&s.length)&&this.addResources(e.loadables)}onInitialize(e){this.engine=e,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await bo(500,this.engine.clock)}addResource(e){this._resources.push(e)}addResources(e){let s=0;const r=e.length;for(s;s<r;s++)this.addResource(e[s])}markResourceComplete(){this._numLoaded++}get progress(){const e=this._resources.length;return e>0?j(this._numLoaded,0,e)/e:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(e,s){this._totalTimeMs+=s}onDraw(e){const s=this._totalTimeMs/1e3;e.fillStyle=Z.Black.toRGBA(),e.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),e.save(),e.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const r=s*10;e.strokeStyle="white",e.lineWidth=10,e.lineCap="round",e.arc(0,0,40,r,r+Math.PI*3/2),e.stroke(),e.fillStyle="white",e.font="16px sans-serif";const a=(this.progress*100).toFixed(0)+"%",l=e.measureText(a),f=Math.abs(l.actualBoundingBoxLeft)+Math.abs(l.actualBoundingBoxRight),p=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);e.fillText(a,-f/2,p/2),e.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async e=>{this.events.emit("loadresourcestart",e),await e.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",e)})}));for(const e of this._resources)e instanceof Pd&&e.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await dn.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const H_="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var O_=o(851);class fn extends Tr{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const e=document.getElementById("excalibur-play-root");return e&&(this._playButtonRootElement=e),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(e){const s=Array.isArray(e)?{loadables:e}:e;super(s),this._logger=at.getInstance(),this._originalOptions={loadables:[]},this.events=new I,this._playButtonShown=!1,this.logo=H_,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=Z.White,this.backgroundColor="#176BAA",this._imageLoaded=new P,this.suppressPlayButton=!1,this._playButtonStyles=O_.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let r=document.getElementById("excalibur-play");return r||(r=document.createElement("button")),r.id="excalibur-play",r.textContent=this.playButtonText,r.style.display="none",r},this._originalOptions={...fn._DEFAULT_LOADER_OPTIONS,...s}}onInitialize(e){this.engine=e,this.screen=e.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var e,s;if(this.suppressPlayButton)this.hidePlayButton(),await bo(500,(e=this.engine)===null||e===void 0?void 0:e.clock);else{const r=()=>{try{this._positionPlayButton()}catch{}};return!((s=this.engine)===null||s===void 0)&&s.browser&&this.engine.browser.window.on("resize",r),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",l=>{l.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(l=>{const f=p=>{var m;if(p.stopPropagation(),this.hidePlayButton(),!((m=this.engine)===null||m===void 0)&&m.browser&&this.engine.browser.window.off("resize",r),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(w){this._logger.error("could not go fullscreen",w)}l()};this._playButton.addEventListener("click",f),this._playButton.addEventListener("touchend",f),this._playButton.addEventListener("pointerup",f),this.engine&&this.engine.input.gamepads.once("button",()=>f(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var e;await bo(200,(e=this.engine)===null||e===void 0?void 0:e.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const e=this._image;await this._imageLoaded.promise,await e?.decode()}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:e,y:s,width:r,height:a}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const l=this._playButton.clientWidth,f=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${e+r/2-l/2}px`,this._playButtonRootElement.style.top=`${s+a/2-f/2+100}px`)}}}onDraw(e){const s=this.engine.canvasHeight/this.engine.pixelRatio,r=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),e.fillStyle=this.backgroundColor,e.fillRect(0,0,r,s);let a=s/2;const l=Math.min(this.logoWidth,r*.75);let f=r/2-l/2;this.logoPosition&&(f=this.logoPosition.x,a=this.logoPosition.y);const p=Math.floor(l*(this.logoHeight/this.logoWidth)),m=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,f,a,l,p):e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,f,a-p-20,l,p),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=m;return}let w=f,b=a;this.loadingBarPosition&&(w=this.loadingBarPosition.x,b=this.loadingBarPosition.y),e.lineWidth=2,sh(e,w,b,l,20,10,this.loadingBarColor);const y=l*this.progress,T=5,D=y-T*2,U=20-T*2;sh(e,w+T,b+T,D>10?D:10,U,5,null,this.loadingBarColor),this.engine.screen.antialiasing=m}}fn._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const Ed={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class Td{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("2d"))},arrayBufferSupport:function(){const e=new XMLHttpRequest;e.open("GET","/");try{e.responseType="arraybuffer"}catch{return!1}return e.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const e=document.createElement("a").style;return e.cssText="background-color:rgba(150,255,150,.5)",(""+e.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let e=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const s=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],r=this.getBrowserFeatures();for(const a of Object.keys(Ed))r[a]?(e+="(%c✓%c)",s.push("font-weight: bold; color: green"),s.push("font-weight: normal; color: inherit")):(e+="(%c✗%c)",s.push("font-weight: bold; color: red"),s.push("font-weight: normal; color: inherit")),e+=" "+Ed[a]+`
`;s.unshift(e),console.log.apply(console,s)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let e=!1;for(const s in this._criticalTests)this._criticalTests[s].call(this)||(this.failedTests.push(s),at.getInstance().error("Critical browser feature missing, Excalibur requires:",s),e=!0);if(e)return!1;for(const s in this._warningTest)this._warningTest[s]()||at.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",s);return!0}}var ft;(function(u){u.PreventCollision="PreventCollision",u.Passive="Passive",u.Active="Active",u.Fixed="Fixed"})(ft||(ft={}));class Zi{static create(e,s){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(e)){const a=this._GROUPS.get(e);if(a.mask===s)return a;throw new Error(`Collision group ${e} already exists with a different mask!`)}const r=new As(e,this._CURRENT_BIT,s!==void 0?s:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(e,r),r}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(e){return this._GROUPS.get(e)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}Zi._STARTING_BIT=1,Zi._MAX_GROUPS=32,Zi._CURRENT_GROUP=1,Zi._CURRENT_BIT=Zi._STARTING_BIT,Zi._GROUPS=new Map;class As{constructor(e,s,r){this._name=e,this._category=s,this._mask=r}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(e){const s=this.category&e.mask,r=this.mask&e.category;return s!==0&&r!==0}invert(){const e=Zi.create("~("+this.name+")",~this.mask|0);return e._category=~this.category,e}static combine(e){const s=e.map(l=>l.name).join("+"),a=~e.reduce((l,f)=>f.category|l,0);return Zi.create(s,a)}static collidesWith(e){const s=`collidesWith(${e.map(a=>a.name).join("+")})`,r=e.reduce((a,l)=>l.category|a,0);return Zi.create(s,r)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}As.All=new As("Collide with all groups",-1,-1);class Ke{constructor(e,s){this.colliderA=e,this.colliderB=s,this.id=null,this.id=Ke.calculatePairHash(e.id,s.id)}static canCollide(e,s){var r,a;if(e.id===s.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.localBounds.hasZeroDimensions()||s.localBounds.hasZeroDimensions())return!1;const l=(r=e?.owner)===null||r===void 0?void 0:r.get(Et),f=(a=s?.owner)===null||a===void 0?void 0:a.get(Et);return!(!l||!f||!l.group.canCollide(f.group)||l.collisionType===ft.Fixed&&f.collisionType===ft.Fixed||f.collisionType===ft.PreventCollision||l.collisionType===ft.PreventCollision||!l.isActive||!f.isActive)}get canCollide(){const e=this.colliderA,s=this.colliderB;return Ke.canCollide(e,s)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(e){return e===this.colliderA||e===this.colliderB}static calculatePairHash(e,s){return e.value<s.value?`#${e.value}+${s.value}`:`#${s.value}+${e.value}`}}class Ir{constructor(e,s){this.min=e,this.max=s}overlaps(e){return this.max>e.min&&e.max>this.min}getOverlap(e){return this.overlaps(e)?this.max>e.max?e.max-this.min:this.max-e.min:0}}class Lh{constructor(e){this.parent=e,this.parent=e||null,this.data=null,this.bounds=new ht,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class Uh{constructor(e,s=new ht(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=e,this.worldBounds=s,this.root=null,this.nodes={}}_insert(e){if(this.root===null){this.root=e,this.root.parent=null;return}const s=e.bounds;let r=this.root;for(;!r.isLeaf();){const p=r.left,m=r.right,w=r.bounds.getPerimeter(),y=r.bounds.combine(s).getPerimeter(),T=2*y,D=2*(y-w);let U=0;const O=s.combine(p.bounds);let q,H;p.isLeaf()?U=O.getPerimeter()+D:(H=p.bounds.getPerimeter(),q=O.getPerimeter(),U=q-H+D);let W=0;const J=s.combine(m.bounds);if(m.isLeaf()?W=J.getPerimeter()+D:(H=m.bounds.getPerimeter(),q=J.getPerimeter(),W=q-H+D),T<U&&T<W)break;U<W?r=p:r=m}const a=r.parent,l=new Lh(a);l.bounds=s.combine(r.bounds),l.height=r.height+1,a!==null?(a.left===r?a.left=l:a.right=l,l.left=r,l.right=e,r.parent=l,e.parent=l):(l.left=r,l.right=e,r.parent=l,e.parent=l,this.root=l);let f=e.parent;for(;f;){if(f=this._balance(f),!f.left)throw new Error("Parent of current leaf cannot have a null left child"+f);if(!f.right)throw new Error("Parent of current leaf cannot have a null right child"+f);f.height=1+Math.max(f.left.height,f.right.height),f.bounds=f.left.bounds.combine(f.right.bounds),f=f.parent}}_remove(e){if(e===this.root){this.root=null;return}const s=e.parent,r=s.parent;let a;if(s.left===e?a=s.right:a=s.left,r){r.left===s?r.left=a:r.right=a,a.parent=r;let l=r;for(;l;)l=this._balance(l),l.bounds=l.left.bounds.combine(l.right.bounds),l.height=1+Math.max(l.left.height,l.right.height),l=l.parent}else this.root=a,a.parent=null}trackCollider(e){const s=new Lh;s.data=e,s.bounds=e.bounds,s.bounds.left-=2,s.bounds.top-=2,s.bounds.right+=2,s.bounds.bottom+=2,this.nodes[e.id.value]=s,this._insert(s)}updateCollider(e){var s;const r=this.nodes[e.id.value];if(!r)return!1;const a=e.bounds;if(!this.worldBounds.contains(a))return at.getInstance().warn("Collider with id "+e.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(e),!1;if(r.bounds.contains(a))return!1;if(this._remove(r),a.left-=this._config.boundsPadding,a.top-=this._config.boundsPadding,a.right+=this._config.boundsPadding,a.bottom+=this._config.boundsPadding,e.owner){const l=(s=e.owner)===null||s===void 0?void 0:s.get(Et);if(l){const f=l.vel.x*32/1e3*this._config.velocityMultiplier,p=l.vel.y*32/1e3*this._config.velocityMultiplier;f<0?a.left+=f:a.right+=f,p<0?a.top+=p:a.bottom+=p}}return r.bounds=a,this._insert(r),!0}untrackCollider(e){const s=this.nodes[e.id.value];s&&(this._remove(s),this.nodes[e.id.value]=null,delete this.nodes[e.id.value])}_balance(e){if(e===null)throw new Error("Cannot balance at null node");if(e.isLeaf()||e.height<2)return e;const s=e.left,r=e.right,a=e,l=s,f=r,p=s.left,m=s.right,w=r.left,b=r.right,y=f.height-l.height;if(y>1)return f.left=a,f.parent=a.parent,a.parent=f,f.parent?f.parent.left===a?f.parent.left=f:f.parent.right=f:this.root=f,w.height>b.height?(f.right=w,a.right=b,b.parent=a,a.bounds=l.bounds.combine(b.bounds),f.bounds=a.bounds.combine(w.bounds),a.height=1+Math.max(l.height,b.height),f.height=1+Math.max(a.height,w.height)):(f.right=b,a.right=w,w.parent=a,a.bounds=l.bounds.combine(w.bounds),f.bounds=a.bounds.combine(b.bounds),a.height=1+Math.max(l.height,w.height),f.height=1+Math.max(a.height,b.height)),f;if(y<-1){if(l.left=a,l.parent=a.parent,a.parent=l,l.parent)if(l.parent.left===a)l.parent.left=l;else{if(l.parent.right!==a)throw"Error rotating Dynamic Tree";l.parent.right=l}else this.root=l;return p.height>m.height?(l.right=p,a.left=m,m.parent=a,a.bounds=f.bounds.combine(m.bounds),l.bounds=a.bounds.combine(p.bounds),a.height=1+Math.max(f.height,m.height),l.height=1+Math.max(a.height,p.height)):(l.right=m,a.left=p,p.parent=a,a.bounds=f.bounds.combine(p.bounds),l.bounds=a.bounds.combine(m.bounds),a.height=1+Math.max(f.height,p.height),l.height=1+Math.max(a.height,m.height)),l}return e}getHeight(){return this.root===null?0:this.root.height}query(e,s){const r=e.bounds,a=l=>{if(l&&l.bounds.overlaps(r))if(l.isLeaf()&&l.data!==e){if(s.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}rayCastQuery(e,s=1/0,r){const a=l=>{if(l&&l.bounds.rayCast(e,s))if(l.isLeaf()){if(r.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}getNodes(){const e=s=>s?[s].concat(e(s.left),e(s.right)):[];return e(this.root)}debug(e){const s=r=>{r&&(r.isLeaf()?r.bounds.draw(e,Z.Green):r.bounds.draw(e,Z.White),r.left&&s(r.left),r.right&&s(r.right))};s(this.root)}}class gn{constructor(e,s){this.pos=e,this.dir=s.normalize()}intersect(e){const s=e.begin.sub(this.pos);if(this.dir.cross(e.getSlope())===0&&s.cross(this.dir)!==0)return-1;const r=this.dir.cross(e.getSlope());if(r===0)return-1;const a=s.cross(e.getSlope())/r;if(a>=0){const l=s.cross(this.dir)/r/e.getLength();if(l>=0&&l<=1)return a}return-1}intersectPoint(e){const s=this.intersect(e);return s<0?null:this.getPoint(s)}getPoint(e){return this.pos.add(this.dir.scale(e))}}class No{constructor(e){this._config=e,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new Uh(e.dynamicTree)}getColliders(){return this._colliders}query(e){const s=[];return e instanceof ht?this._dynamicCollisionTree.query({id:S("collider",-1),owner:null,bounds:e},r=>(s.push(r),!1)):this._dynamicCollisionTree.query({id:S("collider",-1),owner:null,bounds:new ht(e.x,e.y,e.x,e.y)},r=>(s.push(r),!1)),s}rayCast(e,s){var r,a,l;const f=[],p=(r=s?.maxDistance)!==null&&r!==void 0?r:1/0,m=s?.collisionGroup,w=m?m.category:(a=s?.collisionMask)!==null&&a!==void 0?a:As.All.category,b=(l=s?.searchAllColliders)!==null&&l!==void 0?l:!1;return this._dynamicCollisionTree.rayCastQuery(e,p,y=>{const D=y.owner.get(Et);if(s?.ignoreCollisionGroupAll&&D.group===As.All)return!1;const U=(w&D.group.category)!==0;if(D?.group&&!U)return!1;const O=y.rayCast(e,p);if(O){if(s?.filter){if(s.filter(O)&&(f.push(O),!b))return!0}else if(f.push(O),!b)return!0}return!1}),f}track(e){if(!e){at.getInstance().warn("Cannot track null collider");return}if(e instanceof Pe){const s=e.getColliders();for(const r of s)r.owner=e.owner,this._colliders.push(r),this._dynamicCollisionTree.trackCollider(r)}else this._colliders.push(e),this._dynamicCollisionTree.trackCollider(e)}untrack(e){if(!e){at.getInstance().warn("Cannot untrack a null collider");return}if(e instanceof Pe){const s=e.getColliders();for(const r of s){const a=this._colliders.indexOf(r);a!==-1&&this._colliders.splice(a,1),this._dynamicCollisionTree.untrackCollider(r)}}else{const s=this._colliders.indexOf(e);s!==-1&&this._colliders.splice(s,1),this._dynamicCollisionTree.untrackCollider(e)}}_pairExists(e,s){const r=Ke.calculatePairHash(e.id,s.id);return this._pairs.has(r)}broadphase(e,s,r){const a=s/1e3,l=e.filter(p=>{var m,w;const b=(m=p.owner)===null||m===void 0?void 0:m.get(Et);return((w=p.owner)===null||w===void 0?void 0:w.isActive)&&b.collisionType!==ft.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let f;for(let p=0,m=l.length;p<m;p++)f=l[p],this._dynamicCollisionTree.query(f,w=>{if(!this._pairExists(f,w)&&Ke.canCollide(f,w)){const b=new Ke(f,w);this._pairs.add(b.id),this._collisionPairCache.push(b)}return!1});if(r&&(r.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const p of l){const m=p.owner.get(Et);if(m.collisionType!==ft.Active)continue;const w=m.vel.magnitude*a+m.acc.magnitude*.5*a*a,b=Math.min(p.bounds.height,p.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||w>b/2){r&&r.physics.fastBodies++;const y=m.globalPos.sub(m.oldPos),T=p.center,D=p.getFurthestPoint(m.vel),U=D.sub(y),O=new gn(U,m.vel);O.pos=O.pos.add(O.dir.scale(-2*this._config.continuous.surfaceEpsilon));let q,H=new B(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(O,w+this._config.continuous.surfaceEpsilon*2,W=>{if(!this._pairExists(p,W)&&Ke.canCollide(p,W)){const J=W.rayCast(O,w+this._config.continuous.surfaceEpsilon*10);if(J){const Y=J.point.sub(U);Y.magnitude<H.magnitude&&(H=Y,q=W)}}return!1}),q&&B.isValid(H)){const W=new Ke(p,q);this._pairs.has(W.id)||(this._pairs.add(W.id),this._collisionPairCache.push(W));const J=T.sub(D);m.globalPos=U.add(J).add(H).add(O.dir.scale(10*this._config.continuous.surfaceEpsilon)),p.update(m.transform.get()),r&&r.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(e,s){let r=[];for(let a=0;a<e.length;a++){const l=e[a].collide();if(r=r.concat(l),s&&l.length>0)for(const f of l)s.physics.contacts.set(f.id,f)}return s&&(s.physics.collisions+=r.length),r}update(e){let s=0;const r=e.length;for(let a=0;a<r;a++)this._dynamicCollisionTree.updateCollider(e[a])&&s++;return s}debug(e){this._dynamicCollisionTree.debug(e)}}class Gs{constructor(){this.id=S("collider",Gs._ID++),this.composite=null,this.events=new I,this.offset=B.Zero}touching(e){return!!this.collide(e)}}Gs._ID=0;var Rr;(function(u){u.Arcade="arcade",u.Realistic="realistic"})(Rr||(Rr={}));var bs;(function(u){u.None="none",u.VerticalFirst="vertical-first",u.HorizontalFirst="horizontal-first"})(bs||(bs={}));const zh={vertical:1,horizontal:2},Hh={horizontal:1,vertical:2},Oh={horizontal:0,vertical:0};var Yn;(function(u){u.DynamicTree="dynamic-tree",u.SparseHashGrid="sparse-hash-grid"})(Yn||(Yn={}));const ys=()=>({enabled:!0,gravity:z(0,0).clone(),solver:Rr.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:Yn.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:bs.None},realistic:{contactSolveBias:bs.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class Pe extends Gs{set compositeStrategy(e){this._compositeStrategy=e}get compositeStrategy(){return this._compositeStrategy}constructor(e){super(),this._collisionProcessor=new No({...ys()}),this._dynamicAABBTree=new Uh({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const s of e)this.addCollider(s)}clearColliders(){this._colliders=[]}addCollider(e){let s;e instanceof Pe?(s=e.getColliders(),s.forEach(r=>r.offset.addEqual(e.offset))):s=[e];for(const r of s)r.events.pipe(this.events),r.composite=this,this._colliders.push(r),this._collisionProcessor.track(r),this._dynamicAABBTree.trackCollider(r)}removeCollider(e){e.events.pipe(this.events),e.composite=null,ms(e,this._colliders),this._collisionProcessor.untrack(e),this._dynamicAABBTree.untrackCollider(e)}getColliders(){return this._colliders}get worldPos(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:B.Zero).add(this.offset)}get center(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:B.Zero).add(this.offset)}get bounds(){var e,s;const r=this.getColliders();return r.reduce((l,f)=>l.combine(f.bounds),(s=(e=r[0])===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new ht().translate(this.worldPos)).translate(this.offset)}get localBounds(){var e,s;const r=this.getColliders();return r.reduce((l,f)=>l.combine(f.localBounds),(s=(e=r[0])===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new ht)}get axes(){const e=this.getColliders();let s=[];for(const r of e)s=s.concat(r.axes);return s}getFurthestPoint(e){const s=this.getColliders(),r=[];for(const f of s)r.push(f.getFurthestPoint(e));let a=r[0],l=-Number.MAX_VALUE;for(const f of r){const p=f.dot(e);p>l&&(a=f,l=p)}return a}getInertia(e){const s=this.getColliders();let r=0;for(const a of s)r+=a.getInertia(e);return r}collide(e){let s=[e];e instanceof Pe&&(s=e.getColliders());const r=[];for(const l of s)this._dynamicAABBTree.query(l,f=>(r.push(new Ke(l,f)),!1));let a=[];for(const l of r)a=a.concat(l.collide());return a}getClosestLineBetween(e){const s=this.getColliders(),r=[];if(e instanceof Pe){const a=e.getColliders();for(const l of s)for(const f of a){const p=l.getClosestLineBetween(f);p&&r.push(p)}}else for(const a of s){const l=e.getClosestLineBetween(a);l&&r.push(l)}if(r.length){let a=r[0].getLength(),l=r[0];for(const f of r){const p=f.getLength();p<a&&(a=p,l=f)}return l}return null}contains(e){const s=this.getColliders();for(const r of s)if(r.contains(e))return!0;return!1}rayCast(e,s){const r=this.getColliders(),a=[];for(const l of r){const f=l.rayCast(e,s);f&&a.push(f)}if(a.length){let l=a[0],f=l.point.dot(e.dir);for(const p of a){const m=e.dir.dot(p.point);m<f&&(l=p,f=m)}return l}return null}project(e){const s=this.getColliders(),r=[];for(const a of s){const l=a.project(e);l&&r.push(l)}if(r.length){const a=new Ir(r[0].min,r[0].max);for(const l of r)a.min=Math.min(l.min,a.min),a.max=Math.max(l.max,a.max);return a}return null}update(e){if(e){const s=this.getColliders();for(const r of s)r.owner=this.owner,r.update(e)}}debug(e,s,r){const a=this.getColliders();e.save(),e.translate(this.offset.x,this.offset.y);for(const l of a)l.debug(e,s,r);e.restore()}clone(){const e=new Pe(this._colliders.map(s=>s.clone()));return e.offset=this.offset.clone(),e}}class ue{constructor(e,s){this.begin=e,this.end=s}clone(e){const s=e||new ue(this.begin.clone(),this.end.clone());return s.begin=this.begin.clone(s.begin),s.end=this.end.clone(s.end),s}transform(e,s){const r=s||new ue(B.Zero,B.Zero);return r.begin=e.multiply(this.begin,r.begin),r.end=e.multiply(this.end,r.end),r}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const e=this.begin,s=this.end,r=e.distance(s);return this._slope=s.sub(e).scale(1/r)}getEdge(){const e=this.begin;return this.end.sub(e)}getLength(){const e=this.begin,s=this.end;return e.distance(s)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new ue(this.end,this.begin)}below(e){return(this.end.x-this.begin.x)*(e.y-this.begin.y)-(this.end.y-this.begin.y)*(e.x-this.begin.x)>=0}clip(e,s,r=!0){let a=e;r&&(a=a.normalize());const l=a.dot(this.begin)-s,f=a.dot(this.end)-s,p=[];if(l<=0&&p.push(this.begin),f<=0&&p.push(this.end),l*f<0){const m=l/(l-f);p.push(this.begin.add(this.end.sub(this.begin).scale(m)))}return p.length!==2?null:new ue(p[0],p[1])}distanceToPoint(e,s=!1){const r=e.x,a=e.y,l=this.getLength(),f=this.end.y-this.begin.y,p=this.end.x-this.begin.x,m=(f*r-p*a+this.end.x*this.begin.y-this.end.y*this.begin.x)/l;return s?m:Math.abs(m)}findVectorToPoint(e){const s=this.begin.sub(e),r=this.getSlope();return s.sub(r.scale(s.dot(r)))}findPoint(e=null,s=null){const r=this.slope,a=this.intercept;if(e!==null)return new B(e,r*e+a);if(s!==null)return new B((s-a)/r,s);throw new Error("You must provide an X or a Y value")}hasPoint(){let e,s=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")e=new B(arguments[0],arguments[1]),s=arguments[2]||0;else if(arguments[0]instanceof B)e=arguments[0],s=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const r=e.x-this.begin.x,a=e.y-this.begin.y,l=this.end.x-this.begin.x,f=this.end.y-this.begin.y,p=r*f-a*l;return Math.abs(p)>s?!1:Math.abs(l)>=Math.abs(f)?l>0?this.begin.x<=e.x&&e.x<=this.end.x:this.end.x<=e.x&&e.x<=this.begin.x:f>0?this.begin.y<=e.y&&e.y<=this.end.y:this.end.y<=e.y&&e.y<=this.begin.y}}function Vh(u,e){const r=u.dir(),a=e.dir(),l=r.dot(r),f=a.dot(a);if(l<1e-9&&f<1e-9)return new ue(u.begin,e.begin);if(l<1e-9){const q=j(a.dot(u.begin.sub(e.begin))/f,0,1),H=e.begin.add(a.scale(q));return new ue(u.begin,H)}if(f<1e-9){const q=j(r.dot(e.begin.sub(u.begin))/l,0,1),H=u.begin.add(r.scale(q));return new ue(H,e.begin)}const p=u.begin.sub(e.begin),m=l,w=f,b=a.dot(p),y=m*w-Math.pow(r.dot(a),2);let T=0,D=0;Math.abs(y)>1e-9?T=j((r.dot(a)*b-w*r.dot(p))/y,0,1):T=j(r.dot(p)/m,0,1),Math.abs(w)>1e-9?D=j((r.dot(a)*T+b)/w,0,1):D=0;const U=u.begin.add(r.scale(T)),O=e.begin.add(a.scale(D));return new ue(U,O)}const Ji={PolygonPolygonClosestLine(u,e){const s=u.getSides(),r=e.getSides();let a=Number.MAX_VALUE,l=null;for(let f=0;f<s.length;f++)for(let p=0;p<r.length;p++){const m=Vh(s[f],r[p]),w=m.getLength();w<a&&(a=w,l=m)}return l},PolygonEdgeClosestLine(u,e){const r=e.worldPos.sub(u.worldPos),a=new gn(u.worldPos,r),l=u.rayCast(a).point.add(a.dir.scale(.1)),f=u.getClosestFace(l),p=e.asLine();return Vh(f.face,p)},PolygonCircleClosestLine(u,e){const s=e.worldPos,r=s.sub(u.worldPos),a=new gn(u.worldPos,r.normalize()),l=u.rayCast(a).point.add(a.dir.scale(.1)),f=u.getClosestFace(l),p=f.face.begin,m=f.face.getEdge();let w=(m.x*(s.x-p.x)+m.y*(s.y-p.y))/(m.x*m.x+m.y*m.y);w>1?w=1:w<0&&(w=0);const b=Math.sqrt(Math.pow(p.x+m.x*w-s.x,2)+Math.pow(p.y+m.y*w-s.y,2))-e.radius,y=(p.x+m.x*w-s.x)*e.radius/(e.radius+b),T=(p.y+m.y*w-s.y)*e.radius/(e.radius+b);return new ue(m.scale(w).add(p),new B(s.x+y,s.y+T))},CircleCircleClosestLine(u,e){const r=e.worldPos.sub(u.worldPos),l=u.worldPos.sub(e.worldPos),f=new gn(u.worldPos,r),p=new gn(e.worldPos,l),m=u.rayCast(f),w=e.rayCast(p);return new ue(m.point,w.point)},CircleEdgeClosestLine(u,e){const s=u.worldPos,r=e.asLine(),a=r.begin,l=r.getEdge(),f=a,p=l;let m=(p.x*(s.x-f.x)+p.y*(s.y-f.y))/(p.x*p.x+p.y*p.y);m>1?m=1:m<0&&(m=0);const w=Math.sqrt(Math.pow(f.x+p.x*m-s.x,2)+Math.pow(f.y+p.y*m-s.y,2))-u.radius,b=(f.x+p.x*m-s.x)*u.radius/(u.radius+w),y=(f.y+p.y*m-s.y)*u.radius/(u.radius+w);return new ue(p.scale(m).add(f),new B(s.x+b,s.y+y))},EdgeEdgeClosestLine(u,e){const s=u.asLine(),r=e.asLine();return Vh(s,r)}};class We extends Gs{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var e;if(this._radius)return this._radius;const s=this._transform,r=(e=s?.globalScale)!==null&&e!==void 0?e:B.One;return this._radius=this._naturalRadius*Math.min(r.x,r.y)}set radius(e){var s;const r=this._transform,a=(s=r?.globalScale)!==null&&s!==void 0?s:B.One;this._naturalRadius=e/Math.min(a.x,a.y),this._localBoundsDirty=!0,this._radius=e}constructor(e){super(),this.offset=B.Zero,this._globalMatrix=pe.identity(),this._localBoundsDirty=!0,this.offset=e.offset||B.Zero,this.radius=e.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new We({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(e){var s,r;return((r=(s=this._transform)===null||s===void 0?void 0:s.pos)!==null&&r!==void 0?r:this.offset).distance(e)<=this.radius}rayCast(e,s=1/0){var r,a;const l=this.center,f=e.dir,p=e.pos,m=l.sub(p),w=f.scale(m.dot(f)),y=m.sub(w).magnitude;if(y>this.radius)return null;{let T=0;if(X(y,this.radius,1e-4)){if(T=-f.dot(p.sub(l)),T>0&&T<s){const D=e.getPoint(T);return{point:D,normal:D.sub(l).normalize(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(Et),distance:T}}return null}else{const D=Math.sqrt(Math.pow(f.dot(p.sub(l)),2)-Math.pow(p.sub(l).distance(),2)+Math.pow(this.radius,2)),U=-f.dot(p.sub(l))+D,O=-f.dot(p.sub(l))-D,q=[];U>=0&&q.push(U),O>=0&&q.push(O);const H=Math.min(...q);if(H<=s){const W=e.getPoint(H);return{point:W,normal:W.sub(l).normalize(),collider:this,body:(a=this.owner)===null||a===void 0?void 0:a.get(Et),distance:H}}return null}}}getClosestLineBetween(e){if(e instanceof We)return Ji.CircleCircleClosestLine(this,e);if(e instanceof Be)return Ji.PolygonCircleClosestLine(e,this).flip();if(e instanceof _i)return Ji.CircleEdgeClosestLine(this,e).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof We)return Hi.CollideCircleCircle(this,e);if(e instanceof Be)return Hi.CollideCirclePolygon(this,e);if(e instanceof _i)return Hi.CollideCircleEdge(this,e);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){return this.center.add(e.normalize().scale(this.radius))}getFurthestLocalPoint(e){return e.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new ht(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(e){return e*this.radius*this.radius/2}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(e){const s=[],a=this.center.dot(e);return s.push(a),s.push(a+this.radius),s.push(a-this.radius),new Ir(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s,r){var a,l,f,p;const{lineWidth:m}={lineWidth:1,...r},w=this._transform,b=(a=w?.globalScale)!==null&&a!==void 0?a:B.One,y=(l=w?.globalRotation)!==null&&l!==void 0?l:0,T=(f=w?.globalPos)!==null&&f!==void 0?f:B.Zero;e.save(),e.translate(T.x,T.y),e.rotate(y),e.scale(b.x,b.y),e.drawCircle((p=this.offset)!==null&&p!==void 0?p:B.Zero,this._naturalRadius,Z.Transparent,s,m),e.restore()}}class pn{constructor(e,s,r,a,l,f,p,m){var w,b,y,T,D,U;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=e,this.colliderB=s,this.mtv=r,this.normal=a,this.tangent=l,this.points=f,this.localPoints=p,this.info=m,this.id=Ke.calculatePairHash(e.id,s.id),e.composite||s.composite){const O=((w=e.composite)===null||w===void 0?void 0:w.compositeStrategy)==="separate"?e.id:(y=(b=e.composite)===null||b===void 0?void 0:b.id)!==null&&y!==void 0?y:e.id,q=((T=s.composite)===null||T===void 0?void 0:T.compositeStrategy)==="separate"?s.id:(U=(D=s.composite)===null||D===void 0?void 0:D.id)!==null&&U!==void 0?U:s.id;this.id+="|"+Ke.calculatePairHash(O,q)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(Et)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(Et))}matchAwake(){const e=this.bodyA,s=this.bodyB;e&&s&&e.isSleeping!==s.isSleeping&&(e.isSleeping&&e.collisionType!==ft.Fixed&&s.sleepMotion>=e.wakeThreshold&&(e.isSleeping=!1),s.isSleeping&&s.collisionType!==ft.Fixed&&e.sleepMotion>=s.wakeThreshold&&(s.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(e){if(e!==this.colliderA&&e!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(e===this.colliderA)return this;const s=this.colliderA,r=this.colliderB;return this.colliderB=s,this.colliderA=r,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class Id{constructor(){this.axis=z(0,0),this.localAxis=z(0,0),this.side=new ue(z(0,0),z(0,0)),this.localSide=new ue(z(0,0),z(0,0)),this.point=z(0,0),this.localPoint=z(0,0)}}class me{static findPolygonPolygonSeparation(e,s){if(s.transform.matrix.determinant()===0)return me.findPolygonPolygonSeparationDegenerate(e,s);let r=-Number.MAX_VALUE,a=-1,l;const f=s.transform.inverse.multiply(e.transform.matrix,me._SCRATCH_MATRIX),p=f.getRotation(),m=e.normals,w=e.points,b=s.points;for(let D=0;D<w.length;D++){const U=m[D].rotate(p,me._ZERO,me._SCRATCH_NORMAL),O=f.multiply(w[D],me._SCRATCH_POINT);let q=Number.MAX_VALUE,H;for(let W=0;W<b.length;W++){const J=U.dot(b[W].sub(O,me._SCRATCH_SUB_POINT));J<q&&(q=J,H=b[W])}q>r&&(r=q,a=D,l=H)}const y=(a+1)%w.length,T=me.SeparationPool.get();return T.collider=e,T.separation=r,r>0||(m[a].clone(T.localAxis),m[a].rotate(e.transform.rotation,me._ZERO,T.axis),e.transform.matrix.multiply(w[a],T.side.begin),e.transform.matrix.multiply(w[y],T.side.end),s.transform.matrix.multiply(l,T.point),T.sideId=a,l.clone(T.localPoint),w[a].clone(T.localSide.begin),w[y].clone(T.localSide.end)),T}static findCirclePolygonSeparation(e,s){const r=s.axes,l=s.center.sub(e.worldPos),f=s.getFurthestPoint(l.negate());r.push(f.sub(e.worldPos).normalize());let p=Number.MAX_VALUE,m=null,w=-1;for(let b=0;b<r.length;b++){const y=s.project(r[b]),T=e.project(r[b]),D=y.getOverlap(T);if(D<=0)return null;D<p&&(p=D,m=r[b],w=b)}return w<0?null:m.normalize().scale(p)}static findPolygonPolygonSeparationDegenerate(e,s){let r=-Number.MAX_VALUE,a=null,l=null,f=-1,p=null;const m=e.getSides(),w=e.getLocalSides();for(let b=0;b<m.length;b++){const y=m[b],T=y.normal(),D=s.getFurthestPoint(T.negate()),U=y.distanceToPoint(D,!0);U>r&&(r=U,a=y,l=T,f=b,p=D)}return{collider:e,separation:l?r:99,axis:l,side:a,localSide:w[f],sideId:f,point:p,localPoint:l?s.getFurthestLocalPoint(l.negate()):null}}}me.SeparationPool=new Eo(()=>new Id,u=>u,500),me._ZERO=z(0,0),me._SCRATCH_POINT=z(0,0),me._SCRATCH_SUB_POINT=z(0,0),me._SCRATCH_NORMAL=z(0,0),me._SCRATCH_MATRIX=pe.identity(),me.SeparationPool.disableWarnings=!0;const V_=B.Zero,W_=B.Zero,N_=pe.identity(),Hi={CollideCircleCircle(u,e){const s=u.worldPos,r=e.worldPos,a=u.radius+e.radius,l=s.distance(r);if(l>a)return[];const f=a-l,p=r.sub(s).normalize(),m=p.perpendicular(),w=p.scale(f),b=u.getFurthestPoint(p),y=u.getFurthestLocalPoint(p),T={collider:u,separation:f,axis:p,point:b};return[new pn(u,e,w,p,m,[b],[y],T)]},CollideCirclePolygon(u,e){var s,r;let a=me.findCirclePolygonSeparation(u,e);if(!a)return[];a=a.dot(e.center.sub(u.center))<0?a.negate():a;const f=u.getFurthestPoint(a),m=((r=(s=u.owner)===null||s===void 0?void 0:s.get(it))!==null&&r!==void 0?r:new it).applyInverse(f),w=a.normalize(),b={collider:u,separation:-a.magnitude,axis:w,point:f,localPoint:m,side:e.findSide(w.negate()),localSide:e.findLocalSide(w.negate())};return[new pn(u,e,a,w,w.perpendicular(),[f],[m],b)]},CollideCircleEdge(u,e){const s=u.center,r=e.asLine(),a=r.end.sub(r.begin),l=a.dot(r.end.sub(s)),f=a.dot(s.sub(r.begin)),p=e.asLine(),m=e.asLocalLine();if(f<=0){const H=r.begin.sub(s),W=H.dot(H);if(W>u.radius*u.radius)return[];const J=H.normalize(),Y=u.radius-Math.sqrt(W),tt={collider:u,separation:Y,axis:J,point:p.begin,side:p,localSide:m};return[new pn(u,e,J.scale(Y),J,J.perpendicular(),[p.begin],[m.begin],tt)]}if(l<=0){const H=r.end.sub(s),W=H.dot(H);if(W>u.radius*u.radius)return[];const J=H.normalize(),Y=u.radius-Math.sqrt(W),tt={collider:u,separation:Y,axis:J,point:p.end,side:p,localSide:m};return[new pn(u,e,J.scale(Y),J,J.perpendicular(),[p.end],[m.end],tt)]}const w=a.dot(a),b=r.begin.scale(l).add(r.end.scale(f)).scale(1/w),y=s.sub(b),T=y.dot(y);if(T>u.radius*u.radius)return[];let D=a.perpendicular();D.dot(s.sub(r.begin))<0&&(D.x=-D.x,D.y=-D.y),D=D.normalize();const U=u.radius-Math.sqrt(T),O=D.scale(U),q={collider:u,separation:U,axis:D,point:b,side:p,localSide:m};return[new pn(u,e,O,D.negate(),D.negate().perpendicular(),[b],[b.sub(e.worldPos)],q)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(u,e){var s;const r=u.center,l=e.center.sub(r).normalize(),f=new Be({points:[e.begin,e.end,e.end.add(l.scale(100)),e.begin.add(l.scale(100))],offset:e.offset});f.owner=e.owner,((s=e.owner)===null||s===void 0?void 0:s.get(it))&&f.update(e.owner.get(it).get());const m=this.CollidePolygonPolygon(u,f);return m.length&&(m[0].colliderB=e,m[0].id=Ke.calculatePairHash(u.id,e.id)),m},CollidePolygonPolygon(u,e){const s=me.findPolygonPolygonSeparation(u,e);if(s.separation>0)return[];const r=me.findPolygonPolygonSeparation(e,u);if(r.separation>0)return[];const a=s.separation>r.separation?s:r,l=a.collider===u?e:u,f=a.collider===u?u:e,p=l.transform.inverse.multiply(f.transform.matrix,N_),m=p.getRotation(),w=f.normals[a.sideId].rotate(m,V_,W_);let b=Number.MAX_VALUE,y=0;for(let H=0;H<l.normals.length;H++){const W=w.dot(l.normals[H]);W<b&&(b=W,y=H)}if(!a.localSide||!a.localAxis||!a.axis)return[];const T=a.localSide.transform(p),D=a.localAxis.perpendicular().negate().rotate(m),O=new ue(l.points[y],l.points[(y+1)%l.points.length]).clip(D.negate(),-D.dot(T.begin),!1);let q=null;if(O&&(q=O.clip(D,D.dot(T.end),!1)),q){const H=[],W=[],J=q.getPoints();for(let ot=0;ot<J.length;ot++){const Q=J[ot];T.below(Q)&&(H.push(Q),W.push(l.transform.apply(Q)))}let Y=a.axis,tt=Y.perpendicular();return e.center.sub(u.center).dot(Y)<0&&(Y=Y.negate(),tt=Y.perpendicular()),[new pn(u,e,Y.scale(-a.separation),Y,tt,W,H,a)]}return[]},FindContactSeparation(u,e){var s,r,a,l;const f=u.colliderA,p=(r=(s=u.bodyA)===null||s===void 0?void 0:s.transform)!==null&&r!==void 0?r:new it,m=u.colliderB,w=(l=(a=u.bodyB)===null||a===void 0?void 0:a.transform)!==null&&l!==void 0?l:new it;if(f instanceof We&&m instanceof We){const b=f.radius+m.radius,y=p.pos.distance(w.pos);return-(b-y)}if(f instanceof Be&&m instanceof Be&&u.info.localSide){let b,y;return u.info.collider===f?(b=new ue(p.apply(u.info.localSide.begin).add(f.offset),p.apply(u.info.localSide.end).add(f.offset)),y=w.apply(e).add(m.offset)):(b=new ue(w.apply(u.info.localSide.begin).add(m.offset),w.apply(u.info.localSide.end).add(m.offset)),y=p.apply(e).add(f.offset)),b.distanceToPoint(y,!0)}if(f instanceof Be&&m instanceof We||m instanceof Be&&f instanceof We){const b=p.apply(e);if(u.info.side)return u.info.side.distanceToPoint(b,!0)}if(f instanceof _i&&m instanceof Be||m instanceof _i&&f instanceof Be){let b;if(u.info.collider===f?b=w.apply(e):b=p.apply(e),u.info.side)return u.info.side.distanceToPoint(b,!0)}if(f instanceof We&&m instanceof _i||m instanceof We&&f instanceof _i){const b=w.apply(e);let y;f instanceof We&&(y=f.getFurthestPoint(u.normal));const T=b.distance(y);if(u.info.side)return T>0?-T:0}return 0}};class _i extends Gs{constructor(e){var s;super(),this._globalMatrix=pe.identity(),this.begin=e.begin||B.Zero,this.end=e.end||B.Zero,this.offset=(s=e.offset)!==null&&s!==void 0?s:B.Zero}clone(){return new _i({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var e;const s=this._transform;return(e=s?.globalPos.add(this.offset))!==null&&e!==void 0?e:this.offset}get center(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.average(s)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const e=this._getTransformedBegin(),s=this._getTransformedEnd(),r=e.distance(s);return s.sub(e).scale(1/r)}getLength(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.distance(s)}contains(){return!1}rayCast(e,s=1/0){var r;const a=this._getTransformedBegin().sub(e.pos);if(e.dir.cross(this.getSlope())===0&&a.cross(e.dir)!==0)return null;const l=e.dir.cross(this.getSlope());if(l===0)return null;const f=a.cross(this.getSlope())/l;if(f>=0&&f<=s){const p=a.cross(e.dir)/l/this.getLength();if(p>=0&&p<=1)return{distance:f,normal:this.asLine().normal(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(Et),point:e.getPoint(f)}}return null}getClosestLineBetween(e){if(e instanceof We)return Ji.CircleEdgeClosestLine(e,this);if(e instanceof Be)return Ji.PolygonEdgeClosestLine(e,this).flip();if(e instanceof _i)return Ji.EdgeEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof We)return Hi.CollideCircleEdge(e,this);if(e instanceof Be)return Hi.CollidePolygonEdge(e,this);if(e instanceof _i)return Hi.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this._getTransformedBegin(),r=this._getTransformedEnd();return e.dot(s)>0?s:r}_boundsFromBeginEnd(e,s,r=10){return new ht(Math.min(e.x,s.x)-r,Math.min(e.y,s.y)-r,Math.max(e.x,s.x)+r,Math.max(e.y,s.y)+r)}get bounds(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return this._boundsFromBeginEnd(e,s)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new ue(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new ue(this.begin,this.end)}get axes(){const s=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),r=[];return r.push(s),r.push(s.negate()),r.push(s.normal()),r.push(s.normal().negate()),r}getInertia(e){const s=this.end.sub(this.begin).distance()/2;return e*s*s}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(e){const s=[],r=[this._getTransformedBegin(),this._getTransformedEnd()],a=r.length;for(let l=0;l<a;l++)s.push(r[l].dot(e));return new Ir(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s){const r=this._getTransformedBegin(),a=this._getTransformedEnd();e.drawLine(r,a,s,2),e.drawCircle(r,2,s),e.drawCircle(a,2,s)}}class Ee{static registerGraphicsContext(e){Ee._ctx=e}static draw(e){this._drawCalls.push(e)}static drawPoint(e,s){Ee.draw(r=>{r.debug.drawPoint(e,s)})}static drawLine(e,s,r){Ee.draw(a=>{a.debug.drawLine(e,s,r)})}static drawLines(e,s){e.length>1&&Ee.draw(r=>{for(let a=0;a<e.length-1;a++)r.debug.drawLine(e[a],e[a+1],s)})}static drawText(e,s){Ee.draw(r=>{r.debug.drawText(e,s)})}static drawPolygon(e,s){e.length>1&&Ee.draw(r=>{const a=e[0],l=[...e,a];for(let f=0;f<l.length-1;f++)r.debug.drawLine(l[f],l[f+1],s)})}static drawCircle(e,s,r){const{color:a,strokeColor:l,width:f}={color:Z.Black,strokeColor:void 0,width:void 0,...r};Ee.draw(p=>{p.drawCircle(e,s,a,l,f)})}static drawBounds(e,s){Ee.draw(r=>{r.debug.drawRect(e.left,e.top,e.width,e.height,s)})}static drawRay(e,s){const{distance:r,color:a}={color:Z.Blue,distance:10,...s};Ee.draw(l=>{const f=e.pos,p=e.pos.add(e.dir.scale(r));l.debug.drawLine(f,p,{color:a})})}static flush(e){e.save(),e.z=Ee.z;for(const s of Ee._drawCalls)s(e);e.restore(),Ee.clear()}static clear(){Ee._drawCalls.length=0}}Ee._drawCalls=[],Ee.z=1/0;class Be extends Gs{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(e){if(e.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=e,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const e=[];for(let s=0;s<this._points.length;s++)e.push(this._points[(s+1)%this._points.length].sub(this._points[s]).normal());this._normals=e}get points(){return this._points}get transform(){return this._transform}constructor(e){var s;super(),this._logger=at.getInstance(),this._transform=new ws,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(s=e.offset)!==null&&s!==void 0?s:B.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=e.points,this.isConvex()||e.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(e){this._isCounterClockwiseWinding(e)||e.reverse()}_isCounterClockwiseWinding(e){let s=0;for(let r=0;r<e.length;r++)s+=(e[(r+1)%e.length].x-e[r].x)*(e[(r+1)%e.length].y+e[r].y);return s<0}isConvex(){if(this.points.length<3)return!1;let e=this.points[this.points.length-2],s=this.points[this.points.length-1],r=Math.atan2(s.y-e.y,s.x-e.x),a=0,l=0,f=0;for(const[p,m]of this.points.entries()){if(e=s,a=r,s=m,r=Math.atan2(s.y-e.y,s.x-e.x),e.equals(s))return!1;let w=r-a;if(w<=-Math.PI?w+=Math.PI*2:w>Math.PI&&(w-=Math.PI*2),p===0){if(w===0)return!1;l=w>0?1:-1}else if(l*w<=0)return!1;f+=w}return Math.abs(Math.round(f/(Math.PI*2)))===1}tessellate(){const e=[];for(let s=1;s<this.points.length-2;s++)e.push([this.points[0],this.points[s+1],this.points[s+2]]);return e.push([this.points[0],this.points[1],this.points[2]]),new Pe(e.map(s=>Ne.Polygon(s)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const e=[],s=[...this.points].reverse();let r=s.length;function a(y){return y===0?r-1:y-1}function l(y){return y===r-1?0:y+1}function f(y){const T=a(y),D=l(y),U=s[T],O=s[y],q=s[D],H=U.sub(O),W=q.sub(O);return!(H.cross(W)<0)}const p=s.map((y,T)=>f(T));function m(y,T,D,U){const O=D.sub(T),q=U.sub(D),H=T.sub(U),W=y.sub(T),J=y.sub(D),Y=y.sub(U),tt=O.cross(W),ot=q.cross(J),Q=H.cross(Y);return!(tt>0||ot>0||Q>0)}function w(){for(let y=0;y<r;y++)if(p[y]){const T=a(y),D=l(y),U=s[T],O=s[y],q=s[D];let H=!0;for(let W=0;W<r;W++){if(W===y||W===T||W===D)continue;const J=s[W];if(m(J,U,O,q)){H=!1;break}}if(H)return y}for(let y=0;y<r;y++)if(p[y])return y;return 0}function b(y){const T=a(y),D=l(y),U=s[T],O=s[y],q=s[D];e.push([U,O,q]),s.splice(y,1),p.splice(y,1),r--}for(;r>3;){const y=w();b(y);for(let T=0;T<r;T++)p[T]=f(T)}return e.push([s[0],s[1],s[2]]),new Pe(e.map(y=>Ne.Polygon(y,B.Zero,!0)))}clone(){return new Be({offset:this.offset.clone(),points:this.points.map(e=>e.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const e=this.points,s=e.length;this._transformedPoints.length=0;for(let r=0;r<s;r++)this._transformedPoints[r]=this._transform.apply(e[r].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const e=[],s=this.getTransformedPoints(),r=s.length;for(let a=0;a<r;a++)e.push(new ue(s[a],s[(a+1)%r]));this._sides=e,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const e=[],s=this.points,r=s.length;for(let a=0;a<r;a++)e.push(new ue(s[a],s[(a+1)%r]));this._localSides=e,this._localSidesDirty=!1}return this._localSides}findSide(e){const s=this.getSides();let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=s[l],m=f.normal().dot(e);m>a&&(r=f,a=m)}return r}findLocalSide(e){const s=this.getLocalSides();let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=s[l],m=f.normal().dot(e);m>a&&(r=f,a=m)}return r}get axes(){const e=[],s=this.getSides();for(let r=0;r<s.length;r++)e.push(s[r].normal());return e}update(e){e&&(e.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(s=>z(s.x*G(this._transform.scale.x),s.y*G(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(e){const s=this._transform.applyInverse(e),r=new gn(s,new B(1,0));let a=0;const l=this.getLocalSides();for(let f=0;f<l.length;f++){const p=l[f];r.intersect(p)>=0&&a++}return a%2!==0}getClosestLineBetween(e){if(e instanceof We)return Ji.PolygonCircleClosestLine(this,e);if(e instanceof Be)return Ji.PolygonPolygonClosestLine(this,e);if(e instanceof _i)return Ji.PolygonEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof We)return Hi.CollideCirclePolygon(e,this);if(e instanceof Be)return Hi.CollidePolygonPolygon(this,e);if(e instanceof _i)return Hi.CollidePolygonEdge(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this.getTransformedPoints();let r=null,a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=e.dot(s[l]);f>a&&(a=f,r=s[l])}return r}getFurthestLocalPoint(e){const s=this.points;let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=e.dot(s[l]);f>a&&(a=f,r=s[l])}return r}getClosestFace(e){const s=this.getSides();let r=Number.POSITIVE_INFINITY,a=-1,l=-1;for(let f=0;f<s.length;f++){const p=s[f].distanceToPoint(e);p<r&&(r=p,a=f,l=p)}return a!==-1?{distance:s[a].normal().scale(l),face:s[a]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=ht.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(e){if(this._cachedMass===e&&this._cachedInertia)return this._cachedInertia;let s=0,r=0;const a=this.points;for(let l=0;l<a.length;l++){const f=(l+1)%a.length,p=a[f].cross(a[l]);s+=p*(a[l].dot(a[l])+a[l].dot(a[f])+a[f].dot(a[f])),r+=p}return this._cachedMass=e,this._cachedInertia=e/6*(s/r)}rayCast(e,s=1/0){var r;const a=this.getSides(),l=a.length;let f=Number.MAX_VALUE,p,m=-1;for(let w=0;w<l;w++){const b=e.intersect(a[w]);b>=0&&b<f&&b<=s&&(f=b,p=a[w],m=w)}return m>=0?{collider:this,distance:f,body:(r=this.owner)===null||r===void 0?void 0:r.get(Et),point:e.getPoint(f),normal:p.normal()}:null}project(e){const s=this.getTransformedPoints(),r=s.length;let a=Number.MAX_VALUE,l=-Number.MAX_VALUE;for(let f=0;f<r;f++){const p=s[f].dot(e);a=Math.min(a,p),l=Math.max(l,p)}return new Ir(a,l)}debug(e,s,r){const a=this.getTransformedPoints();Ee.drawPolygon(a,{color:s})}}class Ne{static Box(e,s,r=B.Half,a=B.Zero){return new Be({points:new ht(-e*r.x,-s*r.y,e-e*r.x,s-s*r.y).getPoints(),offset:a})}static Polygon(e,s=B.Zero,r=!1){return new Be({points:e,offset:s,suppressConvexWarning:r})}static Circle(e,s=B.Zero){return new We({radius:e,offset:s})}static Edge(e,s){return new _i({begin:e,end:s})}static Capsule(e,s,r=B.Zero){const a=at.getInstance();return e===s&&a.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),s>=e?new Pe([Ne.Circle(e/2,z(0,-s/2+e/2).add(r)),Ne.Box(e,s-e,B.Half,r),Ne.Circle(e/2,z(0,s/2-e/2).add(r))]):new Pe([Ne.Circle(s/2,z(-e/2+s/2,0).add(r)),Ne.Box(e-s,s,B.Half,r),Ne.Circle(s/2,z(e/2-s/2,0).add(r))])}}class ve extends Ti{constructor(e){super(),this.events=new I,this.$colliderAdded=new Ze,this.$colliderRemoved=new Ze,this._collidersToRemove=[],this.set(e)}get(){return this._collider}set(e){return this.clear(),e&&(this._collider=e,this._collider.owner=this.owner,e.events.pipe(this.events),this.$colliderAdded.notifyAll(e),this.update()),e}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const e of this._collidersToRemove)e.events.unpipe(this.events),this.$colliderRemoved.notifyAll(e),e.owner=null}clone(){return new ve(this._collider.clone())}get bounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new ht}get localBounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new ht}update(){var e;const s=(e=this.owner)===null||e===void 0?void 0:e.get(it);this._collider&&(this._collider.owner=this.owner,s&&this._collider.update(s.get()))}collide(e){let s=this._collider,r=e._collider;if(!s||!r)return[];let a=!1;if(r instanceof Pe&&(s=r,r=this._collider,a=!0),this._collider){const l=s.collide(r);return l?(a&&l.forEach(f=>{f.mtv=f.mtv.negate(),f.normal=f.normal.negate(),f.tangent=f.normal.perpendicular(),f.colliderA=this._collider,f.colliderB=e._collider}),l):[]}return[]}onAdd(e){this._collider&&this.update(),this.events.on("precollision",s=>{const r=s;e.events.emit("precollision",new ln(r.self,r.other,r.side,r.intersection,r.contact)),e instanceof $e&&e.onPreCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("postcollision",s=>{const r=s;e.events.emit("postcollision",new cn(r.self,r.other,r.side,r.intersection,r.contact)),e instanceof $e&&e.onPostCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("collisionstart",s=>{const r=s;e.events.emit("collisionstart",new Sr(r.self,r.other,r.side,r.contact)),e instanceof $e&&e.onCollisionStart(r.self,r.other,r.side,r.contact)}),this.events.on("collisionend",s=>{const r=s;e.events.emit("collisionend",new Pr(r.self,r.other,r.side,r.lastContact)),e instanceof $e&&e.onCollisionEnd(r.self,r.other,r.side,r.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(e,s,r=B.Half,a=B.Zero){const l=Ne.Box(e,s,r,a);return this.set(l)}usePolygonCollider(e,s=B.Zero){const r=Ne.Polygon(e,s);return this.set(r)}useCircleCollider(e,s=B.Zero){const r=Ne.Circle(e,s);return this.set(r)}useEdgeCollider(e,s){const r=Ne.Edge(e,s);return this.set(r)}useCompositeCollider(e){return this.set(new Pe(e))}}var ri;(function(u){u.Rotation="rotation",u.X="x",u.Y="y"})(ri||(ri={}));class Et extends Ti{constructor(e){var s,r,a;super(),this.dependencies=[it,Bt],this.id=S("body",Et._ID++),this.events=new I,this.oldTransform=new ws,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=ft.PreventCollision,this.group=As.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=B.Zero,this.oldVel=new B(0,0),this.oldAcc=B.Zero,this._impulseScratch=z(0,0),this._distanceFromCenterScratch=z(0,0),e?(this.collisionType=(s=e.type)!==null&&s!==void 0?s:this.collisionType,this.group=(r=e.group)!==null&&r!==void 0?r:this.group,this.useGravity=(a=e.useGravity)!==null&&a!==void 0?a:this.useGravity,this._bodyConfig={...ys().bodies,...e.config}):this._bodyConfig={...ys().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=Et._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(e){this._bodyConfig={...ys().bodies,...e},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(e){Et._DEFAULT_CONFIG=e}get mass(){return this._mass}set mass(e){this._mass=e,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===ft.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(e){this.isSleeping=e}set isSleeping(e){this._sleeping=e,e?(this.vel=B.Zero,this.acc=B.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const e=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),s=this._bodyConfig.sleepBias;this.sleepMotion=s*this.sleepMotion+(1-s)*e,this.sleepMotion=j(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const e=this.owner.get(ve);if(e){e.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),e.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const s=e.get();if(s)return this._cachedInertia=s.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===ft.Fixed?0:1/this.inertia}get active(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get isActive(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get center(){return this.globalPos}onAdd(e){var s,r;this.transform=(s=this.owner)===null||s===void 0?void 0:s.get(it),this.motion=(r=this.owner)===null||r===void 0?void 0:r.get(Bt)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get globalPos(){return this.transform.globalPos}set globalPos(e){this.transform.globalPos=e}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e}get torque(){return this.motion.torque}set torque(e){this.motion.torque=e}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(e){this.transform.globalRotation=e}get scale(){return this.transform.globalScale}set scale(e){this.transform.globalScale=e}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(e){this.motion.scaleFactor=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}applyImpulse(e,s){if(this.collisionType!==ft.Active)return;const r=s.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(ri.X)>-1&&(r.x=0),this.limitDegreeOfFreedom.indexOf(ri.Y)>-1&&(r.y=0),this.vel.addEqual(r),!this.limitDegreeOfFreedom.includes(ri.Rotation)){const a=e.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*a.cross(s)}}applyLinearImpulse(e){if(this.collisionType!==ft.Active)return;const s=e.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(ri.X)&&(s.x=0),this.limitDegreeOfFreedom.includes(ri.Y)&&(s.y=0),this.vel=this.vel.add(s)}applyAngularImpulse(e,s){if(this.collisionType===ft.Active&&!this.limitDegreeOfFreedom.includes(ri.Rotation)){const r=e.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*r.cross(s)}}captureOldTransform(){this.__oldTransformCaptured=!0;const e=this.transform.get();e.clone(this.oldTransform),this.oldTransform.parent=e.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}Et._ID=0,Et._DEFAULT_CONFIG={...ys().bodies};class Dr extends Wn{constructor(e){super(e),this.width=e.width,this.height=e.height,this.rasterize()}clone(){return new Dr({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.color&&e.fillRect(0,0,this.width,this.height),this.strokeColor&&e.strokeRect(0,0,this.width,this.height)}}class Go extends Wn{get radius(){return this._radius}set radius(e){this._radius=e,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(e){var s,r,a;super(e),this._radius=0;const l=(s=e.lineWidth)!==null&&s!==void 0?s:e.strokeColor?1:0;this.padding=(r=e.padding)!==null&&r!==void 0?r:2+l/2,this.radius=e.radius,this.filtering=(a=e.filtering)!==null&&a!==void 0?a:_e.Blended,this.rasterize()}clone(){return new Go({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.radius>0&&(e.beginPath(),e.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&e.fill(),this.strokeColor&&e.stroke())}}class Xs extends Ti{constructor(e){var s,r;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(s=e?.useColliderShape)!==null&&s!==void 0?s:this.useColliderShape,this.useGraphicsBounds=(r=e?.useGraphicsBounds)!==null&&r!==void 0?r:this.useGraphicsBounds,this.localBounds=e?.localBounds}}class Nt{static CreateReversibleEasingFunction(e){return(s,r,a,l)=>a<r?r-(e(s,a,r,l)-a):e(s,r,a,l)}static CreateVectorEasingFunction(e){return(s,r,a,l)=>new B(e(s,r.x,a.x,l),e(s,r.y,a.y,l))}}Nt.Linear=Nt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,s*u/r+e)),Nt.EaseInQuad=Nt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,s*u*u+e)),Nt.EaseOutQuad=Nt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,-s*u*(u-2)+e)),Nt.EaseInOutQuad=Nt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r/2,u<1?s/2*u*u+e:(u--,-s/2*(u*(u-2)-1)+e))),Nt.EaseInCubic=Nt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,s*u*u*u+e)),Nt.EaseOutCubic=Nt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,u--,s*(u*u*u+1)+e)),Nt.EaseInOutCubic=Nt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r/2,u<1?s/2*u*u*u+e:(u-=2,s/2*(u*u*u+2)+e)));class Rd{constructor(e){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=e}add(e){this._actions.push(e)}remove(e){const s=this._actions.indexOf(e);this._actions.splice(s,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const e=this._actions.length;for(let s=0;s<e;s++)this._actions[s].reset();this._completedActions=[]}update(e){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new Eh(this._currentAction,this._entity))),this._currentAction.update(e),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new Th(this._currentAction,this._entity));const s=this._actions.shift();s&&this._completedActions.push(s)}}}let G_=0;function Ut(){return G_++}class Dd{constructor(e,s,r){this.id=Ut(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new Br(e),this._actionQueue=this._repeatContext.getQueue(),this._repeat=r,this._originalRepeat=r,this._repeatBuilder(this._repeatContext),this._repeat--}update(e){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(e)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class Fd{constructor(e,s){this.id=Ut(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new Br(e),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(e){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(e))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function Md(u,e,s){return(1-s)*u+e*s}function Wh(u,e,s,r){const a=(u-e+V)%V>=Math.PI,l=Math.abs(e-u),f=V-l;let p=0,m=0;l>f?(p=f,m=l):(p=l,m=f);let w=0,b=1;switch(s){case R.ShortestPath:w=p,b=a?1:-1;break;case R.LongestPath:w=m,b=a?-1:1;break;case R.Clockwise:b=1,w=a?p:m;break;case R.CounterClockwise:b=-1,w=a?m:p;break}return u+b*(w*r)}function Fr(u,e,s){return u.scale(1-s).add(e.scale(s))}function Bd(u,e,s){return(s-u)/(e-u)}function kd(u,e,s){const r=s.sub(u),a=e.sub(u),l=r.x/a.x,f=r.y/a.y;return Math.min(l,f)}function Ki(u,e,s,r,a){const l=Bd(u,e,a);return Md(s,r,l)}function X_(u,e,s,r,a){const l=kd(u,e,a);return Fr(s,r,l)}function Ld(u){return u.offset instanceof B&&typeof u.duration=="number"}class Ud{constructor(e,s){var r;if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._easing=Nt.Linear,this._offset=s.offset,this._easing=(r=s.easing)!==null&&r!==void 0?r:this._easing,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=e;const s=j(Ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),f=(a-r.x)/(e/1e3),p=(l-r.y)/(e/1e3);this._motion.vel.x=f,this._motion.vel.y=p,this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=z(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Nh{constructor(e,s,r,a){if(this.id=Ut(),this._started=!1,this._stopped=!1,this._entity=e,this._tx=e.get(it),this._motion=e.get(Bt),this._speed=a,this._offset=new B(s,r),a<=0)throw at.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+a),new Error("Speed must be greater than 0 pixels per second")}update(e){this._started||(this._started=!0,this._start=new B(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(e){const s=e.get(it);return this._stopped||s.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function zd(u){return u.pos instanceof B&&typeof u.duration=="number"}class Hd{constructor(e,s){var r;if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._easing=Nt.Linear,this._end=s.pos,this._easing=(r=s.easing)!==null&&r!==void 0?r:this._easing,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=e;const s=j(Ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),f=(a-r.x)/(e/1e3),p=(l-r.y)/(e/1e3);this._motion.vel.x=f,this._motion.vel.y=p,this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=z(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Gh{constructor(e,s,r,a){this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._end=new B(s,r),this._speed=a}update(e){this._started||(this._started=!0,this._start=new B(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const s=this._dir.scale(this._speed);this._motion.vel=z(s.x,s.y),this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){const s=e.get(it);return this._stopped||new B(s.pos.x,s.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function q_(u){return typeof u.angle=="number"&&typeof u.duration=="number"}class Od{constructor(e,s){var r;if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=s.angle,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(r=s.rotationType)!==null&&r!==void 0?r:R.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=e;const s=j(Ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Wh(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(r-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Vd{constructor(e,s,r,a){this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._end=s,this._speed=r,this._rotationType=a||R.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const s=Math.abs(this._end-this._start),r=V-s;switch(s>r?(this._shortDistance=r,this._longDistance=s):(this._shortDistance=s,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+V)%V>=Math.PI,this._rotationType){case R.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case R.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case R.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case R.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Y_(u){return typeof u.angleRadiansOffset=="number"&&typeof u.duration=="number"}class Wd{constructor(e,s){var r;if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=s.angleRadiansOffset,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(r=s.rotationType)!==null&&r!==void 0?r:R.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._endAngle=rt(this._startAngle+this._offset),this._started=!0),this._currentMs-=e;const s=j(Ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Wh(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(r-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Nd{constructor(e,s,r,a){this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._speed=r,this._offset=s,this._rotationType=a||R.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const s=Math.abs(this._end-this._start),r=V-s;switch(s>r?(this._shortDistance=r,this._longDistance=s):(this._shortDistance=s,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+V)%V>=Math.PI,this._rotationType){case R.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case R.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case R.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case R.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function Gd(u){return typeof u.scale=="object"&&typeof u.duration=="number"}class Xd{constructor(e,s){if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._endScale=z(1,1),this._startScale=z(1,1),this._endScale=s.scale,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=e;const s=j(Ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Fr(this._startScale,this._endScale,s),a=this._tx.scale,l=r.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=B.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class qd{constructor(e,s,r,a,l){this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._endX=s,this._endY=r,this._speedX=a,this._speedY=l}update(e){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*s}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*s}this.isComplete()&&(this._tx.scale=z(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Yd(u){return typeof u.scaleOffset=="object"&&typeof u.duration=="number"}class jd{constructor(e,s){if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._endScale=z(1,1),this._scaleOffset=z(0,0),this._startScale=z(1,1),this._scaleOffset=s.scaleOffset,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=e;const s=j(Ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Fr(this._startScale,this._endScale,s),a=this._tx.scale,l=r.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=B.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Qd{constructor(e,s,r,a){this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._offset=new B(s,r),this._speedX=this._speedY=a}update(e){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Zd{constructor(e){this.id=Ut(),this._hasBeenCalled=!1,this._method=e}update(e){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class Jd{constructor(e,s,r,a,l){this.easingFcn=l,this.id=Ut(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new B(0,0),this._lerpEnd=new B(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._lerpDuration=a,this._lerpEnd=new B(s,r)}_initialize(){this._lerpStart=new B(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=z((s-this._tx.pos.x)/(e/1e3),(r-this._tx.pos.y)/(e/1e3))):(this._tx.pos=z(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=B.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=z(0,0),this._stopped=!0}}class Kd{constructor(e,s,r,a,l){this.easingFcn=l,this.id=Ut(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new B(0,0),this._lerpEnd=new B(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._lerpDuration=a,this._offset=new B(s,r)}_initialize(){this._lerpStart=new B(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=z((s-this._tx.pos.x)/(e/1e3),(r-this._tx.pos.y)/(e/1e3))):(this._tx.pos=z(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=B.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=z(0,0),this._stopped=!0}}class $d{constructor(e,s,r,a=1){this.id=Ut(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=e.get(re),this._timeVisible=s,this._timeNotVisible=r,this._duration=(s+r)*a}update(e){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=e,this._totalTime+=e,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class tu{constructor(e,s,r){this.id=Ut(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=e.get(re),this._endOpacity=s,this._remainingTime=this._originalTime=r}update(e){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*e)/this._remainingTime),this._remainingTime-=e,this.isComplete()&&(this._graphics.opacity=this._endOpacity),at.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class eu{constructor(e){this.id=Ut(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=e}update(e){this._started||(this._started=!0),this._elapsedTime+=e}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class iu{constructor(e){this.id=Ut(),this._stopped=!1,this._entity=e}update(e){this._entity.get(jn).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class Xh{constructor(e,s,r){this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._followTx=s.get(it),this._followMotion=s.get(Bt),this._current=new B(this._tx.pos.x,this._tx.pos.y),this._end=new B(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=r!==void 0?r:this._current.distance(this._end),this._speed=0}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(s!==0&&(this._speed=s),this._current=z(this._tx.pos.x,this._tx.pos.y),this._end=z(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const r=this._dir.scale(this._speed);this._motion.vel=z(r.x,r.y)}else this._motion.vel=z(0,0);this.isComplete()&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}stop(){this._motion.vel=z(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class qh{constructor(e,s,r){this.id=Ut(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._meetTx=s.get(it),this._meetMotion=s.get(Bt),this._current=new B(this._tx.pos.x,this._tx.pos.y),this._end=new B(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=r||0,r!==void 0&&(this._speedWasSpecified=!0)}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));s!==0&&!this._speedWasSpecified&&(this._speed=s),this._current=z(this._tx.pos.x,this._tx.pos.y),this._end=z(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const r=this._dir.scale(this._speed);this._motion.vel=z(r.x,r.y),this.isComplete()&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class su{constructor(e,s,r=1e3){var a;this.id=Ut(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=e.get(re),this._duration=r,this._entity=e,this._material=(a=e.scene)===null||a===void 0?void 0:a.engine.graphicsContext.createMaterial({name:"flash-material",color:s,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=r}update(e){var s;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=e,this._graphics&&((s=this._material)===null||s===void 0||s.update(r=>{r.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Mr{constructor(e){var s;if(this._distLookup=[],this.quality=4,e.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...e.controlPoints],this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(e){this._controlPoints=[...e],this._calculateLookup()}setControlPoint(e,s){this._controlPoints[e]=s,this._calculateLookup()}_calculateLookup(){let e=0;this._distLookup.length=0;let s=this.controlPoints[0];const r=this.controlPoints.length*this.quality;for(let a=0;a<r;a++){const l=a/(r-1),f=this.getPoint(l),p=s.distance(f);e+=p,this._distLookup.push(e),s=f}this._arcLength=e}_getTimeGivenDistance(e){const s=this._distLookup.length,r=this.arcLength;if(e>=0&&e<r){for(let a=0;a<s-1;a++)if(this._distLookup[a]<=e&&e<this._distLookup[a+1])return Ki(this._distLookup[a],this._distLookup[a+1],a/(s-1),(a+1)/(s-1),e)}return e/r}getPoint(e){const s=[...this.controlPoints];for(let r=1;r<s.length;r++)for(let a=0;a<s.length-r;a++)s[a]=Fr(s[a],s[a+1],e);return s[0]}getTangent(e){const s=e*e,r=this.controlPoints[0],a=this.controlPoints[1],l=this.controlPoints[2],f=this.controlPoints[3];return r.scale(-3*s+6*e-3).add(a.scale(9*s-12*e+3).add(l.scale(-9*s+6*e).add(f.scale(3*s)))).normalize()}getUniformTangent(e){const s=e*this.arcLength,r=this._getTimeGivenDistance(s);return this.getTangent(r)}getNormal(e){return this.getTangent(e).normal()}getUniformNormal(e){return this.getUniformTangent(e).normal()}getUniformPoint(e){const s=e*this.arcLength,r=this._getTimeGivenDistance(s);return this.getPoint(r)}clone(){return new Mr({controlPoints:[...this.controlPoints],quality:this.quality})}}class nu{constructor(e,s){var r;if(this.id=Ut(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(it),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new Mr({controlPoints:[z(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(r=s.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=e;const s=j(Ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class ru{constructor(e,s){var r;if(this.id=Ut(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(it),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new Mr({controlPoints:[z(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(r=s.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=e;const s=j(Ki(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class Br{constructor(e){this._entity=e,this._queue=new Rd(e)}getQueue(){return this._queue}update(e){this._queue.update(e)}clearActions(){this._queue.clearActions()}runAction(e){return e.reset(),this._queue.add(e),this}curveBy(e){return this._queue.add(new ru(this._entity,e)),this}curveTo(e){return this._queue.add(new nu(this._entity,e)),this}easeTo(...e){var s,r;let a=0,l=0,f=0,p=Nt.Linear;return e[0]instanceof B?(a=e[0].x,l=e[0].y,f=e[1],p=(s=e[2])!==null&&s!==void 0?s:p):(a=e[0],l=e[1],f=e[2],p=(r=e[3])!==null&&r!==void 0?r:p),this._queue.add(new Jd(this._entity,a,l,f,p)),this}easeBy(...e){var s,r;let a=0,l=0,f=0,p=Nt.Linear;return e[0]instanceof B?(a=e[0].x,l=e[0].y,f=e[1],p=(s=e[2])!==null&&s!==void 0?s:p):(a=e[0],l=e[1],f=e[2],p=(r=e[3])!==null&&r!==void 0?r:p),this._queue.add(new Kd(this._entity,a,l,f,p)),this}moveTo(e,s,r){let a=0,l=0,f=0;return e instanceof B?(a=e.x,l=e.y,f=+(s??0),this._queue.add(new Gh(this._entity,a,l,f))):typeof e=="number"&&typeof s=="number"&&typeof r=="number"?(a=e,l=s,f=r,this._queue.add(new Gh(this._entity,a,l,f))):zd(e)&&this._queue.add(new Hd(this._entity,e)),this}moveBy(e,s,r){let a=0,l=0,f=0;return e instanceof B&&typeof s=="number"?(a=e.x,l=e.y,f=s,this._queue.add(new Nh(this._entity,a,l,f))):typeof e=="number"&&typeof s=="number"&&typeof r=="number"?(a=e,l=s,f=r,this._queue.add(new Nh(this._entity,a,l,f))):Ld(e)&&this._queue.add(new Ud(this._entity,e)),this}rotateTo(e,s,r){return typeof e=="number"&&typeof s=="number"?this._queue.add(new Vd(this._entity,e,s,r)):typeof e=="object"&&this._queue.add(new Od(this._entity,e)),this}rotateBy(e,s,r){return typeof e=="object"?this._queue.add(new Wd(this._entity,e)):this._queue.add(new Nd(this._entity,e,s,r)),this}scaleTo(e,s,r,a){let l=1,f=1,p=0,m=0;return Gd(e)?(this._queue.add(new Xd(this._entity,e)),this):(e instanceof B&&s instanceof B&&(l=e.x,f=e.y,p=s.x,m=s.y),typeof e=="number"&&typeof s=="number"&&(l=e,f=s,p=r,m=a),this._queue.add(new qd(this._entity,l,f,p,m)),this)}scaleBy(e,s,r){if(Yd(e))return this._queue.add(new jd(this._entity,e)),this;let a=1,l=1;return e instanceof B&&(a=e.x,l=e.y,r=s),typeof e=="number"&&typeof s=="number"&&(a=e,l=s),this._queue.add(new Qd(this._entity,a,l,r)),this}blink(e,s,r=1){return this._queue.add(new $d(this._entity,e,s,r)),this}fade(e,s){return this._queue.add(new tu(this._entity,e,s)),this}flash(e,s=1e3){return this._queue.add(new su(this._entity,e,s)),this}delay(e){return this._queue.add(new eu(e)),this}die(){return this._queue.add(new iu(this._entity)),this}callMethod(e){return this._queue.add(new Zd(e)),this}repeat(e,s){return s?(this._queue.add(new Dd(this._entity,e,s)),this):(this.repeatForever(e),this)}repeatForever(e){return this._queue.add(new Fd(this._entity,e)),this}follow(e,s){return s===void 0?this._queue.add(new Xh(this._entity,e)):this._queue.add(new Xh(this._entity,e,s)),this}meet(e,s){return s===void 0?this._queue.add(new qh(this._entity,e)):this._queue.add(new qh(this._entity,e,s)),this}toPromise(){return new Promise(s=>{this._queue.add(new Zd(()=>{s()}))})}}class jn extends Ti{constructor(){super(...arguments),this.dependencies=[it,Bt],this._ctx=null}onAdd(e){this._ctx=new Br(e)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(e){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(e)}update(e){var s;return(s=this._ctx)===null||s===void 0?void 0:s.update(e)}clearActions(){var e;(e=this._ctx)===null||e===void 0||e.clearActions()}curveBy(e){return this._getCtx().curveBy.apply(this._ctx,[e])}curveTo(e){return this._getCtx().curveTo.apply(this._ctx,[e])}easeTo(...e){return this._getCtx().easeTo.apply(this._ctx,e)}easeBy(...e){return this._getCtx().easeBy.apply(this._ctx,e)}moveTo(e,s,r){return this._getCtx().moveTo.apply(this._ctx,[e,s,r])}moveBy(e,s,r){return this._getCtx().moveBy.apply(this._ctx,[e,s,r])}rotateTo(e,s,r){return this._getCtx().rotateTo.apply(this._ctx,[e,s,r])}rotateBy(e,s,r){return this._getCtx().rotateBy.apply(this._ctx,[e,s,r])}scaleTo(e,s,r,a){return this._getCtx().scaleTo.apply(this._ctx,[e,s,r,a])}scaleBy(e,s,r){return this._getCtx().scaleBy.apply(this._ctx,[e,s,r])}blink(e,s,r){return this._getCtx().blink(e,s,r)}fade(e,s){return this._getCtx().fade(e,s)}flash(e,s=1e3){return this._getCtx().flash(e,s)}delay(e){return this._getCtx().delay(e)}die(){return this._getCtx().die()}callMethod(e){return this._getCtx().callMethod(e)}repeat(e,s){return this._getCtx().repeat(e,s)}repeatForever(e){return this._getCtx().repeatForever(e)}follow(e,s){return this._getCtx().follow(e,s)}meet(e,s){return this._getCtx().meet(e,s)}toPromise(){return this._getCtx().toPromise()}}function j_(u){return u instanceof $e}const Q_={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class $e extends Ve{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(e){this.body.oldPos.setTo(e.x,e.y)}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e.clone()}get oldVel(){return this.body.oldVel}set oldVel(e){this.body.oldVel.setTo(e.x,e.y)}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e.clone()}set oldAcc(e){this.body.oldAcc.setTo(e.x,e.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(e){this.transform.rotation=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}get scale(){return this.get(it).scale}set scale(e){this.get(it).scale=e}get anchor(){return this._anchor}set anchor(e){this._anchor=Mi(e,s=>this._handleAnchorChange(s)),this._handleAnchorChange(e)}_handleAnchorChange(e){this.graphics&&(this.graphics.anchor=e)}get offset(){return this._offset}set offset(e){this._offset=Mi(e,s=>this._handleOffsetChange(s)),this._handleOffsetChange(e)}_handleOffsetChange(e){this.graphics&&(this.graphics.offset=e)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(e){e&&(e&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!e&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=e)}get color(){return this.graphics.color}set color(e){this.graphics.color=e}constructor(e){super(),this.events=new I,this._anchor=Mi(B.Half,It=>this._handleAnchorChange(It)),this._offset=Mi(B.Zero,It=>this._handleOffsetChange(It)),this.logger=at.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=It=>{this._dragging&&(this.pos=It.worldPos)},this._pointerDragLeaveHandler=It=>{this._dragging&&(this.pos=It.worldPos)};const{name:s,x:r,y:a,pos:l,coordPlane:f,scale:p,width:m,height:w,radius:b,collider:y,vel:T,acc:D,rotation:U,angularVelocity:O,z:q,color:H,visible:W,opacity:J,anchor:Y,offset:tt,collisionType:ot,collisionGroup:Q,silenceWarnings:_t}={...e};this.name=s??this.name,this.anchor=Y??$e.defaults.anchor.clone(),this.offset=tt??B.Zero,this.transform=new it,this.addComponent(this.transform),this.pos=l??z(r??0,a??0),this.rotation=U??0,this.scale=p??z(1,1),this.z=q??0,this.transform.coordPlane=f??Me.World,this._silenceWarnings=_t??!1,this.pointer=new Xs,this.addComponent(this.pointer),this.graphics=new re({anchor:this.anchor,offset:this.offset,opacity:J}),this.addComponent(this.graphics),this.motion=new Bt,this.addComponent(this.motion),this.vel=T??B.Zero,this.acc=D??B.Zero,this.angularVelocity=O??0,this.actions=new jn,this.addComponent(this.actions),this.body=new Et,this.addComponent(this.body),this.body.collisionType=ot??ft.Passive,Q&&(this.body.group=Q),H&&(this.color=H),y?(this.collider=new ve(y),this.addComponent(this.collider)):b?(this.collider=new ve(Ne.Circle(b)),this.addComponent(this.collider),H&&this.graphics.add(new Go({color:H,radius:b}))):m>0&&w>0?(this.collider=new ve(Ne.Box(m,w,this.anchor)),this.addComponent(this.collider),H&&m&&w&&this.graphics.add(new Dr({color:H,width:m,height:w}))):(this.collider=new ve,this.addComponent(this.collider)),this.graphics.isVisible=W??!0}clone(){const e=new $e({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});e.clearComponents(),e.processComponentRemoval(),e.addComponent(e.transform=this.transform.clone(),!0),e.addComponent(e.pointer=this.pointer.clone(),!0),e.addComponent(e.graphics=this.graphics.clone(),!0),e.addComponent(e.motion=this.motion.clone(),!0),e.addComponent(e.actions=this.actions.clone(),!0),e.addComponent(e.body=this.body.clone(),!0),e.addComponent(e.collider=this.collider.clone(),!0);const s=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],r=this.getComponents();for(const a of r)s.includes(a)||e.addComponent(a.clone(),!0);return e}onInitialize(e){}_initialize(e){super._initialize(e);for(const s of this.children)s._initialize(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_prekill(e){this.events.emit("prekill",new rh(this)),this.onPreKill(e)}onPreKill(e){}_postkill(e){this.events.emit("postkill",new oh(this)),this.onPostKill(e)}onPostKill(e){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new Bo(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(it).z}set z(e){this.get(it).z=e}get center(){const e=this.getGlobalPos();return new B(e.x+this.width/2-this.anchor.x*this.width,e.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new B(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(it).globalRotation}get globalRotation(){return this.get(it).globalRotation}getGlobalPos(){return this.get(it).globalPos}get globalPos(){return this.get(it).globalPos}getGlobalScale(){return this.get(it).globalScale}get globalScale(){return this.get(it).globalScale}get globalZ(){return this.get(it).globalZ}contains(e,s,r=!1){const a=z(e,s),l=this.get(ve);l.update();const f=l.get();if(!f)return!1;const p=f.contains(a);return r?p||this.children.some(m=>m.contains(e,s,!0)):p}within(e,s){const r=this.get(ve),a=e.get(ve),l=r.get(),f=a.get();return l&&f?l.getClosestLineBetween(f).getLength()<=s:!1}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s),this._postupdate(e,s),this._remove(e)}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreCollisionResolve(e,s,r,a){}onPostCollisionResolve(e,s,r,a){}onCollisionStart(e,s,r,a){}onCollisionEnd(e,s,r,a){}_preupdate(e,s){this.events.emit("preupdate",new Ws(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new Ns(e,s,this)),this.onPostUpdate(e,s)}}$e.defaults={anchor:B.Half};function ou(u){return u instanceof Yh}class Yh extends $e{constructor(e){var s,r;super({...e}),this.get(it).coordPlane=Me.Screen,this.anchor=(s=e?.anchor)!==null&&s!==void 0?s:z(0,0),this.body.collisionType=(r=e?.collisionType)!==null&&r!==void 0?r:ft.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!e?.collider&&e?.width>0&&e?.height>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(e){this._engine=e,super._initialize(e)}contains(e,s,r=!0){if(r)return super.contains(e,s);const a=this._engine.worldToScreenCoordinates(new B(e,s));return super.contains(a.x,a.y)}}class _n{get complete(){return this._complete}constructor(e){var s;this._logger=at.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const r=(s=e.action)!==null&&s!==void 0?s:e.fcn,a=e.interval,l=e.repeats,f=e.numberOfRepeats,p=e.randomRange,m=e.random;if(f&&f>=0&&(this.maxNumberOfRepeats=f,!l))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=_n._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=a,p){if(p[0]>p[1])throw new Error("min value must be lower than max value for range");this.random=m??new M,this.randomRange=p,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=l||this.repeats,r&&this.on(r)}on(e){this._callbacks.push(e)}off(e){const s=this._callbacks.indexOf(e);this._callbacks.splice(s,1)}update(e){this._running&&(this._totalTimeAlive+=e,this._elapsedTime+=e,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(s=>{s.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(e,s){if(e&&e>=0&&(this._baseInterval=this.interval=e),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=s,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}_n._MAX_ID=0;class Xo extends Ti{constructor(e){super(),this.parallaxFactor=z(1,1),this.parallaxFactor=e??this.parallaxFactor}}class qo extends Ti{constructor(e,s=!0){super(),this.draw=e,this.useTransform=s}}function au(u){return u&&u._dispatchPointerEvents&&u._processPointerToObject}class Z_{get events(){return this.object.events}init(e,s,r){this.object=e,this.contains=s,this.active=r}}class jh{constructor(){this._proxyPool=new wr(()=>new Z_,e=>e,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(e,s,r){const a=this._proxyPool.rent(!1);a.init(e,s,r),this._proxies.push(a),this._objectToProxy.set(e,a)}_getProxy(e){const s=this._objectToProxy.get(e);if(s)return s;throw new Error("No PointerTargetProxy for object")}removeObject(e){const s=this._objectToProxy.get(e);if(s){const r=this._proxies.indexOf(s);r>-1&&this._proxies.splice(r,1),this._proxyPool.return(s)}}_objectCurrentlyUnderPointer(e,s){return!!(this._currentFrameObjectToPointers.has(e)&&this._currentFrameObjectToPointers.get(e).includes(s))}_objectWasUnderPointer(e,s){return!!(this._lastFrameObjectToPointers.has(e)&&this._lastFrameObjectToPointers.get(e).includes(s))}_entered(e,s){return this._objectCurrentlyUnderPointer(e,s)&&!this._lastFrameObjectToPointers.has(e)}_left(e,s){return!this._currentFrameObjectToPointers.has(e)&&this._objectWasUnderPointer(e,s)}addPointerToObject(e,s){const r=this._objectToProxy.get(e);r&&this._addPointerToProxy(r,s)}_addPointerToProxy(e,s){if(!this._currentFrameObjectToPointers.has(e)){this._currentFrameObjectToPointers.set(e,[s]);return}const r=this._currentFrameObjectToPointers.get(e);this._currentFrameObjectToPointers.set(e,r.concat(s))}dispatchEvents(e,s){const r=new Set(this._lastFrameObjectToPointers.keys()),a=new Set(this._currentFrameObjectToPointers.keys());let l,f,p;for(let m=0;m<s.length;m++){const w=s[m],b=this._getProxy(w);if(au(w)&&w._dispatchPointerEvents(e),r.has(b)||a.has(b)){p=this._processDownAndEmit(e,b),f=this._processUpAndEmit(e,b),l=this._processMoveAndEmit(e,b);const y=[...l.values(),...p.values(),...f.values()];this._processEnterLeaveAndEmit(e,b,y),this._processCancelAndEmit(e,b),this._processWheelAndEmit(e,b)}}}processPointerToObject(e,s){for(let r=0;r<s.length;r++){const a=s[r],l=this._getProxy(a);au(a)&&a._processPointerToObject(e);for(const[f,p]of e.currentFramePointerCoords.entries())l.contains(p)&&this._addPointerToProxy(l,f)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(e,s){const r=new Map;for(const a of e.currentFrameDown)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerdown",a),e.isDragStart(a.pointerId)&&s.events.emit("pointerdragstart",a)),r.set(a.pointerId,a);return r}_processUpAndEmit(e,s){const r=new Map;for(const a of e.currentFrameUp)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerup",a),e.isDragEnd(a.pointerId)&&s.events.emit("pointerdragend",a)),r.set(a.pointerId,a);return r}_processMoveAndEmit(e,s){const r=new Map;for(const a of e.currentFrameMove)a.active&&s.active()&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointermove",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragmove",a)),r.set(a.pointerId,a);return r}_processEnterLeaveAndEmit(e,s,r){for(const a of r){if(a.active&&s.active()&&this._entered(s,a.pointerId)){s.events.emit("pointerenter",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragenter",a);break}if(a.active&&s.active()&&(this._left(s,a.pointerId)||this._objectCurrentlyUnderPointer(s,a.pointerId)&&a.type==="up")){s.events.emit("pointerleave",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragleave",a);break}}}_processCancelAndEmit(e,s){for(const r of e.currentFrameCancel)r.active&&s.active()&&this._objectCurrentlyUnderPointer(s,r.pointerId)&&s.events.emit("pointercancel",r)}_processWheelAndEmit(e,s){for(const r of e.currentFrameWheel)r.active&&s.active()&&this._objectCurrentlyUnderPointer(s,0)&&s.events.emit("pointerwheel",r)}}const J_={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class hu extends Ve{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let e=0;e<this.tiles.length;e++)this.tiles[e]&&this.tiles[e].flagDirty()}get x(){var e;return(e=this.transform.pos.x)!==null&&e!==void 0?e:0}set x(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.get(it).pos=z(e,this.y))}get y(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.pos.y)!==null&&s!==void 0?s:0}set y(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.transform.pos=z(this.x,e))}get z(){var e;return(e=this.transform.z)!==null&&e!==void 0?e:0}set z(e){this.transform&&(this.transform.z=e)}get rotation(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.rotation)!==null&&s!==void 0?s:0}set rotation(e){this.transform&&(this.transform.rotation=e)}get scale(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.scale)!==null&&s!==void 0?s:B.One}set scale(e){var s;!((s=this.transform)===null||s===void 0)&&s.scale&&(this.transform.scale=e)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get vel(){return this._motion.vel}set vel(e){this._motion.vel=e}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,r,a;super([],e.name),this.events=new I,this._token=0,this.logger=at.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(s=e.meshingLookBehind)!==null&&s!==void 0?s:this.meshingLookBehind,this.addComponent(new it),this.addComponent(new Bt),this.addComponent(new Et({type:ft.Fixed})),this.addComponent(new re({onPostDraw:(f,p)=>this.draw(f,p)})),this.addComponent(new qo((f,p)=>this.debug(f,p),!1)),this.addComponent(new ve),this.addComponent(new Xs),this.pointer=this.get(Xs),this._graphics=this.get(re),this.transform=this.get(it),this._motion=this.get(Bt),this.collider=this.get(ve),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(r=e.pos)!==null&&r!==void 0?r:B.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(a=e.renderFromTopOfGraphic)!==null&&a!==void 0?a:this.renderFromTopOfGraphic,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight,this.rows=e.rows,this.columns=e.columns,this._pointerEventDispatcher=new jh,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let l=[];for(let f=0;f<this.columns;f++){for(let p=0;p<this.rows;p++){const m=new lu({x:f,y:p,map:this});m.map=this,this.tiles[f+p*this.columns]=m,this._pointerEventDispatcher.addObject(m,w=>m.bounds.contains(w.worldPos),()=>!0),l.push(m),this._rows[p]||(this._rows[p]=[]),this._rows[p].push(m)}this._cols[f]=l,l=[]}this._graphics.localBounds=new ht({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(e){super._initialize(e),this._engine=e}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:B.Zero;{const r=e.offset;return this._originalOffsets.set(e,r),r}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const e=[];this._composite=this.collider.useCompositeCollider([]);let s=null;const r=(l,f)=>l&&f?l.top===f.top&&l.bottom===f.bottom&&l.right===f.left:!1,a=(l,f,p=this.meshingLookBehind)=>{if(!l)return!1;for(let m=f.length-1;m>=0;m--){if(p--<0)return!1;const w=f[m];if(r(w,l))return f[m]=w.combine(l),!0}return!1};for(let l=0;l<this.columns;l++){for(let f=0;f<this.rows;f++){const p=this.tiles[l+f*this.columns];if(p.solid)if(p.getColliders().length>0){for(const m of p.getColliders()){const w=this._getOrSetColliderOriginalOffset(m);m.offset=z(p.x*this.tileWidth*this.scale.x,p.y*this.tileHeight*this.scale.y).add(w),m.owner=this,this._composite.addCollider(m)}s&&!a(s,e)&&e.push(s),s=null}else s?s=s.combine(p.defaultGeometry):s=p.defaultGeometry;else s&&!a(s,e)&&e.push(s),s=null}s&&!a(s,e)&&e.push(s),s=null}for(const l of e){const f=Ne.Box(l.width,l.height,B.Zero,z(l.left-this.pos.x,l.top-this.pos.y));f.owner=this,this._composite.addCollider(f)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(e){var s;return(s=this.tiles[e])!==null&&s!==void 0?s:null}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const{x:s,y:r}=this._getTileCoordinates(e),a=this.getTile(s,r);return s>=0&&r>=0&&s<this.columns&&r<this.rows&&a?a:null}_getTileCoordinates(e){e=this.transform.applyInverse(e);const s=Math.floor(e.x/this.tileWidth),r=Math.floor(e.y/this.tileHeight);return{x:s,y:r}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let e=this._engine.screen.getWorldBounds();const s=this.get(Xo);if(s&&this.isInitialized){let D=this.pos;const U=B.One.sub(s.parallaxFactor),O=this._engine.currentScene.camera.pos.scale(U);D=D.sub(O),e=e.translate(D)}const r=this.transform.coordPlane===Me.Screen?this._engine.screen.getScreenBounds():e,a=this._getTileCoordinates(r.topLeft),l=this._getTileCoordinates(r.topRight),f=this._getTileCoordinates(r.bottomRight),p=this._getTileCoordinates(r.bottomLeft),m=Math.min(j(a.x,0,this.columns-1),j(l.x,0,this.columns-1)),w=Math.min(j(a.y,0,this.rows-1),j(l.y,0,this.rows-1)),b=Math.max(j(f.x,0,this.columns-1),j(p.x,0,this.columns-1)),y=Math.max(j(f.y,0,this.rows-1),j(p.y,0,this.rows-1)),T=[];for(let D=m;D<=b;D++)for(let U=w;U<=y;U++)T.push(this.getTile(D,U));return T}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(e,s){this._initialize(e),this.onPreUpdate(e,s),this.emit("preupdate",new Ws(e,s,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(e,s),this.emit("postupdate",new Ns(e,s,this))}draw(e,s){if(!this.isInitialized)return;this.emit("predraw",new Gn(e,s,this));let r,a,l;const f=this.getOnScreenTiles();for(let p=0;p<f.length;p++){const m=f[p],w=m.getGraphicsOffsets();for(r=m.getGraphics(),a=0,l=r.length;a<l;a++){const b=r[a],y=w[a];if(b){nh(b)&&b?.tick(s,this._token);const T=this.renderFromTopOfGraphic?0:b.height-this.tileHeight;b.draw(e,m.x*this.tileWidth+y.x,m.y*this.tileHeight-T+y.y)}}}this.emit("postdraw",new Xn(e,s,this))}debug(e,s){const{showAll:r,showGrid:a,gridColor:l,gridWidth:f,showSolidBounds:p,solidBoundsColor:m,showColliderGeometry:w}=s.tilemap,{geometryColor:b,geometryLineWidth:y,geometryPointSize:T}=s.collider,D=this.tileWidth*this.columns*this.scale.x,U=this.tileHeight*this.rows*this.scale.y,O=this.pos;if(a||r){for(let q=0;q<this.rows+1;q++){const H=z(0,q*this.tileHeight*this.scale.y);e.drawLine(O.add(H),O.add(z(D,H.y)),l,f)}for(let q=0;q<this.columns+1;q++){const H=z(q*this.tileWidth*this.scale.x,0);e.drawLine(O.add(H),O.add(z(H.x,U)),l,f)}}if(r||p||w){const q=this._composite.getColliders();e.save(),e.translate(this.pos.x,this.pos.y),e.scale(this.scale.x,this.scale.y);for(const H of q){const W=H.localBounds,J=H.worldPos.sub(this.pos);p&&e.drawRectangle(J,W.width,W.height,m)}if(e.restore(),w)for(const H of q)H.debug(e,b,{lineWidth:y,pointSize:T})}if(r||p){if(e.save(),e.z=999,p)for(let q=0;q<this.tiles.length;q++)this.tiles[q].bounds.draw(e);e.restore()}}}class lu{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(e){var s;(s=this.map)===null||s===void 0||s.flagCollidersDirty(),this._solid=e}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(e,s){this._graphics.push(e),s?.offset?this._offsets.push(s.offset):this._offsets.push(B.Zero)}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&(this._graphics.splice(s,1),this._offsets.splice(s,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(e){var s,r;this._posDirty=!1,this.events=new I,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=e.x,this.y=e.y,this.map=e.map,this._width=e.map.tileWidth*this.map.scale.x,this._height=e.map.tileHeight*this.map.scale.y,this.solid=(s=e.solid)!==null&&s!==void 0?s:this.solid,this._graphics=(r=e.graphics)!==null&&r!==void 0?r:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const e=this.map.pos.add(z(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new ht(e.x,e.y,e.x+this.map.tileWidth,e.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(z(this.x*this._width,this.y*this._height)),this._bounds=new ht(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new B(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}class cu{constructor(e){this.camera=e}lockToActor(e){this.camera.addStrategy(new du(e))}lockToActorAxis(e,s){this.camera.addStrategy(new uu(e,s))}elasticToActor(e,s,r){this.camera.addStrategy(new fu(e,s,r))}radiusAroundActor(e,s){this.camera.addStrategy(new gu(e,s))}limitCameraBounds(e){this.camera.addStrategy(new pu(e))}}var Yo;(function(u){u[u.X=0]="X",u[u.Y=1]="Y"})(Yo||(Yo={}));class du{constructor(e){this.target=e,this.action=(s,r,a,l)=>s.center}}class uu{constructor(e,s){this.target=e,this.axis=s,this.action=(r,a,l,f)=>{const p=r.center,m=a.getFocus();return this.axis===Yo.X?new B(p.x,m.y):new B(m.x,p.y)}}}class fu{constructor(e,s,r){this.target=e,this.cameraElasticity=s,this.cameraFriction=r,this.action=(a,l,f,p)=>{const m=a.center;let w=l.getFocus(),b=l.vel.clone();const y=m.sub(w).scale(this.cameraElasticity);b=b.add(y);const T=b.scale(-1).scale(this.cameraFriction);return b=b.add(T),w=w.add(b),w}}}class gu{constructor(e,s){this.target=e,this.radius=s,this.action=(r,a,l,f)=>{const p=r.center,m=a.getFocus(),w=p.sub(m),b=w.magnitude;if(b>=this.radius){const y=b-this.radius;return m.add(w.normalize().scale(y))}return m}}}class pu{constructor(e){this.target=e,this.boundSizeChecked=!1,this.action=(s,r,a,l)=>{const f=r.getFocus();this.boundSizeChecked||((s.bottom-s.top<a.drawHeight||s.right-s.left<a.drawWidth)&&at.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let p=f.x,m=f.y;return f.x<s.left+a.halfDrawWidth?p=s.left+a.halfDrawWidth:f.x>s.right-a.halfDrawWidth&&(p=s.right-a.halfDrawWidth),f.y<s.top+a.halfDrawHeight?m=s.top+a.halfDrawHeight:f.y>s.bottom-a.halfDrawHeight&&(m=s.bottom-a.halfDrawHeight),z(p,m)}}}const K_={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class _u{constructor(){this.events=new I,this.transform=pe.identity(),this.inverse=pe.identity(),this._cameraStrategies=[],this.strategy=new cu(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new Vs(B.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=B.Zero,this.acc=B.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Nt.EaseInOutCubic,this._easing=Nt.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=z(0,0)}get zoom(){return this._z}set zoom(e){this._z=e,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(e){this._angularVelocity=e}get pos(){return this._pos}set pos(e){this._posChanged=!0,this._pos=new Vs(e,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(e){!this._follow&&!this._cameraMoving&&(this.pos=z(e,this.pos.y))}get y(){return this.pos.y}set y(e){!this._follow&&!this._cameraMoving&&(this.pos=z(this.pos.x,e))}get dx(){return this.vel.x}set dx(e){this.vel=z(e,this.vel.y)}get dy(){return this.vel.y}set dy(e){this.vel=z(this.vel.x,e)}get ax(){return this.acc.x}set ax(e){this.acc=z(e,this.acc.y)}get ay(){return this.acc.y}set ay(e){this.acc=z(this.acc.x,e)}getFocus(){return this.pos}move(e,s,r=Nt.EaseInOutCubic){if(typeof r!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(e):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(e),this._lerpPromise=new Promise(a=>{this._lerpResolve=a}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=s,this._lerpEnd=e,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=r,this._lerpPromise)}shake(e,s,r){this._isShaking=!0,this._shakeMagnitudeX=e,this._shakeMagnitudeY=s,this._shakeDuration=r}zoomOverTime(e,s=0,r=Nt.EaseInOutCubic){if(this._zoomPromise=new Promise(a=>{this._zoomResolve=a}),s)this._isZooming=!0,this._zoomEasing=r,this._currentZoomTime=0,this._zoomDuration=s,this._zoomStart=this.zoom,this._zoomEnd=e;else return this._isZooming=!1,this.zoom=e,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new ht(0,0,0,0)}addStrategy(e){this._cameraStrategies.push(e)}removeStrategy(e){ms(e,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(e,s){this.events.emit("preupdate",new Ws(e,s,this)),this.onPreUpdate(e,s)}onPreUpdate(e,s){}_postupdate(e,s){this.events.emit("postupdate",new Ns(e,s,this)),this.onPostUpdate(e,s)}onPostUpdate(e,s){}get isInitialized(){return this._isInitialized}_initialize(e){if(!this.isInitialized){this._engine=e,this._screen=e.screen;const s=this._screen.contentArea;let r=z(s.width/2,s.height/2);if(!this._engine.loadingComplete){const a=this._screen.peekResolution();a&&(r=z(a.width/2,a.height/2))}this._halfWidth=r.x,this._halfHeight=r.y,this._posChanged||(this.pos=r),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(e,e.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(e),this.events.emit("initialize",new qn(e,this)),this._isInitialized=!0}}onInitialize(e){}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}runStrategies(e,s){for(const r of this._cameraStrategies)this.pos=r.action.call(r,r.target,this,e,s)}updateViewport(){this._viewport=new ht(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(e,s){if(this._initialize(e),this._preupdate(e,s),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(s/1e3)),this.zoom+=this.dz*s/1e3,this.vel=this.vel.add(this.acc.scale(s/1e3)),this.dz+=this.az*s/1e3,this.rotation+=this.angularVelocity*s/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const r=this._zoomEasing,a=r(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=a,this._currentZoomTime+=s}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const a=Nt.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=a,this._currentLerpTime+=s}else{this.pos=this._lerpEnd;const r=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(r)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=s,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(e,s),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(e,s),this._posChanged=!1}draw(e){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const s=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,r=this.pos.scale(s).add(this._oldPos.scale(1-s));r.clone(this.drawPos),this.updateTransform(r)}if(e.snapToPixel){const s=this.drawPos.clone(this._snapPos);s.x=~~(s.x+mt*G(s.x)),s.y=~~(s.y+mt*G(s.y)),s.clone(this.drawPos),this.updateTransform(s)}e.multiply(this.transform)}updateTransform(e){const s=this._screen.resolution.width/this.zoom,r=this._screen.resolution.height/this.zoom,a=z(-e.x+s/2+this._xShake,-e.y+r/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(s/2,r/2),this.transform.rotate(this.rotation),this.transform.translate(-s/2,-r/2),this.transform.translate(a.x,a.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const $_={ExitTrigger:"exit",EnterTrigger:"enter"};class mu extends $e{constructor(e){var s,r,a,l;super({...e}),this.events=new I,this.filter=(s=e.filter)!==null&&s!==void 0?s:()=>!0,this.repeat=(r=e.repeat)!==null&&r!==void 0?r:-1,this.action=(a=e.action)!==null&&a!==void 0?a:()=>{},this.target=e.target,this.graphics.isVisible=(l=e.visible)!==null&&l!==void 0?l:!1,this.body.collisionType=ft.Passive,this.events.on("collisionstart",({other:f})=>{this._matchesTarget(f.owner)&&(this.events.emit("enter",new Sh(this,f.owner)),this._dispatchAction(f.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:f})=>{this._matchesTarget(f.owner)&&this.events.emit("exit",new Ph(this,f.owner))})}_matchesTarget(e){return this.filter(e)&&(this.target===void 0||this.target===e)}_dispatchAction(e){this.repeat!==0&&(this.action.call(this,e),this.repeat--)}}const $i={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var mi;(function(u){u.Update="update",u.Draw="draw"})(mi||(mi={}));class yi{}yi.priority=$i.Average;class vu{constructor(e){this._world=e,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>s=>{this.addEntity(s)},this._createChildRemovedHandler=()=>s=>{this.removeEntity(s,!1)},this._entitiesToRemove=[]}updateEntities(e,s){for(let r=0;r<this.entities.length;r++){const a=this.entities[r];a.update(e.engine,s),a.isActive||this.removeEntity(a)}}findEntitiesForRemoval(){for(let e=0;e<this.entities.length;e++){const s=this.entities[e];s.isActive||this.removeEntity(s)}}addEntity(e){if(e.isActive=!0,e.scene=this._world.scene,e&&!this._entityIndex[e.id]){this._entityIndex[e.id]=e,this.entities.push(e),this._world.queryManager.addEntity(e),e.children.forEach(a=>{a.scene=e.scene,this.addEntity(a)});const s=this._createChildAddedHandler();this._childAddedHandlerMap.set(e,s);const r=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(e,r),e.childrenAdded$.subscribe(s),e.childrenRemoved$.subscribe(r)}}removeEntity(e,s=!0){var r,a;let l=0;e instanceof Ve?l=e.id:l=e;const f=this._entityIndex[l];if(f&&f.isActive&&(f.isActive=!1),f&&s){this._entitiesToRemove.push(f);return}if(delete this._entityIndex[l],f){f.scene=null,ms(f,this.entities),this._world.queryManager.removeEntity(f),f.children.forEach(w=>{w.scene=null,this.removeEntity(w,s)});const p=this._childAddedHandlerMap.get(f);p&&f.childrenAdded$.unsubscribe(p);const m=this._childRemovedHandlerMap.get(f);m&&f.childrenRemoved$.unsubscribe(m),!((a=(r=this._world)===null||r===void 0?void 0:r.scene)===null||a===void 0)&&a.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let e=0;e<this._entitiesToRemove.length;e++){const s=this._entitiesToRemove[e];s.isActive||this.removeEntity(s,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let e=0;e<this.entities.length;e++)this.entities[e].processComponentRemoval()}getById(e){return this._entityIndex[e]}getByName(e){return this.entities.filter(s=>s.name===e)}clear(){for(let e=this.entities.length-1;e>=0;e--)this.removeEntity(this.entities[e])}}class kr{constructor(e){if(this.requiredComponents=e,this.components=new Set,this.entities=[],this.entityAdded$=new Ze,this.entityRemoved$=new Ze,e.length===0)throw new Error("Cannot create query without components");for(const s of e)this.components.add(s);this.id=kr.createId(e)}static createId(e){return e.slice().map(s=>s.name).sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAll(Array.from(this.components))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class Lr{constructor(e){if(this.requiredTags=e,this.tags=new Set,this.entities=[],this.entityAdded$=new Ze,this.entityRemoved$=new Ze,e.length===0)throw new Error("Cannot create tag query without tags");for(const s of e)this.tags.add(s);this.id=Lr.createId(e)}static createId(e){return e.slice().sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAllTags(Array.from(this.tags))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class wu{constructor(e){this._world=e,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=s=>r=>{this.addComponent(s,r)},this._createRemoveComponentHandler=s=>r=>{this.removeComponent(s,r)},this._createAddTagHandler=s=>r=>{this.addTag(s,r)},this._createRemoveTagHandler=s=>r=>{this.removeTag(s,r)}}createQuery(e){const s=kr.createId(e);if(this._queries.has(s))return this._queries.get(s);const r=new kr(e);this._queries.set(r.id,r);for(const a of e){const l=this._componentToQueriesIndex.get(a);l?l.push(r):this._componentToQueriesIndex.set(a,[r])}for(const a of this._world.entities)this.addEntity(a);return r}createTagQuery(e){const s=Lr.createId(e);if(this._tagQueries.has(s))return this._tagQueries.get(s);const r=new Lr(e);this._tagQueries.set(r.id,r);for(const a of e){const l=this._tagToQueriesIndex.get(a);l?l.push(r):this._tagToQueriesIndex.set(a,[r])}for(const a of this._world.entities)this.addEntity(a);return r}addEntity(e){const s=this._addComponentHandlers.get(e),r=this._removeComponentHandlers.get(e),a=s??this._createAddComponentHandler(e),l=r??this._createRemoveComponentHandler(e);this._addComponentHandlers.set(e,a),this._removeComponentHandlers.set(e,l);const f=this._addTagHandlers.get(e),p=this._removeTagHandlers.get(e),m=f??this._createAddTagHandler(e),w=p??this._createRemoveTagHandler(e);this._addTagHandlers.set(e,m),this._removeTagHandlers.set(e,w);for(const b of this._queries.values())b.checkAndAdd(e);for(const b of this._tagQueries.values())b.checkAndAdd(e);e.componentAdded$.subscribe(a),e.componentRemoved$.subscribe(l),e.tagAdded$.subscribe(m),e.tagRemoved$.subscribe(w)}removeEntity(e){const s=this._addComponentHandlers.get(e),r=this._removeComponentHandlers.get(e);for(const f of this._queries.values())f.removeEntity(e);s&&e.componentAdded$.unsubscribe(s),r&&e.componentRemoved$.unsubscribe(r);const a=this._addTagHandlers.get(e),l=this._removeTagHandlers.get(e);for(const f of this._tagQueries.values())f.removeEntity(e);a&&e.tagAdded$.unsubscribe(a),l&&e.tagRemoved$.unsubscribe(l)}addComponent(e,s){var r;const a=(r=this._componentToQueriesIndex.get(s.constructor))!==null&&r!==void 0?r:[];for(const l of a)l.checkAndAdd(e)}removeComponent(e,s){var r;const a=(r=this._componentToQueriesIndex.get(s.constructor))!==null&&r!==void 0?r:[];for(const l of a)l.removeEntity(e)}addTag(e,s){var r;const a=(r=this._tagToQueriesIndex.get(s))!==null&&r!==void 0?r:[];for(const l of a)l.checkAndAdd(e)}removeTag(e,s){var r;const a=(r=this._tagToQueriesIndex.get(s))!==null&&r!==void 0?r:[];for(const l of a)l.removeEntity(e)}}function xu(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class Au{constructor(e){this._world=e,this.systems=[],this.initialized=!1}get(e){return this.systems.find(s=>s instanceof e)}addSystem(e){let s;e instanceof yi?s=e:s=new e(this._world),this.systems.push(s),this.systems.sort((r,a)=>r.constructor.priority-a.constructor.priority),this.initialized&&s.initialize&&s.initialize(this._world,this._world.scene)}removeSystem(e){ms(e,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const e of this.systems)e.initialize&&e.initialize(this._world,this._world.scene)}}updateSystems(e,s,r){const a=this.systems.filter(l=>l.systemType===e);for(const l of a)l.preupdate&&l.preupdate(s,r);for(const l of a)l.update(r);for(const l of a)l.postupdate&&l.postupdate(s,r)}clear(){for(let e=this.systems.length-1;e>=0;e--)this.removeSystem(this.systems[e])}}class bu{constructor(e){this.scene=e,this._logger=at.getInstance(),this.queryManager=new wu(this),this.entityManager=new vu(this),this.systemManager=new Au(this)}query(e){return this.queryManager.createQuery(e)}queryTags(e){return this.queryManager.createTagQuery(e)}update(e,s){e===mi.Update&&this.entityManager.updateEntities(this.scene,s),this.systemManager.updateSystems(e,this.scene,s),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(e){if(e instanceof Ve){this.entityManager.addEntity(e);return}if(e instanceof yi||xu(e)){this.systemManager.addSystem(e);return}this._logger.warn(`Could not add entity/system ${e.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(e){return this.systemManager.get(e)}remove(e,s=!0){if(e instanceof Ve){this.entityManager.removeEntity(e,s);return}if(e instanceof yi){this.systemManager.removeSystem(e);return}this._logger.warn(`Could not remove entity/system ${e.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class jo extends yi{constructor(e,s){super(),this.world=e,this.physics=s,this.systemType=mi.Update,this._physicsConfigDirty=!1,s.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([it,Bt])}update(e){let s,r;const a=this.query.entities,l=this.physics.config.substep;for(let f=0;f<a.length;f++){s=a[f].get(it),r=a[f].get(Bt);const p=a[f].get(Et);if(this._physicsConfigDirty&&p&&p.updatePhysicsConfig(this.physics.config.bodies),p?.isSleeping)continue;const m=r.acc.clone();p?.collisionType===ft.Active&&p?.useGravity&&m.addEqual(this.physics.config.gravity),a[f].parent||this.captureOldTransformWithChildren(a[f]),Je.integrate(s,r,m,e/l)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(e){var s;(s=e.get(Et))===null||s===void 0||s.captureOldTransform();for(let r=0;r<e.children.length;r++)this.captureOldTransformWithChildren(e.children[r])}}jo.priority=$i.Higher;class Qh{constructor(e){this.config=e,this.directionMap=new Map,this.distanceMap=new Map}solve(e){this.preSolve(e),e=e.filter(r=>!r.isCanceled());let s;switch(this.config.contactSolveBias){case bs.HorizontalFirst:{s=Hh;break}case bs.VerticalFirst:{s=zh;break}default:s=Oh}e.sort((r,a)=>{const l=this.directionMap.get(r.id),f=this.directionMap.get(a.id),p=this.distanceMap.get(r.id),m=this.distanceMap.get(a.id);return s[l]-s[f]||p-m});for(const r of e)this.solvePosition(r),this.solveVelocity(r);return this.postSolve(e),e}preSolve(e){for(let r=0;r<e.length;r++){const a=e[r];if(Math.abs(a.mtv.x)<1e-4&&Math.abs(a.mtv.y)<1e-4){a.cancel();continue}const l=Rt.fromDirection(a.mtv),f=a.mtv.negate(),p=Math.abs(a.info.separation);this.distanceMap.set(a.id,p),this.directionMap.set(a.id,l===Rt.Left||l===Rt.Right?"horizontal":"vertical"),a.colliderA.events.emit("precollision",new ln(a.colliderA,a.colliderB,l,f,a)),a.colliderB.events.emit("precollision",new ln(a.colliderB,a.colliderA,Rt.getOpposite(l),f.negate(),a))}}postSolve(e){var s,r;for(let a=0;a<e.length;a++){const l=e[a];if(l.isCanceled())continue;const f=l.colliderA,p=l.colliderB,m=(s=f.owner)===null||s===void 0?void 0:s.get(Et),w=(r=p.owner)===null||r===void 0?void 0:r.get(Et);if(m&&w&&(m.collisionType===ft.Passive||w.collisionType===ft.Passive))continue;const b=Rt.fromDirection(l.mtv),y=l.mtv.negate();l.colliderA.events.emit("postcollision",new cn(l.colliderA,l.colliderB,b,y,l)),l.colliderB.events.emit("postcollision",new cn(l.colliderB,l.colliderA,Rt.getOpposite(b),y.negate(),l))}}solvePosition(e){var s,r;if(!e.colliderA.bounds.overlaps(e.colliderB.bounds,1e-4)){e.cancel();return}if(Math.abs(e.mtv.x)<1e-4&&Math.abs(e.mtv.y)<1e-4){e.cancel();return}let l=e.mtv;const f=e.colliderA,p=e.colliderB,m=(s=f.owner)===null||s===void 0?void 0:s.get(Et),w=(r=p.owner)===null||r===void 0?void 0:r.get(Et);if(m&&w){if(m.collisionType===ft.Passive||w.collisionType===ft.Passive)return;m.collisionType===ft.Active&&w.collisionType===ft.Active&&(l=l.scale(.5)),m.collisionType===ft.Active&&(m.globalPos.x-=l.x,m.globalPos.y-=l.y,f.update(m.transform.get())),w.collisionType===ft.Active&&(w.globalPos.x+=l.x,w.globalPos.y+=l.y,p.update(w.transform.get()))}}solveVelocity(e){var s,r;if(e.isCanceled())return;const a=e.colliderA,l=e.colliderB,f=(s=a.owner)===null||s===void 0?void 0:s.get(Et),p=(r=l.owner)===null||r===void 0?void 0:r.get(Et);if(f&&p){if(f.collisionType===ft.Passive||p.collisionType===ft.Passive)return;const m=e.normal,w=m.negate();if(f.collisionType===ft.Active&&f.vel.normalize().dot(w)<0){const b=m.scale(m.dot(f.vel.negate()));f.vel=f.vel.add(b)}if(p.collisionType===ft.Active&&p.vel.normalize().dot(m)<0){const b=w.scale(w.dot(p.vel.negate()));p.vel=p.vel.add(b)}}}}class yu{constructor(e,s,r){this.point=e,this.local=s,this.contact=r,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new B(0,0),this.bToContact=new B(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const e=this.contact.bodyA,s=this.contact.colliderA,r=this.contact.bodyB,a=this.contact.colliderB;if(e&&r){const l=this.contact.normal,f=this.contact.tangent;this.aToContact=this.point.sub(s.center),this.bToContact=this.point.sub(a.center);const p=this.aToContact.cross(l),m=this.bToContact.cross(l);this.normalMass=e.inverseMass+r.inverseMass+e.inverseInertia*p*p+r.inverseInertia*m*m;const w=this.aToContact.cross(f),b=this.bToContact.cross(f);this.tangentMass=e.inverseMass+r.inverseMass+e.inverseInertia*w*w+r.inverseInertia*b*b}return this}getRelativeVelocity(){const e=this.contact.bodyA,s=this.contact.bodyB;if(e&&s){const r=e.vel.add(B.cross(e.angularVelocity,this.aToContact));return s.vel.add(B.cross(s.angularVelocity,this.bToContact)).sub(r)}return B.Zero}}class Zh{constructor(e){this.config=e,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(e){var s;return(s=this.idToContactConstraint.get(e))!==null&&s!==void 0?s:[]}solve(e){this.preSolve(e),e=e.filter(r=>!r.isCanceled());let s;switch(this.config.contactSolveBias){case bs.HorizontalFirst:{s=Hh;break}case bs.VerticalFirst:{s=zh;break}default:s=Oh}return e.sort((r,a)=>{const l=this.directionMap.get(r.id),f=this.directionMap.get(a.id),p=this.distanceMap.get(r.id),m=this.distanceMap.get(a.id);return s[l]-s[f]||p-m}),this.solveVelocity(e),this.solvePosition(e),this.postSolve(e),e}preSolve(e){var s,r,a,l;for(let m=0;m<e.length;m++){const w=e[m];if(Math.abs(w.mtv.x)<1e-4&&Math.abs(w.mtv.y)<1e-4){w.cancel();continue}const b=Rt.fromDirection(w.mtv),y=Math.abs(((s=w?.info)===null||s===void 0?void 0:s.separation)||0);this.distanceMap.set(w.id,y),this.directionMap.set(w.id,b===Rt.Left||b===Rt.Right?"horizontal":"vertical"),w.colliderA.events.emit("precollision",new ln(w.colliderA,w.colliderB,b,w.mtv,w)),w.colliderA.events.emit("beforecollisionresolve",new Uo(w.colliderA,w.colliderB,b,w.mtv,w)),w.colliderB.events.emit("precollision",new ln(w.colliderB,w.colliderA,Rt.getOpposite(b),w.mtv.negate(),w)),w.colliderB.events.emit("beforecollisionresolve",new Uo(w.colliderB,w.colliderA,Rt.getOpposite(b),w.mtv.negate(),w)),w.matchAwake()}const p=Array.from(this.idToContactConstraint.keys());for(let m=0;m<e.length;m++){const w=e[m],b=p.indexOf(w.id);b>-1&&p.splice(b,1);const y=(r=this.idToContactConstraint.get(w.id))!==null&&r!==void 0?r:[];let T=0;const D=w.bodyA,U=w.colliderA,O=w.bodyB,q=w.colliderB;if(D&&O)for(let H=0;H<w.points.length;H++){const W=w.points[H],J=w.normal,Y=w.tangent,tt=W.sub(U.center),ot=W.sub(q.center),Q=tt.cross(J),_t=ot.cross(J),It=D.inverseMass+O.inverseMass+D.inverseInertia*Q*Q+O.inverseInertia*_t*_t,Yt=tt.cross(Y),Zt=ot.cross(Y),Te=D.inverseMass+O.inverseMass+D.inverseInertia*Yt*Yt+O.inverseInertia*Zt*Zt;y[T]&&((l=(a=y[T])===null||a===void 0?void 0:a.point)===null||l===void 0?void 0:l.squareDistance(W))<4?(y[T].point=W,y[T].local=w.localPoints[T]):y[T]=new yu(W,w.localPoints[T],w),y[T].aToContact=tt,y[T].bToContact=ot,y[T].normalMass=1/It,y[T].tangentMass=1/Te;const te=D.bounciness>O.bounciness?D.bounciness:O.bounciness,zt=w.normal.dot(y[T].getRelativeVelocity());y[T].originalVelocityAndRestitution=0,zt<-.1&&(y[T].originalVelocityAndRestitution=-te*zt),T++}this.idToContactConstraint.set(w.id,y)}for(const m of p)this.idToContactConstraint.delete(m);if(this.config.warmStart)this.warmStart(e);else for(let m=0;m<e.length;m++){const w=e[m],b=this.getContactConstraints(w.id);for(const y of b)y.normalImpulse=0,y.tangentImpulse=0}}postSolve(e){for(let s=0;s<e.length;s++){const r=e[s],a=r.bodyA,l=r.bodyB;if(a&&l){if(a.collisionType===ft.Passive||l.collisionType===ft.Passive)continue;a.updateMotion(),l.updateMotion()}const f=Rt.fromDirection(r.mtv);r.colliderA.events.emit("postcollision",new cn(r.colliderA,r.colliderB,f,r.mtv,r)),r.colliderA.events.emit("aftercollisionresolve",new zo(r.colliderA,r.colliderB,f,r.mtv,r)),r.colliderB.events.emit("postcollision",new cn(r.colliderB,r.colliderA,Rt.getOpposite(f),r.mtv.negate(),r)),r.colliderB.events.emit("aftercollisionresolve",new zo(r.colliderB,r.colliderA,Rt.getOpposite(f),r.mtv.negate(),r))}this.lastFrameContacts.clear();for(let s=0;s<e.length;s++){const r=e[s];this.lastFrameContacts.set(r.id,r)}}warmStart(e){var s;for(let r=0;r<e.length;r++){const a=e[r],l=a.bodyA,f=a.bodyB;if(l&&f){const p=(s=this.idToContactConstraint.get(a.id))!==null&&s!==void 0?s:[];for(const m of p)if(this.config.warmStart){const w=a.normal.scale(m.normalImpulse),b=a.tangent.scale(m.tangentImpulse),y=w.add(b);l.applyImpulse(m.point,y.negate()),f.applyImpulse(m.point,y)}else m.normalImpulse=0,m.tangentImpulse=0}}}solvePosition(e){var s;for(let r=0;r<this.config.positionIterations;r++)for(let a=0;a<e.length;a++){const l=e[a],f=l.bodyA,p=l.bodyB;if(f&&p){if(f.collisionType===ft.Passive||p.collisionType===ft.Passive)continue;const m=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const w of m){const b=l.normal,y=Hi.FindContactSeparation(l,w.local),T=this.config.steeringFactor,D=-5,U=this.config.slop,O=j(T*(y+U),D,0),q=b.scale(-O*w.normalMass);if(f.collisionType===ft.Active){const H=q.negate().scale(f.inverseMass);f.limitDegreeOfFreedom.includes(ri.X)&&(H.x=0),f.limitDegreeOfFreedom.includes(ri.Y)&&(H.y=0),f.globalPos=f.globalPos.add(H),f.limitDegreeOfFreedom.includes(ri.Rotation)||(f.rotation-=w.aToContact.cross(q)*f.inverseInertia)}if(p.collisionType===ft.Active){const H=q.scale(p.inverseMass);p.limitDegreeOfFreedom.includes(ri.X)&&(H.x=0),p.limitDegreeOfFreedom.includes(ri.Y)&&(H.y=0),p.globalPos=p.globalPos.add(H),p.limitDegreeOfFreedom.includes(ri.Rotation)||(p.rotation+=w.bToContact.cross(q)*p.inverseInertia)}}}}}solveVelocity(e){var s;for(let r=0;r<this.config.velocityIterations;r++)for(let a=0;a<e.length;a++){const l=e[a],f=l.bodyA,p=l.bodyB;if(f&&p){if(f.collisionType===ft.Passive||p.collisionType===ft.Passive)continue;const m=Math.min(f.friction,p.friction),w=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const b of w){let D=-b.getRelativeVelocity().dot(l.tangent)*b.tangentMass;const U=m*b.normalImpulse,O=j(b.tangentImpulse+D,-U,U);D=O-b.tangentImpulse,b.tangentImpulse=O;const q=l.tangent.scale(D);f.applyImpulse(b.point,q.negate()),p.applyImpulse(b.point,q)}for(const b of w){const T=b.getRelativeVelocity().dot(l.normal);let D=-b.normalMass*(T-b.originalVelocityAndRestitution);const U=Math.max(b.normalImpulse+D,0);D=U-b.normalImpulse,b.normalImpulse=U;const O=l.normal.scale(D);f.applyImpulse(b.point,O.negate()),p.applyImpulse(b.point,O)}}}}}class Qo extends yi{get _processor(){return this._physics.collisionProcessor}constructor(e,s){super(),this._physics=s,this.systemType=mi.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new Qh(s.config.arcade),this._realisticSolver=new Zh(s.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=r=>this._processor.track(r),this._untrackCollider=r=>this._processor.untrack(r),this.query=e.query([it,Bt,ve]),this.query.entityAdded$.subscribe(r=>{const a=r.get(ve);a.$colliderAdded.subscribe(this._trackCollider),a.$colliderRemoved.subscribe(this._untrackCollider);const l=a.get();l&&this._processor.track(l)}),this.query.entityRemoved$.subscribe(r=>{const a=r.get(ve),l=a.get();a&&l&&this._processor.untrack(l)}),this._motionSystem=e.get(jo)}initialize(e,s){this._engine=s.engine}update(e){var s,r,a,l;if(!this._physics.config.enabled)return;let f=[];for(let y=0;y<this.query.entities.length;y++){const D=this.query.entities[y].get(ve),U=D?.get();if(D&&(!((s=D.owner)===null||s===void 0)&&s.isActive)&&U)if(D.update(),U instanceof Pe){const O=U.getColliders();U.compositeStrategy||(U.compositeStrategy=this._physics.config.colliders.compositeStrategy),f=f.concat(O)}else f.push(U)}this._processor.update(f,e);let p=this._processor.broadphase(f,e);this._currentFrameContacts.clear();let m=[];const w=this.getSolver(),b=this._physics.config.substep;for(let y=0;y<b;y++)if(y>0&&this._motionSystem.update(e),m.length&&(p=m.map(T=>new Ke(T.colliderA,T.colliderB))),p.length){m=this._processor.narrowphase(p,(l=(a=(r=this._engine)===null||r===void 0?void 0:r.debug)===null||a===void 0?void 0:a.stats)===null||l===void 0?void 0:l.currFrame),m=w.solve(m);for(const T of m){if(T.isCanceled())continue;const D=T.id.indexOf("|");if(D>0){const U=T.id.substring(D+1);this._currentFrameContacts.set(U,T)}else this._currentFrameContacts.set(T.id,T)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const y of this.query.entities){const T=y.get(ve);T&&T.processColliderRemoval()}}postupdate(){me.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new Qh(this._physics.config.arcade),this._realisticSolver=new Zh(this._physics.config.realistic)),this._physics.config.solver===Rr.Realistic?this._realisticSolver:this._arcadeSolver}debug(e){this._processor.debug(e,0)}runContactStartEnd(){for(const[e,s]of this._currentFrameContacts)if(!this._lastFrameContacts.has(e)){const r=s.colliderA,a=s.colliderB,l=Rt.fromDirection(s.mtv),f=Rt.getOpposite(l);r.events.emit("collisionstart",new Sr(r,a,l,s)),r.events.emit("contactstart",new ko(r,a,l,s)),a.events.emit("collisionstart",new Sr(a,r,f,s)),a.events.emit("contactstart",new ko(a,r,f,s))}for(const[e,s]of this._lastFrameContacts)if(!this._currentFrameContacts.has(e)){const r=s.colliderA,a=s.colliderB,l=Rt.fromDirection(s.mtv),f=Rt.getOpposite(l);r.events.emit("collisionend",new Pr(r,a,l,s)),r.events.emit("contactend",new Lo(r,a,l,s)),a.events.emit("collisionend",new Pr(a,r,f,s)),a.events.emit("contactend",new Lo(a,r,f,s))}}}Qo.priority=$i.Higher;function tm(u,e,s,r){if(u.parent!==e.parent){const b=u.clone(),y=u.globalPos.clone(),T=u.globalScale.clone(),D=u.globalRotation;b.parent=e.parent,b.globalPos=y,b.globalScale=T,b.globalRotation=D,u=b}let a=e.pos,l=e.scale,f=e.rotation;a=e.pos.scale(s).add(u.pos.scale(1-s)),l=e.scale.scale(s).add(u.scale.scale(1-s));const p=(1-s)*Math.cos(u.rotation)+s*Math.cos(e.rotation),m=(1-s)*Math.sin(u.rotation)+s*Math.sin(e.rotation);f=Math.atan2(m,p);const w=r??new ws;return w.setTransform(a,f,l),w}class Jh extends yi{get sortedTransforms(){return this._sortedTransforms}constructor(e){super(),this.world=e,this.systemType=mi.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new ws,this.query=this.world.query([it,re]),this.query.entityAdded$.subscribe(s=>{const r=s.get(it);this._sortedTransforms.push(r),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{const r=s.get(it);r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const a=this._sortedTransforms.indexOf(r);a>-1&&this._sortedTransforms.splice(a,1)})}initialize(e,s){this._camera=s.camera,this._engine=s.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>e.globalZ-s.globalZ),this._zHasChanged=!1)}update(e){this._token++;let s;Lt.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let r=0;r<this._sortedTransforms.length;r++){const a=this._sortedTransforms[r],l=a.owner;if(l.hasTag("ex.offscreen")||(s=l.get(re),!s.isVisible))continue;s.onPreTransformDraw&&s.onPreTransformDraw(this._graphicsContext,e),l.events.emit("pretransformdraw",new lh(this._graphicsContext,e,l)),a.coordPlane===Me.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),a.coordPlane===Me.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),s.update(e,this._token);const f=l.get(Xo);if(f){const p=B.One.sub(f.parallaxFactor),m=this._camera.drawPos.scale(p);this._graphicsContext.translate(m.x,m.y)}this._applyTransform(l),s.material&&(this._graphicsContext.material=s.material),s.onPreDraw&&s.onPreDraw(this._graphicsContext,e),l.events.emit("predraw",new Gn(this._graphicsContext,e,l)),this._applyOpacity(l),this._drawGraphicsComponent(s,a),s.onPostDraw&&s.onPostDraw(this._graphicsContext,e),l.events.emit("postdraw",new Xn(this._graphicsContext,e,l)),this._graphicsContext.restore(),a.coordPlane===Me.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),s.onPostTransformDraw&&s.onPostTransformDraw(this._graphicsContext,e),l.events.emit("posttransformdraw",new ch(this._graphicsContext,e,l))}this._graphicsContext.restore()}_drawGraphicsComponent(e,s){var r,a;if(e.isVisible){const l=e.flipHorizontal,f=e.flipVertical,p=e.current,m=(r=e.currentOptions)!==null&&r!==void 0?r:{};if(p){let w=e.anchor,b=e.offset,y=1,T=1;m?.anchor&&(w=m.anchor),m?.offset&&(b=m.offset);const D=s.globalScale;y*=p.scale.x*D.x,T*=p.scale.y*D.y;const U=-p.width*w.x+b.x*y,O=-p.height*w.y+b.y*T,q=p.flipHorizontal,H=p.flipVertical;if((l||f)&&(p.flipHorizontal=l?!q:q,p.flipVertical=f?!H:H),p?.draw(this._graphicsContext,U,O),(l||f)&&(p.flipHorizontal=q,p.flipVertical=H),!((a=this._engine)===null||a===void 0)&&a.isDebug&&this._engine.debug.graphics.showBounds){const W=z(U,O);if(p instanceof Vn)for(const J of p.members){let Y,tt=B.Zero;J instanceof se?Y=J:(Y=J.graphic,tt=J.offset),p.useAnchor?Y?.localBounds.translate(W.add(tt)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):Y?.localBounds.translate(tt).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else p?.localBounds.translate(W).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(e){const s=e.getAncestors();for(let r=0;r<s.length;r++){const a=s[r],l=a?.get(it),f=a?.get(Et);if(l){let p=l.get();if(f&&this._engine.fixedUpdateTimestep&&f.__oldTransformCaptured&&f.enableFixedUpdateInterpolate){const m=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;p=tm(f.oldTransform,l.get(),m,this._targetInterpolationTransform)}this._graphicsContext.z=l.globalZ,this._graphicsContext.translate(p.pos.x,p.pos.y),this._graphicsContext.scale(p.scale.x,p.scale.y),this._graphicsContext.rotate(p.rotation)}}}_applyOpacity(e){var s;const r=e.getAncestors();for(let a=0;a<r.length;a++){const l=r[a],f=l?.get(re);this._graphicsContext.opacity*=(s=f?.opacity)!==null&&s!==void 0?s:1}}}Jh.priority=$i.Average;class Kh extends yi{constructor(e){super(),this.world=e,this.systemType=mi.Draw,this.query=this.world.query([it])}initialize(e,s){this._graphicsContext=s.engine.graphicsContext,this._camera=s.camera,this._engine=s.engine,this._collisionSystem=e.systemManager.get(Qo)}update(){var e;if(!this._engine.isDebug)return;const s=this._engine.debug.filter;let r,a;const l=this._engine.debug.entity;let f;const p=this._engine.debug.transform;let m;const w=this._engine.debug.motion;let b;const y=this._engine.debug.collider,T=this._engine.debug.physics;let D;const U=this._engine.debug.graphics;let O,q;const H=this._engine.debug.body,W=this._engine.debug.camera;for(let J=0;J<this.query.entities.length;J++){const Y=this.query.entities[J];if(Y.hasTag("offscreen")||Y instanceof Ho||s.useFilter&&(!(s.ids.length===0||s.ids.includes(Y.id))||!(s.nameQuery===""||Y.name.includes(s.nameQuery))))continue;let tt=B.Zero;const ot=z(0,16);if(r=Y.id,a=Y.name,f=Y.get(it),this._pushCameraTransform(f),this._graphicsContext.save(),f.coordPlane===Me.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=p.debugZIndex,this._applyTransform(Y),f&&((p.showAll||p.showPosition)&&this._graphicsContext.debug.drawPoint(B.Zero,{size:4,color:p.positionColor}),(p.showAll||p.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${f.pos.toString(2)}`,tt),tt=tt.add(ot)),(p.showAll||p.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${f.z.toFixed(1)})`,tt),tt=tt.add(ot)),(l.showAll||l.showId)&&(this._graphicsContext.debug.drawText(`id(${r}) ${Y.parent?"child of id("+((e=Y.parent)===null||e===void 0?void 0:e.id)+")":""}`,tt),tt=tt.add(ot)),(l.showAll||l.showName)&&(this._graphicsContext.debug.drawText(`name(${a})`,tt),tt=tt.add(ot)),(p.showAll||p.showRotation)&&(this._graphicsContext.drawLine(B.Zero,B.fromAngle(f.rotation).scale(50).add(B.Zero),p.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${lt(f.rotation).toFixed(2)})`,tt),tt=tt.add(ot)),(p.showAll||p.showScale)&&this._graphicsContext.drawLine(B.Zero,f.scale.add(B.Zero),p.scaleColor,2)),D=Y.get(re),D&&(U.showAll||U.showBounds)&&D.localBounds.draw(this._graphicsContext,U.boundsColor),O=Y.get(qo),O&&(O.useTransform||this._graphicsContext.restore(),O.draw(this._graphicsContext,this._engine.debug),O.useTransform||(this._graphicsContext.save(),this._applyTransform(Y))),q=Y.get(Et),q&&((H.showAll||H.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${q.group.name})`,tt),tt=tt.add(ot)),(H.showAll||H.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${q.collisionType})`,tt),tt=tt.add(ot)),(H.showAll||H.showMass)&&(this._graphicsContext.debug.drawText(`mass(${q.mass})`,tt),tt=tt.add(ot)),(H.showAll||H.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${q.sleepMotion})`,tt),tt=tt.add(ot)),(H.showAll||H.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${q.canSleep?q.isSleeping:"cant sleep"})`,tt),tt=tt.add(ot))),this._graphicsContext.restore(),this._graphicsContext.save(),f.coordPlane===Me.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=p.debugZIndex,m=Y.get(Bt),m&&((w.showAll||w.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${m.vel.toString(2)}`,tt.add(f.globalPos)),this._graphicsContext.drawLine(f.globalPos,f.globalPos.add(m.vel),w.velocityColor,2),tt=tt.add(ot)),(w.showAll||w.showAcceleration)&&this._graphicsContext.drawLine(f.globalPos,f.globalPos.add(m.acc),w.accelerationColor,2)),b=Y.get(ve),b){const Q=b.get();if((y.showAll||y.showGeometry)&&Q&&Q.debug(this._graphicsContext,y.geometryColor,{lineWidth:y.geometryLineWidth,pointSize:y.geometryPointSize}),y.showAll||y.showBounds){if(Q instanceof Pe){const _t=Q.getColliders();for(const It of _t){const Yt=It.bounds,Zt=z(Yt.left,Yt.top);this._graphicsContext.debug.drawRect(Zt.x,Zt.y,Yt.width,Yt.height,{color:y.boundsColor}),(y.showAll||y.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${It.owner.id})`,Zt)}b.bounds.draw(this._graphicsContext,y.boundsColor)}else if(Q){const _t=b.bounds,It=z(_t.left,_t.top);this._graphicsContext.debug.drawRect(It.x,It.y,_t.width,_t.height,{color:y.boundsColor}),(y.showAll||y.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${b.owner.id})`,It)}}}this._graphicsContext.restore(),this._popCameraTransform(f)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(T.showAll||T.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),T.showAll||T.showCollisionContacts||T.showCollisionNormals)for(const[J,Y]of this._engine.debug.stats.currFrame.physics.contacts){if(T.showAll||T.showCollisionContacts)for(const tt of Y.points)this._graphicsContext.debug.drawPoint(tt,{size:T.contactSize,color:T.collisionContactColor});if(T.showAll||T.showCollisionNormals)for(const tt of Y.points)this._graphicsContext.debug.drawLine(tt,Y.normal.scale(30).add(tt),{color:T.collisionNormalColor})}this._graphicsContext.restore(),W&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(W.showAll||W.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,W.focusColor),(W.showAll||W.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(e,s){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),Ee.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(e){const s=e.getAncestors();for(const r of s){const a=r?.get(it);a&&(this._graphicsContext.translate(a.pos.x,a.pos.y),this._graphicsContext.scale(a.scale.x,a.scale.y),this._graphicsContext.rotate(a.rotation))}}_pushCameraTransform(e){e.coordPlane===Me.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(e){e.coordPlane===Me.World&&this._graphicsContext.restore()}}Kh.priority=$i.Lowest;class $h{constructor(e,s){this.object=e,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=s,this.bounds=e.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const e=this.object.bounds,s=Math.floor(e.left/this.gridSize),r=Math.floor(e.right/this.gridSize),a=Math.floor(e.bottom/this.gridSize),l=Math.floor(e.top/this.gridSize);return this.leftX!==s||this.rightX!==r||this.bottomY!==a||this.topY!==l}clear(){for(const e of this.cells){const s=e.proxies.indexOf(this);s>-1&&e.proxies.splice(s,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class ts{constructor(){this.proxies=[]}configure(e,s){this.x=e,this.y=s,this.key=ts.calculateHashKey(e,s)}static calculateHashKey(e,s){return`${e}+${s}`}}class tl{constructor(e){this.bounds=new ht,this._hashGridCellPool=new wr(()=>new ts,s=>(s.configure(0,0),s.proxies.length=0,s),1e3),this.gridSize=e.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,e.proxyFactory?this._buildProxy=s=>e.proxyFactory(s,this.gridSize):this._buildProxy=s=>new $h(s,this.gridSize)}query(e){const s=new Set;if(e instanceof ht){const r=e,a=Math.floor(r.left/this.gridSize),l=Math.floor(r.right/this.gridSize),f=Math.floor(r.bottom/this.gridSize),p=Math.floor(r.top/this.gridSize);for(let m=a;m<=l;m++)for(let w=p;w<=f;w++){const b=ts.calculateHashKey(m,w),y=this.sparseHashGrid.get(b);if(y)for(let T=0;T<y.proxies.length;T++)y.proxies[T].updateBounds(),y.proxies[T].bounds.intersect(r)&&s.add(y.proxies[T].object)}}else{const r=e,a=ts.calculateHashKey(Math.floor(r.x/this.gridSize),Math.floor(r.y/this.gridSize)),l=this.sparseHashGrid.get(a);if(l)for(let f=0;f<l.proxies.length;f++)l.proxies[f].updateBounds(),l.proxies[f].bounds.contains(r)&&s.add(l.proxies[f].object)}return Array.from(s)}get(e,s){const r=ts.calculateHashKey(e,s);return this.sparseHashGrid.get(r)}_insert(e,s,r){const a=ts.calculateHashKey(e,s);let l=this.sparseHashGrid.get(a);l||(l=this._hashGridCellPool.rent(),l.configure(e,s),this.sparseHashGrid.set(l.key,l)),l.proxies.push(r),r.cells.push(l),this.bounds.combine(r.bounds,this.bounds)}_remove(e,s,r){const a=ts.calculateHashKey(e,s),l=this.sparseHashGrid.get(a);if(l){const f=l.proxies.indexOf(r);f>-1&&l.proxies.splice(f,1);const p=r.cells.indexOf(l);p>-1&&r.cells.splice(p,1),l.proxies.length===0&&(this._hashGridCellPool.return(l),this.sparseHashGrid.delete(a))}}track(e){const s=this._buildProxy(e);this.objectToProxy.set(e,s);for(let r=s.leftX;r<=s.rightX;r++)for(let a=s.topY;a<=s.bottomY;a++)this._insert(r,a,s)}untrack(e){const s=this.objectToProxy.get(e);s&&(s.clear(),this.objectToProxy.delete(e))}update(e){let s=0;for(const r of e){const a=this.objectToProxy.get(r);if(a&&a.hasChanged()){for(let l=a.leftX;l<=a.rightX;l++)for(let f=a.topY;f<=a.bottomY;f++)this._remove(l,f,a);a.update();for(let l=a.leftX;l<=a.rightX;l++)for(let f=a.topY;f<=a.bottomY;f++)this._insert(l,f,a);s++}}return s}debug(e,s){const r=Z.Transparent,a=Z.White;for(const l of this.sparseHashGrid.values())e.drawRectangle(z(l.x*this.gridSize,l.y*this.gridSize),this.gridSize,this.gridSize,r,a,2)}}class Zo extends yi{constructor(e){super(),this.world=e,this.systemType=mi.Update,this._graphicsHashGrid=new tl({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new jh,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([it,Xs]),this.query.entityAdded$.subscribe(s=>{const r=s.get(it),a=s.get(Xs);this._pointerEventDispatcher.addObject(s,f=>a&&a.localBounds?a.localBounds.transform(r.get().matrix).contains(r.coordPlane===Me.World?f.worldPos:f.screenPos):!1,()=>s.isActive),this._entityToPointer.set(s,a);const l=s.get(re);l&&(this._graphics.push(l),this._graphicsHashGrid.track(l)),this._sortedTransforms.push(r),this._sortedEntities.push(r.owner),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{this._pointerEventDispatcher.removeObject(s);const r=s.get(it);this._entityToPointer.delete(s);const a=s.get(re);if(a){const f=this._graphics.indexOf(a);f>-1&&this._graphics.splice(f,1),this._graphicsHashGrid.untrack(a)}r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const l=this._sortedTransforms.indexOf(r);l>-1&&(this._sortedTransforms.splice(l,1),this._sortedEntities.splice(l,1))})}initialize(e,s){this._engine=s.engine,this._scene=s}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>s.z-e.z),this._sortedEntities=this._sortedTransforms.map(e=>e.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[e,s]of this._engineReceiver.currentFramePointerCoords.entries()){const r=this._scene.physics.query(s.worldPos);for(let l=0;l<r.length;l++){const f=r[l],p=this._entityToPointer.get(f.owner);p&&(p.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(f.owner,e)}const a=this._graphicsHashGrid.query(s.worldPos);for(let l=0;l<a.length;l++){const f=a[l],p=this._entityToPointer.get(f.owner);p&&(p.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(f.owner,e)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(e=>e.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(e=>e.clear())}}Zo.priority=$i.Higher;class el extends yi{constructor(e){super(),this.world=e,this.systemType=mi.Update,this._actions=[],this.query=this.world.query([jn]),this.query.entityAdded$.subscribe(s=>this._actions.push(s.get(jn))),this.query.entityRemoved$.subscribe(s=>{const r=s.get(jn),a=this._actions.indexOf(r);a>-1&&this._actions.splice(a,1)})}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}}el.priority=$i.Higher;class Ur extends Ti{constructor(e){super(),this.elevation=0,this.columns=e.columns,this.rows=e.rows,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight}}class il extends yi{constructor(e){super(),this.world=e,this.systemType=mi.Update,this.query=this.world.query([it,Ur])}update(){let e,s;for(let r=0;r<this.query.entities.length;r++){const a=this.query.entities[r];e=a.get(it),s=a.get(Ur);const f=Math.max(s.columns*s.tileWidth,s.rows*s.tileHeight)*s.elevation+e.pos.y;e.z=f}}}il.priority=$i.Lower;class sl extends yi{constructor(e){super(),this.world=e,this.systemType=mi.Draw,this.query=this.world.query([it,re])}initialize(e,s){this._camera=s.camera,this._screen=s.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let e,s,r;for(let a=0;a<this.query.entities.length;a++){const l=this.query.entities[a];s=l.get(re),e=l.get(it),r=l.get(Xo);let f;if(r){const m=B.One.sub(r.parallaxFactor);f=this._camera.pos.scale(m)}const p=this._isOffscreen(e,s,f);p&&!l.hasTag("ex.offscreen")&&(l.events.emit("exitviewport",new yh(l)),l.addTag("ex.offscreen")),!p&&l.hasTag("ex.offscreen")&&(l.events.emit("enterviewport",new Ch(l)),l.removeTag("ex.offscreen"))}}_isOffscreen(e,s,r){if(s.forceOnScreen)return!1;if(e.coordPlane===Me.World){let a=s.localBounds;r&&(a=a.translate(r));const l=a.transform(e.get().matrix);return!this._worldBounds.overlaps(l)}else return!1}}sl.priority=$i.Higher;class Cu extends $h{constructor(e,s){var r,a;super(e,s),this.collider=e,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=s;const l=e.bounds;this.hasZeroBounds=l.hasZeroDimensions(),this.leftX=Math.floor(l.left/this.gridSize),this.rightX=Math.floor(l.right/this.gridSize),this.bottomY=Math.floor(l.bottom/this.gridSize),this.topY=Math.floor(l.top/this.gridSize),this.owner=e.owner,this.body=(r=this.owner)===null||r===void 0?void 0:r.get(Et),this.collisionType=(a=this.body.collisionType)!==null&&a!==void 0?a:ft.PreventCollision}update(){var e,s;super.update(),this.body=(e=this.owner)===null||e===void 0?void 0:e.get(Et),this.collisionType=(s=this.body.collisionType)!==null&&s!==void 0?s:ft.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class nl{constructor(e){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new Eo(()=>new Ke({id:S("collider",0)},{id:S("collider",0)}),s=>(s.colliderA=null,s.colliderB=null,s),200),this.gridSize=e.size,this.hashGrid=new tl({size:this.gridSize,proxyFactory:(s,r)=>new Cu(s,r)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(e){return this.hashGrid.query(e)}rayCast(e,s){var r,a,l;const f=[],p=(r=s?.maxDistance)!==null&&r!==void 0?r:1/0,m=s?.collisionGroup,w=m?m.category:(a=s?.collisionMask)!==null&&a!==void 0?a:As.All.category,b=(l=s?.searchAllColliders)!==null&&l!==void 0?l:!1,y=e.dir.normalize(),T=y.y/y.x,D=y.x/y.y,U=Math.sqrt(1+T*T)*this.gridSize,O=Math.sqrt(1+D*D)*this.gridSize,q=e.pos.x/this.gridSize,H=e.pos.y/this.gridSize,W=z(1,1);let J=~~q,Y=~~H,tt=0,ot=0;y.x<0?(W.x=-1,tt=(q-J)*U):(W.x=1,tt=(J+1-q)*U),y.y<0?(W.y=-1,ot=(H-Y)*O):(W.y=1,ot=(Y+1-H)*O);const Q=new Set;let _t=!1,It=9999;for(;!_t&&It>0&&(It--,!!this.hashGrid.bounds.contains(z(J*this.gridSize,Y*this.gridSize)));){const Yt=ts.calculateHashKey(J,Y),Zt=this.hashGrid.sparseHashGrid.get(Yt);if(Zt){const Te=[];for(let te=0;te<Zt.proxies.length;te++){const zt=Zt.proxies[te];if(!Q.has(zt.collider.id.value)){if(Q.add(zt.collider.id.value),s?.ignoreCollisionGroupAll&&zt.body.group===As.All)continue;const Ge=(w&zt.body.group.category)!==0;if(zt.body.group&&!Ge)continue;const ke=zt.collider.rayCast(e,p);ke&&Te.push(ke)}}Te.sort((te,zt)=>te.distance-zt.distance);for(let te=0;te<Te.length;te++){const zt=Te[te];if(s?.filter){if(s.filter(zt)&&(f.push(zt),!b)){_t=!0;break}}else if(f.push(zt),!b){_t=!0;break}}}tt<ot?(J+=W.x,tt+=U):(Y+=W.y,ot+=O)}return f.sort((Yt,Zt)=>Yt.distance-Zt.distance),!b&&f.length?[f[0]]:f}track(e){let s=[e];if(e instanceof Pe){const r=e.getColliders();for(const a of r)a.owner=e.owner;s=r}for(const r of s)this.hashGrid.track(r)}untrack(e){let s=[e];e instanceof Pe&&(s=e.getColliders());for(const r of s)this.hashGrid.untrack(r)}_canCollide(e,s){return!(e.collider.id===s.collider.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.hasZeroBounds||s.hasZeroBounds||!e.body.group.canCollide(s.body.group)||e.collisionType===ft.Fixed&&s.collisionType===ft.Fixed||e.collisionType===ft.PreventCollision||s.collisionType===ft.PreventCollision||!e.owner.isActive||!s.owner.isActive)}broadphase(e,s){const r=[];this._pairs.clear(),this._nonPairs.clear();let a=0;for(const l of this.hashGrid.objectToProxy.values())if(l.id=a++,!(!l.owner.isActive||l.collisionType===ft.PreventCollision))for(let f=0;f<l.cells.length;f++){const p=l.cells[f];for(let m=0;m<p.proxies.length;m++){const w=p.proxies[m];if(w.id===l.id)continue;const b=Ke.calculatePairHash(l.collider.id,w.collider.id);if(!this._nonPairs.has(b))if(!this._pairs.has(b)&&this._canCollide(l,w)&&l.object.bounds.overlaps(w.object.bounds)){const y=this._pairPool.get();y.colliderA=l.collider,y.colliderB=w.collider,y.id=b,this._pairs.add(b),r.push(y)}else this._nonPairs.add(b)}}return r}narrowphase(e,s){const r=[];for(let a=0;a<e.length;a++){const l=e[a].collide();for(let f=0;f<l.length;f++){const p=l[f];r.push(p),s&&s.physics.contacts.set(p.id,p)}}return this._pairPool.done(),s&&(s.physics.collisions+=r.length),r}update(e,s){return this.hashGrid.update(e)}debug(e,s){this.hashGrid.debug(e,s)}}class Su{get config(){return jp(this._config,e=>{this.$configUpdate.notifyAll(e)})}set config(e){this._config=e,this.$configUpdate.notifyAll(e)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const e=this._collisionProcessor.getColliders();this._config.spatialPartition===Yn.SparseHashGrid?this._collisionProcessor=new nl(this._config.sparseHashGrid):this._collisionProcessor=new No(this._config);for(const s of e)this._collisionProcessor.track(s)}return this._collisionProcessor}constructor(e){this.$configUpdate=new Ze,this._configDirty=!1,this.config=e,this.$configUpdate.subscribe(s=>{this._configDirty=!0,Et.updateDefaultPhysicsConfig(s.bodies)}),this._config.spatialPartition===Yn.SparseHashGrid?this._collisionProcessor=new nl(this._config.sparseHashGrid):this._collisionProcessor=new No(this._config)}rayCast(e,s){return this.collisionProcessor.rayCast(e,s)}query(e){return this._collisionProcessor.query(e)}}class Jo{constructor(){this.events=new I,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(e){this._enabled=e}setMinimumGamepadConfiguration(e){this._enableAndUpdate(),this._minimumConfiguration=e}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(e){if(!this._minimumConfiguration)return!0;if(!e)return!1;const s=e.axes.filter(a=>typeof a!==void 0).length,r=e.buttons.filter(a=>typeof a!==void 0).length;return s>=this._minimumConfiguration.axis&&r>=this._minimumConfiguration.buttons&&e.connected}emit(e,s){this.events.emit(e,s)}on(e,s){return this._enableAndUpdate(),this.events.on(e,s)}once(e,s){return this._enableAndUpdate(),this.events.once(e,s)}off(e,s){this._enableAndUpdate(),this.events.off(e,s)}update(){var e,s;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const r=this._navigator.getGamepads();for(let a=0;a<r.length;a++){if(r[a]){const f=this.at(a);!this.at(a).connected&&this._isGamepadValid(r[a])&&(f.events.pipe(this.events),this.events.emit("connect",new ph(a,this.at(a)))),this.at(a).connected=!0}else{const f=this.at(a);f.connected&&(this.events.emit("disconnect",new _h(a,f)),f.events.unpipe(this.events)),f.connected=!1;continue}if(this.at(a).update(),r[a].timestamp&&r[a].timestamp===this._gamePadTimeStamps[a])continue;this._gamePadTimeStamps[a]=r[a].timestamp,this.at(a).navigatorGamepad=r[a];const l=r[a];if(l){for(let f=0;f<l.buttons.length;f++){const p=l.buttons[f],m=p?.value;m!==((e=this._oldPads[a])===null||e===void 0?void 0:e.getButton(f))&&(p?.pressed?(this.at(a).updateButton(f,m),this.at(a).events.emit("button",new mh(f in zr?f:zr.Unknown,f,m,this.at(a)))):this.at(a).updateButton(f,0))}for(let f=0;f<l.axes.length;f++){const p=l.axes[f];p!==((s=this._oldPads[a])===null||s===void 0?void 0:s.getAxes(f))&&(this.at(a).updateAxes(f,p),this.at(a).events.emit("axis",new vh(f,p,this.at(a))))}}this._oldPads[a]=this._clonePad(r[a])}}at(e){if(this._enableAndUpdate(),e>=this._pads.length)for(let s=this._pads.length-1,r=e;s<r;s++)this._pads.push(new Ko),this._oldPads.push(new Ko);return this._pads[e]}getValidGamepads(){this._enableAndUpdate();const e=[];for(let s=0;s<this._pads.length;s++)this._isGamepadValid(this.at(s).navigatorGamepad)&&this.at(s).connected&&e.push(this.at(s));return e}count(){return this._pads.filter(e=>e.connected).length}_clonePads(e){const s=[];for(let r=0,a=e.length;r<a;r++)s.push(this._clonePad(e[r]));return s}_clonePad(e){let s,r;const a=new Ko;if(!e)return a;for(s=0,r=e.buttons.length;s<r;s++)e.buttons[s]&&a.updateButton(s,e.buttons[s].value);for(s=0,r=e.axes.length;s<r;s++)a.updateAxes(s,e.axes[s]);return a}}Jo.MinAxisMoveThreshold=.05;class Ko{constructor(){this.events=new I,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let e=0;e<this._buttons.length;e++)this._buttons[e]=0;for(let e=0;e<this._axes.length;e++)this._axes[e]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(e,s=1){return this._buttons[e]>=s}isButtonHeld(e,s=1){return this._buttons[e]>=s}wasButtonPressed(e,s=1){return this._buttonsDown[e]>=s}wasButtonReleased(e){return!!this._buttonsUp[e]}getButton(e){return this._buttons[e]}getAxes(e){const s=this._axes[e];return Math.abs(s)<Jo.MinAxisMoveThreshold?0:s}updateButton(e,s){s===0&&this._buttons[e]?this._buttonsUp[e]=1:this._buttonsDown[e]=s,this._buttons[e]=s}updateAxes(e,s){this._axes[e]=s}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}var zr;(function(u){u[u.Unknown=-1]="Unknown",u[u.Face1=0]="Face1",u[u.Face2=1]="Face2",u[u.Face3=2]="Face3",u[u.Face4=3]="Face4",u[u.LeftBumper=4]="LeftBumper",u[u.RightBumper=5]="RightBumper",u[u.LeftTrigger=6]="LeftTrigger",u[u.RightTrigger=7]="RightTrigger",u[u.Select=8]="Select",u[u.Start=9]="Start",u[u.LeftStick=10]="LeftStick",u[u.RightStick=11]="RightStick",u[u.DpadUp=12]="DpadUp",u[u.DpadDown=13]="DpadDown",u[u.DpadLeft=14]="DpadLeft",u[u.DpadRight=15]="DpadRight",u[u.CenterButton=16]="CenterButton",u[u.MiscButton1=17]="MiscButton1"})(zr||(zr={}));var rl;(function(u){u[u.LeftStickX=0]="LeftStickX",u[u.LeftStickY=1]="LeftStickY",u[u.RightStickX=2]="RightStickX",u[u.RightStickY=3]="RightStickY"})(rl||(rl={}));class Pu{constructor(e){this.inputs=e,this._handlers=new Map}execute(){for(const[e,s]of this._handlers.entries()){const r=e(this.inputs);r&&s(r)}}on(e,s){this._handlers.set(e,s)}}function Eu(){try{const u=()=>{};window.top.addEventListener("blur",u),window.top.removeEventListener("blur",u)}catch{return!0}return!1}var Hr;(function(u){u.Backquote="Backquote",u.Backslash="Backslash",u.BracketLeft="BracketLeft",u.BracketRight="BracketRight",u.Comma="Comma",u.Key0="Digit0",u.Key1="Digit1",u.Key2="Digit2",u.Key3="Digit3",u.Key4="Digit4",u.Key5="Digit5",u.Key6="Digit6",u.Key7="Digit7",u.Key8="Digit8",u.Key9="Digit9",u.Digit0="Digit0",u.Digit1="Digit1",u.Digit2="Digit2",u.Digit3="Digit3",u.Digit4="Digit4",u.Digit5="Digit5",u.Digit6="Digit6",u.Digit7="Digit7",u.Digit8="Digit8",u.Digit9="Digit9",u.Equal="Equal",u.IntlBackslash="IntlBackslash",u.IntlRo="IntlRo",u.IntlYen="IntlYen",u.A="KeyA",u.B="KeyB",u.C="KeyC",u.D="KeyD",u.E="KeyE",u.F="KeyF",u.G="KeyG",u.H="KeyH",u.I="KeyI",u.J="KeyJ",u.K="KeyK",u.L="KeyL",u.M="KeyM",u.N="KeyN",u.O="KeyO",u.P="KeyP",u.Q="KeyQ",u.R="KeyR",u.S="KeyS",u.T="KeyT",u.U="KeyU",u.V="KeyV",u.W="KeyW",u.X="KeyX",u.Y="KeyY",u.Z="KeyZ",u.KeyA="KeyA",u.KeyB="KeyB",u.KeyC="KeyC",u.KeyD="KeyD",u.KeyE="KeyE",u.KeyF="KeyF",u.KeyG="KeyG",u.KeyH="KeyH",u.KeyI="KeyI",u.KeyJ="KeyJ",u.KeyK="KeyK",u.KeyL="KeyL",u.KeyM="KeyM",u.KeyN="KeyN",u.KeyO="KeyO",u.KeyP="KeyP",u.KeyQ="KeyQ",u.KeyR="KeyR",u.KeyS="KeyS",u.KeyT="KeyT",u.KeyU="KeyU",u.KeyV="KeyV",u.KeyW="KeyW",u.KeyX="KeyX",u.KeyY="KeyY",u.KeyZ="KeyZ",u.Minus="Minus",u.Period="Period",u.Quote="Quote",u.Semicolon="Semicolon",u.Slash="Slash",u.AltLeft="AltLeft",u.AltRight="AltRight",u.Alt="Alt",u.AltGraph="AltGraph",u.Backspace="Backspace",u.CapsLock="CapsLock",u.ContextMenu="ContextMenu",u.ControlLeft="ControlLeft",u.ControlRight="ControlRight",u.Enter="Enter",u.MetaLeft="MetaLeft",u.MetaRight="MetaRight",u.ShiftLeft="ShiftLeft",u.ShiftRight="ShiftRight",u.Space="Space",u.Tab="Tab",u.Convert="Convert",u.KanaMode="KanaMode",u.NonConvert="NonConvert",u.Delete="Delete",u.End="End",u.Help="Help",u.Home="Home",u.Insert="Insert",u.PageDown="PageDown",u.PageUp="PageUp",u.Up="ArrowUp",u.Down="ArrowDown",u.Left="ArrowLeft",u.Right="ArrowRight",u.ArrowUp="ArrowUp",u.ArrowDown="ArrowDown",u.ArrowLeft="ArrowLeft",u.ArrowRight="ArrowRight",u.NumLock="NumLock",u.Numpad0="Numpad0",u.Numpad1="Numpad1",u.Numpad2="Numpad2",u.Numpad3="Numpad3",u.Numpad4="Numpad4",u.Numpad5="Numpad5",u.Numpad6="Numpad6",u.Numpad7="Numpad7",u.Numpad8="Numpad8",u.Numpad9="Numpad9",u.Num0="Numpad0",u.Num1="Numpad1",u.Num2="Numpad2",u.Num3="Numpad3",u.Num4="Numpad4",u.Num5="Numpad5",u.Num6="Numpad6",u.Num7="Numpad7",u.Num8="Numpad8",u.Num9="Numpad9",u.NumAdd="NumpadAdd",u.NumpadAdd="NumpadAdd",u.NumDecimal="NumpadDecimal",u.NumpadDecimal="NumpadDecimal",u.NumDivide="NumpadDivide",u.NumpadDivide="NumpadDivide",u.NumEnter="NumpadEnter",u.NumpadEnter="NumpadEnter",u.NumMultiply="NumpadMultiply",u.NumpadMultiply="NumpadMultiply",u.NumSubtract="NumpadSubtract",u.NumpadSubtract="NumpadSubtract",u.Esc="Escape",u.Escape="Escape",u.F1="F1",u.F2="F2",u.F3="F3",u.F4="F4",u.F5="F5",u.F6="F6",u.F7="F7",u.F8="F8",u.F9="F9",u.F10="F10",u.F11="F11",u.F12="F12",u.F13="F13",u.F14="F14",u.F15="F15",u.F16="F16",u.F17="F17",u.F18="F18",u.F19="F19",u.F20="F20",u.PrintScreen="PrintScreen",u.ScrollLock="ScrollLock",u.Pause="Pause",u.Unidentified="Unidentified"})(Hr||(Hr={}));class Or extends xt{constructor(e,s,r){super(),this.key=e,this.value=s,this.originalEvent=r}}class Tu{constructor(){this.events=new I,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=e=>{for(const s of this._keys){const r=new Or(s,e.key,e);this.events.emit("up",r),this.events.emit("release",r)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=e=>{if(!this._enabled)return;!e.metaKey&&(this._keys.includes(Hr.MetaLeft)||this._keys.includes(Hr.MetaRight))&&this._releaseAllKeys(e);const s=e.code;if(this._keys.indexOf(s)===-1){this._keys.push(s),this._keysDown.push(s);const r=new Or(s,e.key,e);this.events.emit("down",r),this.events.emit("press",r)}},this._handleKeyUp=e=>{if(!this._enabled)return;const s=e.code,r=this._keys.indexOf(s);this._keys.splice(r,1),this._keysUp.push(s);const a=new Or(s,e.key,e);this.events.emit("up",a),this.events.emit("release",a),e.key==="Meta"&&this._releaseAllKeys(e)}}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}init(e){let{global:s}=e;const{grabWindowFocus:r}=e;s||(Eu()?(s=window,r&&window.focus(),at.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):s=window.top),s.addEventListener("blur",()=>{this._keys.length=0}),s.addEventListener("keyup",this._handleKeyUp),s.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(e){this._enabled=e}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let e=0;e<this._keys.length;e++)this.events.emit("hold",new Or(this._keys[e]))}getKeys(){return this._keys}wasPressed(e){return this._enabled?this._keysDown.indexOf(e)>-1:!1}isHeld(e){return this._enabled?this._keys.indexOf(e)>-1:!1}wasReleased(e){return this._enabled?this._keysUp.indexOf(e)>-1:!1}triggerEvent(e,s,r){e==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:s,key:r??null})),e==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:s,key:r??null}))}}class Qn{static fromPagePosition(e,s,r){let a,l,f,p;arguments.length===3?(a=e,l=s,f=new B(a,l),p=r):(f=e,a=f.x,l=f.y,p=s);const m=p.screen.pageToScreenCoordinates(f),w=p.screen.screenToWorldCoordinates(m);return new Qn(w,f,m)}constructor(e,s,r){this.worldPos=e,this.pagePos=s,this.screenPos=r}}class Vr{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(e,s,r,a,l,f){this.type=e,this.pointerId=s,this.button=r,this.pointerType=a,this.coordinates=l,this.nativeEvent=f,this.active=!0}}class Iu{cancel(){this.active=!1}constructor(e,s,r,a,l,f,p,m,w,b,y,T){this.x=e,this.y=s,this.pageX=r,this.pageY=a,this.screenX=l,this.screenY=f,this.index=p,this.deltaX=m,this.deltaY=w,this.deltaZ=b,this.deltaMode=y,this.ev=T,this.active=!0}}class ol{constructor(){this.events=new I,this.lastPagePos=B.Zero,this.lastScreenPos=B.Zero,this.lastWorldPos=B.Zero,this._onPointerMove=e=>{this.lastPagePos=new B(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new B(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new B(e.worldPos.x,e.worldPos.y)},this._onPointerDown=e=>{this.lastPagePos=new B(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new B(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new B(e.worldPos.x,e.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_updateWorldPosition(e){const s=Qn.fromPagePosition(this.lastPagePos,e);this.lastScreenPos=s.screenPos,this.lastWorldPos=s.worldPos}}var Zn;(function(u){u.Pixel="Pixel",u.Line="Line",u.Page="Page"})(Zn||(Zn={}));var qs;(function(u){u[u.NoButton=-1]="NoButton",u[u.Left=0]="Left",u[u.Middle=1]="Middle",u[u.Right=2]="Right",u[u.Unknown=3]="Unknown"})(qs||(qs={}));var Cs;(function(u){u.Left="Left",u.Middle="Middle",u.Right="Right",u.Unknown="Unknown",u.NoButton="NoButton"})(Cs||(Cs={}));var Ss;(function(u){u.Touch="Touch",u.Mouse="Mouse",u.Pen="Pen",u.Unknown="Unknown"})(Ss||(Ss={}));function em(u){return globalThis.TouchEvent&&u instanceof globalThis.TouchEvent}function im(u){return globalThis.PointerEvent&&u instanceof globalThis.PointerEvent}class $o{constructor(e,s){this.target=e,this.engine=s,this.events=new I,this.primary=new ol,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(e){this._enabled=e}recreate(e,s){const r=new $o(e,s);return r.primary=this.primary,r._pointers=this._pointers,r}at(e){if(e>=this._pointers.length)for(let s=this._pointers.length-1,r=e;s<r;s++)this._pointers.push(new ol);return this._pointers[e]}count(){return this._pointers.length}isDown(e){var s;return this._enabled&&(s=this.currentFramePointerDown.get(e))!==null&&s!==void 0?s:!1}wasDown(e){var s;return this._enabled&&(s=this.lastFramePointerDown.get(e))!==null&&s!==void 0?s:!1}isDragging(e){return this._enabled?this.isDown(e):!1}isDragStart(e){return this._enabled?this.isDown(e)&&!this.wasDown(e):!1}isDragEnd(e){return this._enabled?!this.isDown(e)&&this.wasDown(e):!1}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const e of this.currentFrameDown){if(!e.active)continue;this.emit("down",e),this.at(e.pointerId).emit("down",e),this.primary.emit("pointerdown",e)}for(const e of this.currentFrameUp){if(!e.active)continue;this.emit("up",e),this.at(e.pointerId).emit("up",e)}for(const e of this.currentFrameMove){if(!e.active)continue;this.emit("move",e),this.at(e.pointerId).emit("move",e)}for(const e of this.currentFrameCancel){if(!e.active)continue;this.emit("cancel",e),this.at(e.pointerId).emit("cancel",e)}for(const e of this.currentFrameWheel)e.active&&(this.emit("pointerwheel",e),this.emit("wheel",e),this.primary.emit("pointerwheel",e),this.primary.emit("wheel",e));if(this.engine.currentScene.camera.hasChanged())for(const e of this._pointers)e._updateWorldPosition(this.engine)}clear(){for(const e of this.currentFrameUp){this.currentFramePointerCoords.delete(e.pointerId);const s=this._activeNativePointerIdsToNormalized.entries();for(const[r,a]of s)a===e.pointerId&&this._activeNativePointerIdsToNormalized.delete(r)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(e){var s;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const r={passive:!(this.engine.pageScrollPreventionMode===Ys.All||this.engine.pageScrollPreventionMode===Ys.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,r):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,r):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,r),((s=e?.grabWindowFocus)!==null&&s!==void 0?s:!0)&&Eu()){const l=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",l):(this.target.addEventListener("touchstart",l),this.target.addEventListener("mousedown",l))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(e){this._activeNativePointerIdsToNormalized.set(e,-1);const r=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((a,l)=>a-l).findIndex(a=>a===e);return this._activeNativePointerIdsToNormalized.set(e,r),r}_handle(e){if(!this._enabled)return;e.preventDefault();const s=new Map;let r,a;if(em(e)){r=Cs.Unknown,a=Ss.Touch;for(let l=0;l<e.changedTouches.length;l++){const f=e.changedTouches[l],p=Qn.fromPagePosition(f.pageX,f.pageY,this.engine),m=l+1,w=this._normalizePointerId(m);this.currentFramePointerCoords.set(w,p),s.set(w,p)}}else{r=this._nativeButtonToPointerButton(e.button),a=Ss.Mouse;const l=Qn.fromPagePosition(e.pageX,e.pageY,this.engine);let f=1;im(e)&&(f=e.pointerId,a=this._stringToPointerType(e.pointerType));const p=this._normalizePointerId(f);this.currentFramePointerCoords.set(p,l),s.set(p,l)}for(const[l,f]of s.entries())switch(e.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new Vr("down",l,r,a,f,e)),this.currentFramePointerDown.set(l,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new Vr("up",l,r,a,f,e)),this.currentFramePointerDown.set(l,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new Vr("move",l,r,a,f,e));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new Vr("cancel",l,r,a,f,e));break}}_handleWheel(e){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Ys.All||this.engine.pageScrollPreventionMode===Ys.Canvas&&e.target===this.engine.canvas)&&e.preventDefault();const s=this.engine.screen.pageToScreenCoordinates(z(e.pageX,e.pageY)),r=this.engine.screen.screenToWorldCoordinates(s),a=-1/40,l=e.deltaX||e.wheelDeltaX*a||0,f=e.deltaY||e.wheelDeltaY*a||e.wheelDelta*a||e.detail||0,p=e.deltaZ||0;let m=Zn.Pixel;e.deltaMode&&(e.deltaMode===1?m=Zn.Line:e.deltaMode===2&&(m=Zn.Page));const w=new Iu(r.x,r.y,e.pageX,e.pageY,s.x,s.y,0,l,f,p,m,e);this.currentFrameWheel.push(w)}triggerEvent(e,s){const r=this.engine.screen.worldToPageCoordinates(s);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+e,{pointerId:0,clientX:r.x,clientY:r.y})):this._handle(new window.MouseEvent("mouse"+e,{clientX:r.x,clientY:r.y}));const a=this.engine.currentScene.world.get(Zo);a.preupdate(this.engine.currentScene,1),a.update(1)}_nativeButtonToPointerButton(e){switch(e){case qs.NoButton:return Cs.NoButton;case qs.Left:return Cs.Left;case qs.Middle:return Cs.Middle;case qs.Right:return Cs.Right;case qs.Unknown:return Cs.Unknown;default:return ud(e)}}_stringToPointerType(e){switch(e){case"touch":return Ss.Touch;case"mouse":return Ss.Mouse;case"pen":return Ss.Pen;default:return Ss.Unknown}}}class al{constructor(e){this._enabled=!0;const{pointerTarget:s,grabWindowFocus:r,engine:a}=e;this.keyboard=new Tu,this.pointers=new $o(s,a),this.gamepads=new Jo,this.keyboard.init({grabWindowFocus:r}),this.pointers.init({grabWindowFocus:r}),this.gamepads.init(),this.inputMapper=new Pu({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(e){this._enabled=e,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class sm{}const nm={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function es(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class Ci{get actors(){return this.world.entityManager.entities.filter(e=>e instanceof $e)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(e=>e instanceof mu)}get tileMaps(){return this.world.entityManager.entities.filter(e=>e instanceof hu)}get timers(){return this._timers}constructor(){this._logger=at.getInstance(),this.events=new I,this.camera=new _u,this.world=new bu(this),this.physics=new Su(ys()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(el),this.world.add(new jo(this.world,this.physics)),this.world.add(new Qo(this.world,this.physics)),this.world.add(Zo),this.world.add(il),this.world.add(sl),this.world.add(Jh),this.world.add(Kh)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}onPreLoad(e){}onTransition(e){}onInitialize(e){}onActivate(e){}onDeactivate(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreDraw(e,s){}onPostDraw(e,s){}_initializeChildren(){for(const e of this.entities)e._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(e){var s;if(!this.isInitialized){try{this.engine=e,this.physics.config=this.engine.physics,this.input=new al({pointerTarget:e.pointerScope===F.Canvas?e.canvas:document,grabWindowFocus:e.grabWindowFocus,engine:e}),this.camera._initialize(e),this.world.systemManager.initialize(),await this.onInitialize(e),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,e),this.events.emit("initialize",new qn(e,this))}catch(r){throw this._logger.error(`Error during scene initialization for scene ${(s=e.director)===null||s===void 0?void 0:s.getSceneName(this)}!`),r}this._isInitialized=!0}}async _activate(e){var s,r;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(e)}catch(a){throw this._logger.error(`Error during scene activation for scene ${(r=(s=this.engine)===null||s===void 0?void 0:s.director)===null||r===void 0?void 0:r.getSceneName(this)}!`),a}}async _deactivate(e){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(e)}_preupdate(e,s){this.emit("preupdate",new Ws(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.emit("postupdate",new Ns(e,s,this)),this.onPostUpdate(e,s)}_predraw(e,s){this.emit("predraw",new Gn(e,s,this)),this.onPreDraw(e,s)}_postdraw(e,s){this.emit("postdraw",new Xn(e,s,this)),this.onPostDraw(e,s)}update(e,s){var r;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(r=e.director)===null||r===void 0?void 0:r.getSceneName(this)}!`);return}this._preupdate(e,s);let a,l;for(a=0,l=this._cancelQueue.length;a<l;a++)this.removeTimer(this._cancelQueue[a]);this._cancelQueue.length=0;for(const f of this._timers)f.update(s);this.world.update(mi.Update,s),this.camera&&this.camera.update(e,s),this._collectActorStats(e),this._postupdate(e,s),this.input.update()}draw(e,s){var r;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(e,s),this.world.update(mi.Draw,s),!((r=this.engine)===null||r===void 0)&&r.isDebug&&this.debugDraw(e),this._postdraw(e,s)}debugDraw(e){this.emit("predebugdraw",new dh(e,this)),this.emit("postdebugdraw",new uh(e,this))}contains(e){return this.actors.indexOf(e)>-1}add(e){if(this.emit("entityadded",{target:e}),e instanceof _n){Ao(this._timers,e)||this.addTimer(e);return}this.world.add(e),e.scene=this}transfer(e){let s;e instanceof Ve&&e.scene&&e.scene!==this&&(s=e.scene,e.scene.world.remove(e,!1)),e instanceof _n&&e.scene&&(s=e.scene,e.scene.removeTimer(e)),s?.emit("entityremoved",{target:e}),this.add(e)}remove(e){this.emit("entityremoved",{target:e}),e instanceof Ve&&(e.isActive&&e.kill(),this.world.remove(e)),e instanceof _n&&this.removeTimer(e)}clear(e=!0){for(let s=this.entities.length-1;s>=0;s--)this.world.remove(this.entities[s],e);for(let s=this.timers.length-1;s>=0;s--)this.removeTimer(this.timers[s])}addTimer(e){return this._timers.push(e),e.scene=this,e}removeTimer(e){const s=this._timers.indexOf(e);return s!==-1&&this._timers.splice(s,1),e}cancelTimer(e){return this._cancelQueue.push(e),e}isTimerActive(e){return this._timers.indexOf(e)>-1&&!e.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(e){const s=this.actors;for(let r=0;r<s.length;r++){const a=s[r];a instanceof Yh&&e.stats.currFrame.actors.ui++,e.stats.currFrame.actors.alive++;for(let l=0;l<a.children.length;l++){const f=a.children[l];ou(f)?e.stats.currFrame.actors.ui++:e.stats.currFrame.actors.alive++}}}}var mn;(function(u){u.Protanope="Protanope",u.Deuteranope="Deuteranope",u.Tritanope="Tritanope"})(mn||(mn={}));const rm=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class Ru{constructor(e,s){this._shader=new ni({gl:e,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:s}),this._shader.compile(),this._buffer=new Qi({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new vs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class Du{constructor(e,s=!1){this._colorBlindnessMode=e,this._simulate=!1,this._simulate=s}initialize(e){this._shader=new Ru(e,rm),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(e){if(this._colorBlindnessMode=e,this._shader){const s=this._shader.getShader();s.use(),this._colorBlindnessMode===mn.Protanope?s.setUniformInt("u_type",0):this._colorBlindnessMode===mn.Deuteranope?s.setUniformInt("u_type",1):this._colorBlindnessMode===mn.Tritanope&&s.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(e){if(this._simulate=e,this._shader){const s=this._shader.getShader();s.use(),s.setUniformBoolean("u_simulate",e)}}get simulate(){return this._simulate}}class Fu{constructor(e){this._engine=e,this._colorBlindPostProcessor=new Du(mn.Protanope)}correct(e){this._engine.graphicsContext instanceof xs&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(e){this._engine.graphicsContext instanceof xs&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class Mu{constructor(e){this.stats={currFrame:new Wr,prevFrame:new Wr},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:Z.Yellow,showZIndex:!1,showScale:!1,scaleColor:Z.Green,showRotation:!1,rotationColor:Z.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:Z.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:Z.Blue,showOwner:!1,showGeometry:!0,geometryColor:Z.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:Z.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:Z.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:Z.Yellow,showAcceleration:!1,accelerationColor:Z.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:Z.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:Z.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:Z.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:Z.Yellow,positionSize:1,showGrid:!1,gridColor:Z.Red,gridWidth:1,showColliderGeometry:!0},this._engine=e,this.colorBlindMode=new Fu(this._engine)}useTestClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const r=e.toTestClock();return s&&r.start(),this._engine.clock=r,r}useStandardClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const r=e.toStandardClock();return s&&r.start(),this._engine.clock=r,r}}class Wr{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new ta,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(e){e?(this.id=e.id,this.elapsedMs=e.elapsedMs,this.fps=e.fps,this.actors.alive=e.actors.alive,this.actors.killed=e.actors.killed,this.actors.ui=e.actors.ui,this.duration.update=e.duration.update,this.duration.draw=e.duration.draw,this._physicsStats.reset(e.physics),this.graphics.drawCalls=e.graphics.drawCalls,this.graphics.drawnImages=e.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const e=new Wr;return e.reset(this),e}get id(){return this._id}set id(e){this._id=e}get elapsedMs(){return this._elapsedMs}set elapsedMs(e){this._elapsedMs=e}get fps(){return this._fps}set fps(e){this._fps=e}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class ta{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(e){e?(this.pairs=e.pairs,this.collisions=e.collisions,this.contacts=e.contacts,this.fastBodies=e.fastBodies,this.fastBodyCollisions=e.fastBodyCollisions,this.broadphase=e.broadphase,this.narrowphase=e.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const e=new ta;return e.reset(this),e}get pairs(){return this._pairs}set pairs(e){this._pairs=e}get collisions(){return this._collisions}set collisions(e){this._collisions=e}get contacts(){return this._contacts}set contacts(e){this._contacts=e}get fastBodies(){return this._fastBodies}set fastBodies(e){this._fastBodies=e}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(e){this._fastBodyCollisions=e}get broadphase(){return this._broadphase}set broadphase(e){this._broadphase=e}get narrowphase(){return this._narrowphase}set narrowphase(e){this._narrowphase=e}}class hl{on(e,s){this._nativeHandlers[e]&&this.off(e,this._nativeHandlers[e]),this._nativeHandlers[e]=this._decorate(s),this.nativeComponent.addEventListener(e,this._nativeHandlers[e])}off(e,s){s||(s=this._nativeHandlers[e]),this.nativeComponent.removeEventListener(e,s),this._nativeHandlers[e]=null}_decorate(e){return s=>{this._paused||e(s)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const e in this._nativeHandlers)this.off(e)}constructor(e){this.nativeComponent=e,this._paused=!1,this._nativeHandlers={}}}class Bu{constructor(e,s){this._windowGlobal=e,this._documentGlobal=s,this._windowComponent=new hl(this._windowGlobal),this._documentComponent=new hl(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const ku={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:_e.Blended,canvasImageRendering:"auto"},Lu={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:_e.Blended,canvasImageRendering:"auto"};class Uu{constructor(e){var s;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=e.initialFps,this._samplePeriod=(s=e.samplePeriod)!==null&&s!==void 0?s:this._samplePeriod,this._currentFrameTime=1e3/e.initialFps,this._nowFn=e.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const e=this._nowFn();this._currentFrameTime=e-this._beginFrameTime,e>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(e-this._previousSampleTime),this._previousSampleTime=e,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class ll{constructor(e){var s,r,a;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=e,this.tick=e.tick,this._lastTime=(s=this.now())!==null&&s!==void 0?s:0,this._maxFps=(r=e.maxFps)!==null&&r!==void 0?r:this._maxFps,this._onFatalException=(a=e.onFatalException)!==null&&a!==void 0?a:this._onFatalException,this.fpsSampler=new Uu({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new zu({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new cl({...this._options})}setFatalExceptionHandler(e){this._onFatalException=e}schedule(e,s=0,r="preframe"){const a=this._totalElapsed+s;this._scheduledCbs.push([e,a,r])}__runScheduledCbs(e="preframe"){for(let s=this._scheduledCbs.length-1;s>-1;s--)e===this._scheduledCbs[s][2]&&this._scheduledCbs[s][1]<=this._totalElapsed&&(this._scheduledCbs[s][0](this._elapsed),this._scheduledCbs.splice(s,1))}update(e){try{this.fpsSampler.start();const s=this.now();let r=s-this._lastTime||1;const a=1e3/this._maxFps;if(r>=a){let l=0;a!==0&&(l=r%a,r=r-l),r>200&&(r=1),this._elapsed=e||r,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(e||r),this.__runScheduledCbs("postframe"),a!==0?this._lastTime=s-l:this._lastTime=s,this.fpsSampler.end()}}catch(s){this._onFatalException(s),this.stop()}}}class cl extends ll{constructor(e){super(e),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const e=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(e),this.update()}catch(s){throw window.cancelAnimationFrame(this._requestId),s}};e()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class zu extends ll{constructor(e){super({...e}),this._logger=at.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=e.defaultUpdateMs}now(){var e;return(e=this._currentTime)!==null&&e!==void 0?e:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(e){const s=e??this._updateMs;this._running?(this.update(s),this._currentTime+=s):this._logger.warn("The clock is not running, no step will be performed")}run(e,s){for(let r=0;r<e;r++)this.step(s??this._updateMs)}}var om=o(296);class Hu{constructor(){this._toasterCss=om.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(e){const s=document.createElement("span");return s.innerText=e,s}toast(e,s,r){this._initialize();const a=document.createElement("div");a.className="ex-toast-message";const l=e.split("[LINK]").map(b=>this._createFragment(b));if(s){const b=document.createElement("a");b.href=s,r?b.innerText=r:b.innerText=s,l.splice(1,0,b)}const f=document.createElement("div");l.forEach(b=>{f.appendChild(b)}),a.appendChild(f);const p=document.createElement("button");p.innerText="x",p.addEventListener("click",()=>{this._container.removeChild(a)}),a.appendChild(p);const m=b=>{if(b.key==="Escape")try{this._container.removeChild(a)}catch{}document.removeEventListener("keydown",m)};document.addEventListener("keydown",m);const w=this._container.firstChild;this._container.insertBefore(a,w)}}const am={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class Ou{get isTransitioning(){return this._isTransitioning}constructor(e,s){this._engine=e,this.events=new I,this._logger=at.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new Ci,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const r in s){const a=s[r];this.add(r,a),r==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const e=this._deferredGoto;this._deferredGoto=void 0;const s=this._deferredTransition;this._deferredTransition=void 0;const r=this.getSceneInstance(e);r&&s&&s._addToTargetScene(this._engine,r),await this.swapScene(e),r&&s&&await this.playTransition(s,r)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(e,s){const r=s?.loader;r instanceof Tr?this.mainLoader=r:kh(r)?this.mainLoader=new r:this.mainLoader=new fn;let a;if(s?.inTransition){const{inTransition:l}=s;a=l}if(this.startScene=e,a){const l=this.getSceneInstance(this.startScene);l&&(a._addToTargetScene(this._engine,l),this.swapScene(this.startScene).then(()=>this.playTransition(a,l)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(e){return this._sceneToLoader.get(e)}_getInTransition(e){var s;const r=this.scenes[e];if(!(r instanceof Ci||es(r)))return(s=r?.transitions)===null||s===void 0?void 0:s.in}_getOutTransition(e){var s;const r=this.scenes[e];if(!(r instanceof Ci||es(r)))return(s=r?.transitions)===null||s===void 0?void 0:s.out}getDeferredScene(){const e=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&e?e:null}getSceneDefinition(e){const s=this.scenes[e];if(s instanceof Ci||es(s))return s;if(s)return s.scene}getSceneName(e){for(const[s,r]of Object.entries(this.scenes))if(r instanceof Ci){if(e===r)return s}else if(!es(r)&&e===r.scene)return s;for(const[s,r]of Object.entries(this.scenes))if(es(r)){if(e.constructor===r)return s}else if(!(r instanceof Ci)&&e.constructor===r.scene)return s;return null}assertAdded(e){return this}assertRemoved(e){return this}add(e,s){if(!(s instanceof Ci)&&!es(s)){const{loader:r,transitions:a}=s,{in:l,out:f}=a??{};this._sceneToTransition.set(e,{in:l,out:f}),kh(r)?this._sceneToLoader.set(e,new r):r&&this._sceneToLoader.set(e,r)}return this.scenes[e]&&this._logger.warn("Scene",e,"already exists overwriting"),this.scenes[e]=s,this.assertAdded(e)}remove(e){if(e instanceof Ci||es(e)){const s=e;for(const r in this.scenes)if(this.scenes.hasOwnProperty(r)){const a=this.scenes[r];let l;if(a instanceof Ci||es(a)?l=a:l=a.scene,l===s){if(r===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${r}`);this._sceneToInstance.delete(r),this._sceneToTransition.delete(r),this._sceneToLoader.delete(r),delete this.scenes[r]}}}if(typeof e=="string"){if(e===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${e}`);this._sceneToInstance.delete(e),this._sceneToTransition.delete(e),this._sceneToLoader.delete(e),delete this.scenes[e]}}async goToScene(e,s){var r,a,l,f,p,m;const w=this.getSceneInstance(e);if(!w){this._logger.warn(`Scene ${e} does not exist! Check the name, are you sure you added it?`);return}const b=this.currentScene,y=this.currentSceneName,T=(a=(r=this._engine.input)===null||r===void 0?void 0:r.enabled)!==null&&a!==void 0?a:!0;this._isTransitioning=!0;const D=(l=this.getSceneInstance(y))===null||l===void 0?void 0:l.onTransition("out"),U=w?.onTransition("in");s={sourceOut:(f=this._getOutTransition(this.currentSceneName))!==null&&f!==void 0?f:D,destinationIn:(p=this._getInTransition(e))!==null&&p!==void 0?p:U,...s};const{sourceOut:O,destinationIn:q,sceneActivationData:H}=s,W=O??this._getOutTransition(this.currentSceneName),J=q??this._getInTransition(e),Y=W?.hideLoader||J?.hideLoader;Y&&this.maybeLoadScene(e,Y),this._emitEvent("navigationstart",y,e),W&&await this.playTransition(W,b),await this.maybeLoadScene(e,Y),J&&await J.onPreviousSceneDeactivate(this.currentScene),J&&J._addToTargetScene(this._engine,w),await this.swapScene(e,H),this._emitEvent("navigation",y,e),J&&await this.playTransition(J,w),this._emitEvent("navigationend",y,e),(m=this._engine.input)===null||m===void 0||m.toggleEnabled(T),this._isTransitioning=!1}getSceneInstance(e){const s=this.getSceneDefinition(e);if(!s)return;if(this._sceneToInstance.has(e))return this._sceneToInstance.get(e);if(s instanceof Ci)return this._sceneToInstance.set(e,s),s;const r=new s;return this._sceneToInstance.set(e,r),r}async maybeLoadScene(e,s=!1){var r;const a=(r=this._getLoader(e))!==null&&r!==void 0?r:new Tr,l=this.getSceneDefinition(e),f=this.getSceneInstance(e);l&&f&&!this._loadedScenes.has(f)&&(f.onPreLoad(a),f.events.emit("preload",{loader:a}),s?this._engine.load(a,s):await this._engine.load(a),this._loadedScenes.add(f))}async playTransition(e,s){var r,a,l,f,p,m,w;if(!this.isInitialized){this._deferredTransition=e;return}if(e){this.currentTransition=e;const b=(a=(r=s.input)===null||r===void 0?void 0:r.enabled)!==null&&a!==void 0?a:!0;(l=s.input)===null||l===void 0||l.toggleEnabled(!e.blockInput),(f=this._engine.input)===null||f===void 0||f.toggleEnabled(!e.blockInput),this.currentTransition._addToTargetScene(this._engine,s),await this.currentTransition._play(),(p=s.input)===null||p===void 0||p.toggleEnabled(b)}(m=this.currentTransition)===null||m===void 0||m.kill(),(w=this.currentTransition)===null||w===void 0||w.reset(),this.currentTransition=void 0}async swapScene(e,s){const r=this._engine;if(!this.isInitialized){this._deferredGoto=e;return}const a=this.getSceneInstance(e);if(a){const l=this.currentScene,f=a;if(this._logger.debug("Going to scene:",e),this.currentScene.isInitialized){const w={engine:r,previousScene:l,nextScene:f};await this.currentScene._deactivate(w),this.currentScene.events.emit("deactivate",new bh(w,this.currentScene)),this.currentScene.input.clear()}const p=this._sceneToLoader.get(e);await p?.areResourcesLoaded(),this.currentScene=f,this.currentSceneName=e,r.screen.setCurrentCamera(f.camera),await this.currentScene._initialize(r);const m={engine:r,previousScene:l,nextScene:f,data:s};await this.currentScene._activate(m),this.currentScene.events.emit("activate",new Ah(m,this.currentScene))}else this._logger.error("Scene",e,"does not exist!")}_emitEvent(e,s,r){const a=this.getSceneDefinition(s),l=this.getSceneDefinition(r);this.events.emit(e,{sourceScene:a,sourceName:s,destinationScene:l,destinationName:r})}}function Vu(){const u={scope:(e,s)=>{const r=u.value;u.value=e;try{return s()}catch(a){throw a}finally{u.value=r}},value:void 0};return u}function Wu(u){return u.value}const dl={textureCollectInterval:6e4};class Nu{constructor(e){this.options=e,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=s=>{if(this._running){for(const[r,[a,l]]of this._collectors.entries()){const f=this.options.getTimestamp();for(const[p,[m,w]]of this._collectionMap.entries()){if(r!==m||w+l>=f)continue;a(p)&&this._collectionMap.delete(p)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(e,s,r){this._collectors.set(e,[r,s])}addCollectableResource(e,s){this._collectionMap.set(s,[e,this.options.getTimestamp()])}touch(e){const s=this._collectionMap.get(e);s&&this._collectionMap.set(e,[s[0],this.options.getTimestamp()])}forceCollectAll(){for(const[e,[s]]of this._collectors.entries())for(const[r]of this._collectionMap.entries())s(r)&&this._collectionMap.delete(r)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}x();const hm={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Ys;(function(u){u[u.None=0]="None",u[u.Canvas=1]="Canvas",u[u.All=2]="All"})(Ys||(Ys={}));class oi{static useEngine(){const e=Wu(oi.Context);if(!e)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return e}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(e){this.graphicsContext.snapToPixel=e}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,r,a,l,f,p,m,w,b;this.scope=Y=>oi.Context.scope(this,Y),this.version=vl,this.events=new I,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=Y=>{at.getInstance().fatal(Y,Y.stack)},this._toaster=new Hu,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=Y=>{var tt;Y.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",Y);const ot=document.createElement("div");ot.id="ex-webgl-graphics-context-lost",ot.style.position="absolute",ot.style.zIndex="99",ot.style.left="50%",ot.style.top="50%",ot.style.display="flex",ot.style.flexDirection="column",ot.style.transform="translate(-50%, -50%)",ot.style.backgroundColor="white",ot.style.padding="10px",ot.style.borderStyle="solid 1px";const Q=document.createElement("div");if(Q.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,ot.appendChild(Q),!((tt=this.canvas)===null||tt===void 0)&&tt.parentElement){this.canvas.parentElement.appendChild(ot);const _t=Q.querySelector("#ex-webgl-graphics-reload");_t?.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new P,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],e={...oi._DEFAULT_ENGINE_OPTIONS,...e},this._originalOptions=e,A.freeze(),this.browser=new Bu(window,document);const y=new Td;if(!e.suppressMinimumBrowserFeatureDetection&&!(this._compatible=y.test())){const Y=document.createElement("div");if(Y.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(Y),y.failedTests.forEach(function(tt){const ot=document.createElement("div");ot.innerText="Browser feature missing "+tt,document.body.appendChild(ot)}),e.canvasElementId){const tt=document.getElementById(e.canvasElementId);tt&&tt.parentElement.removeChild(tt)}return}else this._compatible=!0;if(console.log&&!e.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${vl})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),e.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=at.getInstance(),this._logger.defaultLevel===Wt.Debug&&y.logBrowserFeatures(),this._logger.debug("Building engine..."),e.garbageCollection===!0?this.garbageCollectorConfig={...dl}:e.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...dl,...e.garbageCollection},this._garbageCollector=new Nu({getTimestamp:Date.now}),this.canvasElementId=e.canvasElementId,e.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+e.canvasElementId),document.getElementById(e.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(e.canvasElementId)}else e.canvasElement?(this._logger.debug("Using Canvas element specified:",e.canvasElement),this.canvas=e.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!e.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",Y=>{Y.preventDefault()});let T=(s=e.displayMode)!==null&&s!==void 0?s:Se.Fixed;e.width&&e.height||e.viewport?(e.displayMode===void 0&&(T=Se.Fixed),this._logger.debug("Engine viewport is size "+e.width+" x "+e.height)):e.displayMode||(this._logger.debug("Engine viewport is fit"),T=Se.FitScreen),this.grabWindowFocus=e.grabWindowFocus,this.pointerScope=e.pointerScope,this._originalDisplayMode=T;let D,U,O,q,H,W;typeof e.antialiasing=="object"?{pixelArtSampler:D,nativeContextAntialiasing:O,multiSampleAntialiasing:W,filtering:H,canvasImageRendering:q}={...e.pixelArt?Lu:ku,...e.antialiasing}:(D=!!e.pixelArt,O=!1,W=e.antialiasing,q=e.antialiasing?"auto":"pixelated",H=e.antialiasing?_e.Blended:_e.Pixel),O&&W&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),e.pixelArt&&(U=.25),(!e.antialiasing||H===_e.Pixel)&&(U=0),U=(a=(r=e.uvPadding)!==null&&r!==void 0?r:U)!==null&&a!==void 0?a:.01;let J=A.isEnabled("use-canvas-context");if(!J)try{this.graphicsContext=new xs({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:D,antialiasing:O,multiSampleAntialiasing:W,uvPadding:U,powerPreference:e.powerPreference,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(l=e.handleContextLost)!==null&&l!==void 0?l:this._handleWebGLContextLost,handleContextRestored:e.handleContextRestored})}catch(Y){this._logger.warn(`Excalibur could not load webgl for some reason (${Y.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),J=!0}J&&(this.graphicsContext=new Oo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:O,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting})),this.screen=new Fh({canvas:this.canvas,context:this.graphicsContext,antialiasing:O,canvasImageRendering:q,browser:this.browser,viewport:(f=e.viewport)!==null&&f!==void 0?f:e.width&&e.height?{width:e.width,height:e.height}:Dh.SVGA,resolution:e.resolution,displayMode:T,pixelRatio:e.suppressHiDPIScaling?1:(p=e.pixelRatio)!==null&&p!==void 0?p:null}),ne.filtering=H,e.backgroundColor&&(this.backgroundColor=e.backgroundColor.clone()),this.maxFps=(m=e.maxFps)!==null&&m!==void 0?m:this.maxFps,this.fixedUpdateTimestep=(w=e.fixedUpdateTimestep)!==null&&w!==void 0?w:this.fixedUpdateTimestep,this.fixedUpdateFps=(b=e.fixedUpdateFps)!==null&&b!==void 0?b:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new cl({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:Y=>this.onFatalException(Y)}),this.enableCanvasTransparency=e.enableCanvasTransparency,typeof e.physics=="boolean"?this.physics={...ys(),enabled:e.physics}:(this.physics={...ys()},Co(this.physics,e.physics)),this.debug=new Mu(this),this.director=new Ou(this,e.scenes),this._initialize(e),window.___EXCALIBUR_DEVTOOL=this,oi.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:e}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:s,showPlayerMessage:r}=this._originalOptions.configurePerformanceCanvas2DFallback;if(s===void 0&&(s=oi._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),r===void 0&&(r=oi._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!A.isEnabled("use-canvas-context")&&e&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===s.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let a=0;for(let f=0;f<this._fpsSamples.length;f++)a+=this._fpsSamples[f];const l=a/this._fpsSamples.length;this._fpsSamples.length===s.numberOfFrames&&l<=s.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),r&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var e,s,r;const a=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(a,this.canvas),this.canvas=a;const l={...this._originalOptions,antialiasing:this.screen.antialiasing},f=this._originalDisplayMode;this.graphicsContext=new Oo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:l.antialiasing,backgroundColor:l.backgroundColor,snapToPixel:l.snapToPixel,useDrawSorting:l.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new Fh({canvas:this.canvas,context:this.graphicsContext,antialiasing:(e=l.antialiasing)!==null&&e!==void 0?e:!0,browser:this.browser,viewport:(s=l.viewport)!==null&&s!==void 0?s:l.width&&l.height?{width:l.width,height:l.height}:Dh.SVGA,resolution:l.resolution,displayMode:f,pixelRatio:l.suppressHiDPIScaling?1:(r=l.pixelRatio)!==null&&r!==void 0?r:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const p=l&&l.pointerScope===F.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(p,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,oi.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(e){if(e<0){at.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=e}addTimer(e){return this.currentScene.addTimer(e)}removeTimer(e){return this.currentScene.removeTimer(e)}addScene(e,s){return this.director.add(e,s),this}removeScene(e){this.director.remove(e)}add(e){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const s=this.director.getDeferredScene();s instanceof Ci?s.add(e):this.currentScene.add(e)}remove(e){e instanceof Ve&&this.currentScene.remove(e),(e instanceof Ci||es(e))&&this.removeScene(e),typeof e=="string"&&this.removeScene(e)}async goToScene(e,s){await this.scope(async()=>{await this.director.goToScene(e,s)})}screenToWorldCoordinates(e){return this.screen.screenToWorldCoordinates(e)}worldToScreenCoordinates(e){return this.screen.worldToScreenCoordinates(e)}_initialize(e){var s,r;this.pageScrollPreventionMode=e.scrollPreventionMode;const a=e&&e.pointerScope===F.Document?document:this.canvas,l=(r=(s=this._originalOptions)===null||s===void 0?void 0:s.grabWindowFocus)!==null&&r!==void 0?r:!0;this.input=new al({pointerTarget:a,grabWindowFocus:l,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new xh(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new wh(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!e.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(e){this._inputEnabled=e,this.input.toggleEnabled(this._inputEnabled)}onInitialize(e){}get isInitialized(){return this._isInitialized}async _overrideInitialize(e){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(e),this.events.emit("initialize",new qn(e,this)),this._isInitialized=!0)}_update(e){var s;if(this._isLoading){(s=this._loader)===null||s===void 0||s.onUpdate(this,e),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(e),this.currentScene.update(this,e),this.graphicsContext.updatePostProcessors(e),this.clock.__runScheduledCbs("postupdate"),this._postupdate(e),this.input.update()}_preupdate(e){this.emit("preupdate",new Ws(this,e,this)),this.onPreUpdate(this,e)}onPreUpdate(e,s){}_postupdate(e){this.emit("postupdate",new Ns(this,e,this)),this.onPostUpdate(this,e)}onPostUpdate(e,s){}_draw(e){var s,r;if(this.graphicsContext.backgroundColor=(s=this.currentScene.backgroundColor)!==null&&s!==void 0?s:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,e),this._isLoading){this._hideLoader||((r=this._loader)===null||r===void 0||r.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,e),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,e),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(e,s){this.emit("predraw",new Gn(e,s,this)),this.onPreDraw(e,s)}onPreDraw(e,s){}_postdraw(e,s){this.emit("postdraw",new Xn(e,s,this)),this.onPostDraw(e,s)}onPostDraw(e,s){}showDebug(e){this._isDebug=e}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(e,s){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let r;return e instanceof Tr?r=e:typeof e=="string"&&(this.director.configureStart(e,s),r=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(r??new fn),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new ah(this)),this._isReadyFuture.promise})}_mainloop(e){this.scope(()=>{this.emit("preframe",new fh(this,this.stats.prevFrame));const s=e*this.timescale;this.currentFrameElapsedMs=s;const r=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=r,this.stats.currFrame.elapsedMs=s,this.stats.currFrame.fps=this.clock.fpsSampler.fps,Qt.clear();const a=this.clock.now(),l=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=s;this._lagMs>=l;)this._update(l),this._lagMs-=l;else this._update(s);const f=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(s);const p=this.clock.now();this.stats.currFrame.duration.update=f-a,this.stats.currFrame.duration.draw=p-f,this.stats.currFrame.graphics.drawnImages=Qt.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=Qt.DrawCallCount,this.emit("postframe",new gh(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new hh(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(e=!1){return new Promise(r=>{this._screenShotRequests.push({preserveHiDPIResolution:e,resolve:r})})}_checkForScreenShots(){for(const e of this._screenShotRequests){const s=e.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,r=e.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,a=document.createElement("canvas");a.width=s,a.height=r;const l=a.getContext("2d");l.imageSmoothingEnabled=this.screen.antialiasing,l.drawImage(this.canvas,0,0,s,r);const f=new Image,p=a.toDataURL("image/png");f.onload=()=>{e.resolve(f)},f.src=p}this._screenShotRequests.length=0}async load(e,s=!1){await this.scope(async()=>{try{if(e.isLoaded())return;this._loader=e,this._isLoading=!0,this._hideLoader=s,e instanceof fn&&(e.suppressPlayButton=e.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await e.load()}catch(r){this._logger.error("Error loading resources, things may not behave properly",r),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}oi.Context=Vu(),oi.InstanceCount=0,oi._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:F.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Ys.Canvas,backgroundColor:Z.fromHex("#2185d0")};class lm extends $e{set maxWidth(e){this._text.maxWidth=e}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(e){this._font=e,this._text.font=e}get text(){return this._text.text}set text(e){this._text.text=e}get color(){return this._text.color}set color(e){this._text&&(this._text.color=e)}get opacity(){return this.graphics.opacity}set opacity(e){this.graphics.opacity=e}get spriteFont(){return this._spriteFont}set spriteFont(e){e&&(this._spriteFont=e,this._text.font=this._spriteFont)}constructor(e){super(e),this._font=new hn,this._text=new Cr({text:"",font:this._font});const{text:s,pos:r,x:a,y:l,spriteFont:f,font:p,color:m,maxWidth:w}={text:"",...e};this.pos=r??(a&&l?z(a,l):this.pos),this.text=s??this.text,this.font=p??this.font,this.maxWidth=w??this.maxWidth,this.spriteFont=f??this.spriteFont,this._text.color=m??this.color;const b=this.get(re);b.anchor=B.Zero,b.use(this._text)}_initialize(e){super._initialize(e)}getTextWidth(){return this._text.width}}var js;(function(u){u.Circle="circle",u.Rectangle="rectangle"})(js||(js={}));class cm extends $e{constructor(e){var s,r;super({width:(s=e.width)!==null&&s!==void 0?s:0,height:(r=e.height)!==null&&r!==void 0?r:0}),this._particlesToEmit=0,this._particlePool=new wr(()=>new Ho({}),U=>U,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=js.Rectangle,this.radius=0,this.particle={life:2e3,transform:zi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:a,x:l,y:f,z:p,pos:m,isEmitting:w,emitRate:b,emitterType:y,radius:T,random:D}={...e};this.particle={...this.particle,...a},this.pos=m??z(l??0,f??0),this.z=p??0,this.isEmitting=w??this.isEmitting,this.emitRate=b??this.emitRate,this.emitterType=y??this.emitterType,this.radius=T??this.radius,this.body.collisionType=ft.PreventCollision,this.random=D??new M}removeParticle(e){this.deadParticles.push(e)}emitParticles(e){var s;if(!(e<=0)){e=e|0;for(let r=0;r<e;r++){const a=this._createParticle();!((s=this===null||this===void 0?void 0:this.scene)===null||s===void 0)&&s.world&&(this.particle.transform===zi.Global?this.scene.world.add(a):this.addChild(a)),this._activeParticles.push(a)}}}clearParticles(){for(let e=0;e<this._activeParticles.length;e++)this.removeParticle(this._activeParticles[e])}_createParticle(){let e=0,s=0;const r=Pt(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),a=Pt(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),l=this.particle.startSize||Pt(this.particle.minSize||5,this.particle.maxSize||5,this.random),f=a*Math.cos(r),p=a*Math.sin(r);if(this.emitterType===js.Rectangle)e=Pt(0,this.width,this.random),s=Pt(0,this.height,this.random);else if(this.emitterType===js.Circle){const w=Pt(0,this.radius,this.random);e=w*Math.cos(r),s=w*Math.sin(r)}const m=this._particlePool.rent();return m.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:z(e,s),vel:z(f,p),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:l,graphic:this.particle.graphic,fade:this.particle.fade}),m.registerEmitter(this),this.particle.randomRotation&&(m.transform.rotation=Pt(0,Math.PI*2,this.random)),this.particle.focus&&(m.focus=this.particle.focus.add(z(this.pos.x,this.pos.y)),m.focusAccel=this.particle.focusAccel),m}update(e,s){var r;super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let a=0;a<this.deadParticles.length;a++){!((r=this===null||this===void 0?void 0:this.scene)===null||r===void 0)&&r.world&&(this.scene.world.remove(this.deadParticles[a],!1),this._particlePool.return(this.deadParticles[a]));const l=this._activeParticles.indexOf(this.deadParticles[a]);l>-1&&this._activeParticles.splice(l,1)}this.deadParticles.length=0}}function dm(u,e){}class ea{constructor(e,s,r){var a;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=e,this.particle=r,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=s,this._particleLife=(a=this.particle.life)!==null&&a!==void 0?a:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(e,s){if(this._initialized)return;const r=this.emitter.maxParticles,a=this._numInputFloats,l=this._particleData,f=4,p=e.createBuffer(),m=e.createVertexArray();e.bindVertexArray(m),e.bindBuffer(e.ARRAY_BUFFER,p),e.bufferData(e.ARRAY_BUFFER,r*a*f,e.DYNAMIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,l);let w=0;e.vertexAttribPointer(0,2,e.FLOAT,!1,a*f,0),w+=f*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*f,w),w+=f*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*f,w),w+=f*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(m),this._buffers.push(p),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null);const b=e.createBuffer(),y=e.createVertexArray();e.bindVertexArray(y),e.bindBuffer(e.ARRAY_BUFFER,b),e.bufferData(e.ARRAY_BUFFER,r*a*f,e.DYNAMIC_DRAW),w=0,e.vertexAttribPointer(0,2,e.FLOAT,!1,a*f,0),w+=f*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*f,w),w+=f*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*f,w),w+=f*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(y),this._buffers.push(b),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(e){const s=this._particleIndex,r=this.maxParticles*this._numInputFloats,a=e*this._numInputFloats+s;for(let l=s;l<a;l+=this._numInputFloats){const f=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||V),p=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),m=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),w=p*Math.cos(f),b=m*Math.sin(f);let y=0,T=0;if(this.emitter.emitterType===js.Rectangle)y=this._random.floating(-.5,.5)*this.emitter.width,T=this._random.floating(-.5,.5)*this.emitter.height;else{const O=this._random.floating(0,this.emitter.radius);y=O*Math.cos(f),T=O*Math.sin(f)}const D=this.emitter.transform.apply(z(y,T)),U=[this.particle.transform===zi.Local?y:D.x,this.particle.transform===zi.Local?T:D.y,w,b,this.particle.randomRotation?Pt(0,V,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(U,l%this._particleData.length)}a>=r?(this._wrappedParticles+=(a-r)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=e),this._particleIndex=a%r,this._emitted.push([this._particleLife,s])}_uploadEmitted(e){this._particleIndex!==this._uploadIndex&&(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),e.bindBuffer(e.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(e){var s;if(this._particleLife=(s=this.particle.life)!==null&&s!==void 0?s:this._particleLife,this._wrappedLife>0?this._wrappedLife-=e:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let r=this._emitted.length-1;r>=0;r--){const a=this._emitted[r];a[0]-=e,a[0]<=0&&this._emitted.splice(r,1)}this._emitted.sort((r,a)=>r[0]-a[0])}}draw(e){if(this._initialized){if(this._clearRequested?(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData),e.bindBuffer(e.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(e),e.bindVertexArray(this._currentVao),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const s=this._emitted[0][1]/this._numInputFloats;e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-s)*this._numInputFloats*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,s,this.maxParticles-s),e.endTransformFeedback(),e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,s),e.endTransformFeedback()}else e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,this.maxParticles),e.endTransformFeedback();e.bindVertexArray(null),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}ea.GPU_MAX_PARTICLES=1e5;class um extends $e{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get z(){return this.transform.z}set z(e){this.transform.z=e}constructor(e){super({name:"GpuParticleEmitter",width:e.width,height:e.height}),this.particle={life:2e3,transform:zi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new re,this.isEmitting=!1,this.emitRate=1,this.emitterType=js.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:s,maxParticles:r,x:a,y:l,z:f,pos:p,isEmitting:m,emitRate:w,emitterType:b,radius:y,random:T}={...e};this.maxParticles=j(r??this.maxParticles,0,ea.GPU_MAX_PARTICLES),this.pos=p??z(a??0,l??0),this.z=f??0,this.isEmitting=m??this.isEmitting,this.emitRate=w??this.emitRate,this.emitterType=b??this.emitterType,this.radius=y??this.radius,this.particle={...this.particle,...s},this.random=T??new M,this.renderer=new ea(this,this.random,this.particle)}_initialize(e){super._initialize(e);const s=e.graphicsContext;this.renderer.initialize(s.__gl,s)}update(e,s){super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(s)}emitParticles(e){e<=0||this.renderer.emitParticles(e|0)}clearParticles(){this.renderer.clearParticles()}draw(e,s){e.draw("ex.particle",this.renderer,s)}}class Gu extends Ve{getGraphics(){return this._graphics}addGraphic(e,s){this._graphics.push(e),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,s?.offset&&(this._gfx.offset=s.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let e=this._tileBounds.clone();for(const s of this._graphics){const r=z(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:s.height-this.map.tileHeight));e=e.combine(s.localBounds.translate(r))}return e}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&this._graphics.splice(s,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(z(this.x,this.y))}get center(){return this.pos.add(z(0,this.map.tileHeight/2))}constructor(e,s,r,a){super([new it,new re({offset:r??B.Zero,onPostDraw:(T,D)=>this.draw(T,D)}),new Ur(a)]),this.solid=!1,this.events=new I,this._tileBounds=new ht,this._graphics=[],this._colliders=[],this.data=new Map,this.x=e,this.y=s,this.map=a,this._transform=this.get(it),this._isometricEntityComponent=this.get(Ur);const l=this.map.tileWidth/2,f=this.map.tileHeight/2,p=(this.x-this.y)*l,m=(this.x+this.y)*f;this._transform.pos=z(p,m),this._isometricEntityComponent.elevation=a.elevation,this._gfx=this.get(re),this._gfx.isVisible=!1;const w=this.map.tileWidth,b=this.map.tileHeight,y=z(0,this.map.renderFromTopOfGraphic?b:0);this._gfx.localBounds=this._tileBounds=new ht({left:-w/2,top:-b,right:w/2,bottom:b}).translate(y)}draw(e,s){const r=this.map.tileWidth/2;e.save(),e.translate(-r,0);for(const a of this._graphics)a.draw(e,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:a.height-this.map.tileHeight));e.restore()}}class fm extends Ve{get visible(){return this.isVisible}set visible(e){this.isVisible=e}constructor(e){super([new it,new Et({type:ft.Fixed}),new ve,new Xs,new qo((b,y)=>this.debug(b,y),!1)],e.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=z(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:s,tileWidth:r,tileHeight:a,columns:l,rows:f,renderFromTopOfGraphic:p,graphicsOffset:m,elevation:w}=e;this.transform=this.get(it),s&&(this.transform.pos=s),this.collider=this.get(ve),this.collider&&this.collider.set(this._composite=new Pe([])),this.pointer=this.get(Xs),this.renderFromTopOfGraphic=p??this.renderFromTopOfGraphic,this.graphicsOffset=m??this.graphicsOffset,this.elevation=w??this.elevation,this.tileWidth=r,this.tileHeight=a,this.columns=l,this.rows=f,this._pointerEventDispatcher=new jh,this.tiles=new Array(l*f);for(let b=0;b<f;b++)for(let y=0;y<l;y++){const T=new Gu(y,b,this.graphicsOffset,this);this.tiles[y+b*l]=T,this.addChild(T),this._pointerEventDispatcher.addObject(T,D=>this.getTileByPoint(D.worldPos)===T,()=>!0)}this.pointer.localBounds=ht.fromDimension(r*l*this.transform.scale.x,a*f*this.transform.scale.y,z(.5,0))}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:B.Zero;{const r=e.offset;return this._originalOffsets.set(e,r),r}}updateColliders(){this._composite.clearColliders();const e=this.get(it).pos;for(const s of this.tiles)if(s.solid)for(const r of s.getColliders()){const a=this._getOrSetColliderOriginalOffset(r);r.offset=this.tileToWorld(z(s.x,s.y)).sub(e).add(a).sub(z(this.tileWidth/2,this.tileHeight)),r.owner=this,this._composite.addCollider(r)}this.collider.update()}worldToTile(e){e=e.sub(this.transform.globalPos);const s=this.tileWidth/2,r=this.tileHeight/2;return z(~~((e.x/s+e.y/r)/2),~~((e.y/r-e.x/s)/2))}tileToWorld(e){const s=this.tileWidth/2,r=this.tileHeight/2,a=(e.x-e.y)*s,l=(e.x+e.y)*r;return z(a,l).add(this.transform.pos)}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const s=this.worldToTile(e);return this.getTile(s.x,s.y)}_getMaxZIndex(){let e=Number.NEGATIVE_INFINITY;for(const s of this.tiles){const r=s.get(it).z;r>e&&(e=r)}return e}debug(e,s){const{showAll:r,showPosition:a,positionColor:l,positionSize:f,showGrid:p,gridColor:m,gridWidth:w,showColliderGeometry:b}=s.isometric,{geometryColor:y,geometryLineWidth:T,geometryPointSize:D}=s.collider;if(e.save(),e.z=this._getMaxZIndex()+.5,r||p){for(let U=0;U<this.rows+1;U++){const O=this.tileToWorld(z(0,U)),q=this.tileToWorld(z(this.columns,U));e.drawLine(O,q,m,w)}for(let U=0;U<this.columns+1;U++){const O=this.tileToWorld(z(U,0)),q=this.tileToWorld(z(U,this.rows));e.drawLine(O,q,m,w)}}if(r||a)for(const U of this.tiles)e.drawCircle(this.tileToWorld(z(U.x,U.y)),f,l);if(r||b){for(const U of this.tiles)if(U.solid)for(const O of U.getColliders())O.debug(e,y,{lineWidth:T,pointSize:D})}e.restore()}}class ul{constructor(e,s){this.id=Ut(),this._stopped=!1,this._sequenceBuilder=s,this._sequenceContext=new Br(e),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(e){this._actionQueue.update(e)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(e){return new ul(e,this._sequenceBuilder)}}class gm{constructor(e){this.id=Ut(),this._actions=e}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}isComplete(e){return this._actions.every(s=>s.isComplete(e))}reset(){this._actions.forEach(e=>e.reset())}stop(){this._actions.forEach(e=>e.stop())}}class Jn{constructor(e,s){this.bounds=e,this.options=s,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...s},this.halfWidth=e.width/2,this.halfHeight=e.height/2}_split(){this._isDivided=!0;const e={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new Jn(new ht({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),e),this.topRight=new Jn(new ht({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),e),this.bottomLeft=new Jn(new ht({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),e),this.bottomRight=new Jn(new ht({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),e)}_insertIntoSubNodes(e){var s,r,a,l;!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.insert(e),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(e.bounds)&&this.topRight.insert(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.insert(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.insert(e)}insert(e){if(this._isDivided){this._insertIntoSubNodes(e);return}if(this.items.push(e),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const s of this.items)this._insertIntoSubNodes(s);this.items.length=0}}remove(e){var s,r,a,l;if(this.bounds.overlaps(e.bounds)){if(!this._isDivided){const f=this.items.indexOf(e);f>-1&&this.items.splice(f,1);return}!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.remove(e),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(e.bounds)&&this.topRight.remove(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.remove(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.remove(e)}}query(e){let s=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(e)&&(s=s.concat(this.topLeft.query(e))),this.topRight.bounds.overlaps(e)&&(s=s.concat(this.topRight.query(e))),this.bottomLeft.bounds.overlaps(e)&&(s=s.concat(this.bottomLeft.query(e))),this.bottomRight.bounds.overlaps(e)&&(s=s.concat(this.bottomRight.query(e)))),s=s.filter((r,a)=>s.indexOf(r)>=a),s}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let e=this.items;return this._isDivided&&(e=e.concat(this.topLeft.getAllItems()),e=e.concat(this.topRight.getAllItems()),e=e.concat(this.bottomLeft.getAllItems()),e=e.concat(this.bottomRight.getAllItems())),e=e.filter((s,r)=>e.indexOf(s)>=r),e}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(e){this.bounds.draw(e,Z.Yellow),this._isDivided&&(this.topLeft.bounds.draw(e,Z.Yellow),this.topRight.bounds.draw(e,Z.Yellow),this.bottomLeft.bounds.draw(e,Z.Yellow),this.bottomRight.bounds.draw(e,Z.Yellow))}}function pm(u){return!!u._initialize}function _m(u){return!!u.onAdd}function mm(u){return!!u.onRemove}function vm(u){return!!u.onInitialize}function wm(u){return!!u._preupdate}function xm(u){return!!u.onPreUpdate}function Am(u){return!!u.onPostUpdate}function bm(u){return!!u.onPostUpdate}function ym(u){return!!u.onAdd}function Cm(u){return!!u.onRemove}function Sm(u){return!!u.onPreDraw}function Pm(u){return!!u.onPostDraw}class Em{constructor(e,s=!1){this.path=e,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new xr(e,"arraybuffer",s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){const e=await this._resource.load();this._stream=new Xu(e),this._gif=new qu(this._stream);const s=this._gif.images.map(r=>new ji(r.src,!1));return await Promise.all(s.map(r=>r.load())),this.data=this._images=s,this._sprites=this._images.map(r=>r.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(e=0){var s;return(s=this._sprites[e])!==null&&s!==void 0?s:null}toSpriteSheet(){const e=this._sprites;return e.length?new an({sprites:e}):null}toAnimation(e){var s;const r=(s=this._gif)===null||s===void 0?void 0:s.images;if(r?.length){const a=r.map((l,f)=>{var p;return{graphic:this._sprites[f],duration:((p=this._gif)===null||p===void 0?void 0:p.frames[f].delayMs)||void 0}});return this._animation=new Ui({frames:a,frameDuration:e}),this._animation}return null}get readCheckBytes(){var e,s;return(s=(e=this._gif)===null||e===void 0?void 0:e.checkBytes)!==null&&s!==void 0?s:[]}}const ia=u=>u.reduce(function(e,s){return e*2+s},0),fl=u=>{const e=[];for(let s=7;s>=0;s--)e.push(!!(u&1<<s));return e};class Xu{constructor(e){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=s=>{const r=[];for(let a=0;a<s;a++)r.push(this.readByte());return r},this.read=s=>{let r="";for(let a=0;a<s;a++)r+=String.fromCharCode(this.readByte());return r},this.readUnsigned=()=>{const s=this.readBytes(2);return(s[1]<<8)+s[0]},this.data=new Uint8Array(e),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const Tm=function(u,e){let s=0;const r=function(T){let D=0;for(let U=0;U<T;U++)e.charCodeAt(s>>3)&1<<(s&7)&&(D|=1<<U),s++;return D},a=[],l=1<<u,f=l+1;let p=u+1,m=[];const w=function(){m=[],p=u+1;for(let T=0;T<l;T++)m[T]=[T];m[l]=[],m[f]=null};let b=0,y=0;for(;;){if(y=b,b=r(p),b===l){w();continue}if(b===f)break;if(b<m.length)y!==l&&m.push(m[y].concat(m[b][0]));else{if(b!==m.length)throw new Error("Invalid LZW code.");m.push(m[y].concat(m[y][0]))}a.push.apply(a,m[b]),m.length===1<<p&&p<12&&p++}return a};class qu{constructor(e){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=s=>{const r=[];for(let a=0;a<s;a++){const l=this._st.readBytes(3);r.push(l)}return r},this.readSubBlocks=()=>{let s,r;r="";do s=this._st.readByte(),r+=this._st.read(s);while(s!==0);return r},this.parseHeader=()=>{const s={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(s.sig=this._st.read(3),s.ver=this._st.read(3),s.sig!=="GIF")throw new Error("Not a GIF file.");s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned(),this._currentFrameCanvas.width=s.width,this._currentFrameCanvas.height=s.height;const r=fl(this._st.readByte());s.gctFlag=r.shift(),s.colorResolution=ia(r.splice(0,3)),s.sortedFlag=r.shift(),s.globalColorTableSize=ia(r.splice(0,3)),s.backgroundColorIndex=this._st.readByte(),s.pixelAspectRatio=this._st.readByte(),s.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<s.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(s)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=s=>{const r=m=>{this.checkBytes.push(this._st.readByte());const w=fl(this._st.readByte());return m.reserved=w.splice(0,3),m.disposalMethod=ia(w.splice(0,3)),m.userInputFlag=w.shift(),m.transparentColorFlag=w.shift(),m.delayTime=this._st.readUnsigned(),m.transparentColorIndex=this._st.readByte(),m.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(m)&&this.checkBytes.push(this._handler.gce),m},a=m=>{m.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(m)&&this.checkBytes.push(this._handler.com)},l=m=>{this.checkBytes.push(this._st.readByte()),m.ptHeader=this._st.readBytes(12),m.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(m)&&this.checkBytes.push(this._handler.pte)},f=m=>{const w=y=>{this.checkBytes.push(this._st.readByte()),y.unknown=this._st.readByte(),y.iterations=this._st.readUnsigned(),y.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(y)&&this.checkBytes.push(this._handler.app)},b=y=>{y.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[y.identifier]&&this._handler.app[y.identifier](y)&&this.checkBytes.push(this._handler.app[y.identifier])};switch(this.checkBytes.push(this._st.readByte()),m.identifier=this._st.read(8),m.authCode=this._st.read(3),m.identifier){case"NETSCAPE":w(m);break;default:b(m);break}},p=m=>{m.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(m)&&this.checkBytes.push(this._handler.unknown)};switch(s.label=this._st.readByte(),s.label){case 249:s.extType="gce",this._gce=r(s);break;case 254:s.extType="com",a(s);break;case 1:s.extType="pte",l(s);break;case 255:s.extType="app",f(s);break;default:s.extType="unknown",p(s);break}},this.parseImg=s=>{var r;const a=(p,m)=>{const w=new Array(p.length),b=p.length/m,y=(O,q)=>{const H=p.slice(q*m,(q+1)*m);w.splice.apply(w,[O*m,m].concat(H))},T=[0,4,2,1],D=[8,8,4,2];let U=0;for(let O=0;O<4;O++)for(let q=T[O];q<b;q+=D[O])y(q,U),U++;return w};s.leftPos=this._st.readUnsigned(),s.topPos=this._st.readUnsigned(),s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned();const l=fl(this._st.readByte());s.lctFlag=l.shift(),s.interlaced=l.shift(),s.sorted=l.shift(),s.reserved=l.splice(0,2),s.lctSize=ia(l.splice(0,3)),s.lctFlag&&(s.lctBytes=this.parseColorTableBytes(1<<s.lctSize+1)),s.lzwMinCodeSize=this._st.readByte();const f=this.readSubBlocks();s.pixels=Tm(s.lzwMinCodeSize,f),s.interlaced&&(s.pixels=a(s.pixels,s.width)),!((r=this._gce)===null||r===void 0)&&r.delayTime&&(s.delayMs=this._gce.delayTime*10),this.frames.push(s),this.arrayToImage(s,s.lctFlag?s.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(s)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const s={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(s.sentinel)){case"!":s.type="ext",this.parseExt(s);break;case",":s.type="img",this.parseImg(s);break;case";":s.type="eof",this._handler.eof&&this._handler.eof(s)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+s.sentinel.toString(16))}s.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(s,r)=>{var a,l,f,p;const m=document.createElement("canvas");m.width=s.width,m.height=s.height;const w=m.getContext("2d"),b=w.getImageData(0,0,m.width,m.height);let y=-1;!((a=this._gce)===null||a===void 0)&&a.transparentColorFlag&&(y=this._gce.transparentColorIndex);for(let D=0;D<s.pixels.length;D++){const U=s.pixels[D],O=r[U];U===y?b.data.set([0,0,0,0],D*4):b.data.set([...O,255],D*4)}if(w.putImageData(b,0,0),((l=this._gce)===null||l===void 0?void 0:l.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((f=this._gce)===null||f===void 0?void 0:f.disposalMethod)===2&&(!((p=this._hdr)===null||p===void 0)&&p.gctFlag)){const D=r[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${D[0]}, ${D[1]}, ${D[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(m,s.leftPos,s.topPos,s.width,s.height);const T=new Image;T.src=this._currentFrameCanvas.toDataURL(),this.images.push(T)},this._st=e,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class Im{constructor(e,s,{bustCache:r,...a}={}){this.path=e,this.family=s,this._isLoaded=!1,this._resource=new xr(e,"blob",r),this._options=a}async load(){if(this.isLoaded())return this.data;try{const e=await this._resource.load(),s=URL.createObjectURL(e);this.data||(this.data=new FontFace(this.family,`url(${s})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(e){throw`Error loading FontSource from path '${this.path}' with error [${e.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(e){return new hn({family:this.family,...this._options,...e})}}const Yu=Vu(),Rm=/^\s*(?:function)?\*/;function ju(u){return typeof u!="function"?!1:Rm.test(Function.prototype.toString.call(u))?!0:Object.getPrototypeOf?Object.getPrototypeOf(u)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function Qu(...u){var e;const s=at.getInstance();let r,a,l,f;ju(u[0])&&(a=globalThis,r=u[0],l=u[1]),ju(u[1])&&(a=u[0],r=u[1],l=u[2]),u[1]instanceof oi&&(a=u[0],f=u[1],r=u[2],l=u[3]),u[0]instanceof oi&&(a=globalThis,f=u[0],r=u[1],l=u[2]);const p=Wu(Yu),m=l?.timing,w=p?!1:(e=l?.autostart)!==null&&e!==void 0?e:!0;let b;try{b=f??oi.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let y=!1,T=!1,D=!1;const U=r.bind(a),O=U();let q;const H=new Promise((J,Y)=>{q=tt=>{try{if(D){T=!0,J();return}const{done:ot,value:Q}=Yu.scope(!0,()=>O.next(tt));if(ot||D){T=!0,J();return}Q instanceof Promise?Q.then(()=>{b.clock.schedule(q,0,m)}):Q===void 0||Q===void 0?b.clock.schedule(q,0,m):b.clock.schedule(q,Q||0,m)}catch(ot){Y(ot);return}},w&&(y=!0,q(b.clock.elapsed()))}),W={isRunning:()=>y&&!D&&!T,isComplete:()=>T,cancel:()=>{D=!0},start:()=>(y?s.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(U)):(y=!0,q(b.clock.elapsed())),W),generator:O,done:H,then:H.then.bind(H),[Symbol.iterator]:()=>O};return W}class sa extends Ve{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(e){var s,r,a,l;super(),this._logger=at.getInstance(),this.transform=new it,this.graphics=new re,this._completeFuture=new P,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=e.duration,this.easing=(s=e.easing)!==null&&s!==void 0?s:Nt.Linear,this.direction=(r=e.direction)!==null&&r!==void 0?r:"out",this.hideLoader=(a=e.hideLoader)!==null&&a!==void 0?a:!1,this.blockInput=(l=e.blockInput)!==null&&l!==void 0?l:!1,this.transform.coordPlane=Me.Screen,this.transform.pos=B.Zero,this.transform.z=1/0,this.graphics.anchor=B.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(e,s){this.complete||(this._currentDistance+=j(s/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=j(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=j(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(e){}onStart(e){}onUpdate(e){}onEnd(e){}onReset(){}reset(){this.started=!1,this._completeFuture=new P,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(e,s){const r=s;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),r.world.entityManager.getById(this.id))return this._co;this._engine=e,r.add(this);const a=this;return this._co=Qu(e,function*(){for(;!a.complete;){const l=yield;a.updateTransition(a._engine,l),a._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class Dm extends sa{constructor(e){var s,r;super({...e,duration:(s=e.duration)!==null&&s!==void 0?s:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(r=e.color)!==null&&r!==void 0?r:Z.Black}onInitialize(e){this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=new Dr({width:e.screen.resolution.width,height:e.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=e}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class Fm extends sa{constructor(e){super({direction:"in",...e}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(e){this.image=await e.engine.screenshot(!0),await this.image.decode()}onInitialize(e){this.engine=e,this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=ji.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=z(1/e.screen.pixelRatio,1/e.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class Mm extends sa{constructor(e){var s;super({direction:"in",...e}),this._easing=Nt.Linear,this.name=`Slide#${this.id}`,this.slideDirection=e.slideDirection,this.transform.coordPlane=Me.World,this.graphics.forceOnScreen=!0,this._easing=(s=e.easingFunction)!==null&&s!==void 0?s:this._easing,this._vectorEasing=Nt.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(e){this._image=await e.engine.screenshot(!0),await this._image.decode(),this._screenCover=ji.fromHtmlImageElement(this._image).toSprite()}onInitialize(e){switch(this._engine=e,this.slideDirection){case"up":{this._directionOffset=z(0,-e.screen.resolution.height);break}case"down":{this._directionOffset=z(0,e.screen.resolution.height);break}case"left":{this._directionOffset=z(-e.screen.resolution.width,0);break}case"right":{this._directionOffset=z(e.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=z(1/e.screen.pixelRatio,1/e.screen.pixelRatio)}onUpdate(e){this._camera.pos=this._vectorEasing(e,this._destinationCameraPosition,this._startCameraPosition,1)}}class gl extends se{constructor(e){super(),this.color=Z.Black,this.thickness=1;const{start:s,end:r,color:a,thickness:l}=e;this.start=s,this.end=r,this.color=a??this.color,this.thickness=l??this.thickness,this._localBounds=this._calculateBounds();const{width:f,height:p}=this._localBounds;this.width=f,this.height=p}get localBounds(){return this._localBounds}_calculateBounds(){const e=this.end.sub(this.start).normal(),s=this.thickness/2,r=[this.start.add(e.scale(s)),this.end.add(e.scale(s)),this.end.add(e.scale(-s)),this.start.add(e.scale(-s))];return ht.fromPoints(r)}_drawImage(e,s,r){e.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new gl({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class pl extends Wn{get points(){return this._points}set points(e){this._points=e;const s=this.minPoint;this.width=this._points.reduce((r,a)=>Math.max(a.x,r),0)-s.x,this.height=this._points.reduce((r,a)=>Math.max(a.y,r),0)-s.y,this.flagDirty()}get minPoint(){const e=this._points.reduce((r,a)=>Math.min(a.x,r),1/0),s=this._points.reduce((r,a)=>Math.min(a.y,r),1/0);return z(e,s)}constructor(e){super(e),this._points=[],this.points=e.points,this.filtering=_e.Blended,this.rasterize()}clone(){return new pl({points:this.points.map(e=>e.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){if(this.points&&this.points.length){e.beginPath();const s=this.minPoint.negate(),r=this.points[0].add(s);e.moveTo(r.x,r.y),this.points.forEach(a=>{e.lineTo(a.x+s.x,a.y+s.y)}),e.lineTo(r.x,r.y),e.closePath(),this.color&&e.fill(),this.strokeColor&&e.stroke()}}}var Ps;(function(u){u.Stretch="stretch",u.Tile="tile",u.TileFit="tile-fit"})(Ps||(Ps={}));class _l extends se{constructor(e){super(e),this._logger=at.getInstance(),this._config=e,this._imgSource=e.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(e,s=!1){this._config.width=e,s&&this._initialize()}setTargetHeight(e,s=!1){this._config.height=e,s&&this._initialize()}setMargins(e,s,r,a,l=!1){this._config.sourceConfig.leftMargin=e,this._config.sourceConfig.topMargin=s,this._config.sourceConfig.rightMargin=r,this._config.sourceConfig.bottomMargin=a,l&&this._initialize()}setStretch(e,s,r=!1){e==="horizontal"?this._config.destinationConfig.horizontalStretch=s:e==="vertical"?this._config.destinationConfig.verticalStretch=s:(this._config.destinationConfig.horizontalStretch=s,this._config.destinationConfig.verticalStretch=s),r&&this._initialize()}getConfig(){return this._config}_drawTile(e,s,r,a,l,f,p){const m=f||0,w=p||0;let b,y,T,D;const U=this._getNumberOfTiles(s.width,r.x,a),O=this._getNumberOfTiles(s.height,r.y,l);for(let q=0;q<U;q++)for(let H=0;H<O;H++){let{tempSize:W,tempPosition:J}=this._calculateParams(q,U,s.width,r.x,this._config.destinationConfig.horizontalStretch);b=W,y=J,{tempSize:W,tempPosition:J}=this._calculateParams(H,O,s.height,r.y,this._config.destinationConfig.verticalStretch),T=W,D=J,e.drawImage(s,0,0,s.width,s.height,m+y,w+D,b,T)}}_drawImage(e,s,r){this._imgSource.isLoaded()?(this._drawTile(e,this._canvasA,new B(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(e,this._canvasB,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(e,this._canvasC,new B(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(e,this._canvasD,new B(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(e,this._canvasE,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasF,new B(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasG,new B(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasH,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasI,new B(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const e=this._canvasA.getContext("2d");e?.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const s=this._canvasB.getContext("2d");s?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const r=this._canvasC.getContext("2d");r?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const a=this._canvasD.getContext("2d");a?.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const l=this._canvasE.getContext("2d");l?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const f=this._canvasF.getContext("2d");f?.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const p=this._canvasG.getContext("2d");p?.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const m=this._canvasH.getContext("2d");m?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const w=this._canvasI.getContext("2d");w?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new _l(this._config)}_getNumberOfTiles(e,s,r){switch(r){case Ps.Stretch:return 1;case Ps.Tile:return Math.ceil(s/e);case Ps.TileFit:return Math.ceil(s/e)}}_calculateParams(e,s,r,a,l){switch(l){case Ps.Stretch:return{tempPosition:0,tempSize:a};case Ps.Tile:return e===s-1?{tempPosition:e*r,tempSize:r-(s*r-a)}:{tempPosition:e*r,tempSize:r};case Ps.TileFit:const f=a/s;return{tempPosition:e*f,tempSize:f}}}}class ml extends Ui{constructor(e){super({...e,frames:e.animation.frames.slice(),strategy:e.animation.strategy,frameDuration:e.animation.frameDuration,speed:e.animation.speed,reverse:e.animation.isReversed}),this._ready=new P,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...e.sourceView},this._tiledWidth=e.width,this._tiledHeight=e.height;const s=[];for(let r=0;r<this.frames.length;r++){const a=this.frames[r].graphic;if(a&&a instanceof Bi){const l=new Ar({image:a.image,width:e.width,height:e.height,sourceView:{...a.sourceView},wrapping:e.wrapping,filtering:e.filtering});this.frames[r].graphic=l,l.ready.then(()=>{l.sourceView={...l.sourceView,...this._sourceView}}),s.push(l.ready)}}Promise.all(s).then(()=>this._ready.resolve())}static fromAnimation(e,s){return new ml({width:e.width,height:e.height,...s,animation:e})}_updateSourceView(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof Bi&&(s.sourceView={...s.sourceView,...this._sourceView})}}get sourceView(){return Mi(this._sourceView,()=>this._updateSourceView())}set sourceView(e){this._sourceView=Mi(e,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof Bi&&(s.sourceView.height=this._tiledHeight||s.height,s.destSize.height=this._tiledHeight||s.height,s.sourceView.width=this._tiledWidth||s.width,s.destSize.width=this._tiledWidth||s.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(e){this._tiledWidth=e,this._updateWidthHeight()}set height(e){this._tiledHeight=e,this._updateWidthHeight()}}const Zu=5,Kn={},Bm=()=>{for(const u in Kn)Kn[u]=0},na=(u,e)=>{const s=A.isEnabled("suppress-obsolete-message");Kn[u]<Zu&&!s&&(at.getInstance().warn(u),console.trace&&e.showStackTrace&&console.trace()),Kn[u]++};function km(u){return u={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...u},function(e,s,r){if(r&&!(typeof r.value=="function"||typeof r.get=="function"||typeof r.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const l=`${`${e.name||""}${e.name&&s?".":""}${s||""}`} is marked obsolete: ${u.message}`+(u.alternateMethod?` Use ${u.alternateMethod} instead`:"");Kn[l]||(Kn[l]=0);const f=r?{...r}:e;if(!r){class p extends f{constructor(...w){na(l,u),super(...w)}}return p}return r&&r.value?(f.value=function(){return na(l,u),r.value.apply(this,arguments)},f):(r&&r.get&&(f.get=function(){return na(l,u),r.get.apply(this,arguments)}),r&&r.set&&(f.set=function(){return na(l,u),r.set.apply(this,arguments)}),f)}}class Lm{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const e=new P;return this._queue.push(e),e.promise}dequeue(e){this._queue.shift().resolve(e)}}class Um{constructor(e){this._count=e,this._waitQueue=new Lm}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(e=1){if(e!==0){for(;e!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),e--;this._count+=e}}}const vl="0.30.3";return x(),h})())}(El)),El.exports}/*! For license information please see excalibur-perlin.min.js.LICENSE.txt */var wf;function Ix(){return wf||(wf=1,function(d,t){(function(i,n){d.exports=n(Tx())})(self,i=>(()=>{var n={"./src/perlin-noise.ts":(g,_,v)=>{v.r(_),v.d(_,{PerlinDrawer2D:()=>I,PerlinGenerator:()=>P});var x=v("excalibur");function A(F,R,E){return R+F*(E-R)}function S(F){return F*F*F*(F*(6*F-15)+10)}class P{constructor(R){var E,M,V,L;this._perm=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],this._p=new Uint8Array(512),this._defaultPerlinOptions={octaves:1,frequency:1,amplitude:1,persistance:.5},this.persistance=.5,this.amplitude=1,this.frequency=1,this.octaves=1,R={...this._defaultPerlinOptions,...R},this.persistance=(E=R.persistance)!==null&&E!==void 0?E:this.persistance,this.amplitude=(M=R.amplitude)!==null&&M!==void 0?M:this.amplitude,this.frequency=(V=R.frequency)!==null&&V!==void 0?V:this.frequency,this.octaves=(L=R.octaves)!==null&&L!==void 0?L:this.octaves,R.seed?this._random=new x.Random(R.seed):this._random=new x.Random,this._perm=this._random.shuffle(this._perm);for(let G=0;G<512;G++)this._p[G]=255&this._perm[G%256]}noise(){let R=this.amplitude,E=this.frequency,M=0,V=0;for(let L=0;L<this.octaves;L++){switch(arguments.length){case 1:M+=this._noise1d(arguments[0]*E)*R;break;case 2:M+=this._noise2d(arguments[0]*E,arguments[1]*E)*R;break;case 3:M+=this._noise3d(arguments[0]*E,arguments[1]*E,arguments[2]*E)*R;break;default:throw new Error("Invalid arguments for perlin noise")}V+=R,R*=this.persistance,E*=2}return M/V}sequence(R,E){E||(E=1/R);const M=new Array(R);for(let V=0;V<R;V++)M[V]=this.noise(V*E);return M}grid(R,E,M){M||(M=1/Math.min(R,E));const V=new Array(R*E);for(let L=0;L<E;L++)for(let G=0;G<R;G++)V[G+L*R]=this.noise(G*M,L*M);return V}_gradient3d(R,E,M,V){const L=15&R,G=L<8?E:M,j=L<4?M:L===12||L===14?E:V;return((1&L)==0?G:-G)+((2&L)==0?j:-j)}_gradient2d(R,E,M){const V=(1&R)==0?E:M;return(2&R)==0?-V:V}_gradient1d(R,E){return(1&R)==0?-E:E}_noise1d(R){const E=255&Math.floor(R);return(A(S(R-=Math.floor(R)),this._gradient1d(this._p[E],R),this._gradient1d(this._p[E+1],R-1))+1)/2}_noise2d(R,E){const M=255&Math.floor(R),V=255&Math.floor(E);R-=Math.floor(R),E-=Math.floor(E);const L=S(R),G=S(E),j=this._p[M]+V,X=this._p[M+1]+V;return(A(G,A(L,this._gradient2d(this._p[j],R,E),this._gradient2d(this._p[X],R-1,E)),A(L,this._gradient2d(this._p[j+1],R,E-1),this._gradient2d(this._p[X+1],R-1,E-1)))+1)/2}_noise3d(R,E,M){const V=255&Math.floor(R),L=255&Math.floor(E),G=255&Math.floor(M);R-=Math.floor(R),E-=Math.floor(E),M-=Math.floor(M);const j=S(R),X=S(E),rt=S(M),lt=this._p[V]+L,yt=this._p[V+1]+L,wt=this._p[lt]+G,Pt=this._p[yt]+G,Dt=this._p[lt+1]+G,B=this._p[yt+1]+G;return(A(rt,A(X,A(j,this._gradient3d(this._p[wt],R,E,M),this._gradient3d(this._p[Pt],R-1,E,M)),A(j,this._gradient3d(this._p[Dt],R,E-1,M),this._gradient3d(this._p[B],R-1,E-1,M))),A(X,A(j,this._gradient3d(this._p[wt+1],R,E,M-1),this._gradient3d(this._p[Pt+1],R-1,E,M-1)),A(j,this._gradient3d(this._p[Dt+1],R,E-1,M-1),this._gradient3d(this._p[B+1],R-1,E-1,M-1))))+1)/2}}class I{constructor(R,E){this.generator=R,this.colorFcn=M=>M<.5?x.Color.Black:x.Color.White,E&&(this.colorFcn=E)}image(R,E){const M=document.createElement("img"),V=document.createElement("canvas");V.width=R,V.height=E;const L=V.getContext("2d");return this.draw(L,0,0,R,E),M.src=V.toDataURL(),M}draw(R,E,M,V,L){const G=this.generator.grid(V,L),j=R.getImageData(E,M,V,L);for(let X=0;X<L;X++)for(let rt=0;rt<V;rt++){const lt=4*(rt+X*j.width),yt=G[rt+V*X],wt=this.colorFcn(yt);j.data[lt]=wt.r,j.data[lt+1]=wt.g,j.data[lt+2]=wt.b,j.data[lt+3]=Math.floor(255*wt.a)}R.putImageData(j,E,M)}}},excalibur:g=>{g.exports=i}},o={};function h(g){var _=o[g];if(_!==void 0)return _.exports;var v=o[g]={exports:{}};return n[g](v,v.exports,h),v.exports}h.n=g=>{var _=g&&g.__esModule?()=>g.default:()=>g;return h.d(_,{a:_}),_},h.d=(g,_)=>{for(var v in _)h.o(_,v)&&!h.o(g,v)&&Object.defineProperty(g,v,{enumerable:!0,get:_[v]})},h.o=(g,_)=>Object.prototype.hasOwnProperty.call(g,_),h.r=g=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(g,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(g,"__esModule",{value:!0})};var c={};return(()=>{h.r(c),h.d(c,{PerlinDrawer2D:()=>g.PerlinDrawer2D,PerlinGenerator:()=>g.PerlinGenerator});var g=h("./src/perlin-noise.ts")})(),c})())}(Pl)),Pl.exports}var Rx=Ix();const Dx=new Rx.PerlinGenerator({seed:Date.now(),octaves:3,frequency:24,amplitude:.91,persistance:.95}),Js=new Vw({pos:K(0,0),tileWidth:64,tileHeight:32,columns:25,rows:25});let Fx=[is.getSprite(0,0),is.getSprite(1,0),is.getSprite(2,0),is.getSprite(3,0),is.getSprite(4,0),is.getSprite(5,0),is.getSprite(6,0),is.getSprite(0,1),is.getSprite(1,1),is.getSprite(2,1)],Tl=0;for(const d of Js.tiles){if(lp(Tl,Js.columns,Js.rows)){if(d.x==0){let t=new Ds({useAnchor:!0,members:[{graphic:la.getSprite(0,0),offset:K(0,10)},{graphic:dt.tree.toSprite(),offset:K(-6,-30)}]});d.addGraphic(t)}else if(d.y==0&&d.x!=0||d.y==Js.rows-1&&d.x!=0){const t=dt.fence.toSprite();let i=new Ds({useAnchor:!0,members:[{graphic:la.getSprite(0,0),offset:K(0,-32)},{graphic:t,offset:K(0,-32)}]});d.addGraphic(i)}else{let t=new Ds({useAnchor:!0,members:[{graphic:la.getSprite(0,0),offset:K(0,-32)}]});d.addGraphic(t)}d.solid=!0,d.addCollider(Gw.Polygon([K(0,17),K(32,1),K(63,17),K(32,33)]))}else{let t=la.getSprite(0,0);const n=Dx.grid(Js.columns,Js.rows)[Tl];let o=new vr;if(n>.55){const h=o.pickOne(Fx);let c=o.integer(16,32),g=-32,_=new Ds({useAnchor:!0,members:[{graphic:t,offset:K(0,-32)},{graphic:h,offset:K(c,g)}]});d.addGraphic(_)}else{let h=new Ds({useAnchor:!0,members:[{graphic:t,offset:K(0,-32)}]});d.addGraphic(h)}}Tl++}Js.updateColliders();const Zs=150,Mx=new ee({strategy:ie.Loop,frames:[{graphic:Ii.getSprite(0,0),duration:Zs},{graphic:Ii.getSprite(1,0),duration:Zs},{graphic:Ii.getSprite(2,0),duration:Zs},{graphic:Ii.getSprite(3,0),duration:Zs},{graphic:Ii.getSprite(4,0),duration:Zs},{graphic:Ii.getSprite(5,0),duration:Zs},{graphic:Ii.getSprite(6,0),duration:Zs},{graphic:Ii.getSprite(7,0),duration:Zs}]});class Bx extends Ai{progressionStates;overallScore=0;engine;scaleAnimation;resetSignal=new qt("waveReset");highScore="0";lightEnemiesScore;darkEnemiesScore;blessingsScore;soulsScore;swordPlayerScore;bowPlayerScore;totalEnemies;totalEnemiesRemoved;balanceEnemyTypesDefeated;balancePickups;balancePlayerKills;balanceEnemyDefeatRate;myWidth;waveScoreLabel;overallScoreLabel;highscoreLabel;heartButton;flexButton;clockButton;uiData;balance=0;balanceCursorStartingPos=0;balanceCursor;constructor(t){let i=t.screen.contentArea,n=i.right-i.left-20,o=i.bottom-i.top-80,h=new At(10,10);super({width:n,height:o,pos:h,color:le.fromHex("#444444"),z:9e3}),this.myWidth=n,this.uiData={lightEnemiesDefeated:0,darkEnemiesDefeated:0,blessingsCollected:0,soulsCollected:0,totalEnemies:0,totalEnemiesRemoved:0,swordPlayerScore:0,bowPlayerScore:0},this.engine=t;class c extends Ai{constructor(){super({pos:K(n/2-24,15),x:n/2,width:48,height:48,z:2002}),this.graphics.use(Mx)}}this.scaleAnimation=new c,this.addChild(this.scaleAnimation),new as({pos:K(24,45),text:"0",font:new os({family:"Arial",size:24,color:le.White,textAlign:hs.Center})}),this.darkEnemiesScore=ai.create(K(80,47),"0"),this.lightEnemiesScore=ai.create(K(150,47),"0"),this.blessingsScore=ai.create(K(80,88),"0"),this.soulsScore=ai.create(K(150,88),"0"),this.swordPlayerScore=ai.create(K(80,125),"0"),this.bowPlayerScore=ai.create(K(150,125),"0"),this.totalEnemies=ai.create(K(80,165),"0"),this.totalEnemiesRemoved=ai.create(K(150,165),"0"),this.balanceEnemyTypesDefeated=ai.create(K(225,47),"0"),this.balancePickups=ai.create(K(225,88),"0"),this.balancePlayerKills=ai.create(K(225,125),"0"),this.balanceEnemyDefeatRate=ai.create(K(231,165),"0"),this.waveScoreLabel=ai.create(K(n/2+75,97),"0",32),this.overallScoreLabel=ai.create(K(n/2+75,149),"0",32),this.highscoreLabel=ai.create(K(50,o-20),`${this.highScore} `,12),this.addChild(this.lightEnemiesScore),this.addChild(this.darkEnemiesScore),this.addChild(this.blessingsScore),this.addChild(this.soulsScore),this.addChild(this.swordPlayerScore),this.addChild(this.bowPlayerScore),this.addChild(this.totalEnemies),this.addChild(this.totalEnemiesRemoved),this.addChild(this.balanceEnemyTypesDefeated),this.addChild(this.balancePickups),this.addChild(this.balancePlayerKills),this.addChild(this.balanceEnemyDefeatRate),this.addChild(this.waveScoreLabel),this.addChild(this.overallScoreLabel),this.addChild(this.highscoreLabel),this.addChild(Xe.create(K(110,45),Da.getSprite(1,0),K(.75,.75))),this.addChild(Xe.create(K(40,45),Da.getSprite(0,0),K(.75,.75))),this.addChild(Xe.create(K(44,90),Ra.getSprite(1,0),K(1.4,1.4))),this.addChild(Xe.create(K(115,90),Ra.getSprite(0,0),K(1.4,1.4))),this.addChild(Xe.create(K(21,105),tr.getSprite(0,0),K(1,1))),this.addChild(Xe.create(K(105,119),Yr.getSprite(0,0),K(1,1))),this.addChild(Xe.create(K(38,165),je.getSprite(0,0),K(.75,.75))),this.addChild(Xe.create(K(108,160),dt.swordPlayerIconDamaged.toSprite(),K(.6,.6))),this.addChild(Xe.create(K(180,45),Ii.getSprite(0,0),K(.6,.6))),this.addChild(Xe.create(K(180,85),Ii.getSprite(0,0),K(.6,.6))),this.addChild(Xe.create(K(180,125),Ii.getSprite(0,0),K(.6,.6))),this.addChild(Xe.create(K(180,165),Ii.getSprite(0,0),K(.6,.6))),this.addChild(Xe.create(K(300,150),dt.goldmedal.toSprite(),K(1.5,1.5))),this.addChild(Xe.create(K(300,100),dt.silvermedal.toSprite(),K(1.5,1.5))),this.addChild(Xe.create(K(10,o-25),dt.goldstar.toSprite(),K(1.5,1.5)))}getOverallScore(){return this.overallScore}show(t,i,n,o,h){this.progressionStates=o,this.highScore=Za()??"0",this.highscoreLabel.text=`${this.highScore} `,console.log("highscore",this.highScore),this.clockButton||(this.clockButton=new Il(dt.clock.toSprite(),K(this.myWidth-75,155),"speed"),this.addChild(this.clockButton)),this.clockButton.updateEnable(!1),this.heartButton||(this.heartButton=new Il(dt.heart.toSprite(),K(this.myWidth-75,45),"constitution"),this.addChild(this.heartButton)),this.heartButton.updateEnable(!1),this.flexButton||(this.flexButton=new Il(dt.flex.toSprite(),K(this.myWidth-75,100),"strength"),this.addChild(this.flexButton)),this.flexButton.updateEnable(!1),this.uiData.lightEnemiesDefeated=i.lightEnemiesDefeated,this.uiData.darkEnemiesDefeated=i.darkEnemiesDefeated,this.uiData.blessingsCollected=i.blessingsCollected,this.uiData.soulsCollected=i.soulsCollected,this.uiData.totalEnemies=i.totalEnemies,this.uiData.totalEnemiesRemoved=i.totalEnemiesRemoved,this.uiData.bowPlayerScore=n.lightNumberOfEnemiesDefeated,this.uiData.swordPlayerScore=n.darkNumberOfEnemiesDefeated,this.lightEnemiesScore.text=`${this.uiData.lightEnemiesDefeated}`,this.darkEnemiesScore.text=`${this.uiData.darkEnemiesDefeated}`,this.blessingsScore.text=`${this.uiData.blessingsCollected}`,this.soulsScore.text=`${this.uiData.soulsCollected}`,this.swordPlayerScore.text=`${this.uiData.swordPlayerScore}`,this.bowPlayerScore.text=`${this.uiData.bowPlayerScore}`,this.totalEnemies.text=`${this.uiData.totalEnemies}`,this.totalEnemiesRemoved.text=`${this.uiData.totalEnemiesRemoved}`;let c=Math.abs(this.uiData.darkEnemiesDefeated-this.uiData.lightEnemiesDefeated);this.balanceEnemyTypesDefeated.text=`${c}`;let g=Math.abs(this.uiData.blessingsCollected-this.uiData.soulsCollected);this.balancePickups.text=`${g}`;let _=Math.abs(this.uiData.bowPlayerScore-this.uiData.swordPlayerScore);if(this.balancePlayerKills.text=`${_}`,this.uiData.totalEnemies==0)this.balanceEnemyDefeatRate.text="0%";else{let I=((1-this.uiData.totalEnemiesRemoved/this.uiData.totalEnemies)*100).toFixed(0);I.length,this.balanceEnemyDefeatRate.text=`${I}%`}const v=this.uiData.totalEnemies-this.uiData.totalEnemiesRemoved;let x=100-10*Math.abs(this.uiData.darkEnemiesDefeated-this.uiData.lightEnemiesDefeated),A=100-10*Math.abs(this.uiData.blessingsCollected-this.uiData.soulsCollected),S=100-1*Math.abs(this.uiData.bowPlayerScore-this.uiData.swordPlayerScore);x<0&&(x=0),A<0&&(A=0),S<0&&(S=0);const P=v+x+A+S;this.waveScoreLabel.text=`${P}`,this.showScoreTransfer(P),t.add(this),this.resetSignal.send([])}showScoreTransfer(t){setTimeout(()=>{let i=setInterval(()=>{t-=1,this.overallScore+=1,this.waveScoreLabel.text=`${t}`,this.overallScoreLabel.text=`${this.overallScore}`,dt.sfxUptickScore.play(Ri),t==0&&(clearInterval(i),dt.sfxFinalScoreUptick.play(Ri),this.heartButton.updateEnable(!0),this.progressionStates.strength<2&&this.flexButton.updateEnable(!0),this.progressionStates.speed<2&&this.clockButton.updateEnable(!0),this.overallScore>parseInt(this.highScore)?(this.highScore=this.overallScore.toString(),tx(this.overallScore),this.highscoreLabel.text=`${this.highScore} `):this.highscoreLabel.text=`${this.highScore} `)},25)},1e3)}hide(t){t.remove(this)}handleTouchControls(t){const i=t.rawEvent.coordinates.screenPos;t.rawEvent.type=="up"?this.heartButton?.contains(i.x,i.y)?this.heartButton.onUp():this.flexButton?.contains(i.x,i.y)?this.flexButton.onUp():this.clockButton?.contains(i.x,i.y)&&this.clockButton.onUp():t.rawEvent.type=="down"&&(this.heartButton?.contains(i.x,i.y)?this.heartButton.onDown():this.flexButton?.contains(i.x,i.y)?this.flexButton.onDown():this.clockButton?.contains(i.x,i.y)&&this.clockButton.onDown())}onInitialize(t){}}class Xe extends Ai{name="ScreenElementFactory";constructor(t,i,n){super({pos:t}),n&&(this.scale=n),this.graphics.use(i)}static create(t,i,n){return new Xe(t,i,n)}}let ai=class Wp extends as{name="LabelFactory";constructor(t,i,n=20){super({pos:t,text:i,font:new os({family:"Arial",size:n,color:le.White,textAlign:hs.Center})})}static create(t,i,n=20){return new Wp(t,i,n)}};class Il extends Ai{name="ProgressionButtons";upGraphic;downGraphic;icon;type;enabled=!0;upGraphicGroup;downGraphicGroup;subUp;subDown;progressionSignal=new qt("progressionUpdate");constructor(t,i,n){super({width:80,height:48,pos:i,z:2002,anchor:At.Half,color:le.fromHex("#2bb2ea")}),this.type=n,this.pointer.useGraphicsBounds=!1,this.pointer.useColliderShape=!0,this.icon=t;const o={width:80,height:48,source:dt.buttonUp,sourceConfig:{width:192,height:64,leftMargin:3,rightMargin:3,topMargin:2,bottomMargin:4},destinationConfig:{drawCenter:!0,horizontalStretch:ha.Stretch,verticalStretch:ha.Stretch}};this.upGraphic=new df(o),this.upGraphicGroup=new Ds({useAnchor:!0,members:[this.upGraphic,{graphic:t,offset:K(22,8)}]}),this.graphics.use(this.upGraphicGroup);const h={width:80,height:48,source:dt.buttonDown,sourceConfig:{width:192,height:64,leftMargin:3,rightMargin:3,topMargin:2,bottomMargin:2},destinationConfig:{drawCenter:!0,horizontalStretch:ha.Stretch,verticalStretch:ha.Stretch}};this.downGraphic=new df(h),this.downGraphicGroup=new Ds({useAnchor:!0,members:[this.downGraphic,{graphic:t,offset:K(22,8)}]})}updateEnable(t){if(this.enabled=t,this.enabled==!1){let i=this.graphics.current;i&&(i.tint=le.Gray)}else{let i=this.graphics.current;i&&(i.tint=null)}}onInitialize=t=>{};onDown(){this.enabled&&this.graphics.use(this.downGraphicGroup)}onUp(){this.enabled&&(this.scene.hideEndOfWaveModal(),this.graphics.use(this.upGraphicGroup),this.progressionSignal.send([this.type]))}onAdd(t){}onRemove(t){}}class kx extends Ai{constructor(t){super({name:"StatusBar",width:t.x,height:15,x:0,y:1,z:999}),this.dims=t,this.updateSignal.listen(this.UIUpdate.bind(this)),this.lightKillsLabel=new as({anchor:At.Zero,text:"0",font:new os({size:8,family:"Arial",color:le.White,textAlign:hs.Center}),x:t.x-58,y:1}),this.darkKillsLabel=new as({anchor:At.Zero,text:"0",font:new os({size:8,family:"Arial",color:le.White,textAlign:hs.Center}),x:t.x-84,y:1}),this.enemiesRemainingLabel=new as({anchor:At.Zero,text:"0",font:new os({size:8,family:"Arial",color:le.White,textAlign:hs.Center}),x:t.x-110,y:1}),this.soulsCollectedLabel=new as({anchor:At.Zero,text:"0",font:new os({size:8,family:"Arial",color:le.White,textAlign:hs.Center}),x:t.x-36,y:1}),this.blessingsCollectedLabel=new as({anchor:At.Zero,text:"0",font:new os({size:8,family:"Arial",color:le.White,textAlign:hs.Center}),x:t.x-12,y:1}),this.addChild(this.lightKillsLabel),this.addChild(this.darkKillsLabel),this.addChild(this.enemiesRemainingLabel),this.addChild(this.soulsCollectedLabel),this.addChild(this.blessingsCollectedLabel);class i extends Ai{constructor(o,h,c){super({pos:o,width:10,height:10,z:999}),this.graphics.use(h),c&&(this.scale=c)}}this.addChild(new i(new At(t.x-25,0),dt.blessing.toSprite())),this.addChild(new i(new At(t.x-50,0),dt.soul.toSprite())),this.addChild(new i(new At(t.x-125,0),je.getSprite(0,0),new At(.4,.4))),this.addChild(new i(new At(t.x-75,0),Da.getSprite(0,0),new At(.4,.4))),this.addChild(new i(new At(t.x-100,0),Da.getSprite(1,0),new At(.4,.4))),this.resetSignal.listen(()=>this.reset())}totalEnemiesDefeated=0;totalEnemiesRemaining=0;totalEnemiesRemoved=0;lightEnemiesDefeated=0;darkEnemiesDefeated=0;soulsCollected=0;blessingsCollected=0;updateSignal=new qt("stateUpdate");enemiesInWave=0;resetSignal=new qt("waveReset");enemiesRemainingLabel;lightKillsLabel;darkKillsLabel;soulsCollectedLabel;blessingsCollectedLabel;onPreUpdate(t,i){this.enemiesRemainingLabel.text=`${this.totalEnemiesRemaining}`,this.lightKillsLabel.text=`${this.lightEnemiesDefeated}`,this.darkKillsLabel.text=`${this.darkEnemiesDefeated}`,this.soulsCollectedLabel.text=`${this.soulsCollected}`,this.blessingsCollectedLabel.text=`${this.blessingsCollected}`}UIUpdate(t){const[i,n]=t.detail.params;i==="enemyDefeated"?(n==="light"&&(this.lightEnemiesDefeated+=1),n==="dark"&&(this.darkEnemiesDefeated+=1),this.totalEnemiesDefeated=this.lightEnemiesDefeated+this.darkEnemiesDefeated+this.totalEnemiesRemoved,this.totalEnemiesRemaining=this.enemiesInWave-this.totalEnemiesDefeated):i=="soul"?this.soulsCollected++:i=="blessing"?this.blessingsCollected++:i=="batchsize"?(this.enemiesInWave=n,this.totalEnemiesDefeated=0,this.totalEnemiesRemoved=0,this.lightEnemiesDefeated=0,this.darkEnemiesDefeated=0,this.totalEnemiesRemaining=this.enemiesInWave-this.totalEnemiesDefeated):i=="playerDamaged"&&(this.totalEnemiesRemoved++,this.totalEnemiesDefeated=this.lightEnemiesDefeated+this.darkEnemiesDefeated+this.totalEnemiesRemoved,this.totalEnemiesRemaining=this.enemiesInWave-this.totalEnemiesDefeated)}reset(){this.lightEnemiesDefeated=0,this.darkEnemiesDefeated=0,this.soulsCollected=0,this.blessingsCollected=0,this.totalEnemiesDefeated=0,this.totalEnemiesRemoved=0}getUIState(){return{lightEnemiesDefeated:this.lightEnemiesDefeated,darkEnemiesDefeated:this.darkEnemiesDefeated,soulsCollected:this.soulsCollected,blessingsCollected:this.blessingsCollected,totalEnemies:this.enemiesInWave,totalEnemiesRemoved:this.totalEnemiesRemoved}}}class Lx{scene;_isModalShowing=!1;_gestureStartPos=At.Zero;_currentPos=At.Zero;_moveDelta=At.Zero;_lastDirection={x:0,y:0};_isActive=!1;_isDown=!1;_lastEvent=null;_updateInterval=null;_lastState="idle";_controlMap=new Map;_activeTouchReceiver=null;_holdTimeout=null;_holdTriggered=!1;constructor(t){this.scene=t}initialize(t){const i=this.scene.engine;this._controlMap=t,i.input.pointers.primary.on("down",n=>this.onDown(n)),i.input.pointers.primary.on("up",n=>this.onUp(n)),i.input.pointers.primary.on("move",n=>this.onMove(n))}set activeTouchReceiver(t){this._activeTouchReceiver=t}get activeTouchReceiver(){return this._activeTouchReceiver}set modalShowing(t){this._isModalShowing=t}get modalShowing(){return this._isModalShowing}register(){}onDown(t){this._isModalShowing?(this._lastEvent=t,this.notifyJoystickChange("active",K(0,0)),this._isDown=!0):(this._gestureStartPos=t.worldPos.clone(),this._currentPos=t.worldPos.clone(),this._moveDelta=At.Zero,this._lastDirection={x:0,y:0},this._isActive=!0,this._isDown=!0,this._lastEvent=t,this._holdTriggered=!1,this.clearHoldTimeout(),this._holdTimeout=window.setTimeout(()=>{this._holdTriggered=!0,this.notifyHold()},500),this.clearUpdateInterval(),this._updateInterval=window.setInterval(()=>{this.processJoystickState()},50))}onUp(t){this._isDown&&(this._isDown=!1,this._isActive=!1,this._moveDelta=At.Zero,this._lastDirection={x:0,y:0},this._lastEvent=t,this.clearUpdateInterval(),this.clearHoldTimeout(),this.notifyJoystickChange("idle"))}clearHoldTimeout(){this._holdTimeout&&(window.clearTimeout(this._holdTimeout),this._holdTimeout=null)}onMove(t){if(this._isDown&&(this._currentPos=t.worldPos.clone(),this._moveDelta=this._currentPos.sub(this._gestureStartPos),this._lastEvent=t,!this._holdTriggered&&this._moveDelta.magnitude>10&&this.clearHoldTimeout(),this._lastState==="active")){const i=this._moveDelta.magnitude;if(i>=15){const n={x:this._moveDelta.x/i,y:this._moveDelta.y/i};if(Math.abs(this._lastDirection.x)>.01||Math.abs(this._lastDirection.y)>.01){const o=this._lastDirection.x*n.x+this._lastDirection.y*n.y;if(Math.acos(Math.max(-1,Math.min(1,o)))*(180/Math.PI)>90){const c=Math.min(i,50),g=new At(n.x*c,n.y*c);this._gestureStartPos=this._currentPos.sub(g),this._moveDelta=g,this._lastDirection=n}}}}}clearUpdateInterval(){this._updateInterval&&(window.clearInterval(this._updateInterval),this._updateInterval=null)}processJoystickState(){if(!this._isDown||!this._isActive)return;const t=this._moveDelta.magnitude;let i="idle";t>=15&&(i="active");const n=Math.min(t,15);let o={x:0,y:0};t>0&&(o={x:this._moveDelta.x/t,y:this._moveDelta.y/t},this._lastDirection=o),(i!==this._lastState||i==="active")&&this.notifyJoystickChange(i,o,n),this._lastState=i}notifyHold(){if(!this._activeTouchReceiver)return;const t=this._controlMap.get(this._activeTouchReceiver);t&&t({type:"hold",state:"hold",rawEvent:this._lastEvent||void 0})}notifyJoystickChange=(t,i={x:0,y:0},n=0)=>{if(!this._activeTouchReceiver)return;let o=this._controlMap.get(this._activeTouchReceiver);o&&o({direction:i,distance:n,state:t,rawEvent:this._lastEvent||void 0})}}class Ux extends Ai{cursor;balance=0;startingPosX=0;constructor(t){super(),this.z=2005,this.cursor=new zx,this.addChild(this.cursor),this.startingPosX=this.cursor.pos.x}onInitialize(t){this.graphics.use(dt.spectrum.toSprite());const i=t.currentScene.engine.screen.contentArea;this.pos=K(i.width/2-144,i.height-34)}updateBalance(t){this.balance=t,this.balance<-71?this.balance=-71:this.balance>71&&(this.balance=71)}onPreUpdate(t,i){this.cursor.pos.x,this.cursor.pos=K(this.startingPosX+this.balance*2,8)}}class zx extends Ai{constructor(){super(),this.pos=K(139,8)}onInitialize(t){this.graphics.use(dt.cursor.toSprite())}}class Hx extends ld{arena;darkPlayer;lightPlayer;statusBar;sceneTouchManger;burnDown;enemyWaveManager;pregressionSignal=new qt("progressionUpdate");enemyDefeatedSignal=new qt("enemyDefeated");UISignal=new qt("stateUpdate");balanceUI;hudData={lightkills:0,darkkills:0,blessings:0,souls:0,axeKills:0,bowkills:0};progressionStates={health:0,strength:0,speed:0};gameState={waveNumber:0,enemiesRemaining:0,darkEnemiesDefeated:0,lightEnemiesDefeated:0,darkExp:0,lightExp:0,gameDuration:0};stateSignal=new qt("stateUpdate");pauseGameSignal=new qt("pauseGame");endOfWaveModal;touchMap=new Map;scheduleGameOver=!1;scheculedGameOverTik=0;isEndOfWaveModalEnabled=!0;highScore="0";constructor(){super()}onActivate(t){this.isEndOfWaveModalEnabled=!0,this.scheduleGameOver=!1,this.scheculedGameOverTik=0,this.highScore=Za()??"0",this.arena=Js,this.add(this.arena),this.darkPlayer=new ua,this.add(this.darkPlayer),this.darkPlayer.pos=$0(this.arena),this.lightPlayer=new Vp,this.add(this.lightPlayer),this.darkPlayer.registerPartner(this.lightPlayer),this.lightPlayer.registerPartner(this.darkPlayer),this.endOfWaveModal=new Bx(t.engine),this.touchMap.set("darkPlayer",this.darkPlayer.joystickCallback),this.touchMap.set("lightPlayer",this.lightPlayer.joystickCallback),this.touchMap.set("UImodal",o=>{this.endOfWaveModal?.handleTouchControls(o)}),this.sceneTouchManger=new Lx(this),this.sceneTouchManger.initialize(this.touchMap),this.sceneTouchManger.activeTouchReceiver="darkPlayer",this.enemyWaveManager=new Ex(this,this.lightPlayer,this.darkPlayer,this.arena),this.enemyWaveManager?.init();const i=this.engine.screen.contentArea.width,n=this.engine.screen.contentArea.height;this.statusBar=new kx(K(i,n)),this.add(this.statusBar),this.stateSignal.listen(this.stateUpdate.bind(this)),this.balanceUI=new Ux(this),this.add(this.balanceUI),this.enemyDefeatedSignal.listen(o=>{const[h,c,g]=o.detail.params;c==="light"&&g==="axe"?this.hudData.lightkills+=1:c==="dark"&&g==="bow"&&(this.hudData.darkkills+=1),this.hudData.axeKills=this.darkPlayer?.numEnemiesWhileActive,this.hudData.bowkills=this.lightPlayer?.numEnemiesWhileActive}),this.UISignal.listen(o=>{const[h]=o.detail.params;h==="blessing"?this.hudData.blessings+=1:h==="soul"&&(this.hudData.souls+=1)}),this.pregressionSignal.listen(o=>{switch(o.detail.params[0]){case"constitution":this.progressionStates.health++,this.progressionStates.health>2&&(this.progressionStates.health=2);break;case"strength":this.progressionStates.strength++,this.progressionStates.strength>2&&(this.progressionStates.strength=2);break;case"speed":this.progressionStates.speed++,this.progressionStates.speed>2&&(this.progressionStates.speed=2);break}}),this.enemyWaveManager?.startWave()}onDeactivate(t){this.darkPlayer?.kill(),this.lightPlayer?.kill(),this.enemyWaveManager?.endWave()}onPreUpdate(t,i){this.scheduleGameOver&&this.scheculedGameOverTik++,this.scheculedGameOverTik>300&&this.engine.goToScene("gameOver",{sceneActivationData:{score:this.endOfWaveModal?.getOverallScore()}}),this.enemyWaveManager?.update(i),this.balanceUI.updateBalance(this.getBalanceValue()),!this.darkPlayer?.isAlive&&!this.lightPlayer?.isAlive&&(this.scheduleGameOver=!0,this.isEndOfWaveModalEnabled=!1,this.enemyWaveManager.isWaveActive=!1)}getHighScore(){return this.highScore}stateUpdate(t){const[i,n]=t.detail.params;this.gameState[i]=n}showEndOfWaveModal(){this.isEndOfWaveModalEnabled&&(this.darkPlayer.vel=K(0,0),this.lightPlayer.vel=K(0,0),this.sceneTouchManger.activeTouchReceiver="UImodal",this.sceneTouchManger.modalShowing=!0,setTimeout(()=>this.endOfWaveModal?.show(this,this.statusBar.getUIState(),this.getPlayerData(),this.progressionStates,this.getBalanceValue()),500))}getPlayerData(){return{darkNumberOfEnemiesDefeated:this.darkPlayer.numEnemiesWhileActive,lightNumberOfEnemiesDefeated:this.lightPlayer.numEnemiesWhileActive}}hideEndOfWaveModal(){this.endOfWaveModal?.hide(this),this.sceneTouchManger.modalShowing=!1,this.enemyWaveManager?.startWave(),(this.darkPlayer?.isPlayerActive?this.darkPlayer:this.lightPlayer)instanceof ua?this.sceneTouchManger.activeTouchReceiver="darkPlayer":this.sceneTouchManger.activeTouchReceiver="lightPlayer"}getBalanceValue(){this.hudData.lightkills-this.hudData.darkkills;let t=this.hudData.blessings-this.hudData.souls,i=this.hudData.bowkills-this.hudData.axeKills;return t+i}switchPlayerFocus(){let t;dt.sfxPlayerSwitch.play(Ri),this.darkPlayer?.isPlayerActive&&!this.lightPlayer?.isPlayerActive?t=this.lightPlayer:t=this.darkPlayer,this.engine.timescale=.1,this.camera.clearAllStrategies(),this.camera.zoomOverTime(.8,100).then(()=>{this.camera.zoomOverTime(1.5,100).then(()=>{this.engine.timescale=1,this.camera.strategy.lockToActor(t),this.lightPlayer.switchLock=!1,this.darkPlayer.switchLock=!1,t instanceof ua?(this.darkPlayer.isPlayerActive=!0,this.lightPlayer.isPlayerActive=!1,this.sceneTouchManger.activeTouchReceiver="darkPlayer"):(this.darkPlayer.isPlayerActive=!1,this.lightPlayer.isPlayerActive=!0,this.sceneTouchManger.activeTouchReceiver="lightPlayer")})}),this.camera.move(t.pos,200)}}class Np extends Ai{buttonText;upGraphic;downGraphic;constructor(t){super({width:192,height:64,pos:t}),this.buttonText=new as({text:"START",pos:K(192/2,16),font:new os({width:192,height:64,family:"Arial",size:36,color:le.White,textAlign:hs.Center})}),this.addChild(this.buttonText),this.upGraphic=dt.buttonUp.toSprite(),this.downGraphic=dt.buttonDown.toSprite()}onInitialize(t){this.graphics.use(this.upGraphic),this.on("pointerup",()=>{this.graphics.use(this.upGraphic),window.location.reload(),this.buttonText.pos=this.buttonText.pos.add(K(0,-4))}),this.on("pointerdown",()=>{this.graphics.use(this.downGraphic),this.buttonText.pos=this.buttonText.pos.add(K(0,4))})}}class Ox extends Ai{title;constructor(t){let i=t.right-t.left-20,n=t.bottom-t.top-20,o=new At(10,10);super({width:i,height:n,pos:o,color:le.fromHex("#005465")}),this.title=new as({width:i,height:n/4,pos:K(0,0),text:"Angels 'n Demons",font:new os({family:"Arial",size:36,color:le.White,textAlign:hs.Center})}),this.title.pos=K(i/2,n/4),this.addChild(this.title),this.addChild(new Np(K(i/2-192/2,n*.55)))}onInitialize(t){}}class Vx extends ld{starintModal;constructor(){super()}onActivate(t){this.starintModal=new Ox(t.engine.screen.contentArea),this.add(this.starintModal)}onDeactivate(t){}}class Wx extends ld{title;button;highscoreLabel;highScore="0";overallScore=0;overallScoreLabel;onActivate(t){const i=t.engine.screen.contentArea;this.title=jr.create(K(i.width/2,i.height/2-100),"Game Over",42),this.button=new Np(K(i.width/2-192/2,i.height/2)),this.add(this.title),this.add(this.button),this.overallScore=t.data.score,this.highScore=Za()??"0",this.highscoreLabel=jr.create(K(i.width/2,i.height/2+100),`${this.highScore}`,20),this.overallScoreLabel=jr.create(K(i.width/2,i.height/2+75),`${this.overallScore}`,20),this.add(this.highscoreLabel),this.add(this.overallScoreLabel),this.add(Fa.create(K(i.width/2+50,i.height/2+110),dt.silvermedal.toSprite())),this.add(Fa.create(K(i.width/2+50,i.height/2+135),dt.goldstar.toSprite()))}}class jr extends as{constructor(t,i,n=20){super({pos:t,text:i,font:new os({family:"Arial",size:n,color:le.White,textAlign:hs.Center}),z:2e3})}static create(t,i,n=20){return new jr(t,i,n)}}class Fa extends Ai{constructor(t,i,n=K(1,1)){t=K(t.x-96,t.y-32),super({pos:t,z:2e3,scale:n}),this.graphics.use(i)}static create(t,i,n=K(1,1)){return new Fa(t,i,n)}}await Ct.create(document.body,Xw,qw).attached;let xf;window.addEventListener("resize",()=>{console.log("resize"),clearTimeout(xf),xf=window.setTimeout(()=>{location.reload()},500)});const Gp=new Ow({resolution:{width:640,height:360},viewport:{width:640,height:360},canvasElementId:"cnv",displayMode:Hw.FitScreenAndZoom,pixelArt:!0,backgroundColor:le.fromHex("#26111f"),scenes:{intro:{scene:new Vx},game:{scene:new Hx},gameOver:{scene:new Wx}},pixelRatio:2});await Gp.start(dd);Gp.goToScene("game");
