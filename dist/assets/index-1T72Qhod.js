(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const h of o)if(h.type==="childList")for(const c of h.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function i(o){const h={};return o.integrity&&(h.integrity=o.integrity),o.referrerPolicy&&(h.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?h.credentials="include":o.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function n(o){if(o.ep)return;o.ep=!0;const h=i(o);fetch(o.href,h)}})();class fs{constructor(){this.state="created",this.host=null,this.bindings=[],this.views=[],this.animations=[],this.animationQueue=[],this.destroyed="",this.moved=""}static create(t,i={},n,o={parent:null,prepare:!0,sibling:null}){const h=new fs;if(h.model=i,h.element=n??t,h.parent=o.parent??xt,h.host=o.host??h.parent.host,h.sibling=o.sibling??null,n instanceof HTMLTemplateElement||n?.tagName==="TEMPLATE"){const c=n.content.cloneNode(!0);if(c.children.length===1)return xt.create(t,i,c.firstElementChild,o);h.views=[...c.children].map(_=>xt.create(t,i,_,{...o,parent:h})),h.state="rendered"}else h.bindings.push(...xt.parse(h.element,i,h,o.parent));return h.parentElement=n!=null?t:t.ownerDocument.documentElement,h.views.length>1?(h.attached=Promise.all(h.views.map(c=>c.attached)),h.detached=Promise.all(h.views.map(c=>c.detached))):(h.attached=new Promise(c=>{h.t=c}),h.detached=new Promise(c=>{h.i=c})),h}get lastElement(){return this.render==null&&(this.render=!(this.element.hasAttribute?.("PUI-UNRENDERED")??!1)),this.render?this.element:this.bindings.flatMap(n=>n.views).slice(-1)[0]?.lastElement}destroy(){this.views.forEach(t=>t.destroy()),this.element.classList?.add("pui-removing"),this.destroyed="queue",xt.destroyed.push(this)}terminate(){Promise.all(this.getAnimations()).then(()=>{const t=this.element.parentElement;t?.removeChild(this.element),this.i?.(),this.dispatchEvent(t,"removed"),this.bindings.forEach(n=>n.unbind());const i=this.parent.views.findIndex(n=>n===this);i>-1&&this.parent.views.splice(i,1)}),this.destroyed="destroyed"}move(t){this.moved="queue",this.element.classList?.add("pui-moving"),this.sibling=t}play(t,i){return typeof t=="string"&&(t=this.animations.find(n=>n.name===t).clone()),t.element=i,t.state="pending",this.animationQueue.push(t),this.updateAnimations(performance.now()),t}updateFromUI(){this.views.forEach(t=>t.updateFromUI()),this.bindings.forEach(t=>t.updateFromUI())}updateToUI(){const t=this.state==="created";switch(t||(this.views.forEach(i=>i.updateToUI()),this.bindings.forEach(i=>i.updateToUI())),this.state){case"created":if(this.element.classList?.add("pui-adding"),this.render=!(this.element.hasAttribute?.("PUI-UNRENDERED")??!1),this.render){const i=this.parent?.parent;let o=(i?.render??!1?this.sibling:i?.sibling)??null;o=(o instanceof fs?o.lastElement:o)??null;const h=this.parentElement??xt.parentElement(this.element,this.parent);h.insertBefore(this.element,o?.nextSibling??null),this.dispatchEvent(h,"added")}this.t(),this.state="attaching";break;case"attaching":this.getAnimations(!1).length===0&&(this.element.classList?.remove("pui-adding"),this.state="attached");break;case"attached":this.state="rendered";break}t&&(this.views.forEach(i=>i.updateToUI()),this.bindings.forEach(i=>i.updateToUI()))}updateAtEvents(){this.views.forEach(t=>t.updateAtEvents()),this.bindings.forEach(t=>t.updateAtEvents())}updateAnimations(t){for(;this.animationQueue[0]?.state==="finished";)this.animationQueue.shift().destroy();for(let i=0;i<this.animationQueue.length;i++){const n=this.animationQueue[i];n.state==="pending"&&(n.isBlocked(t)||(n.state="playing",n.startTime=t,n.animation=n.element.animate(n.keyframes,n.options),n.finished=n.animation.finished,n.finished.then(()=>{n.state="finished",this.updateAnimations(performance.now())})))}}updateMove(){switch(this.moved){case"queue":this.moved="move";break;case"move":if(this.getAnimations().length===0){const t=this.parentElement??xt.parentElement(this.element,this.parent);let i=(this.sibling instanceof fs?this.sibling.lastElement:this.sibling)??null;if(this.render)t.insertBefore(this.element,i?.nextSibling??null);else{const n=this.bindings.flatMap(o=>o.views);for(const o of n)t.insertBefore(o.element,i?.nextSibling??null),i=o.element}this.element.classList?.remove("pui-moving"),this.moved="",this.sibling=null}break}this.bindings.forEach(t=>t.updateMove()),this.views.forEach(t=>t.updateMove())}getAnimations(t=!0){return(this.element.getAnimations?.({subtree:t})??[]).filter(i=>i.playState!=="finished"&&i.effect?.getTiming().iterations!==1/0).map(i=>i.finished)}dispatchEvent(t,i){if(t!=null){const n=new CustomEvent(`pui-${i}`,{detail:{model:this.model.$model??this.model,context:this.model,element:this.element,view:this},bubbles:!0,cancelable:!0});t.dispatchEvent(n)}}}class vl{constructor(){this.fromUI=!1,this.toUI=!0,this.atEvent=!1,this.oneTime=!1,this.views=[],this.firstUpdate=!0,this.events=[],this.triggerAtEvent=t=>{t.type==="change"?this.events.push(t):xt.resolveValue(this.object,this.property).call(this.object.$model,t,this.object.$model,this.element,this.attribute,this.object)},this.twoWayBindingEvent=t=>{const{target:i,property:n}=xt.resolveProperty(this.object,this.property),o=t.detail;if(o!==this.lastUIValue){let h=o;h!==void 0&&h!==this.lastValue&&xt.resolveValue(this.object,this.property)==="number"&&!isNaN(h)&&(h=+h),i[n]=h}},this.id=++xt.id}get element(){return this.$element==null&&(this.$element=typeof this.selector=="string"?this.context.querySelector(this.selector):this.selector),this.$element}set element(t){this.$element=t}static create(t){const i=new vl,n=t.property?.split(":")??[],o=n.shift(),h=typeof t.attribute!="boolean"?(t.attribute??"innerText").split(":"):[],c=typeof t.attribute!="boolean"?h.shift():t.attribute;if(i.parent=t.parent??xt,i.object="$model"in t.object?t.object:{$model:t.object},i.object.$parent==null){const _=i.parent.parent?.object?.$parent;_!=null&&(i.object.$parent=_)}return i.property=o,i.propertyArguments=n,i.context=t.context??document,i.selector=t.selector,i.attribute=c,i.attributeArguments=h,i.value=t.value??i.value,i.template=t.template??i.template,i.fromUI=t.fromUI??i.fromUI,i.toUI=t.toUI??i.toUI,i.atEvent=t.atEvent??i.atEvent,i.oneTime=t.oneTime??i.oneTime,i.addListener(),typeof i.fromUI!="boolean"&&(i.fromUI=i.fromUI.bind(i)),typeof i.toUI!="boolean"&&(i.toUI=i.toUI.bind(i)),i}destroy(){this.element=null,this.removeListener(),this.views.forEach(t=>t.destroy())}unbind(){xt.unbind(this)}addListener(){this.atEvent&&(this.toUI=!1,this.fromUI=!1,this.element.addEventListener(this.attribute,this.triggerAtEvent)),this.toUI&&this.fromUI&&customElements.get(this.element.tagName.toLowerCase())!=null&&this.element.addEventListener(this.attribute,this.twoWayBindingEvent)}removeListener(){this.atEvent&&this.element.removeEventListener(this.attribute,this.triggerAtEvent),this.toUI&&this.fromUI&&customElements.get(this.element.tagName.toLowerCase())!=null&&this.element.removeEventListener(this.attribute,this.twoWayBindingEvent)}updateFromUI(){if(this.fromUI===!1||this.firstUpdate){this.firstUpdate=!1,this.views.forEach(o=>o.updateFromUI());return}const{target:t,property:i}=xt.resolveProperty(this.element,this.attribute),n=t[i];if(n!==this.lastUIValue){let o=this.fromUI!==!0?this.fromUI(n,this.lastUIValue,this.property,this.object):n;if(this.lastUIValue=n,o!==void 0&&o!==this.lastValue){this.lastValue=o;const{target:h,property:c}=xt.resolveProperty(this.object,this.property);xt.resolveValue(this.object,this.property)==="number"&&!isNaN(o)&&(o=+o),h[c]=o}else this.lastValue=o;this.parent.host?.dispatchEvent(new CustomEvent(i,{detail:o}))}this.views.forEach(o=>o.updateFromUI())}updateToUI(){if(this.toUI===!1){this.views.forEach(i=>i.updateToUI());return}let t=xt.resolveValue(this.object,this.property);if(this.template!=null)if(this.template instanceof HTMLElement)if(typeof this.attribute=="boolean"){if(t=(t??!1)!==!1,t!==this.lastValue){const i=this.toUI!==!0?this.toUI(t,this.lastValue,this.property,this.object,this.value):t;i!==void 0&&i!==this.lastUIValue&&(i===this.attribute?this.views.push(fs.create(this.element.parentElement,this.object,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:this.element})):this.views.pop()?.destroy(),this.lastValue=t,this.lastUIValue=i)}}else{let i=!1,n=!1;t==null&&(t=[]);const o=this.propertyArguments[0],h=this.lastValue??[];if(t.length!==h.length)i=!0;else for(let b=0,P=t.length;b<P;b++){let T,I;o==null?t[b]!==h[b]&&(i=!0,n=!0):(T=xt.resolveValue(t[b]??{},o),I=xt.resolveValue(h[b]??{},o),T!==I&&(i=!0),t[b]!==h[b]&&(n=!0))}if(!i)if(n){const b=this.toUI!==!0?this.toUI(t,h,this.property,this.object,this.value):t;return this.updateViews(t,b)}else return this.updateViews();const c=this.toUI!==!0?this.toUI(t,h,this.property,this.object,this.value):t;if(c==null)return this.updateViews();const _=this.lastUIValue??[];let g=0;for(let b=0,P=c.length,T=0;b<P;b++,T++){let I,F;if(o==null?(I=c[b],F=_[T]):(I=xt.resolveValue(c[b]??{},o),F=xt.resolveValue(_[T]??{},o)),I===F)g++;else break}if(g===c.length&&c.length===_.length)return this.updateViews(t,c);const v=this.views.splice(0,g);let x=v[v.length-1];for(let b=g,P=c.length,T=g;b<P;b++,T++){const I=c[b],F=this.views.shift();if(F==null){const U={$model:{[this.attribute]:I},$parent:this.object},V=fs.create(this.element.parentElement,U,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:x??this.element});v.push(V),x=V;continue}const R=o==null?I:xt.resolveValue(I??{},o),S=F?.model.$model[this.attribute],M=o==null?S:xt.resolveValue(S??{},o);if(R===M){v.push(F),F.move(x??this.element),x=F;continue}if(!c.slice(b).map(U=>o==null?U:xt.resolveValue(U??{},o)).includes(M)){F.destroy(),b--,x=F;continue}this.views.unshift(F);let W=!1;for(let U=0,V=this.views.length;U<V;U++){const j=this.views[U],X=j?.model.$model[this.attribute],nt=o==null?X:xt.resolveValue(X??{},o);if(R===nt){v.push(...this.views.splice(U,1)),j.move(x??this.element),W=!0,x=j;break}}if(!W){const U={$model:{[this.attribute]:I},$parent:this.object},V=fs.create(this.element.parentElement,U,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:x??this.element});v.push(V),x=V}}return this.views.forEach(b=>b.destroy()),this.views=v,this.updateViews(t,c)}else{const i=xt.resolveValue(this.object,this.attribute);if((t??i)==null||(t??i)!==this.lastValue){this.lastUIValue!=null&&(this.lastUIValue.destroy(),this.lastUIValue=null);const n=t==null?i:i.create(t),o=i.template;this.lastValue=t??i;const h=this.element.nodeType===8?this.element.parentElement:this.element,c=this.element.nodeType===8?this.element:null;if(this.lastUIValue=xt.create(h,n,o,{parent:this,prepare:!0,sibling:c}),this.attributeArguments[0]!=null&&t!=null){const{target:_,property:g}=xt.resolveProperty(this.object,this.attributeArguments[0]);_[g]=this.lastUIValue}this.views.push(this.lastUIValue)}}else if(t!==this.lastValue){const i=this.toUI!==!0?this.toUI(t,this.lastValue,this.property,this.object,this.value):t;if(i!==void 0&&i!==this.lastUIValue){const{target:n,property:o}=xt.resolveProperty(this.element,this.attribute);n[o]=i,"setAttribute"in this.element&&this.element.setAttribute(this.attribute,i),this.lastValue=t,this.lastUIValue=i}}this.updateViews()}updateAtEvents(){let t=this.events.shift();for(;t!=null;)xt.resolveValue(this.object,this.property).call(this.object.$model,t,this.object.$model,this.element,this.attribute,this.object),t=this.events.shift();this.views.forEach(i=>i.updateAtEvents())}updateMove(){this.views.forEach(t=>t.updateMove())}updateViews(t,i){t==null?this.views.forEach(n=>n.updateToUI()):(this.views.forEach((n,o)=>{const h=i[o];typeof h=="object"&&(h.$index=o),n.model.$model[this.attribute]=h,n.model.$index=o,n.updateToUI()}),this.lastValue=[...t],this.lastUIValue=[...i]),this.oneTime&&(this.toUI=!1,this.fromUI=!1)}}var Zh;class Le{static initialize(t=!0){if(!this.initialized&&(this.initialized=!0,this.initializeLoadPromise(),t!==!1)){if(t===!0){const i=()=>{this.update(),requestAnimationFrame(i)};requestAnimationFrame(i);return}setInterval(()=>this.update(),1e3/t)}}static import(t){this.initializeLoadPromise(),document.body.insertAdjacentHTML("afterbegin",`<object type="text/pui" data="${t}"></object>`)}static ready(){return this.initialize(),this.loadPromise.then(()=>(this.hoist()&&document.head.insertAdjacentHTML("beforeend",'<style> object[type="text/pui"] { height: 0; position: absolute; } </style>'),this.registrations))}static create(t=document.body,i={},n=null,o={parent:null,prepare:!0,sibling:null}){if(typeof t=="string"&&(t=document.querySelector(t)),(typeof i=="string"||i instanceof HTMLElement)&&(console.warn("Old parameter order to UI.create!"),[i,n]=[n,i]),typeof n=="string"){const c=t?.ownerDocument?.defaultView!=null?t.ownerDocument:document;if(n.startsWith("#"))n=c.querySelector(n).cloneNode(!0);else{const _=c.createElement("template");_.innerHTML=o.prepare?this.prepare(n):n,n=_}}const h=fs.create(t,i,n,o);return h.parent===xt&&this.views.push(h),this.initialize(),h}static play(t,i){return typeof t=="string"?(t=this.globals.animations.find(n=>n.name===t).clone(),t.play(i)):t.play()}static queue(t){this.h.push(t),this.initialize()}static register(t,i){if(typeof t=="string"){this.registrations[t]=i;return}this.registerWebComponent(i,t)}static parse(t,i,n,o){const h=[];if(t instanceof Comment)return[];if(t instanceof HTMLTemplateElement||t.tagName==="TEMPLATE")return[];if(t.nodeType===3){let c=t.textContent,_=c.match(this.regexValue);for(;_!=null;){const g=_[1];let v=_[2];c=_[3];let x=!1;v.startsWith("|")&&(x=!0,v=v.slice(1).trimStart());const b=v.match(this.regexConditionalValue);let P,T=!0;if(v.startsWith("(")){const F=`_pui${this.bindingCounter++}`;Object.defineProperty(i,F,{get:new Function(`return ${v}`)}),v=F}else b&&(v=b[3],P=`${b[2]}${b[1]}`,T=function(F,R,S,M,W){const U=W[0]==="=";return W=W.slice(2,-1),!!F===U?W:""});let I=t.cloneNode();t.textContent=g,this.parentElement(t,o).insertBefore(I,t.nextSibling),h.push(this.bind({selector:I,attribute:"textContent",object:i,property:v,parent:n,oneTime:x,value:P,toUI:T})),t=I,I=t.cloneNode(),I.textContent=c,this.parentElement(t,o).insertBefore(I,t.nextSibling),t=I,_=c.match(this.regexValue)}}else{const c=t.getAttribute("pui")??"";if(c.trim().length>0){const _=c.split(";");for(let g of _)g=g.trim(),g.length>0&&t.setAttribute(`pui.${this.bindingCounter++}`,g)}if(t.removeAttribute("pui"),h.push(...Object.keys(t.attributes??[]).reverse().map(_=>{const g=[];if(t instanceof Comment)return[];const v=t.attributes[_];if(v.name.startsWith("pui.")){const T=v.value.match(this.regexAttribute);let[I,F,R,S,M]=T,W,U,V=!1;if(R!=="@"){const j=F.match(/^'(.*?)'$/);if(j!=null)W=j[1],t.setAttribute("value",W),F=t.nodeName.toLowerCase()==="option"?"selected":"checked",S=X=>X?W:void 0,R=X=>X===W;else if(F==="")if(S===">"){const[X,nt]=M.split(":");if(X.length>0){const{target:ht,property:wt}=this.resolveProperty(i,X);ht[wt]=t}return(nt??"").length>0&&xt.queue(()=>{const{target:ht,property:wt}=this.resolveProperty(i,nt);ht[wt]=n}),[]}else({element:t,template:U}=this.replaceWithComment(t,n,o,v.name)),F=R==="=",R=!0,S==="|"&&(V=!0);else if(S==="="&&R==="="){if(!t.tagName.includes("-")){t.setAttribute("pui-unrendered","");const X=this.parentNode(t,o);X.nodeType!==8?{element:t,template:U}=this.replaceWithComment(t,n,o,v.name,U):t=X}U=F,R=!0}else S==="*"?{element:t,template:U}=this.replaceWithComment(t,n,o,v.name):S==="|"?V=!0:F!=="checked"&&t.setAttribute(F,t.getAttribute?.(F)??"")}return[this.bind({selector:t,attribute:F,value:W,object:i,property:M,template:U,toUI:typeof R=="string"?R==="<":R,fromUI:typeof S=="string"?S===">":S,atEvent:R==="@",parent:n,oneTime:V})]}const x=[v.value];let b=0,P=x[b].match(this.regexValue);for(;P!=null;){let{before:T,property:I,after:F}=P.groups,R=!1;I.startsWith("|")&&(R=!0,I=I.slice(1).trimStart());const S=I.match(this.regexConditionalValue);let M;S&&(I=S[3],M=`${S[2]}${S[1]}`),g.push(this.bind({selector:t,attribute:v.name,object:i,property:I,oneTime:R,toUI(W,U,V,j,X){if(this.oneTime){const ht=x.indexOf(V);ht>-1&&(x[ht]=xt.resolveValue(j,V),x[ht-1]+=x[ht]+x[ht+1],x.splice(ht,2))}const nt=x.map((ht,wt)=>{if(wt%2===0)return ht;const gt=ht.match(xt.regexSplitConditionalValue);if(gt){const At=ht===`${V}${X}`?W:xt.resolveValue(j,gt[1]),Et=gt[2]==="=";return!!At===Et?gt[3].slice(1,-1):""}return ht===V?W:xt.resolveValue(j,ht)}).join("");return t.setAttribute(v.name,nt),nt},parent:n,value:M})),x[b++]=T,x[b++]=`${I}${M??""}`,x[b]=F,P=x[b].match(this.regexValue)}return g}).flat()),t instanceof Comment)return h.filter(_=>_.template!=null?!0:(_.unbind(),!1));if(!this.leaveAttributes)for(let _=Object.keys(t.attributes??[]).length-1;_>=0;_--){const g=t.attributes[Object.keys(t.attributes??[])[_]];g.name.startsWith("pui.")&&t.removeAttribute(g.name)}h.push(...Array.from(t.childNodes).map(_=>this.parse(_,i,n,o)).flat())}return h}static bind(t){return vl.create(t)}static unbind(t){if(t.destroy(),t.parent!==xt){const i=t.parent.bindings,n=i.indexOf(t);n>-1&&i.splice(n,1)}}static update(){this.u.forEach(i=>i()),this.u=this.h,this.h=[],this.views.forEach(i=>i.updateToUI()),this.views.forEach(i=>i.updateFromUI()),this.views.forEach(i=>i.updateAtEvents());const t=performance.now();[...this.views,this.globals].forEach(i=>i.updateAnimations(t)),this.views.forEach(i=>{i.updateMove()});for(let i=0;i<this.destroyed.length;i++){const n=this.destroyed[i];switch(n.destroyed){case"queue":n.state==="rendered"?n.destroyed="destroy":n.updateToUI();break;case"destroy":{n.terminate();const o=this.destroyed.findIndex(h=>n===h);o>-1&&(this.destroyed.splice(o,1),i--)}}}}static resolveProperty(t,i){i=i.replace("[",".").replace("]",".");const n=i.split(".").filter(h=>(h??"").length>0);for(;n[0]==="$parent"&&t.$parent!=null;)t=t.$parent,n.shift();let o=t;if(n[0]==="$index"&&this.objectHas(o,"$index"))return{target:o,property:n[0]};for(this.objectHas(o,"$model")&&(o=t.$model);n.length>1;)o=o[n.shift()];return{target:o,property:n[0]}}static resolveValue(t,i){let n=0;do{const{target:o,property:h}=this.resolveProperty(t,i);if(o!=null&&this.objectHas(o,h))return o[h];t=t.$parent}while(t!=null&&n++<1e3);if(i in this.registrations)return this.registrations[i]}static initializeLoadPromise(){this.loadPromise==null&&(this.loadPromise=new Promise(t=>this.loadResolve=t),document.defaultView?.addEventListener("load",this.loaded))}static hoist(t=document,i=document){t!==i&&((i.querySelectorAll("style")??[]).forEach(h=>{t.head.appendChild(h.cloneNode(!0))}),(i.querySelectorAll("template")??[]).forEach(h=>{t.head.appendChild(h.cloneNode(!0))}));const n=i.querySelectorAll('object[type="text/pui"]')??[];let o=n.length>0;return n.forEach(h=>{o=this.hoist(t,h.contentDocument)||o}),o}static objectHas(t,i){try{return i in t}catch{return!1}}static replaceWithComment(t,i,n,o,h){const c=document.createComment(o);return this.parentNode(t,n).insertBefore(c,t),this.parentNode(t,n).removeChild(t),t.removeAttribute(o),h=h??t,t=c,t.parentNode instanceof DocumentFragment&&(i.element=t),{element:t,template:h}}static parentElement(t,i){const n=t.parentElement;if(n!=null)return n;for(;i!=null&&(i.element==null||i.element===t);)i=i.parent;return i?.element}static parentNode(t,i){const n=t.parentNode;if(n!=null)return n;for(;i!=null&&(i.element==null||i.element===t);)i=i.parent;return i?.element}static prepare(t){let i=t;t="";let n=i.match(this.regexReplace);for(;n!=null;){const[o,h,c,_]=n;c.match(/\S\s*===/)?t+=`${h.trimEnd()}br PUI.${this.bindingCounter++}="${c}"`:t+=`${h} PUI.${this.bindingCounter++}="${c}" `,i=_,n=i.match(this.regexReplace)}return t+=i,t}static parseAttribute(t,i,n,o,h,c){const _=c.match(this.regexAttribute);let[g,v,x,b,P]=_,T,I,F=!1;if(x!=="@"){const R=v.match(/^'(.*?)'$/);if(R!=null)T=R[1],t.setAttribute("value",T),v=t.nodeName.toLowerCase()==="option"?"selected":"checked",b=S=>S?T:void 0,x=S=>S===T;else if(v==="")if(b===">"){const{target:S,property:M}=this.resolveProperty(i,P);return S[M]=t,[]}else({element:t,template:I}=this.replaceWithComment(t,n,o,h)),v=x==="=",x=!0,b==="|"&&(F=!0);else if(b==="="&&x==="="){const S=this.parentNode(t,o);S.nodeType!==8?{element:t,template:I}=this.replaceWithComment(t,n,o,h,I):t=S,I=v,F=!0,x=!0}else b==="*"?{element:t,template:I}=this.replaceWithComment(t,n,o,h):b==="|"?F=!0:v!=="checked"&&t.setAttribute(v,"")}return[this.bind({selector:t,attribute:v,value:T,object:i,property:P,template:I,toUI:typeof x=="string"?x==="<":x,fromUI:typeof b=="string"?b===">":b,atEvent:x==="@",parent:n,oneTime:F})]}static registerWebComponent(t,i){t??(t=i.webComponent);class n extends HTMLElement{constructor(){super(),this.webComponentComponent=i,this.webComponentUIView=null,this.attachShadow({mode:"open"})}connectedCallback(){this.initialize()}disconnectedCallback(){this.terminate()}attributeChangedCallback(c,_,g){this.initialize(),this.webComponentUIView.model[c]=g}initialize(){if(this.webComponentUIView==null){const c="create"in this.webComponentComponent?this.webComponentComponent.create():new this.webComponentComponent;c.webComponentHost=this,this.webComponentUIView=xt.create(this.shadowRoot,c,this.webComponentComponent.template,{host:this.shadowRoot?.host})}}terminate(){this.webComponentUIView!=null&&this.webComponentUIView.destroy()}}n.observedAttributes=i.observedAttributes??[],n.observedProperties=i.observedProperties??n.observedAttributes;const o=[...new Set([...n.observedAttributes,...n.observedProperties])];for(const h of o)Object.defineProperty(n.prototype,h,{configurable:!0,enumerable:!1,get(){return this.webComponentUIView.model[h]},set(c){n.observedAttributes.includes(h)?this.setAttribute(h,c):(this.initialize(),this.webComponentUIView.model[h]=c)}});return customElements.define(t,n),n}}Zh=Le;Le.initialized=!1;Le.id=0;Le.views=[];Le.destroyed=[];Le.globals=new fs;Le.registrations={};Le.leaveAttributes=!1;Le.regexReplace=/([\S\s]*?)\\?\$\{([^}]*?[<=@!]=[*=>|][^}]*?)\}([\S\s]*)/m;Le.regexAttribute=/^\s*(\S*?)\s*([<=@!])=([*=>|])\s*(\S*?)\s*$/;Le.regexValue=/(?<before>[\S\s]*?)\\?\$\{\s*(?<property>[\s\S]*?)\s*\}(?<after>[\S\s]*)/m;Le.regexConditionalValue=/^\s*(.+?)\s*([=!])\s*(\S+)/;Le.regexSplitConditionalValue=/^(.+?)([=!])(.*)/;Le.bindingCounter=0;Le.u=[];Le.h=[];Le.loaded=()=>{Zh.loadResolve(),document.defaultView?.removeEventListener("load",Zh.loaded)};function yg(){let d=window,t=window;for(;;)try{if(d.parent===d){t=d;break}else d.parent.UI!=="guarantee-condition-always-true"&&(d=d.parent)}catch{break}return t}const Qh=yg();"UI"in Qh||(Qh.UI=Le);const xt=Qh.UI;/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var Ag={851:(d,t,i)=>{i.d(t,{A:()=>g});var n=i(1),o=i.n(n),h=i(935),c=i.n(h),_=c()(o());_.push([d.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const g=_},296:(d,t,i)=>{i.d(t,{A:()=>g});var n=i(1),o=i.n(n),h=i(935),c=i.n(h),_=c()(o());_.push([d.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const g=_},935:d=>{d.exports=function(t){var i=[];return i.toString=function(){return this.map(function(o){var h="",c=typeof o[5]<"u";return o[4]&&(h+="@supports (".concat(o[4],") {")),o[2]&&(h+="@media ".concat(o[2]," {")),c&&(h+="@layer".concat(o[5].length>0?" ".concat(o[5]):""," {")),h+=t(o),c&&(h+="}"),o[2]&&(h+="}"),o[4]&&(h+="}"),h}).join("")},i.i=function(o,h,c,_,g){typeof o=="string"&&(o=[[null,o,void 0]]);var v={};if(c)for(var x=0;x<this.length;x++){var b=this[x][0];b!=null&&(v[b]=!0)}for(var P=0;P<o.length;P++){var T=[].concat(o[P]);c&&v[T[0]]||(typeof g<"u"&&(typeof T[5]>"u"||(T[1]="@layer".concat(T[5].length>0?" ".concat(T[5]):""," {").concat(T[1],"}")),T[5]=g),h&&(T[2]&&(T[1]="@media ".concat(T[2]," {").concat(T[1],"}")),T[2]=h),_&&(T[4]?(T[1]="@supports (".concat(T[4],") {").concat(T[1],"}"),T[4]=_):T[4]="".concat(_)),i.push(T))}},i}},1:d=>{d.exports=function(t){var i=t[1],n=t[3];if(!n)return i;if(typeof btoa=="function"){var o=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),h="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(o),c="/*# ".concat(h," */");return[i].concat([c]).join(`
`)}return[i].join(`
`)}}},fu={};function Ee(d){var t=fu[d];if(t!==void 0)return t.exports;var i=fu[d]={id:d,exports:{}};return Ag[d](i,i.exports,Ee),i.exports}Ee.n=d=>{var t=d&&d.__esModule?()=>d.default:()=>d;return Ee.d(t,{a:t}),t};Ee.d=(d,t)=>{for(var i in t)Ee.o(t,i)&&!Ee.o(d,i)&&Object.defineProperty(d,i,{enumerable:!0,get:t[i]})};Ee.o=(d,t)=>Object.prototype.hasOwnProperty.call(d,t);Ee.r=d=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(d,"__esModule",{value:!0})};var C={};Ee.d(C,{eKr:()=>Ql,yVm:()=>Xr,a7j:()=>Yu,U_w:()=>vc,JF2:()=>Zl,htg:()=>Ln,HXL:()=>uc,mcg:()=>Gl,Agj:()=>$e,J3_:()=>Fm,Wgv:()=>$l,u6S:()=>hm,x7M:()=>_e,X55:()=>Ei,m3M:()=>Ar,aE5:()=>nm,YJU:()=>Ti,eZi:()=>cl,GNv:()=>Tr,Y56:()=>fl,_0v:()=>Jo,vhs:()=>Go,vrQ:()=>Vr,Z8b:()=>gf,Yfw:()=>Pt,IcQ:()=>lt,kgJ:()=>pl,GTT:()=>Qf,ypY:()=>Mr,i7d:()=>Mf,fQ3:()=>Lm,HlI:()=>oa,jlt:()=>ha,VQc:()=>We,zD7:()=>gc,AUF:()=>Zi,JoF:()=>Hs,MlA:()=>pe,PZh:()=>en,qA:()=>Pr,CrD:()=>vs,dQK:()=>ji,D3r:()=>Di,Qpo:()=>Qo,D9n:()=>Zo,b6v:()=>Cr,mvh:()=>ua,Bpo:()=>ut,Q1f:()=>K,IKv:()=>jf,fcV:()=>an,Glf:()=>Yf,uAl:()=>gi,ElT:()=>Se,Z8r:()=>Al,QSL:()=>Hf,sPV:()=>jo,nAn:()=>ws,zCU:()=>Yo,QrV:()=>ke,fF9:()=>gv,Jqv:()=>yf,d_u:()=>bf,xI8:()=>Vl,yar:()=>Te,SP7:()=>Zf,oRy:()=>ca,f5X:()=>lc,V1c:()=>Cl,Mlx:()=>$f,ZiM:()=>gl,ZCo:()=>Sr,J5p:()=>Kf,mL_:()=>ii,Guw:()=>vf,N5j:()=>Xu,pgY:()=>wf,OP3:()=>Xo,rl5:()=>i_,eod:()=>Xm,q5Z:()=>Pe,YUC:()=>ec,saR:()=>Ko,hvr:()=>ml,Qol:()=>pf,Wf4:()=>_f,JCs:()=>Wt,gJV:()=>hi,fWD:()=>If,Va_:()=>ks,N$8:()=>ei,_jQ:()=>qm,rxj:()=>Yl,rhv:()=>ql,wCu:()=>Ge,HAp:()=>um,Zy1:()=>Bf,bkB:()=>Qt,wfL:()=>qo,sVA:()=>bl,$Gs:()=>Jl,CJ0:()=>$o,NWh:()=>ps,tWi:()=>jl,xAj:()=>Xl,zWh:()=>mf,i_4:()=>pv,iIx:()=>Fe,Hxo:()=>xf,c9e:()=>hl,KQV:()=>fn,weH:()=>Lt,jXp:()=>fv,zzY:()=>Vo,yRQ:()=>Wo,MtE:()=>Jf,rPj:()=>Br,KLc:()=>fi,Fir:()=>vt,V5f:()=>Il,Xj7:()=>Rl,Wud:()=>zo,FVg:()=>Ol,g5Y:()=>Hl,YQB:()=>Ul,KPb:()=>zl,nHK:()=>_a,Jrb:()=>r_,TX_:()=>dv,Olt:()=>h_,r3n:()=>On,Fvk:()=>Qm,gpR:()=>ta,vYh:()=>se,hnk:()=>ne,D2R:()=>zn,n1o:()=>hc,h9O:()=>Of,X5j:()=>qi,p3P:()=>cc,RLG:()=>Nl,fBU:()=>sc,Adb:()=>ge,bEs:()=>Yi,wCy:()=>Rt,CbD:()=>Yt,x_C:()=>jn,pGf:()=>pc,ibQ:()=>Nf,shR:()=>Dr,Yjk:()=>fc,_u1:()=>$m,OBI:()=>o_,klh:()=>br,s3S:()=>Vf,D$R:()=>Fr,xth:()=>na,JU7:()=>Ym,h9x:()=>Df,N1A:()=>wc,e_k:()=>he,aHM:()=>gn,tlv:()=>ym,Vi9:()=>Ef,ieR:()=>Sf,$bb:()=>me,VyI:()=>ct,imn:()=>Hu,uqu:()=>ai,QnL:()=>$h,vnc:()=>tc,wk_:()=>ll,GH0:()=>Mt,_1r:()=>da,l0X:()=>ol,bT:()=>tf,HHX:()=>al,jtW:()=>sf,tjk:()=>Ms,rWe:()=>tn,j9l:()=>Gu,l0$:()=>bc,sGJ:()=>us,NVp:()=>nc,cPK:()=>Ze,XoL:()=>_c,RmF:()=>Qe,DXI:()=>la,tCD:()=>Km,J3D:()=>ra,vCJ:()=>jm,e6k:()=>Wu,f9l:()=>Fi,v9m:()=>ga,yRJ:()=>Wf,EU6:()=>_l,m3O:()=>cs,Ryz:()=>Ls,OxP:()=>yr,LEs:()=>pa,Ec:()=>un,Pi5:()=>fa,gmH:()=>ds,tS:()=>xc,XxX:()=>Be,bCz:()=>sa,nYS:()=>pn,yiT:()=>Bl,NHl:()=>Yn,mO8:()=>Ll,PXI:()=>El,bn5:()=>Ml,Ywr:()=>zs,cMd:()=>_n,Bs6:()=>Fl,G0k:()=>qn,pyn:()=>kl,QeM:()=>Sl,aPX:()=>Wm,ITP:()=>Dl,BY0:()=>Us,MFw:()=>Wr,sBn:()=>Hr,S3L:()=>Bn,XKQ:()=>Ir,ESI:()=>kf,uxz:()=>Rf,o8N:()=>Nn,u_r:()=>Xn,RlV:()=>sn,gVA:()=>dl,M_G:()=>Nr,BpG:()=>Kl,GRB:()=>cm,kM6:()=>ju,dO8:()=>Zu,jgM:()=>il,FWq:()=>Ur,s3j:()=>Dg,hlw:()=>af,L0q:()=>of,B7e:()=>rf,PGN:()=>nf,H_X:()=>ie,S_d:()=>ff,_Tq:()=>uf,U7E:()=>cf,IOH:()=>lf,Z58:()=>ui,yh2:()=>Nm,ff$:()=>sl,cWi:()=>Iu,NBt:()=>oc,oNz:()=>vm,QlU:()=>qf,Xey:()=>Bs,jft:()=>bv,_r8:()=>fe,bTC:()=>qu,Mtr:()=>si,ypk:()=>Ne,mnM:()=>Ut,q7S:()=>mv,bAZ:()=>Er,ABN:()=>Vu,VK6:()=>bm,Hj2:()=>dc,Df8:()=>ul,oOx:()=>Hn,kxk:()=>Ri,DT1:()=>ia,FLG:()=>nn,qN_:()=>mc,Z37:()=>aa,FtL:()=>Tf,Z6X:()=>a_,iQT:()=>_i,ziO:()=>Uf,OEF:()=>Ki,uuE:()=>li,tiv:()=>Rr,T$Y:()=>t_,EYj:()=>Or,nOB:()=>No,Tap:()=>ee,FAs:()=>Pf,B_P:()=>Cf,aA5:()=>km,J3s:()=>yc,Y0Q:()=>zr,M4G:()=>on,l$l:()=>e_,dLy:()=>ms,WZP:()=>st,eB6:()=>ma,nFK:()=>rl,l9z:()=>Ff,YOF:()=>Um,yhB:()=>we,J0N:()=>yl,Miz:()=>k,Bj4:()=>Jh,Rcs:()=>Qi,vJ4:()=>bs,TqC:()=>ic,nM0:()=>Wl,X1u:()=>rn,SpZ:()=>Nu,DX8:()=>Un,Yx$:()=>Xf,HK4:()=>zf,yt5:()=>Su,vAR:()=>Zm,SE$:()=>_s,qE8:()=>bt,Pz7:()=>l_,sX_:()=>dn,JuI:()=>Cg,pxT:()=>gs,Nl$:()=>Tl,zDr:()=>av,OwT:()=>iv,P$G:()=>ov,mHV:()=>nv,kEA:()=>hv,Fx_:()=>cv,WFC:()=>lv,vKu:()=>tv,aDq:()=>Jm,jIg:()=>rv,UH3:()=>sv,AJO:()=>ev,U4:()=>$u,xAc:()=>Ku,_3Y:()=>Mm,K6X:()=>lm,C1Y:()=>Ou,Aw1:()=>nl,tm8:()=>Ju,LBV:()=>ef,A8$:()=>dm,F5e:()=>Dm,ran:()=>Rm,c8L:()=>df,o6M:()=>hf,hsx:()=>Vi,l9E:()=>Af,aSf:()=>Lf,CcK:()=>Qu,nU8:()=>rc,td6:()=>Gr,Zex:()=>c_,bkJ:()=>zt,mXP:()=>wv,vt$:()=>Vn,hCA:()=>Mi,pjR:()=>pt,U43:()=>Xi,pSZ:()=>Sg,y17:()=>Tg,Ew7:()=>$i,hG1:()=>Im,jVr:()=>vv,_SZ:()=>Nt,xWn:()=>Eu,ehJ:()=>Pg,t6s:()=>G,Eyn:()=>wl});var wl={};Ee.r(wl);Ee.d(wl,{getAttributeComponentSize:()=>Uu,getAttributePointerType:()=>zu,getGLTypeFromSource:()=>Lu,getGlTypeSizeBytes:()=>Kh,getMaxShaderComplexity:()=>Pl,isAttributeInSource:()=>ku});var xl={};Ee.r(xl);Ee.d(xl,{circle:()=>am,line:()=>tl,point:()=>rm,roundRect:()=>el,vector:()=>om});var bl={};Ee.r(bl);Ee.d(bl,{ActionCompleteEvent:()=>Ql,ActionStartEvent:()=>Zl,ActivateEvent:()=>Gl,AddEvent:()=>$l,CollisionEndEvent:()=>Pr,CollisionPostSolveEvent:()=>Qo,CollisionPreSolveEvent:()=>Zo,CollisionStartEvent:()=>Cr,ContactEndEvent:()=>jo,ContactStartEvent:()=>Yo,DeactivateEvent:()=>Vl,EnterTriggerEvent:()=>Yl,EnterViewPortEvent:()=>ql,EventTypes:()=>qo,ExitTriggerEvent:()=>jl,ExitViewPortEvent:()=>Xl,GameEvent:()=>vt,GameStartEvent:()=>Il,GameStopEvent:()=>Rl,GamepadAxisEvent:()=>Ol,GamepadButtonEvent:()=>Hl,GamepadConnectEvent:()=>Ul,GamepadDisconnectEvent:()=>zl,HiddenEvent:()=>Nl,InitializeEvent:()=>jn,KillEvent:()=>na,PostCollisionEvent:()=>pn,PostDebugDrawEvent:()=>Bl,PostDrawEvent:()=>Yn,PostFrameEvent:()=>Ll,PostKillEvent:()=>El,PostTransformDrawEvent:()=>Ml,PostUpdateEvent:()=>zs,PreCollisionEvent:()=>_n,PreDebugDrawEvent:()=>Fl,PreDrawEvent:()=>qn,PreFrameEvent:()=>kl,PreKillEvent:()=>Sl,PreTransformDrawEvent:()=>Dl,PreUpdateEvent:()=>Us,RemoveEvent:()=>Kl,VisibleEvent:()=>Wl});var yl={};Ee.r(yl);Ee.d(yl,{ConsoleAppender:()=>Al,DrawUtil:()=>xl,EasingFunctions:()=>Wt,LogLevel:()=>me,Logger:()=>ct,Observable:()=>Ze,ScreenAppender:()=>Iu,addItemToArray:()=>Eg,contains:()=>Ru,delay:()=>Ho,fail:()=>Du,getPosition:()=>xr,isObject:()=>Uo,mergeDeep:()=>Oo,omit:()=>Mu,removeItemFromArray:()=>Gn});function Tu(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(d){window.setInterval(d,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const t=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(i){return new Promise((n,o)=>{t.call(this,i,n,o)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(d){const t=Date.now();return setTimeout(function(){d({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(d){clearTimeout(d)})}class Fe{static useCanvasGraphicsContext(){Fe.enable("use-canvas-context")}static useLegacyImageRenderer(){Fe.enable("use-legacy-image-renderer")}static freeze(){Fe._FROZEN=!0}static _reset(){Fe._FROZEN=!1,Fe._FLAGS={}}static enable(t){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");Fe._FLAGS[t]=!0}static disable(t){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");Fe._FLAGS[t]=!1}static isEnabled(t){return!!Fe._FLAGS[t]}static show(){return Object.keys(Fe._FLAGS)}}Fe._FROZEN=!1;Fe._FLAGS={};function dn(d,t){return{type:d,value:t}}class fi{constructor(){this._isCompleted=!1,this.promise=new Promise((t,i)=>{this._resolver=t,this._rejecter=i})}get isCompleted(){return this._isCompleted}resolve(t){this._isCompleted||(this._isCompleted=!0,this._resolver(t))}reject(t){this._isCompleted||(this._isCompleted=!0,this._rejecter(t))}}class Qt{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(t,i){var n;return this._empty=!1,this._listeners[t]=(n=this._listeners[t])!==null&&n!==void 0?n:[],this._listeners[t].push(i),{close:()=>this.off(t,i)}}once(t,i){var n;return this._empty=!1,this._listenersOnce[t]=(n=this._listenersOnce[t])!==null&&n!==void 0?n:[],this._listenersOnce[t].push(i),{close:()=>this.off(t,i)}}off(t,i){var n,o;if(i){const h=(n=this._listeners[t])===null||n===void 0?void 0:n.filter(_=>_!==i);this._listeners[t]=h;const c=(o=this._listenersOnce[t])===null||o===void 0?void 0:o.filter(_=>_!==i);this._listenersOnce[t]=c}else delete this._listeners[t]}emit(t,i){if(this._empty||this._paused)return;const n=this._listeners[t];if(n)for(let h=0;h<n.length;h++)n[h](i);const o=this._listenersOnce[t];if(this._listenersOnce[t]=[],o)for(let h=0;h<o.length;h++)o[h](i);for(let h=0;h<this._pipes.length;h++)this._pipes[h].emit(t,i)}pipe(t){if(this===t)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(t),{close:()=>{const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}}}unpipe(t){const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var un;(function(d){d.Canvas="Canvas",d.Document="Document"})(un||(un={}));var ie;(function(d){d.ShortestPath="shortest-path",d.LongestPath="longest-path",d.Clockwise="clockwise",d.CounterClockwise="counter-clockwise"})(ie||(ie={}));const Wh=4294967295;class Nn{constructor(t){this.seed=t,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(t||Date.now())>>>0;for(let i=1;i<this._n;i++){const n=this._mt[i-1]^this._mt[i-1]>>>this._w-2;this._mt[i]=(this._f*((n&4294901760)>>>16)<<16)+this._f*(n&65535)+i>>>0}this._index=this._n}_twist(){const t=[0,this._a];let i=0,n=0;for(;n<this._n-this._m;n++)i=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+this._m]^i>>>1^t[i&1]&Wh;for(;n<this._n-1;n++)i=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+(this._m-this._n)]^i>>>1^t[i&1]&Wh;i=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^i>>>1^t[i&1]&Wh,this._index=0}nextInt(){this._index>=this._n&&this._twist();let t=this._mt[this._index++];return t^=t>>>this._u,t^=t<<this._s&this._b,t^=t<<this._t&this._c,t^=t>>>this._l,t>>>0}next(){return this.nextInt()*(1/4294967296)}floating(t,i){return(i-t)*this.next()+t}integer(t,i){return Math.floor((i-t+1)*this.next()+t)}bool(t=.5){return this.next()<=t}pickOne(t){return t[this.integer(0,t.length-1)]}pickSet(t,i,n=!1){return n?this._pickSetWithDuplicates(t,i):this._pickSetWithoutDuplicates(t,i)}_pickSetWithoutDuplicates(t,i){if(i>t.length||i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(i===t.length)return t;const n=new Array(i);let o=0;const h=t.slice(0);for(;o<i;){const c=this.integer(0,h.length-1);n[o++]=h[c],h.splice(c,1)}return n}_pickSetWithDuplicates(t,i){if(i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const n=new Array(i);for(let o=0;o<i;o++)n[o]=this.pickOne(t);return n}shuffle(t){const i=t.slice(0);let n;for(let o=0;o<i.length-2;o++){const h=this.integer(o,i.length-1);n=i[o],i[o]=i[h],i[h]=n}return i}range(t,i,n){const o=new Array(t);for(let h=0;h<t;h++)o[h]=this.integer(i,n);return o}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const we=Math.PI*2;function Cg(d){return d>=0?d-Math.floor(d):d-Math.ceil(d)}function Nt(d){return d===0?0:d<0?-1:1}function bt(d,t,i){return Math.min(Math.max(t,d),i)}function Su(d,t,i){return Math.abs(d-t)<i}function _s(d){let t=d;if(d>=we)for(;t>=we;)t-=we;if(d<0)for(;t<0;)t+=we;return t}function Eu(d){return 180/Math.PI*d}function Pg(d){return d/180*Math.PI}const Tg=(d,t)=>Array.from(new Array(t-d+1),(i,n)=>n+d);function Xi(d,t,i=new Nn){return i?i.floating(d,t):d+Math.random()*(t-d)}function Sg(d,t,i=new Nn){return i?i.integer(d,t):Math.round(Xi(d,t))}class k{static get Zero(){return new k(0,0)}static get One(){return new k(1,1)}static get Half(){return new k(.5,.5)}static get Up(){return new k(0,-1)}static get Down(){return new k(0,1)}static get Left(){return new k(-1,0)}static get Right(){return new k(1,0)}static fromAngle(t){return new k(Math.cos(t),Math.sin(t))}static isValid(t){return!(t==null||isNaN(t.x)||isNaN(t.y)||t.x===1/0||t.y===1/0||t.x===-1/0||t.y===-1/0)}static distance(t,i){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))}static min(t,i){return new k(Math.min(t.x,i.x),Math.min(t.y,i.y))}static max(t,i){return new k(Math.max(t.x,i.x),Math.max(t.y,i.y))}constructor(t,i){this._x=0,this._y=0,this._x=t,this._y=i}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}setTo(t,i){this.x=t,this.y=i}equals(t,i=k.EQUALS_EPSILON){return Math.abs(this.x-t.x)<=i&&Math.abs(this.y-t.y)<=i}distance(t){if(!t)return Math.sqrt(this.x*this.x+this.y*this.y);const i=this.x-t.x,n=this.y-t.y;return Math.sqrt(i*i+n*n)}squareDistance(t){t||(t=k.Zero);const i=this.x-t.x,n=this.y-t.y;return i*i+n*n}clampMagnitude(t){const i=this.magnitude,n=bt(i,0,t);return this.magnitude=n,this}get size(){return this.distance()}set size(t){const i=this.normalize().scale(t);this.setTo(i.x,i.y)}get magnitude(){return this.distance()}set magnitude(t){this.normalize().scale(t,this)}normalize(){const t=this.distance();return t===0?k.Zero:new k(this.x/t,this.y/t)}average(t){return this.add(t).scale(.5)}scale(t,i){const n=i||new k(0,0);return t instanceof k?(n.x=this.x*t.x,n.y=this.y*t.y):(n.x=this.x*t,n.y=this.y*t),n}add(t,i){return i?(i.x=this.x+t.x,i.y=this.y+t.y,i):new k(this.x+t.x,this.y+t.y)}sub(t,i){const n=i||new k(0,0),o=this.x-t.x,h=this.y-t.y;return n.x=o,n.y=h,n}addEqual(t){return this.setTo(this.x+t.x,this.y+t.y),this}subEqual(t){return this.setTo(this.x-t.x,this.y-t.y),this}scaleEqual(t){return this.setTo(this.x*t,this.y*t),this}dot(t){return this.x*t.x+this.y*t.y}cross(t){if(t instanceof k)return this.x*t.y-this.y*t.x;if(typeof t=="number")return new k(t*this.y,-t*this.x)}static cross(t,i){return new k(-t*i.y,t*i.x)}perpendicular(){return new k(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return _s(Math.atan2(this.y,this.x))}angleBetween(t,i){const n=this.toAngle(),o=_s(t);let h=0,c=0;switch(o>n?h=o-n:h=(we-n+o)%we,c=(h-we)%we,i){case ie.ShortestPath:return Math.abs(h)<Math.abs(c)?h:c;case ie.LongestPath:return Math.abs(h)>Math.abs(c)?h:c;case ie.Clockwise:return h;case ie.CounterClockwise:return c}}rotate(t,i,n){const o=n||new k(0,0);i||(i=new k(0,0));const h=Math.sin(t),c=Math.cos(t),_=c*(this.x-i.x)-h*(this.y-i.y)+i.x,g=h*(this.x-i.x)+c*(this.y-i.y)+i.y;return o.x=_,o.y=g,o}clone(t){const i=t??new k(0,0);return i.x=this.x,i.y=this.y,i}toString(t){return t?`(${this.x.toFixed(t)}, ${this.y.toFixed(t)})`:`(${this.x}, ${this.y})`}}k.EQUALS_EPSILON=.001;function G(d,t){return new k(d,t)}class K{constructor(t,i,n,o){this.r=t,this.g=i,this.b=n,this.a=o??1}static fromRGB(t,i,n,o){return new K(t,i,n,o)}static fromRGBString(t){const i=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let n=null;if(n=t.match(i)){const o=parseInt(n[1],10),h=parseInt(n[2],10),c=parseInt(n[3],10);let _=1;return n[4]&&(_=parseFloat(n[4])),new K(o,h,c,_)}else throw new Error("Invalid rgb/a string: "+t)}static fromHex(t){const i=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let n=null;if(n=t.match(i)){const o=parseInt(n[1],16),h=parseInt(n[2],16),c=parseInt(n[3],16);let _=1;return n[4]&&(_=parseInt(n[4],16)/255),new K(o,h,c,_)}else throw new Error("Invalid hex string: "+t)}static fromHSL(t,i,n,o=1){return new Si(t,i,n,o).toRGBA()}lighten(t=.1){const i=Si.fromRGBA(this.r,this.g,this.b,this.a);return i.l+=(1-i.l)*t,i.toRGBA()}darken(t=.1){const i=Si.fromRGBA(this.r,this.g,this.b,this.a);return i.l-=i.l*t,i.toRGBA()}saturate(t=.1){const i=Si.fromRGBA(this.r,this.g,this.b,this.a);return i.s+=i.s*t,i.toRGBA()}desaturate(t=.1){const i=Si.fromRGBA(this.r,this.g,this.b,this.a);return i.s-=i.s*t,i.toRGBA()}multiply(t){const i=t.r/255*this.r/255*255,n=t.g/255*this.g/255*255,o=t.b/255*this.b/255*255,h=t.a*this.a;return new K(i,n,o,h)}screen(t){const i=t.invert(),n=t.invert();return i.multiply(n).invert()}invert(){return new K(255-this.r,255-this.g,255-this.b,1-this.a)}average(t){const i=(t.r+this.r)/2,n=(t.g+this.g)/2,o=(t.b+this.b)/2,h=(t.a+this.a)/2;return new K(i,n,o,h)}equal(t){return this.toString()===t.toString()}toString(t="rgb"){switch(t){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(t){const i=Math.max(Math.round(t),0).toString(16);return i.length===1?"0"+i:i}toHex(){let t="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(t+=this._componentToHex(this.a*255)),t}toRGBA(){const t=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+t+", "+String(this.a)+")":"rgb("+t+")"}toHSLA(){return Si.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(t){const i=t||new K(this.r,this.g,this.b,this.a);return i.r=this.r,i.g=this.g,i.b=this.b,i.a=this.a,i}static get Black(){return K.fromHex("#000000")}static get White(){return K.fromHex("#FFFFFF")}static get Gray(){return K.fromHex("#808080")}static get LightGray(){return K.fromHex("#D3D3D3")}static get DarkGray(){return K.fromHex("#A9A9A9")}static get Yellow(){return K.fromHex("#FFFF00")}static get Orange(){return K.fromHex("#FFA500")}static get Red(){return K.fromHex("#FF0000")}static get Vermilion(){return K.fromHex("#FF5B31")}static get Rose(){return K.fromHex("#FF007F")}static get Pink(){return K.fromHex("#FFC0CB")}static get Magenta(){return K.fromHex("#FF00FF")}static get Violet(){return K.fromHex("#7F00FF")}static get Purple(){return K.fromHex("#800080")}static get Blue(){return K.fromHex("#0000FF")}static get Azure(){return K.fromHex("#007FFF")}static get Cyan(){return K.fromHex("#00FFFF")}static get Viridian(){return K.fromHex("#59978F")}static get Teal(){return K.fromHex("#008080")}static get Green(){return K.fromHex("#00FF00")}static get Chartreuse(){return K.fromHex("#7FFF00")}static get Transparent(){return K.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return K.fromHex("#176BAA")}static get Brown(){return K.fromHex("#964B00")}}class Si{constructor(t,i,n,o){this.h=t,this.s=i,this.l=n,this.a=o}static hue2rgb(t,i,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+(i-t)*6*n:n<1/2?i:n<2/3?t+(i-t)*(2/3-n)*6:t}static fromRGBA(t,i,n,o){t/=255,i/=255,n/=255;const h=Math.max(t,i,n),c=Math.min(t,i,n);let _,g;const v=(h+c)/2;if(h===c)_=g=0;else{const x=h-c;switch(g=v>.5?x/(2-h-c):x/(h+c),h){case t:_=(i-n)/x+(i<n?6:0);break;case i:_=(n-t)/x+2;break;case n:_=(t-i)/x+4;break}_/=6}return new Si(_,g,v,o)}toRGBA(){let t,i,n;if(this.s===0)t=i=n=this.l;else{const o=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,h=2*this.l-o;t=Si.hue2rgb(h,o,this.h+1/3),i=Si.hue2rgb(h,o,this.h),n=Si.hue2rgb(h,o,this.h-1/3)}return new K(t*255,i*255,n*255,this.a)}toString(){const t=this.h.toFixed(0),i=this.s.toFixed(0),n=this.l.toFixed(0),o=this.a.toFixed(0);return`hsla(${t}, ${i}, ${n}, ${o})`}}var me;(function(d){d[d.Debug=0]="Debug",d[d.Info=1]="Info",d[d.Warn=2]="Warn",d[d.Error=3]="Error",d[d.Fatal=4]="Fatal"})(me||(me={}));class ct{constructor(){if(this._appenders=[],this.defaultLevel=me.Info,this._logOnceSet=new Set,ct._INSTANCE)throw new Error("Logger is a singleton");return ct._INSTANCE=this,ct._INSTANCE.addAppender(new Al),ct._INSTANCE}static getInstance(){return ct._INSTANCE==null&&(ct._INSTANCE=new ct),ct._INSTANCE}addAppender(t){this._appenders.push(t)}clearAppenders(){this._appenders.length=0}_log(t,i){t==null&&(t=this.defaultLevel);const n=this._appenders.length;for(let o=0;o<n;o++)t>=this.defaultLevel&&this._appenders[o].log(t,i)}_logOnce(t,i){const n=t+i.join("+");this._logOnceSet.has(n)||(this._logOnceSet.add(n),this._log(t,i))}debug(...t){this._log(me.Debug,t)}debugOnce(...t){this._logOnce(me.Debug,t)}info(...t){this._log(me.Info,t)}infoOnce(...t){this._logOnce(me.Info,t)}warn(...t){this._log(me.Warn,t)}warnOnce(...t){this._logOnce(me.Warn,t)}error(...t){this._log(me.Error,t)}errorOnce(...t){this._logOnce(me.Error,t)}fatal(...t){this._log(me.Fatal,t)}fatalOnce(...t){this._logOnce(me.Fatal,t)}}ct._INSTANCE=null;class Al{log(t,i){if(!console&&!console.log&&console.warn&&console.error)return;const n=[];n.unshift.apply(n,i),n.unshift("["+me[t]+"] : "),t<me.Warn?console.log.apply?console.log.apply(console,n):console.log(n.join(" ")):t<me.Error?console.warn.apply?console.warn.apply(console,n):console.warn(n.join(" ")):console.error.apply?console.error.apply(console,n):console.error(n.join(" "))}}class Iu{constructor(t){var i,n;this._messages=[],this._pos=10,this._color=K.Black,this._options=t,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(n=(i=t.zIndex)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),t.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var t,i,n,o;const h=this._options;this.canvas.width=(t=h.width)!==null&&t!==void 0?t:h.engine.screen.resolution.width,this.canvas.height=(i=h.height)!==null&&i!==void 0?i:h.engine.screen.resolution.height,this.canvas.style.position="absolute";const c=h.engine.screen.screenToPageCoordinates(G(0,0));this.canvas.style.left=c.x+"px",this.canvas.style.top=c.y+"px",this._pos=(n=h.xPos)!==null&&n!==void 0?n:this._pos,this._color=(o=h.color)!==null&&o!==void 0?o:this._color}log(t,i){const n=i.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+me[t]+"] : "+n);let o=10;this._messages=this._messages.slice(0,1e3);for(let h=0;h<this._messages.length;h++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[h],this._pos,o),o+=10}}var Ut;(function(d){d.None="None",d.Top="Top",d.Bottom="Bottom",d.Left="Left",d.Right="Right"})(Ut||(Ut={}));(function(d){function t(n){return n===d.Top?d.Bottom:n===d.Bottom?d.Top:n===d.Left?d.Right:n===d.Right?d.Left:d.None}d.getOpposite=t;function i(n){return Math.abs(n.x)>=Math.abs(n.y)?n.x<=0?d.Left:d.Right:n.y<=0?d.Top:d.Bottom}d.fromDirection=i})(Ut||(Ut={}));class lt{constructor(t=0,i=0,n=0,o=0){this._points=[],typeof t=="object"?(this.left=t.left,this.top=t.top,this.right=t.right,this.bottom=t.bottom):typeof t=="number"&&(this.left=t,this.top=i,this.right=n,this.bottom=o)}clone(t){const i=t||new lt(0,0,0,0);return i.left=this.left,i.right=this.right,i.top=this.top,i.bottom=this.bottom,i}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(t){return t&&t?Math.abs(t.x)>Math.abs(t.y)?t.x<0?Ut.Right:Ut.Left:t.y<0?Ut.Bottom:Ut.Top:Ut.None}static fromPoints(t){let i=1/0,n=1/0,o=-1/0,h=-1/0;for(let c=0;c<t.length;c++)t[c].x<i&&(i=t[c].x),t[c].x>o&&(o=t[c].x),t[c].y<n&&(n=t[c].y),t[c].y>h&&(h=t[c].y);return new lt(i,n,o,h)}static fromDimension(t,i,n=k.Half,o=k.Zero){return new lt(-t*n.x+o.x,-i*n.y+o.y,t-t*n.x+o.x,i-i*n.y+o.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new k((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new k(this.left,this.top)}get bottomRight(){return new k(this.right,this.bottom)}get topRight(){return new k(this.right,this.top)}get bottomLeft(){return new k(this.left,this.bottom)}translate(t){return new lt(this.left+t.x,this.top+t.y,this.right+t.x,this.bottom+t.y)}rotate(t,i=k.Zero){const n=this.getPoints().map(o=>o.rotate(t,i));return lt.fromPoints(n)}scale(t,i=k.Zero){const n=this.translate(i);return new lt(n.left*t.x,n.top*t.y,n.right*t.x,n.bottom*t.y)}transform(t){const i=t.data[0]*this.left,n=t.data[1]*this.left,o=t.data[0]*this.right,h=t.data[1]*this.right,c=t.data[2]*this.top,_=t.data[3]*this.top,g=t.data[2]*this.bottom,v=t.data[3]*this.bottom,x=t.getPosition(),b=Math.min(i,o)+Math.min(c,g)+x.x,P=Math.min(n,h)+Math.min(_,v)+x.y,T=Math.max(i,o)+Math.max(c,g)+x.x,I=Math.max(n,h)+Math.max(_,v)+x.y;return new lt({left:b,top:P,right:T,bottom:I})}getPerimeter(){const t=this.width,i=this.height;return 2*(t+i)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new k(this.left,this.top)),this._points.push(new k(this.right,this.top)),this._points.push(new k(this.right,this.bottom)),this._points.push(new k(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(t,i=1/0){let n=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,c=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,_=(this.left-t.pos.x)*h,g=(this.right-t.pos.x)*h;n=Math.min(_,g),o=Math.max(_,g);const v=(this.top-t.pos.y)*c,x=(this.bottom-t.pos.y)*c;return n=Math.max(n,Math.min(v,x)),o=Math.min(o,Math.max(v,x)),o>=Math.max(0,n)&&n<i}rayCastTime(t,i=1/0){let n=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,c=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,_=(this.left-t.pos.x)*h,g=(this.right-t.pos.x)*h;n=Math.min(_,g),o=Math.max(_,g);const v=(this.top-t.pos.y)*c,x=(this.bottom-t.pos.y)*c;return n=Math.max(n,Math.min(v,x)),o=Math.min(o,Math.max(v,x)),o>=Math.max(0,n)&&n<i?n:-1}contains(t){return t instanceof k?this.left<=t.x&&this.top<=t.y&&t.y<=this.bottom&&t.x<=this.right:t instanceof lt?this.left<=t.left&&this.top<=t.top&&t.bottom<=this.bottom&&t.right<=this.right:!1}combine(t,i){const n=i||new lt(0,0,0,0),o=Math.min(this.left,t.left),h=Math.min(this.top,t.top),c=Math.max(this.right,t.right),_=Math.max(this.bottom,t.bottom);return n.left=o,n.top=h,n.right=c,n.bottom=_,n}get dimensions(){return new k(this.width,this.height)}overlaps(t,i){const n=i||0;if(t.hasZeroDimensions())return this.contains(t);if(this.hasZeroDimensions())return t.contains(this);const o=this.combine(t);return o.width+n<t.width+this.width&&o.height+n<t.height+this.height}intersect(t){const i=this.combine(t);if(i.width<t.width+this.width&&i.height<t.height+this.height&&!i.dimensions.equals(t.dimensions)&&!i.dimensions.equals(this.dimensions)){let n=0;this.right>=t.left&&this.right<=t.right?n=t.left-this.right:n=t.right-this.left;let o=0;return this.top<=t.bottom&&this.top>=t.top?o=t.bottom-this.top:o=t.top-this.bottom,Math.abs(n)<Math.abs(o)?new k(n,0):new k(0,o)}else if(i.dimensions.equals(t.dimensions)||i.dimensions.equals(this.dimensions)){let n=0;this.width-t.width>=0?this.right-t.right<=t.left-this.left?n=t.left-this.right:n=t.right-this.left:t.right-this.right<=this.left-t.left?n=this.left-t.right:n=this.right-t.left;let o=0;return this.height-t.height>=0?this.bottom-t.bottom<=t.top-this.top?o=t.top-this.bottom:o=t.bottom-this.top:t.bottom-this.bottom<=this.top-t.top?o=this.top-t.bottom:o=this.bottom-t.top,Math.abs(n)<Math.abs(o)?new k(n,0):new k(0,o)}else return null}intersectWithSide(t){const i=this.intersect(t);return lt.getSideFromIntersection(i)}draw(t,i=K.Yellow){t.debug.drawRect(this.left,this.top,this.width,this.height,{color:i})}}function xr(d){if(d&&d.getBoundingClientRect){const t=d.getBoundingClientRect();return G(t.x+window.scrollX,t.y+window.scrollY)}return k.Zero}function Eg(d,t){return t.indexOf(d)===-1?(t.push(d),!0):!1}function Gn(d,t){let i=-1;return(i=t.indexOf(d))>-1?(t.splice(i,1),!0):!1}function Ru(d,t){for(let i=0;i<d.length;i++)if(d[i]===t)return!0;return!1}function Du(d){throw new Error(d)}function Ho(d,t){var i;const n=new fi;return((i=t?.schedule.bind(t))!==null&&i!==void 0?i:setTimeout)(()=>{n.resolve()},d),n.promise}function Mu(d,t){const i={};for(const n in d)t.includes(n)||(i[n]=d[n]);return i}function Uo(d){return d&&typeof d=="object"&&!Array.isArray(d)}function Oo(d,...t){if(!t.length)return d;const i=t.shift();if(Uo(d)&&Uo(i))for(const n in i)Uo(i[n])?(d[n]||Object.assign(d,{[n]:{}}),Oo(d[n],i[n])):Object.assign(d,{[n]:i[n]});return Oo(d,...t)}var $h;(function(d){d[d.X=12]="X",d[d.Y=13]="Y"})($h||($h={}));class ai{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(t,i,n,o,h,c){const _=new ai;return _.data[0]=2/(i-t),_.data[1]=0,_.data[2]=0,_.data[3]=0,_.data[4]=0,_.data[5]=2/(o-n),_.data[6]=0,_.data[7]=0,_.data[8]=0,_.data[9]=0,_.data[10]=-2/(c-h),_.data[11]=0,_.data[12]=-(i+t)/(i-t),_.data[13]=-(o+n)/(o-n),_.data[14]=-(c+h)/(c-h),_.data[15]=1,_}clone(t){const i=t||new ai;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i.data[6]=this.data[6],i.data[7]=this.data[7],i.data[8]=this.data[8],i.data[9]=this.data[9],i.data[10]=this.data[10],i.data[11]=this.data[11],i.data[12]=this.data[12],i.data[13]=this.data[13],i.data[14]=this.data[14],i.data[15]=this.data[15],i}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(t){const i=new ai;return i.data=t,i}static identity(){const t=new ai;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}static translation(t,i){const n=ai.identity();return n.data[12]=t,n.data[13]=i,n}static scale(t,i){const n=ai.identity();return n.data[0]=t,n.data[5]=i,n.data[10]=1,n.data[15]=1,n}static rotation(t){const i=ai.identity();return i.data[0]=Math.cos(t),i.data[4]=-Math.sin(t),i.data[1]=Math.sin(t),i.data[5]=Math.cos(t),i}multiply(t,i){if(t instanceof k){const n=i||new k(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[4]+this.data[12],c=o.x*this.data[1]+o.y*this.data[5]+this.data[13];return n.x=h,n.y=c,n}else{const n=i||new ai,o=t,h=this.data[0],c=this.data[1],_=this.data[2],g=this.data[3],v=this.data[4],x=this.data[5],b=this.data[6],P=this.data[7],T=this.data[8],I=this.data[9],F=this.data[10],R=this.data[11],S=this.data[12],M=this.data[13],W=this.data[14],U=this.data[15],V=o.data[0],j=o.data[1],X=o.data[2],nt=o.data[3],ht=o.data[4],wt=o.data[5],gt=o.data[6],At=o.data[7],Et=o.data[8],B=o.data[9],z=o.data[10],Q=o.data[11],tt=o.data[12],Ht=o.data[13],ot=o.data[14],vi=o.data[15];n.data[0]=h*V+v*j+T*X+S*nt,n.data[1]=c*V+x*j+I*X+M*nt,n.data[2]=_*V+b*j+F*X+W*nt,n.data[3]=g*V+P*j+R*X+U*nt,n.data[4]=h*ht+v*wt+T*gt+S*At,n.data[5]=c*ht+x*wt+I*gt+M*At,n.data[6]=_*ht+b*wt+F*gt+W*At,n.data[7]=g*ht+P*wt+R*gt+U*At,n.data[8]=h*Et+v*B+T*z+S*Q,n.data[9]=c*Et+x*B+I*z+M*Q,n.data[10]=_*Et+b*B+F*z+W*Q,n.data[11]=g*Et+P*B+R*z+U*Q,n.data[12]=h*tt+v*Ht+T*ot+S*vi,n.data[13]=c*tt+x*Ht+I*ot+M*vi,n.data[14]=_*tt+b*Ht+F*ot+W*vi,n.data[15]=g*tt+P*Ht+R*ot+U*vi;const Ji=this.getScale();return n._scaleSignX=Nt(Ji.x)*Nt(n._scaleSignX),n._scaleSignY=Nt(Ji.y)*Nt(n._scaleSignY),n}}translate(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],_=this.data[4],g=this.data[5],v=this.data[6],x=this.data[7],b=this.data[8],P=this.data[9],T=this.data[10],I=this.data[11],F=this.data[12],R=this.data[13],S=this.data[14],M=this.data[15],W=0,U=1;return this.data[12]=n*t+_*i+b*W+F*U,this.data[13]=o*t+g*i+P*W+R*U,this.data[14]=h*t+v*i+T*W+S*U,this.data[15]=c*t+x*i+I*W+M*U,this}setPosition(t,i){this.data[12]=t,this.data[13]=i}getPosition(){return G(this.data[12],this.data[13])}rotate(t){const i=this.data[0],n=this.data[1],o=this.data[2],h=this.data[3],c=this.data[4],_=this.data[5],g=this.data[6],v=this.data[7],x=Math.sin(t),b=Math.cos(t);return this.data[0]=b*i+x*c,this.data[1]=b*n+x*_,this.data[2]=b*o+x*g,this.data[3]=b*h+x*v,this.data[4]=b*c-x*i,this.data[5]=b*_-x*n,this.data[6]=b*g-x*o,this.data[7]=b*v-x*h,this}scale(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],_=this.data[4],g=this.data[5],v=this.data[6],x=this.data[7];return this.data[0]=n*t,this.data[1]=o*t,this.data[2]=h*t,this.data[3]=c*t,this.data[4]=_*i,this.data[5]=g*i,this.data[6]=v*i,this.data[7]=x*i,this}setRotation(t){const i=this.getScale(),n=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=n*i.y,this.data[4]=-n*i.x,this.data[5]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return _s(t)}getScaleX(){const t=G(this.data[0],this.data[4]).magnitude;return this._scaleSignX*t}getScaleY(){const t=G(this.data[1],this.data[5]).magnitude;return this._scaleSignY*t}getScale(){return G(this.getScaleX(),this.getScaleY())}setScaleX(t){if(this._scaleX===t)return;this._scaleSignX=Nt(t);const i=G(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[4]=i.y*t,this._scaleX=t}setScaleY(t){if(this._scaleY===t)return;this._scaleSignY=Nt(t);const i=G(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[5]=i.y*t,this._scaleY=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(t){const n=1/this.getBasisDeterminant(),o=this.data[0],h=this.data[4],c=this.data[1],_=this.data[5],g=t||ai.identity();g.data[0]=_*n,g.data[1]=-c*n,g.data[4]=-h*n,g.data[5]=o*n;const v=this.data[12],x=this.data[13];return g.data[12]=-(v*g.data[0]+x*g.data[4]),g.data[13]=-(v*g.data[1]+x*g.data[5]),g}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class _e{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const t=new _e;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}static translation(t,i){const n=_e.identity();return n.data[4]=t,n.data[5]=i,n}static scale(t,i){const n=_e.identity();return n.data[0]=t,n.data[3]=i,n._scale[0]=t,n._scale[1]=i,n}static rotation(t){const i=_e.identity();return i.data[0]=Math.cos(t),i.data[1]=Math.sin(t),i.data[2]=-Math.sin(t),i.data[3]=Math.cos(t),i}setPosition(t,i){this.data[4]=t,this.data[5]=i}getPosition(){return G(this.data[4],this.data[5])}rotate(t){const i=this.data[0],n=this.data[1],o=this.data[2],h=this.data[3],c=Math.sin(t),_=Math.cos(t);return this.data[0]=_*i+c*o,this.data[1]=_*n+c*h,this.data[2]=_*o-c*i,this.data[3]=_*h-c*n,this}translate(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],_=this.data[4],g=this.data[5];return this.data[4]=n*t+h*i+_,this.data[5]=o*t+c*i+g,this}scale(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3];return this.data[0]=n*t,this.data[1]=o*t,this.data[2]=h*i,this.data[3]=c*i,this._scale[0]=t,this._scale[1]=i,this._scaleSignX=Nt(t),this._scaleSignY=Nt(i),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(t){const i=this.determinant();let n=i;i!==0&&(n=1/i);const o=this.data[0],h=this.data[2],c=this.data[1],_=this.data[3],g=t||_e.identity();g.data[0]=_*n,g.data[1]=-c*n,g.data[2]=-h*n,g.data[3]=o*n;const v=this.data[4],x=this.data[5];return g.data[4]=-(v*g.data[0]+x*g.data[2]),g.data[5]=-(v*g.data[1]+x*g.data[3]),g}multiply(t,i){if(t instanceof k){const n=i||new k(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[2]+this.data[4],c=o.x*this.data[1]+o.y*this.data[3]+this.data[5];return n.x=h,n.y=c,n}else{const n=i||new _e,o=t,h=this.data[0],c=this.data[1],_=this.data[2],g=this.data[3],v=this.data[4],x=this.data[5],b=o.data[0],P=o.data[1],T=o.data[2],I=o.data[3],F=o.data[4],R=o.data[5];n.data[0]=h*b+_*P,n.data[1]=c*b+g*P,n.data[2]=h*T+_*I,n.data[3]=c*T+g*I,n.data[4]=h*F+_*R+v,n.data[5]=c*F+g*R+x;const S=this._scaleSignX,M=this._scaleSignY;return n._scaleSignX=S*Nt(n._scaleSignX),n._scaleSignY=M*Nt(n._scaleSignY),n}}multiplyQuadInPlace(t){const i=t[0]*this.data[0]+t[1]*this.data[2]+this.data[4],n=t[0]*this.data[1]+t[1]*this.data[3]+this.data[5];t[0]=i,t[1]=n;const o=t[2]*this.data[0]+t[3]*this.data[2]+this.data[4],h=t[2]*this.data[1]+t[3]*this.data[3]+this.data[5];t[2]=o,t[3]=h;const c=t[4]*this.data[0]+t[5]*this.data[2]+this.data[4],_=t[4]*this.data[1]+t[5]*this.data[3]+this.data[5];t[4]=c,t[5]=_;const g=t[6]*this.data[0]+t[7]*this.data[2]+this.data[4],v=t[6]*this.data[1]+t[7]*this.data[3]+this.data[5];t[6]=g,t[7]=v}to4x4(){const t=new ai;return t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=0,t.data[3]=0,t.data[4]=this.data[2],t.data[5]=this.data[3],t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=this.data[4],t.data[13]=this.data[5],t.data[14]=0,t.data[15]=1,t}setRotation(t){const i=this.getScale(),n=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=n*i.y,this.data[2]=-n*i.x,this.data[3]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return _s(t)}getScaleX(){const t=this.data[0]*this.data[0]+this.data[2]*this.data[2];return t===1?this._scaleSignX:this._scaleSignX*Math.sqrt(t)}getScaleY(){const t=this.data[1]*this.data[1]+this.data[3]*this.data[3];return t===1?this._scaleSignY:this._scaleSignY*Math.sqrt(t)}getScale(){return G(this.getScaleX(),this.getScaleY())}setScaleX(t){if(t===this._scale[0])return;this._scaleSignX=Nt(t);const i=G(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[2]=i.y*t,this._scale[0]=t}setScaleY(t){if(t===this._scale[1])return;this._scaleSignY=Nt(t);const i=G(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[3]=i.y*t,this._scale[1]=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}clone(t){const i=t||new _e;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i._scaleSignX=this._scaleSignX,i._scaleSignY=this._scaleSignY,i}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}let Lr=class{constructor(t,i,n=1){this.builder=t,this.cleaner=i,this._pool=[],this._size=0,this.grow(n)}grow(t){if(t>0){this._size+=t;for(let i=0;i<t;i++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}};class Ig{constructor(){this._pool=new Lr(()=>_e.identity(),t=>t.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(t,i){return this._currentTransform.translate(t,i)}rotate(t){return this._currentTransform.rotate(t)}scale(t,i){return this._currentTransform.scale(t,i)}reset(){this._currentTransform.reset()}set current(t){this._currentTransform=t}get current(){return this._currentTransform}}class Rg{constructor(){this.opacity=1,this.z=0,this.tint=K.White,this.material=null}}class Fu{constructor(){this._pool=new Lr(()=>new Rg,t=>(t.opacity=1,t.z=0,t.tint=K.White,t.material=null,t),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(t){var i;return t.opacity=this.current.opacity,t.z=this.current.z,t.tint=(i=this.current.tint)===null||i===void 0?void 0:i.clone(),t.material=this.current.material,t}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const Dg={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class Ur{constructor(t,i,n=!1){this.path=t,this.responseType=i,this.bustCache=n,this.data=null,this.logger=ct.getInstance(),this.events=new Qt}isLoaded(){return this.data!==null}_cacheBust(t){return/\?\w*=\w*/.test(t)?t+="&__="+Date.now():t+="?__="+Date.now(),t}load(){return new Promise((t,i)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),t(this.data);return}const n=new XMLHttpRequest;n.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),n.responseType=this.responseType,n.addEventListener("loadstart",o=>this.events.emit("loadstart",o)),n.addEventListener("progress",o=>this.events.emit("progress",o)),n.addEventListener("error",o=>this.events.emit("error",o)),n.addEventListener("load",o=>this.events.emit("load",o)),n.addEventListener("load",()=>{if(n.status!==0&&n.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",n.status),this.events.emit("error",n.response),i(new Error(n.statusText));return}if(n.response instanceof Blob&&n.response.type==="text/html"){const o=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",n.response),i(new Error(o));return}this.data=n.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),t(this.data)}),n.send()})}}function Ii(d,t){return d&&(d.__isProxy===void 0?new Proxy(d,{set:(i,n,o)=>(i[n]!==o&&(i[n]=o,typeof n=="string"&&n[0]!=="_"&&t(i)),!0),get:(i,n)=>n!=="__isProxy"?i[n]:!0}):d)}const Bu=(d=[],t,i)=>({get:(n,o)=>o==="__isProxy"?!0:typeof n[o]=="object"&&n[o]!=null?new Proxy(n[o],Bu([...d,o],t,i)):n[o],set:(n,o,h)=>(typeof o=="string"&&o[0]!=="_"&&t(i),n[o]=h,!0)});function Mg(d,t){return d&&(d.__isProxy===void 0?new Proxy(d,Bu([],t,d)):d)}class se{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(t){this._flipHorizontal=t,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(t){this._flipVertical=t,this._transformStale=!0}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._transformStale=!0}get scale(){return this._scale}set scale(t){this._scale=Ii(t,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(t){t&&(this._origin=Ii(t,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(t){var i,n,o,h,c,_,g;this.id=se._ID++,this.transform=_e.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=k.One,this._width=0,this._height=0,t&&(this.origin=(i=t.origin)!==null&&i!==void 0?i:this.origin,this.flipHorizontal=(n=t.flipHorizontal)!==null&&n!==void 0?n:this.flipHorizontal,this.flipVertical=(o=t.flipVertical)!==null&&o!==void 0?o:this.flipVertical,this.rotation=(h=t.rotation)!==null&&h!==void 0?h:this.rotation,this.opacity=(c=t.opacity)!==null&&c!==void 0?c:this.opacity,this.scale=(_=t.scale)!==null&&_!==void 0?_:this.scale,this.tint=(g=t.tint)!==null&&g!==void 0?g:this.tint,t.width&&(this._width=t.width),t.height&&(this._height=t.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(t){this._width=t,this._transformStale=!0}set height(t){this._height=t,this._transformStale=!0}get localBounds(){return lt.fromDimension(this.width,this.height,k.Zero)}draw(t,i,n){this._preDraw(t,i,n),this._drawImage(t,0,0),this._postDraw(t)}_preDraw(t,i,n){t.save(),t.translate(i,n),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),t.multiply(this.transform),t.opacity=t.opacity*this.opacity,this.tint&&(t.tint=this.tint)}_rotate(t){var i;const n=this.scale.x>0?1:-1,o=this.scale.y>0?1:-1,h=(i=this.origin)!==null&&i!==void 0?i:G(this.width/2,this.height/2);t.translate(h.x,h.y),t.rotate(this.rotation),t.scale(n,o),t.translate(-h.x,-h.y)}_flip(t){this.flipHorizontal&&(t.translate(this.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,this.height/this.scale.y),t.scale(1,-1))}_postDraw(t){this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore()}}se._ID=0;class Ri extends se{static from(t,i){return new Ri({image:t,...i})}constructor(t){var i,n;super(t),this._logger=ct.getInstance(),this._dirty=!0,this.image=t.image;const{width:o,height:h}=t;this.sourceView=(i=t.sourceView)!==null&&i!==void 0?i:{x:0,y:0,width:o??0,height:h??0},this.destSize=(n=t.destSize)!==null&&n!==void 0?n:{width:o??0,height:h??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(t){t/=Math.abs(this.scale.x),this.destSize.width=t,super.width=Math.ceil(this.destSize.width)}set height(t){t/=Math.abs(this.scale.y),this.destSize.height=t,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var t,i,n,o,h,c;const{width:_,height:g}=this.image;this.sourceView.width=((t=this.sourceView)===null||t===void 0?void 0:t.width)||_,this.sourceView.height=((i=this.sourceView)===null||i===void 0?void 0:i.height)||g,this.destSize.width=((n=this.destSize)===null||n===void 0?void 0:n.width)||((o=this.sourceView)===null||o===void 0?void 0:o.width)||_,this.destSize.height=((h=this.destSize)===null||h===void 0?void 0:h.height)||((c=this.sourceView)===null||c===void 0?void 0:c.height)||g,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(t,i,n){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(t,i,n)}_drawImage(t,i,n){this.image.isLoaded()?t.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,i,n,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new Ri({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var ge;(function(d){d.Pixel="Pixel",d.Blended="Blended"})(ge||(ge={}));function Vn(d){switch(d){case ge.Pixel:return ge.Pixel;case ge.Blended:return ge.Blended;default:return}}var Yt;(function(d){d.Clamp="Clamp",d.Repeat="Repeat",d.Mirror="Mirror"})(Yt||(Yt={}));function Mi(d){switch(d){case Yt.Clamp:return Yt.Clamp;case Yt.Repeat:return Yt.Repeat;case Yt.Mirror:return Yt.Mirror;default:return Yt.Clamp}}class ee{constructor(t,i){var n;this._garbageCollector=i,this._textureMap=new Map,this._collect=o=>{var h;if(this._gl){const c=(h=o.dataset.originalSrc)!==null&&h!==void 0?h:o.constructor.name;return ee._LOGGER.debug(`WebGL Texture for ${c} collected`),this.delete(o),!0}return!1},this._gl=t,ee._MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),this._garbageCollector&&(ee._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(n=this._garbageCollector.garbageCollector)===null||n===void 0||n.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[t]of this._textureMap)this.delete(t);this._textureMap.clear(),this._gl=null}get(t){return this._textureMap.get(t)}has(t){return this._textureMap.has(t)}load(t,i,n=!1){var o,h;const c=this._gl;if(!c)return null;const{filtering:_,wrapping:g}={...i};let v=null;if(this.has(t)&&(v=this.get(t)),v)return n&&(c.bindTexture(c.TEXTURE_2D,v),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t)),(o=this._garbageCollector)===null||o===void 0||o.garbageCollector.touch(t),v;v=c.createTexture(),ee.checkImageSizeSupportedAndLog(t),c.bindTexture(c.TEXTURE_2D,v),c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let x;g&&(typeof g=="string"?x={x:g,y:g}:x={x:g.x,y:g.y});const{x:b,y:P}=x??ee.wrapping;switch(b){case Yt.Clamp:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);break;case Yt.Repeat:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT);break;case Yt.Mirror:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.MIRRORED_REPEAT);break;default:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE)}switch(P){case Yt.Clamp:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);break;case Yt.Repeat:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT);break;case Yt.Mirror:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.MIRRORED_REPEAT);break;default:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE)}const T=_??ee.filtering;return c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,T===ge.Pixel?c.NEAREST:c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,T===ge.Pixel?c.NEAREST:c.LINEAR),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t),this._textureMap.set(t,v),(h=this._garbageCollector)===null||h===void 0||h.garbageCollector.addCollectableResource("texture",t),v}delete(t){const i=this._gl;if(i&&this.has(t)){const n=this.get(t);n&&(this._textureMap.delete(t),i.deleteTexture(n))}}static checkImageSizeSupportedAndLog(t){var i;const n=(i=t.dataset.originalSrc)!==null&&i!==void 0?i:"internal canvas bitmap";return t.width>ee._MAX_TEXTURE_SIZE||t.height>ee._MAX_TEXTURE_SIZE?(ee._LOGGER.error(`The image [${n}] provided to Excalibur is too large for the device's maximum texture size of (${ee._MAX_TEXTURE_SIZE}x${ee._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((t.width>4096||t.height>4096)&&ee._LOGGER.warn(`The image [${n}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}ee._LOGGER=ct.getInstance();ee.filtering=ge.Blended;ee.wrapping={x:Yt.Clamp,y:Yt.Clamp};ee._MAX_TEXTURE_SIZE=4096;const Rt={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class Yi{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(t,i,n){this._logger=ct.getInstance(),this.data=new Image,this._readyFuture=new fi,this.ready=this._readyFuture.promise,this.path=t;let o=!1,h;typeof i=="boolean"?o=i:{filtering:n,wrapping:h,bustCache:o}={...i},this._resource=new Ur(t,"blob",o),this.filtering=n??this.filtering,typeof h=="string"?this.wrapping={x:h,y:h}:this.wrapping=h??this.wrapping,t.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${t} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(t,i){const n=new Yi("");if(n._src="image-element",n.data=t,n.data.setAttribute("data-original-src","image-element"),i?.filtering?n.data.setAttribute(Rt.Filtering,i?.filtering):n.data.setAttribute(Rt.Filtering,ge.Blended),i?.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},n.data.setAttribute(Rt.WrappingX,o.x),n.data.setAttribute(Rt.WrappingY,o.y)}else n.data.setAttribute(Rt.WrappingX,Yt.Clamp),n.data.setAttribute(Rt.WrappingY,Yt.Clamp);return ee.checkImageSizeSupportedAndLog(t),n._readyFuture.resolve(t),n}static fromHtmlCanvasElement(t,i){const n=new Yi("");if(n._src="canvas-element-blob",n.data.setAttribute("data-original-src","canvas-element-blob"),i?.filtering?n.data.setAttribute(Rt.Filtering,i?.filtering):n.data.setAttribute(Rt.Filtering,ge.Blended),i?.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},n.data.setAttribute(Rt.WrappingX,o.x),n.data.setAttribute(Rt.WrappingY,o.y)}else n.data.setAttribute(Rt.WrappingX,Yt.Clamp),n.data.setAttribute(Rt.WrappingY,Yt.Clamp);return ee.checkImageSizeSupportedAndLog(t),t.toBlob(o=>{const h=URL.createObjectURL(o);n.image.onload=()=>{URL.revokeObjectURL(h),n.data=n.image,n._readyFuture.resolve(n.image)},n.image.src=h}),n}static fromSvgString(t,i){const n=new Blob([t],{type:"image/svg+xml"}),o=URL.createObjectURL(n);return new Yi(o,i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){var t,i,n,o;if(this.isLoaded())return this.data;try{let h;if(this.path.includes("data:image/"))h=this.path;else{const g=await this._resource.load();h=URL.createObjectURL(g)}const c=new Image,_=new fi;c.onload=()=>_.resolve(),c.src=h,c.setAttribute("data-original-src",this.path),await _.promise,this.data=c,ee.checkImageSizeSupportedAndLog(this.data)}catch(h){throw`Error loading ImageSource from path '${this.path}' with error [${h.message}]`}return this.data.setAttribute(Rt.Filtering,this.filtering),this.data.setAttribute(Rt.WrappingX,(i=(t=this.wrapping)===null||t===void 0?void 0:t.x)!==null&&i!==void 0?i:Yt.Clamp),this.data.setAttribute(Rt.WrappingY,(o=(n=this.wrapping)===null||n===void 0?void 0:n.y)!==null&&o!==void 0?o:Yt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(t){return Ri.from(this,t)}unload(){this.data=new Image}}class ia extends se{constructor(t){super(t),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=ct.getInstance();const{alphabet:i,spriteSheet:n,caseInsensitive:o,spacing:h,shadow:c,lineHeight:_}=t;this.alphabet=i,this.spriteSheet=n,this.caseInsensitive=o??this.caseInsensitive,this.spacing=h??this.spacing,this.shadow=c??this.shadow,this.lineHeight=_??this.lineHeight}_getCharacterSprites(t){const i=[],n=this.caseInsensitive?t.toLocaleLowerCase():t,o=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let h=0;h<n.length;h++){const c=n[h];let _=o.indexOf(c);_===-1&&(_=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${c}' in configured alphabet '${o}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const g=this.spriteSheet.sprites[_];g?i.push(g):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${c}' at index '${_}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return i}measureText(t,i){const n=this._getLinesFromText(t,i),o=n.reduce((g,v)=>g.length>v.length?g:v),h=this._getCharacterSprites(o);let c=0,_=0;for(const g of h)c+=g.width+this.spacing,_=Math.max(_,g.height);return lt.fromDimension(c*this.scale.x,_*n.length*this.scale.y,k.Zero)}_drawImage(t,i,n,o){var h;let c=0,_=0,g=0;const v=this._getLinesFromText(this._text,o);for(const x of v){for(const b of this._getCharacterSprites(x))b.draw(t,i+c,n+_),c+=b.width+this.spacing,g=Math.max(g,b.height);c=0,_+=(h=this.lineHeight)!==null&&h!==void 0?h:g}}render(t,i,n,o,h,c){this._text=i;const _=this.measureText(i,c);this.width=_.width,this.height=_.height,this.shadow&&(t.save(),t.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(t,o,h),this._drawImage(t,0,0,c),this._postDraw(t),t.restore()),this._preDraw(t,o,h),this._drawImage(t,0,0,c),this._postDraw(t)}clone(){return new ia({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(t,i){var n;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let c=o[h],_="";if(this.measureText(c).width>i){for(;this.measureText(c).width>i;)_=c[c.length-1]+_,c=c.slice(0,-1);o[h]=c,o[h+1]=_}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class zr extends Ri{constructor(t){super({image:t.image,sourceView:t.sourceView,destSize:{width:t.width,height:t.height},flipHorizontal:t.flipHorizontal,flipVertical:t.flipVertical,rotation:t.rotation,scale:t.scale,opacity:t.opacity,tint:t.tint,origin:t.origin}),this._ready=new fi,this.ready=this._ready.promise,this._options=t,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(t,i){return new zr({sourceView:{...t.sourceView},width:t.width,height:t.height,...i,image:t.image})}_applyTiling(){const{width:t,height:i,filtering:n,wrapping:o}={...this._options},h=document.createElement("canvas");h.width=this.sourceView.width,h.height=this.sourceView.height,h.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const _=Yi.fromHtmlCanvasElement(h,{wrapping:o??Yt.Repeat,filtering:n});t&&(this.destSize.width=t,this.sourceView.width=t),i&&(this.destSize.height=i,this.sourceView.height=i),this.sourceView.x=0,this.sourceView.y=0,this.image=_,this.image.ready.then(()=>this._ready.resolve())}}class nn{constructor(t){this.sprites=[];const{sprites:i,rows:n,columns:o}=t;this.sprites=i,this.rows=n??1,this.columns=o??this.sprites.length}getSprite(t,i,n){var o,h,c,_,g,v,x,b,P;if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const T=t+i*this.columns,I=this.sprites[T];if(I){if(n){const F=I.clone();return F.flipHorizontal=(o=n.flipHorizontal)!==null&&o!==void 0?o:F.flipHorizontal,F.flipVertical=(h=n.flipVertical)!==null&&h!==void 0?h:F.flipVertical,F.width=(c=n.width)!==null&&c!==void 0?c:F.width,F.height=(_=n.height)!==null&&_!==void 0?_:F.height,F.rotation=(g=n.rotation)!==null&&g!==void 0?g:F.rotation,F.scale=(v=n.scale)!==null&&v!==void 0?v:F.scale,F.opacity=(x=n.opacity)!==null&&x!==void 0?x:F.opacity,F.tint=(b=n.tint)!==null&&b!==void 0?b:F.tint,F.origin=(P=n.origin)!==null&&P!==void 0?P:F.origin,F}return I}throw Error(`Invalid sprite coordinates (${t}, ${i})`)}getTiledSprite(t,i,n){if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const o=t+i*this.columns,h=this.sprites[o];if(h)return zr.fromSprite(h,n);throw Error(`Invalid sprite coordinates (${t}, ${i})`)}static fromImageSourceWithSourceViews(t){const i=t.sourceViews.map(n=>new Ri({image:t.image,sourceView:n}));return new nn({sprites:i})}static fromImageSource(t){var i;const n=[];t.spacing=(i=t.spacing)!==null&&i!==void 0?i:{};const{image:o,grid:{rows:h,columns:c,spriteWidth:_,spriteHeight:g},spacing:{originOffset:v,margin:x}}=t,b={x:0,y:0,...v},P={x:0,y:0,...x};for(let T=0;T<c;T++)for(let I=0;I<h;I++)n[T+I*c]=new Ri({image:o,sourceView:{x:T*_+P.x*T+b.x,y:I*g+P.y*I+b.y,width:_,height:g},destSize:{height:g,width:_}});return new nn({sprites:n,rows:h,columns:c})}clone(){return new nn({sprites:this.sprites.map(t=>t.clone()),rows:this.rows,columns:this.columns})}}const Fg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class Cl{constructor(){this.fontSheet=Fg,this.size=16,this.load()}load(){return this._imageSource=new Yi(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=nn.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new ia({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(t,i,n){this._imageSource.isLoaded()&&this._spriteFont.render(t,i,null,n.x,n.y)}}class Bg{constructor(t,i){this._gl=t,this._texture=i}use(){const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture)}disable(){const t=this._gl;t.bindTexture(t.TEXTURE_2D,null)}}class Mo{constructor(t){var i,n;this.antialias=!1,this.samples=1,this._gl=t.gl,this.width=t.width,this.height=t.height,this.transparency=t.transparency,this.antialias=(i=t.antialias)!==null&&i!==void 0?i:this.antialias,this.samples=(n=t.samples)!==null&&n!==void 0?n:this._gl.getParameter(this._gl.MAX_SAMPLES);const o=this._gl;o.drawingBufferFormat?this.bufferFormat=o.drawingBufferFormat:this.transparency?this.bufferFormat=o.RGBA8:this.bufferFormat=o.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(t,i){const n=this._gl;this.width=t,this.height=i,n.bindTexture(n.TEXTURE_2D,this._frameTexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.width,this.height,0,n.RGBA,n.UNSIGNED_BYTE,null),this._renderBuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,this._renderBuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,Math.min(this.samples,n.getParameter(n.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const t=this._gl;this._renderBuffer=t.createRenderbuffer(),this._renderFrameBuffer=t.createFramebuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._renderBuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,Math.min(this.samples,t.getParameter(t.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const t=this._gl;this._frameTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._frameTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const i=t.COLOR_ATTACHMENT0;this._frameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,i,t.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new Bg(this._gl,this._frameTexture)}blitToScreen(){const t=this._gl;this._renderBuffer?(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)):(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.frameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const t=this._gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.frameBuffer),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)}}copyToTexture(t){const i=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this._frameBuffer),i.bindTexture(i.TEXTURE_2D,t),i.copyTexImage2D(i.TEXTURE_2D,0,i.RGBA,0,0,this.width,this.height,0)}use(){const t=this._gl;this.antialias?t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.viewport(0,0,this.width,this.height)}disable(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null)}}const kg=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,Lg=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function Kh(d,t){switch(t){case d.INT:case d.UNSIGNED_INT:case d.FLOAT:return 4;case d.SHORT:return 2;case d.UNSIGNED_SHORT:return 2;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;default:return 1}}function ku(d,t){const i=`(?<type>[a-z0-9]+)\\s+${t};`,o=new RegExp(i,"g").exec(d);return o?.length>0}function Lu(d,t,i){var n;const o=`(?<type>[a-z0-9]+)\\s+${i};`,c=new RegExp(o,"g").exec(t);switch((n=c?.groups)===null||n===void 0?void 0:n.type){case"float":case"vec2":case"vec3":case"vec4":return d.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return d.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return d.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return d.BOOL;case"short":return d.SHORT;case"ushort":return d.UNSIGNED_SHORT;case"ubyte":return d.UNSIGNED_BYTE;case"byte":return d.BYTE;default:return d.FLOAT}}function Uu(d,t){switch(t){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:return 1;case d.FLOAT_VEC2:return 2;case d.FLOAT_VEC3:return 3;case d.FLOAT_VEC4:return 4;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;case d.UNSIGNED_SHORT:case d.SHORT:return 1;default:return 1}}function zu(d,t){switch(t){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:case d.FLOAT_VEC2:case d.FLOAT_VEC3:case d.FLOAT_VEC4:return d.FLOAT;case d.BYTE:return d.BYTE;case d.UNSIGNED_BYTE:return d.UNSIGNED_BYTE;case d.SHORT:return d.SHORT;case d.UNSIGNED_SHORT:return d.UNSIGNED_SHORT;default:return d.FLOAT}}function Pl(d,t){const i=o=>{const h=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let c="";for(let _=0;_<o;_++)_===0?c+=`if (index <= ${_}.5) {
`:c+=`   else if (index <= ${_}.5) {
`,c+=`      fragColor = vec4(1.0);
`,c+=`   }
`;return h.replace("%%complexity%%",c)};let n=!1;do{const o=i(t),h=d.createShader(d.FRAGMENT_SHADER);d.shaderSource(h,o),d.compileShader(h),n=d.getShaderParameter(h,d.COMPILE_STATUS),n||(t=t/2|0)}while(!n);return t}class si{get compiled(){return this._compiled}constructor(t){this._logger=ct.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:i,vertexSource:n,fragmentSource:o,onPreLink:h,onPostCompile:c}=t;this._gl=i,this.vertexSource=n,this.fragmentSource=o,this._onPreLink=h,this._onPostCompile=c}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),si._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return si._ACTIVE_SHADER_INSTANCE===this}compile(){const t=this._gl,i=this._compileShader(t,this.vertexSource,t.VERTEX_SHADER),n=this._compileShader(t,this.fragmentSource,t.FRAGMENT_SHADER);this.program=this._createProgram(t,i,n);const o=this.getAttributes();for(const c of o)this.attributes[c.name]=c;const h=this.getUniforms();for(const c of h)this.uniforms[c.name]=c;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS),n=[];for(let o=0;o<i;o++){const h=t.getActiveUniform(this.program,o),c=t.getUniformLocation(this.program,h.name);n.push({name:h.name,glType:h.type,location:c})}return n}getAttributes(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES),n=[];for(let o=0;o<i;o++){const h=t.getActiveAttrib(this.program,o),c=t.getAttribLocation(this.program,h.name);n.push({name:h.name,glType:zu(t,h.type),size:Uu(t,h.type),location:c,normalized:!1})}return n}setTexture(t,i){const n=this._gl;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,i)}setUniformInt(t,i){this.setUniform("uniform1i",t,~~i)}trySetUniformInt(t,i){return this.trySetUniform("uniform1i",t,~~i)}setUniformIntArray(t,i){this.setUniform("uniform1iv",t,i)}trySetUniformIntArray(t,i){return this.trySetUniform("uniform1iv",t,i)}setUniformBoolean(t,i){this.setUniform("uniform1i",t,i?1:0)}trySetUniformBoolean(t,i){return this.trySetUniform("uniform1i",t,i?1:0)}setUniformFloat(t,i){this.setUniform("uniform1f",t,i)}trySetUniformFloat(t,i){return this.trySetUniform("uniform1f",t,i)}setUniformFloatArray(t,i){this.setUniform("uniform1fv",t,i)}trySetUniformFloatArray(t,i){return this.trySetUniform("uniform1fv",t,i)}setUniformFloatVector(t,i){this.setUniform("uniform2f",t,i.x,i.y)}trySetUniformFloatVector(t,i){return this.trySetUniform("uniform2f",t,i.x,i.y)}setUniformFloatColor(t,i){this.setUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}trySetUniformFloatColor(t,i){return this.trySetUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}setUniformMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,i.data)}setUniformAffineMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,[i.data[0],i.data[1],0,0,i.data[2],i.data[3],0,0,0,0,1,0,i.data[4],i.data[5],0,1])}trySetUniformMatrix(t,i){return this.trySetUniform("uniformMatrix4fv",t,!1,i.data)}setUniform(t,i,...n){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${t}:${i}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const h=this._gl.getUniformLocation(this.program,i);if(h){const c=[h,...n];this._gl[t].apply(this._gl,c)}else throw Error(`Uniform ${t}:${i} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(t,i,...n){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${t}:${i}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const h=this._gl.getUniformLocation(this.program,i);if(h){const c=[h,...n];this._gl[t].apply(this._gl,c)}else return!1;return!0}_createProgram(t,i,n){const o=t.createProgram();if(o===null)throw Error("Could not create graphics shader program");if(t.attachShader(o,i),t.attachShader(o,n),this._onPreLink&&this._onPreLink(o),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw Error(`Could not link the program: [${t.getProgramInfoLog(o)}]`);return o}_compileShader(t,i,n){const o=t.VERTEX_SHADER===n?"vertex":"fragment",h=t.createShader(n);if(h===null)throw Error(`Could not build shader: [${i}]`);if(t.shaderSource(h,i),t.compileShader(h),!t.getShaderParameter(h,t.COMPILE_STATUS)){const _=t.getShaderInfoLog(h);throw Error(`Could not compile ${o} shader:

${_}${this._processSourceForError(i,_)}`)}return h}_processSourceForError(t,i){if(!t)return i;const n=t.split(`
`),o=i.search(/\d:\d/),h=i.indexOf(" ",o),[c,_]=i.slice(o,h).split(":").map(g=>Number(g));for(let g=0;g<n.length;g++)n[g]=`${g+1}: ${n[g]}${_===g+1?" <----- ERROR!":""}`;return`

Source:
`+n.join(`
`)}}si._ACTIVE_SHADER_INSTANCE=null;class Qi{constructor(t){this.type="dynamic";const{gl:i,size:n,type:o,data:h}=t;if(this._gl=i,this.buffer=this._gl.createBuffer(),!h&&!n)throw Error("Must either provide data or a size to the VertexBuffer");h?this.bufferData=h:this.bufferData=new Float32Array(n),this.type=o??this.type,i.bindBuffer(i.ARRAY_BUFFER,this.buffer),i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this.buffer)}unbind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,null)}upload(t){const i=this._gl;i.bindBuffer(i.ARRAY_BUFFER,this.buffer),t?i.bufferSubData(i.ARRAY_BUFFER,0,this.bufferData,0,t):i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class bs{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(t){this._logger=ct.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:i,shader:n,vertexBuffer:o,attributes:h,suppressWarnings:c}=t;this._gl=i,this._vertexBuffer=o,this._attributes=h,this._shader=n,this._suppressWarnings=c,n&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(t){t&&this._shader!==t&&(this._shader=t,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const t=this._shader.attributes;for(const h of this._attributes){const c=t[h[0]];if(!c){if(!ku(this._shader.vertexSource,h[0]))throw Error(`The attribute named: ${h[0]} size ${h[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${h[0]} size ${h[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${h[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${h[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const _=Lu(this._gl,this._shader.vertexSource,h[0]);this._layout.push({name:h[0],glType:_,size:h[1],location:-1,normalized:!1})}if(c){if(c.size!==h[1])throw Error(`VertexLayout size definition for attribute: [${h[0]}, ${h[1]}], doesn't match shader source size ${c.size}:
 ${this._shader.vertexSource}`);this._layout.push(c)}}let i=0;for(const h of this._layout){const c=Kh(this._gl,h.glType);this._vertexTotalSizeBytes+=c*h.size,i+=h.size}this._vertexBuffer.bufferData.length%i!==0&&this._logger.warn(`The vertex component size (${i})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const n=this._gl;this._vao=n.createVertexArray(),n.bindVertexArray(this._vao),this._vertexBuffer.bind();let o=0;for(const h of this._layout)h.location!==-1&&(h.glType===n.INT?n.vertexAttribIPointer(h.location,h.size,h.glType,this.totalVertexSizeBytes,o):n.vertexAttribPointer(h.location,h.size,h.glType,h.normalized,this.totalVertexSizeBytes,o),n.enableVertexAttribArray(h.location)),o+=Kh(n,h.glType)*h.size;n.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(t=!1,i){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const n=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),t&&this._vertexBuffer.upload(i),n.bindVertexArray(this._vao)}}class Zt{static clear(){Zt.DrawCallCount=0,Zt.DrawnImagesCount=0}}Zt.DrawCallCount=0;Zt.DrawnImagesCount=0;class Ug{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=G(0,0),this._endScratch=G(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new si({gl:t,vertexSource:kg,fragmentSource:Lg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new Qi({gl:t,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new bs({gl:t,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,n){this._isFull()&&this.flush(),this._lineCount++;const o=this._context.getTransform(),h=o.multiply(t,this._startScratch),c=o.multiply(i,this._endScratch),_=this._vertexBuffer.bufferData;_[this._vertexIndex++]=h.x,_[this._vertexIndex++]=h.y,_[this._vertexIndex++]=n.r/255,_[this._vertexIndex++]=n.g/255,_[this._vertexIndex++]=n.b/255,_[this._vertexIndex++]=n.a,_[this._vertexIndex++]=c.x,_[this._vertexIndex++]=c.y,_[this._vertexIndex++]=n.r/255,_[this._vertexIndex++]=n.g/255,_[this._vertexIndex++]=n.b/255,_[this._vertexIndex++]=n.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.LINES,0,this._lineCount*2),Zt.DrawnImagesCount+=this._lineCount,Zt.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const zg=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,Hg=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class Og{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new si({gl:t,vertexSource:zg,fragmentSource:Hg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new Qi({gl:t,size:7*this._maxPoints,type:"dynamic"}),this._layout=new bs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,n){this._isFull()&&this.flush(),this._pointCount++;const o=this._context.getTransform(),h=this._context.opacity,c=this._context.snapToPixel,_=o.multiply(t);c&&(_.x=~~(_.x+pt),_.y=~~(_.y+pt));const g=this._buffer.bufferData;g[this._vertexIndex++]=_.x,g[this._vertexIndex++]=_.y,g[this._vertexIndex++]=i.r/255,g[this._vertexIndex++]=i.g/255,g[this._vertexIndex++]=i.b/255,g[this._vertexIndex++]=i.a*h,g[this._vertexIndex++]=n*Math.max(o.getScaleX(),o.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.POINTS,0,this._pointCount),Zt.DrawnImagesCount+=this._pointCount,Zt.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const Wg=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,Ng=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class Gg{constructor(t){this._gl=t,this._shader=new si({gl:t,vertexSource:Wg,fragmentSource:Ng}),this._shader.compile(),this._buffer=new Qi({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new bs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(t){const i=this._gl,n=t.getShader();n.use(),t.getLayout().use(),i.activeTexture(i.TEXTURE0),n.trySetUniformInt("u_image",0),t.onDraw&&t.onDraw(),i.drawArrays(i.TRIANGLES,0,6)}renderToScreen(){const t=this._gl;this._shader.use(),this._layout.use(),t.drawArrays(t.TRIANGLES,0,6)}}class Hr{constructor(t,i,n){this._logger=ct.getInstance(),this._gl=t,this.buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer);const o=i*6;if(!n)this.bufferData=new Uint32Array(o);else{const _=Math.floor(16383.5);this.bufferGlType=t.UNSIGNED_SHORT,this.bufferData=new Uint16Array(o),i>_&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${_}) requested quads(${i})`)}let h=0;for(let c=0;c<o;c+=6)this.bufferData[c+0]=h+0,this.bufferData[c+1]=h+1,this.bufferData[c+2]=h+2,this.bufferData[c+3]=h+2,this.bufferData[c+4]=h+1,this.bufferData[c+5]=h+3,h+=4;t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const Vg=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,Xg=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class qg{constructor(t){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=K.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=Pl(t,n);this._maxTextures=Math.min(n,o);const h=this._transformFragmentSource(Vg,this._maxTextures);this._shader=new si({gl:t,fragmentSource:h,vertexSource:Xg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((c,_)=>_)),this._buffer=new Qi({gl:t,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new bs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new Hr(t,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let n=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_textureIndex <= ${h}.5) {
`:o+=`   else if (v_textureIndex <= ${h}.5) {
`,o+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return n=n.replace("%%texture_picker%%",o),n}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(Rt.Filtering),n=i?Vn(i):void 0,o=Mi(t.getAttribute(Rt.WrappingX)),h=Mi(t.getAttribute(Rt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&(this._textures.push(_),this._textureToIndex.set(_,this._textureIndex++),this._images.add(t))}_bindTextures(t){for(let i=0;i<this._maxTextures;i++)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,this._textures[i]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const n=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(n))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,n,o,h,c,_,g,v){var x,b,P,T;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const I=this._getImageWidth(t),F=this._getImageHeight(t);let R=I||o||0,S=F||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(x=o??I)!==null&&x!==void 0?x:0,this._view[3]=(b=h??F)!==null&&b!==void 0?b:0,this._dest[0]=i??1,this._dest[1]=n??1,c!==void 0&&_!==void 0&&g!==void 0&&v!==void 0&&(this._view[0]=i??1,this._view[1]=n??1,this._view[2]=(P=o??I)!==null&&P!==void 0?P:0,this._view[3]=(T=h??F)!==null&&T!==void 0?T:0,this._dest[0]=c,this._dest[1]=_,R=g,S=v),i=this._view[0],n=this._view[1];const M=this._view[2],W=this._view[3],U=this._context.getTransform(),V=this._context.opacity,j=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+R,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+S,this._quad[6]=this._dest[0]+R,this._quad[7]=this._dest[1]+S,U.multiplyQuadInPlace(this._quad),j&&(this._quad[0]=~~(this._quad[0]+Nt(this._quad[0])*pt),this._quad[1]=~~(this._quad[1]+Nt(this._quad[1])*pt),this._quad[2]=~~(this._quad[2]+Nt(this._quad[2])*pt),this._quad[3]=~~(this._quad[3]+Nt(this._quad[3])*pt),this._quad[4]=~~(this._quad[4]+Nt(this._quad[4])*pt),this._quad[5]=~~(this._quad[5]+Nt(this._quad[5])*pt),this._quad[6]=~~(this._quad[6]+Nt(this._quad[6])*pt),this._quad[7]=~~(this._quad[7]+Nt(this._quad[7])*pt));const X=this._context.tint||this._defaultTint,nt=this._getTextureIdForImage(t),ht=I||R,wt=F||S,gt=(i+this.uvPadding)/ht,At=(n+this.uvPadding)/wt,Et=(i+M-this.uvPadding)/ht,B=(n+W-this.uvPadding)/wt,z=I,Q=F,tt=this._layout.vertexBuffer.bufferData;tt[this._vertexIndex++]=this._quad[0],tt[this._vertexIndex++]=this._quad[1],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=gt,tt[this._vertexIndex++]=At,tt[this._vertexIndex++]=nt,tt[this._vertexIndex++]=X.r/255,tt[this._vertexIndex++]=X.g/255,tt[this._vertexIndex++]=X.b/255,tt[this._vertexIndex++]=X.a,tt[this._vertexIndex++]=this._quad[4],tt[this._vertexIndex++]=this._quad[5],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=gt,tt[this._vertexIndex++]=B,tt[this._vertexIndex++]=nt,tt[this._vertexIndex++]=X.r/255,tt[this._vertexIndex++]=X.g/255,tt[this._vertexIndex++]=X.b/255,tt[this._vertexIndex++]=X.a,tt[this._vertexIndex++]=this._quad[2],tt[this._vertexIndex++]=this._quad[3],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=Et,tt[this._vertexIndex++]=At,tt[this._vertexIndex++]=nt,tt[this._vertexIndex++]=X.r/255,tt[this._vertexIndex++]=X.g/255,tt[this._vertexIndex++]=X.b/255,tt[this._vertexIndex++]=X.a,tt[this._vertexIndex++]=this._quad[6],tt[this._vertexIndex++]=this._quad[7],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=Et,tt[this._vertexIndex++]=B,tt[this._vertexIndex++]=nt,tt[this._vertexIndex++]=X.r/255,tt[this._vertexIndex++]=X.g/255,tt[this._vertexIndex++]=X.b/255,tt[this._vertexIndex++]=X.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),this._quads.bind(),t.drawElements(t.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),Zt.DrawnImagesCount+=this._imageCount,Zt.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const Yg=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,jg=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class Zg{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=K.Transparent,this._scratch1=G(0,0),this._scratch2=G(0,0),this._scratch3=G(0,0),this._scratch4=G(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new si({gl:t,fragmentSource:Yg,vertexSource:jg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new Qi({gl:t,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new bs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Hr(t,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...t){t[0]instanceof k&&t[1]instanceof k?this.drawLine.apply(this,t):this.drawRectangle.apply(this,t)}drawLine(t,i,n,o=1){this._isFull()&&this.flush(),this._rectangleCount++;const h=this._context.getTransform(),c=this._context.opacity,_=this._context.snapToPixel,g=i.sub(t),v=g.magnitude,x=g.normalize().perpendicular(),b=o/2,P=h.multiply(x.scale(b,this._scratch1).add(t,this._scratch1),this._scratch1),T=h.multiply(x.scale(-b,this._scratch2).add(t,this._scratch2),this._scratch2),I=h.multiply(x.scale(b,this._scratch3).add(i,this._scratch3),this._scratch3),F=h.multiply(x.scale(-b,this._scratch4).add(i,this._scratch4),this._scratch4);_&&(P.x=~~(P.x+pt),P.y=~~(P.y+pt),I.x=~~(I.x+pt),I.y=~~(I.y+pt),T.x=~~(T.x+pt),T.y=~~(T.y+pt),F.x=~~(F.x+pt),F.y=~~(F.y+pt));const R=0,S=0,M=1,W=1,U=this._transparent,V=0,j=1,X=this._layout.vertexBuffer.bufferData;X[this._vertexIndex++]=P.x,X[this._vertexIndex++]=P.y,X[this._vertexIndex++]=R,X[this._vertexIndex++]=S,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=V/j,X[this._vertexIndex++]=T.x,X[this._vertexIndex++]=T.y,X[this._vertexIndex++]=R,X[this._vertexIndex++]=W,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=V/j,X[this._vertexIndex++]=I.x,X[this._vertexIndex++]=I.y,X[this._vertexIndex++]=M,X[this._vertexIndex++]=S,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=V/j,X[this._vertexIndex++]=F.x,X[this._vertexIndex++]=F.y,X[this._vertexIndex++]=M,X[this._vertexIndex++]=W,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=V/j}drawRectangle(t,i,n,o,h=K.Transparent,c=0){this._isFull()&&this.flush(),this._rectangleCount++;const _=this._context.getTransform(),g=this._context.opacity,v=this._context.snapToPixel,x=_.multiply(t.add(G(0,0))),b=_.multiply(t.add(G(i,0))),P=_.multiply(t.add(G(i,n))),T=_.multiply(t.add(G(0,n)));v&&(x.x=~~(x.x+pt),x.y=~~(x.y+pt),b.x=~~(b.x+pt),b.y=~~(b.y+pt),T.x=~~(T.x+pt),T.y=~~(T.y+pt),P.x=~~(P.x+pt),P.y=~~(P.y+pt));const I=0,F=0,R=1,S=1,M=this._layout.vertexBuffer.bufferData;M[this._vertexIndex++]=x.x,M[this._vertexIndex++]=x.y,M[this._vertexIndex++]=I,M[this._vertexIndex++]=F,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=g,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=T.x,M[this._vertexIndex++]=T.y,M[this._vertexIndex++]=I,M[this._vertexIndex++]=S,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=g,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=b.x,M[this._vertexIndex++]=b.y,M[this._vertexIndex++]=R,M[this._vertexIndex++]=F,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=g,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=P.x,M[this._vertexIndex++]=P.y,M[this._vertexIndex++]=R,M[this._vertexIndex++]=S,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=g,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),Zt.DrawnImagesCount+=this._rectangleCount,Zt.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const Qg=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,$g=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class Kg{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new si({gl:t,fragmentSource:Qg,vertexSource:$g}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new Qi({gl:t,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new bs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Hr(t,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(t,i,n,o=K.Transparent,h=0){this._isFull()&&this.flush(),this._circleCount++;const c=this._context.getTransform(),_=this._context.opacity,g=this._context.snapToPixel,v=c.multiply(t.add(G(-i,-i))),x=c.multiply(t.add(G(i,-i))),b=c.multiply(t.add(G(i,i))),P=c.multiply(t.add(G(-i,i)));g&&(v.x=~~(v.x+pt),v.y=~~(v.y+pt),x.x=~~(x.x+pt),x.y=~~(x.y+pt),P.x=~~(P.x+pt),P.y=~~(P.y+pt),b.x=~~(b.x+pt),b.y=~~(b.y+pt));const T=0,I=0,F=1,R=1,S=this._layout.vertexBuffer.bufferData;S[this._vertexIndex++]=v.x,S[this._vertexIndex++]=v.y,S[this._vertexIndex++]=T,S[this._vertexIndex++]=I,S[this._vertexIndex++]=_,S[this._vertexIndex++]=n.r/255,S[this._vertexIndex++]=n.g/255,S[this._vertexIndex++]=n.b/255,S[this._vertexIndex++]=n.a,S[this._vertexIndex++]=o.r/255,S[this._vertexIndex++]=o.g/255,S[this._vertexIndex++]=o.b/255,S[this._vertexIndex++]=o.a,S[this._vertexIndex++]=h/i,S[this._vertexIndex++]=P.x,S[this._vertexIndex++]=P.y,S[this._vertexIndex++]=T,S[this._vertexIndex++]=R,S[this._vertexIndex++]=_,S[this._vertexIndex++]=n.r/255,S[this._vertexIndex++]=n.g/255,S[this._vertexIndex++]=n.b/255,S[this._vertexIndex++]=n.a,S[this._vertexIndex++]=o.r/255,S[this._vertexIndex++]=o.g/255,S[this._vertexIndex++]=o.b/255,S[this._vertexIndex++]=o.a,S[this._vertexIndex++]=h/i,S[this._vertexIndex++]=x.x,S[this._vertexIndex++]=x.y,S[this._vertexIndex++]=F,S[this._vertexIndex++]=I,S[this._vertexIndex++]=_,S[this._vertexIndex++]=n.r/255,S[this._vertexIndex++]=n.g/255,S[this._vertexIndex++]=n.b/255,S[this._vertexIndex++]=n.a,S[this._vertexIndex++]=o.r/255,S[this._vertexIndex++]=o.g/255,S[this._vertexIndex++]=o.b/255,S[this._vertexIndex++]=o.a,S[this._vertexIndex++]=h/i,S[this._vertexIndex++]=b.x,S[this._vertexIndex++]=b.y,S[this._vertexIndex++]=F,S[this._vertexIndex++]=R,S[this._vertexIndex++]=_,S[this._vertexIndex++]=n.r/255,S[this._vertexIndex++]=n.g/255,S[this._vertexIndex++]=n.b/255,S[this._vertexIndex++]=n.a,S[this._vertexIndex++]=o.r/255,S[this._vertexIndex++]=o.g/255,S[this._vertexIndex++]=o.b/255,S[this._vertexIndex++]=o.a,S[this._vertexIndex++]=h/i}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),Zt.DrawnImagesCount+=this._circleCount,Zt.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class sa{constructor(t,i,n=100){this.builder=t,this.recycler=i,this.maxObjects=n,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=ct.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let t=0;t<this.maxObjects;t++)this.objects[t]=this.builder()}using(t){const i=t(this);return i?this.done(...i):this.done()}borrow(t){const i=this.get();t(i),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...t){this.index=0;for(const i of t){const n=this.objects.indexOf(i);this.objects[n]=this.builder(),this.totalAllocations++}return t}}class Jg{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=_e.identity(),this.state={z:0,opacity:1,tint:K.White,material:null},this.args=new Array(10)}}const tm=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class Hu{constructor(t){this._logger=ct.getInstance(),this._color=K.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:i,name:n,vertexSource:o,fragmentSource:h,graphicsContext:c,images:_}=t;if(this._name=n??"anonymous material",this._vertexSource=o??tm,this._fragmentSource=h,this._color=i??this._color,!c)throw Error(`Material ${n} must be provided an excalibur webgl graphics context`);if(c instanceof ps?(this._graphicsContext=c,this._initialize(c)):this._logger.warn(`Material ${n} was created in 2D Canvas mode, currently only WebGL is supported`),_)for(const g in _)this.addImageSource(g,_[g])}_initialize(t){if(this._initialized)return;const i=t.__gl;this._maxTextureSlots=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=t.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(t){this._color=t}get name(){var t;return(t=this._name)!==null&&t!==void 0?t:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(t){this._shader&&(this._shader.use(),t(this._shader))}getShader(){return this._shader}addImageSource(t,i){this._images.size<this._maxTextureSlots?this._images.set(t,i):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(t){const i=this._images.get(t);this._graphicsContext.textureLoader.delete(i.image),this._images.delete(t)}_loadImageSource(t){const i=t.image,n=i.getAttribute(Rt.Filtering),o=n?Vn(n):void 0,h=Mi(i.getAttribute(Rt.WrappingX)),c=Mi(i.getAttribute(Rt.WrappingY)),_=i.getAttribute("forceUpload")==="true",g=this._graphicsContext.textureLoader.load(i,{filtering:o,wrapping:{x:h,y:c}},_);return i.removeAttribute("forceUpload"),this._textures.has(t)||this._textures.set(t,g),g}uploadAndBind(t,i=2){let n=i;for(const[o,h]of this._images.entries()){if(!h.isLoaded()){this._logger.warnOnce(`Image named ${o} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const c=this._loadImageSource(h);t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,c),this._shader.trySetUniformInt(o,n),n++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class _u{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(t,i){this._gl=t,this._context=i,this._buffer=new Qi({gl:t,size:6*4,type:"dynamic"}),this._layout=new bs({gl:t,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new Hr(t,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(t,i,n,o,h,c,_,g,v){var x,b,P,T;const I=this._gl,F=this._context.material;if(!F)return;const R=this._context.getTransform(),S=this._context.opacity,M=F.getShader(),W=this._layout.vertexBuffer.bufferData;let U=0,V=t?.width||o||0,j=t?.height||h||0,X=[0,0,(x=o??t?.width)!==null&&x!==void 0?x:0,(b=h??t?.height)!==null&&b!==void 0?b:0],nt=[i??1,n??1];c!==void 0&&_!==void 0&&g!==void 0&&v!==void 0&&(X=[i??1,n??1,(P=o??t?.width)!==null&&P!==void 0?P:0,(T=h??t?.height)!==null&&T!==void 0?T:0],nt=[c,_],V=g,j=v),i=X[0],n=X[1];const ht=X[2],wt=X[3],gt=G(nt[0],nt[1]),At=G(nt[0]+V,nt[1]),Et=G(nt[0],nt[1]+j),B=G(nt[0]+V,nt[1]+j),z=t.width||V,Q=t.height||j,tt=i/z,Ht=n/Q,ot=(i+ht-.01)/z,vi=(n+wt-.01)/Q,Ji=R.getPosition(),St=Ji.add(B),at=Ji.x/this._context.width,ys=Ji.y/this._context.height,qr=St.x/this._context.width,ts=St.y/this._context.height;W[U++]=gt.x,W[U++]=gt.y,W[U++]=tt,W[U++]=Ht,W[U++]=at,W[U++]=ys,W[U++]=Et.x,W[U++]=Et.y,W[U++]=tt,W[U++]=vi,W[U++]=at,W[U++]=ts,W[U++]=At.x,W[U++]=At.y,W[U++]=ot,W[U++]=Ht,W[U++]=qr,W[U++]=ys,W[U++]=B.x,W[U++]=B.y,W[U++]=ot,W[U++]=vi,W[U++]=qr,W[U++]=ts;const Yr=this._addImageAsTexture(t);F.use(),this._layout.shader=M,this._layout.use(!0),M.trySetUniformFloat("u_time_ms",performance.now()),M.trySetUniformFloat("u_opacity",S),M.trySetUniformFloatVector("u_resolution",G(this._context.width,this._context.height)),M.trySetUniformFloatVector("u_graphic_resolution",G(z,Q)),M.trySetUniformFloatVector("u_size",G(ht,wt)),M.trySetUniformMatrix("u_matrix",this._context.ortho),M.trySetUniformMatrix("u_transform",R.to4x4()),I.activeTexture(I.TEXTURE0+0),I.bindTexture(I.TEXTURE_2D,Yr),M.trySetUniformInt("u_graphic",0),I.activeTexture(I.TEXTURE0+1),I.bindTexture(I.TEXTURE_2D,this._context.materialScreenTexture),M.trySetUniformInt("u_screen_texture",1),F.uploadAndBind(I),this._quads.bind(),I.drawElements(I.TRIANGLES,6,this._quads.bufferGlType,0),Zt.DrawnImagesCount++,Zt.DrawCallCount++}_addImageAsTexture(t){const i=t.getAttribute(Rt.Filtering),n=i?Vn(i):void 0,o=Mi(t.getAttribute(Rt.WrappingX)),h=Mi(t.getAttribute(Rt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);return t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&this._textures.push(_),_}hasPendingDraws(){return!1}flush(){}}const em=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,im=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var ke;(function(d){d.World="world",d.Screen="screen"})(ke||(ke={}));class Jh extends k{constructor(t){super(0,0),this._getX=t.getX,this._getY=t.getY,this._setX=t.setX,this._setY=t.setY}get x(){return this._x=this._getX()}set x(t){this._setX(t),this._x=t}get y(){return this._y=this._getY()}set y(t){this._setY(t),this._y=t}}class Fs extends k{constructor(t,i){super(t.x,t.y),this.original=t,this.change=i}get x(){return this._x=this.original.x}set x(t){t!==this._x&&(this.change(t,this._y),this._x=this.original.x=t)}get y(){return this._y=this.original.y}set y(t){t!==this._y&&(this.change(this._x,t),this._y=this.original.y=t)}setTo(t,i){this.x=t,this.y=i}}class ms{constructor(){this._parent=null,this._children=[],this._pos=new Fs(G(0,0),()=>{this.flagDirty()}),this._globalPos=new Jh({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:t=>{if(this.parent){const{x:i}=this.parent.inverse.multiply(G(t,this.pos.y));this.pos.x=i}else this.pos.x=t;t!==this.matrix.data[4]&&this.flagDirty()},setY:t=>{if(this.parent){const{y:i}=this.parent.inverse.multiply(G(this.pos.x,t));this.pos.y=i}else this.pos.y=t;t!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new Fs(G(1,1),()=>{this.flagDirty()}),this._globalScale=new Jh({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:t=>{if(this.parent){const i=this.parent.globalScale.x;this.scale.x=t/i}else this.scale.x=t},setY:t=>{if(this.parent){const i=this.parent.globalScale.y;this.scale.y=t/i}else this.scale.y=t}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=_e.identity(),this._inverse=_e.identity(),this._scratch=_e.identity()}get parent(){return this._parent}set parent(t){if(this._parent){const i=this._parent._children.indexOf(this);i>-1&&this._parent._children.splice(i,1)}this._parent=t,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(t){this._pos.x=t.x,this._pos.y=t.y}get pos(){return this._pos}set globalPos(t){let i=t.clone();this.parent&&(i=this.parent.inverse.multiply(t)),i.equals(this._pos)||(this._pos=i,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(t){const i=_s(t);i!==this._rotation&&this.flagDirty(),this._rotation=i}get rotation(){return this._rotation}set globalRotation(t){let i=0;this.parent&&(i=this.parent.globalRotation);const n=_s(t+i);n!==this._rotation&&this.flagDirty(),this._rotation=n}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(t){this._scale.x=t.x,this._scale.y=t.y}get scale(){return this._scale}set globalScale(t){let i=G(1,1);this.parent&&(i=this.parent.globalScale),this.scale=t.scale(G(1/i.x,1/i.y))}get globalScale(){return this._globalScale}set z(t){this._z=t,this.flagDirty()}get z(){return this._z}set globalZ(t){this.parent?this.z=t-this.parent.globalZ:this.z=t}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let t=0;t<this._children.length;t++)this._children[t].flagDirty()}apply(t){return this.matrix.multiply(t)}applyInverse(t){return this.inverse.multiply(t)}setTransform(t,i,n){this._pos.x=t.x,this._pos.y=t.y,this._rotation=_s(i),this._scale.x=n.x,this._scale.y=n.y,this.flagDirty()}isMirrored(){const t=Nt(this.scale.x)>>>31,i=Nt(this.scale.y)>>>31;return!!(t^i)}clone(t){const i=t??new ms;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.flagDirty(),i}cloneWithParent(t){const i=t??new ms;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.parent=this.parent,i.flagDirty(),i}toString(){return this.matrix.toString()}}function Ou(d){return!!d&&!!d.prototype&&!!d.prototype.constructor}function sm(d){return!!d?.clone}class gi{constructor(){this.owner=void 0}clone(){const t=new this.constructor;for(const i in this)if(this.hasOwnProperty(i)){const n=this[i];sm(n)&&i!=="owner"&&i!=="clone"?t[i]=n.clone():t[i]=n}return t}}class Ze{constructor(){this.observers=[],this.subscriptions=[]}register(t){this.observers.push(t)}subscribe(t){this.subscriptions.push(t)}unregister(t){const i=this.observers.indexOf(t);i!==-1&&this.observers.splice(i,1)}unsubscribe(t){const i=this.subscriptions.indexOf(t);i!==-1&&this.subscriptions.splice(i,1)}notifyAll(t){const i=this.observers.length;for(let o=0;o<i;o++)this.observers[o].notify(t);const n=this.subscriptions.length;for(let o=0;o<n;o++)this.subscriptions[o](t)}clear(){this.observers.length=0,this.subscriptions.length=0}}class st extends gi{constructor(){super(...arguments),this._logger=ct.getInstance(),this._parentComponent=null,this._transform=new ms,this._addChildTransform=t=>{const i=t.get(st);i&&(i._transform.parent=this._transform,i._parentComponent=this)},this.zIndexChanged$=new Ze,this._coordPlane=ke.World}get(){return this._transform}onAdd(t){for(const i of t.children)this._addChildTransform(i);t.childrenAdded$.subscribe(i=>this._addChildTransform(i)),t.childrenRemoved$.subscribe(i=>{const n=i.get(st);n&&(n._transform.parent=null,n._parentComponent=null)})}onRemove(t){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(t){const i=this._transform.z;this._transform.z=t,i!==t&&this.zIndexChanged$.notifyAll(t)}get globalZ(){return this._transform.globalZ}set globalZ(t){this._transform.globalZ=t}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(t){var i;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(i=this.owner)===null||i===void 0?void 0:i.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=t}get pos(){return this._transform.pos}set pos(t){this._transform.pos=t}get globalPos(){return this._transform.globalPos}set globalPos(t){this._transform.globalPos=t}get rotation(){return this._transform.rotation}set rotation(t){this._transform.rotation=t}get globalRotation(){return this._transform.globalRotation}set globalRotation(t){this._transform.globalRotation=t}get scale(){return this._transform.scale}set scale(t){this._transform.scale=t}get globalScale(){return this._transform.globalScale}set globalScale(t){this._transform.globalScale=t}applyInverse(t){return this._transform.applyInverse(t)}apply(t){return this._transform.apply(t)}clone(){const t=new st;return t._transform=this._transform.clone(),t}}var Ar;(function(d){d.Forward="forward",d.Backward="backward"})(Ar||(Ar={}));var Ti;(function(d){d.End="end",d.Loop="loop",d.PingPong="pingpong",d.Freeze="freeze"})(Ti||(Ti={}));const nm={Frame:"frame",Loop:"loop",End:"end"};class Ei extends se{constructor(t){var i,n,o;super(t),this.events=new Qt,this.frames=[],this.strategy=Ti.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=t.frames,this.speed=(i=t.speed)!==null&&i!==void 0?i:this.speed,this.strategy=(n=t.strategy)!==null&&n!==void 0?n:this.strategy,this.frameDuration=t.totalDuration?t.totalDuration/this.frames.length:(o=t.frameDuration)!==null&&o!==void 0?o:this.frameDuration,t.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new Ei({frames:this.frames.map(t=>({...t})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.width*this.scale.x):0}get height(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.height*this.scale.y):0}static fromSpriteSheet(t,i,n,o=Ti.Loop){const h=t.sprites.length-1,c=i.filter(_=>_<0||_>h);return c.length&&Ei._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${c.join(",")} no frame will be shown`),new Ei({frames:t.sprites.filter((_,g)=>i.indexOf(g)>-1).map(_=>({graphic:_,duration:n})),strategy:o})}static fromSpriteSheetCoordinates(t){var i;const{spriteSheet:n,frameCoordinates:o,durationPerFrame:h,durationPerFrameMs:c,speed:_,strategy:g,reverse:v}=t,x=(i=h??c)!==null&&i!==void 0?i:100,b=[];for(const P of o){const{x:T,y:I,duration:F,options:R}=P,S=n.getSprite(T,I,R);S?b.push({graphic:S,duration:F??x}):Ei._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${T}, ${I}), please check your SpriteSheet to confirm that sprite exists`)}return new Ei({frames:b,strategy:g,speed:_,reverse:v})}get speed(){return this._speed}set speed(t){this._speed=bt(Math.abs(t),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?Ar.Backward:Ar.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const t=this.frames[this._currentFrame];t&&(this._timeLeftInFrame=t?.duration||this.frameDuration)}get canFinish(){switch(this.strategy){case Ti.End:case Ti.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(t,i){this._currentFrame=t,this._timeLeftInFrame=i??this.frameDuration;const n=this.frames[this._currentFrame];n&&!this._done&&(this._timeLeftInFrame=i??(n?.duration||this.frameDuration),this.events.emit("frame",{...n,frameIndex:this.currentFrameIndex}))}_nextFrame(){const t=this._currentFrame;if(this._done)return t;let i=-1;switch(this.strategy){case Ti.Loop:{i=(t+1)%this.frames.length,i===0&&this.events.emit("loop",this);break}case Ti.End:{i=t+1,i>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case Ti.Freeze:{i=bt(t+1,0,this.frames.length-1),i>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case Ti.PingPong:{t+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),t+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),i=t+this._pingPongDirection%this.frames.length;break}}return i}tick(t,i=0){this._idempotencyToken!==i&&(this._idempotencyToken=i,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=t*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(t,i,n){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(t,i,n)}}Ei._LOGGER=ct.getInstance();class zn extends se{constructor(t){var i;super(t),this._logger=ct.getInstance(),this.useAnchor=!0,this.members=[],this.members=t.members,this.useAnchor=(i=t.useAnchor)!==null&&i!==void 0?i:this.useAnchor,this._updateDimensions()}clone(){return new zn({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const t=this.localBounds;return this.width=t.width,this.height=t.height,t}get localBounds(){const t=new lt;for(const i of this.members)if(i instanceof se)i.localBounds.combine(t,t);else{const{graphic:n,offset:o,useBounds:h}=i;n?(h===void 0?!0:h)&&n.localBounds.translate(o).combine(t,t):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(i)}.`)}return t}_isAnimationOrGroup(t){return t instanceof Ei||t instanceof zn}tick(t,i){for(const n of this.members){let o;n instanceof se?o=n:o=n.graphic,this._isAnimationOrGroup(o)&&o.tick(t,i)}}reset(){for(const t of this.members){let i;t instanceof se?i=t:i=t.graphic,this._isAnimationOrGroup(i)&&i.reset()}}_preDraw(t,i,n){this._updateDimensions(),super._preDraw(t,this.useAnchor?i:0,this.useAnchor?n:0)}_drawImage(t,i,n){const o=k.Zero;for(const h of this.members){let c;h instanceof se?c=h:(c=h.graphic,h.offset.clone(o)),c&&(t.save(),t.translate(i,n),c.draw(t,o.x,o.y),this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore())}}}class Xn extends se{constructor(t){var i,n,o,h,c,_,g,v,x,b;super(Mu({...t},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=Ii(K.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,t&&(this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this.color=(n=t.color)!==null&&n!==void 0?n:K.Black,this.strokeColor=t?.strokeColor,this.smoothing=(o=t.smoothing)!==null&&o!==void 0?o:this.smoothing,this.lineWidth=(h=t.lineWidth)!==null&&h!==void 0?h:this.lineWidth,this.lineDash=(c=t.lineDash)!==null&&c!==void 0?c:this.lineDash,this.lineCap=(_=t.lineCap)!==null&&_!==void 0?_:this.lineCap,this.padding=(g=t.padding)!==null&&g!==void 0?g:this.padding,this.filtering=(v=t.filtering)!==null&&v!==void 0?v:this.filtering),this._bitmap=document.createElement("canvas");const P=(x=t?.width)!==null&&x!==void 0?x:this._bitmap.width,T=(b=t?.height)!==null&&b!==void 0?b:this._bitmap.height;this.width=P,this.height=T;const I=this._bitmap.getContext("2d");if(I)this._ctx=I;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(t){t/=Math.abs(this.scale.x),this._bitmap.width=t,this._originalWidth=t,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(t){t/=Math.abs(this.scale.y),this._bitmap.height=t,this._originalHeight=t,this.flagDirty()}_getTotalWidth(){var t;return(((t=this._originalWidth)!==null&&t!==void 0?t:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var t;return(((t=this._originalHeight)!==null&&t!==void 0?t:this._bitmap.height)+this.padding*2)*1}get localBounds(){return lt.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,k.Zero)}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this.flagDirty()}get color(){return this._color}set color(t){this.flagDirty(),this._color=Ii(t,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(t){this.flagDirty(),t&&(this._strokeColor=Ii(t,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(t){this._lineDash=t,this.flagDirty()}get padding(){return this._padding}set padding(t){this._padding=t,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(t){var i,n,o,h;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),t.scale(this.quality,this.quality),t.translate(this.padding,this.padding),t.imageSmoothingEnabled=this.smoothing,t.lineWidth=this.lineWidth,t.setLineDash((i=this.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.lineCap=this.lineCap,t.strokeStyle=(o=(n=this.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&o!==void 0?o:"",t.fillStyle=(h=this.color)===null||h===void 0?void 0:h.toString()}_drawImage(t,i,n){this._dirty&&this.rasterize(),t.scale(1/this.quality,1/this.quality),t.drawImage(this._bitmap,i,n)}}var Wo;(function(d){d.Em="em",d.Rem="rem",d.Px="px",d.Pt="pt",d.Percent="%"})(Wo||(Wo={}));var No;(function(d){d.Left="left",d.Right="right",d.Center="center",d.Start="start",d.End="end"})(No||(No={}));var Go;(function(d){d.Top="top",d.Hanging="hanging",d.Middle="middle",d.Alphabetic="alphabetic",d.Ideographic="ideographic",d.Bottom="bottom"})(Go||(Go={}));var Vo;(function(d){d.Normal="normal",d.Italic="italic",d.Oblique="oblique"})(Vo||(Vo={}));var Xo;(function(d){d.LeftToRight="ltr",d.RightToLeft="rtl"})(Xo||(Xo={}));function tl(d,t=K.Red,i,n,o,h,c=1,_="butt"){d.save(),d.beginPath(),d.lineWidth=c,d.lineCap=_,d.strokeStyle=t.toString(),d.moveTo(i,n),d.lineTo(o,h),d.closePath(),d.stroke(),d.restore()}function rm(d,t=K.Red,i){d.beginPath(),d.strokeStyle=t.toString(),d.arc(i.x,i.y,5,0,Math.PI*2),d.closePath(),d.stroke()}function om(d,t,i,n,o=1){const h=t?t.toString():"blue",c=n.scale(o);d.beginPath(),d.strokeStyle=h,d.moveTo(i.x,i.y),d.lineTo(i.x+c.x,i.y+c.y),d.closePath(),d.stroke()}function el(d,t,i,n,o,h=5,c=K.White,_=null){let g;if(typeof h=="number")g={tl:h,tr:h,br:h,bl:h};else{const v={tl:0,tr:0,br:0,bl:0};for(const x in v)if(v.hasOwnProperty(x)){const b=x;g[b]=h[b]||v[b]}}d.beginPath(),d.moveTo(t+g.tl,i),d.lineTo(t+n-g.tr,i),d.quadraticCurveTo(t+n,i,t+n,i+g.tr),d.lineTo(t+n,i+o-g.br),d.quadraticCurveTo(t+n,i+o,t+n-g.br,i+o),d.lineTo(t+g.bl,i+o),d.quadraticCurveTo(t,i+o,t,i+o-g.bl),d.lineTo(t,i+g.tl),d.quadraticCurveTo(t,i,t+g.tl,i),d.closePath(),_&&(d.fillStyle=_.toString(),d.fill()),c&&(d.strokeStyle=c.toString(),d.stroke())}function am(d,t,i,n,o=K.White,h=null){d.beginPath(),d.arc(t,i,n,0,Math.PI*2),d.closePath(),h&&(d.fillStyle=h.toString(),d.fill()),o&&(d.strokeStyle=o.toString(),d.stroke())}class kn{constructor(t,i,n,o){this.font=t,this.text=i,this.color=n,this.maxWidth=o,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const h=this.canvas.getContext("2d");if(!h)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=h,this.dimensions=this.measureText(i),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(t,i){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let n=null;i!=null?n=this._getLinesFromText(t,i):n=t.split(`
`);const o=n.reduce((P,T)=>P.length>T.length?P:T);this._applyFont(this.ctx);const h=this.ctx.measureText(o);let c=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);const _=c*n.length;c=_;const g=_-Math.abs(h.actualBoundingBoxAscent),v=0,x=0;return new lt({left:v-Math.abs(h.actualBoundingBoxLeft)-this.font.padding,top:x-Math.abs(h.actualBoundingBoxAscent)-this.font.padding,bottom:x+g+this.font.padding,right:v+Math.abs(h.actualBoundingBoxRight)+this.font.padding})}_setDimension(t,i){let n=1;this.font.lineHeight&&(n=this.font.lineHeight/this.font.size),i.canvas.width=(t.width+this.font.padding*2)*2*this.font.quality,i.canvas.height=(t.height+this.font.padding*2)*2*this.font.quality*n}static getHashCode(t,i,n){var o;return i+"__hashcode__"+t.fontString+t.showDebug+t.textAlign+t.baseAlign+t.direction+t.lineHeight+JSON.stringify(t.shadow)+(t.padding.toString()+t.smoothing.toString()+t.lineWidth.toString()+t.lineDash.toString()+((o=t.strokeColor)===null||o===void 0?void 0:o.toString())+(n?n.toString():t.color.toString()))}getHashCode(t=!0){return kn.getHashCode(this.font,this.text,t?this.color:void 0)}_applyRasterProperties(t){var i,n,o;t.translate(this.font.padding,this.font.padding),t.imageSmoothingEnabled=this.font.smoothing,t.lineWidth=this.font.lineWidth,t.setLineDash((i=this.font.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.strokeStyle=(o=(n=this.font.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&o!==void 0?o:"",t.fillStyle=this.color.toString()}_applyFont(t){t.resetTransform(),t.translate(this.font.padding+t.canvas.width/2,this.font.padding+t.canvas.height/2),t.scale(this.font.quality,this.font.quality),t.textAlign=this.font.textAlign,t.textBaseline=this.font.baseAlign,t.font=this.font.fontString,t.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(t.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(t.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(t.shadowOffsetX=this.font.shadow.offset.x,t.shadowOffsetY=this.font.shadow.offset.y))}_drawText(t,i,n){this._applyRasterProperties(t),this._applyFont(t);for(let o=0;o<i.length;o++){const h=i[o];this.color&&t.fillText(h,0,o*n),this.font.strokeColor&&t.strokeText(h,0,o*n)}this.font.showDebug&&(tl(t,K.Green,-t.canvas.width/2,0,t.canvas.width/2,0,2),tl(t,K.Red,0,-t.canvas.height/2,0,t.canvas.height/2,2))}_splitTextBitmap(t){const i=[];let n=0,o=0;const h=Math.min(4096,t.canvas.width),c=Math.min(4096,t.canvas.height);for(;n<t.canvas.width;){for(;o<t.canvas.height;){const _=document.createElement("canvas");_.width=h,_.height=c;const g=_.getContext("2d");if(!g)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");g.drawImage(t.canvas,n,o,h,c,0,0,h,c),i.push({x:n,y:o,canvas:_}),o+=c}n+=h,o=0}return i}flagDirty(){this._dirty=!0}render(t,i,n,o){var h;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=t;const c=this.getHashCode();if(this._lastHashCode!==c&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,o),this._setDimension(this.dimensions,this.ctx);const _=this._getLinesFromText(this.text,o),g=(h=this.font.lineHeight)!==null&&h!==void 0?h:this.dimensions.height/_.length;if(this._drawText(this.ctx,_,g),t instanceof ps)for(const v of this._textFragments)t.textureLoader.delete(v.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),t instanceof ps)for(const v of this._textFragments)t.textureLoader.load(v.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=c,this._dirty=!1}for(const _ of this._textFragments)t.drawImage(_.canvas,0,0,_.canvas.width,_.canvas.height,_.x/this.font.quality+i-this.ctx.canvas.width/this.font.quality/2,_.y/this.font.quality+n-this.ctx.canvas.height/this.font.quality/2,_.canvas.width/this.font.quality,_.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof ps)for(const t of this._textFragments)this._ex.textureLoader.delete(t.canvas);this._textFragments.length=0}_getLinesFromText(t,i){var n;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let c=o[h],_="";if(this.measureText(c).width>i){for(;this.measureText(c).width>i;)_=c[c.length-1]+_,c=c.slice(0,-1);o[h]=c,o[h+1]=_}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class Lt{static measureText(t,i,n){const o=kn.getHashCode(i,t);if(Lt._MEASURE_CACHE.has(o))return Lt._MEASURE_CACHE.get(o);Lt._LOGGER.debug("Font text measurement cache miss");const h=i.measureTextWithoutCache(t,n);return Lt._MEASURE_CACHE.set(o,h),h}static getTextInstance(t,i,n){const o=kn.getHashCode(i,t,n);let h=Lt._TEXT_CACHE.get(o);return h||(h=new kn(i,t,n),Lt._TEXT_CACHE.set(o,h),Lt._LOGGER.debug("Font text instance cache miss")),Lt._TEXT_USAGE.set(h,performance.now()),h}static checkAndClearCache(){const t=[],i=new Set;for(const[o,h]of Lt._TEXT_USAGE.entries())if(h+Lt.FONT_TIMEOUT<performance.now())Lt._LOGGER.debug(`Text cache entry timed out ${o.text}`),t.push(o),o.dispose();else{const c=o.getHashCode(!1);i.add(c)}t.forEach(o=>{Lt._TEXT_USAGE.delete(o)}),this._TEXT_CACHE.clear();for(const[o]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(o.getHashCode(),o);const n=new Map;for(const o of i)Lt._MEASURE_CACHE.has(o)&&n.set(o,Lt._MEASURE_CACHE.get(o));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=n}static get cacheSize(){return Lt._TEXT_USAGE.size}static clearCache(){for(const[t]of Lt._TEXT_USAGE.entries())t.dispose();Lt._TEXT_USAGE.clear(),Lt._TEXT_CACHE.clear(),Lt._MEASURE_CACHE.clear()}}Lt.FONT_TIMEOUT=500;Lt._LOGGER=ct.getInstance();Lt._TEXT_USAGE=new Map;Lt._TEXT_CACHE=new Map;Lt._MEASURE_CACHE=new Map;class fn extends se{constructor(t={}){var i,n,o,h,c,_,g,v,x,b,P,T,I,F,R,S,M,W,U,V;super(t),this.filtering=ge.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=K.Black,this.family="sans-serif",this.style=Vo.Normal,this.bold=!1,this.unit=Wo.Px,this.textAlign=No.Left,this.baseAlign=Go.Top,this.direction=Xo.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new lt,this._textMeasurement=new kn(this,"",K.Black),this.smoothing=(i=t?.smoothing)!==null&&i!==void 0?i:this.smoothing,this.padding=(n=t?.padding)!==null&&n!==void 0?n:this.padding,this.color=(o=t?.color)!==null&&o!==void 0?o:this.color,this.strokeColor=(h=t?.strokeColor)!==null&&h!==void 0?h:this.strokeColor,this.lineDash=(c=t?.lineDash)!==null&&c!==void 0?c:this.lineDash,this.lineWidth=(_=t?.lineWidth)!==null&&_!==void 0?_:this.lineWidth,this.filtering=(g=t?.filtering)!==null&&g!==void 0?g:this.filtering,this.family=(v=t?.family)!==null&&v!==void 0?v:this.family,this.style=(x=t?.style)!==null&&x!==void 0?x:this.style,this.bold=(b=t?.bold)!==null&&b!==void 0?b:this.bold,this.size=(P=t?.size)!==null&&P!==void 0?P:this.size,this.unit=(T=t?.unit)!==null&&T!==void 0?T:this.unit,this.textAlign=(I=t?.textAlign)!==null&&I!==void 0?I:this.textAlign,this.baseAlign=(F=t?.baseAlign)!==null&&F!==void 0?F:this.baseAlign,this.direction=(R=t?.direction)!==null&&R!==void 0?R:this.direction,this.lineHeight=(S=t?.lineHeight)!==null&&S!==void 0?S:this.lineHeight,this.quality=(M=t?.quality)!==null&&M!==void 0?M:this.quality,t?.shadow&&(this.shadow={},this.shadow.blur=(W=t.shadow.blur)!==null&&W!==void 0?W:this.shadow.blur,this.shadow.offset=(U=t.shadow.offset)!==null&&U!==void 0?U:this.shadow.offset,this.shadow.color=(V=t.shadow.color)!==null&&V!==void 0?V:this.shadow.color)}clone(){return new fn({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(t,i,n){}_rotate(t){var i;const n=(i=this.origin)!==null&&i!==void 0?i:this._textBounds.center;t.translate(n.x,n.y),t.rotate(this.rotation),t.translate(-n.x,-n.y)}_flip(t){this.flipHorizontal&&(t.translate(this._textBounds.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,-this._textBounds.height/2/this.scale.y),t.scale(1,-1))}measureTextWithoutCache(t,i){return this._textMeasurement.measureText(t,i)}measureText(t,i){return Lt.measureText(t,this,i)}_postDraw(t){t.restore()}render(t,i,n,o,h,c){const _=Lt.getTextInstance(i,this,n);this._textBounds=_.dimensions,this._preDraw(t,o,h),_.render(t,o,h,c),this._postDraw(t)}}class Or extends se{constructor(t){var i,n;super(t),this._text="",this._textWidth=0,this._textHeight=0,this.font=(i=t.font)!==null&&i!==void 0?i:new fn,this.color=(n=t.color)!==null&&n!==void 0?n:this.color,this.text=t.text,this.maxWidth=t.maxWidth}clone(){var t,i;return new Or({text:this.text.slice(),color:(i=(t=this.color)===null||t===void 0?void 0:t.clone())!==null&&i!==void 0?i:K.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(t){this._text=t,this._calculateDimension()}get font(){return this._font}set font(t){this._font=t}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:t,height:i}=this.font.measureText(this._text,this.maxWidth);this._textWidth=t,this._textHeight=i}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(t){}_flip(t){}_preDraw(t,i,n){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(t,i,n)}_drawImage(t,i,n){var o;let h=K.Black;this.font instanceof fn&&(h=(o=this.color)!==null&&o!==void 0?o:this.font.color);const{width:c,height:_}=this.font.measureText(this._text,this.maxWidth);this._textWidth=c,this._textHeight=_,this.font.render(t,this._text,h,i,n,this.maxWidth),this.font.showDebug&&(t.debug.drawRect(i-c,n-_,c*2,_*2),this.maxWidth!=null&&t.debug.drawRect(i,n,this.maxWidth,this.height,{color:K.Yellow}))}}function Tl(d){return!!d.tick}class ne extends gi{get visible(){return this.isVisible}set visible(t){this.isVisible=t}get offset(){return this._offset}set offset(t){this._offset=new Fs(t,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(t){this._anchor=new Fs(t,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(t){if(t){this._color=t.clone();const i=this.graphics.current;(i instanceof Xn||i instanceof Or)&&(i.color=this._color)}}constructor(t){super(),this._logger=ct.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new Fs(k.Zero,()=>this.recalculateBounds()),this._anchor=new Fs(k.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,t={visible:this.isVisible,graphics:{},...t};const{current:i,anchor:n,color:o,opacity:h,visible:c,graphics:_,offset:g,copyGraphics:v,onPreDraw:x,onPostDraw:b,onPreTransformDraw:P,onPostTransformDraw:T}=t;for(const[I,F]of Object.entries(_))F instanceof se?this._graphics[I]=F:(this._graphics[I]=F.graphic,this._options[I]=F.options);this.offset=g??this.offset,this.opacity=h??this.opacity,this.anchor=n??this.anchor,this.color=o??this.color,this.copyGraphics=v??this.copyGraphics,this.onPreDraw=x??this.onPreDraw,this.onPostDraw=b??this.onPostDraw,this.onPreDraw=P??this.onPreTransformDraw,this.onPostTransformDraw=T??this.onPostTransformDraw,this.isVisible=!!c,this._current=i??this._current,i&&this._graphics[i]&&this.use(i)}getGraphic(t){return this._graphics[t]}getOptions(t){return this._options[t]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(t,i,n){let o="default",h=null,c;if(typeof t=="string"&&i instanceof se&&(o=t,h=i,c=n),t instanceof se&&!(i instanceof se)&&(h=t,c=i),!h)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[o]=this.copyGraphics?h.clone():h,this._options[o]=this.copyGraphics?{...c}:c,o==="default"&&this.use("default"),h}remove(t){delete this._graphics[t],delete this._options[t],this._current===t&&(this._current="default",this.recalculateBounds())}use(t,i){var n;if(t instanceof se){let o=t;this.copyGraphics&&(o=t.clone()),this._current="default",this._graphics[this._current]=o,this._options[this._current]=i}else this._current=t,this._options[this._current]=i,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(n=this.owner)===null||n===void 0?void 0:n.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(t){this._localBounds=t}recalculateBounds(){let t=new lt;const i=this._graphics[this._current],n=this._options[this._current];if(!i){this._localBounds=t;return}let o=this.anchor,h=this.offset;n?.anchor&&(o=n.anchor),n?.offset&&(h=n.offset);const c=i.localBounds,_=-c.width*o.x+h.x,g=-c.height*o.y+h.y;i instanceof zn&&!i.useAnchor?t=i?.localBounds.combine(t):t=i?.localBounds.translate(G(_,g)).combine(t),this._localBounds=t}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let t=this.localBounds;if(this.owner){const i=this.owner.get(st);i&&(t=t.transform(i.get().matrix))}return t}update(t,i=0){const n=this.current;n&&Tl(n)&&n.tick(t,i)}clone(){const t=new ne;return t._graphics={...this._graphics},t._options={...this._options},t.offset=this.offset.clone(),this.color&&(t.color=this.color.clone()),t.opacity=this.opacity,t.anchor=this.anchor.clone(),t.copyGraphics=this.copyGraphics,t.onPreDraw=this.onPreDraw,t.onPostDraw=this.onPostDraw,t.isVisible=this.isVisible,t}}var qo;(function(d){d.Kill="kill",d.PreKill="prekill",d.PostKill="postkill",d.PreDraw="predraw",d.PostDraw="postdraw",d.PreDebugDraw="predebugdraw",d.PostDebugDraw="postdebugdraw",d.PreUpdate="preupdate",d.PostUpdate="postupdate",d.PreFrame="preframe",d.PostFrame="postframe",d.PreCollision="precollision",d.CollisionStart="collisionstart",d.CollisionEnd="collisionend",d.PostCollision="postcollision",d.Initialize="initialize",d.Activate="activate",d.Deactivate="deactivate",d.ExitViewport="exitviewport",d.EnterViewport="enterviewport",d.ExitTrigger="exit",d.EnterTrigger="enter",d.Connect="connect",d.Disconnect="disconnect",d.Button="button",d.Axis="axis",d.Visible="visible",d.Hidden="hidden",d.Start="start",d.Stop="stop",d.PointerUp="pointerup",d.PointerDown="pointerdown",d.PointerMove="pointermove",d.PointerEnter="pointerenter",d.PointerLeave="pointerleave",d.PointerCancel="pointercancel",d.PointerWheel="pointerwheel",d.Up="up",d.Down="down",d.Move="move",d.Enter="enter",d.Leave="leave",d.Cancel="cancel",d.Wheel="wheel",d.Press="press",d.Release="release",d.Hold="hold",d.PointerDragStart="pointerdragstart",d.PointerDragEnd="pointerdragend",d.PointerDragEnter="pointerdragenter",d.PointerDragLeave="pointerdragleave",d.PointerDragMove="pointerdragmove",d.ActionStart="actionstart",d.ActionComplete="actioncomplete",d.Add="add",d.Remove="remove"})(qo||(qo={}));class vt{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(t){this._bubbles=t}stopPropagation(){this.bubbles=!1}}class na extends vt{constructor(t){super(),this.self=t,this.target=t}}class Sl extends vt{constructor(t){super(),this.self=t,this.target=t}}class El extends vt{constructor(t){super(),this.self=t,this.target=t}}class Il extends vt{constructor(t){super(),this.self=t,this.target=t}}class Rl extends vt{constructor(t){super(),this.self=t,this.target=t}}class qn extends vt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class Yn extends vt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class Dl extends vt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class Ml extends vt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class Fl extends vt{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class Bl extends vt{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class Us extends vt{constructor(t,i,n){super(),this.engine=t,this.elapsed=i,this.self=n,this.target=n}}class zs extends vt{constructor(t,i,n){super(),this.engine=t,this.elapsed=i,this.self=n,this.target=n}}class kl extends vt{constructor(t,i){super(),this.engine=t,this.prevStats=i,this.target=t}}class Ll extends vt{constructor(t,i){super(),this.engine=t,this.stats=i,this.target=t}}class Ul extends vt{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class zl extends vt{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class Hl extends vt{constructor(t,i,n,o){super(),this.button=t,this.index=i,this.value=n,this.self=o,this.target=o}}class Ol extends vt{constructor(t,i,n){super(),this.axis=t,this.value=i,this.self=n,this.target=n}}class Wl extends vt{constructor(t){super(),this.self=t,this.target=t}}class Nl extends vt{constructor(t){super(),this.self=t,this.target=t}}class _n extends vt{constructor(t,i,n,o,h){super(),this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h,this.target=t}}class pn extends vt{constructor(t,i,n,o,h){super(),this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h,this.target=t}}class Yo{constructor(t,i,n,o){this.self=t,this.other=i,this.side=n,this.contact=o}}class jo{constructor(t,i,n,o){this.self=t,this.other=i,this.side=n,this.lastContact=o}}class Zo{constructor(t,i,n,o,h){this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h}}class Qo{constructor(t,i,n,o,h){this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h}}class Cr extends vt{constructor(t,i,n,o){super(),this.self=t,this.other=i,this.side=n,this.contact=o,this.target=t}}class Pr extends vt{constructor(t,i,n,o){super(),this.self=t,this.other=i,this.side=n,this.lastContact=o,this.target=t}}class jn extends vt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class Gl extends vt{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class Vl extends vt{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class Xl extends vt{constructor(t){super(),this.self=t,this.target=t}}class ql extends vt{constructor(t){super(),this.self=t,this.target=t}}class Yl extends vt{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class jl extends vt{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class Zl extends vt{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class Ql extends vt{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class $l extends vt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class Kl extends vt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class hm{constructor(t){this.data=t,this.type="Component Added"}}function lm(d){return!!d&&d.type==="Component Added"}class cm{constructor(t){this.data=t,this.type="Component Removed"}}function dm(d){return!!d&&d.type==="Component Removed"}const um={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class Ge{constructor(t,i){this.id=Ge._ID++,this.name=`Entity#${this.id}`,this.events=new Qt,this._tags=new Set,this.componentAdded$=new Ze,this.componentRemoved$=new Ze,this.tagAdded$=new Ze,this.tagRemoved$=new Ze,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new Ze,this.childrenRemoved$=new Ze,this._children=[],this._isInitialized=!1,this._isAdded=!1;let n,o;if(Array.isArray(t))n=t,o=i;else if(t&&typeof t=="object"){const{components:h,name:c,silenceWarnings:_}=t;n=h??[],o=c}if(o&&(this.name=o),n)for(const h of n)this.addComponent(h)}get active(){return this.isActive}set active(t){this.isActive=t}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new na(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(t){return this._tags.has(t)}addTag(t){return this._tags.add(t),this.tagAdded$.notifyAll(t),this}removeTag(t){return this._tags.delete(t),this.tagRemoved$.notifyAll(t),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(t){for(let i=0;i<t.length;i++)if(!this.components.has(t[i]))return!1;return!0}hasAllTags(t){for(let i=0;i<t.length;i++)if(!this.tags.has(t[i]))return!1;return!0}get(t){return this.components.get(t)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(t){if(t.parent===null){if(this.getAncestors().includes(t))throw new Error("Cycle detected, cannot add entity");this._children.push(t),t._parent=this,this.childrenAdded$.notifyAll(t)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(t){return t.parent===this&&(Gn(t,this._children),t._parent=null,this.childrenRemoved$.notifyAll(t)),this}removeAllChildren(){for(let t=this.children.length-1;t>=0;t--)this.removeChild(this.children[t]);return this}getAncestors(){const t=[this];let i=this.parent;for(;i;)t.push(i),i=i.parent;return t.reverse()}getDescendants(){let t=[this],i=[this];for(;i.length>0;){const n=i.pop();n&&(i=i.concat(n.children),t=t.concat(n.children))}return t}clone(){const t=new Ge;for(const i of this.types){const n=this.get(i);n&&t.addComponent(n.clone())}for(const i of this.children)t.addChild(i.clone());return t}addTemplate(t,i=!1){for(const n of t.getComponents())this.addComponent(n.clone(),i);for(const n of t.children)this.addChild(n.clone().addTemplate(n));return this}_getClassHierarchyRoot(t){var i,n;let o=t,h=(i=Object.getPrototypeOf(o.prototype))===null||i===void 0?void 0:i.constructor;for(;h&&h!==Object&&h!==gi;)o=h,h=(n=Object.getPrototypeOf(o.prototype))===null||n===void 0?void 0:n.constructor;return o}addComponent(t,i=!1){if(this.has(t.constructor))if(i)this.removeComponent(t.constructor,!0);else return this;if(t.dependencies&&t.dependencies.length)for(const o of t.dependencies)this.addComponent(new o);t.owner=this;const n=this._getClassHierarchyRoot(t.constructor);return this.components.set(n,t),this.components.set(t.constructor,t),this.componentValues.push(t),t.onAdd&&t.onAdd(this),this.componentAdded$.notifyAll(t),this}removeComponent(t,i=!1){let n;if(Ou(t)?n=t:n=t.constructor,i){const o=this.components.get(n);if(o){this.componentRemoved$.notifyAll(o),o.owner=void 0,o.onRemove&&o.onRemove(this);const c=this.componentValues.indexOf(o);c>-1&&this.componentValues.splice(c,1)}const h=this._getClassHierarchyRoot(n);this.components.delete(h),this.components.delete(n)}else this._componentsToRemove.push(n);return this}clearComponents(){const t=this.types;for(const i of t)this.removeComponent(i)}processComponentRemoval(){for(const t of this._componentsToRemove)this.removeComponent(t,!0);this._componentsToRemove.length=0}has(t){return this.components.has(t)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(t){this.isInitialized||(this.onInitialize(t),this.events.emit("initialize",new jn(t,this)),this._isInitialized=!0)}_add(t){!this.isAdded&&this.isActive&&(this.onAdd(t),this.events.emit("add",new $l(t,this)),this._isAdded=!0)}_remove(t){this.isAdded&&!this.isActive&&(this.onRemove(t),this.events.emit("remove",new Kl(t,this)),this._isAdded=!1)}_preupdate(t,i){this.events.emit("preupdate",new Us(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new zs(t,i,this)),this.onPostUpdate(t,i)}onInitialize(t){}onAdd(t){}onRemove(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i);for(const n of this.children)n.update(t,i);this._postupdate(t,i),this._remove(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}Ge._ID=0;class Mt extends gi{constructor(){super(...arguments),this.vel=k.Zero,this.acc=k.Zero,this.scaleFactor=k.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class je{static integrate(t,i,n,o){const h=o/1e3;i.vel.addEqual(n.scale(h,je._ACC)),t.pos.add(i.vel.scale(h,je._VEL),je._POS).addEqual(n.scale(.5*h*h,je._VEL_ACC)),i.angularVelocity+=i.torque*(1/i.inertia)*h;const c=t.rotation+i.angularVelocity*h;t.scale.add(i.scaleFactor.scale(h,this._SCALE_FACTOR),je._SCALE),t.get().setTransform(je._POS,c,je._SCALE)}}je._POS=new k(0,0);je._SCALE=new k(1,1);je._ACC=new k(0,0);je._VEL=new k(0,0);je._VEL_ACC=new k(0,0);je._SCALE_FACTOR=new k(0,0);class ra extends Ge{constructor(t){super({silenceWarnings:!0}),this.beginColor=K.White,this.endColor=K.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=K.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=Fi.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new st),this.addComponent(this.motion=new Mt),this.addComponent(this.graphics=new ne),this.configure(t)}registerEmitter(t){if(this._emitter=t,this.particleTransform===Fi.Global){const i=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(i),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(t){var i,n,o,h,c,_,g,v,x,b,P,T,I,F;this.particleTransform=(i=t.transform)!==null&&i!==void 0?i:this.particleTransform,this.life=(n=t.life)!==null&&n!==void 0?n:this.life,this.fade=(o=t.fade)!==null&&o!==void 0?o:this.fade,this.size=(h=t.size)!==null&&h!==void 0?h:this.size,this.endColor=(c=t.endColor)!==null&&c!==void 0?c:this.endColor.clone(),this.beginColor=(_=t.beginColor)!==null&&_!==void 0?_:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=t.graphic,this.graphics.opacity=(g=t.opacity)!==null&&g!==void 0?g:this.graphics.opacity,this.transform.pos=(v=t.pos)!==null&&v!==void 0?v:this.transform.pos,this.transform.rotation=(x=t.rotation)!==null&&x!==void 0?x:0,this.transform.scale=G(1,1),this.motion.vel=(b=t.vel)!==null&&b!==void 0?b:this.motion.vel,this.motion.angularVelocity=(P=t.angularVelocity)!==null&&P!==void 0?P:0,this.motion.acc=(T=t.acc)!==null&&T!==void 0?T:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(I=t.startSize)!==null&&I!==void 0?I:0,this.endSize=(F=t.endSize)!==null&&F!==void 0?F:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=lt.fromDimension(this.size,this.size,k.Half),this.graphics.onPostDraw=R=>{R.save(),R.debug.drawPoint(G(0,0),{color:this._currentColor,size:this.size}),R.restore()})}kill(){var t;!((t=this._emitter)===null||t===void 0)&&t.isActive?this._emitter.removeParticle(this):super.kill()}update(t,i){this.life=this.life-i,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=bt(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=bt(this.sizeRate*i+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=bt(this._currentColor.r+this._rRate*i,0,255),this._currentColor.g=bt(this._currentColor.g+this._gRate*i,0,255),this._currentColor.b=bt(this._currentColor.b+this._bRate*i,0,255),this._currentColor.a=this.graphics.opacity;let n=this.motion.acc;this.focus&&(n=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(i/1e3)),je.integrate(this.transform,this.motion,n,i)}}ra.DefaultConfig={beginColor:K.White,endColor:K.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var Fi;(function(d){d.Global="global",d.Local="local"})(Fi||(Fi={}));class Wu{constructor(){this.type="ex.particle",this.priority=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new si({gl:t,vertexSource:em,fragmentSource:im,onPreLink:n=>{t.transformFeedbackVaryings(n,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],t.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(t){const i=t.getAttribute(Rt.Filtering),n=i?Vn(i):void 0,o=Mi(t.getAttribute(Rt.WrappingX)),h=Mi(t.getAttribute(Rt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);return t.removeAttribute("forceUpload"),_}draw(t,i){var n,o,h,c,_,g,v,x,b;const P=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const T=t.particle.transform===Fi.Local?this._context.getTransform():this._context.getTransform().multiply(t.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",T),this._shader.setUniformBoolean("fade",!!t.particle.fade),this._shader.setUniformBoolean("useTexture",!!t.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(n=t.particle.life)!==null&&n!==void 0?n:2e3),this._shader.setUniformFloat("deltaMs",i),this._shader.setUniformFloatVector("gravity",(o=t.particle.acc)!==null&&o!==void 0?o:G(0,0)),this._shader.setUniformFloatColor("beginColor",(h=t.particle.beginColor)!==null&&h!==void 0?h:K.Transparent),this._shader.setUniformFloatColor("endColor",(c=t.particle.endColor)!==null&&c!==void 0?c:K.Transparent);let I=(_=t.particle.startSize)!==null&&_!==void 0?_:0,F=(g=t.particle.endSize)!==null&&g!==void 0?g:0;const R=(v=t.particle.size)!==null&&v!==void 0?v:0;if(R>0&&(I=R,F=R),this._shader.setUniformFloat("startSize",I??10),this._shader.setUniformFloat("endSize",F??10),this._shader.setUniformFloat("startOpacity",(x=t.particle.opacity)!==null&&x!==void 0?x:1),t.particle.focus&&(this._shader.setUniformFloatVector("focus",t.particle.focus),this._shader.setUniformFloat("focusAccel",(b=t.particle.focusAccel)!==null&&b!==void 0?b:0)),t.particle.graphic){const S=t.particle.graphic,M=this._getTexture(S.image.image);P.activeTexture(P.TEXTURE0),P.bindTexture(P.TEXTURE_2D,M),this._shader.setUniformInt("graphic",0)}t.draw(P)}hasPendingDraws(){return!1}flush(){}dispose(){}}const fm=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,_m=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class pm{constructor(t){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=K.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=Pl(t,n);this._maxTextures=Math.min(n,o);const h=this._transformFragmentSource(fm,this._maxTextures);this._shader=new si({gl:t,fragmentSource:h,vertexSource:_m}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((b,P)=>P)),this._vao=t.createVertexArray(),t.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._meshBuffer),t.bufferData(t.ARRAY_BUFFER,this._quadMesh,t.STATIC_DRAW),t.vertexAttribPointer(0,2,t.FLOAT,!1,16,0),t.enableVertexAttribArray(0),t.vertexAttribPointer(1,2,t.FLOAT,!1,16,8),t.enableVertexAttribArray(1),t.bindBuffer(t.ARRAY_BUFFER,null);const c=this._components;this._transformData=new Qi({gl:t,size:c*this._maxImages,type:"dynamic"}),this._transformData.bind();let _=0,g=2;const v=4,x=c*4;t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(2),_+=2*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(3),_+=2*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(4),_+=2*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(5),_+=2*v,t.vertexAttribPointer(g++,1,t.FLOAT,!1,x,_),t.enableVertexAttribArray(6),_+=1*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(7),_+=2*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(8),_+=2*v,t.vertexAttribPointer(g++,1,t.FLOAT,!1,x,_),t.enableVertexAttribArray(9),_+=1*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(10),_+=2*v,t.vertexAttribPointer(g++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(11),_+=2*v,t.vertexAttribPointer(g++,4,t.FLOAT,!1,x,_),t.enableVertexAttribArray(12),_+=4*v,t.vertexAttribDivisor(2,1),t.vertexAttribDivisor(3,1),t.vertexAttribDivisor(4,1),t.vertexAttribDivisor(5,1),t.vertexAttribDivisor(6,1),t.vertexAttribDivisor(7,1),t.vertexAttribDivisor(8,1),t.vertexAttribDivisor(9,1),t.vertexAttribDivisor(10,1),t.vertexAttribDivisor(11,1),t.vertexAttribDivisor(12,1),t.bindVertexArray(null)}_bindData(t){const i=this._components;this._transformData.bind(),this._transformData.upload(i*this._imageCount),t.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let n=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_texture_index <= ${h}.5) {
`:o+=`   else if (v_texture_index <= ${h}.5) {
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return n=n.replace("%%texture_picker%%",o),n}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(Rt.Filtering),n=i?Vn(i):void 0,o=Mi(t.getAttribute(Rt.WrappingX)),h=Mi(t.getAttribute(Rt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&(this._textures.push(_),this._textureToIndex.set(_,this._textureIndex++),this._images.add(t))}_bindTextures(t){const i=Math.min(this._textureIndex,this._maxTextures);for(let n=0;n<i;n++)t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,this._textures[n]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const n=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(n))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,n,o,h,c,_,g,v){var x,b,P,T;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const I=this._getImageWidth(t),F=this._getImageHeight(t);let R=I||o||0,S=F||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(x=o??I)!==null&&x!==void 0?x:0,this._view[3]=(b=h??F)!==null&&b!==void 0?b:0,this._dest[0]=i??1,this._dest[1]=n??1,c!==void 0&&_!==void 0&&g!==void 0&&v!==void 0&&(this._view[0]=i??1,this._view[1]=n??1,this._view[2]=(P=o??I)!==null&&P!==void 0?P:0,this._view[3]=(T=h??F)!==null&&T!==void 0?T:0,this._dest[0]=c,this._dest[1]=_,R=g,S=v),i=this._view[0],n=this._view[1];const M=this._view[2],W=this._view[3],U=this._context.getTransform(),V=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+pt),this._dest[1]=~~(this._dest[1]+pt));const X=this._context.tint||this._defaultTint,nt=this._getTextureIdForImage(t),ht=I||R,wt=F||S,gt=(i+this.uvPadding)/ht,At=(n+this.uvPadding)/wt,Et=(i+M-this.uvPadding)/ht,B=(n+W-this.uvPadding)/wt,z=I,Q=F,tt=this._transformData.bufferData;tt[this._vertexIndex++]=this._dest[0],tt[this._vertexIndex++]=this._dest[1],tt[this._vertexIndex++]=U.data[0],tt[this._vertexIndex++]=U.data[1],tt[this._vertexIndex++]=U.data[2],tt[this._vertexIndex++]=U.data[3],tt[this._vertexIndex++]=U.data[4],tt[this._vertexIndex++]=U.data[5],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=R,tt[this._vertexIndex++]=S,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=nt,tt[this._vertexIndex++]=gt,tt[this._vertexIndex++]=At,tt[this._vertexIndex++]=Et,tt[this._vertexIndex++]=B,tt[this._vertexIndex++]=X.r/255,tt[this._vertexIndex++]=X.g/255,tt[this._vertexIndex++]=X.b/255,tt[this._vertexIndex++]=X.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._bindData(t),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),t.drawArraysInstanced(t.TRIANGLES,0,6,this._imageCount),Zt.DrawnImagesCount+=this._imageCount,Zt.DrawCallCount++,t.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const pt=1e-4;class gm{constructor(t){this._webglCtx=t,this._debugText=new Cl}drawRect(t,i,n,o,h={color:K.Black}){this.drawLine(G(t,i),G(t+n,i),{...h}),this.drawLine(G(t+n,i),G(t+n,i+o),{...h}),this.drawLine(G(t+n,i+o),G(t,i+o),{...h}),this.drawLine(G(t,i+o),G(t,i),{...h})}drawLine(t,i,n){var o;this._webglCtx.draw("ex.line",t,i,(o=n?.color)!==null&&o!==void 0?o:K.Black)}drawPoint(t,i={color:K.Black,size:5}){this._webglCtx.draw("ex.point",t,i.color,i.size)}drawText(t,i){this._debugText.write(this._webglCtx,t,i)}}class ps{get z(){return this._state.current.z}set z(t){this._state.current.z=t}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(t){let i=!0;return(t.width>4096||t.height>4096)&&(i=!1),i}constructor(t){this._logger=ct.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=Fe.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new sa(()=>new Jg,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new Ig,this._state=new Fu,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=K.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new gm(this),this._totalPostProcessorTime=0;const{canvasElement:i,context:n,enableTransparency:o,antialiasing:h,uvPadding:c,multiSampleAntialiasing:_,pixelArtSampler:g,powerPreference:v,snapToPixel:x,backgroundColor:b,useDrawSorting:P,garbageCollector:T,handleContextLost:I,handleContextRestored:F}=t;if(this.__gl=n??i.getContext("webgl2",{antialias:h??this.smoothing,premultipliedAlpha:!1,alpha:o??this.transparency,depth:!1,powerPreference:v??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");I&&this.__gl.canvas.addEventListener("webglcontextlost",I,!1),F&&this.__gl.canvas.addEventListener("webglcontextrestored",F,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new ee(this.__gl,T),this.snapToPixel=x??this.snapToPixel,this.smoothing=h??this.smoothing,this.transparency=o??this.transparency,this.pixelArtSampler=g??this.pixelArtSampler,this.uvPadding=c??this.uvPadding,this.multiSampleAntialiasing=typeof _=="boolean"?_:this.multiSampleAntialiasing,this.samples=typeof _=="object"?_.samples:void 0,this.backgroundColor=b??this.backgroundColor,this.useDrawSorting=P??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const t of this._renderers.values())t.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const t=this.__gl;if(this._ortho=ai.ortho(0,t.canvas.width,t.canvas.height,0,400,-400),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!1),this.register(new qg({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new _u),this.register(new Zg),this.register(new Kg),this.register(new Og),this.register(new Ug),this.lazyRegister("ex.particle",()=>new Wu),this.register(new pm({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=t.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");t.bindTexture(t.TEXTURE_2D,this.materialScreenTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),this._screenRenderer=new Gg(t),this._renderTarget=new Mo({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),this._postProcessTargets=[new Mo({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),new Mo({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height})],this._msaaTarget=new Mo({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(t){this._renderers.set(t.type,t),t.initialize(this.__gl,this)}lazyRegister(t,i){this._lazyRenderersFactory.set(t,i)}get(t){let i=this._renderers.get(t);if(!i){const n=this._lazyRenderersFactory.get(t);n&&(this._logger.debug("lazy init renderer:",t),i=n(),this.register(i))}return i}_isCurrentRenderer(t){return!this._currentRenderer||this._currentRenderer===t}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(t,...i){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${t}, the webgl context is lost`);return}const n=this.get(t);if(n)if(this.useDrawSorting){const o=this._drawCallPool.get();o.z=this._state.current.z,o.priority=n.priority,o.renderer=t,this.getTransform().clone(o.transform),o.state.z=this._state.current.z,o.state.opacity=this._state.current.opacity,o.state.tint=this._state.current.tint,o.state.material=this._state.current.material,o.args[0]=i[0],o.args[1]=i[1],o.args[2]=i[2],o.args[3]=i[3],o.args[4]=i[4],o.args[5]=i[5],o.args[6]=i[6],o.args[7]=i[7],o.args[8]=i[8],o.args[9]=i[9],this._drawCalls[this._drawCallIndex++]=o}else this._currentRenderer||(this._currentRenderer=n),this._isCurrentRenderer(n)||this._currentRenderer.flush(),n.draw(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9]),this._currentRenderer=n;else throw Error(`No renderer with name ${t} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(t){const i=this.__gl;this._ortho=this._ortho=ai.ortho(0,t.width,t.height,0,400,-400),this._renderTarget.setResolution(i.canvas.width,i.canvas.height),this._msaaTarget.setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[0].setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[1].setResolution(i.canvas.width,i.canvas.height)}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}drawImage(t,i,n,o,h,c,_,g,v){if(!(o===0||h===0)){{if(g===0||v===0)return;if(this._getImageWidth(t)===0||this._getImageHeight(t)===0)return}if(!t){ct.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",t,i,n,o,h,c,_,g,v):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,t,i,n,o,h,c,_,g,v):this.draw(this.imageRenderer,t,i,n,o,h,c,_,g,v)}}drawLine(t,i,n,o=1){this.draw("ex.rectangle",t,i,n,o)}drawRectangle(t,i,n,o,h,c){this.draw("ex.rectangle",t,i,n,o,h,c)}drawCircle(t,i,n,o,h){this.draw("ex.circle",t,i,n,o,h)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(t,i){this._transform.translate(this.snapToPixel?~~(t+pt):t,this.snapToPixel?~~(i+pt):i)}rotate(t){this._transform.rotate(t)}scale(t,i){this._transform.scale(t,i)}transform(t){this._transform.current=t}getTransform(){return this._transform.current}multiply(t){this._transform.current.multiply(t,this._transform.current)}addPostProcessor(t){this._postprocessors.push(t),t.initialize(this.__gl)}removePostProcessor(t){const i=this._postprocessors.indexOf(t);i!==-1&&this._postprocessors.splice(i,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(t){for(const i of this._postprocessors){const n=i.getShader();n.use();const o=n.getUniforms();this._totalPostProcessorTime+=t,o.find(h=>h.name==="u_time_ms")&&n.setUniformFloat("u_time_ms",this._totalPostProcessorTime),o.find(h=>h.name==="u_elapsed_ms")&&n.setUniformFloat("u_elapsed_ms",t),o.find(h=>h.name==="u_resolution")&&n.setUniformFloatVector("u_resolution",G(this.width,this.height)),i.onUpdate&&i.onUpdate(t)}}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return new Hu({...t,graphicsContext:this})}createShader(t){const i=this.__gl,{vertexSource:n,fragmentSource:o}=t,h=new si({gl:i,vertexSource:n,fragmentSource:o});return h.compile(),h}clear(){const t=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT)}flush(){var t;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let i=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(i.use(),this.useDrawSorting){for(let c=this._drawCallIndex;c<this._drawCalls.length;c++)this._drawCalls[c]=null;const n=new Map;for(const[c]of this._renderers){let _=0;for(_=0;_<this._drawCallIndex&&this._drawCalls[_].renderer!==c;_++);n.set(c,_)}this._drawCalls.sort((c,_)=>{if(c===null||_===null)return 0;const g=c.z-_.z,v=n.get(c.renderer)-n.get(_.renderer),x=c.priority-_.priority;return g===0?x===0?v:x:g});const o=this._transform.current,h=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let c=this._drawCalls[0].renderer,_=this.get(c);for(let g=0;g<this._drawCallIndex;g++)this._transform.current=this._drawCalls[g].transform,this._state.current=this._drawCalls[g].state,this._drawCalls[g].renderer!==c&&(_.flush(),c=this._drawCalls[g].renderer,_=this.get(c)),_ instanceof _u&&(!((t=this.material)===null||t===void 0)&&t.isUsingScreenTexture)&&(i.copyToTexture(this.materialScreenTexture),i.use()),_.draw(...this._drawCalls[g].args);_.hasPendingDraws()&&_.flush()}this._transform.current=o,this._state.current=h,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const n of this._renderers.values())n.hasPendingDraws()&&n.flush();i.disable(),this._postprocessors.length>0&&i.toRenderSource().use();for(let n=0;n<this._postprocessors.length;n++)i=this._postProcessTargets[n%2],this._postProcessTargets[n%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[n]),this._postProcessTargets[n%2].toRenderSource().use();i.blitToScreen()}}const ae=1e-4;class mm{constructor(t){this._ex=t,this._debugText=new Cl}drawRect(t,i,n,o){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(t+ae):t,this._ex.snapToPixel?~~(i+ae):i,this._ex.snapToPixel?~~(n+ae):n,this._ex.snapToPixel?~~(o+ae):o),this._ex.__ctx.restore()}drawLine(t,i,n={color:K.Black}){var o,h;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(h=(o=n.color)===null||o===void 0?void 0:o.toString())!==null&&h!==void 0?h:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(t.x+ae):t.x,this._ex.snapToPixel?~~(t.y+ae):t.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(i.x+ae):i.x,this._ex.snapToPixel?~~(i.y+ae):i.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(t,i={color:K.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=i.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(t.x+ae):t.x,this._ex.snapToPixel?~~(t.y+ae):t.y,i.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(t,i){this._debugText.write(this._ex,t,i)}}class $o{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(t){this.__ctx.imageSmoothingEnabled=t}constructor(t){this.useDrawSorting=!1,this.z=0,this.backgroundColor=K.ExcaliburBlue,this._state=new Fu,this.snapToPixel=!1,this.debug=new mm(this);const{canvasElement:i,context:n,enableTransparency:o,snapToPixel:h,antialiasing:c,backgroundColor:_}=t;if(this.__ctx=n??i.getContext("2d",{alpha:o??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=_??this.backgroundColor,this.snapToPixel=h??this.snapToPixel,this.smoothing=c??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(t){}drawImage(t,i,n,o,h,c,_,g,v){if(o===0||h===0)return;if(g===0||v===0)return;if(t.width===0||t.height===0)return;this.__ctx.globalAlpha=this.opacity;const x=[t,i,n,o,h,c,_,g,v].filter(b=>b!==void 0).map(b=>typeof b=="number"&&this.snapToPixel?~~b:b);this.__ctx.drawImage.apply(this.__ctx,x),Zt.DrawCallCount++,Zt.DrawnImagesCount=1}drawLine(t,i,n,o=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=n.toString(),this.__ctx.moveTo(this.snapToPixel?~~(t.x+ae):t.x,this.snapToPixel?~~(t.y+ae):t.y),this.__ctx.lineTo(this.snapToPixel?~~(i.x+ae):i.x,this.snapToPixel?~~(i.y+ae):i.y),this.__ctx.lineWidth=o,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(t,i,n,o){this.__ctx.save(),this.__ctx.fillStyle=o.toString(),this.__ctx.fillRect(this.snapToPixel?~~(t.x+ae):t.x,this.snapToPixel?~~(t.y+ae):t.y,this.snapToPixel?~~(i+ae):i,this.snapToPixel?~~(n+ae):n),this.__ctx.restore()}drawCircle(t,i,n,o,h){this.__ctx.save(),this.__ctx.beginPath(),o&&(this.__ctx.strokeStyle=o.toString()),h&&(this.__ctx.lineWidth=h),this.__ctx.fillStyle=n.toString(),this.__ctx.arc(this.snapToPixel?~~(t.x+ae):t.x,this.snapToPixel?~~(t.y+ae):t.y,i,0,Math.PI*2),this.__ctx.fill(),o&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(t,i){this.__ctx.translate(this.snapToPixel?~~(t+ae):t,this.snapToPixel?~~(i+ae):i)}rotate(t){this.__ctx.rotate(t)}scale(t,i){this.__ctx.scale(t,i)}getTransform(){throw new Error("Not implemented")}multiply(t){this.__ctx.setTransform(this.__ctx.getTransform().multiply(t.toDOMMatrix()))}addPostProcessor(t){}removePostProcessor(t){}clearPostProcessors(){}updatePostProcessors(t){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),Zt.clear()}flush(){}dispose(){this.__ctx=void 0}}var Pe;(function(d){d.Fixed="Fixed",d.FitContainerAndFill="FitContainerAndFill",d.FitScreenAndFill="FitScreenAndFill",d.FitContainerAndZoom="FitContainerAndZoom",d.FitScreenAndZoom="FitScreenAndZoom",d.FitScreen="FitScreen",d.FillScreen="FillScreen",d.FitContainer="FitContainer",d.FillContainer="FillContainer"})(Pe||(Pe={}));class il{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const vm={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class sl{constructor(t){var i,n,o,h;this.events=new Qt,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=ct.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const c=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(c),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new lt,this._unsafeArea=new lt,this.viewport=t.viewport,this.resolution=(i=t.resolution)!==null&&i!==void 0?i:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(n=t.displayMode)!==null&&n!==void 0?n:Pe.Fixed,this._canvas=t.canvas,this.graphicsContext=t.context,this._antialiasing=(o=t.antialiasing)!==null&&o!==void 0?o:this._antialiasing,this._canvasImageRendering=(h=t.canvasImageRendering)!==null&&h!==void 0?h:this._canvasImageRendering,this._browser=t.browser,this._pixelRatioOverride=t.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const t=this.worldToPageCoordinates(k.Zero);return this.worldToPageCoordinates(G(1,0)).sub(t).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(t){this._pixelRatioOverride=t}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case Pe.FillContainer:case Pe.FitContainer:case Pe.FitContainerAndFill:case Pe.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(t){this._resolution=t}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(t){this._viewport=t}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(t){this._camera=t}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof ps&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let o=Math.max(1,this.pixelRatio-.5),h=!1;for(;o>1&&!h;){o=Math.max(1,o-.5);const c=this._resolution.width*o,_=this._resolution.height*o;h=this.graphicsContext.checkIfResolutionSupported({width:c,height:_})}this.pixelRatioOverride=o,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const t=this.viewport.widthUnit==="percent"?"%":"px",i=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+t,this._canvas.style.height=this.viewport.height+i,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof $o&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(t){this._antialiasing=t,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(t){return this.enterFullscreen(t)}enterFullscreen(t){var i,n,o,h,c,_;if(t){const g=document.getElementById(t);if(g?.requestFullscreen||g?.webkitRequestFullscreen){if(g.getAttribute("ex-fullscreen-listener")||(g.setAttribute("ex-fullscreen-listener","true"),g.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),g.requestFullscreen)return(i=g.requestFullscreen())!==null&&i!==void 0?i:Promise.resolve();if(g.webkitRequestFullscreen)return(n=g.webkitRequestFullscreen())!==null&&n!==void 0?n:Promise.resolve()}}return!((o=this._canvas)===null||o===void 0)&&o.requestFullscreen?(c=(h=this._canvas)===null||h===void 0?void 0:h.requestFullscreen())!==null&&c!==void 0?c:Promise.resolve():this._canvas.webkitRequestFullscreen?(_=this._canvas.webkitRequestFullscreen())!==null&&_!==void 0?_:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(t){return{width:t.widthUnit==="percent"?this.canvas.offsetWidth:t.width,height:t.heightUnit==="percent"?this.canvas.offsetHeight:t.height}}pageToScreenCoordinates(t){let i=t.x,n=t.y;this._isFullscreen||(i-=xr(this._canvas).x,n-=xr(this._canvas).y);const o=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,c=(window.innerHeight-h)/2;n=(n-c)/h*o.height,i=i/window.innerWidth*o.width}else{const h=window.innerHeight*this.aspectRatio,c=(window.innerWidth-h)/2;i=(i-c)/h*o.width,n=n/window.innerHeight*o.height}return i=i/o.width*this.resolution.width,n=n/o.height*this.resolution.height,i=i-this.contentArea.left,n=n-this.contentArea.top,new k(i,n)}screenToPageCoordinates(t){let i=t.x,n=t.y;const o=this._viewportToPixels(this.viewport);if(i=i/this.resolution.width*o.width,n=n/this.resolution.height*o.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,c=(window.innerHeight-h)/2;n=n/o.height*h+c,i=i/o.width*window.innerWidth}else{const h=window.innerHeight*this.aspectRatio,c=(window.innerWidth-h)/2;i=i/o.width*h+c,n=n/o.height*window.innerHeight}return this._isFullscreen||(i+=xr(this._canvas).x,n+=xr(this._canvas).y),new k(i,n)}screenToWorldCoordinates(t){return t=t.add(G(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(t):t.sub(G(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(t){return this._camera?this._camera.transform.multiply(t):t.add(G(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(t){const i=this.pageToScreenCoordinates(t);return this.screenToWorldCoordinates(i)}worldToPageCoordinates(t){const i=this.worldToScreenCoordinates(t);return this.screenToPageCoordinates(i)}getWorldBounds(){return lt.fromDimension(this.resolution.width,this.resolution.height,k.Half).scale(G(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return lt.fromDimension(this.resolution.width,this.resolution.height,k.Zero,k.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return G(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=this.aspectRatio;let i=0,n=0;window.innerWidth/t<window.innerHeight?(i=window.innerWidth,n=window.innerWidth/t):(i=window.innerHeight*t,n=window.innerHeight),this.viewport={width:i,height:n},this._contentArea=lt.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this._unsafeArea=lt.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndFill(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(t,i,n){if(this.viewport=n??{width:t,height:i},t/i<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:t*this._contentResolution.width/t,height:t*this._contentResolution.width/t*i/t};const o=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new lt({top:o,left:0,right:this._contentResolution.width,bottom:this.resolution.height-o}),this._unsafeArea=new lt({top:-o,left:0,right:this._contentResolution.width,bottom:this.resolution.height+o})}else{this.resolution={width:i*this._contentResolution.height/i*t/i,height:i*this._contentResolution.height/i};const o=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new lt({top:0,left:o,right:this.resolution.width-o,bottom:this._contentResolution.height}),this._unsafeArea=new lt({top:0,left:-o,right:this.resolution.width+o,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndZoom(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const t=this.canvas.parentElement;t.style.overflow="hidden";const{offsetWidth:i,offsetHeight:n}=this.canvas;this._computeFitAndZoom(i,n),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(t,i){const n=this.aspectRatio;let o=0,h=0;t/n<i?(o=t,h=t/n):(o=i*n,h=i);const c=t/o,_=i/h,g=Math.max(c,_),v=o*g,x=h*g;v>t?this.canvas.style.left=-(v-t)/2+"px":this.canvas.style.left="",x>i?this.canvas.style.top=-(x-i)/2+"px":this.canvas.style.top="",this.viewport={width:v,height:x};const b=lt.fromDimension(this.viewport.width,this.viewport.height,k.Zero);if(this.viewport.width>t){const P=(this.viewport.width-t)/this.viewport.width*this.resolution.width;b.top=0,b.left=P/2,b.right=this.resolution.width-P/2,b.bottom=this.resolution.height}if(this.viewport.height>i){const P=(this.viewport.height-i)/this.viewport.height*this.resolution.height;b.top=P/2,b.left=0,b.bottom=this.resolution.height-P/2,b.right=this.resolution.width}this._contentArea=b}_computeFitContainer(){const t=this.aspectRatio;let i=0,n=0,o="pixel",h="pixel";const c=this.canvas.parentElement;c.clientWidth/t<c.clientHeight?(this.canvas.style.width="100%",i=100,o="percent",n=this.canvas.offsetWidth/t):(this.canvas.style.height="100%",n=100,h="percent",i=this.canvas.offsetHeight*t),this.viewport={width:i,widthUnit:o,height:n,heightUnit:h},this._contentArea=lt.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(t){this.displayMode===Pe.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===Pe.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:t.innerWidth,height:t.innerHeight},this.viewport=this.resolution),this._contentArea=lt.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.displayMode===Pe.FitScreen&&this._computeFit(),this.displayMode===Pe.FitContainer&&this._computeFitContainer(),this.displayMode===Pe.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===Pe.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===Pe.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===Pe.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class Tr{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function wm(d){return!!d.playbackState}class rn{static unlock(){return new Promise((i,n)=>{if(rn._UNLOCKED||!Tr.create())return i(!0);const o=setTimeout(()=>{ct.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),i(!1)},200),h=Tr.create();h.resume().then(()=>{const c=h.createBuffer(1,1,22050),_=h.createBufferSource();let g=!1;_.buffer=c,_.connect(h.destination),_.onended=()=>g=!0,_.start(0),setTimeout(()=>{wm(_)?(_.playbackState===_.PLAYING_STATE||_.playbackState===_.FINISHED_STATE)&&(rn._UNLOCKED=!0):(h.currentTime>0||g)&&(rn._UNLOCKED=!0)},0),clearTimeout(o),i(!0)},()=>{n()})})}static isUnlocked(){return this._UNLOCKED}}rn._UNLOCKED=!1;class oa extends Xn{get ctx(){return this._ctx}constructor(t={}){super(t),this._options=t}clone(){return new oa({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){var i,n;!((i=this._options)===null||i===void 0)&&i.draw&&((n=this._options)===null||n===void 0||n.draw(t)),this._options.cache||this.flagDirty()}}class Jl{}Jl.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class aa{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(t){this._currentState=t}static create(t,i){const n=new aa;n.data=i;for(const o in t.states)n.states.set(o,{name:o,...t.states[o]});for(const o of n.states.values())for(const h of o.transitions)if(h!=="*"&&!n.states.has(h))throw Error(`Invalid state machine, state [${o.name}] has a transition to another state that doesn't exist [${h}]`);return n.currentState=n.startState=n.states.get(t.start),n}in(t){return this.currentState.name===t}go(t,i){var n,o;if(this.currentState.transitions.includes(t)||this.currentState.transitions.includes("*")){const h=this.states.get(t);return this.currentState.onExit&&((n=this.currentState)===null||n===void 0?void 0:n.onExit({to:h.name,data:this.data}))===!1||h?.onEnter&&h?.onEnter({from:this.currentState.name,eventData:i,data:this.data})===!1?!1:(this.currentState=h,!((o=this.currentState)===null||o===void 0)&&o.onState&&this.currentState.onState(),!0)}return!1}update(t){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,t)}save(t){localStorage.setItem(t,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(t){const i=JSON.parse(localStorage.getItem(t));this.currentState=this.states.get(i.currentState),this.data=i.data}}class Nu{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(t){this._loop=t,this._instance&&(this._instance.loop=t,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(t){t=bt(t,0,1),this._volume=t,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(t,this._audioContext.currentTime,.1):this._volumeNode.gain.value=t}get volume(){return this._volume}get duration(){var t;return(t=this._duration)!==null&&t!==void 0?t:this.getTotalPlaybackDuration()}set duration(t){this._duration=t}constructor(t){this._src=t,this._audioContext=Tr.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new fi,this._stateMachine=aa.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:i})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,i.pausedAt*this._playbackRate):this._instance.start(0,i.pausedAt*this._playbackRate,this.duration),i.startedAt=this._audioContext.currentTime-i.pausedAt,i.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:i})=>{i==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:i,data:n})=>{n.pausedAt=(i??0)/this._playbackRate,n.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:i})=>{i.pausedAt=0,i.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:i})=>{i.pausedAt=this._audioContext.currentTime-i.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(t=()=>{}){return this._playStarted=t,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(t){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",t)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:t,startedAt:i}=this._stateMachine.data;return t?t*this._playbackRate:i?(this._audioContext.currentTime-i)*this._playbackRate:0}set playbackRate(t){this._instance.playbackRate.value=this._playbackRate=t}get playbackRate(){return this._instance.playbackRate.value}}class tc extends vt{set bubbles(t){}get bubbles(){return!1}get _path(){return null}set _path(t){}constructor(t,i="MediaEvent"){super(),this.target=t,this._name=i}stopPropagation(){}action(){}propagate(){}layPath(t){}}class tn extends tc{constructor(t,i){super(t,"NativeSoundEvent"),this.track=i}}class Gu extends tc{constructor(t,i){super(t,"NativeSoundProcessedEvent"),this._processedData=i,this.data=this._processedData}}function xm(d){try{const t=new Audio,i=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,n=d.match(i)[1];return!!t.canPlayType("audio/"+n)}catch(t){return ct.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",t),!1}}const bm={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class Vu{set loop(t){this._loop=t;for(const i of this._tracks)i.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(t){this._volume=t;for(const i of this._tracks)i.volume=this._volume;this.events.emit("volumechange",new tn(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(t){this._duration=t}get instances(){return this._tracks}get path(){return this._resource.path}set path(t){this._resource.path=t}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}constructor(...t){this.events=new Qt,this.logger=ct.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=Tr.create(),this._resource=new Ur("",Jl.type.arraybuffer);for(const i of t)if(xm(i)){this.path=i;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",t.join(", ")),this.logger.warn("Attempting to use",t[0]),this.path=t[0])}isLoaded(){return!!this.data}async load(){var t,i;if(this.data)return this.data;const n=await this._resource.load(),o=await this.decodeAudio(n.slice(0));return this._duration=(i=(t=this._duration)!==null&&t!==void 0?t:o?.duration)!==null&&i!==void 0?i:void 0,this.events.emit("processed",new Gu(this,o)),this.data=o}async decodeAudio(t){try{return await this._audioContext.decodeAudioData(t.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(t){t&&(this._engine=t,this._engine.on("hidden",()=>{t.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{t.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(t=>t.isPlaying())}isPaused(){return this._tracks.some(t=>t.isPaused())}isStopped(){return this._tracks.some(t=>t.isStopped())}play(t){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=t||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const t of this._tracks)t.pause();this.events.emit("pause",new tn(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const t of this._tracks)t.stop();this.events.emit("stop",new tn(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._tracks.forEach(i=>{i.playbackRate=this._playbackRate})}seek(t,i=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[i].seek(t)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(t=0){return this._tracks.length?this._tracks[t].getPlaybackPosition():0}getTrackId(t){return this._tracks.indexOf(t)}async _resumePlayback(){if(this.isPaused()){const t=[];for(const i of this._tracks)t.push(i.play().then(()=>(this._tracks.splice(this.getTrackId(i),1),!0)));this.events.emit("resume",new tn(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(t)}return!0}async _startPlayback(){const t=this._getTrackInstance(this.data),i=await t.play(()=>{this.events.emit("playbackstart",new tn(this,t)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new tn(this,t));const n=this.getTrackId(t);return n!==-1&&this._tracks.splice(n,1),i}_getTrackInstance(t){var i;const n=new Nu(t);return n.loop=this.loop,n.volume=this.volume,n.duration=(i=this.duration)!==null&&i!==void 0?i:0,n.playbackRate=this._playbackRate,this._tracks.push(n),n}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const ym={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function nl(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class Sr{get resources(){return this._resources}constructor(t){var i;this.events=new Qt,this.canvas=new oa({filtering:ge.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new fi,t&&(!((i=t.loadables)===null||i===void 0)&&i.length)&&this.addResources(t.loadables)}onInitialize(t){this.engine=t,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await Ho(500,this.engine.clock)}addResource(t){this._resources.push(t)}addResources(t){let i=0;const n=t.length;for(i;i<n;i++)this.addResource(t[i])}markResourceComplete(){this._numLoaded++}get progress(){const t=this._resources.length;return t>0?bt(this._numLoaded,0,t)/t:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(t,i){this._totalTimeMs+=i}onDraw(t){const i=this._totalTimeMs/1e3;t.fillStyle=K.Black.toRGBA(),t.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),t.save(),t.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const n=i*10;t.strokeStyle="white",t.lineWidth=10,t.lineCap="round",t.arc(0,0,40,n,n+Math.PI*3/2),t.stroke(),t.fillStyle="white",t.font="16px sans-serif";const o=(this.progress*100).toFixed(0)+"%",h=t.measureText(o),c=Math.abs(h.actualBoundingBoxLeft)+Math.abs(h.actualBoundingBoxRight),_=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);t.fillText(o,-c/2,_/2),t.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async t=>{this.events.emit("loadresourcestart",t),await t.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",t)})}));for(const t of this._resources)t instanceof Vu&&t.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await rn.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const Am="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var Cm=Ee(851);class gn extends Sr{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const t=document.getElementById("excalibur-play-root");return t&&(this._playButtonRootElement=t),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(t){const i=Array.isArray(t)?{loadables:t}:t;super(i),this._logger=ct.getInstance(),this._originalOptions={loadables:[]},this.events=new Qt,this._playButtonShown=!1,this.logo=Am,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=K.White,this.backgroundColor="#176BAA",this._imageLoaded=new fi,this.suppressPlayButton=!1,this._playButtonStyles=Cm.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let n=document.getElementById("excalibur-play");return n||(n=document.createElement("button")),n.id="excalibur-play",n.textContent=this.playButtonText,n.style.display="none",n},this._originalOptions={...gn._DEFAULT_LOADER_OPTIONS,...i}}onInitialize(t){this.engine=t,this.screen=t.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var t,i;if(this.suppressPlayButton)this.hidePlayButton(),await Ho(500,(t=this.engine)===null||t===void 0?void 0:t.clock);else{const n=()=>{try{this._positionPlayButton()}catch{}};return!((i=this.engine)===null||i===void 0)&&i.browser&&this.engine.browser.window.on("resize",n),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",h=>{h.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(h=>{const c=_=>{var g;if(_.stopPropagation(),this.hidePlayButton(),!((g=this.engine)===null||g===void 0)&&g.browser&&this.engine.browser.window.off("resize",n),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(v){this._logger.error("could not go fullscreen",v)}h()};this._playButton.addEventListener("click",c),this._playButton.addEventListener("touchend",c),this._playButton.addEventListener("pointerup",c),this.engine&&this.engine.input.gamepads.once("button",()=>c(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var t;await Ho(200,(t=this.engine)===null||t===void 0?void 0:t.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const t=this._image;await this._imageLoaded.promise,await t?.decode()}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:t,y:i,width:n,height:o}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const h=this._playButton.clientWidth,c=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${t+n/2-h/2}px`,this._playButtonRootElement.style.top=`${i+o/2-c/2+100}px`)}}}onDraw(t){const i=this.engine.canvasHeight/this.engine.pixelRatio,n=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),t.fillStyle=this.backgroundColor,t.fillRect(0,0,n,i);let o=i/2;const h=Math.min(this.logoWidth,n*.75);let c=n/2-h/2;this.logoPosition&&(c=this.logoPosition.x,o=this.logoPosition.y);const _=Math.floor(h*(this.logoHeight/this.logoWidth)),g=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,c,o,h,_):t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,c,o-_-20,h,_),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=g;return}let v=c,x=o;this.loadingBarPosition&&(v=this.loadingBarPosition.x,x=this.loadingBarPosition.y),t.lineWidth=2,el(t,v,x,h,20,10,this.loadingBarColor);const b=h*this.progress,P=5,T=b-P*2,I=20-P*2;el(t,v+P,x+P,T>10?T:10,I,5,null,this.loadingBarColor),this.engine.screen.antialiasing=g}}gn._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const pu={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class Xu{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("2d"))},arrayBufferSupport:function(){const t=new XMLHttpRequest;t.open("GET","/");try{t.responseType="arraybuffer"}catch{return!1}return t.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const t=document.createElement("a").style;return t.cssText="background-color:rgba(150,255,150,.5)",(""+t.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let t=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const i=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],n=this.getBrowserFeatures();for(const o of Object.keys(pu))n[o]?(t+="(%c✓%c)",i.push("font-weight: bold; color: green"),i.push("font-weight: normal; color: inherit")):(t+="(%c✗%c)",i.push("font-weight: bold; color: red"),i.push("font-weight: normal; color: inherit")),t+=" "+pu[o]+`
`;i.unshift(t),console.log.apply(console,i)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let t=!1;for(const i in this._criticalTests)this._criticalTests[i].call(this)||(this.failedTests.push(i),ct.getInstance().error("Critical browser feature missing, Excalibur requires:",i),t=!0);if(t)return!1;for(const i in this._warningTest)this._warningTest[i]()||ct.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",i);return!0}}var ut;(function(d){d.PreventCollision="PreventCollision",d.Passive="Passive",d.Active="Active",d.Fixed="Fixed"})(ut||(ut={}));class ji{static create(t,i){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(t)){const o=this._GROUPS.get(t);if(o.mask===i)return o;throw new Error(`Collision group ${t} already exists with a different mask!`)}const n=new vs(t,this._CURRENT_BIT,i!==void 0?i:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(t,n),n}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(t){return this._GROUPS.get(t)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}ji._STARTING_BIT=1;ji._MAX_GROUPS=32;ji._CURRENT_GROUP=1;ji._CURRENT_BIT=ji._STARTING_BIT;ji._GROUPS=new Map;class vs{constructor(t,i,n){this._name=t,this._category=i,this._mask=n}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(t){const i=this.category&t.mask,n=this.mask&t.category;return i!==0&&n!==0}invert(){const t=ji.create("~("+this.name+")",~this.mask|0);return t._category=~this.category,t}static combine(t){const i=t.map(h=>h.name).join("+"),o=~t.reduce((h,c)=>c.category|h,0);return ji.create(i,o)}static collidesWith(t){const i=`collidesWith(${t.map(o=>o.name).join("+")})`,n=t.reduce((o,h)=>h.category|o,0);return ji.create(i,n)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}vs.All=new vs("Collide with all groups",-1,-1);class Qe{constructor(t,i){this.colliderA=t,this.colliderB=i,this.id=null,this.id=Qe.calculatePairHash(t.id,i.id)}static canCollide(t,i){var n,o;if(t.id===i.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.localBounds.hasZeroDimensions()||i.localBounds.hasZeroDimensions())return!1;const h=(n=t?.owner)===null||n===void 0?void 0:n.get(Pt),c=(o=i?.owner)===null||o===void 0?void 0:o.get(Pt);return!(!h||!c||!h.group.canCollide(c.group)||h.collisionType===ut.Fixed&&c.collisionType===ut.Fixed||c.collisionType===ut.PreventCollision||h.collisionType===ut.PreventCollision||!h.isActive||!c.isActive)}get canCollide(){const t=this.colliderA,i=this.colliderB;return Qe.canCollide(t,i)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(t){return t===this.colliderA||t===this.colliderB}static calculatePairHash(t,i){return t.value<i.value?`#${t.value}+${i.value}`:`#${i.value}+${t.value}`}}class Wr{constructor(t,i){this.min=t,this.max=i}overlaps(t){return this.max>t.min&&t.max>this.min}getOverlap(t){return this.overlaps(t)?this.max>t.max?t.max-this.min:this.max-t.min:0}}class rl{constructor(t){this.parent=t,this.parent=t||null,this.data=null,this.bounds=new lt,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class ec{constructor(t,i=new lt(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=t,this.worldBounds=i,this.root=null,this.nodes={}}_insert(t){if(this.root===null){this.root=t,this.root.parent=null;return}const i=t.bounds;let n=this.root;for(;!n.isLeaf();){const _=n.left,g=n.right,v=n.bounds.getPerimeter(),b=n.bounds.combine(i).getPerimeter(),P=2*b,T=2*(b-v);let I=0;const F=i.combine(_.bounds);let R,S;_.isLeaf()?I=F.getPerimeter()+T:(S=_.bounds.getPerimeter(),R=F.getPerimeter(),I=R-S+T);let M=0;const W=i.combine(g.bounds);if(g.isLeaf()?M=W.getPerimeter()+T:(S=g.bounds.getPerimeter(),R=W.getPerimeter(),M=R-S+T),P<I&&P<M)break;I<M?n=_:n=g}const o=n.parent,h=new rl(o);h.bounds=i.combine(n.bounds),h.height=n.height+1,o!==null?(o.left===n?o.left=h:o.right=h,h.left=n,h.right=t,n.parent=h,t.parent=h):(h.left=n,h.right=t,n.parent=h,t.parent=h,this.root=h);let c=t.parent;for(;c;){if(c=this._balance(c),!c.left)throw new Error("Parent of current leaf cannot have a null left child"+c);if(!c.right)throw new Error("Parent of current leaf cannot have a null right child"+c);c.height=1+Math.max(c.left.height,c.right.height),c.bounds=c.left.bounds.combine(c.right.bounds),c=c.parent}}_remove(t){if(t===this.root){this.root=null;return}const i=t.parent,n=i.parent;let o;if(i.left===t?o=i.right:o=i.left,n){n.left===i?n.left=o:n.right=o,o.parent=n;let h=n;for(;h;)h=this._balance(h),h.bounds=h.left.bounds.combine(h.right.bounds),h.height=1+Math.max(h.left.height,h.right.height),h=h.parent}else this.root=o,o.parent=null}trackCollider(t){const i=new rl;i.data=t,i.bounds=t.bounds,i.bounds.left-=2,i.bounds.top-=2,i.bounds.right+=2,i.bounds.bottom+=2,this.nodes[t.id.value]=i,this._insert(i)}updateCollider(t){var i;const n=this.nodes[t.id.value];if(!n)return!1;const o=t.bounds;if(!this.worldBounds.contains(o))return ct.getInstance().warn("Collider with id "+t.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(t),!1;if(n.bounds.contains(o))return!1;if(this._remove(n),o.left-=this._config.boundsPadding,o.top-=this._config.boundsPadding,o.right+=this._config.boundsPadding,o.bottom+=this._config.boundsPadding,t.owner){const h=(i=t.owner)===null||i===void 0?void 0:i.get(Pt);if(h){const c=h.vel.x*32/1e3*this._config.velocityMultiplier,_=h.vel.y*32/1e3*this._config.velocityMultiplier;c<0?o.left+=c:o.right+=c,_<0?o.top+=_:o.bottom+=_}}return n.bounds=o,this._insert(n),!0}untrackCollider(t){const i=this.nodes[t.id.value];i&&(this._remove(i),this.nodes[t.id.value]=null,delete this.nodes[t.id.value])}_balance(t){if(t===null)throw new Error("Cannot balance at null node");if(t.isLeaf()||t.height<2)return t;const i=t.left,n=t.right,o=t,h=i,c=n,_=i.left,g=i.right,v=n.left,x=n.right,b=c.height-h.height;if(b>1)return c.left=o,c.parent=o.parent,o.parent=c,c.parent?c.parent.left===o?c.parent.left=c:c.parent.right=c:this.root=c,v.height>x.height?(c.right=v,o.right=x,x.parent=o,o.bounds=h.bounds.combine(x.bounds),c.bounds=o.bounds.combine(v.bounds),o.height=1+Math.max(h.height,x.height),c.height=1+Math.max(o.height,v.height)):(c.right=x,o.right=v,v.parent=o,o.bounds=h.bounds.combine(v.bounds),c.bounds=o.bounds.combine(x.bounds),o.height=1+Math.max(h.height,v.height),c.height=1+Math.max(o.height,x.height)),c;if(b<-1){if(h.left=o,h.parent=o.parent,o.parent=h,h.parent)if(h.parent.left===o)h.parent.left=h;else{if(h.parent.right!==o)throw"Error rotating Dynamic Tree";h.parent.right=h}else this.root=h;return _.height>g.height?(h.right=_,o.left=g,g.parent=o,o.bounds=c.bounds.combine(g.bounds),h.bounds=o.bounds.combine(_.bounds),o.height=1+Math.max(c.height,g.height),h.height=1+Math.max(o.height,_.height)):(h.right=g,o.left=_,_.parent=o,o.bounds=c.bounds.combine(_.bounds),h.bounds=o.bounds.combine(g.bounds),o.height=1+Math.max(c.height,_.height),h.height=1+Math.max(o.height,g.height)),h}return t}getHeight(){return this.root===null?0:this.root.height}query(t,i){const n=t.bounds,o=h=>{if(h&&h.bounds.overlaps(n))if(h.isLeaf()&&h.data!==t){if(i.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}rayCastQuery(t,i=1/0,n){const o=h=>{if(h&&h.bounds.rayCast(t,i))if(h.isLeaf()){if(n.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}getNodes(){const t=i=>i?[i].concat(t(i.left),t(i.right)):[];return t(this.root)}debug(t){const i=n=>{n&&(n.isLeaf()?n.bounds.draw(t,K.Green):n.bounds.draw(t,K.White),n.left&&i(n.left),n.right&&i(n.right))};i(this.root)}}class sn{constructor(t,i){this.pos=t,this.dir=i.normalize()}intersect(t){const i=t.begin.sub(this.pos);if(this.dir.cross(t.getSlope())===0&&i.cross(this.dir)!==0)return-1;const n=this.dir.cross(t.getSlope());if(n===0)return-1;const o=i.cross(t.getSlope())/n;if(o>=0){const h=i.cross(this.dir)/n/t.getLength();if(h>=0&&h<=1)return o}return-1}intersectPoint(t){const i=this.intersect(t);return i<0?null:this.getPoint(i)}getPoint(t){return this.pos.add(this.dir.scale(t))}}class Ko{constructor(t){this._config=t,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new ec(t.dynamicTree)}getColliders(){return this._colliders}query(t){const i=[];return t instanceof lt?this._dynamicCollisionTree.query({id:dn("collider",-1),owner:null,bounds:t},n=>(i.push(n),!1)):this._dynamicCollisionTree.query({id:dn("collider",-1),owner:null,bounds:new lt(t.x,t.y,t.x,t.y)},n=>(i.push(n),!1)),i}rayCast(t,i){var n,o,h;const c=[],_=(n=i?.maxDistance)!==null&&n!==void 0?n:1/0,g=i?.collisionGroup,v=g?g.category:(o=i?.collisionMask)!==null&&o!==void 0?o:vs.All.category,x=(h=i?.searchAllColliders)!==null&&h!==void 0?h:!1;return this._dynamicCollisionTree.rayCastQuery(t,_,b=>{const T=b.owner.get(Pt);if(i?.ignoreCollisionGroupAll&&T.group===vs.All)return!1;const I=(v&T.group.category)!==0;if(T?.group&&!I)return!1;const F=b.rayCast(t,_);if(F){if(i?.filter){if(i.filter(F)&&(c.push(F),!x))return!0}else if(c.push(F),!x)return!0}return!1}),c}track(t){if(!t){ct.getInstance().warn("Cannot track null collider");return}if(t instanceof Se){const i=t.getColliders();for(const n of i)n.owner=t.owner,this._colliders.push(n),this._dynamicCollisionTree.trackCollider(n)}else this._colliders.push(t),this._dynamicCollisionTree.trackCollider(t)}untrack(t){if(!t){ct.getInstance().warn("Cannot untrack a null collider");return}if(t instanceof Se){const i=t.getColliders();for(const n of i){const o=this._colliders.indexOf(n);o!==-1&&this._colliders.splice(o,1),this._dynamicCollisionTree.untrackCollider(n)}}else{const i=this._colliders.indexOf(t);i!==-1&&this._colliders.splice(i,1),this._dynamicCollisionTree.untrackCollider(t)}}_pairExists(t,i){const n=Qe.calculatePairHash(t.id,i.id);return this._pairs.has(n)}broadphase(t,i,n){const o=i/1e3,h=t.filter(_=>{var g,v;const x=(g=_.owner)===null||g===void 0?void 0:g.get(Pt);return((v=_.owner)===null||v===void 0?void 0:v.isActive)&&x.collisionType!==ut.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let c;for(let _=0,g=h.length;_<g;_++)c=h[_],this._dynamicCollisionTree.query(c,v=>{if(!this._pairExists(c,v)&&Qe.canCollide(c,v)){const x=new Qe(c,v);this._pairs.add(x.id),this._collisionPairCache.push(x)}return!1});if(n&&(n.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const _ of h){const g=_.owner.get(Pt);if(g.collisionType!==ut.Active)continue;const v=g.vel.magnitude*o+g.acc.magnitude*.5*o*o,x=Math.min(_.bounds.height,_.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||v>x/2){n&&n.physics.fastBodies++;const b=g.globalPos.sub(g.oldPos),P=_.center,T=_.getFurthestPoint(g.vel),I=T.sub(b),F=new sn(I,g.vel);F.pos=F.pos.add(F.dir.scale(-2*this._config.continuous.surfaceEpsilon));let R,S=new k(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(F,v+this._config.continuous.surfaceEpsilon*2,M=>{if(!this._pairExists(_,M)&&Qe.canCollide(_,M)){const W=M.rayCast(F,v+this._config.continuous.surfaceEpsilon*10);if(W){const U=W.point.sub(I);U.magnitude<S.magnitude&&(S=U,R=M)}}return!1}),R&&k.isValid(S)){const M=new Qe(_,R);this._pairs.has(M.id)||(this._pairs.add(M.id),this._collisionPairCache.push(M));const W=P.sub(T);g.globalPos=I.add(W).add(S).add(F.dir.scale(10*this._config.continuous.surfaceEpsilon)),_.update(g.transform.get()),n&&n.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(t,i){let n=[];for(let o=0;o<t.length;o++){const h=t[o].collide();if(n=n.concat(h),i&&h.length>0)for(const c of h)i.physics.contacts.set(c.id,c)}return i&&(i.physics.collisions+=n.length),n}update(t){let i=0;const n=t.length;for(let o=0;o<n;o++)this._dynamicCollisionTree.updateCollider(t[o])&&i++;return i}debug(t){this._dynamicCollisionTree.debug(t)}}class Hs{constructor(){this.id=dn("collider",Hs._ID++),this.composite=null,this.events=new Qt,this.offset=k.Zero}touching(t){return!!this.collide(t)}}Hs._ID=0;var Er;(function(d){d.Arcade="arcade",d.Realistic="realistic"})(Er||(Er={}));var ws;(function(d){d.None="none",d.VerticalFirst="vertical-first",d.HorizontalFirst="horizontal-first"})(ws||(ws={}));const ic={vertical:1,horizontal:2},sc={horizontal:1,vertical:2},nc={horizontal:0,vertical:0};var Hn;(function(d){d.DynamicTree="dynamic-tree",d.SparseHashGrid="sparse-hash-grid"})(Hn||(Hn={}));const gs=()=>({enabled:!0,gravity:G(0,0).clone(),solver:Er.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:Hn.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:ws.None},realistic:{contactSolveBias:ws.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class Se extends Hs{set compositeStrategy(t){this._compositeStrategy=t}get compositeStrategy(){return this._compositeStrategy}constructor(t){super(),this._collisionProcessor=new Ko({...gs()}),this._dynamicAABBTree=new ec({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const i of t)this.addCollider(i)}clearColliders(){this._colliders=[]}addCollider(t){let i;t instanceof Se?(i=t.getColliders(),i.forEach(n=>n.offset.addEqual(t.offset))):i=[t];for(const n of i)n.events.pipe(this.events),n.composite=this,this._colliders.push(n),this._collisionProcessor.track(n),this._dynamicAABBTree.trackCollider(n)}removeCollider(t){t.events.pipe(this.events),t.composite=null,Gn(t,this._colliders),this._collisionProcessor.untrack(t),this._dynamicAABBTree.untrackCollider(t)}getColliders(){return this._colliders}get worldPos(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:k.Zero).add(this.offset)}get center(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:k.Zero).add(this.offset)}get bounds(){var t,i;const n=this.getColliders();return n.reduce((h,c)=>h.combine(c.bounds),(i=(t=n[0])===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new lt().translate(this.worldPos)).translate(this.offset)}get localBounds(){var t,i;const n=this.getColliders();return n.reduce((h,c)=>h.combine(c.localBounds),(i=(t=n[0])===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new lt)}get axes(){const t=this.getColliders();let i=[];for(const n of t)i=i.concat(n.axes);return i}getFurthestPoint(t){const i=this.getColliders(),n=[];for(const c of i)n.push(c.getFurthestPoint(t));let o=n[0],h=-Number.MAX_VALUE;for(const c of n){const _=c.dot(t);_>h&&(o=c,h=_)}return o}getInertia(t){const i=this.getColliders();let n=0;for(const o of i)n+=o.getInertia(t);return n}collide(t){let i=[t];t instanceof Se&&(i=t.getColliders());const n=[];for(const h of i)this._dynamicAABBTree.query(h,c=>(n.push(new Qe(h,c)),!1));let o=[];for(const h of n)o=o.concat(h.collide());return o}getClosestLineBetween(t){const i=this.getColliders(),n=[];if(t instanceof Se){const o=t.getColliders();for(const h of i)for(const c of o){const _=h.getClosestLineBetween(c);_&&n.push(_)}}else for(const o of i){const h=t.getClosestLineBetween(o);h&&n.push(h)}if(n.length){let o=n[0].getLength(),h=n[0];for(const c of n){const _=c.getLength();_<o&&(o=_,h=c)}return h}return null}contains(t){const i=this.getColliders();for(const n of i)if(n.contains(t))return!0;return!1}rayCast(t,i){const n=this.getColliders(),o=[];for(const h of n){const c=h.rayCast(t,i);c&&o.push(c)}if(o.length){let h=o[0],c=h.point.dot(t.dir);for(const _ of o){const g=t.dir.dot(_.point);g<c&&(h=_,c=g)}return h}return null}project(t){const i=this.getColliders(),n=[];for(const o of i){const h=o.project(t);h&&n.push(h)}if(n.length){const o=new Wr(n[0].min,n[0].max);for(const h of n)o.min=Math.min(h.min,o.min),o.max=Math.max(h.max,o.max);return o}return null}update(t){if(t){const i=this.getColliders();for(const n of i)n.owner=this.owner,n.update(t)}}debug(t,i,n){const o=this.getColliders();t.save(),t.translate(this.offset.x,this.offset.y);for(const h of o)h.debug(t,i,n);t.restore()}clone(){const t=new Se(this._colliders.map(i=>i.clone()));return t.offset=this.offset.clone(),t}}class he{constructor(t,i){this.begin=t,this.end=i}clone(t){const i=t||new he(this.begin.clone(),this.end.clone());return i.begin=this.begin.clone(i.begin),i.end=this.end.clone(i.end),i}transform(t,i){const n=i||new he(k.Zero,k.Zero);return n.begin=t.multiply(this.begin,n.begin),n.end=t.multiply(this.end,n.end),n}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const t=this.begin,i=this.end,n=t.distance(i);return this._slope=i.sub(t).scale(1/n)}getEdge(){const t=this.begin;return this.end.sub(t)}getLength(){const t=this.begin,i=this.end;return t.distance(i)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new he(this.end,this.begin)}below(t){return(this.end.x-this.begin.x)*(t.y-this.begin.y)-(this.end.y-this.begin.y)*(t.x-this.begin.x)>=0}clip(t,i,n=!0){let o=t;n&&(o=o.normalize());const h=o.dot(this.begin)-i,c=o.dot(this.end)-i,_=[];if(h<=0&&_.push(this.begin),c<=0&&_.push(this.end),h*c<0){const g=h/(h-c);_.push(this.begin.add(this.end.sub(this.begin).scale(g)))}return _.length!==2?null:new he(_[0],_[1])}distanceToPoint(t,i=!1){const n=t.x,o=t.y,h=this.getLength(),c=this.end.y-this.begin.y,_=this.end.x-this.begin.x,g=(c*n-_*o+this.end.x*this.begin.y-this.end.y*this.begin.x)/h;return i?g:Math.abs(g)}findVectorToPoint(t){const i=this.begin.sub(t),n=this.getSlope();return i.sub(n.scale(i.dot(n)))}findPoint(t=null,i=null){const n=this.slope,o=this.intercept;if(t!==null)return new k(t,n*t+o);if(i!==null)return new k((i-o)/n,i);throw new Error("You must provide an X or a Y value")}hasPoint(){let t,i=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")t=new k(arguments[0],arguments[1]),i=arguments[2]||0;else if(arguments[0]instanceof k)t=arguments[0],i=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const n=t.x-this.begin.x,o=t.y-this.begin.y,h=this.end.x-this.begin.x,c=this.end.y-this.begin.y,_=n*c-o*h;return Math.abs(_)>i?!1:Math.abs(h)>=Math.abs(c)?h>0?this.begin.x<=t.x&&t.x<=this.end.x:this.end.x<=t.x&&t.x<=this.begin.x:c>0?this.begin.y<=t.y&&t.y<=this.end.y:this.end.y<=t.y&&t.y<=this.begin.y}}function Nh(d,t){const n=d.dir(),o=t.dir(),h=n.dot(n),c=o.dot(o);if(h<1e-9&&c<1e-9)return new he(d.begin,t.begin);if(h<1e-9){const R=bt(o.dot(d.begin.sub(t.begin))/c,0,1),S=t.begin.add(o.scale(R));return new he(d.begin,S)}if(c<1e-9){const R=bt(n.dot(t.begin.sub(d.begin))/h,0,1),S=d.begin.add(n.scale(R));return new he(S,t.begin)}const _=d.begin.sub(t.begin),g=h,v=c,x=o.dot(_),b=g*v-Math.pow(n.dot(o),2);let P=0,T=0;Math.abs(b)>1e-9?P=bt((n.dot(o)*x-v*n.dot(_))/b,0,1):P=bt(n.dot(_)/g,0,1),Math.abs(v)>1e-9?T=bt((n.dot(o)*P+x)/v,0,1):T=0;const I=d.begin.add(n.scale(P)),F=t.begin.add(o.scale(T));return new he(I,F)}const Zi={PolygonPolygonClosestLine(d,t){const i=d.getSides(),n=t.getSides();let o=Number.MAX_VALUE,h=null;for(let c=0;c<i.length;c++)for(let _=0;_<n.length;_++){const g=Nh(i[c],n[_]),v=g.getLength();v<o&&(o=v,h=g)}return h},PolygonEdgeClosestLine(d,t){const n=t.worldPos.sub(d.worldPos),o=new sn(d.worldPos,n),h=d.rayCast(o).point.add(o.dir.scale(.1)),c=d.getClosestFace(h),_=t.asLine();return Nh(c.face,_)},PolygonCircleClosestLine(d,t){const i=t.worldPos,n=i.sub(d.worldPos),o=new sn(d.worldPos,n.normalize()),h=d.rayCast(o).point.add(o.dir.scale(.1)),c=d.getClosestFace(h),_=c.face.begin,g=c.face.getEdge();let v=(g.x*(i.x-_.x)+g.y*(i.y-_.y))/(g.x*g.x+g.y*g.y);v>1?v=1:v<0&&(v=0);const x=Math.sqrt(Math.pow(_.x+g.x*v-i.x,2)+Math.pow(_.y+g.y*v-i.y,2))-t.radius,b=(_.x+g.x*v-i.x)*t.radius/(t.radius+x),P=(_.y+g.y*v-i.y)*t.radius/(t.radius+x);return new he(g.scale(v).add(_),new k(i.x+b,i.y+P))},CircleCircleClosestLine(d,t){const n=t.worldPos.sub(d.worldPos),h=d.worldPos.sub(t.worldPos),c=new sn(d.worldPos,n),_=new sn(t.worldPos,h),g=d.rayCast(c),v=t.rayCast(_);return new he(g.point,v.point)},CircleEdgeClosestLine(d,t){const i=d.worldPos,n=t.asLine(),o=n.begin,h=n.getEdge(),c=o,_=h;let g=(_.x*(i.x-c.x)+_.y*(i.y-c.y))/(_.x*_.x+_.y*_.y);g>1?g=1:g<0&&(g=0);const v=Math.sqrt(Math.pow(c.x+_.x*g-i.x,2)+Math.pow(c.y+_.y*g-i.y,2))-d.radius,x=(c.x+_.x*g-i.x)*d.radius/(d.radius+v),b=(c.y+_.y*g-i.y)*d.radius/(d.radius+v);return new he(_.scale(g).add(c),new k(i.x+x,i.y+b))},EdgeEdgeClosestLine(d,t){const i=d.asLine(),n=t.asLine();return Nh(i,n)}};class We extends Hs{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var t;if(this._radius)return this._radius;const i=this._transform,n=(t=i?.globalScale)!==null&&t!==void 0?t:k.One;return this._radius=this._naturalRadius*Math.min(n.x,n.y)}set radius(t){var i;const n=this._transform,o=(i=n?.globalScale)!==null&&i!==void 0?i:k.One;this._naturalRadius=t/Math.min(o.x,o.y),this._localBoundsDirty=!0,this._radius=t}constructor(t){super(),this.offset=k.Zero,this._globalMatrix=_e.identity(),this._localBoundsDirty=!0,this.offset=t.offset||k.Zero,this.radius=t.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new We({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(t){var i,n;return((n=(i=this._transform)===null||i===void 0?void 0:i.pos)!==null&&n!==void 0?n:this.offset).distance(t)<=this.radius}rayCast(t,i=1/0){var n,o;const h=this.center,c=t.dir,_=t.pos,g=h.sub(_),v=c.scale(g.dot(c)),b=g.sub(v).magnitude;if(b>this.radius)return null;{let P=0;if(Su(b,this.radius,1e-4)){if(P=-c.dot(_.sub(h)),P>0&&P<i){const T=t.getPoint(P);return{point:T,normal:T.sub(h).normalize(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(Pt),distance:P}}return null}else{const T=Math.sqrt(Math.pow(c.dot(_.sub(h)),2)-Math.pow(_.sub(h).distance(),2)+Math.pow(this.radius,2)),I=-c.dot(_.sub(h))+T,F=-c.dot(_.sub(h))-T,R=[];I>=0&&R.push(I),F>=0&&R.push(F);const S=Math.min(...R);if(S<=i){const M=t.getPoint(S);return{point:M,normal:M.sub(h).normalize(),collider:this,body:(o=this.owner)===null||o===void 0?void 0:o.get(Pt),distance:S}}return null}}}getClosestLineBetween(t){if(t instanceof We)return Zi.CircleCircleClosestLine(this,t);if(t instanceof Be)return Zi.PolygonCircleClosestLine(t,this).flip();if(t instanceof hi)return Zi.CircleEdgeClosestLine(this,t).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof We)return Di.CollideCircleCircle(this,t);if(t instanceof Be)return Di.CollideCirclePolygon(this,t);if(t instanceof hi)return Di.CollideCircleEdge(this,t);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){return this.center.add(t.normalize().scale(this.radius))}getFurthestLocalPoint(t){return t.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new lt(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(t){return t*this.radius*this.radius/2}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(t){const i=[],o=this.center.dot(t);return i.push(o),i.push(o+this.radius),i.push(o-this.radius),new Wr(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i,n){var o,h,c,_;const{lineWidth:g}={lineWidth:1,...n},v=this._transform,x=(o=v?.globalScale)!==null&&o!==void 0?o:k.One,b=(h=v?.globalRotation)!==null&&h!==void 0?h:0,P=(c=v?.globalPos)!==null&&c!==void 0?c:k.Zero;t.save(),t.translate(P.x,P.y),t.rotate(b),t.scale(x.x,x.y),t.drawCircle((_=this.offset)!==null&&_!==void 0?_:k.Zero,this._naturalRadius,K.Transparent,i,g),t.restore()}}class en{constructor(t,i,n,o,h,c,_,g){var v,x,b,P,T,I;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=t,this.colliderB=i,this.mtv=n,this.normal=o,this.tangent=h,this.points=c,this.localPoints=_,this.info=g,this.id=Qe.calculatePairHash(t.id,i.id),t.composite||i.composite){const F=((v=t.composite)===null||v===void 0?void 0:v.compositeStrategy)==="separate"?t.id:(b=(x=t.composite)===null||x===void 0?void 0:x.id)!==null&&b!==void 0?b:t.id,R=((P=i.composite)===null||P===void 0?void 0:P.compositeStrategy)==="separate"?i.id:(I=(T=i.composite)===null||T===void 0?void 0:T.id)!==null&&I!==void 0?I:i.id;this.id+="|"+Qe.calculatePairHash(F,R)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(Pt)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(Pt))}matchAwake(){const t=this.bodyA,i=this.bodyB;t&&i&&t.isSleeping!==i.isSleeping&&(t.isSleeping&&t.collisionType!==ut.Fixed&&i.sleepMotion>=t.wakeThreshold&&(t.isSleeping=!1),i.isSleeping&&i.collisionType!==ut.Fixed&&t.sleepMotion>=i.wakeThreshold&&(i.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(t){if(t!==this.colliderA&&t!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(t===this.colliderA)return this;const i=this.colliderA,n=this.colliderB;return this.colliderB=i,this.colliderA=n,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class qu{constructor(){this.axis=G(0,0),this.localAxis=G(0,0),this.side=new he(G(0,0),G(0,0)),this.localSide=new he(G(0,0),G(0,0)),this.point=G(0,0),this.localPoint=G(0,0)}}class fe{static findPolygonPolygonSeparation(t,i){if(i.transform.matrix.determinant()===0)return fe.findPolygonPolygonSeparationDegenerate(t,i);let n=-Number.MAX_VALUE,o=-1,h;const c=i.transform.inverse.multiply(t.transform.matrix,fe._SCRATCH_MATRIX),_=c.getRotation(),g=t.normals,v=t.points,x=i.points;for(let T=0;T<v.length;T++){const I=g[T].rotate(_,fe._ZERO,fe._SCRATCH_NORMAL),F=c.multiply(v[T],fe._SCRATCH_POINT);let R=Number.MAX_VALUE,S;for(let M=0;M<x.length;M++){const W=I.dot(x[M].sub(F,fe._SCRATCH_SUB_POINT));W<R&&(R=W,S=x[M])}R>n&&(n=R,o=T,h=S)}const b=(o+1)%v.length,P=fe.SeparationPool.get();return P.collider=t,P.separation=n,n>0||(g[o].clone(P.localAxis),g[o].rotate(t.transform.rotation,fe._ZERO,P.axis),t.transform.matrix.multiply(v[o],P.side.begin),t.transform.matrix.multiply(v[b],P.side.end),i.transform.matrix.multiply(h,P.point),P.sideId=o,h.clone(P.localPoint),v[o].clone(P.localSide.begin),v[b].clone(P.localSide.end)),P}static findCirclePolygonSeparation(t,i){const n=i.axes,h=i.center.sub(t.worldPos),c=i.getFurthestPoint(h.negate());n.push(c.sub(t.worldPos).normalize());let _=Number.MAX_VALUE,g=null,v=-1;for(let x=0;x<n.length;x++){const b=i.project(n[x]),P=t.project(n[x]),T=b.getOverlap(P);if(T<=0)return null;T<_&&(_=T,g=n[x],v=x)}return v<0?null:g.normalize().scale(_)}static findPolygonPolygonSeparationDegenerate(t,i){let n=-Number.MAX_VALUE,o=null,h=null,c=-1,_=null;const g=t.getSides(),v=t.getLocalSides();for(let x=0;x<g.length;x++){const b=g[x],P=b.normal(),T=i.getFurthestPoint(P.negate()),I=b.distanceToPoint(T,!0);I>n&&(n=I,o=b,h=P,c=x,_=T)}return{collider:t,separation:h?n:99,axis:h,side:o,localSide:v[c],sideId:c,point:_,localPoint:h?i.getFurthestLocalPoint(h.negate()):null}}}fe.SeparationPool=new sa(()=>new qu,d=>d,500);fe._ZERO=G(0,0);fe._SCRATCH_POINT=G(0,0);fe._SCRATCH_SUB_POINT=G(0,0);fe._SCRATCH_NORMAL=G(0,0);fe._SCRATCH_MATRIX=_e.identity();fe.SeparationPool.disableWarnings=!0;const Pm=k.Zero,Tm=k.Zero,Sm=_e.identity(),Di={CollideCircleCircle(d,t){const i=d.worldPos,n=t.worldPos,o=d.radius+t.radius,h=i.distance(n);if(h>o)return[];const c=o-h,_=n.sub(i).normalize(),g=_.perpendicular(),v=_.scale(c),x=d.getFurthestPoint(_),b=d.getFurthestLocalPoint(_),P={collider:d,separation:c,axis:_,point:x};return[new en(d,t,v,_,g,[x],[b],P)]},CollideCirclePolygon(d,t){var i,n;let o=fe.findCirclePolygonSeparation(d,t);if(!o)return[];o=o.dot(t.center.sub(d.center))<0?o.negate():o;const c=d.getFurthestPoint(o),g=((n=(i=d.owner)===null||i===void 0?void 0:i.get(st))!==null&&n!==void 0?n:new st).applyInverse(c),v=o.normalize(),x={collider:d,separation:-o.magnitude,axis:v,point:c,localPoint:g,side:t.findSide(v.negate()),localSide:t.findLocalSide(v.negate())};return[new en(d,t,o,v,v.perpendicular(),[c],[g],x)]},CollideCircleEdge(d,t){const i=d.center,n=t.asLine(),o=n.end.sub(n.begin),h=o.dot(n.end.sub(i)),c=o.dot(i.sub(n.begin)),_=t.asLine(),g=t.asLocalLine();if(c<=0){const S=n.begin.sub(i),M=S.dot(S);if(M>d.radius*d.radius)return[];const W=S.normalize(),U=d.radius-Math.sqrt(M),V={collider:d,separation:U,axis:W,point:_.begin,side:_,localSide:g};return[new en(d,t,W.scale(U),W,W.perpendicular(),[_.begin],[g.begin],V)]}if(h<=0){const S=n.end.sub(i),M=S.dot(S);if(M>d.radius*d.radius)return[];const W=S.normalize(),U=d.radius-Math.sqrt(M),V={collider:d,separation:U,axis:W,point:_.end,side:_,localSide:g};return[new en(d,t,W.scale(U),W,W.perpendicular(),[_.end],[g.end],V)]}const v=o.dot(o),x=n.begin.scale(h).add(n.end.scale(c)).scale(1/v),b=i.sub(x),P=b.dot(b);if(P>d.radius*d.radius)return[];let T=o.perpendicular();T.dot(i.sub(n.begin))<0&&(T.x=-T.x,T.y=-T.y),T=T.normalize();const I=d.radius-Math.sqrt(P),F=T.scale(I),R={collider:d,separation:I,axis:T,point:x,side:_,localSide:g};return[new en(d,t,F,T.negate(),T.negate().perpendicular(),[x],[x.sub(t.worldPos)],R)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(d,t){var i;const n=d.center,h=t.center.sub(n).normalize(),c=new Be({points:[t.begin,t.end,t.end.add(h.scale(100)),t.begin.add(h.scale(100))],offset:t.offset});c.owner=t.owner,((i=t.owner)===null||i===void 0?void 0:i.get(st))&&c.update(t.owner.get(st).get());const g=this.CollidePolygonPolygon(d,c);return g.length&&(g[0].colliderB=t,g[0].id=Qe.calculatePairHash(d.id,t.id)),g},CollidePolygonPolygon(d,t){const i=fe.findPolygonPolygonSeparation(d,t);if(i.separation>0)return[];const n=fe.findPolygonPolygonSeparation(t,d);if(n.separation>0)return[];const o=i.separation>n.separation?i:n,h=o.collider===d?t:d,c=o.collider===d?d:t,_=h.transform.inverse.multiply(c.transform.matrix,Sm),g=_.getRotation(),v=c.normals[o.sideId].rotate(g,Pm,Tm);let x=Number.MAX_VALUE,b=0;for(let S=0;S<h.normals.length;S++){const M=v.dot(h.normals[S]);M<x&&(x=M,b=S)}if(!o.localSide||!o.localAxis||!o.axis)return[];const P=o.localSide.transform(_),T=o.localAxis.perpendicular().negate().rotate(g),F=new he(h.points[b],h.points[(b+1)%h.points.length]).clip(T.negate(),-T.dot(P.begin),!1);let R=null;if(F&&(R=F.clip(T,T.dot(P.end),!1)),R){const S=[],M=[],W=R.getPoints();for(let j=0;j<W.length;j++){const X=W[j];P.below(X)&&(S.push(X),M.push(h.transform.apply(X)))}let U=o.axis,V=U.perpendicular();return t.center.sub(d.center).dot(U)<0&&(U=U.negate(),V=U.perpendicular()),[new en(d,t,U.scale(-o.separation),U,V,M,S,o)]}return[]},FindContactSeparation(d,t){var i,n,o,h;const c=d.colliderA,_=(n=(i=d.bodyA)===null||i===void 0?void 0:i.transform)!==null&&n!==void 0?n:new st,g=d.colliderB,v=(h=(o=d.bodyB)===null||o===void 0?void 0:o.transform)!==null&&h!==void 0?h:new st;if(c instanceof We&&g instanceof We){const x=c.radius+g.radius,b=_.pos.distance(v.pos);return-(x-b)}if(c instanceof Be&&g instanceof Be&&d.info.localSide){let x,b;return d.info.collider===c?(x=new he(_.apply(d.info.localSide.begin).add(c.offset),_.apply(d.info.localSide.end).add(c.offset)),b=v.apply(t).add(g.offset)):(x=new he(v.apply(d.info.localSide.begin).add(g.offset),v.apply(d.info.localSide.end).add(g.offset)),b=_.apply(t).add(c.offset)),x.distanceToPoint(b,!0)}if(c instanceof Be&&g instanceof We||g instanceof Be&&c instanceof We){const x=_.apply(t);if(d.info.side)return d.info.side.distanceToPoint(x,!0)}if(c instanceof hi&&g instanceof Be||g instanceof hi&&c instanceof Be){let x;if(d.info.collider===c?x=v.apply(t):x=_.apply(t),d.info.side)return d.info.side.distanceToPoint(x,!0)}if(c instanceof We&&g instanceof hi||g instanceof We&&c instanceof hi){const x=v.apply(t);let b;c instanceof We&&(b=c.getFurthestPoint(d.normal));const P=x.distance(b);if(d.info.side)return P>0?-P:0}return 0}};class hi extends Hs{constructor(t){var i;super(),this._globalMatrix=_e.identity(),this.begin=t.begin||k.Zero,this.end=t.end||k.Zero,this.offset=(i=t.offset)!==null&&i!==void 0?i:k.Zero}clone(){return new hi({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var t;const i=this._transform;return(t=i?.globalPos.add(this.offset))!==null&&t!==void 0?t:this.offset}get center(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.average(i)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const t=this._getTransformedBegin(),i=this._getTransformedEnd(),n=t.distance(i);return i.sub(t).scale(1/n)}getLength(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.distance(i)}contains(){return!1}rayCast(t,i=1/0){var n;const o=this._getTransformedBegin().sub(t.pos);if(t.dir.cross(this.getSlope())===0&&o.cross(t.dir)!==0)return null;const h=t.dir.cross(this.getSlope());if(h===0)return null;const c=o.cross(this.getSlope())/h;if(c>=0&&c<=i){const _=o.cross(t.dir)/h/this.getLength();if(_>=0&&_<=1)return{distance:c,normal:this.asLine().normal(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(Pt),point:t.getPoint(c)}}return null}getClosestLineBetween(t){if(t instanceof We)return Zi.CircleEdgeClosestLine(t,this);if(t instanceof Be)return Zi.PolygonEdgeClosestLine(t,this).flip();if(t instanceof hi)return Zi.EdgeEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof We)return Di.CollideCircleEdge(t,this);if(t instanceof Be)return Di.CollidePolygonEdge(t,this);if(t instanceof hi)return Di.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this._getTransformedBegin(),n=this._getTransformedEnd();return t.dot(i)>0?i:n}_boundsFromBeginEnd(t,i,n=10){return new lt(Math.min(t.x,i.x)-n,Math.min(t.y,i.y)-n,Math.max(t.x,i.x)+n,Math.max(t.y,i.y)+n)}get bounds(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return this._boundsFromBeginEnd(t,i)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new he(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new he(this.begin,this.end)}get axes(){const i=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),n=[];return n.push(i),n.push(i.negate()),n.push(i.normal()),n.push(i.normal().negate()),n}getInertia(t){const i=this.end.sub(this.begin).distance()/2;return t*i*i}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(t){const i=[],n=[this._getTransformedBegin(),this._getTransformedEnd()],o=n.length;for(let h=0;h<o;h++)i.push(n[h].dot(t));return new Wr(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i){const n=this._getTransformedBegin(),o=this._getTransformedEnd();t.drawLine(n,o,i,2),t.drawCircle(n,2,i),t.drawCircle(o,2,i)}}class Te{static registerGraphicsContext(t){Te._ctx=t}static draw(t){this._drawCalls.push(t)}static drawPoint(t,i){Te.draw(n=>{n.debug.drawPoint(t,i)})}static drawLine(t,i,n){Te.draw(o=>{o.debug.drawLine(t,i,n)})}static drawLines(t,i){t.length>1&&Te.draw(n=>{for(let o=0;o<t.length-1;o++)n.debug.drawLine(t[o],t[o+1],i)})}static drawText(t,i){Te.draw(n=>{n.debug.drawText(t,i)})}static drawPolygon(t,i){t.length>1&&Te.draw(n=>{const o=t[0],h=[...t,o];for(let c=0;c<h.length-1;c++)n.debug.drawLine(h[c],h[c+1],i)})}static drawCircle(t,i,n){const{color:o,strokeColor:h,width:c}={color:K.Black,strokeColor:void 0,width:void 0,...n};Te.draw(_=>{_.drawCircle(t,i,o,h,c)})}static drawBounds(t,i){Te.draw(n=>{n.debug.drawRect(t.left,t.top,t.width,t.height,i)})}static drawRay(t,i){const{distance:n,color:o}={color:K.Blue,distance:10,...i};Te.draw(h=>{const c=t.pos,_=t.pos.add(t.dir.scale(n));h.debug.drawLine(c,_,{color:o})})}static flush(t){t.save(),t.z=Te.z;for(const i of Te._drawCalls)i(t);t.restore(),Te.clear()}static clear(){Te._drawCalls.length=0}}Te._drawCalls=[];Te.z=1/0;class Be extends Hs{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(t){if(t.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=t,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const t=[];for(let i=0;i<this._points.length;i++)t.push(this._points[(i+1)%this._points.length].sub(this._points[i]).normal());this._normals=t}get points(){return this._points}get transform(){return this._transform}constructor(t){var i;super(),this._logger=ct.getInstance(),this._transform=new ms,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(i=t.offset)!==null&&i!==void 0?i:k.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=t.points,this.isConvex()||t.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(t){this._isCounterClockwiseWinding(t)||t.reverse()}_isCounterClockwiseWinding(t){let i=0;for(let n=0;n<t.length;n++)i+=(t[(n+1)%t.length].x-t[n].x)*(t[(n+1)%t.length].y+t[n].y);return i<0}isConvex(){if(this.points.length<3)return!1;let t=this.points[this.points.length-2],i=this.points[this.points.length-1],n=Math.atan2(i.y-t.y,i.x-t.x),o=0,h=0,c=0;for(const[_,g]of this.points.entries()){if(t=i,o=n,i=g,n=Math.atan2(i.y-t.y,i.x-t.x),t.equals(i))return!1;let v=n-o;if(v<=-Math.PI?v+=Math.PI*2:v>Math.PI&&(v-=Math.PI*2),_===0){if(v===0)return!1;h=v>0?1:-1}else if(h*v<=0)return!1;c+=v}return Math.abs(Math.round(c/(Math.PI*2)))===1}tessellate(){const t=[];for(let i=1;i<this.points.length-2;i++)t.push([this.points[0],this.points[i+1],this.points[i+2]]);return t.push([this.points[0],this.points[1],this.points[2]]),new Se(t.map(i=>Ne.Polygon(i)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const t=[],i=[...this.points].reverse();let n=i.length;function o(b){return b===0?n-1:b-1}function h(b){return b===n-1?0:b+1}function c(b){const P=o(b),T=h(b),I=i[P],F=i[b],R=i[T],S=I.sub(F),M=R.sub(F);return!(S.cross(M)<0)}const _=i.map((b,P)=>c(P));function g(b,P,T,I){const F=T.sub(P),R=I.sub(T),S=P.sub(I),M=b.sub(P),W=b.sub(T),U=b.sub(I),V=F.cross(M),j=R.cross(W),X=S.cross(U);return!(V>0||j>0||X>0)}function v(){for(let b=0;b<n;b++)if(_[b]){const P=o(b),T=h(b),I=i[P],F=i[b],R=i[T];let S=!0;for(let M=0;M<n;M++){if(M===b||M===P||M===T)continue;const W=i[M];if(g(W,I,F,R)){S=!1;break}}if(S)return b}for(let b=0;b<n;b++)if(_[b])return b;return 0}function x(b){const P=o(b),T=h(b),I=i[P],F=i[b],R=i[T];t.push([I,F,R]),i.splice(b,1),_.splice(b,1),n--}for(;n>3;){const b=v();x(b);for(let P=0;P<n;P++)_[P]=c(P)}return t.push([i[0],i[1],i[2]]),new Se(t.map(b=>Ne.Polygon(b,k.Zero,!0)))}clone(){return new Be({offset:this.offset.clone(),points:this.points.map(t=>t.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const t=this.points,i=t.length;this._transformedPoints.length=0;for(let n=0;n<i;n++)this._transformedPoints[n]=this._transform.apply(t[n].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const t=[],i=this.getTransformedPoints(),n=i.length;for(let o=0;o<n;o++)t.push(new he(i[o],i[(o+1)%n]));this._sides=t,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const t=[],i=this.points,n=i.length;for(let o=0;o<n;o++)t.push(new he(i[o],i[(o+1)%n]));this._localSides=t,this._localSidesDirty=!1}return this._localSides}findSide(t){const i=this.getSides();let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=i[h],g=c.normal().dot(t);g>o&&(n=c,o=g)}return n}findLocalSide(t){const i=this.getLocalSides();let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=i[h],g=c.normal().dot(t);g>o&&(n=c,o=g)}return n}get axes(){const t=[],i=this.getSides();for(let n=0;n<i.length;n++)t.push(i[n].normal());return t}update(t){t&&(t.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(i=>G(i.x*Nt(this._transform.scale.x),i.y*Nt(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(t){const i=this._transform.applyInverse(t),n=new sn(i,new k(1,0));let o=0;const h=this.getLocalSides();for(let c=0;c<h.length;c++){const _=h[c];n.intersect(_)>=0&&o++}return o%2!==0}getClosestLineBetween(t){if(t instanceof We)return Zi.PolygonCircleClosestLine(this,t);if(t instanceof Be)return Zi.PolygonPolygonClosestLine(this,t);if(t instanceof hi)return Zi.PolygonEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof We)return Di.CollideCirclePolygon(t,this);if(t instanceof Be)return Di.CollidePolygonPolygon(this,t);if(t instanceof hi)return Di.CollidePolygonEdge(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this.getTransformedPoints();let n=null,o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=t.dot(i[h]);c>o&&(o=c,n=i[h])}return n}getFurthestLocalPoint(t){const i=this.points;let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=t.dot(i[h]);c>o&&(o=c,n=i[h])}return n}getClosestFace(t){const i=this.getSides();let n=Number.POSITIVE_INFINITY,o=-1,h=-1;for(let c=0;c<i.length;c++){const _=i[c].distanceToPoint(t);_<n&&(n=_,o=c,h=_)}return o!==-1?{distance:i[o].normal().scale(h),face:i[o]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=lt.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(t){if(this._cachedMass===t&&this._cachedInertia)return this._cachedInertia;let i=0,n=0;const o=this.points;for(let h=0;h<o.length;h++){const c=(h+1)%o.length,_=o[c].cross(o[h]);i+=_*(o[h].dot(o[h])+o[h].dot(o[c])+o[c].dot(o[c])),n+=_}return this._cachedMass=t,this._cachedInertia=t/6*(i/n)}rayCast(t,i=1/0){var n;const o=this.getSides(),h=o.length;let c=Number.MAX_VALUE,_,g=-1;for(let v=0;v<h;v++){const x=t.intersect(o[v]);x>=0&&x<c&&x<=i&&(c=x,_=o[v],g=v)}return g>=0?{collider:this,distance:c,body:(n=this.owner)===null||n===void 0?void 0:n.get(Pt),point:t.getPoint(c),normal:_.normal()}:null}project(t){const i=this.getTransformedPoints(),n=i.length;let o=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let c=0;c<n;c++){const _=i[c].dot(t);o=Math.min(o,_),h=Math.max(h,_)}return new Wr(o,h)}debug(t,i,n){const o=this.getTransformedPoints();Te.drawPolygon(o,{color:i})}}class Ne{static Box(t,i,n=k.Half,o=k.Zero){return new Be({points:new lt(-t*n.x,-i*n.y,t-t*n.x,i-i*n.y).getPoints(),offset:o})}static Polygon(t,i=k.Zero,n=!1){return new Be({points:t,offset:i,suppressConvexWarning:n})}static Circle(t,i=k.Zero){return new We({radius:t,offset:i})}static Edge(t,i){return new hi({begin:t,end:i})}static Capsule(t,i,n=k.Zero){const o=ct.getInstance();return t===i&&o.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),i>=t?new Se([Ne.Circle(t/2,G(0,-i/2+t/2).add(n)),Ne.Box(t,i-t,k.Half,n),Ne.Circle(t/2,G(0,i/2-t/2).add(n))]):new Se([Ne.Circle(i/2,G(-t/2+i/2,0).add(n)),Ne.Box(t-i,i,k.Half,n),Ne.Circle(i/2,G(t/2-i/2,0).add(n))])}}class pe extends gi{constructor(t){super(),this.events=new Qt,this.$colliderAdded=new Ze,this.$colliderRemoved=new Ze,this._collidersToRemove=[],this.set(t)}get(){return this._collider}set(t){return this.clear(),t&&(this._collider=t,this._collider.owner=this.owner,t.events.pipe(this.events),this.$colliderAdded.notifyAll(t),this.update()),t}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const t of this._collidersToRemove)t.events.unpipe(this.events),this.$colliderRemoved.notifyAll(t),t.owner=null}clone(){return new pe(this._collider.clone())}get bounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new lt}get localBounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new lt}update(){var t;const i=(t=this.owner)===null||t===void 0?void 0:t.get(st);this._collider&&(this._collider.owner=this.owner,i&&this._collider.update(i.get()))}collide(t){let i=this._collider,n=t._collider;if(!i||!n)return[];let o=!1;if(n instanceof Se&&(i=n,n=this._collider,o=!0),this._collider){const h=i.collide(n);return h?(o&&h.forEach(c=>{c.mtv=c.mtv.negate(),c.normal=c.normal.negate(),c.tangent=c.normal.perpendicular(),c.colliderA=this._collider,c.colliderB=t._collider}),h):[]}return[]}onAdd(t){this._collider&&this.update(),this.events.on("precollision",i=>{const n=i;t.events.emit("precollision",new _n(n.self,n.other,n.side,n.intersection,n.contact)),t instanceof $e&&t.onPreCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("postcollision",i=>{const n=i;t.events.emit("postcollision",new pn(n.self,n.other,n.side,n.intersection,n.contact)),t instanceof $e&&t.onPostCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("collisionstart",i=>{const n=i;t.events.emit("collisionstart",new Cr(n.self,n.other,n.side,n.contact)),t instanceof $e&&t.onCollisionStart(n.self,n.other,n.side,n.contact)}),this.events.on("collisionend",i=>{const n=i;t.events.emit("collisionend",new Pr(n.self,n.other,n.side,n.lastContact)),t instanceof $e&&t.onCollisionEnd(n.self,n.other,n.side,n.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(t,i,n=k.Half,o=k.Zero){const h=Ne.Box(t,i,n,o);return this.set(h)}usePolygonCollider(t,i=k.Zero){const n=Ne.Polygon(t,i);return this.set(n)}useCircleCollider(t,i=k.Zero){const n=Ne.Circle(t,i);return this.set(n)}useEdgeCollider(t,i){const n=Ne.Edge(t,i);return this.set(n)}useCompositeCollider(t){return this.set(new Se(t))}}var ii;(function(d){d.Rotation="rotation",d.X="x",d.Y="y"})(ii||(ii={}));class Pt extends gi{constructor(t){var i,n,o;super(),this.dependencies=[st,Mt],this.id=dn("body",Pt._ID++),this.events=new Qt,this.oldTransform=new ms,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=ut.PreventCollision,this.group=vs.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=k.Zero,this.oldVel=new k(0,0),this.oldAcc=k.Zero,this._impulseScratch=G(0,0),this._distanceFromCenterScratch=G(0,0),t?(this.collisionType=(i=t.type)!==null&&i!==void 0?i:this.collisionType,this.group=(n=t.group)!==null&&n!==void 0?n:this.group,this.useGravity=(o=t.useGravity)!==null&&o!==void 0?o:this.useGravity,this._bodyConfig={...gs().bodies,...t.config}):this._bodyConfig={...gs().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=Pt._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(t){this._bodyConfig={...gs().bodies,...t},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(t){Pt._DEFAULT_CONFIG=t}get mass(){return this._mass}set mass(t){this._mass=t,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===ut.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(t){this.isSleeping=t}set isSleeping(t){this._sleeping=t,t?(this.vel=k.Zero,this.acc=k.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const t=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),i=this._bodyConfig.sleepBias;this.sleepMotion=i*this.sleepMotion+(1-i)*t,this.sleepMotion=bt(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const t=this.owner.get(pe);if(t){t.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),t.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const i=t.get();if(i)return this._cachedInertia=i.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===ut.Fixed?0:1/this.inertia}get active(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get isActive(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get center(){return this.globalPos}onAdd(t){var i,n;this.transform=(i=this.owner)===null||i===void 0?void 0:i.get(st),this.motion=(n=this.owner)===null||n===void 0?void 0:n.get(Mt)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get globalPos(){return this.transform.globalPos}set globalPos(t){this.transform.globalPos=t}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t}get torque(){return this.motion.torque}set torque(t){this.motion.torque=t}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(t){this.transform.globalRotation=t}get scale(){return this.transform.globalScale}set scale(t){this.transform.globalScale=t}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(t){this.motion.scaleFactor=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}applyImpulse(t,i){if(this.collisionType!==ut.Active)return;const n=i.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(ii.X)>-1&&(n.x=0),this.limitDegreeOfFreedom.indexOf(ii.Y)>-1&&(n.y=0),this.vel.addEqual(n),!this.limitDegreeOfFreedom.includes(ii.Rotation)){const o=t.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*o.cross(i)}}applyLinearImpulse(t){if(this.collisionType!==ut.Active)return;const i=t.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(ii.X)&&(i.x=0),this.limitDegreeOfFreedom.includes(ii.Y)&&(i.y=0),this.vel=this.vel.add(i)}applyAngularImpulse(t,i){if(this.collisionType===ut.Active&&!this.limitDegreeOfFreedom.includes(ii.Rotation)){const n=t.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*n.cross(i)}}captureOldTransform(){this.__oldTransformCaptured=!0;const t=this.transform.get();t.clone(this.oldTransform),this.oldTransform.parent=t.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}Pt._ID=0;Pt._DEFAULT_CONFIG={...gs().bodies};class Nr extends Xn{constructor(t){super(t),this.width=t.width,this.height=t.height,this.rasterize()}clone(){return new Nr({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.color&&t.fillRect(0,0,this.width,this.height),this.strokeColor&&t.strokeRect(0,0,this.width,this.height)}}class ha extends Xn{get radius(){return this._radius}set radius(t){this._radius=t,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(t){var i,n,o;super(t),this._radius=0;const h=(i=t.lineWidth)!==null&&i!==void 0?i:t.strokeColor?1:0;this.padding=(n=t.padding)!==null&&n!==void 0?n:2+h/2,this.radius=t.radius,this.filtering=(o=t.filtering)!==null&&o!==void 0?o:ge.Blended,this.rasterize()}clone(){return new ha({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.radius>0&&(t.beginPath(),t.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&t.fill(),this.strokeColor&&t.stroke())}}class Ls extends gi{constructor(t){var i,n;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(i=t?.useColliderShape)!==null&&i!==void 0?i:this.useColliderShape,this.useGraphicsBounds=(n=t?.useGraphicsBounds)!==null&&n!==void 0?n:this.useGraphicsBounds,this.localBounds=t?.localBounds}}class Wt{static CreateReversibleEasingFunction(t){return(i,n,o,h)=>o<n?n-(t(i,o,n,h)-o):t(i,n,o,h)}static CreateVectorEasingFunction(t){return(i,n,o,h)=>new k(t(i,n.x,o.x,h),t(i,n.y,o.y,h))}}Wt.Linear=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,i*d/n+t));Wt.EaseInQuad=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,i*d*d+t));Wt.EaseOutQuad=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,-i*d*(d-2)+t));Wt.EaseInOutQuad=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n/2,d<1?i/2*d*d+t:(d--,-i/2*(d*(d-2)-1)+t)));Wt.EaseInCubic=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,i*d*d*d+t));Wt.EaseOutCubic=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,d--,i*(d*d*d+1)+t));Wt.EaseInOutCubic=Wt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n/2,d<1?i/2*d*d*d+t:(d-=2,i/2*(d*d*d+2)+t)));class Yu{constructor(t){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=t}add(t){this._actions.push(t)}remove(t){const i=this._actions.indexOf(t);this._actions.splice(i,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const t=this._actions.length;for(let i=0;i<t;i++)this._actions[i].reset();this._completedActions=[]}update(t){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new Zl(this._currentAction,this._entity))),this._currentAction.update(t),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new Ql(this._currentAction,this._entity));const i=this._actions.shift();i&&this._completedActions.push(i)}}}let Em=0;function zt(){return Em++}class ju{constructor(t,i,n){this.id=zt(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new Xr(t),this._actionQueue=this._repeatContext.getQueue(),this._repeat=n,this._originalRepeat=n,this._repeatBuilder(this._repeatContext),this._repeat--}update(t){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(t)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class Zu{constructor(t,i){this.id=zt(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new Xr(t),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(t){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(t))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function Qu(d,t,i){return(1-i)*d+t*i}function rc(d,t,i,n){const o=(d-t+we)%we>=Math.PI,h=Math.abs(t-d),c=we-h;let _=0,g=0;h>c?(_=c,g=h):(_=h,g=c);let v=0,x=1;switch(i){case ie.ShortestPath:v=_,x=o?1:-1;break;case ie.LongestPath:v=g,x=o?-1:1;break;case ie.Clockwise:x=1,v=o?_:g;break;case ie.CounterClockwise:x=-1,v=o?g:_;break}return d+x*(v*n)}function Gr(d,t,i){return d.scale(1-i).add(t.scale(i))}function $u(d,t,i){return(i-d)/(t-d)}function Ku(d,t,i){const n=i.sub(d),o=t.sub(d),h=n.x/o.x,c=n.y/o.y;return Math.min(h,c)}function $i(d,t,i,n,o){const h=$u(d,t,o);return Qu(i,n,h)}function Im(d,t,i,n,o){const h=Ku(d,t,o);return Gr(i,n,h)}function Ju(d){return d.offset instanceof k&&typeof d.duration=="number"}class tf{constructor(t,i){var n;if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._easing=Wt.Linear,this._offset=i.offset,this._easing=(n=i.easing)!==null&&n!==void 0?n:this._easing,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=t;const i=bt($i(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),c=(o-n.x)/(t/1e3),_=(h-n.y)/(t/1e3);this._motion.vel.x=c,this._motion.vel.y=_,this.isComplete(this.entity)&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=G(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class ol{constructor(t,i,n,o){if(this.id=zt(),this._started=!1,this._stopped=!1,this._entity=t,this._tx=t.get(st),this._motion=t.get(Mt),this._speed=o,this._offset=new k(i,n),o<=0)throw ct.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+o),new Error("Speed must be greater than 0 pixels per second")}update(t){this._started||(this._started=!0,this._start=new k(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(t){const i=t.get(st);return this._stopped||i.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=G(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function ef(d){return d.pos instanceof k&&typeof d.duration=="number"}class sf{constructor(t,i){var n;if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._easing=Wt.Linear,this._end=i.pos,this._easing=(n=i.easing)!==null&&n!==void 0?n:this._easing,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=t;const i=bt($i(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),c=(o-n.x)/(t/1e3),_=(h-n.y)/(t/1e3);this._motion.vel.x=c,this._motion.vel.y=_,this.isComplete(this.entity)&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=G(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class al{constructor(t,i,n,o){this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._end=new k(i,n),this._speed=o}update(t){this._started||(this._started=!0,this._start=new k(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const i=this._dir.scale(this._speed);this._motion.vel=G(i.x,i.y),this.isComplete(this.entity)&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(t){const i=t.get(st);return this._stopped||new k(i.pos.x,i.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=G(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Rm(d){return typeof d.angle=="number"&&typeof d.duration=="number"}class nf{constructor(t,i){var n;if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=i.angle,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(n=i.rotationType)!==null&&n!==void 0?n:ie.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=t;const i=bt($i(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=rc(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(n-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class rf{constructor(t,i,n,o){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._end=i,this._speed=n,this._rotationType=o||ie.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const i=Math.abs(this._end-this._start),n=we-i;switch(i>n?(this._shortDistance=n,this._longDistance=i):(this._shortDistance=i,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+we)%we>=Math.PI,this._rotationType){case ie.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case ie.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case ie.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case ie.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Dm(d){return typeof d.angleRadiansOffset=="number"&&typeof d.duration=="number"}class of{constructor(t,i){var n;if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=i.angleRadiansOffset,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(n=i.rotationType)!==null&&n!==void 0?n:ie.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._endAngle=_s(this._startAngle+this._offset),this._started=!0),this._currentMs-=t;const i=bt($i(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=rc(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(n-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class af{constructor(t,i,n,o){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._speed=n,this._offset=i,this._rotationType=o||ie.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const i=Math.abs(this._end-this._start),n=we-i;switch(i>n?(this._shortDistance=n,this._longDistance=i):(this._shortDistance=i,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+we)%we>=Math.PI,this._rotationType){case ie.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case ie.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case ie.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case ie.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function hf(d){return typeof d.scale=="object"&&typeof d.duration=="number"}class lf{constructor(t,i){if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._endScale=G(1,1),this._startScale=G(1,1),this._endScale=i.scale,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=t;const i=bt($i(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Gr(this._startScale,this._endScale,i),o=this._tx.scale,h=n.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=k.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class cf{constructor(t,i,n,o,h){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._endX=i,this._endY=n,this._speedX=o,this._speedY=h}update(t){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*i}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*i}this.isComplete()&&(this._tx.scale=G(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function df(d){return typeof d.scaleOffset=="object"&&typeof d.duration=="number"}class uf{constructor(t,i){if(this.entity=t,this.id=zt(),this._started=!1,this._stopped=!1,this._endScale=G(1,1),this._scaleOffset=G(0,0),this._startScale=G(1,1),this._scaleOffset=i.scaleOffset,this._tx=t.get(st),this._motion=t.get(Mt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=t;const i=bt($i(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Gr(this._startScale,this._endScale,i),o=this._tx.scale,h=n.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=k.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class ff{constructor(t,i,n,o){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._offset=new k(i,n),this._speedX=this._speedY=o}update(t){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class gu{constructor(t){this.id=zt(),this._hasBeenCalled=!1,this._method=t}update(t){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class _f{constructor(t,i,n,o,h){this.easingFcn=h,this.id=zt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new k(0,0),this._lerpEnd=new k(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._lerpDuration=o,this._lerpEnd=new k(i,n)}_initialize(){this._lerpStart=new k(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=G((i-this._tx.pos.x)/(t/1e3),(n-this._tx.pos.y)/(t/1e3))):(this._tx.pos=G(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=k.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=G(0,0),this._stopped=!0}}class pf{constructor(t,i,n,o,h){this.easingFcn=h,this.id=zt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new k(0,0),this._lerpEnd=new k(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._lerpDuration=o,this._offset=new k(i,n)}_initialize(){this._lerpStart=new k(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=G((i-this._tx.pos.x)/(t/1e3),(n-this._tx.pos.y)/(t/1e3))):(this._tx.pos=G(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=k.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=G(0,0),this._stopped=!0}}class gf{constructor(t,i,n,o=1){this.id=zt(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=t.get(ne),this._timeVisible=i,this._timeNotVisible=n,this._duration=(i+n)*o}update(t){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=t,this._totalTime+=t,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class mf{constructor(t,i,n){this.id=zt(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=t.get(ne),this._endOpacity=i,this._remainingTime=this._originalTime=n}update(t){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*t)/this._remainingTime),this._remainingTime-=t,this.isComplete()&&(this._graphics.opacity=this._endOpacity),ct.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class vf{constructor(t){this.id=zt(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=t}update(t){this._started||(this._started=!0),this._elapsedTime+=t}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class wf{constructor(t){this.id=zt(),this._stopped=!1,this._entity=t}update(t){this._entity.get(Ln).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class hl{constructor(t,i,n){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._followTx=i.get(st),this._followMotion=i.get(Mt),this._current=new k(this._tx.pos.x,this._tx.pos.y),this._end=new k(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=n!==void 0?n:this._current.distance(this._end),this._speed=0}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(i!==0&&(this._speed=i),this._current=G(this._tx.pos.x,this._tx.pos.y),this._end=G(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const n=this._dir.scale(this._speed);this._motion.vel=G(n.x,n.y)}else this._motion.vel=G(0,0);this.isComplete()&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}stop(){this._motion.vel=G(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class ll{constructor(t,i,n){this.id=zt(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=t.get(st),this._motion=t.get(Mt),this._meetTx=i.get(st),this._meetMotion=i.get(Mt),this._current=new k(this._tx.pos.x,this._tx.pos.y),this._end=new k(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=n||0,n!==void 0&&(this._speedWasSpecified=!0)}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));i!==0&&!this._speedWasSpecified&&(this._speed=i),this._current=G(this._tx.pos.x,this._tx.pos.y),this._end=G(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const n=this._dir.scale(this._speed);this._motion.vel=G(n.x,n.y),this.isComplete()&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=G(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class xf{constructor(t,i,n=1e3){var o;this.id=zt(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=t.get(ne),this._duration=n,this._entity=t,this._material=(o=t.scene)===null||o===void 0?void 0:o.engine.graphicsContext.createMaterial({name:"flash-material",color:i,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=n}update(t){var i;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=t,this._graphics&&((i=this._material)===null||i===void 0||i.update(n=>{n.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Vr{constructor(t){var i;if(this._distLookup=[],this.quality=4,t.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...t.controlPoints],this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(t){this._controlPoints=[...t],this._calculateLookup()}setControlPoint(t,i){this._controlPoints[t]=i,this._calculateLookup()}_calculateLookup(){let t=0;this._distLookup.length=0;let i=this.controlPoints[0];const n=this.controlPoints.length*this.quality;for(let o=0;o<n;o++){const h=o/(n-1),c=this.getPoint(h),_=i.distance(c);t+=_,this._distLookup.push(t),i=c}this._arcLength=t}_getTimeGivenDistance(t){const i=this._distLookup.length,n=this.arcLength;if(t>=0&&t<n){for(let o=0;o<i-1;o++)if(this._distLookup[o]<=t&&t<this._distLookup[o+1])return $i(this._distLookup[o],this._distLookup[o+1],o/(i-1),(o+1)/(i-1),t)}return t/n}getPoint(t){const i=[...this.controlPoints];for(let n=1;n<i.length;n++)for(let o=0;o<i.length-n;o++)i[o]=Gr(i[o],i[o+1],t);return i[0]}getTangent(t){const i=t*t,n=this.controlPoints[0],o=this.controlPoints[1],h=this.controlPoints[2],c=this.controlPoints[3];return n.scale(-3*i+6*t-3).add(o.scale(9*i-12*t+3).add(h.scale(-9*i+6*t).add(c.scale(3*i)))).normalize()}getUniformTangent(t){const i=t*this.arcLength,n=this._getTimeGivenDistance(i);return this.getTangent(n)}getNormal(t){return this.getTangent(t).normal()}getUniformNormal(t){return this.getUniformTangent(t).normal()}getUniformPoint(t){const i=t*this.arcLength,n=this._getTimeGivenDistance(i);return this.getPoint(n)}clone(){return new Vr({controlPoints:[...this.controlPoints],quality:this.quality})}}class bf{constructor(t,i){var n;if(this.id=zt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(st),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new Vr({controlPoints:[G(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(n=i.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=t;const i=bt($i(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class yf{constructor(t,i){var n;if(this.id=zt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(st),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new Vr({controlPoints:[G(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(n=i.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=t;const i=bt($i(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class Xr{constructor(t){this._entity=t,this._queue=new Yu(t)}getQueue(){return this._queue}update(t){this._queue.update(t)}clearActions(){this._queue.clearActions()}runAction(t){return t.reset(),this._queue.add(t),this}curveBy(t){return this._queue.add(new yf(this._entity,t)),this}curveTo(t){return this._queue.add(new bf(this._entity,t)),this}easeTo(...t){var i,n;let o=0,h=0,c=0,_=Wt.Linear;return t[0]instanceof k?(o=t[0].x,h=t[0].y,c=t[1],_=(i=t[2])!==null&&i!==void 0?i:_):(o=t[0],h=t[1],c=t[2],_=(n=t[3])!==null&&n!==void 0?n:_),this._queue.add(new _f(this._entity,o,h,c,_)),this}easeBy(...t){var i,n;let o=0,h=0,c=0,_=Wt.Linear;return t[0]instanceof k?(o=t[0].x,h=t[0].y,c=t[1],_=(i=t[2])!==null&&i!==void 0?i:_):(o=t[0],h=t[1],c=t[2],_=(n=t[3])!==null&&n!==void 0?n:_),this._queue.add(new pf(this._entity,o,h,c,_)),this}moveTo(t,i,n){let o=0,h=0,c=0;return t instanceof k?(o=t.x,h=t.y,c=+(i??0),this._queue.add(new al(this._entity,o,h,c))):typeof t=="number"&&typeof i=="number"&&typeof n=="number"?(o=t,h=i,c=n,this._queue.add(new al(this._entity,o,h,c))):ef(t)&&this._queue.add(new sf(this._entity,t)),this}moveBy(t,i,n){let o=0,h=0,c=0;return t instanceof k&&typeof i=="number"?(o=t.x,h=t.y,c=i,this._queue.add(new ol(this._entity,o,h,c))):typeof t=="number"&&typeof i=="number"&&typeof n=="number"?(o=t,h=i,c=n,this._queue.add(new ol(this._entity,o,h,c))):Ju(t)&&this._queue.add(new tf(this._entity,t)),this}rotateTo(t,i,n){return typeof t=="number"&&typeof i=="number"?this._queue.add(new rf(this._entity,t,i,n)):typeof t=="object"&&this._queue.add(new nf(this._entity,t)),this}rotateBy(t,i,n){return typeof t=="object"?this._queue.add(new of(this._entity,t)):this._queue.add(new af(this._entity,t,i,n)),this}scaleTo(t,i,n,o){let h=1,c=1,_=0,g=0;return hf(t)?(this._queue.add(new lf(this._entity,t)),this):(t instanceof k&&i instanceof k&&(h=t.x,c=t.y,_=i.x,g=i.y),typeof t=="number"&&typeof i=="number"&&(h=t,c=i,_=n,g=o),this._queue.add(new cf(this._entity,h,c,_,g)),this)}scaleBy(t,i,n){if(df(t))return this._queue.add(new uf(this._entity,t)),this;let o=1,h=1;return t instanceof k&&(o=t.x,h=t.y,n=i),typeof t=="number"&&typeof i=="number"&&(o=t,h=i),this._queue.add(new ff(this._entity,o,h,n)),this}blink(t,i,n=1){return this._queue.add(new gf(this._entity,t,i,n)),this}fade(t,i){return this._queue.add(new mf(this._entity,t,i)),this}flash(t,i=1e3){return this._queue.add(new xf(this._entity,t,i)),this}delay(t){return this._queue.add(new vf(t)),this}die(){return this._queue.add(new wf(this._entity)),this}callMethod(t){return this._queue.add(new gu(t)),this}repeat(t,i){return i?(this._queue.add(new ju(this._entity,t,i)),this):(this.repeatForever(t),this)}repeatForever(t){return this._queue.add(new Zu(this._entity,t)),this}follow(t,i){return i===void 0?this._queue.add(new hl(this._entity,t)):this._queue.add(new hl(this._entity,t,i)),this}meet(t,i){return i===void 0?this._queue.add(new ll(this._entity,t)):this._queue.add(new ll(this._entity,t,i)),this}toPromise(){return new Promise(i=>{this._queue.add(new gu(()=>{i()}))})}}class Ln extends gi{constructor(){super(...arguments),this.dependencies=[st,Mt],this._ctx=null}onAdd(t){this._ctx=new Xr(t)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(t){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(t)}update(t){var i;return(i=this._ctx)===null||i===void 0?void 0:i.update(t)}clearActions(){var t;(t=this._ctx)===null||t===void 0||t.clearActions()}curveBy(t){return this._getCtx().curveBy.apply(this._ctx,[t])}curveTo(t){return this._getCtx().curveTo.apply(this._ctx,[t])}easeTo(...t){return this._getCtx().easeTo.apply(this._ctx,t)}easeBy(...t){return this._getCtx().easeBy.apply(this._ctx,t)}moveTo(t,i,n){return this._getCtx().moveTo.apply(this._ctx,[t,i,n])}moveBy(t,i,n){return this._getCtx().moveBy.apply(this._ctx,[t,i,n])}rotateTo(t,i,n){return this._getCtx().rotateTo.apply(this._ctx,[t,i,n])}rotateBy(t,i,n){return this._getCtx().rotateBy.apply(this._ctx,[t,i,n])}scaleTo(t,i,n,o){return this._getCtx().scaleTo.apply(this._ctx,[t,i,n,o])}scaleBy(t,i,n){return this._getCtx().scaleBy.apply(this._ctx,[t,i,n])}blink(t,i,n){return this._getCtx().blink(t,i,n)}fade(t,i){return this._getCtx().fade(t,i)}flash(t,i=1e3){return this._getCtx().flash(t,i)}delay(t){return this._getCtx().delay(t)}die(){return this._getCtx().die()}callMethod(t){return this._getCtx().callMethod(t)}repeat(t,i){return this._getCtx().repeat(t,i)}repeatForever(t){return this._getCtx().repeatForever(t)}follow(t,i){return this._getCtx().follow(t,i)}meet(t,i){return this._getCtx().meet(t,i)}toPromise(){return this._getCtx().toPromise()}}function Mm(d){return d instanceof $e}const Fm={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class $e extends Ge{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(t){this.body.oldPos.setTo(t.x,t.y)}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t.clone()}get oldVel(){return this.body.oldVel}set oldVel(t){this.body.oldVel.setTo(t.x,t.y)}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t.clone()}set oldAcc(t){this.body.oldAcc.setTo(t.x,t.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(t){this.transform.rotation=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}get scale(){return this.get(st).scale}set scale(t){this.get(st).scale=t}get anchor(){return this._anchor}set anchor(t){this._anchor=Ii(t,i=>this._handleAnchorChange(i)),this._handleAnchorChange(t)}_handleAnchorChange(t){this.graphics&&(this.graphics.anchor=t)}get offset(){return this._offset}set offset(t){this._offset=Ii(t,i=>this._handleOffsetChange(i)),this._handleOffsetChange(t)}_handleOffsetChange(t){this.graphics&&(this.graphics.offset=t)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(t){t&&(t&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!t&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=t)}get color(){return this.graphics.color}set color(t){this.graphics.color=t}constructor(t){super(),this.events=new Qt,this._anchor=Ii(k.Half,ht=>this._handleAnchorChange(ht)),this._offset=Ii(k.Zero,ht=>this._handleOffsetChange(ht)),this.logger=ct.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=ht=>{this._dragging&&(this.pos=ht.worldPos)},this._pointerDragLeaveHandler=ht=>{this._dragging&&(this.pos=ht.worldPos)};const{name:i,x:n,y:o,pos:h,coordPlane:c,scale:_,width:g,height:v,radius:x,collider:b,vel:P,acc:T,rotation:I,angularVelocity:F,z:R,color:S,visible:M,opacity:W,anchor:U,offset:V,collisionType:j,collisionGroup:X,silenceWarnings:nt}={...t};this.name=i??this.name,this.anchor=U??$e.defaults.anchor.clone(),this.offset=V??k.Zero,this.transform=new st,this.addComponent(this.transform),this.pos=h??G(n??0,o??0),this.rotation=I??0,this.scale=_??G(1,1),this.z=R??0,this.transform.coordPlane=c??ke.World,this._silenceWarnings=nt??!1,this.pointer=new Ls,this.addComponent(this.pointer),this.graphics=new ne({anchor:this.anchor,offset:this.offset,opacity:W}),this.addComponent(this.graphics),this.motion=new Mt,this.addComponent(this.motion),this.vel=P??k.Zero,this.acc=T??k.Zero,this.angularVelocity=F??0,this.actions=new Ln,this.addComponent(this.actions),this.body=new Pt,this.addComponent(this.body),this.body.collisionType=j??ut.Passive,X&&(this.body.group=X),S&&(this.color=S),b?(this.collider=new pe(b),this.addComponent(this.collider)):x?(this.collider=new pe(Ne.Circle(x)),this.addComponent(this.collider),S&&this.graphics.add(new ha({color:S,radius:x}))):g>0&&v>0?(this.collider=new pe(Ne.Box(g,v,this.anchor)),this.addComponent(this.collider),S&&g&&v&&this.graphics.add(new Nr({color:S,width:g,height:v}))):(this.collider=new pe,this.addComponent(this.collider)),this.graphics.isVisible=M??!0}clone(){const t=new $e({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});t.clearComponents(),t.processComponentRemoval(),t.addComponent(t.transform=this.transform.clone(),!0),t.addComponent(t.pointer=this.pointer.clone(),!0),t.addComponent(t.graphics=this.graphics.clone(),!0),t.addComponent(t.motion=this.motion.clone(),!0),t.addComponent(t.actions=this.actions.clone(),!0),t.addComponent(t.body=this.body.clone(),!0),t.addComponent(t.collider=this.collider.clone(),!0);const i=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],n=this.getComponents();for(const o of n)i.includes(o)||t.addComponent(o.clone(),!0);return t}onInitialize(t){}_initialize(t){super._initialize(t);for(const i of this.children)i._initialize(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_prekill(t){this.events.emit("prekill",new Sl(this)),this.onPreKill(t)}onPreKill(t){}_postkill(t){this.events.emit("postkill",new El(this)),this.onPostKill(t)}onPostKill(t){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new na(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(st).z}set z(t){this.get(st).z=t}get center(){const t=this.getGlobalPos();return new k(t.x+this.width/2-this.anchor.x*this.width,t.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new k(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(st).globalRotation}get globalRotation(){return this.get(st).globalRotation}getGlobalPos(){return this.get(st).globalPos}get globalPos(){return this.get(st).globalPos}getGlobalScale(){return this.get(st).globalScale}get globalScale(){return this.get(st).globalScale}get globalZ(){return this.get(st).globalZ}contains(t,i,n=!1){const o=G(t,i),h=this.get(pe);h.update();const c=h.get();if(!c)return!1;const _=c.contains(o);return n?_||this.children.some(g=>g.contains(t,i,!0)):_}within(t,i){const n=this.get(pe),o=t.get(pe),h=n.get(),c=o.get();return h&&c?h.getClosestLineBetween(c).getLength()<=i:!1}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i),this._postupdate(t,i),this._remove(t)}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreCollisionResolve(t,i,n,o){}onPostCollisionResolve(t,i,n,o){}onCollisionStart(t,i,n,o){}onCollisionEnd(t,i,n,o){}_preupdate(t,i){this.events.emit("preupdate",new Us(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new zs(t,i,this)),this.onPostUpdate(t,i)}}$e.defaults={anchor:k.Half};function Af(d){return d instanceof oc}class oc extends $e{constructor(t){var i,n;super({...t}),this.get(st).coordPlane=ke.Screen,this.anchor=(i=t?.anchor)!==null&&i!==void 0?i:G(0,0),this.body.collisionType=(n=t?.collisionType)!==null&&n!==void 0?n:ut.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!t?.collider&&t?.width>0&&t?.height>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(t){this._engine=t,super._initialize(t)}contains(t,i,n=!0){if(n)return super.contains(t,i);const o=this._engine.worldToScreenCoordinates(new k(t,i));return super.contains(o.x,o.y)}}class on{get complete(){return this._complete}constructor(t){var i;this._logger=ct.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const n=(i=t.action)!==null&&i!==void 0?i:t.fcn,o=t.interval,h=t.repeats,c=t.numberOfRepeats,_=t.randomRange,g=t.random;if(c&&c>=0&&(this.maxNumberOfRepeats=c,!h))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=on._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=o,_){if(_[0]>_[1])throw new Error("min value must be lower than max value for range");this.random=g??new Nn,this.randomRange=_,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=h||this.repeats,n&&this.on(n)}on(t){this._callbacks.push(t)}off(t){const i=this._callbacks.indexOf(t);this._callbacks.splice(i,1)}update(t){this._running&&(this._totalTimeAlive+=t,this._elapsedTime+=t,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(i=>{i.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(t,i){if(t&&t>=0&&(this._baseInterval=this.interval=t),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=i,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}on._MAX_ID=0;class la extends gi{constructor(t){super(),this.parallaxFactor=G(1,1),this.parallaxFactor=t??this.parallaxFactor}}class ca extends gi{constructor(t,i=!0){super(),this.draw=t,this.useTransform=i}}function mu(d){return d&&d._dispatchPointerEvents&&d._processPointerToObject}class Bm{get events(){return this.object.events}init(t,i,n){this.object=t,this.contains=i,this.active=n}}class ac{constructor(){this._proxyPool=new Lr(()=>new Bm,t=>t,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(t,i,n){const o=this._proxyPool.rent(!1);o.init(t,i,n),this._proxies.push(o),this._objectToProxy.set(t,o)}_getProxy(t){const i=this._objectToProxy.get(t);if(i)return i;throw new Error("No PointerTargetProxy for object")}removeObject(t){const i=this._objectToProxy.get(t);if(i){const n=this._proxies.indexOf(i);n>-1&&this._proxies.splice(n,1),this._proxyPool.return(i)}}_objectCurrentlyUnderPointer(t,i){return!!(this._currentFrameObjectToPointers.has(t)&&this._currentFrameObjectToPointers.get(t).includes(i))}_objectWasUnderPointer(t,i){return!!(this._lastFrameObjectToPointers.has(t)&&this._lastFrameObjectToPointers.get(t).includes(i))}_entered(t,i){return this._objectCurrentlyUnderPointer(t,i)&&!this._lastFrameObjectToPointers.has(t)}_left(t,i){return!this._currentFrameObjectToPointers.has(t)&&this._objectWasUnderPointer(t,i)}addPointerToObject(t,i){const n=this._objectToProxy.get(t);n&&this._addPointerToProxy(n,i)}_addPointerToProxy(t,i){if(!this._currentFrameObjectToPointers.has(t)){this._currentFrameObjectToPointers.set(t,[i]);return}const n=this._currentFrameObjectToPointers.get(t);this._currentFrameObjectToPointers.set(t,n.concat(i))}dispatchEvents(t,i){const n=new Set(this._lastFrameObjectToPointers.keys()),o=new Set(this._currentFrameObjectToPointers.keys());let h,c,_;for(let g=0;g<i.length;g++){const v=i[g],x=this._getProxy(v);if(mu(v)&&v._dispatchPointerEvents(t),n.has(x)||o.has(x)){_=this._processDownAndEmit(t,x),c=this._processUpAndEmit(t,x),h=this._processMoveAndEmit(t,x);const b=[...h.values(),..._.values(),...c.values()];this._processEnterLeaveAndEmit(t,x,b),this._processCancelAndEmit(t,x),this._processWheelAndEmit(t,x)}}}processPointerToObject(t,i){for(let n=0;n<i.length;n++){const o=i[n],h=this._getProxy(o);mu(o)&&o._processPointerToObject(t);for(const[c,_]of t.currentFramePointerCoords.entries())h.contains(_)&&this._addPointerToProxy(h,c)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(t,i){const n=new Map;for(const o of t.currentFrameDown)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerdown",o),t.isDragStart(o.pointerId)&&i.events.emit("pointerdragstart",o)),n.set(o.pointerId,o);return n}_processUpAndEmit(t,i){const n=new Map;for(const o of t.currentFrameUp)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerup",o),t.isDragEnd(o.pointerId)&&i.events.emit("pointerdragend",o)),n.set(o.pointerId,o);return n}_processMoveAndEmit(t,i){const n=new Map;for(const o of t.currentFrameMove)o.active&&i.active()&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointermove",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragmove",o)),n.set(o.pointerId,o);return n}_processEnterLeaveAndEmit(t,i,n){for(const o of n){if(o.active&&i.active()&&this._entered(i,o.pointerId)){i.events.emit("pointerenter",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragenter",o);break}if(o.active&&i.active()&&(this._left(i,o.pointerId)||this._objectCurrentlyUnderPointer(i,o.pointerId)&&o.type==="up")){i.events.emit("pointerleave",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragleave",o);break}}}_processCancelAndEmit(t,i){for(const n of t.currentFrameCancel)n.active&&i.active()&&this._objectCurrentlyUnderPointer(i,n.pointerId)&&i.events.emit("pointercancel",n)}_processWheelAndEmit(t,i){for(const n of t.currentFrameWheel)n.active&&i.active()&&this._objectCurrentlyUnderPointer(i,0)&&i.events.emit("pointerwheel",n)}}const km={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class Cf extends Ge{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let t=0;t<this.tiles.length;t++)this.tiles[t]&&this.tiles[t].flagDirty()}get x(){var t;return(t=this.transform.pos.x)!==null&&t!==void 0?t:0}set x(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.get(st).pos=G(t,this.y))}get y(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.pos.y)!==null&&i!==void 0?i:0}set y(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.transform.pos=G(this.x,t))}get z(){var t;return(t=this.transform.z)!==null&&t!==void 0?t:0}set z(t){this.transform&&(this.transform.z=t)}get rotation(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.rotation)!==null&&i!==void 0?i:0}set rotation(t){this.transform&&(this.transform.rotation=t)}get scale(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.scale)!==null&&i!==void 0?i:k.One}set scale(t){var i;!((i=this.transform)===null||i===void 0)&&i.scale&&(this.transform.scale=t)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get vel(){return this._motion.vel}set vel(t){this._motion.vel=t}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,n,o;super([],t.name),this.events=new Qt,this._token=0,this.logger=ct.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(i=t.meshingLookBehind)!==null&&i!==void 0?i:this.meshingLookBehind,this.addComponent(new st),this.addComponent(new Mt),this.addComponent(new Pt({type:ut.Fixed})),this.addComponent(new ne({onPostDraw:(c,_)=>this.draw(c,_)})),this.addComponent(new ca((c,_)=>this.debug(c,_),!1)),this.addComponent(new pe),this.addComponent(new Ls),this.pointer=this.get(Ls),this._graphics=this.get(ne),this.transform=this.get(st),this._motion=this.get(Mt),this.collider=this.get(pe),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(n=t.pos)!==null&&n!==void 0?n:k.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(o=t.renderFromTopOfGraphic)!==null&&o!==void 0?o:this.renderFromTopOfGraphic,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight,this.rows=t.rows,this.columns=t.columns,this._pointerEventDispatcher=new ac,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let h=[];for(let c=0;c<this.columns;c++){for(let _=0;_<this.rows;_++){const g=new Pf({x:c,y:_,map:this});g.map=this,this.tiles[c+_*this.columns]=g,this._pointerEventDispatcher.addObject(g,v=>g.bounds.contains(v.worldPos),()=>!0),h.push(g),this._rows[_]||(this._rows[_]=[]),this._rows[_].push(g)}this._cols[c]=h,h=[]}this._graphics.localBounds=new lt({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(t){super._initialize(t),this._engine=t}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:k.Zero;{const n=t.offset;return this._originalOffsets.set(t,n),n}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const t=[];this._composite=this.collider.useCompositeCollider([]);let i=null;const n=(h,c)=>h&&c?h.top===c.top&&h.bottom===c.bottom&&h.right===c.left:!1,o=(h,c,_=this.meshingLookBehind)=>{if(!h)return!1;for(let g=c.length-1;g>=0;g--){if(_--<0)return!1;const v=c[g];if(n(v,h))return c[g]=v.combine(h),!0}return!1};for(let h=0;h<this.columns;h++){for(let c=0;c<this.rows;c++){const _=this.tiles[h+c*this.columns];if(_.solid)if(_.getColliders().length>0){for(const g of _.getColliders()){const v=this._getOrSetColliderOriginalOffset(g);g.offset=G(_.x*this.tileWidth*this.scale.x,_.y*this.tileHeight*this.scale.y).add(v),g.owner=this,this._composite.addCollider(g)}i&&!o(i,t)&&t.push(i),i=null}else i?i=i.combine(_.defaultGeometry):i=_.defaultGeometry;else i&&!o(i,t)&&t.push(i),i=null}i&&!o(i,t)&&t.push(i),i=null}for(const h of t){const c=Ne.Box(h.width,h.height,k.Zero,G(h.left-this.pos.x,h.top-this.pos.y));c.owner=this,this._composite.addCollider(c)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(t){var i;return(i=this.tiles[t])!==null&&i!==void 0?i:null}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const{x:i,y:n}=this._getTileCoordinates(t),o=this.getTile(i,n);return i>=0&&n>=0&&i<this.columns&&n<this.rows&&o?o:null}_getTileCoordinates(t){t=this.transform.applyInverse(t);const i=Math.floor(t.x/this.tileWidth),n=Math.floor(t.y/this.tileHeight);return{x:i,y:n}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let t=this._engine.screen.getWorldBounds();const i=this.get(la);if(i&&this.isInitialized){let T=this.pos;const I=k.One.sub(i.parallaxFactor),F=this._engine.currentScene.camera.pos.scale(I);T=T.sub(F),t=t.translate(T)}const n=this.transform.coordPlane===ke.Screen?this._engine.screen.getScreenBounds():t,o=this._getTileCoordinates(n.topLeft),h=this._getTileCoordinates(n.topRight),c=this._getTileCoordinates(n.bottomRight),_=this._getTileCoordinates(n.bottomLeft),g=Math.min(bt(o.x,0,this.columns-1),bt(h.x,0,this.columns-1)),v=Math.min(bt(o.y,0,this.rows-1),bt(h.y,0,this.rows-1)),x=Math.max(bt(c.x,0,this.columns-1),bt(_.x,0,this.columns-1)),b=Math.max(bt(c.y,0,this.rows-1),bt(_.y,0,this.rows-1)),P=[];for(let T=g;T<=x;T++)for(let I=v;I<=b;I++)P.push(this.getTile(T,I));return P}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(t,i){this._initialize(t),this.onPreUpdate(t,i),this.emit("preupdate",new Us(t,i,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(t,i),this.emit("postupdate",new zs(t,i,this))}draw(t,i){if(!this.isInitialized)return;this.emit("predraw",new qn(t,i,this));let n,o,h;const c=this.getOnScreenTiles();for(let _=0;_<c.length;_++){const g=c[_],v=g.getGraphicsOffsets();for(n=g.getGraphics(),o=0,h=n.length;o<h;o++){const x=n[o],b=v[o];if(x){Tl(x)&&x?.tick(i,this._token);const P=this.renderFromTopOfGraphic?0:x.height-this.tileHeight;x.draw(t,g.x*this.tileWidth+b.x,g.y*this.tileHeight-P+b.y)}}}this.emit("postdraw",new Yn(t,i,this))}debug(t,i){const{showAll:n,showGrid:o,gridColor:h,gridWidth:c,showSolidBounds:_,solidBoundsColor:g,showColliderGeometry:v}=i.tilemap,{geometryColor:x,geometryLineWidth:b,geometryPointSize:P}=i.collider,T=this.tileWidth*this.columns*this.scale.x,I=this.tileHeight*this.rows*this.scale.y,F=this.pos;if(o||n){for(let R=0;R<this.rows+1;R++){const S=G(0,R*this.tileHeight*this.scale.y);t.drawLine(F.add(S),F.add(G(T,S.y)),h,c)}for(let R=0;R<this.columns+1;R++){const S=G(R*this.tileWidth*this.scale.x,0);t.drawLine(F.add(S),F.add(G(S.x,I)),h,c)}}if(n||_||v){const R=this._composite.getColliders();t.save(),t.translate(this.pos.x,this.pos.y),t.scale(this.scale.x,this.scale.y);for(const S of R){const M=S.localBounds,W=S.worldPos.sub(this.pos);_&&t.drawRectangle(W,M.width,M.height,g)}if(t.restore(),v)for(const S of R)S.debug(t,x,{lineWidth:b,pointSize:P})}if(n||_){if(t.save(),t.z=999,_)for(let R=0;R<this.tiles.length;R++)this.tiles[R].bounds.draw(t);t.restore()}}}class Pf{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(t){var i;(i=this.map)===null||i===void 0||i.flagCollidersDirty(),this._solid=t}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(t,i){this._graphics.push(t),i?.offset?this._offsets.push(i.offset):this._offsets.push(k.Zero)}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&(this._graphics.splice(i,1),this._offsets.splice(i,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(t){var i,n;this._posDirty=!1,this.events=new Qt,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=t.x,this.y=t.y,this.map=t.map,this._width=t.map.tileWidth*this.map.scale.x,this._height=t.map.tileHeight*this.map.scale.y,this.solid=(i=t.solid)!==null&&i!==void 0?i:this.solid,this._graphics=(n=t.graphics)!==null&&n!==void 0?n:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const t=this.map.pos.add(G(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new lt(t.x,t.y,t.x+this.map.tileWidth,t.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(G(this.x*this._width,this.y*this._height)),this._bounds=new lt(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new k(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}class Tf{constructor(t){this.camera=t}lockToActor(t){this.camera.addStrategy(new Sf(t))}lockToActorAxis(t,i){this.camera.addStrategy(new Ef(t,i))}elasticToActor(t,i,n){this.camera.addStrategy(new If(t,i,n))}radiusAroundActor(t,i){this.camera.addStrategy(new Rf(t,i))}limitCameraBounds(t){this.camera.addStrategy(new Df(t))}}var Jo;(function(d){d[d.X=0]="X",d[d.Y=1]="Y"})(Jo||(Jo={}));class Sf{constructor(t){this.target=t,this.action=(i,n,o,h)=>i.center}}class Ef{constructor(t,i){this.target=t,this.axis=i,this.action=(n,o,h,c)=>{const _=n.center,g=o.getFocus();return this.axis===Jo.X?new k(_.x,g.y):new k(g.x,_.y)}}}class If{constructor(t,i,n){this.target=t,this.cameraElasticity=i,this.cameraFriction=n,this.action=(o,h,c,_)=>{const g=o.center;let v=h.getFocus(),x=h.vel.clone();const b=g.sub(v).scale(this.cameraElasticity);x=x.add(b);const P=x.scale(-1).scale(this.cameraFriction);return x=x.add(P),v=v.add(x),v}}}class Rf{constructor(t,i){this.target=t,this.radius=i,this.action=(n,o,h,c)=>{const _=n.center,g=o.getFocus(),v=_.sub(g),x=v.magnitude;if(x>=this.radius){const b=x-this.radius;return g.add(v.normalize().scale(b))}return g}}}class Df{constructor(t){this.target=t,this.boundSizeChecked=!1,this.action=(i,n,o,h)=>{const c=n.getFocus();this.boundSizeChecked||((i.bottom-i.top<o.drawHeight||i.right-i.left<o.drawWidth)&&ct.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let _=c.x,g=c.y;return c.x<i.left+o.halfDrawWidth?_=i.left+o.halfDrawWidth:c.x>i.right-o.halfDrawWidth&&(_=i.right-o.halfDrawWidth),c.y<i.top+o.halfDrawHeight?g=i.top+o.halfDrawHeight:c.y>i.bottom-o.halfDrawHeight&&(g=i.bottom-o.halfDrawHeight),G(_,g)}}}const Lm={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class Mf{constructor(){this.events=new Qt,this.transform=_e.identity(),this.inverse=_e.identity(),this._cameraStrategies=[],this.strategy=new Tf(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new Fs(k.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=k.Zero,this.acc=k.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Wt.EaseInOutCubic,this._easing=Wt.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=G(0,0)}get zoom(){return this._z}set zoom(t){this._z=t,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(t){this._angularVelocity=t}get pos(){return this._pos}set pos(t){this._posChanged=!0,this._pos=new Fs(t,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(t){!this._follow&&!this._cameraMoving&&(this.pos=G(t,this.pos.y))}get y(){return this.pos.y}set y(t){!this._follow&&!this._cameraMoving&&(this.pos=G(this.pos.x,t))}get dx(){return this.vel.x}set dx(t){this.vel=G(t,this.vel.y)}get dy(){return this.vel.y}set dy(t){this.vel=G(this.vel.x,t)}get ax(){return this.acc.x}set ax(t){this.acc=G(t,this.acc.y)}get ay(){return this.acc.y}set ay(t){this.acc=G(this.acc.x,t)}getFocus(){return this.pos}move(t,i,n=Wt.EaseInOutCubic){if(typeof n!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(t):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(t),this._lerpPromise=new Promise(o=>{this._lerpResolve=o}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=i,this._lerpEnd=t,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=n,this._lerpPromise)}shake(t,i,n){this._isShaking=!0,this._shakeMagnitudeX=t,this._shakeMagnitudeY=i,this._shakeDuration=n}zoomOverTime(t,i=0,n=Wt.EaseInOutCubic){if(this._zoomPromise=new Promise(o=>{this._zoomResolve=o}),i)this._isZooming=!0,this._zoomEasing=n,this._currentZoomTime=0,this._zoomDuration=i,this._zoomStart=this.zoom,this._zoomEnd=t;else return this._isZooming=!1,this.zoom=t,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new lt(0,0,0,0)}addStrategy(t){this._cameraStrategies.push(t)}removeStrategy(t){Gn(t,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(t,i){this.events.emit("preupdate",new Us(t,i,this)),this.onPreUpdate(t,i)}onPreUpdate(t,i){}_postupdate(t,i){this.events.emit("postupdate",new zs(t,i,this)),this.onPostUpdate(t,i)}onPostUpdate(t,i){}get isInitialized(){return this._isInitialized}_initialize(t){if(!this.isInitialized){this._engine=t,this._screen=t.screen;const i=this._screen.contentArea;let n=G(i.width/2,i.height/2);if(!this._engine.loadingComplete){const o=this._screen.peekResolution();o&&(n=G(o.width/2,o.height/2))}this._halfWidth=n.x,this._halfHeight=n.y,this._posChanged||(this.pos=n),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(t,t.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(t),this.events.emit("initialize",new jn(t,this)),this._isInitialized=!0}}onInitialize(t){}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}runStrategies(t,i){for(const n of this._cameraStrategies)this.pos=n.action.call(n,n.target,this,t,i)}updateViewport(){this._viewport=new lt(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(t,i){if(this._initialize(t),this._preupdate(t,i),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(i/1e3)),this.zoom+=this.dz*i/1e3,this.vel=this.vel.add(this.acc.scale(i/1e3)),this.dz+=this.az*i/1e3,this.rotation+=this.angularVelocity*i/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const n=this._zoomEasing,o=n(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=o,this._currentZoomTime+=i}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const o=Wt.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=o,this._currentLerpTime+=i}else{this.pos=this._lerpEnd;const n=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(n)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=i,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(t,i),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(t,i),this._posChanged=!1}draw(t){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const i=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,n=this.pos.scale(i).add(this._oldPos.scale(1-i));n.clone(this.drawPos),this.updateTransform(n)}if(t.snapToPixel){const i=this.drawPos.clone(this._snapPos);i.x=~~(i.x+pt*Nt(i.x)),i.y=~~(i.y+pt*Nt(i.y)),i.clone(this.drawPos),this.updateTransform(i)}t.multiply(this.transform)}updateTransform(t){const i=this._screen.resolution.width/this.zoom,n=this._screen.resolution.height/this.zoom,o=G(-t.x+i/2+this._xShake,-t.y+n/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(i/2,n/2),this.transform.rotate(this.rotation),this.transform.translate(-i/2,-n/2),this.transform.translate(o.x,o.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const Um={ExitTrigger:"exit",EnterTrigger:"enter"};class Ff extends $e{constructor(t){var i,n,o,h;super({...t}),this.events=new Qt,this.filter=(i=t.filter)!==null&&i!==void 0?i:()=>!0,this.repeat=(n=t.repeat)!==null&&n!==void 0?n:-1,this.action=(o=t.action)!==null&&o!==void 0?o:()=>{},this.target=t.target,this.graphics.isVisible=(h=t.visible)!==null&&h!==void 0?h:!1,this.body.collisionType=ut.Passive,this.events.on("collisionstart",({other:c})=>{this._matchesTarget(c.owner)&&(this.events.emit("enter",new Yl(this,c.owner)),this._dispatchAction(c.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:c})=>{this._matchesTarget(c.owner)&&this.events.emit("exit",new jl(this,c.owner))})}_matchesTarget(t){return this.filter(t)&&(this.target===void 0||this.target===t)}_dispatchAction(t){this.repeat!==0&&(this.action.call(this,t),this.repeat--)}}const Ki={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var li;(function(d){d.Update="update",d.Draw="draw"})(li||(li={}));class _i{}_i.priority=Ki.Average;class Bf{constructor(t){this._world=t,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>i=>{this.addEntity(i)},this._createChildRemovedHandler=()=>i=>{this.removeEntity(i,!1)},this._entitiesToRemove=[]}updateEntities(t,i){for(let n=0;n<this.entities.length;n++){const o=this.entities[n];o.update(t.engine,i),o.isActive||this.removeEntity(o)}}findEntitiesForRemoval(){for(let t=0;t<this.entities.length;t++){const i=this.entities[t];i.isActive||this.removeEntity(i)}}addEntity(t){if(t.isActive=!0,t.scene=this._world.scene,t&&!this._entityIndex[t.id]){this._entityIndex[t.id]=t,this.entities.push(t),this._world.queryManager.addEntity(t),t.children.forEach(o=>{o.scene=t.scene,this.addEntity(o)});const i=this._createChildAddedHandler();this._childAddedHandlerMap.set(t,i);const n=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(t,n),t.childrenAdded$.subscribe(i),t.childrenRemoved$.subscribe(n)}}removeEntity(t,i=!0){var n,o;let h=0;t instanceof Ge?h=t.id:h=t;const c=this._entityIndex[h];if(c&&c.isActive&&(c.isActive=!1),c&&i){this._entitiesToRemove.push(c);return}if(delete this._entityIndex[h],c){c.scene=null,Gn(c,this.entities),this._world.queryManager.removeEntity(c),c.children.forEach(v=>{v.scene=null,this.removeEntity(v,i)});const _=this._childAddedHandlerMap.get(c);_&&c.childrenAdded$.unsubscribe(_);const g=this._childRemovedHandlerMap.get(c);g&&c.childrenRemoved$.unsubscribe(g),!((o=(n=this._world)===null||n===void 0?void 0:n.scene)===null||o===void 0)&&o.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let t=0;t<this._entitiesToRemove.length;t++){const i=this._entitiesToRemove[t];i.isActive||this.removeEntity(i,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let t=0;t<this.entities.length;t++)this.entities[t].processComponentRemoval()}getById(t){return this._entityIndex[t]}getByName(t){return this.entities.filter(i=>i.name===t)}clear(){for(let t=this.entities.length-1;t>=0;t--)this.removeEntity(this.entities[t])}}class Ir{constructor(t){if(this.requiredComponents=t,this.components=new Set,this.entities=[],this.entityAdded$=new Ze,this.entityRemoved$=new Ze,t.length===0)throw new Error("Cannot create query without components");for(const i of t)this.components.add(i);this.id=Ir.createId(t)}static createId(t){return t.slice().map(i=>i.name).sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAll(Array.from(this.components))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class Rr{constructor(t){if(this.requiredTags=t,this.tags=new Set,this.entities=[],this.entityAdded$=new Ze,this.entityRemoved$=new Ze,t.length===0)throw new Error("Cannot create tag query without tags");for(const i of t)this.tags.add(i);this.id=Rr.createId(t)}static createId(t){return t.slice().sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAllTags(Array.from(this.tags))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class kf{constructor(t){this._world=t,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=i=>n=>{this.addComponent(i,n)},this._createRemoveComponentHandler=i=>n=>{this.removeComponent(i,n)},this._createAddTagHandler=i=>n=>{this.addTag(i,n)},this._createRemoveTagHandler=i=>n=>{this.removeTag(i,n)}}createQuery(t){const i=Ir.createId(t);if(this._queries.has(i))return this._queries.get(i);const n=new Ir(t);this._queries.set(n.id,n);for(const o of t){const h=this._componentToQueriesIndex.get(o);h?h.push(n):this._componentToQueriesIndex.set(o,[n])}for(const o of this._world.entities)this.addEntity(o);return n}createTagQuery(t){const i=Rr.createId(t);if(this._tagQueries.has(i))return this._tagQueries.get(i);const n=new Rr(t);this._tagQueries.set(n.id,n);for(const o of t){const h=this._tagToQueriesIndex.get(o);h?h.push(n):this._tagToQueriesIndex.set(o,[n])}for(const o of this._world.entities)this.addEntity(o);return n}addEntity(t){const i=this._addComponentHandlers.get(t),n=this._removeComponentHandlers.get(t),o=i??this._createAddComponentHandler(t),h=n??this._createRemoveComponentHandler(t);this._addComponentHandlers.set(t,o),this._removeComponentHandlers.set(t,h);const c=this._addTagHandlers.get(t),_=this._removeTagHandlers.get(t),g=c??this._createAddTagHandler(t),v=_??this._createRemoveTagHandler(t);this._addTagHandlers.set(t,g),this._removeTagHandlers.set(t,v);for(const x of this._queries.values())x.checkAndAdd(t);for(const x of this._tagQueries.values())x.checkAndAdd(t);t.componentAdded$.subscribe(o),t.componentRemoved$.subscribe(h),t.tagAdded$.subscribe(g),t.tagRemoved$.subscribe(v)}removeEntity(t){const i=this._addComponentHandlers.get(t),n=this._removeComponentHandlers.get(t);for(const c of this._queries.values())c.removeEntity(t);i&&t.componentAdded$.unsubscribe(i),n&&t.componentRemoved$.unsubscribe(n);const o=this._addTagHandlers.get(t),h=this._removeTagHandlers.get(t);for(const c of this._tagQueries.values())c.removeEntity(t);o&&t.tagAdded$.unsubscribe(o),h&&t.tagRemoved$.unsubscribe(h)}addComponent(t,i){var n;const o=(n=this._componentToQueriesIndex.get(i.constructor))!==null&&n!==void 0?n:[];for(const h of o)h.checkAndAdd(t)}removeComponent(t,i){var n;const o=(n=this._componentToQueriesIndex.get(i.constructor))!==null&&n!==void 0?n:[];for(const h of o)h.removeEntity(t)}addTag(t,i){var n;const o=(n=this._tagToQueriesIndex.get(i))!==null&&n!==void 0?n:[];for(const h of o)h.checkAndAdd(t)}removeTag(t,i){var n;const o=(n=this._tagToQueriesIndex.get(i))!==null&&n!==void 0?n:[];for(const h of o)h.removeEntity(t)}}function Lf(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class Uf{constructor(t){this._world=t,this.systems=[],this.initialized=!1}get(t){return this.systems.find(i=>i instanceof t)}addSystem(t){let i;t instanceof _i?i=t:i=new t(this._world),this.systems.push(i),this.systems.sort((n,o)=>n.constructor.priority-o.constructor.priority),this.initialized&&i.initialize&&i.initialize(this._world,this._world.scene)}removeSystem(t){Gn(t,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const t of this.systems)t.initialize&&t.initialize(this._world,this._world.scene)}}updateSystems(t,i,n){const o=this.systems.filter(h=>h.systemType===t);for(const h of o)h.preupdate&&h.preupdate(i,n);for(const h of o)h.update(n);for(const h of o)h.postupdate&&h.postupdate(i,n)}clear(){for(let t=this.systems.length-1;t>=0;t--)this.removeSystem(this.systems[t])}}class zf{constructor(t){this.scene=t,this._logger=ct.getInstance(),this.queryManager=new kf(this),this.entityManager=new Bf(this),this.systemManager=new Uf(this)}query(t){return this.queryManager.createQuery(t)}queryTags(t){return this.queryManager.createTagQuery(t)}update(t,i){t===li.Update&&this.entityManager.updateEntities(this.scene,i),this.systemManager.updateSystems(t,this.scene,i),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(t){if(t instanceof Ge){this.entityManager.addEntity(t);return}if(t instanceof _i||Lf(t)){this.systemManager.addSystem(t);return}this._logger.warn(`Could not add entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(t){return this.systemManager.get(t)}remove(t,i=!0){if(t instanceof Ge){this.entityManager.removeEntity(t,i);return}if(t instanceof _i){this.systemManager.removeSystem(t);return}this._logger.warn(`Could not remove entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class da extends _i{constructor(t,i){super(),this.world=t,this.physics=i,this.systemType=li.Update,this._physicsConfigDirty=!1,i.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([st,Mt])}update(t){let i,n;const o=this.query.entities,h=this.physics.config.substep;for(let c=0;c<o.length;c++){i=o[c].get(st),n=o[c].get(Mt);const _=o[c].get(Pt);if(this._physicsConfigDirty&&_&&_.updatePhysicsConfig(this.physics.config.bodies),_?.isSleeping)continue;const g=n.acc.clone();_?.collisionType===ut.Active&&_?.useGravity&&g.addEqual(this.physics.config.gravity),o[c].parent||this.captureOldTransformWithChildren(o[c]),je.integrate(i,n,g,t/h)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(t){var i;(i=t.get(Pt))===null||i===void 0||i.captureOldTransform();for(let n=0;n<t.children.length;n++)this.captureOldTransformWithChildren(t.children[n])}}da.priority=Ki.Higher;class cl{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map}solve(t){this.preSolve(t),t=t.filter(n=>!n.isCanceled());let i;switch(this.config.contactSolveBias){case ws.HorizontalFirst:{i=sc;break}case ws.VerticalFirst:{i=ic;break}default:i=nc}t.sort((n,o)=>{const h=this.directionMap.get(n.id),c=this.directionMap.get(o.id),_=this.distanceMap.get(n.id),g=this.distanceMap.get(o.id);return i[h]-i[c]||_-g});for(const n of t)this.solvePosition(n),this.solveVelocity(n);return this.postSolve(t),t}preSolve(t){for(let n=0;n<t.length;n++){const o=t[n];if(Math.abs(o.mtv.x)<1e-4&&Math.abs(o.mtv.y)<1e-4){o.cancel();continue}const h=Ut.fromDirection(o.mtv),c=o.mtv.negate(),_=Math.abs(o.info.separation);this.distanceMap.set(o.id,_),this.directionMap.set(o.id,h===Ut.Left||h===Ut.Right?"horizontal":"vertical"),o.colliderA.events.emit("precollision",new _n(o.colliderA,o.colliderB,h,c,o)),o.colliderB.events.emit("precollision",new _n(o.colliderB,o.colliderA,Ut.getOpposite(h),c.negate(),o))}}postSolve(t){var i,n;for(let o=0;o<t.length;o++){const h=t[o];if(h.isCanceled())continue;const c=h.colliderA,_=h.colliderB,g=(i=c.owner)===null||i===void 0?void 0:i.get(Pt),v=(n=_.owner)===null||n===void 0?void 0:n.get(Pt);if(g&&v&&(g.collisionType===ut.Passive||v.collisionType===ut.Passive))continue;const x=Ut.fromDirection(h.mtv),b=h.mtv.negate();h.colliderA.events.emit("postcollision",new pn(h.colliderA,h.colliderB,x,b,h)),h.colliderB.events.emit("postcollision",new pn(h.colliderB,h.colliderA,Ut.getOpposite(x),b.negate(),h))}}solvePosition(t){var i,n;if(!t.colliderA.bounds.overlaps(t.colliderB.bounds,1e-4)){t.cancel();return}if(Math.abs(t.mtv.x)<1e-4&&Math.abs(t.mtv.y)<1e-4){t.cancel();return}let h=t.mtv;const c=t.colliderA,_=t.colliderB,g=(i=c.owner)===null||i===void 0?void 0:i.get(Pt),v=(n=_.owner)===null||n===void 0?void 0:n.get(Pt);if(g&&v){if(g.collisionType===ut.Passive||v.collisionType===ut.Passive)return;g.collisionType===ut.Active&&v.collisionType===ut.Active&&(h=h.scale(.5)),g.collisionType===ut.Active&&(g.globalPos.x-=h.x,g.globalPos.y-=h.y,c.update(g.transform.get())),v.collisionType===ut.Active&&(v.globalPos.x+=h.x,v.globalPos.y+=h.y,_.update(v.transform.get()))}}solveVelocity(t){var i,n;if(t.isCanceled())return;const o=t.colliderA,h=t.colliderB,c=(i=o.owner)===null||i===void 0?void 0:i.get(Pt),_=(n=h.owner)===null||n===void 0?void 0:n.get(Pt);if(c&&_){if(c.collisionType===ut.Passive||_.collisionType===ut.Passive)return;const g=t.normal,v=g.negate();if(c.collisionType===ut.Active&&c.vel.normalize().dot(v)<0){const x=g.scale(g.dot(c.vel.negate()));c.vel=c.vel.add(x)}if(_.collisionType===ut.Active&&_.vel.normalize().dot(g)<0){const x=v.scale(v.dot(_.vel.negate()));_.vel=_.vel.add(x)}}}}class Hf{constructor(t,i,n){this.point=t,this.local=i,this.contact=n,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new k(0,0),this.bToContact=new k(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const t=this.contact.bodyA,i=this.contact.colliderA,n=this.contact.bodyB,o=this.contact.colliderB;if(t&&n){const h=this.contact.normal,c=this.contact.tangent;this.aToContact=this.point.sub(i.center),this.bToContact=this.point.sub(o.center);const _=this.aToContact.cross(h),g=this.bToContact.cross(h);this.normalMass=t.inverseMass+n.inverseMass+t.inverseInertia*_*_+n.inverseInertia*g*g;const v=this.aToContact.cross(c),x=this.bToContact.cross(c);this.tangentMass=t.inverseMass+n.inverseMass+t.inverseInertia*v*v+n.inverseInertia*x*x}return this}getRelativeVelocity(){const t=this.contact.bodyA,i=this.contact.bodyB;if(t&&i){const n=t.vel.add(k.cross(t.angularVelocity,this.aToContact));return i.vel.add(k.cross(i.angularVelocity,this.bToContact)).sub(n)}return k.Zero}}class dl{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(t){var i;return(i=this.idToContactConstraint.get(t))!==null&&i!==void 0?i:[]}solve(t){this.preSolve(t),t=t.filter(n=>!n.isCanceled());let i;switch(this.config.contactSolveBias){case ws.HorizontalFirst:{i=sc;break}case ws.VerticalFirst:{i=ic;break}default:i=nc}return t.sort((n,o)=>{const h=this.directionMap.get(n.id),c=this.directionMap.get(o.id),_=this.distanceMap.get(n.id),g=this.distanceMap.get(o.id);return i[h]-i[c]||_-g}),this.solveVelocity(t),this.solvePosition(t),this.postSolve(t),t}preSolve(t){var i,n,o,h;for(let g=0;g<t.length;g++){const v=t[g];if(Math.abs(v.mtv.x)<1e-4&&Math.abs(v.mtv.y)<1e-4){v.cancel();continue}const x=Ut.fromDirection(v.mtv),b=Math.abs(((i=v?.info)===null||i===void 0?void 0:i.separation)||0);this.distanceMap.set(v.id,b),this.directionMap.set(v.id,x===Ut.Left||x===Ut.Right?"horizontal":"vertical"),v.colliderA.events.emit("precollision",new _n(v.colliderA,v.colliderB,x,v.mtv,v)),v.colliderA.events.emit("beforecollisionresolve",new Zo(v.colliderA,v.colliderB,x,v.mtv,v)),v.colliderB.events.emit("precollision",new _n(v.colliderB,v.colliderA,Ut.getOpposite(x),v.mtv.negate(),v)),v.colliderB.events.emit("beforecollisionresolve",new Zo(v.colliderB,v.colliderA,Ut.getOpposite(x),v.mtv.negate(),v)),v.matchAwake()}const _=Array.from(this.idToContactConstraint.keys());for(let g=0;g<t.length;g++){const v=t[g],x=_.indexOf(v.id);x>-1&&_.splice(x,1);const b=(n=this.idToContactConstraint.get(v.id))!==null&&n!==void 0?n:[];let P=0;const T=v.bodyA,I=v.colliderA,F=v.bodyB,R=v.colliderB;if(T&&F)for(let S=0;S<v.points.length;S++){const M=v.points[S],W=v.normal,U=v.tangent,V=M.sub(I.center),j=M.sub(R.center),X=V.cross(W),nt=j.cross(W),ht=T.inverseMass+F.inverseMass+T.inverseInertia*X*X+F.inverseInertia*nt*nt,wt=V.cross(U),gt=j.cross(U),At=T.inverseMass+F.inverseMass+T.inverseInertia*wt*wt+F.inverseInertia*gt*gt;b[P]&&((h=(o=b[P])===null||o===void 0?void 0:o.point)===null||h===void 0?void 0:h.squareDistance(M))<4?(b[P].point=M,b[P].local=v.localPoints[P]):b[P]=new Hf(M,v.localPoints[P],v),b[P].aToContact=V,b[P].bToContact=j,b[P].normalMass=1/ht,b[P].tangentMass=1/At;const Et=T.bounciness>F.bounciness?T.bounciness:F.bounciness,B=v.normal.dot(b[P].getRelativeVelocity());b[P].originalVelocityAndRestitution=0,B<-.1&&(b[P].originalVelocityAndRestitution=-Et*B),P++}this.idToContactConstraint.set(v.id,b)}for(const g of _)this.idToContactConstraint.delete(g);if(this.config.warmStart)this.warmStart(t);else for(let g=0;g<t.length;g++){const v=t[g],x=this.getContactConstraints(v.id);for(const b of x)b.normalImpulse=0,b.tangentImpulse=0}}postSolve(t){for(let i=0;i<t.length;i++){const n=t[i],o=n.bodyA,h=n.bodyB;if(o&&h){if(o.collisionType===ut.Passive||h.collisionType===ut.Passive)continue;o.updateMotion(),h.updateMotion()}const c=Ut.fromDirection(n.mtv);n.colliderA.events.emit("postcollision",new pn(n.colliderA,n.colliderB,c,n.mtv,n)),n.colliderA.events.emit("aftercollisionresolve",new Qo(n.colliderA,n.colliderB,c,n.mtv,n)),n.colliderB.events.emit("postcollision",new pn(n.colliderB,n.colliderA,Ut.getOpposite(c),n.mtv.negate(),n)),n.colliderB.events.emit("aftercollisionresolve",new Qo(n.colliderB,n.colliderA,Ut.getOpposite(c),n.mtv.negate(),n))}this.lastFrameContacts.clear();for(let i=0;i<t.length;i++){const n=t[i];this.lastFrameContacts.set(n.id,n)}}warmStart(t){var i;for(let n=0;n<t.length;n++){const o=t[n],h=o.bodyA,c=o.bodyB;if(h&&c){const _=(i=this.idToContactConstraint.get(o.id))!==null&&i!==void 0?i:[];for(const g of _)if(this.config.warmStart){const v=o.normal.scale(g.normalImpulse),x=o.tangent.scale(g.tangentImpulse),b=v.add(x);h.applyImpulse(g.point,b.negate()),c.applyImpulse(g.point,b)}else g.normalImpulse=0,g.tangentImpulse=0}}}solvePosition(t){var i;for(let n=0;n<this.config.positionIterations;n++)for(let o=0;o<t.length;o++){const h=t[o],c=h.bodyA,_=h.bodyB;if(c&&_){if(c.collisionType===ut.Passive||_.collisionType===ut.Passive)continue;const g=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const v of g){const x=h.normal,b=Di.FindContactSeparation(h,v.local),P=this.config.steeringFactor,T=-5,I=this.config.slop,F=bt(P*(b+I),T,0),R=x.scale(-F*v.normalMass);if(c.collisionType===ut.Active){const S=R.negate().scale(c.inverseMass);c.limitDegreeOfFreedom.includes(ii.X)&&(S.x=0),c.limitDegreeOfFreedom.includes(ii.Y)&&(S.y=0),c.globalPos=c.globalPos.add(S),c.limitDegreeOfFreedom.includes(ii.Rotation)||(c.rotation-=v.aToContact.cross(R)*c.inverseInertia)}if(_.collisionType===ut.Active){const S=R.scale(_.inverseMass);_.limitDegreeOfFreedom.includes(ii.X)&&(S.x=0),_.limitDegreeOfFreedom.includes(ii.Y)&&(S.y=0),_.globalPos=_.globalPos.add(S),_.limitDegreeOfFreedom.includes(ii.Rotation)||(_.rotation+=v.bToContact.cross(R)*_.inverseInertia)}}}}}solveVelocity(t){var i;for(let n=0;n<this.config.velocityIterations;n++)for(let o=0;o<t.length;o++){const h=t[o],c=h.bodyA,_=h.bodyB;if(c&&_){if(c.collisionType===ut.Passive||_.collisionType===ut.Passive)continue;const g=Math.min(c.friction,_.friction),v=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const x of v){let T=-x.getRelativeVelocity().dot(h.tangent)*x.tangentMass;const I=g*x.normalImpulse,F=bt(x.tangentImpulse+T,-I,I);T=F-x.tangentImpulse,x.tangentImpulse=F;const R=h.tangent.scale(T);c.applyImpulse(x.point,R.negate()),_.applyImpulse(x.point,R)}for(const x of v){const P=x.getRelativeVelocity().dot(h.normal);let T=-x.normalMass*(P-x.originalVelocityAndRestitution);const I=Math.max(x.normalImpulse+T,0);T=I-x.normalImpulse,x.normalImpulse=I;const F=h.normal.scale(T);c.applyImpulse(x.point,F.negate()),_.applyImpulse(x.point,F)}}}}}class ua extends _i{get _processor(){return this._physics.collisionProcessor}constructor(t,i){super(),this._physics=i,this.systemType=li.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new cl(i.config.arcade),this._realisticSolver=new dl(i.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=n=>this._processor.track(n),this._untrackCollider=n=>this._processor.untrack(n),this.query=t.query([st,Mt,pe]),this.query.entityAdded$.subscribe(n=>{const o=n.get(pe);o.$colliderAdded.subscribe(this._trackCollider),o.$colliderRemoved.subscribe(this._untrackCollider);const h=o.get();h&&this._processor.track(h)}),this.query.entityRemoved$.subscribe(n=>{const o=n.get(pe),h=o.get();o&&h&&this._processor.untrack(h)}),this._motionSystem=t.get(da)}initialize(t,i){this._engine=i.engine}update(t){var i,n,o,h;if(!this._physics.config.enabled)return;let c=[];for(let b=0;b<this.query.entities.length;b++){const T=this.query.entities[b].get(pe),I=T?.get();if(T&&(!((i=T.owner)===null||i===void 0)&&i.isActive)&&I)if(T.update(),I instanceof Se){const F=I.getColliders();I.compositeStrategy||(I.compositeStrategy=this._physics.config.colliders.compositeStrategy),c=c.concat(F)}else c.push(I)}this._processor.update(c,t);let _=this._processor.broadphase(c,t);this._currentFrameContacts.clear();let g=[];const v=this.getSolver(),x=this._physics.config.substep;for(let b=0;b<x;b++)if(b>0&&this._motionSystem.update(t),g.length&&(_=g.map(P=>new Qe(P.colliderA,P.colliderB))),_.length){g=this._processor.narrowphase(_,(h=(o=(n=this._engine)===null||n===void 0?void 0:n.debug)===null||o===void 0?void 0:o.stats)===null||h===void 0?void 0:h.currFrame),g=v.solve(g);for(const P of g){if(P.isCanceled())continue;const T=P.id.indexOf("|");if(T>0){const I=P.id.substring(T+1);this._currentFrameContacts.set(I,P)}else this._currentFrameContacts.set(P.id,P)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const b of this.query.entities){const P=b.get(pe);P&&P.processColliderRemoval()}}postupdate(){fe.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new cl(this._physics.config.arcade),this._realisticSolver=new dl(this._physics.config.realistic)),this._physics.config.solver===Er.Realistic?this._realisticSolver:this._arcadeSolver}debug(t){this._processor.debug(t,0)}runContactStartEnd(){for(const[t,i]of this._currentFrameContacts)if(!this._lastFrameContacts.has(t)){const n=i.colliderA,o=i.colliderB,h=Ut.fromDirection(i.mtv),c=Ut.getOpposite(h);n.events.emit("collisionstart",new Cr(n,o,h,i)),n.events.emit("contactstart",new Yo(n,o,h,i)),o.events.emit("collisionstart",new Cr(o,n,c,i)),o.events.emit("contactstart",new Yo(o,n,c,i))}for(const[t,i]of this._lastFrameContacts)if(!this._currentFrameContacts.has(t)){const n=i.colliderA,o=i.colliderB,h=Ut.fromDirection(i.mtv),c=Ut.getOpposite(h);n.events.emit("collisionend",new Pr(n,o,h,i)),n.events.emit("contactend",new jo(n,o,h,i)),o.events.emit("collisionend",new Pr(o,n,c,i)),o.events.emit("contactend",new jo(o,n,c,i))}}}ua.priority=Ki.Higher;function zm(d,t,i,n){if(d.parent!==t.parent){const x=d.clone(),b=d.globalPos.clone(),P=d.globalScale.clone(),T=d.globalRotation;x.parent=t.parent,x.globalPos=b,x.globalScale=P,x.globalRotation=T,d=x}let o=t.pos,h=t.scale,c=t.rotation;o=t.pos.scale(i).add(d.pos.scale(1-i)),h=t.scale.scale(i).add(d.scale.scale(1-i));const _=(1-i)*Math.cos(d.rotation)+i*Math.cos(t.rotation),g=(1-i)*Math.sin(d.rotation)+i*Math.sin(t.rotation);c=Math.atan2(g,_);const v=n??new ms;return v.setTransform(o,c,h),v}class hc extends _i{get sortedTransforms(){return this._sortedTransforms}constructor(t){super(),this.world=t,this.systemType=li.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new ms,this.query=this.world.query([st,ne]),this.query.entityAdded$.subscribe(i=>{const n=i.get(st);this._sortedTransforms.push(n),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{const n=i.get(st);n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const o=this._sortedTransforms.indexOf(n);o>-1&&this._sortedTransforms.splice(o,1)})}initialize(t,i){this._camera=i.camera,this._engine=i.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>t.globalZ-i.globalZ),this._zHasChanged=!1)}update(t){this._token++;let i;Lt.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let n=0;n<this._sortedTransforms.length;n++){const o=this._sortedTransforms[n],h=o.owner;if(h.hasTag("ex.offscreen")||(i=h.get(ne),!i.isVisible))continue;i.onPreTransformDraw&&i.onPreTransformDraw(this._graphicsContext,t),h.events.emit("pretransformdraw",new Dl(this._graphicsContext,t,h)),o.coordPlane===ke.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),o.coordPlane===ke.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),i.update(t,this._token);const c=h.get(la);if(c){const _=k.One.sub(c.parallaxFactor),g=this._camera.drawPos.scale(_);this._graphicsContext.translate(g.x,g.y)}this._applyTransform(h),i.material&&(this._graphicsContext.material=i.material),i.onPreDraw&&i.onPreDraw(this._graphicsContext,t),h.events.emit("predraw",new qn(this._graphicsContext,t,h)),this._applyOpacity(h),this._drawGraphicsComponent(i,o),i.onPostDraw&&i.onPostDraw(this._graphicsContext,t),h.events.emit("postdraw",new Yn(this._graphicsContext,t,h)),this._graphicsContext.restore(),o.coordPlane===ke.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),i.onPostTransformDraw&&i.onPostTransformDraw(this._graphicsContext,t),h.events.emit("posttransformdraw",new Ml(this._graphicsContext,t,h))}this._graphicsContext.restore()}_drawGraphicsComponent(t,i){var n,o;if(t.isVisible){const h=t.flipHorizontal,c=t.flipVertical,_=t.current,g=(n=t.currentOptions)!==null&&n!==void 0?n:{};if(_){let v=t.anchor,x=t.offset,b=1,P=1;g?.anchor&&(v=g.anchor),g?.offset&&(x=g.offset);const T=i.globalScale;b*=_.scale.x*T.x,P*=_.scale.y*T.y;const I=-_.width*v.x+x.x*b,F=-_.height*v.y+x.y*P,R=_.flipHorizontal,S=_.flipVertical;if((h||c)&&(_.flipHorizontal=h?!R:R,_.flipVertical=c?!S:S),_?.draw(this._graphicsContext,I,F),(h||c)&&(_.flipHorizontal=R,_.flipVertical=S),!((o=this._engine)===null||o===void 0)&&o.isDebug&&this._engine.debug.graphics.showBounds){const M=G(I,F);if(_ instanceof zn)for(const W of _.members){let U,V=k.Zero;W instanceof se?U=W:(U=W.graphic,V=W.offset),_.useAnchor?U?.localBounds.translate(M.add(V)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):U?.localBounds.translate(V).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else _?.localBounds.translate(M).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(t){const i=t.getAncestors();for(let n=0;n<i.length;n++){const o=i[n],h=o?.get(st),c=o?.get(Pt);if(h){let _=h.get();if(c&&this._engine.fixedUpdateTimestep&&c.__oldTransformCaptured&&c.enableFixedUpdateInterpolate){const g=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;_=zm(c.oldTransform,h.get(),g,this._targetInterpolationTransform)}this._graphicsContext.z=h.globalZ,this._graphicsContext.translate(_.pos.x,_.pos.y),this._graphicsContext.scale(_.scale.x,_.scale.y),this._graphicsContext.rotate(_.rotation)}}}_applyOpacity(t){var i;const n=t.getAncestors();for(let o=0;o<n.length;o++){const h=n[o],c=h?.get(ne);this._graphicsContext.opacity*=(i=c?.opacity)!==null&&i!==void 0?i:1}}}hc.priority=Ki.Average;class lc extends _i{constructor(t){super(),this.world=t,this.systemType=li.Draw,this.query=this.world.query([st])}initialize(t,i){this._graphicsContext=i.engine.graphicsContext,this._camera=i.camera,this._engine=i.engine,this._collisionSystem=t.systemManager.get(ua)}update(){var t;if(!this._engine.isDebug)return;const i=this._engine.debug.filter;let n,o;const h=this._engine.debug.entity;let c;const _=this._engine.debug.transform;let g;const v=this._engine.debug.motion;let x;const b=this._engine.debug.collider,P=this._engine.debug.physics;let T;const I=this._engine.debug.graphics;let F,R;const S=this._engine.debug.body,M=this._engine.debug.camera;for(let W=0;W<this.query.entities.length;W++){const U=this.query.entities[W];if(U.hasTag("offscreen")||U instanceof ra||i.useFilter&&(!(i.ids.length===0||i.ids.includes(U.id))||!(i.nameQuery===""||U.name.includes(i.nameQuery))))continue;let V=k.Zero;const j=G(0,16);if(n=U.id,o=U.name,c=U.get(st),this._pushCameraTransform(c),this._graphicsContext.save(),c.coordPlane===ke.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=_.debugZIndex,this._applyTransform(U),c&&((_.showAll||_.showPosition)&&this._graphicsContext.debug.drawPoint(k.Zero,{size:4,color:_.positionColor}),(_.showAll||_.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${c.pos.toString(2)}`,V),V=V.add(j)),(_.showAll||_.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${c.z.toFixed(1)})`,V),V=V.add(j)),(h.showAll||h.showId)&&(this._graphicsContext.debug.drawText(`id(${n}) ${U.parent?"child of id("+((t=U.parent)===null||t===void 0?void 0:t.id)+")":""}`,V),V=V.add(j)),(h.showAll||h.showName)&&(this._graphicsContext.debug.drawText(`name(${o})`,V),V=V.add(j)),(_.showAll||_.showRotation)&&(this._graphicsContext.drawLine(k.Zero,k.fromAngle(c.rotation).scale(50).add(k.Zero),_.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${Eu(c.rotation).toFixed(2)})`,V),V=V.add(j)),(_.showAll||_.showScale)&&this._graphicsContext.drawLine(k.Zero,c.scale.add(k.Zero),_.scaleColor,2)),T=U.get(ne),T&&(I.showAll||I.showBounds)&&T.localBounds.draw(this._graphicsContext,I.boundsColor),F=U.get(ca),F&&(F.useTransform||this._graphicsContext.restore(),F.draw(this._graphicsContext,this._engine.debug),F.useTransform||(this._graphicsContext.save(),this._applyTransform(U))),R=U.get(Pt),R&&((S.showAll||S.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${R.group.name})`,V),V=V.add(j)),(S.showAll||S.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${R.collisionType})`,V),V=V.add(j)),(S.showAll||S.showMass)&&(this._graphicsContext.debug.drawText(`mass(${R.mass})`,V),V=V.add(j)),(S.showAll||S.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${R.sleepMotion})`,V),V=V.add(j)),(S.showAll||S.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${R.canSleep?R.isSleeping:"cant sleep"})`,V),V=V.add(j))),this._graphicsContext.restore(),this._graphicsContext.save(),c.coordPlane===ke.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=_.debugZIndex,g=U.get(Mt),g&&((v.showAll||v.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${g.vel.toString(2)}`,V.add(c.globalPos)),this._graphicsContext.drawLine(c.globalPos,c.globalPos.add(g.vel),v.velocityColor,2),V=V.add(j)),(v.showAll||v.showAcceleration)&&this._graphicsContext.drawLine(c.globalPos,c.globalPos.add(g.acc),v.accelerationColor,2)),x=U.get(pe),x){const X=x.get();if((b.showAll||b.showGeometry)&&X&&X.debug(this._graphicsContext,b.geometryColor,{lineWidth:b.geometryLineWidth,pointSize:b.geometryPointSize}),b.showAll||b.showBounds){if(X instanceof Se){const nt=X.getColliders();for(const ht of nt){const wt=ht.bounds,gt=G(wt.left,wt.top);this._graphicsContext.debug.drawRect(gt.x,gt.y,wt.width,wt.height,{color:b.boundsColor}),(b.showAll||b.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${ht.owner.id})`,gt)}x.bounds.draw(this._graphicsContext,b.boundsColor)}else if(X){const nt=x.bounds,ht=G(nt.left,nt.top);this._graphicsContext.debug.drawRect(ht.x,ht.y,nt.width,nt.height,{color:b.boundsColor}),(b.showAll||b.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${x.owner.id})`,ht)}}}this._graphicsContext.restore(),this._popCameraTransform(c)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(P.showAll||P.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),P.showAll||P.showCollisionContacts||P.showCollisionNormals)for(const[W,U]of this._engine.debug.stats.currFrame.physics.contacts){if(P.showAll||P.showCollisionContacts)for(const V of U.points)this._graphicsContext.debug.drawPoint(V,{size:P.contactSize,color:P.collisionContactColor});if(P.showAll||P.showCollisionNormals)for(const V of U.points)this._graphicsContext.debug.drawLine(V,U.normal.scale(30).add(V),{color:P.collisionNormalColor})}this._graphicsContext.restore(),M&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(M.showAll||M.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,M.focusColor),(M.showAll||M.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(t,i){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),Te.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(t){const i=t.getAncestors();for(const n of i){const o=n?.get(st);o&&(this._graphicsContext.translate(o.pos.x,o.pos.y),this._graphicsContext.scale(o.scale.x,o.scale.y),this._graphicsContext.rotate(o.rotation))}}_pushCameraTransform(t){t.coordPlane===ke.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(t){t.coordPlane===ke.World&&this._graphicsContext.restore()}}lc.priority=Ki.Lowest;class cc{constructor(t,i){this.object=t,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=i,this.bounds=t.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const t=this.object.bounds,i=Math.floor(t.left/this.gridSize),n=Math.floor(t.right/this.gridSize),o=Math.floor(t.bottom/this.gridSize),h=Math.floor(t.top/this.gridSize);return this.leftX!==i||this.rightX!==n||this.bottomY!==o||this.topY!==h}clear(){for(const t of this.cells){const i=t.proxies.indexOf(this);i>-1&&t.proxies.splice(i,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class qi{constructor(){this.proxies=[]}configure(t,i){this.x=t,this.y=i,this.key=qi.calculateHashKey(t,i)}static calculateHashKey(t,i){return`${t}+${i}`}}class dc{constructor(t){this.bounds=new lt,this._hashGridCellPool=new Lr(()=>new qi,i=>(i.configure(0,0),i.proxies.length=0,i),1e3),this.gridSize=t.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,t.proxyFactory?this._buildProxy=i=>t.proxyFactory(i,this.gridSize):this._buildProxy=i=>new cc(i,this.gridSize)}query(t){const i=new Set;if(t instanceof lt){const n=t,o=Math.floor(n.left/this.gridSize),h=Math.floor(n.right/this.gridSize),c=Math.floor(n.bottom/this.gridSize),_=Math.floor(n.top/this.gridSize);for(let g=o;g<=h;g++)for(let v=_;v<=c;v++){const x=qi.calculateHashKey(g,v),b=this.sparseHashGrid.get(x);if(b)for(let P=0;P<b.proxies.length;P++)b.proxies[P].updateBounds(),b.proxies[P].bounds.intersect(n)&&i.add(b.proxies[P].object)}}else{const n=t,o=qi.calculateHashKey(Math.floor(n.x/this.gridSize),Math.floor(n.y/this.gridSize)),h=this.sparseHashGrid.get(o);if(h)for(let c=0;c<h.proxies.length;c++)h.proxies[c].updateBounds(),h.proxies[c].bounds.contains(n)&&i.add(h.proxies[c].object)}return Array.from(i)}get(t,i){const n=qi.calculateHashKey(t,i);return this.sparseHashGrid.get(n)}_insert(t,i,n){const o=qi.calculateHashKey(t,i);let h=this.sparseHashGrid.get(o);h||(h=this._hashGridCellPool.rent(),h.configure(t,i),this.sparseHashGrid.set(h.key,h)),h.proxies.push(n),n.cells.push(h),this.bounds.combine(n.bounds,this.bounds)}_remove(t,i,n){const o=qi.calculateHashKey(t,i),h=this.sparseHashGrid.get(o);if(h){const c=h.proxies.indexOf(n);c>-1&&h.proxies.splice(c,1);const _=n.cells.indexOf(h);_>-1&&n.cells.splice(_,1),h.proxies.length===0&&(this._hashGridCellPool.return(h),this.sparseHashGrid.delete(o))}}track(t){const i=this._buildProxy(t);this.objectToProxy.set(t,i);for(let n=i.leftX;n<=i.rightX;n++)for(let o=i.topY;o<=i.bottomY;o++)this._insert(n,o,i)}untrack(t){const i=this.objectToProxy.get(t);i&&(i.clear(),this.objectToProxy.delete(t))}update(t){let i=0;for(const n of t){const o=this.objectToProxy.get(n);if(o&&o.hasChanged()){for(let h=o.leftX;h<=o.rightX;h++)for(let c=o.topY;c<=o.bottomY;c++)this._remove(h,c,o);o.update();for(let h=o.leftX;h<=o.rightX;h++)for(let c=o.topY;c<=o.bottomY;c++)this._insert(h,c,o);i++}}return i}debug(t,i){const n=K.Transparent,o=K.White;for(const h of this.sparseHashGrid.values())t.drawRectangle(G(h.x*this.gridSize,h.y*this.gridSize),this.gridSize,this.gridSize,n,o,2)}}class fa extends _i{constructor(t){super(),this.world=t,this.systemType=li.Update,this._graphicsHashGrid=new dc({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new ac,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([st,Ls]),this.query.entityAdded$.subscribe(i=>{const n=i.get(st),o=i.get(Ls);this._pointerEventDispatcher.addObject(i,c=>o&&o.localBounds?o.localBounds.transform(n.get().matrix).contains(n.coordPlane===ke.World?c.worldPos:c.screenPos):!1,()=>i.isActive),this._entityToPointer.set(i,o);const h=i.get(ne);h&&(this._graphics.push(h),this._graphicsHashGrid.track(h)),this._sortedTransforms.push(n),this._sortedEntities.push(n.owner),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{this._pointerEventDispatcher.removeObject(i);const n=i.get(st);this._entityToPointer.delete(i);const o=i.get(ne);if(o){const c=this._graphics.indexOf(o);c>-1&&this._graphics.splice(c,1),this._graphicsHashGrid.untrack(o)}n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const h=this._sortedTransforms.indexOf(n);h>-1&&(this._sortedTransforms.splice(h,1),this._sortedEntities.splice(h,1))})}initialize(t,i){this._engine=i.engine,this._scene=i}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>i.z-t.z),this._sortedEntities=this._sortedTransforms.map(t=>t.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[t,i]of this._engineReceiver.currentFramePointerCoords.entries()){const n=this._scene.physics.query(i.worldPos);for(let h=0;h<n.length;h++){const c=n[h],_=this._entityToPointer.get(c.owner);_&&(_.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(c.owner,t)}const o=this._graphicsHashGrid.query(i.worldPos);for(let h=0;h<o.length;h++){const c=o[h],_=this._entityToPointer.get(c.owner);_&&(_.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(c.owner,t)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(t=>t.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(t=>t.clear())}}fa.priority=Ki.Higher;class uc extends _i{constructor(t){super(),this.world=t,this.systemType=li.Update,this._actions=[],this.query=this.world.query([Ln]),this.query.entityAdded$.subscribe(i=>this._actions.push(i.get(Ln))),this.query.entityRemoved$.subscribe(i=>{const n=i.get(Ln),o=this._actions.indexOf(n);o>-1&&this._actions.splice(o,1)})}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}}uc.priority=Ki.Higher;class Dr extends gi{constructor(t){super(),this.elevation=0,this.columns=t.columns,this.rows=t.rows,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight}}class fc extends _i{constructor(t){super(),this.world=t,this.systemType=li.Update,this.query=this.world.query([st,Dr])}update(){let t,i;for(let n=0;n<this.query.entities.length;n++){const o=this.query.entities[n];t=o.get(st),i=o.get(Dr);const c=Math.max(i.columns*i.tileWidth,i.rows*i.tileHeight)*i.elevation+t.pos.y;t.z=c}}}fc.priority=Ki.Lower;class _c extends _i{constructor(t){super(),this.world=t,this.systemType=li.Draw,this.query=this.world.query([st,ne])}initialize(t,i){this._camera=i.camera,this._screen=i.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let t,i,n;for(let o=0;o<this.query.entities.length;o++){const h=this.query.entities[o];i=h.get(ne),t=h.get(st),n=h.get(la);let c;if(n){const g=k.One.sub(n.parallaxFactor);c=this._camera.pos.scale(g)}const _=this._isOffscreen(t,i,c);_&&!h.hasTag("ex.offscreen")&&(h.events.emit("exitviewport",new Xl(h)),h.addTag("ex.offscreen")),!_&&h.hasTag("ex.offscreen")&&(h.events.emit("enterviewport",new ql(h)),h.removeTag("ex.offscreen"))}}_isOffscreen(t,i,n){if(i.forceOnScreen)return!1;if(t.coordPlane===ke.World){let o=i.localBounds;n&&(o=o.translate(n));const h=o.transform(t.get().matrix);return!this._worldBounds.overlaps(h)}else return!1}}_c.priority=Ki.Higher;class Of extends cc{constructor(t,i){var n,o;super(t,i),this.collider=t,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=i;const h=t.bounds;this.hasZeroBounds=h.hasZeroDimensions(),this.leftX=Math.floor(h.left/this.gridSize),this.rightX=Math.floor(h.right/this.gridSize),this.bottomY=Math.floor(h.bottom/this.gridSize),this.topY=Math.floor(h.top/this.gridSize),this.owner=t.owner,this.body=(n=this.owner)===null||n===void 0?void 0:n.get(Pt),this.collisionType=(o=this.body.collisionType)!==null&&o!==void 0?o:ut.PreventCollision}update(){var t,i;super.update(),this.body=(t=this.owner)===null||t===void 0?void 0:t.get(Pt),this.collisionType=(i=this.body.collisionType)!==null&&i!==void 0?i:ut.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class ul{constructor(t){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new sa(()=>new Qe({id:dn("collider",0)},{id:dn("collider",0)}),i=>(i.colliderA=null,i.colliderB=null,i),200),this.gridSize=t.size,this.hashGrid=new dc({size:this.gridSize,proxyFactory:(i,n)=>new Of(i,n)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(t){return this.hashGrid.query(t)}rayCast(t,i){var n,o,h;const c=[],_=(n=i?.maxDistance)!==null&&n!==void 0?n:1/0,g=i?.collisionGroup,v=g?g.category:(o=i?.collisionMask)!==null&&o!==void 0?o:vs.All.category,x=(h=i?.searchAllColliders)!==null&&h!==void 0?h:!1,b=t.dir.normalize(),P=b.y/b.x,T=b.x/b.y,I=Math.sqrt(1+P*P)*this.gridSize,F=Math.sqrt(1+T*T)*this.gridSize,R=t.pos.x/this.gridSize,S=t.pos.y/this.gridSize,M=G(1,1);let W=~~R,U=~~S,V=0,j=0;b.x<0?(M.x=-1,V=(R-W)*I):(M.x=1,V=(W+1-R)*I),b.y<0?(M.y=-1,j=(S-U)*F):(M.y=1,j=(U+1-S)*F);const X=new Set;let nt=!1,ht=9999;for(;!nt&&ht>0&&(ht--,!!this.hashGrid.bounds.contains(G(W*this.gridSize,U*this.gridSize)));){const wt=qi.calculateHashKey(W,U),gt=this.hashGrid.sparseHashGrid.get(wt);if(gt){const At=[];for(let Et=0;Et<gt.proxies.length;Et++){const B=gt.proxies[Et];if(!X.has(B.collider.id.value)){if(X.add(B.collider.id.value),i?.ignoreCollisionGroupAll&&B.body.group===vs.All)continue;const z=(v&B.body.group.category)!==0;if(B.body.group&&!z)continue;const Q=B.collider.rayCast(t,_);Q&&At.push(Q)}}At.sort((Et,B)=>Et.distance-B.distance);for(let Et=0;Et<At.length;Et++){const B=At[Et];if(i?.filter){if(i.filter(B)&&(c.push(B),!x)){nt=!0;break}}else if(c.push(B),!x){nt=!0;break}}}V<j?(W+=M.x,V+=I):(U+=M.y,j+=F)}return c.sort((wt,gt)=>wt.distance-gt.distance),!x&&c.length?[c[0]]:c}track(t){let i=[t];if(t instanceof Se){const n=t.getColliders();for(const o of n)o.owner=t.owner;i=n}for(const n of i)this.hashGrid.track(n)}untrack(t){let i=[t];t instanceof Se&&(i=t.getColliders());for(const n of i)this.hashGrid.untrack(n)}_canCollide(t,i){return!(t.collider.id===i.collider.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.hasZeroBounds||i.hasZeroBounds||!t.body.group.canCollide(i.body.group)||t.collisionType===ut.Fixed&&i.collisionType===ut.Fixed||t.collisionType===ut.PreventCollision||i.collisionType===ut.PreventCollision||!t.owner.isActive||!i.owner.isActive)}broadphase(t,i){const n=[];this._pairs.clear(),this._nonPairs.clear();let o=0;for(const h of this.hashGrid.objectToProxy.values())if(h.id=o++,!(!h.owner.isActive||h.collisionType===ut.PreventCollision))for(let c=0;c<h.cells.length;c++){const _=h.cells[c];for(let g=0;g<_.proxies.length;g++){const v=_.proxies[g];if(v.id===h.id)continue;const x=Qe.calculatePairHash(h.collider.id,v.collider.id);if(!this._nonPairs.has(x))if(!this._pairs.has(x)&&this._canCollide(h,v)&&h.object.bounds.overlaps(v.object.bounds)){const b=this._pairPool.get();b.colliderA=h.collider,b.colliderB=v.collider,b.id=x,this._pairs.add(x),n.push(b)}else this._nonPairs.add(x)}}return n}narrowphase(t,i){const n=[];for(let o=0;o<t.length;o++){const h=t[o].collide();for(let c=0;c<h.length;c++){const _=h[c];n.push(_),i&&i.physics.contacts.set(_.id,_)}}return this._pairPool.done(),i&&(i.physics.collisions+=n.length),n}update(t,i){return this.hashGrid.update(t)}debug(t,i){this.hashGrid.debug(t,i)}}class Wf{get config(){return Mg(this._config,t=>{this.$configUpdate.notifyAll(t)})}set config(t){this._config=t,this.$configUpdate.notifyAll(t)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const t=this._collisionProcessor.getColliders();this._config.spatialPartition===Hn.SparseHashGrid?this._collisionProcessor=new ul(this._config.sparseHashGrid):this._collisionProcessor=new Ko(this._config);for(const i of t)this._collisionProcessor.track(i)}return this._collisionProcessor}constructor(t){this.$configUpdate=new Ze,this._configDirty=!1,this.config=t,this.$configUpdate.subscribe(i=>{this._configDirty=!0,Pt.updateDefaultPhysicsConfig(i.bodies)}),this._config.spatialPartition===Hn.SparseHashGrid?this._collisionProcessor=new ul(this._config.sparseHashGrid):this._collisionProcessor=new Ko(this._config)}rayCast(t,i){return this.collisionProcessor.rayCast(t,i)}query(t){return this._collisionProcessor.query(t)}}class _a{constructor(){this.events=new Qt,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(t){this._enabled=t}setMinimumGamepadConfiguration(t){this._enableAndUpdate(),this._minimumConfiguration=t}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(t){if(!this._minimumConfiguration)return!0;if(!t)return!1;const i=t.axes.filter(o=>typeof o!==void 0).length,n=t.buttons.filter(o=>typeof o!==void 0).length;return i>=this._minimumConfiguration.axis&&n>=this._minimumConfiguration.buttons&&t.connected}emit(t,i){this.events.emit(t,i)}on(t,i){return this._enableAndUpdate(),this.events.on(t,i)}once(t,i){return this._enableAndUpdate(),this.events.once(t,i)}off(t,i){this._enableAndUpdate(),this.events.off(t,i)}update(){var t,i;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const n=this._navigator.getGamepads();for(let o=0;o<n.length;o++){if(n[o]){const c=this.at(o);!this.at(o).connected&&this._isGamepadValid(n[o])&&(c.events.pipe(this.events),this.events.emit("connect",new Ul(o,this.at(o)))),this.at(o).connected=!0}else{const c=this.at(o);c.connected&&(this.events.emit("disconnect",new zl(o,c)),c.events.unpipe(this.events)),c.connected=!1;continue}if(this.at(o).update(),n[o].timestamp&&n[o].timestamp===this._gamePadTimeStamps[o])continue;this._gamePadTimeStamps[o]=n[o].timestamp,this.at(o).navigatorGamepad=n[o];const h=n[o];if(h){for(let c=0;c<h.buttons.length;c++){const _=h.buttons[c],g=_?.value;g!==((t=this._oldPads[o])===null||t===void 0?void 0:t.getButton(c))&&(_?.pressed?(this.at(o).updateButton(c,g),this.at(o).events.emit("button",new Hl(c in Mr?c:Mr.Unknown,c,g,this.at(o)))):this.at(o).updateButton(c,0))}for(let c=0;c<h.axes.length;c++){const _=h.axes[c];_!==((i=this._oldPads[o])===null||i===void 0?void 0:i.getAxes(c))&&(this.at(o).updateAxes(c,_),this.at(o).events.emit("axis",new Ol(c,_,this.at(o))))}}this._oldPads[o]=this._clonePad(n[o])}}at(t){if(this._enableAndUpdate(),t>=this._pads.length)for(let i=this._pads.length-1,n=t;i<n;i++)this._pads.push(new zo),this._oldPads.push(new zo);return this._pads[t]}getValidGamepads(){this._enableAndUpdate();const t=[];for(let i=0;i<this._pads.length;i++)this._isGamepadValid(this.at(i).navigatorGamepad)&&this.at(i).connected&&t.push(this.at(i));return t}count(){return this._pads.filter(t=>t.connected).length}_clonePads(t){const i=[];for(let n=0,o=t.length;n<o;n++)i.push(this._clonePad(t[n]));return i}_clonePad(t){let i,n;const o=new zo;if(!t)return o;for(i=0,n=t.buttons.length;i<n;i++)t.buttons[i]&&o.updateButton(i,t.buttons[i].value);for(i=0,n=t.axes.length;i<n;i++)o.updateAxes(i,t.axes[i]);return o}}_a.MinAxisMoveThreshold=.05;class zo{constructor(){this.events=new Qt,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let t=0;t<this._buttons.length;t++)this._buttons[t]=0;for(let t=0;t<this._axes.length;t++)this._axes[t]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(t,i=1){return this._buttons[t]>=i}isButtonHeld(t,i=1){return this._buttons[t]>=i}wasButtonPressed(t,i=1){return this._buttonsDown[t]>=i}wasButtonReleased(t){return!!this._buttonsUp[t]}getButton(t){return this._buttons[t]}getAxes(t){const i=this._axes[t];return Math.abs(i)<_a.MinAxisMoveThreshold?0:i}updateButton(t,i){i===0&&this._buttons[t]?this._buttonsUp[t]=1:this._buttonsDown[t]=i,this._buttons[t]=i}updateAxes(t,i){this._axes[t]=i}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}var Mr;(function(d){d[d.Unknown=-1]="Unknown",d[d.Face1=0]="Face1",d[d.Face2=1]="Face2",d[d.Face3=2]="Face3",d[d.Face4=3]="Face4",d[d.LeftBumper=4]="LeftBumper",d[d.RightBumper=5]="RightBumper",d[d.LeftTrigger=6]="LeftTrigger",d[d.RightTrigger=7]="RightTrigger",d[d.Select=8]="Select",d[d.Start=9]="Start",d[d.LeftStick=10]="LeftStick",d[d.RightStick=11]="RightStick",d[d.DpadUp=12]="DpadUp",d[d.DpadDown=13]="DpadDown",d[d.DpadLeft=14]="DpadLeft",d[d.DpadRight=15]="DpadRight",d[d.CenterButton=16]="CenterButton",d[d.MiscButton1=17]="MiscButton1"})(Mr||(Mr={}));var fl;(function(d){d[d.LeftStickX=0]="LeftStickX",d[d.LeftStickY=1]="LeftStickY",d[d.RightStickX=2]="RightStickX",d[d.RightStickY=3]="RightStickY"})(fl||(fl={}));class Nf{constructor(t){this.inputs=t,this._handlers=new Map}execute(){for(const[t,i]of this._handlers.entries()){const n=t(this.inputs);n&&i(n)}}on(t,i){this._handlers.set(t,i)}}function Gf(){try{const d=()=>{};window.top.addEventListener("blur",d),window.top.removeEventListener("blur",d)}catch{return!0}return!1}var Fr;(function(d){d.Backquote="Backquote",d.Backslash="Backslash",d.BracketLeft="BracketLeft",d.BracketRight="BracketRight",d.Comma="Comma",d.Key0="Digit0",d.Key1="Digit1",d.Key2="Digit2",d.Key3="Digit3",d.Key4="Digit4",d.Key5="Digit5",d.Key6="Digit6",d.Key7="Digit7",d.Key8="Digit8",d.Key9="Digit9",d.Digit0="Digit0",d.Digit1="Digit1",d.Digit2="Digit2",d.Digit3="Digit3",d.Digit4="Digit4",d.Digit5="Digit5",d.Digit6="Digit6",d.Digit7="Digit7",d.Digit8="Digit8",d.Digit9="Digit9",d.Equal="Equal",d.IntlBackslash="IntlBackslash",d.IntlRo="IntlRo",d.IntlYen="IntlYen",d.A="KeyA",d.B="KeyB",d.C="KeyC",d.D="KeyD",d.E="KeyE",d.F="KeyF",d.G="KeyG",d.H="KeyH",d.I="KeyI",d.J="KeyJ",d.K="KeyK",d.L="KeyL",d.M="KeyM",d.N="KeyN",d.O="KeyO",d.P="KeyP",d.Q="KeyQ",d.R="KeyR",d.S="KeyS",d.T="KeyT",d.U="KeyU",d.V="KeyV",d.W="KeyW",d.X="KeyX",d.Y="KeyY",d.Z="KeyZ",d.KeyA="KeyA",d.KeyB="KeyB",d.KeyC="KeyC",d.KeyD="KeyD",d.KeyE="KeyE",d.KeyF="KeyF",d.KeyG="KeyG",d.KeyH="KeyH",d.KeyI="KeyI",d.KeyJ="KeyJ",d.KeyK="KeyK",d.KeyL="KeyL",d.KeyM="KeyM",d.KeyN="KeyN",d.KeyO="KeyO",d.KeyP="KeyP",d.KeyQ="KeyQ",d.KeyR="KeyR",d.KeyS="KeyS",d.KeyT="KeyT",d.KeyU="KeyU",d.KeyV="KeyV",d.KeyW="KeyW",d.KeyX="KeyX",d.KeyY="KeyY",d.KeyZ="KeyZ",d.Minus="Minus",d.Period="Period",d.Quote="Quote",d.Semicolon="Semicolon",d.Slash="Slash",d.AltLeft="AltLeft",d.AltRight="AltRight",d.Alt="Alt",d.AltGraph="AltGraph",d.Backspace="Backspace",d.CapsLock="CapsLock",d.ContextMenu="ContextMenu",d.ControlLeft="ControlLeft",d.ControlRight="ControlRight",d.Enter="Enter",d.MetaLeft="MetaLeft",d.MetaRight="MetaRight",d.ShiftLeft="ShiftLeft",d.ShiftRight="ShiftRight",d.Space="Space",d.Tab="Tab",d.Convert="Convert",d.KanaMode="KanaMode",d.NonConvert="NonConvert",d.Delete="Delete",d.End="End",d.Help="Help",d.Home="Home",d.Insert="Insert",d.PageDown="PageDown",d.PageUp="PageUp",d.Up="ArrowUp",d.Down="ArrowDown",d.Left="ArrowLeft",d.Right="ArrowRight",d.ArrowUp="ArrowUp",d.ArrowDown="ArrowDown",d.ArrowLeft="ArrowLeft",d.ArrowRight="ArrowRight",d.NumLock="NumLock",d.Numpad0="Numpad0",d.Numpad1="Numpad1",d.Numpad2="Numpad2",d.Numpad3="Numpad3",d.Numpad4="Numpad4",d.Numpad5="Numpad5",d.Numpad6="Numpad6",d.Numpad7="Numpad7",d.Numpad8="Numpad8",d.Numpad9="Numpad9",d.Num0="Numpad0",d.Num1="Numpad1",d.Num2="Numpad2",d.Num3="Numpad3",d.Num4="Numpad4",d.Num5="Numpad5",d.Num6="Numpad6",d.Num7="Numpad7",d.Num8="Numpad8",d.Num9="Numpad9",d.NumAdd="NumpadAdd",d.NumpadAdd="NumpadAdd",d.NumDecimal="NumpadDecimal",d.NumpadDecimal="NumpadDecimal",d.NumDivide="NumpadDivide",d.NumpadDivide="NumpadDivide",d.NumEnter="NumpadEnter",d.NumpadEnter="NumpadEnter",d.NumMultiply="NumpadMultiply",d.NumpadMultiply="NumpadMultiply",d.NumSubtract="NumpadSubtract",d.NumpadSubtract="NumpadSubtract",d.Esc="Escape",d.Escape="Escape",d.F1="F1",d.F2="F2",d.F3="F3",d.F4="F4",d.F5="F5",d.F6="F6",d.F7="F7",d.F8="F8",d.F9="F9",d.F10="F10",d.F11="F11",d.F12="F12",d.F13="F13",d.F14="F14",d.F15="F15",d.F16="F16",d.F17="F17",d.F18="F18",d.F19="F19",d.F20="F20",d.PrintScreen="PrintScreen",d.ScrollLock="ScrollLock",d.Pause="Pause",d.Unidentified="Unidentified"})(Fr||(Fr={}));class br extends vt{constructor(t,i,n){super(),this.key=t,this.value=i,this.originalEvent=n}}class Vf{constructor(){this.events=new Qt,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=t=>{for(const i of this._keys){const n=new br(i,t.key,t);this.events.emit("up",n),this.events.emit("release",n)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=t=>{if(!this._enabled)return;!t.metaKey&&(this._keys.includes(Fr.MetaLeft)||this._keys.includes(Fr.MetaRight))&&this._releaseAllKeys(t);const i=t.code;if(this._keys.indexOf(i)===-1){this._keys.push(i),this._keysDown.push(i);const n=new br(i,t.key,t);this.events.emit("down",n),this.events.emit("press",n)}},this._handleKeyUp=t=>{if(!this._enabled)return;const i=t.code,n=this._keys.indexOf(i);this._keys.splice(n,1),this._keysUp.push(i);const o=new br(i,t.key,t);this.events.emit("up",o),this.events.emit("release",o),t.key==="Meta"&&this._releaseAllKeys(t)}}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}init(t){let{global:i}=t;const{grabWindowFocus:n}=t;i||(Gf()?(i=window,n&&window.focus(),ct.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):i=window.top),i.addEventListener("blur",()=>{this._keys.length=0}),i.addEventListener("keyup",this._handleKeyUp),i.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(t){this._enabled=t}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let t=0;t<this._keys.length;t++)this.events.emit("hold",new br(this._keys[t]))}getKeys(){return this._keys}wasPressed(t){return this._enabled?this._keysDown.indexOf(t)>-1:!1}isHeld(t){return this._enabled?this._keys.indexOf(t)>-1:!1}wasReleased(t){return this._enabled?this._keysUp.indexOf(t)>-1:!1}triggerEvent(t,i,n){t==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:i,key:n??null})),t==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:i,key:n??null}))}}class On{static fromPagePosition(t,i,n){let o,h,c,_;arguments.length===3?(o=t,h=i,c=new k(o,h),_=n):(c=t,o=c.x,h=c.y,_=i);const g=_.screen.pageToScreenCoordinates(c),v=_.screen.screenToWorldCoordinates(g);return new On(v,c,g)}constructor(t,i,n){this.worldPos=t,this.pagePos=i,this.screenPos=n}}class yr{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(t,i,n,o,h,c){this.type=t,this.pointerId=i,this.button=n,this.pointerType=o,this.coordinates=h,this.nativeEvent=c,this.active=!0}}class Xf{cancel(){this.active=!1}constructor(t,i,n,o,h,c,_,g,v,x,b,P){this.x=t,this.y=i,this.pageX=n,this.pageY=o,this.screenX=h,this.screenY=c,this.index=_,this.deltaX=g,this.deltaY=v,this.deltaZ=x,this.deltaMode=b,this.ev=P,this.active=!0}}class _l{constructor(){this.events=new Qt,this.lastPagePos=k.Zero,this.lastScreenPos=k.Zero,this.lastWorldPos=k.Zero,this._onPointerMove=t=>{this.lastPagePos=new k(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new k(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new k(t.worldPos.x,t.worldPos.y)},this._onPointerDown=t=>{this.lastPagePos=new k(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new k(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new k(t.worldPos.x,t.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_updateWorldPosition(t){const i=On.fromPagePosition(this.lastPagePos,t);this.lastScreenPos=i.screenPos,this.lastWorldPos=i.worldPos}}var Un;(function(d){d.Pixel="Pixel",d.Line="Line",d.Page="Page"})(Un||(Un={}));var Ms;(function(d){d[d.NoButton=-1]="NoButton",d[d.Left=0]="Left",d[d.Middle=1]="Middle",d[d.Right=2]="Right",d[d.Unknown=3]="Unknown"})(Ms||(Ms={}));var cs;(function(d){d.Left="Left",d.Middle="Middle",d.Right="Right",d.Unknown="Unknown",d.NoButton="NoButton"})(cs||(cs={}));var ds;(function(d){d.Touch="Touch",d.Mouse="Mouse",d.Pen="Pen",d.Unknown="Unknown"})(ds||(ds={}));function Hm(d){return globalThis.TouchEvent&&d instanceof globalThis.TouchEvent}function Om(d){return globalThis.PointerEvent&&d instanceof globalThis.PointerEvent}class pa{constructor(t,i){this.target=t,this.engine=i,this.events=new Qt,this.primary=new _l,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(t){this._enabled=t}recreate(t,i){const n=new pa(t,i);return n.primary=this.primary,n._pointers=this._pointers,n}at(t){if(t>=this._pointers.length)for(let i=this._pointers.length-1,n=t;i<n;i++)this._pointers.push(new _l);return this._pointers[t]}count(){return this._pointers.length}isDown(t){var i;return this._enabled&&(i=this.currentFramePointerDown.get(t))!==null&&i!==void 0?i:!1}wasDown(t){var i;return this._enabled&&(i=this.lastFramePointerDown.get(t))!==null&&i!==void 0?i:!1}isDragging(t){return this._enabled?this.isDown(t):!1}isDragStart(t){return this._enabled?this.isDown(t)&&!this.wasDown(t):!1}isDragEnd(t){return this._enabled?!this.isDown(t)&&this.wasDown(t):!1}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const t of this.currentFrameDown){if(!t.active)continue;this.emit("down",t),this.at(t.pointerId).emit("down",t),this.primary.emit("pointerdown",t)}for(const t of this.currentFrameUp){if(!t.active)continue;this.emit("up",t),this.at(t.pointerId).emit("up",t)}for(const t of this.currentFrameMove){if(!t.active)continue;this.emit("move",t),this.at(t.pointerId).emit("move",t)}for(const t of this.currentFrameCancel){if(!t.active)continue;this.emit("cancel",t),this.at(t.pointerId).emit("cancel",t)}for(const t of this.currentFrameWheel)t.active&&(this.emit("pointerwheel",t),this.emit("wheel",t),this.primary.emit("pointerwheel",t),this.primary.emit("wheel",t));if(this.engine.currentScene.camera.hasChanged())for(const t of this._pointers)t._updateWorldPosition(this.engine)}clear(){for(const t of this.currentFrameUp){this.currentFramePointerCoords.delete(t.pointerId);const i=this._activeNativePointerIdsToNormalized.entries();for(const[n,o]of i)o===t.pointerId&&this._activeNativePointerIdsToNormalized.delete(n)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(t){var i;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const n={passive:!(this.engine.pageScrollPreventionMode===Bs.All||this.engine.pageScrollPreventionMode===Bs.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,n):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,n):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,n),((i=t?.grabWindowFocus)!==null&&i!==void 0?i:!0)&&Gf()){const h=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",h):(this.target.addEventListener("touchstart",h),this.target.addEventListener("mousedown",h))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(t){this._activeNativePointerIdsToNormalized.set(t,-1);const n=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((o,h)=>o-h).findIndex(o=>o===t);return this._activeNativePointerIdsToNormalized.set(t,n),n}_handle(t){if(!this._enabled)return;t.preventDefault();const i=new Map;let n,o;if(Hm(t)){n=cs.Unknown,o=ds.Touch;for(let h=0;h<t.changedTouches.length;h++){const c=t.changedTouches[h],_=On.fromPagePosition(c.pageX,c.pageY,this.engine),g=h+1,v=this._normalizePointerId(g);this.currentFramePointerCoords.set(v,_),i.set(v,_)}}else{n=this._nativeButtonToPointerButton(t.button),o=ds.Mouse;const h=On.fromPagePosition(t.pageX,t.pageY,this.engine);let c=1;Om(t)&&(c=t.pointerId,o=this._stringToPointerType(t.pointerType));const _=this._normalizePointerId(c);this.currentFramePointerCoords.set(_,h),i.set(_,h)}for(const[h,c]of i.entries())switch(t.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new yr("down",h,n,o,c,t)),this.currentFramePointerDown.set(h,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new yr("up",h,n,o,c,t)),this.currentFramePointerDown.set(h,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new yr("move",h,n,o,c,t));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new yr("cancel",h,n,o,c,t));break}}_handleWheel(t){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Bs.All||this.engine.pageScrollPreventionMode===Bs.Canvas&&t.target===this.engine.canvas)&&t.preventDefault();const i=this.engine.screen.pageToScreenCoordinates(G(t.pageX,t.pageY)),n=this.engine.screen.screenToWorldCoordinates(i),o=-1/40,h=t.deltaX||t.wheelDeltaX*o||0,c=t.deltaY||t.wheelDeltaY*o||t.wheelDelta*o||t.detail||0,_=t.deltaZ||0;let g=Un.Pixel;t.deltaMode&&(t.deltaMode===1?g=Un.Line:t.deltaMode===2&&(g=Un.Page));const v=new Xf(n.x,n.y,t.pageX,t.pageY,i.x,i.y,0,h,c,_,g,t);this.currentFrameWheel.push(v)}triggerEvent(t,i){const n=this.engine.screen.worldToPageCoordinates(i);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+t,{pointerId:0,clientX:n.x,clientY:n.y})):this._handle(new window.MouseEvent("mouse"+t,{clientX:n.x,clientY:n.y}));const o=this.engine.currentScene.world.get(fa);o.preupdate(this.engine.currentScene,1),o.update(1)}_nativeButtonToPointerButton(t){switch(t){case Ms.NoButton:return cs.NoButton;case Ms.Left:return cs.Left;case Ms.Middle:return cs.Middle;case Ms.Right:return cs.Right;case Ms.Unknown:return cs.Unknown;default:return Du(t)}}_stringToPointerType(t){switch(t){case"touch":return ds.Touch;case"mouse":return ds.Mouse;case"pen":return ds.Pen;default:return ds.Unknown}}}class pc{constructor(t){this._enabled=!0;const{pointerTarget:i,grabWindowFocus:n,engine:o}=t;this.keyboard=new Vf,this.pointers=new pa(i,o),this.gamepads=new _a,this.keyboard.init({grabWindowFocus:n}),this.pointers.init({grabWindowFocus:n}),this.gamepads.init(),this.inputMapper=new Nf({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(t){this._enabled=t,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class Wm{}const Nm={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function Vi(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class ui{get actors(){return this.world.entityManager.entities.filter(t=>t instanceof $e)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(t=>t instanceof Ff)}get tileMaps(){return this.world.entityManager.entities.filter(t=>t instanceof Cf)}get timers(){return this._timers}constructor(){this._logger=ct.getInstance(),this.events=new Qt,this.camera=new Mf,this.world=new zf(this),this.physics=new Wf(gs()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(uc),this.world.add(new da(this.world,this.physics)),this.world.add(new ua(this.world,this.physics)),this.world.add(fa),this.world.add(fc),this.world.add(_c),this.world.add(hc),this.world.add(lc)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}onPreLoad(t){}onTransition(t){}onInitialize(t){}onActivate(t){}onDeactivate(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreDraw(t,i){}onPostDraw(t,i){}_initializeChildren(){for(const t of this.entities)t._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(t){var i;if(!this.isInitialized){try{this.engine=t,this.physics.config=this.engine.physics,this.input=new pc({pointerTarget:t.pointerScope===un.Canvas?t.canvas:document,grabWindowFocus:t.grabWindowFocus,engine:t}),this.camera._initialize(t),this.world.systemManager.initialize(),await this.onInitialize(t),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,t),this.events.emit("initialize",new jn(t,this))}catch(n){throw this._logger.error(`Error during scene initialization for scene ${(i=t.director)===null||i===void 0?void 0:i.getSceneName(this)}!`),n}this._isInitialized=!0}}async _activate(t){var i,n;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(t)}catch(o){throw this._logger.error(`Error during scene activation for scene ${(n=(i=this.engine)===null||i===void 0?void 0:i.director)===null||n===void 0?void 0:n.getSceneName(this)}!`),o}}async _deactivate(t){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(t)}_preupdate(t,i){this.emit("preupdate",new Us(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.emit("postupdate",new zs(t,i,this)),this.onPostUpdate(t,i)}_predraw(t,i){this.emit("predraw",new qn(t,i,this)),this.onPreDraw(t,i)}_postdraw(t,i){this.emit("postdraw",new Yn(t,i,this)),this.onPostDraw(t,i)}update(t,i){var n;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(n=t.director)===null||n===void 0?void 0:n.getSceneName(this)}!`);return}this._preupdate(t,i);let o,h;for(o=0,h=this._cancelQueue.length;o<h;o++)this.removeTimer(this._cancelQueue[o]);this._cancelQueue.length=0;for(const c of this._timers)c.update(i);this.world.update(li.Update,i),this.camera&&this.camera.update(t,i),this._collectActorStats(t),this._postupdate(t,i),this.input.update()}draw(t,i){var n;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(t,i),this.world.update(li.Draw,i),!((n=this.engine)===null||n===void 0)&&n.isDebug&&this.debugDraw(t),this._postdraw(t,i)}debugDraw(t){this.emit("predebugdraw",new Fl(t,this)),this.emit("postdebugdraw",new Bl(t,this))}contains(t){return this.actors.indexOf(t)>-1}add(t){if(this.emit("entityadded",{target:t}),t instanceof on){Ru(this._timers,t)||this.addTimer(t);return}this.world.add(t),t.scene=this}transfer(t){let i;t instanceof Ge&&t.scene&&t.scene!==this&&(i=t.scene,t.scene.world.remove(t,!1)),t instanceof on&&t.scene&&(i=t.scene,t.scene.removeTimer(t)),i?.emit("entityremoved",{target:t}),this.add(t)}remove(t){this.emit("entityremoved",{target:t}),t instanceof Ge&&(t.isActive&&t.kill(),this.world.remove(t)),t instanceof on&&this.removeTimer(t)}clear(t=!0){for(let i=this.entities.length-1;i>=0;i--)this.world.remove(this.entities[i],t);for(let i=this.timers.length-1;i>=0;i--)this.removeTimer(this.timers[i])}addTimer(t){return this._timers.push(t),t.scene=this,t}removeTimer(t){const i=this._timers.indexOf(t);return i!==-1&&this._timers.splice(i,1),t}cancelTimer(t){return this._cancelQueue.push(t),t}isTimerActive(t){return this._timers.indexOf(t)>-1&&!t.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(t){const i=this.actors;for(let n=0;n<i.length;n++){const o=i[n];o instanceof oc&&t.stats.currFrame.actors.ui++,t.stats.currFrame.actors.alive++;for(let h=0;h<o.children.length;h++){const c=o.children[h];Af(c)?t.stats.currFrame.actors.ui++:t.stats.currFrame.actors.alive++}}}}var an;(function(d){d.Protanope="Protanope",d.Deuteranope="Deuteranope",d.Tritanope="Tritanope"})(an||(an={}));const Gm=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class qf{constructor(t,i){this._shader=new si({gl:t,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:i}),this._shader.compile(),this._buffer=new Qi({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new bs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class Yf{constructor(t,i=!1){this._colorBlindnessMode=t,this._simulate=!1,this._simulate=i}initialize(t){this._shader=new qf(t,Gm),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(t){if(this._colorBlindnessMode=t,this._shader){const i=this._shader.getShader();i.use(),this._colorBlindnessMode===an.Protanope?i.setUniformInt("u_type",0):this._colorBlindnessMode===an.Deuteranope?i.setUniformInt("u_type",1):this._colorBlindnessMode===an.Tritanope&&i.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(t){if(this._simulate=t,this._shader){const i=this._shader.getShader();i.use(),i.setUniformBoolean("u_simulate",t)}}get simulate(){return this._simulate}}class jf{constructor(t){this._engine=t,this._colorBlindPostProcessor=new Yf(an.Protanope)}correct(t){this._engine.graphicsContext instanceof ps&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(t){this._engine.graphicsContext instanceof ps&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class Zf{constructor(t){this.stats={currFrame:new Br,prevFrame:new Br},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:K.Yellow,showZIndex:!1,showScale:!1,scaleColor:K.Green,showRotation:!1,rotationColor:K.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:K.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:K.Blue,showOwner:!1,showGeometry:!0,geometryColor:K.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:K.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:K.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:K.Yellow,showAcceleration:!1,accelerationColor:K.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:K.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:K.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:K.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:K.Yellow,positionSize:1,showGrid:!1,gridColor:K.Red,gridWidth:1,showColliderGeometry:!0},this._engine=t,this.colorBlindMode=new jf(this._engine)}useTestClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const n=t.toTestClock();return i&&n.start(),this._engine.clock=n,n}useStandardClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const n=t.toStandardClock();return i&&n.start(),this._engine.clock=n,n}}class Br{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new ga,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(t){t?(this.id=t.id,this.elapsedMs=t.elapsedMs,this.fps=t.fps,this.actors.alive=t.actors.alive,this.actors.killed=t.actors.killed,this.actors.ui=t.actors.ui,this.duration.update=t.duration.update,this.duration.draw=t.duration.draw,this._physicsStats.reset(t.physics),this.graphics.drawCalls=t.graphics.drawCalls,this.graphics.drawnImages=t.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const t=new Br;return t.reset(this),t}get id(){return this._id}set id(t){this._id=t}get elapsedMs(){return this._elapsedMs}set elapsedMs(t){this._elapsedMs=t}get fps(){return this._fps}set fps(t){this._fps=t}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class ga{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(t){t?(this.pairs=t.pairs,this.collisions=t.collisions,this.contacts=t.contacts,this.fastBodies=t.fastBodies,this.fastBodyCollisions=t.fastBodyCollisions,this.broadphase=t.broadphase,this.narrowphase=t.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const t=new ga;return t.reset(this),t}get pairs(){return this._pairs}set pairs(t){this._pairs=t}get collisions(){return this._collisions}set collisions(t){this._collisions=t}get contacts(){return this._contacts}set contacts(t){this._contacts=t}get fastBodies(){return this._fastBodies}set fastBodies(t){this._fastBodies=t}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(t){this._fastBodyCollisions=t}get broadphase(){return this._broadphase}set broadphase(t){this._broadphase=t}get narrowphase(){return this._narrowphase}set narrowphase(t){this._narrowphase=t}}class pl{on(t,i){this._nativeHandlers[t]&&this.off(t,this._nativeHandlers[t]),this._nativeHandlers[t]=this._decorate(i),this.nativeComponent.addEventListener(t,this._nativeHandlers[t])}off(t,i){i||(i=this._nativeHandlers[t]),this.nativeComponent.removeEventListener(t,i),this._nativeHandlers[t]=null}_decorate(t){return i=>{this._paused||t(i)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const t in this._nativeHandlers)this.off(t)}constructor(t){this.nativeComponent=t,this._paused=!1,this._nativeHandlers={}}}class Qf{constructor(t,i){this._windowGlobal=t,this._documentGlobal=i,this._windowComponent=new pl(this._windowGlobal),this._documentComponent=new pl(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const $f={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:ge.Blended,canvasImageRendering:"auto"},Kf={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:ge.Blended,canvasImageRendering:"auto"};class Jf{constructor(t){var i;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=t.initialFps,this._samplePeriod=(i=t.samplePeriod)!==null&&i!==void 0?i:this._samplePeriod,this._currentFrameTime=1e3/t.initialFps,this._nowFn=t.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const t=this._nowFn();this._currentFrameTime=t-this._beginFrameTime,t>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(t-this._previousSampleTime),this._previousSampleTime=t,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class gc{constructor(t){var i,n,o;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=t,this.tick=t.tick,this._lastTime=(i=this.now())!==null&&i!==void 0?i:0,this._maxFps=(n=t.maxFps)!==null&&n!==void 0?n:this._maxFps,this._onFatalException=(o=t.onFatalException)!==null&&o!==void 0?o:this._onFatalException,this.fpsSampler=new Jf({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new t_({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new mc({...this._options})}setFatalExceptionHandler(t){this._onFatalException=t}schedule(t,i=0,n="preframe"){const o=this._totalElapsed+i;this._scheduledCbs.push([t,o,n])}__runScheduledCbs(t="preframe"){for(let i=this._scheduledCbs.length-1;i>-1;i--)t===this._scheduledCbs[i][2]&&this._scheduledCbs[i][1]<=this._totalElapsed&&(this._scheduledCbs[i][0](this._elapsed),this._scheduledCbs.splice(i,1))}update(t){try{this.fpsSampler.start();const i=this.now();let n=i-this._lastTime||1;const o=1e3/this._maxFps;if(n>=o){let h=0;o!==0&&(h=n%o,n=n-h),n>200&&(n=1),this._elapsed=t||n,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(t||n),this.__runScheduledCbs("postframe"),o!==0?this._lastTime=i-h:this._lastTime=i,this.fpsSampler.end()}}catch(i){this._onFatalException(i),this.stop()}}}class mc extends gc{constructor(t){super(t),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const t=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(t),this.update()}catch(i){throw window.cancelAnimationFrame(this._requestId),i}};t()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class t_ extends gc{constructor(t){super({...t}),this._logger=ct.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=t.defaultUpdateMs}now(){var t;return(t=this._currentTime)!==null&&t!==void 0?t:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(t){const i=t??this._updateMs;this._running?(this.update(i),this._currentTime+=i):this._logger.warn("The clock is not running, no step will be performed")}run(t,i){for(let n=0;n<t;n++)this.step(i??this._updateMs)}}var Vm=Ee(296);class e_{constructor(){this._toasterCss=Vm.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(t){const i=document.createElement("span");return i.innerText=t,i}toast(t,i,n){this._initialize();const o=document.createElement("div");o.className="ex-toast-message";const h=t.split("[LINK]").map(x=>this._createFragment(x));if(i){const x=document.createElement("a");x.href=i,n?x.innerText=n:x.innerText=i,h.splice(1,0,x)}const c=document.createElement("div");h.forEach(x=>{c.appendChild(x)}),o.appendChild(c);const _=document.createElement("button");_.innerText="x",_.addEventListener("click",()=>{this._container.removeChild(o)}),o.appendChild(_);const g=x=>{if(x.key==="Escape")try{this._container.removeChild(o)}catch{}document.removeEventListener("keydown",g)};document.addEventListener("keydown",g);const v=this._container.firstChild;this._container.insertBefore(o,v)}}const Xm={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class i_{get isTransitioning(){return this._isTransitioning}constructor(t,i){this._engine=t,this.events=new Qt,this._logger=ct.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new ui,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const n in i){const o=i[n];this.add(n,o),n==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const t=this._deferredGoto;this._deferredGoto=void 0;const i=this._deferredTransition;this._deferredTransition=void 0;const n=this.getSceneInstance(t);n&&i&&i._addToTargetScene(this._engine,n),await this.swapScene(t),n&&i&&await this.playTransition(i,n)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(t,i){const n=i?.loader;n instanceof Sr?this.mainLoader=n:nl(n)?this.mainLoader=new n:this.mainLoader=new gn;let o;if(i?.inTransition){const{inTransition:h}=i;o=h}if(this.startScene=t,o){const h=this.getSceneInstance(this.startScene);h&&(o._addToTargetScene(this._engine,h),this.swapScene(this.startScene).then(()=>this.playTransition(o,h)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(t){return this._sceneToLoader.get(t)}_getInTransition(t){var i;const n=this.scenes[t];if(!(n instanceof ui||Vi(n)))return(i=n?.transitions)===null||i===void 0?void 0:i.in}_getOutTransition(t){var i;const n=this.scenes[t];if(!(n instanceof ui||Vi(n)))return(i=n?.transitions)===null||i===void 0?void 0:i.out}getDeferredScene(){const t=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&t?t:null}getSceneDefinition(t){const i=this.scenes[t];if(i instanceof ui||Vi(i))return i;if(i)return i.scene}getSceneName(t){for(const[i,n]of Object.entries(this.scenes))if(n instanceof ui){if(t===n)return i}else if(!Vi(n)&&t===n.scene)return i;for(const[i,n]of Object.entries(this.scenes))if(Vi(n)){if(t.constructor===n)return i}else if(!(n instanceof ui)&&t.constructor===n.scene)return i;return null}assertAdded(t){return this}assertRemoved(t){return this}add(t,i){if(!(i instanceof ui)&&!Vi(i)){const{loader:n,transitions:o}=i,{in:h,out:c}=o??{};this._sceneToTransition.set(t,{in:h,out:c}),nl(n)?this._sceneToLoader.set(t,new n):n&&this._sceneToLoader.set(t,n)}return this.scenes[t]&&this._logger.warn("Scene",t,"already exists overwriting"),this.scenes[t]=i,this.assertAdded(t)}remove(t){if(t instanceof ui||Vi(t)){const i=t;for(const n in this.scenes)if(this.scenes.hasOwnProperty(n)){const o=this.scenes[n];let h;if(o instanceof ui||Vi(o)?h=o:h=o.scene,h===i){if(n===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${n}`);this._sceneToInstance.delete(n),this._sceneToTransition.delete(n),this._sceneToLoader.delete(n),delete this.scenes[n]}}}if(typeof t=="string"){if(t===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${t}`);this._sceneToInstance.delete(t),this._sceneToTransition.delete(t),this._sceneToLoader.delete(t),delete this.scenes[t]}}async goToScene(t,i){var n,o,h,c,_,g;const v=this.getSceneInstance(t);if(!v){this._logger.warn(`Scene ${t} does not exist! Check the name, are you sure you added it?`);return}const x=this.currentScene,b=this.currentSceneName,P=(o=(n=this._engine.input)===null||n===void 0?void 0:n.enabled)!==null&&o!==void 0?o:!0;this._isTransitioning=!0;const T=(h=this.getSceneInstance(b))===null||h===void 0?void 0:h.onTransition("out"),I=v?.onTransition("in");i={sourceOut:(c=this._getOutTransition(this.currentSceneName))!==null&&c!==void 0?c:T,destinationIn:(_=this._getInTransition(t))!==null&&_!==void 0?_:I,...i};const{sourceOut:F,destinationIn:R,sceneActivationData:S}=i,M=F??this._getOutTransition(this.currentSceneName),W=R??this._getInTransition(t),U=M?.hideLoader||W?.hideLoader;U&&this.maybeLoadScene(t,U),this._emitEvent("navigationstart",b,t),M&&await this.playTransition(M,x),await this.maybeLoadScene(t,U),W&&await W.onPreviousSceneDeactivate(this.currentScene),W&&W._addToTargetScene(this._engine,v),await this.swapScene(t,S),this._emitEvent("navigation",b,t),W&&await this.playTransition(W,v),this._emitEvent("navigationend",b,t),(g=this._engine.input)===null||g===void 0||g.toggleEnabled(P),this._isTransitioning=!1}getSceneInstance(t){const i=this.getSceneDefinition(t);if(!i)return;if(this._sceneToInstance.has(t))return this._sceneToInstance.get(t);if(i instanceof ui)return this._sceneToInstance.set(t,i),i;const n=new i;return this._sceneToInstance.set(t,n),n}async maybeLoadScene(t,i=!1){var n;const o=(n=this._getLoader(t))!==null&&n!==void 0?n:new Sr,h=this.getSceneDefinition(t),c=this.getSceneInstance(t);h&&c&&!this._loadedScenes.has(c)&&(c.onPreLoad(o),c.events.emit("preload",{loader:o}),i?this._engine.load(o,i):await this._engine.load(o),this._loadedScenes.add(c))}async playTransition(t,i){var n,o,h,c,_,g,v;if(!this.isInitialized){this._deferredTransition=t;return}if(t){this.currentTransition=t;const x=(o=(n=i.input)===null||n===void 0?void 0:n.enabled)!==null&&o!==void 0?o:!0;(h=i.input)===null||h===void 0||h.toggleEnabled(!t.blockInput),(c=this._engine.input)===null||c===void 0||c.toggleEnabled(!t.blockInput),this.currentTransition._addToTargetScene(this._engine,i),await this.currentTransition._play(),(_=i.input)===null||_===void 0||_.toggleEnabled(x)}(g=this.currentTransition)===null||g===void 0||g.kill(),(v=this.currentTransition)===null||v===void 0||v.reset(),this.currentTransition=void 0}async swapScene(t,i){const n=this._engine;if(!this.isInitialized){this._deferredGoto=t;return}const o=this.getSceneInstance(t);if(o){const h=this.currentScene,c=o;if(this._logger.debug("Going to scene:",t),this.currentScene.isInitialized){const v={engine:n,previousScene:h,nextScene:c};await this.currentScene._deactivate(v),this.currentScene.events.emit("deactivate",new Vl(v,this.currentScene)),this.currentScene.input.clear()}const _=this._sceneToLoader.get(t);await _?.areResourcesLoaded(),this.currentScene=c,this.currentSceneName=t,n.screen.setCurrentCamera(c.camera),await this.currentScene._initialize(n);const g={engine:n,previousScene:h,nextScene:c,data:i};await this.currentScene._activate(g),this.currentScene.events.emit("activate",new Gl(g,this.currentScene))}else this._logger.error("Scene",t,"does not exist!")}_emitEvent(t,i,n){const o=this.getSceneDefinition(i),h=this.getSceneDefinition(n);this.events.emit(t,{sourceScene:o,sourceName:i,destinationScene:h,destinationName:n})}}function s_(){const d={scope:(t,i)=>{const n=d.value;d.value=t;try{return i()}catch(o){throw o}finally{d.value=n}},value:void 0};return d}function n_(d){return d.value}const gl={textureCollectInterval:6e4};class r_{constructor(t){this.options=t,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=i=>{if(this._running){for(const[n,[o,h]]of this._collectors.entries()){const c=this.options.getTimestamp();for(const[_,[g,v]]of this._collectionMap.entries()){if(n!==g||v+h>=c)continue;o(_)&&this._collectionMap.delete(_)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(t,i,n){this._collectors.set(t,[n,i])}addCollectableResource(t,i){this._collectionMap.set(i,[t,this.options.getTimestamp()])}touch(t){const i=this._collectionMap.get(t);i&&this._collectionMap.set(t,[i[0],this.options.getTimestamp()])}forceCollectAll(){for(const[t,[i]]of this._collectors.entries())for(const[n]of this._collectionMap.entries())i(n)&&this._collectionMap.delete(n)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}Tu();const qm={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Bs;(function(d){d[d.None=0]="None",d[d.Canvas=1]="Canvas",d[d.All=2]="All"})(Bs||(Bs={}));class ei{static useEngine(){const t=n_(ei.Context);if(!t)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return t}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(t){this.graphicsContext.snapToPixel=t}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,n,o,h,c,_,g,v,x;this.scope=U=>ei.Context.scope(this,U),this.version=ml,this.events=new Qt,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=U=>{ct.getInstance().fatal(U,U.stack)},this._toaster=new e_,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=U=>{var V;U.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",U);const j=document.createElement("div");j.id="ex-webgl-graphics-context-lost",j.style.position="absolute",j.style.zIndex="99",j.style.left="50%",j.style.top="50%",j.style.display="flex",j.style.flexDirection="column",j.style.transform="translate(-50%, -50%)",j.style.backgroundColor="white",j.style.padding="10px",j.style.borderStyle="solid 1px";const X=document.createElement("div");if(X.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,j.appendChild(X),!((V=this.canvas)===null||V===void 0)&&V.parentElement){this.canvas.parentElement.appendChild(j);const nt=X.querySelector("#ex-webgl-graphics-reload");nt?.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new fi,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],t={...ei._DEFAULT_ENGINE_OPTIONS,...t},this._originalOptions=t,Fe.freeze(),this.browser=new Qf(window,document);const b=new Xu;if(!t.suppressMinimumBrowserFeatureDetection&&!(this._compatible=b.test())){const U=document.createElement("div");if(U.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(U),b.failedTests.forEach(function(V){const j=document.createElement("div");j.innerText="Browser feature missing "+V,document.body.appendChild(j)}),t.canvasElementId){const V=document.getElementById(t.canvasElementId);V&&V.parentElement.removeChild(V)}return}else this._compatible=!0;if(console.log&&!t.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${ml})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),t.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=ct.getInstance(),this._logger.defaultLevel===me.Debug&&b.logBrowserFeatures(),this._logger.debug("Building engine..."),t.garbageCollection===!0?this.garbageCollectorConfig={...gl}:t.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...gl,...t.garbageCollection},this._garbageCollector=new r_({getTimestamp:Date.now}),this.canvasElementId=t.canvasElementId,t.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+t.canvasElementId),document.getElementById(t.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(t.canvasElementId)}else t.canvasElement?(this._logger.debug("Using Canvas element specified:",t.canvasElement),this.canvas=t.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!t.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",U=>{U.preventDefault()});let P=(i=t.displayMode)!==null&&i!==void 0?i:Pe.Fixed;t.width&&t.height||t.viewport?(t.displayMode===void 0&&(P=Pe.Fixed),this._logger.debug("Engine viewport is size "+t.width+" x "+t.height)):t.displayMode||(this._logger.debug("Engine viewport is fit"),P=Pe.FitScreen),this.grabWindowFocus=t.grabWindowFocus,this.pointerScope=t.pointerScope,this._originalDisplayMode=P;let T,I,F,R,S,M;typeof t.antialiasing=="object"?{pixelArtSampler:T,nativeContextAntialiasing:F,multiSampleAntialiasing:M,filtering:S,canvasImageRendering:R}={...t.pixelArt?Kf:$f,...t.antialiasing}:(T=!!t.pixelArt,F=!1,M=t.antialiasing,R=t.antialiasing?"auto":"pixelated",S=t.antialiasing?ge.Blended:ge.Pixel),F&&M&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),t.pixelArt&&(I=.25),(!t.antialiasing||S===ge.Pixel)&&(I=0),I=(o=(n=t.uvPadding)!==null&&n!==void 0?n:I)!==null&&o!==void 0?o:.01;let W=Fe.isEnabled("use-canvas-context");if(!W)try{this.graphicsContext=new ps({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:T,antialiasing:F,multiSampleAntialiasing:M,uvPadding:I,powerPreference:t.powerPreference,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(h=t.handleContextLost)!==null&&h!==void 0?h:this._handleWebGLContextLost,handleContextRestored:t.handleContextRestored})}catch(U){this._logger.warn(`Excalibur could not load webgl for some reason (${U.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),W=!0}W&&(this.graphicsContext=new $o({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:F,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting})),this.screen=new sl({canvas:this.canvas,context:this.graphicsContext,antialiasing:F,canvasImageRendering:R,browser:this.browser,viewport:(c=t.viewport)!==null&&c!==void 0?c:t.width&&t.height?{width:t.width,height:t.height}:il.SVGA,resolution:t.resolution,displayMode:P,pixelRatio:t.suppressHiDPIScaling?1:(_=t.pixelRatio)!==null&&_!==void 0?_:null}),ee.filtering=S,t.backgroundColor&&(this.backgroundColor=t.backgroundColor.clone()),this.maxFps=(g=t.maxFps)!==null&&g!==void 0?g:this.maxFps,this.fixedUpdateTimestep=(v=t.fixedUpdateTimestep)!==null&&v!==void 0?v:this.fixedUpdateTimestep,this.fixedUpdateFps=(x=t.fixedUpdateFps)!==null&&x!==void 0?x:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new mc({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:U=>this.onFatalException(U)}),this.enableCanvasTransparency=t.enableCanvasTransparency,typeof t.physics=="boolean"?this.physics={...gs(),enabled:t.physics}:(this.physics={...gs()},Oo(this.physics,t.physics)),this.debug=new Zf(this),this.director=new i_(this,t.scenes),this._initialize(t),window.___EXCALIBUR_DEVTOOL=this,ei.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:t}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:i,showPlayerMessage:n}=this._originalOptions.configurePerformanceCanvas2DFallback;if(i===void 0&&(i=ei._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),n===void 0&&(n=ei._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!Fe.isEnabled("use-canvas-context")&&t&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===i.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let o=0;for(let c=0;c<this._fpsSamples.length;c++)o+=this._fpsSamples[c];const h=o/this._fpsSamples.length;this._fpsSamples.length===i.numberOfFrames&&h<=i.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),n&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var t,i,n;const o=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(o,this.canvas),this.canvas=o;const h={...this._originalOptions,antialiasing:this.screen.antialiasing},c=this._originalDisplayMode;this.graphicsContext=new $o({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:h.antialiasing,backgroundColor:h.backgroundColor,snapToPixel:h.snapToPixel,useDrawSorting:h.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new sl({canvas:this.canvas,context:this.graphicsContext,antialiasing:(t=h.antialiasing)!==null&&t!==void 0?t:!0,browser:this.browser,viewport:(i=h.viewport)!==null&&i!==void 0?i:h.width&&h.height?{width:h.width,height:h.height}:il.SVGA,resolution:h.resolution,displayMode:c,pixelRatio:h.suppressHiDPIScaling?1:(n=h.pixelRatio)!==null&&n!==void 0?n:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const _=h&&h.pointerScope===un.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(_,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,ei.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(t){if(t<0){ct.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=t}addTimer(t){return this.currentScene.addTimer(t)}removeTimer(t){return this.currentScene.removeTimer(t)}addScene(t,i){return this.director.add(t,i),this}removeScene(t){this.director.remove(t)}add(t){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const i=this.director.getDeferredScene();i instanceof ui?i.add(t):this.currentScene.add(t)}remove(t){t instanceof Ge&&this.currentScene.remove(t),(t instanceof ui||Vi(t))&&this.removeScene(t),typeof t=="string"&&this.removeScene(t)}async goToScene(t,i){await this.scope(async()=>{await this.director.goToScene(t,i)})}screenToWorldCoordinates(t){return this.screen.screenToWorldCoordinates(t)}worldToScreenCoordinates(t){return this.screen.worldToScreenCoordinates(t)}_initialize(t){var i,n;this.pageScrollPreventionMode=t.scrollPreventionMode;const o=t&&t.pointerScope===un.Document?document:this.canvas,h=(n=(i=this._originalOptions)===null||i===void 0?void 0:i.grabWindowFocus)!==null&&n!==void 0?n:!0;this.input=new pc({pointerTarget:o,grabWindowFocus:h,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new Nl(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new Wl(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!t.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(t){this._inputEnabled=t,this.input.toggleEnabled(this._inputEnabled)}onInitialize(t){}get isInitialized(){return this._isInitialized}async _overrideInitialize(t){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(t),this.events.emit("initialize",new jn(t,this)),this._isInitialized=!0)}_update(t){var i;if(this._isLoading){(i=this._loader)===null||i===void 0||i.onUpdate(this,t),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(t),this.currentScene.update(this,t),this.graphicsContext.updatePostProcessors(t),this.clock.__runScheduledCbs("postupdate"),this._postupdate(t),this.input.update()}_preupdate(t){this.emit("preupdate",new Us(this,t,this)),this.onPreUpdate(this,t)}onPreUpdate(t,i){}_postupdate(t){this.emit("postupdate",new zs(this,t,this)),this.onPostUpdate(this,t)}onPostUpdate(t,i){}_draw(t){var i,n;if(this.graphicsContext.backgroundColor=(i=this.currentScene.backgroundColor)!==null&&i!==void 0?i:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,t),this._isLoading){this._hideLoader||((n=this._loader)===null||n===void 0||n.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,t),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,t),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(t,i){this.emit("predraw",new qn(t,i,this)),this.onPreDraw(t,i)}onPreDraw(t,i){}_postdraw(t,i){this.emit("postdraw",new Yn(t,i,this)),this.onPostDraw(t,i)}onPostDraw(t,i){}showDebug(t){this._isDebug=t}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(t,i){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let n;return t instanceof Sr?n=t:typeof t=="string"&&(this.director.configureStart(t,i),n=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(n??new gn),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new Il(this)),this._isReadyFuture.promise})}_mainloop(t){this.scope(()=>{this.emit("preframe",new kl(this,this.stats.prevFrame));const i=t*this.timescale;this.currentFrameElapsedMs=i;const n=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=n,this.stats.currFrame.elapsedMs=i,this.stats.currFrame.fps=this.clock.fpsSampler.fps,Zt.clear();const o=this.clock.now(),h=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=i;this._lagMs>=h;)this._update(h),this._lagMs-=h;else this._update(i);const c=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(i);const _=this.clock.now();this.stats.currFrame.duration.update=c-o,this.stats.currFrame.duration.draw=_-c,this.stats.currFrame.graphics.drawnImages=Zt.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=Zt.DrawCallCount,this.emit("postframe",new Ll(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new Rl(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(t=!1){return new Promise(n=>{this._screenShotRequests.push({preserveHiDPIResolution:t,resolve:n})})}_checkForScreenShots(){for(const t of this._screenShotRequests){const i=t.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,n=t.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,o=document.createElement("canvas");o.width=i,o.height=n;const h=o.getContext("2d");h.imageSmoothingEnabled=this.screen.antialiasing,h.drawImage(this.canvas,0,0,i,n);const c=new Image,_=o.toDataURL("image/png");c.onload=()=>{t.resolve(c)},c.src=_}this._screenShotRequests.length=0}async load(t,i=!1){await this.scope(async()=>{try{if(t.isLoaded())return;this._loader=t,this._isLoading=!0,this._hideLoader=i,t instanceof gn&&(t.suppressPlayButton=t.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await t.load()}catch(n){this._logger.error("Error loading resources, things may not behave properly",n),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}ei.Context=s_();ei.InstanceCount=0;ei._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:un.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Bs.Canvas,backgroundColor:K.fromHex("#2185d0")};class Ym extends $e{set maxWidth(t){this._text.maxWidth=t}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(t){this._font=t,this._text.font=t}get text(){return this._text.text}set text(t){this._text.text=t}get color(){return this._text.color}set color(t){this._text&&(this._text.color=t)}get opacity(){return this.graphics.opacity}set opacity(t){this.graphics.opacity=t}get spriteFont(){return this._spriteFont}set spriteFont(t){t&&(this._spriteFont=t,this._text.font=this._spriteFont)}constructor(t){super(t),this._font=new fn,this._text=new Or({text:"",font:this._font});const{text:i,pos:n,x:o,y:h,spriteFont:c,font:_,color:g,maxWidth:v}={text:"",...t};this.pos=n??(o&&h?G(o,h):this.pos),this.text=i??this.text,this.font=_??this.font,this.maxWidth=v??this.maxWidth,this.spriteFont=c??this.spriteFont,this._text.color=g??this.color;const x=this.get(ne);x.anchor=k.Zero,x.use(this._text)}_initialize(t){super._initialize(t)}getTextWidth(){return this._text.width}}var ks;(function(d){d.Circle="circle",d.Rectangle="rectangle"})(ks||(ks={}));class jm extends $e{constructor(t){var i,n;super({width:(i=t.width)!==null&&i!==void 0?i:0,height:(n=t.height)!==null&&n!==void 0?n:0}),this._particlesToEmit=0,this._particlePool=new Lr(()=>new ra({}),I=>I,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=ks.Rectangle,this.radius=0,this.particle={life:2e3,transform:Fi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:o,x:h,y:c,z:_,pos:g,isEmitting:v,emitRate:x,emitterType:b,radius:P,random:T}={...t};this.particle={...this.particle,...o},this.pos=g??G(h??0,c??0),this.z=_??0,this.isEmitting=v??this.isEmitting,this.emitRate=x??this.emitRate,this.emitterType=b??this.emitterType,this.radius=P??this.radius,this.body.collisionType=ut.PreventCollision,this.random=T??new Nn}removeParticle(t){this.deadParticles.push(t)}emitParticles(t){var i;if(!(t<=0)){t=t|0;for(let n=0;n<t;n++){const o=this._createParticle();!((i=this===null||this===void 0?void 0:this.scene)===null||i===void 0)&&i.world&&(this.particle.transform===Fi.Global?this.scene.world.add(o):this.addChild(o)),this._activeParticles.push(o)}}}clearParticles(){for(let t=0;t<this._activeParticles.length;t++)this.removeParticle(this._activeParticles[t])}_createParticle(){let t=0,i=0;const n=Xi(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),o=Xi(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),h=this.particle.startSize||Xi(this.particle.minSize||5,this.particle.maxSize||5,this.random),c=o*Math.cos(n),_=o*Math.sin(n);if(this.emitterType===ks.Rectangle)t=Xi(0,this.width,this.random),i=Xi(0,this.height,this.random);else if(this.emitterType===ks.Circle){const v=Xi(0,this.radius,this.random);t=v*Math.cos(n),i=v*Math.sin(n)}const g=this._particlePool.rent();return g.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:G(t,i),vel:G(c,_),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:h,graphic:this.particle.graphic,fade:this.particle.fade}),g.registerEmitter(this),this.particle.randomRotation&&(g.transform.rotation=Xi(0,Math.PI*2,this.random)),this.particle.focus&&(g.focus=this.particle.focus.add(G(this.pos.x,this.pos.y)),g.focusAccel=this.particle.focusAccel),g}update(t,i){var n;super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let o=0;o<this.deadParticles.length;o++){!((n=this===null||this===void 0?void 0:this.scene)===null||n===void 0)&&n.world&&(this.scene.world.remove(this.deadParticles[o],!1),this._particlePool.return(this.deadParticles[o]));const h=this._activeParticles.indexOf(this.deadParticles[o]);h>-1&&this._activeParticles.splice(h,1)}this.deadParticles.length=0}}function Zm(d,t){}class ta{constructor(t,i,n){var o;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=t,this.particle=n,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=i,this._particleLife=(o=this.particle.life)!==null&&o!==void 0?o:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(t,i){if(this._initialized)return;const n=this.emitter.maxParticles,o=this._numInputFloats,h=this._particleData,c=4,_=t.createBuffer(),g=t.createVertexArray();t.bindVertexArray(g),t.bindBuffer(t.ARRAY_BUFFER,_),t.bufferData(t.ARRAY_BUFFER,n*o*c,t.DYNAMIC_DRAW),t.bufferSubData(t.ARRAY_BUFFER,0,h);let v=0;t.vertexAttribPointer(0,2,t.FLOAT,!1,o*c,0),v+=c*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*c,v),v+=c*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*c,v),v+=c*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(g),this._buffers.push(_),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null);const x=t.createBuffer(),b=t.createVertexArray();t.bindVertexArray(b),t.bindBuffer(t.ARRAY_BUFFER,x),t.bufferData(t.ARRAY_BUFFER,n*o*c,t.DYNAMIC_DRAW),v=0,t.vertexAttribPointer(0,2,t.FLOAT,!1,o*c,0),v+=c*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*c,v),v+=c*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*c,v),v+=c*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(b),this._buffers.push(x),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(t){const i=this._particleIndex,n=this.maxParticles*this._numInputFloats,o=t*this._numInputFloats+i;for(let h=i;h<o;h+=this._numInputFloats){const c=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||we),_=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),g=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),v=_*Math.cos(c),x=g*Math.sin(c);let b=0,P=0;if(this.emitter.emitterType===ks.Rectangle)b=this._random.floating(-.5,.5)*this.emitter.width,P=this._random.floating(-.5,.5)*this.emitter.height;else{const F=this._random.floating(0,this.emitter.radius);b=F*Math.cos(c),P=F*Math.sin(c)}const T=this.emitter.transform.apply(G(b,P)),I=[this.particle.transform===Fi.Local?b:T.x,this.particle.transform===Fi.Local?P:T.y,v,x,this.particle.randomRotation?Xi(0,we,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(I,h%this._particleData.length)}o>=n?(this._wrappedParticles+=(o-n)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=t),this._particleIndex=o%n,this._emitted.push([this._particleLife,i])}_uploadEmitted(t){this._particleIndex!==this._uploadIndex&&(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),t.bindBuffer(t.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(t){var i;if(this._particleLife=(i=this.particle.life)!==null&&i!==void 0?i:this._particleLife,this._wrappedLife>0?this._wrappedLife-=t:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let n=this._emitted.length-1;n>=0;n--){const o=this._emitted[n];o[0]-=t,o[0]<=0&&this._emitted.splice(n,1)}this._emitted.sort((n,o)=>n[0]-o[0])}}draw(t){if(this._initialized){if(this._clearRequested?(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData),t.bindBuffer(t.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(t),t.bindVertexArray(this._currentVao),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const i=this._emitted[0][1]/this._numInputFloats;t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-i)*this._numInputFloats*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,i,this.maxParticles-i),t.endTransformFeedback(),t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,i),t.endTransformFeedback()}else t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,this.maxParticles),t.endTransformFeedback();t.bindVertexArray(null),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}ta.GPU_MAX_PARTICLES=1e5;class Qm extends $e{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get z(){return this.transform.z}set z(t){this.transform.z=t}constructor(t){super({name:"GpuParticleEmitter",width:t.width,height:t.height}),this.particle={life:2e3,transform:Fi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new ne,this.isEmitting=!1,this.emitRate=1,this.emitterType=ks.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:i,maxParticles:n,x:o,y:h,z:c,pos:_,isEmitting:g,emitRate:v,emitterType:x,radius:b,random:P}={...t};this.maxParticles=bt(n??this.maxParticles,0,ta.GPU_MAX_PARTICLES),this.pos=_??G(o??0,h??0),this.z=c??0,this.isEmitting=g??this.isEmitting,this.emitRate=v??this.emitRate,this.emitterType=x??this.emitterType,this.radius=b??this.radius,this.particle={...this.particle,...i},this.random=P??new Nn,this.renderer=new ta(this,this.random,this.particle)}_initialize(t){super._initialize(t);const i=t.graphicsContext;this.renderer.initialize(i.__gl,i)}update(t,i){super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(i)}emitParticles(t){t<=0||this.renderer.emitParticles(t|0)}clearParticles(){this.renderer.clearParticles()}draw(t,i){t.draw("ex.particle",this.renderer,i)}}class o_ extends Ge{getGraphics(){return this._graphics}addGraphic(t,i){this._graphics.push(t),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,i?.offset&&(this._gfx.offset=i.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let t=this._tileBounds.clone();for(const i of this._graphics){const n=G(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:i.height-this.map.tileHeight));t=t.combine(i.localBounds.translate(n))}return t}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&this._graphics.splice(i,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(G(this.x,this.y))}get center(){return this.pos.add(G(0,this.map.tileHeight/2))}constructor(t,i,n,o){super([new st,new ne({offset:n??k.Zero,onPostDraw:(P,T)=>this.draw(P,T)}),new Dr(o)]),this.solid=!1,this.events=new Qt,this._tileBounds=new lt,this._graphics=[],this._colliders=[],this.data=new Map,this.x=t,this.y=i,this.map=o,this._transform=this.get(st),this._isometricEntityComponent=this.get(Dr);const h=this.map.tileWidth/2,c=this.map.tileHeight/2,_=(this.x-this.y)*h,g=(this.x+this.y)*c;this._transform.pos=G(_,g),this._isometricEntityComponent.elevation=o.elevation,this._gfx=this.get(ne),this._gfx.isVisible=!1;const v=this.map.tileWidth,x=this.map.tileHeight,b=G(0,this.map.renderFromTopOfGraphic?x:0);this._gfx.localBounds=this._tileBounds=new lt({left:-v/2,top:-x,right:v/2,bottom:x}).translate(b)}draw(t,i){const n=this.map.tileWidth/2;t.save(),t.translate(-n,0);for(const o of this._graphics)o.draw(t,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:o.height-this.map.tileHeight));t.restore()}}class $m extends Ge{get visible(){return this.isVisible}set visible(t){this.isVisible=t}constructor(t){super([new st,new Pt({type:ut.Fixed}),new pe,new Ls,new ca((x,b)=>this.debug(x,b),!1)],t.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=G(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:i,tileWidth:n,tileHeight:o,columns:h,rows:c,renderFromTopOfGraphic:_,graphicsOffset:g,elevation:v}=t;this.transform=this.get(st),i&&(this.transform.pos=i),this.collider=this.get(pe),this.collider&&this.collider.set(this._composite=new Se([])),this.pointer=this.get(Ls),this.renderFromTopOfGraphic=_??this.renderFromTopOfGraphic,this.graphicsOffset=g??this.graphicsOffset,this.elevation=v??this.elevation,this.tileWidth=n,this.tileHeight=o,this.columns=h,this.rows=c,this._pointerEventDispatcher=new ac,this.tiles=new Array(h*c);for(let x=0;x<c;x++)for(let b=0;b<h;b++){const P=new o_(b,x,this.graphicsOffset,this);this.tiles[b+x*h]=P,this.addChild(P),this._pointerEventDispatcher.addObject(P,T=>this.getTileByPoint(T.worldPos)===P,()=>!0)}this.pointer.localBounds=lt.fromDimension(n*h*this.transform.scale.x,o*c*this.transform.scale.y,G(.5,0))}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:k.Zero;{const n=t.offset;return this._originalOffsets.set(t,n),n}}updateColliders(){this._composite.clearColliders();const t=this.get(st).pos;for(const i of this.tiles)if(i.solid)for(const n of i.getColliders()){const o=this._getOrSetColliderOriginalOffset(n);n.offset=this.tileToWorld(G(i.x,i.y)).sub(t).add(o).sub(G(this.tileWidth/2,this.tileHeight)),n.owner=this,this._composite.addCollider(n)}this.collider.update()}worldToTile(t){t=t.sub(this.transform.globalPos);const i=this.tileWidth/2,n=this.tileHeight/2;return G(~~((t.x/i+t.y/n)/2),~~((t.y/n-t.x/i)/2))}tileToWorld(t){const i=this.tileWidth/2,n=this.tileHeight/2,o=(t.x-t.y)*i,h=(t.x+t.y)*n;return G(o,h).add(this.transform.pos)}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const i=this.worldToTile(t);return this.getTile(i.x,i.y)}_getMaxZIndex(){let t=Number.NEGATIVE_INFINITY;for(const i of this.tiles){const n=i.get(st).z;n>t&&(t=n)}return t}debug(t,i){const{showAll:n,showPosition:o,positionColor:h,positionSize:c,showGrid:_,gridColor:g,gridWidth:v,showColliderGeometry:x}=i.isometric,{geometryColor:b,geometryLineWidth:P,geometryPointSize:T}=i.collider;if(t.save(),t.z=this._getMaxZIndex()+.5,n||_){for(let I=0;I<this.rows+1;I++){const F=this.tileToWorld(G(0,I)),R=this.tileToWorld(G(this.columns,I));t.drawLine(F,R,g,v)}for(let I=0;I<this.columns+1;I++){const F=this.tileToWorld(G(I,0)),R=this.tileToWorld(G(I,this.rows));t.drawLine(F,R,g,v)}}if(n||o)for(const I of this.tiles)t.drawCircle(this.tileToWorld(G(I.x,I.y)),c,h);if(n||x){for(const I of this.tiles)if(I.solid)for(const F of I.getColliders())F.debug(t,b,{lineWidth:P,pointSize:T})}t.restore()}}class vc{constructor(t,i){this.id=zt(),this._stopped=!1,this._sequenceBuilder=i,this._sequenceContext=new Xr(t),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(t){this._actionQueue.update(t)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(t){return new vc(t,this._sequenceBuilder)}}class Km{constructor(t){this.id=zt(),this._actions=t}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}isComplete(t){return this._actions.every(i=>i.isComplete(t))}reset(){this._actions.forEach(t=>t.reset())}stop(){this._actions.forEach(t=>t.stop())}}class Bn{constructor(t,i){this.bounds=t,this.options=i,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...i},this.halfWidth=t.width/2,this.halfHeight=t.height/2}_split(){this._isDivided=!0;const t={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new Bn(new lt({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),t),this.topRight=new Bn(new lt({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),t),this.bottomLeft=new Bn(new lt({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),t),this.bottomRight=new Bn(new lt({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),t)}_insertIntoSubNodes(t){var i,n,o,h;!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.insert(t),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.topRight.insert(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.insert(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.insert(t)}insert(t){if(this._isDivided){this._insertIntoSubNodes(t);return}if(this.items.push(t),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const i of this.items)this._insertIntoSubNodes(i);this.items.length=0}}remove(t){var i,n,o,h;if(this.bounds.overlaps(t.bounds)){if(!this._isDivided){const c=this.items.indexOf(t);c>-1&&this.items.splice(c,1);return}!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.remove(t),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.topRight.remove(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.remove(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.remove(t)}}query(t){let i=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(t)&&(i=i.concat(this.topLeft.query(t))),this.topRight.bounds.overlaps(t)&&(i=i.concat(this.topRight.query(t))),this.bottomLeft.bounds.overlaps(t)&&(i=i.concat(this.bottomLeft.query(t))),this.bottomRight.bounds.overlaps(t)&&(i=i.concat(this.bottomRight.query(t)))),i=i.filter((n,o)=>i.indexOf(n)>=o),i}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let t=this.items;return this._isDivided&&(t=t.concat(this.topLeft.getAllItems()),t=t.concat(this.topRight.getAllItems()),t=t.concat(this.bottomLeft.getAllItems()),t=t.concat(this.bottomRight.getAllItems())),t=t.filter((i,n)=>t.indexOf(i)>=n),t}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(t){this.bounds.draw(t,K.Yellow),this._isDivided&&(this.topLeft.bounds.draw(t,K.Yellow),this.topRight.bounds.draw(t,K.Yellow),this.bottomLeft.bounds.draw(t,K.Yellow),this.bottomRight.bounds.draw(t,K.Yellow))}}function Jm(d){return!!d._initialize}function tv(d){return!!d.onAdd}function ev(d){return!!d.onRemove}function iv(d){return!!d.onInitialize}function sv(d){return!!d._preupdate}function nv(d){return!!d.onPreUpdate}function rv(d){return!!d.onPostUpdate}function ov(d){return!!d.onPostUpdate}function av(d){return!!d.onAdd}function hv(d){return!!d.onRemove}function lv(d){return!!d.onPreDraw}function cv(d){return!!d.onPostDraw}class dv{constructor(t,i=!1){this.path=t,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new Ur(t,"arraybuffer",i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){const t=await this._resource.load();this._stream=new a_(t),this._gif=new h_(this._stream);const i=this._gif.images.map(n=>new Yi(n.src,!1));return await Promise.all(i.map(n=>n.load())),this.data=this._images=i,this._sprites=this._images.map(n=>n.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(t=0){var i;return(i=this._sprites[t])!==null&&i!==void 0?i:null}toSpriteSheet(){const t=this._sprites;return t.length?new nn({sprites:t}):null}toAnimation(t){var i;const n=(i=this._gif)===null||i===void 0?void 0:i.images;if(n?.length){const o=n.map((h,c)=>{var _;return{graphic:this._sprites[c],duration:((_=this._gif)===null||_===void 0?void 0:_.frames[c].delayMs)||void 0}});return this._animation=new Ei({frames:o,frameDuration:t}),this._animation}return null}get readCheckBytes(){var t,i;return(i=(t=this._gif)===null||t===void 0?void 0:t.checkBytes)!==null&&i!==void 0?i:[]}}const Fo=d=>d.reduce(function(t,i){return t*2+i},0),Gh=d=>{const t=[];for(let i=7;i>=0;i--)t.push(!!(d&1<<i));return t};class a_{constructor(t){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=i=>{const n=[];for(let o=0;o<i;o++)n.push(this.readByte());return n},this.read=i=>{let n="";for(let o=0;o<i;o++)n+=String.fromCharCode(this.readByte());return n},this.readUnsigned=()=>{const i=this.readBytes(2);return(i[1]<<8)+i[0]},this.data=new Uint8Array(t),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const uv=function(d,t){let i=0;const n=function(P){let T=0;for(let I=0;I<P;I++)t.charCodeAt(i>>3)&1<<(i&7)&&(T|=1<<I),i++;return T},o=[],h=1<<d,c=h+1;let _=d+1,g=[];const v=function(){g=[],_=d+1;for(let P=0;P<h;P++)g[P]=[P];g[h]=[],g[c]=null};let x=0,b=0;for(;;){if(b=x,x=n(_),x===h){v();continue}if(x===c)break;if(x<g.length)b!==h&&g.push(g[b].concat(g[x][0]));else{if(x!==g.length)throw new Error("Invalid LZW code.");g.push(g[b].concat(g[b][0]))}o.push.apply(o,g[x]),g.length===1<<_&&_<12&&_++}return o};class h_{constructor(t){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=i=>{const n=[];for(let o=0;o<i;o++){const h=this._st.readBytes(3);n.push(h)}return n},this.readSubBlocks=()=>{let i,n;n="";do i=this._st.readByte(),n+=this._st.read(i);while(i!==0);return n},this.parseHeader=()=>{const i={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(i.sig=this._st.read(3),i.ver=this._st.read(3),i.sig!=="GIF")throw new Error("Not a GIF file.");i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned(),this._currentFrameCanvas.width=i.width,this._currentFrameCanvas.height=i.height;const n=Gh(this._st.readByte());i.gctFlag=n.shift(),i.colorResolution=Fo(n.splice(0,3)),i.sortedFlag=n.shift(),i.globalColorTableSize=Fo(n.splice(0,3)),i.backgroundColorIndex=this._st.readByte(),i.pixelAspectRatio=this._st.readByte(),i.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<i.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(i)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=i=>{const n=g=>{this.checkBytes.push(this._st.readByte());const v=Gh(this._st.readByte());return g.reserved=v.splice(0,3),g.disposalMethod=Fo(v.splice(0,3)),g.userInputFlag=v.shift(),g.transparentColorFlag=v.shift(),g.delayTime=this._st.readUnsigned(),g.transparentColorIndex=this._st.readByte(),g.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(g)&&this.checkBytes.push(this._handler.gce),g},o=g=>{g.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(g)&&this.checkBytes.push(this._handler.com)},h=g=>{this.checkBytes.push(this._st.readByte()),g.ptHeader=this._st.readBytes(12),g.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(g)&&this.checkBytes.push(this._handler.pte)},c=g=>{const v=b=>{this.checkBytes.push(this._st.readByte()),b.unknown=this._st.readByte(),b.iterations=this._st.readUnsigned(),b.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(b)&&this.checkBytes.push(this._handler.app)},x=b=>{b.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[b.identifier]&&this._handler.app[b.identifier](b)&&this.checkBytes.push(this._handler.app[b.identifier])};switch(this.checkBytes.push(this._st.readByte()),g.identifier=this._st.read(8),g.authCode=this._st.read(3),g.identifier){case"NETSCAPE":v(g);break;default:x(g);break}},_=g=>{g.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(g)&&this.checkBytes.push(this._handler.unknown)};switch(i.label=this._st.readByte(),i.label){case 249:i.extType="gce",this._gce=n(i);break;case 254:i.extType="com",o(i);break;case 1:i.extType="pte",h(i);break;case 255:i.extType="app",c(i);break;default:i.extType="unknown",_(i);break}},this.parseImg=i=>{var n;const o=(_,g)=>{const v=new Array(_.length),x=_.length/g,b=(F,R)=>{const S=_.slice(R*g,(R+1)*g);v.splice.apply(v,[F*g,g].concat(S))},P=[0,4,2,1],T=[8,8,4,2];let I=0;for(let F=0;F<4;F++)for(let R=P[F];R<x;R+=T[F])b(R,I),I++;return v};i.leftPos=this._st.readUnsigned(),i.topPos=this._st.readUnsigned(),i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned();const h=Gh(this._st.readByte());i.lctFlag=h.shift(),i.interlaced=h.shift(),i.sorted=h.shift(),i.reserved=h.splice(0,2),i.lctSize=Fo(h.splice(0,3)),i.lctFlag&&(i.lctBytes=this.parseColorTableBytes(1<<i.lctSize+1)),i.lzwMinCodeSize=this._st.readByte();const c=this.readSubBlocks();i.pixels=uv(i.lzwMinCodeSize,c),i.interlaced&&(i.pixels=o(i.pixels,i.width)),!((n=this._gce)===null||n===void 0)&&n.delayTime&&(i.delayMs=this._gce.delayTime*10),this.frames.push(i),this.arrayToImage(i,i.lctFlag?i.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(i)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const i={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(i.sentinel)){case"!":i.type="ext",this.parseExt(i);break;case",":i.type="img",this.parseImg(i);break;case";":i.type="eof",this._handler.eof&&this._handler.eof(i)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+i.sentinel.toString(16))}i.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(i,n)=>{var o,h,c,_;const g=document.createElement("canvas");g.width=i.width,g.height=i.height;const v=g.getContext("2d"),x=v.getImageData(0,0,g.width,g.height);let b=-1;!((o=this._gce)===null||o===void 0)&&o.transparentColorFlag&&(b=this._gce.transparentColorIndex);for(let T=0;T<i.pixels.length;T++){const I=i.pixels[T],F=n[I];I===b?x.data.set([0,0,0,0],T*4):x.data.set([...F,255],T*4)}if(v.putImageData(x,0,0),((h=this._gce)===null||h===void 0?void 0:h.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((c=this._gce)===null||c===void 0?void 0:c.disposalMethod)===2&&(!((_=this._hdr)===null||_===void 0)&&_.gctFlag)){const T=n[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${T[0]}, ${T[1]}, ${T[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(g,i.leftPos,i.topPos,i.width,i.height);const P=new Image;P.src=this._currentFrameCanvas.toDataURL(),this.images.push(P)},this._st=t,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class fv{constructor(t,i,{bustCache:n,...o}={}){this.path=t,this.family=i,this._isLoaded=!1,this._resource=new Ur(t,"blob",n),this._options=o}async load(){if(this.isLoaded())return this.data;try{const t=await this._resource.load(),i=URL.createObjectURL(t);this.data||(this.data=new FontFace(this.family,`url(${i})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(t){throw`Error loading FontSource from path '${this.path}' with error [${t.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(t){return new fn({family:this.family,...this._options,...t})}}const vu=s_(),_v=/^\s*(?:function)?\*/;function wu(d){return typeof d!="function"?!1:_v.test(Function.prototype.toString.call(d))?!0:Object.getPrototypeOf?Object.getPrototypeOf(d)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function l_(...d){var t;const i=ct.getInstance();let n,o,h,c;wu(d[0])&&(o=globalThis,n=d[0],h=d[1]),wu(d[1])&&(o=d[0],n=d[1],h=d[2]),d[1]instanceof ei&&(o=d[0],c=d[1],n=d[2],h=d[3]),d[0]instanceof ei&&(o=globalThis,c=d[0],n=d[1],h=d[2]);const _=n_(vu),g=h?.timing,v=_?!1:(t=h?.autostart)!==null&&t!==void 0?t:!0;let x;try{x=c??ei.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let b=!1,P=!1,T=!1;const I=n.bind(o),F=I();let R;const S=new Promise((W,U)=>{R=V=>{try{if(T){P=!0,W();return}const{done:j,value:X}=vu.scope(!0,()=>F.next(V));if(j||T){P=!0,W();return}X instanceof Promise?X.then(()=>{x.clock.schedule(R,0,g)}):X===void 0||X===void 0?x.clock.schedule(R,0,g):x.clock.schedule(R,X||0,g)}catch(j){U(j);return}},v&&(b=!0,R(x.clock.elapsed()))}),M={isRunning:()=>b&&!T&&!P,isComplete:()=>P,cancel:()=>{T=!0},start:()=>(b?i.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(I)):(b=!0,R(x.clock.elapsed())),M),generator:F,done:S,then:S.then.bind(S),[Symbol.iterator]:()=>F};return M}class ma extends Ge{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(t){var i,n,o,h;super(),this._logger=ct.getInstance(),this.transform=new st,this.graphics=new ne,this._completeFuture=new fi,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=t.duration,this.easing=(i=t.easing)!==null&&i!==void 0?i:Wt.Linear,this.direction=(n=t.direction)!==null&&n!==void 0?n:"out",this.hideLoader=(o=t.hideLoader)!==null&&o!==void 0?o:!1,this.blockInput=(h=t.blockInput)!==null&&h!==void 0?h:!1,this.transform.coordPlane=ke.Screen,this.transform.pos=k.Zero,this.transform.z=1/0,this.graphics.anchor=k.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(t,i){this.complete||(this._currentDistance+=bt(i/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=bt(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=bt(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(t){}onStart(t){}onUpdate(t){}onEnd(t){}onReset(){}reset(){this.started=!1,this._completeFuture=new fi,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(t,i){const n=i;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),n.world.entityManager.getById(this.id))return this._co;this._engine=t,n.add(this);const o=this;return this._co=l_(t,function*(){for(;!o.complete;){const h=yield;o.updateTransition(o._engine,h),o._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class pv extends ma{constructor(t){var i,n;super({...t,duration:(i=t.duration)!==null&&i!==void 0?i:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(n=t.color)!==null&&n!==void 0?n:K.Black}onInitialize(t){this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=new Nr({width:t.screen.resolution.width,height:t.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=t}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class gv extends ma{constructor(t){super({direction:"in",...t}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(t){this.image=await t.engine.screenshot(!0),await this.image.decode()}onInitialize(t){this.engine=t,this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=Yi.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=G(1/t.screen.pixelRatio,1/t.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class mv extends ma{constructor(t){var i;super({direction:"in",...t}),this._easing=Wt.Linear,this.name=`Slide#${this.id}`,this.slideDirection=t.slideDirection,this.transform.coordPlane=ke.World,this.graphics.forceOnScreen=!0,this._easing=(i=t.easingFunction)!==null&&i!==void 0?i:this._easing,this._vectorEasing=Wt.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(t){this._image=await t.engine.screenshot(!0),await this._image.decode(),this._screenCover=Yi.fromHtmlImageElement(this._image).toSprite()}onInitialize(t){switch(this._engine=t,this.slideDirection){case"up":{this._directionOffset=G(0,-t.screen.resolution.height);break}case"down":{this._directionOffset=G(0,t.screen.resolution.height);break}case"left":{this._directionOffset=G(-t.screen.resolution.width,0);break}case"right":{this._directionOffset=G(t.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=G(1/t.screen.pixelRatio,1/t.screen.pixelRatio)}onUpdate(t){this._camera.pos=this._vectorEasing(t,this._destinationCameraPosition,this._startCameraPosition,1)}}class wc extends se{constructor(t){super(),this.color=K.Black,this.thickness=1;const{start:i,end:n,color:o,thickness:h}=t;this.start=i,this.end=n,this.color=o??this.color,this.thickness=h??this.thickness,this._localBounds=this._calculateBounds();const{width:c,height:_}=this._localBounds;this.width=c,this.height=_}get localBounds(){return this._localBounds}_calculateBounds(){const t=this.end.sub(this.start).normal(),i=this.thickness/2,n=[this.start.add(t.scale(i)),this.end.add(t.scale(i)),this.end.add(t.scale(-i)),this.start.add(t.scale(-i))];return lt.fromPoints(n)}_drawImage(t,i,n){t.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new wc({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class xc extends Xn{get points(){return this._points}set points(t){this._points=t;const i=this.minPoint;this.width=this._points.reduce((n,o)=>Math.max(o.x,n),0)-i.x,this.height=this._points.reduce((n,o)=>Math.max(o.y,n),0)-i.y,this.flagDirty()}get minPoint(){const t=this._points.reduce((n,o)=>Math.min(o.x,n),1/0),i=this._points.reduce((n,o)=>Math.min(o.y,n),1/0);return G(t,i)}constructor(t){super(t),this._points=[],this.points=t.points,this.filtering=ge.Blended,this.rasterize()}clone(){return new xc({points:this.points.map(t=>t.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){if(this.points&&this.points.length){t.beginPath();const i=this.minPoint.negate(),n=this.points[0].add(i);t.moveTo(n.x,n.y),this.points.forEach(o=>{t.lineTo(o.x+i.x,o.y+i.y)}),t.lineTo(n.x,n.y),t.closePath(),this.color&&t.fill(),this.strokeColor&&t.stroke()}}}var us;(function(d){d.Stretch="stretch",d.Tile="tile",d.TileFit="tile-fit"})(us||(us={}));class bc extends se{constructor(t){super(t),this._logger=ct.getInstance(),this._config=t,this._imgSource=t.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(t,i=!1){this._config.width=t,i&&this._initialize()}setTargetHeight(t,i=!1){this._config.height=t,i&&this._initialize()}setMargins(t,i,n,o,h=!1){this._config.sourceConfig.leftMargin=t,this._config.sourceConfig.topMargin=i,this._config.sourceConfig.rightMargin=n,this._config.sourceConfig.bottomMargin=o,h&&this._initialize()}setStretch(t,i,n=!1){t==="horizontal"?this._config.destinationConfig.horizontalStretch=i:t==="vertical"?this._config.destinationConfig.verticalStretch=i:(this._config.destinationConfig.horizontalStretch=i,this._config.destinationConfig.verticalStretch=i),n&&this._initialize()}getConfig(){return this._config}_drawTile(t,i,n,o,h,c,_){const g=c||0,v=_||0;let x,b,P,T;const I=this._getNumberOfTiles(i.width,n.x,o),F=this._getNumberOfTiles(i.height,n.y,h);for(let R=0;R<I;R++)for(let S=0;S<F;S++){let{tempSize:M,tempPosition:W}=this._calculateParams(R,I,i.width,n.x,this._config.destinationConfig.horizontalStretch);x=M,b=W,{tempSize:M,tempPosition:W}=this._calculateParams(S,F,i.height,n.y,this._config.destinationConfig.verticalStretch),P=M,T=W,t.drawImage(i,0,0,i.width,i.height,g+b,v+T,x,P)}}_drawImage(t,i,n){this._imgSource.isLoaded()?(this._drawTile(t,this._canvasA,new k(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(t,this._canvasB,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(t,this._canvasC,new k(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(t,this._canvasD,new k(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(t,this._canvasE,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasF,new k(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasG,new k(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasH,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasI,new k(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const t=this._canvasA.getContext("2d");t?.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const i=this._canvasB.getContext("2d");i?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const n=this._canvasC.getContext("2d");n?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const o=this._canvasD.getContext("2d");o?.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const h=this._canvasE.getContext("2d");h?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const c=this._canvasF.getContext("2d");c?.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const _=this._canvasG.getContext("2d");_?.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const g=this._canvasH.getContext("2d");g?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const v=this._canvasI.getContext("2d");v?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new bc(this._config)}_getNumberOfTiles(t,i,n){switch(n){case us.Stretch:return 1;case us.Tile:return Math.ceil(i/t);case us.TileFit:return Math.ceil(i/t)}}_calculateParams(t,i,n,o,h){switch(h){case us.Stretch:return{tempPosition:0,tempSize:o};case us.Tile:return t===i-1?{tempPosition:t*n,tempSize:n-(i*n-o)}:{tempPosition:t*n,tempSize:n};case us.TileFit:const c=o/i;return{tempPosition:t*c,tempSize:c}}}}class yc extends Ei{constructor(t){super({...t,frames:t.animation.frames.slice(),strategy:t.animation.strategy,frameDuration:t.animation.frameDuration,speed:t.animation.speed,reverse:t.animation.isReversed}),this._ready=new fi,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...t.sourceView},this._tiledWidth=t.width,this._tiledHeight=t.height;const i=[];for(let n=0;n<this.frames.length;n++){const o=this.frames[n].graphic;if(o&&o instanceof Ri){const h=new zr({image:o.image,width:t.width,height:t.height,sourceView:{...o.sourceView},wrapping:t.wrapping,filtering:t.filtering});this.frames[n].graphic=h,h.ready.then(()=>{h.sourceView={...h.sourceView,...this._sourceView}}),i.push(h.ready)}}Promise.all(i).then(()=>this._ready.resolve())}static fromAnimation(t,i){return new yc({width:t.width,height:t.height,...i,animation:t})}_updateSourceView(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof Ri&&(i.sourceView={...i.sourceView,...this._sourceView})}}get sourceView(){return Ii(this._sourceView,()=>this._updateSourceView())}set sourceView(t){this._sourceView=Ii(t,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof Ri&&(i.sourceView.height=this._tiledHeight||i.height,i.destSize.height=this._tiledHeight||i.height,i.sourceView.width=this._tiledWidth||i.width,i.destSize.width=this._tiledWidth||i.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(t){this._tiledWidth=t,this._updateWidthHeight()}set height(t){this._tiledHeight=t,this._updateWidthHeight()}}const c_=5,Wn={},vv=()=>{for(const d in Wn)Wn[d]=0},Bo=(d,t)=>{const i=Fe.isEnabled("suppress-obsolete-message");Wn[d]<c_&&!i&&(ct.getInstance().warn(d),console.trace&&t.showStackTrace&&console.trace()),Wn[d]++};function wv(d){return d={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...d},function(t,i,n){if(n&&!(typeof n.value=="function"||typeof n.get=="function"||typeof n.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const h=`${`${t.name||""}${t.name&&i?".":""}${i||""}`} is marked obsolete: ${d.message}`+(d.alternateMethod?` Use ${d.alternateMethod} instead`:"");Wn[h]||(Wn[h]=0);const c=n?{...n}:t;if(!n){class _ extends c{constructor(...v){Bo(h,d),super(...v)}}return _}return n&&n.value?(c.value=function(){return Bo(h,d),n.value.apply(this,arguments)},c):(n&&n.get&&(c.get=function(){return Bo(h,d),n.get.apply(this,arguments)}),n&&n.set&&(c.set=function(){return Bo(h,d),n.set.apply(this,arguments)}),c)}}class xv{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const t=new fi;return this._queue.push(t),t.promise}dequeue(t){this._queue.shift().resolve(t)}}class bv{constructor(t){this._count=t,this._waitQueue=new xv}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(t=1){if(t!==0){for(;t!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),t--;this._count+=t}}}const ml="0.30.3";Tu();C.eKr;C.yVm;C.a7j;C.U_w;C.JF2;C.htg;C.HXL;C.mcg;var mn=C.Agj;C.J3_;C.Wgv;C.u6S;C.x7M;var yv=C.X55;C.m3M;C.aE5;var Av=C.YJU;C.eZi;C.GNv;C.Y56;C._0v;C.vhs;C.vrQ;C.Z8b;C.Yfw;C.IcQ;C.kgJ;C.GTT;C.ypY;C.i7d;C.fQ3;C.HlI;var d_=C.jlt;C.VQc;C.zD7;C.AUF;C.JoF;C.MlA;C.PZh;C.qA;var va=C.CrD;C.dQK;C.D3r;C.Qpo;C.D9n;C.b6v;C.mvh;var vn=C.Bpo,jt=C.Q1f;C.IKv;C.fcV;C.Glf;var u_=C.uAl;C.ElT;C.Z8r;C.QSL;C.sPV;C.nAn;C.zCU;C.QrV;C.fF9;C.Jqv;C.d_u;C.xI8;C.yar;C.SP7;C.oRy;C.f5X;C.V1c;C.Mlx;C.ZiM;C.ZCo;C.J5p;C.mL_;C.Guw;C.N5j;C.pgY;C.OP3;C.rl5;C.eod;var Cv=C.q5Z;C.YUC;C.saR;C.hvr;C.Qol;C.Wf4;C.JCs;C.gJV;C.fWD;C.Va_;var Pv=C.N$8;C._jQ;C.rxj;C.rhv;C.wCu;C.HAp;C.Zy1;C.bkB;C.wfL;C.sVA;C.$Gs;C.CJ0;C.NWh;C.tWi;C.xAj;C.zWh;C.i_4;C.iIx;C.Hxo;var f_=C.c9e,hn=C.KQV;C.weH;C.jXp;C.zzY;C.yRQ;C.MtE;C.rPj;C.KLc;C.Fir;C.V5f;C.Xj7;C.Wud;C.FVg;C.g5Y;C.YQB;C.KPb;C.nHK;C.Jrb;C.TX_;C.Olt;C.r3n;C.Fvk;C.gpR;C.vYh;C.hnk;var Fn=C.D2R;C.n1o;C.h9O;C.X5j;C.p3P;C.RLG;C.fBU;C.Adb;var Me=C.bEs;C.wCy;C.CbD;C.x_C;C.pGf;C.ibQ;C.shR;C.Yjk;var Tv=C._u1;C.OBI;C.klh;C.s3S;C.D$R;C.xth;var ln=C.JU7;C.h9x;C.N1A;C.e_k;var Sv=C.aHM;C.tlv;C.Vi9;C.ieR;C.$bb;C.VyI;C.imn;C.uqu;C.QnL;C.vnc;var Ev=C.wk_;C.GH0;C._1r;C.l0X;C.bT;C.HHX;C.jtW;C.tjk;C.rWe;C.j9l;C.l0$;C.sGJ;C.NVp;C.cPK;C.XoL;C.RmF;C.DXI;C.tCD;C.J3D;C.vCJ;C.e6k;C.f9l;C.v9m;C.yRJ;C.EU6;C.m3O;C.Ryz;C.OxP;C.LEs;C.Ec;C.Pi5;C.gmH;C.tS;C.XxX;C.bCz;C.nYS;C.yiT;C.NHl;C.mO8;C.PXI;C.bn5;C.Ywr;C.cMd;C.Bs6;C.G0k;C.pyn;C.QeM;C.aPX;C.ITP;C.BY0;C.MFw;C.sBn;C.S3L;C.XKQ;C.ESI;C.uxz;var Zn=C.o8N;C.u_r;C.RlV;C.gVA;var ea=C.M_G;C.BpG;C.GRB;C.kM6;C.dO8;C.jgM;C.FWq;C.s3j;C.hlw;C.L0q;C.B7e;C.PGN;C.H_X;C.S_d;C._Tq;C.U7E;C.IOH;var __=C.Z58;C.yh2;C.ff$;C.cWi;var xs=C.NBt;C.oNz;C.QlU;C.Xey;C.jft;C._r8;C.bTC;C.Mtr;var Iv=C.ypk;C.mnM;C.q7S;C.bAZ;C.ABN;C.VK6;C.Hj2;C.Df8;C.oOx;C.kxk;C.DT1;var mi=C.FLG;C.qN_;C.Z37;C.FtL;C.Z6X;C.iQT;C.ziO;C.OEF;C.uuE;C.tiv;C.T$Y;C.EYj;var cn=C.nOB;C.Tap;C.FAs;C.B_P;C.aA5;C.J3s;C.Y0Q;C.M4G;C.l$l;C.dLy;C.WZP;C.eB6;C.nFK;C.l9z;C.YOF;C.yhB;C.J0N;var ve=C.Miz;C.Bj4;C.Rcs;C.vJ4;C.TqC;C.nM0;C.X1u;C.SpZ;C.DX8;C.Yx$;C.HK4;C.yt5;C.vAR;C.SE$;C.qE8;C.Pz7;C.sX_;C.JuI;C.pxT;C.Nl$;C.zDr;C.OwT;C.P$G;C.mHV;C.kEA;C.Fx_;C.WFC;C.vKu;C.aDq;C.jIg;C.UH3;C.AJO;C.U4;C.xAc;C._3Y;C.K6X;C.C1Y;C.Aw1;C.tm8;C.LBV;C.A8$;C.F5e;C.ran;C.c8L;C.o6M;C.hsx;C.l9E;C.aSf;C.CcK;C.nU8;C.td6;C.Zex;C.bkJ;C.mXP;C.vt$;C.hCA;C.pjR;C.U43;C.pSZ;C.y17;C.Ew7;C.hG1;C.jVr;C._SZ;C.xWn;var Rv=C.ehJ,yt=C.t6s;C.Eyn;const Dv={App:void 0},Mv=`
<style> 
   canvas {
       user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -moz-user-select: none;

      -webkit-touch-callout: none; /* disables long-press context menu on iOS Safari */
   }
</style> 
<div \${==>App}> 
    <canvas id='cnv'> </canvas> 
</div>`;class p_ extends u_{config={updateInterval:100,moveTolerance:5,deadZone:10,maxDistance:100,autoRecenter:!0,recenterThreshold:90};upHandler;downHandler;moveHandler;cancelHandler;gestureStartPos=ve.Zero;currentPos=ve.Zero;moveDelta=ve.Zero;lastDirection={x:0,y:0};isActive=!1;isDown=!1;lastEvent=null;updateInterval=null;lastState="idle";onJoystickChange=null;onAdd(t){this.owner=t}init(t={},i){if(this.config={...this.config,...t},i&&(this.onJoystickChange=i),!this.owner)return;const n=this.owner.scene?.engine.input.pointers.primary;n&&(this.downHandler=n.on("down",o=>this.onDown(o)),this.moveHandler=n.on("move",o=>this.onMove(o)),this.upHandler=n.on("up",o=>this.onUp(o)),this.notifyJoystickChange("idle"))}onRemove(){this.upHandler?.remove(),this.downHandler?.remove(),this.moveHandler?.remove(),this.cancelHandler?.remove(),this.clearUpdateInterval()}onDown(t){console.log("tc pointerdown"),this.gestureStartPos=t.worldPos.clone(),this.currentPos=t.worldPos.clone(),this.moveDelta=ve.Zero,this.lastDirection={x:0,y:0},this.isActive=!0,this.isDown=!0,this.lastEvent=t,this.clearUpdateInterval(),this.updateInterval=window.setInterval(()=>{this.processJoystickState()},this.config.updateInterval)}onMove(t){if(this.isDown&&(this.currentPos=t.worldPos.clone(),this.moveDelta=this.currentPos.sub(this.gestureStartPos),this.lastEvent=t,this.config.autoRecenter&&this.lastState==="active")){const i=this.moveDelta.magnitude;if(i>=this.config.deadZone){const n={x:this.moveDelta.x/i,y:this.moveDelta.y/i};if(Math.abs(this.lastDirection.x)>.01||Math.abs(this.lastDirection.y)>.01){const o=this.lastDirection.x*n.x+this.lastDirection.y*n.y;if(Math.acos(Math.max(-1,Math.min(1,o)))*(180/Math.PI)>this.config.recenterThreshold){const c=Math.min(i,this.config.maxDistance/2),_=new ve(n.x*c,n.y*c);this.gestureStartPos=this.currentPos.sub(_),this.moveDelta=_,this.lastDirection=n}}}}}onUp(t){console.log("tc pointerup"),this.isDown&&(this.isDown=!1,this.isActive=!1,this.moveDelta=ve.Zero,this.lastDirection={x:0,y:0},this.lastEvent=null,this.clearUpdateInterval(),this.notifyJoystickChange("idle"))}clearUpdateInterval(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null)}processJoystickState(){if(!this.isDown||!this.isActive)return;const t=this.moveDelta.magnitude;let i="idle";t>=this.config.deadZone&&(i="active");const n=Math.min(t,this.config.maxDistance);let o={x:0,y:0};t>0&&(o={x:this.moveDelta.x/t,y:this.moveDelta.y/t},this.lastDirection=o),(i!==this.lastState||i==="active")&&this.notifyJoystickChange(i,o,n),this.lastState=i}notifyJoystickChange(t,i={x:0,y:0},n=0){this.onJoystickChange&&this.onJoystickChange({direction:i,distance:n,state:t,rawEvent:this.lastEvent||void 0})}getJoystickState(){const t=this.moveDelta.magnitude,i=this.isDown&&t>=this.config.deadZone?"active":"idle";let n={x:0,y:0};return t>0&&(n={x:this.moveDelta.x/t,y:this.moveDelta.y/t}),{direction:n,distance:Math.min(t,this.config.maxDistance),state:i,rawEvent:this.lastEvent||void 0}}drawJoystick(t){if(!this.isDown)return;const i=this.gestureStartPos.x,n=this.gestureStartPos.y,o=this.currentPos.x,h=this.currentPos.y;t.beginPath(),t.arc(i,n,this.config.maxDistance,0,Math.PI*2),t.strokeStyle="rgba(255,255,255,0.5)",t.lineWidth=2,t.stroke(),t.beginPath(),t.moveTo(i,n),t.lineTo(o,h),t.strokeStyle="rgba(255,255,255,0.7)",t.lineWidth=3,t.stroke(),t.beginPath(),t.arc(o,h,20,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.8)",t.fill()}update(t,i){}}const g_=new va("weapons",4,2),Fv=new va("enemy",2,5),m_=new va("player",1,10),v_=new va("drops",8,1);class w_ extends xs{constructor(t,i,n){const o=new ea({width:t.x,height:t.y,color:jt.Green}),h=new ea({width:t.x,height:t.y,color:jt.Red});super({name:"outerHealthBar",width:t.x,height:t.y,pos:i,z:1}),this.dims=t,this.position=i,this.maxVal=n,this.graphics.use(h),this.percent=100,this.child=new xs({name:"innerHealthBar",width:t.x,height:t.y,pos:new ve(0,0),z:1}),this.child.graphics.use(o),this.addChild(this.child)}percent;child;setPercent(t){this.percent=t,this.percent<0&&(this.percent=0),this.percent>100&&(this.percent=100),this.child.scale.x=this.percent/100,this.child.scale.y=1}}class Bi{controller;signalName;sender;callback;constructor(t,i){this.signalName=t,i?this.sender=i:this.sender=""}send(t){let i;t?i=new CustomEvent(this.signalName,{detail:{who:this.sender,params:[...t]}}):i=new CustomEvent(this.signalName,{detail:{who:this.sender}}),document.dispatchEvent(i)}listen(t){this.callback=t,this.controller=new AbortController,document.addEventListener(this.signalName,i=>{this.callback&&this.callback(i)},{signal:this.controller.signal})}stopListening(){this.controller&&this.controller.abort(),this.controller=null}}const Bv=300;class kv extends mn{damage;UISignal=new Bi("stateUpdate");constructor(t,i,n){super({radius:2,color:jt.Yellow,pos:t,anchor:ve.Half,z:1e3,collisionType:vn.Passive,collisionGroup:g_}),this.damage=n,this.vel=i.pos.sub(this.pos).normalize().scale(Bv)}onCollisionStart(t,i,n,o){if(i.owner instanceof kr){const h=i.owner;this.UISignal.send(["enemyDefeated",h.affinity]),h.checkDrop(),this.scene.enemyWaveManager?.enemyPool?.return(h),this.scene?.remove(h),this.kill()}}}class x_ extends mn{constructor(t){super({radius:3,color:jt.fromHex("#EEEEEE"),pos:t,collisionType:vn.Passive,collisionGroup:v_,z:1e3})}}class b_ extends mn{constructor(t){super({radius:3,color:jt.fromHex("#050505"),pos:t,collisionType:vn.Passive,collisionGroup:v_,z:1e3})}}class y_ extends u_{_heldKeys=[];_keyEnable=!1;constructor(){super()}onAdd(t){this.owner=t}init(){window.addEventListener("keydown",t=>{if(!this._heldKeys.includes(t.key)){if(!this.keyEnable)return;this._heldKeys.push(t.key)}}),window.addEventListener("keyup",t=>{this.keyEnable||(this.keyEnable=!0);const i=this._heldKeys.indexOf(t.key);i>-1&&this._heldKeys.splice(i,1)})}get keys(){return this._heldKeys}set keyEnable(t){this._keyEnable=t}get keyEnable(){return this._keyEnable}onRemove(t){window.removeEventListener("keydown",this.init),window.removeEventListener("keyup",this.init)}update(t,i){}}class A_ extends mn{currentHP=20;maxHP=20;exp=0;isPlayerActive=!1;jc=new p_;kc=new y_;partner;HealthBar;fireIntervalHandler;isJoystickActive=!0;isKeyboardActive=!1;UISignal=new Bi("stateUpdate");speed=100;fireInterval=6e3;fireRange=100;fireDamage=1;constructor(){super({radius:10,color:jt.White,pos:yt(0,0),anchor:ve.Half,z:1e3,collisionType:vn.Active,collisionGroup:m_}),this.addComponent(this.jc),this.HealthBar=new w_(new ve(20,2),new ve(-10,-15),20),this.addChild(this.HealthBar),this.fireIntervalHandler=setInterval(this.fire.bind(this),this.fireInterval)}onInitialize(t){this.jc.init({updateInterval:50,deadZone:15},i=>{this.isPlayerActive&&(i.state==="active"?(this.vel.x=i.direction.x*this.speed,this.vel.y=i.direction.y*this.speed):(this.vel.x=0,this.vel.y=0))}),this.kc.init()}onCollisionStart(t,i,n,o){i.owner instanceof x_&&(i.owner.kill(),this.UISignal.send(["blessing"]),this.exp+=1)}registerPartner(t){this.partner=t,this.pos=t.pos.clone().add(yt(0,-50))}fire(){let t=this.scene?.entities.filter(o=>o instanceof kr),i,n=1/0;for(const o of t){let h=o,c=this.pos.distance(h.pos);c<n&&(n=c,i=h)}if(i){let o=new kv(this.pos,i,this.fireDamage);this.scene?.add(o)}}onPreUpdate(t,i){const o=this.actions.getQueue().getActions().find(h=>h instanceof f_);if(!this.isPlayerActive&&this.partner&&this.partner.pos.distance(this.pos)>25&&!o?this.actions.follow(this.partner,50):this.isPlayerActive&&o&&this.actions.clearActions(),this.HealthBar?.setPercent(this.currentHP/this.maxHP*100),this.kc.keyEnable&&(this.isKeyboardActive=!0,this.isJoystickActive=!1),this.isPlayerActive&&this.isKeyboardActive){let h=this.kc.keys;h.includes("ArrowLeft")?this.vel.x=-this.speed:h.includes("ArrowRight")&&(this.vel.x=this.speed),h.includes("ArrowUp")?this.vel.y=-this.speed:h.includes("ArrowDown")&&(this.vel.y=this.speed),!h.includes("ArrowLeft")&&!h.includes("ArrowRight")&&(this.vel.x=0),!h.includes("ArrowUp")&&!h.includes("ArrowDown")&&(this.vel.y=0)}this.currentHP<=0&&(this.isPlayerActive&&this.scene.switchPlayerFocus(),this.fireIntervalHandler&&clearInterval(this.fireIntervalHandler),this.kill())}}const Lv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEQAAAAiCAYAAADmvn/1AAAAAXNSR0IArs4c6QAAAcBJREFUaIHt2L1qAkEYheFjiiBJ4yXYx8LKOk0uIb21VcpAUlhEsEwl5A4C6cVKglWEYEydIoWCWwpRMNWkWNbiyMfszLc7AZm3W3cchodh/wBlnXHTNHvnRjuPtlG7ZbqXNfU6Kr5/7IybBgA+lysAwHaxAQDM77bec/o0arcMACx/03UsVz8AgO7r2msdzn9iCC4UDENwvjC5B9sguLJgbBCcK4x1kCsEVxSMKwSXF0Y8qYXgfGG0EJwN5uDHoiG4vDBFQ3ASzP6gbAhOgikbgmOYSmgILoPpf12kCwwEwWUwcYfwDuEB8RoiFO8yQvE5RCg+qQrFdxmhY33bVXds30NOtBMMa0+Ym552GnVn721U367U83hvq/psagAgmSUAgF3ynZ64vwm6VSeNgQGARfIBAFhs1gCA291LmA9EDMGFgmEIzhcm92AbBFcWjA2Cc4WxDnKF4IqCcYXg8sKIJ7UQnC+MFoKzwRz8WDQElxemaAhOgtkflA3BSTBlQ3AMUwkNwWUwk+fTdIGBILgMJu4Q3iE8IF5DhOJdRig+hwjFJ1Wh+C4jdKxvu+rqs6nBw+O/fyCaNAamX71Wr+MPZlhfhBfdpjwAAAAASUVORK5CYII=",Uv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAAFACAYAAADNkKWqAAAAAXNSR0IArs4c6QAABW5JREFUeJzt3TFOHVcYhuFj6daRV0AdF9mCN4BckM4VC3DhjjKFy/S0kVyliBQXkTfAFigcicZiBRYbuCmSQeFcxndm7pyZc+Z/nsaIBn7J36sLjE1KK7u6udxf3Vzu1/481hL9fljTi7U+cN/of339cbXPaUnR74caLD62oa92thqC6PdDTRYb2dQv87YSguj3Q42Kj2uu72+1GoLo90PNio2q1Df2WwlB9PuhBbOPaamfaNYaguj3Q0tmG9Faj3LUEoLo90OLTh5PLc+wrRWC6PdDyyaPppbh55YKQfT7YQtGj6XW4edKhSD6/bAlg0fSyvBzc4Ug+v2wRUfH0erwc1NDEP1+2LLeUWxl+LmhIYh+P0RwMIatDj/XF4Lo90MkjyOIMvxcF4Lo90NEu6uby/2PZy/T3/ff1v5cVvHb1/f7lFLY+yGy3d3tQ7q7fUhvzs9SChSCu9uHJ39GvR8i23Vv/PX5PqUAIegbfvT7IaJd/o6thmDo8KPfD5EcBLCzlRBMHX70+yGC3gB2Wg3BXMOPfj9s2dEAdloJQanhR78ftujxGbCL64tRz8HVFoKpw//07tOL5H4I6eAvf2shmHv40e+HSHpHUHsISg8/+v0QwdEx1BaCpYcf/X7YssGjWDsEaw8/+v2wRaPHsXQIaht+9PthSyaPpHQIah9+9PthC04ey9whaG340e+Hls02mlND0Prwo98PLZp9PGNDMFWtwx9z/5vzs8d/YTJWrfdDS4qNqFQIWxn+kPunBLCV+6EFxcc0VwhbHf737h8TwFbvh5otNqqpIdzK8J+7f0gAt3I/1GjxcQ0N4VaH///7vxfArd4PNVltZH0hjDL8i+uL/XMBjHI/kFK6/HCzv/xwE/JXUqb/QrjUT86Bp1Z7tdEXvY+/vPYKCFjE4rHJw/fy1b8PBH/78vRLQSEESlssMnn4Hr7cppRS+uHVTykJIbCC4nE5Fr6cEAJLKRaVseHLCSFQ2uwxOTV8OSEESpktInOHLyeEwNxOjkfp8OWEEJjL5GgsHb6cEAKnGh2LtcOXE0JgqsGRqC18OSEExjoah9rDlxNCYKjeKLQWvpwQAsccxKD18OWEEOjzGIGthS8nhEBu9/6Pr/v0TBi68LUewr7wAezu//ycUkrp7OfzlDYUwmPh6+4B4tp1b2wlhMIHDLXL39FqCIUPGOsggJ1WQih8wFS9AezUGkLhA051NICdWkIofMBcHp+Bu3h7PepXM/aFsLPU/weYf7yxPv3+znOAENTB+GsLofABpfRGYO0QCh9Q2tEYLB1C4QOWMjgKpUMofMDSRsdh6VeEwgeUMjkSc4cwJ3xAaSfHotQrwrGEDxhrtmicGkLhA5Y2ezzGhnAq4QNOVSwipUIofMBcisdkrhAKHzC3xaIyNYTCB5SyeFyGhlD4gNJWi0xfCIUPCOPi7fV+qZ8cAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAhf4BDsJ9Emo7biEAAAAASUVORK5CYII=",zv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACgCAYAAACLz2ctAAAAAXNSR0IArs4c6QAAA61JREFUeJzt2j9oG1ccB/BfUkO2pMHgpeFi7Aa6eAhoNYSSzRZEQ4dCi2mHekiMs3QpOGOHeGmIPWQphHZKB4fY3kzByeAMxhm6FJoaWbhLIaR0brgufaoky7YUW4osfz4gJL27d+909+X9ERcBAHB8HvxxI3/X59Cq0mIpP+wzdFQKW+P7qXaUi9APF/DCtbET/xt63dnaL9+XZ+u6/ytj598qSEep2+h+5ZsjHaPZObRyXheujeUff/KhEHZYXQCXVytRWizlKYgfZe+3fcB0c1PddkLYbN+Z7NszreyXNM79lm4u7anfrKzRYPlc8eefXsZg+VzxsH15e2cbC4oTWSyvViIi4tfKXxHRXoiujJ2vq1ucyFqu30owDttv+oPHLR3jIBeujeXb5c2VwfK54nZ5c0Uv2Dl1AVy6uXQmha9WO8NpY6+5vFqJ4kR2lHPsqtqhN4XvXQzFp2VlvKcHTL1LcSKL3375OyL+D1XtHHE/qedLdVOP2krdiIPnfEeZD7Z64xqH3nc1FC/dXDrTeM6lxVLe6ihxUhz4Y9IFuDJ2vi5QXw7f27feQTe6GxfvOG7SyHBhcru8ubLfd7qktFjKm7262X632joup2XopIf5UxkAAE64bDTLs9HMRJ7uy0azfO7uk3x9Y0sI+1BP/qteG7Sp6YW4Pn4pbs/MxqvXOxERUfm90pPnTRd0cjhMx17f2Kr2eFcL43kq1xP2uYPClbbled6RENQGb31jq9rO+sZWfrUwXg3f+sZWPnf3iRD2ierDCNlolv/w4+OYml6IxpubjWb51PRC7LzciafPX8Tas922G2olMGvPdqvHfvr8RdyemY21Z7vx3f17cX38UnX7yqP5ttunNw1UP7wZKn7x6Vf/FQ5FxN7Hsu7ML8f18UttN5LC/flnN/Jm87cU8IcPbsXgxcsR8XW1ncb2Vh7Nx6vXO+aBfaKlmzgyXJhsVt7sCZHU07UTkBTA1Ms9fHCrum3w4uXq4iMRPpp624VC7SIjzQVr55rpPc/zvJOLIE6pkeHC5MhwYTKFsDZ8KZSpbO7uE4uQPjJw+C6dt13eXKkd5u/ML9dtn5pe2FNGf+ipudTIcGHyn/f+XI6on/s1+zzwZqjoKeWTr6cCGLH/gqeR8AEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCz+BWpwAcBUWVpgAAAADmVYSWZNTQAqAAAACAAAAAAAAADSU5MAAAAASUVORK5CYII=",Hv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAZFJREFUWIXl179OwlAUx/HvTXgIpEvjxsJkGGrcJeqIq0NZHQi7b0AcWGVghREJrIbgQJxYupkuIpuPcB3MvdbS0v9l8ExN07SfnHv66y2WaUjLNCRHKvH18iABru6GALy6H6JUgDPoSIBqo8YxIEK1f9hrcQyIsExDDnst7P6cY0A0QFXZEGGZhpyNbHabLQCLpUN3vCptaSrqoNqoaYT3AXZ//gcyG9kKIvOAVIJOOoOOrN8/iTIggQCFACgasjeEi6XD5UV970IFUZXXjIjH23MJ6IeGAYqC6GlvN0198hDAD8maI+LUPLsGqPI59ULiIOAnN7LkiB7CHSc3AJO1O/VeEAfifYXbTZPueCXiDmvl3X17BlCdSAtJmyN766Ig+sYRS2P35/qmu81WD7F/WOF3XhQYAnIgr474cwR+uuLvSOS7GtWRydolS47ETq24S5M0RxLndxTEizlUCpL6S5Z0WMMq8zc9KyS33U1aSO77vKSQwna8cSGF7/2jIKX9BYVBSv0NC4KUDgiD/N/6BqlKK1m+ta+tAAAAAElFTkSuQmCC",Ov="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAABG9JREFUeJztnL1P20AYh398CKQsdEJCgCFNVZEuDK4iEaljt7JlYOnQfyHq1qFi6Jp/gSFLB9SFTnRFiUSbNUioaT6KFMFElkhB0HSIzlzOZ/tIch+27pEixR+xLw/v3b1+HTMHg3AyzpC3vtPozKluiyiLuhtAS0sV8gCArDMAAFx0lkf7HMPbxzSZ2hpDxLHSgiAy+8cVAOaI1NIIJ+MMU4W8T1o6t+Tbt3l+N7ZMizRBotIGkKhzi663jieNhZUIjESaEI3KTsxGnYg4FhOjUekkEiXv+KDKXV/4uhd6vNoM2jYpSv5qdPSFyWv/bgMALo82AQAvP/wFAGy92PIkhnVnHVEo/YSi8n58+ucJY7k82sTbL/NGSlTShcPk0bCRR5ZZ0rkln8SsM9DSledlHpxEnwhnp9fe+8ujTVwebXrr6G1hpAr5wKsZWUiPwKgEGRilNYelGj6j69t2dnqNw59rcIsumud3XiTzolAHSrpwOreEvbUNVLtXgfu4RRffg7a9eTyOaUjrwk7GGbpFV+hLp3NLkfuJHCfrDJR3Y6ljIE21e4W9tQ3ferob8kQGyTWh+wIGVGN4mNhVg1AWgYA/CulJIa4oFQgEd+W4oqULexJzwbNyGKaMf4DGMZAXiWFpDhAu7qKzjKwzGOWdRRcoYajisk6KQCfjDIMqKDSsMF7XrnavIiOOyNPBzAWKyuMRFYEmonwSSRqJEVgr6SmrShkDdeR3qUIetVLFW1ZVF0xMBAIjiaLls1kxc4GdRmeuVqpJy9XIjSRTkBKBsiWahJYunCSxiRoDdWAFTkksBZo0kWgROM0NIfqnb+SlEy3VmGkSbV7hQKdEo7pwHGdnowRGobNsFYQUgdOUtKaBFFTdoqvs1qbUCAwa53iTiEj3DYu+xBRURWElxvXunNaKdFyl0SiZROI4u4oiRSAR1jy/U1Zc1VWRllK1pX+NPwt5InflgMdnSICYV6QnaTyJ1mm6eyIq0tMyScTqTK6lpjFhMpIysdiK9JRIu5Rj100qTeRziazGsMk06c5BTyPxaJ7fRaYn7HbVz4pouZRjvzT98KGINBYd6QtBWhrDi7TjgyryqZWxVxBR22l0pC8EqX8tdizsNDpzTsYZsmIq/d7YMm87HaWEWqmGfGpl7POqI1DZyZ5vv34HAPcLNyfvX2156xutW9++me1nY8uN1q1PMvAoutLvaXvcVfpJiTjAL29SeNIr/R4WH1b3/7R+BT2vIwWpeaCovN2d9Scdl41QYBSN9ws3J/Q5VSBNoMgX2d1Z9+Q9RSIvAp967lmh7VqYJyxKYrnejpSnGikCeRGw+LC6X663Ua63PVEfv1V8n+VJbLRuUa63sfiwus+bTCr9njcGhrVBBlImkajG3y/cnAAjqeR9FLQc9jP0NhoVE4q0WVj1YM6iajY2rh4YN6TmgbqiUGUuqDSRVoHqRFr5pZwsVIsjaLl+nJVMXdJotP/3M0BcqAnCLBaLxWKxWCwWi8VisVgsOvkPW9QWs7d38t4AAAAASUVORK5CYII=",Wv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAgCAYAAADaInAlAAAAAXNSR0IArs4c6QAAAppJREFUeJztmb9r20AUx7+pSvcQDxmNO7WbwBiDJ/8F3jN1655Vc1bvXTp3DXTXFBAikK2eHDJmSMheMO70xPP5TvdDd5JD3wcMtnT3vk/f93wSOkAQBEEQBEEQBEH4jzgLmTQZT/f89+PTfVAcIYyY/n8MES7yCrPlDgBQlxluMN93TSQkD6LvBhxKP4X/zhMm4+m+yCt8+5UBAP78+Htwvi4z3DzMk5phNOBhDiB9IYbUT+W/02BVnOizCYZuwCH1U/pvHUji1PFfv3/SindJwjWHoRpwSP3U/n9wGUTiJGwSV8fGgBvAdXU5zJY7FHl1dI9+r/qT8XR/e32X1P/WBqAEVF6f37Tfidvru6hFGKoB+yhACK7+06ctltMKQNRlhtV6ge1mhLrMUJcZtpsRVusF6jKzB/DkVBowVN+lACZoHvc1xH/bimRtgJDCkildDDDl4mPAeyiASbvIKxR51ej6QP7T/DaMDUBJ8ARoeePLnO7YdjNqEgi9J+oK4Ao34NQL4EpdZt7+z5Y763OJtgF48XkCAPDz6vdBcH6Mw59cfYtgKkCIAbFIVQAV1Xv1Gnz8d+GoAdoSqMsMF5fnR0H4MfWeGKsIIQ1I4065ACZ4fP7Sydd/2+rV+gyg625bwK7/vtgNGEpfBTBhmhfbf+NegG8BX5/fGnFOqAHqMktx+FKsQzWgSwF0Or76vjw+3Z/Ru/0C7quIzn+X19RHDUAJFKgOjAfQBKPEPn95wcXlOVbrRTOX/sHqPN+3YzajVUwG+NJ3AUw5AGg2eVRc/Xfx3XhSXYp5MNtuWNfdMr7pwmkaMLcbwMeH5MDzUPHRT7U3wH+b/HfRbh3AhYbY8zddaEwDYubVl74gCIIgCIIgCIIgCEII/wA4CPQArRf9NwAAAABJRU5ErkJggg==",Nv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAEBJREFUWIVjYBgFo2AUjIJRMApGwSgYBaNgFIyCkQ4YiVWopGDiQ4rB9x6c2UKxA0i1lBzHMFHDAkrAgEfBKAAAZe4MBrg/DiUAAAAASUVORK5CYII=",Gv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAQCAYAAACm53kpAAAAAXNSR0IArs4c6QAAAHpJREFUWIVjYBgFo2AUjIIRDBiROczMhv/pYenfv+cZsYkPqP3MzIb/6QWweXSg7GeBWf7nzzkGRkasEUN18P//fwYWFqP/sJiA2T/rWSBd7P/z5xzcfhZkCSVZVbo4ABe4/GkrfSySwiI2UrPAaCE4CkbBKBgFIxkAADT+0rfjVIbqAAAAAElFTkSuQmCC",Vv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAABACAMAAAB7sojtAAAABGdBTUEAALGPC/xhBQAAAMBQTFRFE2SIFGWGFH2qE2SGE2WGFXupE2WHFXyoEmWIE2WHFXyoFX2oAAAALq3jIpXFKKHUFXSbFGuPFXWdFG6TNbv0Jp3PFXqjMrXtH6fhIKniNLnyM7nyIKnjMrfxMLXvJa3mKbDpJ6/oJq7nLbPsJq3nJa3nIqvkK7HrLLPsLrTuLLLsMrfwLbPtJKzlH6jiM7jxIanjMbfwMLbvKK/pIqrkJKzmLrTtL7XuKrHqK7LrJ67oI6vlKbDqFGWHNr33Fn2oEt7TigAAAA10Uk5TTz8/769fn89v37+fAH/YHM0AAAEYSURBVGje3drHdcNQDERRWFkklCXSWbYl55wT+dF/V+bCBz083Arm7UdUW3mWGVCW5S1V0dzAcpWu2XhUJqByNDbrSt9WCWtlfTEr03IfaZlKsyYgpQOolP4DHqHiBBxBecAtlAc8Q8UJeIGKE3AM5QGfUHECrqE84AMqTsAdlAdsoDzgCsoDbqA84BsqTsAllAd8QcUJqKDiBJxAecArVJyAUygP+IGKE3AG5QFbKA84h/KANZQHvEPFCbiH8oBfqDgBF1Ae8AYVJ+AJKk7AIZQH7EF5wANUjICiuZxVu0hVczkrZM4+/c1lZjah7p+YzaSeko+v01ra9aKgzi8WdVs6NVpHdtgBItoj7+8173UdDKnzhwPVPwRCH/15giO3AAAAAElFTkSuQmCC",Xv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAABACAMAAAB7sojtAAAABGdBTUEAALGPC/xhBQAAAKVQTFRFFnyoFXyoFXyoFH2qFXupFn2oFX2oAAAAIpXFLq3jNbv0KKHUKLDqJp3PMrXtNLnyM7nyMrfxJKzlK7HrLbPsMrfwJq7nLbPtJa3mMLXvKbDpJq3nIqvkLrTuJ6/oLLPsLLLsJa3nIKnjIKniH6fhM7jxMLbvKK/pKbDqL7XuJ67oLrTtKrHqIqrkJKzmK7LrI6vlMbfwIanjH6jiHqfhNr33Fn2oU/4/+wAAAAh0Uk5Tr8+/P1/fnwDVUD04AAABAklEQVRo3u3aR1IDURAE0da4lh1hhLfCI7z5ff+jMQuizkB28E5QuS9zr7uqCqCq6mp38y7AOrcmYjzpC1A/GUc0NopFwVrEyCL6Ml0iTUsfMQSUsgVVym/ALVSegG0oBexBKeADKk/AHVSegCMoBTxC5Qk4g1LAE1SegAMoBaygFHABpYBLKAW8QeUJ2IVSwDNUnoAHqDwBx1AKuIfKE3AOpYANVJ6AfSgFnEApYA2lgEMoBbxC5QnYgVLAO1SegFMoBbxA5Qn4hMoTcAWlgGsoBXxB5Qm4gVLAN9R/wJ8IaIfb5Zy5fz7cLlsz9vHVrI6YUffPImr++du9aanz28b9ByOQclrdOBB9AAAAAElFTkSuQmCC",qv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAABuBJREFUeJztnTFoG1cYx/9uC6GlZOlgYjpIVigYmiXIghiE5S0eMkZKtttCkIdMSZOCoSE4uJDNIWRo0WBITh2NcTNFQZCC7C2FQulFmho0FEIpBU/XoXmXd6e76M56uvd94vuBsNAd8v997/++793p3R0gCIIgCIIgCIIgCIIgCIIgCIIgCIIgCAJRFgtlX72StuetSRAEYRp8ZPLLFgtlf2FpFQdnjhK3H5w5Ip1EuRcA7voFYRLy9r+xBLpYKPvzhRIAYP1NGa8HR3PRfV4PjubW35QxXyiRHMjcCwB3/YAUANtwjr8N/xudgeroHTGuUyjAvQBw1w9IAbAN5/jb8v8nJr5E58/fXkA1JI7hwDP9L6cCRZNkgZv+1AMAwX5+3D42UQnoh7cPsP6mHLv94MwR1lEmqZ17/HXy8r+xBPoumEEn1CrVkX22tpu4c+sh3HYrtoMowL0AcNevkAJgF27xV+Ttf2MJVDfQcODBOXbRqu4E27e2m6G/bpuWgbgXAO76FVIA7MI1/rb8b/wQvlapogNgfQAsvOqjeq4IALhz66Hpf2UU7gWAu34pAHbhHn9b/jeaQFvHLpze+yQKAG67BQCxplJVmlJncC0ACq76pQDYhXv8FXn732gCdU41UKtU4bZboYTZqDuBeQCE3qsESwHuBYC7fkAKgG24xh+w43+jCXQ48OAOPDTqDjq97sj2pCRKBe4FgLt+KQB24R5/G/43ug50vlAiE8yTMBx4cNstNOpO7HY1e4i+pwJ3/foA0GnUHbx8/hS1ShW1ShUvnz9Fo+4kttMWrWMXnV4XtUo1GMBuuwW33UKn1w29gPdrRm1q1uEefxv+N5pAhwNv5NfHRt2B225hZe0KVtauoNPrYmXtCkrFZXLngrgXAO76pQDYhXv8bfjf6DpQ/TyQovuqj4Wl1eBQRuEOPHKD/UMFQD8lsbLWDX5NpdQG7vrnCyX80nHnAIfMrCwL3E9hzUL88/a/8WVMw4EHvKu0nV4XH3/6ZbBNNSLuF0rbcC8A3PUDUgBswzn+tvxvNIEqQW4bWid4WFhaRfdVP0icnV6XTOCjcC0ACq76pQDYZRbiD+Tv/6kFYNzJcYrBV0S1LyytAkBgok6v+26mQROu+pVudQ5OHwDVc8XQAKB2/hx4v5QpbvCOJCCi+gG+8Vfk6f+pBCBayahV2zRE1/VFodyWNL/sctIvBSBfuMZfkaf/J/6SOLHzhVKQdFRFBsJrrqiaBwAu1Bo+F/3c43/SZTyc9McloCGRQ+BJllFR1Z+n/yf6kqh4JTZpcaq+PIJSFYu2Ixrc6MwCoKF/kvjf/37DeuxFv10m0U9hBs09/sFC4Ge7u77v+6EbJ/u+7z/b3Q3e+77v376549++ueNfqDXI/EoZdwPccTeBpqKfe/y560/LLOq/t3nfehso+MfIQvoH19+iVFyG1z8MXqXiMh5cfxvaTy2+rVWqZJIQADy6dwNe/zB0ZYjXP8SjezcAjBqImv6TxJ8SXPWnHcBq/1nS/+1331jTHcWmfyZKoPoU/nxzH6XicvA639wP9qO2YDhK1g6gAvf4c9evGOefWdRfKi7nLXMECv4xeinn+eY+ftx7ERKvoxpC4fxhlCwdQFE/kC3+FOGmP+0AVoj+6WLDP8YfKrf69Wd4cu3SB/ehelPZtB1AVT/AO/4Ab/3j/KOYBf22f0BKIm//GE2gT65dwotf/8XVx3sj26hXL0WaDqAK9/hz1w8k+0f0Tx8b/jGaQOOER6FcvdJ0AIXlG0lkif+4x+/aYJb9oxD908OGfya+Fv714GgOBfhn7wKnNy8Hn/999yf88UUrdF/EYH+iXH28h42L8duo6j9J/BcLZb9Rd+B0N+CcagAWnxAp/qEDR/22/WPkSiR95X8S0X2odISagZ39y8HpzcvYuPg5dn7+J+gABWX9aeKvEicQXlC8td1EqbhsvT1ZZsK2tUZZLJT9cf5RUNMOZNMP0GtDGu/ol2Wb1D/xlUhq9f/WdhO/r8ypGU3oUFF/0Jaa9VA4FND1x129wEm/IqnSZtk3bxYL5WAGHDcYVMJ3uhv46qVPIuFH4Xz/gXHaqcY/zYRg2r43MgP1+ofB0wZ19FmPQj2fhFIncNevdCmS9EVvkEJBPxAewOrUghqo+ucArevI4/hQWzhq1j8H6MQ/6+QBmM6Rl5EgZHm4FLUHUQH89QP/69LPayaZnKL+C7WGH706RB+o4+5VQIW4QQ3QSTpJcI1/1glB2jGSBRKBEMygG52KydOQdAjJqQ0Kjm3hqFmRdULAdYwIgiAIgiAIgiAIgiAIgiAIgiAIgiAIgiAIgiAIgiAIgiAIAgn+A7oMD5O/vWDBAAAAAElFTkSuQmCC",Yv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAAQRJREFUeJzt2b1NBDEQgFGDKMSYFkwl5AQUctFJ1wUBOZVAC/x0YoLFiAgJbsUw7HuSJWf3zdxJt9KWAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMBXTqI+uNU+5v359TGsY6uy719/LP2L03VyjvN5mCxa7WOe6JZjZZ9Bf6wt95+tGfIdN9dXH/fbu/uojFW02ke2f+Hs+9cfS3+w8W6/O6R8itvvDmOejP3Z968/lv5grfY5Q8oBsn8B2fevP5b+hZdIP9RqH08vD6WUUi7OL9PN8B/2P+/6f5/+RbrB/4rsPyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAPeAL/X/DNWhUtlAAAAAElFTkSuQmCC",jv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAAOVJREFUeJzt2LEJAjEUgOEIDhIyQzaxt3CQqw7cwsJ5nOFwk1idWAmC8O5x31cl3Z+kSEgpAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHxziA5otY91vDwf4T2/0h8ra3+rfSzPxyFr/2rv/cf/5vym1T4u59N7fruXkekQ9MfSH0t/oFb7mKfrWM3TdXzeBlunP5b+WPo3oNU+Wu3vRWRbgP5YmfvX3qz9peTe/1L+0x/+XN37H0o0/TH8gW5D9n7YpWyvNQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA2JcXCrA+xD02G1sAAAAASUVORK5CYII=",Zv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAABQCAYAAABoMayFAAAAAXNSR0IArs4c6QAABFNJREFUeJzt3b1u01AYxvHHCOUWCqiD47RbVRZnKEgVKwMCxIBY4C6yAmvvgi4ICYQQAytCQgxk6ceC1IQMqKW3wHIYiisn2Ikdf5xj5/9bKrVR5L6tn7zvybEjAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKsp8ENj+xiahHoBLRH4oTHGGE7qbKhX+UwK28eF+lyxfQAfPnyks8mBelWPIFwd1gMQcBVB2H4EYEOMJ0Ov1+1ra/saXWBJPM/zsjyOIGyvq7YPALApCsEsARc9JmtwIrmuLtWPDhDQxUlJR1i+pLq6VD8CEIjJ0524dCK7LqmuLtSPAARm5OkGpWzjM9JfXGzWjwAEUhCC5Ut7cbFVPwKwodb8nu1DWAl5u0Egk+jKhqODM65uyGHnzmPqZlHa1SMurGc1iSv1owNsmPPJyPYhAK1BAAIlogvMxpU3RAhAICPCrX0IQKBkBGU2LnSBBCCAlUUAAhWgCyymrvpZ2d+Utn1jPBmy32oO6mZX3pOS/YOLzatpHfWr/W4wgR+avd11SdKjV+/18vZNbW0EkqSBZDiZ50us3e66GXz5RRA6xhhjCMH5PM/z0kKwjvrVOgIHfmg+XR9KujiBe92+9k87Oj4ZS5I+XR9yn7sU1M4uRtp2qn0N8LW3LUnqdfuX39s/7Uz9DMmoXbUCPyz96hqCs5jW1S/+Txb4odm589jMfh/JqF11Aj80L25tmx87SqzlokvguDxuObbrV/saYHydas3vXV7axfrVYtSuWlsbgY4UaG+z3PVo1gKTZQ23Kutn9Y8S+KFZ83v69vkN/xxLoH7lCvzQjH5+17tnDzX48quU5+TFKdkynV0VIWj1M0HiXQzyo37Li148ziejqTr2un2Nfn7X4N/XonrdPjsbZrgSfpLlAOTkLYb6FRMPv3gIvrx9U1JHx4e/Cz3//fv3WtcBRuujy/5eLoWfZHkEBlwS+KF5euOPtjaCUkbgtoWfVCwAl31Do8oA5GMxAU1v0I+0McBscTH8JAIQuHR8MtYTc6i7ZyHhN8e/j2PIvLbpavhJ3AwBkHTR7e2fdgi/BfJ+Fo3L4SexBgggp2gD/vlkpPFk6M1bFyQAAbTK7JUye7vrOj4Za/+0MxWCroefxAgMIKOkSy6jvZJPzOHUY5sQfhJvggDIIL5FKLoD0fOvB3r37KEkTa2dNiX8JEZgABlEt2M72nwgSf/tkywafhI3kAXgsMAPzdunD0zgh+bo4MwYY6ZG4ibeMYcRGEAm48nQG0ipd29e9nltdn68CQIgs7L3SDL2AmicpDG4KWNvHB0ggJVFAAKoHaMvgEZbdgy2fdxxdIAAauNa50cAAgAA5DU7Bjdl9I3QAQIoTdqI69roGyEAAVTK1fADgMIWjcG2j28eOkAApYp3fHR/AFov6vzi+wFtHxMA1Gb2btEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADI6S9A7MTvVldiMwAAAABJRU5ErkJggg==",Qv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAACO1JREFUeJztnV9oW9cdx79OTTGUPJUUkvTGRpjUMfawjVbM0uRa9kr60OKUmSaBzBDIDAnJGoaoQwhshmDiIDaXDgwmEEhH5wdBa9LHObK2ZA6LcEQdFLsxqhMt3YPxy8rAZBp3D1e/q3Ovrlw7utI5x/l9QFzfqyvpe77nd373/LmSAYZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhFCPUFLaCPI/ZGuw/8zKjdfyHmsLWf//9tuUnTjy20Xmy0bkC2H+mUnT2X2b87wjqjX7+8W8AlAr+dvGe6xidpxKhprC19M0O3+DwlqfcebJh/+WiewLS3X9Z8V9xAg01hS0jEsUfL5iuY16TaX9mYgBGJKpcJeiagNh/+XACkofs+A+kB5pLxAAARiQKIxLF0jc7nL8fLa3i28V7zuPR0qpzvgrIroAgYP/lwwlIHjLjP5AEakSiODeedPYpSMRK8Z6vEjonIID9lwknIPnIjP+6IN6Egkjk7s2TAICDg38q2c8lYsiupAL57Erx005QBRx4a5dz7NHSKs6NJ5UvA/tfGygRTk/fchrxXz79vasRe/X3938AAMro19l/QG78V/wm4pX02gd5vNV1CJ2nJ/D3O9+hq3M3Gl5rAADX/j6jQxnzAf0TEP3N/tceTkBy0Tr+Q01hyzw1ZZmnpqz7j/NWqClsLdw4b9W/Um/l1+39+lfqS/ZVGr7QcCvUFLbi5zsc/f+Yy1n59byjX9xXRT/7rwZiPdCDdPvtq6RfZ/9ViP/6IN5kZmIAD3JAa2tLEG9XM8Qrb+zSAI69243pLvu5rs7d2N/S7Zzr3VcJ9l8e1BhzidiWekAqsB38B+TGfyAJVGRvc7tr/8H1MwDgBNLU2TZ8civoT60MXROQH+x/7eAEpB61jv9AVuH7zsQBAJnMIgBbdMNrDXiaS+PAiT+gf2QO+4wO7DM60PvR2SA+smr4VYBYnqmzbZKUlYf9l8vMxACA7ZuAVPdfZvxX1APNrqTqkIhZAHAsEcPgnucA7Ep4cP0MOk9POJmfeKPnrDJDGKLvTByxSwOFCjjsVAAAHDhxD/tbuh3NvR8NAbcmJaotwv6rh44jAF39VyH+A7uNaXDPc/ziV/aq497mdrzRY2f6944cRyaziNbWFtdWiVUwuFfxBvc8x6/HzgEAni0voPP0hO9rlFnFK8D+y8FvCJ/6fMilff0/666he+rzIYR/OamEfkBv/wmZ8R/Yd+Fvfv8q+kfm0D8yh2fLCwBs8R0dnQBQslUFMpIqgLRT8Lx35Dj2GR2urYqw/7Unu5KqyyViyCViOPZud0kPCIAzlKQHNWxV0Nl/EVnxH0gCza6k6uhhNPagf2QOQFHs01waV8eG8TSXDuLjqoKuCQhg/2XCCUg+MuM/8FX4ZDJWZ5pRy2jswdWxYQDAwXcuOM9fHRtWbg5O7M6bZtTqH5kF4K0AMv9EreVtCfZfDje/fxU3Cw13+rf2MUpAmcxiyVYltoP/xGbiP/+/fGDTD1Wbx8iv562+IxeLB0JhxC4NIHraPpZ7MqvUPIqIaUYtALh7ZxyAuwLu3hl3EpCq+oHt7X+QDSBoTDNq5Z7M4mkujYvDYwDgNGQAuDg8hi+++LOy3gN6+0944z+ZjFVFc9WMuP84b0VH7dW96Kh9m0Hskn27R3Q0rtTXwfy4/zhvUbIBUExAo3Egm1I6AQH6++93AUA2BUDt5A9s7gKssn5Ab//9ME9NWdXQH/gQ3g9quA6FgihPKIzkjeO20UngpzcKFQHAaOxBdkWPcujo/4McnItWkWIPWmWSyVidnYCEg4UEdPCdC8g9mZUlbdPo7D/g7kAUCV5/YKvwXqjXQ1vxuA4BRLrvP85b4oMqRPUybBf/Rf26aAcKN3eHwnYSun7VbsihsGxZm0Z3/2ulvyrdcOql+SH+lqCqwwCvfvEqRsNfQB/9Ijr6T+igHWD9sqml/qoN4Q/tfob+Ux87++KVQGXzCdIfHY27tKv2Y7Ib4U38hA7+A/76ddG+2fg3d9Y7jT35gzqLM+X06+I/UJv4CTSB0uQ5AJf5hE7Jh/SLCy+EqkEk+l8y7wm9/PfTD9jfOlHBfzHxAaXJzy/+CSqDubPeOv/h+wCAz778uhoyX5hy+lXx3w/TjFo0TVKr+AkkgYaawpbR2FPYKZ3nmb7xKYC9QXxUVfgx/YTKCWij3zj0zoOqingBEFFVf6S9FYB9D6iJtCUmUXEBwxv/lDxnVtfx1dAAHi5nayu8DLr5L+LEfzZV0oarqT/4RaTCCm850apevRx89NsNoPC06voL6Oa/ubPewvw4MG/f+uOn31hLw1hLu15Dj5oJLZD8IV+XWMjg8u15XDv8pq3HjFpiEqIy/O1fdvI0GntgrKWd3islz8RCRvrwXTf/vWRXUnWO/mzKPfUWPwnETzr/5ylI3YH8Sw+n9+Z6IoxDu585u6rePKy7fhG/HkTuySyMSFTp+z7NnfVWpL0Vbc0hfPLXfxYbaZd9y4/R2GNv19I4/+H7znCXenCAPQSWkYSoJ9m3y/7Vn9zrxW95OboLWwCuMlAPVnYC/TH/CRX9JzYqA+bHq6a7ogJ7h43GWtoV9AQFf+71Dlw7/CaOTsaxv6VbeoPWXb8X52IwP+5qyIBdtpnVdSV1U/ADQFtzCEcn4+jb1eBORmtpRNpbkVjIuBoADX9lJSGx4Xoboxhfxlraee53P/uJRZoB+YtHOvtPbFSGwT3Pq6b7hV9IE+BHJ+O40tuFtuYQgGJG9wYPBdnD5WzJuS+qoRJ0118OcWHi4XIWl2/P46uhAXz25dcQFyxU1A1s3DsQGwmhQhLa6kq6iivvOvtPlCsDUJyvJoLSXfEi0pXeLly+PY8rvV2u42IvxygUjLK+KpPmgP76/SB9VC5K+CrrpkDu29VQ0khd5yxkNlz9lslmtaikmdhO/nvLUE3dFfVA/Y6XE7bV86uN7vo3YjOT4yrqJlTsob1MbAf/t0MZGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhXnL+DyMmbYWxYb8ZAAAAAElFTkSuQmCC",$v="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAA3dJREFUeJzt3D9LHEEYx/HfBd+FHJFDu1gIJ2gVRaxthKuEpBHSpLKyEZtUV6UJaBOwSZHGFxAUFCxcsDBddL1jsdU3ENgUe3PxH7o7e3c7D34/jXDczP32med21l1RAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAojYlm+v7jj9R3bGOi6TUWGev1t54f1Qqhf974Diz74fXFDdUXN0rPU0YIC+DLev2t55ds94/LYDV/KP0z5jOoMdFM628XJEm/vq1qSdkiJAdtxZ2olmeO9uaqZurS0idJB+0077hBGcQCSKosu+X6W88v2e4fyXb+kPqn8Am0H77RvBdGkjbiSJIKhWlvrnqNKyOkBSjKev2t55ds949kO39o/VPoBPpU+LNEmqlnP9Voqp69/GKY2amx2umfv9kuWGBcWaEtQBHW6289v2S7fyTb+UPsH+97oA9tfPkpF2YU43w8twAuQ/3tQq5fb2anxmpnSfFxw2Kh/sPIQf/kZz3/c6rqH78TaLbj9J0l2eV/ctD2mi4EFr7Afdbrbz3/E0z1zwBzvPb+93qIJEmKIyXdQ7V6oS+vTvX7+2etbOc/iNbynKTeDekHRRmqOHq0C7vi92+Oh85y/SXb+a33j/X8UjD9U+gKNO5EtaR7qKR72H9tf2tel1enuj3e1fjkdP99eea7vDrV/tZ8NVcecaTkoK3W8pxay3NeWVrLc//fP4IvsPX6W89/j8H+ucdg/hD7p/AV6J1wqSSNT07r9nhX1xfnWtk+yTXHzdHOo3slSfcw94H76s2fSpJ7Crm/Na93H77eWYCTQgvgdj0337BZrr9kO7/1/rGeXwqvf7wfIrkPu744l5QdSLS3nmtsc21H1xfnXrtGWXEnqrmdTLq/AM21nVxz3BztpA8XYVQnIMdq/R2r+a33j/X8Tij9U+opfNyJaivbJ/3Cu4N5SbS33g+ed8yghbIAZViuv2Q7v/X+sZ7ffWbV/eP/EKkn7kS1xkQzdQeRp5DuvXkXbFiyBVAqnSjaWy+0AE6VJyDJdv0l2/mt94/1/FL1/TPyXeMu93djVexeT+XIm8W93zXdynb++0YhCaX+vkLJb71/rOf3FUr/vFpV/0MF2Ga9f6znBwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQFn/AEOMz2GJzMQ0AAAAAElFTkSuQmCC",Kv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAAxtJREFUeJzt2T9r21AUh+GfS7+FMTHCYzUUNMRTU0LI6CWQLoYWgsdMHkIW46WTpy4FZ2jBS4cu/gAlLQQ8RNDB3eooLsFz5kJBHWTJiv/RWrJkxe+zWFHE9bnnHh3JkgQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALBBjKLlvnjzyU07jm1F/rHN0qr/J3EMYhStzJ+4WW5A5B9RZTn/adb/06gDGEXLLezsSZK+vD/SvrxFuLtsyRnaueuff9zjg11JkjO0c4vG8LcXHbNOWW5A5H8zGEXLLbys69uHV4nnL6os5z/t+o/UQIPgDSvY1zo/kiQdX7ZkFC33+GBXN7fX+vHxVJWm3Okg/eDtTk2SZFXlJnkSp70AUZD/yRj+NheA/5Pl/G9C/a/cQOcF//1Oel7wPiWp2yjr2et3ur+6UL5kSurNBN9tlJUvmbKqbXUb5VXDiW0OWWlA5H8yhsQFYBVZzn/U+vfjjlr/sTwDnVZ/+1mSlC+Zur+60GjQl1VtzxxX2NkbT2wykaQsWwBft1HWze11aAFmi6fbKMvu1GRV2xoN+onFv8w25N8oWm7a+X8wh/E8WudHQRMKN6BuoxzEPD2G5DUgu1NL7G72MeR/kSTrP3oDdewHf+4fngX7/ITmS2ZwhQq7+/U1mFy+ZG7lAkRG/iVxAYhTFvIfSLn+47kDdWzJsVU/OQsCc4Z2rtLsBYmfF5x/jG8bFyAW5J8LwKoeQ/5XqH9naOfiqP+Vn4GOr6Su5BWC5AUe+p+coZ0zipbrT2Les5F/OWbtxgVTP/E+JwsgV+rJ7tSWNCAFP7n85yyJhLzl+ffjTCv/k0DsB3eh+4dnwfZo0Fe+ZI4bkDnTRL0G9FuV5uIaS0QG878p9R/LyeI/t0nl5IvAj3vRAoSPmd4/b5xlx6wT+U8+/+GXR9P8BhR+vjka9FVp9mbim30J0050DlI28z/v+9P47kydcOuS1Qb0WGQ1/zQgAIho3tt1AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEC8/gIPz/mfyE/ZzwAAAABJRU5ErkJggg==",Jv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAgCAYAAADaInAlAAAAAXNSR0IArs4c6QAAAgtJREFUeJztmj1Ow0AQhWeRKc0BKKNUUcIBaIw7pFgKuQAnIHeg4QRwDKQIKdSRzxCUClHmAm4oLA0F2cjkh6zXaz/bma9K5bd+82bsdZZIEARBEARBODkUegEuCHyP9e84SVtxT0IOmJkD3+PX+zvOhqFKULpF9c9ciSMNUEqpOEnVx+cXTcYRrBhoH2z0nQSgyAJcwcw8XywJFYI4SVU46MECaKtfOADMzERE4aBHSAOIfk1AhgCpDdHXxdcEvseP11fQZzFqHdoLlAe2+tYTgJlZKbXzxo3uAgRZL9BTKK++ZyNyqPibLdhiyUREk3FENJ1x1VuzOEkVeg1NIfcEOFT8OhIOo9I19vnRpCmQKwCmxUcboJm/z2j0sirt+sf8qCKA/2GibxwAm85HG0BE9PZwSUS7L6xVUHYAXegbBcB27KMN6Hc7G32llHIZAhNPwmG0CSACE32nH4LqxuhlVVoBTAKFbgBnE8B191TF0+33HwOqvo9WTQBb8+puQBGOedKaCaAxDUHgexwOetTvduh5OoP9RZs1gNdUvYVFNoCJfu53gKY9DrQBao3r6+/zA90AefStvgTqm942VO/30d2PLkCTsN4FbCcfXXzkVMp6gQ5fXv3Ci2Nmvrk4JyJ85xPhCoBuAFt9ZwtEn8urQwGa1Pmtow5nEZp4JKxVnLwBgiAIgiAIhvwA7Cn27X2XP3EAAAAASUVORK5CYII=",xe={tsetD1:new Me(Lv),ground:new Me(Uv),overlay:new Me(zv),fence:new Me(Hv),tree:new Me(Ov),purpleGuy:new Me(Wv),purpleShadow:new Me(Nv),lifebar:new Me(Gv),buttonUp:new Me(Vv),buttonDown:new Me(Xv),swordPlayerBody:new Me(qv),swordPlayerHands:new Me(Yv),swordPlayerHandArmed:new Me(jv),sword:new Me(Zv),arrowPlayerBody:new Me(Qv),arrowPlayerHands:new Me($v),arrowPlayerHandsArmed:new Me(Kv),bow:new Me(Jv)};mi.fromImageSource({image:xe.tsetD1,grid:{rows:2,columns:2,spriteWidth:34,spriteHeight:17}});const ko=mi.fromImageSource({image:xe.ground,grid:{rows:10,columns:5,spriteWidth:64,spriteHeight:32}}),Gi=mi.fromImageSource({image:xe.overlay,grid:{rows:10,columns:10,spriteHeight:16,spriteWidth:16}}),Lo=mi.fromImageSource({image:xe.purpleGuy,grid:{rows:1,columns:4,spriteHeight:32,spriteWidth:32}});mi.fromImageSource({image:xe.swordPlayerBody,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}});mi.fromImageSource({image:xe.swordPlayerHands,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}});mi.fromImageSource({image:xe.swordPlayerHandArmed,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}});mi.fromImageSource({image:xe.sword,grid:{rows:1,columns:4,spriteHeight:80,spriteWidth:80}});mi.fromImageSource({image:xe.arrowPlayerBody,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}});mi.fromImageSource({image:xe.arrowPlayerHands,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}});mi.fromImageSource({image:xe.arrowPlayerHandsArmed,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}});mi.fromImageSource({image:xe.bow,grid:{rows:1,columns:4,spriteHeight:80,spriteWidth:80}});const C_=new Sv;for(let d of Object.values(xe))C_.addResource(d);const tw=new yv({strategy:Av.Loop,frames:[{graphic:Lo.getSprite(0,0),duration:100},{graphic:Lo.getSprite(1,0),duration:100},{graphic:Lo.getSprite(2,0),duration:100},{graphic:Lo.getSprite(3,0),duration:100}]}),Vh=25,xu=new Zn(Date.now()),bu=new Fn({useAnchor:!0,members:[{graphic:xe.purpleShadow.toSprite(),offset:yt(0,0)},{graphic:tw,offset:yt(0,0)}]}),ew=new d_({radius:7.5,color:jt.Red,strokeColor:jt.fromHex("#000000"),lineWidth:2}),iw=new d_({radius:7.5,color:jt.Red,strokeColor:jt.fromHex("#FFFFFF"),lineWidth:2});class kr extends mn{affinity="dark";lightTarget;darkTarget;currentTarget=void 0;constructor(t,i,n){super({radius:7.5,pos:t,anchor:ve.Half,z:1e3,collisionType:vn.Active,collisionGroup:Fv}),this.lightTarget=i,this.darkTarget=n,this.graphics.add(bu)}onCollisionStart(t,i,n,o){(i.owner instanceof P_||i.owner instanceof A_)&&(this.scene.enemyWaveManager?.enemyPool?.return(this),this.scene?.remove(this),i.owner.currentHP-=2)}onInitialize(){}reset(){this.graphics.getNames().forEach(i=>this.graphics.remove(i)),xu.bool()?(this.affinity="light",this.graphics.add(iw)):(this.affinity="dark",this.graphics.add(ew))}checkDrop(){if(xu.integer(0,100)<40){if(!this.scene)return;this.affinity=="dark"?this.scene.add(new b_(this.pos)):this.scene.add(new x_(this.pos))}}onPreUpdate(t,i){this.graphics.add(bu);const o=this.actions.getQueue().getActions().find(c=>c instanceof Ev);let h;if(o)this.scene?.entities?.find(g=>g==this.currentTarget)||(this.lightTarget&&this.darkTarget?h=this.lightTarget.pos.distance(this.pos)<this.darkTarget.pos.distance(this.pos)?this.lightTarget:this.darkTarget:this.lightTarget?h=this.lightTarget:h=this.darkTarget,this.currentTarget=h,this.actions.clearActions(),this.actions.meet(h,Vh));else{if(this.lightTarget&&this.darkTarget?h=this.lightTarget.pos.distance(this.pos)<this.darkTarget.pos.distance(this.pos)?this.lightTarget:this.darkTarget:this.lightTarget?h=this.lightTarget:this.darkTarget&&(h=this.darkTarget),!h)return;this.currentTarget=h,this.actions.meet(h,Vh)}if(this.lightTarget&&this.darkTarget){let c=this.lightTarget.pos.distance(this.pos)<this.darkTarget.pos.distance(this.pos)?this.lightTarget:this.darkTarget;this.actions.meet(c,Vh)}}}let sw=.15;class nw extends mn{angle=0;radius=20;angVel=sw;UISignal=new Bi("stateUpdate");constructor(t){super({width:12,height:3,color:jt.LightGray,pos:yt(0,0).add(yt(20,0)),rotation:Rv(0),collisionType:vn.Passive,collisionGroup:g_})}onCollisionStart(t,i,n,o){if(i.owner instanceof kr){let h=i.owner;this.UISignal.send(["enemyDefeated",h.affinity]),h.checkDrop(),this.scene.enemyWaveManager?.enemyPool?.return(h),this.scene?.remove(h)}}onPreUpdate(t,i){this.angle+=this.angVel,this.angle>=Math.PI*2&&(this.angle=Math.PI*2,this.kill());const n=this.radius*Math.cos(this.angle),o=this.radius*Math.sin(this.angle);this.pos.setTo(n,o),this.rotation=this.angle}}class P_ extends mn{currentHP=20;maxHP=20;isPlayerActive=!0;partner;jc=new p_;kc=new y_;HealthBar;speed=80;exp=0;fireIntervalHandler;fireInterval=2e3;fireDamage=3;isJoystickActive=!0;isKeyboardActive=!1;UISignal=new Bi("stateUpdate");gamePausedSignal=new Bi("pauseGame");constructor(){super({radius:10,color:jt.Black,pos:yt(0,0),anchor:ve.Half,z:1e3,collisionType:vn.Active,collisionGroup:m_}),this.addComponent(this.jc),this.HealthBar=new w_(new ve(20,2),new ve(-10,-15),20),this.addChild(this.HealthBar),this.fireIntervalHandler=setInterval(this.fire.bind(this),this.fireInterval)}onInitialize(t){this.jc.init({updateInterval:50,deadZone:15},i=>{!this.isPlayerActive||!this.isJoystickActive||(i.state==="active"?(this.vel.x=i.direction.x*this.speed,this.vel.y=i.direction.y*this.speed):(this.vel.x=0,this.vel.y=0))}),this.kc.init(),this.scene&&(this.scene.camera.strategy.lockToActor(this),this.scene.camera.zoom=1.5)}onCollisionStart(t,i,n,o){i.owner instanceof b_&&(this.exp+=1,this.UISignal.send(["soul"]),i.owner.kill())}registerPartner(t){this.partner=t}fire(){let t=new nw(this.pos);this.addChild(t)}onPreUpdate(t,i){const o=this.actions.getQueue().getActions().find(h=>h instanceof f_);if(!this.isPlayerActive&&this.partner&&this.partner.pos.distance(this.pos)>25&&!o?this.actions.follow(this.partner,50):this.isPlayerActive&&o&&this.actions.clearActions(),this.HealthBar?.setPercent(this.currentHP/this.maxHP*100),this.kc.keyEnable&&(this.isKeyboardActive=!0,this.isJoystickActive=!1),this.isPlayerActive&&this.isKeyboardActive){let h=this.kc.keys;h.includes("ArrowLeft")?this.vel.x=-this.speed:h.includes("ArrowRight")&&(this.vel.x=this.speed),h.includes("ArrowUp")?this.vel.y=-this.speed:h.includes("ArrowDown")&&(this.vel.y=this.speed),!h.includes("ArrowLeft")&&!h.includes("ArrowRight")&&(this.vel.x=0),!h.includes("ArrowUp")&&!h.includes("ArrowDown")&&(this.vel.y=0)}this.currentHP<=0&&(this.isPlayerActive&&this.scene.switchPlayerFocus(),this.fireIntervalHandler&&clearInterval(this.fireIntervalHandler),this.kill())}}class rw{constructor(t,i,n=1){this.builder=t,this.cleaner=i,this.grow(n)}_pool=[];_size=0;grow(t){if(t>0){this._size+=t;for(let i=0;i<t;i++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}}function T_(d,t,i){const n=d%t,o=Math.floor(d/t);return n===0||n===t-1||o===0||o===i-1}function ow(d,t,i){const n=d%t,o=Math.floor(d/t);return n===1||n===t-2||o===1||o===i-2}function aw(d){return Math.floor(55+d*25)}function hw(d){const t=Math.max(3,Math.floor(d/15));let i=Array.from({length:t},(_,g)=>g+1);const n=i.reduce((_,g)=>_+g,0);let o=i.map(_=>Math.floor(_/n*d)),h=o.reduce((_,g)=>_+g,0),c=d-h;for(;c!==0;)for(let _=o.length-1;_>=0&&c!==0;_--)o[_]+=c>0?1:-1,c+=c>0?-1:1;return o}function lw(d){return yt(0,d.rows*d.tileHeight/2)}class cw{rng=new Zn(Date.now());getSpawnPositions(t,i){console.log("random");let n=[];for(let o=0;o<t;o++){let h=this.getRandomTile(i);n.push({x:h.x,y:h.y})}return n}getRandomTile(t){let i=t.columns*t.rows,n=this.rng.integer(0,i-1);for(;T_(n,t.columns,t.rows);)n=this.rng.integer(0,i-1);return t.tiles[n].pos.clone()}}class dw{getSpawnPositions(t,i){console.log("circle");let n=i.columns,o=i.rows;const h=Math.ceil(n/2),c=Math.ceil(o/2),_=n/2-2;let g=[];for(let v=0;v<t;v++){const x=2*Math.PI*v/t,b=Math.floor(h+Math.cos(x)*_),T=Math.floor(c+Math.sin(x)*_)*n+b,I=i.tiles[T].pos.clone();g.push({x:I.x,y:I.y})}return g}}class uw{rng=new Zn(Date.now());getSpawnPositions(t,i){console.log("edges");const n=[],o=i.tiles.filter((h,c)=>ow(c,i.columns,i.rows));for(let h=0;h<t;h++){const c=this.rng.pickOne(o);c&&n.push({x:c.pos.x,y:c.pos.y})}return n}}class fw{rng=new Zn;getSpawnPositions(t,i){console.log("cluster");const n=[],o={tl:{x:Math.floor(i.columns/4),y:Math.floor(i.rows/4)},tr:{x:Math.floor(i.columns/4)*3,y:Math.floor(i.rows/4)},bl:{x:Math.floor(i.columns/4),y:Math.floor(i.rows/4)*3},br:{x:Math.floor(i.columns/4)*3,y:Math.floor(i.rows/4)*3}},h=["tl","tr","bl","br"],c=this.rng.pickOne(h),_=o[c],g=_.x,v=_.y,x=Math.floor(Math.sqrt(i.tiles.length)/4);for(let b=0;b<t;b++){let P=this.rng.integer(-x/2,x/2),T=this.rng.integer(-x/2,x/2),I=g+P;const R=(v+T)*i.columns+I,S=i.tiles[R];S&&n.push({x:S.pos.x,y:S.pos.y})}return n}}class _w{getSpawnPositions(t){return Array.from({length:t},()=>({x:Math.random()*800+800,y:Math.random()*600}))}}let yu=18e3,pw=5;const gw={RANDOM:"RANDOM"},Xh={RANDOM:new cw,CIRCLE:new dw,EDGES:new uw,CLUSTER:new fw,RANDOM_OFFSCREEN:new _w};class mw{enemyPool;rng;lightPlayer;darkPlayer;spawnInterval=yu;spawnEnabled=!1;scene;stateSignal=new Bi("stateUpdate");burnDown=new Bi("burnDown");map;enemyCount=0;waveNumber=0;batchSize=[];batchIndex=0;spawnStrategy=gw.RANDOM;lastBatchSpawnedFlag=!1;WaveTimer;isWaveActive=!1;duration=0;isStartDelayConsumed=!1;constructor(t,i,n,o){this.rng=new Zn(Date.now()),this.lightPlayer=i,this.darkPlayer=n,this.scene=t,this.map=o,this.WaveTimer=setInterval(this.waveTik,1e3)}init(){this.enemyPool=new rw(this.makeEnemy,this.cleanUpEnemy,500),this.isWaveActive=!0}waveTik=()=>{this.isWaveActive&&(this.duration+=1,!this.isStartDelayConsumed&&this.duration>=pw&&(this.isStartDelayConsumed=!0,console.log("initial batch spawn"),this.spawnEnemies()),this.isStartDelayConsumed&&(this.stateSignal.send(["waveDuration",this.duration]),this.burnDown.send()))};startWave(){this.waveNumber+=1,this.isWaveActive=!0,this.spawnEnabled=!0,this.duration=0,this.isStartDelayConsumed=!1,this.enemyCount=aw(this.waveNumber),this.batchSize=hw(this.enemyCount),this.spawnStrategy=this.rng.pickOne(Object.keys(Xh)),this.lastBatchSpawnedFlag=!1}endWave(){this.spawnEnabled=!1,this.isWaveActive=!1,this.duration=0,this.isStartDelayConsumed=!1,this.scene.showEndOfWaveModal()}spawnEnemies(){if(this.lastBatchSpawnedFlag){this.scene.entities.filter(o=>o instanceof kr).length==0&&this.endWave();return}let t=Xh[this.spawnStrategy].getSpawnPositions(this.batchSize[this.batchIndex],this.map);this.batchIndex+=1,this.spawnStrategy=this.rng.pickOne(Object.keys(Xh)),this.batchIndex==this.batchSize.length&&(this.lastBatchSpawnedFlag=!0);for(let i=0;i<t.length;i++){let n=t[i];if(n===void 0)continue;let o=this.map?.tiles.find(c=>c.pos.x===n.x&&c.pos.y===n.y);if(!o)continue;let h=this.enemyPool?.rent(!0);h.pos=o.pos.clone(),this.scene.add(h)}}makeEnemy=()=>new kr(yt(0,0),this.lightPlayer,this.darkPlayer);cleanUpEnemy(t){return t.reset(),t}update(t){this.spawnEnabled&&this.isStartDelayConsumed&&(this.spawnInterval-=t,this.spawnInterval<=0&&(this.spawnInterval=yu,this.spawnEnemies()))}}class vw extends xs{constructor(t){super({name:"StatusBar",width:t.x,height:15,x:0,y:0,color:jt.Black,opacity:.5,z:999}),this.dims=t,this.timeLabel=new ln({text:Au(this.time),font:new hn({size:12,family:"Arial",color:jt.White,textAlign:cn.Center}),x:this.pos.x+this.width/2,y:0}),this.addChild(this.timeLabel),this.whiteKills=new ln({anchor:ve.Zero,text:`Light Kills: ${this.whites}`,font:new hn({size:12,family:"Arial",color:jt.White,textAlign:cn.Center}),x:this.pos.x+100,y:0}),this.addChild(this.whiteKills),this.blackKills=new ln({anchor:ve.Zero,text:`Dark Kills: ${this.blacks}`,font:new hn({size:12,family:"Arial",color:jt.White,textAlign:cn.Center}),x:0,y:0}),this.addChild(this.blackKills);let i=this.blackKills.getTextWidth();this.blackKills.pos.x=t.x-i;let n=this.timeLabel.getTextWidth();this.timeLabel.pos.x=this.width/2-n/2}time=0;whites=0;blacks=0;souls=0;blessings=0;timeLabel;whiteKills;blackKills;updateSignal=new Bi("stateUpdate");onInitialize(t){this.updateSignal.listen(this.UIUpdate.bind(this))}onPreUpdate(t,i){let n=this.timeLabel.getTextWidth();this.timeLabel.pos.x=this.width/2-n/2,this.whiteKills.text=`Light Kills: ${this.whites}  Blessings: ${this.blessings}`,this.blackKills.text=`Dark Kills: ${this.blacks} Souls: ${this.souls}`;let o=this.blackKills.getTextWidth();this.blackKills.pos.x=this.width-5-o}UIUpdate(t){const[i,n]=t.detail.params;i==="waveDuration"?(this.time=n,this.timeLabel.text=Au(this.time)):i==="enemyDefeated"?(n==="light"&&(this.whites+=1),n==="dark"&&(this.blacks+=1)):i=="soul"?this.souls++:i=="blessing"&&this.blessings++}}function Au(d){const t=Math.floor(d/60),i=d%60;return`Time: ${t}:${i.toString().padStart(2,"0")}`}class ww extends xs{constructor(t,i,n,o){const h=new ea({width:t.x,height:t.y,color:jt.Green}),c=new ea({width:t.x,height:t.y,color:jt.Red});super({name:"burnDownBar",width:t.x,height:t.y,pos:i,z:1001,opacity:.7}),this.dims=t,this.position=i,this.graphics.use(c),this.percent=n,this.scene=o,this.currentVal=n,this.maxVal=n,this.child=new xs({name:"innerHealthBar",width:t.x,height:t.y,pos:new ve(0,0),z:1}),this.child.graphics.use(h),this.addChild(this.child),this.burnDownSignal.listen(()=>{this.currentVal--,this.percent=this.currentVal/this.maxVal*100,this.percent<0&&(this.percent=0),this.percent>100&&(this.percent=100),this.child.scale.x=this.percent/100,this.child.scale.y=1,this.percent<=0&&(this.scene.switchPlayerFocus(),this.currentVal=this.maxVal,this.percent=100,this.child.scale.x=this.percent/100,this.child.scale.y=1)})}burnDownSignal=new Bi("burnDown");currentVal;maxVal;percent;child;scene}var qh={exports:{}},Yh={exports:{}};/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var Cu;function xw(){return Cu||(Cu=1,function(d,t){(function(n,o){d.exports=o()})(self,()=>(()=>{var i={851:(u,e,s)=>{s.d(e,{A:()=>m});var r=s(1),a=s.n(r),l=s(935),f=s.n(l),p=f()(a());p.push([u.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const m=p},296:(u,e,s)=>{s.d(e,{A:()=>m});var r=s(1),a=s.n(r),l=s(935),f=s.n(l),p=f()(a());p.push([u.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const m=p},935:u=>{u.exports=function(e){var s=[];return s.toString=function(){return this.map(function(a){var l="",f=typeof a[5]<"u";return a[4]&&(l+="@supports (".concat(a[4],") {")),a[2]&&(l+="@media ".concat(a[2]," {")),f&&(l+="@layer".concat(a[5].length>0?" ".concat(a[5]):""," {")),l+=e(a),f&&(l+="}"),a[2]&&(l+="}"),a[4]&&(l+="}"),l}).join("")},s.i=function(a,l,f,p,m){typeof a=="string"&&(a=[[null,a,void 0]]);var w={};if(f)for(var y=0;y<this.length;y++){var A=this[y][0];A!=null&&(w[A]=!0)}for(var E=0;E<a.length;E++){var D=[].concat(a[E]);f&&w[D[0]]||(typeof m<"u"&&(typeof D[5]>"u"||(D[1]="@layer".concat(D[5].length>0?" ".concat(D[5]):""," {").concat(D[1],"}")),D[5]=m),l&&(D[2]&&(D[1]="@media ".concat(D[2]," {").concat(D[1],"}")),D[2]=l),p&&(D[4]?(D[1]="@supports (".concat(D[4],") {").concat(D[1],"}"),D[4]=p):D[4]="".concat(p)),s.push(D))}},s}},1:u=>{u.exports=function(e){var s=e[1],r=e[3];if(!r)return s;if(typeof btoa=="function"){var a=btoa(unescape(encodeURIComponent(JSON.stringify(r)))),l="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),f="/*# ".concat(l," */");return[s].concat([f]).join(`
`)}return[s].join(`
`)}}},n={};function o(u){var e=n[u];if(e!==void 0)return e.exports;var s=n[u]={id:u,exports:{}};return i[u](s,s.exports,o),s.exports}o.n=u=>{var e=u&&u.__esModule?()=>u.default:()=>u;return o.d(e,{a:e}),e},o.d=(u,e)=>{for(var s in e)o.o(e,s)&&!o.o(u,s)&&Object.defineProperty(u,s,{enumerable:!0,get:e[s]})},o.o=(u,e)=>Object.prototype.hasOwnProperty.call(u,e),o.r=u=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(u,"__esModule",{value:!0})};var h={};o.r(h),o.d(h,{ActionCompleteEvent:()=>Qa,ActionContext:()=>dr,ActionQueue:()=>Wc,ActionSequence:()=>Bh,ActionStartEvent:()=>Za,ActionsComponent:()=>Sn,ActionsSystem:()=>Ah,ActivateEvent:()=>Ga,Actor:()=>Ye,ActorEvents:()=>Mp,AddEvent:()=>$a,AddedComponent:()=>ap,AffineMatrix:()=>le,Animation:()=>Ai,AnimationDirection:()=>tr,AnimationEvents:()=>sp,AnimationStrategy:()=>yi,ArcadeSolver:()=>mh,AudioContextFactory:()=>nr,Axes:()=>Sh,Axis:()=>xo,BaseAlign:()=>io,BezierCurve:()=>cr,Blink:()=>cd,BodyComponent:()=>Ct,BoundingBox:()=>at,BrowserComponent:()=>Rh,BrowserEvents:()=>Xd,Buttons:()=>pr,Camera:()=>Sd,CameraEvents:()=>kp,Canvas:()=>_o,Circle:()=>mo,CircleCollider:()=>ze,Clock:()=>Dh,ClosestLineJumpTable:()=>zi,Collider:()=>Ts,ColliderComponent:()=>ue,CollisionContact:()=>js,CollisionEndEvent:()=>sr,CollisionGroup:()=>ns,CollisionGroupManager:()=>Ui,CollisionJumpTable:()=>Pi,CollisionPostSolveEvent:()=>co,CollisionPreSolveEvent:()=>lo,CollisionStartEvent:()=>ir,CollisionSystem:()=>yo,CollisionType:()=>dt,Color:()=>Q,ColorBlindFlags:()=>Gd,ColorBlindnessMode:()=>Qs,ColorBlindnessPostProcessor:()=>Nd,Component:()=>pi,CompositeCollider:()=>ye,ConsoleAppender:()=>vi,ContactConstraintPoint:()=>Bd,ContactEndEvent:()=>ho,ContactSolveBias:()=>rs,ContactStartEvent:()=>ao,CoordPlane:()=>Ie,CrossFade:()=>pg,CurveBy:()=>gd,CurveTo:()=>pd,DeactivateEvent:()=>Va,Debug:()=>Ae,DebugConfig:()=>Vd,DebugGraphicsComponent:()=>wo,DebugSystem:()=>xh,DebugText:()=>xa,DefaultAntialiasOptions:()=>qd,DefaultGarbageCollectionOptions:()=>Fh,DefaultLoader:()=>rr,DefaultPixelArtOptions:()=>Yd,DegreeOfFreedom:()=>Je,Delay:()=>ud,Detector:()=>Hc,Die:()=>fd,Direction:()=>no,Director:()=>$d,DirectorEvents:()=>Vp,DisplayMode:()=>be,DynamicTree:()=>rh,DynamicTreeCollisionProcessor:()=>go,EX_VERSION:()=>Oh,EaseBy:()=>ld,EaseTo:()=>hd,EasingFunctions:()=>Ot,EdgeCollider:()=>ri,ElasticToActorStrategy:()=>Cd,EmitterType:()=>Rs,Engine:()=>ti,EngineEvents:()=>Xp,EnterTriggerEvent:()=>Ya,EnterViewPortEvent:()=>qa,Entity:()=>Ue,EntityEvents:()=>dp,EntityManager:()=>Id,EventEmitter:()=>I,EventTypes:()=>ro,Events:()=>g,ExResponse:()=>eh,ExcaliburGraphicsContext2DCanvas:()=>fo,ExcaliburGraphicsContextWebGL:()=>ss,ExitTriggerEvent:()=>ja,ExitViewPortEvent:()=>Xa,Fade:()=>dd,FadeInOut:()=>_g,Flags:()=>b,Flash:()=>_d,Follow:()=>fh,Font:()=>Ws,FontCache:()=>Ft,FontSource:()=>ug,FontStyle:()=>so,FontUnit:()=>to,FpsSampler:()=>jd,FrameStats:()=>wr,Future:()=>T,GameEvent:()=>mt,GameStartEvent:()=>Ia,GameStopEvent:()=>Ra,Gamepad:()=>Po,GamepadAxisEvent:()=>Oa,GamepadButtonEvent:()=>Ha,GamepadConnectEvent:()=>Ua,GamepadDisconnectEvent:()=>za,Gamepads:()=>Co,GarbageCollector:()=>tu,Gif:()=>cg,GifParser:()=>su,GlobalCoordinates:()=>En,GpuParticleEmitter:()=>Zp,GpuParticleRenderer:()=>Eo,Graphic:()=>Kt,GraphicsComponent:()=>te,GraphicsGroup:()=>xn,GraphicsSystem:()=>wh,HashColliderProxy:()=>kd,HashGridCell:()=>Wi,HashGridProxy:()=>bh,HiddenEvent:()=>Na,HorizontalFirst:()=>ah,ImageFiltering:()=>ce,ImageSource:()=>ki,ImageSourceAttributeConstants:()=>It,ImageWrapping:()=>Vt,InitializeEvent:()=>Pn,InputHost:()=>Ih,InputMapper:()=>Ud,IsometricEntityComponent:()=>_r,IsometricEntitySystem:()=>Ch,IsometricMap:()=>Qp,IsometricTile:()=>eu,KeyEvent:()=>mr,Keyboard:()=>Hd,Keys:()=>gr,KillEvent:()=>oo,Label:()=>qp,LimitCameraBoundsStrategy:()=>Td,Line:()=>Lh,LineSegment:()=>oe,Loader:()=>qs,LoaderEvents:()=>bp,LockCameraToActorAxisStrategy:()=>Ad,LockCameraToActorStrategy:()=>yd,LogLevel:()=>Ht,Logger:()=>ot,Material:()=>Dc,Matrix:()=>ni,MatrixLocations:()=>wa,MediaEvent:()=>ih,Meet:()=>_h,MotionComponent:()=>Dt,MotionSystem:()=>bo,MoveBy:()=>dh,MoveByWithOptions:()=>jc,MoveTo:()=>uh,MoveToWithOptions:()=>Qc,NativePointerButton:()=>Es,NativeSoundEvent:()=>Xs,NativeSoundProcessedEvent:()=>Lc,NineSlice:()=>zh,NineSliceStretch:()=>ls,None:()=>hh,Observable:()=>Ve,OffscreenSystem:()=>Ph,Pair:()=>qe,ParallaxComponent:()=>vo,ParallelActions:()=>$p,Particle:()=>uo,ParticleEmitter:()=>Yp,ParticleRenderer:()=>Bc,ParticleTransform:()=>Ci,PhysicsStats:()=>So,PhysicsWorld:()=>Ld,PointerAbstraction:()=>Eh,PointerButton:()=>as,PointerComponent:()=>Ss,PointerEvent:()=>vr,PointerEventReceiver:()=>To,PointerScope:()=>F,PointerSystem:()=>Ao,PointerType:()=>hs,Polygon:()=>Uh,PolygonCollider:()=>Re,Pool:()=>Jr,PostCollisionEvent:()=>Gs,PostDebugDrawEvent:()=>Ba,PostDrawEvent:()=>Cn,PostFrameEvent:()=>La,PostKillEvent:()=>Ea,PostTransformDrawEvent:()=>Ma,PostUpdateEvent:()=>Ps,PreCollisionEvent:()=>Ns,PreDebugDrawEvent:()=>Fa,PreDrawEvent:()=>An,PreFrameEvent:()=>ka,PreKillEvent:()=>Sa,PreLoadEvent:()=>Op,PreTransformDrawEvent:()=>Da,PreUpdateEvent:()=>Cs,Projection:()=>or,QuadIndexBuffer:()=>Jn,QuadTree:()=>Rn,Query:()=>ur,QueryManager:()=>Rd,RadiusAroundActorStrategy:()=>Pd,Random:()=>M,Raster:()=>bn,Ray:()=>Ys,RealisticSolver:()=>vh,Rectangle:()=>hr,RemoveEvent:()=>Ka,RemovedComponent:()=>lp,Repeat:()=>Nc,RepeatForever:()=>Gc,Resolution:()=>Ja,Resource:()=>$n,ResourceEvents:()=>R_,RotateBy:()=>td,RotateByWithOptions:()=>Jc,RotateTo:()=>Kc,RotateToWithOptions:()=>$c,RotationType:()=>R,ScaleBy:()=>od,ScaleByWithOptions:()=>rd,ScaleTo:()=>sd,ScaleToWithOptions:()=>id,Scene:()=>di,SceneEvents:()=>Wp,Screen:()=>th,ScreenAppender:()=>Ji,ScreenElement:()=>ph,ScreenEvents:()=>mp,ScreenShader:()=>Wd,ScrollPreventionMode:()=>Is,Semaphore:()=>xg,SeparatingAxis:()=>de,SeparationInfo:()=>Oc,Shader:()=>Ke,Shape:()=>He,Side:()=>St,Slide:()=>gg,SolverStrategy:()=>ar,Sound:()=>Uc,SoundEvents:()=>xp,SparseHashGrid:()=>yh,SparseHashGridCollisionProcessor:()=>Th,SpatialPartitionStrategy:()=>Tn,Sprite:()=>xi,SpriteFont:()=>$r,SpriteSheet:()=>Os,StandardClock:()=>Mh,StateMachine:()=>po,StrategyContainer:()=>bd,Stream:()=>iu,System:()=>ci,SystemManager:()=>Md,SystemPriority:()=>Oi,SystemType:()=>oi,TagQuery:()=>fr,TestClock:()=>Zd,Text:()=>er,TextAlign:()=>eo,TextureLoader:()=>Jt,Tile:()=>xd,TileMap:()=>wd,TileMapEvents:()=>Bp,TiledAnimation:()=>Hh,TiledSprite:()=>Kn,Timer:()=>Zs,Toaster:()=>Qd,Transform:()=>is,TransformComponent:()=>et,Transition:()=>Ro,TreeNode:()=>nh,Trigger:()=>Ed,TriggerEvents:()=>Lp,TwoPI:()=>W,Util:()=>v,Vector:()=>B,VectorView:()=>Aa,VertexBuffer:()=>Li,VertexLayout:()=>es,VerticalFirst:()=>oh,VisibleEvent:()=>Wa,WebAudio:()=>Vs,WebAudioInstance:()=>kc,WheelDeltaMode:()=>In,WheelEvent:()=>Od,World:()=>Fd,approximatelyEqual:()=>X,assert:()=>jp,canonicalizeAngle:()=>nt,clamp:()=>j,coroutine:()=>ou,createId:()=>P,frac:()=>U,getDefaultPhysicsConfig:()=>os,hasGraphicsTick:()=>Ta,hasOnAdd:()=>og,hasOnInitialize:()=>eg,hasOnPostUpdate:()=>rg,hasOnPreUpdate:()=>sg,hasOnRemove:()=>ag,hasPostDraw:()=>lg,hasPreDraw:()=>hg,has_add:()=>Jp,has_initialize:()=>Kp,has_postupdate:()=>ng,has_preupdate:()=>ig,has_remove:()=>tg,inverseLerp:()=>Xc,inverseLerpVector:()=>qc,isActor:()=>Dp,isAddedComponent:()=>hp,isComponentCtor:()=>Fc,isLoaderConstructor:()=>sh,isMoveByOptions:()=>Yc,isMoveToOptions:()=>Zc,isRemovedComponent:()=>cp,isRotateByOptions:()=>Rp,isRotateToOptions:()=>Ip,isScaleByOptions:()=>nd,isScaleToOptions:()=>ed,isSceneConstructor:()=>Ni,isScreenElement:()=>md,isSystemConstructor:()=>Dd,lerp:()=>Vc,lerpAngle:()=>ch,lerpVector:()=>lr,maxMessages:()=>au,nextActionId:()=>Bt,obsolete:()=>vg,parseImageFiltering:()=>wn,parseImageWrapping:()=>bi,pixelSnapEpsilon:()=>_t,randomInRange:()=>At,randomIntInRange:()=>Et,range:()=>gt,remap:()=>Hi,remapVector:()=>Ep,resetObsoleteCounter:()=>mg,sign:()=>V,toDegrees:()=>ht,toRadians:()=>wt,vec:()=>z,webgl:()=>c});var c={};o.r(c),o.d(c,{getAttributeComponentSize:()=>Ic,getAttributePointerType:()=>Rc,getGLTypeFromSource:()=>Ec,getGlTypeSizeBytes:()=>ba,getMaxShaderComplexity:()=>ya,isAttributeInSource:()=>Sc});var _={};o.r(_),o.d(_,{circle:()=>op,line:()=>Ca,point:()=>np,roundRect:()=>Pa,vector:()=>rp});var g={};o.r(g),o.d(g,{ActionCompleteEvent:()=>Qa,ActionStartEvent:()=>Za,ActivateEvent:()=>Ga,AddEvent:()=>$a,CollisionEndEvent:()=>sr,CollisionPostSolveEvent:()=>co,CollisionPreSolveEvent:()=>lo,CollisionStartEvent:()=>ir,ContactEndEvent:()=>ho,ContactStartEvent:()=>ao,DeactivateEvent:()=>Va,EnterTriggerEvent:()=>Ya,EnterViewPortEvent:()=>qa,EventTypes:()=>ro,ExitTriggerEvent:()=>ja,ExitViewPortEvent:()=>Xa,GameEvent:()=>mt,GameStartEvent:()=>Ia,GameStopEvent:()=>Ra,GamepadAxisEvent:()=>Oa,GamepadButtonEvent:()=>Ha,GamepadConnectEvent:()=>Ua,GamepadDisconnectEvent:()=>za,HiddenEvent:()=>Na,InitializeEvent:()=>Pn,KillEvent:()=>oo,PostCollisionEvent:()=>Gs,PostDebugDrawEvent:()=>Ba,PostDrawEvent:()=>Cn,PostFrameEvent:()=>La,PostKillEvent:()=>Ea,PostTransformDrawEvent:()=>Ma,PostUpdateEvent:()=>Ps,PreCollisionEvent:()=>Ns,PreDebugDrawEvent:()=>Fa,PreDrawEvent:()=>An,PreFrameEvent:()=>ka,PreKillEvent:()=>Sa,PreTransformDrawEvent:()=>Da,PreUpdateEvent:()=>Cs,RemoveEvent:()=>Ka,VisibleEvent:()=>Wa});var v={};o.r(v),o.d(v,{ConsoleAppender:()=>vi,DrawUtil:()=>_,EasingFunctions:()=>Ot,LogLevel:()=>Ht,Logger:()=>ot,Observable:()=>Ve,ScreenAppender:()=>Ji,addItemToArray:()=>qr,contains:()=>Yr,delay:()=>jr,fail:()=>Ac,getPosition:()=>ys,isObject:()=>Zr,mergeDeep:()=>Qr,omit:()=>Cc,removeItemFromArray:()=>ts});function x(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(u){window.setInterval(u,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const e=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(s){return new Promise((r,a)=>{e.call(this,s,r,a)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(u){const e=Date.now();return setTimeout(function(){u({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-e))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(u){clearTimeout(u)})}class b{static useCanvasGraphicsContext(){b.enable("use-canvas-context")}static useLegacyImageRenderer(){b.enable("use-legacy-image-renderer")}static freeze(){b._FROZEN=!0}static _reset(){b._FROZEN=!1,b._FLAGS={}}static enable(e){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");b._FLAGS[e]=!0}static disable(e){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");b._FLAGS[e]=!1}static isEnabled(e){return!!b._FLAGS[e]}static show(){return Object.keys(b._FLAGS)}}b._FROZEN=!1,b._FLAGS={};function P(u,e){return{type:u,value:e}}class T{constructor(){this._isCompleted=!1,this.promise=new Promise((e,s)=>{this._resolver=e,this._rejecter=s})}get isCompleted(){return this._isCompleted}resolve(e){this._isCompleted||(this._isCompleted=!0,this._resolver(e))}reject(e){this._isCompleted||(this._isCompleted=!0,this._rejecter(e))}}class I{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(e,s){var r;return this._empty=!1,this._listeners[e]=(r=this._listeners[e])!==null&&r!==void 0?r:[],this._listeners[e].push(s),{close:()=>this.off(e,s)}}once(e,s){var r;return this._empty=!1,this._listenersOnce[e]=(r=this._listenersOnce[e])!==null&&r!==void 0?r:[],this._listenersOnce[e].push(s),{close:()=>this.off(e,s)}}off(e,s){var r,a;if(s){const l=(r=this._listeners[e])===null||r===void 0?void 0:r.filter(p=>p!==s);this._listeners[e]=l;const f=(a=this._listenersOnce[e])===null||a===void 0?void 0:a.filter(p=>p!==s);this._listenersOnce[e]=f}else delete this._listeners[e]}emit(e,s){if(this._empty||this._paused)return;const r=this._listeners[e];if(r)for(let l=0;l<r.length;l++)r[l](s);const a=this._listenersOnce[e];if(this._listenersOnce[e]=[],a)for(let l=0;l<a.length;l++)a[l](s);for(let l=0;l<this._pipes.length;l++)this._pipes[l].emit(e,s)}pipe(e){if(this===e)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(e),{close:()=>{const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}}}unpipe(e){const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var F;(function(u){u.Canvas="Canvas",u.Document="Document"})(F||(F={}));var R;(function(u){u.ShortestPath="shortest-path",u.LongestPath="longest-path",u.Clockwise="clockwise",u.CounterClockwise="counter-clockwise"})(R||(R={}));const S=4294967295;class M{constructor(e){this.seed=e,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(e||Date.now())>>>0;for(let s=1;s<this._n;s++){const r=this._mt[s-1]^this._mt[s-1]>>>this._w-2;this._mt[s]=(this._f*((r&4294901760)>>>16)<<16)+this._f*(r&65535)+s>>>0}this._index=this._n}_twist(){const e=[0,this._a];let s=0,r=0;for(;r<this._n-this._m;r++)s=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+this._m]^s>>>1^e[s&1]&S;for(;r<this._n-1;r++)s=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+(this._m-this._n)]^s>>>1^e[s&1]&S;s=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^s>>>1^e[s&1]&S,this._index=0}nextInt(){this._index>=this._n&&this._twist();let e=this._mt[this._index++];return e^=e>>>this._u,e^=e<<this._s&this._b,e^=e<<this._t&this._c,e^=e>>>this._l,e>>>0}next(){return this.nextInt()*(1/4294967296)}floating(e,s){return(s-e)*this.next()+e}integer(e,s){return Math.floor((s-e+1)*this.next()+e)}bool(e=.5){return this.next()<=e}pickOne(e){return e[this.integer(0,e.length-1)]}pickSet(e,s,r=!1){return r?this._pickSetWithDuplicates(e,s):this._pickSetWithoutDuplicates(e,s)}_pickSetWithoutDuplicates(e,s){if(s>e.length||s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(s===e.length)return e;const r=new Array(s);let a=0;const l=e.slice(0);for(;a<s;){const f=this.integer(0,l.length-1);r[a++]=l[f],l.splice(f,1)}return r}_pickSetWithDuplicates(e,s){if(s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const r=new Array(s);for(let a=0;a<s;a++)r[a]=this.pickOne(e);return r}shuffle(e){const s=e.slice(0);let r;for(let a=0;a<s.length-2;a++){const l=this.integer(a,s.length-1);r=s[a],s[a]=s[l],s[l]=r}return s}range(e,s,r){const a=new Array(e);for(let l=0;l<e;l++)a[l]=this.integer(s,r);return a}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const W=Math.PI*2;function U(u){return u>=0?u-Math.floor(u):u-Math.ceil(u)}function V(u){return u===0?0:u<0?-1:1}function j(u,e,s){return Math.min(Math.max(e,u),s)}function X(u,e,s){return Math.abs(u-e)<s}function nt(u){let e=u;if(u>=W)for(;e>=W;)e-=W;if(u<0)for(;e<0;)e+=W;return e}function ht(u){return 180/Math.PI*u}function wt(u){return u/180*Math.PI}const gt=(u,e)=>Array.from(new Array(e-u+1),(s,r)=>r+u);function At(u,e,s=new M){return s?s.floating(u,e):u+Math.random()*(e-u)}function Et(u,e,s=new M){return s?s.integer(u,e):Math.round(At(u,e))}class B{static get Zero(){return new B(0,0)}static get One(){return new B(1,1)}static get Half(){return new B(.5,.5)}static get Up(){return new B(0,-1)}static get Down(){return new B(0,1)}static get Left(){return new B(-1,0)}static get Right(){return new B(1,0)}static fromAngle(e){return new B(Math.cos(e),Math.sin(e))}static isValid(e){return!(e==null||isNaN(e.x)||isNaN(e.y)||e.x===1/0||e.y===1/0||e.x===-1/0||e.y===-1/0)}static distance(e,s){return Math.sqrt(Math.pow(e.x-s.x,2)+Math.pow(e.y-s.y,2))}static min(e,s){return new B(Math.min(e.x,s.x),Math.min(e.y,s.y))}static max(e,s){return new B(Math.max(e.x,s.x),Math.max(e.y,s.y))}constructor(e,s){this._x=0,this._y=0,this._x=e,this._y=s}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}setTo(e,s){this.x=e,this.y=s}equals(e,s=B.EQUALS_EPSILON){return Math.abs(this.x-e.x)<=s&&Math.abs(this.y-e.y)<=s}distance(e){if(!e)return Math.sqrt(this.x*this.x+this.y*this.y);const s=this.x-e.x,r=this.y-e.y;return Math.sqrt(s*s+r*r)}squareDistance(e){e||(e=B.Zero);const s=this.x-e.x,r=this.y-e.y;return s*s+r*r}clampMagnitude(e){const s=this.magnitude,r=j(s,0,e);return this.magnitude=r,this}get size(){return this.distance()}set size(e){const s=this.normalize().scale(e);this.setTo(s.x,s.y)}get magnitude(){return this.distance()}set magnitude(e){this.normalize().scale(e,this)}normalize(){const e=this.distance();return e===0?B.Zero:new B(this.x/e,this.y/e)}average(e){return this.add(e).scale(.5)}scale(e,s){const r=s||new B(0,0);return e instanceof B?(r.x=this.x*e.x,r.y=this.y*e.y):(r.x=this.x*e,r.y=this.y*e),r}add(e,s){return s?(s.x=this.x+e.x,s.y=this.y+e.y,s):new B(this.x+e.x,this.y+e.y)}sub(e,s){const r=s||new B(0,0),a=this.x-e.x,l=this.y-e.y;return r.x=a,r.y=l,r}addEqual(e){return this.setTo(this.x+e.x,this.y+e.y),this}subEqual(e){return this.setTo(this.x-e.x,this.y-e.y),this}scaleEqual(e){return this.setTo(this.x*e,this.y*e),this}dot(e){return this.x*e.x+this.y*e.y}cross(e){if(e instanceof B)return this.x*e.y-this.y*e.x;if(typeof e=="number")return new B(e*this.y,-e*this.x)}static cross(e,s){return new B(-e*s.y,e*s.x)}perpendicular(){return new B(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return nt(Math.atan2(this.y,this.x))}angleBetween(e,s){const r=this.toAngle(),a=nt(e);let l=0,f=0;switch(a>r?l=a-r:l=(W-r+a)%W,f=(l-W)%W,s){case R.ShortestPath:return Math.abs(l)<Math.abs(f)?l:f;case R.LongestPath:return Math.abs(l)>Math.abs(f)?l:f;case R.Clockwise:return l;case R.CounterClockwise:return f}}rotate(e,s,r){const a=r||new B(0,0);s||(s=new B(0,0));const l=Math.sin(e),f=Math.cos(e),p=f*(this.x-s.x)-l*(this.y-s.y)+s.x,m=l*(this.x-s.x)+f*(this.y-s.y)+s.y;return a.x=p,a.y=m,a}clone(e){const s=e??new B(0,0);return s.x=this.x,s.y=this.y,s}toString(e){return e?`(${this.x.toFixed(e)}, ${this.y.toFixed(e)})`:`(${this.x}, ${this.y})`}}B.EQUALS_EPSILON=.001;function z(u,e){return new B(u,e)}class Q{constructor(e,s,r,a){this.r=e,this.g=s,this.b=r,this.a=a??1}static fromRGB(e,s,r,a){return new Q(e,s,r,a)}static fromRGBString(e){const s=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let r=null;if(r=e.match(s)){const a=parseInt(r[1],10),l=parseInt(r[2],10),f=parseInt(r[3],10);let p=1;return r[4]&&(p=parseFloat(r[4])),new Q(a,l,f,p)}else throw new Error("Invalid rgb/a string: "+e)}static fromHex(e){const s=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let r=null;if(r=e.match(s)){const a=parseInt(r[1],16),l=parseInt(r[2],16),f=parseInt(r[3],16);let p=1;return r[4]&&(p=parseInt(r[4],16)/255),new Q(a,l,f,p)}else throw new Error("Invalid hex string: "+e)}static fromHSL(e,s,r,a=1){return new tt(e,s,r,a).toRGBA()}lighten(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.l+=(1-s.l)*e,s.toRGBA()}darken(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.l-=s.l*e,s.toRGBA()}saturate(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.s+=s.s*e,s.toRGBA()}desaturate(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.s-=s.s*e,s.toRGBA()}multiply(e){const s=e.r/255*this.r/255*255,r=e.g/255*this.g/255*255,a=e.b/255*this.b/255*255,l=e.a*this.a;return new Q(s,r,a,l)}screen(e){const s=e.invert(),r=e.invert();return s.multiply(r).invert()}invert(){return new Q(255-this.r,255-this.g,255-this.b,1-this.a)}average(e){const s=(e.r+this.r)/2,r=(e.g+this.g)/2,a=(e.b+this.b)/2,l=(e.a+this.a)/2;return new Q(s,r,a,l)}equal(e){return this.toString()===e.toString()}toString(e="rgb"){switch(e){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(e){const s=Math.max(Math.round(e),0).toString(16);return s.length===1?"0"+s:s}toHex(){let e="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(e+=this._componentToHex(this.a*255)),e}toRGBA(){const e=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+e+", "+String(this.a)+")":"rgb("+e+")"}toHSLA(){return tt.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(e){const s=e||new Q(this.r,this.g,this.b,this.a);return s.r=this.r,s.g=this.g,s.b=this.b,s.a=this.a,s}static get Black(){return Q.fromHex("#000000")}static get White(){return Q.fromHex("#FFFFFF")}static get Gray(){return Q.fromHex("#808080")}static get LightGray(){return Q.fromHex("#D3D3D3")}static get DarkGray(){return Q.fromHex("#A9A9A9")}static get Yellow(){return Q.fromHex("#FFFF00")}static get Orange(){return Q.fromHex("#FFA500")}static get Red(){return Q.fromHex("#FF0000")}static get Vermilion(){return Q.fromHex("#FF5B31")}static get Rose(){return Q.fromHex("#FF007F")}static get Pink(){return Q.fromHex("#FFC0CB")}static get Magenta(){return Q.fromHex("#FF00FF")}static get Violet(){return Q.fromHex("#7F00FF")}static get Purple(){return Q.fromHex("#800080")}static get Blue(){return Q.fromHex("#0000FF")}static get Azure(){return Q.fromHex("#007FFF")}static get Cyan(){return Q.fromHex("#00FFFF")}static get Viridian(){return Q.fromHex("#59978F")}static get Teal(){return Q.fromHex("#008080")}static get Green(){return Q.fromHex("#00FF00")}static get Chartreuse(){return Q.fromHex("#7FFF00")}static get Transparent(){return Q.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return Q.fromHex("#176BAA")}static get Brown(){return Q.fromHex("#964B00")}}class tt{constructor(e,s,r,a){this.h=e,this.s=s,this.l=r,this.a=a}static hue2rgb(e,s,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+(s-e)*6*r:r<1/2?s:r<2/3?e+(s-e)*(2/3-r)*6:e}static fromRGBA(e,s,r,a){e/=255,s/=255,r/=255;const l=Math.max(e,s,r),f=Math.min(e,s,r);let p,m;const w=(l+f)/2;if(l===f)p=m=0;else{const y=l-f;switch(m=w>.5?y/(2-l-f):y/(l+f),l){case e:p=(s-r)/y+(s<r?6:0);break;case s:p=(r-e)/y+2;break;case r:p=(e-s)/y+4;break}p/=6}return new tt(p,m,w,a)}toRGBA(){let e,s,r;if(this.s===0)e=s=r=this.l;else{const a=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,l=2*this.l-a;e=tt.hue2rgb(l,a,this.h+1/3),s=tt.hue2rgb(l,a,this.h),r=tt.hue2rgb(l,a,this.h-1/3)}return new Q(e*255,s*255,r*255,this.a)}toString(){const e=this.h.toFixed(0),s=this.s.toFixed(0),r=this.l.toFixed(0),a=this.a.toFixed(0);return`hsla(${e}, ${s}, ${r}, ${a})`}}var Ht;(function(u){u[u.Debug=0]="Debug",u[u.Info=1]="Info",u[u.Warn=2]="Warn",u[u.Error=3]="Error",u[u.Fatal=4]="Fatal"})(Ht||(Ht={}));class ot{constructor(){if(this._appenders=[],this.defaultLevel=Ht.Info,this._logOnceSet=new Set,ot._INSTANCE)throw new Error("Logger is a singleton");return ot._INSTANCE=this,ot._INSTANCE.addAppender(new vi),ot._INSTANCE}static getInstance(){return ot._INSTANCE==null&&(ot._INSTANCE=new ot),ot._INSTANCE}addAppender(e){this._appenders.push(e)}clearAppenders(){this._appenders.length=0}_log(e,s){e==null&&(e=this.defaultLevel);const r=this._appenders.length;for(let a=0;a<r;a++)e>=this.defaultLevel&&this._appenders[a].log(e,s)}_logOnce(e,s){const r=e+s.join("+");this._logOnceSet.has(r)||(this._logOnceSet.add(r),this._log(e,s))}debug(...e){this._log(Ht.Debug,e)}debugOnce(...e){this._logOnce(Ht.Debug,e)}info(...e){this._log(Ht.Info,e)}infoOnce(...e){this._logOnce(Ht.Info,e)}warn(...e){this._log(Ht.Warn,e)}warnOnce(...e){this._logOnce(Ht.Warn,e)}error(...e){this._log(Ht.Error,e)}errorOnce(...e){this._logOnce(Ht.Error,e)}fatal(...e){this._log(Ht.Fatal,e)}fatalOnce(...e){this._logOnce(Ht.Fatal,e)}}ot._INSTANCE=null;class vi{log(e,s){if(!console&&!console.log&&console.warn&&console.error)return;const r=[];r.unshift.apply(r,s),r.unshift("["+Ht[e]+"] : "),e<Ht.Warn?console.log.apply?console.log.apply(console,r):console.log(r.join(" ")):e<Ht.Error?console.warn.apply?console.warn.apply(console,r):console.warn(r.join(" ")):console.error.apply?console.error.apply(console,r):console.error(r.join(" "))}}class Ji{constructor(e){var s,r;this._messages=[],this._pos=10,this._color=Q.Black,this._options=e,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(r=(s=e.zIndex)===null||s===void 0?void 0:s.toString())!==null&&r!==void 0?r:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),e.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var e,s,r,a;const l=this._options;this.canvas.width=(e=l.width)!==null&&e!==void 0?e:l.engine.screen.resolution.width,this.canvas.height=(s=l.height)!==null&&s!==void 0?s:l.engine.screen.resolution.height,this.canvas.style.position="absolute";const f=l.engine.screen.screenToPageCoordinates(z(0,0));this.canvas.style.left=f.x+"px",this.canvas.style.top=f.y+"px",this._pos=(r=l.xPos)!==null&&r!==void 0?r:this._pos,this._color=(a=l.color)!==null&&a!==void 0?a:this._color}log(e,s){const r=s.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+Ht[e]+"] : "+r);let a=10;this._messages=this._messages.slice(0,1e3);for(let l=0;l<this._messages.length;l++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[l],this._pos,a),a+=10}}var St;(function(u){u.None="None",u.Top="Top",u.Bottom="Bottom",u.Left="Left",u.Right="Right"})(St||(St={})),function(u){function e(r){return r===u.Top?u.Bottom:r===u.Bottom?u.Top:r===u.Left?u.Right:r===u.Right?u.Left:u.None}u.getOpposite=e;function s(r){return Math.abs(r.x)>=Math.abs(r.y)?r.x<=0?u.Left:u.Right:r.y<=0?u.Top:u.Bottom}u.fromDirection=s}(St||(St={}));class at{constructor(e=0,s=0,r=0,a=0){this._points=[],typeof e=="object"?(this.left=e.left,this.top=e.top,this.right=e.right,this.bottom=e.bottom):typeof e=="number"&&(this.left=e,this.top=s,this.right=r,this.bottom=a)}clone(e){const s=e||new at(0,0,0,0);return s.left=this.left,s.right=this.right,s.top=this.top,s.bottom=this.bottom,s}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(e){return e&&e?Math.abs(e.x)>Math.abs(e.y)?e.x<0?St.Right:St.Left:e.y<0?St.Bottom:St.Top:St.None}static fromPoints(e){let s=1/0,r=1/0,a=-1/0,l=-1/0;for(let f=0;f<e.length;f++)e[f].x<s&&(s=e[f].x),e[f].x>a&&(a=e[f].x),e[f].y<r&&(r=e[f].y),e[f].y>l&&(l=e[f].y);return new at(s,r,a,l)}static fromDimension(e,s,r=B.Half,a=B.Zero){return new at(-e*r.x+a.x,-s*r.y+a.y,e-e*r.x+a.x,s-s*r.y+a.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new B((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new B(this.left,this.top)}get bottomRight(){return new B(this.right,this.bottom)}get topRight(){return new B(this.right,this.top)}get bottomLeft(){return new B(this.left,this.bottom)}translate(e){return new at(this.left+e.x,this.top+e.y,this.right+e.x,this.bottom+e.y)}rotate(e,s=B.Zero){const r=this.getPoints().map(a=>a.rotate(e,s));return at.fromPoints(r)}scale(e,s=B.Zero){const r=this.translate(s);return new at(r.left*e.x,r.top*e.y,r.right*e.x,r.bottom*e.y)}transform(e){const s=e.data[0]*this.left,r=e.data[1]*this.left,a=e.data[0]*this.right,l=e.data[1]*this.right,f=e.data[2]*this.top,p=e.data[3]*this.top,m=e.data[2]*this.bottom,w=e.data[3]*this.bottom,y=e.getPosition(),A=Math.min(s,a)+Math.min(f,m)+y.x,E=Math.min(r,l)+Math.min(p,w)+y.y,D=Math.max(s,a)+Math.max(f,m)+y.x,L=Math.max(r,l)+Math.max(p,w)+y.y;return new at({left:A,top:E,right:D,bottom:L})}getPerimeter(){const e=this.width,s=this.height;return 2*(e+s)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new B(this.left,this.top)),this._points.push(new B(this.right,this.top)),this._points.push(new B(this.right,this.bottom)),this._points.push(new B(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(e,s=1/0){let r=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,f=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,p=(this.left-e.pos.x)*l,m=(this.right-e.pos.x)*l;r=Math.min(p,m),a=Math.max(p,m);const w=(this.top-e.pos.y)*f,y=(this.bottom-e.pos.y)*f;return r=Math.max(r,Math.min(w,y)),a=Math.min(a,Math.max(w,y)),a>=Math.max(0,r)&&r<s}rayCastTime(e,s=1/0){let r=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,f=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,p=(this.left-e.pos.x)*l,m=(this.right-e.pos.x)*l;r=Math.min(p,m),a=Math.max(p,m);const w=(this.top-e.pos.y)*f,y=(this.bottom-e.pos.y)*f;return r=Math.max(r,Math.min(w,y)),a=Math.min(a,Math.max(w,y)),a>=Math.max(0,r)&&r<s?r:-1}contains(e){return e instanceof B?this.left<=e.x&&this.top<=e.y&&e.y<=this.bottom&&e.x<=this.right:e instanceof at?this.left<=e.left&&this.top<=e.top&&e.bottom<=this.bottom&&e.right<=this.right:!1}combine(e,s){const r=s||new at(0,0,0,0),a=Math.min(this.left,e.left),l=Math.min(this.top,e.top),f=Math.max(this.right,e.right),p=Math.max(this.bottom,e.bottom);return r.left=a,r.top=l,r.right=f,r.bottom=p,r}get dimensions(){return new B(this.width,this.height)}overlaps(e,s){const r=s||0;if(e.hasZeroDimensions())return this.contains(e);if(this.hasZeroDimensions())return e.contains(this);const a=this.combine(e);return a.width+r<e.width+this.width&&a.height+r<e.height+this.height}intersect(e){const s=this.combine(e);if(s.width<e.width+this.width&&s.height<e.height+this.height&&!s.dimensions.equals(e.dimensions)&&!s.dimensions.equals(this.dimensions)){let r=0;this.right>=e.left&&this.right<=e.right?r=e.left-this.right:r=e.right-this.left;let a=0;return this.top<=e.bottom&&this.top>=e.top?a=e.bottom-this.top:a=e.top-this.bottom,Math.abs(r)<Math.abs(a)?new B(r,0):new B(0,a)}else if(s.dimensions.equals(e.dimensions)||s.dimensions.equals(this.dimensions)){let r=0;this.width-e.width>=0?this.right-e.right<=e.left-this.left?r=e.left-this.right:r=e.right-this.left:e.right-this.right<=this.left-e.left?r=this.left-e.right:r=this.right-e.left;let a=0;return this.height-e.height>=0?this.bottom-e.bottom<=e.top-this.top?a=e.top-this.bottom:a=e.bottom-this.top:e.bottom-this.bottom<=this.top-e.top?a=this.top-e.bottom:a=this.bottom-e.top,Math.abs(r)<Math.abs(a)?new B(r,0):new B(0,a)}else return null}intersectWithSide(e){const s=this.intersect(e);return at.getSideFromIntersection(s)}draw(e,s=Q.Yellow){e.debug.drawRect(this.left,this.top,this.width,this.height,{color:s})}}function ys(u){if(u&&u.getBoundingClientRect){const e=u.getBoundingClientRect();return z(e.x+window.scrollX,e.y+window.scrollY)}return B.Zero}function qr(u,e){return e.indexOf(u)===-1?(e.push(u),!0):!1}function ts(u,e){let s=-1;return(s=e.indexOf(u))>-1?(e.splice(s,1),!0):!1}function Yr(u,e){for(let s=0;s<u.length;s++)if(u[s]===e)return!0;return!1}function Ac(u){throw new Error(u)}function jr(u,e){var s;const r=new T;return((s=e?.schedule.bind(e))!==null&&s!==void 0?s:setTimeout)(()=>{r.resolve()},u),r.promise}function Cc(u,e){const s={};for(const r in u)e.includes(r)||(s[r]=u[r]);return s}function Zr(u){return u&&typeof u=="object"&&!Array.isArray(u)}function Qr(u,...e){if(!e.length)return u;const s=e.shift();if(Zr(u)&&Zr(s))for(const r in s)Zr(s[r])?(u[r]||Object.assign(u,{[r]:{}}),Qr(u[r],s[r])):Object.assign(u,{[r]:s[r]});return Qr(u,...e)}var wa;(function(u){u[u.X=12]="X",u[u.Y=13]="Y"})(wa||(wa={}));class ni{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(e,s,r,a,l,f){const p=new ni;return p.data[0]=2/(s-e),p.data[1]=0,p.data[2]=0,p.data[3]=0,p.data[4]=0,p.data[5]=2/(a-r),p.data[6]=0,p.data[7]=0,p.data[8]=0,p.data[9]=0,p.data[10]=-2/(f-l),p.data[11]=0,p.data[12]=-(s+e)/(s-e),p.data[13]=-(a+r)/(a-r),p.data[14]=-(f+l)/(f-l),p.data[15]=1,p}clone(e){const s=e||new ni;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s.data[6]=this.data[6],s.data[7]=this.data[7],s.data[8]=this.data[8],s.data[9]=this.data[9],s.data[10]=this.data[10],s.data[11]=this.data[11],s.data[12]=this.data[12],s.data[13]=this.data[13],s.data[14]=this.data[14],s.data[15]=this.data[15],s}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(e){const s=new ni;return s.data=e,s}static identity(){const e=new ni;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}static translation(e,s){const r=ni.identity();return r.data[12]=e,r.data[13]=s,r}static scale(e,s){const r=ni.identity();return r.data[0]=e,r.data[5]=s,r.data[10]=1,r.data[15]=1,r}static rotation(e){const s=ni.identity();return s.data[0]=Math.cos(e),s.data[4]=-Math.sin(e),s.data[1]=Math.sin(e),s.data[5]=Math.cos(e),s}multiply(e,s){if(e instanceof B){const r=s||new B(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[4]+this.data[12],f=a.x*this.data[1]+a.y*this.data[5]+this.data[13];return r.x=l,r.y=f,r}else{const r=s||new ni,a=e,l=this.data[0],f=this.data[1],p=this.data[2],m=this.data[3],w=this.data[4],y=this.data[5],A=this.data[6],E=this.data[7],D=this.data[8],L=this.data[9],O=this.data[10],q=this.data[11],H=this.data[12],N=this.data[13],$=this.data[14],Y=this.data[15],J=a.data[0],rt=a.data[1],Z=a.data[2],ft=a.data[3],Tt=a.data[4],Gt=a.data[5],qt=a.data[6],Ce=a.data[7],$t=a.data[8],kt=a.data[9],Oe=a.data[10],De=a.data[11],it=a.data[12],$s=a.data[13],Ks=a.data[14],Js=a.data[15];r.data[0]=l*J+w*rt+D*Z+H*ft,r.data[1]=f*J+y*rt+L*Z+N*ft,r.data[2]=p*J+A*rt+O*Z+$*ft,r.data[3]=m*J+E*rt+q*Z+Y*ft,r.data[4]=l*Tt+w*Gt+D*qt+H*Ce,r.data[5]=f*Tt+y*Gt+L*qt+N*Ce,r.data[6]=p*Tt+A*Gt+O*qt+$*Ce,r.data[7]=m*Tt+E*Gt+q*qt+Y*Ce,r.data[8]=l*$t+w*kt+D*Oe+H*De,r.data[9]=f*$t+y*kt+L*Oe+N*De,r.data[10]=p*$t+A*kt+O*Oe+$*De,r.data[11]=m*$t+E*kt+q*Oe+Y*De,r.data[12]=l*it+w*$s+D*Ks+H*Js,r.data[13]=f*it+y*$s+L*Ks+N*Js,r.data[14]=p*it+A*$s+O*Ks+$*Js,r.data[15]=m*it+E*$s+q*Ks+Y*Js;const Mn=this.getScale();return r._scaleSignX=V(Mn.x)*V(r._scaleSignX),r._scaleSignY=V(Mn.y)*V(r._scaleSignY),r}}translate(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],p=this.data[4],m=this.data[5],w=this.data[6],y=this.data[7],A=this.data[8],E=this.data[9],D=this.data[10],L=this.data[11],O=this.data[12],q=this.data[13],H=this.data[14],N=this.data[15],$=0,Y=1;return this.data[12]=r*e+p*s+A*$+O*Y,this.data[13]=a*e+m*s+E*$+q*Y,this.data[14]=l*e+w*s+D*$+H*Y,this.data[15]=f*e+y*s+L*$+N*Y,this}setPosition(e,s){this.data[12]=e,this.data[13]=s}getPosition(){return z(this.data[12],this.data[13])}rotate(e){const s=this.data[0],r=this.data[1],a=this.data[2],l=this.data[3],f=this.data[4],p=this.data[5],m=this.data[6],w=this.data[7],y=Math.sin(e),A=Math.cos(e);return this.data[0]=A*s+y*f,this.data[1]=A*r+y*p,this.data[2]=A*a+y*m,this.data[3]=A*l+y*w,this.data[4]=A*f-y*s,this.data[5]=A*p-y*r,this.data[6]=A*m-y*a,this.data[7]=A*w-y*l,this}scale(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],p=this.data[4],m=this.data[5],w=this.data[6],y=this.data[7];return this.data[0]=r*e,this.data[1]=a*e,this.data[2]=l*e,this.data[3]=f*e,this.data[4]=p*s,this.data[5]=m*s,this.data[6]=w*s,this.data[7]=y*s,this}setRotation(e){const s=this.getScale(),r=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=r*s.y,this.data[4]=-r*s.x,this.data[5]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return nt(e)}getScaleX(){const e=z(this.data[0],this.data[4]).magnitude;return this._scaleSignX*e}getScaleY(){const e=z(this.data[1],this.data[5]).magnitude;return this._scaleSignY*e}getScale(){return z(this.getScaleX(),this.getScaleY())}setScaleX(e){if(this._scaleX===e)return;this._scaleSignX=V(e);const s=z(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[4]=s.y*e,this._scaleX=e}setScaleY(e){if(this._scaleY===e)return;this._scaleSignY=V(e);const s=z(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[5]=s.y*e,this._scaleY=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(e){const r=1/this.getBasisDeterminant(),a=this.data[0],l=this.data[4],f=this.data[1],p=this.data[5],m=e||ni.identity();m.data[0]=p*r,m.data[1]=-f*r,m.data[4]=-l*r,m.data[5]=a*r;const w=this.data[12],y=this.data[13];return m.data[12]=-(w*m.data[0]+y*m.data[4]),m.data[13]=-(w*m.data[1]+y*m.data[5]),m}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class le{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const e=new le;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}static translation(e,s){const r=le.identity();return r.data[4]=e,r.data[5]=s,r}static scale(e,s){const r=le.identity();return r.data[0]=e,r.data[3]=s,r._scale[0]=e,r._scale[1]=s,r}static rotation(e){const s=le.identity();return s.data[0]=Math.cos(e),s.data[1]=Math.sin(e),s.data[2]=-Math.sin(e),s.data[3]=Math.cos(e),s}setPosition(e,s){this.data[4]=e,this.data[5]=s}getPosition(){return z(this.data[4],this.data[5])}rotate(e){const s=this.data[0],r=this.data[1],a=this.data[2],l=this.data[3],f=Math.sin(e),p=Math.cos(e);return this.data[0]=p*s+f*a,this.data[1]=p*r+f*l,this.data[2]=p*a-f*s,this.data[3]=p*l-f*r,this}translate(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],p=this.data[4],m=this.data[5];return this.data[4]=r*e+l*s+p,this.data[5]=a*e+f*s+m,this}scale(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3];return this.data[0]=r*e,this.data[1]=a*e,this.data[2]=l*s,this.data[3]=f*s,this._scale[0]=e,this._scale[1]=s,this._scaleSignX=V(e),this._scaleSignY=V(s),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(e){const s=this.determinant();let r=s;s!==0&&(r=1/s);const a=this.data[0],l=this.data[2],f=this.data[1],p=this.data[3],m=e||le.identity();m.data[0]=p*r,m.data[1]=-f*r,m.data[2]=-l*r,m.data[3]=a*r;const w=this.data[4],y=this.data[5];return m.data[4]=-(w*m.data[0]+y*m.data[2]),m.data[5]=-(w*m.data[1]+y*m.data[3]),m}multiply(e,s){if(e instanceof B){const r=s||new B(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[2]+this.data[4],f=a.x*this.data[1]+a.y*this.data[3]+this.data[5];return r.x=l,r.y=f,r}else{const r=s||new le,a=e,l=this.data[0],f=this.data[1],p=this.data[2],m=this.data[3],w=this.data[4],y=this.data[5],A=a.data[0],E=a.data[1],D=a.data[2],L=a.data[3],O=a.data[4],q=a.data[5];r.data[0]=l*A+p*E,r.data[1]=f*A+m*E,r.data[2]=l*D+p*L,r.data[3]=f*D+m*L,r.data[4]=l*O+p*q+w,r.data[5]=f*O+m*q+y;const H=this._scaleSignX,N=this._scaleSignY;return r._scaleSignX=H*V(r._scaleSignX),r._scaleSignY=N*V(r._scaleSignY),r}}multiplyQuadInPlace(e){const s=e[0]*this.data[0]+e[1]*this.data[2]+this.data[4],r=e[0]*this.data[1]+e[1]*this.data[3]+this.data[5];e[0]=s,e[1]=r;const a=e[2]*this.data[0]+e[3]*this.data[2]+this.data[4],l=e[2]*this.data[1]+e[3]*this.data[3]+this.data[5];e[2]=a,e[3]=l;const f=e[4]*this.data[0]+e[5]*this.data[2]+this.data[4],p=e[4]*this.data[1]+e[5]*this.data[3]+this.data[5];e[4]=f,e[5]=p;const m=e[6]*this.data[0]+e[7]*this.data[2]+this.data[4],w=e[6]*this.data[1]+e[7]*this.data[3]+this.data[5];e[6]=m,e[7]=w}to4x4(){const e=new ni;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=0,e.data[3]=0,e.data[4]=this.data[2],e.data[5]=this.data[3],e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=this.data[4],e.data[13]=this.data[5],e.data[14]=0,e.data[15]=1,e}setRotation(e){const s=this.getScale(),r=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=r*s.y,this.data[2]=-r*s.x,this.data[3]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return nt(e)}getScaleX(){const e=this.data[0]*this.data[0]+this.data[2]*this.data[2];return e===1?this._scaleSignX:this._scaleSignX*Math.sqrt(e)}getScaleY(){const e=this.data[1]*this.data[1]+this.data[3]*this.data[3];return e===1?this._scaleSignY:this._scaleSignY*Math.sqrt(e)}getScale(){return z(this.getScaleX(),this.getScaleY())}setScaleX(e){if(e===this._scale[0])return;this._scaleSignX=V(e);const s=z(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[2]=s.y*e,this._scale[0]=e}setScaleY(e){if(e===this._scale[1])return;this._scaleSignY=V(e);const s=z(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[3]=s.y*e,this._scale[1]=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}clone(e){const s=e||new le;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s._scaleSignX=this._scaleSignX,s._scaleSignY=this._scaleSignY,s}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}class Qn{constructor(e,s,r=1){this.builder=e,this.cleaner=s,this._pool=[],this._size=0,this.grow(r)}grow(e){if(e>0){this._size+=e;for(let s=0;s<e;s++)this._pool.push(this.builder())}}rent(e=!1){return this._pool.length===0&&this.grow(this._size),e?this.cleaner(this._pool.pop()):this._pool.pop()}return(e){this._pool.push(e)}}class E_{constructor(){this._pool=new Qn(()=>le.identity(),e=>e.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(e,s){return this._currentTransform.translate(e,s)}rotate(e){return this._currentTransform.rotate(e)}scale(e,s){return this._currentTransform.scale(e,s)}reset(){this._currentTransform.reset()}set current(e){this._currentTransform=e}get current(){return this._currentTransform}}class I_{constructor(){this.opacity=1,this.z=0,this.tint=Q.White,this.material=null}}class Pc{constructor(){this._pool=new Qn(()=>new I_,e=>(e.opacity=1,e.z=0,e.tint=Q.White,e.material=null,e),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(e){var s;return e.opacity=this.current.opacity,e.z=this.current.z,e.tint=(s=this.current.tint)===null||s===void 0?void 0:s.clone(),e.material=this.current.material,e}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const R_={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class $n{constructor(e,s,r=!1){this.path=e,this.responseType=s,this.bustCache=r,this.data=null,this.logger=ot.getInstance(),this.events=new I}isLoaded(){return this.data!==null}_cacheBust(e){return/\?\w*=\w*/.test(e)?e+="&__="+Date.now():e+="?__="+Date.now(),e}load(){return new Promise((e,s)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),e(this.data);return}const r=new XMLHttpRequest;r.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),r.responseType=this.responseType,r.addEventListener("loadstart",a=>this.events.emit("loadstart",a)),r.addEventListener("progress",a=>this.events.emit("progress",a)),r.addEventListener("error",a=>this.events.emit("error",a)),r.addEventListener("load",a=>this.events.emit("load",a)),r.addEventListener("load",()=>{if(r.status!==0&&r.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",r.status),this.events.emit("error",r.response),s(new Error(r.statusText));return}if(r.response instanceof Blob&&r.response.type==="text/html"){const a=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",r.response),s(new Error(a));return}this.data=r.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),e(this.data)}),r.send()})}}function wi(u,e){return u&&(u.__isProxy===void 0?new Proxy(u,{set:(s,r,a)=>(s[r]!==a&&(s[r]=a,typeof r=="string"&&r[0]!=="_"&&e(s)),!0),get:(s,r)=>r!=="__isProxy"?s[r]:!0}):u)}const Tc=(u=[],e,s)=>({get:(r,a)=>a==="__isProxy"?!0:typeof r[a]=="object"&&r[a]!=null?new Proxy(r[a],Tc([...u,a],e,s)):r[a],set:(r,a,l)=>(typeof a=="string"&&a[0]!=="_"&&e(s),r[a]=l,!0)});function D_(u,e){return u&&(u.__isProxy===void 0?new Proxy(u,Tc([],e,u)):u)}class Kt{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(e){this._flipHorizontal=e,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(e){this._flipVertical=e,this._transformStale=!0}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._transformStale=!0}get scale(){return this._scale}set scale(e){this._scale=wi(e,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(e){e&&(this._origin=wi(e,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(e){var s,r,a,l,f,p,m;this.id=Kt._ID++,this.transform=le.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=B.One,this._width=0,this._height=0,e&&(this.origin=(s=e.origin)!==null&&s!==void 0?s:this.origin,this.flipHorizontal=(r=e.flipHorizontal)!==null&&r!==void 0?r:this.flipHorizontal,this.flipVertical=(a=e.flipVertical)!==null&&a!==void 0?a:this.flipVertical,this.rotation=(l=e.rotation)!==null&&l!==void 0?l:this.rotation,this.opacity=(f=e.opacity)!==null&&f!==void 0?f:this.opacity,this.scale=(p=e.scale)!==null&&p!==void 0?p:this.scale,this.tint=(m=e.tint)!==null&&m!==void 0?m:this.tint,e.width&&(this._width=e.width),e.height&&(this._height=e.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(e){this._width=e,this._transformStale=!0}set height(e){this._height=e,this._transformStale=!0}get localBounds(){return at.fromDimension(this.width,this.height,B.Zero)}draw(e,s,r){this._preDraw(e,s,r),this._drawImage(e,0,0),this._postDraw(e)}_preDraw(e,s,r){e.save(),e.translate(s,r),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),e.multiply(this.transform),e.opacity=e.opacity*this.opacity,this.tint&&(e.tint=this.tint)}_rotate(e){var s;const r=this.scale.x>0?1:-1,a=this.scale.y>0?1:-1,l=(s=this.origin)!==null&&s!==void 0?s:z(this.width/2,this.height/2);e.translate(l.x,l.y),e.rotate(this.rotation),e.scale(r,a),e.translate(-l.x,-l.y)}_flip(e){this.flipHorizontal&&(e.translate(this.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,this.height/this.scale.y),e.scale(1,-1))}_postDraw(e){this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore()}}Kt._ID=0;class xi extends Kt{static from(e,s){return new xi({image:e,...s})}constructor(e){var s,r;super(e),this._logger=ot.getInstance(),this._dirty=!0,this.image=e.image;const{width:a,height:l}=e;this.sourceView=(s=e.sourceView)!==null&&s!==void 0?s:{x:0,y:0,width:a??0,height:l??0},this.destSize=(r=e.destSize)!==null&&r!==void 0?r:{width:a??0,height:l??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(e){e/=Math.abs(this.scale.x),this.destSize.width=e,super.width=Math.ceil(this.destSize.width)}set height(e){e/=Math.abs(this.scale.y),this.destSize.height=e,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var e,s,r,a,l,f;const{width:p,height:m}=this.image;this.sourceView.width=((e=this.sourceView)===null||e===void 0?void 0:e.width)||p,this.sourceView.height=((s=this.sourceView)===null||s===void 0?void 0:s.height)||m,this.destSize.width=((r=this.destSize)===null||r===void 0?void 0:r.width)||((a=this.sourceView)===null||a===void 0?void 0:a.width)||p,this.destSize.height=((l=this.destSize)===null||l===void 0?void 0:l.height)||((f=this.sourceView)===null||f===void 0?void 0:f.height)||m,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(e,s,r){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(e,s,r)}_drawImage(e,s,r){this.image.isLoaded()?e.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,s,r,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new xi({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var ce;(function(u){u.Pixel="Pixel",u.Blended="Blended"})(ce||(ce={}));function wn(u){switch(u){case ce.Pixel:return ce.Pixel;case ce.Blended:return ce.Blended;default:return}}var Vt;(function(u){u.Clamp="Clamp",u.Repeat="Repeat",u.Mirror="Mirror"})(Vt||(Vt={}));function bi(u){switch(u){case Vt.Clamp:return Vt.Clamp;case Vt.Repeat:return Vt.Repeat;case Vt.Mirror:return Vt.Mirror;default:return Vt.Clamp}}class Jt{constructor(e,s){var r;this._garbageCollector=s,this._textureMap=new Map,this._collect=a=>{var l;if(this._gl){const f=(l=a.dataset.originalSrc)!==null&&l!==void 0?l:a.constructor.name;return Jt._LOGGER.debug(`WebGL Texture for ${f} collected`),this.delete(a),!0}return!1},this._gl=e,Jt._MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE),this._garbageCollector&&(Jt._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(r=this._garbageCollector.garbageCollector)===null||r===void 0||r.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[e]of this._textureMap)this.delete(e);this._textureMap.clear(),this._gl=null}get(e){return this._textureMap.get(e)}has(e){return this._textureMap.has(e)}load(e,s,r=!1){var a,l;const f=this._gl;if(!f)return null;const{filtering:p,wrapping:m}={...s};let w=null;if(this.has(e)&&(w=this.get(e)),w)return r&&(f.bindTexture(f.TEXTURE_2D,w),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,e)),(a=this._garbageCollector)===null||a===void 0||a.garbageCollector.touch(e),w;w=f.createTexture(),Jt.checkImageSizeSupportedAndLog(e),f.bindTexture(f.TEXTURE_2D,w),f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let y;m&&(typeof m=="string"?y={x:m,y:m}:y={x:m.x,y:m.y});const{x:A,y:E}=y??Jt.wrapping;switch(A){case Vt.Clamp:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);break;case Vt.Repeat:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT);break;case Vt.Mirror:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.MIRRORED_REPEAT);break;default:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE)}switch(E){case Vt.Clamp:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);break;case Vt.Repeat:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT);break;case Vt.Mirror:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.MIRRORED_REPEAT);break;default:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE)}const D=p??Jt.filtering;return f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,D===ce.Pixel?f.NEAREST:f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,D===ce.Pixel?f.NEAREST:f.LINEAR),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,e),this._textureMap.set(e,w),(l=this._garbageCollector)===null||l===void 0||l.garbageCollector.addCollectableResource("texture",e),w}delete(e){const s=this._gl;if(s&&this.has(e)){const r=this.get(e);r&&(this._textureMap.delete(e),s.deleteTexture(r))}}static checkImageSizeSupportedAndLog(e){var s;const r=(s=e.dataset.originalSrc)!==null&&s!==void 0?s:"internal canvas bitmap";return e.width>Jt._MAX_TEXTURE_SIZE||e.height>Jt._MAX_TEXTURE_SIZE?(Jt._LOGGER.error(`The image [${r}] provided to Excalibur is too large for the device's maximum texture size of (${Jt._MAX_TEXTURE_SIZE}x${Jt._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((e.width>4096||e.height>4096)&&Jt._LOGGER.warn(`The image [${r}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}Jt._LOGGER=ot.getInstance(),Jt.filtering=ce.Blended,Jt.wrapping={x:Vt.Clamp,y:Vt.Clamp},Jt._MAX_TEXTURE_SIZE=4096;const It={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class ki{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(e,s,r){this._logger=ot.getInstance(),this.data=new Image,this._readyFuture=new T,this.ready=this._readyFuture.promise,this.path=e;let a=!1,l;typeof s=="boolean"?a=s:{filtering:r,wrapping:l,bustCache:a}={...s},this._resource=new $n(e,"blob",a),this.filtering=r??this.filtering,typeof l=="string"?this.wrapping={x:l,y:l}:this.wrapping=l??this.wrapping,e.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${e} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(e,s){const r=new ki("");if(r._src="image-element",r.data=e,r.data.setAttribute("data-original-src","image-element"),s?.filtering?r.data.setAttribute(It.Filtering,s?.filtering):r.data.setAttribute(It.Filtering,ce.Blended),s?.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},r.data.setAttribute(It.WrappingX,a.x),r.data.setAttribute(It.WrappingY,a.y)}else r.data.setAttribute(It.WrappingX,Vt.Clamp),r.data.setAttribute(It.WrappingY,Vt.Clamp);return Jt.checkImageSizeSupportedAndLog(e),r._readyFuture.resolve(e),r}static fromHtmlCanvasElement(e,s){const r=new ki("");if(r._src="canvas-element-blob",r.data.setAttribute("data-original-src","canvas-element-blob"),s?.filtering?r.data.setAttribute(It.Filtering,s?.filtering):r.data.setAttribute(It.Filtering,ce.Blended),s?.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},r.data.setAttribute(It.WrappingX,a.x),r.data.setAttribute(It.WrappingY,a.y)}else r.data.setAttribute(It.WrappingX,Vt.Clamp),r.data.setAttribute(It.WrappingY,Vt.Clamp);return Jt.checkImageSizeSupportedAndLog(e),e.toBlob(a=>{const l=URL.createObjectURL(a);r.image.onload=()=>{URL.revokeObjectURL(l),r.data=r.image,r._readyFuture.resolve(r.image)},r.image.src=l}),r}static fromSvgString(e,s){const r=new Blob([e],{type:"image/svg+xml"}),a=URL.createObjectURL(r);return new ki(a,s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){var e,s,r,a;if(this.isLoaded())return this.data;try{let l;if(this.path.includes("data:image/"))l=this.path;else{const m=await this._resource.load();l=URL.createObjectURL(m)}const f=new Image,p=new T;f.onload=()=>p.resolve(),f.src=l,f.setAttribute("data-original-src",this.path),await p.promise,this.data=f,Jt.checkImageSizeSupportedAndLog(this.data)}catch(l){throw`Error loading ImageSource from path '${this.path}' with error [${l.message}]`}return this.data.setAttribute(It.Filtering,this.filtering),this.data.setAttribute(It.WrappingX,(s=(e=this.wrapping)===null||e===void 0?void 0:e.x)!==null&&s!==void 0?s:Vt.Clamp),this.data.setAttribute(It.WrappingY,(a=(r=this.wrapping)===null||r===void 0?void 0:r.y)!==null&&a!==void 0?a:Vt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(e){return xi.from(this,e)}unload(){this.data=new Image}}class $r extends Kt{constructor(e){super(e),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=ot.getInstance();const{alphabet:s,spriteSheet:r,caseInsensitive:a,spacing:l,shadow:f,lineHeight:p}=e;this.alphabet=s,this.spriteSheet=r,this.caseInsensitive=a??this.caseInsensitive,this.spacing=l??this.spacing,this.shadow=f??this.shadow,this.lineHeight=p??this.lineHeight}_getCharacterSprites(e){const s=[],r=this.caseInsensitive?e.toLocaleLowerCase():e,a=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let l=0;l<r.length;l++){const f=r[l];let p=a.indexOf(f);p===-1&&(p=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${f}' in configured alphabet '${a}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const m=this.spriteSheet.sprites[p];m?s.push(m):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${f}' at index '${p}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return s}measureText(e,s){const r=this._getLinesFromText(e,s),a=r.reduce((m,w)=>m.length>w.length?m:w),l=this._getCharacterSprites(a);let f=0,p=0;for(const m of l)f+=m.width+this.spacing,p=Math.max(p,m.height);return at.fromDimension(f*this.scale.x,p*r.length*this.scale.y,B.Zero)}_drawImage(e,s,r,a){var l;let f=0,p=0,m=0;const w=this._getLinesFromText(this._text,a);for(const y of w){for(const A of this._getCharacterSprites(y))A.draw(e,s+f,r+p),f+=A.width+this.spacing,m=Math.max(m,A.height);f=0,p+=(l=this.lineHeight)!==null&&l!==void 0?l:m}}render(e,s,r,a,l,f){this._text=s;const p=this.measureText(s,f);this.width=p.width,this.height=p.height,this.shadow&&(e.save(),e.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(e,a,l),this._drawImage(e,0,0,f),this._postDraw(e),e.restore()),this._preDraw(e,a,l),this._drawImage(e,0,0,f),this._postDraw(e)}clone(){return new $r({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(e,s){var r;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let f=a[l],p="";if(this.measureText(f).width>s){for(;this.measureText(f).width>s;)p=f[f.length-1]+p,f=f.slice(0,-1);a[l]=f,a[l+1]=p}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class Kn extends xi{constructor(e){super({image:e.image,sourceView:e.sourceView,destSize:{width:e.width,height:e.height},flipHorizontal:e.flipHorizontal,flipVertical:e.flipVertical,rotation:e.rotation,scale:e.scale,opacity:e.opacity,tint:e.tint,origin:e.origin}),this._ready=new T,this.ready=this._ready.promise,this._options=e,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(e,s){return new Kn({sourceView:{...e.sourceView},width:e.width,height:e.height,...s,image:e.image})}_applyTiling(){const{width:e,height:s,filtering:r,wrapping:a}={...this._options},l=document.createElement("canvas");l.width=this.sourceView.width,l.height=this.sourceView.height,l.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const p=ki.fromHtmlCanvasElement(l,{wrapping:a??Vt.Repeat,filtering:r});e&&(this.destSize.width=e,this.sourceView.width=e),s&&(this.destSize.height=s,this.sourceView.height=s),this.sourceView.x=0,this.sourceView.y=0,this.image=p,this.image.ready.then(()=>this._ready.resolve())}}class Os{constructor(e){this.sprites=[];const{sprites:s,rows:r,columns:a}=e;this.sprites=s,this.rows=r??1,this.columns=a??this.sprites.length}getSprite(e,s,r){var a,l,f,p,m,w,y,A,E;if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const D=e+s*this.columns,L=this.sprites[D];if(L){if(r){const O=L.clone();return O.flipHorizontal=(a=r.flipHorizontal)!==null&&a!==void 0?a:O.flipHorizontal,O.flipVertical=(l=r.flipVertical)!==null&&l!==void 0?l:O.flipVertical,O.width=(f=r.width)!==null&&f!==void 0?f:O.width,O.height=(p=r.height)!==null&&p!==void 0?p:O.height,O.rotation=(m=r.rotation)!==null&&m!==void 0?m:O.rotation,O.scale=(w=r.scale)!==null&&w!==void 0?w:O.scale,O.opacity=(y=r.opacity)!==null&&y!==void 0?y:O.opacity,O.tint=(A=r.tint)!==null&&A!==void 0?A:O.tint,O.origin=(E=r.origin)!==null&&E!==void 0?E:O.origin,O}return L}throw Error(`Invalid sprite coordinates (${e}, ${s})`)}getTiledSprite(e,s,r){if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const a=e+s*this.columns,l=this.sprites[a];if(l)return Kn.fromSprite(l,r);throw Error(`Invalid sprite coordinates (${e}, ${s})`)}static fromImageSourceWithSourceViews(e){const s=e.sourceViews.map(r=>new xi({image:e.image,sourceView:r}));return new Os({sprites:s})}static fromImageSource(e){var s;const r=[];e.spacing=(s=e.spacing)!==null&&s!==void 0?s:{};const{image:a,grid:{rows:l,columns:f,spriteWidth:p,spriteHeight:m},spacing:{originOffset:w,margin:y}}=e,A={x:0,y:0,...w},E={x:0,y:0,...y};for(let D=0;D<f;D++)for(let L=0;L<l;L++)r[D+L*f]=new xi({image:a,sourceView:{x:D*p+E.x*D+A.x,y:L*m+E.y*L+A.y,width:p,height:m},destSize:{height:m,width:p}});return new Os({sprites:r,rows:l,columns:f})}clone(){return new Os({sprites:this.sprites.map(e=>e.clone()),rows:this.rows,columns:this.columns})}}const M_="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class xa{constructor(){this.fontSheet=M_,this.size=16,this.load()}load(){return this._imageSource=new ki(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=Os.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new $r({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(e,s,r){this._imageSource.isLoaded()&&this._spriteFont.render(e,s,null,r.x,r.y)}}class F_{constructor(e,s){this._gl=e,this._texture=s}use(){const e=this._gl;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._texture)}disable(){const e=this._gl;e.bindTexture(e.TEXTURE_2D,null)}}class Kr{constructor(e){var s,r;this.antialias=!1,this.samples=1,this._gl=e.gl,this.width=e.width,this.height=e.height,this.transparency=e.transparency,this.antialias=(s=e.antialias)!==null&&s!==void 0?s:this.antialias,this.samples=(r=e.samples)!==null&&r!==void 0?r:this._gl.getParameter(this._gl.MAX_SAMPLES);const a=this._gl;a.drawingBufferFormat?this.bufferFormat=a.drawingBufferFormat:this.transparency?this.bufferFormat=a.RGBA8:this.bufferFormat=a.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(e,s){const r=this._gl;this.width=e,this.height=s,r.bindTexture(r.TEXTURE_2D,this._frameTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.width,this.height,0,r.RGBA,r.UNSIGNED_BYTE,null),this._renderBuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,this._renderBuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,Math.min(this.samples,r.getParameter(r.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const e=this._gl;this._renderBuffer=e.createRenderbuffer(),this._renderFrameBuffer=e.createFramebuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._renderBuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,Math.min(this.samples,e.getParameter(e.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const e=this._gl;this._frameTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._frameTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const s=e.COLOR_ATTACHMENT0;this._frameBuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,s,e.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new F_(this._gl,this._frameTexture)}blitToScreen(){const e=this._gl;this._renderBuffer?(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)):(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.frameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const e=this._gl;e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.frameBuffer),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)}}copyToTexture(e){const s=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),s.bindFramebuffer(s.FRAMEBUFFER,this._frameBuffer),s.bindTexture(s.TEXTURE_2D,e),s.copyTexImage2D(s.TEXTURE_2D,0,s.RGBA,0,0,this.width,this.height,0)}use(){const e=this._gl;this.antialias?e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.viewport(0,0,this.width,this.height)}disable(){const e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null)}}const B_=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,k_=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function ba(u,e){switch(e){case u.INT:case u.UNSIGNED_INT:case u.FLOAT:return 4;case u.SHORT:return 2;case u.UNSIGNED_SHORT:return 2;case u.BYTE:return 1;case u.UNSIGNED_BYTE:return 1;default:return 1}}function Sc(u,e){const s=`(?<type>[a-z0-9]+)\\s+${e};`,a=new RegExp(s,"g").exec(u);return a?.length>0}function Ec(u,e,s){var r;const a=`(?<type>[a-z0-9]+)\\s+${s};`,f=new RegExp(a,"g").exec(e);switch((r=f?.groups)===null||r===void 0?void 0:r.type){case"float":case"vec2":case"vec3":case"vec4":return u.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return u.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return u.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return u.BOOL;case"short":return u.SHORT;case"ushort":return u.UNSIGNED_SHORT;case"ubyte":return u.UNSIGNED_BYTE;case"byte":return u.BYTE;default:return u.FLOAT}}function Ic(u,e){switch(e){case u.LOW_FLOAT:case u.HIGH_FLOAT:case u.FLOAT:return 1;case u.FLOAT_VEC2:return 2;case u.FLOAT_VEC3:return 3;case u.FLOAT_VEC4:return 4;case u.BYTE:return 1;case u.UNSIGNED_BYTE:return 1;case u.UNSIGNED_SHORT:case u.SHORT:return 1;default:return 1}}function Rc(u,e){switch(e){case u.LOW_FLOAT:case u.HIGH_FLOAT:case u.FLOAT:case u.FLOAT_VEC2:case u.FLOAT_VEC3:case u.FLOAT_VEC4:return u.FLOAT;case u.BYTE:return u.BYTE;case u.UNSIGNED_BYTE:return u.UNSIGNED_BYTE;case u.SHORT:return u.SHORT;case u.UNSIGNED_SHORT:return u.UNSIGNED_SHORT;default:return u.FLOAT}}function ya(u,e){const s=a=>{const l=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let f="";for(let p=0;p<a;p++)p===0?f+=`if (index <= ${p}.5) {
`:f+=`   else if (index <= ${p}.5) {
`,f+=`      fragColor = vec4(1.0);
`,f+=`   }
`;return l.replace("%%complexity%%",f)};let r=!1;do{const a=s(e),l=u.createShader(u.FRAGMENT_SHADER);u.shaderSource(l,a),u.compileShader(l),r=u.getShaderParameter(l,u.COMPILE_STATUS),r||(e=e/2|0)}while(!r);return e}class Ke{get compiled(){return this._compiled}constructor(e){this._logger=ot.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:s,vertexSource:r,fragmentSource:a,onPreLink:l,onPostCompile:f}=e;this._gl=s,this.vertexSource=r,this.fragmentSource=a,this._onPreLink=l,this._onPostCompile=f}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),Ke._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return Ke._ACTIVE_SHADER_INSTANCE===this}compile(){const e=this._gl,s=this._compileShader(e,this.vertexSource,e.VERTEX_SHADER),r=this._compileShader(e,this.fragmentSource,e.FRAGMENT_SHADER);this.program=this._createProgram(e,s,r);const a=this.getAttributes();for(const f of a)this.attributes[f.name]=f;const l=this.getUniforms();for(const f of l)this.uniforms[f.name]=f;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS),r=[];for(let a=0;a<s;a++){const l=e.getActiveUniform(this.program,a),f=e.getUniformLocation(this.program,l.name);r.push({name:l.name,glType:l.type,location:f})}return r}getAttributes(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES),r=[];for(let a=0;a<s;a++){const l=e.getActiveAttrib(this.program,a),f=e.getAttribLocation(this.program,l.name);r.push({name:l.name,glType:Rc(e,l.type),size:Ic(e,l.type),location:f,normalized:!1})}return r}setTexture(e,s){const r=this._gl;r.activeTexture(r.TEXTURE0+e),r.bindTexture(r.TEXTURE_2D,s)}setUniformInt(e,s){this.setUniform("uniform1i",e,~~s)}trySetUniformInt(e,s){return this.trySetUniform("uniform1i",e,~~s)}setUniformIntArray(e,s){this.setUniform("uniform1iv",e,s)}trySetUniformIntArray(e,s){return this.trySetUniform("uniform1iv",e,s)}setUniformBoolean(e,s){this.setUniform("uniform1i",e,s?1:0)}trySetUniformBoolean(e,s){return this.trySetUniform("uniform1i",e,s?1:0)}setUniformFloat(e,s){this.setUniform("uniform1f",e,s)}trySetUniformFloat(e,s){return this.trySetUniform("uniform1f",e,s)}setUniformFloatArray(e,s){this.setUniform("uniform1fv",e,s)}trySetUniformFloatArray(e,s){return this.trySetUniform("uniform1fv",e,s)}setUniformFloatVector(e,s){this.setUniform("uniform2f",e,s.x,s.y)}trySetUniformFloatVector(e,s){return this.trySetUniform("uniform2f",e,s.x,s.y)}setUniformFloatColor(e,s){this.setUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}trySetUniformFloatColor(e,s){return this.trySetUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}setUniformMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,s.data)}setUniformAffineMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,[s.data[0],s.data[1],0,0,s.data[2],s.data[3],0,0,0,0,1,0,s.data[4],s.data[5],0,1])}trySetUniformMatrix(e,s){return this.trySetUniform("uniformMatrix4fv",e,!1,s.data)}setUniform(e,s,...r){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${e}:${s}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const l=this._gl.getUniformLocation(this.program,s);if(l){const f=[l,...r];this._gl[e].apply(this._gl,f)}else throw Error(`Uniform ${e}:${s} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(e,s,...r){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${e}:${s}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const l=this._gl.getUniformLocation(this.program,s);if(l){const f=[l,...r];this._gl[e].apply(this._gl,f)}else return!1;return!0}_createProgram(e,s,r){const a=e.createProgram();if(a===null)throw Error("Could not create graphics shader program");if(e.attachShader(a,s),e.attachShader(a,r),this._onPreLink&&this._onPreLink(a),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw Error(`Could not link the program: [${e.getProgramInfoLog(a)}]`);return a}_compileShader(e,s,r){const a=e.VERTEX_SHADER===r?"vertex":"fragment",l=e.createShader(r);if(l===null)throw Error(`Could not build shader: [${s}]`);if(e.shaderSource(l,s),e.compileShader(l),!e.getShaderParameter(l,e.COMPILE_STATUS)){const p=e.getShaderInfoLog(l);throw Error(`Could not compile ${a} shader:

${p}${this._processSourceForError(s,p)}`)}return l}_processSourceForError(e,s){if(!e)return s;const r=e.split(`
`),a=s.search(/\d:\d/),l=s.indexOf(" ",a),[f,p]=s.slice(a,l).split(":").map(m=>Number(m));for(let m=0;m<r.length;m++)r[m]=`${m+1}: ${r[m]}${p===m+1?" <----- ERROR!":""}`;return`

Source:
`+r.join(`
`)}}Ke._ACTIVE_SHADER_INSTANCE=null;class Li{constructor(e){this.type="dynamic";const{gl:s,size:r,type:a,data:l}=e;if(this._gl=s,this.buffer=this._gl.createBuffer(),!l&&!r)throw Error("Must either provide data or a size to the VertexBuffer");l?this.bufferData=l:this.bufferData=new Float32Array(r),this.type=a??this.type,s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer)}unbind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,null)}upload(e){const s=this._gl;s.bindBuffer(s.ARRAY_BUFFER,this.buffer),e?s.bufferSubData(s.ARRAY_BUFFER,0,this.bufferData,0,e):s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class es{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(e){this._logger=ot.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:s,shader:r,vertexBuffer:a,attributes:l,suppressWarnings:f}=e;this._gl=s,this._vertexBuffer=a,this._attributes=l,this._shader=r,this._suppressWarnings=f,r&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(e){e&&this._shader!==e&&(this._shader=e,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const e=this._shader.attributes;for(const l of this._attributes){const f=e[l[0]];if(!f){if(!Sc(this._shader.vertexSource,l[0]))throw Error(`The attribute named: ${l[0]} size ${l[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${l[0]} size ${l[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${l[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${l[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const p=Ec(this._gl,this._shader.vertexSource,l[0]);this._layout.push({name:l[0],glType:p,size:l[1],location:-1,normalized:!1})}if(f){if(f.size!==l[1])throw Error(`VertexLayout size definition for attribute: [${l[0]}, ${l[1]}], doesn't match shader source size ${f.size}:
 ${this._shader.vertexSource}`);this._layout.push(f)}}let s=0;for(const l of this._layout){const f=ba(this._gl,l.glType);this._vertexTotalSizeBytes+=f*l.size,s+=l.size}this._vertexBuffer.bufferData.length%s!==0&&this._logger.warn(`The vertex component size (${s})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const r=this._gl;this._vao=r.createVertexArray(),r.bindVertexArray(this._vao),this._vertexBuffer.bind();let a=0;for(const l of this._layout)l.location!==-1&&(l.glType===r.INT?r.vertexAttribIPointer(l.location,l.size,l.glType,this.totalVertexSizeBytes,a):r.vertexAttribPointer(l.location,l.size,l.glType,l.normalized,this.totalVertexSizeBytes,a),r.enableVertexAttribArray(l.location)),a+=ba(r,l.glType)*l.size;r.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(e=!1,s){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const r=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),e&&this._vertexBuffer.upload(s),r.bindVertexArray(this._vao)}}class Xt{static clear(){Xt.DrawCallCount=0,Xt.DrawnImagesCount=0}}Xt.DrawCallCount=0,Xt.DrawnImagesCount=0;class L_{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=z(0,0),this._endScratch=z(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new Ke({gl:e,vertexSource:B_,fragmentSource:k_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new Li({gl:e,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new es({gl:e,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,r){this._isFull()&&this.flush(),this._lineCount++;const a=this._context.getTransform(),l=a.multiply(e,this._startScratch),f=a.multiply(s,this._endScratch),p=this._vertexBuffer.bufferData;p[this._vertexIndex++]=l.x,p[this._vertexIndex++]=l.y,p[this._vertexIndex++]=r.r/255,p[this._vertexIndex++]=r.g/255,p[this._vertexIndex++]=r.b/255,p[this._vertexIndex++]=r.a,p[this._vertexIndex++]=f.x,p[this._vertexIndex++]=f.y,p[this._vertexIndex++]=r.r/255,p[this._vertexIndex++]=r.g/255,p[this._vertexIndex++]=r.b/255,p[this._vertexIndex++]=r.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.LINES,0,this._lineCount*2),Xt.DrawnImagesCount+=this._lineCount,Xt.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const U_=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,z_=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class H_{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new Ke({gl:e,vertexSource:U_,fragmentSource:z_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new Li({gl:e,size:7*this._maxPoints,type:"dynamic"}),this._layout=new es({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,r){this._isFull()&&this.flush(),this._pointCount++;const a=this._context.getTransform(),l=this._context.opacity,f=this._context.snapToPixel,p=a.multiply(e);f&&(p.x=~~(p.x+_t),p.y=~~(p.y+_t));const m=this._buffer.bufferData;m[this._vertexIndex++]=p.x,m[this._vertexIndex++]=p.y,m[this._vertexIndex++]=s.r/255,m[this._vertexIndex++]=s.g/255,m[this._vertexIndex++]=s.b/255,m[this._vertexIndex++]=s.a*l,m[this._vertexIndex++]=r*Math.max(a.getScaleX(),a.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.POINTS,0,this._pointCount),Xt.DrawnImagesCount+=this._pointCount,Xt.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const O_=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,W_=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class N_{constructor(e){this._gl=e,this._shader=new Ke({gl:e,vertexSource:O_,fragmentSource:W_}),this._shader.compile(),this._buffer=new Li({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new es({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(e){const s=this._gl,r=e.getShader();r.use(),e.getLayout().use(),s.activeTexture(s.TEXTURE0),r.trySetUniformInt("u_image",0),e.onDraw&&e.onDraw(),s.drawArrays(s.TRIANGLES,0,6)}renderToScreen(){const e=this._gl;this._shader.use(),this._layout.use(),e.drawArrays(e.TRIANGLES,0,6)}}class Jn{constructor(e,s,r){this._logger=ot.getInstance(),this._gl=e,this.buffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer);const a=s*6;if(!r)this.bufferData=new Uint32Array(a);else{const p=Math.floor(16383.5);this.bufferGlType=e.UNSIGNED_SHORT,this.bufferData=new Uint16Array(a),s>p&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${p}) requested quads(${s})`)}let l=0;for(let f=0;f<a;f+=6)this.bufferData[f+0]=l+0,this.bufferData[f+1]=l+1,this.bufferData[f+2]=l+2,this.bufferData[f+3]=l+2,this.bufferData[f+4]=l+1,this.bufferData[f+5]=l+3,l+=4;e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const G_=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,V_=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class X_{constructor(e){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=Q.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=ya(e,r);this._maxTextures=Math.min(r,a);const l=this._transformFragmentSource(G_,this._maxTextures);this._shader=new Ke({gl:e,fragmentSource:l,vertexSource:V_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((f,p)=>p)),this._buffer=new Li({gl:e,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new es({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new Jn(e,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let r=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_textureIndex <= ${l}.5) {
`:a+=`   else if (v_textureIndex <= ${l}.5) {
`,a+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return r=r.replace("%%texture_picker%%",a),r}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(It.Filtering),r=s?wn(s):void 0,a=bi(e.getAttribute(It.WrappingX)),l=bi(e.getAttribute(It.WrappingY)),f=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&(this._textures.push(p),this._textureToIndex.set(p,this._textureIndex++),this._images.add(e))}_bindTextures(e){for(let s=0;s<this._maxTextures;s++)e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_2D,this._textures[s]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const r=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(r))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,r,a,l,f,p,m,w){var y,A,E,D;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const L=this._getImageWidth(e),O=this._getImageHeight(e);let q=L||a||0,H=O||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(y=a??L)!==null&&y!==void 0?y:0,this._view[3]=(A=l??O)!==null&&A!==void 0?A:0,this._dest[0]=s??1,this._dest[1]=r??1,f!==void 0&&p!==void 0&&m!==void 0&&w!==void 0&&(this._view[0]=s??1,this._view[1]=r??1,this._view[2]=(E=a??L)!==null&&E!==void 0?E:0,this._view[3]=(D=l??O)!==null&&D!==void 0?D:0,this._dest[0]=f,this._dest[1]=p,q=m,H=w),s=this._view[0],r=this._view[1];const N=this._view[2],$=this._view[3],Y=this._context.getTransform(),J=this._context.opacity,rt=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+q,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+H,this._quad[6]=this._dest[0]+q,this._quad[7]=this._dest[1]+H,Y.multiplyQuadInPlace(this._quad),rt&&(this._quad[0]=~~(this._quad[0]+V(this._quad[0])*_t),this._quad[1]=~~(this._quad[1]+V(this._quad[1])*_t),this._quad[2]=~~(this._quad[2]+V(this._quad[2])*_t),this._quad[3]=~~(this._quad[3]+V(this._quad[3])*_t),this._quad[4]=~~(this._quad[4]+V(this._quad[4])*_t),this._quad[5]=~~(this._quad[5]+V(this._quad[5])*_t),this._quad[6]=~~(this._quad[6]+V(this._quad[6])*_t),this._quad[7]=~~(this._quad[7]+V(this._quad[7])*_t));const Z=this._context.tint||this._defaultTint,ft=this._getTextureIdForImage(e),Tt=L||q,Gt=O||H,qt=(s+this.uvPadding)/Tt,Ce=(r+this.uvPadding)/Gt,$t=(s+N-this.uvPadding)/Tt,kt=(r+$-this.uvPadding)/Gt,Oe=L,De=O,it=this._layout.vertexBuffer.bufferData;it[this._vertexIndex++]=this._quad[0],it[this._vertexIndex++]=this._quad[1],it[this._vertexIndex++]=J,it[this._vertexIndex++]=Oe,it[this._vertexIndex++]=De,it[this._vertexIndex++]=qt,it[this._vertexIndex++]=Ce,it[this._vertexIndex++]=ft,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a,it[this._vertexIndex++]=this._quad[4],it[this._vertexIndex++]=this._quad[5],it[this._vertexIndex++]=J,it[this._vertexIndex++]=Oe,it[this._vertexIndex++]=De,it[this._vertexIndex++]=qt,it[this._vertexIndex++]=kt,it[this._vertexIndex++]=ft,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a,it[this._vertexIndex++]=this._quad[2],it[this._vertexIndex++]=this._quad[3],it[this._vertexIndex++]=J,it[this._vertexIndex++]=Oe,it[this._vertexIndex++]=De,it[this._vertexIndex++]=$t,it[this._vertexIndex++]=Ce,it[this._vertexIndex++]=ft,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a,it[this._vertexIndex++]=this._quad[6],it[this._vertexIndex++]=this._quad[7],it[this._vertexIndex++]=J,it[this._vertexIndex++]=Oe,it[this._vertexIndex++]=De,it[this._vertexIndex++]=$t,it[this._vertexIndex++]=kt,it[this._vertexIndex++]=ft,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),this._quads.bind(),e.drawElements(e.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),Xt.DrawnImagesCount+=this._imageCount,Xt.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const q_=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,Y_=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class j_{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=Q.Transparent,this._scratch1=z(0,0),this._scratch2=z(0,0),this._scratch3=z(0,0),this._scratch4=z(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new Ke({gl:e,fragmentSource:q_,vertexSource:Y_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new Li({gl:e,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new es({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Jn(e,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...e){e[0]instanceof B&&e[1]instanceof B?this.drawLine.apply(this,e):this.drawRectangle.apply(this,e)}drawLine(e,s,r,a=1){this._isFull()&&this.flush(),this._rectangleCount++;const l=this._context.getTransform(),f=this._context.opacity,p=this._context.snapToPixel,m=s.sub(e),w=m.magnitude,y=m.normalize().perpendicular(),A=a/2,E=l.multiply(y.scale(A,this._scratch1).add(e,this._scratch1),this._scratch1),D=l.multiply(y.scale(-A,this._scratch2).add(e,this._scratch2),this._scratch2),L=l.multiply(y.scale(A,this._scratch3).add(s,this._scratch3),this._scratch3),O=l.multiply(y.scale(-A,this._scratch4).add(s,this._scratch4),this._scratch4);p&&(E.x=~~(E.x+_t),E.y=~~(E.y+_t),L.x=~~(L.x+_t),L.y=~~(L.y+_t),D.x=~~(D.x+_t),D.y=~~(D.y+_t),O.x=~~(O.x+_t),O.y=~~(O.y+_t));const q=0,H=0,N=1,$=1,Y=this._transparent,J=0,rt=1,Z=this._layout.vertexBuffer.bufferData;Z[this._vertexIndex++]=E.x,Z[this._vertexIndex++]=E.y,Z[this._vertexIndex++]=q,Z[this._vertexIndex++]=H,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=J/rt,Z[this._vertexIndex++]=D.x,Z[this._vertexIndex++]=D.y,Z[this._vertexIndex++]=q,Z[this._vertexIndex++]=$,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=J/rt,Z[this._vertexIndex++]=L.x,Z[this._vertexIndex++]=L.y,Z[this._vertexIndex++]=N,Z[this._vertexIndex++]=H,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=J/rt,Z[this._vertexIndex++]=O.x,Z[this._vertexIndex++]=O.y,Z[this._vertexIndex++]=N,Z[this._vertexIndex++]=$,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=J/rt}drawRectangle(e,s,r,a,l=Q.Transparent,f=0){this._isFull()&&this.flush(),this._rectangleCount++;const p=this._context.getTransform(),m=this._context.opacity,w=this._context.snapToPixel,y=p.multiply(e.add(z(0,0))),A=p.multiply(e.add(z(s,0))),E=p.multiply(e.add(z(s,r))),D=p.multiply(e.add(z(0,r)));w&&(y.x=~~(y.x+_t),y.y=~~(y.y+_t),A.x=~~(A.x+_t),A.y=~~(A.y+_t),D.x=~~(D.x+_t),D.y=~~(D.y+_t),E.x=~~(E.x+_t),E.y=~~(E.y+_t));const L=0,O=0,q=1,H=1,N=this._layout.vertexBuffer.bufferData;N[this._vertexIndex++]=y.x,N[this._vertexIndex++]=y.y,N[this._vertexIndex++]=L,N[this._vertexIndex++]=O,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=f,N[this._vertexIndex++]=D.x,N[this._vertexIndex++]=D.y,N[this._vertexIndex++]=L,N[this._vertexIndex++]=H,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=f,N[this._vertexIndex++]=A.x,N[this._vertexIndex++]=A.y,N[this._vertexIndex++]=q,N[this._vertexIndex++]=O,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=f,N[this._vertexIndex++]=E.x,N[this._vertexIndex++]=E.y,N[this._vertexIndex++]=q,N[this._vertexIndex++]=H,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=f}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),Xt.DrawnImagesCount+=this._rectangleCount,Xt.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const Z_=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,Q_=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class $_{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new Ke({gl:e,fragmentSource:Z_,vertexSource:Q_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new Li({gl:e,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new es({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Jn(e,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(e,s,r,a=Q.Transparent,l=0){this._isFull()&&this.flush(),this._circleCount++;const f=this._context.getTransform(),p=this._context.opacity,m=this._context.snapToPixel,w=f.multiply(e.add(z(-s,-s))),y=f.multiply(e.add(z(s,-s))),A=f.multiply(e.add(z(s,s))),E=f.multiply(e.add(z(-s,s)));m&&(w.x=~~(w.x+_t),w.y=~~(w.y+_t),y.x=~~(y.x+_t),y.y=~~(y.y+_t),E.x=~~(E.x+_t),E.y=~~(E.y+_t),A.x=~~(A.x+_t),A.y=~~(A.y+_t));const D=0,L=0,O=1,q=1,H=this._layout.vertexBuffer.bufferData;H[this._vertexIndex++]=w.x,H[this._vertexIndex++]=w.y,H[this._vertexIndex++]=D,H[this._vertexIndex++]=L,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=E.x,H[this._vertexIndex++]=E.y,H[this._vertexIndex++]=D,H[this._vertexIndex++]=q,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=y.x,H[this._vertexIndex++]=y.y,H[this._vertexIndex++]=O,H[this._vertexIndex++]=L,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=A.x,H[this._vertexIndex++]=A.y,H[this._vertexIndex++]=O,H[this._vertexIndex++]=q,H[this._vertexIndex++]=p,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),Xt.DrawnImagesCount+=this._circleCount,Xt.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class Jr{constructor(e,s,r=100){this.builder=e,this.recycler=s,this.maxObjects=r,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=ot.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let e=0;e<this.maxObjects;e++)this.objects[e]=this.builder()}using(e){const s=e(this);return s?this.done(...s):this.done()}borrow(e){const s=this.get();e(s),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...e){this.index=0;for(const s of e){const r=this.objects.indexOf(s);this.objects[r]=this.builder(),this.totalAllocations++}return e}}class K_{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=le.identity(),this.state={z:0,opacity:1,tint:Q.White,material:null},this.args=new Array(10)}}const J_=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class Dc{constructor(e){this._logger=ot.getInstance(),this._color=Q.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:s,name:r,vertexSource:a,fragmentSource:l,graphicsContext:f,images:p}=e;if(this._name=r??"anonymous material",this._vertexSource=a??J_,this._fragmentSource=l,this._color=s??this._color,!f)throw Error(`Material ${r} must be provided an excalibur webgl graphics context`);if(f instanceof ss?(this._graphicsContext=f,this._initialize(f)):this._logger.warn(`Material ${r} was created in 2D Canvas mode, currently only WebGL is supported`),p)for(const m in p)this.addImageSource(m,p[m])}_initialize(e){if(this._initialized)return;const s=e.__gl;this._maxTextureSlots=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=e.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(e){this._color=e}get name(){var e;return(e=this._name)!==null&&e!==void 0?e:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(e){this._shader&&(this._shader.use(),e(this._shader))}getShader(){return this._shader}addImageSource(e,s){this._images.size<this._maxTextureSlots?this._images.set(e,s):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(e){const s=this._images.get(e);this._graphicsContext.textureLoader.delete(s.image),this._images.delete(e)}_loadImageSource(e){const s=e.image,r=s.getAttribute(It.Filtering),a=r?wn(r):void 0,l=bi(s.getAttribute(It.WrappingX)),f=bi(s.getAttribute(It.WrappingY)),p=s.getAttribute("forceUpload")==="true",m=this._graphicsContext.textureLoader.load(s,{filtering:a,wrapping:{x:l,y:f}},p);return s.removeAttribute("forceUpload"),this._textures.has(e)||this._textures.set(e,m),m}uploadAndBind(e,s=2){let r=s;for(const[a,l]of this._images.entries()){if(!l.isLoaded()){this._logger.warnOnce(`Image named ${a} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const f=this._loadImageSource(l);e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,f),this._shader.trySetUniformInt(a,r),r++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class Mc{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(e,s){this._gl=e,this._context=s,this._buffer=new Li({gl:e,size:6*4,type:"dynamic"}),this._layout=new es({gl:e,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new Jn(e,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(e,s,r,a,l,f,p,m,w){var y,A,E,D;const L=this._gl,O=this._context.material;if(!O)return;const q=this._context.getTransform(),H=this._context.opacity,N=O.getShader(),$=this._layout.vertexBuffer.bufferData;let Y=0,J=e?.width||a||0,rt=e?.height||l||0,Z=[0,0,(y=a??e?.width)!==null&&y!==void 0?y:0,(A=l??e?.height)!==null&&A!==void 0?A:0],ft=[s??1,r??1];f!==void 0&&p!==void 0&&m!==void 0&&w!==void 0&&(Z=[s??1,r??1,(E=a??e?.width)!==null&&E!==void 0?E:0,(D=l??e?.height)!==null&&D!==void 0?D:0],ft=[f,p],J=m,rt=w),s=Z[0],r=Z[1];const Tt=Z[2],Gt=Z[3],qt=z(ft[0],ft[1]),Ce=z(ft[0]+J,ft[1]),$t=z(ft[0],ft[1]+rt),kt=z(ft[0]+J,ft[1]+rt),Oe=e.width||J,De=e.height||rt,it=s/Oe,$s=r/De,Ks=(s+Tt-.01)/Oe,Js=(r+Gt-.01)/De,Mn=q.getPosition(),hu=Mn.add(kt),lu=Mn.x/this._context.width,cu=Mn.y/this._context.height,du=hu.x/this._context.width,uu=hu.y/this._context.height;$[Y++]=qt.x,$[Y++]=qt.y,$[Y++]=it,$[Y++]=$s,$[Y++]=lu,$[Y++]=cu,$[Y++]=$t.x,$[Y++]=$t.y,$[Y++]=it,$[Y++]=Js,$[Y++]=lu,$[Y++]=uu,$[Y++]=Ce.x,$[Y++]=Ce.y,$[Y++]=Ks,$[Y++]=$s,$[Y++]=du,$[Y++]=cu,$[Y++]=kt.x,$[Y++]=kt.y,$[Y++]=Ks,$[Y++]=Js,$[Y++]=du,$[Y++]=uu;const bg=this._addImageAsTexture(e);O.use(),this._layout.shader=N,this._layout.use(!0),N.trySetUniformFloat("u_time_ms",performance.now()),N.trySetUniformFloat("u_opacity",H),N.trySetUniformFloatVector("u_resolution",z(this._context.width,this._context.height)),N.trySetUniformFloatVector("u_graphic_resolution",z(Oe,De)),N.trySetUniformFloatVector("u_size",z(Tt,Gt)),N.trySetUniformMatrix("u_matrix",this._context.ortho),N.trySetUniformMatrix("u_transform",q.to4x4()),L.activeTexture(L.TEXTURE0+0),L.bindTexture(L.TEXTURE_2D,bg),N.trySetUniformInt("u_graphic",0),L.activeTexture(L.TEXTURE0+1),L.bindTexture(L.TEXTURE_2D,this._context.materialScreenTexture),N.trySetUniformInt("u_screen_texture",1),O.uploadAndBind(L),this._quads.bind(),L.drawElements(L.TRIANGLES,6,this._quads.bufferGlType,0),Xt.DrawnImagesCount++,Xt.DrawCallCount++}_addImageAsTexture(e){const s=e.getAttribute(It.Filtering),r=s?wn(s):void 0,a=bi(e.getAttribute(It.WrappingX)),l=bi(e.getAttribute(It.WrappingY)),f=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);return e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&this._textures.push(p),p}hasPendingDraws(){return!1}flush(){}}const tp=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,ep=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var Ie;(function(u){u.World="world",u.Screen="screen"})(Ie||(Ie={}));class Aa extends B{constructor(e){super(0,0),this._getX=e.getX,this._getY=e.getY,this._setX=e.setX,this._setY=e.setY}get x(){return this._x=this._getX()}set x(e){this._setX(e),this._x=e}get y(){return this._y=this._getY()}set y(e){this._setY(e),this._y=e}}class As extends B{constructor(e,s){super(e.x,e.y),this.original=e,this.change=s}get x(){return this._x=this.original.x}set x(e){e!==this._x&&(this.change(e,this._y),this._x=this.original.x=e)}get y(){return this._y=this.original.y}set y(e){e!==this._y&&(this.change(this._x,e),this._y=this.original.y=e)}setTo(e,s){this.x=e,this.y=s}}class is{constructor(){this._parent=null,this._children=[],this._pos=new As(z(0,0),()=>{this.flagDirty()}),this._globalPos=new Aa({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:e=>{if(this.parent){const{x:s}=this.parent.inverse.multiply(z(e,this.pos.y));this.pos.x=s}else this.pos.x=e;e!==this.matrix.data[4]&&this.flagDirty()},setY:e=>{if(this.parent){const{y:s}=this.parent.inverse.multiply(z(this.pos.x,e));this.pos.y=s}else this.pos.y=e;e!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new As(z(1,1),()=>{this.flagDirty()}),this._globalScale=new Aa({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:e=>{if(this.parent){const s=this.parent.globalScale.x;this.scale.x=e/s}else this.scale.x=e},setY:e=>{if(this.parent){const s=this.parent.globalScale.y;this.scale.y=e/s}else this.scale.y=e}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=le.identity(),this._inverse=le.identity(),this._scratch=le.identity()}get parent(){return this._parent}set parent(e){if(this._parent){const s=this._parent._children.indexOf(this);s>-1&&this._parent._children.splice(s,1)}this._parent=e,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(e){this._pos.x=e.x,this._pos.y=e.y}get pos(){return this._pos}set globalPos(e){let s=e.clone();this.parent&&(s=this.parent.inverse.multiply(e)),s.equals(this._pos)||(this._pos=s,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(e){const s=nt(e);s!==this._rotation&&this.flagDirty(),this._rotation=s}get rotation(){return this._rotation}set globalRotation(e){let s=0;this.parent&&(s=this.parent.globalRotation);const r=nt(e+s);r!==this._rotation&&this.flagDirty(),this._rotation=r}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(e){this._scale.x=e.x,this._scale.y=e.y}get scale(){return this._scale}set globalScale(e){let s=z(1,1);this.parent&&(s=this.parent.globalScale),this.scale=e.scale(z(1/s.x,1/s.y))}get globalScale(){return this._globalScale}set z(e){this._z=e,this.flagDirty()}get z(){return this._z}set globalZ(e){this.parent?this.z=e-this.parent.globalZ:this.z=e}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let e=0;e<this._children.length;e++)this._children[e].flagDirty()}apply(e){return this.matrix.multiply(e)}applyInverse(e){return this.inverse.multiply(e)}setTransform(e,s,r){this._pos.x=e.x,this._pos.y=e.y,this._rotation=nt(s),this._scale.x=r.x,this._scale.y=r.y,this.flagDirty()}isMirrored(){const e=V(this.scale.x)>>>31,s=V(this.scale.y)>>>31;return!!(e^s)}clone(e){const s=e??new is;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.flagDirty(),s}cloneWithParent(e){const s=e??new is;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.parent=this.parent,s.flagDirty(),s}toString(){return this.matrix.toString()}}function Fc(u){return!!u&&!!u.prototype&&!!u.prototype.constructor}function ip(u){return!!u?.clone}class pi{constructor(){this.owner=void 0}clone(){const e=new this.constructor;for(const s in this)if(this.hasOwnProperty(s)){const r=this[s];ip(r)&&s!=="owner"&&s!=="clone"?e[s]=r.clone():e[s]=r}return e}}class Ve{constructor(){this.observers=[],this.subscriptions=[]}register(e){this.observers.push(e)}subscribe(e){this.subscriptions.push(e)}unregister(e){const s=this.observers.indexOf(e);s!==-1&&this.observers.splice(s,1)}unsubscribe(e){const s=this.subscriptions.indexOf(e);s!==-1&&this.subscriptions.splice(s,1)}notifyAll(e){const s=this.observers.length;for(let a=0;a<s;a++)this.observers[a].notify(e);const r=this.subscriptions.length;for(let a=0;a<r;a++)this.subscriptions[a](e)}clear(){this.observers.length=0,this.subscriptions.length=0}}class et extends pi{constructor(){super(...arguments),this._logger=ot.getInstance(),this._parentComponent=null,this._transform=new is,this._addChildTransform=e=>{const s=e.get(et);s&&(s._transform.parent=this._transform,s._parentComponent=this)},this.zIndexChanged$=new Ve,this._coordPlane=Ie.World}get(){return this._transform}onAdd(e){for(const s of e.children)this._addChildTransform(s);e.childrenAdded$.subscribe(s=>this._addChildTransform(s)),e.childrenRemoved$.subscribe(s=>{const r=s.get(et);r&&(r._transform.parent=null,r._parentComponent=null)})}onRemove(e){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(e){const s=this._transform.z;this._transform.z=e,s!==e&&this.zIndexChanged$.notifyAll(e)}get globalZ(){return this._transform.globalZ}set globalZ(e){this._transform.globalZ=e}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(e){var s;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(s=this.owner)===null||s===void 0?void 0:s.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=e}get pos(){return this._transform.pos}set pos(e){this._transform.pos=e}get globalPos(){return this._transform.globalPos}set globalPos(e){this._transform.globalPos=e}get rotation(){return this._transform.rotation}set rotation(e){this._transform.rotation=e}get globalRotation(){return this._transform.globalRotation}set globalRotation(e){this._transform.globalRotation=e}get scale(){return this._transform.scale}set scale(e){this._transform.scale=e}get globalScale(){return this._transform.globalScale}set globalScale(e){this._transform.globalScale=e}applyInverse(e){return this._transform.applyInverse(e)}apply(e){return this._transform.apply(e)}clone(){const e=new et;return e._transform=this._transform.clone(),e}}var tr;(function(u){u.Forward="forward",u.Backward="backward"})(tr||(tr={}));var yi;(function(u){u.End="end",u.Loop="loop",u.PingPong="pingpong",u.Freeze="freeze"})(yi||(yi={}));const sp={Frame:"frame",Loop:"loop",End:"end"};class Ai extends Kt{constructor(e){var s,r,a;super(e),this.events=new I,this.frames=[],this.strategy=yi.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=e.frames,this.speed=(s=e.speed)!==null&&s!==void 0?s:this.speed,this.strategy=(r=e.strategy)!==null&&r!==void 0?r:this.strategy,this.frameDuration=e.totalDuration?e.totalDuration/this.frames.length:(a=e.frameDuration)!==null&&a!==void 0?a:this.frameDuration,e.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new Ai({frames:this.frames.map(e=>({...e})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.width*this.scale.x):0}get height(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.height*this.scale.y):0}static fromSpriteSheet(e,s,r,a=yi.Loop){const l=e.sprites.length-1,f=s.filter(p=>p<0||p>l);return f.length&&Ai._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${f.join(",")} no frame will be shown`),new Ai({frames:e.sprites.filter((p,m)=>s.indexOf(m)>-1).map(p=>({graphic:p,duration:r})),strategy:a})}static fromSpriteSheetCoordinates(e){var s;const{spriteSheet:r,frameCoordinates:a,durationPerFrame:l,durationPerFrameMs:f,speed:p,strategy:m,reverse:w}=e,y=(s=l??f)!==null&&s!==void 0?s:100,A=[];for(const E of a){const{x:D,y:L,duration:O,options:q}=E,H=r.getSprite(D,L,q);H?A.push({graphic:H,duration:O??y}):Ai._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${D}, ${L}), please check your SpriteSheet to confirm that sprite exists`)}return new Ai({frames:A,strategy:m,speed:p,reverse:w})}get speed(){return this._speed}set speed(e){this._speed=j(Math.abs(e),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?tr.Backward:tr.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const e=this.frames[this._currentFrame];e&&(this._timeLeftInFrame=e?.duration||this.frameDuration)}get canFinish(){switch(this.strategy){case yi.End:case yi.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(e,s){this._currentFrame=e,this._timeLeftInFrame=s??this.frameDuration;const r=this.frames[this._currentFrame];r&&!this._done&&(this._timeLeftInFrame=s??(r?.duration||this.frameDuration),this.events.emit("frame",{...r,frameIndex:this.currentFrameIndex}))}_nextFrame(){const e=this._currentFrame;if(this._done)return e;let s=-1;switch(this.strategy){case yi.Loop:{s=(e+1)%this.frames.length,s===0&&this.events.emit("loop",this);break}case yi.End:{s=e+1,s>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case yi.Freeze:{s=j(e+1,0,this.frames.length-1),s>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case yi.PingPong:{e+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),e+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),s=e+this._pingPongDirection%this.frames.length;break}}return s}tick(e,s=0){this._idempotencyToken!==s&&(this._idempotencyToken=s,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=e*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(e,s,r){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(e,s,r)}}Ai._LOGGER=ot.getInstance();class xn extends Kt{constructor(e){var s;super(e),this._logger=ot.getInstance(),this.useAnchor=!0,this.members=[],this.members=e.members,this.useAnchor=(s=e.useAnchor)!==null&&s!==void 0?s:this.useAnchor,this._updateDimensions()}clone(){return new xn({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const e=this.localBounds;return this.width=e.width,this.height=e.height,e}get localBounds(){const e=new at;for(const s of this.members)if(s instanceof Kt)s.localBounds.combine(e,e);else{const{graphic:r,offset:a,useBounds:l}=s;r?(l===void 0?!0:l)&&r.localBounds.translate(a).combine(e,e):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(s)}.`)}return e}_isAnimationOrGroup(e){return e instanceof Ai||e instanceof xn}tick(e,s){for(const r of this.members){let a;r instanceof Kt?a=r:a=r.graphic,this._isAnimationOrGroup(a)&&a.tick(e,s)}}reset(){for(const e of this.members){let s;e instanceof Kt?s=e:s=e.graphic,this._isAnimationOrGroup(s)&&s.reset()}}_preDraw(e,s,r){this._updateDimensions(),super._preDraw(e,this.useAnchor?s:0,this.useAnchor?r:0)}_drawImage(e,s,r){const a=B.Zero;for(const l of this.members){let f;l instanceof Kt?f=l:(f=l.graphic,l.offset.clone(a)),f&&(e.save(),e.translate(s,r),f.draw(e,a.x,a.y),this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore())}}}class bn extends Kt{constructor(e){var s,r,a,l,f,p,m,w,y,A;super(Cc({...e},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=wi(Q.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,e&&(this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this.color=(r=e.color)!==null&&r!==void 0?r:Q.Black,this.strokeColor=e?.strokeColor,this.smoothing=(a=e.smoothing)!==null&&a!==void 0?a:this.smoothing,this.lineWidth=(l=e.lineWidth)!==null&&l!==void 0?l:this.lineWidth,this.lineDash=(f=e.lineDash)!==null&&f!==void 0?f:this.lineDash,this.lineCap=(p=e.lineCap)!==null&&p!==void 0?p:this.lineCap,this.padding=(m=e.padding)!==null&&m!==void 0?m:this.padding,this.filtering=(w=e.filtering)!==null&&w!==void 0?w:this.filtering),this._bitmap=document.createElement("canvas");const E=(y=e?.width)!==null&&y!==void 0?y:this._bitmap.width,D=(A=e?.height)!==null&&A!==void 0?A:this._bitmap.height;this.width=E,this.height=D;const L=this._bitmap.getContext("2d");if(L)this._ctx=L;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(e){e/=Math.abs(this.scale.x),this._bitmap.width=e,this._originalWidth=e,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(e){e/=Math.abs(this.scale.y),this._bitmap.height=e,this._originalHeight=e,this.flagDirty()}_getTotalWidth(){var e;return(((e=this._originalWidth)!==null&&e!==void 0?e:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var e;return(((e=this._originalHeight)!==null&&e!==void 0?e:this._bitmap.height)+this.padding*2)*1}get localBounds(){return at.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,B.Zero)}get smoothing(){return this._smoothing}set smoothing(e){this._smoothing=e,this.flagDirty()}get color(){return this._color}set color(e){this.flagDirty(),this._color=wi(e,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(e){this.flagDirty(),e&&(this._strokeColor=wi(e,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(e){this._lineDash=e,this.flagDirty()}get padding(){return this._padding}set padding(e){this._padding=e,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(e){var s,r,a,l;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),e.scale(this.quality,this.quality),e.translate(this.padding,this.padding),e.imageSmoothingEnabled=this.smoothing,e.lineWidth=this.lineWidth,e.setLineDash((s=this.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.lineCap=this.lineCap,e.strokeStyle=(a=(r=this.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&a!==void 0?a:"",e.fillStyle=(l=this.color)===null||l===void 0?void 0:l.toString()}_drawImage(e,s,r){this._dirty&&this.rasterize(),e.scale(1/this.quality,1/this.quality),e.drawImage(this._bitmap,s,r)}}var to;(function(u){u.Em="em",u.Rem="rem",u.Px="px",u.Pt="pt",u.Percent="%"})(to||(to={}));var eo;(function(u){u.Left="left",u.Right="right",u.Center="center",u.Start="start",u.End="end"})(eo||(eo={}));var io;(function(u){u.Top="top",u.Hanging="hanging",u.Middle="middle",u.Alphabetic="alphabetic",u.Ideographic="ideographic",u.Bottom="bottom"})(io||(io={}));var so;(function(u){u.Normal="normal",u.Italic="italic",u.Oblique="oblique"})(so||(so={}));var no;(function(u){u.LeftToRight="ltr",u.RightToLeft="rtl"})(no||(no={}));function Ca(u,e=Q.Red,s,r,a,l,f=1,p="butt"){u.save(),u.beginPath(),u.lineWidth=f,u.lineCap=p,u.strokeStyle=e.toString(),u.moveTo(s,r),u.lineTo(a,l),u.closePath(),u.stroke(),u.restore()}function np(u,e=Q.Red,s){u.beginPath(),u.strokeStyle=e.toString(),u.arc(s.x,s.y,5,0,Math.PI*2),u.closePath(),u.stroke()}function rp(u,e,s,r,a=1){const l=e?e.toString():"blue",f=r.scale(a);u.beginPath(),u.strokeStyle=l,u.moveTo(s.x,s.y),u.lineTo(s.x+f.x,s.y+f.y),u.closePath(),u.stroke()}function Pa(u,e,s,r,a,l=5,f=Q.White,p=null){let m;if(typeof l=="number")m={tl:l,tr:l,br:l,bl:l};else{const w={tl:0,tr:0,br:0,bl:0};for(const y in w)if(w.hasOwnProperty(y)){const A=y;m[A]=l[A]||w[A]}}u.beginPath(),u.moveTo(e+m.tl,s),u.lineTo(e+r-m.tr,s),u.quadraticCurveTo(e+r,s,e+r,s+m.tr),u.lineTo(e+r,s+a-m.br),u.quadraticCurveTo(e+r,s+a,e+r-m.br,s+a),u.lineTo(e+m.bl,s+a),u.quadraticCurveTo(e,s+a,e,s+a-m.bl),u.lineTo(e,s+m.tl),u.quadraticCurveTo(e,s,e+m.tl,s),u.closePath(),p&&(u.fillStyle=p.toString(),u.fill()),f&&(u.strokeStyle=f.toString(),u.stroke())}function op(u,e,s,r,a=Q.White,l=null){u.beginPath(),u.arc(e,s,r,0,Math.PI*2),u.closePath(),l&&(u.fillStyle=l.toString(),u.fill()),a&&(u.strokeStyle=a.toString(),u.stroke())}class yn{constructor(e,s,r,a){this.font=e,this.text=s,this.color=r,this.maxWidth=a,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const l=this.canvas.getContext("2d");if(!l)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=l,this.dimensions=this.measureText(s),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(e,s){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let r=null;s!=null?r=this._getLinesFromText(e,s):r=e.split(`
`);const a=r.reduce((E,D)=>E.length>D.length?E:D);this._applyFont(this.ctx);const l=this.ctx.measureText(a);let f=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);const p=f*r.length;f=p;const m=p-Math.abs(l.actualBoundingBoxAscent),w=0,y=0;return new at({left:w-Math.abs(l.actualBoundingBoxLeft)-this.font.padding,top:y-Math.abs(l.actualBoundingBoxAscent)-this.font.padding,bottom:y+m+this.font.padding,right:w+Math.abs(l.actualBoundingBoxRight)+this.font.padding})}_setDimension(e,s){let r=1;this.font.lineHeight&&(r=this.font.lineHeight/this.font.size),s.canvas.width=(e.width+this.font.padding*2)*2*this.font.quality,s.canvas.height=(e.height+this.font.padding*2)*2*this.font.quality*r}static getHashCode(e,s,r){var a;return s+"__hashcode__"+e.fontString+e.showDebug+e.textAlign+e.baseAlign+e.direction+e.lineHeight+JSON.stringify(e.shadow)+(e.padding.toString()+e.smoothing.toString()+e.lineWidth.toString()+e.lineDash.toString()+((a=e.strokeColor)===null||a===void 0?void 0:a.toString())+(r?r.toString():e.color.toString()))}getHashCode(e=!0){return yn.getHashCode(this.font,this.text,e?this.color:void 0)}_applyRasterProperties(e){var s,r,a;e.translate(this.font.padding,this.font.padding),e.imageSmoothingEnabled=this.font.smoothing,e.lineWidth=this.font.lineWidth,e.setLineDash((s=this.font.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.strokeStyle=(a=(r=this.font.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&a!==void 0?a:"",e.fillStyle=this.color.toString()}_applyFont(e){e.resetTransform(),e.translate(this.font.padding+e.canvas.width/2,this.font.padding+e.canvas.height/2),e.scale(this.font.quality,this.font.quality),e.textAlign=this.font.textAlign,e.textBaseline=this.font.baseAlign,e.font=this.font.fontString,e.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(e.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(e.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(e.shadowOffsetX=this.font.shadow.offset.x,e.shadowOffsetY=this.font.shadow.offset.y))}_drawText(e,s,r){this._applyRasterProperties(e),this._applyFont(e);for(let a=0;a<s.length;a++){const l=s[a];this.color&&e.fillText(l,0,a*r),this.font.strokeColor&&e.strokeText(l,0,a*r)}this.font.showDebug&&(Ca(e,Q.Green,-e.canvas.width/2,0,e.canvas.width/2,0,2),Ca(e,Q.Red,0,-e.canvas.height/2,0,e.canvas.height/2,2))}_splitTextBitmap(e){const s=[];let r=0,a=0;const l=Math.min(4096,e.canvas.width),f=Math.min(4096,e.canvas.height);for(;r<e.canvas.width;){for(;a<e.canvas.height;){const p=document.createElement("canvas");p.width=l,p.height=f;const m=p.getContext("2d");if(!m)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");m.drawImage(e.canvas,r,a,l,f,0,0,l,f),s.push({x:r,y:a,canvas:p}),a+=f}r+=l,a=0}return s}flagDirty(){this._dirty=!0}render(e,s,r,a){var l;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=e;const f=this.getHashCode();if(this._lastHashCode!==f&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,a),this._setDimension(this.dimensions,this.ctx);const p=this._getLinesFromText(this.text,a),m=(l=this.font.lineHeight)!==null&&l!==void 0?l:this.dimensions.height/p.length;if(this._drawText(this.ctx,p,m),e instanceof ss)for(const w of this._textFragments)e.textureLoader.delete(w.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),e instanceof ss)for(const w of this._textFragments)e.textureLoader.load(w.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=f,this._dirty=!1}for(const p of this._textFragments)e.drawImage(p.canvas,0,0,p.canvas.width,p.canvas.height,p.x/this.font.quality+s-this.ctx.canvas.width/this.font.quality/2,p.y/this.font.quality+r-this.ctx.canvas.height/this.font.quality/2,p.canvas.width/this.font.quality,p.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof ss)for(const e of this._textFragments)this._ex.textureLoader.delete(e.canvas);this._textFragments.length=0}_getLinesFromText(e,s){var r;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let f=a[l],p="";if(this.measureText(f).width>s){for(;this.measureText(f).width>s;)p=f[f.length-1]+p,f=f.slice(0,-1);a[l]=f,a[l+1]=p}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class Ft{static measureText(e,s,r){const a=yn.getHashCode(s,e);if(Ft._MEASURE_CACHE.has(a))return Ft._MEASURE_CACHE.get(a);Ft._LOGGER.debug("Font text measurement cache miss");const l=s.measureTextWithoutCache(e,r);return Ft._MEASURE_CACHE.set(a,l),l}static getTextInstance(e,s,r){const a=yn.getHashCode(s,e,r);let l=Ft._TEXT_CACHE.get(a);return l||(l=new yn(s,e,r),Ft._TEXT_CACHE.set(a,l),Ft._LOGGER.debug("Font text instance cache miss")),Ft._TEXT_USAGE.set(l,performance.now()),l}static checkAndClearCache(){const e=[],s=new Set;for(const[a,l]of Ft._TEXT_USAGE.entries())if(l+Ft.FONT_TIMEOUT<performance.now())Ft._LOGGER.debug(`Text cache entry timed out ${a.text}`),e.push(a),a.dispose();else{const f=a.getHashCode(!1);s.add(f)}e.forEach(a=>{Ft._TEXT_USAGE.delete(a)}),this._TEXT_CACHE.clear();for(const[a]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(a.getHashCode(),a);const r=new Map;for(const a of s)Ft._MEASURE_CACHE.has(a)&&r.set(a,Ft._MEASURE_CACHE.get(a));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=r}static get cacheSize(){return Ft._TEXT_USAGE.size}static clearCache(){for(const[e]of Ft._TEXT_USAGE.entries())e.dispose();Ft._TEXT_USAGE.clear(),Ft._TEXT_CACHE.clear(),Ft._MEASURE_CACHE.clear()}}Ft.FONT_TIMEOUT=500,Ft._LOGGER=ot.getInstance(),Ft._TEXT_USAGE=new Map,Ft._TEXT_CACHE=new Map,Ft._MEASURE_CACHE=new Map;class Ws extends Kt{constructor(e={}){var s,r,a,l,f,p,m,w,y,A,E,D,L,O,q,H,N,$,Y,J;super(e),this.filtering=ce.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=Q.Black,this.family="sans-serif",this.style=so.Normal,this.bold=!1,this.unit=to.Px,this.textAlign=eo.Left,this.baseAlign=io.Top,this.direction=no.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new at,this._textMeasurement=new yn(this,"",Q.Black),this.smoothing=(s=e?.smoothing)!==null&&s!==void 0?s:this.smoothing,this.padding=(r=e?.padding)!==null&&r!==void 0?r:this.padding,this.color=(a=e?.color)!==null&&a!==void 0?a:this.color,this.strokeColor=(l=e?.strokeColor)!==null&&l!==void 0?l:this.strokeColor,this.lineDash=(f=e?.lineDash)!==null&&f!==void 0?f:this.lineDash,this.lineWidth=(p=e?.lineWidth)!==null&&p!==void 0?p:this.lineWidth,this.filtering=(m=e?.filtering)!==null&&m!==void 0?m:this.filtering,this.family=(w=e?.family)!==null&&w!==void 0?w:this.family,this.style=(y=e?.style)!==null&&y!==void 0?y:this.style,this.bold=(A=e?.bold)!==null&&A!==void 0?A:this.bold,this.size=(E=e?.size)!==null&&E!==void 0?E:this.size,this.unit=(D=e?.unit)!==null&&D!==void 0?D:this.unit,this.textAlign=(L=e?.textAlign)!==null&&L!==void 0?L:this.textAlign,this.baseAlign=(O=e?.baseAlign)!==null&&O!==void 0?O:this.baseAlign,this.direction=(q=e?.direction)!==null&&q!==void 0?q:this.direction,this.lineHeight=(H=e?.lineHeight)!==null&&H!==void 0?H:this.lineHeight,this.quality=(N=e?.quality)!==null&&N!==void 0?N:this.quality,e?.shadow&&(this.shadow={},this.shadow.blur=($=e.shadow.blur)!==null&&$!==void 0?$:this.shadow.blur,this.shadow.offset=(Y=e.shadow.offset)!==null&&Y!==void 0?Y:this.shadow.offset,this.shadow.color=(J=e.shadow.color)!==null&&J!==void 0?J:this.shadow.color)}clone(){return new Ws({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(e,s,r){}_rotate(e){var s;const r=(s=this.origin)!==null&&s!==void 0?s:this._textBounds.center;e.translate(r.x,r.y),e.rotate(this.rotation),e.translate(-r.x,-r.y)}_flip(e){this.flipHorizontal&&(e.translate(this._textBounds.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,-this._textBounds.height/2/this.scale.y),e.scale(1,-1))}measureTextWithoutCache(e,s){return this._textMeasurement.measureText(e,s)}measureText(e,s){return Ft.measureText(e,this,s)}_postDraw(e){e.restore()}render(e,s,r,a,l,f){const p=Ft.getTextInstance(s,this,r);this._textBounds=p.dimensions,this._preDraw(e,a,l),p.render(e,a,l,f),this._postDraw(e)}}class er extends Kt{constructor(e){var s,r;super(e),this._text="",this._textWidth=0,this._textHeight=0,this.font=(s=e.font)!==null&&s!==void 0?s:new Ws,this.color=(r=e.color)!==null&&r!==void 0?r:this.color,this.text=e.text,this.maxWidth=e.maxWidth}clone(){var e,s;return new er({text:this.text.slice(),color:(s=(e=this.color)===null||e===void 0?void 0:e.clone())!==null&&s!==void 0?s:Q.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(e){this._text=e,this._calculateDimension()}get font(){return this._font}set font(e){this._font=e}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:e,height:s}=this.font.measureText(this._text,this.maxWidth);this._textWidth=e,this._textHeight=s}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(e){}_flip(e){}_preDraw(e,s,r){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(e,s,r)}_drawImage(e,s,r){var a;let l=Q.Black;this.font instanceof Ws&&(l=(a=this.color)!==null&&a!==void 0?a:this.font.color);const{width:f,height:p}=this.font.measureText(this._text,this.maxWidth);this._textWidth=f,this._textHeight=p,this.font.render(e,this._text,l,s,r,this.maxWidth),this.font.showDebug&&(e.debug.drawRect(s-f,r-p,f*2,p*2),this.maxWidth!=null&&e.debug.drawRect(s,r,this.maxWidth,this.height,{color:Q.Yellow}))}}function Ta(u){return!!u.tick}class te extends pi{get visible(){return this.isVisible}set visible(e){this.isVisible=e}get offset(){return this._offset}set offset(e){this._offset=new As(e,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(e){this._anchor=new As(e,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(e){if(e){this._color=e.clone();const s=this.graphics.current;(s instanceof bn||s instanceof er)&&(s.color=this._color)}}constructor(e){super(),this._logger=ot.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new As(B.Zero,()=>this.recalculateBounds()),this._anchor=new As(B.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,e={visible:this.isVisible,graphics:{},...e};const{current:s,anchor:r,color:a,opacity:l,visible:f,graphics:p,offset:m,copyGraphics:w,onPreDraw:y,onPostDraw:A,onPreTransformDraw:E,onPostTransformDraw:D}=e;for(const[L,O]of Object.entries(p))O instanceof Kt?this._graphics[L]=O:(this._graphics[L]=O.graphic,this._options[L]=O.options);this.offset=m??this.offset,this.opacity=l??this.opacity,this.anchor=r??this.anchor,this.color=a??this.color,this.copyGraphics=w??this.copyGraphics,this.onPreDraw=y??this.onPreDraw,this.onPostDraw=A??this.onPostDraw,this.onPreDraw=E??this.onPreTransformDraw,this.onPostTransformDraw=D??this.onPostTransformDraw,this.isVisible=!!f,this._current=s??this._current,s&&this._graphics[s]&&this.use(s)}getGraphic(e){return this._graphics[e]}getOptions(e){return this._options[e]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(e,s,r){let a="default",l=null,f;if(typeof e=="string"&&s instanceof Kt&&(a=e,l=s,f=r),e instanceof Kt&&!(s instanceof Kt)&&(l=e,f=s),!l)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[a]=this.copyGraphics?l.clone():l,this._options[a]=this.copyGraphics?{...f}:f,a==="default"&&this.use("default"),l}remove(e){delete this._graphics[e],delete this._options[e],this._current===e&&(this._current="default",this.recalculateBounds())}use(e,s){var r;if(e instanceof Kt){let a=e;this.copyGraphics&&(a=e.clone()),this._current="default",this._graphics[this._current]=a,this._options[this._current]=s}else this._current=e,this._options[this._current]=s,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(r=this.owner)===null||r===void 0?void 0:r.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(e){this._localBounds=e}recalculateBounds(){let e=new at;const s=this._graphics[this._current],r=this._options[this._current];if(!s){this._localBounds=e;return}let a=this.anchor,l=this.offset;r?.anchor&&(a=r.anchor),r?.offset&&(l=r.offset);const f=s.localBounds,p=-f.width*a.x+l.x,m=-f.height*a.y+l.y;s instanceof xn&&!s.useAnchor?e=s?.localBounds.combine(e):e=s?.localBounds.translate(z(p,m)).combine(e),this._localBounds=e}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let e=this.localBounds;if(this.owner){const s=this.owner.get(et);s&&(e=e.transform(s.get().matrix))}return e}update(e,s=0){const r=this.current;r&&Ta(r)&&r.tick(e,s)}clone(){const e=new te;return e._graphics={...this._graphics},e._options={...this._options},e.offset=this.offset.clone(),this.color&&(e.color=this.color.clone()),e.opacity=this.opacity,e.anchor=this.anchor.clone(),e.copyGraphics=this.copyGraphics,e.onPreDraw=this.onPreDraw,e.onPostDraw=this.onPostDraw,e.isVisible=this.isVisible,e}}var ro;(function(u){u.Kill="kill",u.PreKill="prekill",u.PostKill="postkill",u.PreDraw="predraw",u.PostDraw="postdraw",u.PreDebugDraw="predebugdraw",u.PostDebugDraw="postdebugdraw",u.PreUpdate="preupdate",u.PostUpdate="postupdate",u.PreFrame="preframe",u.PostFrame="postframe",u.PreCollision="precollision",u.CollisionStart="collisionstart",u.CollisionEnd="collisionend",u.PostCollision="postcollision",u.Initialize="initialize",u.Activate="activate",u.Deactivate="deactivate",u.ExitViewport="exitviewport",u.EnterViewport="enterviewport",u.ExitTrigger="exit",u.EnterTrigger="enter",u.Connect="connect",u.Disconnect="disconnect",u.Button="button",u.Axis="axis",u.Visible="visible",u.Hidden="hidden",u.Start="start",u.Stop="stop",u.PointerUp="pointerup",u.PointerDown="pointerdown",u.PointerMove="pointermove",u.PointerEnter="pointerenter",u.PointerLeave="pointerleave",u.PointerCancel="pointercancel",u.PointerWheel="pointerwheel",u.Up="up",u.Down="down",u.Move="move",u.Enter="enter",u.Leave="leave",u.Cancel="cancel",u.Wheel="wheel",u.Press="press",u.Release="release",u.Hold="hold",u.PointerDragStart="pointerdragstart",u.PointerDragEnd="pointerdragend",u.PointerDragEnter="pointerdragenter",u.PointerDragLeave="pointerdragleave",u.PointerDragMove="pointerdragmove",u.ActionStart="actionstart",u.ActionComplete="actioncomplete",u.Add="add",u.Remove="remove"})(ro||(ro={}));class mt{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(e){this._bubbles=e}stopPropagation(){this.bubbles=!1}}class oo extends mt{constructor(e){super(),this.self=e,this.target=e}}class Sa extends mt{constructor(e){super(),this.self=e,this.target=e}}class Ea extends mt{constructor(e){super(),this.self=e,this.target=e}}class Ia extends mt{constructor(e){super(),this.self=e,this.target=e}}class Ra extends mt{constructor(e){super(),this.self=e,this.target=e}}class An extends mt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class Cn extends mt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class Da extends mt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class Ma extends mt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class Fa extends mt{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class Ba extends mt{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class Cs extends mt{constructor(e,s,r){super(),this.engine=e,this.elapsed=s,this.self=r,this.target=r}}class Ps extends mt{constructor(e,s,r){super(),this.engine=e,this.elapsed=s,this.self=r,this.target=r}}class ka extends mt{constructor(e,s){super(),this.engine=e,this.prevStats=s,this.target=e}}class La extends mt{constructor(e,s){super(),this.engine=e,this.stats=s,this.target=e}}class Ua extends mt{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class za extends mt{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class Ha extends mt{constructor(e,s,r,a){super(),this.button=e,this.index=s,this.value=r,this.self=a,this.target=a}}class Oa extends mt{constructor(e,s,r){super(),this.axis=e,this.value=s,this.self=r,this.target=r}}class Wa extends mt{constructor(e){super(),this.self=e,this.target=e}}class Na extends mt{constructor(e){super(),this.self=e,this.target=e}}class Ns extends mt{constructor(e,s,r,a,l){super(),this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l,this.target=e}}class Gs extends mt{constructor(e,s,r,a,l){super(),this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l,this.target=e}}class ao{constructor(e,s,r,a){this.self=e,this.other=s,this.side=r,this.contact=a}}class ho{constructor(e,s,r,a){this.self=e,this.other=s,this.side=r,this.lastContact=a}}class lo{constructor(e,s,r,a,l){this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l}}class co{constructor(e,s,r,a,l){this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l}}class ir extends mt{constructor(e,s,r,a){super(),this.self=e,this.other=s,this.side=r,this.contact=a,this.target=e}}class sr extends mt{constructor(e,s,r,a){super(),this.self=e,this.other=s,this.side=r,this.lastContact=a,this.target=e}}class Pn extends mt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class Ga extends mt{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class Va extends mt{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class Xa extends mt{constructor(e){super(),this.self=e,this.target=e}}class qa extends mt{constructor(e){super(),this.self=e,this.target=e}}class Ya extends mt{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class ja extends mt{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class Za extends mt{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class Qa extends mt{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class $a extends mt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class Ka extends mt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class ap{constructor(e){this.data=e,this.type="Component Added"}}function hp(u){return!!u&&u.type==="Component Added"}class lp{constructor(e){this.data=e,this.type="Component Removed"}}function cp(u){return!!u&&u.type==="Component Removed"}const dp={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class Ue{constructor(e,s){this.id=Ue._ID++,this.name=`Entity#${this.id}`,this.events=new I,this._tags=new Set,this.componentAdded$=new Ve,this.componentRemoved$=new Ve,this.tagAdded$=new Ve,this.tagRemoved$=new Ve,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new Ve,this.childrenRemoved$=new Ve,this._children=[],this._isInitialized=!1,this._isAdded=!1;let r,a;if(Array.isArray(e))r=e,a=s;else if(e&&typeof e=="object"){const{components:l,name:f,silenceWarnings:p}=e;r=l??[],a=f}if(a&&(this.name=a),r)for(const l of r)this.addComponent(l)}get active(){return this.isActive}set active(e){this.isActive=e}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new oo(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(e){return this._tags.has(e)}addTag(e){return this._tags.add(e),this.tagAdded$.notifyAll(e),this}removeTag(e){return this._tags.delete(e),this.tagRemoved$.notifyAll(e),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(e){for(let s=0;s<e.length;s++)if(!this.components.has(e[s]))return!1;return!0}hasAllTags(e){for(let s=0;s<e.length;s++)if(!this.tags.has(e[s]))return!1;return!0}get(e){return this.components.get(e)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(e){if(e.parent===null){if(this.getAncestors().includes(e))throw new Error("Cycle detected, cannot add entity");this._children.push(e),e._parent=this,this.childrenAdded$.notifyAll(e)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(e){return e.parent===this&&(ts(e,this._children),e._parent=null,this.childrenRemoved$.notifyAll(e)),this}removeAllChildren(){for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);return this}getAncestors(){const e=[this];let s=this.parent;for(;s;)e.push(s),s=s.parent;return e.reverse()}getDescendants(){let e=[this],s=[this];for(;s.length>0;){const r=s.pop();r&&(s=s.concat(r.children),e=e.concat(r.children))}return e}clone(){const e=new Ue;for(const s of this.types){const r=this.get(s);r&&e.addComponent(r.clone())}for(const s of this.children)e.addChild(s.clone());return e}addTemplate(e,s=!1){for(const r of e.getComponents())this.addComponent(r.clone(),s);for(const r of e.children)this.addChild(r.clone().addTemplate(r));return this}_getClassHierarchyRoot(e){var s,r;let a=e,l=(s=Object.getPrototypeOf(a.prototype))===null||s===void 0?void 0:s.constructor;for(;l&&l!==Object&&l!==pi;)a=l,l=(r=Object.getPrototypeOf(a.prototype))===null||r===void 0?void 0:r.constructor;return a}addComponent(e,s=!1){if(this.has(e.constructor))if(s)this.removeComponent(e.constructor,!0);else return this;if(e.dependencies&&e.dependencies.length)for(const a of e.dependencies)this.addComponent(new a);e.owner=this;const r=this._getClassHierarchyRoot(e.constructor);return this.components.set(r,e),this.components.set(e.constructor,e),this.componentValues.push(e),e.onAdd&&e.onAdd(this),this.componentAdded$.notifyAll(e),this}removeComponent(e,s=!1){let r;if(Fc(e)?r=e:r=e.constructor,s){const a=this.components.get(r);if(a){this.componentRemoved$.notifyAll(a),a.owner=void 0,a.onRemove&&a.onRemove(this);const f=this.componentValues.indexOf(a);f>-1&&this.componentValues.splice(f,1)}const l=this._getClassHierarchyRoot(r);this.components.delete(l),this.components.delete(r)}else this._componentsToRemove.push(r);return this}clearComponents(){const e=this.types;for(const s of e)this.removeComponent(s)}processComponentRemoval(){for(const e of this._componentsToRemove)this.removeComponent(e,!0);this._componentsToRemove.length=0}has(e){return this.components.has(e)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(e){this.isInitialized||(this.onInitialize(e),this.events.emit("initialize",new Pn(e,this)),this._isInitialized=!0)}_add(e){!this.isAdded&&this.isActive&&(this.onAdd(e),this.events.emit("add",new $a(e,this)),this._isAdded=!0)}_remove(e){this.isAdded&&!this.isActive&&(this.onRemove(e),this.events.emit("remove",new Ka(e,this)),this._isAdded=!1)}_preupdate(e,s){this.events.emit("preupdate",new Cs(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new Ps(e,s,this)),this.onPostUpdate(e,s)}onInitialize(e){}onAdd(e){}onRemove(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s);for(const r of this.children)r.update(e,s);this._postupdate(e,s),this._remove(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}Ue._ID=0;class Dt extends pi{constructor(){super(...arguments),this.vel=B.Zero,this.acc=B.Zero,this.scaleFactor=B.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class Xe{static integrate(e,s,r,a){const l=a/1e3;s.vel.addEqual(r.scale(l,Xe._ACC)),e.pos.add(s.vel.scale(l,Xe._VEL),Xe._POS).addEqual(r.scale(.5*l*l,Xe._VEL_ACC)),s.angularVelocity+=s.torque*(1/s.inertia)*l;const f=e.rotation+s.angularVelocity*l;e.scale.add(s.scaleFactor.scale(l,this._SCALE_FACTOR),Xe._SCALE),e.get().setTransform(Xe._POS,f,Xe._SCALE)}}Xe._POS=new B(0,0),Xe._SCALE=new B(1,1),Xe._ACC=new B(0,0),Xe._VEL=new B(0,0),Xe._VEL_ACC=new B(0,0),Xe._SCALE_FACTOR=new B(0,0);class uo extends Ue{constructor(e){super({silenceWarnings:!0}),this.beginColor=Q.White,this.endColor=Q.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=Q.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=Ci.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new et),this.addComponent(this.motion=new Dt),this.addComponent(this.graphics=new te),this.configure(e)}registerEmitter(e){if(this._emitter=e,this.particleTransform===Ci.Global){const s=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(s),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(e){var s,r,a,l,f,p,m,w,y,A,E,D,L,O;this.particleTransform=(s=e.transform)!==null&&s!==void 0?s:this.particleTransform,this.life=(r=e.life)!==null&&r!==void 0?r:this.life,this.fade=(a=e.fade)!==null&&a!==void 0?a:this.fade,this.size=(l=e.size)!==null&&l!==void 0?l:this.size,this.endColor=(f=e.endColor)!==null&&f!==void 0?f:this.endColor.clone(),this.beginColor=(p=e.beginColor)!==null&&p!==void 0?p:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=e.graphic,this.graphics.opacity=(m=e.opacity)!==null&&m!==void 0?m:this.graphics.opacity,this.transform.pos=(w=e.pos)!==null&&w!==void 0?w:this.transform.pos,this.transform.rotation=(y=e.rotation)!==null&&y!==void 0?y:0,this.transform.scale=z(1,1),this.motion.vel=(A=e.vel)!==null&&A!==void 0?A:this.motion.vel,this.motion.angularVelocity=(E=e.angularVelocity)!==null&&E!==void 0?E:0,this.motion.acc=(D=e.acc)!==null&&D!==void 0?D:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(L=e.startSize)!==null&&L!==void 0?L:0,this.endSize=(O=e.endSize)!==null&&O!==void 0?O:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=at.fromDimension(this.size,this.size,B.Half),this.graphics.onPostDraw=q=>{q.save(),q.debug.drawPoint(z(0,0),{color:this._currentColor,size:this.size}),q.restore()})}kill(){var e;!((e=this._emitter)===null||e===void 0)&&e.isActive?this._emitter.removeParticle(this):super.kill()}update(e,s){this.life=this.life-s,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=j(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=j(this.sizeRate*s+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=j(this._currentColor.r+this._rRate*s,0,255),this._currentColor.g=j(this._currentColor.g+this._gRate*s,0,255),this._currentColor.b=j(this._currentColor.b+this._bRate*s,0,255),this._currentColor.a=this.graphics.opacity;let r=this.motion.acc;this.focus&&(r=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(s/1e3)),Xe.integrate(this.transform,this.motion,r,s)}}uo.DefaultConfig={beginColor:Q.White,endColor:Q.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var Ci;(function(u){u.Global="global",u.Local="local"})(Ci||(Ci={}));class Bc{constructor(){this.type="ex.particle",this.priority=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new Ke({gl:e,vertexSource:tp,fragmentSource:ep,onPreLink:r=>{e.transformFeedbackVaryings(r,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],e.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(e){const s=e.getAttribute(It.Filtering),r=s?wn(s):void 0,a=bi(e.getAttribute(It.WrappingX)),l=bi(e.getAttribute(It.WrappingY)),f=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);return e.removeAttribute("forceUpload"),p}draw(e,s){var r,a,l,f,p,m,w,y,A;const E=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const D=e.particle.transform===Ci.Local?this._context.getTransform():this._context.getTransform().multiply(e.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",D),this._shader.setUniformBoolean("fade",!!e.particle.fade),this._shader.setUniformBoolean("useTexture",!!e.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(r=e.particle.life)!==null&&r!==void 0?r:2e3),this._shader.setUniformFloat("deltaMs",s),this._shader.setUniformFloatVector("gravity",(a=e.particle.acc)!==null&&a!==void 0?a:z(0,0)),this._shader.setUniformFloatColor("beginColor",(l=e.particle.beginColor)!==null&&l!==void 0?l:Q.Transparent),this._shader.setUniformFloatColor("endColor",(f=e.particle.endColor)!==null&&f!==void 0?f:Q.Transparent);let L=(p=e.particle.startSize)!==null&&p!==void 0?p:0,O=(m=e.particle.endSize)!==null&&m!==void 0?m:0;const q=(w=e.particle.size)!==null&&w!==void 0?w:0;if(q>0&&(L=q,O=q),this._shader.setUniformFloat("startSize",L??10),this._shader.setUniformFloat("endSize",O??10),this._shader.setUniformFloat("startOpacity",(y=e.particle.opacity)!==null&&y!==void 0?y:1),e.particle.focus&&(this._shader.setUniformFloatVector("focus",e.particle.focus),this._shader.setUniformFloat("focusAccel",(A=e.particle.focusAccel)!==null&&A!==void 0?A:0)),e.particle.graphic){const H=e.particle.graphic,N=this._getTexture(H.image.image);E.activeTexture(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,N),this._shader.setUniformInt("graphic",0)}e.draw(E)}hasPendingDraws(){return!1}flush(){}dispose(){}}const up=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,fp=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class _p{constructor(e){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=Q.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=ya(e,r);this._maxTextures=Math.min(r,a);const l=this._transformFragmentSource(up,this._maxTextures);this._shader=new Ke({gl:e,fragmentSource:l,vertexSource:fp}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((A,E)=>E)),this._vao=e.createVertexArray(),e.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._meshBuffer),e.bufferData(e.ARRAY_BUFFER,this._quadMesh,e.STATIC_DRAW),e.vertexAttribPointer(0,2,e.FLOAT,!1,16,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,16,8),e.enableVertexAttribArray(1),e.bindBuffer(e.ARRAY_BUFFER,null);const f=this._components;this._transformData=new Li({gl:e,size:f*this._maxImages,type:"dynamic"}),this._transformData.bind();let p=0,m=2;const w=4,y=f*4;e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(2),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(3),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(4),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(5),p+=2*w,e.vertexAttribPointer(m++,1,e.FLOAT,!1,y,p),e.enableVertexAttribArray(6),p+=1*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(7),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(8),p+=2*w,e.vertexAttribPointer(m++,1,e.FLOAT,!1,y,p),e.enableVertexAttribArray(9),p+=1*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(10),p+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,p),e.enableVertexAttribArray(11),p+=2*w,e.vertexAttribPointer(m++,4,e.FLOAT,!1,y,p),e.enableVertexAttribArray(12),p+=4*w,e.vertexAttribDivisor(2,1),e.vertexAttribDivisor(3,1),e.vertexAttribDivisor(4,1),e.vertexAttribDivisor(5,1),e.vertexAttribDivisor(6,1),e.vertexAttribDivisor(7,1),e.vertexAttribDivisor(8,1),e.vertexAttribDivisor(9,1),e.vertexAttribDivisor(10,1),e.vertexAttribDivisor(11,1),e.vertexAttribDivisor(12,1),e.bindVertexArray(null)}_bindData(e){const s=this._components;this._transformData.bind(),this._transformData.upload(s*this._imageCount),e.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let r=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_texture_index <= ${l}.5) {
`:a+=`   else if (v_texture_index <= ${l}.5) {
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return r=r.replace("%%texture_picker%%",a),r}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(It.Filtering),r=s?wn(s):void 0,a=bi(e.getAttribute(It.WrappingX)),l=bi(e.getAttribute(It.WrappingY)),f=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&(this._textures.push(p),this._textureToIndex.set(p,this._textureIndex++),this._images.add(e))}_bindTextures(e){const s=Math.min(this._textureIndex,this._maxTextures);for(let r=0;r<s;r++)e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,this._textures[r]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const r=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(r))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,r,a,l,f,p,m,w){var y,A,E,D;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const L=this._getImageWidth(e),O=this._getImageHeight(e);let q=L||a||0,H=O||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(y=a??L)!==null&&y!==void 0?y:0,this._view[3]=(A=l??O)!==null&&A!==void 0?A:0,this._dest[0]=s??1,this._dest[1]=r??1,f!==void 0&&p!==void 0&&m!==void 0&&w!==void 0&&(this._view[0]=s??1,this._view[1]=r??1,this._view[2]=(E=a??L)!==null&&E!==void 0?E:0,this._view[3]=(D=l??O)!==null&&D!==void 0?D:0,this._dest[0]=f,this._dest[1]=p,q=m,H=w),s=this._view[0],r=this._view[1];const N=this._view[2],$=this._view[3],Y=this._context.getTransform(),J=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+_t),this._dest[1]=~~(this._dest[1]+_t));const Z=this._context.tint||this._defaultTint,ft=this._getTextureIdForImage(e),Tt=L||q,Gt=O||H,qt=(s+this.uvPadding)/Tt,Ce=(r+this.uvPadding)/Gt,$t=(s+N-this.uvPadding)/Tt,kt=(r+$-this.uvPadding)/Gt,Oe=L,De=O,it=this._transformData.bufferData;it[this._vertexIndex++]=this._dest[0],it[this._vertexIndex++]=this._dest[1],it[this._vertexIndex++]=Y.data[0],it[this._vertexIndex++]=Y.data[1],it[this._vertexIndex++]=Y.data[2],it[this._vertexIndex++]=Y.data[3],it[this._vertexIndex++]=Y.data[4],it[this._vertexIndex++]=Y.data[5],it[this._vertexIndex++]=J,it[this._vertexIndex++]=q,it[this._vertexIndex++]=H,it[this._vertexIndex++]=Oe,it[this._vertexIndex++]=De,it[this._vertexIndex++]=ft,it[this._vertexIndex++]=qt,it[this._vertexIndex++]=Ce,it[this._vertexIndex++]=$t,it[this._vertexIndex++]=kt,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._bindData(e),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),e.drawArraysInstanced(e.TRIANGLES,0,6,this._imageCount),Xt.DrawnImagesCount+=this._imageCount,Xt.DrawCallCount++,e.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const _t=1e-4;class pp{constructor(e){this._webglCtx=e,this._debugText=new xa}drawRect(e,s,r,a,l={color:Q.Black}){this.drawLine(z(e,s),z(e+r,s),{...l}),this.drawLine(z(e+r,s),z(e+r,s+a),{...l}),this.drawLine(z(e+r,s+a),z(e,s+a),{...l}),this.drawLine(z(e,s+a),z(e,s),{...l})}drawLine(e,s,r){var a;this._webglCtx.draw("ex.line",e,s,(a=r?.color)!==null&&a!==void 0?a:Q.Black)}drawPoint(e,s={color:Q.Black,size:5}){this._webglCtx.draw("ex.point",e,s.color,s.size)}drawText(e,s){this._debugText.write(this._webglCtx,e,s)}}class ss{get z(){return this._state.current.z}set z(e){this._state.current.z=e}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(e){let s=!0;return(e.width>4096||e.height>4096)&&(s=!1),s}constructor(e){this._logger=ot.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=b.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new Jr(()=>new K_,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new E_,this._state=new Pc,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=Q.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new pp(this),this._totalPostProcessorTime=0;const{canvasElement:s,context:r,enableTransparency:a,antialiasing:l,uvPadding:f,multiSampleAntialiasing:p,pixelArtSampler:m,powerPreference:w,snapToPixel:y,backgroundColor:A,useDrawSorting:E,garbageCollector:D,handleContextLost:L,handleContextRestored:O}=e;if(this.__gl=r??s.getContext("webgl2",{antialias:l??this.smoothing,premultipliedAlpha:!1,alpha:a??this.transparency,depth:!1,powerPreference:w??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");L&&this.__gl.canvas.addEventListener("webglcontextlost",L,!1),O&&this.__gl.canvas.addEventListener("webglcontextrestored",O,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new Jt(this.__gl,D),this.snapToPixel=y??this.snapToPixel,this.smoothing=l??this.smoothing,this.transparency=a??this.transparency,this.pixelArtSampler=m??this.pixelArtSampler,this.uvPadding=f??this.uvPadding,this.multiSampleAntialiasing=typeof p=="boolean"?p:this.multiSampleAntialiasing,this.samples=typeof p=="object"?p.samples:void 0,this.backgroundColor=A??this.backgroundColor,this.useDrawSorting=E??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const e of this._renderers.values())e.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const e=this.__gl;if(this._ortho=ni.ortho(0,e.canvas.width,e.canvas.height,0,400,-400),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.depthMask(!1),this.register(new X_({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new Mc),this.register(new j_),this.register(new $_),this.register(new H_),this.register(new L_),this.lazyRegister("ex.particle",()=>new Bc),this.register(new _p({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=e.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");e.bindTexture(e.TEXTURE_2D,this.materialScreenTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.bindTexture(e.TEXTURE_2D,null),this._screenRenderer=new N_(e),this._renderTarget=new Kr({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),this._postProcessTargets=[new Kr({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),new Kr({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height})],this._msaaTarget=new Kr({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(e){this._renderers.set(e.type,e),e.initialize(this.__gl,this)}lazyRegister(e,s){this._lazyRenderersFactory.set(e,s)}get(e){let s=this._renderers.get(e);if(!s){const r=this._lazyRenderersFactory.get(e);r&&(this._logger.debug("lazy init renderer:",e),s=r(),this.register(s))}return s}_isCurrentRenderer(e){return!this._currentRenderer||this._currentRenderer===e}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(e,...s){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${e}, the webgl context is lost`);return}const r=this.get(e);if(r)if(this.useDrawSorting){const a=this._drawCallPool.get();a.z=this._state.current.z,a.priority=r.priority,a.renderer=e,this.getTransform().clone(a.transform),a.state.z=this._state.current.z,a.state.opacity=this._state.current.opacity,a.state.tint=this._state.current.tint,a.state.material=this._state.current.material,a.args[0]=s[0],a.args[1]=s[1],a.args[2]=s[2],a.args[3]=s[3],a.args[4]=s[4],a.args[5]=s[5],a.args[6]=s[6],a.args[7]=s[7],a.args[8]=s[8],a.args[9]=s[9],this._drawCalls[this._drawCallIndex++]=a}else this._currentRenderer||(this._currentRenderer=r),this._isCurrentRenderer(r)||this._currentRenderer.flush(),r.draw(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9]),this._currentRenderer=r;else throw Error(`No renderer with name ${e} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(e){const s=this.__gl;this._ortho=this._ortho=ni.ortho(0,e.width,e.height,0,400,-400),this._renderTarget.setResolution(s.canvas.width,s.canvas.height),this._msaaTarget.setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[0].setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[1].setResolution(s.canvas.width,s.canvas.height)}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}drawImage(e,s,r,a,l,f,p,m,w){if(!(a===0||l===0)){{if(m===0||w===0)return;if(this._getImageWidth(e)===0||this._getImageHeight(e)===0)return}if(!e){ot.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",e,s,r,a,l,f,p,m,w):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,e,s,r,a,l,f,p,m,w):this.draw(this.imageRenderer,e,s,r,a,l,f,p,m,w)}}drawLine(e,s,r,a=1){this.draw("ex.rectangle",e,s,r,a)}drawRectangle(e,s,r,a,l,f){this.draw("ex.rectangle",e,s,r,a,l,f)}drawCircle(e,s,r,a,l){this.draw("ex.circle",e,s,r,a,l)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(e,s){this._transform.translate(this.snapToPixel?~~(e+_t):e,this.snapToPixel?~~(s+_t):s)}rotate(e){this._transform.rotate(e)}scale(e,s){this._transform.scale(e,s)}transform(e){this._transform.current=e}getTransform(){return this._transform.current}multiply(e){this._transform.current.multiply(e,this._transform.current)}addPostProcessor(e){this._postprocessors.push(e),e.initialize(this.__gl)}removePostProcessor(e){const s=this._postprocessors.indexOf(e);s!==-1&&this._postprocessors.splice(s,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(e){for(const s of this._postprocessors){const r=s.getShader();r.use();const a=r.getUniforms();this._totalPostProcessorTime+=e,a.find(l=>l.name==="u_time_ms")&&r.setUniformFloat("u_time_ms",this._totalPostProcessorTime),a.find(l=>l.name==="u_elapsed_ms")&&r.setUniformFloat("u_elapsed_ms",e),a.find(l=>l.name==="u_resolution")&&r.setUniformFloatVector("u_resolution",z(this.width,this.height)),s.onUpdate&&s.onUpdate(e)}}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return new Dc({...e,graphicsContext:this})}createShader(e){const s=this.__gl,{vertexSource:r,fragmentSource:a}=e,l=new Ke({gl:s,vertexSource:r,fragmentSource:a});return l.compile(),l}clear(){const e=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT)}flush(){var e;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let s=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(s.use(),this.useDrawSorting){for(let f=this._drawCallIndex;f<this._drawCalls.length;f++)this._drawCalls[f]=null;const r=new Map;for(const[f]of this._renderers){let p=0;for(p=0;p<this._drawCallIndex&&this._drawCalls[p].renderer!==f;p++);r.set(f,p)}this._drawCalls.sort((f,p)=>{if(f===null||p===null)return 0;const m=f.z-p.z,w=r.get(f.renderer)-r.get(p.renderer),y=f.priority-p.priority;return m===0?y===0?w:y:m});const a=this._transform.current,l=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let f=this._drawCalls[0].renderer,p=this.get(f);for(let m=0;m<this._drawCallIndex;m++)this._transform.current=this._drawCalls[m].transform,this._state.current=this._drawCalls[m].state,this._drawCalls[m].renderer!==f&&(p.flush(),f=this._drawCalls[m].renderer,p=this.get(f)),p instanceof Mc&&(!((e=this.material)===null||e===void 0)&&e.isUsingScreenTexture)&&(s.copyToTexture(this.materialScreenTexture),s.use()),p.draw(...this._drawCalls[m].args);p.hasPendingDraws()&&p.flush()}this._transform.current=a,this._state.current=l,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const r of this._renderers.values())r.hasPendingDraws()&&r.flush();s.disable(),this._postprocessors.length>0&&s.toRenderSource().use();for(let r=0;r<this._postprocessors.length;r++)s=this._postProcessTargets[r%2],this._postProcessTargets[r%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[r]),this._postProcessTargets[r%2].toRenderSource().use();s.blitToScreen()}}const re=1e-4;class gp{constructor(e){this._ex=e,this._debugText=new xa}drawRect(e,s,r,a){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(e+re):e,this._ex.snapToPixel?~~(s+re):s,this._ex.snapToPixel?~~(r+re):r,this._ex.snapToPixel?~~(a+re):a),this._ex.__ctx.restore()}drawLine(e,s,r={color:Q.Black}){var a,l;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(l=(a=r.color)===null||a===void 0?void 0:a.toString())!==null&&l!==void 0?l:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(e.x+re):e.x,this._ex.snapToPixel?~~(e.y+re):e.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(s.x+re):s.x,this._ex.snapToPixel?~~(s.y+re):s.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(e,s={color:Q.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=s.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(e.x+re):e.x,this._ex.snapToPixel?~~(e.y+re):e.y,s.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(e,s){this._debugText.write(this._ex,e,s)}}class fo{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(e){this.__ctx.imageSmoothingEnabled=e}constructor(e){this.useDrawSorting=!1,this.z=0,this.backgroundColor=Q.ExcaliburBlue,this._state=new Pc,this.snapToPixel=!1,this.debug=new gp(this);const{canvasElement:s,context:r,enableTransparency:a,snapToPixel:l,antialiasing:f,backgroundColor:p}=e;if(this.__ctx=r??s.getContext("2d",{alpha:a??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=p??this.backgroundColor,this.snapToPixel=l??this.snapToPixel,this.smoothing=f??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(e){}drawImage(e,s,r,a,l,f,p,m,w){if(a===0||l===0)return;if(m===0||w===0)return;if(e.width===0||e.height===0)return;this.__ctx.globalAlpha=this.opacity;const y=[e,s,r,a,l,f,p,m,w].filter(A=>A!==void 0).map(A=>typeof A=="number"&&this.snapToPixel?~~A:A);this.__ctx.drawImage.apply(this.__ctx,y),Xt.DrawCallCount++,Xt.DrawnImagesCount=1}drawLine(e,s,r,a=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=r.toString(),this.__ctx.moveTo(this.snapToPixel?~~(e.x+re):e.x,this.snapToPixel?~~(e.y+re):e.y),this.__ctx.lineTo(this.snapToPixel?~~(s.x+re):s.x,this.snapToPixel?~~(s.y+re):s.y),this.__ctx.lineWidth=a,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(e,s,r,a){this.__ctx.save(),this.__ctx.fillStyle=a.toString(),this.__ctx.fillRect(this.snapToPixel?~~(e.x+re):e.x,this.snapToPixel?~~(e.y+re):e.y,this.snapToPixel?~~(s+re):s,this.snapToPixel?~~(r+re):r),this.__ctx.restore()}drawCircle(e,s,r,a,l){this.__ctx.save(),this.__ctx.beginPath(),a&&(this.__ctx.strokeStyle=a.toString()),l&&(this.__ctx.lineWidth=l),this.__ctx.fillStyle=r.toString(),this.__ctx.arc(this.snapToPixel?~~(e.x+re):e.x,this.snapToPixel?~~(e.y+re):e.y,s,0,Math.PI*2),this.__ctx.fill(),a&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(e,s){this.__ctx.translate(this.snapToPixel?~~(e+re):e,this.snapToPixel?~~(s+re):s)}rotate(e){this.__ctx.rotate(e)}scale(e,s){this.__ctx.scale(e,s)}getTransform(){throw new Error("Not implemented")}multiply(e){this.__ctx.setTransform(this.__ctx.getTransform().multiply(e.toDOMMatrix()))}addPostProcessor(e){}removePostProcessor(e){}clearPostProcessors(){}updatePostProcessors(e){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),Xt.clear()}flush(){}dispose(){this.__ctx=void 0}}var be;(function(u){u.Fixed="Fixed",u.FitContainerAndFill="FitContainerAndFill",u.FitScreenAndFill="FitScreenAndFill",u.FitContainerAndZoom="FitContainerAndZoom",u.FitScreenAndZoom="FitScreenAndZoom",u.FitScreen="FitScreen",u.FillScreen="FillScreen",u.FitContainer="FitContainer",u.FillContainer="FillContainer"})(be||(be={}));class Ja{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const mp={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class th{constructor(e){var s,r,a,l;this.events=new I,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=ot.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const f=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(f),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new at,this._unsafeArea=new at,this.viewport=e.viewport,this.resolution=(s=e.resolution)!==null&&s!==void 0?s:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(r=e.displayMode)!==null&&r!==void 0?r:be.Fixed,this._canvas=e.canvas,this.graphicsContext=e.context,this._antialiasing=(a=e.antialiasing)!==null&&a!==void 0?a:this._antialiasing,this._canvasImageRendering=(l=e.canvasImageRendering)!==null&&l!==void 0?l:this._canvasImageRendering,this._browser=e.browser,this._pixelRatioOverride=e.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const e=this.worldToPageCoordinates(B.Zero);return this.worldToPageCoordinates(z(1,0)).sub(e).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(e){this._pixelRatioOverride=e}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case be.FillContainer:case be.FitContainer:case be.FitContainerAndFill:case be.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(e){this._resolution=e}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(e){this._viewport=e}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(e){this._camera=e}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof ss&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let a=Math.max(1,this.pixelRatio-.5),l=!1;for(;a>1&&!l;){a=Math.max(1,a-.5);const f=this._resolution.width*a,p=this._resolution.height*a;l=this.graphicsContext.checkIfResolutionSupported({width:f,height:p})}this.pixelRatioOverride=a,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const e=this.viewport.widthUnit==="percent"?"%":"px",s=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+e,this._canvas.style.height=this.viewport.height+s,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof fo&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(e){this._antialiasing=e,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(e){return this.enterFullscreen(e)}enterFullscreen(e){var s,r,a,l,f,p;if(e){const m=document.getElementById(e);if(m?.requestFullscreen||m?.webkitRequestFullscreen){if(m.getAttribute("ex-fullscreen-listener")||(m.setAttribute("ex-fullscreen-listener","true"),m.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),m.requestFullscreen)return(s=m.requestFullscreen())!==null&&s!==void 0?s:Promise.resolve();if(m.webkitRequestFullscreen)return(r=m.webkitRequestFullscreen())!==null&&r!==void 0?r:Promise.resolve()}}return!((a=this._canvas)===null||a===void 0)&&a.requestFullscreen?(f=(l=this._canvas)===null||l===void 0?void 0:l.requestFullscreen())!==null&&f!==void 0?f:Promise.resolve():this._canvas.webkitRequestFullscreen?(p=this._canvas.webkitRequestFullscreen())!==null&&p!==void 0?p:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(e){return{width:e.widthUnit==="percent"?this.canvas.offsetWidth:e.width,height:e.heightUnit==="percent"?this.canvas.offsetHeight:e.height}}pageToScreenCoordinates(e){let s=e.x,r=e.y;this._isFullscreen||(s-=ys(this._canvas).x,r-=ys(this._canvas).y);const a=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,f=(window.innerHeight-l)/2;r=(r-f)/l*a.height,s=s/window.innerWidth*a.width}else{const l=window.innerHeight*this.aspectRatio,f=(window.innerWidth-l)/2;s=(s-f)/l*a.width,r=r/window.innerHeight*a.height}return s=s/a.width*this.resolution.width,r=r/a.height*this.resolution.height,s=s-this.contentArea.left,r=r-this.contentArea.top,new B(s,r)}screenToPageCoordinates(e){let s=e.x,r=e.y;const a=this._viewportToPixels(this.viewport);if(s=s/this.resolution.width*a.width,r=r/this.resolution.height*a.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,f=(window.innerHeight-l)/2;r=r/a.height*l+f,s=s/a.width*window.innerWidth}else{const l=window.innerHeight*this.aspectRatio,f=(window.innerWidth-l)/2;s=s/a.width*l+f,r=r/a.height*window.innerHeight}return this._isFullscreen||(s+=ys(this._canvas).x,r+=ys(this._canvas).y),new B(s,r)}screenToWorldCoordinates(e){return e=e.add(z(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(e):e.sub(z(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(e){return this._camera?this._camera.transform.multiply(e):e.add(z(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(e){const s=this.pageToScreenCoordinates(e);return this.screenToWorldCoordinates(s)}worldToPageCoordinates(e){const s=this.worldToScreenCoordinates(e);return this.screenToPageCoordinates(s)}getWorldBounds(){return at.fromDimension(this.resolution.width,this.resolution.height,B.Half).scale(z(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return at.fromDimension(this.resolution.width,this.resolution.height,B.Zero,B.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return z(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=this.aspectRatio;let s=0,r=0;window.innerWidth/e<window.innerHeight?(s=window.innerWidth,r=window.innerWidth/e):(s=window.innerHeight*e,r=window.innerHeight),this.viewport={width:s,height:r},this._contentArea=at.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this._unsafeArea=at.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndFill(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(e,s,r){if(this.viewport=r??{width:e,height:s},e/s<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:e*this._contentResolution.width/e,height:e*this._contentResolution.width/e*s/e};const a=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new at({top:a,left:0,right:this._contentResolution.width,bottom:this.resolution.height-a}),this._unsafeArea=new at({top:-a,left:0,right:this._contentResolution.width,bottom:this.resolution.height+a})}else{this.resolution={width:s*this._contentResolution.height/s*e/s,height:s*this._contentResolution.height/s};const a=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new at({top:0,left:a,right:this.resolution.width-a,bottom:this._contentResolution.height}),this._unsafeArea=new at({top:0,left:-a,right:this.resolution.width+a,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndZoom(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const e=this.canvas.parentElement;e.style.overflow="hidden";const{offsetWidth:s,offsetHeight:r}=this.canvas;this._computeFitAndZoom(s,r),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(e,s){const r=this.aspectRatio;let a=0,l=0;e/r<s?(a=e,l=e/r):(a=s*r,l=s);const f=e/a,p=s/l,m=Math.max(f,p),w=a*m,y=l*m;w>e?this.canvas.style.left=-(w-e)/2+"px":this.canvas.style.left="",y>s?this.canvas.style.top=-(y-s)/2+"px":this.canvas.style.top="",this.viewport={width:w,height:y};const A=at.fromDimension(this.viewport.width,this.viewport.height,B.Zero);if(this.viewport.width>e){const E=(this.viewport.width-e)/this.viewport.width*this.resolution.width;A.top=0,A.left=E/2,A.right=this.resolution.width-E/2,A.bottom=this.resolution.height}if(this.viewport.height>s){const E=(this.viewport.height-s)/this.viewport.height*this.resolution.height;A.top=E/2,A.left=0,A.bottom=this.resolution.height-E/2,A.right=this.resolution.width}this._contentArea=A}_computeFitContainer(){const e=this.aspectRatio;let s=0,r=0,a="pixel",l="pixel";const f=this.canvas.parentElement;f.clientWidth/e<f.clientHeight?(this.canvas.style.width="100%",s=100,a="percent",r=this.canvas.offsetWidth/e):(this.canvas.style.height="100%",r=100,l="percent",s=this.canvas.offsetHeight*e),this.viewport={width:s,widthUnit:a,height:r,heightUnit:l},this._contentArea=at.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(e){this.displayMode===be.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===be.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:e.innerWidth,height:e.innerHeight},this.viewport=this.resolution),this._contentArea=at.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.displayMode===be.FitScreen&&this._computeFit(),this.displayMode===be.FitContainer&&this._computeFitContainer(),this.displayMode===be.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===be.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===be.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===be.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class nr{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function vp(u){return!!u.playbackState}class Vs{static unlock(){return new Promise((s,r)=>{if(Vs._UNLOCKED||!nr.create())return s(!0);const a=setTimeout(()=>{ot.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),s(!1)},200),l=nr.create();l.resume().then(()=>{const f=l.createBuffer(1,1,22050),p=l.createBufferSource();let m=!1;p.buffer=f,p.connect(l.destination),p.onended=()=>m=!0,p.start(0),setTimeout(()=>{vp(p)?(p.playbackState===p.PLAYING_STATE||p.playbackState===p.FINISHED_STATE)&&(Vs._UNLOCKED=!0):(l.currentTime>0||m)&&(Vs._UNLOCKED=!0)},0),clearTimeout(a),s(!0)},()=>{r()})})}static isUnlocked(){return this._UNLOCKED}}Vs._UNLOCKED=!1;class _o extends bn{get ctx(){return this._ctx}constructor(e={}){super(e),this._options=e}clone(){return new _o({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){var s,r;!((s=this._options)===null||s===void 0)&&s.draw&&((r=this._options)===null||r===void 0||r.draw(e)),this._options.cache||this.flagDirty()}}class eh{}eh.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class po{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(e){this._currentState=e}static create(e,s){const r=new po;r.data=s;for(const a in e.states)r.states.set(a,{name:a,...e.states[a]});for(const a of r.states.values())for(const l of a.transitions)if(l!=="*"&&!r.states.has(l))throw Error(`Invalid state machine, state [${a.name}] has a transition to another state that doesn't exist [${l}]`);return r.currentState=r.startState=r.states.get(e.start),r}in(e){return this.currentState.name===e}go(e,s){var r,a;if(this.currentState.transitions.includes(e)||this.currentState.transitions.includes("*")){const l=this.states.get(e);return this.currentState.onExit&&((r=this.currentState)===null||r===void 0?void 0:r.onExit({to:l.name,data:this.data}))===!1||l?.onEnter&&l?.onEnter({from:this.currentState.name,eventData:s,data:this.data})===!1?!1:(this.currentState=l,!((a=this.currentState)===null||a===void 0)&&a.onState&&this.currentState.onState(),!0)}return!1}update(e){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,e)}save(e){localStorage.setItem(e,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(e){const s=JSON.parse(localStorage.getItem(e));this.currentState=this.states.get(s.currentState),this.data=s.data}}class kc{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(e){this._loop=e,this._instance&&(this._instance.loop=e,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(e){e=j(e,0,1),this._volume=e,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(e,this._audioContext.currentTime,.1):this._volumeNode.gain.value=e}get volume(){return this._volume}get duration(){var e;return(e=this._duration)!==null&&e!==void 0?e:this.getTotalPlaybackDuration()}set duration(e){this._duration=e}constructor(e){this._src=e,this._audioContext=nr.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new T,this._stateMachine=po.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:s})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,s.pausedAt*this._playbackRate):this._instance.start(0,s.pausedAt*this._playbackRate,this.duration),s.startedAt=this._audioContext.currentTime-s.pausedAt,s.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:s})=>{s==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:s,data:r})=>{r.pausedAt=(s??0)/this._playbackRate,r.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:s})=>{s.pausedAt=0,s.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:s})=>{s.pausedAt=this._audioContext.currentTime-s.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(e=()=>{}){return this._playStarted=e,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(e){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",e)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:e,startedAt:s}=this._stateMachine.data;return e?e*this._playbackRate:s?(this._audioContext.currentTime-s)*this._playbackRate:0}set playbackRate(e){this._instance.playbackRate.value=this._playbackRate=e}get playbackRate(){return this._instance.playbackRate.value}}class ih extends mt{set bubbles(e){}get bubbles(){return!1}get _path(){return null}set _path(e){}constructor(e,s="MediaEvent"){super(),this.target=e,this._name=s}stopPropagation(){}action(){}propagate(){}layPath(e){}}class Xs extends ih{constructor(e,s){super(e,"NativeSoundEvent"),this.track=s}}class Lc extends ih{constructor(e,s){super(e,"NativeSoundProcessedEvent"),this._processedData=s,this.data=this._processedData}}function wp(u){try{const e=new Audio,s=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,r=u.match(s)[1];return!!e.canPlayType("audio/"+r)}catch(e){return ot.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",e),!1}}const xp={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class Uc{set loop(e){this._loop=e;for(const s of this._tracks)s.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(e){this._volume=e;for(const s of this._tracks)s.volume=this._volume;this.events.emit("volumechange",new Xs(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(e){this._duration=e}get instances(){return this._tracks}get path(){return this._resource.path}set path(e){this._resource.path=e}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}constructor(...e){this.events=new I,this.logger=ot.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=nr.create(),this._resource=new $n("",eh.type.arraybuffer);for(const s of e)if(wp(s)){this.path=s;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",e.join(", ")),this.logger.warn("Attempting to use",e[0]),this.path=e[0])}isLoaded(){return!!this.data}async load(){var e,s;if(this.data)return this.data;const r=await this._resource.load(),a=await this.decodeAudio(r.slice(0));return this._duration=(s=(e=this._duration)!==null&&e!==void 0?e:a?.duration)!==null&&s!==void 0?s:void 0,this.events.emit("processed",new Lc(this,a)),this.data=a}async decodeAudio(e){try{return await this._audioContext.decodeAudioData(e.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(e){e&&(this._engine=e,this._engine.on("hidden",()=>{e.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{e.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(e=>e.isPlaying())}isPaused(){return this._tracks.some(e=>e.isPaused())}isStopped(){return this._tracks.some(e=>e.isStopped())}play(e){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=e||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const e of this._tracks)e.pause();this.events.emit("pause",new Xs(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const e of this._tracks)e.stop();this.events.emit("stop",new Xs(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._tracks.forEach(s=>{s.playbackRate=this._playbackRate})}seek(e,s=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[s].seek(e)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(e=0){return this._tracks.length?this._tracks[e].getPlaybackPosition():0}getTrackId(e){return this._tracks.indexOf(e)}async _resumePlayback(){if(this.isPaused()){const e=[];for(const s of this._tracks)e.push(s.play().then(()=>(this._tracks.splice(this.getTrackId(s),1),!0)));this.events.emit("resume",new Xs(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(e)}return!0}async _startPlayback(){const e=this._getTrackInstance(this.data),s=await e.play(()=>{this.events.emit("playbackstart",new Xs(this,e)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new Xs(this,e));const r=this.getTrackId(e);return r!==-1&&this._tracks.splice(r,1),s}_getTrackInstance(e){var s;const r=new kc(e);return r.loop=this.loop,r.volume=this.volume,r.duration=(s=this.duration)!==null&&s!==void 0?s:0,r.playbackRate=this._playbackRate,this._tracks.push(r),r}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const bp={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function sh(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class rr{get resources(){return this._resources}constructor(e){var s;this.events=new I,this.canvas=new _o({filtering:ce.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new T,e&&(!((s=e.loadables)===null||s===void 0)&&s.length)&&this.addResources(e.loadables)}onInitialize(e){this.engine=e,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await jr(500,this.engine.clock)}addResource(e){this._resources.push(e)}addResources(e){let s=0;const r=e.length;for(s;s<r;s++)this.addResource(e[s])}markResourceComplete(){this._numLoaded++}get progress(){const e=this._resources.length;return e>0?j(this._numLoaded,0,e)/e:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(e,s){this._totalTimeMs+=s}onDraw(e){const s=this._totalTimeMs/1e3;e.fillStyle=Q.Black.toRGBA(),e.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),e.save(),e.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const r=s*10;e.strokeStyle="white",e.lineWidth=10,e.lineCap="round",e.arc(0,0,40,r,r+Math.PI*3/2),e.stroke(),e.fillStyle="white",e.font="16px sans-serif";const a=(this.progress*100).toFixed(0)+"%",l=e.measureText(a),f=Math.abs(l.actualBoundingBoxLeft)+Math.abs(l.actualBoundingBoxRight),p=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);e.fillText(a,-f/2,p/2),e.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async e=>{this.events.emit("loadresourcestart",e),await e.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",e)})}));for(const e of this._resources)e instanceof Uc&&e.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await Vs.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const yp="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var Ap=o(851);class qs extends rr{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const e=document.getElementById("excalibur-play-root");return e&&(this._playButtonRootElement=e),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(e){const s=Array.isArray(e)?{loadables:e}:e;super(s),this._logger=ot.getInstance(),this._originalOptions={loadables:[]},this.events=new I,this._playButtonShown=!1,this.logo=yp,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=Q.White,this.backgroundColor="#176BAA",this._imageLoaded=new T,this.suppressPlayButton=!1,this._playButtonStyles=Ap.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let r=document.getElementById("excalibur-play");return r||(r=document.createElement("button")),r.id="excalibur-play",r.textContent=this.playButtonText,r.style.display="none",r},this._originalOptions={...qs._DEFAULT_LOADER_OPTIONS,...s}}onInitialize(e){this.engine=e,this.screen=e.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var e,s;if(this.suppressPlayButton)this.hidePlayButton(),await jr(500,(e=this.engine)===null||e===void 0?void 0:e.clock);else{const r=()=>{try{this._positionPlayButton()}catch{}};return!((s=this.engine)===null||s===void 0)&&s.browser&&this.engine.browser.window.on("resize",r),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",l=>{l.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(l=>{const f=p=>{var m;if(p.stopPropagation(),this.hidePlayButton(),!((m=this.engine)===null||m===void 0)&&m.browser&&this.engine.browser.window.off("resize",r),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(w){this._logger.error("could not go fullscreen",w)}l()};this._playButton.addEventListener("click",f),this._playButton.addEventListener("touchend",f),this._playButton.addEventListener("pointerup",f),this.engine&&this.engine.input.gamepads.once("button",()=>f(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var e;await jr(200,(e=this.engine)===null||e===void 0?void 0:e.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const e=this._image;await this._imageLoaded.promise,await e?.decode()}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:e,y:s,width:r,height:a}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const l=this._playButton.clientWidth,f=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${e+r/2-l/2}px`,this._playButtonRootElement.style.top=`${s+a/2-f/2+100}px`)}}}onDraw(e){const s=this.engine.canvasHeight/this.engine.pixelRatio,r=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),e.fillStyle=this.backgroundColor,e.fillRect(0,0,r,s);let a=s/2;const l=Math.min(this.logoWidth,r*.75);let f=r/2-l/2;this.logoPosition&&(f=this.logoPosition.x,a=this.logoPosition.y);const p=Math.floor(l*(this.logoHeight/this.logoWidth)),m=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,f,a,l,p):e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,f,a-p-20,l,p),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=m;return}let w=f,y=a;this.loadingBarPosition&&(w=this.loadingBarPosition.x,y=this.loadingBarPosition.y),e.lineWidth=2,Pa(e,w,y,l,20,10,this.loadingBarColor);const A=l*this.progress,E=5,D=A-E*2,L=20-E*2;Pa(e,w+E,y+E,D>10?D:10,L,5,null,this.loadingBarColor),this.engine.screen.antialiasing=m}}qs._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const zc={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class Hc{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("2d"))},arrayBufferSupport:function(){const e=new XMLHttpRequest;e.open("GET","/");try{e.responseType="arraybuffer"}catch{return!1}return e.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const e=document.createElement("a").style;return e.cssText="background-color:rgba(150,255,150,.5)",(""+e.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let e=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const s=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],r=this.getBrowserFeatures();for(const a of Object.keys(zc))r[a]?(e+="(%c✓%c)",s.push("font-weight: bold; color: green"),s.push("font-weight: normal; color: inherit")):(e+="(%c✗%c)",s.push("font-weight: bold; color: red"),s.push("font-weight: normal; color: inherit")),e+=" "+zc[a]+`
`;s.unshift(e),console.log.apply(console,s)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let e=!1;for(const s in this._criticalTests)this._criticalTests[s].call(this)||(this.failedTests.push(s),ot.getInstance().error("Critical browser feature missing, Excalibur requires:",s),e=!0);if(e)return!1;for(const s in this._warningTest)this._warningTest[s]()||ot.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",s);return!0}}var dt;(function(u){u.PreventCollision="PreventCollision",u.Passive="Passive",u.Active="Active",u.Fixed="Fixed"})(dt||(dt={}));class Ui{static create(e,s){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(e)){const a=this._GROUPS.get(e);if(a.mask===s)return a;throw new Error(`Collision group ${e} already exists with a different mask!`)}const r=new ns(e,this._CURRENT_BIT,s!==void 0?s:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(e,r),r}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(e){return this._GROUPS.get(e)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}Ui._STARTING_BIT=1,Ui._MAX_GROUPS=32,Ui._CURRENT_GROUP=1,Ui._CURRENT_BIT=Ui._STARTING_BIT,Ui._GROUPS=new Map;class ns{constructor(e,s,r){this._name=e,this._category=s,this._mask=r}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(e){const s=this.category&e.mask,r=this.mask&e.category;return s!==0&&r!==0}invert(){const e=Ui.create("~("+this.name+")",~this.mask|0);return e._category=~this.category,e}static combine(e){const s=e.map(l=>l.name).join("+"),a=~e.reduce((l,f)=>f.category|l,0);return Ui.create(s,a)}static collidesWith(e){const s=`collidesWith(${e.map(a=>a.name).join("+")})`,r=e.reduce((a,l)=>l.category|a,0);return Ui.create(s,r)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}ns.All=new ns("Collide with all groups",-1,-1);class qe{constructor(e,s){this.colliderA=e,this.colliderB=s,this.id=null,this.id=qe.calculatePairHash(e.id,s.id)}static canCollide(e,s){var r,a;if(e.id===s.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.localBounds.hasZeroDimensions()||s.localBounds.hasZeroDimensions())return!1;const l=(r=e?.owner)===null||r===void 0?void 0:r.get(Ct),f=(a=s?.owner)===null||a===void 0?void 0:a.get(Ct);return!(!l||!f||!l.group.canCollide(f.group)||l.collisionType===dt.Fixed&&f.collisionType===dt.Fixed||f.collisionType===dt.PreventCollision||l.collisionType===dt.PreventCollision||!l.isActive||!f.isActive)}get canCollide(){const e=this.colliderA,s=this.colliderB;return qe.canCollide(e,s)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(e){return e===this.colliderA||e===this.colliderB}static calculatePairHash(e,s){return e.value<s.value?`#${e.value}+${s.value}`:`#${s.value}+${e.value}`}}class or{constructor(e,s){this.min=e,this.max=s}overlaps(e){return this.max>e.min&&e.max>this.min}getOverlap(e){return this.overlaps(e)?this.max>e.max?e.max-this.min:this.max-e.min:0}}class nh{constructor(e){this.parent=e,this.parent=e||null,this.data=null,this.bounds=new at,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class rh{constructor(e,s=new at(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=e,this.worldBounds=s,this.root=null,this.nodes={}}_insert(e){if(this.root===null){this.root=e,this.root.parent=null;return}const s=e.bounds;let r=this.root;for(;!r.isLeaf();){const p=r.left,m=r.right,w=r.bounds.getPerimeter(),A=r.bounds.combine(s).getPerimeter(),E=2*A,D=2*(A-w);let L=0;const O=s.combine(p.bounds);let q,H;p.isLeaf()?L=O.getPerimeter()+D:(H=p.bounds.getPerimeter(),q=O.getPerimeter(),L=q-H+D);let N=0;const $=s.combine(m.bounds);if(m.isLeaf()?N=$.getPerimeter()+D:(H=m.bounds.getPerimeter(),q=$.getPerimeter(),N=q-H+D),E<L&&E<N)break;L<N?r=p:r=m}const a=r.parent,l=new nh(a);l.bounds=s.combine(r.bounds),l.height=r.height+1,a!==null?(a.left===r?a.left=l:a.right=l,l.left=r,l.right=e,r.parent=l,e.parent=l):(l.left=r,l.right=e,r.parent=l,e.parent=l,this.root=l);let f=e.parent;for(;f;){if(f=this._balance(f),!f.left)throw new Error("Parent of current leaf cannot have a null left child"+f);if(!f.right)throw new Error("Parent of current leaf cannot have a null right child"+f);f.height=1+Math.max(f.left.height,f.right.height),f.bounds=f.left.bounds.combine(f.right.bounds),f=f.parent}}_remove(e){if(e===this.root){this.root=null;return}const s=e.parent,r=s.parent;let a;if(s.left===e?a=s.right:a=s.left,r){r.left===s?r.left=a:r.right=a,a.parent=r;let l=r;for(;l;)l=this._balance(l),l.bounds=l.left.bounds.combine(l.right.bounds),l.height=1+Math.max(l.left.height,l.right.height),l=l.parent}else this.root=a,a.parent=null}trackCollider(e){const s=new nh;s.data=e,s.bounds=e.bounds,s.bounds.left-=2,s.bounds.top-=2,s.bounds.right+=2,s.bounds.bottom+=2,this.nodes[e.id.value]=s,this._insert(s)}updateCollider(e){var s;const r=this.nodes[e.id.value];if(!r)return!1;const a=e.bounds;if(!this.worldBounds.contains(a))return ot.getInstance().warn("Collider with id "+e.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(e),!1;if(r.bounds.contains(a))return!1;if(this._remove(r),a.left-=this._config.boundsPadding,a.top-=this._config.boundsPadding,a.right+=this._config.boundsPadding,a.bottom+=this._config.boundsPadding,e.owner){const l=(s=e.owner)===null||s===void 0?void 0:s.get(Ct);if(l){const f=l.vel.x*32/1e3*this._config.velocityMultiplier,p=l.vel.y*32/1e3*this._config.velocityMultiplier;f<0?a.left+=f:a.right+=f,p<0?a.top+=p:a.bottom+=p}}return r.bounds=a,this._insert(r),!0}untrackCollider(e){const s=this.nodes[e.id.value];s&&(this._remove(s),this.nodes[e.id.value]=null,delete this.nodes[e.id.value])}_balance(e){if(e===null)throw new Error("Cannot balance at null node");if(e.isLeaf()||e.height<2)return e;const s=e.left,r=e.right,a=e,l=s,f=r,p=s.left,m=s.right,w=r.left,y=r.right,A=f.height-l.height;if(A>1)return f.left=a,f.parent=a.parent,a.parent=f,f.parent?f.parent.left===a?f.parent.left=f:f.parent.right=f:this.root=f,w.height>y.height?(f.right=w,a.right=y,y.parent=a,a.bounds=l.bounds.combine(y.bounds),f.bounds=a.bounds.combine(w.bounds),a.height=1+Math.max(l.height,y.height),f.height=1+Math.max(a.height,w.height)):(f.right=y,a.right=w,w.parent=a,a.bounds=l.bounds.combine(w.bounds),f.bounds=a.bounds.combine(y.bounds),a.height=1+Math.max(l.height,w.height),f.height=1+Math.max(a.height,y.height)),f;if(A<-1){if(l.left=a,l.parent=a.parent,a.parent=l,l.parent)if(l.parent.left===a)l.parent.left=l;else{if(l.parent.right!==a)throw"Error rotating Dynamic Tree";l.parent.right=l}else this.root=l;return p.height>m.height?(l.right=p,a.left=m,m.parent=a,a.bounds=f.bounds.combine(m.bounds),l.bounds=a.bounds.combine(p.bounds),a.height=1+Math.max(f.height,m.height),l.height=1+Math.max(a.height,p.height)):(l.right=m,a.left=p,p.parent=a,a.bounds=f.bounds.combine(p.bounds),l.bounds=a.bounds.combine(m.bounds),a.height=1+Math.max(f.height,p.height),l.height=1+Math.max(a.height,m.height)),l}return e}getHeight(){return this.root===null?0:this.root.height}query(e,s){const r=e.bounds,a=l=>{if(l&&l.bounds.overlaps(r))if(l.isLeaf()&&l.data!==e){if(s.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}rayCastQuery(e,s=1/0,r){const a=l=>{if(l&&l.bounds.rayCast(e,s))if(l.isLeaf()){if(r.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}getNodes(){const e=s=>s?[s].concat(e(s.left),e(s.right)):[];return e(this.root)}debug(e){const s=r=>{r&&(r.isLeaf()?r.bounds.draw(e,Q.Green):r.bounds.draw(e,Q.White),r.left&&s(r.left),r.right&&s(r.right))};s(this.root)}}class Ys{constructor(e,s){this.pos=e,this.dir=s.normalize()}intersect(e){const s=e.begin.sub(this.pos);if(this.dir.cross(e.getSlope())===0&&s.cross(this.dir)!==0)return-1;const r=this.dir.cross(e.getSlope());if(r===0)return-1;const a=s.cross(e.getSlope())/r;if(a>=0){const l=s.cross(this.dir)/r/e.getLength();if(l>=0&&l<=1)return a}return-1}intersectPoint(e){const s=this.intersect(e);return s<0?null:this.getPoint(s)}getPoint(e){return this.pos.add(this.dir.scale(e))}}class go{constructor(e){this._config=e,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new rh(e.dynamicTree)}getColliders(){return this._colliders}query(e){const s=[];return e instanceof at?this._dynamicCollisionTree.query({id:P("collider",-1),owner:null,bounds:e},r=>(s.push(r),!1)):this._dynamicCollisionTree.query({id:P("collider",-1),owner:null,bounds:new at(e.x,e.y,e.x,e.y)},r=>(s.push(r),!1)),s}rayCast(e,s){var r,a,l;const f=[],p=(r=s?.maxDistance)!==null&&r!==void 0?r:1/0,m=s?.collisionGroup,w=m?m.category:(a=s?.collisionMask)!==null&&a!==void 0?a:ns.All.category,y=(l=s?.searchAllColliders)!==null&&l!==void 0?l:!1;return this._dynamicCollisionTree.rayCastQuery(e,p,A=>{const D=A.owner.get(Ct);if(s?.ignoreCollisionGroupAll&&D.group===ns.All)return!1;const L=(w&D.group.category)!==0;if(D?.group&&!L)return!1;const O=A.rayCast(e,p);if(O){if(s?.filter){if(s.filter(O)&&(f.push(O),!y))return!0}else if(f.push(O),!y)return!0}return!1}),f}track(e){if(!e){ot.getInstance().warn("Cannot track null collider");return}if(e instanceof ye){const s=e.getColliders();for(const r of s)r.owner=e.owner,this._colliders.push(r),this._dynamicCollisionTree.trackCollider(r)}else this._colliders.push(e),this._dynamicCollisionTree.trackCollider(e)}untrack(e){if(!e){ot.getInstance().warn("Cannot untrack a null collider");return}if(e instanceof ye){const s=e.getColliders();for(const r of s){const a=this._colliders.indexOf(r);a!==-1&&this._colliders.splice(a,1),this._dynamicCollisionTree.untrackCollider(r)}}else{const s=this._colliders.indexOf(e);s!==-1&&this._colliders.splice(s,1),this._dynamicCollisionTree.untrackCollider(e)}}_pairExists(e,s){const r=qe.calculatePairHash(e.id,s.id);return this._pairs.has(r)}broadphase(e,s,r){const a=s/1e3,l=e.filter(p=>{var m,w;const y=(m=p.owner)===null||m===void 0?void 0:m.get(Ct);return((w=p.owner)===null||w===void 0?void 0:w.isActive)&&y.collisionType!==dt.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let f;for(let p=0,m=l.length;p<m;p++)f=l[p],this._dynamicCollisionTree.query(f,w=>{if(!this._pairExists(f,w)&&qe.canCollide(f,w)){const y=new qe(f,w);this._pairs.add(y.id),this._collisionPairCache.push(y)}return!1});if(r&&(r.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const p of l){const m=p.owner.get(Ct);if(m.collisionType!==dt.Active)continue;const w=m.vel.magnitude*a+m.acc.magnitude*.5*a*a,y=Math.min(p.bounds.height,p.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||w>y/2){r&&r.physics.fastBodies++;const A=m.globalPos.sub(m.oldPos),E=p.center,D=p.getFurthestPoint(m.vel),L=D.sub(A),O=new Ys(L,m.vel);O.pos=O.pos.add(O.dir.scale(-2*this._config.continuous.surfaceEpsilon));let q,H=new B(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(O,w+this._config.continuous.surfaceEpsilon*2,N=>{if(!this._pairExists(p,N)&&qe.canCollide(p,N)){const $=N.rayCast(O,w+this._config.continuous.surfaceEpsilon*10);if($){const Y=$.point.sub(L);Y.magnitude<H.magnitude&&(H=Y,q=N)}}return!1}),q&&B.isValid(H)){const N=new qe(p,q);this._pairs.has(N.id)||(this._pairs.add(N.id),this._collisionPairCache.push(N));const $=E.sub(D);m.globalPos=L.add($).add(H).add(O.dir.scale(10*this._config.continuous.surfaceEpsilon)),p.update(m.transform.get()),r&&r.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(e,s){let r=[];for(let a=0;a<e.length;a++){const l=e[a].collide();if(r=r.concat(l),s&&l.length>0)for(const f of l)s.physics.contacts.set(f.id,f)}return s&&(s.physics.collisions+=r.length),r}update(e){let s=0;const r=e.length;for(let a=0;a<r;a++)this._dynamicCollisionTree.updateCollider(e[a])&&s++;return s}debug(e){this._dynamicCollisionTree.debug(e)}}class Ts{constructor(){this.id=P("collider",Ts._ID++),this.composite=null,this.events=new I,this.offset=B.Zero}touching(e){return!!this.collide(e)}}Ts._ID=0;var ar;(function(u){u.Arcade="arcade",u.Realistic="realistic"})(ar||(ar={}));var rs;(function(u){u.None="none",u.VerticalFirst="vertical-first",u.HorizontalFirst="horizontal-first"})(rs||(rs={}));const oh={vertical:1,horizontal:2},ah={horizontal:1,vertical:2},hh={horizontal:0,vertical:0};var Tn;(function(u){u.DynamicTree="dynamic-tree",u.SparseHashGrid="sparse-hash-grid"})(Tn||(Tn={}));const os=()=>({enabled:!0,gravity:z(0,0).clone(),solver:ar.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:Tn.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:rs.None},realistic:{contactSolveBias:rs.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class ye extends Ts{set compositeStrategy(e){this._compositeStrategy=e}get compositeStrategy(){return this._compositeStrategy}constructor(e){super(),this._collisionProcessor=new go({...os()}),this._dynamicAABBTree=new rh({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const s of e)this.addCollider(s)}clearColliders(){this._colliders=[]}addCollider(e){let s;e instanceof ye?(s=e.getColliders(),s.forEach(r=>r.offset.addEqual(e.offset))):s=[e];for(const r of s)r.events.pipe(this.events),r.composite=this,this._colliders.push(r),this._collisionProcessor.track(r),this._dynamicAABBTree.trackCollider(r)}removeCollider(e){e.events.pipe(this.events),e.composite=null,ts(e,this._colliders),this._collisionProcessor.untrack(e),this._dynamicAABBTree.untrackCollider(e)}getColliders(){return this._colliders}get worldPos(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:B.Zero).add(this.offset)}get center(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:B.Zero).add(this.offset)}get bounds(){var e,s;const r=this.getColliders();return r.reduce((l,f)=>l.combine(f.bounds),(s=(e=r[0])===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new at().translate(this.worldPos)).translate(this.offset)}get localBounds(){var e,s;const r=this.getColliders();return r.reduce((l,f)=>l.combine(f.localBounds),(s=(e=r[0])===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new at)}get axes(){const e=this.getColliders();let s=[];for(const r of e)s=s.concat(r.axes);return s}getFurthestPoint(e){const s=this.getColliders(),r=[];for(const f of s)r.push(f.getFurthestPoint(e));let a=r[0],l=-Number.MAX_VALUE;for(const f of r){const p=f.dot(e);p>l&&(a=f,l=p)}return a}getInertia(e){const s=this.getColliders();let r=0;for(const a of s)r+=a.getInertia(e);return r}collide(e){let s=[e];e instanceof ye&&(s=e.getColliders());const r=[];for(const l of s)this._dynamicAABBTree.query(l,f=>(r.push(new qe(l,f)),!1));let a=[];for(const l of r)a=a.concat(l.collide());return a}getClosestLineBetween(e){const s=this.getColliders(),r=[];if(e instanceof ye){const a=e.getColliders();for(const l of s)for(const f of a){const p=l.getClosestLineBetween(f);p&&r.push(p)}}else for(const a of s){const l=e.getClosestLineBetween(a);l&&r.push(l)}if(r.length){let a=r[0].getLength(),l=r[0];for(const f of r){const p=f.getLength();p<a&&(a=p,l=f)}return l}return null}contains(e){const s=this.getColliders();for(const r of s)if(r.contains(e))return!0;return!1}rayCast(e,s){const r=this.getColliders(),a=[];for(const l of r){const f=l.rayCast(e,s);f&&a.push(f)}if(a.length){let l=a[0],f=l.point.dot(e.dir);for(const p of a){const m=e.dir.dot(p.point);m<f&&(l=p,f=m)}return l}return null}project(e){const s=this.getColliders(),r=[];for(const a of s){const l=a.project(e);l&&r.push(l)}if(r.length){const a=new or(r[0].min,r[0].max);for(const l of r)a.min=Math.min(l.min,a.min),a.max=Math.max(l.max,a.max);return a}return null}update(e){if(e){const s=this.getColliders();for(const r of s)r.owner=this.owner,r.update(e)}}debug(e,s,r){const a=this.getColliders();e.save(),e.translate(this.offset.x,this.offset.y);for(const l of a)l.debug(e,s,r);e.restore()}clone(){const e=new ye(this._colliders.map(s=>s.clone()));return e.offset=this.offset.clone(),e}}class oe{constructor(e,s){this.begin=e,this.end=s}clone(e){const s=e||new oe(this.begin.clone(),this.end.clone());return s.begin=this.begin.clone(s.begin),s.end=this.end.clone(s.end),s}transform(e,s){const r=s||new oe(B.Zero,B.Zero);return r.begin=e.multiply(this.begin,r.begin),r.end=e.multiply(this.end,r.end),r}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const e=this.begin,s=this.end,r=e.distance(s);return this._slope=s.sub(e).scale(1/r)}getEdge(){const e=this.begin;return this.end.sub(e)}getLength(){const e=this.begin,s=this.end;return e.distance(s)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new oe(this.end,this.begin)}below(e){return(this.end.x-this.begin.x)*(e.y-this.begin.y)-(this.end.y-this.begin.y)*(e.x-this.begin.x)>=0}clip(e,s,r=!0){let a=e;r&&(a=a.normalize());const l=a.dot(this.begin)-s,f=a.dot(this.end)-s,p=[];if(l<=0&&p.push(this.begin),f<=0&&p.push(this.end),l*f<0){const m=l/(l-f);p.push(this.begin.add(this.end.sub(this.begin).scale(m)))}return p.length!==2?null:new oe(p[0],p[1])}distanceToPoint(e,s=!1){const r=e.x,a=e.y,l=this.getLength(),f=this.end.y-this.begin.y,p=this.end.x-this.begin.x,m=(f*r-p*a+this.end.x*this.begin.y-this.end.y*this.begin.x)/l;return s?m:Math.abs(m)}findVectorToPoint(e){const s=this.begin.sub(e),r=this.getSlope();return s.sub(r.scale(s.dot(r)))}findPoint(e=null,s=null){const r=this.slope,a=this.intercept;if(e!==null)return new B(e,r*e+a);if(s!==null)return new B((s-a)/r,s);throw new Error("You must provide an X or a Y value")}hasPoint(){let e,s=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")e=new B(arguments[0],arguments[1]),s=arguments[2]||0;else if(arguments[0]instanceof B)e=arguments[0],s=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const r=e.x-this.begin.x,a=e.y-this.begin.y,l=this.end.x-this.begin.x,f=this.end.y-this.begin.y,p=r*f-a*l;return Math.abs(p)>s?!1:Math.abs(l)>=Math.abs(f)?l>0?this.begin.x<=e.x&&e.x<=this.end.x:this.end.x<=e.x&&e.x<=this.begin.x:f>0?this.begin.y<=e.y&&e.y<=this.end.y:this.end.y<=e.y&&e.y<=this.begin.y}}function lh(u,e){const r=u.dir(),a=e.dir(),l=r.dot(r),f=a.dot(a);if(l<1e-9&&f<1e-9)return new oe(u.begin,e.begin);if(l<1e-9){const q=j(a.dot(u.begin.sub(e.begin))/f,0,1),H=e.begin.add(a.scale(q));return new oe(u.begin,H)}if(f<1e-9){const q=j(r.dot(e.begin.sub(u.begin))/l,0,1),H=u.begin.add(r.scale(q));return new oe(H,e.begin)}const p=u.begin.sub(e.begin),m=l,w=f,y=a.dot(p),A=m*w-Math.pow(r.dot(a),2);let E=0,D=0;Math.abs(A)>1e-9?E=j((r.dot(a)*y-w*r.dot(p))/A,0,1):E=j(r.dot(p)/m,0,1),Math.abs(w)>1e-9?D=j((r.dot(a)*E+y)/w,0,1):D=0;const L=u.begin.add(r.scale(E)),O=e.begin.add(a.scale(D));return new oe(L,O)}const zi={PolygonPolygonClosestLine(u,e){const s=u.getSides(),r=e.getSides();let a=Number.MAX_VALUE,l=null;for(let f=0;f<s.length;f++)for(let p=0;p<r.length;p++){const m=lh(s[f],r[p]),w=m.getLength();w<a&&(a=w,l=m)}return l},PolygonEdgeClosestLine(u,e){const r=e.worldPos.sub(u.worldPos),a=new Ys(u.worldPos,r),l=u.rayCast(a).point.add(a.dir.scale(.1)),f=u.getClosestFace(l),p=e.asLine();return lh(f.face,p)},PolygonCircleClosestLine(u,e){const s=e.worldPos,r=s.sub(u.worldPos),a=new Ys(u.worldPos,r.normalize()),l=u.rayCast(a).point.add(a.dir.scale(.1)),f=u.getClosestFace(l),p=f.face.begin,m=f.face.getEdge();let w=(m.x*(s.x-p.x)+m.y*(s.y-p.y))/(m.x*m.x+m.y*m.y);w>1?w=1:w<0&&(w=0);const y=Math.sqrt(Math.pow(p.x+m.x*w-s.x,2)+Math.pow(p.y+m.y*w-s.y,2))-e.radius,A=(p.x+m.x*w-s.x)*e.radius/(e.radius+y),E=(p.y+m.y*w-s.y)*e.radius/(e.radius+y);return new oe(m.scale(w).add(p),new B(s.x+A,s.y+E))},CircleCircleClosestLine(u,e){const r=e.worldPos.sub(u.worldPos),l=u.worldPos.sub(e.worldPos),f=new Ys(u.worldPos,r),p=new Ys(e.worldPos,l),m=u.rayCast(f),w=e.rayCast(p);return new oe(m.point,w.point)},CircleEdgeClosestLine(u,e){const s=u.worldPos,r=e.asLine(),a=r.begin,l=r.getEdge(),f=a,p=l;let m=(p.x*(s.x-f.x)+p.y*(s.y-f.y))/(p.x*p.x+p.y*p.y);m>1?m=1:m<0&&(m=0);const w=Math.sqrt(Math.pow(f.x+p.x*m-s.x,2)+Math.pow(f.y+p.y*m-s.y,2))-u.radius,y=(f.x+p.x*m-s.x)*u.radius/(u.radius+w),A=(f.y+p.y*m-s.y)*u.radius/(u.radius+w);return new oe(p.scale(m).add(f),new B(s.x+y,s.y+A))},EdgeEdgeClosestLine(u,e){const s=u.asLine(),r=e.asLine();return lh(s,r)}};class ze extends Ts{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var e;if(this._radius)return this._radius;const s=this._transform,r=(e=s?.globalScale)!==null&&e!==void 0?e:B.One;return this._radius=this._naturalRadius*Math.min(r.x,r.y)}set radius(e){var s;const r=this._transform,a=(s=r?.globalScale)!==null&&s!==void 0?s:B.One;this._naturalRadius=e/Math.min(a.x,a.y),this._localBoundsDirty=!0,this._radius=e}constructor(e){super(),this.offset=B.Zero,this._globalMatrix=le.identity(),this._localBoundsDirty=!0,this.offset=e.offset||B.Zero,this.radius=e.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new ze({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(e){var s,r;return((r=(s=this._transform)===null||s===void 0?void 0:s.pos)!==null&&r!==void 0?r:this.offset).distance(e)<=this.radius}rayCast(e,s=1/0){var r,a;const l=this.center,f=e.dir,p=e.pos,m=l.sub(p),w=f.scale(m.dot(f)),A=m.sub(w).magnitude;if(A>this.radius)return null;{let E=0;if(X(A,this.radius,1e-4)){if(E=-f.dot(p.sub(l)),E>0&&E<s){const D=e.getPoint(E);return{point:D,normal:D.sub(l).normalize(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(Ct),distance:E}}return null}else{const D=Math.sqrt(Math.pow(f.dot(p.sub(l)),2)-Math.pow(p.sub(l).distance(),2)+Math.pow(this.radius,2)),L=-f.dot(p.sub(l))+D,O=-f.dot(p.sub(l))-D,q=[];L>=0&&q.push(L),O>=0&&q.push(O);const H=Math.min(...q);if(H<=s){const N=e.getPoint(H);return{point:N,normal:N.sub(l).normalize(),collider:this,body:(a=this.owner)===null||a===void 0?void 0:a.get(Ct),distance:H}}return null}}}getClosestLineBetween(e){if(e instanceof ze)return zi.CircleCircleClosestLine(this,e);if(e instanceof Re)return zi.PolygonCircleClosestLine(e,this).flip();if(e instanceof ri)return zi.CircleEdgeClosestLine(this,e).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof ze)return Pi.CollideCircleCircle(this,e);if(e instanceof Re)return Pi.CollideCirclePolygon(this,e);if(e instanceof ri)return Pi.CollideCircleEdge(this,e);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){return this.center.add(e.normalize().scale(this.radius))}getFurthestLocalPoint(e){return e.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new at(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(e){return e*this.radius*this.radius/2}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(e){const s=[],a=this.center.dot(e);return s.push(a),s.push(a+this.radius),s.push(a-this.radius),new or(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s,r){var a,l,f,p;const{lineWidth:m}={lineWidth:1,...r},w=this._transform,y=(a=w?.globalScale)!==null&&a!==void 0?a:B.One,A=(l=w?.globalRotation)!==null&&l!==void 0?l:0,E=(f=w?.globalPos)!==null&&f!==void 0?f:B.Zero;e.save(),e.translate(E.x,E.y),e.rotate(A),e.scale(y.x,y.y),e.drawCircle((p=this.offset)!==null&&p!==void 0?p:B.Zero,this._naturalRadius,Q.Transparent,s,m),e.restore()}}class js{constructor(e,s,r,a,l,f,p,m){var w,y,A,E,D,L;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=e,this.colliderB=s,this.mtv=r,this.normal=a,this.tangent=l,this.points=f,this.localPoints=p,this.info=m,this.id=qe.calculatePairHash(e.id,s.id),e.composite||s.composite){const O=((w=e.composite)===null||w===void 0?void 0:w.compositeStrategy)==="separate"?e.id:(A=(y=e.composite)===null||y===void 0?void 0:y.id)!==null&&A!==void 0?A:e.id,q=((E=s.composite)===null||E===void 0?void 0:E.compositeStrategy)==="separate"?s.id:(L=(D=s.composite)===null||D===void 0?void 0:D.id)!==null&&L!==void 0?L:s.id;this.id+="|"+qe.calculatePairHash(O,q)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(Ct)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(Ct))}matchAwake(){const e=this.bodyA,s=this.bodyB;e&&s&&e.isSleeping!==s.isSleeping&&(e.isSleeping&&e.collisionType!==dt.Fixed&&s.sleepMotion>=e.wakeThreshold&&(e.isSleeping=!1),s.isSleeping&&s.collisionType!==dt.Fixed&&e.sleepMotion>=s.wakeThreshold&&(s.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(e){if(e!==this.colliderA&&e!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(e===this.colliderA)return this;const s=this.colliderA,r=this.colliderB;return this.colliderB=s,this.colliderA=r,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class Oc{constructor(){this.axis=z(0,0),this.localAxis=z(0,0),this.side=new oe(z(0,0),z(0,0)),this.localSide=new oe(z(0,0),z(0,0)),this.point=z(0,0),this.localPoint=z(0,0)}}class de{static findPolygonPolygonSeparation(e,s){if(s.transform.matrix.determinant()===0)return de.findPolygonPolygonSeparationDegenerate(e,s);let r=-Number.MAX_VALUE,a=-1,l;const f=s.transform.inverse.multiply(e.transform.matrix,de._SCRATCH_MATRIX),p=f.getRotation(),m=e.normals,w=e.points,y=s.points;for(let D=0;D<w.length;D++){const L=m[D].rotate(p,de._ZERO,de._SCRATCH_NORMAL),O=f.multiply(w[D],de._SCRATCH_POINT);let q=Number.MAX_VALUE,H;for(let N=0;N<y.length;N++){const $=L.dot(y[N].sub(O,de._SCRATCH_SUB_POINT));$<q&&(q=$,H=y[N])}q>r&&(r=q,a=D,l=H)}const A=(a+1)%w.length,E=de.SeparationPool.get();return E.collider=e,E.separation=r,r>0||(m[a].clone(E.localAxis),m[a].rotate(e.transform.rotation,de._ZERO,E.axis),e.transform.matrix.multiply(w[a],E.side.begin),e.transform.matrix.multiply(w[A],E.side.end),s.transform.matrix.multiply(l,E.point),E.sideId=a,l.clone(E.localPoint),w[a].clone(E.localSide.begin),w[A].clone(E.localSide.end)),E}static findCirclePolygonSeparation(e,s){const r=s.axes,l=s.center.sub(e.worldPos),f=s.getFurthestPoint(l.negate());r.push(f.sub(e.worldPos).normalize());let p=Number.MAX_VALUE,m=null,w=-1;for(let y=0;y<r.length;y++){const A=s.project(r[y]),E=e.project(r[y]),D=A.getOverlap(E);if(D<=0)return null;D<p&&(p=D,m=r[y],w=y)}return w<0?null:m.normalize().scale(p)}static findPolygonPolygonSeparationDegenerate(e,s){let r=-Number.MAX_VALUE,a=null,l=null,f=-1,p=null;const m=e.getSides(),w=e.getLocalSides();for(let y=0;y<m.length;y++){const A=m[y],E=A.normal(),D=s.getFurthestPoint(E.negate()),L=A.distanceToPoint(D,!0);L>r&&(r=L,a=A,l=E,f=y,p=D)}return{collider:e,separation:l?r:99,axis:l,side:a,localSide:w[f],sideId:f,point:p,localPoint:l?s.getFurthestLocalPoint(l.negate()):null}}}de.SeparationPool=new Jr(()=>new Oc,u=>u,500),de._ZERO=z(0,0),de._SCRATCH_POINT=z(0,0),de._SCRATCH_SUB_POINT=z(0,0),de._SCRATCH_NORMAL=z(0,0),de._SCRATCH_MATRIX=le.identity(),de.SeparationPool.disableWarnings=!0;const Cp=B.Zero,Pp=B.Zero,Tp=le.identity(),Pi={CollideCircleCircle(u,e){const s=u.worldPos,r=e.worldPos,a=u.radius+e.radius,l=s.distance(r);if(l>a)return[];const f=a-l,p=r.sub(s).normalize(),m=p.perpendicular(),w=p.scale(f),y=u.getFurthestPoint(p),A=u.getFurthestLocalPoint(p),E={collider:u,separation:f,axis:p,point:y};return[new js(u,e,w,p,m,[y],[A],E)]},CollideCirclePolygon(u,e){var s,r;let a=de.findCirclePolygonSeparation(u,e);if(!a)return[];a=a.dot(e.center.sub(u.center))<0?a.negate():a;const f=u.getFurthestPoint(a),m=((r=(s=u.owner)===null||s===void 0?void 0:s.get(et))!==null&&r!==void 0?r:new et).applyInverse(f),w=a.normalize(),y={collider:u,separation:-a.magnitude,axis:w,point:f,localPoint:m,side:e.findSide(w.negate()),localSide:e.findLocalSide(w.negate())};return[new js(u,e,a,w,w.perpendicular(),[f],[m],y)]},CollideCircleEdge(u,e){const s=u.center,r=e.asLine(),a=r.end.sub(r.begin),l=a.dot(r.end.sub(s)),f=a.dot(s.sub(r.begin)),p=e.asLine(),m=e.asLocalLine();if(f<=0){const H=r.begin.sub(s),N=H.dot(H);if(N>u.radius*u.radius)return[];const $=H.normalize(),Y=u.radius-Math.sqrt(N),J={collider:u,separation:Y,axis:$,point:p.begin,side:p,localSide:m};return[new js(u,e,$.scale(Y),$,$.perpendicular(),[p.begin],[m.begin],J)]}if(l<=0){const H=r.end.sub(s),N=H.dot(H);if(N>u.radius*u.radius)return[];const $=H.normalize(),Y=u.radius-Math.sqrt(N),J={collider:u,separation:Y,axis:$,point:p.end,side:p,localSide:m};return[new js(u,e,$.scale(Y),$,$.perpendicular(),[p.end],[m.end],J)]}const w=a.dot(a),y=r.begin.scale(l).add(r.end.scale(f)).scale(1/w),A=s.sub(y),E=A.dot(A);if(E>u.radius*u.radius)return[];let D=a.perpendicular();D.dot(s.sub(r.begin))<0&&(D.x=-D.x,D.y=-D.y),D=D.normalize();const L=u.radius-Math.sqrt(E),O=D.scale(L),q={collider:u,separation:L,axis:D,point:y,side:p,localSide:m};return[new js(u,e,O,D.negate(),D.negate().perpendicular(),[y],[y.sub(e.worldPos)],q)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(u,e){var s;const r=u.center,l=e.center.sub(r).normalize(),f=new Re({points:[e.begin,e.end,e.end.add(l.scale(100)),e.begin.add(l.scale(100))],offset:e.offset});f.owner=e.owner,((s=e.owner)===null||s===void 0?void 0:s.get(et))&&f.update(e.owner.get(et).get());const m=this.CollidePolygonPolygon(u,f);return m.length&&(m[0].colliderB=e,m[0].id=qe.calculatePairHash(u.id,e.id)),m},CollidePolygonPolygon(u,e){const s=de.findPolygonPolygonSeparation(u,e);if(s.separation>0)return[];const r=de.findPolygonPolygonSeparation(e,u);if(r.separation>0)return[];const a=s.separation>r.separation?s:r,l=a.collider===u?e:u,f=a.collider===u?u:e,p=l.transform.inverse.multiply(f.transform.matrix,Tp),m=p.getRotation(),w=f.normals[a.sideId].rotate(m,Cp,Pp);let y=Number.MAX_VALUE,A=0;for(let H=0;H<l.normals.length;H++){const N=w.dot(l.normals[H]);N<y&&(y=N,A=H)}if(!a.localSide||!a.localAxis||!a.axis)return[];const E=a.localSide.transform(p),D=a.localAxis.perpendicular().negate().rotate(m),O=new oe(l.points[A],l.points[(A+1)%l.points.length]).clip(D.negate(),-D.dot(E.begin),!1);let q=null;if(O&&(q=O.clip(D,D.dot(E.end),!1)),q){const H=[],N=[],$=q.getPoints();for(let rt=0;rt<$.length;rt++){const Z=$[rt];E.below(Z)&&(H.push(Z),N.push(l.transform.apply(Z)))}let Y=a.axis,J=Y.perpendicular();return e.center.sub(u.center).dot(Y)<0&&(Y=Y.negate(),J=Y.perpendicular()),[new js(u,e,Y.scale(-a.separation),Y,J,N,H,a)]}return[]},FindContactSeparation(u,e){var s,r,a,l;const f=u.colliderA,p=(r=(s=u.bodyA)===null||s===void 0?void 0:s.transform)!==null&&r!==void 0?r:new et,m=u.colliderB,w=(l=(a=u.bodyB)===null||a===void 0?void 0:a.transform)!==null&&l!==void 0?l:new et;if(f instanceof ze&&m instanceof ze){const y=f.radius+m.radius,A=p.pos.distance(w.pos);return-(y-A)}if(f instanceof Re&&m instanceof Re&&u.info.localSide){let y,A;return u.info.collider===f?(y=new oe(p.apply(u.info.localSide.begin).add(f.offset),p.apply(u.info.localSide.end).add(f.offset)),A=w.apply(e).add(m.offset)):(y=new oe(w.apply(u.info.localSide.begin).add(m.offset),w.apply(u.info.localSide.end).add(m.offset)),A=p.apply(e).add(f.offset)),y.distanceToPoint(A,!0)}if(f instanceof Re&&m instanceof ze||m instanceof Re&&f instanceof ze){const y=p.apply(e);if(u.info.side)return u.info.side.distanceToPoint(y,!0)}if(f instanceof ri&&m instanceof Re||m instanceof ri&&f instanceof Re){let y;if(u.info.collider===f?y=w.apply(e):y=p.apply(e),u.info.side)return u.info.side.distanceToPoint(y,!0)}if(f instanceof ze&&m instanceof ri||m instanceof ze&&f instanceof ri){const y=w.apply(e);let A;f instanceof ze&&(A=f.getFurthestPoint(u.normal));const E=y.distance(A);if(u.info.side)return E>0?-E:0}return 0}};class ri extends Ts{constructor(e){var s;super(),this._globalMatrix=le.identity(),this.begin=e.begin||B.Zero,this.end=e.end||B.Zero,this.offset=(s=e.offset)!==null&&s!==void 0?s:B.Zero}clone(){return new ri({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var e;const s=this._transform;return(e=s?.globalPos.add(this.offset))!==null&&e!==void 0?e:this.offset}get center(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.average(s)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const e=this._getTransformedBegin(),s=this._getTransformedEnd(),r=e.distance(s);return s.sub(e).scale(1/r)}getLength(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.distance(s)}contains(){return!1}rayCast(e,s=1/0){var r;const a=this._getTransformedBegin().sub(e.pos);if(e.dir.cross(this.getSlope())===0&&a.cross(e.dir)!==0)return null;const l=e.dir.cross(this.getSlope());if(l===0)return null;const f=a.cross(this.getSlope())/l;if(f>=0&&f<=s){const p=a.cross(e.dir)/l/this.getLength();if(p>=0&&p<=1)return{distance:f,normal:this.asLine().normal(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(Ct),point:e.getPoint(f)}}return null}getClosestLineBetween(e){if(e instanceof ze)return zi.CircleEdgeClosestLine(e,this);if(e instanceof Re)return zi.PolygonEdgeClosestLine(e,this).flip();if(e instanceof ri)return zi.EdgeEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof ze)return Pi.CollideCircleEdge(e,this);if(e instanceof Re)return Pi.CollidePolygonEdge(e,this);if(e instanceof ri)return Pi.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this._getTransformedBegin(),r=this._getTransformedEnd();return e.dot(s)>0?s:r}_boundsFromBeginEnd(e,s,r=10){return new at(Math.min(e.x,s.x)-r,Math.min(e.y,s.y)-r,Math.max(e.x,s.x)+r,Math.max(e.y,s.y)+r)}get bounds(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return this._boundsFromBeginEnd(e,s)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new oe(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new oe(this.begin,this.end)}get axes(){const s=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),r=[];return r.push(s),r.push(s.negate()),r.push(s.normal()),r.push(s.normal().negate()),r}getInertia(e){const s=this.end.sub(this.begin).distance()/2;return e*s*s}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(e){const s=[],r=[this._getTransformedBegin(),this._getTransformedEnd()],a=r.length;for(let l=0;l<a;l++)s.push(r[l].dot(e));return new or(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s){const r=this._getTransformedBegin(),a=this._getTransformedEnd();e.drawLine(r,a,s,2),e.drawCircle(r,2,s),e.drawCircle(a,2,s)}}class Ae{static registerGraphicsContext(e){Ae._ctx=e}static draw(e){this._drawCalls.push(e)}static drawPoint(e,s){Ae.draw(r=>{r.debug.drawPoint(e,s)})}static drawLine(e,s,r){Ae.draw(a=>{a.debug.drawLine(e,s,r)})}static drawLines(e,s){e.length>1&&Ae.draw(r=>{for(let a=0;a<e.length-1;a++)r.debug.drawLine(e[a],e[a+1],s)})}static drawText(e,s){Ae.draw(r=>{r.debug.drawText(e,s)})}static drawPolygon(e,s){e.length>1&&Ae.draw(r=>{const a=e[0],l=[...e,a];for(let f=0;f<l.length-1;f++)r.debug.drawLine(l[f],l[f+1],s)})}static drawCircle(e,s,r){const{color:a,strokeColor:l,width:f}={color:Q.Black,strokeColor:void 0,width:void 0,...r};Ae.draw(p=>{p.drawCircle(e,s,a,l,f)})}static drawBounds(e,s){Ae.draw(r=>{r.debug.drawRect(e.left,e.top,e.width,e.height,s)})}static drawRay(e,s){const{distance:r,color:a}={color:Q.Blue,distance:10,...s};Ae.draw(l=>{const f=e.pos,p=e.pos.add(e.dir.scale(r));l.debug.drawLine(f,p,{color:a})})}static flush(e){e.save(),e.z=Ae.z;for(const s of Ae._drawCalls)s(e);e.restore(),Ae.clear()}static clear(){Ae._drawCalls.length=0}}Ae._drawCalls=[],Ae.z=1/0;class Re extends Ts{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(e){if(e.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=e,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const e=[];for(let s=0;s<this._points.length;s++)e.push(this._points[(s+1)%this._points.length].sub(this._points[s]).normal());this._normals=e}get points(){return this._points}get transform(){return this._transform}constructor(e){var s;super(),this._logger=ot.getInstance(),this._transform=new is,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(s=e.offset)!==null&&s!==void 0?s:B.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=e.points,this.isConvex()||e.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(e){this._isCounterClockwiseWinding(e)||e.reverse()}_isCounterClockwiseWinding(e){let s=0;for(let r=0;r<e.length;r++)s+=(e[(r+1)%e.length].x-e[r].x)*(e[(r+1)%e.length].y+e[r].y);return s<0}isConvex(){if(this.points.length<3)return!1;let e=this.points[this.points.length-2],s=this.points[this.points.length-1],r=Math.atan2(s.y-e.y,s.x-e.x),a=0,l=0,f=0;for(const[p,m]of this.points.entries()){if(e=s,a=r,s=m,r=Math.atan2(s.y-e.y,s.x-e.x),e.equals(s))return!1;let w=r-a;if(w<=-Math.PI?w+=Math.PI*2:w>Math.PI&&(w-=Math.PI*2),p===0){if(w===0)return!1;l=w>0?1:-1}else if(l*w<=0)return!1;f+=w}return Math.abs(Math.round(f/(Math.PI*2)))===1}tessellate(){const e=[];for(let s=1;s<this.points.length-2;s++)e.push([this.points[0],this.points[s+1],this.points[s+2]]);return e.push([this.points[0],this.points[1],this.points[2]]),new ye(e.map(s=>He.Polygon(s)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const e=[],s=[...this.points].reverse();let r=s.length;function a(A){return A===0?r-1:A-1}function l(A){return A===r-1?0:A+1}function f(A){const E=a(A),D=l(A),L=s[E],O=s[A],q=s[D],H=L.sub(O),N=q.sub(O);return!(H.cross(N)<0)}const p=s.map((A,E)=>f(E));function m(A,E,D,L){const O=D.sub(E),q=L.sub(D),H=E.sub(L),N=A.sub(E),$=A.sub(D),Y=A.sub(L),J=O.cross(N),rt=q.cross($),Z=H.cross(Y);return!(J>0||rt>0||Z>0)}function w(){for(let A=0;A<r;A++)if(p[A]){const E=a(A),D=l(A),L=s[E],O=s[A],q=s[D];let H=!0;for(let N=0;N<r;N++){if(N===A||N===E||N===D)continue;const $=s[N];if(m($,L,O,q)){H=!1;break}}if(H)return A}for(let A=0;A<r;A++)if(p[A])return A;return 0}function y(A){const E=a(A),D=l(A),L=s[E],O=s[A],q=s[D];e.push([L,O,q]),s.splice(A,1),p.splice(A,1),r--}for(;r>3;){const A=w();y(A);for(let E=0;E<r;E++)p[E]=f(E)}return e.push([s[0],s[1],s[2]]),new ye(e.map(A=>He.Polygon(A,B.Zero,!0)))}clone(){return new Re({offset:this.offset.clone(),points:this.points.map(e=>e.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const e=this.points,s=e.length;this._transformedPoints.length=0;for(let r=0;r<s;r++)this._transformedPoints[r]=this._transform.apply(e[r].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const e=[],s=this.getTransformedPoints(),r=s.length;for(let a=0;a<r;a++)e.push(new oe(s[a],s[(a+1)%r]));this._sides=e,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const e=[],s=this.points,r=s.length;for(let a=0;a<r;a++)e.push(new oe(s[a],s[(a+1)%r]));this._localSides=e,this._localSidesDirty=!1}return this._localSides}findSide(e){const s=this.getSides();let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=s[l],m=f.normal().dot(e);m>a&&(r=f,a=m)}return r}findLocalSide(e){const s=this.getLocalSides();let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=s[l],m=f.normal().dot(e);m>a&&(r=f,a=m)}return r}get axes(){const e=[],s=this.getSides();for(let r=0;r<s.length;r++)e.push(s[r].normal());return e}update(e){e&&(e.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(s=>z(s.x*V(this._transform.scale.x),s.y*V(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(e){const s=this._transform.applyInverse(e),r=new Ys(s,new B(1,0));let a=0;const l=this.getLocalSides();for(let f=0;f<l.length;f++){const p=l[f];r.intersect(p)>=0&&a++}return a%2!==0}getClosestLineBetween(e){if(e instanceof ze)return zi.PolygonCircleClosestLine(this,e);if(e instanceof Re)return zi.PolygonPolygonClosestLine(this,e);if(e instanceof ri)return zi.PolygonEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof ze)return Pi.CollideCirclePolygon(e,this);if(e instanceof Re)return Pi.CollidePolygonPolygon(this,e);if(e instanceof ri)return Pi.CollidePolygonEdge(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this.getTransformedPoints();let r=null,a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=e.dot(s[l]);f>a&&(a=f,r=s[l])}return r}getFurthestLocalPoint(e){const s=this.points;let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=e.dot(s[l]);f>a&&(a=f,r=s[l])}return r}getClosestFace(e){const s=this.getSides();let r=Number.POSITIVE_INFINITY,a=-1,l=-1;for(let f=0;f<s.length;f++){const p=s[f].distanceToPoint(e);p<r&&(r=p,a=f,l=p)}return a!==-1?{distance:s[a].normal().scale(l),face:s[a]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=at.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(e){if(this._cachedMass===e&&this._cachedInertia)return this._cachedInertia;let s=0,r=0;const a=this.points;for(let l=0;l<a.length;l++){const f=(l+1)%a.length,p=a[f].cross(a[l]);s+=p*(a[l].dot(a[l])+a[l].dot(a[f])+a[f].dot(a[f])),r+=p}return this._cachedMass=e,this._cachedInertia=e/6*(s/r)}rayCast(e,s=1/0){var r;const a=this.getSides(),l=a.length;let f=Number.MAX_VALUE,p,m=-1;for(let w=0;w<l;w++){const y=e.intersect(a[w]);y>=0&&y<f&&y<=s&&(f=y,p=a[w],m=w)}return m>=0?{collider:this,distance:f,body:(r=this.owner)===null||r===void 0?void 0:r.get(Ct),point:e.getPoint(f),normal:p.normal()}:null}project(e){const s=this.getTransformedPoints(),r=s.length;let a=Number.MAX_VALUE,l=-Number.MAX_VALUE;for(let f=0;f<r;f++){const p=s[f].dot(e);a=Math.min(a,p),l=Math.max(l,p)}return new or(a,l)}debug(e,s,r){const a=this.getTransformedPoints();Ae.drawPolygon(a,{color:s})}}class He{static Box(e,s,r=B.Half,a=B.Zero){return new Re({points:new at(-e*r.x,-s*r.y,e-e*r.x,s-s*r.y).getPoints(),offset:a})}static Polygon(e,s=B.Zero,r=!1){return new Re({points:e,offset:s,suppressConvexWarning:r})}static Circle(e,s=B.Zero){return new ze({radius:e,offset:s})}static Edge(e,s){return new ri({begin:e,end:s})}static Capsule(e,s,r=B.Zero){const a=ot.getInstance();return e===s&&a.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),s>=e?new ye([He.Circle(e/2,z(0,-s/2+e/2).add(r)),He.Box(e,s-e,B.Half,r),He.Circle(e/2,z(0,s/2-e/2).add(r))]):new ye([He.Circle(s/2,z(-e/2+s/2,0).add(r)),He.Box(e-s,s,B.Half,r),He.Circle(s/2,z(e/2-s/2,0).add(r))])}}class ue extends pi{constructor(e){super(),this.events=new I,this.$colliderAdded=new Ve,this.$colliderRemoved=new Ve,this._collidersToRemove=[],this.set(e)}get(){return this._collider}set(e){return this.clear(),e&&(this._collider=e,this._collider.owner=this.owner,e.events.pipe(this.events),this.$colliderAdded.notifyAll(e),this.update()),e}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const e of this._collidersToRemove)e.events.unpipe(this.events),this.$colliderRemoved.notifyAll(e),e.owner=null}clone(){return new ue(this._collider.clone())}get bounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new at}get localBounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new at}update(){var e;const s=(e=this.owner)===null||e===void 0?void 0:e.get(et);this._collider&&(this._collider.owner=this.owner,s&&this._collider.update(s.get()))}collide(e){let s=this._collider,r=e._collider;if(!s||!r)return[];let a=!1;if(r instanceof ye&&(s=r,r=this._collider,a=!0),this._collider){const l=s.collide(r);return l?(a&&l.forEach(f=>{f.mtv=f.mtv.negate(),f.normal=f.normal.negate(),f.tangent=f.normal.perpendicular(),f.colliderA=this._collider,f.colliderB=e._collider}),l):[]}return[]}onAdd(e){this._collider&&this.update(),this.events.on("precollision",s=>{const r=s;e.events.emit("precollision",new Ns(r.self,r.other,r.side,r.intersection,r.contact)),e instanceof Ye&&e.onPreCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("postcollision",s=>{const r=s;e.events.emit("postcollision",new Gs(r.self,r.other,r.side,r.intersection,r.contact)),e instanceof Ye&&e.onPostCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("collisionstart",s=>{const r=s;e.events.emit("collisionstart",new ir(r.self,r.other,r.side,r.contact)),e instanceof Ye&&e.onCollisionStart(r.self,r.other,r.side,r.contact)}),this.events.on("collisionend",s=>{const r=s;e.events.emit("collisionend",new sr(r.self,r.other,r.side,r.lastContact)),e instanceof Ye&&e.onCollisionEnd(r.self,r.other,r.side,r.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(e,s,r=B.Half,a=B.Zero){const l=He.Box(e,s,r,a);return this.set(l)}usePolygonCollider(e,s=B.Zero){const r=He.Polygon(e,s);return this.set(r)}useCircleCollider(e,s=B.Zero){const r=He.Circle(e,s);return this.set(r)}useEdgeCollider(e,s){const r=He.Edge(e,s);return this.set(r)}useCompositeCollider(e){return this.set(new ye(e))}}var Je;(function(u){u.Rotation="rotation",u.X="x",u.Y="y"})(Je||(Je={}));class Ct extends pi{constructor(e){var s,r,a;super(),this.dependencies=[et,Dt],this.id=P("body",Ct._ID++),this.events=new I,this.oldTransform=new is,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=dt.PreventCollision,this.group=ns.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=B.Zero,this.oldVel=new B(0,0),this.oldAcc=B.Zero,this._impulseScratch=z(0,0),this._distanceFromCenterScratch=z(0,0),e?(this.collisionType=(s=e.type)!==null&&s!==void 0?s:this.collisionType,this.group=(r=e.group)!==null&&r!==void 0?r:this.group,this.useGravity=(a=e.useGravity)!==null&&a!==void 0?a:this.useGravity,this._bodyConfig={...os().bodies,...e.config}):this._bodyConfig={...os().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=Ct._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(e){this._bodyConfig={...os().bodies,...e},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(e){Ct._DEFAULT_CONFIG=e}get mass(){return this._mass}set mass(e){this._mass=e,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===dt.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(e){this.isSleeping=e}set isSleeping(e){this._sleeping=e,e?(this.vel=B.Zero,this.acc=B.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const e=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),s=this._bodyConfig.sleepBias;this.sleepMotion=s*this.sleepMotion+(1-s)*e,this.sleepMotion=j(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const e=this.owner.get(ue);if(e){e.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),e.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const s=e.get();if(s)return this._cachedInertia=s.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===dt.Fixed?0:1/this.inertia}get active(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get isActive(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get center(){return this.globalPos}onAdd(e){var s,r;this.transform=(s=this.owner)===null||s===void 0?void 0:s.get(et),this.motion=(r=this.owner)===null||r===void 0?void 0:r.get(Dt)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get globalPos(){return this.transform.globalPos}set globalPos(e){this.transform.globalPos=e}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e}get torque(){return this.motion.torque}set torque(e){this.motion.torque=e}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(e){this.transform.globalRotation=e}get scale(){return this.transform.globalScale}set scale(e){this.transform.globalScale=e}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(e){this.motion.scaleFactor=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}applyImpulse(e,s){if(this.collisionType!==dt.Active)return;const r=s.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(Je.X)>-1&&(r.x=0),this.limitDegreeOfFreedom.indexOf(Je.Y)>-1&&(r.y=0),this.vel.addEqual(r),!this.limitDegreeOfFreedom.includes(Je.Rotation)){const a=e.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*a.cross(s)}}applyLinearImpulse(e){if(this.collisionType!==dt.Active)return;const s=e.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(Je.X)&&(s.x=0),this.limitDegreeOfFreedom.includes(Je.Y)&&(s.y=0),this.vel=this.vel.add(s)}applyAngularImpulse(e,s){if(this.collisionType===dt.Active&&!this.limitDegreeOfFreedom.includes(Je.Rotation)){const r=e.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*r.cross(s)}}captureOldTransform(){this.__oldTransformCaptured=!0;const e=this.transform.get();e.clone(this.oldTransform),this.oldTransform.parent=e.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}Ct._ID=0,Ct._DEFAULT_CONFIG={...os().bodies};class hr extends bn{constructor(e){super(e),this.width=e.width,this.height=e.height,this.rasterize()}clone(){return new hr({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.color&&e.fillRect(0,0,this.width,this.height),this.strokeColor&&e.strokeRect(0,0,this.width,this.height)}}class mo extends bn{get radius(){return this._radius}set radius(e){this._radius=e,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(e){var s,r,a;super(e),this._radius=0;const l=(s=e.lineWidth)!==null&&s!==void 0?s:e.strokeColor?1:0;this.padding=(r=e.padding)!==null&&r!==void 0?r:2+l/2,this.radius=e.radius,this.filtering=(a=e.filtering)!==null&&a!==void 0?a:ce.Blended,this.rasterize()}clone(){return new mo({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.radius>0&&(e.beginPath(),e.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&e.fill(),this.strokeColor&&e.stroke())}}class Ss extends pi{constructor(e){var s,r;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(s=e?.useColliderShape)!==null&&s!==void 0?s:this.useColliderShape,this.useGraphicsBounds=(r=e?.useGraphicsBounds)!==null&&r!==void 0?r:this.useGraphicsBounds,this.localBounds=e?.localBounds}}class Ot{static CreateReversibleEasingFunction(e){return(s,r,a,l)=>a<r?r-(e(s,a,r,l)-a):e(s,r,a,l)}static CreateVectorEasingFunction(e){return(s,r,a,l)=>new B(e(s,r.x,a.x,l),e(s,r.y,a.y,l))}}Ot.Linear=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,s*u/r+e)),Ot.EaseInQuad=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,s*u*u+e)),Ot.EaseOutQuad=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,-s*u*(u-2)+e)),Ot.EaseInOutQuad=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r/2,u<1?s/2*u*u+e:(u--,-s/2*(u*(u-2)-1)+e))),Ot.EaseInCubic=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,s*u*u*u+e)),Ot.EaseOutCubic=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,u--,s*(u*u*u+1)+e)),Ot.EaseInOutCubic=Ot.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r/2,u<1?s/2*u*u*u+e:(u-=2,s/2*(u*u*u+2)+e)));class Wc{constructor(e){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=e}add(e){this._actions.push(e)}remove(e){const s=this._actions.indexOf(e);this._actions.splice(s,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const e=this._actions.length;for(let s=0;s<e;s++)this._actions[s].reset();this._completedActions=[]}update(e){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new Za(this._currentAction,this._entity))),this._currentAction.update(e),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new Qa(this._currentAction,this._entity));const s=this._actions.shift();s&&this._completedActions.push(s)}}}let Sp=0;function Bt(){return Sp++}class Nc{constructor(e,s,r){this.id=Bt(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new dr(e),this._actionQueue=this._repeatContext.getQueue(),this._repeat=r,this._originalRepeat=r,this._repeatBuilder(this._repeatContext),this._repeat--}update(e){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(e)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class Gc{constructor(e,s){this.id=Bt(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new dr(e),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(e){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(e))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function Vc(u,e,s){return(1-s)*u+e*s}function ch(u,e,s,r){const a=(u-e+W)%W>=Math.PI,l=Math.abs(e-u),f=W-l;let p=0,m=0;l>f?(p=f,m=l):(p=l,m=f);let w=0,y=1;switch(s){case R.ShortestPath:w=p,y=a?1:-1;break;case R.LongestPath:w=m,y=a?-1:1;break;case R.Clockwise:y=1,w=a?p:m;break;case R.CounterClockwise:y=-1,w=a?m:p;break}return u+y*(w*r)}function lr(u,e,s){return u.scale(1-s).add(e.scale(s))}function Xc(u,e,s){return(s-u)/(e-u)}function qc(u,e,s){const r=s.sub(u),a=e.sub(u),l=r.x/a.x,f=r.y/a.y;return Math.min(l,f)}function Hi(u,e,s,r,a){const l=Xc(u,e,a);return Vc(s,r,l)}function Ep(u,e,s,r,a){const l=qc(u,e,a);return lr(s,r,l)}function Yc(u){return u.offset instanceof B&&typeof u.duration=="number"}class jc{constructor(e,s){var r;if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._easing=Ot.Linear,this._offset=s.offset,this._easing=(r=s.easing)!==null&&r!==void 0?r:this._easing,this._tx=e.get(et),this._motion=e.get(Dt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=e;const s=j(Hi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),f=(a-r.x)/(e/1e3),p=(l-r.y)/(e/1e3);this._motion.vel.x=f,this._motion.vel.y=p,this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=z(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class dh{constructor(e,s,r,a){if(this.id=Bt(),this._started=!1,this._stopped=!1,this._entity=e,this._tx=e.get(et),this._motion=e.get(Dt),this._speed=a,this._offset=new B(s,r),a<=0)throw ot.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+a),new Error("Speed must be greater than 0 pixels per second")}update(e){this._started||(this._started=!0,this._start=new B(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(e){const s=e.get(et);return this._stopped||s.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Zc(u){return u.pos instanceof B&&typeof u.duration=="number"}class Qc{constructor(e,s){var r;if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._easing=Ot.Linear,this._end=s.pos,this._easing=(r=s.easing)!==null&&r!==void 0?r:this._easing,this._tx=e.get(et),this._motion=e.get(Dt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=e;const s=j(Hi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),f=(a-r.x)/(e/1e3),p=(l-r.y)/(e/1e3);this._motion.vel.x=f,this._motion.vel.y=p,this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=z(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class uh{constructor(e,s,r,a){this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Dt),this._end=new B(s,r),this._speed=a}update(e){this._started||(this._started=!0,this._start=new B(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const s=this._dir.scale(this._speed);this._motion.vel=z(s.x,s.y),this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){const s=e.get(et);return this._stopped||new B(s.pos.x,s.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Ip(u){return typeof u.angle=="number"&&typeof u.duration=="number"}class $c{constructor(e,s){var r;if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=s.angle,this._tx=e.get(et),this._motion=e.get(Dt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(r=s.rotationType)!==null&&r!==void 0?r:R.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=e;const s=j(Hi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=ch(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(r-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Kc{constructor(e,s,r,a){this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Dt),this._end=s,this._speed=r,this._rotationType=a||R.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const s=Math.abs(this._end-this._start),r=W-s;switch(s>r?(this._shortDistance=r,this._longDistance=s):(this._shortDistance=s,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+W)%W>=Math.PI,this._rotationType){case R.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case R.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case R.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case R.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Rp(u){return typeof u.angleRadiansOffset=="number"&&typeof u.duration=="number"}class Jc{constructor(e,s){var r;if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=s.angleRadiansOffset,this._tx=e.get(et),this._motion=e.get(Dt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(r=s.rotationType)!==null&&r!==void 0?r:R.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._endAngle=nt(this._startAngle+this._offset),this._started=!0),this._currentMs-=e;const s=j(Hi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=ch(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(r-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class td{constructor(e,s,r,a){this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Dt),this._speed=r,this._offset=s,this._rotationType=a||R.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const s=Math.abs(this._end-this._start),r=W-s;switch(s>r?(this._shortDistance=r,this._longDistance=s):(this._shortDistance=s,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+W)%W>=Math.PI,this._rotationType){case R.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case R.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case R.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case R.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function ed(u){return typeof u.scale=="object"&&typeof u.duration=="number"}class id{constructor(e,s){if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._endScale=z(1,1),this._startScale=z(1,1),this._endScale=s.scale,this._tx=e.get(et),this._motion=e.get(Dt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=e;const s=j(Hi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=lr(this._startScale,this._endScale,s),a=this._tx.scale,l=r.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=B.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class sd{constructor(e,s,r,a,l){this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Dt),this._endX=s,this._endY=r,this._speedX=a,this._speedY=l}update(e){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*s}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*s}this.isComplete()&&(this._tx.scale=z(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function nd(u){return typeof u.scaleOffset=="object"&&typeof u.duration=="number"}class rd{constructor(e,s){if(this.entity=e,this.id=Bt(),this._started=!1,this._stopped=!1,this._endScale=z(1,1),this._scaleOffset=z(0,0),this._startScale=z(1,1),this._scaleOffset=s.scaleOffset,this._tx=e.get(et),this._motion=e.get(Dt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=e;const s=j(Hi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=lr(this._startScale,this._endScale,s),a=this._tx.scale,l=r.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=B.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class od{constructor(e,s,r,a){this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Dt),this._offset=new B(s,r),this._speedX=this._speedY=a}update(e){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class ad{constructor(e){this.id=Bt(),this._hasBeenCalled=!1,this._method=e}update(e){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class hd{constructor(e,s,r,a,l){this.easingFcn=l,this.id=Bt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new B(0,0),this._lerpEnd=new B(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Dt),this._lerpDuration=a,this._lerpEnd=new B(s,r)}_initialize(){this._lerpStart=new B(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=z((s-this._tx.pos.x)/(e/1e3),(r-this._tx.pos.y)/(e/1e3))):(this._tx.pos=z(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=B.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=z(0,0),this._stopped=!0}}class ld{constructor(e,s,r,a,l){this.easingFcn=l,this.id=Bt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new B(0,0),this._lerpEnd=new B(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Dt),this._lerpDuration=a,this._offset=new B(s,r)}_initialize(){this._lerpStart=new B(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=z((s-this._tx.pos.x)/(e/1e3),(r-this._tx.pos.y)/(e/1e3))):(this._tx.pos=z(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=B.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=z(0,0),this._stopped=!0}}class cd{constructor(e,s,r,a=1){this.id=Bt(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=e.get(te),this._timeVisible=s,this._timeNotVisible=r,this._duration=(s+r)*a}update(e){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=e,this._totalTime+=e,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class dd{constructor(e,s,r){this.id=Bt(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=e.get(te),this._endOpacity=s,this._remainingTime=this._originalTime=r}update(e){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*e)/this._remainingTime),this._remainingTime-=e,this.isComplete()&&(this._graphics.opacity=this._endOpacity),ot.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class ud{constructor(e){this.id=Bt(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=e}update(e){this._started||(this._started=!0),this._elapsedTime+=e}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class fd{constructor(e){this.id=Bt(),this._stopped=!1,this._entity=e}update(e){this._entity.get(Sn).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class fh{constructor(e,s,r){this.id=Bt(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Dt),this._followTx=s.get(et),this._followMotion=s.get(Dt),this._current=new B(this._tx.pos.x,this._tx.pos.y),this._end=new B(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=r!==void 0?r:this._current.distance(this._end),this._speed=0}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(s!==0&&(this._speed=s),this._current=z(this._tx.pos.x,this._tx.pos.y),this._end=z(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const r=this._dir.scale(this._speed);this._motion.vel=z(r.x,r.y)}else this._motion.vel=z(0,0);this.isComplete()&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}stop(){this._motion.vel=z(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class _h{constructor(e,s,r){this.id=Bt(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=e.get(et),this._motion=e.get(Dt),this._meetTx=s.get(et),this._meetMotion=s.get(Dt),this._current=new B(this._tx.pos.x,this._tx.pos.y),this._end=new B(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=r||0,r!==void 0&&(this._speedWasSpecified=!0)}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));s!==0&&!this._speedWasSpecified&&(this._speed=s),this._current=z(this._tx.pos.x,this._tx.pos.y),this._end=z(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const r=this._dir.scale(this._speed);this._motion.vel=z(r.x,r.y),this.isComplete()&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class _d{constructor(e,s,r=1e3){var a;this.id=Bt(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=e.get(te),this._duration=r,this._entity=e,this._material=(a=e.scene)===null||a===void 0?void 0:a.engine.graphicsContext.createMaterial({name:"flash-material",color:s,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=r}update(e){var s;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=e,this._graphics&&((s=this._material)===null||s===void 0||s.update(r=>{r.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class cr{constructor(e){var s;if(this._distLookup=[],this.quality=4,e.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...e.controlPoints],this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(e){this._controlPoints=[...e],this._calculateLookup()}setControlPoint(e,s){this._controlPoints[e]=s,this._calculateLookup()}_calculateLookup(){let e=0;this._distLookup.length=0;let s=this.controlPoints[0];const r=this.controlPoints.length*this.quality;for(let a=0;a<r;a++){const l=a/(r-1),f=this.getPoint(l),p=s.distance(f);e+=p,this._distLookup.push(e),s=f}this._arcLength=e}_getTimeGivenDistance(e){const s=this._distLookup.length,r=this.arcLength;if(e>=0&&e<r){for(let a=0;a<s-1;a++)if(this._distLookup[a]<=e&&e<this._distLookup[a+1])return Hi(this._distLookup[a],this._distLookup[a+1],a/(s-1),(a+1)/(s-1),e)}return e/r}getPoint(e){const s=[...this.controlPoints];for(let r=1;r<s.length;r++)for(let a=0;a<s.length-r;a++)s[a]=lr(s[a],s[a+1],e);return s[0]}getTangent(e){const s=e*e,r=this.controlPoints[0],a=this.controlPoints[1],l=this.controlPoints[2],f=this.controlPoints[3];return r.scale(-3*s+6*e-3).add(a.scale(9*s-12*e+3).add(l.scale(-9*s+6*e).add(f.scale(3*s)))).normalize()}getUniformTangent(e){const s=e*this.arcLength,r=this._getTimeGivenDistance(s);return this.getTangent(r)}getNormal(e){return this.getTangent(e).normal()}getUniformNormal(e){return this.getUniformTangent(e).normal()}getUniformPoint(e){const s=e*this.arcLength,r=this._getTimeGivenDistance(s);return this.getPoint(r)}clone(){return new cr({controlPoints:[...this.controlPoints],quality:this.quality})}}class pd{constructor(e,s){var r;if(this.id=Bt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(et),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new cr({controlPoints:[z(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(r=s.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=e;const s=j(Hi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class gd{constructor(e,s){var r;if(this.id=Bt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(et),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new cr({controlPoints:[z(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(r=s.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=e;const s=j(Hi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class dr{constructor(e){this._entity=e,this._queue=new Wc(e)}getQueue(){return this._queue}update(e){this._queue.update(e)}clearActions(){this._queue.clearActions()}runAction(e){return e.reset(),this._queue.add(e),this}curveBy(e){return this._queue.add(new gd(this._entity,e)),this}curveTo(e){return this._queue.add(new pd(this._entity,e)),this}easeTo(...e){var s,r;let a=0,l=0,f=0,p=Ot.Linear;return e[0]instanceof B?(a=e[0].x,l=e[0].y,f=e[1],p=(s=e[2])!==null&&s!==void 0?s:p):(a=e[0],l=e[1],f=e[2],p=(r=e[3])!==null&&r!==void 0?r:p),this._queue.add(new hd(this._entity,a,l,f,p)),this}easeBy(...e){var s,r;let a=0,l=0,f=0,p=Ot.Linear;return e[0]instanceof B?(a=e[0].x,l=e[0].y,f=e[1],p=(s=e[2])!==null&&s!==void 0?s:p):(a=e[0],l=e[1],f=e[2],p=(r=e[3])!==null&&r!==void 0?r:p),this._queue.add(new ld(this._entity,a,l,f,p)),this}moveTo(e,s,r){let a=0,l=0,f=0;return e instanceof B?(a=e.x,l=e.y,f=+(s??0),this._queue.add(new uh(this._entity,a,l,f))):typeof e=="number"&&typeof s=="number"&&typeof r=="number"?(a=e,l=s,f=r,this._queue.add(new uh(this._entity,a,l,f))):Zc(e)&&this._queue.add(new Qc(this._entity,e)),this}moveBy(e,s,r){let a=0,l=0,f=0;return e instanceof B&&typeof s=="number"?(a=e.x,l=e.y,f=s,this._queue.add(new dh(this._entity,a,l,f))):typeof e=="number"&&typeof s=="number"&&typeof r=="number"?(a=e,l=s,f=r,this._queue.add(new dh(this._entity,a,l,f))):Yc(e)&&this._queue.add(new jc(this._entity,e)),this}rotateTo(e,s,r){return typeof e=="number"&&typeof s=="number"?this._queue.add(new Kc(this._entity,e,s,r)):typeof e=="object"&&this._queue.add(new $c(this._entity,e)),this}rotateBy(e,s,r){return typeof e=="object"?this._queue.add(new Jc(this._entity,e)):this._queue.add(new td(this._entity,e,s,r)),this}scaleTo(e,s,r,a){let l=1,f=1,p=0,m=0;return ed(e)?(this._queue.add(new id(this._entity,e)),this):(e instanceof B&&s instanceof B&&(l=e.x,f=e.y,p=s.x,m=s.y),typeof e=="number"&&typeof s=="number"&&(l=e,f=s,p=r,m=a),this._queue.add(new sd(this._entity,l,f,p,m)),this)}scaleBy(e,s,r){if(nd(e))return this._queue.add(new rd(this._entity,e)),this;let a=1,l=1;return e instanceof B&&(a=e.x,l=e.y,r=s),typeof e=="number"&&typeof s=="number"&&(a=e,l=s),this._queue.add(new od(this._entity,a,l,r)),this}blink(e,s,r=1){return this._queue.add(new cd(this._entity,e,s,r)),this}fade(e,s){return this._queue.add(new dd(this._entity,e,s)),this}flash(e,s=1e3){return this._queue.add(new _d(this._entity,e,s)),this}delay(e){return this._queue.add(new ud(e)),this}die(){return this._queue.add(new fd(this._entity)),this}callMethod(e){return this._queue.add(new ad(e)),this}repeat(e,s){return s?(this._queue.add(new Nc(this._entity,e,s)),this):(this.repeatForever(e),this)}repeatForever(e){return this._queue.add(new Gc(this._entity,e)),this}follow(e,s){return s===void 0?this._queue.add(new fh(this._entity,e)):this._queue.add(new fh(this._entity,e,s)),this}meet(e,s){return s===void 0?this._queue.add(new _h(this._entity,e)):this._queue.add(new _h(this._entity,e,s)),this}toPromise(){return new Promise(s=>{this._queue.add(new ad(()=>{s()}))})}}class Sn extends pi{constructor(){super(...arguments),this.dependencies=[et,Dt],this._ctx=null}onAdd(e){this._ctx=new dr(e)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(e){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(e)}update(e){var s;return(s=this._ctx)===null||s===void 0?void 0:s.update(e)}clearActions(){var e;(e=this._ctx)===null||e===void 0||e.clearActions()}curveBy(e){return this._getCtx().curveBy.apply(this._ctx,[e])}curveTo(e){return this._getCtx().curveTo.apply(this._ctx,[e])}easeTo(...e){return this._getCtx().easeTo.apply(this._ctx,e)}easeBy(...e){return this._getCtx().easeBy.apply(this._ctx,e)}moveTo(e,s,r){return this._getCtx().moveTo.apply(this._ctx,[e,s,r])}moveBy(e,s,r){return this._getCtx().moveBy.apply(this._ctx,[e,s,r])}rotateTo(e,s,r){return this._getCtx().rotateTo.apply(this._ctx,[e,s,r])}rotateBy(e,s,r){return this._getCtx().rotateBy.apply(this._ctx,[e,s,r])}scaleTo(e,s,r,a){return this._getCtx().scaleTo.apply(this._ctx,[e,s,r,a])}scaleBy(e,s,r){return this._getCtx().scaleBy.apply(this._ctx,[e,s,r])}blink(e,s,r){return this._getCtx().blink(e,s,r)}fade(e,s){return this._getCtx().fade(e,s)}flash(e,s=1e3){return this._getCtx().flash(e,s)}delay(e){return this._getCtx().delay(e)}die(){return this._getCtx().die()}callMethod(e){return this._getCtx().callMethod(e)}repeat(e,s){return this._getCtx().repeat(e,s)}repeatForever(e){return this._getCtx().repeatForever(e)}follow(e,s){return this._getCtx().follow(e,s)}meet(e,s){return this._getCtx().meet(e,s)}toPromise(){return this._getCtx().toPromise()}}function Dp(u){return u instanceof Ye}const Mp={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class Ye extends Ue{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(e){this.body.oldPos.setTo(e.x,e.y)}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e.clone()}get oldVel(){return this.body.oldVel}set oldVel(e){this.body.oldVel.setTo(e.x,e.y)}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e.clone()}set oldAcc(e){this.body.oldAcc.setTo(e.x,e.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(e){this.transform.rotation=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}get scale(){return this.get(et).scale}set scale(e){this.get(et).scale=e}get anchor(){return this._anchor}set anchor(e){this._anchor=wi(e,s=>this._handleAnchorChange(s)),this._handleAnchorChange(e)}_handleAnchorChange(e){this.graphics&&(this.graphics.anchor=e)}get offset(){return this._offset}set offset(e){this._offset=wi(e,s=>this._handleOffsetChange(s)),this._handleOffsetChange(e)}_handleOffsetChange(e){this.graphics&&(this.graphics.offset=e)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(e){e&&(e&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!e&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=e)}get color(){return this.graphics.color}set color(e){this.graphics.color=e}constructor(e){super(),this.events=new I,this._anchor=wi(B.Half,Tt=>this._handleAnchorChange(Tt)),this._offset=wi(B.Zero,Tt=>this._handleOffsetChange(Tt)),this.logger=ot.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=Tt=>{this._dragging&&(this.pos=Tt.worldPos)},this._pointerDragLeaveHandler=Tt=>{this._dragging&&(this.pos=Tt.worldPos)};const{name:s,x:r,y:a,pos:l,coordPlane:f,scale:p,width:m,height:w,radius:y,collider:A,vel:E,acc:D,rotation:L,angularVelocity:O,z:q,color:H,visible:N,opacity:$,anchor:Y,offset:J,collisionType:rt,collisionGroup:Z,silenceWarnings:ft}={...e};this.name=s??this.name,this.anchor=Y??Ye.defaults.anchor.clone(),this.offset=J??B.Zero,this.transform=new et,this.addComponent(this.transform),this.pos=l??z(r??0,a??0),this.rotation=L??0,this.scale=p??z(1,1),this.z=q??0,this.transform.coordPlane=f??Ie.World,this._silenceWarnings=ft??!1,this.pointer=new Ss,this.addComponent(this.pointer),this.graphics=new te({anchor:this.anchor,offset:this.offset,opacity:$}),this.addComponent(this.graphics),this.motion=new Dt,this.addComponent(this.motion),this.vel=E??B.Zero,this.acc=D??B.Zero,this.angularVelocity=O??0,this.actions=new Sn,this.addComponent(this.actions),this.body=new Ct,this.addComponent(this.body),this.body.collisionType=rt??dt.Passive,Z&&(this.body.group=Z),H&&(this.color=H),A?(this.collider=new ue(A),this.addComponent(this.collider)):y?(this.collider=new ue(He.Circle(y)),this.addComponent(this.collider),H&&this.graphics.add(new mo({color:H,radius:y}))):m>0&&w>0?(this.collider=new ue(He.Box(m,w,this.anchor)),this.addComponent(this.collider),H&&m&&w&&this.graphics.add(new hr({color:H,width:m,height:w}))):(this.collider=new ue,this.addComponent(this.collider)),this.graphics.isVisible=N??!0}clone(){const e=new Ye({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});e.clearComponents(),e.processComponentRemoval(),e.addComponent(e.transform=this.transform.clone(),!0),e.addComponent(e.pointer=this.pointer.clone(),!0),e.addComponent(e.graphics=this.graphics.clone(),!0),e.addComponent(e.motion=this.motion.clone(),!0),e.addComponent(e.actions=this.actions.clone(),!0),e.addComponent(e.body=this.body.clone(),!0),e.addComponent(e.collider=this.collider.clone(),!0);const s=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],r=this.getComponents();for(const a of r)s.includes(a)||e.addComponent(a.clone(),!0);return e}onInitialize(e){}_initialize(e){super._initialize(e);for(const s of this.children)s._initialize(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_prekill(e){this.events.emit("prekill",new Sa(this)),this.onPreKill(e)}onPreKill(e){}_postkill(e){this.events.emit("postkill",new Ea(this)),this.onPostKill(e)}onPostKill(e){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new oo(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(et).z}set z(e){this.get(et).z=e}get center(){const e=this.getGlobalPos();return new B(e.x+this.width/2-this.anchor.x*this.width,e.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new B(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(et).globalRotation}get globalRotation(){return this.get(et).globalRotation}getGlobalPos(){return this.get(et).globalPos}get globalPos(){return this.get(et).globalPos}getGlobalScale(){return this.get(et).globalScale}get globalScale(){return this.get(et).globalScale}get globalZ(){return this.get(et).globalZ}contains(e,s,r=!1){const a=z(e,s),l=this.get(ue);l.update();const f=l.get();if(!f)return!1;const p=f.contains(a);return r?p||this.children.some(m=>m.contains(e,s,!0)):p}within(e,s){const r=this.get(ue),a=e.get(ue),l=r.get(),f=a.get();return l&&f?l.getClosestLineBetween(f).getLength()<=s:!1}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s),this._postupdate(e,s),this._remove(e)}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreCollisionResolve(e,s,r,a){}onPostCollisionResolve(e,s,r,a){}onCollisionStart(e,s,r,a){}onCollisionEnd(e,s,r,a){}_preupdate(e,s){this.events.emit("preupdate",new Cs(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new Ps(e,s,this)),this.onPostUpdate(e,s)}}Ye.defaults={anchor:B.Half};function md(u){return u instanceof ph}class ph extends Ye{constructor(e){var s,r;super({...e}),this.get(et).coordPlane=Ie.Screen,this.anchor=(s=e?.anchor)!==null&&s!==void 0?s:z(0,0),this.body.collisionType=(r=e?.collisionType)!==null&&r!==void 0?r:dt.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!e?.collider&&e?.width>0&&e?.height>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(e){this._engine=e,super._initialize(e)}contains(e,s,r=!0){if(r)return super.contains(e,s);const a=this._engine.worldToScreenCoordinates(new B(e,s));return super.contains(a.x,a.y)}}class Zs{get complete(){return this._complete}constructor(e){var s;this._logger=ot.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const r=(s=e.action)!==null&&s!==void 0?s:e.fcn,a=e.interval,l=e.repeats,f=e.numberOfRepeats,p=e.randomRange,m=e.random;if(f&&f>=0&&(this.maxNumberOfRepeats=f,!l))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=Zs._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=a,p){if(p[0]>p[1])throw new Error("min value must be lower than max value for range");this.random=m??new M,this.randomRange=p,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=l||this.repeats,r&&this.on(r)}on(e){this._callbacks.push(e)}off(e){const s=this._callbacks.indexOf(e);this._callbacks.splice(s,1)}update(e){this._running&&(this._totalTimeAlive+=e,this._elapsedTime+=e,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(s=>{s.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(e,s){if(e&&e>=0&&(this._baseInterval=this.interval=e),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=s,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}Zs._MAX_ID=0;class vo extends pi{constructor(e){super(),this.parallaxFactor=z(1,1),this.parallaxFactor=e??this.parallaxFactor}}class wo extends pi{constructor(e,s=!0){super(),this.draw=e,this.useTransform=s}}function vd(u){return u&&u._dispatchPointerEvents&&u._processPointerToObject}class Fp{get events(){return this.object.events}init(e,s,r){this.object=e,this.contains=s,this.active=r}}class gh{constructor(){this._proxyPool=new Qn(()=>new Fp,e=>e,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(e,s,r){const a=this._proxyPool.rent(!1);a.init(e,s,r),this._proxies.push(a),this._objectToProxy.set(e,a)}_getProxy(e){const s=this._objectToProxy.get(e);if(s)return s;throw new Error("No PointerTargetProxy for object")}removeObject(e){const s=this._objectToProxy.get(e);if(s){const r=this._proxies.indexOf(s);r>-1&&this._proxies.splice(r,1),this._proxyPool.return(s)}}_objectCurrentlyUnderPointer(e,s){return!!(this._currentFrameObjectToPointers.has(e)&&this._currentFrameObjectToPointers.get(e).includes(s))}_objectWasUnderPointer(e,s){return!!(this._lastFrameObjectToPointers.has(e)&&this._lastFrameObjectToPointers.get(e).includes(s))}_entered(e,s){return this._objectCurrentlyUnderPointer(e,s)&&!this._lastFrameObjectToPointers.has(e)}_left(e,s){return!this._currentFrameObjectToPointers.has(e)&&this._objectWasUnderPointer(e,s)}addPointerToObject(e,s){const r=this._objectToProxy.get(e);r&&this._addPointerToProxy(r,s)}_addPointerToProxy(e,s){if(!this._currentFrameObjectToPointers.has(e)){this._currentFrameObjectToPointers.set(e,[s]);return}const r=this._currentFrameObjectToPointers.get(e);this._currentFrameObjectToPointers.set(e,r.concat(s))}dispatchEvents(e,s){const r=new Set(this._lastFrameObjectToPointers.keys()),a=new Set(this._currentFrameObjectToPointers.keys());let l,f,p;for(let m=0;m<s.length;m++){const w=s[m],y=this._getProxy(w);if(vd(w)&&w._dispatchPointerEvents(e),r.has(y)||a.has(y)){p=this._processDownAndEmit(e,y),f=this._processUpAndEmit(e,y),l=this._processMoveAndEmit(e,y);const A=[...l.values(),...p.values(),...f.values()];this._processEnterLeaveAndEmit(e,y,A),this._processCancelAndEmit(e,y),this._processWheelAndEmit(e,y)}}}processPointerToObject(e,s){for(let r=0;r<s.length;r++){const a=s[r],l=this._getProxy(a);vd(a)&&a._processPointerToObject(e);for(const[f,p]of e.currentFramePointerCoords.entries())l.contains(p)&&this._addPointerToProxy(l,f)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(e,s){const r=new Map;for(const a of e.currentFrameDown)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerdown",a),e.isDragStart(a.pointerId)&&s.events.emit("pointerdragstart",a)),r.set(a.pointerId,a);return r}_processUpAndEmit(e,s){const r=new Map;for(const a of e.currentFrameUp)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerup",a),e.isDragEnd(a.pointerId)&&s.events.emit("pointerdragend",a)),r.set(a.pointerId,a);return r}_processMoveAndEmit(e,s){const r=new Map;for(const a of e.currentFrameMove)a.active&&s.active()&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointermove",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragmove",a)),r.set(a.pointerId,a);return r}_processEnterLeaveAndEmit(e,s,r){for(const a of r){if(a.active&&s.active()&&this._entered(s,a.pointerId)){s.events.emit("pointerenter",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragenter",a);break}if(a.active&&s.active()&&(this._left(s,a.pointerId)||this._objectCurrentlyUnderPointer(s,a.pointerId)&&a.type==="up")){s.events.emit("pointerleave",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragleave",a);break}}}_processCancelAndEmit(e,s){for(const r of e.currentFrameCancel)r.active&&s.active()&&this._objectCurrentlyUnderPointer(s,r.pointerId)&&s.events.emit("pointercancel",r)}_processWheelAndEmit(e,s){for(const r of e.currentFrameWheel)r.active&&s.active()&&this._objectCurrentlyUnderPointer(s,0)&&s.events.emit("pointerwheel",r)}}const Bp={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class wd extends Ue{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let e=0;e<this.tiles.length;e++)this.tiles[e]&&this.tiles[e].flagDirty()}get x(){var e;return(e=this.transform.pos.x)!==null&&e!==void 0?e:0}set x(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.get(et).pos=z(e,this.y))}get y(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.pos.y)!==null&&s!==void 0?s:0}set y(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.transform.pos=z(this.x,e))}get z(){var e;return(e=this.transform.z)!==null&&e!==void 0?e:0}set z(e){this.transform&&(this.transform.z=e)}get rotation(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.rotation)!==null&&s!==void 0?s:0}set rotation(e){this.transform&&(this.transform.rotation=e)}get scale(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.scale)!==null&&s!==void 0?s:B.One}set scale(e){var s;!((s=this.transform)===null||s===void 0)&&s.scale&&(this.transform.scale=e)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get vel(){return this._motion.vel}set vel(e){this._motion.vel=e}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,r,a;super([],e.name),this.events=new I,this._token=0,this.logger=ot.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(s=e.meshingLookBehind)!==null&&s!==void 0?s:this.meshingLookBehind,this.addComponent(new et),this.addComponent(new Dt),this.addComponent(new Ct({type:dt.Fixed})),this.addComponent(new te({onPostDraw:(f,p)=>this.draw(f,p)})),this.addComponent(new wo((f,p)=>this.debug(f,p),!1)),this.addComponent(new ue),this.addComponent(new Ss),this.pointer=this.get(Ss),this._graphics=this.get(te),this.transform=this.get(et),this._motion=this.get(Dt),this.collider=this.get(ue),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(r=e.pos)!==null&&r!==void 0?r:B.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(a=e.renderFromTopOfGraphic)!==null&&a!==void 0?a:this.renderFromTopOfGraphic,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight,this.rows=e.rows,this.columns=e.columns,this._pointerEventDispatcher=new gh,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let l=[];for(let f=0;f<this.columns;f++){for(let p=0;p<this.rows;p++){const m=new xd({x:f,y:p,map:this});m.map=this,this.tiles[f+p*this.columns]=m,this._pointerEventDispatcher.addObject(m,w=>m.bounds.contains(w.worldPos),()=>!0),l.push(m),this._rows[p]||(this._rows[p]=[]),this._rows[p].push(m)}this._cols[f]=l,l=[]}this._graphics.localBounds=new at({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(e){super._initialize(e),this._engine=e}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:B.Zero;{const r=e.offset;return this._originalOffsets.set(e,r),r}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const e=[];this._composite=this.collider.useCompositeCollider([]);let s=null;const r=(l,f)=>l&&f?l.top===f.top&&l.bottom===f.bottom&&l.right===f.left:!1,a=(l,f,p=this.meshingLookBehind)=>{if(!l)return!1;for(let m=f.length-1;m>=0;m--){if(p--<0)return!1;const w=f[m];if(r(w,l))return f[m]=w.combine(l),!0}return!1};for(let l=0;l<this.columns;l++){for(let f=0;f<this.rows;f++){const p=this.tiles[l+f*this.columns];if(p.solid)if(p.getColliders().length>0){for(const m of p.getColliders()){const w=this._getOrSetColliderOriginalOffset(m);m.offset=z(p.x*this.tileWidth*this.scale.x,p.y*this.tileHeight*this.scale.y).add(w),m.owner=this,this._composite.addCollider(m)}s&&!a(s,e)&&e.push(s),s=null}else s?s=s.combine(p.defaultGeometry):s=p.defaultGeometry;else s&&!a(s,e)&&e.push(s),s=null}s&&!a(s,e)&&e.push(s),s=null}for(const l of e){const f=He.Box(l.width,l.height,B.Zero,z(l.left-this.pos.x,l.top-this.pos.y));f.owner=this,this._composite.addCollider(f)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(e){var s;return(s=this.tiles[e])!==null&&s!==void 0?s:null}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const{x:s,y:r}=this._getTileCoordinates(e),a=this.getTile(s,r);return s>=0&&r>=0&&s<this.columns&&r<this.rows&&a?a:null}_getTileCoordinates(e){e=this.transform.applyInverse(e);const s=Math.floor(e.x/this.tileWidth),r=Math.floor(e.y/this.tileHeight);return{x:s,y:r}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let e=this._engine.screen.getWorldBounds();const s=this.get(vo);if(s&&this.isInitialized){let D=this.pos;const L=B.One.sub(s.parallaxFactor),O=this._engine.currentScene.camera.pos.scale(L);D=D.sub(O),e=e.translate(D)}const r=this.transform.coordPlane===Ie.Screen?this._engine.screen.getScreenBounds():e,a=this._getTileCoordinates(r.topLeft),l=this._getTileCoordinates(r.topRight),f=this._getTileCoordinates(r.bottomRight),p=this._getTileCoordinates(r.bottomLeft),m=Math.min(j(a.x,0,this.columns-1),j(l.x,0,this.columns-1)),w=Math.min(j(a.y,0,this.rows-1),j(l.y,0,this.rows-1)),y=Math.max(j(f.x,0,this.columns-1),j(p.x,0,this.columns-1)),A=Math.max(j(f.y,0,this.rows-1),j(p.y,0,this.rows-1)),E=[];for(let D=m;D<=y;D++)for(let L=w;L<=A;L++)E.push(this.getTile(D,L));return E}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(e,s){this._initialize(e),this.onPreUpdate(e,s),this.emit("preupdate",new Cs(e,s,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(e,s),this.emit("postupdate",new Ps(e,s,this))}draw(e,s){if(!this.isInitialized)return;this.emit("predraw",new An(e,s,this));let r,a,l;const f=this.getOnScreenTiles();for(let p=0;p<f.length;p++){const m=f[p],w=m.getGraphicsOffsets();for(r=m.getGraphics(),a=0,l=r.length;a<l;a++){const y=r[a],A=w[a];if(y){Ta(y)&&y?.tick(s,this._token);const E=this.renderFromTopOfGraphic?0:y.height-this.tileHeight;y.draw(e,m.x*this.tileWidth+A.x,m.y*this.tileHeight-E+A.y)}}}this.emit("postdraw",new Cn(e,s,this))}debug(e,s){const{showAll:r,showGrid:a,gridColor:l,gridWidth:f,showSolidBounds:p,solidBoundsColor:m,showColliderGeometry:w}=s.tilemap,{geometryColor:y,geometryLineWidth:A,geometryPointSize:E}=s.collider,D=this.tileWidth*this.columns*this.scale.x,L=this.tileHeight*this.rows*this.scale.y,O=this.pos;if(a||r){for(let q=0;q<this.rows+1;q++){const H=z(0,q*this.tileHeight*this.scale.y);e.drawLine(O.add(H),O.add(z(D,H.y)),l,f)}for(let q=0;q<this.columns+1;q++){const H=z(q*this.tileWidth*this.scale.x,0);e.drawLine(O.add(H),O.add(z(H.x,L)),l,f)}}if(r||p||w){const q=this._composite.getColliders();e.save(),e.translate(this.pos.x,this.pos.y),e.scale(this.scale.x,this.scale.y);for(const H of q){const N=H.localBounds,$=H.worldPos.sub(this.pos);p&&e.drawRectangle($,N.width,N.height,m)}if(e.restore(),w)for(const H of q)H.debug(e,y,{lineWidth:A,pointSize:E})}if(r||p){if(e.save(),e.z=999,p)for(let q=0;q<this.tiles.length;q++)this.tiles[q].bounds.draw(e);e.restore()}}}class xd{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(e){var s;(s=this.map)===null||s===void 0||s.flagCollidersDirty(),this._solid=e}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(e,s){this._graphics.push(e),s?.offset?this._offsets.push(s.offset):this._offsets.push(B.Zero)}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&(this._graphics.splice(s,1),this._offsets.splice(s,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(e){var s,r;this._posDirty=!1,this.events=new I,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=e.x,this.y=e.y,this.map=e.map,this._width=e.map.tileWidth*this.map.scale.x,this._height=e.map.tileHeight*this.map.scale.y,this.solid=(s=e.solid)!==null&&s!==void 0?s:this.solid,this._graphics=(r=e.graphics)!==null&&r!==void 0?r:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const e=this.map.pos.add(z(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new at(e.x,e.y,e.x+this.map.tileWidth,e.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(z(this.x*this._width,this.y*this._height)),this._bounds=new at(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new B(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}class bd{constructor(e){this.camera=e}lockToActor(e){this.camera.addStrategy(new yd(e))}lockToActorAxis(e,s){this.camera.addStrategy(new Ad(e,s))}elasticToActor(e,s,r){this.camera.addStrategy(new Cd(e,s,r))}radiusAroundActor(e,s){this.camera.addStrategy(new Pd(e,s))}limitCameraBounds(e){this.camera.addStrategy(new Td(e))}}var xo;(function(u){u[u.X=0]="X",u[u.Y=1]="Y"})(xo||(xo={}));class yd{constructor(e){this.target=e,this.action=(s,r,a,l)=>s.center}}class Ad{constructor(e,s){this.target=e,this.axis=s,this.action=(r,a,l,f)=>{const p=r.center,m=a.getFocus();return this.axis===xo.X?new B(p.x,m.y):new B(m.x,p.y)}}}class Cd{constructor(e,s,r){this.target=e,this.cameraElasticity=s,this.cameraFriction=r,this.action=(a,l,f,p)=>{const m=a.center;let w=l.getFocus(),y=l.vel.clone();const A=m.sub(w).scale(this.cameraElasticity);y=y.add(A);const E=y.scale(-1).scale(this.cameraFriction);return y=y.add(E),w=w.add(y),w}}}class Pd{constructor(e,s){this.target=e,this.radius=s,this.action=(r,a,l,f)=>{const p=r.center,m=a.getFocus(),w=p.sub(m),y=w.magnitude;if(y>=this.radius){const A=y-this.radius;return m.add(w.normalize().scale(A))}return m}}}class Td{constructor(e){this.target=e,this.boundSizeChecked=!1,this.action=(s,r,a,l)=>{const f=r.getFocus();this.boundSizeChecked||((s.bottom-s.top<a.drawHeight||s.right-s.left<a.drawWidth)&&ot.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let p=f.x,m=f.y;return f.x<s.left+a.halfDrawWidth?p=s.left+a.halfDrawWidth:f.x>s.right-a.halfDrawWidth&&(p=s.right-a.halfDrawWidth),f.y<s.top+a.halfDrawHeight?m=s.top+a.halfDrawHeight:f.y>s.bottom-a.halfDrawHeight&&(m=s.bottom-a.halfDrawHeight),z(p,m)}}}const kp={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class Sd{constructor(){this.events=new I,this.transform=le.identity(),this.inverse=le.identity(),this._cameraStrategies=[],this.strategy=new bd(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new As(B.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=B.Zero,this.acc=B.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Ot.EaseInOutCubic,this._easing=Ot.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=z(0,0)}get zoom(){return this._z}set zoom(e){this._z=e,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(e){this._angularVelocity=e}get pos(){return this._pos}set pos(e){this._posChanged=!0,this._pos=new As(e,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(e){!this._follow&&!this._cameraMoving&&(this.pos=z(e,this.pos.y))}get y(){return this.pos.y}set y(e){!this._follow&&!this._cameraMoving&&(this.pos=z(this.pos.x,e))}get dx(){return this.vel.x}set dx(e){this.vel=z(e,this.vel.y)}get dy(){return this.vel.y}set dy(e){this.vel=z(this.vel.x,e)}get ax(){return this.acc.x}set ax(e){this.acc=z(e,this.acc.y)}get ay(){return this.acc.y}set ay(e){this.acc=z(this.acc.x,e)}getFocus(){return this.pos}move(e,s,r=Ot.EaseInOutCubic){if(typeof r!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(e):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(e),this._lerpPromise=new Promise(a=>{this._lerpResolve=a}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=s,this._lerpEnd=e,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=r,this._lerpPromise)}shake(e,s,r){this._isShaking=!0,this._shakeMagnitudeX=e,this._shakeMagnitudeY=s,this._shakeDuration=r}zoomOverTime(e,s=0,r=Ot.EaseInOutCubic){if(this._zoomPromise=new Promise(a=>{this._zoomResolve=a}),s)this._isZooming=!0,this._zoomEasing=r,this._currentZoomTime=0,this._zoomDuration=s,this._zoomStart=this.zoom,this._zoomEnd=e;else return this._isZooming=!1,this.zoom=e,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new at(0,0,0,0)}addStrategy(e){this._cameraStrategies.push(e)}removeStrategy(e){ts(e,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(e,s){this.events.emit("preupdate",new Cs(e,s,this)),this.onPreUpdate(e,s)}onPreUpdate(e,s){}_postupdate(e,s){this.events.emit("postupdate",new Ps(e,s,this)),this.onPostUpdate(e,s)}onPostUpdate(e,s){}get isInitialized(){return this._isInitialized}_initialize(e){if(!this.isInitialized){this._engine=e,this._screen=e.screen;const s=this._screen.contentArea;let r=z(s.width/2,s.height/2);if(!this._engine.loadingComplete){const a=this._screen.peekResolution();a&&(r=z(a.width/2,a.height/2))}this._halfWidth=r.x,this._halfHeight=r.y,this._posChanged||(this.pos=r),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(e,e.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(e),this.events.emit("initialize",new Pn(e,this)),this._isInitialized=!0}}onInitialize(e){}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}runStrategies(e,s){for(const r of this._cameraStrategies)this.pos=r.action.call(r,r.target,this,e,s)}updateViewport(){this._viewport=new at(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(e,s){if(this._initialize(e),this._preupdate(e,s),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(s/1e3)),this.zoom+=this.dz*s/1e3,this.vel=this.vel.add(this.acc.scale(s/1e3)),this.dz+=this.az*s/1e3,this.rotation+=this.angularVelocity*s/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const r=this._zoomEasing,a=r(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=a,this._currentZoomTime+=s}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const a=Ot.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=a,this._currentLerpTime+=s}else{this.pos=this._lerpEnd;const r=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(r)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=s,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(e,s),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(e,s),this._posChanged=!1}draw(e){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const s=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,r=this.pos.scale(s).add(this._oldPos.scale(1-s));r.clone(this.drawPos),this.updateTransform(r)}if(e.snapToPixel){const s=this.drawPos.clone(this._snapPos);s.x=~~(s.x+_t*V(s.x)),s.y=~~(s.y+_t*V(s.y)),s.clone(this.drawPos),this.updateTransform(s)}e.multiply(this.transform)}updateTransform(e){const s=this._screen.resolution.width/this.zoom,r=this._screen.resolution.height/this.zoom,a=z(-e.x+s/2+this._xShake,-e.y+r/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(s/2,r/2),this.transform.rotate(this.rotation),this.transform.translate(-s/2,-r/2),this.transform.translate(a.x,a.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const Lp={ExitTrigger:"exit",EnterTrigger:"enter"};class Ed extends Ye{constructor(e){var s,r,a,l;super({...e}),this.events=new I,this.filter=(s=e.filter)!==null&&s!==void 0?s:()=>!0,this.repeat=(r=e.repeat)!==null&&r!==void 0?r:-1,this.action=(a=e.action)!==null&&a!==void 0?a:()=>{},this.target=e.target,this.graphics.isVisible=(l=e.visible)!==null&&l!==void 0?l:!1,this.body.collisionType=dt.Passive,this.events.on("collisionstart",({other:f})=>{this._matchesTarget(f.owner)&&(this.events.emit("enter",new Ya(this,f.owner)),this._dispatchAction(f.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:f})=>{this._matchesTarget(f.owner)&&this.events.emit("exit",new ja(this,f.owner))})}_matchesTarget(e){return this.filter(e)&&(this.target===void 0||this.target===e)}_dispatchAction(e){this.repeat!==0&&(this.action.call(this,e),this.repeat--)}}const Oi={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var oi;(function(u){u.Update="update",u.Draw="draw"})(oi||(oi={}));class ci{}ci.priority=Oi.Average;class Id{constructor(e){this._world=e,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>s=>{this.addEntity(s)},this._createChildRemovedHandler=()=>s=>{this.removeEntity(s,!1)},this._entitiesToRemove=[]}updateEntities(e,s){for(let r=0;r<this.entities.length;r++){const a=this.entities[r];a.update(e.engine,s),a.isActive||this.removeEntity(a)}}findEntitiesForRemoval(){for(let e=0;e<this.entities.length;e++){const s=this.entities[e];s.isActive||this.removeEntity(s)}}addEntity(e){if(e.isActive=!0,e.scene=this._world.scene,e&&!this._entityIndex[e.id]){this._entityIndex[e.id]=e,this.entities.push(e),this._world.queryManager.addEntity(e),e.children.forEach(a=>{a.scene=e.scene,this.addEntity(a)});const s=this._createChildAddedHandler();this._childAddedHandlerMap.set(e,s);const r=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(e,r),e.childrenAdded$.subscribe(s),e.childrenRemoved$.subscribe(r)}}removeEntity(e,s=!0){var r,a;let l=0;e instanceof Ue?l=e.id:l=e;const f=this._entityIndex[l];if(f&&f.isActive&&(f.isActive=!1),f&&s){this._entitiesToRemove.push(f);return}if(delete this._entityIndex[l],f){f.scene=null,ts(f,this.entities),this._world.queryManager.removeEntity(f),f.children.forEach(w=>{w.scene=null,this.removeEntity(w,s)});const p=this._childAddedHandlerMap.get(f);p&&f.childrenAdded$.unsubscribe(p);const m=this._childRemovedHandlerMap.get(f);m&&f.childrenRemoved$.unsubscribe(m),!((a=(r=this._world)===null||r===void 0?void 0:r.scene)===null||a===void 0)&&a.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let e=0;e<this._entitiesToRemove.length;e++){const s=this._entitiesToRemove[e];s.isActive||this.removeEntity(s,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let e=0;e<this.entities.length;e++)this.entities[e].processComponentRemoval()}getById(e){return this._entityIndex[e]}getByName(e){return this.entities.filter(s=>s.name===e)}clear(){for(let e=this.entities.length-1;e>=0;e--)this.removeEntity(this.entities[e])}}class ur{constructor(e){if(this.requiredComponents=e,this.components=new Set,this.entities=[],this.entityAdded$=new Ve,this.entityRemoved$=new Ve,e.length===0)throw new Error("Cannot create query without components");for(const s of e)this.components.add(s);this.id=ur.createId(e)}static createId(e){return e.slice().map(s=>s.name).sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAll(Array.from(this.components))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class fr{constructor(e){if(this.requiredTags=e,this.tags=new Set,this.entities=[],this.entityAdded$=new Ve,this.entityRemoved$=new Ve,e.length===0)throw new Error("Cannot create tag query without tags");for(const s of e)this.tags.add(s);this.id=fr.createId(e)}static createId(e){return e.slice().sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAllTags(Array.from(this.tags))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class Rd{constructor(e){this._world=e,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=s=>r=>{this.addComponent(s,r)},this._createRemoveComponentHandler=s=>r=>{this.removeComponent(s,r)},this._createAddTagHandler=s=>r=>{this.addTag(s,r)},this._createRemoveTagHandler=s=>r=>{this.removeTag(s,r)}}createQuery(e){const s=ur.createId(e);if(this._queries.has(s))return this._queries.get(s);const r=new ur(e);this._queries.set(r.id,r);for(const a of e){const l=this._componentToQueriesIndex.get(a);l?l.push(r):this._componentToQueriesIndex.set(a,[r])}for(const a of this._world.entities)this.addEntity(a);return r}createTagQuery(e){const s=fr.createId(e);if(this._tagQueries.has(s))return this._tagQueries.get(s);const r=new fr(e);this._tagQueries.set(r.id,r);for(const a of e){const l=this._tagToQueriesIndex.get(a);l?l.push(r):this._tagToQueriesIndex.set(a,[r])}for(const a of this._world.entities)this.addEntity(a);return r}addEntity(e){const s=this._addComponentHandlers.get(e),r=this._removeComponentHandlers.get(e),a=s??this._createAddComponentHandler(e),l=r??this._createRemoveComponentHandler(e);this._addComponentHandlers.set(e,a),this._removeComponentHandlers.set(e,l);const f=this._addTagHandlers.get(e),p=this._removeTagHandlers.get(e),m=f??this._createAddTagHandler(e),w=p??this._createRemoveTagHandler(e);this._addTagHandlers.set(e,m),this._removeTagHandlers.set(e,w);for(const y of this._queries.values())y.checkAndAdd(e);for(const y of this._tagQueries.values())y.checkAndAdd(e);e.componentAdded$.subscribe(a),e.componentRemoved$.subscribe(l),e.tagAdded$.subscribe(m),e.tagRemoved$.subscribe(w)}removeEntity(e){const s=this._addComponentHandlers.get(e),r=this._removeComponentHandlers.get(e);for(const f of this._queries.values())f.removeEntity(e);s&&e.componentAdded$.unsubscribe(s),r&&e.componentRemoved$.unsubscribe(r);const a=this._addTagHandlers.get(e),l=this._removeTagHandlers.get(e);for(const f of this._tagQueries.values())f.removeEntity(e);a&&e.tagAdded$.unsubscribe(a),l&&e.tagRemoved$.unsubscribe(l)}addComponent(e,s){var r;const a=(r=this._componentToQueriesIndex.get(s.constructor))!==null&&r!==void 0?r:[];for(const l of a)l.checkAndAdd(e)}removeComponent(e,s){var r;const a=(r=this._componentToQueriesIndex.get(s.constructor))!==null&&r!==void 0?r:[];for(const l of a)l.removeEntity(e)}addTag(e,s){var r;const a=(r=this._tagToQueriesIndex.get(s))!==null&&r!==void 0?r:[];for(const l of a)l.checkAndAdd(e)}removeTag(e,s){var r;const a=(r=this._tagToQueriesIndex.get(s))!==null&&r!==void 0?r:[];for(const l of a)l.removeEntity(e)}}function Dd(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class Md{constructor(e){this._world=e,this.systems=[],this.initialized=!1}get(e){return this.systems.find(s=>s instanceof e)}addSystem(e){let s;e instanceof ci?s=e:s=new e(this._world),this.systems.push(s),this.systems.sort((r,a)=>r.constructor.priority-a.constructor.priority),this.initialized&&s.initialize&&s.initialize(this._world,this._world.scene)}removeSystem(e){ts(e,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const e of this.systems)e.initialize&&e.initialize(this._world,this._world.scene)}}updateSystems(e,s,r){const a=this.systems.filter(l=>l.systemType===e);for(const l of a)l.preupdate&&l.preupdate(s,r);for(const l of a)l.update(r);for(const l of a)l.postupdate&&l.postupdate(s,r)}clear(){for(let e=this.systems.length-1;e>=0;e--)this.removeSystem(this.systems[e])}}class Fd{constructor(e){this.scene=e,this._logger=ot.getInstance(),this.queryManager=new Rd(this),this.entityManager=new Id(this),this.systemManager=new Md(this)}query(e){return this.queryManager.createQuery(e)}queryTags(e){return this.queryManager.createTagQuery(e)}update(e,s){e===oi.Update&&this.entityManager.updateEntities(this.scene,s),this.systemManager.updateSystems(e,this.scene,s),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(e){if(e instanceof Ue){this.entityManager.addEntity(e);return}if(e instanceof ci||Dd(e)){this.systemManager.addSystem(e);return}this._logger.warn(`Could not add entity/system ${e.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(e){return this.systemManager.get(e)}remove(e,s=!0){if(e instanceof Ue){this.entityManager.removeEntity(e,s);return}if(e instanceof ci){this.systemManager.removeSystem(e);return}this._logger.warn(`Could not remove entity/system ${e.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class bo extends ci{constructor(e,s){super(),this.world=e,this.physics=s,this.systemType=oi.Update,this._physicsConfigDirty=!1,s.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([et,Dt])}update(e){let s,r;const a=this.query.entities,l=this.physics.config.substep;for(let f=0;f<a.length;f++){s=a[f].get(et),r=a[f].get(Dt);const p=a[f].get(Ct);if(this._physicsConfigDirty&&p&&p.updatePhysicsConfig(this.physics.config.bodies),p?.isSleeping)continue;const m=r.acc.clone();p?.collisionType===dt.Active&&p?.useGravity&&m.addEqual(this.physics.config.gravity),a[f].parent||this.captureOldTransformWithChildren(a[f]),Xe.integrate(s,r,m,e/l)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(e){var s;(s=e.get(Ct))===null||s===void 0||s.captureOldTransform();for(let r=0;r<e.children.length;r++)this.captureOldTransformWithChildren(e.children[r])}}bo.priority=Oi.Higher;class mh{constructor(e){this.config=e,this.directionMap=new Map,this.distanceMap=new Map}solve(e){this.preSolve(e),e=e.filter(r=>!r.isCanceled());let s;switch(this.config.contactSolveBias){case rs.HorizontalFirst:{s=ah;break}case rs.VerticalFirst:{s=oh;break}default:s=hh}e.sort((r,a)=>{const l=this.directionMap.get(r.id),f=this.directionMap.get(a.id),p=this.distanceMap.get(r.id),m=this.distanceMap.get(a.id);return s[l]-s[f]||p-m});for(const r of e)this.solvePosition(r),this.solveVelocity(r);return this.postSolve(e),e}preSolve(e){for(let r=0;r<e.length;r++){const a=e[r];if(Math.abs(a.mtv.x)<1e-4&&Math.abs(a.mtv.y)<1e-4){a.cancel();continue}const l=St.fromDirection(a.mtv),f=a.mtv.negate(),p=Math.abs(a.info.separation);this.distanceMap.set(a.id,p),this.directionMap.set(a.id,l===St.Left||l===St.Right?"horizontal":"vertical"),a.colliderA.events.emit("precollision",new Ns(a.colliderA,a.colliderB,l,f,a)),a.colliderB.events.emit("precollision",new Ns(a.colliderB,a.colliderA,St.getOpposite(l),f.negate(),a))}}postSolve(e){var s,r;for(let a=0;a<e.length;a++){const l=e[a];if(l.isCanceled())continue;const f=l.colliderA,p=l.colliderB,m=(s=f.owner)===null||s===void 0?void 0:s.get(Ct),w=(r=p.owner)===null||r===void 0?void 0:r.get(Ct);if(m&&w&&(m.collisionType===dt.Passive||w.collisionType===dt.Passive))continue;const y=St.fromDirection(l.mtv),A=l.mtv.negate();l.colliderA.events.emit("postcollision",new Gs(l.colliderA,l.colliderB,y,A,l)),l.colliderB.events.emit("postcollision",new Gs(l.colliderB,l.colliderA,St.getOpposite(y),A.negate(),l))}}solvePosition(e){var s,r;if(!e.colliderA.bounds.overlaps(e.colliderB.bounds,1e-4)){e.cancel();return}if(Math.abs(e.mtv.x)<1e-4&&Math.abs(e.mtv.y)<1e-4){e.cancel();return}let l=e.mtv;const f=e.colliderA,p=e.colliderB,m=(s=f.owner)===null||s===void 0?void 0:s.get(Ct),w=(r=p.owner)===null||r===void 0?void 0:r.get(Ct);if(m&&w){if(m.collisionType===dt.Passive||w.collisionType===dt.Passive)return;m.collisionType===dt.Active&&w.collisionType===dt.Active&&(l=l.scale(.5)),m.collisionType===dt.Active&&(m.globalPos.x-=l.x,m.globalPos.y-=l.y,f.update(m.transform.get())),w.collisionType===dt.Active&&(w.globalPos.x+=l.x,w.globalPos.y+=l.y,p.update(w.transform.get()))}}solveVelocity(e){var s,r;if(e.isCanceled())return;const a=e.colliderA,l=e.colliderB,f=(s=a.owner)===null||s===void 0?void 0:s.get(Ct),p=(r=l.owner)===null||r===void 0?void 0:r.get(Ct);if(f&&p){if(f.collisionType===dt.Passive||p.collisionType===dt.Passive)return;const m=e.normal,w=m.negate();if(f.collisionType===dt.Active&&f.vel.normalize().dot(w)<0){const y=m.scale(m.dot(f.vel.negate()));f.vel=f.vel.add(y)}if(p.collisionType===dt.Active&&p.vel.normalize().dot(m)<0){const y=w.scale(w.dot(p.vel.negate()));p.vel=p.vel.add(y)}}}}class Bd{constructor(e,s,r){this.point=e,this.local=s,this.contact=r,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new B(0,0),this.bToContact=new B(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const e=this.contact.bodyA,s=this.contact.colliderA,r=this.contact.bodyB,a=this.contact.colliderB;if(e&&r){const l=this.contact.normal,f=this.contact.tangent;this.aToContact=this.point.sub(s.center),this.bToContact=this.point.sub(a.center);const p=this.aToContact.cross(l),m=this.bToContact.cross(l);this.normalMass=e.inverseMass+r.inverseMass+e.inverseInertia*p*p+r.inverseInertia*m*m;const w=this.aToContact.cross(f),y=this.bToContact.cross(f);this.tangentMass=e.inverseMass+r.inverseMass+e.inverseInertia*w*w+r.inverseInertia*y*y}return this}getRelativeVelocity(){const e=this.contact.bodyA,s=this.contact.bodyB;if(e&&s){const r=e.vel.add(B.cross(e.angularVelocity,this.aToContact));return s.vel.add(B.cross(s.angularVelocity,this.bToContact)).sub(r)}return B.Zero}}class vh{constructor(e){this.config=e,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(e){var s;return(s=this.idToContactConstraint.get(e))!==null&&s!==void 0?s:[]}solve(e){this.preSolve(e),e=e.filter(r=>!r.isCanceled());let s;switch(this.config.contactSolveBias){case rs.HorizontalFirst:{s=ah;break}case rs.VerticalFirst:{s=oh;break}default:s=hh}return e.sort((r,a)=>{const l=this.directionMap.get(r.id),f=this.directionMap.get(a.id),p=this.distanceMap.get(r.id),m=this.distanceMap.get(a.id);return s[l]-s[f]||p-m}),this.solveVelocity(e),this.solvePosition(e),this.postSolve(e),e}preSolve(e){var s,r,a,l;for(let m=0;m<e.length;m++){const w=e[m];if(Math.abs(w.mtv.x)<1e-4&&Math.abs(w.mtv.y)<1e-4){w.cancel();continue}const y=St.fromDirection(w.mtv),A=Math.abs(((s=w?.info)===null||s===void 0?void 0:s.separation)||0);this.distanceMap.set(w.id,A),this.directionMap.set(w.id,y===St.Left||y===St.Right?"horizontal":"vertical"),w.colliderA.events.emit("precollision",new Ns(w.colliderA,w.colliderB,y,w.mtv,w)),w.colliderA.events.emit("beforecollisionresolve",new lo(w.colliderA,w.colliderB,y,w.mtv,w)),w.colliderB.events.emit("precollision",new Ns(w.colliderB,w.colliderA,St.getOpposite(y),w.mtv.negate(),w)),w.colliderB.events.emit("beforecollisionresolve",new lo(w.colliderB,w.colliderA,St.getOpposite(y),w.mtv.negate(),w)),w.matchAwake()}const p=Array.from(this.idToContactConstraint.keys());for(let m=0;m<e.length;m++){const w=e[m],y=p.indexOf(w.id);y>-1&&p.splice(y,1);const A=(r=this.idToContactConstraint.get(w.id))!==null&&r!==void 0?r:[];let E=0;const D=w.bodyA,L=w.colliderA,O=w.bodyB,q=w.colliderB;if(D&&O)for(let H=0;H<w.points.length;H++){const N=w.points[H],$=w.normal,Y=w.tangent,J=N.sub(L.center),rt=N.sub(q.center),Z=J.cross($),ft=rt.cross($),Tt=D.inverseMass+O.inverseMass+D.inverseInertia*Z*Z+O.inverseInertia*ft*ft,Gt=J.cross(Y),qt=rt.cross(Y),Ce=D.inverseMass+O.inverseMass+D.inverseInertia*Gt*Gt+O.inverseInertia*qt*qt;A[E]&&((l=(a=A[E])===null||a===void 0?void 0:a.point)===null||l===void 0?void 0:l.squareDistance(N))<4?(A[E].point=N,A[E].local=w.localPoints[E]):A[E]=new Bd(N,w.localPoints[E],w),A[E].aToContact=J,A[E].bToContact=rt,A[E].normalMass=1/Tt,A[E].tangentMass=1/Ce;const $t=D.bounciness>O.bounciness?D.bounciness:O.bounciness,kt=w.normal.dot(A[E].getRelativeVelocity());A[E].originalVelocityAndRestitution=0,kt<-.1&&(A[E].originalVelocityAndRestitution=-$t*kt),E++}this.idToContactConstraint.set(w.id,A)}for(const m of p)this.idToContactConstraint.delete(m);if(this.config.warmStart)this.warmStart(e);else for(let m=0;m<e.length;m++){const w=e[m],y=this.getContactConstraints(w.id);for(const A of y)A.normalImpulse=0,A.tangentImpulse=0}}postSolve(e){for(let s=0;s<e.length;s++){const r=e[s],a=r.bodyA,l=r.bodyB;if(a&&l){if(a.collisionType===dt.Passive||l.collisionType===dt.Passive)continue;a.updateMotion(),l.updateMotion()}const f=St.fromDirection(r.mtv);r.colliderA.events.emit("postcollision",new Gs(r.colliderA,r.colliderB,f,r.mtv,r)),r.colliderA.events.emit("aftercollisionresolve",new co(r.colliderA,r.colliderB,f,r.mtv,r)),r.colliderB.events.emit("postcollision",new Gs(r.colliderB,r.colliderA,St.getOpposite(f),r.mtv.negate(),r)),r.colliderB.events.emit("aftercollisionresolve",new co(r.colliderB,r.colliderA,St.getOpposite(f),r.mtv.negate(),r))}this.lastFrameContacts.clear();for(let s=0;s<e.length;s++){const r=e[s];this.lastFrameContacts.set(r.id,r)}}warmStart(e){var s;for(let r=0;r<e.length;r++){const a=e[r],l=a.bodyA,f=a.bodyB;if(l&&f){const p=(s=this.idToContactConstraint.get(a.id))!==null&&s!==void 0?s:[];for(const m of p)if(this.config.warmStart){const w=a.normal.scale(m.normalImpulse),y=a.tangent.scale(m.tangentImpulse),A=w.add(y);l.applyImpulse(m.point,A.negate()),f.applyImpulse(m.point,A)}else m.normalImpulse=0,m.tangentImpulse=0}}}solvePosition(e){var s;for(let r=0;r<this.config.positionIterations;r++)for(let a=0;a<e.length;a++){const l=e[a],f=l.bodyA,p=l.bodyB;if(f&&p){if(f.collisionType===dt.Passive||p.collisionType===dt.Passive)continue;const m=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const w of m){const y=l.normal,A=Pi.FindContactSeparation(l,w.local),E=this.config.steeringFactor,D=-5,L=this.config.slop,O=j(E*(A+L),D,0),q=y.scale(-O*w.normalMass);if(f.collisionType===dt.Active){const H=q.negate().scale(f.inverseMass);f.limitDegreeOfFreedom.includes(Je.X)&&(H.x=0),f.limitDegreeOfFreedom.includes(Je.Y)&&(H.y=0),f.globalPos=f.globalPos.add(H),f.limitDegreeOfFreedom.includes(Je.Rotation)||(f.rotation-=w.aToContact.cross(q)*f.inverseInertia)}if(p.collisionType===dt.Active){const H=q.scale(p.inverseMass);p.limitDegreeOfFreedom.includes(Je.X)&&(H.x=0),p.limitDegreeOfFreedom.includes(Je.Y)&&(H.y=0),p.globalPos=p.globalPos.add(H),p.limitDegreeOfFreedom.includes(Je.Rotation)||(p.rotation+=w.bToContact.cross(q)*p.inverseInertia)}}}}}solveVelocity(e){var s;for(let r=0;r<this.config.velocityIterations;r++)for(let a=0;a<e.length;a++){const l=e[a],f=l.bodyA,p=l.bodyB;if(f&&p){if(f.collisionType===dt.Passive||p.collisionType===dt.Passive)continue;const m=Math.min(f.friction,p.friction),w=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const y of w){let D=-y.getRelativeVelocity().dot(l.tangent)*y.tangentMass;const L=m*y.normalImpulse,O=j(y.tangentImpulse+D,-L,L);D=O-y.tangentImpulse,y.tangentImpulse=O;const q=l.tangent.scale(D);f.applyImpulse(y.point,q.negate()),p.applyImpulse(y.point,q)}for(const y of w){const E=y.getRelativeVelocity().dot(l.normal);let D=-y.normalMass*(E-y.originalVelocityAndRestitution);const L=Math.max(y.normalImpulse+D,0);D=L-y.normalImpulse,y.normalImpulse=L;const O=l.normal.scale(D);f.applyImpulse(y.point,O.negate()),p.applyImpulse(y.point,O)}}}}}class yo extends ci{get _processor(){return this._physics.collisionProcessor}constructor(e,s){super(),this._physics=s,this.systemType=oi.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new mh(s.config.arcade),this._realisticSolver=new vh(s.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=r=>this._processor.track(r),this._untrackCollider=r=>this._processor.untrack(r),this.query=e.query([et,Dt,ue]),this.query.entityAdded$.subscribe(r=>{const a=r.get(ue);a.$colliderAdded.subscribe(this._trackCollider),a.$colliderRemoved.subscribe(this._untrackCollider);const l=a.get();l&&this._processor.track(l)}),this.query.entityRemoved$.subscribe(r=>{const a=r.get(ue),l=a.get();a&&l&&this._processor.untrack(l)}),this._motionSystem=e.get(bo)}initialize(e,s){this._engine=s.engine}update(e){var s,r,a,l;if(!this._physics.config.enabled)return;let f=[];for(let A=0;A<this.query.entities.length;A++){const D=this.query.entities[A].get(ue),L=D?.get();if(D&&(!((s=D.owner)===null||s===void 0)&&s.isActive)&&L)if(D.update(),L instanceof ye){const O=L.getColliders();L.compositeStrategy||(L.compositeStrategy=this._physics.config.colliders.compositeStrategy),f=f.concat(O)}else f.push(L)}this._processor.update(f,e);let p=this._processor.broadphase(f,e);this._currentFrameContacts.clear();let m=[];const w=this.getSolver(),y=this._physics.config.substep;for(let A=0;A<y;A++)if(A>0&&this._motionSystem.update(e),m.length&&(p=m.map(E=>new qe(E.colliderA,E.colliderB))),p.length){m=this._processor.narrowphase(p,(l=(a=(r=this._engine)===null||r===void 0?void 0:r.debug)===null||a===void 0?void 0:a.stats)===null||l===void 0?void 0:l.currFrame),m=w.solve(m);for(const E of m){if(E.isCanceled())continue;const D=E.id.indexOf("|");if(D>0){const L=E.id.substring(D+1);this._currentFrameContacts.set(L,E)}else this._currentFrameContacts.set(E.id,E)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const A of this.query.entities){const E=A.get(ue);E&&E.processColliderRemoval()}}postupdate(){de.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new mh(this._physics.config.arcade),this._realisticSolver=new vh(this._physics.config.realistic)),this._physics.config.solver===ar.Realistic?this._realisticSolver:this._arcadeSolver}debug(e){this._processor.debug(e,0)}runContactStartEnd(){for(const[e,s]of this._currentFrameContacts)if(!this._lastFrameContacts.has(e)){const r=s.colliderA,a=s.colliderB,l=St.fromDirection(s.mtv),f=St.getOpposite(l);r.events.emit("collisionstart",new ir(r,a,l,s)),r.events.emit("contactstart",new ao(r,a,l,s)),a.events.emit("collisionstart",new ir(a,r,f,s)),a.events.emit("contactstart",new ao(a,r,f,s))}for(const[e,s]of this._lastFrameContacts)if(!this._currentFrameContacts.has(e)){const r=s.colliderA,a=s.colliderB,l=St.fromDirection(s.mtv),f=St.getOpposite(l);r.events.emit("collisionend",new sr(r,a,l,s)),r.events.emit("contactend",new ho(r,a,l,s)),a.events.emit("collisionend",new sr(a,r,f,s)),a.events.emit("contactend",new ho(a,r,f,s))}}}yo.priority=Oi.Higher;function Up(u,e,s,r){if(u.parent!==e.parent){const y=u.clone(),A=u.globalPos.clone(),E=u.globalScale.clone(),D=u.globalRotation;y.parent=e.parent,y.globalPos=A,y.globalScale=E,y.globalRotation=D,u=y}let a=e.pos,l=e.scale,f=e.rotation;a=e.pos.scale(s).add(u.pos.scale(1-s)),l=e.scale.scale(s).add(u.scale.scale(1-s));const p=(1-s)*Math.cos(u.rotation)+s*Math.cos(e.rotation),m=(1-s)*Math.sin(u.rotation)+s*Math.sin(e.rotation);f=Math.atan2(m,p);const w=r??new is;return w.setTransform(a,f,l),w}class wh extends ci{get sortedTransforms(){return this._sortedTransforms}constructor(e){super(),this.world=e,this.systemType=oi.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new is,this.query=this.world.query([et,te]),this.query.entityAdded$.subscribe(s=>{const r=s.get(et);this._sortedTransforms.push(r),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{const r=s.get(et);r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const a=this._sortedTransforms.indexOf(r);a>-1&&this._sortedTransforms.splice(a,1)})}initialize(e,s){this._camera=s.camera,this._engine=s.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>e.globalZ-s.globalZ),this._zHasChanged=!1)}update(e){this._token++;let s;Ft.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let r=0;r<this._sortedTransforms.length;r++){const a=this._sortedTransforms[r],l=a.owner;if(l.hasTag("ex.offscreen")||(s=l.get(te),!s.isVisible))continue;s.onPreTransformDraw&&s.onPreTransformDraw(this._graphicsContext,e),l.events.emit("pretransformdraw",new Da(this._graphicsContext,e,l)),a.coordPlane===Ie.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),a.coordPlane===Ie.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),s.update(e,this._token);const f=l.get(vo);if(f){const p=B.One.sub(f.parallaxFactor),m=this._camera.drawPos.scale(p);this._graphicsContext.translate(m.x,m.y)}this._applyTransform(l),s.material&&(this._graphicsContext.material=s.material),s.onPreDraw&&s.onPreDraw(this._graphicsContext,e),l.events.emit("predraw",new An(this._graphicsContext,e,l)),this._applyOpacity(l),this._drawGraphicsComponent(s,a),s.onPostDraw&&s.onPostDraw(this._graphicsContext,e),l.events.emit("postdraw",new Cn(this._graphicsContext,e,l)),this._graphicsContext.restore(),a.coordPlane===Ie.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),s.onPostTransformDraw&&s.onPostTransformDraw(this._graphicsContext,e),l.events.emit("posttransformdraw",new Ma(this._graphicsContext,e,l))}this._graphicsContext.restore()}_drawGraphicsComponent(e,s){var r,a;if(e.isVisible){const l=e.flipHorizontal,f=e.flipVertical,p=e.current,m=(r=e.currentOptions)!==null&&r!==void 0?r:{};if(p){let w=e.anchor,y=e.offset,A=1,E=1;m?.anchor&&(w=m.anchor),m?.offset&&(y=m.offset);const D=s.globalScale;A*=p.scale.x*D.x,E*=p.scale.y*D.y;const L=-p.width*w.x+y.x*A,O=-p.height*w.y+y.y*E,q=p.flipHorizontal,H=p.flipVertical;if((l||f)&&(p.flipHorizontal=l?!q:q,p.flipVertical=f?!H:H),p?.draw(this._graphicsContext,L,O),(l||f)&&(p.flipHorizontal=q,p.flipVertical=H),!((a=this._engine)===null||a===void 0)&&a.isDebug&&this._engine.debug.graphics.showBounds){const N=z(L,O);if(p instanceof xn)for(const $ of p.members){let Y,J=B.Zero;$ instanceof Kt?Y=$:(Y=$.graphic,J=$.offset),p.useAnchor?Y?.localBounds.translate(N.add(J)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):Y?.localBounds.translate(J).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else p?.localBounds.translate(N).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(e){const s=e.getAncestors();for(let r=0;r<s.length;r++){const a=s[r],l=a?.get(et),f=a?.get(Ct);if(l){let p=l.get();if(f&&this._engine.fixedUpdateTimestep&&f.__oldTransformCaptured&&f.enableFixedUpdateInterpolate){const m=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;p=Up(f.oldTransform,l.get(),m,this._targetInterpolationTransform)}this._graphicsContext.z=l.globalZ,this._graphicsContext.translate(p.pos.x,p.pos.y),this._graphicsContext.scale(p.scale.x,p.scale.y),this._graphicsContext.rotate(p.rotation)}}}_applyOpacity(e){var s;const r=e.getAncestors();for(let a=0;a<r.length;a++){const l=r[a],f=l?.get(te);this._graphicsContext.opacity*=(s=f?.opacity)!==null&&s!==void 0?s:1}}}wh.priority=Oi.Average;class xh extends ci{constructor(e){super(),this.world=e,this.systemType=oi.Draw,this.query=this.world.query([et])}initialize(e,s){this._graphicsContext=s.engine.graphicsContext,this._camera=s.camera,this._engine=s.engine,this._collisionSystem=e.systemManager.get(yo)}update(){var e;if(!this._engine.isDebug)return;const s=this._engine.debug.filter;let r,a;const l=this._engine.debug.entity;let f;const p=this._engine.debug.transform;let m;const w=this._engine.debug.motion;let y;const A=this._engine.debug.collider,E=this._engine.debug.physics;let D;const L=this._engine.debug.graphics;let O,q;const H=this._engine.debug.body,N=this._engine.debug.camera;for(let $=0;$<this.query.entities.length;$++){const Y=this.query.entities[$];if(Y.hasTag("offscreen")||Y instanceof uo||s.useFilter&&(!(s.ids.length===0||s.ids.includes(Y.id))||!(s.nameQuery===""||Y.name.includes(s.nameQuery))))continue;let J=B.Zero;const rt=z(0,16);if(r=Y.id,a=Y.name,f=Y.get(et),this._pushCameraTransform(f),this._graphicsContext.save(),f.coordPlane===Ie.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=p.debugZIndex,this._applyTransform(Y),f&&((p.showAll||p.showPosition)&&this._graphicsContext.debug.drawPoint(B.Zero,{size:4,color:p.positionColor}),(p.showAll||p.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${f.pos.toString(2)}`,J),J=J.add(rt)),(p.showAll||p.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${f.z.toFixed(1)})`,J),J=J.add(rt)),(l.showAll||l.showId)&&(this._graphicsContext.debug.drawText(`id(${r}) ${Y.parent?"child of id("+((e=Y.parent)===null||e===void 0?void 0:e.id)+")":""}`,J),J=J.add(rt)),(l.showAll||l.showName)&&(this._graphicsContext.debug.drawText(`name(${a})`,J),J=J.add(rt)),(p.showAll||p.showRotation)&&(this._graphicsContext.drawLine(B.Zero,B.fromAngle(f.rotation).scale(50).add(B.Zero),p.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${ht(f.rotation).toFixed(2)})`,J),J=J.add(rt)),(p.showAll||p.showScale)&&this._graphicsContext.drawLine(B.Zero,f.scale.add(B.Zero),p.scaleColor,2)),D=Y.get(te),D&&(L.showAll||L.showBounds)&&D.localBounds.draw(this._graphicsContext,L.boundsColor),O=Y.get(wo),O&&(O.useTransform||this._graphicsContext.restore(),O.draw(this._graphicsContext,this._engine.debug),O.useTransform||(this._graphicsContext.save(),this._applyTransform(Y))),q=Y.get(Ct),q&&((H.showAll||H.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${q.group.name})`,J),J=J.add(rt)),(H.showAll||H.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${q.collisionType})`,J),J=J.add(rt)),(H.showAll||H.showMass)&&(this._graphicsContext.debug.drawText(`mass(${q.mass})`,J),J=J.add(rt)),(H.showAll||H.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${q.sleepMotion})`,J),J=J.add(rt)),(H.showAll||H.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${q.canSleep?q.isSleeping:"cant sleep"})`,J),J=J.add(rt))),this._graphicsContext.restore(),this._graphicsContext.save(),f.coordPlane===Ie.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=p.debugZIndex,m=Y.get(Dt),m&&((w.showAll||w.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${m.vel.toString(2)}`,J.add(f.globalPos)),this._graphicsContext.drawLine(f.globalPos,f.globalPos.add(m.vel),w.velocityColor,2),J=J.add(rt)),(w.showAll||w.showAcceleration)&&this._graphicsContext.drawLine(f.globalPos,f.globalPos.add(m.acc),w.accelerationColor,2)),y=Y.get(ue),y){const Z=y.get();if((A.showAll||A.showGeometry)&&Z&&Z.debug(this._graphicsContext,A.geometryColor,{lineWidth:A.geometryLineWidth,pointSize:A.geometryPointSize}),A.showAll||A.showBounds){if(Z instanceof ye){const ft=Z.getColliders();for(const Tt of ft){const Gt=Tt.bounds,qt=z(Gt.left,Gt.top);this._graphicsContext.debug.drawRect(qt.x,qt.y,Gt.width,Gt.height,{color:A.boundsColor}),(A.showAll||A.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${Tt.owner.id})`,qt)}y.bounds.draw(this._graphicsContext,A.boundsColor)}else if(Z){const ft=y.bounds,Tt=z(ft.left,ft.top);this._graphicsContext.debug.drawRect(Tt.x,Tt.y,ft.width,ft.height,{color:A.boundsColor}),(A.showAll||A.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${y.owner.id})`,Tt)}}}this._graphicsContext.restore(),this._popCameraTransform(f)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(E.showAll||E.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),E.showAll||E.showCollisionContacts||E.showCollisionNormals)for(const[$,Y]of this._engine.debug.stats.currFrame.physics.contacts){if(E.showAll||E.showCollisionContacts)for(const J of Y.points)this._graphicsContext.debug.drawPoint(J,{size:E.contactSize,color:E.collisionContactColor});if(E.showAll||E.showCollisionNormals)for(const J of Y.points)this._graphicsContext.debug.drawLine(J,Y.normal.scale(30).add(J),{color:E.collisionNormalColor})}this._graphicsContext.restore(),N&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(N.showAll||N.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,N.focusColor),(N.showAll||N.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(e,s){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),Ae.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(e){const s=e.getAncestors();for(const r of s){const a=r?.get(et);a&&(this._graphicsContext.translate(a.pos.x,a.pos.y),this._graphicsContext.scale(a.scale.x,a.scale.y),this._graphicsContext.rotate(a.rotation))}}_pushCameraTransform(e){e.coordPlane===Ie.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(e){e.coordPlane===Ie.World&&this._graphicsContext.restore()}}xh.priority=Oi.Lowest;class bh{constructor(e,s){this.object=e,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=s,this.bounds=e.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const e=this.object.bounds,s=Math.floor(e.left/this.gridSize),r=Math.floor(e.right/this.gridSize),a=Math.floor(e.bottom/this.gridSize),l=Math.floor(e.top/this.gridSize);return this.leftX!==s||this.rightX!==r||this.bottomY!==a||this.topY!==l}clear(){for(const e of this.cells){const s=e.proxies.indexOf(this);s>-1&&e.proxies.splice(s,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class Wi{constructor(){this.proxies=[]}configure(e,s){this.x=e,this.y=s,this.key=Wi.calculateHashKey(e,s)}static calculateHashKey(e,s){return`${e}+${s}`}}class yh{constructor(e){this.bounds=new at,this._hashGridCellPool=new Qn(()=>new Wi,s=>(s.configure(0,0),s.proxies.length=0,s),1e3),this.gridSize=e.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,e.proxyFactory?this._buildProxy=s=>e.proxyFactory(s,this.gridSize):this._buildProxy=s=>new bh(s,this.gridSize)}query(e){const s=new Set;if(e instanceof at){const r=e,a=Math.floor(r.left/this.gridSize),l=Math.floor(r.right/this.gridSize),f=Math.floor(r.bottom/this.gridSize),p=Math.floor(r.top/this.gridSize);for(let m=a;m<=l;m++)for(let w=p;w<=f;w++){const y=Wi.calculateHashKey(m,w),A=this.sparseHashGrid.get(y);if(A)for(let E=0;E<A.proxies.length;E++)A.proxies[E].updateBounds(),A.proxies[E].bounds.intersect(r)&&s.add(A.proxies[E].object)}}else{const r=e,a=Wi.calculateHashKey(Math.floor(r.x/this.gridSize),Math.floor(r.y/this.gridSize)),l=this.sparseHashGrid.get(a);if(l)for(let f=0;f<l.proxies.length;f++)l.proxies[f].updateBounds(),l.proxies[f].bounds.contains(r)&&s.add(l.proxies[f].object)}return Array.from(s)}get(e,s){const r=Wi.calculateHashKey(e,s);return this.sparseHashGrid.get(r)}_insert(e,s,r){const a=Wi.calculateHashKey(e,s);let l=this.sparseHashGrid.get(a);l||(l=this._hashGridCellPool.rent(),l.configure(e,s),this.sparseHashGrid.set(l.key,l)),l.proxies.push(r),r.cells.push(l),this.bounds.combine(r.bounds,this.bounds)}_remove(e,s,r){const a=Wi.calculateHashKey(e,s),l=this.sparseHashGrid.get(a);if(l){const f=l.proxies.indexOf(r);f>-1&&l.proxies.splice(f,1);const p=r.cells.indexOf(l);p>-1&&r.cells.splice(p,1),l.proxies.length===0&&(this._hashGridCellPool.return(l),this.sparseHashGrid.delete(a))}}track(e){const s=this._buildProxy(e);this.objectToProxy.set(e,s);for(let r=s.leftX;r<=s.rightX;r++)for(let a=s.topY;a<=s.bottomY;a++)this._insert(r,a,s)}untrack(e){const s=this.objectToProxy.get(e);s&&(s.clear(),this.objectToProxy.delete(e))}update(e){let s=0;for(const r of e){const a=this.objectToProxy.get(r);if(a&&a.hasChanged()){for(let l=a.leftX;l<=a.rightX;l++)for(let f=a.topY;f<=a.bottomY;f++)this._remove(l,f,a);a.update();for(let l=a.leftX;l<=a.rightX;l++)for(let f=a.topY;f<=a.bottomY;f++)this._insert(l,f,a);s++}}return s}debug(e,s){const r=Q.Transparent,a=Q.White;for(const l of this.sparseHashGrid.values())e.drawRectangle(z(l.x*this.gridSize,l.y*this.gridSize),this.gridSize,this.gridSize,r,a,2)}}class Ao extends ci{constructor(e){super(),this.world=e,this.systemType=oi.Update,this._graphicsHashGrid=new yh({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new gh,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([et,Ss]),this.query.entityAdded$.subscribe(s=>{const r=s.get(et),a=s.get(Ss);this._pointerEventDispatcher.addObject(s,f=>a&&a.localBounds?a.localBounds.transform(r.get().matrix).contains(r.coordPlane===Ie.World?f.worldPos:f.screenPos):!1,()=>s.isActive),this._entityToPointer.set(s,a);const l=s.get(te);l&&(this._graphics.push(l),this._graphicsHashGrid.track(l)),this._sortedTransforms.push(r),this._sortedEntities.push(r.owner),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{this._pointerEventDispatcher.removeObject(s);const r=s.get(et);this._entityToPointer.delete(s);const a=s.get(te);if(a){const f=this._graphics.indexOf(a);f>-1&&this._graphics.splice(f,1),this._graphicsHashGrid.untrack(a)}r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const l=this._sortedTransforms.indexOf(r);l>-1&&(this._sortedTransforms.splice(l,1),this._sortedEntities.splice(l,1))})}initialize(e,s){this._engine=s.engine,this._scene=s}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>s.z-e.z),this._sortedEntities=this._sortedTransforms.map(e=>e.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[e,s]of this._engineReceiver.currentFramePointerCoords.entries()){const r=this._scene.physics.query(s.worldPos);for(let l=0;l<r.length;l++){const f=r[l],p=this._entityToPointer.get(f.owner);p&&(p.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(f.owner,e)}const a=this._graphicsHashGrid.query(s.worldPos);for(let l=0;l<a.length;l++){const f=a[l],p=this._entityToPointer.get(f.owner);p&&(p.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(f.owner,e)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(e=>e.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(e=>e.clear())}}Ao.priority=Oi.Higher;class Ah extends ci{constructor(e){super(),this.world=e,this.systemType=oi.Update,this._actions=[],this.query=this.world.query([Sn]),this.query.entityAdded$.subscribe(s=>this._actions.push(s.get(Sn))),this.query.entityRemoved$.subscribe(s=>{const r=s.get(Sn),a=this._actions.indexOf(r);a>-1&&this._actions.splice(a,1)})}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}}Ah.priority=Oi.Higher;class _r extends pi{constructor(e){super(),this.elevation=0,this.columns=e.columns,this.rows=e.rows,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight}}class Ch extends ci{constructor(e){super(),this.world=e,this.systemType=oi.Update,this.query=this.world.query([et,_r])}update(){let e,s;for(let r=0;r<this.query.entities.length;r++){const a=this.query.entities[r];e=a.get(et),s=a.get(_r);const f=Math.max(s.columns*s.tileWidth,s.rows*s.tileHeight)*s.elevation+e.pos.y;e.z=f}}}Ch.priority=Oi.Lower;class Ph extends ci{constructor(e){super(),this.world=e,this.systemType=oi.Draw,this.query=this.world.query([et,te])}initialize(e,s){this._camera=s.camera,this._screen=s.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let e,s,r;for(let a=0;a<this.query.entities.length;a++){const l=this.query.entities[a];s=l.get(te),e=l.get(et),r=l.get(vo);let f;if(r){const m=B.One.sub(r.parallaxFactor);f=this._camera.pos.scale(m)}const p=this._isOffscreen(e,s,f);p&&!l.hasTag("ex.offscreen")&&(l.events.emit("exitviewport",new Xa(l)),l.addTag("ex.offscreen")),!p&&l.hasTag("ex.offscreen")&&(l.events.emit("enterviewport",new qa(l)),l.removeTag("ex.offscreen"))}}_isOffscreen(e,s,r){if(s.forceOnScreen)return!1;if(e.coordPlane===Ie.World){let a=s.localBounds;r&&(a=a.translate(r));const l=a.transform(e.get().matrix);return!this._worldBounds.overlaps(l)}else return!1}}Ph.priority=Oi.Higher;class kd extends bh{constructor(e,s){var r,a;super(e,s),this.collider=e,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=s;const l=e.bounds;this.hasZeroBounds=l.hasZeroDimensions(),this.leftX=Math.floor(l.left/this.gridSize),this.rightX=Math.floor(l.right/this.gridSize),this.bottomY=Math.floor(l.bottom/this.gridSize),this.topY=Math.floor(l.top/this.gridSize),this.owner=e.owner,this.body=(r=this.owner)===null||r===void 0?void 0:r.get(Ct),this.collisionType=(a=this.body.collisionType)!==null&&a!==void 0?a:dt.PreventCollision}update(){var e,s;super.update(),this.body=(e=this.owner)===null||e===void 0?void 0:e.get(Ct),this.collisionType=(s=this.body.collisionType)!==null&&s!==void 0?s:dt.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class Th{constructor(e){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new Jr(()=>new qe({id:P("collider",0)},{id:P("collider",0)}),s=>(s.colliderA=null,s.colliderB=null,s),200),this.gridSize=e.size,this.hashGrid=new yh({size:this.gridSize,proxyFactory:(s,r)=>new kd(s,r)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(e){return this.hashGrid.query(e)}rayCast(e,s){var r,a,l;const f=[],p=(r=s?.maxDistance)!==null&&r!==void 0?r:1/0,m=s?.collisionGroup,w=m?m.category:(a=s?.collisionMask)!==null&&a!==void 0?a:ns.All.category,y=(l=s?.searchAllColliders)!==null&&l!==void 0?l:!1,A=e.dir.normalize(),E=A.y/A.x,D=A.x/A.y,L=Math.sqrt(1+E*E)*this.gridSize,O=Math.sqrt(1+D*D)*this.gridSize,q=e.pos.x/this.gridSize,H=e.pos.y/this.gridSize,N=z(1,1);let $=~~q,Y=~~H,J=0,rt=0;A.x<0?(N.x=-1,J=(q-$)*L):(N.x=1,J=($+1-q)*L),A.y<0?(N.y=-1,rt=(H-Y)*O):(N.y=1,rt=(Y+1-H)*O);const Z=new Set;let ft=!1,Tt=9999;for(;!ft&&Tt>0&&(Tt--,!!this.hashGrid.bounds.contains(z($*this.gridSize,Y*this.gridSize)));){const Gt=Wi.calculateHashKey($,Y),qt=this.hashGrid.sparseHashGrid.get(Gt);if(qt){const Ce=[];for(let $t=0;$t<qt.proxies.length;$t++){const kt=qt.proxies[$t];if(!Z.has(kt.collider.id.value)){if(Z.add(kt.collider.id.value),s?.ignoreCollisionGroupAll&&kt.body.group===ns.All)continue;const Oe=(w&kt.body.group.category)!==0;if(kt.body.group&&!Oe)continue;const De=kt.collider.rayCast(e,p);De&&Ce.push(De)}}Ce.sort(($t,kt)=>$t.distance-kt.distance);for(let $t=0;$t<Ce.length;$t++){const kt=Ce[$t];if(s?.filter){if(s.filter(kt)&&(f.push(kt),!y)){ft=!0;break}}else if(f.push(kt),!y){ft=!0;break}}}J<rt?($+=N.x,J+=L):(Y+=N.y,rt+=O)}return f.sort((Gt,qt)=>Gt.distance-qt.distance),!y&&f.length?[f[0]]:f}track(e){let s=[e];if(e instanceof ye){const r=e.getColliders();for(const a of r)a.owner=e.owner;s=r}for(const r of s)this.hashGrid.track(r)}untrack(e){let s=[e];e instanceof ye&&(s=e.getColliders());for(const r of s)this.hashGrid.untrack(r)}_canCollide(e,s){return!(e.collider.id===s.collider.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.hasZeroBounds||s.hasZeroBounds||!e.body.group.canCollide(s.body.group)||e.collisionType===dt.Fixed&&s.collisionType===dt.Fixed||e.collisionType===dt.PreventCollision||s.collisionType===dt.PreventCollision||!e.owner.isActive||!s.owner.isActive)}broadphase(e,s){const r=[];this._pairs.clear(),this._nonPairs.clear();let a=0;for(const l of this.hashGrid.objectToProxy.values())if(l.id=a++,!(!l.owner.isActive||l.collisionType===dt.PreventCollision))for(let f=0;f<l.cells.length;f++){const p=l.cells[f];for(let m=0;m<p.proxies.length;m++){const w=p.proxies[m];if(w.id===l.id)continue;const y=qe.calculatePairHash(l.collider.id,w.collider.id);if(!this._nonPairs.has(y))if(!this._pairs.has(y)&&this._canCollide(l,w)&&l.object.bounds.overlaps(w.object.bounds)){const A=this._pairPool.get();A.colliderA=l.collider,A.colliderB=w.collider,A.id=y,this._pairs.add(y),r.push(A)}else this._nonPairs.add(y)}}return r}narrowphase(e,s){const r=[];for(let a=0;a<e.length;a++){const l=e[a].collide();for(let f=0;f<l.length;f++){const p=l[f];r.push(p),s&&s.physics.contacts.set(p.id,p)}}return this._pairPool.done(),s&&(s.physics.collisions+=r.length),r}update(e,s){return this.hashGrid.update(e)}debug(e,s){this.hashGrid.debug(e,s)}}class Ld{get config(){return D_(this._config,e=>{this.$configUpdate.notifyAll(e)})}set config(e){this._config=e,this.$configUpdate.notifyAll(e)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const e=this._collisionProcessor.getColliders();this._config.spatialPartition===Tn.SparseHashGrid?this._collisionProcessor=new Th(this._config.sparseHashGrid):this._collisionProcessor=new go(this._config);for(const s of e)this._collisionProcessor.track(s)}return this._collisionProcessor}constructor(e){this.$configUpdate=new Ve,this._configDirty=!1,this.config=e,this.$configUpdate.subscribe(s=>{this._configDirty=!0,Ct.updateDefaultPhysicsConfig(s.bodies)}),this._config.spatialPartition===Tn.SparseHashGrid?this._collisionProcessor=new Th(this._config.sparseHashGrid):this._collisionProcessor=new go(this._config)}rayCast(e,s){return this.collisionProcessor.rayCast(e,s)}query(e){return this._collisionProcessor.query(e)}}class Co{constructor(){this.events=new I,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(e){this._enabled=e}setMinimumGamepadConfiguration(e){this._enableAndUpdate(),this._minimumConfiguration=e}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(e){if(!this._minimumConfiguration)return!0;if(!e)return!1;const s=e.axes.filter(a=>typeof a!==void 0).length,r=e.buttons.filter(a=>typeof a!==void 0).length;return s>=this._minimumConfiguration.axis&&r>=this._minimumConfiguration.buttons&&e.connected}emit(e,s){this.events.emit(e,s)}on(e,s){return this._enableAndUpdate(),this.events.on(e,s)}once(e,s){return this._enableAndUpdate(),this.events.once(e,s)}off(e,s){this._enableAndUpdate(),this.events.off(e,s)}update(){var e,s;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const r=this._navigator.getGamepads();for(let a=0;a<r.length;a++){if(r[a]){const f=this.at(a);!this.at(a).connected&&this._isGamepadValid(r[a])&&(f.events.pipe(this.events),this.events.emit("connect",new Ua(a,this.at(a)))),this.at(a).connected=!0}else{const f=this.at(a);f.connected&&(this.events.emit("disconnect",new za(a,f)),f.events.unpipe(this.events)),f.connected=!1;continue}if(this.at(a).update(),r[a].timestamp&&r[a].timestamp===this._gamePadTimeStamps[a])continue;this._gamePadTimeStamps[a]=r[a].timestamp,this.at(a).navigatorGamepad=r[a];const l=r[a];if(l){for(let f=0;f<l.buttons.length;f++){const p=l.buttons[f],m=p?.value;m!==((e=this._oldPads[a])===null||e===void 0?void 0:e.getButton(f))&&(p?.pressed?(this.at(a).updateButton(f,m),this.at(a).events.emit("button",new Ha(f in pr?f:pr.Unknown,f,m,this.at(a)))):this.at(a).updateButton(f,0))}for(let f=0;f<l.axes.length;f++){const p=l.axes[f];p!==((s=this._oldPads[a])===null||s===void 0?void 0:s.getAxes(f))&&(this.at(a).updateAxes(f,p),this.at(a).events.emit("axis",new Oa(f,p,this.at(a))))}}this._oldPads[a]=this._clonePad(r[a])}}at(e){if(this._enableAndUpdate(),e>=this._pads.length)for(let s=this._pads.length-1,r=e;s<r;s++)this._pads.push(new Po),this._oldPads.push(new Po);return this._pads[e]}getValidGamepads(){this._enableAndUpdate();const e=[];for(let s=0;s<this._pads.length;s++)this._isGamepadValid(this.at(s).navigatorGamepad)&&this.at(s).connected&&e.push(this.at(s));return e}count(){return this._pads.filter(e=>e.connected).length}_clonePads(e){const s=[];for(let r=0,a=e.length;r<a;r++)s.push(this._clonePad(e[r]));return s}_clonePad(e){let s,r;const a=new Po;if(!e)return a;for(s=0,r=e.buttons.length;s<r;s++)e.buttons[s]&&a.updateButton(s,e.buttons[s].value);for(s=0,r=e.axes.length;s<r;s++)a.updateAxes(s,e.axes[s]);return a}}Co.MinAxisMoveThreshold=.05;class Po{constructor(){this.events=new I,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let e=0;e<this._buttons.length;e++)this._buttons[e]=0;for(let e=0;e<this._axes.length;e++)this._axes[e]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(e,s=1){return this._buttons[e]>=s}isButtonHeld(e,s=1){return this._buttons[e]>=s}wasButtonPressed(e,s=1){return this._buttonsDown[e]>=s}wasButtonReleased(e){return!!this._buttonsUp[e]}getButton(e){return this._buttons[e]}getAxes(e){const s=this._axes[e];return Math.abs(s)<Co.MinAxisMoveThreshold?0:s}updateButton(e,s){s===0&&this._buttons[e]?this._buttonsUp[e]=1:this._buttonsDown[e]=s,this._buttons[e]=s}updateAxes(e,s){this._axes[e]=s}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}var pr;(function(u){u[u.Unknown=-1]="Unknown",u[u.Face1=0]="Face1",u[u.Face2=1]="Face2",u[u.Face3=2]="Face3",u[u.Face4=3]="Face4",u[u.LeftBumper=4]="LeftBumper",u[u.RightBumper=5]="RightBumper",u[u.LeftTrigger=6]="LeftTrigger",u[u.RightTrigger=7]="RightTrigger",u[u.Select=8]="Select",u[u.Start=9]="Start",u[u.LeftStick=10]="LeftStick",u[u.RightStick=11]="RightStick",u[u.DpadUp=12]="DpadUp",u[u.DpadDown=13]="DpadDown",u[u.DpadLeft=14]="DpadLeft",u[u.DpadRight=15]="DpadRight",u[u.CenterButton=16]="CenterButton",u[u.MiscButton1=17]="MiscButton1"})(pr||(pr={}));var Sh;(function(u){u[u.LeftStickX=0]="LeftStickX",u[u.LeftStickY=1]="LeftStickY",u[u.RightStickX=2]="RightStickX",u[u.RightStickY=3]="RightStickY"})(Sh||(Sh={}));class Ud{constructor(e){this.inputs=e,this._handlers=new Map}execute(){for(const[e,s]of this._handlers.entries()){const r=e(this.inputs);r&&s(r)}}on(e,s){this._handlers.set(e,s)}}function zd(){try{const u=()=>{};window.top.addEventListener("blur",u),window.top.removeEventListener("blur",u)}catch{return!0}return!1}var gr;(function(u){u.Backquote="Backquote",u.Backslash="Backslash",u.BracketLeft="BracketLeft",u.BracketRight="BracketRight",u.Comma="Comma",u.Key0="Digit0",u.Key1="Digit1",u.Key2="Digit2",u.Key3="Digit3",u.Key4="Digit4",u.Key5="Digit5",u.Key6="Digit6",u.Key7="Digit7",u.Key8="Digit8",u.Key9="Digit9",u.Digit0="Digit0",u.Digit1="Digit1",u.Digit2="Digit2",u.Digit3="Digit3",u.Digit4="Digit4",u.Digit5="Digit5",u.Digit6="Digit6",u.Digit7="Digit7",u.Digit8="Digit8",u.Digit9="Digit9",u.Equal="Equal",u.IntlBackslash="IntlBackslash",u.IntlRo="IntlRo",u.IntlYen="IntlYen",u.A="KeyA",u.B="KeyB",u.C="KeyC",u.D="KeyD",u.E="KeyE",u.F="KeyF",u.G="KeyG",u.H="KeyH",u.I="KeyI",u.J="KeyJ",u.K="KeyK",u.L="KeyL",u.M="KeyM",u.N="KeyN",u.O="KeyO",u.P="KeyP",u.Q="KeyQ",u.R="KeyR",u.S="KeyS",u.T="KeyT",u.U="KeyU",u.V="KeyV",u.W="KeyW",u.X="KeyX",u.Y="KeyY",u.Z="KeyZ",u.KeyA="KeyA",u.KeyB="KeyB",u.KeyC="KeyC",u.KeyD="KeyD",u.KeyE="KeyE",u.KeyF="KeyF",u.KeyG="KeyG",u.KeyH="KeyH",u.KeyI="KeyI",u.KeyJ="KeyJ",u.KeyK="KeyK",u.KeyL="KeyL",u.KeyM="KeyM",u.KeyN="KeyN",u.KeyO="KeyO",u.KeyP="KeyP",u.KeyQ="KeyQ",u.KeyR="KeyR",u.KeyS="KeyS",u.KeyT="KeyT",u.KeyU="KeyU",u.KeyV="KeyV",u.KeyW="KeyW",u.KeyX="KeyX",u.KeyY="KeyY",u.KeyZ="KeyZ",u.Minus="Minus",u.Period="Period",u.Quote="Quote",u.Semicolon="Semicolon",u.Slash="Slash",u.AltLeft="AltLeft",u.AltRight="AltRight",u.Alt="Alt",u.AltGraph="AltGraph",u.Backspace="Backspace",u.CapsLock="CapsLock",u.ContextMenu="ContextMenu",u.ControlLeft="ControlLeft",u.ControlRight="ControlRight",u.Enter="Enter",u.MetaLeft="MetaLeft",u.MetaRight="MetaRight",u.ShiftLeft="ShiftLeft",u.ShiftRight="ShiftRight",u.Space="Space",u.Tab="Tab",u.Convert="Convert",u.KanaMode="KanaMode",u.NonConvert="NonConvert",u.Delete="Delete",u.End="End",u.Help="Help",u.Home="Home",u.Insert="Insert",u.PageDown="PageDown",u.PageUp="PageUp",u.Up="ArrowUp",u.Down="ArrowDown",u.Left="ArrowLeft",u.Right="ArrowRight",u.ArrowUp="ArrowUp",u.ArrowDown="ArrowDown",u.ArrowLeft="ArrowLeft",u.ArrowRight="ArrowRight",u.NumLock="NumLock",u.Numpad0="Numpad0",u.Numpad1="Numpad1",u.Numpad2="Numpad2",u.Numpad3="Numpad3",u.Numpad4="Numpad4",u.Numpad5="Numpad5",u.Numpad6="Numpad6",u.Numpad7="Numpad7",u.Numpad8="Numpad8",u.Numpad9="Numpad9",u.Num0="Numpad0",u.Num1="Numpad1",u.Num2="Numpad2",u.Num3="Numpad3",u.Num4="Numpad4",u.Num5="Numpad5",u.Num6="Numpad6",u.Num7="Numpad7",u.Num8="Numpad8",u.Num9="Numpad9",u.NumAdd="NumpadAdd",u.NumpadAdd="NumpadAdd",u.NumDecimal="NumpadDecimal",u.NumpadDecimal="NumpadDecimal",u.NumDivide="NumpadDivide",u.NumpadDivide="NumpadDivide",u.NumEnter="NumpadEnter",u.NumpadEnter="NumpadEnter",u.NumMultiply="NumpadMultiply",u.NumpadMultiply="NumpadMultiply",u.NumSubtract="NumpadSubtract",u.NumpadSubtract="NumpadSubtract",u.Esc="Escape",u.Escape="Escape",u.F1="F1",u.F2="F2",u.F3="F3",u.F4="F4",u.F5="F5",u.F6="F6",u.F7="F7",u.F8="F8",u.F9="F9",u.F10="F10",u.F11="F11",u.F12="F12",u.F13="F13",u.F14="F14",u.F15="F15",u.F16="F16",u.F17="F17",u.F18="F18",u.F19="F19",u.F20="F20",u.PrintScreen="PrintScreen",u.ScrollLock="ScrollLock",u.Pause="Pause",u.Unidentified="Unidentified"})(gr||(gr={}));class mr extends mt{constructor(e,s,r){super(),this.key=e,this.value=s,this.originalEvent=r}}class Hd{constructor(){this.events=new I,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=e=>{for(const s of this._keys){const r=new mr(s,e.key,e);this.events.emit("up",r),this.events.emit("release",r)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=e=>{if(!this._enabled)return;!e.metaKey&&(this._keys.includes(gr.MetaLeft)||this._keys.includes(gr.MetaRight))&&this._releaseAllKeys(e);const s=e.code;if(this._keys.indexOf(s)===-1){this._keys.push(s),this._keysDown.push(s);const r=new mr(s,e.key,e);this.events.emit("down",r),this.events.emit("press",r)}},this._handleKeyUp=e=>{if(!this._enabled)return;const s=e.code,r=this._keys.indexOf(s);this._keys.splice(r,1),this._keysUp.push(s);const a=new mr(s,e.key,e);this.events.emit("up",a),this.events.emit("release",a),e.key==="Meta"&&this._releaseAllKeys(e)}}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}init(e){let{global:s}=e;const{grabWindowFocus:r}=e;s||(zd()?(s=window,r&&window.focus(),ot.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):s=window.top),s.addEventListener("blur",()=>{this._keys.length=0}),s.addEventListener("keyup",this._handleKeyUp),s.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(e){this._enabled=e}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let e=0;e<this._keys.length;e++)this.events.emit("hold",new mr(this._keys[e]))}getKeys(){return this._keys}wasPressed(e){return this._enabled?this._keysDown.indexOf(e)>-1:!1}isHeld(e){return this._enabled?this._keys.indexOf(e)>-1:!1}wasReleased(e){return this._enabled?this._keysUp.indexOf(e)>-1:!1}triggerEvent(e,s,r){e==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:s,key:r??null})),e==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:s,key:r??null}))}}class En{static fromPagePosition(e,s,r){let a,l,f,p;arguments.length===3?(a=e,l=s,f=new B(a,l),p=r):(f=e,a=f.x,l=f.y,p=s);const m=p.screen.pageToScreenCoordinates(f),w=p.screen.screenToWorldCoordinates(m);return new En(w,f,m)}constructor(e,s,r){this.worldPos=e,this.pagePos=s,this.screenPos=r}}class vr{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(e,s,r,a,l,f){this.type=e,this.pointerId=s,this.button=r,this.pointerType=a,this.coordinates=l,this.nativeEvent=f,this.active=!0}}class Od{cancel(){this.active=!1}constructor(e,s,r,a,l,f,p,m,w,y,A,E){this.x=e,this.y=s,this.pageX=r,this.pageY=a,this.screenX=l,this.screenY=f,this.index=p,this.deltaX=m,this.deltaY=w,this.deltaZ=y,this.deltaMode=A,this.ev=E,this.active=!0}}class Eh{constructor(){this.events=new I,this.lastPagePos=B.Zero,this.lastScreenPos=B.Zero,this.lastWorldPos=B.Zero,this._onPointerMove=e=>{this.lastPagePos=new B(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new B(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new B(e.worldPos.x,e.worldPos.y)},this._onPointerDown=e=>{this.lastPagePos=new B(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new B(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new B(e.worldPos.x,e.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_updateWorldPosition(e){const s=En.fromPagePosition(this.lastPagePos,e);this.lastScreenPos=s.screenPos,this.lastWorldPos=s.worldPos}}var In;(function(u){u.Pixel="Pixel",u.Line="Line",u.Page="Page"})(In||(In={}));var Es;(function(u){u[u.NoButton=-1]="NoButton",u[u.Left=0]="Left",u[u.Middle=1]="Middle",u[u.Right=2]="Right",u[u.Unknown=3]="Unknown"})(Es||(Es={}));var as;(function(u){u.Left="Left",u.Middle="Middle",u.Right="Right",u.Unknown="Unknown",u.NoButton="NoButton"})(as||(as={}));var hs;(function(u){u.Touch="Touch",u.Mouse="Mouse",u.Pen="Pen",u.Unknown="Unknown"})(hs||(hs={}));function zp(u){return globalThis.TouchEvent&&u instanceof globalThis.TouchEvent}function Hp(u){return globalThis.PointerEvent&&u instanceof globalThis.PointerEvent}class To{constructor(e,s){this.target=e,this.engine=s,this.events=new I,this.primary=new Eh,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(e){this._enabled=e}recreate(e,s){const r=new To(e,s);return r.primary=this.primary,r._pointers=this._pointers,r}at(e){if(e>=this._pointers.length)for(let s=this._pointers.length-1,r=e;s<r;s++)this._pointers.push(new Eh);return this._pointers[e]}count(){return this._pointers.length}isDown(e){var s;return this._enabled&&(s=this.currentFramePointerDown.get(e))!==null&&s!==void 0?s:!1}wasDown(e){var s;return this._enabled&&(s=this.lastFramePointerDown.get(e))!==null&&s!==void 0?s:!1}isDragging(e){return this._enabled?this.isDown(e):!1}isDragStart(e){return this._enabled?this.isDown(e)&&!this.wasDown(e):!1}isDragEnd(e){return this._enabled?!this.isDown(e)&&this.wasDown(e):!1}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const e of this.currentFrameDown){if(!e.active)continue;this.emit("down",e),this.at(e.pointerId).emit("down",e),this.primary.emit("pointerdown",e)}for(const e of this.currentFrameUp){if(!e.active)continue;this.emit("up",e),this.at(e.pointerId).emit("up",e)}for(const e of this.currentFrameMove){if(!e.active)continue;this.emit("move",e),this.at(e.pointerId).emit("move",e)}for(const e of this.currentFrameCancel){if(!e.active)continue;this.emit("cancel",e),this.at(e.pointerId).emit("cancel",e)}for(const e of this.currentFrameWheel)e.active&&(this.emit("pointerwheel",e),this.emit("wheel",e),this.primary.emit("pointerwheel",e),this.primary.emit("wheel",e));if(this.engine.currentScene.camera.hasChanged())for(const e of this._pointers)e._updateWorldPosition(this.engine)}clear(){for(const e of this.currentFrameUp){this.currentFramePointerCoords.delete(e.pointerId);const s=this._activeNativePointerIdsToNormalized.entries();for(const[r,a]of s)a===e.pointerId&&this._activeNativePointerIdsToNormalized.delete(r)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(e){var s;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const r={passive:!(this.engine.pageScrollPreventionMode===Is.All||this.engine.pageScrollPreventionMode===Is.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,r):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,r):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,r),((s=e?.grabWindowFocus)!==null&&s!==void 0?s:!0)&&zd()){const l=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",l):(this.target.addEventListener("touchstart",l),this.target.addEventListener("mousedown",l))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(e){this._activeNativePointerIdsToNormalized.set(e,-1);const r=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((a,l)=>a-l).findIndex(a=>a===e);return this._activeNativePointerIdsToNormalized.set(e,r),r}_handle(e){if(!this._enabled)return;e.preventDefault();const s=new Map;let r,a;if(zp(e)){r=as.Unknown,a=hs.Touch;for(let l=0;l<e.changedTouches.length;l++){const f=e.changedTouches[l],p=En.fromPagePosition(f.pageX,f.pageY,this.engine),m=l+1,w=this._normalizePointerId(m);this.currentFramePointerCoords.set(w,p),s.set(w,p)}}else{r=this._nativeButtonToPointerButton(e.button),a=hs.Mouse;const l=En.fromPagePosition(e.pageX,e.pageY,this.engine);let f=1;Hp(e)&&(f=e.pointerId,a=this._stringToPointerType(e.pointerType));const p=this._normalizePointerId(f);this.currentFramePointerCoords.set(p,l),s.set(p,l)}for(const[l,f]of s.entries())switch(e.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new vr("down",l,r,a,f,e)),this.currentFramePointerDown.set(l,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new vr("up",l,r,a,f,e)),this.currentFramePointerDown.set(l,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new vr("move",l,r,a,f,e));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new vr("cancel",l,r,a,f,e));break}}_handleWheel(e){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Is.All||this.engine.pageScrollPreventionMode===Is.Canvas&&e.target===this.engine.canvas)&&e.preventDefault();const s=this.engine.screen.pageToScreenCoordinates(z(e.pageX,e.pageY)),r=this.engine.screen.screenToWorldCoordinates(s),a=-1/40,l=e.deltaX||e.wheelDeltaX*a||0,f=e.deltaY||e.wheelDeltaY*a||e.wheelDelta*a||e.detail||0,p=e.deltaZ||0;let m=In.Pixel;e.deltaMode&&(e.deltaMode===1?m=In.Line:e.deltaMode===2&&(m=In.Page));const w=new Od(r.x,r.y,e.pageX,e.pageY,s.x,s.y,0,l,f,p,m,e);this.currentFrameWheel.push(w)}triggerEvent(e,s){const r=this.engine.screen.worldToPageCoordinates(s);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+e,{pointerId:0,clientX:r.x,clientY:r.y})):this._handle(new window.MouseEvent("mouse"+e,{clientX:r.x,clientY:r.y}));const a=this.engine.currentScene.world.get(Ao);a.preupdate(this.engine.currentScene,1),a.update(1)}_nativeButtonToPointerButton(e){switch(e){case Es.NoButton:return as.NoButton;case Es.Left:return as.Left;case Es.Middle:return as.Middle;case Es.Right:return as.Right;case Es.Unknown:return as.Unknown;default:return Ac(e)}}_stringToPointerType(e){switch(e){case"touch":return hs.Touch;case"mouse":return hs.Mouse;case"pen":return hs.Pen;default:return hs.Unknown}}}class Ih{constructor(e){this._enabled=!0;const{pointerTarget:s,grabWindowFocus:r,engine:a}=e;this.keyboard=new Hd,this.pointers=new To(s,a),this.gamepads=new Co,this.keyboard.init({grabWindowFocus:r}),this.pointers.init({grabWindowFocus:r}),this.gamepads.init(),this.inputMapper=new Ud({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(e){this._enabled=e,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class Op{}const Wp={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function Ni(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class di{get actors(){return this.world.entityManager.entities.filter(e=>e instanceof Ye)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(e=>e instanceof Ed)}get tileMaps(){return this.world.entityManager.entities.filter(e=>e instanceof wd)}get timers(){return this._timers}constructor(){this._logger=ot.getInstance(),this.events=new I,this.camera=new Sd,this.world=new Fd(this),this.physics=new Ld(os()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(Ah),this.world.add(new bo(this.world,this.physics)),this.world.add(new yo(this.world,this.physics)),this.world.add(Ao),this.world.add(Ch),this.world.add(Ph),this.world.add(wh),this.world.add(xh)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}onPreLoad(e){}onTransition(e){}onInitialize(e){}onActivate(e){}onDeactivate(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreDraw(e,s){}onPostDraw(e,s){}_initializeChildren(){for(const e of this.entities)e._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(e){var s;if(!this.isInitialized){try{this.engine=e,this.physics.config=this.engine.physics,this.input=new Ih({pointerTarget:e.pointerScope===F.Canvas?e.canvas:document,grabWindowFocus:e.grabWindowFocus,engine:e}),this.camera._initialize(e),this.world.systemManager.initialize(),await this.onInitialize(e),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,e),this.events.emit("initialize",new Pn(e,this))}catch(r){throw this._logger.error(`Error during scene initialization for scene ${(s=e.director)===null||s===void 0?void 0:s.getSceneName(this)}!`),r}this._isInitialized=!0}}async _activate(e){var s,r;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(e)}catch(a){throw this._logger.error(`Error during scene activation for scene ${(r=(s=this.engine)===null||s===void 0?void 0:s.director)===null||r===void 0?void 0:r.getSceneName(this)}!`),a}}async _deactivate(e){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(e)}_preupdate(e,s){this.emit("preupdate",new Cs(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.emit("postupdate",new Ps(e,s,this)),this.onPostUpdate(e,s)}_predraw(e,s){this.emit("predraw",new An(e,s,this)),this.onPreDraw(e,s)}_postdraw(e,s){this.emit("postdraw",new Cn(e,s,this)),this.onPostDraw(e,s)}update(e,s){var r;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(r=e.director)===null||r===void 0?void 0:r.getSceneName(this)}!`);return}this._preupdate(e,s);let a,l;for(a=0,l=this._cancelQueue.length;a<l;a++)this.removeTimer(this._cancelQueue[a]);this._cancelQueue.length=0;for(const f of this._timers)f.update(s);this.world.update(oi.Update,s),this.camera&&this.camera.update(e,s),this._collectActorStats(e),this._postupdate(e,s),this.input.update()}draw(e,s){var r;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(e,s),this.world.update(oi.Draw,s),!((r=this.engine)===null||r===void 0)&&r.isDebug&&this.debugDraw(e),this._postdraw(e,s)}debugDraw(e){this.emit("predebugdraw",new Fa(e,this)),this.emit("postdebugdraw",new Ba(e,this))}contains(e){return this.actors.indexOf(e)>-1}add(e){if(this.emit("entityadded",{target:e}),e instanceof Zs){Yr(this._timers,e)||this.addTimer(e);return}this.world.add(e),e.scene=this}transfer(e){let s;e instanceof Ue&&e.scene&&e.scene!==this&&(s=e.scene,e.scene.world.remove(e,!1)),e instanceof Zs&&e.scene&&(s=e.scene,e.scene.removeTimer(e)),s?.emit("entityremoved",{target:e}),this.add(e)}remove(e){this.emit("entityremoved",{target:e}),e instanceof Ue&&(e.isActive&&e.kill(),this.world.remove(e)),e instanceof Zs&&this.removeTimer(e)}clear(e=!0){for(let s=this.entities.length-1;s>=0;s--)this.world.remove(this.entities[s],e);for(let s=this.timers.length-1;s>=0;s--)this.removeTimer(this.timers[s])}addTimer(e){return this._timers.push(e),e.scene=this,e}removeTimer(e){const s=this._timers.indexOf(e);return s!==-1&&this._timers.splice(s,1),e}cancelTimer(e){return this._cancelQueue.push(e),e}isTimerActive(e){return this._timers.indexOf(e)>-1&&!e.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(e){const s=this.actors;for(let r=0;r<s.length;r++){const a=s[r];a instanceof ph&&e.stats.currFrame.actors.ui++,e.stats.currFrame.actors.alive++;for(let l=0;l<a.children.length;l++){const f=a.children[l];md(f)?e.stats.currFrame.actors.ui++:e.stats.currFrame.actors.alive++}}}}var Qs;(function(u){u.Protanope="Protanope",u.Deuteranope="Deuteranope",u.Tritanope="Tritanope"})(Qs||(Qs={}));const Np=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class Wd{constructor(e,s){this._shader=new Ke({gl:e,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:s}),this._shader.compile(),this._buffer=new Li({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new es({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class Nd{constructor(e,s=!1){this._colorBlindnessMode=e,this._simulate=!1,this._simulate=s}initialize(e){this._shader=new Wd(e,Np),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(e){if(this._colorBlindnessMode=e,this._shader){const s=this._shader.getShader();s.use(),this._colorBlindnessMode===Qs.Protanope?s.setUniformInt("u_type",0):this._colorBlindnessMode===Qs.Deuteranope?s.setUniformInt("u_type",1):this._colorBlindnessMode===Qs.Tritanope&&s.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(e){if(this._simulate=e,this._shader){const s=this._shader.getShader();s.use(),s.setUniformBoolean("u_simulate",e)}}get simulate(){return this._simulate}}class Gd{constructor(e){this._engine=e,this._colorBlindPostProcessor=new Nd(Qs.Protanope)}correct(e){this._engine.graphicsContext instanceof ss&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(e){this._engine.graphicsContext instanceof ss&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class Vd{constructor(e){this.stats={currFrame:new wr,prevFrame:new wr},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:Q.Yellow,showZIndex:!1,showScale:!1,scaleColor:Q.Green,showRotation:!1,rotationColor:Q.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:Q.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:Q.Blue,showOwner:!1,showGeometry:!0,geometryColor:Q.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:Q.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:Q.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:Q.Yellow,showAcceleration:!1,accelerationColor:Q.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:Q.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:Q.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:Q.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:Q.Yellow,positionSize:1,showGrid:!1,gridColor:Q.Red,gridWidth:1,showColliderGeometry:!0},this._engine=e,this.colorBlindMode=new Gd(this._engine)}useTestClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const r=e.toTestClock();return s&&r.start(),this._engine.clock=r,r}useStandardClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const r=e.toStandardClock();return s&&r.start(),this._engine.clock=r,r}}class wr{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new So,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(e){e?(this.id=e.id,this.elapsedMs=e.elapsedMs,this.fps=e.fps,this.actors.alive=e.actors.alive,this.actors.killed=e.actors.killed,this.actors.ui=e.actors.ui,this.duration.update=e.duration.update,this.duration.draw=e.duration.draw,this._physicsStats.reset(e.physics),this.graphics.drawCalls=e.graphics.drawCalls,this.graphics.drawnImages=e.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const e=new wr;return e.reset(this),e}get id(){return this._id}set id(e){this._id=e}get elapsedMs(){return this._elapsedMs}set elapsedMs(e){this._elapsedMs=e}get fps(){return this._fps}set fps(e){this._fps=e}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class So{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(e){e?(this.pairs=e.pairs,this.collisions=e.collisions,this.contacts=e.contacts,this.fastBodies=e.fastBodies,this.fastBodyCollisions=e.fastBodyCollisions,this.broadphase=e.broadphase,this.narrowphase=e.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const e=new So;return e.reset(this),e}get pairs(){return this._pairs}set pairs(e){this._pairs=e}get collisions(){return this._collisions}set collisions(e){this._collisions=e}get contacts(){return this._contacts}set contacts(e){this._contacts=e}get fastBodies(){return this._fastBodies}set fastBodies(e){this._fastBodies=e}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(e){this._fastBodyCollisions=e}get broadphase(){return this._broadphase}set broadphase(e){this._broadphase=e}get narrowphase(){return this._narrowphase}set narrowphase(e){this._narrowphase=e}}class Rh{on(e,s){this._nativeHandlers[e]&&this.off(e,this._nativeHandlers[e]),this._nativeHandlers[e]=this._decorate(s),this.nativeComponent.addEventListener(e,this._nativeHandlers[e])}off(e,s){s||(s=this._nativeHandlers[e]),this.nativeComponent.removeEventListener(e,s),this._nativeHandlers[e]=null}_decorate(e){return s=>{this._paused||e(s)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const e in this._nativeHandlers)this.off(e)}constructor(e){this.nativeComponent=e,this._paused=!1,this._nativeHandlers={}}}class Xd{constructor(e,s){this._windowGlobal=e,this._documentGlobal=s,this._windowComponent=new Rh(this._windowGlobal),this._documentComponent=new Rh(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const qd={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:ce.Blended,canvasImageRendering:"auto"},Yd={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:ce.Blended,canvasImageRendering:"auto"};class jd{constructor(e){var s;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=e.initialFps,this._samplePeriod=(s=e.samplePeriod)!==null&&s!==void 0?s:this._samplePeriod,this._currentFrameTime=1e3/e.initialFps,this._nowFn=e.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const e=this._nowFn();this._currentFrameTime=e-this._beginFrameTime,e>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(e-this._previousSampleTime),this._previousSampleTime=e,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class Dh{constructor(e){var s,r,a;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=e,this.tick=e.tick,this._lastTime=(s=this.now())!==null&&s!==void 0?s:0,this._maxFps=(r=e.maxFps)!==null&&r!==void 0?r:this._maxFps,this._onFatalException=(a=e.onFatalException)!==null&&a!==void 0?a:this._onFatalException,this.fpsSampler=new jd({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new Zd({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new Mh({...this._options})}setFatalExceptionHandler(e){this._onFatalException=e}schedule(e,s=0,r="preframe"){const a=this._totalElapsed+s;this._scheduledCbs.push([e,a,r])}__runScheduledCbs(e="preframe"){for(let s=this._scheduledCbs.length-1;s>-1;s--)e===this._scheduledCbs[s][2]&&this._scheduledCbs[s][1]<=this._totalElapsed&&(this._scheduledCbs[s][0](this._elapsed),this._scheduledCbs.splice(s,1))}update(e){try{this.fpsSampler.start();const s=this.now();let r=s-this._lastTime||1;const a=1e3/this._maxFps;if(r>=a){let l=0;a!==0&&(l=r%a,r=r-l),r>200&&(r=1),this._elapsed=e||r,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(e||r),this.__runScheduledCbs("postframe"),a!==0?this._lastTime=s-l:this._lastTime=s,this.fpsSampler.end()}}catch(s){this._onFatalException(s),this.stop()}}}class Mh extends Dh{constructor(e){super(e),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const e=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(e),this.update()}catch(s){throw window.cancelAnimationFrame(this._requestId),s}};e()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class Zd extends Dh{constructor(e){super({...e}),this._logger=ot.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=e.defaultUpdateMs}now(){var e;return(e=this._currentTime)!==null&&e!==void 0?e:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(e){const s=e??this._updateMs;this._running?(this.update(s),this._currentTime+=s):this._logger.warn("The clock is not running, no step will be performed")}run(e,s){for(let r=0;r<e;r++)this.step(s??this._updateMs)}}var Gp=o(296);class Qd{constructor(){this._toasterCss=Gp.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(e){const s=document.createElement("span");return s.innerText=e,s}toast(e,s,r){this._initialize();const a=document.createElement("div");a.className="ex-toast-message";const l=e.split("[LINK]").map(y=>this._createFragment(y));if(s){const y=document.createElement("a");y.href=s,r?y.innerText=r:y.innerText=s,l.splice(1,0,y)}const f=document.createElement("div");l.forEach(y=>{f.appendChild(y)}),a.appendChild(f);const p=document.createElement("button");p.innerText="x",p.addEventListener("click",()=>{this._container.removeChild(a)}),a.appendChild(p);const m=y=>{if(y.key==="Escape")try{this._container.removeChild(a)}catch{}document.removeEventListener("keydown",m)};document.addEventListener("keydown",m);const w=this._container.firstChild;this._container.insertBefore(a,w)}}const Vp={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class $d{get isTransitioning(){return this._isTransitioning}constructor(e,s){this._engine=e,this.events=new I,this._logger=ot.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new di,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const r in s){const a=s[r];this.add(r,a),r==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const e=this._deferredGoto;this._deferredGoto=void 0;const s=this._deferredTransition;this._deferredTransition=void 0;const r=this.getSceneInstance(e);r&&s&&s._addToTargetScene(this._engine,r),await this.swapScene(e),r&&s&&await this.playTransition(s,r)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(e,s){const r=s?.loader;r instanceof rr?this.mainLoader=r:sh(r)?this.mainLoader=new r:this.mainLoader=new qs;let a;if(s?.inTransition){const{inTransition:l}=s;a=l}if(this.startScene=e,a){const l=this.getSceneInstance(this.startScene);l&&(a._addToTargetScene(this._engine,l),this.swapScene(this.startScene).then(()=>this.playTransition(a,l)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(e){return this._sceneToLoader.get(e)}_getInTransition(e){var s;const r=this.scenes[e];if(!(r instanceof di||Ni(r)))return(s=r?.transitions)===null||s===void 0?void 0:s.in}_getOutTransition(e){var s;const r=this.scenes[e];if(!(r instanceof di||Ni(r)))return(s=r?.transitions)===null||s===void 0?void 0:s.out}getDeferredScene(){const e=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&e?e:null}getSceneDefinition(e){const s=this.scenes[e];if(s instanceof di||Ni(s))return s;if(s)return s.scene}getSceneName(e){for(const[s,r]of Object.entries(this.scenes))if(r instanceof di){if(e===r)return s}else if(!Ni(r)&&e===r.scene)return s;for(const[s,r]of Object.entries(this.scenes))if(Ni(r)){if(e.constructor===r)return s}else if(!(r instanceof di)&&e.constructor===r.scene)return s;return null}assertAdded(e){return this}assertRemoved(e){return this}add(e,s){if(!(s instanceof di)&&!Ni(s)){const{loader:r,transitions:a}=s,{in:l,out:f}=a??{};this._sceneToTransition.set(e,{in:l,out:f}),sh(r)?this._sceneToLoader.set(e,new r):r&&this._sceneToLoader.set(e,r)}return this.scenes[e]&&this._logger.warn("Scene",e,"already exists overwriting"),this.scenes[e]=s,this.assertAdded(e)}remove(e){if(e instanceof di||Ni(e)){const s=e;for(const r in this.scenes)if(this.scenes.hasOwnProperty(r)){const a=this.scenes[r];let l;if(a instanceof di||Ni(a)?l=a:l=a.scene,l===s){if(r===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${r}`);this._sceneToInstance.delete(r),this._sceneToTransition.delete(r),this._sceneToLoader.delete(r),delete this.scenes[r]}}}if(typeof e=="string"){if(e===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${e}`);this._sceneToInstance.delete(e),this._sceneToTransition.delete(e),this._sceneToLoader.delete(e),delete this.scenes[e]}}async goToScene(e,s){var r,a,l,f,p,m;const w=this.getSceneInstance(e);if(!w){this._logger.warn(`Scene ${e} does not exist! Check the name, are you sure you added it?`);return}const y=this.currentScene,A=this.currentSceneName,E=(a=(r=this._engine.input)===null||r===void 0?void 0:r.enabled)!==null&&a!==void 0?a:!0;this._isTransitioning=!0;const D=(l=this.getSceneInstance(A))===null||l===void 0?void 0:l.onTransition("out"),L=w?.onTransition("in");s={sourceOut:(f=this._getOutTransition(this.currentSceneName))!==null&&f!==void 0?f:D,destinationIn:(p=this._getInTransition(e))!==null&&p!==void 0?p:L,...s};const{sourceOut:O,destinationIn:q,sceneActivationData:H}=s,N=O??this._getOutTransition(this.currentSceneName),$=q??this._getInTransition(e),Y=N?.hideLoader||$?.hideLoader;Y&&this.maybeLoadScene(e,Y),this._emitEvent("navigationstart",A,e),N&&await this.playTransition(N,y),await this.maybeLoadScene(e,Y),$&&await $.onPreviousSceneDeactivate(this.currentScene),$&&$._addToTargetScene(this._engine,w),await this.swapScene(e,H),this._emitEvent("navigation",A,e),$&&await this.playTransition($,w),this._emitEvent("navigationend",A,e),(m=this._engine.input)===null||m===void 0||m.toggleEnabled(E),this._isTransitioning=!1}getSceneInstance(e){const s=this.getSceneDefinition(e);if(!s)return;if(this._sceneToInstance.has(e))return this._sceneToInstance.get(e);if(s instanceof di)return this._sceneToInstance.set(e,s),s;const r=new s;return this._sceneToInstance.set(e,r),r}async maybeLoadScene(e,s=!1){var r;const a=(r=this._getLoader(e))!==null&&r!==void 0?r:new rr,l=this.getSceneDefinition(e),f=this.getSceneInstance(e);l&&f&&!this._loadedScenes.has(f)&&(f.onPreLoad(a),f.events.emit("preload",{loader:a}),s?this._engine.load(a,s):await this._engine.load(a),this._loadedScenes.add(f))}async playTransition(e,s){var r,a,l,f,p,m,w;if(!this.isInitialized){this._deferredTransition=e;return}if(e){this.currentTransition=e;const y=(a=(r=s.input)===null||r===void 0?void 0:r.enabled)!==null&&a!==void 0?a:!0;(l=s.input)===null||l===void 0||l.toggleEnabled(!e.blockInput),(f=this._engine.input)===null||f===void 0||f.toggleEnabled(!e.blockInput),this.currentTransition._addToTargetScene(this._engine,s),await this.currentTransition._play(),(p=s.input)===null||p===void 0||p.toggleEnabled(y)}(m=this.currentTransition)===null||m===void 0||m.kill(),(w=this.currentTransition)===null||w===void 0||w.reset(),this.currentTransition=void 0}async swapScene(e,s){const r=this._engine;if(!this.isInitialized){this._deferredGoto=e;return}const a=this.getSceneInstance(e);if(a){const l=this.currentScene,f=a;if(this._logger.debug("Going to scene:",e),this.currentScene.isInitialized){const w={engine:r,previousScene:l,nextScene:f};await this.currentScene._deactivate(w),this.currentScene.events.emit("deactivate",new Va(w,this.currentScene)),this.currentScene.input.clear()}const p=this._sceneToLoader.get(e);await p?.areResourcesLoaded(),this.currentScene=f,this.currentSceneName=e,r.screen.setCurrentCamera(f.camera),await this.currentScene._initialize(r);const m={engine:r,previousScene:l,nextScene:f,data:s};await this.currentScene._activate(m),this.currentScene.events.emit("activate",new Ga(m,this.currentScene))}else this._logger.error("Scene",e,"does not exist!")}_emitEvent(e,s,r){const a=this.getSceneDefinition(s),l=this.getSceneDefinition(r);this.events.emit(e,{sourceScene:a,sourceName:s,destinationScene:l,destinationName:r})}}function Kd(){const u={scope:(e,s)=>{const r=u.value;u.value=e;try{return s()}catch(a){throw a}finally{u.value=r}},value:void 0};return u}function Jd(u){return u.value}const Fh={textureCollectInterval:6e4};class tu{constructor(e){this.options=e,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=s=>{if(this._running){for(const[r,[a,l]]of this._collectors.entries()){const f=this.options.getTimestamp();for(const[p,[m,w]]of this._collectionMap.entries()){if(r!==m||w+l>=f)continue;a(p)&&this._collectionMap.delete(p)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(e,s,r){this._collectors.set(e,[r,s])}addCollectableResource(e,s){this._collectionMap.set(s,[e,this.options.getTimestamp()])}touch(e){const s=this._collectionMap.get(e);s&&this._collectionMap.set(e,[s[0],this.options.getTimestamp()])}forceCollectAll(){for(const[e,[s]]of this._collectors.entries())for(const[r]of this._collectionMap.entries())s(r)&&this._collectionMap.delete(r)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}x();const Xp={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Is;(function(u){u[u.None=0]="None",u[u.Canvas=1]="Canvas",u[u.All=2]="All"})(Is||(Is={}));class ti{static useEngine(){const e=Jd(ti.Context);if(!e)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return e}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(e){this.graphicsContext.snapToPixel=e}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,r,a,l,f,p,m,w,y;this.scope=Y=>ti.Context.scope(this,Y),this.version=Oh,this.events=new I,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=Y=>{ot.getInstance().fatal(Y,Y.stack)},this._toaster=new Qd,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=Y=>{var J;Y.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",Y);const rt=document.createElement("div");rt.id="ex-webgl-graphics-context-lost",rt.style.position="absolute",rt.style.zIndex="99",rt.style.left="50%",rt.style.top="50%",rt.style.display="flex",rt.style.flexDirection="column",rt.style.transform="translate(-50%, -50%)",rt.style.backgroundColor="white",rt.style.padding="10px",rt.style.borderStyle="solid 1px";const Z=document.createElement("div");if(Z.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,rt.appendChild(Z),!((J=this.canvas)===null||J===void 0)&&J.parentElement){this.canvas.parentElement.appendChild(rt);const ft=Z.querySelector("#ex-webgl-graphics-reload");ft?.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new T,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],e={...ti._DEFAULT_ENGINE_OPTIONS,...e},this._originalOptions=e,b.freeze(),this.browser=new Xd(window,document);const A=new Hc;if(!e.suppressMinimumBrowserFeatureDetection&&!(this._compatible=A.test())){const Y=document.createElement("div");if(Y.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(Y),A.failedTests.forEach(function(J){const rt=document.createElement("div");rt.innerText="Browser feature missing "+J,document.body.appendChild(rt)}),e.canvasElementId){const J=document.getElementById(e.canvasElementId);J&&J.parentElement.removeChild(J)}return}else this._compatible=!0;if(console.log&&!e.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${Oh})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),e.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=ot.getInstance(),this._logger.defaultLevel===Ht.Debug&&A.logBrowserFeatures(),this._logger.debug("Building engine..."),e.garbageCollection===!0?this.garbageCollectorConfig={...Fh}:e.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...Fh,...e.garbageCollection},this._garbageCollector=new tu({getTimestamp:Date.now}),this.canvasElementId=e.canvasElementId,e.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+e.canvasElementId),document.getElementById(e.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(e.canvasElementId)}else e.canvasElement?(this._logger.debug("Using Canvas element specified:",e.canvasElement),this.canvas=e.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!e.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",Y=>{Y.preventDefault()});let E=(s=e.displayMode)!==null&&s!==void 0?s:be.Fixed;e.width&&e.height||e.viewport?(e.displayMode===void 0&&(E=be.Fixed),this._logger.debug("Engine viewport is size "+e.width+" x "+e.height)):e.displayMode||(this._logger.debug("Engine viewport is fit"),E=be.FitScreen),this.grabWindowFocus=e.grabWindowFocus,this.pointerScope=e.pointerScope,this._originalDisplayMode=E;let D,L,O,q,H,N;typeof e.antialiasing=="object"?{pixelArtSampler:D,nativeContextAntialiasing:O,multiSampleAntialiasing:N,filtering:H,canvasImageRendering:q}={...e.pixelArt?Yd:qd,...e.antialiasing}:(D=!!e.pixelArt,O=!1,N=e.antialiasing,q=e.antialiasing?"auto":"pixelated",H=e.antialiasing?ce.Blended:ce.Pixel),O&&N&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),e.pixelArt&&(L=.25),(!e.antialiasing||H===ce.Pixel)&&(L=0),L=(a=(r=e.uvPadding)!==null&&r!==void 0?r:L)!==null&&a!==void 0?a:.01;let $=b.isEnabled("use-canvas-context");if(!$)try{this.graphicsContext=new ss({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:D,antialiasing:O,multiSampleAntialiasing:N,uvPadding:L,powerPreference:e.powerPreference,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(l=e.handleContextLost)!==null&&l!==void 0?l:this._handleWebGLContextLost,handleContextRestored:e.handleContextRestored})}catch(Y){this._logger.warn(`Excalibur could not load webgl for some reason (${Y.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),$=!0}$&&(this.graphicsContext=new fo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:O,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting})),this.screen=new th({canvas:this.canvas,context:this.graphicsContext,antialiasing:O,canvasImageRendering:q,browser:this.browser,viewport:(f=e.viewport)!==null&&f!==void 0?f:e.width&&e.height?{width:e.width,height:e.height}:Ja.SVGA,resolution:e.resolution,displayMode:E,pixelRatio:e.suppressHiDPIScaling?1:(p=e.pixelRatio)!==null&&p!==void 0?p:null}),Jt.filtering=H,e.backgroundColor&&(this.backgroundColor=e.backgroundColor.clone()),this.maxFps=(m=e.maxFps)!==null&&m!==void 0?m:this.maxFps,this.fixedUpdateTimestep=(w=e.fixedUpdateTimestep)!==null&&w!==void 0?w:this.fixedUpdateTimestep,this.fixedUpdateFps=(y=e.fixedUpdateFps)!==null&&y!==void 0?y:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new Mh({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:Y=>this.onFatalException(Y)}),this.enableCanvasTransparency=e.enableCanvasTransparency,typeof e.physics=="boolean"?this.physics={...os(),enabled:e.physics}:(this.physics={...os()},Qr(this.physics,e.physics)),this.debug=new Vd(this),this.director=new $d(this,e.scenes),this._initialize(e),window.___EXCALIBUR_DEVTOOL=this,ti.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:e}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:s,showPlayerMessage:r}=this._originalOptions.configurePerformanceCanvas2DFallback;if(s===void 0&&(s=ti._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),r===void 0&&(r=ti._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!b.isEnabled("use-canvas-context")&&e&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===s.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let a=0;for(let f=0;f<this._fpsSamples.length;f++)a+=this._fpsSamples[f];const l=a/this._fpsSamples.length;this._fpsSamples.length===s.numberOfFrames&&l<=s.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),r&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var e,s,r;const a=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(a,this.canvas),this.canvas=a;const l={...this._originalOptions,antialiasing:this.screen.antialiasing},f=this._originalDisplayMode;this.graphicsContext=new fo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:l.antialiasing,backgroundColor:l.backgroundColor,snapToPixel:l.snapToPixel,useDrawSorting:l.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new th({canvas:this.canvas,context:this.graphicsContext,antialiasing:(e=l.antialiasing)!==null&&e!==void 0?e:!0,browser:this.browser,viewport:(s=l.viewport)!==null&&s!==void 0?s:l.width&&l.height?{width:l.width,height:l.height}:Ja.SVGA,resolution:l.resolution,displayMode:f,pixelRatio:l.suppressHiDPIScaling?1:(r=l.pixelRatio)!==null&&r!==void 0?r:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const p=l&&l.pointerScope===F.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(p,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,ti.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(e){if(e<0){ot.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=e}addTimer(e){return this.currentScene.addTimer(e)}removeTimer(e){return this.currentScene.removeTimer(e)}addScene(e,s){return this.director.add(e,s),this}removeScene(e){this.director.remove(e)}add(e){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const s=this.director.getDeferredScene();s instanceof di?s.add(e):this.currentScene.add(e)}remove(e){e instanceof Ue&&this.currentScene.remove(e),(e instanceof di||Ni(e))&&this.removeScene(e),typeof e=="string"&&this.removeScene(e)}async goToScene(e,s){await this.scope(async()=>{await this.director.goToScene(e,s)})}screenToWorldCoordinates(e){return this.screen.screenToWorldCoordinates(e)}worldToScreenCoordinates(e){return this.screen.worldToScreenCoordinates(e)}_initialize(e){var s,r;this.pageScrollPreventionMode=e.scrollPreventionMode;const a=e&&e.pointerScope===F.Document?document:this.canvas,l=(r=(s=this._originalOptions)===null||s===void 0?void 0:s.grabWindowFocus)!==null&&r!==void 0?r:!0;this.input=new Ih({pointerTarget:a,grabWindowFocus:l,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new Na(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new Wa(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!e.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(e){this._inputEnabled=e,this.input.toggleEnabled(this._inputEnabled)}onInitialize(e){}get isInitialized(){return this._isInitialized}async _overrideInitialize(e){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(e),this.events.emit("initialize",new Pn(e,this)),this._isInitialized=!0)}_update(e){var s;if(this._isLoading){(s=this._loader)===null||s===void 0||s.onUpdate(this,e),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(e),this.currentScene.update(this,e),this.graphicsContext.updatePostProcessors(e),this.clock.__runScheduledCbs("postupdate"),this._postupdate(e),this.input.update()}_preupdate(e){this.emit("preupdate",new Cs(this,e,this)),this.onPreUpdate(this,e)}onPreUpdate(e,s){}_postupdate(e){this.emit("postupdate",new Ps(this,e,this)),this.onPostUpdate(this,e)}onPostUpdate(e,s){}_draw(e){var s,r;if(this.graphicsContext.backgroundColor=(s=this.currentScene.backgroundColor)!==null&&s!==void 0?s:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,e),this._isLoading){this._hideLoader||((r=this._loader)===null||r===void 0||r.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,e),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,e),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(e,s){this.emit("predraw",new An(e,s,this)),this.onPreDraw(e,s)}onPreDraw(e,s){}_postdraw(e,s){this.emit("postdraw",new Cn(e,s,this)),this.onPostDraw(e,s)}onPostDraw(e,s){}showDebug(e){this._isDebug=e}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(e,s){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let r;return e instanceof rr?r=e:typeof e=="string"&&(this.director.configureStart(e,s),r=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(r??new qs),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new Ia(this)),this._isReadyFuture.promise})}_mainloop(e){this.scope(()=>{this.emit("preframe",new ka(this,this.stats.prevFrame));const s=e*this.timescale;this.currentFrameElapsedMs=s;const r=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=r,this.stats.currFrame.elapsedMs=s,this.stats.currFrame.fps=this.clock.fpsSampler.fps,Xt.clear();const a=this.clock.now(),l=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=s;this._lagMs>=l;)this._update(l),this._lagMs-=l;else this._update(s);const f=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(s);const p=this.clock.now();this.stats.currFrame.duration.update=f-a,this.stats.currFrame.duration.draw=p-f,this.stats.currFrame.graphics.drawnImages=Xt.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=Xt.DrawCallCount,this.emit("postframe",new La(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new Ra(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(e=!1){return new Promise(r=>{this._screenShotRequests.push({preserveHiDPIResolution:e,resolve:r})})}_checkForScreenShots(){for(const e of this._screenShotRequests){const s=e.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,r=e.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,a=document.createElement("canvas");a.width=s,a.height=r;const l=a.getContext("2d");l.imageSmoothingEnabled=this.screen.antialiasing,l.drawImage(this.canvas,0,0,s,r);const f=new Image,p=a.toDataURL("image/png");f.onload=()=>{e.resolve(f)},f.src=p}this._screenShotRequests.length=0}async load(e,s=!1){await this.scope(async()=>{try{if(e.isLoaded())return;this._loader=e,this._isLoading=!0,this._hideLoader=s,e instanceof qs&&(e.suppressPlayButton=e.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await e.load()}catch(r){this._logger.error("Error loading resources, things may not behave properly",r),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}ti.Context=Kd(),ti.InstanceCount=0,ti._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:F.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Is.Canvas,backgroundColor:Q.fromHex("#2185d0")};class qp extends Ye{set maxWidth(e){this._text.maxWidth=e}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(e){this._font=e,this._text.font=e}get text(){return this._text.text}set text(e){this._text.text=e}get color(){return this._text.color}set color(e){this._text&&(this._text.color=e)}get opacity(){return this.graphics.opacity}set opacity(e){this.graphics.opacity=e}get spriteFont(){return this._spriteFont}set spriteFont(e){e&&(this._spriteFont=e,this._text.font=this._spriteFont)}constructor(e){super(e),this._font=new Ws,this._text=new er({text:"",font:this._font});const{text:s,pos:r,x:a,y:l,spriteFont:f,font:p,color:m,maxWidth:w}={text:"",...e};this.pos=r??(a&&l?z(a,l):this.pos),this.text=s??this.text,this.font=p??this.font,this.maxWidth=w??this.maxWidth,this.spriteFont=f??this.spriteFont,this._text.color=m??this.color;const y=this.get(te);y.anchor=B.Zero,y.use(this._text)}_initialize(e){super._initialize(e)}getTextWidth(){return this._text.width}}var Rs;(function(u){u.Circle="circle",u.Rectangle="rectangle"})(Rs||(Rs={}));class Yp extends Ye{constructor(e){var s,r;super({width:(s=e.width)!==null&&s!==void 0?s:0,height:(r=e.height)!==null&&r!==void 0?r:0}),this._particlesToEmit=0,this._particlePool=new Qn(()=>new uo({}),L=>L,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=Rs.Rectangle,this.radius=0,this.particle={life:2e3,transform:Ci.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:a,x:l,y:f,z:p,pos:m,isEmitting:w,emitRate:y,emitterType:A,radius:E,random:D}={...e};this.particle={...this.particle,...a},this.pos=m??z(l??0,f??0),this.z=p??0,this.isEmitting=w??this.isEmitting,this.emitRate=y??this.emitRate,this.emitterType=A??this.emitterType,this.radius=E??this.radius,this.body.collisionType=dt.PreventCollision,this.random=D??new M}removeParticle(e){this.deadParticles.push(e)}emitParticles(e){var s;if(!(e<=0)){e=e|0;for(let r=0;r<e;r++){const a=this._createParticle();!((s=this===null||this===void 0?void 0:this.scene)===null||s===void 0)&&s.world&&(this.particle.transform===Ci.Global?this.scene.world.add(a):this.addChild(a)),this._activeParticles.push(a)}}}clearParticles(){for(let e=0;e<this._activeParticles.length;e++)this.removeParticle(this._activeParticles[e])}_createParticle(){let e=0,s=0;const r=At(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),a=At(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),l=this.particle.startSize||At(this.particle.minSize||5,this.particle.maxSize||5,this.random),f=a*Math.cos(r),p=a*Math.sin(r);if(this.emitterType===Rs.Rectangle)e=At(0,this.width,this.random),s=At(0,this.height,this.random);else if(this.emitterType===Rs.Circle){const w=At(0,this.radius,this.random);e=w*Math.cos(r),s=w*Math.sin(r)}const m=this._particlePool.rent();return m.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:z(e,s),vel:z(f,p),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:l,graphic:this.particle.graphic,fade:this.particle.fade}),m.registerEmitter(this),this.particle.randomRotation&&(m.transform.rotation=At(0,Math.PI*2,this.random)),this.particle.focus&&(m.focus=this.particle.focus.add(z(this.pos.x,this.pos.y)),m.focusAccel=this.particle.focusAccel),m}update(e,s){var r;super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let a=0;a<this.deadParticles.length;a++){!((r=this===null||this===void 0?void 0:this.scene)===null||r===void 0)&&r.world&&(this.scene.world.remove(this.deadParticles[a],!1),this._particlePool.return(this.deadParticles[a]));const l=this._activeParticles.indexOf(this.deadParticles[a]);l>-1&&this._activeParticles.splice(l,1)}this.deadParticles.length=0}}function jp(u,e){}class Eo{constructor(e,s,r){var a;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=e,this.particle=r,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=s,this._particleLife=(a=this.particle.life)!==null&&a!==void 0?a:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(e,s){if(this._initialized)return;const r=this.emitter.maxParticles,a=this._numInputFloats,l=this._particleData,f=4,p=e.createBuffer(),m=e.createVertexArray();e.bindVertexArray(m),e.bindBuffer(e.ARRAY_BUFFER,p),e.bufferData(e.ARRAY_BUFFER,r*a*f,e.DYNAMIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,l);let w=0;e.vertexAttribPointer(0,2,e.FLOAT,!1,a*f,0),w+=f*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*f,w),w+=f*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*f,w),w+=f*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(m),this._buffers.push(p),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null);const y=e.createBuffer(),A=e.createVertexArray();e.bindVertexArray(A),e.bindBuffer(e.ARRAY_BUFFER,y),e.bufferData(e.ARRAY_BUFFER,r*a*f,e.DYNAMIC_DRAW),w=0,e.vertexAttribPointer(0,2,e.FLOAT,!1,a*f,0),w+=f*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*f,w),w+=f*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*f,w),w+=f*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(A),this._buffers.push(y),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(e){const s=this._particleIndex,r=this.maxParticles*this._numInputFloats,a=e*this._numInputFloats+s;for(let l=s;l<a;l+=this._numInputFloats){const f=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||W),p=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),m=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),w=p*Math.cos(f),y=m*Math.sin(f);let A=0,E=0;if(this.emitter.emitterType===Rs.Rectangle)A=this._random.floating(-.5,.5)*this.emitter.width,E=this._random.floating(-.5,.5)*this.emitter.height;else{const O=this._random.floating(0,this.emitter.radius);A=O*Math.cos(f),E=O*Math.sin(f)}const D=this.emitter.transform.apply(z(A,E)),L=[this.particle.transform===Ci.Local?A:D.x,this.particle.transform===Ci.Local?E:D.y,w,y,this.particle.randomRotation?At(0,W,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(L,l%this._particleData.length)}a>=r?(this._wrappedParticles+=(a-r)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=e),this._particleIndex=a%r,this._emitted.push([this._particleLife,s])}_uploadEmitted(e){this._particleIndex!==this._uploadIndex&&(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),e.bindBuffer(e.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(e){var s;if(this._particleLife=(s=this.particle.life)!==null&&s!==void 0?s:this._particleLife,this._wrappedLife>0?this._wrappedLife-=e:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let r=this._emitted.length-1;r>=0;r--){const a=this._emitted[r];a[0]-=e,a[0]<=0&&this._emitted.splice(r,1)}this._emitted.sort((r,a)=>r[0]-a[0])}}draw(e){if(this._initialized){if(this._clearRequested?(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData),e.bindBuffer(e.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(e),e.bindVertexArray(this._currentVao),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const s=this._emitted[0][1]/this._numInputFloats;e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-s)*this._numInputFloats*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,s,this.maxParticles-s),e.endTransformFeedback(),e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,s),e.endTransformFeedback()}else e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,this.maxParticles),e.endTransformFeedback();e.bindVertexArray(null),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}Eo.GPU_MAX_PARTICLES=1e5;class Zp extends Ye{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get z(){return this.transform.z}set z(e){this.transform.z=e}constructor(e){super({name:"GpuParticleEmitter",width:e.width,height:e.height}),this.particle={life:2e3,transform:Ci.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new te,this.isEmitting=!1,this.emitRate=1,this.emitterType=Rs.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:s,maxParticles:r,x:a,y:l,z:f,pos:p,isEmitting:m,emitRate:w,emitterType:y,radius:A,random:E}={...e};this.maxParticles=j(r??this.maxParticles,0,Eo.GPU_MAX_PARTICLES),this.pos=p??z(a??0,l??0),this.z=f??0,this.isEmitting=m??this.isEmitting,this.emitRate=w??this.emitRate,this.emitterType=y??this.emitterType,this.radius=A??this.radius,this.particle={...this.particle,...s},this.random=E??new M,this.renderer=new Eo(this,this.random,this.particle)}_initialize(e){super._initialize(e);const s=e.graphicsContext;this.renderer.initialize(s.__gl,s)}update(e,s){super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(s)}emitParticles(e){e<=0||this.renderer.emitParticles(e|0)}clearParticles(){this.renderer.clearParticles()}draw(e,s){e.draw("ex.particle",this.renderer,s)}}class eu extends Ue{getGraphics(){return this._graphics}addGraphic(e,s){this._graphics.push(e),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,s?.offset&&(this._gfx.offset=s.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let e=this._tileBounds.clone();for(const s of this._graphics){const r=z(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:s.height-this.map.tileHeight));e=e.combine(s.localBounds.translate(r))}return e}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&this._graphics.splice(s,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(z(this.x,this.y))}get center(){return this.pos.add(z(0,this.map.tileHeight/2))}constructor(e,s,r,a){super([new et,new te({offset:r??B.Zero,onPostDraw:(E,D)=>this.draw(E,D)}),new _r(a)]),this.solid=!1,this.events=new I,this._tileBounds=new at,this._graphics=[],this._colliders=[],this.data=new Map,this.x=e,this.y=s,this.map=a,this._transform=this.get(et),this._isometricEntityComponent=this.get(_r);const l=this.map.tileWidth/2,f=this.map.tileHeight/2,p=(this.x-this.y)*l,m=(this.x+this.y)*f;this._transform.pos=z(p,m),this._isometricEntityComponent.elevation=a.elevation,this._gfx=this.get(te),this._gfx.isVisible=!1;const w=this.map.tileWidth,y=this.map.tileHeight,A=z(0,this.map.renderFromTopOfGraphic?y:0);this._gfx.localBounds=this._tileBounds=new at({left:-w/2,top:-y,right:w/2,bottom:y}).translate(A)}draw(e,s){const r=this.map.tileWidth/2;e.save(),e.translate(-r,0);for(const a of this._graphics)a.draw(e,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:a.height-this.map.tileHeight));e.restore()}}class Qp extends Ue{get visible(){return this.isVisible}set visible(e){this.isVisible=e}constructor(e){super([new et,new Ct({type:dt.Fixed}),new ue,new Ss,new wo((y,A)=>this.debug(y,A),!1)],e.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=z(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:s,tileWidth:r,tileHeight:a,columns:l,rows:f,renderFromTopOfGraphic:p,graphicsOffset:m,elevation:w}=e;this.transform=this.get(et),s&&(this.transform.pos=s),this.collider=this.get(ue),this.collider&&this.collider.set(this._composite=new ye([])),this.pointer=this.get(Ss),this.renderFromTopOfGraphic=p??this.renderFromTopOfGraphic,this.graphicsOffset=m??this.graphicsOffset,this.elevation=w??this.elevation,this.tileWidth=r,this.tileHeight=a,this.columns=l,this.rows=f,this._pointerEventDispatcher=new gh,this.tiles=new Array(l*f);for(let y=0;y<f;y++)for(let A=0;A<l;A++){const E=new eu(A,y,this.graphicsOffset,this);this.tiles[A+y*l]=E,this.addChild(E),this._pointerEventDispatcher.addObject(E,D=>this.getTileByPoint(D.worldPos)===E,()=>!0)}this.pointer.localBounds=at.fromDimension(r*l*this.transform.scale.x,a*f*this.transform.scale.y,z(.5,0))}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:B.Zero;{const r=e.offset;return this._originalOffsets.set(e,r),r}}updateColliders(){this._composite.clearColliders();const e=this.get(et).pos;for(const s of this.tiles)if(s.solid)for(const r of s.getColliders()){const a=this._getOrSetColliderOriginalOffset(r);r.offset=this.tileToWorld(z(s.x,s.y)).sub(e).add(a).sub(z(this.tileWidth/2,this.tileHeight)),r.owner=this,this._composite.addCollider(r)}this.collider.update()}worldToTile(e){e=e.sub(this.transform.globalPos);const s=this.tileWidth/2,r=this.tileHeight/2;return z(~~((e.x/s+e.y/r)/2),~~((e.y/r-e.x/s)/2))}tileToWorld(e){const s=this.tileWidth/2,r=this.tileHeight/2,a=(e.x-e.y)*s,l=(e.x+e.y)*r;return z(a,l).add(this.transform.pos)}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const s=this.worldToTile(e);return this.getTile(s.x,s.y)}_getMaxZIndex(){let e=Number.NEGATIVE_INFINITY;for(const s of this.tiles){const r=s.get(et).z;r>e&&(e=r)}return e}debug(e,s){const{showAll:r,showPosition:a,positionColor:l,positionSize:f,showGrid:p,gridColor:m,gridWidth:w,showColliderGeometry:y}=s.isometric,{geometryColor:A,geometryLineWidth:E,geometryPointSize:D}=s.collider;if(e.save(),e.z=this._getMaxZIndex()+.5,r||p){for(let L=0;L<this.rows+1;L++){const O=this.tileToWorld(z(0,L)),q=this.tileToWorld(z(this.columns,L));e.drawLine(O,q,m,w)}for(let L=0;L<this.columns+1;L++){const O=this.tileToWorld(z(L,0)),q=this.tileToWorld(z(L,this.rows));e.drawLine(O,q,m,w)}}if(r||a)for(const L of this.tiles)e.drawCircle(this.tileToWorld(z(L.x,L.y)),f,l);if(r||y){for(const L of this.tiles)if(L.solid)for(const O of L.getColliders())O.debug(e,A,{lineWidth:E,pointSize:D})}e.restore()}}class Bh{constructor(e,s){this.id=Bt(),this._stopped=!1,this._sequenceBuilder=s,this._sequenceContext=new dr(e),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(e){this._actionQueue.update(e)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(e){return new Bh(e,this._sequenceBuilder)}}class $p{constructor(e){this.id=Bt(),this._actions=e}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}isComplete(e){return this._actions.every(s=>s.isComplete(e))}reset(){this._actions.forEach(e=>e.reset())}stop(){this._actions.forEach(e=>e.stop())}}class Rn{constructor(e,s){this.bounds=e,this.options=s,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...s},this.halfWidth=e.width/2,this.halfHeight=e.height/2}_split(){this._isDivided=!0;const e={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new Rn(new at({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),e),this.topRight=new Rn(new at({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),e),this.bottomLeft=new Rn(new at({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),e),this.bottomRight=new Rn(new at({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),e)}_insertIntoSubNodes(e){var s,r,a,l;!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.insert(e),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(e.bounds)&&this.topRight.insert(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.insert(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.insert(e)}insert(e){if(this._isDivided){this._insertIntoSubNodes(e);return}if(this.items.push(e),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const s of this.items)this._insertIntoSubNodes(s);this.items.length=0}}remove(e){var s,r,a,l;if(this.bounds.overlaps(e.bounds)){if(!this._isDivided){const f=this.items.indexOf(e);f>-1&&this.items.splice(f,1);return}!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.remove(e),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(e.bounds)&&this.topRight.remove(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.remove(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.remove(e)}}query(e){let s=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(e)&&(s=s.concat(this.topLeft.query(e))),this.topRight.bounds.overlaps(e)&&(s=s.concat(this.topRight.query(e))),this.bottomLeft.bounds.overlaps(e)&&(s=s.concat(this.bottomLeft.query(e))),this.bottomRight.bounds.overlaps(e)&&(s=s.concat(this.bottomRight.query(e)))),s=s.filter((r,a)=>s.indexOf(r)>=a),s}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let e=this.items;return this._isDivided&&(e=e.concat(this.topLeft.getAllItems()),e=e.concat(this.topRight.getAllItems()),e=e.concat(this.bottomLeft.getAllItems()),e=e.concat(this.bottomRight.getAllItems())),e=e.filter((s,r)=>e.indexOf(s)>=r),e}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(e){this.bounds.draw(e,Q.Yellow),this._isDivided&&(this.topLeft.bounds.draw(e,Q.Yellow),this.topRight.bounds.draw(e,Q.Yellow),this.bottomLeft.bounds.draw(e,Q.Yellow),this.bottomRight.bounds.draw(e,Q.Yellow))}}function Kp(u){return!!u._initialize}function Jp(u){return!!u.onAdd}function tg(u){return!!u.onRemove}function eg(u){return!!u.onInitialize}function ig(u){return!!u._preupdate}function sg(u){return!!u.onPreUpdate}function ng(u){return!!u.onPostUpdate}function rg(u){return!!u.onPostUpdate}function og(u){return!!u.onAdd}function ag(u){return!!u.onRemove}function hg(u){return!!u.onPreDraw}function lg(u){return!!u.onPostDraw}class cg{constructor(e,s=!1){this.path=e,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new $n(e,"arraybuffer",s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){const e=await this._resource.load();this._stream=new iu(e),this._gif=new su(this._stream);const s=this._gif.images.map(r=>new ki(r.src,!1));return await Promise.all(s.map(r=>r.load())),this.data=this._images=s,this._sprites=this._images.map(r=>r.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(e=0){var s;return(s=this._sprites[e])!==null&&s!==void 0?s:null}toSpriteSheet(){const e=this._sprites;return e.length?new Os({sprites:e}):null}toAnimation(e){var s;const r=(s=this._gif)===null||s===void 0?void 0:s.images;if(r?.length){const a=r.map((l,f)=>{var p;return{graphic:this._sprites[f],duration:((p=this._gif)===null||p===void 0?void 0:p.frames[f].delayMs)||void 0}});return this._animation=new Ai({frames:a,frameDuration:e}),this._animation}return null}get readCheckBytes(){var e,s;return(s=(e=this._gif)===null||e===void 0?void 0:e.checkBytes)!==null&&s!==void 0?s:[]}}const Io=u=>u.reduce(function(e,s){return e*2+s},0),kh=u=>{const e=[];for(let s=7;s>=0;s--)e.push(!!(u&1<<s));return e};class iu{constructor(e){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=s=>{const r=[];for(let a=0;a<s;a++)r.push(this.readByte());return r},this.read=s=>{let r="";for(let a=0;a<s;a++)r+=String.fromCharCode(this.readByte());return r},this.readUnsigned=()=>{const s=this.readBytes(2);return(s[1]<<8)+s[0]},this.data=new Uint8Array(e),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const dg=function(u,e){let s=0;const r=function(E){let D=0;for(let L=0;L<E;L++)e.charCodeAt(s>>3)&1<<(s&7)&&(D|=1<<L),s++;return D},a=[],l=1<<u,f=l+1;let p=u+1,m=[];const w=function(){m=[],p=u+1;for(let E=0;E<l;E++)m[E]=[E];m[l]=[],m[f]=null};let y=0,A=0;for(;;){if(A=y,y=r(p),y===l){w();continue}if(y===f)break;if(y<m.length)A!==l&&m.push(m[A].concat(m[y][0]));else{if(y!==m.length)throw new Error("Invalid LZW code.");m.push(m[A].concat(m[A][0]))}a.push.apply(a,m[y]),m.length===1<<p&&p<12&&p++}return a};class su{constructor(e){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=s=>{const r=[];for(let a=0;a<s;a++){const l=this._st.readBytes(3);r.push(l)}return r},this.readSubBlocks=()=>{let s,r;r="";do s=this._st.readByte(),r+=this._st.read(s);while(s!==0);return r},this.parseHeader=()=>{const s={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(s.sig=this._st.read(3),s.ver=this._st.read(3),s.sig!=="GIF")throw new Error("Not a GIF file.");s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned(),this._currentFrameCanvas.width=s.width,this._currentFrameCanvas.height=s.height;const r=kh(this._st.readByte());s.gctFlag=r.shift(),s.colorResolution=Io(r.splice(0,3)),s.sortedFlag=r.shift(),s.globalColorTableSize=Io(r.splice(0,3)),s.backgroundColorIndex=this._st.readByte(),s.pixelAspectRatio=this._st.readByte(),s.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<s.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(s)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=s=>{const r=m=>{this.checkBytes.push(this._st.readByte());const w=kh(this._st.readByte());return m.reserved=w.splice(0,3),m.disposalMethod=Io(w.splice(0,3)),m.userInputFlag=w.shift(),m.transparentColorFlag=w.shift(),m.delayTime=this._st.readUnsigned(),m.transparentColorIndex=this._st.readByte(),m.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(m)&&this.checkBytes.push(this._handler.gce),m},a=m=>{m.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(m)&&this.checkBytes.push(this._handler.com)},l=m=>{this.checkBytes.push(this._st.readByte()),m.ptHeader=this._st.readBytes(12),m.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(m)&&this.checkBytes.push(this._handler.pte)},f=m=>{const w=A=>{this.checkBytes.push(this._st.readByte()),A.unknown=this._st.readByte(),A.iterations=this._st.readUnsigned(),A.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(A)&&this.checkBytes.push(this._handler.app)},y=A=>{A.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[A.identifier]&&this._handler.app[A.identifier](A)&&this.checkBytes.push(this._handler.app[A.identifier])};switch(this.checkBytes.push(this._st.readByte()),m.identifier=this._st.read(8),m.authCode=this._st.read(3),m.identifier){case"NETSCAPE":w(m);break;default:y(m);break}},p=m=>{m.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(m)&&this.checkBytes.push(this._handler.unknown)};switch(s.label=this._st.readByte(),s.label){case 249:s.extType="gce",this._gce=r(s);break;case 254:s.extType="com",a(s);break;case 1:s.extType="pte",l(s);break;case 255:s.extType="app",f(s);break;default:s.extType="unknown",p(s);break}},this.parseImg=s=>{var r;const a=(p,m)=>{const w=new Array(p.length),y=p.length/m,A=(O,q)=>{const H=p.slice(q*m,(q+1)*m);w.splice.apply(w,[O*m,m].concat(H))},E=[0,4,2,1],D=[8,8,4,2];let L=0;for(let O=0;O<4;O++)for(let q=E[O];q<y;q+=D[O])A(q,L),L++;return w};s.leftPos=this._st.readUnsigned(),s.topPos=this._st.readUnsigned(),s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned();const l=kh(this._st.readByte());s.lctFlag=l.shift(),s.interlaced=l.shift(),s.sorted=l.shift(),s.reserved=l.splice(0,2),s.lctSize=Io(l.splice(0,3)),s.lctFlag&&(s.lctBytes=this.parseColorTableBytes(1<<s.lctSize+1)),s.lzwMinCodeSize=this._st.readByte();const f=this.readSubBlocks();s.pixels=dg(s.lzwMinCodeSize,f),s.interlaced&&(s.pixels=a(s.pixels,s.width)),!((r=this._gce)===null||r===void 0)&&r.delayTime&&(s.delayMs=this._gce.delayTime*10),this.frames.push(s),this.arrayToImage(s,s.lctFlag?s.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(s)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const s={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(s.sentinel)){case"!":s.type="ext",this.parseExt(s);break;case",":s.type="img",this.parseImg(s);break;case";":s.type="eof",this._handler.eof&&this._handler.eof(s)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+s.sentinel.toString(16))}s.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(s,r)=>{var a,l,f,p;const m=document.createElement("canvas");m.width=s.width,m.height=s.height;const w=m.getContext("2d"),y=w.getImageData(0,0,m.width,m.height);let A=-1;!((a=this._gce)===null||a===void 0)&&a.transparentColorFlag&&(A=this._gce.transparentColorIndex);for(let D=0;D<s.pixels.length;D++){const L=s.pixels[D],O=r[L];L===A?y.data.set([0,0,0,0],D*4):y.data.set([...O,255],D*4)}if(w.putImageData(y,0,0),((l=this._gce)===null||l===void 0?void 0:l.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((f=this._gce)===null||f===void 0?void 0:f.disposalMethod)===2&&(!((p=this._hdr)===null||p===void 0)&&p.gctFlag)){const D=r[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${D[0]}, ${D[1]}, ${D[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(m,s.leftPos,s.topPos,s.width,s.height);const E=new Image;E.src=this._currentFrameCanvas.toDataURL(),this.images.push(E)},this._st=e,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class ug{constructor(e,s,{bustCache:r,...a}={}){this.path=e,this.family=s,this._isLoaded=!1,this._resource=new $n(e,"blob",r),this._options=a}async load(){if(this.isLoaded())return this.data;try{const e=await this._resource.load(),s=URL.createObjectURL(e);this.data||(this.data=new FontFace(this.family,`url(${s})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(e){throw`Error loading FontSource from path '${this.path}' with error [${e.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(e){return new Ws({family:this.family,...this._options,...e})}}const nu=Kd(),fg=/^\s*(?:function)?\*/;function ru(u){return typeof u!="function"?!1:fg.test(Function.prototype.toString.call(u))?!0:Object.getPrototypeOf?Object.getPrototypeOf(u)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function ou(...u){var e;const s=ot.getInstance();let r,a,l,f;ru(u[0])&&(a=globalThis,r=u[0],l=u[1]),ru(u[1])&&(a=u[0],r=u[1],l=u[2]),u[1]instanceof ti&&(a=u[0],f=u[1],r=u[2],l=u[3]),u[0]instanceof ti&&(a=globalThis,f=u[0],r=u[1],l=u[2]);const p=Jd(nu),m=l?.timing,w=p?!1:(e=l?.autostart)!==null&&e!==void 0?e:!0;let y;try{y=f??ti.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let A=!1,E=!1,D=!1;const L=r.bind(a),O=L();let q;const H=new Promise(($,Y)=>{q=J=>{try{if(D){E=!0,$();return}const{done:rt,value:Z}=nu.scope(!0,()=>O.next(J));if(rt||D){E=!0,$();return}Z instanceof Promise?Z.then(()=>{y.clock.schedule(q,0,m)}):Z===void 0||Z===void 0?y.clock.schedule(q,0,m):y.clock.schedule(q,Z||0,m)}catch(rt){Y(rt);return}},w&&(A=!0,q(y.clock.elapsed()))}),N={isRunning:()=>A&&!D&&!E,isComplete:()=>E,cancel:()=>{D=!0},start:()=>(A?s.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(L)):(A=!0,q(y.clock.elapsed())),N),generator:O,done:H,then:H.then.bind(H),[Symbol.iterator]:()=>O};return N}class Ro extends Ue{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(e){var s,r,a,l;super(),this._logger=ot.getInstance(),this.transform=new et,this.graphics=new te,this._completeFuture=new T,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=e.duration,this.easing=(s=e.easing)!==null&&s!==void 0?s:Ot.Linear,this.direction=(r=e.direction)!==null&&r!==void 0?r:"out",this.hideLoader=(a=e.hideLoader)!==null&&a!==void 0?a:!1,this.blockInput=(l=e.blockInput)!==null&&l!==void 0?l:!1,this.transform.coordPlane=Ie.Screen,this.transform.pos=B.Zero,this.transform.z=1/0,this.graphics.anchor=B.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(e,s){this.complete||(this._currentDistance+=j(s/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=j(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=j(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(e){}onStart(e){}onUpdate(e){}onEnd(e){}onReset(){}reset(){this.started=!1,this._completeFuture=new T,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(e,s){const r=s;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),r.world.entityManager.getById(this.id))return this._co;this._engine=e,r.add(this);const a=this;return this._co=ou(e,function*(){for(;!a.complete;){const l=yield;a.updateTransition(a._engine,l),a._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class _g extends Ro{constructor(e){var s,r;super({...e,duration:(s=e.duration)!==null&&s!==void 0?s:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(r=e.color)!==null&&r!==void 0?r:Q.Black}onInitialize(e){this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=new hr({width:e.screen.resolution.width,height:e.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=e}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class pg extends Ro{constructor(e){super({direction:"in",...e}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(e){this.image=await e.engine.screenshot(!0),await this.image.decode()}onInitialize(e){this.engine=e,this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=ki.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=z(1/e.screen.pixelRatio,1/e.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class gg extends Ro{constructor(e){var s;super({direction:"in",...e}),this._easing=Ot.Linear,this.name=`Slide#${this.id}`,this.slideDirection=e.slideDirection,this.transform.coordPlane=Ie.World,this.graphics.forceOnScreen=!0,this._easing=(s=e.easingFunction)!==null&&s!==void 0?s:this._easing,this._vectorEasing=Ot.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(e){this._image=await e.engine.screenshot(!0),await this._image.decode(),this._screenCover=ki.fromHtmlImageElement(this._image).toSprite()}onInitialize(e){switch(this._engine=e,this.slideDirection){case"up":{this._directionOffset=z(0,-e.screen.resolution.height);break}case"down":{this._directionOffset=z(0,e.screen.resolution.height);break}case"left":{this._directionOffset=z(-e.screen.resolution.width,0);break}case"right":{this._directionOffset=z(e.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=z(1/e.screen.pixelRatio,1/e.screen.pixelRatio)}onUpdate(e){this._camera.pos=this._vectorEasing(e,this._destinationCameraPosition,this._startCameraPosition,1)}}class Lh extends Kt{constructor(e){super(),this.color=Q.Black,this.thickness=1;const{start:s,end:r,color:a,thickness:l}=e;this.start=s,this.end=r,this.color=a??this.color,this.thickness=l??this.thickness,this._localBounds=this._calculateBounds();const{width:f,height:p}=this._localBounds;this.width=f,this.height=p}get localBounds(){return this._localBounds}_calculateBounds(){const e=this.end.sub(this.start).normal(),s=this.thickness/2,r=[this.start.add(e.scale(s)),this.end.add(e.scale(s)),this.end.add(e.scale(-s)),this.start.add(e.scale(-s))];return at.fromPoints(r)}_drawImage(e,s,r){e.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new Lh({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class Uh extends bn{get points(){return this._points}set points(e){this._points=e;const s=this.minPoint;this.width=this._points.reduce((r,a)=>Math.max(a.x,r),0)-s.x,this.height=this._points.reduce((r,a)=>Math.max(a.y,r),0)-s.y,this.flagDirty()}get minPoint(){const e=this._points.reduce((r,a)=>Math.min(a.x,r),1/0),s=this._points.reduce((r,a)=>Math.min(a.y,r),1/0);return z(e,s)}constructor(e){super(e),this._points=[],this.points=e.points,this.filtering=ce.Blended,this.rasterize()}clone(){return new Uh({points:this.points.map(e=>e.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){if(this.points&&this.points.length){e.beginPath();const s=this.minPoint.negate(),r=this.points[0].add(s);e.moveTo(r.x,r.y),this.points.forEach(a=>{e.lineTo(a.x+s.x,a.y+s.y)}),e.lineTo(r.x,r.y),e.closePath(),this.color&&e.fill(),this.strokeColor&&e.stroke()}}}var ls;(function(u){u.Stretch="stretch",u.Tile="tile",u.TileFit="tile-fit"})(ls||(ls={}));class zh extends Kt{constructor(e){super(e),this._logger=ot.getInstance(),this._config=e,this._imgSource=e.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(e,s=!1){this._config.width=e,s&&this._initialize()}setTargetHeight(e,s=!1){this._config.height=e,s&&this._initialize()}setMargins(e,s,r,a,l=!1){this._config.sourceConfig.leftMargin=e,this._config.sourceConfig.topMargin=s,this._config.sourceConfig.rightMargin=r,this._config.sourceConfig.bottomMargin=a,l&&this._initialize()}setStretch(e,s,r=!1){e==="horizontal"?this._config.destinationConfig.horizontalStretch=s:e==="vertical"?this._config.destinationConfig.verticalStretch=s:(this._config.destinationConfig.horizontalStretch=s,this._config.destinationConfig.verticalStretch=s),r&&this._initialize()}getConfig(){return this._config}_drawTile(e,s,r,a,l,f,p){const m=f||0,w=p||0;let y,A,E,D;const L=this._getNumberOfTiles(s.width,r.x,a),O=this._getNumberOfTiles(s.height,r.y,l);for(let q=0;q<L;q++)for(let H=0;H<O;H++){let{tempSize:N,tempPosition:$}=this._calculateParams(q,L,s.width,r.x,this._config.destinationConfig.horizontalStretch);y=N,A=$,{tempSize:N,tempPosition:$}=this._calculateParams(H,O,s.height,r.y,this._config.destinationConfig.verticalStretch),E=N,D=$,e.drawImage(s,0,0,s.width,s.height,m+A,w+D,y,E)}}_drawImage(e,s,r){this._imgSource.isLoaded()?(this._drawTile(e,this._canvasA,new B(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(e,this._canvasB,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(e,this._canvasC,new B(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(e,this._canvasD,new B(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(e,this._canvasE,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasF,new B(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasG,new B(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasH,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasI,new B(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const e=this._canvasA.getContext("2d");e?.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const s=this._canvasB.getContext("2d");s?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const r=this._canvasC.getContext("2d");r?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const a=this._canvasD.getContext("2d");a?.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const l=this._canvasE.getContext("2d");l?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const f=this._canvasF.getContext("2d");f?.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const p=this._canvasG.getContext("2d");p?.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const m=this._canvasH.getContext("2d");m?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const w=this._canvasI.getContext("2d");w?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new zh(this._config)}_getNumberOfTiles(e,s,r){switch(r){case ls.Stretch:return 1;case ls.Tile:return Math.ceil(s/e);case ls.TileFit:return Math.ceil(s/e)}}_calculateParams(e,s,r,a,l){switch(l){case ls.Stretch:return{tempPosition:0,tempSize:a};case ls.Tile:return e===s-1?{tempPosition:e*r,tempSize:r-(s*r-a)}:{tempPosition:e*r,tempSize:r};case ls.TileFit:const f=a/s;return{tempPosition:e*f,tempSize:f}}}}class Hh extends Ai{constructor(e){super({...e,frames:e.animation.frames.slice(),strategy:e.animation.strategy,frameDuration:e.animation.frameDuration,speed:e.animation.speed,reverse:e.animation.isReversed}),this._ready=new T,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...e.sourceView},this._tiledWidth=e.width,this._tiledHeight=e.height;const s=[];for(let r=0;r<this.frames.length;r++){const a=this.frames[r].graphic;if(a&&a instanceof xi){const l=new Kn({image:a.image,width:e.width,height:e.height,sourceView:{...a.sourceView},wrapping:e.wrapping,filtering:e.filtering});this.frames[r].graphic=l,l.ready.then(()=>{l.sourceView={...l.sourceView,...this._sourceView}}),s.push(l.ready)}}Promise.all(s).then(()=>this._ready.resolve())}static fromAnimation(e,s){return new Hh({width:e.width,height:e.height,...s,animation:e})}_updateSourceView(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof xi&&(s.sourceView={...s.sourceView,...this._sourceView})}}get sourceView(){return wi(this._sourceView,()=>this._updateSourceView())}set sourceView(e){this._sourceView=wi(e,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof xi&&(s.sourceView.height=this._tiledHeight||s.height,s.destSize.height=this._tiledHeight||s.height,s.sourceView.width=this._tiledWidth||s.width,s.destSize.width=this._tiledWidth||s.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(e){this._tiledWidth=e,this._updateWidthHeight()}set height(e){this._tiledHeight=e,this._updateWidthHeight()}}const au=5,Dn={},mg=()=>{for(const u in Dn)Dn[u]=0},Do=(u,e)=>{const s=b.isEnabled("suppress-obsolete-message");Dn[u]<au&&!s&&(ot.getInstance().warn(u),console.trace&&e.showStackTrace&&console.trace()),Dn[u]++};function vg(u){return u={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...u},function(e,s,r){if(r&&!(typeof r.value=="function"||typeof r.get=="function"||typeof r.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const l=`${`${e.name||""}${e.name&&s?".":""}${s||""}`} is marked obsolete: ${u.message}`+(u.alternateMethod?` Use ${u.alternateMethod} instead`:"");Dn[l]||(Dn[l]=0);const f=r?{...r}:e;if(!r){class p extends f{constructor(...w){Do(l,u),super(...w)}}return p}return r&&r.value?(f.value=function(){return Do(l,u),r.value.apply(this,arguments)},f):(r&&r.get&&(f.get=function(){return Do(l,u),r.get.apply(this,arguments)}),r&&r.set&&(f.set=function(){return Do(l,u),r.set.apply(this,arguments)}),f)}}class wg{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const e=new T;return this._queue.push(e),e.promise}dequeue(e){this._queue.shift().resolve(e)}}class xg{constructor(e){this._count=e,this._waitQueue=new wg}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(e=1){if(e!==0){for(;e!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),e--;this._count+=e}}}const Oh="0.30.3";return x(),h})())}(Yh)),Yh.exports}/*! For license information please see excalibur-perlin.min.js.LICENSE.txt */var Pu;function bw(){return Pu||(Pu=1,function(d,t){(function(i,n){d.exports=n(xw())})(self,i=>(()=>{var n={"./src/perlin-noise.ts":(_,g,v)=>{v.r(g),v.d(g,{PerlinDrawer2D:()=>I,PerlinGenerator:()=>T});var x=v("excalibur");function b(F,R,S){return R+F*(S-R)}function P(F){return F*F*F*(F*(6*F-15)+10)}class T{constructor(R){var S,M,W,U;this._perm=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],this._p=new Uint8Array(512),this._defaultPerlinOptions={octaves:1,frequency:1,amplitude:1,persistance:.5},this.persistance=.5,this.amplitude=1,this.frequency=1,this.octaves=1,R={...this._defaultPerlinOptions,...R},this.persistance=(S=R.persistance)!==null&&S!==void 0?S:this.persistance,this.amplitude=(M=R.amplitude)!==null&&M!==void 0?M:this.amplitude,this.frequency=(W=R.frequency)!==null&&W!==void 0?W:this.frequency,this.octaves=(U=R.octaves)!==null&&U!==void 0?U:this.octaves,R.seed?this._random=new x.Random(R.seed):this._random=new x.Random,this._perm=this._random.shuffle(this._perm);for(let V=0;V<512;V++)this._p[V]=255&this._perm[V%256]}noise(){let R=this.amplitude,S=this.frequency,M=0,W=0;for(let U=0;U<this.octaves;U++){switch(arguments.length){case 1:M+=this._noise1d(arguments[0]*S)*R;break;case 2:M+=this._noise2d(arguments[0]*S,arguments[1]*S)*R;break;case 3:M+=this._noise3d(arguments[0]*S,arguments[1]*S,arguments[2]*S)*R;break;default:throw new Error("Invalid arguments for perlin noise")}W+=R,R*=this.persistance,S*=2}return M/W}sequence(R,S){S||(S=1/R);const M=new Array(R);for(let W=0;W<R;W++)M[W]=this.noise(W*S);return M}grid(R,S,M){M||(M=1/Math.min(R,S));const W=new Array(R*S);for(let U=0;U<S;U++)for(let V=0;V<R;V++)W[V+U*R]=this.noise(V*M,U*M);return W}_gradient3d(R,S,M,W){const U=15&R,V=U<8?S:M,j=U<4?M:U===12||U===14?S:W;return((1&U)==0?V:-V)+((2&U)==0?j:-j)}_gradient2d(R,S,M){const W=(1&R)==0?S:M;return(2&R)==0?-W:W}_gradient1d(R,S){return(1&R)==0?-S:S}_noise1d(R){const S=255&Math.floor(R);return(b(P(R-=Math.floor(R)),this._gradient1d(this._p[S],R),this._gradient1d(this._p[S+1],R-1))+1)/2}_noise2d(R,S){const M=255&Math.floor(R),W=255&Math.floor(S);R-=Math.floor(R),S-=Math.floor(S);const U=P(R),V=P(S),j=this._p[M]+W,X=this._p[M+1]+W;return(b(V,b(U,this._gradient2d(this._p[j],R,S),this._gradient2d(this._p[X],R-1,S)),b(U,this._gradient2d(this._p[j+1],R,S-1),this._gradient2d(this._p[X+1],R-1,S-1)))+1)/2}_noise3d(R,S,M){const W=255&Math.floor(R),U=255&Math.floor(S),V=255&Math.floor(M);R-=Math.floor(R),S-=Math.floor(S),M-=Math.floor(M);const j=P(R),X=P(S),nt=P(M),ht=this._p[W]+U,wt=this._p[W+1]+U,gt=this._p[ht]+V,At=this._p[wt]+V,Et=this._p[ht+1]+V,B=this._p[wt+1]+V;return(b(nt,b(X,b(j,this._gradient3d(this._p[gt],R,S,M),this._gradient3d(this._p[At],R-1,S,M)),b(j,this._gradient3d(this._p[Et],R,S-1,M),this._gradient3d(this._p[B],R-1,S-1,M))),b(X,b(j,this._gradient3d(this._p[gt+1],R,S,M-1),this._gradient3d(this._p[At+1],R-1,S,M-1)),b(j,this._gradient3d(this._p[Et+1],R,S-1,M-1),this._gradient3d(this._p[B+1],R-1,S-1,M-1))))+1)/2}}class I{constructor(R,S){this.generator=R,this.colorFcn=M=>M<.5?x.Color.Black:x.Color.White,S&&(this.colorFcn=S)}image(R,S){const M=document.createElement("img"),W=document.createElement("canvas");W.width=R,W.height=S;const U=W.getContext("2d");return this.draw(U,0,0,R,S),M.src=W.toDataURL(),M}draw(R,S,M,W,U){const V=this.generator.grid(W,U),j=R.getImageData(S,M,W,U);for(let X=0;X<U;X++)for(let nt=0;nt<W;nt++){const ht=4*(nt+X*j.width),wt=V[nt+W*X],gt=this.colorFcn(wt);j.data[ht]=gt.r,j.data[ht+1]=gt.g,j.data[ht+2]=gt.b,j.data[ht+3]=Math.floor(255*gt.a)}R.putImageData(j,S,M)}}},excalibur:_=>{_.exports=i}},o={};function h(_){var g=o[_];if(g!==void 0)return g.exports;var v=o[_]={exports:{}};return n[_](v,v.exports,h),v.exports}h.n=_=>{var g=_&&_.__esModule?()=>_.default:()=>_;return h.d(g,{a:g}),g},h.d=(_,g)=>{for(var v in g)h.o(g,v)&&!h.o(_,v)&&Object.defineProperty(_,v,{enumerable:!0,get:g[v]})},h.o=(_,g)=>Object.prototype.hasOwnProperty.call(_,g),h.r=_=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(_,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(_,"__esModule",{value:!0})};var c={};return(()=>{h.r(c),h.d(c,{PerlinDrawer2D:()=>_.PerlinDrawer2D,PerlinGenerator:()=>_.PerlinGenerator});var _=h("./src/perlin-noise.ts")})(),c})())}(qh)),qh.exports}var yw=bw();const Aw=new yw.PerlinGenerator({seed:Date.now(),octaves:3,frequency:24,amplitude:.91,persistance:.95}),Ds=new Tv({pos:yt(0,0),tileWidth:64,tileHeight:32,columns:25,rows:25});let Cw=[Gi.getSprite(0,0),Gi.getSprite(1,0),Gi.getSprite(2,0),Gi.getSprite(3,0),Gi.getSprite(4,0),Gi.getSprite(5,0),Gi.getSprite(6,0),Gi.getSprite(0,1),Gi.getSprite(1,1),Gi.getSprite(2,1)],jh=0;for(const d of Ds.tiles){if(T_(jh,Ds.columns,Ds.rows)){if(d.x==0){let t=new Fn({useAnchor:!0,members:[{graphic:ko.getSprite(0,0),offset:yt(0,16)},{graphic:xe.tree.toSprite(),offset:yt(-6,-24)}]});d.addGraphic(t)}else if(d.y==0&&d.x!=0||d.y==Ds.rows-1&&d.x!=0){const t=xe.fence.toSprite();let i=new Fn({useAnchor:!0,members:[{graphic:ko.getSprite(0,0),offset:yt(0,-32)},{graphic:t,offset:yt(0,-32)}]});d.addGraphic(i)}else{let t=new Fn({useAnchor:!0,members:[{graphic:ko.getSprite(0,0),offset:yt(0,-32)}]});d.addGraphic(t)}d.solid=!0,d.addCollider(Iv.Polygon([yt(0,17),yt(32,1),yt(63,17),yt(32,33)]))}else{let t=ko.getSprite(0,0);const n=Aw.grid(Ds.columns,Ds.rows)[jh];let o=new Zn;if(n>.55){const h=o.pickOne(Cw);let c=o.integer(16,32),_=-32,g=new Fn({useAnchor:!0,members:[{graphic:t,offset:yt(0,-32)},{graphic:h,offset:yt(c,_)}]});d.addGraphic(g)}else{let h=new Fn({useAnchor:!0,members:[{graphic:t,offset:yt(0,-32)}]});d.addGraphic(h)}}jh++}Ds.updateColliders();class Pw extends xs{buttonText;upGraphic;downGraphic;constructor(t){super({width:192,height:64,pos:t}),this.buttonText=new ln({text:"START",pos:yt(192/2,16),font:new hn({width:192,height:64,family:"Arial",size:36,color:jt.White,textAlign:cn.Center})}),this.addChild(this.buttonText),this.upGraphic=xe.buttonUp.toSprite(),this.downGraphic=xe.buttonDown.toSprite()}onInitialize(t){this.graphics.use(this.upGraphic),this.on("pointerup",()=>{this.graphics.use(this.upGraphic),t.goToScene("game"),this.buttonText.pos=this.buttonText.pos.add(yt(0,-4))}),this.on("pointerdown",()=>{this.graphics.use(this.downGraphic),this.buttonText.pos=this.buttonText.pos.add(yt(0,4))})}}class Tw extends xs{buttonText;upGraphic;downGraphic;engine;constructor(t){super({width:192,height:64,pos:t,z:2001,color:jt.Transparent}),this.buttonText=new ln({text:"Next Wave",pos:yt(192/2,16),font:new hn({width:192,height:64,family:"Arial",size:24,color:jt.White,textAlign:cn.Center})}),this.addChild(this.buttonText),this.upGraphic=xe.buttonUp.toSprite(),this.downGraphic=xe.buttonDown.toSprite()}onInitialize(t){this.engine=t}onAdd(t){this.graphics.use(this.upGraphic),window.addEventListener("pointerup",this.upClick),window.addEventListener("pointerdown",this.downClick)}downClick=t=>{this.graphics.use(this.downGraphic),this.buttonText.pos=this.buttonText.pos.add(yt(0,4))};upClick=t=>{this.graphics.use(this.upGraphic),this.buttonText.pos=this.buttonText.pos.add(yt(0,-4)),this.engine.currentScene.hideEndOfWaveModal()}}class Sw extends xs{title;engine;constructor(t){let i=t.screen.contentArea,n=i.right-i.left-20,o=i.bottom-i.top-20,h=new ve(10,10);super({width:n,height:o,pos:h,color:jt.Black,z:2e3}),this.engine=t,this.title=new ln({width:n,height:o/4,pos:yt(0,0),text:"Wave Complete",font:new hn({family:"Arial",size:36,color:jt.White,textAlign:cn.Center})}),this.title.pos=yt(n/2,o/4),this.addChild(this.title),this.addChild(new Tw(yt(n/2-192/2,o*.55)))}show(t){t.add(this)}hide(t){t.remove(this)}onInitialize(t){}}class Ew extends __{arena;darkPlayer;lightPlayer;statusBar;burnDown;enemyWaveManager;gameState={waveNumber:0,enemiesRemaining:0,darkEnemiesDefeated:0,lightEnemiesDefeated:0,darkExp:0,lightExp:0,gameDuration:0};stateSignal=new Bi("stateUpdate");pauseGameSignal=new Bi("pauseGame");endOfWaveModal;constructor(){super()}onActivate(t){this.arena=Ds,this.add(this.arena),this.darkPlayer=new P_,this.add(this.darkPlayer),this.darkPlayer.pos=lw(this.arena),this.lightPlayer=new A_,this.add(this.lightPlayer),this.darkPlayer.registerPartner(this.lightPlayer),this.lightPlayer.registerPartner(this.darkPlayer),this.enemyWaveManager=new mw(this,this.lightPlayer,this.darkPlayer,this.arena),this.enemyWaveManager?.init();const i=this.engine.screen.contentArea.width,n=this.engine.screen.contentArea.height;this.statusBar=new vw(yt(i,n)),this.add(this.statusBar),this.stateSignal.listen(this.stateUpdate.bind(this)),this.burnDown=new ww(yt(i,10),yt(0,n-12),60,this),this.add(this.burnDown),this.endOfWaveModal=new Sw(t.engine),this.enemyWaveManager?.startWave()}onDeactivate(t){this.darkPlayer?.kill(),this.lightPlayer?.kill(),this.enemyWaveManager?.endWave()}onPreUpdate(t,i){this.enemyWaveManager?.update(i)}stateUpdate(t){const[i,n]=t.detail.params;this.gameState[i]=n}showEndOfWaveModal(){this.endOfWaveModal?.show(this)}hideEndOfWaveModal(){this.endOfWaveModal?.hide(this),this.enemyWaveManager?.startWave()}switchPlayerFocus(){this.darkPlayer?.isPlayerActive&&!this.lightPlayer?.isPlayerActive?(this.darkPlayer.isPlayerActive=!1,this.lightPlayer.isPlayerActive=!0,this.camera.strategy.lockToActor(this.lightPlayer)):(this.darkPlayer.isPlayerActive=!0,this.lightPlayer.isPlayerActive=!1,this.camera.strategy.lockToActor(this.darkPlayer))}}class Iw extends xs{title;constructor(t){let i=t.right-t.left-20,n=t.bottom-t.top-20,o=new ve(10,10);super({width:i,height:n,pos:o,color:jt.fromHex("#005465")}),this.title=new ln({width:i,height:n/4,pos:yt(0,0),text:"Angels 'n Demons",font:new hn({family:"Arial",size:36,color:jt.White,textAlign:cn.Center})}),this.title.pos=yt(i/2,n/4),this.addChild(this.title),this.addChild(new Pw(yt(i/2-192/2,n*.55)))}onInitialize(t){}}class Rw extends __{starintModal;constructor(){super()}onActivate(t){this.starintModal=new Iw(t.engine.screen.contentArea),this.add(this.starintModal)}onDeactivate(t){}}await xt.create(document.body,Dv,Mv).attached;const S_=new Pv({resolution:{width:640,height:360},viewport:{width:640,height:360},canvasElementId:"cnv",displayMode:Cv.FitScreenAndZoom,pixelArt:!0,scenes:{intro:{scene:new Rw},game:{scene:new Ew}},pixelRatio:2});await S_.start(C_);S_.goToScene("intro");
