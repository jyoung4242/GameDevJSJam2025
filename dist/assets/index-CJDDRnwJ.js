(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const h of o)if(h.type==="childList")for(const c of h.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function i(o){const h={};return o.integrity&&(h.integrity=o.integrity),o.referrerPolicy&&(h.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?h.credentials="include":o.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function n(o){if(o.ep)return;o.ep=!0;const h=i(o);fetch(o.href,h)}})();class Ss{constructor(){this.state="created",this.host=null,this.bindings=[],this.views=[],this.animations=[],this.animationQueue=[],this.destroyed="",this.moved=""}static create(t,i={},n,o={parent:null,prepare:!0,sibling:null}){const h=new Ss;if(h.model=i,h.element=n??t,h.parent=o.parent??bt,h.host=o.host??h.parent.host,h.sibling=o.sibling??null,n instanceof HTMLTemplateElement||n?.tagName==="TEMPLATE"){const c=n.content.cloneNode(!0);if(c.children.length===1)return bt.create(t,i,c.firstElementChild,o);h.views=[...c.children].map(_=>bt.create(t,i,_,{...o,parent:h})),h.state="rendered"}else h.bindings.push(...bt.parse(h.element,i,h,o.parent));return h.parentElement=n!=null?t:t.ownerDocument.documentElement,h.views.length>1?(h.attached=Promise.all(h.views.map(c=>c.attached)),h.detached=Promise.all(h.views.map(c=>c.detached))):(h.attached=new Promise(c=>{h.t=c}),h.detached=new Promise(c=>{h.i=c})),h}get lastElement(){return this.render==null&&(this.render=!(this.element.hasAttribute?.("PUI-UNRENDERED")??!1)),this.render?this.element:this.bindings.flatMap(n=>n.views).slice(-1)[0]?.lastElement}destroy(){this.views.forEach(t=>t.destroy()),this.element.classList?.add("pui-removing"),this.destroyed="queue",bt.destroyed.push(this)}terminate(){Promise.all(this.getAnimations()).then(()=>{const t=this.element.parentElement;t?.removeChild(this.element),this.i?.(),this.dispatchEvent(t,"removed"),this.bindings.forEach(n=>n.unbind());const i=this.parent.views.findIndex(n=>n===this);i>-1&&this.parent.views.splice(i,1)}),this.destroyed="destroyed"}move(t){this.moved="queue",this.element.classList?.add("pui-moving"),this.sibling=t}play(t,i){return typeof t=="string"&&(t=this.animations.find(n=>n.name===t).clone()),t.element=i,t.state="pending",this.animationQueue.push(t),this.updateAnimations(performance.now()),t}updateFromUI(){this.views.forEach(t=>t.updateFromUI()),this.bindings.forEach(t=>t.updateFromUI())}updateToUI(){const t=this.state==="created";switch(t||(this.views.forEach(i=>i.updateToUI()),this.bindings.forEach(i=>i.updateToUI())),this.state){case"created":if(this.element.classList?.add("pui-adding"),this.render=!(this.element.hasAttribute?.("PUI-UNRENDERED")??!1),this.render){const i=this.parent?.parent;let o=(i?.render??!1?this.sibling:i?.sibling)??null;o=(o instanceof Ss?o.lastElement:o)??null;const h=this.parentElement??bt.parentElement(this.element,this.parent);h.insertBefore(this.element,o?.nextSibling??null),this.dispatchEvent(h,"added")}this.t(),this.state="attaching";break;case"attaching":this.getAnimations(!1).length===0&&(this.element.classList?.remove("pui-adding"),this.state="attached");break;case"attached":this.state="rendered";break}t&&(this.views.forEach(i=>i.updateToUI()),this.bindings.forEach(i=>i.updateToUI()))}updateAtEvents(){this.views.forEach(t=>t.updateAtEvents()),this.bindings.forEach(t=>t.updateAtEvents())}updateAnimations(t){for(;this.animationQueue[0]?.state==="finished";)this.animationQueue.shift().destroy();for(let i=0;i<this.animationQueue.length;i++){const n=this.animationQueue[i];n.state==="pending"&&(n.isBlocked(t)||(n.state="playing",n.startTime=t,n.animation=n.element.animate(n.keyframes,n.options),n.finished=n.animation.finished,n.finished.then(()=>{n.state="finished",this.updateAnimations(performance.now())})))}}updateMove(){switch(this.moved){case"queue":this.moved="move";break;case"move":if(this.getAnimations().length===0){const t=this.parentElement??bt.parentElement(this.element,this.parent);let i=(this.sibling instanceof Ss?this.sibling.lastElement:this.sibling)??null;if(this.render)t.insertBefore(this.element,i?.nextSibling??null);else{const n=this.bindings.flatMap(o=>o.views);for(const o of n)t.insertBefore(o.element,i?.nextSibling??null),i=o.element}this.element.classList?.remove("pui-moving"),this.moved="",this.sibling=null}break}this.bindings.forEach(t=>t.updateMove()),this.views.forEach(t=>t.updateMove())}getAnimations(t=!0){return(this.element.getAnimations?.({subtree:t})??[]).filter(i=>i.playState!=="finished"&&i.effect?.getTiming().iterations!==1/0).map(i=>i.finished)}dispatchEvent(t,i){if(t!=null){const n=new CustomEvent(`pui-${i}`,{detail:{model:this.model.$model??this.model,context:this.model,element:this.element,view:this},bubbles:!0,cancelable:!0});t.dispatchEvent(n)}}}class Gl{constructor(){this.fromUI=!1,this.toUI=!0,this.atEvent=!1,this.oneTime=!1,this.views=[],this.firstUpdate=!0,this.events=[],this.triggerAtEvent=t=>{t.type==="change"?this.events.push(t):bt.resolveValue(this.object,this.property).call(this.object.$model,t,this.object.$model,this.element,this.attribute,this.object)},this.twoWayBindingEvent=t=>{const{target:i,property:n}=bt.resolveProperty(this.object,this.property),o=t.detail;if(o!==this.lastUIValue){let h=o;h!==void 0&&h!==this.lastValue&&bt.resolveValue(this.object,this.property)==="number"&&!isNaN(h)&&(h=+h),i[n]=h}},this.id=++bt.id}get element(){return this.$element==null&&(this.$element=typeof this.selector=="string"?this.context.querySelector(this.selector):this.selector),this.$element}set element(t){this.$element=t}static create(t){const i=new Gl,n=t.property?.split(":")??[],o=n.shift(),h=typeof t.attribute!="boolean"?(t.attribute??"innerText").split(":"):[],c=typeof t.attribute!="boolean"?h.shift():t.attribute;if(i.parent=t.parent??bt,i.object="$model"in t.object?t.object:{$model:t.object},i.object.$parent==null){const _=i.parent.parent?.object?.$parent;_!=null&&(i.object.$parent=_)}return i.property=o,i.propertyArguments=n,i.context=t.context??document,i.selector=t.selector,i.attribute=c,i.attributeArguments=h,i.value=t.value??i.value,i.template=t.template??i.template,i.fromUI=t.fromUI??i.fromUI,i.toUI=t.toUI??i.toUI,i.atEvent=t.atEvent??i.atEvent,i.oneTime=t.oneTime??i.oneTime,i.addListener(),typeof i.fromUI!="boolean"&&(i.fromUI=i.fromUI.bind(i)),typeof i.toUI!="boolean"&&(i.toUI=i.toUI.bind(i)),i}destroy(){this.element=null,this.removeListener(),this.views.forEach(t=>t.destroy())}unbind(){bt.unbind(this)}addListener(){this.atEvent&&(this.toUI=!1,this.fromUI=!1,this.element.addEventListener(this.attribute,this.triggerAtEvent)),this.toUI&&this.fromUI&&customElements.get(this.element.tagName.toLowerCase())!=null&&this.element.addEventListener(this.attribute,this.twoWayBindingEvent)}removeListener(){this.atEvent&&this.element.removeEventListener(this.attribute,this.triggerAtEvent),this.toUI&&this.fromUI&&customElements.get(this.element.tagName.toLowerCase())!=null&&this.element.removeEventListener(this.attribute,this.twoWayBindingEvent)}updateFromUI(){if(this.fromUI===!1||this.firstUpdate){this.firstUpdate=!1,this.views.forEach(o=>o.updateFromUI());return}const{target:t,property:i}=bt.resolveProperty(this.element,this.attribute),n=t[i];if(n!==this.lastUIValue){let o=this.fromUI!==!0?this.fromUI(n,this.lastUIValue,this.property,this.object):n;if(this.lastUIValue=n,o!==void 0&&o!==this.lastValue){this.lastValue=o;const{target:h,property:c}=bt.resolveProperty(this.object,this.property);bt.resolveValue(this.object,this.property)==="number"&&!isNaN(o)&&(o=+o),h[c]=o}else this.lastValue=o;this.parent.host?.dispatchEvent(new CustomEvent(i,{detail:o}))}this.views.forEach(o=>o.updateFromUI())}updateToUI(){if(this.toUI===!1){this.views.forEach(i=>i.updateToUI());return}let t=bt.resolveValue(this.object,this.property);if(this.template!=null)if(this.template instanceof HTMLElement)if(typeof this.attribute=="boolean"){if(t=(t??!1)!==!1,t!==this.lastValue){const i=this.toUI!==!0?this.toUI(t,this.lastValue,this.property,this.object,this.value):t;i!==void 0&&i!==this.lastUIValue&&(i===this.attribute?this.views.push(Ss.create(this.element.parentElement,this.object,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:this.element})):this.views.pop()?.destroy(),this.lastValue=t,this.lastUIValue=i)}}else{let i=!1,n=!1;t==null&&(t=[]);const o=this.propertyArguments[0],h=this.lastValue??[];if(t.length!==h.length)i=!0;else for(let b=0,S=t.length;b<S;b++){let P,I;o==null?t[b]!==h[b]&&(i=!0,n=!0):(P=bt.resolveValue(t[b]??{},o),I=bt.resolveValue(h[b]??{},o),P!==I&&(i=!0),t[b]!==h[b]&&(n=!0))}if(!i)if(n){const b=this.toUI!==!0?this.toUI(t,h,this.property,this.object,this.value):t;return this.updateViews(t,b)}else return this.updateViews();const c=this.toUI!==!0?this.toUI(t,h,this.property,this.object,this.value):t;if(c==null)return this.updateViews();const _=this.lastUIValue??[];let p=0;for(let b=0,S=c.length,P=0;b<S;b++,P++){let I,M;if(o==null?(I=c[b],M=_[P]):(I=bt.resolveValue(c[b]??{},o),M=bt.resolveValue(_[P]??{},o)),I===M)p++;else break}if(p===c.length&&c.length===_.length)return this.updateViews(t,c);const v=this.views.splice(0,p);let x=v[v.length-1];for(let b=p,S=c.length,P=p;b<S;b++,P++){const I=c[b],M=this.views.shift();if(M==null){const U={$model:{[this.attribute]:I},$parent:this.object},V=Ss.create(this.element.parentElement,U,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:x??this.element});v.push(V),x=V;continue}const R=o==null?I:bt.resolveValue(I??{},o),T=M?.model.$model[this.attribute],F=o==null?T:bt.resolveValue(T??{},o);if(R===F){v.push(M),M.move(x??this.element),x=M;continue}if(!c.slice(b).map(U=>o==null?U:bt.resolveValue(U??{},o)).includes(F)){M.destroy(),b--,x=M;continue}this.views.unshift(M);let W=!1;for(let U=0,V=this.views.length;U<V;U++){const j=this.views[U],X=j?.model.$model[this.attribute],rt=o==null?X:bt.resolveValue(X??{},o);if(R===rt){v.push(...this.views.splice(U,1)),j.move(x??this.element),W=!0,x=j;break}}if(!W){const U={$model:{[this.attribute]:I},$parent:this.object},V=Ss.create(this.element.parentElement,U,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:x??this.element});v.push(V),x=V}}return this.views.forEach(b=>b.destroy()),this.views=v,this.updateViews(t,c)}else{const i=bt.resolveValue(this.object,this.attribute);if((t??i)==null||(t??i)!==this.lastValue){this.lastUIValue!=null&&(this.lastUIValue.destroy(),this.lastUIValue=null);const n=t==null?i:i.create(t),o=i.template;this.lastValue=t??i;const h=this.element.nodeType===8?this.element.parentElement:this.element,c=this.element.nodeType===8?this.element:null;if(this.lastUIValue=bt.create(h,n,o,{parent:this,prepare:!0,sibling:c}),this.attributeArguments[0]!=null&&t!=null){const{target:_,property:p}=bt.resolveProperty(this.object,this.attributeArguments[0]);_[p]=this.lastUIValue}this.views.push(this.lastUIValue)}}else if(t!==this.lastValue){const i=this.toUI!==!0?this.toUI(t,this.lastValue,this.property,this.object,this.value):t;if(i!==void 0&&i!==this.lastUIValue){const{target:n,property:o}=bt.resolveProperty(this.element,this.attribute);n[o]=i,"setAttribute"in this.element&&this.element.setAttribute(this.attribute,i),this.lastValue=t,this.lastUIValue=i}}this.updateViews()}updateAtEvents(){let t=this.events.shift();for(;t!=null;)bt.resolveValue(this.object,this.property).call(this.object.$model,t,this.object.$model,this.element,this.attribute,this.object),t=this.events.shift();this.views.forEach(i=>i.updateAtEvents())}updateMove(){this.views.forEach(t=>t.updateMove())}updateViews(t,i){t==null?this.views.forEach(n=>n.updateToUI()):(this.views.forEach((n,o)=>{const h=i[o];typeof h=="object"&&(h.$index=o),n.model.$model[this.attribute]=h,n.model.$index=o,n.updateToUI()}),this.lastValue=[...t],this.lastUIValue=[...i]),this.oneTime&&(this.toUI=!1,this.fromUI=!1)}}var wl;class Le{static initialize(t=!0){if(!this.initialized&&(this.initialized=!0,this.initializeLoadPromise(),t!==!1)){if(t===!0){const i=()=>{this.update(),requestAnimationFrame(i)};requestAnimationFrame(i);return}setInterval(()=>this.update(),1e3/t)}}static import(t){this.initializeLoadPromise(),document.body.insertAdjacentHTML("afterbegin",`<object type="text/pui" data="${t}"></object>`)}static ready(){return this.initialize(),this.loadPromise.then(()=>(this.hoist()&&document.head.insertAdjacentHTML("beforeend",'<style> object[type="text/pui"] { height: 0; position: absolute; } </style>'),this.registrations))}static create(t=document.body,i={},n=null,o={parent:null,prepare:!0,sibling:null}){if(typeof t=="string"&&(t=document.querySelector(t)),(typeof i=="string"||i instanceof HTMLElement)&&(console.warn("Old parameter order to UI.create!"),[i,n]=[n,i]),typeof n=="string"){const c=t?.ownerDocument?.defaultView!=null?t.ownerDocument:document;if(n.startsWith("#"))n=c.querySelector(n).cloneNode(!0);else{const _=c.createElement("template");_.innerHTML=o.prepare?this.prepare(n):n,n=_}}const h=Ss.create(t,i,n,o);return h.parent===bt&&this.views.push(h),this.initialize(),h}static play(t,i){return typeof t=="string"?(t=this.globals.animations.find(n=>n.name===t).clone(),t.play(i)):t.play()}static queue(t){this.h.push(t),this.initialize()}static register(t,i){if(typeof t=="string"){this.registrations[t]=i;return}this.registerWebComponent(i,t)}static parse(t,i,n,o){const h=[];if(t instanceof Comment)return[];if(t instanceof HTMLTemplateElement||t.tagName==="TEMPLATE")return[];if(t.nodeType===3){let c=t.textContent,_=c.match(this.regexValue);for(;_!=null;){const p=_[1];let v=_[2];c=_[3];let x=!1;v.startsWith("|")&&(x=!0,v=v.slice(1).trimStart());const b=v.match(this.regexConditionalValue);let S,P=!0;if(v.startsWith("(")){const M=`_pui${this.bindingCounter++}`;Object.defineProperty(i,M,{get:new Function(`return ${v}`)}),v=M}else b&&(v=b[3],S=`${b[2]}${b[1]}`,P=function(M,R,T,F,W){const U=W[0]==="=";return W=W.slice(2,-1),!!M===U?W:""});let I=t.cloneNode();t.textContent=p,this.parentElement(t,o).insertBefore(I,t.nextSibling),h.push(this.bind({selector:I,attribute:"textContent",object:i,property:v,parent:n,oneTime:x,value:S,toUI:P})),t=I,I=t.cloneNode(),I.textContent=c,this.parentElement(t,o).insertBefore(I,t.nextSibling),t=I,_=c.match(this.regexValue)}}else{const c=t.getAttribute("pui")??"";if(c.trim().length>0){const _=c.split(";");for(let p of _)p=p.trim(),p.length>0&&t.setAttribute(`pui.${this.bindingCounter++}`,p)}if(t.removeAttribute("pui"),h.push(...Object.keys(t.attributes??[]).reverse().map(_=>{const p=[];if(t instanceof Comment)return[];const v=t.attributes[_];if(v.name.startsWith("pui.")){const P=v.value.match(this.regexAttribute);let[I,M,R,T,F]=P,W,U,V=!1;if(R!=="@"){const j=M.match(/^'(.*?)'$/);if(j!=null)W=j[1],t.setAttribute("value",W),M=t.nodeName.toLowerCase()==="option"?"selected":"checked",T=X=>X?W:void 0,R=X=>X===W;else if(M==="")if(T===">"){const[X,rt]=F.split(":");if(X.length>0){const{target:lt,property:xt}=this.resolveProperty(i,X);lt[xt]=t}return(rt??"").length>0&&bt.queue(()=>{const{target:lt,property:xt}=this.resolveProperty(i,rt);lt[xt]=n}),[]}else({element:t,template:U}=this.replaceWithComment(t,n,o,v.name)),M=R==="=",R=!0,T==="|"&&(V=!0);else if(T==="="&&R==="="){if(!t.tagName.includes("-")){t.setAttribute("pui-unrendered","");const X=this.parentNode(t,o);X.nodeType!==8?{element:t,template:U}=this.replaceWithComment(t,n,o,v.name,U):t=X}U=M,R=!0}else T==="*"?{element:t,template:U}=this.replaceWithComment(t,n,o,v.name):T==="|"?V=!0:M!=="checked"&&t.setAttribute(M,t.getAttribute?.(M)??"")}return[this.bind({selector:t,attribute:M,value:W,object:i,property:F,template:U,toUI:typeof R=="string"?R==="<":R,fromUI:typeof T=="string"?T===">":T,atEvent:R==="@",parent:n,oneTime:V})]}const x=[v.value];let b=0,S=x[b].match(this.regexValue);for(;S!=null;){let{before:P,property:I,after:M}=S.groups,R=!1;I.startsWith("|")&&(R=!0,I=I.slice(1).trimStart());const T=I.match(this.regexConditionalValue);let F;T&&(I=T[3],F=`${T[2]}${T[1]}`),p.push(this.bind({selector:t,attribute:v.name,object:i,property:I,oneTime:R,toUI(W,U,V,j,X){if(this.oneTime){const lt=x.indexOf(V);lt>-1&&(x[lt]=bt.resolveValue(j,V),x[lt-1]+=x[lt]+x[lt+1],x.splice(lt,2))}const rt=x.map((lt,xt)=>{if(xt%2===0)return lt;const mt=lt.match(bt.regexSplitConditionalValue);if(mt){const Ct=lt===`${V}${X}`?W:bt.resolveValue(j,mt[1]),Rt=mt[2]==="=";return!!Ct===Rt?mt[3].slice(1,-1):""}return lt===V?W:bt.resolveValue(j,lt)}).join("");return t.setAttribute(v.name,rt),rt},parent:n,value:F})),x[b++]=P,x[b++]=`${I}${F??""}`,x[b]=M,S=x[b].match(this.regexValue)}return p}).flat()),t instanceof Comment)return h.filter(_=>_.template!=null?!0:(_.unbind(),!1));if(!this.leaveAttributes)for(let _=Object.keys(t.attributes??[]).length-1;_>=0;_--){const p=t.attributes[Object.keys(t.attributes??[])[_]];p.name.startsWith("pui.")&&t.removeAttribute(p.name)}h.push(...Array.from(t.childNodes).map(_=>this.parse(_,i,n,o)).flat())}return h}static bind(t){return Gl.create(t)}static unbind(t){if(t.destroy(),t.parent!==bt){const i=t.parent.bindings,n=i.indexOf(t);n>-1&&i.splice(n,1)}}static update(){this.u.forEach(i=>i()),this.u=this.h,this.h=[],this.views.forEach(i=>i.updateToUI()),this.views.forEach(i=>i.updateFromUI()),this.views.forEach(i=>i.updateAtEvents());const t=performance.now();[...this.views,this.globals].forEach(i=>i.updateAnimations(t)),this.views.forEach(i=>{i.updateMove()});for(let i=0;i<this.destroyed.length;i++){const n=this.destroyed[i];switch(n.destroyed){case"queue":n.state==="rendered"?n.destroyed="destroy":n.updateToUI();break;case"destroy":{n.terminate();const o=this.destroyed.findIndex(h=>n===h);o>-1&&(this.destroyed.splice(o,1),i--)}}}}static resolveProperty(t,i){i=i.replace("[",".").replace("]",".");const n=i.split(".").filter(h=>(h??"").length>0);for(;n[0]==="$parent"&&t.$parent!=null;)t=t.$parent,n.shift();let o=t;if(n[0]==="$index"&&this.objectHas(o,"$index"))return{target:o,property:n[0]};for(this.objectHas(o,"$model")&&(o=t.$model);n.length>1;)o=o[n.shift()];return{target:o,property:n[0]}}static resolveValue(t,i){let n=0;do{const{target:o,property:h}=this.resolveProperty(t,i);if(o!=null&&this.objectHas(o,h))return o[h];t=t.$parent}while(t!=null&&n++<1e3);if(i in this.registrations)return this.registrations[i]}static initializeLoadPromise(){this.loadPromise==null&&(this.loadPromise=new Promise(t=>this.loadResolve=t),document.defaultView?.addEventListener("load",this.loaded))}static hoist(t=document,i=document){t!==i&&((i.querySelectorAll("style")??[]).forEach(h=>{t.head.appendChild(h.cloneNode(!0))}),(i.querySelectorAll("template")??[]).forEach(h=>{t.head.appendChild(h.cloneNode(!0))}));const n=i.querySelectorAll('object[type="text/pui"]')??[];let o=n.length>0;return n.forEach(h=>{o=this.hoist(t,h.contentDocument)||o}),o}static objectHas(t,i){try{return i in t}catch{return!1}}static replaceWithComment(t,i,n,o,h){const c=document.createComment(o);return this.parentNode(t,n).insertBefore(c,t),this.parentNode(t,n).removeChild(t),t.removeAttribute(o),h=h??t,t=c,t.parentNode instanceof DocumentFragment&&(i.element=t),{element:t,template:h}}static parentElement(t,i){const n=t.parentElement;if(n!=null)return n;for(;i!=null&&(i.element==null||i.element===t);)i=i.parent;return i?.element}static parentNode(t,i){const n=t.parentNode;if(n!=null)return n;for(;i!=null&&(i.element==null||i.element===t);)i=i.parent;return i?.element}static prepare(t){let i=t;t="";let n=i.match(this.regexReplace);for(;n!=null;){const[o,h,c,_]=n;c.match(/\S\s*===/)?t+=`${h.trimEnd()}br PUI.${this.bindingCounter++}="${c}"`:t+=`${h} PUI.${this.bindingCounter++}="${c}" `,i=_,n=i.match(this.regexReplace)}return t+=i,t}static parseAttribute(t,i,n,o,h,c){const _=c.match(this.regexAttribute);let[p,v,x,b,S]=_,P,I,M=!1;if(x!=="@"){const R=v.match(/^'(.*?)'$/);if(R!=null)P=R[1],t.setAttribute("value",P),v=t.nodeName.toLowerCase()==="option"?"selected":"checked",b=T=>T?P:void 0,x=T=>T===P;else if(v==="")if(b===">"){const{target:T,property:F}=this.resolveProperty(i,S);return T[F]=t,[]}else({element:t,template:I}=this.replaceWithComment(t,n,o,h)),v=x==="=",x=!0,b==="|"&&(M=!0);else if(b==="="&&x==="="){const T=this.parentNode(t,o);T.nodeType!==8?{element:t,template:I}=this.replaceWithComment(t,n,o,h,I):t=T,I=v,M=!0,x=!0}else b==="*"?{element:t,template:I}=this.replaceWithComment(t,n,o,h):b==="|"?M=!0:v!=="checked"&&t.setAttribute(v,"")}return[this.bind({selector:t,attribute:v,value:P,object:i,property:S,template:I,toUI:typeof x=="string"?x==="<":x,fromUI:typeof b=="string"?b===">":b,atEvent:x==="@",parent:n,oneTime:M})]}static registerWebComponent(t,i){t??(t=i.webComponent);class n extends HTMLElement{constructor(){super(),this.webComponentComponent=i,this.webComponentUIView=null,this.attachShadow({mode:"open"})}connectedCallback(){this.initialize()}disconnectedCallback(){this.terminate()}attributeChangedCallback(c,_,p){this.initialize(),this.webComponentUIView.model[c]=p}initialize(){if(this.webComponentUIView==null){const c="create"in this.webComponentComponent?this.webComponentComponent.create():new this.webComponentComponent;c.webComponentHost=this,this.webComponentUIView=bt.create(this.shadowRoot,c,this.webComponentComponent.template,{host:this.shadowRoot?.host})}}terminate(){this.webComponentUIView!=null&&this.webComponentUIView.destroy()}}n.observedAttributes=i.observedAttributes??[],n.observedProperties=i.observedProperties??n.observedAttributes;const o=[...new Set([...n.observedAttributes,...n.observedProperties])];for(const h of o)Object.defineProperty(n.prototype,h,{configurable:!0,enumerable:!1,get(){return this.webComponentUIView.model[h]},set(c){n.observedAttributes.includes(h)?this.setAttribute(h,c):(this.initialize(),this.webComponentUIView.model[h]=c)}});return customElements.define(t,n),n}}wl=Le;Le.initialized=!1;Le.id=0;Le.views=[];Le.destroyed=[];Le.globals=new Ss;Le.registrations={};Le.leaveAttributes=!1;Le.regexReplace=/([\S\s]*?)\\?\$\{([^}]*?[<=@!]=[*=>|][^}]*?)\}([\S\s]*)/m;Le.regexAttribute=/^\s*(\S*?)\s*([<=@!])=([*=>|])\s*(\S*?)\s*$/;Le.regexValue=/(?<before>[\S\s]*?)\\?\$\{\s*(?<property>[\s\S]*?)\s*\}(?<after>[\S\s]*)/m;Le.regexConditionalValue=/^\s*(.+?)\s*([=!])\s*(\S+)/;Le.regexSplitConditionalValue=/^(.+?)([=!])(.*)/;Le.bindingCounter=0;Le.u=[];Le.h=[];Le.loaded=()=>{wl.loadResolve(),document.defaultView?.removeEventListener("load",wl.loaded)};function bm(){let d=window,t=window;for(;;)try{if(d.parent===d){t=d;break}else d.parent.UI!=="guarantee-condition-always-true"&&(d=d.parent)}catch{break}return t}const xl=bm();"UI"in xl||(xl.UI=Le);const bt=xl.UI;/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var ym={851:(d,t,i)=>{i.d(t,{A:()=>p});var n=i(1),o=i.n(n),h=i(935),c=i.n(h),_=c()(o());_.push([d.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const p=_},296:(d,t,i)=>{i.d(t,{A:()=>p});var n=i(1),o=i.n(n),h=i(935),c=i.n(h),_=c()(o());_.push([d.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const p=_},935:d=>{d.exports=function(t){var i=[];return i.toString=function(){return this.map(function(o){var h="",c=typeof o[5]<"u";return o[4]&&(h+="@supports (".concat(o[4],") {")),o[2]&&(h+="@media ".concat(o[2]," {")),c&&(h+="@layer".concat(o[5].length>0?" ".concat(o[5]):""," {")),h+=t(o),c&&(h+="}"),o[2]&&(h+="}"),o[4]&&(h+="}"),h}).join("")},i.i=function(o,h,c,_,p){typeof o=="string"&&(o=[[null,o,void 0]]);var v={};if(c)for(var x=0;x<this.length;x++){var b=this[x][0];b!=null&&(v[b]=!0)}for(var S=0;S<o.length;S++){var P=[].concat(o[S]);c&&v[P[0]]||(typeof p<"u"&&(typeof P[5]>"u"||(P[1]="@layer".concat(P[5].length>0?" ".concat(P[5]):""," {").concat(P[1],"}")),P[5]=p),h&&(P[2]&&(P[1]="@media ".concat(P[2]," {").concat(P[1],"}")),P[2]=h),_&&(P[4]?(P[1]="@supports (".concat(P[4],") {").concat(P[1],"}"),P[4]=_):P[4]="".concat(_)),i.push(P))}},i}},1:d=>{d.exports=function(t){var i=t[1],n=t[3];if(!n)return i;if(typeof btoa=="function"){var o=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),h="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(o),c="/*# ".concat(h," */");return[i].concat([c]).join(`
`)}return[i].join(`
`)}}},Ou={};function Ie(d){var t=Ou[d];if(t!==void 0)return t.exports;var i=Ou[d]={id:d,exports:{}};return ym[d](i,i.exports,Ie),i.exports}Ie.n=d=>{var t=d&&d.__esModule?()=>d.default:()=>d;return Ie.d(t,{a:t}),t};Ie.d=(d,t)=>{for(var i in t)Ie.o(t,i)&&!Ie.o(d,i)&&Object.defineProperty(d,i,{enumerable:!0,get:t[i]})};Ie.o=(d,t)=>Object.prototype.hasOwnProperty.call(d,t);Ie.r=d=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(d,"__esModule",{value:!0})};var C={};Ie.d(C,{eKr:()=>bc,yVm:()=>uo,a7j:()=>xf,U_w:()=>Gc,JF2:()=>xc,htg:()=>$n,HXL:()=>Uc,mcg:()=>_c,Agj:()=>ti,J3_:()=>Fv,Wgv:()=>yc,u6S:()=>av,x7M:()=>me,X55:()=>ki,m3M:()=>Vr,aE5:()=>sv,YJU:()=>Mi,eZi:()=>Bl,GNv:()=>Yr,Y56:()=>Ul,_0v:()=>xa,vhs:()=>ca,vrQ:()=>co,Z8b:()=>Nf,Yfw:()=>Pt,IcQ:()=>ct,kgJ:()=>Hl,GTT:()=>y_,ypY:()=>$r,i7d:()=>n_,fQ3:()=>kv,HlI:()=>Ea,jlt:()=>Ra,VQc:()=>Ge,zD7:()=>Wc,AUF:()=>ns,JoF:()=>tn,MlA:()=>ve,PZh:()=>vn,qA:()=>qr,CrD:()=>Rs,dQK:()=>ss,D3r:()=>zi,Qpo:()=>ma,D9n:()=>pa,b6v:()=>Xr,mvh:()=>Ba,Bpo:()=>ft,Q1f:()=>K,IKv:()=>x_,fcV:()=>In,Glf:()=>w_,uAl:()=>Ci,ElT:()=>Ee,Z8r:()=>jl,QSL:()=>d_,sPV:()=>ga,nAn:()=>Ds,zCU:()=>_a,QrV:()=>ke,fF9:()=>gw,Jqv:()=>jf,d_u:()=>Yf,xI8:()=>gc,yar:()=>Te,SP7:()=>b_,oRy:()=>Fa,f5X:()=>Bc,V1c:()=>Zl,Mlx:()=>A_,ZiM:()=>Ol,ZCo:()=>jr,J5p:()=>C_,mL_:()=>ri,Guw:()=>Vf,N5j:()=>vf,pgY:()=>Xf,OP3:()=>ua,rl5:()=>E_,eod:()=>Vv,q5Z:()=>Pe,YUC:()=>Pc,saR:()=>wa,hvr:()=>Wl,Qol:()=>Wf,Wf4:()=>Of,JCs:()=>Xt,gJV:()=>_i,fWD:()=>e_,Va_:()=>Qs,N$8:()=>ni,_jQ:()=>Xv,rxj:()=>vc,rhv:()=>mc,wCu:()=>qe,HAp:()=>dv,Zy1:()=>o_,bkB:()=>$t,wfL:()=>fa,sVA:()=>ql,$Gs:()=>Cc,CJ0:()=>va,NWh:()=>Ts,tWi:()=>wc,xAj:()=>pc,zWh:()=>Gf,i_4:()=>_w,iIx:()=>Me,Hxo:()=>qf,c9e:()=>Fl,KQV:()=>Fn,weH:()=>Ht,jXp:()=>uw,zzY:()=>da,yRQ:()=>ha,MtE:()=>S_,rPj:()=>eo,KLc:()=>bi,Fir:()=>wt,V5f:()=>tc,Xj7:()=>ec,Wud:()=>ra,FVg:()=>dc,g5Y:()=>cc,YQB:()=>hc,KPb:()=>lc,nHK:()=>La,Jrb:()=>D_,TX_:()=>cw,Olt:()=>B_,r3n:()=>sr,Fvk:()=>Zv,gpR:()=>ba,vYh:()=>oe,hnk:()=>ae,D2R:()=>er,n1o:()=>Mc,h9O:()=>u_,X5j:()=>es,p3P:()=>kc,RLG:()=>fc,fBU:()=>Ec,Adb:()=>we,bEs:()=>is,wCy:()=>Mt,CbD:()=>Jt,x_C:()=>_r,pGf:()=>Oc,ibQ:()=>__,shR:()=>Kr,Yjk:()=>zc,_u1:()=>Qv,OBI:()=>F_,klh:()=>Wr,s3S:()=>p_,D$R:()=>to,xth:()=>Pa,JU7:()=>qv,h9x:()=>s_,N1A:()=>Vc,e_k:()=>de,aHM:()=>kn,tlv:()=>bv,Vi9:()=>t_,ieR:()=>$f,$bb:()=>xe,VyI:()=>dt,imn:()=>uf,uqu:()=>fi,QnL:()=>bl,vnc:()=>Sc,wk_:()=>Ml,GH0:()=>kt,_1r:()=>Ma,l0X:()=>Rl,bT:()=>Tf,HHX:()=>Dl,jtW:()=>If,tjk:()=>qs,rWe:()=>mn,j9l:()=>pf,l0$:()=>qc,sGJ:()=>bs,NVp:()=>Ic,cPK:()=>Ke,XoL:()=>Hc,RmF:()=>$e,DXI:()=>Da,tCD:()=>Jv,J3D:()=>Ta,vCJ:()=>Yv,e6k:()=>_f,f9l:()=>Oi,v9m:()=>za,yRJ:()=>f_,EU6:()=>zl,m3O:()=>ws,Ryz:()=>Js,OxP:()=>Nr,LEs:()=>Ua,Ec:()=>Dn,Pi5:()=>ka,gmH:()=>xs,tS:()=>Xc,XxX:()=>Be,bCz:()=>Sa,nYS:()=>Bn,yiT:()=>rc,NHl:()=>fr,mO8:()=>ac,PXI:()=>$l,bn5:()=>sc,Ywr:()=>$s,cMd:()=>Mn,Bs6:()=>nc,G0k:()=>ur,pyn:()=>oc,QeM:()=>Kl,aPX:()=>Ov,ITP:()=>ic,BY0:()=>Ks,MFw:()=>ao,sBn:()=>ro,S3L:()=>Jn,XKQ:()=>Qr,ESI:()=>a_,uxz:()=>i_,o8N:()=>hr,u_r:()=>dr,RlV:()=>Sn,gVA:()=>kl,M_G:()=>ho,BpG:()=>Ac,GRB:()=>lv,kM6:()=>bf,dO8:()=>yf,jgM:()=>Pl,FWq:()=>so,s3j:()=>Rm,hlw:()=>Mf,L0q:()=>Ff,B7e:()=>Df,PGN:()=>Rf,H_X:()=>re,S_d:()=>Hf,_Tq:()=>zf,U7E:()=>Lf,IOH:()=>kf,Z58:()=>wi,yh2:()=>Wv,ff$:()=>Tl,cWi:()=>ef,NBt:()=>Dc,oNz:()=>mv,QlU:()=>v_,Xey:()=>Zs,jft:()=>xw,_r8:()=>pe,bTC:()=>wf,Mtr:()=>hi,ypk:()=>Ve,mnM:()=>Ot,q7S:()=>pw,bAZ:()=>Zr,ABN:()=>mf,VK6:()=>xv,Hj2:()=>Lc,Df8:()=>Ll,oOx:()=>ir,kxk:()=>Ui,DT1:()=>Ca,FLG:()=>Pn,qN_:()=>Nc,Z37:()=>Ia,FtL:()=>Kf,Z6X:()=>M_,iQT:()=>yi,ziO:()=>l_,OEF:()=>as,uuE:()=>pi,tiv:()=>Jr,T$Y:()=>P_,EYj:()=>oo,nOB:()=>la,Tap:()=>ne,FAs:()=>Jf,B_P:()=>Qf,aA5:()=>Bv,J3s:()=>Yc,Y0Q:()=>no,M4G:()=>En,l$l:()=>T_,dLy:()=>Is,WZP:()=>st,eB6:()=>Ha,nFK:()=>Il,l9z:()=>r_,YOF:()=>Lv,yhB:()=>be,J0N:()=>Yl,Miz:()=>k,Bj4:()=>Al,Rcs:()=>rs,vJ4:()=>Fs,TqC:()=>Tc,nM0:()=>uc,X1u:()=>Tn,SpZ:()=>gf,DX8:()=>tr,Yx$:()=>m_,HK4:()=>c_,yt5:()=>$u,vAR:()=>jv,SE$:()=>Ps,qE8:()=>At,Pz7:()=>k_,sX_:()=>Rn,JuI:()=>Am,pxT:()=>Es,Nl$:()=>Jl,zDr:()=>ow,OwT:()=>ew,P$G:()=>rw,mHV:()=>sw,kEA:()=>aw,Fx_:()=>lw,WFC:()=>hw,vKu:()=>$v,aDq:()=>Kv,jIg:()=>nw,UH3:()=>iw,AJO:()=>tw,U4:()=>Cf,xAc:()=>Sf,_3Y:()=>Dv,K6X:()=>hv,C1Y:()=>ff,Aw1:()=>El,tm8:()=>Pf,LBV:()=>Ef,A8$:()=>cv,F5e:()=>Rv,ran:()=>Iv,c8L:()=>Uf,o6M:()=>Bf,hsx:()=>Ji,l9E:()=>Zf,aSf:()=>h_,CcK:()=>Af,nU8:()=>Rc,td6:()=>lo,Zex:()=>L_,bkJ:()=>Nt,mXP:()=>vw,vt$:()=>cr,hCA:()=>Hi,pjR:()=>pt,U43:()=>ts,pSZ:()=>Pm,y17:()=>Sm,Ew7:()=>os,hG1:()=>Ev,jVr:()=>mw,_SZ:()=>qt,xWn:()=>tf,ehJ:()=>Cm,t6s:()=>G,Eyn:()=>Vl});var Vl={};Ie.r(Vl);Ie.d(Vl,{getAttributeComponentSize:()=>cf,getAttributePointerType:()=>df,getGLTypeFromSource:()=>lf,getGlTypeSizeBytes:()=>yl,getMaxShaderComplexity:()=>Ql,isAttributeInSource:()=>hf});var Xl={};Ie.r(Xl);Ie.d(Xl,{circle:()=>ov,line:()=>Cl,point:()=>nv,roundRect:()=>Sl,vector:()=>rv});var ql={};Ie.r(ql);Ie.d(ql,{ActionCompleteEvent:()=>bc,ActionStartEvent:()=>xc,ActivateEvent:()=>_c,AddEvent:()=>yc,CollisionEndEvent:()=>qr,CollisionPostSolveEvent:()=>ma,CollisionPreSolveEvent:()=>pa,CollisionStartEvent:()=>Xr,ContactEndEvent:()=>ga,ContactStartEvent:()=>_a,DeactivateEvent:()=>gc,EnterTriggerEvent:()=>vc,EnterViewPortEvent:()=>mc,EventTypes:()=>fa,ExitTriggerEvent:()=>wc,ExitViewPortEvent:()=>pc,GameEvent:()=>wt,GameStartEvent:()=>tc,GameStopEvent:()=>ec,GamepadAxisEvent:()=>dc,GamepadButtonEvent:()=>cc,GamepadConnectEvent:()=>hc,GamepadDisconnectEvent:()=>lc,HiddenEvent:()=>fc,InitializeEvent:()=>_r,KillEvent:()=>Pa,PostCollisionEvent:()=>Bn,PostDebugDrawEvent:()=>rc,PostDrawEvent:()=>fr,PostFrameEvent:()=>ac,PostKillEvent:()=>$l,PostTransformDrawEvent:()=>sc,PostUpdateEvent:()=>$s,PreCollisionEvent:()=>Mn,PreDebugDrawEvent:()=>nc,PreDrawEvent:()=>ur,PreFrameEvent:()=>oc,PreKillEvent:()=>Kl,PreTransformDrawEvent:()=>ic,PreUpdateEvent:()=>Ks,RemoveEvent:()=>Ac,VisibleEvent:()=>uc});var Yl={};Ie.r(Yl);Ie.d(Yl,{ConsoleAppender:()=>jl,DrawUtil:()=>Xl,EasingFunctions:()=>Xt,LogLevel:()=>xe,Logger:()=>dt,Observable:()=>Ke,ScreenAppender:()=>ef,addItemToArray:()=>Tm,contains:()=>sf,delay:()=>oa,fail:()=>nf,getPosition:()=>Or,isObject:()=>na,mergeDeep:()=>aa,omit:()=>rf,removeItemFromArray:()=>lr});function Ku(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(d){window.setInterval(d,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const t=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(i){return new Promise((n,o)=>{t.call(this,i,n,o)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(d){const t=Date.now();return setTimeout(function(){d({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(d){clearTimeout(d)})}class Me{static useCanvasGraphicsContext(){Me.enable("use-canvas-context")}static useLegacyImageRenderer(){Me.enable("use-legacy-image-renderer")}static freeze(){Me._FROZEN=!0}static _reset(){Me._FROZEN=!1,Me._FLAGS={}}static enable(t){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");Me._FLAGS[t]=!0}static disable(t){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");Me._FLAGS[t]=!1}static isEnabled(t){return!!Me._FLAGS[t]}static show(){return Object.keys(Me._FLAGS)}}Me._FROZEN=!1;Me._FLAGS={};function Rn(d,t){return{type:d,value:t}}class bi{constructor(){this._isCompleted=!1,this.promise=new Promise((t,i)=>{this._resolver=t,this._rejecter=i})}get isCompleted(){return this._isCompleted}resolve(t){this._isCompleted||(this._isCompleted=!0,this._resolver(t))}reject(t){this._isCompleted||(this._isCompleted=!0,this._rejecter(t))}}class $t{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(t,i){var n;return this._empty=!1,this._listeners[t]=(n=this._listeners[t])!==null&&n!==void 0?n:[],this._listeners[t].push(i),{close:()=>this.off(t,i)}}once(t,i){var n;return this._empty=!1,this._listenersOnce[t]=(n=this._listenersOnce[t])!==null&&n!==void 0?n:[],this._listenersOnce[t].push(i),{close:()=>this.off(t,i)}}off(t,i){var n,o;if(i){const h=(n=this._listeners[t])===null||n===void 0?void 0:n.filter(_=>_!==i);this._listeners[t]=h;const c=(o=this._listenersOnce[t])===null||o===void 0?void 0:o.filter(_=>_!==i);this._listenersOnce[t]=c}else delete this._listeners[t]}emit(t,i){if(this._empty||this._paused)return;const n=this._listeners[t];if(n)for(let h=0;h<n.length;h++)n[h](i);const o=this._listenersOnce[t];if(this._listenersOnce[t]=[],o)for(let h=0;h<o.length;h++)o[h](i);for(let h=0;h<this._pipes.length;h++)this._pipes[h].emit(t,i)}pipe(t){if(this===t)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(t),{close:()=>{const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}}}unpipe(t){const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var Dn;(function(d){d.Canvas="Canvas",d.Document="Document"})(Dn||(Dn={}));var re;(function(d){d.ShortestPath="shortest-path",d.LongestPath="longest-path",d.Clockwise="clockwise",d.CounterClockwise="counter-clockwise"})(re||(re={}));const ll=4294967295;class hr{constructor(t){this.seed=t,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(t||Date.now())>>>0;for(let i=1;i<this._n;i++){const n=this._mt[i-1]^this._mt[i-1]>>>this._w-2;this._mt[i]=(this._f*((n&4294901760)>>>16)<<16)+this._f*(n&65535)+i>>>0}this._index=this._n}_twist(){const t=[0,this._a];let i=0,n=0;for(;n<this._n-this._m;n++)i=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+this._m]^i>>>1^t[i&1]&ll;for(;n<this._n-1;n++)i=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+(this._m-this._n)]^i>>>1^t[i&1]&ll;i=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^i>>>1^t[i&1]&ll,this._index=0}nextInt(){this._index>=this._n&&this._twist();let t=this._mt[this._index++];return t^=t>>>this._u,t^=t<<this._s&this._b,t^=t<<this._t&this._c,t^=t>>>this._l,t>>>0}next(){return this.nextInt()*(1/4294967296)}floating(t,i){return(i-t)*this.next()+t}integer(t,i){return Math.floor((i-t+1)*this.next()+t)}bool(t=.5){return this.next()<=t}pickOne(t){return t[this.integer(0,t.length-1)]}pickSet(t,i,n=!1){return n?this._pickSetWithDuplicates(t,i):this._pickSetWithoutDuplicates(t,i)}_pickSetWithoutDuplicates(t,i){if(i>t.length||i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(i===t.length)return t;const n=new Array(i);let o=0;const h=t.slice(0);for(;o<i;){const c=this.integer(0,h.length-1);n[o++]=h[c],h.splice(c,1)}return n}_pickSetWithDuplicates(t,i){if(i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const n=new Array(i);for(let o=0;o<i;o++)n[o]=this.pickOne(t);return n}shuffle(t){const i=t.slice(0);let n;for(let o=0;o<i.length-2;o++){const h=this.integer(o,i.length-1);n=i[o],i[o]=i[h],i[h]=n}return i}range(t,i,n){const o=new Array(t);for(let h=0;h<t;h++)o[h]=this.integer(i,n);return o}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const be=Math.PI*2;function Am(d){return d>=0?d-Math.floor(d):d-Math.ceil(d)}function qt(d){return d===0?0:d<0?-1:1}function At(d,t,i){return Math.min(Math.max(t,d),i)}function $u(d,t,i){return Math.abs(d-t)<i}function Ps(d){let t=d;if(d>=be)for(;t>=be;)t-=be;if(d<0)for(;t<0;)t+=be;return t}function tf(d){return 180/Math.PI*d}function Cm(d){return d/180*Math.PI}const Sm=(d,t)=>Array.from(new Array(t-d+1),(i,n)=>n+d);function ts(d,t,i=new hr){return i?i.floating(d,t):d+Math.random()*(t-d)}function Pm(d,t,i=new hr){return i?i.integer(d,t):Math.round(ts(d,t))}class k{static get Zero(){return new k(0,0)}static get One(){return new k(1,1)}static get Half(){return new k(.5,.5)}static get Up(){return new k(0,-1)}static get Down(){return new k(0,1)}static get Left(){return new k(-1,0)}static get Right(){return new k(1,0)}static fromAngle(t){return new k(Math.cos(t),Math.sin(t))}static isValid(t){return!(t==null||isNaN(t.x)||isNaN(t.y)||t.x===1/0||t.y===1/0||t.x===-1/0||t.y===-1/0)}static distance(t,i){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))}static min(t,i){return new k(Math.min(t.x,i.x),Math.min(t.y,i.y))}static max(t,i){return new k(Math.max(t.x,i.x),Math.max(t.y,i.y))}constructor(t,i){this._x=0,this._y=0,this._x=t,this._y=i}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}setTo(t,i){this.x=t,this.y=i}equals(t,i=k.EQUALS_EPSILON){return Math.abs(this.x-t.x)<=i&&Math.abs(this.y-t.y)<=i}distance(t){if(!t)return Math.sqrt(this.x*this.x+this.y*this.y);const i=this.x-t.x,n=this.y-t.y;return Math.sqrt(i*i+n*n)}squareDistance(t){t||(t=k.Zero);const i=this.x-t.x,n=this.y-t.y;return i*i+n*n}clampMagnitude(t){const i=this.magnitude,n=At(i,0,t);return this.magnitude=n,this}get size(){return this.distance()}set size(t){const i=this.normalize().scale(t);this.setTo(i.x,i.y)}get magnitude(){return this.distance()}set magnitude(t){this.normalize().scale(t,this)}normalize(){const t=this.distance();return t===0?k.Zero:new k(this.x/t,this.y/t)}average(t){return this.add(t).scale(.5)}scale(t,i){const n=i||new k(0,0);return t instanceof k?(n.x=this.x*t.x,n.y=this.y*t.y):(n.x=this.x*t,n.y=this.y*t),n}add(t,i){return i?(i.x=this.x+t.x,i.y=this.y+t.y,i):new k(this.x+t.x,this.y+t.y)}sub(t,i){const n=i||new k(0,0),o=this.x-t.x,h=this.y-t.y;return n.x=o,n.y=h,n}addEqual(t){return this.setTo(this.x+t.x,this.y+t.y),this}subEqual(t){return this.setTo(this.x-t.x,this.y-t.y),this}scaleEqual(t){return this.setTo(this.x*t,this.y*t),this}dot(t){return this.x*t.x+this.y*t.y}cross(t){if(t instanceof k)return this.x*t.y-this.y*t.x;if(typeof t=="number")return new k(t*this.y,-t*this.x)}static cross(t,i){return new k(-t*i.y,t*i.x)}perpendicular(){return new k(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return Ps(Math.atan2(this.y,this.x))}angleBetween(t,i){const n=this.toAngle(),o=Ps(t);let h=0,c=0;switch(o>n?h=o-n:h=(be-n+o)%be,c=(h-be)%be,i){case re.ShortestPath:return Math.abs(h)<Math.abs(c)?h:c;case re.LongestPath:return Math.abs(h)>Math.abs(c)?h:c;case re.Clockwise:return h;case re.CounterClockwise:return c}}rotate(t,i,n){const o=n||new k(0,0);i||(i=new k(0,0));const h=Math.sin(t),c=Math.cos(t),_=c*(this.x-i.x)-h*(this.y-i.y)+i.x,p=h*(this.x-i.x)+c*(this.y-i.y)+i.y;return o.x=_,o.y=p,o}clone(t){const i=t??new k(0,0);return i.x=this.x,i.y=this.y,i}toString(t){return t?`(${this.x.toFixed(t)}, ${this.y.toFixed(t)})`:`(${this.x}, ${this.y})`}}k.EQUALS_EPSILON=.001;function G(d,t){return new k(d,t)}class K{constructor(t,i,n,o){this.r=t,this.g=i,this.b=n,this.a=o??1}static fromRGB(t,i,n,o){return new K(t,i,n,o)}static fromRGBString(t){const i=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let n=null;if(n=t.match(i)){const o=parseInt(n[1],10),h=parseInt(n[2],10),c=parseInt(n[3],10);let _=1;return n[4]&&(_=parseFloat(n[4])),new K(o,h,c,_)}else throw new Error("Invalid rgb/a string: "+t)}static fromHex(t){const i=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let n=null;if(n=t.match(i)){const o=parseInt(n[1],16),h=parseInt(n[2],16),c=parseInt(n[3],16);let _=1;return n[4]&&(_=parseInt(n[4],16)/255),new K(o,h,c,_)}else throw new Error("Invalid hex string: "+t)}static fromHSL(t,i,n,o=1){return new Bi(t,i,n,o).toRGBA()}lighten(t=.1){const i=Bi.fromRGBA(this.r,this.g,this.b,this.a);return i.l+=(1-i.l)*t,i.toRGBA()}darken(t=.1){const i=Bi.fromRGBA(this.r,this.g,this.b,this.a);return i.l-=i.l*t,i.toRGBA()}saturate(t=.1){const i=Bi.fromRGBA(this.r,this.g,this.b,this.a);return i.s+=i.s*t,i.toRGBA()}desaturate(t=.1){const i=Bi.fromRGBA(this.r,this.g,this.b,this.a);return i.s-=i.s*t,i.toRGBA()}multiply(t){const i=t.r/255*this.r/255*255,n=t.g/255*this.g/255*255,o=t.b/255*this.b/255*255,h=t.a*this.a;return new K(i,n,o,h)}screen(t){const i=t.invert(),n=t.invert();return i.multiply(n).invert()}invert(){return new K(255-this.r,255-this.g,255-this.b,1-this.a)}average(t){const i=(t.r+this.r)/2,n=(t.g+this.g)/2,o=(t.b+this.b)/2,h=(t.a+this.a)/2;return new K(i,n,o,h)}equal(t){return this.toString()===t.toString()}toString(t="rgb"){switch(t){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(t){const i=Math.max(Math.round(t),0).toString(16);return i.length===1?"0"+i:i}toHex(){let t="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(t+=this._componentToHex(this.a*255)),t}toRGBA(){const t=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+t+", "+String(this.a)+")":"rgb("+t+")"}toHSLA(){return Bi.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(t){const i=t||new K(this.r,this.g,this.b,this.a);return i.r=this.r,i.g=this.g,i.b=this.b,i.a=this.a,i}static get Black(){return K.fromHex("#000000")}static get White(){return K.fromHex("#FFFFFF")}static get Gray(){return K.fromHex("#808080")}static get LightGray(){return K.fromHex("#D3D3D3")}static get DarkGray(){return K.fromHex("#A9A9A9")}static get Yellow(){return K.fromHex("#FFFF00")}static get Orange(){return K.fromHex("#FFA500")}static get Red(){return K.fromHex("#FF0000")}static get Vermilion(){return K.fromHex("#FF5B31")}static get Rose(){return K.fromHex("#FF007F")}static get Pink(){return K.fromHex("#FFC0CB")}static get Magenta(){return K.fromHex("#FF00FF")}static get Violet(){return K.fromHex("#7F00FF")}static get Purple(){return K.fromHex("#800080")}static get Blue(){return K.fromHex("#0000FF")}static get Azure(){return K.fromHex("#007FFF")}static get Cyan(){return K.fromHex("#00FFFF")}static get Viridian(){return K.fromHex("#59978F")}static get Teal(){return K.fromHex("#008080")}static get Green(){return K.fromHex("#00FF00")}static get Chartreuse(){return K.fromHex("#7FFF00")}static get Transparent(){return K.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return K.fromHex("#176BAA")}static get Brown(){return K.fromHex("#964B00")}}class Bi{constructor(t,i,n,o){this.h=t,this.s=i,this.l=n,this.a=o}static hue2rgb(t,i,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+(i-t)*6*n:n<1/2?i:n<2/3?t+(i-t)*(2/3-n)*6:t}static fromRGBA(t,i,n,o){t/=255,i/=255,n/=255;const h=Math.max(t,i,n),c=Math.min(t,i,n);let _,p;const v=(h+c)/2;if(h===c)_=p=0;else{const x=h-c;switch(p=v>.5?x/(2-h-c):x/(h+c),h){case t:_=(i-n)/x+(i<n?6:0);break;case i:_=(n-t)/x+2;break;case n:_=(t-i)/x+4;break}_/=6}return new Bi(_,p,v,o)}toRGBA(){let t,i,n;if(this.s===0)t=i=n=this.l;else{const o=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,h=2*this.l-o;t=Bi.hue2rgb(h,o,this.h+1/3),i=Bi.hue2rgb(h,o,this.h),n=Bi.hue2rgb(h,o,this.h-1/3)}return new K(t*255,i*255,n*255,this.a)}toString(){const t=this.h.toFixed(0),i=this.s.toFixed(0),n=this.l.toFixed(0),o=this.a.toFixed(0);return`hsla(${t}, ${i}, ${n}, ${o})`}}var xe;(function(d){d[d.Debug=0]="Debug",d[d.Info=1]="Info",d[d.Warn=2]="Warn",d[d.Error=3]="Error",d[d.Fatal=4]="Fatal"})(xe||(xe={}));class dt{constructor(){if(this._appenders=[],this.defaultLevel=xe.Info,this._logOnceSet=new Set,dt._INSTANCE)throw new Error("Logger is a singleton");return dt._INSTANCE=this,dt._INSTANCE.addAppender(new jl),dt._INSTANCE}static getInstance(){return dt._INSTANCE==null&&(dt._INSTANCE=new dt),dt._INSTANCE}addAppender(t){this._appenders.push(t)}clearAppenders(){this._appenders.length=0}_log(t,i){t==null&&(t=this.defaultLevel);const n=this._appenders.length;for(let o=0;o<n;o++)t>=this.defaultLevel&&this._appenders[o].log(t,i)}_logOnce(t,i){const n=t+i.join("+");this._logOnceSet.has(n)||(this._logOnceSet.add(n),this._log(t,i))}debug(...t){this._log(xe.Debug,t)}debugOnce(...t){this._logOnce(xe.Debug,t)}info(...t){this._log(xe.Info,t)}infoOnce(...t){this._logOnce(xe.Info,t)}warn(...t){this._log(xe.Warn,t)}warnOnce(...t){this._logOnce(xe.Warn,t)}error(...t){this._log(xe.Error,t)}errorOnce(...t){this._logOnce(xe.Error,t)}fatal(...t){this._log(xe.Fatal,t)}fatalOnce(...t){this._logOnce(xe.Fatal,t)}}dt._INSTANCE=null;class jl{log(t,i){if(!console&&!console.log&&console.warn&&console.error)return;const n=[];n.unshift.apply(n,i),n.unshift("["+xe[t]+"] : "),t<xe.Warn?console.log.apply?console.log.apply(console,n):console.log(n.join(" ")):t<xe.Error?console.warn.apply?console.warn.apply(console,n):console.warn(n.join(" ")):console.error.apply?console.error.apply(console,n):console.error(n.join(" "))}}class ef{constructor(t){var i,n;this._messages=[],this._pos=10,this._color=K.Black,this._options=t,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(n=(i=t.zIndex)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),t.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var t,i,n,o;const h=this._options;this.canvas.width=(t=h.width)!==null&&t!==void 0?t:h.engine.screen.resolution.width,this.canvas.height=(i=h.height)!==null&&i!==void 0?i:h.engine.screen.resolution.height,this.canvas.style.position="absolute";const c=h.engine.screen.screenToPageCoordinates(G(0,0));this.canvas.style.left=c.x+"px",this.canvas.style.top=c.y+"px",this._pos=(n=h.xPos)!==null&&n!==void 0?n:this._pos,this._color=(o=h.color)!==null&&o!==void 0?o:this._color}log(t,i){const n=i.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+xe[t]+"] : "+n);let o=10;this._messages=this._messages.slice(0,1e3);for(let h=0;h<this._messages.length;h++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[h],this._pos,o),o+=10}}var Ot;(function(d){d.None="None",d.Top="Top",d.Bottom="Bottom",d.Left="Left",d.Right="Right"})(Ot||(Ot={}));(function(d){function t(n){return n===d.Top?d.Bottom:n===d.Bottom?d.Top:n===d.Left?d.Right:n===d.Right?d.Left:d.None}d.getOpposite=t;function i(n){return Math.abs(n.x)>=Math.abs(n.y)?n.x<=0?d.Left:d.Right:n.y<=0?d.Top:d.Bottom}d.fromDirection=i})(Ot||(Ot={}));class ct{constructor(t=0,i=0,n=0,o=0){this._points=[],typeof t=="object"?(this.left=t.left,this.top=t.top,this.right=t.right,this.bottom=t.bottom):typeof t=="number"&&(this.left=t,this.top=i,this.right=n,this.bottom=o)}clone(t){const i=t||new ct(0,0,0,0);return i.left=this.left,i.right=this.right,i.top=this.top,i.bottom=this.bottom,i}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(t){return t&&t?Math.abs(t.x)>Math.abs(t.y)?t.x<0?Ot.Right:Ot.Left:t.y<0?Ot.Bottom:Ot.Top:Ot.None}static fromPoints(t){let i=1/0,n=1/0,o=-1/0,h=-1/0;for(let c=0;c<t.length;c++)t[c].x<i&&(i=t[c].x),t[c].x>o&&(o=t[c].x),t[c].y<n&&(n=t[c].y),t[c].y>h&&(h=t[c].y);return new ct(i,n,o,h)}static fromDimension(t,i,n=k.Half,o=k.Zero){return new ct(-t*n.x+o.x,-i*n.y+o.y,t-t*n.x+o.x,i-i*n.y+o.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new k((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new k(this.left,this.top)}get bottomRight(){return new k(this.right,this.bottom)}get topRight(){return new k(this.right,this.top)}get bottomLeft(){return new k(this.left,this.bottom)}translate(t){return new ct(this.left+t.x,this.top+t.y,this.right+t.x,this.bottom+t.y)}rotate(t,i=k.Zero){const n=this.getPoints().map(o=>o.rotate(t,i));return ct.fromPoints(n)}scale(t,i=k.Zero){const n=this.translate(i);return new ct(n.left*t.x,n.top*t.y,n.right*t.x,n.bottom*t.y)}transform(t){const i=t.data[0]*this.left,n=t.data[1]*this.left,o=t.data[0]*this.right,h=t.data[1]*this.right,c=t.data[2]*this.top,_=t.data[3]*this.top,p=t.data[2]*this.bottom,v=t.data[3]*this.bottom,x=t.getPosition(),b=Math.min(i,o)+Math.min(c,p)+x.x,S=Math.min(n,h)+Math.min(_,v)+x.y,P=Math.max(i,o)+Math.max(c,p)+x.x,I=Math.max(n,h)+Math.max(_,v)+x.y;return new ct({left:b,top:S,right:P,bottom:I})}getPerimeter(){const t=this.width,i=this.height;return 2*(t+i)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new k(this.left,this.top)),this._points.push(new k(this.right,this.top)),this._points.push(new k(this.right,this.bottom)),this._points.push(new k(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(t,i=1/0){let n=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,c=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,_=(this.left-t.pos.x)*h,p=(this.right-t.pos.x)*h;n=Math.min(_,p),o=Math.max(_,p);const v=(this.top-t.pos.y)*c,x=(this.bottom-t.pos.y)*c;return n=Math.max(n,Math.min(v,x)),o=Math.min(o,Math.max(v,x)),o>=Math.max(0,n)&&n<i}rayCastTime(t,i=1/0){let n=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,c=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,_=(this.left-t.pos.x)*h,p=(this.right-t.pos.x)*h;n=Math.min(_,p),o=Math.max(_,p);const v=(this.top-t.pos.y)*c,x=(this.bottom-t.pos.y)*c;return n=Math.max(n,Math.min(v,x)),o=Math.min(o,Math.max(v,x)),o>=Math.max(0,n)&&n<i?n:-1}contains(t){return t instanceof k?this.left<=t.x&&this.top<=t.y&&t.y<=this.bottom&&t.x<=this.right:t instanceof ct?this.left<=t.left&&this.top<=t.top&&t.bottom<=this.bottom&&t.right<=this.right:!1}combine(t,i){const n=i||new ct(0,0,0,0),o=Math.min(this.left,t.left),h=Math.min(this.top,t.top),c=Math.max(this.right,t.right),_=Math.max(this.bottom,t.bottom);return n.left=o,n.top=h,n.right=c,n.bottom=_,n}get dimensions(){return new k(this.width,this.height)}overlaps(t,i){const n=i||0;if(t.hasZeroDimensions())return this.contains(t);if(this.hasZeroDimensions())return t.contains(this);const o=this.combine(t);return o.width+n<t.width+this.width&&o.height+n<t.height+this.height}intersect(t){const i=this.combine(t);if(i.width<t.width+this.width&&i.height<t.height+this.height&&!i.dimensions.equals(t.dimensions)&&!i.dimensions.equals(this.dimensions)){let n=0;this.right>=t.left&&this.right<=t.right?n=t.left-this.right:n=t.right-this.left;let o=0;return this.top<=t.bottom&&this.top>=t.top?o=t.bottom-this.top:o=t.top-this.bottom,Math.abs(n)<Math.abs(o)?new k(n,0):new k(0,o)}else if(i.dimensions.equals(t.dimensions)||i.dimensions.equals(this.dimensions)){let n=0;this.width-t.width>=0?this.right-t.right<=t.left-this.left?n=t.left-this.right:n=t.right-this.left:t.right-this.right<=this.left-t.left?n=this.left-t.right:n=this.right-t.left;let o=0;return this.height-t.height>=0?this.bottom-t.bottom<=t.top-this.top?o=t.top-this.bottom:o=t.bottom-this.top:t.bottom-this.bottom<=this.top-t.top?o=this.top-t.bottom:o=this.bottom-t.top,Math.abs(n)<Math.abs(o)?new k(n,0):new k(0,o)}else return null}intersectWithSide(t){const i=this.intersect(t);return ct.getSideFromIntersection(i)}draw(t,i=K.Yellow){t.debug.drawRect(this.left,this.top,this.width,this.height,{color:i})}}function Or(d){if(d&&d.getBoundingClientRect){const t=d.getBoundingClientRect();return G(t.x+window.scrollX,t.y+window.scrollY)}return k.Zero}function Tm(d,t){return t.indexOf(d)===-1?(t.push(d),!0):!1}function lr(d,t){let i=-1;return(i=t.indexOf(d))>-1?(t.splice(i,1),!0):!1}function sf(d,t){for(let i=0;i<d.length;i++)if(d[i]===t)return!0;return!1}function nf(d){throw new Error(d)}function oa(d,t){var i;const n=new bi;return((i=t?.schedule.bind(t))!==null&&i!==void 0?i:setTimeout)(()=>{n.resolve()},d),n.promise}function rf(d,t){const i={};for(const n in d)t.includes(n)||(i[n]=d[n]);return i}function na(d){return d&&typeof d=="object"&&!Array.isArray(d)}function aa(d,...t){if(!t.length)return d;const i=t.shift();if(na(d)&&na(i))for(const n in i)na(i[n])?(d[n]||Object.assign(d,{[n]:{}}),aa(d[n],i[n])):Object.assign(d,{[n]:i[n]});return aa(d,...t)}var bl;(function(d){d[d.X=12]="X",d[d.Y=13]="Y"})(bl||(bl={}));class fi{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(t,i,n,o,h,c){const _=new fi;return _.data[0]=2/(i-t),_.data[1]=0,_.data[2]=0,_.data[3]=0,_.data[4]=0,_.data[5]=2/(o-n),_.data[6]=0,_.data[7]=0,_.data[8]=0,_.data[9]=0,_.data[10]=-2/(c-h),_.data[11]=0,_.data[12]=-(i+t)/(i-t),_.data[13]=-(o+n)/(o-n),_.data[14]=-(c+h)/(c-h),_.data[15]=1,_}clone(t){const i=t||new fi;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i.data[6]=this.data[6],i.data[7]=this.data[7],i.data[8]=this.data[8],i.data[9]=this.data[9],i.data[10]=this.data[10],i.data[11]=this.data[11],i.data[12]=this.data[12],i.data[13]=this.data[13],i.data[14]=this.data[14],i.data[15]=this.data[15],i}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(t){const i=new fi;return i.data=t,i}static identity(){const t=new fi;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}static translation(t,i){const n=fi.identity();return n.data[12]=t,n.data[13]=i,n}static scale(t,i){const n=fi.identity();return n.data[0]=t,n.data[5]=i,n.data[10]=1,n.data[15]=1,n}static rotation(t){const i=fi.identity();return i.data[0]=Math.cos(t),i.data[4]=-Math.sin(t),i.data[1]=Math.sin(t),i.data[5]=Math.cos(t),i}multiply(t,i){if(t instanceof k){const n=i||new k(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[4]+this.data[12],c=o.x*this.data[1]+o.y*this.data[5]+this.data[13];return n.x=h,n.y=c,n}else{const n=i||new fi,o=t,h=this.data[0],c=this.data[1],_=this.data[2],p=this.data[3],v=this.data[4],x=this.data[5],b=this.data[6],S=this.data[7],P=this.data[8],I=this.data[9],M=this.data[10],R=this.data[11],T=this.data[12],F=this.data[13],W=this.data[14],U=this.data[15],V=o.data[0],j=o.data[1],X=o.data[2],rt=o.data[3],lt=o.data[4],xt=o.data[5],mt=o.data[6],Ct=o.data[7],Rt=o.data[8],B=o.data[9],z=o.data[10],Q=o.data[11],tt=o.data[12],Gt=o.data[13],at=o.data[14],Si=o.data[15];n.data[0]=h*V+v*j+P*X+T*rt,n.data[1]=c*V+x*j+I*X+F*rt,n.data[2]=_*V+b*j+M*X+W*rt,n.data[3]=p*V+S*j+R*X+U*rt,n.data[4]=h*lt+v*xt+P*mt+T*Ct,n.data[5]=c*lt+x*xt+I*mt+F*Ct,n.data[6]=_*lt+b*xt+M*mt+W*Ct,n.data[7]=p*lt+S*xt+R*mt+U*Ct,n.data[8]=h*Rt+v*B+P*z+T*Q,n.data[9]=c*Rt+x*B+I*z+F*Q,n.data[10]=_*Rt+b*B+M*z+W*Q,n.data[11]=p*Rt+S*B+R*z+U*Q,n.data[12]=h*tt+v*Gt+P*at+T*Si,n.data[13]=c*tt+x*Gt+I*at+F*Si,n.data[14]=_*tt+b*Gt+M*at+W*Si,n.data[15]=p*tt+S*Gt+R*at+U*Si;const hs=this.getScale();return n._scaleSignX=qt(hs.x)*qt(n._scaleSignX),n._scaleSignY=qt(hs.y)*qt(n._scaleSignY),n}}translate(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],_=this.data[4],p=this.data[5],v=this.data[6],x=this.data[7],b=this.data[8],S=this.data[9],P=this.data[10],I=this.data[11],M=this.data[12],R=this.data[13],T=this.data[14],F=this.data[15],W=0,U=1;return this.data[12]=n*t+_*i+b*W+M*U,this.data[13]=o*t+p*i+S*W+R*U,this.data[14]=h*t+v*i+P*W+T*U,this.data[15]=c*t+x*i+I*W+F*U,this}setPosition(t,i){this.data[12]=t,this.data[13]=i}getPosition(){return G(this.data[12],this.data[13])}rotate(t){const i=this.data[0],n=this.data[1],o=this.data[2],h=this.data[3],c=this.data[4],_=this.data[5],p=this.data[6],v=this.data[7],x=Math.sin(t),b=Math.cos(t);return this.data[0]=b*i+x*c,this.data[1]=b*n+x*_,this.data[2]=b*o+x*p,this.data[3]=b*h+x*v,this.data[4]=b*c-x*i,this.data[5]=b*_-x*n,this.data[6]=b*p-x*o,this.data[7]=b*v-x*h,this}scale(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],_=this.data[4],p=this.data[5],v=this.data[6],x=this.data[7];return this.data[0]=n*t,this.data[1]=o*t,this.data[2]=h*t,this.data[3]=c*t,this.data[4]=_*i,this.data[5]=p*i,this.data[6]=v*i,this.data[7]=x*i,this}setRotation(t){const i=this.getScale(),n=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=n*i.y,this.data[4]=-n*i.x,this.data[5]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return Ps(t)}getScaleX(){const t=G(this.data[0],this.data[4]).magnitude;return this._scaleSignX*t}getScaleY(){const t=G(this.data[1],this.data[5]).magnitude;return this._scaleSignY*t}getScale(){return G(this.getScaleX(),this.getScaleY())}setScaleX(t){if(this._scaleX===t)return;this._scaleSignX=qt(t);const i=G(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[4]=i.y*t,this._scaleX=t}setScaleY(t){if(this._scaleY===t)return;this._scaleSignY=qt(t);const i=G(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[5]=i.y*t,this._scaleY=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(t){const n=1/this.getBasisDeterminant(),o=this.data[0],h=this.data[4],c=this.data[1],_=this.data[5],p=t||fi.identity();p.data[0]=_*n,p.data[1]=-c*n,p.data[4]=-h*n,p.data[5]=o*n;const v=this.data[12],x=this.data[13];return p.data[12]=-(v*p.data[0]+x*p.data[4]),p.data[13]=-(v*p.data[1]+x*p.data[5]),p}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class me{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const t=new me;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}static translation(t,i){const n=me.identity();return n.data[4]=t,n.data[5]=i,n}static scale(t,i){const n=me.identity();return n.data[0]=t,n.data[3]=i,n._scale[0]=t,n._scale[1]=i,n}static rotation(t){const i=me.identity();return i.data[0]=Math.cos(t),i.data[1]=Math.sin(t),i.data[2]=-Math.sin(t),i.data[3]=Math.cos(t),i}setPosition(t,i){this.data[4]=t,this.data[5]=i}getPosition(){return G(this.data[4],this.data[5])}rotate(t){const i=this.data[0],n=this.data[1],o=this.data[2],h=this.data[3],c=Math.sin(t),_=Math.cos(t);return this.data[0]=_*i+c*o,this.data[1]=_*n+c*h,this.data[2]=_*o-c*i,this.data[3]=_*h-c*n,this}translate(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],_=this.data[4],p=this.data[5];return this.data[4]=n*t+h*i+_,this.data[5]=o*t+c*i+p,this}scale(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3];return this.data[0]=n*t,this.data[1]=o*t,this.data[2]=h*i,this.data[3]=c*i,this._scale[0]=t,this._scale[1]=i,this._scaleSignX=qt(t),this._scaleSignY=qt(i),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(t){const i=this.determinant();let n=i;i!==0&&(n=1/i);const o=this.data[0],h=this.data[2],c=this.data[1],_=this.data[3],p=t||me.identity();p.data[0]=_*n,p.data[1]=-c*n,p.data[2]=-h*n,p.data[3]=o*n;const v=this.data[4],x=this.data[5];return p.data[4]=-(v*p.data[0]+x*p.data[2]),p.data[5]=-(v*p.data[1]+x*p.data[3]),p}multiply(t,i){if(t instanceof k){const n=i||new k(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[2]+this.data[4],c=o.x*this.data[1]+o.y*this.data[3]+this.data[5];return n.x=h,n.y=c,n}else{const n=i||new me,o=t,h=this.data[0],c=this.data[1],_=this.data[2],p=this.data[3],v=this.data[4],x=this.data[5],b=o.data[0],S=o.data[1],P=o.data[2],I=o.data[3],M=o.data[4],R=o.data[5];n.data[0]=h*b+_*S,n.data[1]=c*b+p*S,n.data[2]=h*P+_*I,n.data[3]=c*P+p*I,n.data[4]=h*M+_*R+v,n.data[5]=c*M+p*R+x;const T=this._scaleSignX,F=this._scaleSignY;return n._scaleSignX=T*qt(n._scaleSignX),n._scaleSignY=F*qt(n._scaleSignY),n}}multiplyQuadInPlace(t){const i=t[0]*this.data[0]+t[1]*this.data[2]+this.data[4],n=t[0]*this.data[1]+t[1]*this.data[3]+this.data[5];t[0]=i,t[1]=n;const o=t[2]*this.data[0]+t[3]*this.data[2]+this.data[4],h=t[2]*this.data[1]+t[3]*this.data[3]+this.data[5];t[2]=o,t[3]=h;const c=t[4]*this.data[0]+t[5]*this.data[2]+this.data[4],_=t[4]*this.data[1]+t[5]*this.data[3]+this.data[5];t[4]=c,t[5]=_;const p=t[6]*this.data[0]+t[7]*this.data[2]+this.data[4],v=t[6]*this.data[1]+t[7]*this.data[3]+this.data[5];t[6]=p,t[7]=v}to4x4(){const t=new fi;return t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=0,t.data[3]=0,t.data[4]=this.data[2],t.data[5]=this.data[3],t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=this.data[4],t.data[13]=this.data[5],t.data[14]=0,t.data[15]=1,t}setRotation(t){const i=this.getScale(),n=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=n*i.y,this.data[2]=-n*i.x,this.data[3]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return Ps(t)}getScaleX(){const t=this.data[0]*this.data[0]+this.data[2]*this.data[2];return t===1?this._scaleSignX:this._scaleSignX*Math.sqrt(t)}getScaleY(){const t=this.data[1]*this.data[1]+this.data[3]*this.data[3];return t===1?this._scaleSignY:this._scaleSignY*Math.sqrt(t)}getScale(){return G(this.getScaleX(),this.getScaleY())}setScaleX(t){if(t===this._scale[0])return;this._scaleSignX=qt(t);const i=G(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[2]=i.y*t,this._scale[0]=t}setScaleY(t){if(t===this._scale[1])return;this._scaleSignY=qt(t);const i=G(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[3]=i.y*t,this._scale[1]=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}clone(t){const i=t||new me;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i._scaleSignX=this._scaleSignX,i._scaleSignY=this._scaleSignY,i}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}let io=class{constructor(t,i,n=1){this.builder=t,this.cleaner=i,this._pool=[],this._size=0,this.grow(n)}grow(t){if(t>0){this._size+=t;for(let i=0;i<t;i++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}};class Em{constructor(){this._pool=new io(()=>me.identity(),t=>t.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(t,i){return this._currentTransform.translate(t,i)}rotate(t){return this._currentTransform.rotate(t)}scale(t,i){return this._currentTransform.scale(t,i)}reset(){this._currentTransform.reset()}set current(t){this._currentTransform=t}get current(){return this._currentTransform}}class Im{constructor(){this.opacity=1,this.z=0,this.tint=K.White,this.material=null}}class of{constructor(){this._pool=new io(()=>new Im,t=>(t.opacity=1,t.z=0,t.tint=K.White,t.material=null,t),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(t){var i;return t.opacity=this.current.opacity,t.z=this.current.z,t.tint=(i=this.current.tint)===null||i===void 0?void 0:i.clone(),t.material=this.current.material,t}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const Rm={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class so{constructor(t,i,n=!1){this.path=t,this.responseType=i,this.bustCache=n,this.data=null,this.logger=dt.getInstance(),this.events=new $t}isLoaded(){return this.data!==null}_cacheBust(t){return/\?\w*=\w*/.test(t)?t+="&__="+Date.now():t+="?__="+Date.now(),t}load(){return new Promise((t,i)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),t(this.data);return}const n=new XMLHttpRequest;n.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),n.responseType=this.responseType,n.addEventListener("loadstart",o=>this.events.emit("loadstart",o)),n.addEventListener("progress",o=>this.events.emit("progress",o)),n.addEventListener("error",o=>this.events.emit("error",o)),n.addEventListener("load",o=>this.events.emit("load",o)),n.addEventListener("load",()=>{if(n.status!==0&&n.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",n.status),this.events.emit("error",n.response),i(new Error(n.statusText));return}if(n.response instanceof Blob&&n.response.type==="text/html"){const o=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",n.response),i(new Error(o));return}this.data=n.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),t(this.data)}),n.send()})}}function Li(d,t){return d&&(d.__isProxy===void 0?new Proxy(d,{set:(i,n,o)=>(i[n]!==o&&(i[n]=o,typeof n=="string"&&n[0]!=="_"&&t(i)),!0),get:(i,n)=>n!=="__isProxy"?i[n]:!0}):d)}const af=(d=[],t,i)=>({get:(n,o)=>o==="__isProxy"?!0:typeof n[o]=="object"&&n[o]!=null?new Proxy(n[o],af([...d,o],t,i)):n[o],set:(n,o,h)=>(typeof o=="string"&&o[0]!=="_"&&t(i),n[o]=h,!0)});function Dm(d,t){return d&&(d.__isProxy===void 0?new Proxy(d,af([],t,d)):d)}class oe{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(t){this._flipHorizontal=t,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(t){this._flipVertical=t,this._transformStale=!0}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._transformStale=!0}get scale(){return this._scale}set scale(t){this._scale=Li(t,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(t){t&&(this._origin=Li(t,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(t){var i,n,o,h,c,_,p;this.id=oe._ID++,this.transform=me.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=k.One,this._width=0,this._height=0,t&&(this.origin=(i=t.origin)!==null&&i!==void 0?i:this.origin,this.flipHorizontal=(n=t.flipHorizontal)!==null&&n!==void 0?n:this.flipHorizontal,this.flipVertical=(o=t.flipVertical)!==null&&o!==void 0?o:this.flipVertical,this.rotation=(h=t.rotation)!==null&&h!==void 0?h:this.rotation,this.opacity=(c=t.opacity)!==null&&c!==void 0?c:this.opacity,this.scale=(_=t.scale)!==null&&_!==void 0?_:this.scale,this.tint=(p=t.tint)!==null&&p!==void 0?p:this.tint,t.width&&(this._width=t.width),t.height&&(this._height=t.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(t){this._width=t,this._transformStale=!0}set height(t){this._height=t,this._transformStale=!0}get localBounds(){return ct.fromDimension(this.width,this.height,k.Zero)}draw(t,i,n){this._preDraw(t,i,n),this._drawImage(t,0,0),this._postDraw(t)}_preDraw(t,i,n){t.save(),t.translate(i,n),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),t.multiply(this.transform),t.opacity=t.opacity*this.opacity,this.tint&&(t.tint=this.tint)}_rotate(t){var i;const n=this.scale.x>0?1:-1,o=this.scale.y>0?1:-1,h=(i=this.origin)!==null&&i!==void 0?i:G(this.width/2,this.height/2);t.translate(h.x,h.y),t.rotate(this.rotation),t.scale(n,o),t.translate(-h.x,-h.y)}_flip(t){this.flipHorizontal&&(t.translate(this.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,this.height/this.scale.y),t.scale(1,-1))}_postDraw(t){this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore()}}oe._ID=0;class Ui extends oe{static from(t,i){return new Ui({image:t,...i})}constructor(t){var i,n;super(t),this._logger=dt.getInstance(),this._dirty=!0,this.image=t.image;const{width:o,height:h}=t;this.sourceView=(i=t.sourceView)!==null&&i!==void 0?i:{x:0,y:0,width:o??0,height:h??0},this.destSize=(n=t.destSize)!==null&&n!==void 0?n:{width:o??0,height:h??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(t){t/=Math.abs(this.scale.x),this.destSize.width=t,super.width=Math.ceil(this.destSize.width)}set height(t){t/=Math.abs(this.scale.y),this.destSize.height=t,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var t,i,n,o,h,c;const{width:_,height:p}=this.image;this.sourceView.width=((t=this.sourceView)===null||t===void 0?void 0:t.width)||_,this.sourceView.height=((i=this.sourceView)===null||i===void 0?void 0:i.height)||p,this.destSize.width=((n=this.destSize)===null||n===void 0?void 0:n.width)||((o=this.sourceView)===null||o===void 0?void 0:o.width)||_,this.destSize.height=((h=this.destSize)===null||h===void 0?void 0:h.height)||((c=this.sourceView)===null||c===void 0?void 0:c.height)||p,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(t,i,n){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(t,i,n)}_drawImage(t,i,n){this.image.isLoaded()?t.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,i,n,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new Ui({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var we;(function(d){d.Pixel="Pixel",d.Blended="Blended"})(we||(we={}));function cr(d){switch(d){case we.Pixel:return we.Pixel;case we.Blended:return we.Blended;default:return}}var Jt;(function(d){d.Clamp="Clamp",d.Repeat="Repeat",d.Mirror="Mirror"})(Jt||(Jt={}));function Hi(d){switch(d){case Jt.Clamp:return Jt.Clamp;case Jt.Repeat:return Jt.Repeat;case Jt.Mirror:return Jt.Mirror;default:return Jt.Clamp}}class ne{constructor(t,i){var n;this._garbageCollector=i,this._textureMap=new Map,this._collect=o=>{var h;if(this._gl){const c=(h=o.dataset.originalSrc)!==null&&h!==void 0?h:o.constructor.name;return ne._LOGGER.debug(`WebGL Texture for ${c} collected`),this.delete(o),!0}return!1},this._gl=t,ne._MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),this._garbageCollector&&(ne._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(n=this._garbageCollector.garbageCollector)===null||n===void 0||n.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[t]of this._textureMap)this.delete(t);this._textureMap.clear(),this._gl=null}get(t){return this._textureMap.get(t)}has(t){return this._textureMap.has(t)}load(t,i,n=!1){var o,h;const c=this._gl;if(!c)return null;const{filtering:_,wrapping:p}={...i};let v=null;if(this.has(t)&&(v=this.get(t)),v)return n&&(c.bindTexture(c.TEXTURE_2D,v),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t)),(o=this._garbageCollector)===null||o===void 0||o.garbageCollector.touch(t),v;v=c.createTexture(),ne.checkImageSizeSupportedAndLog(t),c.bindTexture(c.TEXTURE_2D,v),c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let x;p&&(typeof p=="string"?x={x:p,y:p}:x={x:p.x,y:p.y});const{x:b,y:S}=x??ne.wrapping;switch(b){case Jt.Clamp:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);break;case Jt.Repeat:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT);break;case Jt.Mirror:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.MIRRORED_REPEAT);break;default:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE)}switch(S){case Jt.Clamp:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);break;case Jt.Repeat:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT);break;case Jt.Mirror:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.MIRRORED_REPEAT);break;default:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE)}const P=_??ne.filtering;return c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,P===we.Pixel?c.NEAREST:c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,P===we.Pixel?c.NEAREST:c.LINEAR),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t),this._textureMap.set(t,v),(h=this._garbageCollector)===null||h===void 0||h.garbageCollector.addCollectableResource("texture",t),v}delete(t){const i=this._gl;if(i&&this.has(t)){const n=this.get(t);n&&(this._textureMap.delete(t),i.deleteTexture(n))}}static checkImageSizeSupportedAndLog(t){var i;const n=(i=t.dataset.originalSrc)!==null&&i!==void 0?i:"internal canvas bitmap";return t.width>ne._MAX_TEXTURE_SIZE||t.height>ne._MAX_TEXTURE_SIZE?(ne._LOGGER.error(`The image [${n}] provided to Excalibur is too large for the device's maximum texture size of (${ne._MAX_TEXTURE_SIZE}x${ne._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((t.width>4096||t.height>4096)&&ne._LOGGER.warn(`The image [${n}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}ne._LOGGER=dt.getInstance();ne.filtering=we.Blended;ne.wrapping={x:Jt.Clamp,y:Jt.Clamp};ne._MAX_TEXTURE_SIZE=4096;const Mt={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class is{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(t,i,n){this._logger=dt.getInstance(),this.data=new Image,this._readyFuture=new bi,this.ready=this._readyFuture.promise,this.path=t;let o=!1,h;typeof i=="boolean"?o=i:{filtering:n,wrapping:h,bustCache:o}={...i},this._resource=new so(t,"blob",o),this.filtering=n??this.filtering,typeof h=="string"?this.wrapping={x:h,y:h}:this.wrapping=h??this.wrapping,t.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${t} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(t,i){const n=new is("");if(n._src="image-element",n.data=t,n.data.setAttribute("data-original-src","image-element"),i?.filtering?n.data.setAttribute(Mt.Filtering,i?.filtering):n.data.setAttribute(Mt.Filtering,we.Blended),i?.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},n.data.setAttribute(Mt.WrappingX,o.x),n.data.setAttribute(Mt.WrappingY,o.y)}else n.data.setAttribute(Mt.WrappingX,Jt.Clamp),n.data.setAttribute(Mt.WrappingY,Jt.Clamp);return ne.checkImageSizeSupportedAndLog(t),n._readyFuture.resolve(t),n}static fromHtmlCanvasElement(t,i){const n=new is("");if(n._src="canvas-element-blob",n.data.setAttribute("data-original-src","canvas-element-blob"),i?.filtering?n.data.setAttribute(Mt.Filtering,i?.filtering):n.data.setAttribute(Mt.Filtering,we.Blended),i?.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},n.data.setAttribute(Mt.WrappingX,o.x),n.data.setAttribute(Mt.WrappingY,o.y)}else n.data.setAttribute(Mt.WrappingX,Jt.Clamp),n.data.setAttribute(Mt.WrappingY,Jt.Clamp);return ne.checkImageSizeSupportedAndLog(t),t.toBlob(o=>{const h=URL.createObjectURL(o);n.image.onload=()=>{URL.revokeObjectURL(h),n.data=n.image,n._readyFuture.resolve(n.image)},n.image.src=h}),n}static fromSvgString(t,i){const n=new Blob([t],{type:"image/svg+xml"}),o=URL.createObjectURL(n);return new is(o,i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){var t,i,n,o;if(this.isLoaded())return this.data;try{let h;if(this.path.includes("data:image/"))h=this.path;else{const p=await this._resource.load();h=URL.createObjectURL(p)}const c=new Image,_=new bi;c.onload=()=>_.resolve(),c.src=h,c.setAttribute("data-original-src",this.path),await _.promise,this.data=c,ne.checkImageSizeSupportedAndLog(this.data)}catch(h){throw`Error loading ImageSource from path '${this.path}' with error [${h.message}]`}return this.data.setAttribute(Mt.Filtering,this.filtering),this.data.setAttribute(Mt.WrappingX,(i=(t=this.wrapping)===null||t===void 0?void 0:t.x)!==null&&i!==void 0?i:Jt.Clamp),this.data.setAttribute(Mt.WrappingY,(o=(n=this.wrapping)===null||n===void 0?void 0:n.y)!==null&&o!==void 0?o:Jt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(t){return Ui.from(this,t)}unload(){this.data=new Image}}class Ca extends oe{constructor(t){super(t),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=dt.getInstance();const{alphabet:i,spriteSheet:n,caseInsensitive:o,spacing:h,shadow:c,lineHeight:_}=t;this.alphabet=i,this.spriteSheet=n,this.caseInsensitive=o??this.caseInsensitive,this.spacing=h??this.spacing,this.shadow=c??this.shadow,this.lineHeight=_??this.lineHeight}_getCharacterSprites(t){const i=[],n=this.caseInsensitive?t.toLocaleLowerCase():t,o=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let h=0;h<n.length;h++){const c=n[h];let _=o.indexOf(c);_===-1&&(_=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${c}' in configured alphabet '${o}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const p=this.spriteSheet.sprites[_];p?i.push(p):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${c}' at index '${_}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return i}measureText(t,i){const n=this._getLinesFromText(t,i),o=n.reduce((p,v)=>p.length>v.length?p:v),h=this._getCharacterSprites(o);let c=0,_=0;for(const p of h)c+=p.width+this.spacing,_=Math.max(_,p.height);return ct.fromDimension(c*this.scale.x,_*n.length*this.scale.y,k.Zero)}_drawImage(t,i,n,o){var h;let c=0,_=0,p=0;const v=this._getLinesFromText(this._text,o);for(const x of v){for(const b of this._getCharacterSprites(x))b.draw(t,i+c,n+_),c+=b.width+this.spacing,p=Math.max(p,b.height);c=0,_+=(h=this.lineHeight)!==null&&h!==void 0?h:p}}render(t,i,n,o,h,c){this._text=i;const _=this.measureText(i,c);this.width=_.width,this.height=_.height,this.shadow&&(t.save(),t.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(t,o,h),this._drawImage(t,0,0,c),this._postDraw(t),t.restore()),this._preDraw(t,o,h),this._drawImage(t,0,0,c),this._postDraw(t)}clone(){return new Ca({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(t,i){var n;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let c=o[h],_="";if(this.measureText(c).width>i){for(;this.measureText(c).width>i;)_=c[c.length-1]+_,c=c.slice(0,-1);o[h]=c,o[h+1]=_}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class no extends Ui{constructor(t){super({image:t.image,sourceView:t.sourceView,destSize:{width:t.width,height:t.height},flipHorizontal:t.flipHorizontal,flipVertical:t.flipVertical,rotation:t.rotation,scale:t.scale,opacity:t.opacity,tint:t.tint,origin:t.origin}),this._ready=new bi,this.ready=this._ready.promise,this._options=t,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(t,i){return new no({sourceView:{...t.sourceView},width:t.width,height:t.height,...i,image:t.image})}_applyTiling(){const{width:t,height:i,filtering:n,wrapping:o}={...this._options},h=document.createElement("canvas");h.width=this.sourceView.width,h.height=this.sourceView.height,h.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const _=is.fromHtmlCanvasElement(h,{wrapping:o??Jt.Repeat,filtering:n});t&&(this.destSize.width=t,this.sourceView.width=t),i&&(this.destSize.height=i,this.sourceView.height=i),this.sourceView.x=0,this.sourceView.y=0,this.image=_,this.image.ready.then(()=>this._ready.resolve())}}class Pn{constructor(t){this.sprites=[];const{sprites:i,rows:n,columns:o}=t;this.sprites=i,this.rows=n??1,this.columns=o??this.sprites.length}getSprite(t,i,n){var o,h,c,_,p,v,x,b,S;if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const P=t+i*this.columns,I=this.sprites[P];if(I){if(n){const M=I.clone();return M.flipHorizontal=(o=n.flipHorizontal)!==null&&o!==void 0?o:M.flipHorizontal,M.flipVertical=(h=n.flipVertical)!==null&&h!==void 0?h:M.flipVertical,M.width=(c=n.width)!==null&&c!==void 0?c:M.width,M.height=(_=n.height)!==null&&_!==void 0?_:M.height,M.rotation=(p=n.rotation)!==null&&p!==void 0?p:M.rotation,M.scale=(v=n.scale)!==null&&v!==void 0?v:M.scale,M.opacity=(x=n.opacity)!==null&&x!==void 0?x:M.opacity,M.tint=(b=n.tint)!==null&&b!==void 0?b:M.tint,M.origin=(S=n.origin)!==null&&S!==void 0?S:M.origin,M}return I}throw Error(`Invalid sprite coordinates (${t}, ${i})`)}getTiledSprite(t,i,n){if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const o=t+i*this.columns,h=this.sprites[o];if(h)return no.fromSprite(h,n);throw Error(`Invalid sprite coordinates (${t}, ${i})`)}static fromImageSourceWithSourceViews(t){const i=t.sourceViews.map(n=>new Ui({image:t.image,sourceView:n}));return new Pn({sprites:i})}static fromImageSource(t){var i;const n=[];t.spacing=(i=t.spacing)!==null&&i!==void 0?i:{};const{image:o,grid:{rows:h,columns:c,spriteWidth:_,spriteHeight:p},spacing:{originOffset:v,margin:x}}=t,b={x:0,y:0,...v},S={x:0,y:0,...x};for(let P=0;P<c;P++)for(let I=0;I<h;I++)n[P+I*c]=new Ui({image:o,sourceView:{x:P*_+S.x*P+b.x,y:I*p+S.y*I+b.y,width:_,height:p},destSize:{height:p,width:_}});return new Pn({sprites:n,rows:h,columns:c})}clone(){return new Pn({sprites:this.sprites.map(t=>t.clone()),rows:this.rows,columns:this.columns})}}const Fm="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class Zl{constructor(){this.fontSheet=Fm,this.size=16,this.load()}load(){return this._imageSource=new is(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=Pn.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new Ca({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(t,i,n){this._imageSource.isLoaded()&&this._spriteFont.render(t,i,null,n.x,n.y)}}class Mm{constructor(t,i){this._gl=t,this._texture=i}use(){const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture)}disable(){const t=this._gl;t.bindTexture(t.TEXTURE_2D,null)}}class $o{constructor(t){var i,n;this.antialias=!1,this.samples=1,this._gl=t.gl,this.width=t.width,this.height=t.height,this.transparency=t.transparency,this.antialias=(i=t.antialias)!==null&&i!==void 0?i:this.antialias,this.samples=(n=t.samples)!==null&&n!==void 0?n:this._gl.getParameter(this._gl.MAX_SAMPLES);const o=this._gl;o.drawingBufferFormat?this.bufferFormat=o.drawingBufferFormat:this.transparency?this.bufferFormat=o.RGBA8:this.bufferFormat=o.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(t,i){const n=this._gl;this.width=t,this.height=i,n.bindTexture(n.TEXTURE_2D,this._frameTexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.width,this.height,0,n.RGBA,n.UNSIGNED_BYTE,null),this._renderBuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,this._renderBuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,Math.min(this.samples,n.getParameter(n.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const t=this._gl;this._renderBuffer=t.createRenderbuffer(),this._renderFrameBuffer=t.createFramebuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._renderBuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,Math.min(this.samples,t.getParameter(t.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const t=this._gl;this._frameTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._frameTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const i=t.COLOR_ATTACHMENT0;this._frameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,i,t.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new Mm(this._gl,this._frameTexture)}blitToScreen(){const t=this._gl;this._renderBuffer?(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)):(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.frameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const t=this._gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.frameBuffer),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)}}copyToTexture(t){const i=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this._frameBuffer),i.bindTexture(i.TEXTURE_2D,t),i.copyTexImage2D(i.TEXTURE_2D,0,i.RGBA,0,0,this.width,this.height,0)}use(){const t=this._gl;this.antialias?t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.viewport(0,0,this.width,this.height)}disable(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null)}}const Bm=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,km=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function yl(d,t){switch(t){case d.INT:case d.UNSIGNED_INT:case d.FLOAT:return 4;case d.SHORT:return 2;case d.UNSIGNED_SHORT:return 2;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;default:return 1}}function hf(d,t){const i=`(?<type>[a-z0-9]+)\\s+${t};`,o=new RegExp(i,"g").exec(d);return o?.length>0}function lf(d,t,i){var n;const o=`(?<type>[a-z0-9]+)\\s+${i};`,c=new RegExp(o,"g").exec(t);switch((n=c?.groups)===null||n===void 0?void 0:n.type){case"float":case"vec2":case"vec3":case"vec4":return d.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return d.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return d.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return d.BOOL;case"short":return d.SHORT;case"ushort":return d.UNSIGNED_SHORT;case"ubyte":return d.UNSIGNED_BYTE;case"byte":return d.BYTE;default:return d.FLOAT}}function cf(d,t){switch(t){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:return 1;case d.FLOAT_VEC2:return 2;case d.FLOAT_VEC3:return 3;case d.FLOAT_VEC4:return 4;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;case d.UNSIGNED_SHORT:case d.SHORT:return 1;default:return 1}}function df(d,t){switch(t){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:case d.FLOAT_VEC2:case d.FLOAT_VEC3:case d.FLOAT_VEC4:return d.FLOAT;case d.BYTE:return d.BYTE;case d.UNSIGNED_BYTE:return d.UNSIGNED_BYTE;case d.SHORT:return d.SHORT;case d.UNSIGNED_SHORT:return d.UNSIGNED_SHORT;default:return d.FLOAT}}function Ql(d,t){const i=o=>{const h=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let c="";for(let _=0;_<o;_++)_===0?c+=`if (index <= ${_}.5) {
`:c+=`   else if (index <= ${_}.5) {
`,c+=`      fragColor = vec4(1.0);
`,c+=`   }
`;return h.replace("%%complexity%%",c)};let n=!1;do{const o=i(t),h=d.createShader(d.FRAGMENT_SHADER);d.shaderSource(h,o),d.compileShader(h),n=d.getShaderParameter(h,d.COMPILE_STATUS),n||(t=t/2|0)}while(!n);return t}class hi{get compiled(){return this._compiled}constructor(t){this._logger=dt.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:i,vertexSource:n,fragmentSource:o,onPreLink:h,onPostCompile:c}=t;this._gl=i,this.vertexSource=n,this.fragmentSource=o,this._onPreLink=h,this._onPostCompile=c}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),hi._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return hi._ACTIVE_SHADER_INSTANCE===this}compile(){const t=this._gl,i=this._compileShader(t,this.vertexSource,t.VERTEX_SHADER),n=this._compileShader(t,this.fragmentSource,t.FRAGMENT_SHADER);this.program=this._createProgram(t,i,n);const o=this.getAttributes();for(const c of o)this.attributes[c.name]=c;const h=this.getUniforms();for(const c of h)this.uniforms[c.name]=c;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS),n=[];for(let o=0;o<i;o++){const h=t.getActiveUniform(this.program,o),c=t.getUniformLocation(this.program,h.name);n.push({name:h.name,glType:h.type,location:c})}return n}getAttributes(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES),n=[];for(let o=0;o<i;o++){const h=t.getActiveAttrib(this.program,o),c=t.getAttribLocation(this.program,h.name);n.push({name:h.name,glType:df(t,h.type),size:cf(t,h.type),location:c,normalized:!1})}return n}setTexture(t,i){const n=this._gl;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,i)}setUniformInt(t,i){this.setUniform("uniform1i",t,~~i)}trySetUniformInt(t,i){return this.trySetUniform("uniform1i",t,~~i)}setUniformIntArray(t,i){this.setUniform("uniform1iv",t,i)}trySetUniformIntArray(t,i){return this.trySetUniform("uniform1iv",t,i)}setUniformBoolean(t,i){this.setUniform("uniform1i",t,i?1:0)}trySetUniformBoolean(t,i){return this.trySetUniform("uniform1i",t,i?1:0)}setUniformFloat(t,i){this.setUniform("uniform1f",t,i)}trySetUniformFloat(t,i){return this.trySetUniform("uniform1f",t,i)}setUniformFloatArray(t,i){this.setUniform("uniform1fv",t,i)}trySetUniformFloatArray(t,i){return this.trySetUniform("uniform1fv",t,i)}setUniformFloatVector(t,i){this.setUniform("uniform2f",t,i.x,i.y)}trySetUniformFloatVector(t,i){return this.trySetUniform("uniform2f",t,i.x,i.y)}setUniformFloatColor(t,i){this.setUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}trySetUniformFloatColor(t,i){return this.trySetUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}setUniformMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,i.data)}setUniformAffineMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,[i.data[0],i.data[1],0,0,i.data[2],i.data[3],0,0,0,0,1,0,i.data[4],i.data[5],0,1])}trySetUniformMatrix(t,i){return this.trySetUniform("uniformMatrix4fv",t,!1,i.data)}setUniform(t,i,...n){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${t}:${i}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const h=this._gl.getUniformLocation(this.program,i);if(h){const c=[h,...n];this._gl[t].apply(this._gl,c)}else throw Error(`Uniform ${t}:${i} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(t,i,...n){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${t}:${i}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const h=this._gl.getUniformLocation(this.program,i);if(h){const c=[h,...n];this._gl[t].apply(this._gl,c)}else return!1;return!0}_createProgram(t,i,n){const o=t.createProgram();if(o===null)throw Error("Could not create graphics shader program");if(t.attachShader(o,i),t.attachShader(o,n),this._onPreLink&&this._onPreLink(o),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw Error(`Could not link the program: [${t.getProgramInfoLog(o)}]`);return o}_compileShader(t,i,n){const o=t.VERTEX_SHADER===n?"vertex":"fragment",h=t.createShader(n);if(h===null)throw Error(`Could not build shader: [${i}]`);if(t.shaderSource(h,i),t.compileShader(h),!t.getShaderParameter(h,t.COMPILE_STATUS)){const _=t.getShaderInfoLog(h);throw Error(`Could not compile ${o} shader:

${_}${this._processSourceForError(i,_)}`)}return h}_processSourceForError(t,i){if(!t)return i;const n=t.split(`
`),o=i.search(/\d:\d/),h=i.indexOf(" ",o),[c,_]=i.slice(o,h).split(":").map(p=>Number(p));for(let p=0;p<n.length;p++)n[p]=`${p+1}: ${n[p]}${_===p+1?" <----- ERROR!":""}`;return`

Source:
`+n.join(`
`)}}hi._ACTIVE_SHADER_INSTANCE=null;class rs{constructor(t){this.type="dynamic";const{gl:i,size:n,type:o,data:h}=t;if(this._gl=i,this.buffer=this._gl.createBuffer(),!h&&!n)throw Error("Must either provide data or a size to the VertexBuffer");h?this.bufferData=h:this.bufferData=new Float32Array(n),this.type=o??this.type,i.bindBuffer(i.ARRAY_BUFFER,this.buffer),i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this.buffer)}unbind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,null)}upload(t){const i=this._gl;i.bindBuffer(i.ARRAY_BUFFER,this.buffer),t?i.bufferSubData(i.ARRAY_BUFFER,0,this.bufferData,0,t):i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class Fs{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(t){this._logger=dt.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:i,shader:n,vertexBuffer:o,attributes:h,suppressWarnings:c}=t;this._gl=i,this._vertexBuffer=o,this._attributes=h,this._shader=n,this._suppressWarnings=c,n&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(t){t&&this._shader!==t&&(this._shader=t,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const t=this._shader.attributes;for(const h of this._attributes){const c=t[h[0]];if(!c){if(!hf(this._shader.vertexSource,h[0]))throw Error(`The attribute named: ${h[0]} size ${h[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${h[0]} size ${h[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${h[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${h[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const _=lf(this._gl,this._shader.vertexSource,h[0]);this._layout.push({name:h[0],glType:_,size:h[1],location:-1,normalized:!1})}if(c){if(c.size!==h[1])throw Error(`VertexLayout size definition for attribute: [${h[0]}, ${h[1]}], doesn't match shader source size ${c.size}:
 ${this._shader.vertexSource}`);this._layout.push(c)}}let i=0;for(const h of this._layout){const c=yl(this._gl,h.glType);this._vertexTotalSizeBytes+=c*h.size,i+=h.size}this._vertexBuffer.bufferData.length%i!==0&&this._logger.warn(`The vertex component size (${i})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const n=this._gl;this._vao=n.createVertexArray(),n.bindVertexArray(this._vao),this._vertexBuffer.bind();let o=0;for(const h of this._layout)h.location!==-1&&(h.glType===n.INT?n.vertexAttribIPointer(h.location,h.size,h.glType,this.totalVertexSizeBytes,o):n.vertexAttribPointer(h.location,h.size,h.glType,h.normalized,this.totalVertexSizeBytes,o),n.enableVertexAttribArray(h.location)),o+=yl(n,h.glType)*h.size;n.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(t=!1,i){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const n=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),t&&this._vertexBuffer.upload(i),n.bindVertexArray(this._vao)}}class Kt{static clear(){Kt.DrawCallCount=0,Kt.DrawnImagesCount=0}}Kt.DrawCallCount=0;Kt.DrawnImagesCount=0;class Lm{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=G(0,0),this._endScratch=G(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new hi({gl:t,vertexSource:Bm,fragmentSource:km}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new rs({gl:t,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new Fs({gl:t,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,n){this._isFull()&&this.flush(),this._lineCount++;const o=this._context.getTransform(),h=o.multiply(t,this._startScratch),c=o.multiply(i,this._endScratch),_=this._vertexBuffer.bufferData;_[this._vertexIndex++]=h.x,_[this._vertexIndex++]=h.y,_[this._vertexIndex++]=n.r/255,_[this._vertexIndex++]=n.g/255,_[this._vertexIndex++]=n.b/255,_[this._vertexIndex++]=n.a,_[this._vertexIndex++]=c.x,_[this._vertexIndex++]=c.y,_[this._vertexIndex++]=n.r/255,_[this._vertexIndex++]=n.g/255,_[this._vertexIndex++]=n.b/255,_[this._vertexIndex++]=n.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.LINES,0,this._lineCount*2),Kt.DrawnImagesCount+=this._lineCount,Kt.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const Um=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,zm=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class Hm{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new hi({gl:t,vertexSource:Um,fragmentSource:zm}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new rs({gl:t,size:7*this._maxPoints,type:"dynamic"}),this._layout=new Fs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,n){this._isFull()&&this.flush(),this._pointCount++;const o=this._context.getTransform(),h=this._context.opacity,c=this._context.snapToPixel,_=o.multiply(t);c&&(_.x=~~(_.x+pt),_.y=~~(_.y+pt));const p=this._buffer.bufferData;p[this._vertexIndex++]=_.x,p[this._vertexIndex++]=_.y,p[this._vertexIndex++]=i.r/255,p[this._vertexIndex++]=i.g/255,p[this._vertexIndex++]=i.b/255,p[this._vertexIndex++]=i.a*h,p[this._vertexIndex++]=n*Math.max(o.getScaleX(),o.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.POINTS,0,this._pointCount),Kt.DrawnImagesCount+=this._pointCount,Kt.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const Om=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,Wm=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class Nm{constructor(t){this._gl=t,this._shader=new hi({gl:t,vertexSource:Om,fragmentSource:Wm}),this._shader.compile(),this._buffer=new rs({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Fs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(t){const i=this._gl,n=t.getShader();n.use(),t.getLayout().use(),i.activeTexture(i.TEXTURE0),n.trySetUniformInt("u_image",0),t.onDraw&&t.onDraw(),i.drawArrays(i.TRIANGLES,0,6)}renderToScreen(){const t=this._gl;this._shader.use(),this._layout.use(),t.drawArrays(t.TRIANGLES,0,6)}}class ro{constructor(t,i,n){this._logger=dt.getInstance(),this._gl=t,this.buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer);const o=i*6;if(!n)this.bufferData=new Uint32Array(o);else{const _=Math.floor(16383.5);this.bufferGlType=t.UNSIGNED_SHORT,this.bufferData=new Uint16Array(o),i>_&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${_}) requested quads(${i})`)}let h=0;for(let c=0;c<o;c+=6)this.bufferData[c+0]=h+0,this.bufferData[c+1]=h+1,this.bufferData[c+2]=h+2,this.bufferData[c+3]=h+2,this.bufferData[c+4]=h+1,this.bufferData[c+5]=h+3,h+=4;t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const Gm=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,Vm=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class Xm{constructor(t){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=K.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=Ql(t,n);this._maxTextures=Math.min(n,o);const h=this._transformFragmentSource(Gm,this._maxTextures);this._shader=new hi({gl:t,fragmentSource:h,vertexSource:Vm}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((c,_)=>_)),this._buffer=new rs({gl:t,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new Fs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new ro(t,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let n=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_textureIndex <= ${h}.5) {
`:o+=`   else if (v_textureIndex <= ${h}.5) {
`,o+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return n=n.replace("%%texture_picker%%",o),n}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(Mt.Filtering),n=i?cr(i):void 0,o=Hi(t.getAttribute(Mt.WrappingX)),h=Hi(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&(this._textures.push(_),this._textureToIndex.set(_,this._textureIndex++),this._images.add(t))}_bindTextures(t){for(let i=0;i<this._maxTextures;i++)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,this._textures[i]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const n=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(n))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,n,o,h,c,_,p,v){var x,b,S,P;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const I=this._getImageWidth(t),M=this._getImageHeight(t);let R=I||o||0,T=M||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(x=o??I)!==null&&x!==void 0?x:0,this._view[3]=(b=h??M)!==null&&b!==void 0?b:0,this._dest[0]=i??1,this._dest[1]=n??1,c!==void 0&&_!==void 0&&p!==void 0&&v!==void 0&&(this._view[0]=i??1,this._view[1]=n??1,this._view[2]=(S=o??I)!==null&&S!==void 0?S:0,this._view[3]=(P=h??M)!==null&&P!==void 0?P:0,this._dest[0]=c,this._dest[1]=_,R=p,T=v),i=this._view[0],n=this._view[1];const F=this._view[2],W=this._view[3],U=this._context.getTransform(),V=this._context.opacity,j=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+R,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+T,this._quad[6]=this._dest[0]+R,this._quad[7]=this._dest[1]+T,U.multiplyQuadInPlace(this._quad),j&&(this._quad[0]=~~(this._quad[0]+qt(this._quad[0])*pt),this._quad[1]=~~(this._quad[1]+qt(this._quad[1])*pt),this._quad[2]=~~(this._quad[2]+qt(this._quad[2])*pt),this._quad[3]=~~(this._quad[3]+qt(this._quad[3])*pt),this._quad[4]=~~(this._quad[4]+qt(this._quad[4])*pt),this._quad[5]=~~(this._quad[5]+qt(this._quad[5])*pt),this._quad[6]=~~(this._quad[6]+qt(this._quad[6])*pt),this._quad[7]=~~(this._quad[7]+qt(this._quad[7])*pt));const X=this._context.tint||this._defaultTint,rt=this._getTextureIdForImage(t),lt=I||R,xt=M||T,mt=(i+this.uvPadding)/lt,Ct=(n+this.uvPadding)/xt,Rt=(i+F-this.uvPadding)/lt,B=(n+W-this.uvPadding)/xt,z=I,Q=M,tt=this._layout.vertexBuffer.bufferData;tt[this._vertexIndex++]=this._quad[0],tt[this._vertexIndex++]=this._quad[1],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=mt,tt[this._vertexIndex++]=Ct,tt[this._vertexIndex++]=rt,tt[this._vertexIndex++]=X.r/255,tt[this._vertexIndex++]=X.g/255,tt[this._vertexIndex++]=X.b/255,tt[this._vertexIndex++]=X.a,tt[this._vertexIndex++]=this._quad[4],tt[this._vertexIndex++]=this._quad[5],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=mt,tt[this._vertexIndex++]=B,tt[this._vertexIndex++]=rt,tt[this._vertexIndex++]=X.r/255,tt[this._vertexIndex++]=X.g/255,tt[this._vertexIndex++]=X.b/255,tt[this._vertexIndex++]=X.a,tt[this._vertexIndex++]=this._quad[2],tt[this._vertexIndex++]=this._quad[3],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=Rt,tt[this._vertexIndex++]=Ct,tt[this._vertexIndex++]=rt,tt[this._vertexIndex++]=X.r/255,tt[this._vertexIndex++]=X.g/255,tt[this._vertexIndex++]=X.b/255,tt[this._vertexIndex++]=X.a,tt[this._vertexIndex++]=this._quad[6],tt[this._vertexIndex++]=this._quad[7],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=Rt,tt[this._vertexIndex++]=B,tt[this._vertexIndex++]=rt,tt[this._vertexIndex++]=X.r/255,tt[this._vertexIndex++]=X.g/255,tt[this._vertexIndex++]=X.b/255,tt[this._vertexIndex++]=X.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),this._quads.bind(),t.drawElements(t.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),Kt.DrawnImagesCount+=this._imageCount,Kt.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const qm=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,Ym=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class jm{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=K.Transparent,this._scratch1=G(0,0),this._scratch2=G(0,0),this._scratch3=G(0,0),this._scratch4=G(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new hi({gl:t,fragmentSource:qm,vertexSource:Ym}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new rs({gl:t,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new Fs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new ro(t,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...t){t[0]instanceof k&&t[1]instanceof k?this.drawLine.apply(this,t):this.drawRectangle.apply(this,t)}drawLine(t,i,n,o=1){this._isFull()&&this.flush(),this._rectangleCount++;const h=this._context.getTransform(),c=this._context.opacity,_=this._context.snapToPixel,p=i.sub(t),v=p.magnitude,x=p.normalize().perpendicular(),b=o/2,S=h.multiply(x.scale(b,this._scratch1).add(t,this._scratch1),this._scratch1),P=h.multiply(x.scale(-b,this._scratch2).add(t,this._scratch2),this._scratch2),I=h.multiply(x.scale(b,this._scratch3).add(i,this._scratch3),this._scratch3),M=h.multiply(x.scale(-b,this._scratch4).add(i,this._scratch4),this._scratch4);_&&(S.x=~~(S.x+pt),S.y=~~(S.y+pt),I.x=~~(I.x+pt),I.y=~~(I.y+pt),P.x=~~(P.x+pt),P.y=~~(P.y+pt),M.x=~~(M.x+pt),M.y=~~(M.y+pt));const R=0,T=0,F=1,W=1,U=this._transparent,V=0,j=1,X=this._layout.vertexBuffer.bufferData;X[this._vertexIndex++]=S.x,X[this._vertexIndex++]=S.y,X[this._vertexIndex++]=R,X[this._vertexIndex++]=T,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=V/j,X[this._vertexIndex++]=P.x,X[this._vertexIndex++]=P.y,X[this._vertexIndex++]=R,X[this._vertexIndex++]=W,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=V/j,X[this._vertexIndex++]=I.x,X[this._vertexIndex++]=I.y,X[this._vertexIndex++]=F,X[this._vertexIndex++]=T,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=V/j,X[this._vertexIndex++]=M.x,X[this._vertexIndex++]=M.y,X[this._vertexIndex++]=F,X[this._vertexIndex++]=W,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=V/j}drawRectangle(t,i,n,o,h=K.Transparent,c=0){this._isFull()&&this.flush(),this._rectangleCount++;const _=this._context.getTransform(),p=this._context.opacity,v=this._context.snapToPixel,x=_.multiply(t.add(G(0,0))),b=_.multiply(t.add(G(i,0))),S=_.multiply(t.add(G(i,n))),P=_.multiply(t.add(G(0,n)));v&&(x.x=~~(x.x+pt),x.y=~~(x.y+pt),b.x=~~(b.x+pt),b.y=~~(b.y+pt),P.x=~~(P.x+pt),P.y=~~(P.y+pt),S.x=~~(S.x+pt),S.y=~~(S.y+pt));const I=0,M=0,R=1,T=1,F=this._layout.vertexBuffer.bufferData;F[this._vertexIndex++]=x.x,F[this._vertexIndex++]=x.y,F[this._vertexIndex++]=I,F[this._vertexIndex++]=M,F[this._vertexIndex++]=i,F[this._vertexIndex++]=n,F[this._vertexIndex++]=p,F[this._vertexIndex++]=o.r/255,F[this._vertexIndex++]=o.g/255,F[this._vertexIndex++]=o.b/255,F[this._vertexIndex++]=o.a,F[this._vertexIndex++]=h.r/255,F[this._vertexIndex++]=h.g/255,F[this._vertexIndex++]=h.b/255,F[this._vertexIndex++]=h.a,F[this._vertexIndex++]=c,F[this._vertexIndex++]=P.x,F[this._vertexIndex++]=P.y,F[this._vertexIndex++]=I,F[this._vertexIndex++]=T,F[this._vertexIndex++]=i,F[this._vertexIndex++]=n,F[this._vertexIndex++]=p,F[this._vertexIndex++]=o.r/255,F[this._vertexIndex++]=o.g/255,F[this._vertexIndex++]=o.b/255,F[this._vertexIndex++]=o.a,F[this._vertexIndex++]=h.r/255,F[this._vertexIndex++]=h.g/255,F[this._vertexIndex++]=h.b/255,F[this._vertexIndex++]=h.a,F[this._vertexIndex++]=c,F[this._vertexIndex++]=b.x,F[this._vertexIndex++]=b.y,F[this._vertexIndex++]=R,F[this._vertexIndex++]=M,F[this._vertexIndex++]=i,F[this._vertexIndex++]=n,F[this._vertexIndex++]=p,F[this._vertexIndex++]=o.r/255,F[this._vertexIndex++]=o.g/255,F[this._vertexIndex++]=o.b/255,F[this._vertexIndex++]=o.a,F[this._vertexIndex++]=h.r/255,F[this._vertexIndex++]=h.g/255,F[this._vertexIndex++]=h.b/255,F[this._vertexIndex++]=h.a,F[this._vertexIndex++]=c,F[this._vertexIndex++]=S.x,F[this._vertexIndex++]=S.y,F[this._vertexIndex++]=R,F[this._vertexIndex++]=T,F[this._vertexIndex++]=i,F[this._vertexIndex++]=n,F[this._vertexIndex++]=p,F[this._vertexIndex++]=o.r/255,F[this._vertexIndex++]=o.g/255,F[this._vertexIndex++]=o.b/255,F[this._vertexIndex++]=o.a,F[this._vertexIndex++]=h.r/255,F[this._vertexIndex++]=h.g/255,F[this._vertexIndex++]=h.b/255,F[this._vertexIndex++]=h.a,F[this._vertexIndex++]=c}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),Kt.DrawnImagesCount+=this._rectangleCount,Kt.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const Zm=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,Qm=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class Jm{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new hi({gl:t,fragmentSource:Zm,vertexSource:Qm}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new rs({gl:t,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new Fs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new ro(t,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(t,i,n,o=K.Transparent,h=0){this._isFull()&&this.flush(),this._circleCount++;const c=this._context.getTransform(),_=this._context.opacity,p=this._context.snapToPixel,v=c.multiply(t.add(G(-i,-i))),x=c.multiply(t.add(G(i,-i))),b=c.multiply(t.add(G(i,i))),S=c.multiply(t.add(G(-i,i)));p&&(v.x=~~(v.x+pt),v.y=~~(v.y+pt),x.x=~~(x.x+pt),x.y=~~(x.y+pt),S.x=~~(S.x+pt),S.y=~~(S.y+pt),b.x=~~(b.x+pt),b.y=~~(b.y+pt));const P=0,I=0,M=1,R=1,T=this._layout.vertexBuffer.bufferData;T[this._vertexIndex++]=v.x,T[this._vertexIndex++]=v.y,T[this._vertexIndex++]=P,T[this._vertexIndex++]=I,T[this._vertexIndex++]=_,T[this._vertexIndex++]=n.r/255,T[this._vertexIndex++]=n.g/255,T[this._vertexIndex++]=n.b/255,T[this._vertexIndex++]=n.a,T[this._vertexIndex++]=o.r/255,T[this._vertexIndex++]=o.g/255,T[this._vertexIndex++]=o.b/255,T[this._vertexIndex++]=o.a,T[this._vertexIndex++]=h/i,T[this._vertexIndex++]=S.x,T[this._vertexIndex++]=S.y,T[this._vertexIndex++]=P,T[this._vertexIndex++]=R,T[this._vertexIndex++]=_,T[this._vertexIndex++]=n.r/255,T[this._vertexIndex++]=n.g/255,T[this._vertexIndex++]=n.b/255,T[this._vertexIndex++]=n.a,T[this._vertexIndex++]=o.r/255,T[this._vertexIndex++]=o.g/255,T[this._vertexIndex++]=o.b/255,T[this._vertexIndex++]=o.a,T[this._vertexIndex++]=h/i,T[this._vertexIndex++]=x.x,T[this._vertexIndex++]=x.y,T[this._vertexIndex++]=M,T[this._vertexIndex++]=I,T[this._vertexIndex++]=_,T[this._vertexIndex++]=n.r/255,T[this._vertexIndex++]=n.g/255,T[this._vertexIndex++]=n.b/255,T[this._vertexIndex++]=n.a,T[this._vertexIndex++]=o.r/255,T[this._vertexIndex++]=o.g/255,T[this._vertexIndex++]=o.b/255,T[this._vertexIndex++]=o.a,T[this._vertexIndex++]=h/i,T[this._vertexIndex++]=b.x,T[this._vertexIndex++]=b.y,T[this._vertexIndex++]=M,T[this._vertexIndex++]=R,T[this._vertexIndex++]=_,T[this._vertexIndex++]=n.r/255,T[this._vertexIndex++]=n.g/255,T[this._vertexIndex++]=n.b/255,T[this._vertexIndex++]=n.a,T[this._vertexIndex++]=o.r/255,T[this._vertexIndex++]=o.g/255,T[this._vertexIndex++]=o.b/255,T[this._vertexIndex++]=o.a,T[this._vertexIndex++]=h/i}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),Kt.DrawnImagesCount+=this._circleCount,Kt.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class Sa{constructor(t,i,n=100){this.builder=t,this.recycler=i,this.maxObjects=n,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=dt.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let t=0;t<this.maxObjects;t++)this.objects[t]=this.builder()}using(t){const i=t(this);return i?this.done(...i):this.done()}borrow(t){const i=this.get();t(i),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...t){this.index=0;for(const i of t){const n=this.objects.indexOf(i);this.objects[n]=this.builder(),this.totalAllocations++}return t}}class Km{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=me.identity(),this.state={z:0,opacity:1,tint:K.White,material:null},this.args=new Array(10)}}const $m=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class uf{constructor(t){this._logger=dt.getInstance(),this._color=K.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:i,name:n,vertexSource:o,fragmentSource:h,graphicsContext:c,images:_}=t;if(this._name=n??"anonymous material",this._vertexSource=o??$m,this._fragmentSource=h,this._color=i??this._color,!c)throw Error(`Material ${n} must be provided an excalibur webgl graphics context`);if(c instanceof Ts?(this._graphicsContext=c,this._initialize(c)):this._logger.warn(`Material ${n} was created in 2D Canvas mode, currently only WebGL is supported`),_)for(const p in _)this.addImageSource(p,_[p])}_initialize(t){if(this._initialized)return;const i=t.__gl;this._maxTextureSlots=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=t.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(t){this._color=t}get name(){var t;return(t=this._name)!==null&&t!==void 0?t:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(t){this._shader&&(this._shader.use(),t(this._shader))}getShader(){return this._shader}addImageSource(t,i){this._images.size<this._maxTextureSlots?this._images.set(t,i):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(t){const i=this._images.get(t);this._graphicsContext.textureLoader.delete(i.image),this._images.delete(t)}_loadImageSource(t){const i=t.image,n=i.getAttribute(Mt.Filtering),o=n?cr(n):void 0,h=Hi(i.getAttribute(Mt.WrappingX)),c=Hi(i.getAttribute(Mt.WrappingY)),_=i.getAttribute("forceUpload")==="true",p=this._graphicsContext.textureLoader.load(i,{filtering:o,wrapping:{x:h,y:c}},_);return i.removeAttribute("forceUpload"),this._textures.has(t)||this._textures.set(t,p),p}uploadAndBind(t,i=2){let n=i;for(const[o,h]of this._images.entries()){if(!h.isLoaded()){this._logger.warnOnce(`Image named ${o} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const c=this._loadImageSource(h);t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,c),this._shader.trySetUniformInt(o,n),n++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class Wu{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(t,i){this._gl=t,this._context=i,this._buffer=new rs({gl:t,size:6*4,type:"dynamic"}),this._layout=new Fs({gl:t,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new ro(t,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(t,i,n,o,h,c,_,p,v){var x,b,S,P;const I=this._gl,M=this._context.material;if(!M)return;const R=this._context.getTransform(),T=this._context.opacity,F=M.getShader(),W=this._layout.vertexBuffer.bufferData;let U=0,V=t?.width||o||0,j=t?.height||h||0,X=[0,0,(x=o??t?.width)!==null&&x!==void 0?x:0,(b=h??t?.height)!==null&&b!==void 0?b:0],rt=[i??1,n??1];c!==void 0&&_!==void 0&&p!==void 0&&v!==void 0&&(X=[i??1,n??1,(S=o??t?.width)!==null&&S!==void 0?S:0,(P=h??t?.height)!==null&&P!==void 0?P:0],rt=[c,_],V=p,j=v),i=X[0],n=X[1];const lt=X[2],xt=X[3],mt=G(rt[0],rt[1]),Ct=G(rt[0]+V,rt[1]),Rt=G(rt[0],rt[1]+j),B=G(rt[0]+V,rt[1]+j),z=t.width||V,Q=t.height||j,tt=i/z,Gt=n/Q,at=(i+lt-.01)/z,Si=(n+xt-.01)/Q,hs=R.getPosition(),It=hs.add(B),ht=hs.x/this._context.width,Ms=hs.y/this._context.height,_o=It.x/this._context.width,ls=It.y/this._context.height;W[U++]=mt.x,W[U++]=mt.y,W[U++]=tt,W[U++]=Gt,W[U++]=ht,W[U++]=Ms,W[U++]=Rt.x,W[U++]=Rt.y,W[U++]=tt,W[U++]=Si,W[U++]=ht,W[U++]=ls,W[U++]=Ct.x,W[U++]=Ct.y,W[U++]=at,W[U++]=Gt,W[U++]=_o,W[U++]=Ms,W[U++]=B.x,W[U++]=B.y,W[U++]=at,W[U++]=Si,W[U++]=_o,W[U++]=ls;const go=this._addImageAsTexture(t);M.use(),this._layout.shader=F,this._layout.use(!0),F.trySetUniformFloat("u_time_ms",performance.now()),F.trySetUniformFloat("u_opacity",T),F.trySetUniformFloatVector("u_resolution",G(this._context.width,this._context.height)),F.trySetUniformFloatVector("u_graphic_resolution",G(z,Q)),F.trySetUniformFloatVector("u_size",G(lt,xt)),F.trySetUniformMatrix("u_matrix",this._context.ortho),F.trySetUniformMatrix("u_transform",R.to4x4()),I.activeTexture(I.TEXTURE0+0),I.bindTexture(I.TEXTURE_2D,go),F.trySetUniformInt("u_graphic",0),I.activeTexture(I.TEXTURE0+1),I.bindTexture(I.TEXTURE_2D,this._context.materialScreenTexture),F.trySetUniformInt("u_screen_texture",1),M.uploadAndBind(I),this._quads.bind(),I.drawElements(I.TRIANGLES,6,this._quads.bufferGlType,0),Kt.DrawnImagesCount++,Kt.DrawCallCount++}_addImageAsTexture(t){const i=t.getAttribute(Mt.Filtering),n=i?cr(i):void 0,o=Hi(t.getAttribute(Mt.WrappingX)),h=Hi(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);return t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&this._textures.push(_),_}hasPendingDraws(){return!1}flush(){}}const tv=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,ev=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var ke;(function(d){d.World="world",d.Screen="screen"})(ke||(ke={}));class Al extends k{constructor(t){super(0,0),this._getX=t.getX,this._getY=t.getY,this._setX=t.setX,this._setY=t.setY}get x(){return this._x=this._getX()}set x(t){this._setX(t),this._x=t}get y(){return this._y=this._getY()}set y(t){this._setY(t),this._y=t}}class js extends k{constructor(t,i){super(t.x,t.y),this.original=t,this.change=i}get x(){return this._x=this.original.x}set x(t){t!==this._x&&(this.change(t,this._y),this._x=this.original.x=t)}get y(){return this._y=this.original.y}set y(t){t!==this._y&&(this.change(this._x,t),this._y=this.original.y=t)}setTo(t,i){this.x=t,this.y=i}}class Is{constructor(){this._parent=null,this._children=[],this._pos=new js(G(0,0),()=>{this.flagDirty()}),this._globalPos=new Al({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:t=>{if(this.parent){const{x:i}=this.parent.inverse.multiply(G(t,this.pos.y));this.pos.x=i}else this.pos.x=t;t!==this.matrix.data[4]&&this.flagDirty()},setY:t=>{if(this.parent){const{y:i}=this.parent.inverse.multiply(G(this.pos.x,t));this.pos.y=i}else this.pos.y=t;t!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new js(G(1,1),()=>{this.flagDirty()}),this._globalScale=new Al({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:t=>{if(this.parent){const i=this.parent.globalScale.x;this.scale.x=t/i}else this.scale.x=t},setY:t=>{if(this.parent){const i=this.parent.globalScale.y;this.scale.y=t/i}else this.scale.y=t}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=me.identity(),this._inverse=me.identity(),this._scratch=me.identity()}get parent(){return this._parent}set parent(t){if(this._parent){const i=this._parent._children.indexOf(this);i>-1&&this._parent._children.splice(i,1)}this._parent=t,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(t){this._pos.x=t.x,this._pos.y=t.y}get pos(){return this._pos}set globalPos(t){let i=t.clone();this.parent&&(i=this.parent.inverse.multiply(t)),i.equals(this._pos)||(this._pos=i,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(t){const i=Ps(t);i!==this._rotation&&this.flagDirty(),this._rotation=i}get rotation(){return this._rotation}set globalRotation(t){let i=0;this.parent&&(i=this.parent.globalRotation);const n=Ps(t+i);n!==this._rotation&&this.flagDirty(),this._rotation=n}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(t){this._scale.x=t.x,this._scale.y=t.y}get scale(){return this._scale}set globalScale(t){let i=G(1,1);this.parent&&(i=this.parent.globalScale),this.scale=t.scale(G(1/i.x,1/i.y))}get globalScale(){return this._globalScale}set z(t){this._z=t,this.flagDirty()}get z(){return this._z}set globalZ(t){this.parent?this.z=t-this.parent.globalZ:this.z=t}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let t=0;t<this._children.length;t++)this._children[t].flagDirty()}apply(t){return this.matrix.multiply(t)}applyInverse(t){return this.inverse.multiply(t)}setTransform(t,i,n){this._pos.x=t.x,this._pos.y=t.y,this._rotation=Ps(i),this._scale.x=n.x,this._scale.y=n.y,this.flagDirty()}isMirrored(){const t=qt(this.scale.x)>>>31,i=qt(this.scale.y)>>>31;return!!(t^i)}clone(t){const i=t??new Is;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.flagDirty(),i}cloneWithParent(t){const i=t??new Is;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.parent=this.parent,i.flagDirty(),i}toString(){return this.matrix.toString()}}function ff(d){return!!d&&!!d.prototype&&!!d.prototype.constructor}function iv(d){return!!d?.clone}class Ci{constructor(){this.owner=void 0}clone(){const t=new this.constructor;for(const i in this)if(this.hasOwnProperty(i)){const n=this[i];iv(n)&&i!=="owner"&&i!=="clone"?t[i]=n.clone():t[i]=n}return t}}class Ke{constructor(){this.observers=[],this.subscriptions=[]}register(t){this.observers.push(t)}subscribe(t){this.subscriptions.push(t)}unregister(t){const i=this.observers.indexOf(t);i!==-1&&this.observers.splice(i,1)}unsubscribe(t){const i=this.subscriptions.indexOf(t);i!==-1&&this.subscriptions.splice(i,1)}notifyAll(t){const i=this.observers.length;for(let o=0;o<i;o++)this.observers[o].notify(t);const n=this.subscriptions.length;for(let o=0;o<n;o++)this.subscriptions[o](t)}clear(){this.observers.length=0,this.subscriptions.length=0}}class st extends Ci{constructor(){super(...arguments),this._logger=dt.getInstance(),this._parentComponent=null,this._transform=new Is,this._addChildTransform=t=>{const i=t.get(st);i&&(i._transform.parent=this._transform,i._parentComponent=this)},this.zIndexChanged$=new Ke,this._coordPlane=ke.World}get(){return this._transform}onAdd(t){for(const i of t.children)this._addChildTransform(i);t.childrenAdded$.subscribe(i=>this._addChildTransform(i)),t.childrenRemoved$.subscribe(i=>{const n=i.get(st);n&&(n._transform.parent=null,n._parentComponent=null)})}onRemove(t){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(t){const i=this._transform.z;this._transform.z=t,i!==t&&this.zIndexChanged$.notifyAll(t)}get globalZ(){return this._transform.globalZ}set globalZ(t){this._transform.globalZ=t}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(t){var i;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(i=this.owner)===null||i===void 0?void 0:i.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=t}get pos(){return this._transform.pos}set pos(t){this._transform.pos=t}get globalPos(){return this._transform.globalPos}set globalPos(t){this._transform.globalPos=t}get rotation(){return this._transform.rotation}set rotation(t){this._transform.rotation=t}get globalRotation(){return this._transform.globalRotation}set globalRotation(t){this._transform.globalRotation=t}get scale(){return this._transform.scale}set scale(t){this._transform.scale=t}get globalScale(){return this._transform.globalScale}set globalScale(t){this._transform.globalScale=t}applyInverse(t){return this._transform.applyInverse(t)}apply(t){return this._transform.apply(t)}clone(){const t=new st;return t._transform=this._transform.clone(),t}}var Vr;(function(d){d.Forward="forward",d.Backward="backward"})(Vr||(Vr={}));var Mi;(function(d){d.End="end",d.Loop="loop",d.PingPong="pingpong",d.Freeze="freeze"})(Mi||(Mi={}));const sv={Frame:"frame",Loop:"loop",End:"end"};class ki extends oe{constructor(t){var i,n,o;super(t),this.events=new $t,this.frames=[],this.strategy=Mi.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=t.frames,this.speed=(i=t.speed)!==null&&i!==void 0?i:this.speed,this.strategy=(n=t.strategy)!==null&&n!==void 0?n:this.strategy,this.frameDuration=t.totalDuration?t.totalDuration/this.frames.length:(o=t.frameDuration)!==null&&o!==void 0?o:this.frameDuration,t.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new ki({frames:this.frames.map(t=>({...t})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.width*this.scale.x):0}get height(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.height*this.scale.y):0}static fromSpriteSheet(t,i,n,o=Mi.Loop){const h=t.sprites.length-1,c=i.filter(_=>_<0||_>h);return c.length&&ki._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${c.join(",")} no frame will be shown`),new ki({frames:t.sprites.filter((_,p)=>i.indexOf(p)>-1).map(_=>({graphic:_,duration:n})),strategy:o})}static fromSpriteSheetCoordinates(t){var i;const{spriteSheet:n,frameCoordinates:o,durationPerFrame:h,durationPerFrameMs:c,speed:_,strategy:p,reverse:v}=t,x=(i=h??c)!==null&&i!==void 0?i:100,b=[];for(const S of o){const{x:P,y:I,duration:M,options:R}=S,T=n.getSprite(P,I,R);T?b.push({graphic:T,duration:M??x}):ki._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${P}, ${I}), please check your SpriteSheet to confirm that sprite exists`)}return new ki({frames:b,strategy:p,speed:_,reverse:v})}get speed(){return this._speed}set speed(t){this._speed=At(Math.abs(t),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?Vr.Backward:Vr.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const t=this.frames[this._currentFrame];t&&(this._timeLeftInFrame=t?.duration||this.frameDuration)}get canFinish(){switch(this.strategy){case Mi.End:case Mi.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(t,i){this._currentFrame=t,this._timeLeftInFrame=i??this.frameDuration;const n=this.frames[this._currentFrame];n&&!this._done&&(this._timeLeftInFrame=i??(n?.duration||this.frameDuration),this.events.emit("frame",{...n,frameIndex:this.currentFrameIndex}))}_nextFrame(){const t=this._currentFrame;if(this._done)return t;let i=-1;switch(this.strategy){case Mi.Loop:{i=(t+1)%this.frames.length,i===0&&this.events.emit("loop",this);break}case Mi.End:{i=t+1,i>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case Mi.Freeze:{i=At(t+1,0,this.frames.length-1),i>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case Mi.PingPong:{t+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),t+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),i=t+this._pingPongDirection%this.frames.length;break}}return i}tick(t,i=0){this._idempotencyToken!==i&&(this._idempotencyToken=i,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=t*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(t,i,n){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(t,i,n)}}ki._LOGGER=dt.getInstance();class er extends oe{constructor(t){var i;super(t),this._logger=dt.getInstance(),this.useAnchor=!0,this.members=[],this.members=t.members,this.useAnchor=(i=t.useAnchor)!==null&&i!==void 0?i:this.useAnchor,this._updateDimensions()}clone(){return new er({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const t=this.localBounds;return this.width=t.width,this.height=t.height,t}get localBounds(){const t=new ct;for(const i of this.members)if(i instanceof oe)i.localBounds.combine(t,t);else{const{graphic:n,offset:o,useBounds:h}=i;n?(h===void 0?!0:h)&&n.localBounds.translate(o).combine(t,t):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(i)}.`)}return t}_isAnimationOrGroup(t){return t instanceof ki||t instanceof er}tick(t,i){for(const n of this.members){let o;n instanceof oe?o=n:o=n.graphic,this._isAnimationOrGroup(o)&&o.tick(t,i)}}reset(){for(const t of this.members){let i;t instanceof oe?i=t:i=t.graphic,this._isAnimationOrGroup(i)&&i.reset()}}_preDraw(t,i,n){this._updateDimensions(),super._preDraw(t,this.useAnchor?i:0,this.useAnchor?n:0)}_drawImage(t,i,n){const o=k.Zero;for(const h of this.members){let c;h instanceof oe?c=h:(c=h.graphic,h.offset.clone(o)),c&&(t.save(),t.translate(i,n),c.draw(t,o.x,o.y),this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore())}}}class dr extends oe{constructor(t){var i,n,o,h,c,_,p,v,x,b;super(rf({...t},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=Li(K.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,t&&(this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this.color=(n=t.color)!==null&&n!==void 0?n:K.Black,this.strokeColor=t?.strokeColor,this.smoothing=(o=t.smoothing)!==null&&o!==void 0?o:this.smoothing,this.lineWidth=(h=t.lineWidth)!==null&&h!==void 0?h:this.lineWidth,this.lineDash=(c=t.lineDash)!==null&&c!==void 0?c:this.lineDash,this.lineCap=(_=t.lineCap)!==null&&_!==void 0?_:this.lineCap,this.padding=(p=t.padding)!==null&&p!==void 0?p:this.padding,this.filtering=(v=t.filtering)!==null&&v!==void 0?v:this.filtering),this._bitmap=document.createElement("canvas");const S=(x=t?.width)!==null&&x!==void 0?x:this._bitmap.width,P=(b=t?.height)!==null&&b!==void 0?b:this._bitmap.height;this.width=S,this.height=P;const I=this._bitmap.getContext("2d");if(I)this._ctx=I;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(t){t/=Math.abs(this.scale.x),this._bitmap.width=t,this._originalWidth=t,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(t){t/=Math.abs(this.scale.y),this._bitmap.height=t,this._originalHeight=t,this.flagDirty()}_getTotalWidth(){var t;return(((t=this._originalWidth)!==null&&t!==void 0?t:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var t;return(((t=this._originalHeight)!==null&&t!==void 0?t:this._bitmap.height)+this.padding*2)*1}get localBounds(){return ct.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,k.Zero)}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this.flagDirty()}get color(){return this._color}set color(t){this.flagDirty(),this._color=Li(t,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(t){this.flagDirty(),t&&(this._strokeColor=Li(t,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(t){this._lineDash=t,this.flagDirty()}get padding(){return this._padding}set padding(t){this._padding=t,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(t){var i,n,o,h;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),t.scale(this.quality,this.quality),t.translate(this.padding,this.padding),t.imageSmoothingEnabled=this.smoothing,t.lineWidth=this.lineWidth,t.setLineDash((i=this.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.lineCap=this.lineCap,t.strokeStyle=(o=(n=this.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&o!==void 0?o:"",t.fillStyle=(h=this.color)===null||h===void 0?void 0:h.toString()}_drawImage(t,i,n){this._dirty&&this.rasterize(),t.scale(1/this.quality,1/this.quality),t.drawImage(this._bitmap,i,n)}}var ha;(function(d){d.Em="em",d.Rem="rem",d.Px="px",d.Pt="pt",d.Percent="%"})(ha||(ha={}));var la;(function(d){d.Left="left",d.Right="right",d.Center="center",d.Start="start",d.End="end"})(la||(la={}));var ca;(function(d){d.Top="top",d.Hanging="hanging",d.Middle="middle",d.Alphabetic="alphabetic",d.Ideographic="ideographic",d.Bottom="bottom"})(ca||(ca={}));var da;(function(d){d.Normal="normal",d.Italic="italic",d.Oblique="oblique"})(da||(da={}));var ua;(function(d){d.LeftToRight="ltr",d.RightToLeft="rtl"})(ua||(ua={}));function Cl(d,t=K.Red,i,n,o,h,c=1,_="butt"){d.save(),d.beginPath(),d.lineWidth=c,d.lineCap=_,d.strokeStyle=t.toString(),d.moveTo(i,n),d.lineTo(o,h),d.closePath(),d.stroke(),d.restore()}function nv(d,t=K.Red,i){d.beginPath(),d.strokeStyle=t.toString(),d.arc(i.x,i.y,5,0,Math.PI*2),d.closePath(),d.stroke()}function rv(d,t,i,n,o=1){const h=t?t.toString():"blue",c=n.scale(o);d.beginPath(),d.strokeStyle=h,d.moveTo(i.x,i.y),d.lineTo(i.x+c.x,i.y+c.y),d.closePath(),d.stroke()}function Sl(d,t,i,n,o,h=5,c=K.White,_=null){let p;if(typeof h=="number")p={tl:h,tr:h,br:h,bl:h};else{const v={tl:0,tr:0,br:0,bl:0};for(const x in v)if(v.hasOwnProperty(x)){const b=x;p[b]=h[b]||v[b]}}d.beginPath(),d.moveTo(t+p.tl,i),d.lineTo(t+n-p.tr,i),d.quadraticCurveTo(t+n,i,t+n,i+p.tr),d.lineTo(t+n,i+o-p.br),d.quadraticCurveTo(t+n,i+o,t+n-p.br,i+o),d.lineTo(t+p.bl,i+o),d.quadraticCurveTo(t,i+o,t,i+o-p.bl),d.lineTo(t,i+p.tl),d.quadraticCurveTo(t,i,t+p.tl,i),d.closePath(),_&&(d.fillStyle=_.toString(),d.fill()),c&&(d.strokeStyle=c.toString(),d.stroke())}function ov(d,t,i,n,o=K.White,h=null){d.beginPath(),d.arc(t,i,n,0,Math.PI*2),d.closePath(),h&&(d.fillStyle=h.toString(),d.fill()),o&&(d.strokeStyle=o.toString(),d.stroke())}class Kn{constructor(t,i,n,o){this.font=t,this.text=i,this.color=n,this.maxWidth=o,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const h=this.canvas.getContext("2d");if(!h)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=h,this.dimensions=this.measureText(i),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(t,i){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let n=null;i!=null?n=this._getLinesFromText(t,i):n=t.split(`
`);const o=n.reduce((S,P)=>S.length>P.length?S:P);this._applyFont(this.ctx);const h=this.ctx.measureText(o);let c=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);const _=c*n.length;c=_;const p=_-Math.abs(h.actualBoundingBoxAscent),v=0,x=0;return new ct({left:v-Math.abs(h.actualBoundingBoxLeft)-this.font.padding,top:x-Math.abs(h.actualBoundingBoxAscent)-this.font.padding,bottom:x+p+this.font.padding,right:v+Math.abs(h.actualBoundingBoxRight)+this.font.padding})}_setDimension(t,i){let n=1;this.font.lineHeight&&(n=this.font.lineHeight/this.font.size),i.canvas.width=(t.width+this.font.padding*2)*2*this.font.quality,i.canvas.height=(t.height+this.font.padding*2)*2*this.font.quality*n}static getHashCode(t,i,n){var o;return i+"__hashcode__"+t.fontString+t.showDebug+t.textAlign+t.baseAlign+t.direction+t.lineHeight+JSON.stringify(t.shadow)+(t.padding.toString()+t.smoothing.toString()+t.lineWidth.toString()+t.lineDash.toString()+((o=t.strokeColor)===null||o===void 0?void 0:o.toString())+(n?n.toString():t.color.toString()))}getHashCode(t=!0){return Kn.getHashCode(this.font,this.text,t?this.color:void 0)}_applyRasterProperties(t){var i,n,o;t.translate(this.font.padding,this.font.padding),t.imageSmoothingEnabled=this.font.smoothing,t.lineWidth=this.font.lineWidth,t.setLineDash((i=this.font.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.strokeStyle=(o=(n=this.font.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&o!==void 0?o:"",t.fillStyle=this.color.toString()}_applyFont(t){t.resetTransform(),t.translate(this.font.padding+t.canvas.width/2,this.font.padding+t.canvas.height/2),t.scale(this.font.quality,this.font.quality),t.textAlign=this.font.textAlign,t.textBaseline=this.font.baseAlign,t.font=this.font.fontString,t.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(t.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(t.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(t.shadowOffsetX=this.font.shadow.offset.x,t.shadowOffsetY=this.font.shadow.offset.y))}_drawText(t,i,n){this._applyRasterProperties(t),this._applyFont(t);for(let o=0;o<i.length;o++){const h=i[o];this.color&&t.fillText(h,0,o*n),this.font.strokeColor&&t.strokeText(h,0,o*n)}this.font.showDebug&&(Cl(t,K.Green,-t.canvas.width/2,0,t.canvas.width/2,0,2),Cl(t,K.Red,0,-t.canvas.height/2,0,t.canvas.height/2,2))}_splitTextBitmap(t){const i=[];let n=0,o=0;const h=Math.min(4096,t.canvas.width),c=Math.min(4096,t.canvas.height);for(;n<t.canvas.width;){for(;o<t.canvas.height;){const _=document.createElement("canvas");_.width=h,_.height=c;const p=_.getContext("2d");if(!p)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");p.drawImage(t.canvas,n,o,h,c,0,0,h,c),i.push({x:n,y:o,canvas:_}),o+=c}n+=h,o=0}return i}flagDirty(){this._dirty=!0}render(t,i,n,o){var h;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=t;const c=this.getHashCode();if(this._lastHashCode!==c&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,o),this._setDimension(this.dimensions,this.ctx);const _=this._getLinesFromText(this.text,o),p=(h=this.font.lineHeight)!==null&&h!==void 0?h:this.dimensions.height/_.length;if(this._drawText(this.ctx,_,p),t instanceof Ts)for(const v of this._textFragments)t.textureLoader.delete(v.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),t instanceof Ts)for(const v of this._textFragments)t.textureLoader.load(v.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=c,this._dirty=!1}for(const _ of this._textFragments)t.drawImage(_.canvas,0,0,_.canvas.width,_.canvas.height,_.x/this.font.quality+i-this.ctx.canvas.width/this.font.quality/2,_.y/this.font.quality+n-this.ctx.canvas.height/this.font.quality/2,_.canvas.width/this.font.quality,_.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof Ts)for(const t of this._textFragments)this._ex.textureLoader.delete(t.canvas);this._textFragments.length=0}_getLinesFromText(t,i){var n;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let c=o[h],_="";if(this.measureText(c).width>i){for(;this.measureText(c).width>i;)_=c[c.length-1]+_,c=c.slice(0,-1);o[h]=c,o[h+1]=_}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class Ht{static measureText(t,i,n){const o=Kn.getHashCode(i,t);if(Ht._MEASURE_CACHE.has(o))return Ht._MEASURE_CACHE.get(o);Ht._LOGGER.debug("Font text measurement cache miss");const h=i.measureTextWithoutCache(t,n);return Ht._MEASURE_CACHE.set(o,h),h}static getTextInstance(t,i,n){const o=Kn.getHashCode(i,t,n);let h=Ht._TEXT_CACHE.get(o);return h||(h=new Kn(i,t,n),Ht._TEXT_CACHE.set(o,h),Ht._LOGGER.debug("Font text instance cache miss")),Ht._TEXT_USAGE.set(h,performance.now()),h}static checkAndClearCache(){const t=[],i=new Set;for(const[o,h]of Ht._TEXT_USAGE.entries())if(h+Ht.FONT_TIMEOUT<performance.now())Ht._LOGGER.debug(`Text cache entry timed out ${o.text}`),t.push(o),o.dispose();else{const c=o.getHashCode(!1);i.add(c)}t.forEach(o=>{Ht._TEXT_USAGE.delete(o)}),this._TEXT_CACHE.clear();for(const[o]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(o.getHashCode(),o);const n=new Map;for(const o of i)Ht._MEASURE_CACHE.has(o)&&n.set(o,Ht._MEASURE_CACHE.get(o));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=n}static get cacheSize(){return Ht._TEXT_USAGE.size}static clearCache(){for(const[t]of Ht._TEXT_USAGE.entries())t.dispose();Ht._TEXT_USAGE.clear(),Ht._TEXT_CACHE.clear(),Ht._MEASURE_CACHE.clear()}}Ht.FONT_TIMEOUT=500;Ht._LOGGER=dt.getInstance();Ht._TEXT_USAGE=new Map;Ht._TEXT_CACHE=new Map;Ht._MEASURE_CACHE=new Map;class Fn extends oe{constructor(t={}){var i,n,o,h,c,_,p,v,x,b,S,P,I,M,R,T,F,W,U,V;super(t),this.filtering=we.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=K.Black,this.family="sans-serif",this.style=da.Normal,this.bold=!1,this.unit=ha.Px,this.textAlign=la.Left,this.baseAlign=ca.Top,this.direction=ua.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new ct,this._textMeasurement=new Kn(this,"",K.Black),this.smoothing=(i=t?.smoothing)!==null&&i!==void 0?i:this.smoothing,this.padding=(n=t?.padding)!==null&&n!==void 0?n:this.padding,this.color=(o=t?.color)!==null&&o!==void 0?o:this.color,this.strokeColor=(h=t?.strokeColor)!==null&&h!==void 0?h:this.strokeColor,this.lineDash=(c=t?.lineDash)!==null&&c!==void 0?c:this.lineDash,this.lineWidth=(_=t?.lineWidth)!==null&&_!==void 0?_:this.lineWidth,this.filtering=(p=t?.filtering)!==null&&p!==void 0?p:this.filtering,this.family=(v=t?.family)!==null&&v!==void 0?v:this.family,this.style=(x=t?.style)!==null&&x!==void 0?x:this.style,this.bold=(b=t?.bold)!==null&&b!==void 0?b:this.bold,this.size=(S=t?.size)!==null&&S!==void 0?S:this.size,this.unit=(P=t?.unit)!==null&&P!==void 0?P:this.unit,this.textAlign=(I=t?.textAlign)!==null&&I!==void 0?I:this.textAlign,this.baseAlign=(M=t?.baseAlign)!==null&&M!==void 0?M:this.baseAlign,this.direction=(R=t?.direction)!==null&&R!==void 0?R:this.direction,this.lineHeight=(T=t?.lineHeight)!==null&&T!==void 0?T:this.lineHeight,this.quality=(F=t?.quality)!==null&&F!==void 0?F:this.quality,t?.shadow&&(this.shadow={},this.shadow.blur=(W=t.shadow.blur)!==null&&W!==void 0?W:this.shadow.blur,this.shadow.offset=(U=t.shadow.offset)!==null&&U!==void 0?U:this.shadow.offset,this.shadow.color=(V=t.shadow.color)!==null&&V!==void 0?V:this.shadow.color)}clone(){return new Fn({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(t,i,n){}_rotate(t){var i;const n=(i=this.origin)!==null&&i!==void 0?i:this._textBounds.center;t.translate(n.x,n.y),t.rotate(this.rotation),t.translate(-n.x,-n.y)}_flip(t){this.flipHorizontal&&(t.translate(this._textBounds.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,-this._textBounds.height/2/this.scale.y),t.scale(1,-1))}measureTextWithoutCache(t,i){return this._textMeasurement.measureText(t,i)}measureText(t,i){return Ht.measureText(t,this,i)}_postDraw(t){t.restore()}render(t,i,n,o,h,c){const _=Ht.getTextInstance(i,this,n);this._textBounds=_.dimensions,this._preDraw(t,o,h),_.render(t,o,h,c),this._postDraw(t)}}class oo extends oe{constructor(t){var i,n;super(t),this._text="",this._textWidth=0,this._textHeight=0,this.font=(i=t.font)!==null&&i!==void 0?i:new Fn,this.color=(n=t.color)!==null&&n!==void 0?n:this.color,this.text=t.text,this.maxWidth=t.maxWidth}clone(){var t,i;return new oo({text:this.text.slice(),color:(i=(t=this.color)===null||t===void 0?void 0:t.clone())!==null&&i!==void 0?i:K.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(t){this._text=t,this._calculateDimension()}get font(){return this._font}set font(t){this._font=t}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:t,height:i}=this.font.measureText(this._text,this.maxWidth);this._textWidth=t,this._textHeight=i}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(t){}_flip(t){}_preDraw(t,i,n){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(t,i,n)}_drawImage(t,i,n){var o;let h=K.Black;this.font instanceof Fn&&(h=(o=this.color)!==null&&o!==void 0?o:this.font.color);const{width:c,height:_}=this.font.measureText(this._text,this.maxWidth);this._textWidth=c,this._textHeight=_,this.font.render(t,this._text,h,i,n,this.maxWidth),this.font.showDebug&&(t.debug.drawRect(i-c,n-_,c*2,_*2),this.maxWidth!=null&&t.debug.drawRect(i,n,this.maxWidth,this.height,{color:K.Yellow}))}}function Jl(d){return!!d.tick}class ae extends Ci{get visible(){return this.isVisible}set visible(t){this.isVisible=t}get offset(){return this._offset}set offset(t){this._offset=new js(t,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(t){this._anchor=new js(t,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(t){if(t){this._color=t.clone();const i=this.graphics.current;(i instanceof dr||i instanceof oo)&&(i.color=this._color)}}constructor(t){super(),this._logger=dt.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new js(k.Zero,()=>this.recalculateBounds()),this._anchor=new js(k.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,t={visible:this.isVisible,graphics:{},...t};const{current:i,anchor:n,color:o,opacity:h,visible:c,graphics:_,offset:p,copyGraphics:v,onPreDraw:x,onPostDraw:b,onPreTransformDraw:S,onPostTransformDraw:P}=t;for(const[I,M]of Object.entries(_))M instanceof oe?this._graphics[I]=M:(this._graphics[I]=M.graphic,this._options[I]=M.options);this.offset=p??this.offset,this.opacity=h??this.opacity,this.anchor=n??this.anchor,this.color=o??this.color,this.copyGraphics=v??this.copyGraphics,this.onPreDraw=x??this.onPreDraw,this.onPostDraw=b??this.onPostDraw,this.onPreDraw=S??this.onPreTransformDraw,this.onPostTransformDraw=P??this.onPostTransformDraw,this.isVisible=!!c,this._current=i??this._current,i&&this._graphics[i]&&this.use(i)}getGraphic(t){return this._graphics[t]}getOptions(t){return this._options[t]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(t,i,n){let o="default",h=null,c;if(typeof t=="string"&&i instanceof oe&&(o=t,h=i,c=n),t instanceof oe&&!(i instanceof oe)&&(h=t,c=i),!h)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[o]=this.copyGraphics?h.clone():h,this._options[o]=this.copyGraphics?{...c}:c,o==="default"&&this.use("default"),h}remove(t){delete this._graphics[t],delete this._options[t],this._current===t&&(this._current="default",this.recalculateBounds())}use(t,i){var n;if(t instanceof oe){let o=t;this.copyGraphics&&(o=t.clone()),this._current="default",this._graphics[this._current]=o,this._options[this._current]=i}else this._current=t,this._options[this._current]=i,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(n=this.owner)===null||n===void 0?void 0:n.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(t){this._localBounds=t}recalculateBounds(){let t=new ct;const i=this._graphics[this._current],n=this._options[this._current];if(!i){this._localBounds=t;return}let o=this.anchor,h=this.offset;n?.anchor&&(o=n.anchor),n?.offset&&(h=n.offset);const c=i.localBounds,_=-c.width*o.x+h.x,p=-c.height*o.y+h.y;i instanceof er&&!i.useAnchor?t=i?.localBounds.combine(t):t=i?.localBounds.translate(G(_,p)).combine(t),this._localBounds=t}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let t=this.localBounds;if(this.owner){const i=this.owner.get(st);i&&(t=t.transform(i.get().matrix))}return t}update(t,i=0){const n=this.current;n&&Jl(n)&&n.tick(t,i)}clone(){const t=new ae;return t._graphics={...this._graphics},t._options={...this._options},t.offset=this.offset.clone(),this.color&&(t.color=this.color.clone()),t.opacity=this.opacity,t.anchor=this.anchor.clone(),t.copyGraphics=this.copyGraphics,t.onPreDraw=this.onPreDraw,t.onPostDraw=this.onPostDraw,t.isVisible=this.isVisible,t}}var fa;(function(d){d.Kill="kill",d.PreKill="prekill",d.PostKill="postkill",d.PreDraw="predraw",d.PostDraw="postdraw",d.PreDebugDraw="predebugdraw",d.PostDebugDraw="postdebugdraw",d.PreUpdate="preupdate",d.PostUpdate="postupdate",d.PreFrame="preframe",d.PostFrame="postframe",d.PreCollision="precollision",d.CollisionStart="collisionstart",d.CollisionEnd="collisionend",d.PostCollision="postcollision",d.Initialize="initialize",d.Activate="activate",d.Deactivate="deactivate",d.ExitViewport="exitviewport",d.EnterViewport="enterviewport",d.ExitTrigger="exit",d.EnterTrigger="enter",d.Connect="connect",d.Disconnect="disconnect",d.Button="button",d.Axis="axis",d.Visible="visible",d.Hidden="hidden",d.Start="start",d.Stop="stop",d.PointerUp="pointerup",d.PointerDown="pointerdown",d.PointerMove="pointermove",d.PointerEnter="pointerenter",d.PointerLeave="pointerleave",d.PointerCancel="pointercancel",d.PointerWheel="pointerwheel",d.Up="up",d.Down="down",d.Move="move",d.Enter="enter",d.Leave="leave",d.Cancel="cancel",d.Wheel="wheel",d.Press="press",d.Release="release",d.Hold="hold",d.PointerDragStart="pointerdragstart",d.PointerDragEnd="pointerdragend",d.PointerDragEnter="pointerdragenter",d.PointerDragLeave="pointerdragleave",d.PointerDragMove="pointerdragmove",d.ActionStart="actionstart",d.ActionComplete="actioncomplete",d.Add="add",d.Remove="remove"})(fa||(fa={}));class wt{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(t){this._bubbles=t}stopPropagation(){this.bubbles=!1}}class Pa extends wt{constructor(t){super(),this.self=t,this.target=t}}class Kl extends wt{constructor(t){super(),this.self=t,this.target=t}}class $l extends wt{constructor(t){super(),this.self=t,this.target=t}}class tc extends wt{constructor(t){super(),this.self=t,this.target=t}}class ec extends wt{constructor(t){super(),this.self=t,this.target=t}}class ur extends wt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class fr extends wt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class ic extends wt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class sc extends wt{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class nc extends wt{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class rc extends wt{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class Ks extends wt{constructor(t,i,n){super(),this.engine=t,this.elapsed=i,this.self=n,this.target=n}}class $s extends wt{constructor(t,i,n){super(),this.engine=t,this.elapsed=i,this.self=n,this.target=n}}class oc extends wt{constructor(t,i){super(),this.engine=t,this.prevStats=i,this.target=t}}class ac extends wt{constructor(t,i){super(),this.engine=t,this.stats=i,this.target=t}}class hc extends wt{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class lc extends wt{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class cc extends wt{constructor(t,i,n,o){super(),this.button=t,this.index=i,this.value=n,this.self=o,this.target=o}}class dc extends wt{constructor(t,i,n){super(),this.axis=t,this.value=i,this.self=n,this.target=n}}class uc extends wt{constructor(t){super(),this.self=t,this.target=t}}class fc extends wt{constructor(t){super(),this.self=t,this.target=t}}class Mn extends wt{constructor(t,i,n,o,h){super(),this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h,this.target=t}}class Bn extends wt{constructor(t,i,n,o,h){super(),this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h,this.target=t}}class _a{constructor(t,i,n,o){this.self=t,this.other=i,this.side=n,this.contact=o}}class ga{constructor(t,i,n,o){this.self=t,this.other=i,this.side=n,this.lastContact=o}}class pa{constructor(t,i,n,o,h){this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h}}class ma{constructor(t,i,n,o,h){this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h}}class Xr extends wt{constructor(t,i,n,o){super(),this.self=t,this.other=i,this.side=n,this.contact=o,this.target=t}}class qr extends wt{constructor(t,i,n,o){super(),this.self=t,this.other=i,this.side=n,this.lastContact=o,this.target=t}}class _r extends wt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class _c extends wt{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class gc extends wt{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class pc extends wt{constructor(t){super(),this.self=t,this.target=t}}class mc extends wt{constructor(t){super(),this.self=t,this.target=t}}class vc extends wt{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class wc extends wt{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class xc extends wt{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class bc extends wt{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class yc extends wt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class Ac extends wt{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class av{constructor(t){this.data=t,this.type="Component Added"}}function hv(d){return!!d&&d.type==="Component Added"}class lv{constructor(t){this.data=t,this.type="Component Removed"}}function cv(d){return!!d&&d.type==="Component Removed"}const dv={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class qe{constructor(t,i){this.id=qe._ID++,this.name=`Entity#${this.id}`,this.events=new $t,this._tags=new Set,this.componentAdded$=new Ke,this.componentRemoved$=new Ke,this.tagAdded$=new Ke,this.tagRemoved$=new Ke,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new Ke,this.childrenRemoved$=new Ke,this._children=[],this._isInitialized=!1,this._isAdded=!1;let n,o;if(Array.isArray(t))n=t,o=i;else if(t&&typeof t=="object"){const{components:h,name:c,silenceWarnings:_}=t;n=h??[],o=c}if(o&&(this.name=o),n)for(const h of n)this.addComponent(h)}get active(){return this.isActive}set active(t){this.isActive=t}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new Pa(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(t){return this._tags.has(t)}addTag(t){return this._tags.add(t),this.tagAdded$.notifyAll(t),this}removeTag(t){return this._tags.delete(t),this.tagRemoved$.notifyAll(t),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(t){for(let i=0;i<t.length;i++)if(!this.components.has(t[i]))return!1;return!0}hasAllTags(t){for(let i=0;i<t.length;i++)if(!this.tags.has(t[i]))return!1;return!0}get(t){return this.components.get(t)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(t){if(t.parent===null){if(this.getAncestors().includes(t))throw new Error("Cycle detected, cannot add entity");this._children.push(t),t._parent=this,this.childrenAdded$.notifyAll(t)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(t){return t.parent===this&&(lr(t,this._children),t._parent=null,this.childrenRemoved$.notifyAll(t)),this}removeAllChildren(){for(let t=this.children.length-1;t>=0;t--)this.removeChild(this.children[t]);return this}getAncestors(){const t=[this];let i=this.parent;for(;i;)t.push(i),i=i.parent;return t.reverse()}getDescendants(){let t=[this],i=[this];for(;i.length>0;){const n=i.pop();n&&(i=i.concat(n.children),t=t.concat(n.children))}return t}clone(){const t=new qe;for(const i of this.types){const n=this.get(i);n&&t.addComponent(n.clone())}for(const i of this.children)t.addChild(i.clone());return t}addTemplate(t,i=!1){for(const n of t.getComponents())this.addComponent(n.clone(),i);for(const n of t.children)this.addChild(n.clone().addTemplate(n));return this}_getClassHierarchyRoot(t){var i,n;let o=t,h=(i=Object.getPrototypeOf(o.prototype))===null||i===void 0?void 0:i.constructor;for(;h&&h!==Object&&h!==Ci;)o=h,h=(n=Object.getPrototypeOf(o.prototype))===null||n===void 0?void 0:n.constructor;return o}addComponent(t,i=!1){if(this.has(t.constructor))if(i)this.removeComponent(t.constructor,!0);else return this;if(t.dependencies&&t.dependencies.length)for(const o of t.dependencies)this.addComponent(new o);t.owner=this;const n=this._getClassHierarchyRoot(t.constructor);return this.components.set(n,t),this.components.set(t.constructor,t),this.componentValues.push(t),t.onAdd&&t.onAdd(this),this.componentAdded$.notifyAll(t),this}removeComponent(t,i=!1){let n;if(ff(t)?n=t:n=t.constructor,i){const o=this.components.get(n);if(o){this.componentRemoved$.notifyAll(o),o.owner=void 0,o.onRemove&&o.onRemove(this);const c=this.componentValues.indexOf(o);c>-1&&this.componentValues.splice(c,1)}const h=this._getClassHierarchyRoot(n);this.components.delete(h),this.components.delete(n)}else this._componentsToRemove.push(n);return this}clearComponents(){const t=this.types;for(const i of t)this.removeComponent(i)}processComponentRemoval(){for(const t of this._componentsToRemove)this.removeComponent(t,!0);this._componentsToRemove.length=0}has(t){return this.components.has(t)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(t){this.isInitialized||(this.onInitialize(t),this.events.emit("initialize",new _r(t,this)),this._isInitialized=!0)}_add(t){!this.isAdded&&this.isActive&&(this.onAdd(t),this.events.emit("add",new yc(t,this)),this._isAdded=!0)}_remove(t){this.isAdded&&!this.isActive&&(this.onRemove(t),this.events.emit("remove",new Ac(t,this)),this._isAdded=!1)}_preupdate(t,i){this.events.emit("preupdate",new Ks(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new $s(t,i,this)),this.onPostUpdate(t,i)}onInitialize(t){}onAdd(t){}onRemove(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i);for(const n of this.children)n.update(t,i);this._postupdate(t,i),this._remove(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}qe._ID=0;class kt extends Ci{constructor(){super(...arguments),this.vel=k.Zero,this.acc=k.Zero,this.scaleFactor=k.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class Je{static integrate(t,i,n,o){const h=o/1e3;i.vel.addEqual(n.scale(h,Je._ACC)),t.pos.add(i.vel.scale(h,Je._VEL),Je._POS).addEqual(n.scale(.5*h*h,Je._VEL_ACC)),i.angularVelocity+=i.torque*(1/i.inertia)*h;const c=t.rotation+i.angularVelocity*h;t.scale.add(i.scaleFactor.scale(h,this._SCALE_FACTOR),Je._SCALE),t.get().setTransform(Je._POS,c,Je._SCALE)}}Je._POS=new k(0,0);Je._SCALE=new k(1,1);Je._ACC=new k(0,0);Je._VEL=new k(0,0);Je._VEL_ACC=new k(0,0);Je._SCALE_FACTOR=new k(0,0);class Ta extends qe{constructor(t){super({silenceWarnings:!0}),this.beginColor=K.White,this.endColor=K.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=K.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=Oi.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new st),this.addComponent(this.motion=new kt),this.addComponent(this.graphics=new ae),this.configure(t)}registerEmitter(t){if(this._emitter=t,this.particleTransform===Oi.Global){const i=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(i),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(t){var i,n,o,h,c,_,p,v,x,b,S,P,I,M;this.particleTransform=(i=t.transform)!==null&&i!==void 0?i:this.particleTransform,this.life=(n=t.life)!==null&&n!==void 0?n:this.life,this.fade=(o=t.fade)!==null&&o!==void 0?o:this.fade,this.size=(h=t.size)!==null&&h!==void 0?h:this.size,this.endColor=(c=t.endColor)!==null&&c!==void 0?c:this.endColor.clone(),this.beginColor=(_=t.beginColor)!==null&&_!==void 0?_:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=t.graphic,this.graphics.opacity=(p=t.opacity)!==null&&p!==void 0?p:this.graphics.opacity,this.transform.pos=(v=t.pos)!==null&&v!==void 0?v:this.transform.pos,this.transform.rotation=(x=t.rotation)!==null&&x!==void 0?x:0,this.transform.scale=G(1,1),this.motion.vel=(b=t.vel)!==null&&b!==void 0?b:this.motion.vel,this.motion.angularVelocity=(S=t.angularVelocity)!==null&&S!==void 0?S:0,this.motion.acc=(P=t.acc)!==null&&P!==void 0?P:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(I=t.startSize)!==null&&I!==void 0?I:0,this.endSize=(M=t.endSize)!==null&&M!==void 0?M:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=ct.fromDimension(this.size,this.size,k.Half),this.graphics.onPostDraw=R=>{R.save(),R.debug.drawPoint(G(0,0),{color:this._currentColor,size:this.size}),R.restore()})}kill(){var t;!((t=this._emitter)===null||t===void 0)&&t.isActive?this._emitter.removeParticle(this):super.kill()}update(t,i){this.life=this.life-i,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=At(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=At(this.sizeRate*i+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=At(this._currentColor.r+this._rRate*i,0,255),this._currentColor.g=At(this._currentColor.g+this._gRate*i,0,255),this._currentColor.b=At(this._currentColor.b+this._bRate*i,0,255),this._currentColor.a=this.graphics.opacity;let n=this.motion.acc;this.focus&&(n=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(i/1e3)),Je.integrate(this.transform,this.motion,n,i)}}Ta.DefaultConfig={beginColor:K.White,endColor:K.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var Oi;(function(d){d.Global="global",d.Local="local"})(Oi||(Oi={}));class _f{constructor(){this.type="ex.particle",this.priority=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new hi({gl:t,vertexSource:tv,fragmentSource:ev,onPreLink:n=>{t.transformFeedbackVaryings(n,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],t.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(t){const i=t.getAttribute(Mt.Filtering),n=i?cr(i):void 0,o=Hi(t.getAttribute(Mt.WrappingX)),h=Hi(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);return t.removeAttribute("forceUpload"),_}draw(t,i){var n,o,h,c,_,p,v,x,b;const S=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const P=t.particle.transform===Oi.Local?this._context.getTransform():this._context.getTransform().multiply(t.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",P),this._shader.setUniformBoolean("fade",!!t.particle.fade),this._shader.setUniformBoolean("useTexture",!!t.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(n=t.particle.life)!==null&&n!==void 0?n:2e3),this._shader.setUniformFloat("deltaMs",i),this._shader.setUniformFloatVector("gravity",(o=t.particle.acc)!==null&&o!==void 0?o:G(0,0)),this._shader.setUniformFloatColor("beginColor",(h=t.particle.beginColor)!==null&&h!==void 0?h:K.Transparent),this._shader.setUniformFloatColor("endColor",(c=t.particle.endColor)!==null&&c!==void 0?c:K.Transparent);let I=(_=t.particle.startSize)!==null&&_!==void 0?_:0,M=(p=t.particle.endSize)!==null&&p!==void 0?p:0;const R=(v=t.particle.size)!==null&&v!==void 0?v:0;if(R>0&&(I=R,M=R),this._shader.setUniformFloat("startSize",I??10),this._shader.setUniformFloat("endSize",M??10),this._shader.setUniformFloat("startOpacity",(x=t.particle.opacity)!==null&&x!==void 0?x:1),t.particle.focus&&(this._shader.setUniformFloatVector("focus",t.particle.focus),this._shader.setUniformFloat("focusAccel",(b=t.particle.focusAccel)!==null&&b!==void 0?b:0)),t.particle.graphic){const T=t.particle.graphic,F=this._getTexture(T.image.image);S.activeTexture(S.TEXTURE0),S.bindTexture(S.TEXTURE_2D,F),this._shader.setUniformInt("graphic",0)}t.draw(S)}hasPendingDraws(){return!1}flush(){}dispose(){}}const uv=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,fv=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class _v{constructor(t){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=K.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=Ql(t,n);this._maxTextures=Math.min(n,o);const h=this._transformFragmentSource(uv,this._maxTextures);this._shader=new hi({gl:t,fragmentSource:h,vertexSource:fv}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((b,S)=>S)),this._vao=t.createVertexArray(),t.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._meshBuffer),t.bufferData(t.ARRAY_BUFFER,this._quadMesh,t.STATIC_DRAW),t.vertexAttribPointer(0,2,t.FLOAT,!1,16,0),t.enableVertexAttribArray(0),t.vertexAttribPointer(1,2,t.FLOAT,!1,16,8),t.enableVertexAttribArray(1),t.bindBuffer(t.ARRAY_BUFFER,null);const c=this._components;this._transformData=new rs({gl:t,size:c*this._maxImages,type:"dynamic"}),this._transformData.bind();let _=0,p=2;const v=4,x=c*4;t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(2),_+=2*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(3),_+=2*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(4),_+=2*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(5),_+=2*v,t.vertexAttribPointer(p++,1,t.FLOAT,!1,x,_),t.enableVertexAttribArray(6),_+=1*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(7),_+=2*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(8),_+=2*v,t.vertexAttribPointer(p++,1,t.FLOAT,!1,x,_),t.enableVertexAttribArray(9),_+=1*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(10),_+=2*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(11),_+=2*v,t.vertexAttribPointer(p++,4,t.FLOAT,!1,x,_),t.enableVertexAttribArray(12),_+=4*v,t.vertexAttribDivisor(2,1),t.vertexAttribDivisor(3,1),t.vertexAttribDivisor(4,1),t.vertexAttribDivisor(5,1),t.vertexAttribDivisor(6,1),t.vertexAttribDivisor(7,1),t.vertexAttribDivisor(8,1),t.vertexAttribDivisor(9,1),t.vertexAttribDivisor(10,1),t.vertexAttribDivisor(11,1),t.vertexAttribDivisor(12,1),t.bindVertexArray(null)}_bindData(t){const i=this._components;this._transformData.bind(),this._transformData.upload(i*this._imageCount),t.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let n=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_texture_index <= ${h}.5) {
`:o+=`   else if (v_texture_index <= ${h}.5) {
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return n=n.replace("%%texture_picker%%",o),n}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(Mt.Filtering),n=i?cr(i):void 0,o=Hi(t.getAttribute(Mt.WrappingX)),h=Hi(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&(this._textures.push(_),this._textureToIndex.set(_,this._textureIndex++),this._images.add(t))}_bindTextures(t){const i=Math.min(this._textureIndex,this._maxTextures);for(let n=0;n<i;n++)t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,this._textures[n]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const n=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(n))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,n,o,h,c,_,p,v){var x,b,S,P;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const I=this._getImageWidth(t),M=this._getImageHeight(t);let R=I||o||0,T=M||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(x=o??I)!==null&&x!==void 0?x:0,this._view[3]=(b=h??M)!==null&&b!==void 0?b:0,this._dest[0]=i??1,this._dest[1]=n??1,c!==void 0&&_!==void 0&&p!==void 0&&v!==void 0&&(this._view[0]=i??1,this._view[1]=n??1,this._view[2]=(S=o??I)!==null&&S!==void 0?S:0,this._view[3]=(P=h??M)!==null&&P!==void 0?P:0,this._dest[0]=c,this._dest[1]=_,R=p,T=v),i=this._view[0],n=this._view[1];const F=this._view[2],W=this._view[3],U=this._context.getTransform(),V=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+pt),this._dest[1]=~~(this._dest[1]+pt));const X=this._context.tint||this._defaultTint,rt=this._getTextureIdForImage(t),lt=I||R,xt=M||T,mt=(i+this.uvPadding)/lt,Ct=(n+this.uvPadding)/xt,Rt=(i+F-this.uvPadding)/lt,B=(n+W-this.uvPadding)/xt,z=I,Q=M,tt=this._transformData.bufferData;tt[this._vertexIndex++]=this._dest[0],tt[this._vertexIndex++]=this._dest[1],tt[this._vertexIndex++]=U.data[0],tt[this._vertexIndex++]=U.data[1],tt[this._vertexIndex++]=U.data[2],tt[this._vertexIndex++]=U.data[3],tt[this._vertexIndex++]=U.data[4],tt[this._vertexIndex++]=U.data[5],tt[this._vertexIndex++]=V,tt[this._vertexIndex++]=R,tt[this._vertexIndex++]=T,tt[this._vertexIndex++]=z,tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=rt,tt[this._vertexIndex++]=mt,tt[this._vertexIndex++]=Ct,tt[this._vertexIndex++]=Rt,tt[this._vertexIndex++]=B,tt[this._vertexIndex++]=X.r/255,tt[this._vertexIndex++]=X.g/255,tt[this._vertexIndex++]=X.b/255,tt[this._vertexIndex++]=X.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._bindData(t),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),t.drawArraysInstanced(t.TRIANGLES,0,6,this._imageCount),Kt.DrawnImagesCount+=this._imageCount,Kt.DrawCallCount++,t.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const pt=1e-4;class gv{constructor(t){this._webglCtx=t,this._debugText=new Zl}drawRect(t,i,n,o,h={color:K.Black}){this.drawLine(G(t,i),G(t+n,i),{...h}),this.drawLine(G(t+n,i),G(t+n,i+o),{...h}),this.drawLine(G(t+n,i+o),G(t,i+o),{...h}),this.drawLine(G(t,i+o),G(t,i),{...h})}drawLine(t,i,n){var o;this._webglCtx.draw("ex.line",t,i,(o=n?.color)!==null&&o!==void 0?o:K.Black)}drawPoint(t,i={color:K.Black,size:5}){this._webglCtx.draw("ex.point",t,i.color,i.size)}drawText(t,i){this._debugText.write(this._webglCtx,t,i)}}class Ts{get z(){return this._state.current.z}set z(t){this._state.current.z=t}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(t){let i=!0;return(t.width>4096||t.height>4096)&&(i=!1),i}constructor(t){this._logger=dt.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=Me.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new Sa(()=>new Km,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new Em,this._state=new of,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=K.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new gv(this),this._totalPostProcessorTime=0;const{canvasElement:i,context:n,enableTransparency:o,antialiasing:h,uvPadding:c,multiSampleAntialiasing:_,pixelArtSampler:p,powerPreference:v,snapToPixel:x,backgroundColor:b,useDrawSorting:S,garbageCollector:P,handleContextLost:I,handleContextRestored:M}=t;if(this.__gl=n??i.getContext("webgl2",{antialias:h??this.smoothing,premultipliedAlpha:!1,alpha:o??this.transparency,depth:!1,powerPreference:v??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");I&&this.__gl.canvas.addEventListener("webglcontextlost",I,!1),M&&this.__gl.canvas.addEventListener("webglcontextrestored",M,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new ne(this.__gl,P),this.snapToPixel=x??this.snapToPixel,this.smoothing=h??this.smoothing,this.transparency=o??this.transparency,this.pixelArtSampler=p??this.pixelArtSampler,this.uvPadding=c??this.uvPadding,this.multiSampleAntialiasing=typeof _=="boolean"?_:this.multiSampleAntialiasing,this.samples=typeof _=="object"?_.samples:void 0,this.backgroundColor=b??this.backgroundColor,this.useDrawSorting=S??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const t of this._renderers.values())t.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const t=this.__gl;if(this._ortho=fi.ortho(0,t.canvas.width,t.canvas.height,0,400,-400),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!1),this.register(new Xm({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new Wu),this.register(new jm),this.register(new Jm),this.register(new Hm),this.register(new Lm),this.lazyRegister("ex.particle",()=>new _f),this.register(new _v({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=t.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");t.bindTexture(t.TEXTURE_2D,this.materialScreenTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),this._screenRenderer=new Nm(t),this._renderTarget=new $o({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),this._postProcessTargets=[new $o({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),new $o({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height})],this._msaaTarget=new $o({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(t){this._renderers.set(t.type,t),t.initialize(this.__gl,this)}lazyRegister(t,i){this._lazyRenderersFactory.set(t,i)}get(t){let i=this._renderers.get(t);if(!i){const n=this._lazyRenderersFactory.get(t);n&&(this._logger.debug("lazy init renderer:",t),i=n(),this.register(i))}return i}_isCurrentRenderer(t){return!this._currentRenderer||this._currentRenderer===t}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(t,...i){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${t}, the webgl context is lost`);return}const n=this.get(t);if(n)if(this.useDrawSorting){const o=this._drawCallPool.get();o.z=this._state.current.z,o.priority=n.priority,o.renderer=t,this.getTransform().clone(o.transform),o.state.z=this._state.current.z,o.state.opacity=this._state.current.opacity,o.state.tint=this._state.current.tint,o.state.material=this._state.current.material,o.args[0]=i[0],o.args[1]=i[1],o.args[2]=i[2],o.args[3]=i[3],o.args[4]=i[4],o.args[5]=i[5],o.args[6]=i[6],o.args[7]=i[7],o.args[8]=i[8],o.args[9]=i[9],this._drawCalls[this._drawCallIndex++]=o}else this._currentRenderer||(this._currentRenderer=n),this._isCurrentRenderer(n)||this._currentRenderer.flush(),n.draw(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9]),this._currentRenderer=n;else throw Error(`No renderer with name ${t} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(t){const i=this.__gl;this._ortho=this._ortho=fi.ortho(0,t.width,t.height,0,400,-400),this._renderTarget.setResolution(i.canvas.width,i.canvas.height),this._msaaTarget.setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[0].setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[1].setResolution(i.canvas.width,i.canvas.height)}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}drawImage(t,i,n,o,h,c,_,p,v){if(!(o===0||h===0)){{if(p===0||v===0)return;if(this._getImageWidth(t)===0||this._getImageHeight(t)===0)return}if(!t){dt.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",t,i,n,o,h,c,_,p,v):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,t,i,n,o,h,c,_,p,v):this.draw(this.imageRenderer,t,i,n,o,h,c,_,p,v)}}drawLine(t,i,n,o=1){this.draw("ex.rectangle",t,i,n,o)}drawRectangle(t,i,n,o,h,c){this.draw("ex.rectangle",t,i,n,o,h,c)}drawCircle(t,i,n,o,h){this.draw("ex.circle",t,i,n,o,h)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(t,i){this._transform.translate(this.snapToPixel?~~(t+pt):t,this.snapToPixel?~~(i+pt):i)}rotate(t){this._transform.rotate(t)}scale(t,i){this._transform.scale(t,i)}transform(t){this._transform.current=t}getTransform(){return this._transform.current}multiply(t){this._transform.current.multiply(t,this._transform.current)}addPostProcessor(t){this._postprocessors.push(t),t.initialize(this.__gl)}removePostProcessor(t){const i=this._postprocessors.indexOf(t);i!==-1&&this._postprocessors.splice(i,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(t){for(const i of this._postprocessors){const n=i.getShader();n.use();const o=n.getUniforms();this._totalPostProcessorTime+=t,o.find(h=>h.name==="u_time_ms")&&n.setUniformFloat("u_time_ms",this._totalPostProcessorTime),o.find(h=>h.name==="u_elapsed_ms")&&n.setUniformFloat("u_elapsed_ms",t),o.find(h=>h.name==="u_resolution")&&n.setUniformFloatVector("u_resolution",G(this.width,this.height)),i.onUpdate&&i.onUpdate(t)}}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return new uf({...t,graphicsContext:this})}createShader(t){const i=this.__gl,{vertexSource:n,fragmentSource:o}=t,h=new hi({gl:i,vertexSource:n,fragmentSource:o});return h.compile(),h}clear(){const t=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT)}flush(){var t;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let i=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(i.use(),this.useDrawSorting){for(let c=this._drawCallIndex;c<this._drawCalls.length;c++)this._drawCalls[c]=null;const n=new Map;for(const[c]of this._renderers){let _=0;for(_=0;_<this._drawCallIndex&&this._drawCalls[_].renderer!==c;_++);n.set(c,_)}this._drawCalls.sort((c,_)=>{if(c===null||_===null)return 0;const p=c.z-_.z,v=n.get(c.renderer)-n.get(_.renderer),x=c.priority-_.priority;return p===0?x===0?v:x:p});const o=this._transform.current,h=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let c=this._drawCalls[0].renderer,_=this.get(c);for(let p=0;p<this._drawCallIndex;p++)this._transform.current=this._drawCalls[p].transform,this._state.current=this._drawCalls[p].state,this._drawCalls[p].renderer!==c&&(_.flush(),c=this._drawCalls[p].renderer,_=this.get(c)),_ instanceof Wu&&(!((t=this.material)===null||t===void 0)&&t.isUsingScreenTexture)&&(i.copyToTexture(this.materialScreenTexture),i.use()),_.draw(...this._drawCalls[p].args);_.hasPendingDraws()&&_.flush()}this._transform.current=o,this._state.current=h,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const n of this._renderers.values())n.hasPendingDraws()&&n.flush();i.disable(),this._postprocessors.length>0&&i.toRenderSource().use();for(let n=0;n<this._postprocessors.length;n++)i=this._postProcessTargets[n%2],this._postProcessTargets[n%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[n]),this._postProcessTargets[n%2].toRenderSource().use();i.blitToScreen()}}const ce=1e-4;class pv{constructor(t){this._ex=t,this._debugText=new Zl}drawRect(t,i,n,o){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(t+ce):t,this._ex.snapToPixel?~~(i+ce):i,this._ex.snapToPixel?~~(n+ce):n,this._ex.snapToPixel?~~(o+ce):o),this._ex.__ctx.restore()}drawLine(t,i,n={color:K.Black}){var o,h;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(h=(o=n.color)===null||o===void 0?void 0:o.toString())!==null&&h!==void 0?h:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(t.x+ce):t.x,this._ex.snapToPixel?~~(t.y+ce):t.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(i.x+ce):i.x,this._ex.snapToPixel?~~(i.y+ce):i.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(t,i={color:K.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=i.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(t.x+ce):t.x,this._ex.snapToPixel?~~(t.y+ce):t.y,i.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(t,i){this._debugText.write(this._ex,t,i)}}class va{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(t){this.__ctx.imageSmoothingEnabled=t}constructor(t){this.useDrawSorting=!1,this.z=0,this.backgroundColor=K.ExcaliburBlue,this._state=new of,this.snapToPixel=!1,this.debug=new pv(this);const{canvasElement:i,context:n,enableTransparency:o,snapToPixel:h,antialiasing:c,backgroundColor:_}=t;if(this.__ctx=n??i.getContext("2d",{alpha:o??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=_??this.backgroundColor,this.snapToPixel=h??this.snapToPixel,this.smoothing=c??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(t){}drawImage(t,i,n,o,h,c,_,p,v){if(o===0||h===0)return;if(p===0||v===0)return;if(t.width===0||t.height===0)return;this.__ctx.globalAlpha=this.opacity;const x=[t,i,n,o,h,c,_,p,v].filter(b=>b!==void 0).map(b=>typeof b=="number"&&this.snapToPixel?~~b:b);this.__ctx.drawImage.apply(this.__ctx,x),Kt.DrawCallCount++,Kt.DrawnImagesCount=1}drawLine(t,i,n,o=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=n.toString(),this.__ctx.moveTo(this.snapToPixel?~~(t.x+ce):t.x,this.snapToPixel?~~(t.y+ce):t.y),this.__ctx.lineTo(this.snapToPixel?~~(i.x+ce):i.x,this.snapToPixel?~~(i.y+ce):i.y),this.__ctx.lineWidth=o,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(t,i,n,o){this.__ctx.save(),this.__ctx.fillStyle=o.toString(),this.__ctx.fillRect(this.snapToPixel?~~(t.x+ce):t.x,this.snapToPixel?~~(t.y+ce):t.y,this.snapToPixel?~~(i+ce):i,this.snapToPixel?~~(n+ce):n),this.__ctx.restore()}drawCircle(t,i,n,o,h){this.__ctx.save(),this.__ctx.beginPath(),o&&(this.__ctx.strokeStyle=o.toString()),h&&(this.__ctx.lineWidth=h),this.__ctx.fillStyle=n.toString(),this.__ctx.arc(this.snapToPixel?~~(t.x+ce):t.x,this.snapToPixel?~~(t.y+ce):t.y,i,0,Math.PI*2),this.__ctx.fill(),o&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(t,i){this.__ctx.translate(this.snapToPixel?~~(t+ce):t,this.snapToPixel?~~(i+ce):i)}rotate(t){this.__ctx.rotate(t)}scale(t,i){this.__ctx.scale(t,i)}getTransform(){throw new Error("Not implemented")}multiply(t){this.__ctx.setTransform(this.__ctx.getTransform().multiply(t.toDOMMatrix()))}addPostProcessor(t){}removePostProcessor(t){}clearPostProcessors(){}updatePostProcessors(t){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),Kt.clear()}flush(){}dispose(){this.__ctx=void 0}}var Pe;(function(d){d.Fixed="Fixed",d.FitContainerAndFill="FitContainerAndFill",d.FitScreenAndFill="FitScreenAndFill",d.FitContainerAndZoom="FitContainerAndZoom",d.FitScreenAndZoom="FitScreenAndZoom",d.FitScreen="FitScreen",d.FillScreen="FillScreen",d.FitContainer="FitContainer",d.FillContainer="FillContainer"})(Pe||(Pe={}));class Pl{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const mv={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class Tl{constructor(t){var i,n,o,h;this.events=new $t,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=dt.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const c=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(c),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new ct,this._unsafeArea=new ct,this.viewport=t.viewport,this.resolution=(i=t.resolution)!==null&&i!==void 0?i:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(n=t.displayMode)!==null&&n!==void 0?n:Pe.Fixed,this._canvas=t.canvas,this.graphicsContext=t.context,this._antialiasing=(o=t.antialiasing)!==null&&o!==void 0?o:this._antialiasing,this._canvasImageRendering=(h=t.canvasImageRendering)!==null&&h!==void 0?h:this._canvasImageRendering,this._browser=t.browser,this._pixelRatioOverride=t.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const t=this.worldToPageCoordinates(k.Zero);return this.worldToPageCoordinates(G(1,0)).sub(t).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(t){this._pixelRatioOverride=t}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case Pe.FillContainer:case Pe.FitContainer:case Pe.FitContainerAndFill:case Pe.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(t){this._resolution=t}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(t){this._viewport=t}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(t){this._camera=t}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof Ts&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let o=Math.max(1,this.pixelRatio-.5),h=!1;for(;o>1&&!h;){o=Math.max(1,o-.5);const c=this._resolution.width*o,_=this._resolution.height*o;h=this.graphicsContext.checkIfResolutionSupported({width:c,height:_})}this.pixelRatioOverride=o,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const t=this.viewport.widthUnit==="percent"?"%":"px",i=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+t,this._canvas.style.height=this.viewport.height+i,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof va&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(t){this._antialiasing=t,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(t){return this.enterFullscreen(t)}enterFullscreen(t){var i,n,o,h,c,_;if(t){const p=document.getElementById(t);if(p?.requestFullscreen||p?.webkitRequestFullscreen){if(p.getAttribute("ex-fullscreen-listener")||(p.setAttribute("ex-fullscreen-listener","true"),p.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),p.requestFullscreen)return(i=p.requestFullscreen())!==null&&i!==void 0?i:Promise.resolve();if(p.webkitRequestFullscreen)return(n=p.webkitRequestFullscreen())!==null&&n!==void 0?n:Promise.resolve()}}return!((o=this._canvas)===null||o===void 0)&&o.requestFullscreen?(c=(h=this._canvas)===null||h===void 0?void 0:h.requestFullscreen())!==null&&c!==void 0?c:Promise.resolve():this._canvas.webkitRequestFullscreen?(_=this._canvas.webkitRequestFullscreen())!==null&&_!==void 0?_:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(t){return{width:t.widthUnit==="percent"?this.canvas.offsetWidth:t.width,height:t.heightUnit==="percent"?this.canvas.offsetHeight:t.height}}pageToScreenCoordinates(t){let i=t.x,n=t.y;this._isFullscreen||(i-=Or(this._canvas).x,n-=Or(this._canvas).y);const o=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,c=(window.innerHeight-h)/2;n=(n-c)/h*o.height,i=i/window.innerWidth*o.width}else{const h=window.innerHeight*this.aspectRatio,c=(window.innerWidth-h)/2;i=(i-c)/h*o.width,n=n/window.innerHeight*o.height}return i=i/o.width*this.resolution.width,n=n/o.height*this.resolution.height,i=i-this.contentArea.left,n=n-this.contentArea.top,new k(i,n)}screenToPageCoordinates(t){let i=t.x,n=t.y;const o=this._viewportToPixels(this.viewport);if(i=i/this.resolution.width*o.width,n=n/this.resolution.height*o.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,c=(window.innerHeight-h)/2;n=n/o.height*h+c,i=i/o.width*window.innerWidth}else{const h=window.innerHeight*this.aspectRatio,c=(window.innerWidth-h)/2;i=i/o.width*h+c,n=n/o.height*window.innerHeight}return this._isFullscreen||(i+=Or(this._canvas).x,n+=Or(this._canvas).y),new k(i,n)}screenToWorldCoordinates(t){return t=t.add(G(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(t):t.sub(G(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(t){return this._camera?this._camera.transform.multiply(t):t.add(G(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(t){const i=this.pageToScreenCoordinates(t);return this.screenToWorldCoordinates(i)}worldToPageCoordinates(t){const i=this.worldToScreenCoordinates(t);return this.screenToPageCoordinates(i)}getWorldBounds(){return ct.fromDimension(this.resolution.width,this.resolution.height,k.Half).scale(G(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero,k.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return G(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=this.aspectRatio;let i=0,n=0;window.innerWidth/t<window.innerHeight?(i=window.innerWidth,n=window.innerWidth/t):(i=window.innerHeight*t,n=window.innerHeight),this.viewport={width:i,height:n},this._contentArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this._unsafeArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndFill(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(t,i,n){if(this.viewport=n??{width:t,height:i},t/i<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:t*this._contentResolution.width/t,height:t*this._contentResolution.width/t*i/t};const o=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new ct({top:o,left:0,right:this._contentResolution.width,bottom:this.resolution.height-o}),this._unsafeArea=new ct({top:-o,left:0,right:this._contentResolution.width,bottom:this.resolution.height+o})}else{this.resolution={width:i*this._contentResolution.height/i*t/i,height:i*this._contentResolution.height/i};const o=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new ct({top:0,left:o,right:this.resolution.width-o,bottom:this._contentResolution.height}),this._unsafeArea=new ct({top:0,left:-o,right:this.resolution.width+o,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndZoom(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const t=this.canvas.parentElement;t.style.overflow="hidden";const{offsetWidth:i,offsetHeight:n}=this.canvas;this._computeFitAndZoom(i,n),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(t,i){const n=this.aspectRatio;let o=0,h=0;t/n<i?(o=t,h=t/n):(o=i*n,h=i);const c=t/o,_=i/h,p=Math.max(c,_),v=o*p,x=h*p;v>t?this.canvas.style.left=-(v-t)/2+"px":this.canvas.style.left="",x>i?this.canvas.style.top=-(x-i)/2+"px":this.canvas.style.top="",this.viewport={width:v,height:x};const b=ct.fromDimension(this.viewport.width,this.viewport.height,k.Zero);if(this.viewport.width>t){const S=(this.viewport.width-t)/this.viewport.width*this.resolution.width;b.top=0,b.left=S/2,b.right=this.resolution.width-S/2,b.bottom=this.resolution.height}if(this.viewport.height>i){const S=(this.viewport.height-i)/this.viewport.height*this.resolution.height;b.top=S/2,b.left=0,b.bottom=this.resolution.height-S/2,b.right=this.resolution.width}this._contentArea=b}_computeFitContainer(){const t=this.aspectRatio;let i=0,n=0,o="pixel",h="pixel";const c=this.canvas.parentElement;c.clientWidth/t<c.clientHeight?(this.canvas.style.width="100%",i=100,o="percent",n=this.canvas.offsetWidth/t):(this.canvas.style.height="100%",n=100,h="percent",i=this.canvas.offsetHeight*t),this.viewport={width:i,widthUnit:o,height:n,heightUnit:h},this._contentArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(t){this.displayMode===Pe.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===Pe.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:t.innerWidth,height:t.innerHeight},this.viewport=this.resolution),this._contentArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.displayMode===Pe.FitScreen&&this._computeFit(),this.displayMode===Pe.FitContainer&&this._computeFitContainer(),this.displayMode===Pe.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===Pe.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===Pe.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===Pe.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class Yr{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function vv(d){return!!d.playbackState}class Tn{static unlock(){return new Promise((i,n)=>{if(Tn._UNLOCKED||!Yr.create())return i(!0);const o=setTimeout(()=>{dt.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),i(!1)},200),h=Yr.create();h.resume().then(()=>{const c=h.createBuffer(1,1,22050),_=h.createBufferSource();let p=!1;_.buffer=c,_.connect(h.destination),_.onended=()=>p=!0,_.start(0),setTimeout(()=>{vv(_)?(_.playbackState===_.PLAYING_STATE||_.playbackState===_.FINISHED_STATE)&&(Tn._UNLOCKED=!0):(h.currentTime>0||p)&&(Tn._UNLOCKED=!0)},0),clearTimeout(o),i(!0)},()=>{n()})})}static isUnlocked(){return this._UNLOCKED}}Tn._UNLOCKED=!1;class Ea extends dr{get ctx(){return this._ctx}constructor(t={}){super(t),this._options=t}clone(){return new Ea({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){var i,n;!((i=this._options)===null||i===void 0)&&i.draw&&((n=this._options)===null||n===void 0||n.draw(t)),this._options.cache||this.flagDirty()}}class Cc{}Cc.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class Ia{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(t){this._currentState=t}static create(t,i){const n=new Ia;n.data=i;for(const o in t.states)n.states.set(o,{name:o,...t.states[o]});for(const o of n.states.values())for(const h of o.transitions)if(h!=="*"&&!n.states.has(h))throw Error(`Invalid state machine, state [${o.name}] has a transition to another state that doesn't exist [${h}]`);return n.currentState=n.startState=n.states.get(t.start),n}in(t){return this.currentState.name===t}go(t,i){var n,o;if(this.currentState.transitions.includes(t)||this.currentState.transitions.includes("*")){const h=this.states.get(t);return this.currentState.onExit&&((n=this.currentState)===null||n===void 0?void 0:n.onExit({to:h.name,data:this.data}))===!1||h?.onEnter&&h?.onEnter({from:this.currentState.name,eventData:i,data:this.data})===!1?!1:(this.currentState=h,!((o=this.currentState)===null||o===void 0)&&o.onState&&this.currentState.onState(),!0)}return!1}update(t){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,t)}save(t){localStorage.setItem(t,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(t){const i=JSON.parse(localStorage.getItem(t));this.currentState=this.states.get(i.currentState),this.data=i.data}}class gf{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(t){this._loop=t,this._instance&&(this._instance.loop=t,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(t){t=At(t,0,1),this._volume=t,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(t,this._audioContext.currentTime,.1):this._volumeNode.gain.value=t}get volume(){return this._volume}get duration(){var t;return(t=this._duration)!==null&&t!==void 0?t:this.getTotalPlaybackDuration()}set duration(t){this._duration=t}constructor(t){this._src=t,this._audioContext=Yr.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new bi,this._stateMachine=Ia.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:i})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,i.pausedAt*this._playbackRate):this._instance.start(0,i.pausedAt*this._playbackRate,this.duration),i.startedAt=this._audioContext.currentTime-i.pausedAt,i.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:i})=>{i==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:i,data:n})=>{n.pausedAt=(i??0)/this._playbackRate,n.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:i})=>{i.pausedAt=0,i.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:i})=>{i.pausedAt=this._audioContext.currentTime-i.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(t=()=>{}){return this._playStarted=t,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(t){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",t)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:t,startedAt:i}=this._stateMachine.data;return t?t*this._playbackRate:i?(this._audioContext.currentTime-i)*this._playbackRate:0}set playbackRate(t){this._instance.playbackRate.value=this._playbackRate=t}get playbackRate(){return this._instance.playbackRate.value}}class Sc extends wt{set bubbles(t){}get bubbles(){return!1}get _path(){return null}set _path(t){}constructor(t,i="MediaEvent"){super(),this.target=t,this._name=i}stopPropagation(){}action(){}propagate(){}layPath(t){}}class mn extends Sc{constructor(t,i){super(t,"NativeSoundEvent"),this.track=i}}class pf extends Sc{constructor(t,i){super(t,"NativeSoundProcessedEvent"),this._processedData=i,this.data=this._processedData}}function wv(d){try{const t=new Audio,i=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,n=d.match(i)[1];return!!t.canPlayType("audio/"+n)}catch(t){return dt.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",t),!1}}const xv={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class mf{set loop(t){this._loop=t;for(const i of this._tracks)i.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(t){this._volume=t;for(const i of this._tracks)i.volume=this._volume;this.events.emit("volumechange",new mn(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(t){this._duration=t}get instances(){return this._tracks}get path(){return this._resource.path}set path(t){this._resource.path=t}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}constructor(...t){this.events=new $t,this.logger=dt.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=Yr.create(),this._resource=new so("",Cc.type.arraybuffer);for(const i of t)if(wv(i)){this.path=i;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",t.join(", ")),this.logger.warn("Attempting to use",t[0]),this.path=t[0])}isLoaded(){return!!this.data}async load(){var t,i;if(this.data)return this.data;const n=await this._resource.load(),o=await this.decodeAudio(n.slice(0));return this._duration=(i=(t=this._duration)!==null&&t!==void 0?t:o?.duration)!==null&&i!==void 0?i:void 0,this.events.emit("processed",new pf(this,o)),this.data=o}async decodeAudio(t){try{return await this._audioContext.decodeAudioData(t.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(t){t&&(this._engine=t,this._engine.on("hidden",()=>{t.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{t.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(t=>t.isPlaying())}isPaused(){return this._tracks.some(t=>t.isPaused())}isStopped(){return this._tracks.some(t=>t.isStopped())}play(t){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=t||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const t of this._tracks)t.pause();this.events.emit("pause",new mn(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const t of this._tracks)t.stop();this.events.emit("stop",new mn(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._tracks.forEach(i=>{i.playbackRate=this._playbackRate})}seek(t,i=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[i].seek(t)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(t=0){return this._tracks.length?this._tracks[t].getPlaybackPosition():0}getTrackId(t){return this._tracks.indexOf(t)}async _resumePlayback(){if(this.isPaused()){const t=[];for(const i of this._tracks)t.push(i.play().then(()=>(this._tracks.splice(this.getTrackId(i),1),!0)));this.events.emit("resume",new mn(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(t)}return!0}async _startPlayback(){const t=this._getTrackInstance(this.data),i=await t.play(()=>{this.events.emit("playbackstart",new mn(this,t)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new mn(this,t));const n=this.getTrackId(t);return n!==-1&&this._tracks.splice(n,1),i}_getTrackInstance(t){var i;const n=new gf(t);return n.loop=this.loop,n.volume=this.volume,n.duration=(i=this.duration)!==null&&i!==void 0?i:0,n.playbackRate=this._playbackRate,this._tracks.push(n),n}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const bv={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function El(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class jr{get resources(){return this._resources}constructor(t){var i;this.events=new $t,this.canvas=new Ea({filtering:we.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new bi,t&&(!((i=t.loadables)===null||i===void 0)&&i.length)&&this.addResources(t.loadables)}onInitialize(t){this.engine=t,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await oa(500,this.engine.clock)}addResource(t){this._resources.push(t)}addResources(t){let i=0;const n=t.length;for(i;i<n;i++)this.addResource(t[i])}markResourceComplete(){this._numLoaded++}get progress(){const t=this._resources.length;return t>0?At(this._numLoaded,0,t)/t:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(t,i){this._totalTimeMs+=i}onDraw(t){const i=this._totalTimeMs/1e3;t.fillStyle=K.Black.toRGBA(),t.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),t.save(),t.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const n=i*10;t.strokeStyle="white",t.lineWidth=10,t.lineCap="round",t.arc(0,0,40,n,n+Math.PI*3/2),t.stroke(),t.fillStyle="white",t.font="16px sans-serif";const o=(this.progress*100).toFixed(0)+"%",h=t.measureText(o),c=Math.abs(h.actualBoundingBoxLeft)+Math.abs(h.actualBoundingBoxRight),_=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);t.fillText(o,-c/2,_/2),t.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async t=>{this.events.emit("loadresourcestart",t),await t.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",t)})}));for(const t of this._resources)t instanceof mf&&t.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await Tn.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const yv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var Av=Ie(851);class kn extends jr{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const t=document.getElementById("excalibur-play-root");return t&&(this._playButtonRootElement=t),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(t){const i=Array.isArray(t)?{loadables:t}:t;super(i),this._logger=dt.getInstance(),this._originalOptions={loadables:[]},this.events=new $t,this._playButtonShown=!1,this.logo=yv,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=K.White,this.backgroundColor="#176BAA",this._imageLoaded=new bi,this.suppressPlayButton=!1,this._playButtonStyles=Av.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let n=document.getElementById("excalibur-play");return n||(n=document.createElement("button")),n.id="excalibur-play",n.textContent=this.playButtonText,n.style.display="none",n},this._originalOptions={...kn._DEFAULT_LOADER_OPTIONS,...i}}onInitialize(t){this.engine=t,this.screen=t.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var t,i;if(this.suppressPlayButton)this.hidePlayButton(),await oa(500,(t=this.engine)===null||t===void 0?void 0:t.clock);else{const n=()=>{try{this._positionPlayButton()}catch{}};return!((i=this.engine)===null||i===void 0)&&i.browser&&this.engine.browser.window.on("resize",n),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",h=>{h.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(h=>{const c=_=>{var p;if(_.stopPropagation(),this.hidePlayButton(),!((p=this.engine)===null||p===void 0)&&p.browser&&this.engine.browser.window.off("resize",n),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(v){this._logger.error("could not go fullscreen",v)}h()};this._playButton.addEventListener("click",c),this._playButton.addEventListener("touchend",c),this._playButton.addEventListener("pointerup",c),this.engine&&this.engine.input.gamepads.once("button",()=>c(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var t;await oa(200,(t=this.engine)===null||t===void 0?void 0:t.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const t=this._image;await this._imageLoaded.promise,await t?.decode()}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:t,y:i,width:n,height:o}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const h=this._playButton.clientWidth,c=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${t+n/2-h/2}px`,this._playButtonRootElement.style.top=`${i+o/2-c/2+100}px`)}}}onDraw(t){const i=this.engine.canvasHeight/this.engine.pixelRatio,n=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),t.fillStyle=this.backgroundColor,t.fillRect(0,0,n,i);let o=i/2;const h=Math.min(this.logoWidth,n*.75);let c=n/2-h/2;this.logoPosition&&(c=this.logoPosition.x,o=this.logoPosition.y);const _=Math.floor(h*(this.logoHeight/this.logoWidth)),p=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,c,o,h,_):t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,c,o-_-20,h,_),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=p;return}let v=c,x=o;this.loadingBarPosition&&(v=this.loadingBarPosition.x,x=this.loadingBarPosition.y),t.lineWidth=2,Sl(t,v,x,h,20,10,this.loadingBarColor);const b=h*this.progress,S=5,P=b-S*2,I=20-S*2;Sl(t,v+S,x+S,P>10?P:10,I,5,null,this.loadingBarColor),this.engine.screen.antialiasing=p}}kn._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const Nu={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class vf{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("2d"))},arrayBufferSupport:function(){const t=new XMLHttpRequest;t.open("GET","/");try{t.responseType="arraybuffer"}catch{return!1}return t.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const t=document.createElement("a").style;return t.cssText="background-color:rgba(150,255,150,.5)",(""+t.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let t=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const i=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],n=this.getBrowserFeatures();for(const o of Object.keys(Nu))n[o]?(t+="(%c%c)",i.push("font-weight: bold; color: green"),i.push("font-weight: normal; color: inherit")):(t+="(%c%c)",i.push("font-weight: bold; color: red"),i.push("font-weight: normal; color: inherit")),t+=" "+Nu[o]+`
`;i.unshift(t),console.log.apply(console,i)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let t=!1;for(const i in this._criticalTests)this._criticalTests[i].call(this)||(this.failedTests.push(i),dt.getInstance().error("Critical browser feature missing, Excalibur requires:",i),t=!0);if(t)return!1;for(const i in this._warningTest)this._warningTest[i]()||dt.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",i);return!0}}var ft;(function(d){d.PreventCollision="PreventCollision",d.Passive="Passive",d.Active="Active",d.Fixed="Fixed"})(ft||(ft={}));class ss{static create(t,i){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(t)){const o=this._GROUPS.get(t);if(o.mask===i)return o;throw new Error(`Collision group ${t} already exists with a different mask!`)}const n=new Rs(t,this._CURRENT_BIT,i!==void 0?i:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(t,n),n}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(t){return this._GROUPS.get(t)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}ss._STARTING_BIT=1;ss._MAX_GROUPS=32;ss._CURRENT_GROUP=1;ss._CURRENT_BIT=ss._STARTING_BIT;ss._GROUPS=new Map;class Rs{constructor(t,i,n){this._name=t,this._category=i,this._mask=n}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(t){const i=this.category&t.mask,n=this.mask&t.category;return i!==0&&n!==0}invert(){const t=ss.create("~("+this.name+")",~this.mask|0);return t._category=~this.category,t}static combine(t){const i=t.map(h=>h.name).join("+"),o=~t.reduce((h,c)=>c.category|h,0);return ss.create(i,o)}static collidesWith(t){const i=`collidesWith(${t.map(o=>o.name).join("+")})`,n=t.reduce((o,h)=>h.category|o,0);return ss.create(i,n)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}Rs.All=new Rs("Collide with all groups",-1,-1);class $e{constructor(t,i){this.colliderA=t,this.colliderB=i,this.id=null,this.id=$e.calculatePairHash(t.id,i.id)}static canCollide(t,i){var n,o;if(t.id===i.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.localBounds.hasZeroDimensions()||i.localBounds.hasZeroDimensions())return!1;const h=(n=t?.owner)===null||n===void 0?void 0:n.get(Pt),c=(o=i?.owner)===null||o===void 0?void 0:o.get(Pt);return!(!h||!c||!h.group.canCollide(c.group)||h.collisionType===ft.Fixed&&c.collisionType===ft.Fixed||c.collisionType===ft.PreventCollision||h.collisionType===ft.PreventCollision||!h.isActive||!c.isActive)}get canCollide(){const t=this.colliderA,i=this.colliderB;return $e.canCollide(t,i)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(t){return t===this.colliderA||t===this.colliderB}static calculatePairHash(t,i){return t.value<i.value?`#${t.value}+${i.value}`:`#${i.value}+${t.value}`}}class ao{constructor(t,i){this.min=t,this.max=i}overlaps(t){return this.max>t.min&&t.max>this.min}getOverlap(t){return this.overlaps(t)?this.max>t.max?t.max-this.min:this.max-t.min:0}}class Il{constructor(t){this.parent=t,this.parent=t||null,this.data=null,this.bounds=new ct,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class Pc{constructor(t,i=new ct(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=t,this.worldBounds=i,this.root=null,this.nodes={}}_insert(t){if(this.root===null){this.root=t,this.root.parent=null;return}const i=t.bounds;let n=this.root;for(;!n.isLeaf();){const _=n.left,p=n.right,v=n.bounds.getPerimeter(),b=n.bounds.combine(i).getPerimeter(),S=2*b,P=2*(b-v);let I=0;const M=i.combine(_.bounds);let R,T;_.isLeaf()?I=M.getPerimeter()+P:(T=_.bounds.getPerimeter(),R=M.getPerimeter(),I=R-T+P);let F=0;const W=i.combine(p.bounds);if(p.isLeaf()?F=W.getPerimeter()+P:(T=p.bounds.getPerimeter(),R=W.getPerimeter(),F=R-T+P),S<I&&S<F)break;I<F?n=_:n=p}const o=n.parent,h=new Il(o);h.bounds=i.combine(n.bounds),h.height=n.height+1,o!==null?(o.left===n?o.left=h:o.right=h,h.left=n,h.right=t,n.parent=h,t.parent=h):(h.left=n,h.right=t,n.parent=h,t.parent=h,this.root=h);let c=t.parent;for(;c;){if(c=this._balance(c),!c.left)throw new Error("Parent of current leaf cannot have a null left child"+c);if(!c.right)throw new Error("Parent of current leaf cannot have a null right child"+c);c.height=1+Math.max(c.left.height,c.right.height),c.bounds=c.left.bounds.combine(c.right.bounds),c=c.parent}}_remove(t){if(t===this.root){this.root=null;return}const i=t.parent,n=i.parent;let o;if(i.left===t?o=i.right:o=i.left,n){n.left===i?n.left=o:n.right=o,o.parent=n;let h=n;for(;h;)h=this._balance(h),h.bounds=h.left.bounds.combine(h.right.bounds),h.height=1+Math.max(h.left.height,h.right.height),h=h.parent}else this.root=o,o.parent=null}trackCollider(t){const i=new Il;i.data=t,i.bounds=t.bounds,i.bounds.left-=2,i.bounds.top-=2,i.bounds.right+=2,i.bounds.bottom+=2,this.nodes[t.id.value]=i,this._insert(i)}updateCollider(t){var i;const n=this.nodes[t.id.value];if(!n)return!1;const o=t.bounds;if(!this.worldBounds.contains(o))return dt.getInstance().warn("Collider with id "+t.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(t),!1;if(n.bounds.contains(o))return!1;if(this._remove(n),o.left-=this._config.boundsPadding,o.top-=this._config.boundsPadding,o.right+=this._config.boundsPadding,o.bottom+=this._config.boundsPadding,t.owner){const h=(i=t.owner)===null||i===void 0?void 0:i.get(Pt);if(h){const c=h.vel.x*32/1e3*this._config.velocityMultiplier,_=h.vel.y*32/1e3*this._config.velocityMultiplier;c<0?o.left+=c:o.right+=c,_<0?o.top+=_:o.bottom+=_}}return n.bounds=o,this._insert(n),!0}untrackCollider(t){const i=this.nodes[t.id.value];i&&(this._remove(i),this.nodes[t.id.value]=null,delete this.nodes[t.id.value])}_balance(t){if(t===null)throw new Error("Cannot balance at null node");if(t.isLeaf()||t.height<2)return t;const i=t.left,n=t.right,o=t,h=i,c=n,_=i.left,p=i.right,v=n.left,x=n.right,b=c.height-h.height;if(b>1)return c.left=o,c.parent=o.parent,o.parent=c,c.parent?c.parent.left===o?c.parent.left=c:c.parent.right=c:this.root=c,v.height>x.height?(c.right=v,o.right=x,x.parent=o,o.bounds=h.bounds.combine(x.bounds),c.bounds=o.bounds.combine(v.bounds),o.height=1+Math.max(h.height,x.height),c.height=1+Math.max(o.height,v.height)):(c.right=x,o.right=v,v.parent=o,o.bounds=h.bounds.combine(v.bounds),c.bounds=o.bounds.combine(x.bounds),o.height=1+Math.max(h.height,v.height),c.height=1+Math.max(o.height,x.height)),c;if(b<-1){if(h.left=o,h.parent=o.parent,o.parent=h,h.parent)if(h.parent.left===o)h.parent.left=h;else{if(h.parent.right!==o)throw"Error rotating Dynamic Tree";h.parent.right=h}else this.root=h;return _.height>p.height?(h.right=_,o.left=p,p.parent=o,o.bounds=c.bounds.combine(p.bounds),h.bounds=o.bounds.combine(_.bounds),o.height=1+Math.max(c.height,p.height),h.height=1+Math.max(o.height,_.height)):(h.right=p,o.left=_,_.parent=o,o.bounds=c.bounds.combine(_.bounds),h.bounds=o.bounds.combine(p.bounds),o.height=1+Math.max(c.height,_.height),h.height=1+Math.max(o.height,p.height)),h}return t}getHeight(){return this.root===null?0:this.root.height}query(t,i){const n=t.bounds,o=h=>{if(h&&h.bounds.overlaps(n))if(h.isLeaf()&&h.data!==t){if(i.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}rayCastQuery(t,i=1/0,n){const o=h=>{if(h&&h.bounds.rayCast(t,i))if(h.isLeaf()){if(n.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}getNodes(){const t=i=>i?[i].concat(t(i.left),t(i.right)):[];return t(this.root)}debug(t){const i=n=>{n&&(n.isLeaf()?n.bounds.draw(t,K.Green):n.bounds.draw(t,K.White),n.left&&i(n.left),n.right&&i(n.right))};i(this.root)}}class Sn{constructor(t,i){this.pos=t,this.dir=i.normalize()}intersect(t){const i=t.begin.sub(this.pos);if(this.dir.cross(t.getSlope())===0&&i.cross(this.dir)!==0)return-1;const n=this.dir.cross(t.getSlope());if(n===0)return-1;const o=i.cross(t.getSlope())/n;if(o>=0){const h=i.cross(this.dir)/n/t.getLength();if(h>=0&&h<=1)return o}return-1}intersectPoint(t){const i=this.intersect(t);return i<0?null:this.getPoint(i)}getPoint(t){return this.pos.add(this.dir.scale(t))}}class wa{constructor(t){this._config=t,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new Pc(t.dynamicTree)}getColliders(){return this._colliders}query(t){const i=[];return t instanceof ct?this._dynamicCollisionTree.query({id:Rn("collider",-1),owner:null,bounds:t},n=>(i.push(n),!1)):this._dynamicCollisionTree.query({id:Rn("collider",-1),owner:null,bounds:new ct(t.x,t.y,t.x,t.y)},n=>(i.push(n),!1)),i}rayCast(t,i){var n,o,h;const c=[],_=(n=i?.maxDistance)!==null&&n!==void 0?n:1/0,p=i?.collisionGroup,v=p?p.category:(o=i?.collisionMask)!==null&&o!==void 0?o:Rs.All.category,x=(h=i?.searchAllColliders)!==null&&h!==void 0?h:!1;return this._dynamicCollisionTree.rayCastQuery(t,_,b=>{const P=b.owner.get(Pt);if(i?.ignoreCollisionGroupAll&&P.group===Rs.All)return!1;const I=(v&P.group.category)!==0;if(P?.group&&!I)return!1;const M=b.rayCast(t,_);if(M){if(i?.filter){if(i.filter(M)&&(c.push(M),!x))return!0}else if(c.push(M),!x)return!0}return!1}),c}track(t){if(!t){dt.getInstance().warn("Cannot track null collider");return}if(t instanceof Ee){const i=t.getColliders();for(const n of i)n.owner=t.owner,this._colliders.push(n),this._dynamicCollisionTree.trackCollider(n)}else this._colliders.push(t),this._dynamicCollisionTree.trackCollider(t)}untrack(t){if(!t){dt.getInstance().warn("Cannot untrack a null collider");return}if(t instanceof Ee){const i=t.getColliders();for(const n of i){const o=this._colliders.indexOf(n);o!==-1&&this._colliders.splice(o,1),this._dynamicCollisionTree.untrackCollider(n)}}else{const i=this._colliders.indexOf(t);i!==-1&&this._colliders.splice(i,1),this._dynamicCollisionTree.untrackCollider(t)}}_pairExists(t,i){const n=$e.calculatePairHash(t.id,i.id);return this._pairs.has(n)}broadphase(t,i,n){const o=i/1e3,h=t.filter(_=>{var p,v;const x=(p=_.owner)===null||p===void 0?void 0:p.get(Pt);return((v=_.owner)===null||v===void 0?void 0:v.isActive)&&x.collisionType!==ft.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let c;for(let _=0,p=h.length;_<p;_++)c=h[_],this._dynamicCollisionTree.query(c,v=>{if(!this._pairExists(c,v)&&$e.canCollide(c,v)){const x=new $e(c,v);this._pairs.add(x.id),this._collisionPairCache.push(x)}return!1});if(n&&(n.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const _ of h){const p=_.owner.get(Pt);if(p.collisionType!==ft.Active)continue;const v=p.vel.magnitude*o+p.acc.magnitude*.5*o*o,x=Math.min(_.bounds.height,_.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||v>x/2){n&&n.physics.fastBodies++;const b=p.globalPos.sub(p.oldPos),S=_.center,P=_.getFurthestPoint(p.vel),I=P.sub(b),M=new Sn(I,p.vel);M.pos=M.pos.add(M.dir.scale(-2*this._config.continuous.surfaceEpsilon));let R,T=new k(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(M,v+this._config.continuous.surfaceEpsilon*2,F=>{if(!this._pairExists(_,F)&&$e.canCollide(_,F)){const W=F.rayCast(M,v+this._config.continuous.surfaceEpsilon*10);if(W){const U=W.point.sub(I);U.magnitude<T.magnitude&&(T=U,R=F)}}return!1}),R&&k.isValid(T)){const F=new $e(_,R);this._pairs.has(F.id)||(this._pairs.add(F.id),this._collisionPairCache.push(F));const W=S.sub(P);p.globalPos=I.add(W).add(T).add(M.dir.scale(10*this._config.continuous.surfaceEpsilon)),_.update(p.transform.get()),n&&n.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(t,i){let n=[];for(let o=0;o<t.length;o++){const h=t[o].collide();if(n=n.concat(h),i&&h.length>0)for(const c of h)i.physics.contacts.set(c.id,c)}return i&&(i.physics.collisions+=n.length),n}update(t){let i=0;const n=t.length;for(let o=0;o<n;o++)this._dynamicCollisionTree.updateCollider(t[o])&&i++;return i}debug(t){this._dynamicCollisionTree.debug(t)}}class tn{constructor(){this.id=Rn("collider",tn._ID++),this.composite=null,this.events=new $t,this.offset=k.Zero}touching(t){return!!this.collide(t)}}tn._ID=0;var Zr;(function(d){d.Arcade="arcade",d.Realistic="realistic"})(Zr||(Zr={}));var Ds;(function(d){d.None="none",d.VerticalFirst="vertical-first",d.HorizontalFirst="horizontal-first"})(Ds||(Ds={}));const Tc={vertical:1,horizontal:2},Ec={horizontal:1,vertical:2},Ic={horizontal:0,vertical:0};var ir;(function(d){d.DynamicTree="dynamic-tree",d.SparseHashGrid="sparse-hash-grid"})(ir||(ir={}));const Es=()=>({enabled:!0,gravity:G(0,0).clone(),solver:Zr.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:ir.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:Ds.None},realistic:{contactSolveBias:Ds.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class Ee extends tn{set compositeStrategy(t){this._compositeStrategy=t}get compositeStrategy(){return this._compositeStrategy}constructor(t){super(),this._collisionProcessor=new wa({...Es()}),this._dynamicAABBTree=new Pc({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const i of t)this.addCollider(i)}clearColliders(){this._colliders=[]}addCollider(t){let i;t instanceof Ee?(i=t.getColliders(),i.forEach(n=>n.offset.addEqual(t.offset))):i=[t];for(const n of i)n.events.pipe(this.events),n.composite=this,this._colliders.push(n),this._collisionProcessor.track(n),this._dynamicAABBTree.trackCollider(n)}removeCollider(t){t.events.pipe(this.events),t.composite=null,lr(t,this._colliders),this._collisionProcessor.untrack(t),this._dynamicAABBTree.untrackCollider(t)}getColliders(){return this._colliders}get worldPos(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:k.Zero).add(this.offset)}get center(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:k.Zero).add(this.offset)}get bounds(){var t,i;const n=this.getColliders();return n.reduce((h,c)=>h.combine(c.bounds),(i=(t=n[0])===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new ct().translate(this.worldPos)).translate(this.offset)}get localBounds(){var t,i;const n=this.getColliders();return n.reduce((h,c)=>h.combine(c.localBounds),(i=(t=n[0])===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new ct)}get axes(){const t=this.getColliders();let i=[];for(const n of t)i=i.concat(n.axes);return i}getFurthestPoint(t){const i=this.getColliders(),n=[];for(const c of i)n.push(c.getFurthestPoint(t));let o=n[0],h=-Number.MAX_VALUE;for(const c of n){const _=c.dot(t);_>h&&(o=c,h=_)}return o}getInertia(t){const i=this.getColliders();let n=0;for(const o of i)n+=o.getInertia(t);return n}collide(t){let i=[t];t instanceof Ee&&(i=t.getColliders());const n=[];for(const h of i)this._dynamicAABBTree.query(h,c=>(n.push(new $e(h,c)),!1));let o=[];for(const h of n)o=o.concat(h.collide());return o}getClosestLineBetween(t){const i=this.getColliders(),n=[];if(t instanceof Ee){const o=t.getColliders();for(const h of i)for(const c of o){const _=h.getClosestLineBetween(c);_&&n.push(_)}}else for(const o of i){const h=t.getClosestLineBetween(o);h&&n.push(h)}if(n.length){let o=n[0].getLength(),h=n[0];for(const c of n){const _=c.getLength();_<o&&(o=_,h=c)}return h}return null}contains(t){const i=this.getColliders();for(const n of i)if(n.contains(t))return!0;return!1}rayCast(t,i){const n=this.getColliders(),o=[];for(const h of n){const c=h.rayCast(t,i);c&&o.push(c)}if(o.length){let h=o[0],c=h.point.dot(t.dir);for(const _ of o){const p=t.dir.dot(_.point);p<c&&(h=_,c=p)}return h}return null}project(t){const i=this.getColliders(),n=[];for(const o of i){const h=o.project(t);h&&n.push(h)}if(n.length){const o=new ao(n[0].min,n[0].max);for(const h of n)o.min=Math.min(h.min,o.min),o.max=Math.max(h.max,o.max);return o}return null}update(t){if(t){const i=this.getColliders();for(const n of i)n.owner=this.owner,n.update(t)}}debug(t,i,n){const o=this.getColliders();t.save(),t.translate(this.offset.x,this.offset.y);for(const h of o)h.debug(t,i,n);t.restore()}clone(){const t=new Ee(this._colliders.map(i=>i.clone()));return t.offset=this.offset.clone(),t}}class de{constructor(t,i){this.begin=t,this.end=i}clone(t){const i=t||new de(this.begin.clone(),this.end.clone());return i.begin=this.begin.clone(i.begin),i.end=this.end.clone(i.end),i}transform(t,i){const n=i||new de(k.Zero,k.Zero);return n.begin=t.multiply(this.begin,n.begin),n.end=t.multiply(this.end,n.end),n}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const t=this.begin,i=this.end,n=t.distance(i);return this._slope=i.sub(t).scale(1/n)}getEdge(){const t=this.begin;return this.end.sub(t)}getLength(){const t=this.begin,i=this.end;return t.distance(i)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new de(this.end,this.begin)}below(t){return(this.end.x-this.begin.x)*(t.y-this.begin.y)-(this.end.y-this.begin.y)*(t.x-this.begin.x)>=0}clip(t,i,n=!0){let o=t;n&&(o=o.normalize());const h=o.dot(this.begin)-i,c=o.dot(this.end)-i,_=[];if(h<=0&&_.push(this.begin),c<=0&&_.push(this.end),h*c<0){const p=h/(h-c);_.push(this.begin.add(this.end.sub(this.begin).scale(p)))}return _.length!==2?null:new de(_[0],_[1])}distanceToPoint(t,i=!1){const n=t.x,o=t.y,h=this.getLength(),c=this.end.y-this.begin.y,_=this.end.x-this.begin.x,p=(c*n-_*o+this.end.x*this.begin.y-this.end.y*this.begin.x)/h;return i?p:Math.abs(p)}findVectorToPoint(t){const i=this.begin.sub(t),n=this.getSlope();return i.sub(n.scale(i.dot(n)))}findPoint(t=null,i=null){const n=this.slope,o=this.intercept;if(t!==null)return new k(t,n*t+o);if(i!==null)return new k((i-o)/n,i);throw new Error("You must provide an X or a Y value")}hasPoint(){let t,i=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")t=new k(arguments[0],arguments[1]),i=arguments[2]||0;else if(arguments[0]instanceof k)t=arguments[0],i=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const n=t.x-this.begin.x,o=t.y-this.begin.y,h=this.end.x-this.begin.x,c=this.end.y-this.begin.y,_=n*c-o*h;return Math.abs(_)>i?!1:Math.abs(h)>=Math.abs(c)?h>0?this.begin.x<=t.x&&t.x<=this.end.x:this.end.x<=t.x&&t.x<=this.begin.x:c>0?this.begin.y<=t.y&&t.y<=this.end.y:this.end.y<=t.y&&t.y<=this.begin.y}}function cl(d,t){const n=d.dir(),o=t.dir(),h=n.dot(n),c=o.dot(o);if(h<1e-9&&c<1e-9)return new de(d.begin,t.begin);if(h<1e-9){const R=At(o.dot(d.begin.sub(t.begin))/c,0,1),T=t.begin.add(o.scale(R));return new de(d.begin,T)}if(c<1e-9){const R=At(n.dot(t.begin.sub(d.begin))/h,0,1),T=d.begin.add(n.scale(R));return new de(T,t.begin)}const _=d.begin.sub(t.begin),p=h,v=c,x=o.dot(_),b=p*v-Math.pow(n.dot(o),2);let S=0,P=0;Math.abs(b)>1e-9?S=At((n.dot(o)*x-v*n.dot(_))/b,0,1):S=At(n.dot(_)/p,0,1),Math.abs(v)>1e-9?P=At((n.dot(o)*S+x)/v,0,1):P=0;const I=d.begin.add(n.scale(S)),M=t.begin.add(o.scale(P));return new de(I,M)}const ns={PolygonPolygonClosestLine(d,t){const i=d.getSides(),n=t.getSides();let o=Number.MAX_VALUE,h=null;for(let c=0;c<i.length;c++)for(let _=0;_<n.length;_++){const p=cl(i[c],n[_]),v=p.getLength();v<o&&(o=v,h=p)}return h},PolygonEdgeClosestLine(d,t){const n=t.worldPos.sub(d.worldPos),o=new Sn(d.worldPos,n),h=d.rayCast(o).point.add(o.dir.scale(.1)),c=d.getClosestFace(h),_=t.asLine();return cl(c.face,_)},PolygonCircleClosestLine(d,t){const i=t.worldPos,n=i.sub(d.worldPos),o=new Sn(d.worldPos,n.normalize()),h=d.rayCast(o).point.add(o.dir.scale(.1)),c=d.getClosestFace(h),_=c.face.begin,p=c.face.getEdge();let v=(p.x*(i.x-_.x)+p.y*(i.y-_.y))/(p.x*p.x+p.y*p.y);v>1?v=1:v<0&&(v=0);const x=Math.sqrt(Math.pow(_.x+p.x*v-i.x,2)+Math.pow(_.y+p.y*v-i.y,2))-t.radius,b=(_.x+p.x*v-i.x)*t.radius/(t.radius+x),S=(_.y+p.y*v-i.y)*t.radius/(t.radius+x);return new de(p.scale(v).add(_),new k(i.x+b,i.y+S))},CircleCircleClosestLine(d,t){const n=t.worldPos.sub(d.worldPos),h=d.worldPos.sub(t.worldPos),c=new Sn(d.worldPos,n),_=new Sn(t.worldPos,h),p=d.rayCast(c),v=t.rayCast(_);return new de(p.point,v.point)},CircleEdgeClosestLine(d,t){const i=d.worldPos,n=t.asLine(),o=n.begin,h=n.getEdge(),c=o,_=h;let p=(_.x*(i.x-c.x)+_.y*(i.y-c.y))/(_.x*_.x+_.y*_.y);p>1?p=1:p<0&&(p=0);const v=Math.sqrt(Math.pow(c.x+_.x*p-i.x,2)+Math.pow(c.y+_.y*p-i.y,2))-d.radius,x=(c.x+_.x*p-i.x)*d.radius/(d.radius+v),b=(c.y+_.y*p-i.y)*d.radius/(d.radius+v);return new de(_.scale(p).add(c),new k(i.x+x,i.y+b))},EdgeEdgeClosestLine(d,t){const i=d.asLine(),n=t.asLine();return cl(i,n)}};class Ge extends tn{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var t;if(this._radius)return this._radius;const i=this._transform,n=(t=i?.globalScale)!==null&&t!==void 0?t:k.One;return this._radius=this._naturalRadius*Math.min(n.x,n.y)}set radius(t){var i;const n=this._transform,o=(i=n?.globalScale)!==null&&i!==void 0?i:k.One;this._naturalRadius=t/Math.min(o.x,o.y),this._localBoundsDirty=!0,this._radius=t}constructor(t){super(),this.offset=k.Zero,this._globalMatrix=me.identity(),this._localBoundsDirty=!0,this.offset=t.offset||k.Zero,this.radius=t.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new Ge({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(t){var i,n;return((n=(i=this._transform)===null||i===void 0?void 0:i.pos)!==null&&n!==void 0?n:this.offset).distance(t)<=this.radius}rayCast(t,i=1/0){var n,o;const h=this.center,c=t.dir,_=t.pos,p=h.sub(_),v=c.scale(p.dot(c)),b=p.sub(v).magnitude;if(b>this.radius)return null;{let S=0;if($u(b,this.radius,1e-4)){if(S=-c.dot(_.sub(h)),S>0&&S<i){const P=t.getPoint(S);return{point:P,normal:P.sub(h).normalize(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(Pt),distance:S}}return null}else{const P=Math.sqrt(Math.pow(c.dot(_.sub(h)),2)-Math.pow(_.sub(h).distance(),2)+Math.pow(this.radius,2)),I=-c.dot(_.sub(h))+P,M=-c.dot(_.sub(h))-P,R=[];I>=0&&R.push(I),M>=0&&R.push(M);const T=Math.min(...R);if(T<=i){const F=t.getPoint(T);return{point:F,normal:F.sub(h).normalize(),collider:this,body:(o=this.owner)===null||o===void 0?void 0:o.get(Pt),distance:T}}return null}}}getClosestLineBetween(t){if(t instanceof Ge)return ns.CircleCircleClosestLine(this,t);if(t instanceof Be)return ns.PolygonCircleClosestLine(t,this).flip();if(t instanceof _i)return ns.CircleEdgeClosestLine(this,t).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Ge)return zi.CollideCircleCircle(this,t);if(t instanceof Be)return zi.CollideCirclePolygon(this,t);if(t instanceof _i)return zi.CollideCircleEdge(this,t);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){return this.center.add(t.normalize().scale(this.radius))}getFurthestLocalPoint(t){return t.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new ct(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(t){return t*this.radius*this.radius/2}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(t){const i=[],o=this.center.dot(t);return i.push(o),i.push(o+this.radius),i.push(o-this.radius),new ao(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i,n){var o,h,c,_;const{lineWidth:p}={lineWidth:1,...n},v=this._transform,x=(o=v?.globalScale)!==null&&o!==void 0?o:k.One,b=(h=v?.globalRotation)!==null&&h!==void 0?h:0,S=(c=v?.globalPos)!==null&&c!==void 0?c:k.Zero;t.save(),t.translate(S.x,S.y),t.rotate(b),t.scale(x.x,x.y),t.drawCircle((_=this.offset)!==null&&_!==void 0?_:k.Zero,this._naturalRadius,K.Transparent,i,p),t.restore()}}class vn{constructor(t,i,n,o,h,c,_,p){var v,x,b,S,P,I;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=t,this.colliderB=i,this.mtv=n,this.normal=o,this.tangent=h,this.points=c,this.localPoints=_,this.info=p,this.id=$e.calculatePairHash(t.id,i.id),t.composite||i.composite){const M=((v=t.composite)===null||v===void 0?void 0:v.compositeStrategy)==="separate"?t.id:(b=(x=t.composite)===null||x===void 0?void 0:x.id)!==null&&b!==void 0?b:t.id,R=((S=i.composite)===null||S===void 0?void 0:S.compositeStrategy)==="separate"?i.id:(I=(P=i.composite)===null||P===void 0?void 0:P.id)!==null&&I!==void 0?I:i.id;this.id+="|"+$e.calculatePairHash(M,R)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(Pt)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(Pt))}matchAwake(){const t=this.bodyA,i=this.bodyB;t&&i&&t.isSleeping!==i.isSleeping&&(t.isSleeping&&t.collisionType!==ft.Fixed&&i.sleepMotion>=t.wakeThreshold&&(t.isSleeping=!1),i.isSleeping&&i.collisionType!==ft.Fixed&&t.sleepMotion>=i.wakeThreshold&&(i.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(t){if(t!==this.colliderA&&t!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(t===this.colliderA)return this;const i=this.colliderA,n=this.colliderB;return this.colliderB=i,this.colliderA=n,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class wf{constructor(){this.axis=G(0,0),this.localAxis=G(0,0),this.side=new de(G(0,0),G(0,0)),this.localSide=new de(G(0,0),G(0,0)),this.point=G(0,0),this.localPoint=G(0,0)}}class pe{static findPolygonPolygonSeparation(t,i){if(i.transform.matrix.determinant()===0)return pe.findPolygonPolygonSeparationDegenerate(t,i);let n=-Number.MAX_VALUE,o=-1,h;const c=i.transform.inverse.multiply(t.transform.matrix,pe._SCRATCH_MATRIX),_=c.getRotation(),p=t.normals,v=t.points,x=i.points;for(let P=0;P<v.length;P++){const I=p[P].rotate(_,pe._ZERO,pe._SCRATCH_NORMAL),M=c.multiply(v[P],pe._SCRATCH_POINT);let R=Number.MAX_VALUE,T;for(let F=0;F<x.length;F++){const W=I.dot(x[F].sub(M,pe._SCRATCH_SUB_POINT));W<R&&(R=W,T=x[F])}R>n&&(n=R,o=P,h=T)}const b=(o+1)%v.length,S=pe.SeparationPool.get();return S.collider=t,S.separation=n,n>0||(p[o].clone(S.localAxis),p[o].rotate(t.transform.rotation,pe._ZERO,S.axis),t.transform.matrix.multiply(v[o],S.side.begin),t.transform.matrix.multiply(v[b],S.side.end),i.transform.matrix.multiply(h,S.point),S.sideId=o,h.clone(S.localPoint),v[o].clone(S.localSide.begin),v[b].clone(S.localSide.end)),S}static findCirclePolygonSeparation(t,i){const n=i.axes,h=i.center.sub(t.worldPos),c=i.getFurthestPoint(h.negate());n.push(c.sub(t.worldPos).normalize());let _=Number.MAX_VALUE,p=null,v=-1;for(let x=0;x<n.length;x++){const b=i.project(n[x]),S=t.project(n[x]),P=b.getOverlap(S);if(P<=0)return null;P<_&&(_=P,p=n[x],v=x)}return v<0?null:p.normalize().scale(_)}static findPolygonPolygonSeparationDegenerate(t,i){let n=-Number.MAX_VALUE,o=null,h=null,c=-1,_=null;const p=t.getSides(),v=t.getLocalSides();for(let x=0;x<p.length;x++){const b=p[x],S=b.normal(),P=i.getFurthestPoint(S.negate()),I=b.distanceToPoint(P,!0);I>n&&(n=I,o=b,h=S,c=x,_=P)}return{collider:t,separation:h?n:99,axis:h,side:o,localSide:v[c],sideId:c,point:_,localPoint:h?i.getFurthestLocalPoint(h.negate()):null}}}pe.SeparationPool=new Sa(()=>new wf,d=>d,500);pe._ZERO=G(0,0);pe._SCRATCH_POINT=G(0,0);pe._SCRATCH_SUB_POINT=G(0,0);pe._SCRATCH_NORMAL=G(0,0);pe._SCRATCH_MATRIX=me.identity();pe.SeparationPool.disableWarnings=!0;const Cv=k.Zero,Sv=k.Zero,Pv=me.identity(),zi={CollideCircleCircle(d,t){const i=d.worldPos,n=t.worldPos,o=d.radius+t.radius,h=i.distance(n);if(h>o)return[];const c=o-h,_=n.sub(i).normalize(),p=_.perpendicular(),v=_.scale(c),x=d.getFurthestPoint(_),b=d.getFurthestLocalPoint(_),S={collider:d,separation:c,axis:_,point:x};return[new vn(d,t,v,_,p,[x],[b],S)]},CollideCirclePolygon(d,t){var i,n;let o=pe.findCirclePolygonSeparation(d,t);if(!o)return[];o=o.dot(t.center.sub(d.center))<0?o.negate():o;const c=d.getFurthestPoint(o),p=((n=(i=d.owner)===null||i===void 0?void 0:i.get(st))!==null&&n!==void 0?n:new st).applyInverse(c),v=o.normalize(),x={collider:d,separation:-o.magnitude,axis:v,point:c,localPoint:p,side:t.findSide(v.negate()),localSide:t.findLocalSide(v.negate())};return[new vn(d,t,o,v,v.perpendicular(),[c],[p],x)]},CollideCircleEdge(d,t){const i=d.center,n=t.asLine(),o=n.end.sub(n.begin),h=o.dot(n.end.sub(i)),c=o.dot(i.sub(n.begin)),_=t.asLine(),p=t.asLocalLine();if(c<=0){const T=n.begin.sub(i),F=T.dot(T);if(F>d.radius*d.radius)return[];const W=T.normalize(),U=d.radius-Math.sqrt(F),V={collider:d,separation:U,axis:W,point:_.begin,side:_,localSide:p};return[new vn(d,t,W.scale(U),W,W.perpendicular(),[_.begin],[p.begin],V)]}if(h<=0){const T=n.end.sub(i),F=T.dot(T);if(F>d.radius*d.radius)return[];const W=T.normalize(),U=d.radius-Math.sqrt(F),V={collider:d,separation:U,axis:W,point:_.end,side:_,localSide:p};return[new vn(d,t,W.scale(U),W,W.perpendicular(),[_.end],[p.end],V)]}const v=o.dot(o),x=n.begin.scale(h).add(n.end.scale(c)).scale(1/v),b=i.sub(x),S=b.dot(b);if(S>d.radius*d.radius)return[];let P=o.perpendicular();P.dot(i.sub(n.begin))<0&&(P.x=-P.x,P.y=-P.y),P=P.normalize();const I=d.radius-Math.sqrt(S),M=P.scale(I),R={collider:d,separation:I,axis:P,point:x,side:_,localSide:p};return[new vn(d,t,M,P.negate(),P.negate().perpendicular(),[x],[x.sub(t.worldPos)],R)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(d,t){var i;const n=d.center,h=t.center.sub(n).normalize(),c=new Be({points:[t.begin,t.end,t.end.add(h.scale(100)),t.begin.add(h.scale(100))],offset:t.offset});c.owner=t.owner,((i=t.owner)===null||i===void 0?void 0:i.get(st))&&c.update(t.owner.get(st).get());const p=this.CollidePolygonPolygon(d,c);return p.length&&(p[0].colliderB=t,p[0].id=$e.calculatePairHash(d.id,t.id)),p},CollidePolygonPolygon(d,t){const i=pe.findPolygonPolygonSeparation(d,t);if(i.separation>0)return[];const n=pe.findPolygonPolygonSeparation(t,d);if(n.separation>0)return[];const o=i.separation>n.separation?i:n,h=o.collider===d?t:d,c=o.collider===d?d:t,_=h.transform.inverse.multiply(c.transform.matrix,Pv),p=_.getRotation(),v=c.normals[o.sideId].rotate(p,Cv,Sv);let x=Number.MAX_VALUE,b=0;for(let T=0;T<h.normals.length;T++){const F=v.dot(h.normals[T]);F<x&&(x=F,b=T)}if(!o.localSide||!o.localAxis||!o.axis)return[];const S=o.localSide.transform(_),P=o.localAxis.perpendicular().negate().rotate(p),M=new de(h.points[b],h.points[(b+1)%h.points.length]).clip(P.negate(),-P.dot(S.begin),!1);let R=null;if(M&&(R=M.clip(P,P.dot(S.end),!1)),R){const T=[],F=[],W=R.getPoints();for(let j=0;j<W.length;j++){const X=W[j];S.below(X)&&(T.push(X),F.push(h.transform.apply(X)))}let U=o.axis,V=U.perpendicular();return t.center.sub(d.center).dot(U)<0&&(U=U.negate(),V=U.perpendicular()),[new vn(d,t,U.scale(-o.separation),U,V,F,T,o)]}return[]},FindContactSeparation(d,t){var i,n,o,h;const c=d.colliderA,_=(n=(i=d.bodyA)===null||i===void 0?void 0:i.transform)!==null&&n!==void 0?n:new st,p=d.colliderB,v=(h=(o=d.bodyB)===null||o===void 0?void 0:o.transform)!==null&&h!==void 0?h:new st;if(c instanceof Ge&&p instanceof Ge){const x=c.radius+p.radius,b=_.pos.distance(v.pos);return-(x-b)}if(c instanceof Be&&p instanceof Be&&d.info.localSide){let x,b;return d.info.collider===c?(x=new de(_.apply(d.info.localSide.begin).add(c.offset),_.apply(d.info.localSide.end).add(c.offset)),b=v.apply(t).add(p.offset)):(x=new de(v.apply(d.info.localSide.begin).add(p.offset),v.apply(d.info.localSide.end).add(p.offset)),b=_.apply(t).add(c.offset)),x.distanceToPoint(b,!0)}if(c instanceof Be&&p instanceof Ge||p instanceof Be&&c instanceof Ge){const x=_.apply(t);if(d.info.side)return d.info.side.distanceToPoint(x,!0)}if(c instanceof _i&&p instanceof Be||p instanceof _i&&c instanceof Be){let x;if(d.info.collider===c?x=v.apply(t):x=_.apply(t),d.info.side)return d.info.side.distanceToPoint(x,!0)}if(c instanceof Ge&&p instanceof _i||p instanceof Ge&&c instanceof _i){const x=v.apply(t);let b;c instanceof Ge&&(b=c.getFurthestPoint(d.normal));const S=x.distance(b);if(d.info.side)return S>0?-S:0}return 0}};class _i extends tn{constructor(t){var i;super(),this._globalMatrix=me.identity(),this.begin=t.begin||k.Zero,this.end=t.end||k.Zero,this.offset=(i=t.offset)!==null&&i!==void 0?i:k.Zero}clone(){return new _i({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var t;const i=this._transform;return(t=i?.globalPos.add(this.offset))!==null&&t!==void 0?t:this.offset}get center(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.average(i)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const t=this._getTransformedBegin(),i=this._getTransformedEnd(),n=t.distance(i);return i.sub(t).scale(1/n)}getLength(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.distance(i)}contains(){return!1}rayCast(t,i=1/0){var n;const o=this._getTransformedBegin().sub(t.pos);if(t.dir.cross(this.getSlope())===0&&o.cross(t.dir)!==0)return null;const h=t.dir.cross(this.getSlope());if(h===0)return null;const c=o.cross(this.getSlope())/h;if(c>=0&&c<=i){const _=o.cross(t.dir)/h/this.getLength();if(_>=0&&_<=1)return{distance:c,normal:this.asLine().normal(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(Pt),point:t.getPoint(c)}}return null}getClosestLineBetween(t){if(t instanceof Ge)return ns.CircleEdgeClosestLine(t,this);if(t instanceof Be)return ns.PolygonEdgeClosestLine(t,this).flip();if(t instanceof _i)return ns.EdgeEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Ge)return zi.CollideCircleEdge(t,this);if(t instanceof Be)return zi.CollidePolygonEdge(t,this);if(t instanceof _i)return zi.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this._getTransformedBegin(),n=this._getTransformedEnd();return t.dot(i)>0?i:n}_boundsFromBeginEnd(t,i,n=10){return new ct(Math.min(t.x,i.x)-n,Math.min(t.y,i.y)-n,Math.max(t.x,i.x)+n,Math.max(t.y,i.y)+n)}get bounds(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return this._boundsFromBeginEnd(t,i)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new de(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new de(this.begin,this.end)}get axes(){const i=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),n=[];return n.push(i),n.push(i.negate()),n.push(i.normal()),n.push(i.normal().negate()),n}getInertia(t){const i=this.end.sub(this.begin).distance()/2;return t*i*i}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(t){const i=[],n=[this._getTransformedBegin(),this._getTransformedEnd()],o=n.length;for(let h=0;h<o;h++)i.push(n[h].dot(t));return new ao(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i){const n=this._getTransformedBegin(),o=this._getTransformedEnd();t.drawLine(n,o,i,2),t.drawCircle(n,2,i),t.drawCircle(o,2,i)}}class Te{static registerGraphicsContext(t){Te._ctx=t}static draw(t){this._drawCalls.push(t)}static drawPoint(t,i){Te.draw(n=>{n.debug.drawPoint(t,i)})}static drawLine(t,i,n){Te.draw(o=>{o.debug.drawLine(t,i,n)})}static drawLines(t,i){t.length>1&&Te.draw(n=>{for(let o=0;o<t.length-1;o++)n.debug.drawLine(t[o],t[o+1],i)})}static drawText(t,i){Te.draw(n=>{n.debug.drawText(t,i)})}static drawPolygon(t,i){t.length>1&&Te.draw(n=>{const o=t[0],h=[...t,o];for(let c=0;c<h.length-1;c++)n.debug.drawLine(h[c],h[c+1],i)})}static drawCircle(t,i,n){const{color:o,strokeColor:h,width:c}={color:K.Black,strokeColor:void 0,width:void 0,...n};Te.draw(_=>{_.drawCircle(t,i,o,h,c)})}static drawBounds(t,i){Te.draw(n=>{n.debug.drawRect(t.left,t.top,t.width,t.height,i)})}static drawRay(t,i){const{distance:n,color:o}={color:K.Blue,distance:10,...i};Te.draw(h=>{const c=t.pos,_=t.pos.add(t.dir.scale(n));h.debug.drawLine(c,_,{color:o})})}static flush(t){t.save(),t.z=Te.z;for(const i of Te._drawCalls)i(t);t.restore(),Te.clear()}static clear(){Te._drawCalls.length=0}}Te._drawCalls=[];Te.z=1/0;class Be extends tn{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(t){if(t.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=t,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const t=[];for(let i=0;i<this._points.length;i++)t.push(this._points[(i+1)%this._points.length].sub(this._points[i]).normal());this._normals=t}get points(){return this._points}get transform(){return this._transform}constructor(t){var i;super(),this._logger=dt.getInstance(),this._transform=new Is,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(i=t.offset)!==null&&i!==void 0?i:k.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=t.points,this.isConvex()||t.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(t){this._isCounterClockwiseWinding(t)||t.reverse()}_isCounterClockwiseWinding(t){let i=0;for(let n=0;n<t.length;n++)i+=(t[(n+1)%t.length].x-t[n].x)*(t[(n+1)%t.length].y+t[n].y);return i<0}isConvex(){if(this.points.length<3)return!1;let t=this.points[this.points.length-2],i=this.points[this.points.length-1],n=Math.atan2(i.y-t.y,i.x-t.x),o=0,h=0,c=0;for(const[_,p]of this.points.entries()){if(t=i,o=n,i=p,n=Math.atan2(i.y-t.y,i.x-t.x),t.equals(i))return!1;let v=n-o;if(v<=-Math.PI?v+=Math.PI*2:v>Math.PI&&(v-=Math.PI*2),_===0){if(v===0)return!1;h=v>0?1:-1}else if(h*v<=0)return!1;c+=v}return Math.abs(Math.round(c/(Math.PI*2)))===1}tessellate(){const t=[];for(let i=1;i<this.points.length-2;i++)t.push([this.points[0],this.points[i+1],this.points[i+2]]);return t.push([this.points[0],this.points[1],this.points[2]]),new Ee(t.map(i=>Ve.Polygon(i)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const t=[],i=[...this.points].reverse();let n=i.length;function o(b){return b===0?n-1:b-1}function h(b){return b===n-1?0:b+1}function c(b){const S=o(b),P=h(b),I=i[S],M=i[b],R=i[P],T=I.sub(M),F=R.sub(M);return!(T.cross(F)<0)}const _=i.map((b,S)=>c(S));function p(b,S,P,I){const M=P.sub(S),R=I.sub(P),T=S.sub(I),F=b.sub(S),W=b.sub(P),U=b.sub(I),V=M.cross(F),j=R.cross(W),X=T.cross(U);return!(V>0||j>0||X>0)}function v(){for(let b=0;b<n;b++)if(_[b]){const S=o(b),P=h(b),I=i[S],M=i[b],R=i[P];let T=!0;for(let F=0;F<n;F++){if(F===b||F===S||F===P)continue;const W=i[F];if(p(W,I,M,R)){T=!1;break}}if(T)return b}for(let b=0;b<n;b++)if(_[b])return b;return 0}function x(b){const S=o(b),P=h(b),I=i[S],M=i[b],R=i[P];t.push([I,M,R]),i.splice(b,1),_.splice(b,1),n--}for(;n>3;){const b=v();x(b);for(let S=0;S<n;S++)_[S]=c(S)}return t.push([i[0],i[1],i[2]]),new Ee(t.map(b=>Ve.Polygon(b,k.Zero,!0)))}clone(){return new Be({offset:this.offset.clone(),points:this.points.map(t=>t.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const t=this.points,i=t.length;this._transformedPoints.length=0;for(let n=0;n<i;n++)this._transformedPoints[n]=this._transform.apply(t[n].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const t=[],i=this.getTransformedPoints(),n=i.length;for(let o=0;o<n;o++)t.push(new de(i[o],i[(o+1)%n]));this._sides=t,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const t=[],i=this.points,n=i.length;for(let o=0;o<n;o++)t.push(new de(i[o],i[(o+1)%n]));this._localSides=t,this._localSidesDirty=!1}return this._localSides}findSide(t){const i=this.getSides();let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=i[h],p=c.normal().dot(t);p>o&&(n=c,o=p)}return n}findLocalSide(t){const i=this.getLocalSides();let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=i[h],p=c.normal().dot(t);p>o&&(n=c,o=p)}return n}get axes(){const t=[],i=this.getSides();for(let n=0;n<i.length;n++)t.push(i[n].normal());return t}update(t){t&&(t.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(i=>G(i.x*qt(this._transform.scale.x),i.y*qt(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(t){const i=this._transform.applyInverse(t),n=new Sn(i,new k(1,0));let o=0;const h=this.getLocalSides();for(let c=0;c<h.length;c++){const _=h[c];n.intersect(_)>=0&&o++}return o%2!==0}getClosestLineBetween(t){if(t instanceof Ge)return ns.PolygonCircleClosestLine(this,t);if(t instanceof Be)return ns.PolygonPolygonClosestLine(this,t);if(t instanceof _i)return ns.PolygonEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Ge)return zi.CollideCirclePolygon(t,this);if(t instanceof Be)return zi.CollidePolygonPolygon(this,t);if(t instanceof _i)return zi.CollidePolygonEdge(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this.getTransformedPoints();let n=null,o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=t.dot(i[h]);c>o&&(o=c,n=i[h])}return n}getFurthestLocalPoint(t){const i=this.points;let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=t.dot(i[h]);c>o&&(o=c,n=i[h])}return n}getClosestFace(t){const i=this.getSides();let n=Number.POSITIVE_INFINITY,o=-1,h=-1;for(let c=0;c<i.length;c++){const _=i[c].distanceToPoint(t);_<n&&(n=_,o=c,h=_)}return o!==-1?{distance:i[o].normal().scale(h),face:i[o]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=ct.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(t){if(this._cachedMass===t&&this._cachedInertia)return this._cachedInertia;let i=0,n=0;const o=this.points;for(let h=0;h<o.length;h++){const c=(h+1)%o.length,_=o[c].cross(o[h]);i+=_*(o[h].dot(o[h])+o[h].dot(o[c])+o[c].dot(o[c])),n+=_}return this._cachedMass=t,this._cachedInertia=t/6*(i/n)}rayCast(t,i=1/0){var n;const o=this.getSides(),h=o.length;let c=Number.MAX_VALUE,_,p=-1;for(let v=0;v<h;v++){const x=t.intersect(o[v]);x>=0&&x<c&&x<=i&&(c=x,_=o[v],p=v)}return p>=0?{collider:this,distance:c,body:(n=this.owner)===null||n===void 0?void 0:n.get(Pt),point:t.getPoint(c),normal:_.normal()}:null}project(t){const i=this.getTransformedPoints(),n=i.length;let o=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let c=0;c<n;c++){const _=i[c].dot(t);o=Math.min(o,_),h=Math.max(h,_)}return new ao(o,h)}debug(t,i,n){const o=this.getTransformedPoints();Te.drawPolygon(o,{color:i})}}class Ve{static Box(t,i,n=k.Half,o=k.Zero){return new Be({points:new ct(-t*n.x,-i*n.y,t-t*n.x,i-i*n.y).getPoints(),offset:o})}static Polygon(t,i=k.Zero,n=!1){return new Be({points:t,offset:i,suppressConvexWarning:n})}static Circle(t,i=k.Zero){return new Ge({radius:t,offset:i})}static Edge(t,i){return new _i({begin:t,end:i})}static Capsule(t,i,n=k.Zero){const o=dt.getInstance();return t===i&&o.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),i>=t?new Ee([Ve.Circle(t/2,G(0,-i/2+t/2).add(n)),Ve.Box(t,i-t,k.Half,n),Ve.Circle(t/2,G(0,i/2-t/2).add(n))]):new Ee([Ve.Circle(i/2,G(-t/2+i/2,0).add(n)),Ve.Box(t-i,i,k.Half,n),Ve.Circle(i/2,G(t/2-i/2,0).add(n))])}}class ve extends Ci{constructor(t){super(),this.events=new $t,this.$colliderAdded=new Ke,this.$colliderRemoved=new Ke,this._collidersToRemove=[],this.set(t)}get(){return this._collider}set(t){return this.clear(),t&&(this._collider=t,this._collider.owner=this.owner,t.events.pipe(this.events),this.$colliderAdded.notifyAll(t),this.update()),t}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const t of this._collidersToRemove)t.events.unpipe(this.events),this.$colliderRemoved.notifyAll(t),t.owner=null}clone(){return new ve(this._collider.clone())}get bounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new ct}get localBounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new ct}update(){var t;const i=(t=this.owner)===null||t===void 0?void 0:t.get(st);this._collider&&(this._collider.owner=this.owner,i&&this._collider.update(i.get()))}collide(t){let i=this._collider,n=t._collider;if(!i||!n)return[];let o=!1;if(n instanceof Ee&&(i=n,n=this._collider,o=!0),this._collider){const h=i.collide(n);return h?(o&&h.forEach(c=>{c.mtv=c.mtv.negate(),c.normal=c.normal.negate(),c.tangent=c.normal.perpendicular(),c.colliderA=this._collider,c.colliderB=t._collider}),h):[]}return[]}onAdd(t){this._collider&&this.update(),this.events.on("precollision",i=>{const n=i;t.events.emit("precollision",new Mn(n.self,n.other,n.side,n.intersection,n.contact)),t instanceof ti&&t.onPreCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("postcollision",i=>{const n=i;t.events.emit("postcollision",new Bn(n.self,n.other,n.side,n.intersection,n.contact)),t instanceof ti&&t.onPostCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("collisionstart",i=>{const n=i;t.events.emit("collisionstart",new Xr(n.self,n.other,n.side,n.contact)),t instanceof ti&&t.onCollisionStart(n.self,n.other,n.side,n.contact)}),this.events.on("collisionend",i=>{const n=i;t.events.emit("collisionend",new qr(n.self,n.other,n.side,n.lastContact)),t instanceof ti&&t.onCollisionEnd(n.self,n.other,n.side,n.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(t,i,n=k.Half,o=k.Zero){const h=Ve.Box(t,i,n,o);return this.set(h)}usePolygonCollider(t,i=k.Zero){const n=Ve.Polygon(t,i);return this.set(n)}useCircleCollider(t,i=k.Zero){const n=Ve.Circle(t,i);return this.set(n)}useEdgeCollider(t,i){const n=Ve.Edge(t,i);return this.set(n)}useCompositeCollider(t){return this.set(new Ee(t))}}var ri;(function(d){d.Rotation="rotation",d.X="x",d.Y="y"})(ri||(ri={}));class Pt extends Ci{constructor(t){var i,n,o;super(),this.dependencies=[st,kt],this.id=Rn("body",Pt._ID++),this.events=new $t,this.oldTransform=new Is,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=ft.PreventCollision,this.group=Rs.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=k.Zero,this.oldVel=new k(0,0),this.oldAcc=k.Zero,this._impulseScratch=G(0,0),this._distanceFromCenterScratch=G(0,0),t?(this.collisionType=(i=t.type)!==null&&i!==void 0?i:this.collisionType,this.group=(n=t.group)!==null&&n!==void 0?n:this.group,this.useGravity=(o=t.useGravity)!==null&&o!==void 0?o:this.useGravity,this._bodyConfig={...Es().bodies,...t.config}):this._bodyConfig={...Es().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=Pt._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(t){this._bodyConfig={...Es().bodies,...t},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(t){Pt._DEFAULT_CONFIG=t}get mass(){return this._mass}set mass(t){this._mass=t,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===ft.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(t){this.isSleeping=t}set isSleeping(t){this._sleeping=t,t?(this.vel=k.Zero,this.acc=k.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const t=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),i=this._bodyConfig.sleepBias;this.sleepMotion=i*this.sleepMotion+(1-i)*t,this.sleepMotion=At(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const t=this.owner.get(ve);if(t){t.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),t.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const i=t.get();if(i)return this._cachedInertia=i.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===ft.Fixed?0:1/this.inertia}get active(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get isActive(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get center(){return this.globalPos}onAdd(t){var i,n;this.transform=(i=this.owner)===null||i===void 0?void 0:i.get(st),this.motion=(n=this.owner)===null||n===void 0?void 0:n.get(kt)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get globalPos(){return this.transform.globalPos}set globalPos(t){this.transform.globalPos=t}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t}get torque(){return this.motion.torque}set torque(t){this.motion.torque=t}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(t){this.transform.globalRotation=t}get scale(){return this.transform.globalScale}set scale(t){this.transform.globalScale=t}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(t){this.motion.scaleFactor=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}applyImpulse(t,i){if(this.collisionType!==ft.Active)return;const n=i.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(ri.X)>-1&&(n.x=0),this.limitDegreeOfFreedom.indexOf(ri.Y)>-1&&(n.y=0),this.vel.addEqual(n),!this.limitDegreeOfFreedom.includes(ri.Rotation)){const o=t.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*o.cross(i)}}applyLinearImpulse(t){if(this.collisionType!==ft.Active)return;const i=t.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(ri.X)&&(i.x=0),this.limitDegreeOfFreedom.includes(ri.Y)&&(i.y=0),this.vel=this.vel.add(i)}applyAngularImpulse(t,i){if(this.collisionType===ft.Active&&!this.limitDegreeOfFreedom.includes(ri.Rotation)){const n=t.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*n.cross(i)}}captureOldTransform(){this.__oldTransformCaptured=!0;const t=this.transform.get();t.clone(this.oldTransform),this.oldTransform.parent=t.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}Pt._ID=0;Pt._DEFAULT_CONFIG={...Es().bodies};class ho extends dr{constructor(t){super(t),this.width=t.width,this.height=t.height,this.rasterize()}clone(){return new ho({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.color&&t.fillRect(0,0,this.width,this.height),this.strokeColor&&t.strokeRect(0,0,this.width,this.height)}}class Ra extends dr{get radius(){return this._radius}set radius(t){this._radius=t,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(t){var i,n,o;super(t),this._radius=0;const h=(i=t.lineWidth)!==null&&i!==void 0?i:t.strokeColor?1:0;this.padding=(n=t.padding)!==null&&n!==void 0?n:2+h/2,this.radius=t.radius,this.filtering=(o=t.filtering)!==null&&o!==void 0?o:we.Blended,this.rasterize()}clone(){return new Ra({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.radius>0&&(t.beginPath(),t.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&t.fill(),this.strokeColor&&t.stroke())}}class Js extends Ci{constructor(t){var i,n;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(i=t?.useColliderShape)!==null&&i!==void 0?i:this.useColliderShape,this.useGraphicsBounds=(n=t?.useGraphicsBounds)!==null&&n!==void 0?n:this.useGraphicsBounds,this.localBounds=t?.localBounds}}class Xt{static CreateReversibleEasingFunction(t){return(i,n,o,h)=>o<n?n-(t(i,o,n,h)-o):t(i,n,o,h)}static CreateVectorEasingFunction(t){return(i,n,o,h)=>new k(t(i,n.x,o.x,h),t(i,n.y,o.y,h))}}Xt.Linear=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,i*d/n+t));Xt.EaseInQuad=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,i*d*d+t));Xt.EaseOutQuad=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,-i*d*(d-2)+t));Xt.EaseInOutQuad=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n/2,d<1?i/2*d*d+t:(d--,-i/2*(d*(d-2)-1)+t)));Xt.EaseInCubic=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,i*d*d*d+t));Xt.EaseOutCubic=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,d--,i*(d*d*d+1)+t));Xt.EaseInOutCubic=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n/2,d<1?i/2*d*d*d+t:(d-=2,i/2*(d*d*d+2)+t)));class xf{constructor(t){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=t}add(t){this._actions.push(t)}remove(t){const i=this._actions.indexOf(t);this._actions.splice(i,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const t=this._actions.length;for(let i=0;i<t;i++)this._actions[i].reset();this._completedActions=[]}update(t){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new xc(this._currentAction,this._entity))),this._currentAction.update(t),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new bc(this._currentAction,this._entity));const i=this._actions.shift();i&&this._completedActions.push(i)}}}let Tv=0;function Nt(){return Tv++}class bf{constructor(t,i,n){this.id=Nt(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new uo(t),this._actionQueue=this._repeatContext.getQueue(),this._repeat=n,this._originalRepeat=n,this._repeatBuilder(this._repeatContext),this._repeat--}update(t){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(t)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class yf{constructor(t,i){this.id=Nt(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new uo(t),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(t){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(t))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function Af(d,t,i){return(1-i)*d+t*i}function Rc(d,t,i,n){const o=(d-t+be)%be>=Math.PI,h=Math.abs(t-d),c=be-h;let _=0,p=0;h>c?(_=c,p=h):(_=h,p=c);let v=0,x=1;switch(i){case re.ShortestPath:v=_,x=o?1:-1;break;case re.LongestPath:v=p,x=o?-1:1;break;case re.Clockwise:x=1,v=o?_:p;break;case re.CounterClockwise:x=-1,v=o?p:_;break}return d+x*(v*n)}function lo(d,t,i){return d.scale(1-i).add(t.scale(i))}function Cf(d,t,i){return(i-d)/(t-d)}function Sf(d,t,i){const n=i.sub(d),o=t.sub(d),h=n.x/o.x,c=n.y/o.y;return Math.min(h,c)}function os(d,t,i,n,o){const h=Cf(d,t,o);return Af(i,n,h)}function Ev(d,t,i,n,o){const h=Sf(d,t,o);return lo(i,n,h)}function Pf(d){return d.offset instanceof k&&typeof d.duration=="number"}class Tf{constructor(t,i){var n;if(this.entity=t,this.id=Nt(),this._started=!1,this._stopped=!1,this._easing=Xt.Linear,this._offset=i.offset,this._easing=(n=i.easing)!==null&&n!==void 0?n:this._easing,this._tx=t.get(st),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=t;const i=At(os(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),c=(o-n.x)/(t/1e3),_=(h-n.y)/(t/1e3);this._motion.vel.x=c,this._motion.vel.y=_,this.isComplete(this.entity)&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=G(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Rl{constructor(t,i,n,o){if(this.id=Nt(),this._started=!1,this._stopped=!1,this._entity=t,this._tx=t.get(st),this._motion=t.get(kt),this._speed=o,this._offset=new k(i,n),o<=0)throw dt.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+o),new Error("Speed must be greater than 0 pixels per second")}update(t){this._started||(this._started=!0,this._start=new k(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(t){const i=t.get(st);return this._stopped||i.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=G(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Ef(d){return d.pos instanceof k&&typeof d.duration=="number"}class If{constructor(t,i){var n;if(this.entity=t,this.id=Nt(),this._started=!1,this._stopped=!1,this._easing=Xt.Linear,this._end=i.pos,this._easing=(n=i.easing)!==null&&n!==void 0?n:this._easing,this._tx=t.get(st),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=t;const i=At(os(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),c=(o-n.x)/(t/1e3),_=(h-n.y)/(t/1e3);this._motion.vel.x=c,this._motion.vel.y=_,this.isComplete(this.entity)&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=G(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Dl{constructor(t,i,n,o){this.entity=t,this.id=Nt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(kt),this._end=new k(i,n),this._speed=o}update(t){this._started||(this._started=!0,this._start=new k(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const i=this._dir.scale(this._speed);this._motion.vel=G(i.x,i.y),this.isComplete(this.entity)&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(t){const i=t.get(st);return this._stopped||new k(i.pos.x,i.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=G(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Iv(d){return typeof d.angle=="number"&&typeof d.duration=="number"}class Rf{constructor(t,i){var n;if(this.entity=t,this.id=Nt(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=i.angle,this._tx=t.get(st),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(n=i.rotationType)!==null&&n!==void 0?n:re.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=t;const i=At(os(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Rc(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(n-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Df{constructor(t,i,n,o){this.id=Nt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(kt),this._end=i,this._speed=n,this._rotationType=o||re.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const i=Math.abs(this._end-this._start),n=be-i;switch(i>n?(this._shortDistance=n,this._longDistance=i):(this._shortDistance=i,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+be)%be>=Math.PI,this._rotationType){case re.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case re.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case re.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case re.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Rv(d){return typeof d.angleRadiansOffset=="number"&&typeof d.duration=="number"}class Ff{constructor(t,i){var n;if(this.entity=t,this.id=Nt(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=i.angleRadiansOffset,this._tx=t.get(st),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(n=i.rotationType)!==null&&n!==void 0?n:re.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._endAngle=Ps(this._startAngle+this._offset),this._started=!0),this._currentMs-=t;const i=At(os(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Rc(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(n-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Mf{constructor(t,i,n,o){this.id=Nt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(kt),this._speed=n,this._offset=i,this._rotationType=o||re.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const i=Math.abs(this._end-this._start),n=be-i;switch(i>n?(this._shortDistance=n,this._longDistance=i):(this._shortDistance=i,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+be)%be>=Math.PI,this._rotationType){case re.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case re.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case re.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case re.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function Bf(d){return typeof d.scale=="object"&&typeof d.duration=="number"}class kf{constructor(t,i){if(this.entity=t,this.id=Nt(),this._started=!1,this._stopped=!1,this._endScale=G(1,1),this._startScale=G(1,1),this._endScale=i.scale,this._tx=t.get(st),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=t;const i=At(os(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=lo(this._startScale,this._endScale,i),o=this._tx.scale,h=n.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=k.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Lf{constructor(t,i,n,o,h){this.id=Nt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(kt),this._endX=i,this._endY=n,this._speedX=o,this._speedY=h}update(t){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*i}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*i}this.isComplete()&&(this._tx.scale=G(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Uf(d){return typeof d.scaleOffset=="object"&&typeof d.duration=="number"}class zf{constructor(t,i){if(this.entity=t,this.id=Nt(),this._started=!1,this._stopped=!1,this._endScale=G(1,1),this._scaleOffset=G(0,0),this._startScale=G(1,1),this._scaleOffset=i.scaleOffset,this._tx=t.get(st),this._motion=t.get(kt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=t;const i=At(os(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=lo(this._startScale,this._endScale,i),o=this._tx.scale,h=n.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=k.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Hf{constructor(t,i,n,o){this.id=Nt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(kt),this._offset=new k(i,n),this._speedX=this._speedY=o}update(t){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Gu{constructor(t){this.id=Nt(),this._hasBeenCalled=!1,this._method=t}update(t){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class Of{constructor(t,i,n,o,h){this.easingFcn=h,this.id=Nt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new k(0,0),this._lerpEnd=new k(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(kt),this._lerpDuration=o,this._lerpEnd=new k(i,n)}_initialize(){this._lerpStart=new k(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=G((i-this._tx.pos.x)/(t/1e3),(n-this._tx.pos.y)/(t/1e3))):(this._tx.pos=G(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=k.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=G(0,0),this._stopped=!0}}class Wf{constructor(t,i,n,o,h){this.easingFcn=h,this.id=Nt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new k(0,0),this._lerpEnd=new k(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(kt),this._lerpDuration=o,this._offset=new k(i,n)}_initialize(){this._lerpStart=new k(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=G((i-this._tx.pos.x)/(t/1e3),(n-this._tx.pos.y)/(t/1e3))):(this._tx.pos=G(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=k.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=G(0,0),this._stopped=!0}}class Nf{constructor(t,i,n,o=1){this.id=Nt(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=t.get(ae),this._timeVisible=i,this._timeNotVisible=n,this._duration=(i+n)*o}update(t){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=t,this._totalTime+=t,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class Gf{constructor(t,i,n){this.id=Nt(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=t.get(ae),this._endOpacity=i,this._remainingTime=this._originalTime=n}update(t){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*t)/this._remainingTime),this._remainingTime-=t,this.isComplete()&&(this._graphics.opacity=this._endOpacity),dt.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class Vf{constructor(t){this.id=Nt(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=t}update(t){this._started||(this._started=!0),this._elapsedTime+=t}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class Xf{constructor(t){this.id=Nt(),this._stopped=!1,this._entity=t}update(t){this._entity.get($n).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class Fl{constructor(t,i,n){this.id=Nt(),this._started=!1,this._stopped=!1,this._tx=t.get(st),this._motion=t.get(kt),this._followTx=i.get(st),this._followMotion=i.get(kt),this._current=new k(this._tx.pos.x,this._tx.pos.y),this._end=new k(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=n!==void 0?n:this._current.distance(this._end),this._speed=0}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(i!==0&&(this._speed=i),this._current=G(this._tx.pos.x,this._tx.pos.y),this._end=G(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const n=this._dir.scale(this._speed);this._motion.vel=G(n.x,n.y)}else this._motion.vel=G(0,0);this.isComplete()&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}stop(){this._motion.vel=G(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class Ml{constructor(t,i,n){this.id=Nt(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=t.get(st),this._motion=t.get(kt),this._meetTx=i.get(st),this._meetMotion=i.get(kt),this._current=new k(this._tx.pos.x,this._tx.pos.y),this._end=new k(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=n||0,n!==void 0&&(this._speedWasSpecified=!0)}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));i!==0&&!this._speedWasSpecified&&(this._speed=i),this._current=G(this._tx.pos.x,this._tx.pos.y),this._end=G(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const n=this._dir.scale(this._speed);this._motion.vel=G(n.x,n.y),this.isComplete()&&(this._tx.pos=G(this._end.x,this._end.y),this._motion.vel=G(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=G(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class qf{constructor(t,i,n=1e3){var o;this.id=Nt(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=t.get(ae),this._duration=n,this._entity=t,this._material=(o=t.scene)===null||o===void 0?void 0:o.engine.graphicsContext.createMaterial({name:"flash-material",color:i,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=n}update(t){var i;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=t,this._graphics&&((i=this._material)===null||i===void 0||i.update(n=>{n.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class co{constructor(t){var i;if(this._distLookup=[],this.quality=4,t.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...t.controlPoints],this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(t){this._controlPoints=[...t],this._calculateLookup()}setControlPoint(t,i){this._controlPoints[t]=i,this._calculateLookup()}_calculateLookup(){let t=0;this._distLookup.length=0;let i=this.controlPoints[0];const n=this.controlPoints.length*this.quality;for(let o=0;o<n;o++){const h=o/(n-1),c=this.getPoint(h),_=i.distance(c);t+=_,this._distLookup.push(t),i=c}this._arcLength=t}_getTimeGivenDistance(t){const i=this._distLookup.length,n=this.arcLength;if(t>=0&&t<n){for(let o=0;o<i-1;o++)if(this._distLookup[o]<=t&&t<this._distLookup[o+1])return os(this._distLookup[o],this._distLookup[o+1],o/(i-1),(o+1)/(i-1),t)}return t/n}getPoint(t){const i=[...this.controlPoints];for(let n=1;n<i.length;n++)for(let o=0;o<i.length-n;o++)i[o]=lo(i[o],i[o+1],t);return i[0]}getTangent(t){const i=t*t,n=this.controlPoints[0],o=this.controlPoints[1],h=this.controlPoints[2],c=this.controlPoints[3];return n.scale(-3*i+6*t-3).add(o.scale(9*i-12*t+3).add(h.scale(-9*i+6*t).add(c.scale(3*i)))).normalize()}getUniformTangent(t){const i=t*this.arcLength,n=this._getTimeGivenDistance(i);return this.getTangent(n)}getNormal(t){return this.getTangent(t).normal()}getUniformNormal(t){return this.getUniformTangent(t).normal()}getUniformPoint(t){const i=t*this.arcLength,n=this._getTimeGivenDistance(i);return this.getPoint(n)}clone(){return new co({controlPoints:[...this.controlPoints],quality:this.quality})}}class Yf{constructor(t,i){var n;if(this.id=Nt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(st),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new co({controlPoints:[G(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(n=i.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=t;const i=At(os(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class jf{constructor(t,i){var n;if(this.id=Nt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(st),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new co({controlPoints:[G(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(n=i.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=t;const i=At(os(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class uo{constructor(t){this._entity=t,this._queue=new xf(t)}getQueue(){return this._queue}update(t){this._queue.update(t)}clearActions(){this._queue.clearActions()}runAction(t){return t.reset(),this._queue.add(t),this}curveBy(t){return this._queue.add(new jf(this._entity,t)),this}curveTo(t){return this._queue.add(new Yf(this._entity,t)),this}easeTo(...t){var i,n;let o=0,h=0,c=0,_=Xt.Linear;return t[0]instanceof k?(o=t[0].x,h=t[0].y,c=t[1],_=(i=t[2])!==null&&i!==void 0?i:_):(o=t[0],h=t[1],c=t[2],_=(n=t[3])!==null&&n!==void 0?n:_),this._queue.add(new Of(this._entity,o,h,c,_)),this}easeBy(...t){var i,n;let o=0,h=0,c=0,_=Xt.Linear;return t[0]instanceof k?(o=t[0].x,h=t[0].y,c=t[1],_=(i=t[2])!==null&&i!==void 0?i:_):(o=t[0],h=t[1],c=t[2],_=(n=t[3])!==null&&n!==void 0?n:_),this._queue.add(new Wf(this._entity,o,h,c,_)),this}moveTo(t,i,n){let o=0,h=0,c=0;return t instanceof k?(o=t.x,h=t.y,c=+(i??0),this._queue.add(new Dl(this._entity,o,h,c))):typeof t=="number"&&typeof i=="number"&&typeof n=="number"?(o=t,h=i,c=n,this._queue.add(new Dl(this._entity,o,h,c))):Ef(t)&&this._queue.add(new If(this._entity,t)),this}moveBy(t,i,n){let o=0,h=0,c=0;return t instanceof k&&typeof i=="number"?(o=t.x,h=t.y,c=i,this._queue.add(new Rl(this._entity,o,h,c))):typeof t=="number"&&typeof i=="number"&&typeof n=="number"?(o=t,h=i,c=n,this._queue.add(new Rl(this._entity,o,h,c))):Pf(t)&&this._queue.add(new Tf(this._entity,t)),this}rotateTo(t,i,n){return typeof t=="number"&&typeof i=="number"?this._queue.add(new Df(this._entity,t,i,n)):typeof t=="object"&&this._queue.add(new Rf(this._entity,t)),this}rotateBy(t,i,n){return typeof t=="object"?this._queue.add(new Ff(this._entity,t)):this._queue.add(new Mf(this._entity,t,i,n)),this}scaleTo(t,i,n,o){let h=1,c=1,_=0,p=0;return Bf(t)?(this._queue.add(new kf(this._entity,t)),this):(t instanceof k&&i instanceof k&&(h=t.x,c=t.y,_=i.x,p=i.y),typeof t=="number"&&typeof i=="number"&&(h=t,c=i,_=n,p=o),this._queue.add(new Lf(this._entity,h,c,_,p)),this)}scaleBy(t,i,n){if(Uf(t))return this._queue.add(new zf(this._entity,t)),this;let o=1,h=1;return t instanceof k&&(o=t.x,h=t.y,n=i),typeof t=="number"&&typeof i=="number"&&(o=t,h=i),this._queue.add(new Hf(this._entity,o,h,n)),this}blink(t,i,n=1){return this._queue.add(new Nf(this._entity,t,i,n)),this}fade(t,i){return this._queue.add(new Gf(this._entity,t,i)),this}flash(t,i=1e3){return this._queue.add(new qf(this._entity,t,i)),this}delay(t){return this._queue.add(new Vf(t)),this}die(){return this._queue.add(new Xf(this._entity)),this}callMethod(t){return this._queue.add(new Gu(t)),this}repeat(t,i){return i?(this._queue.add(new bf(this._entity,t,i)),this):(this.repeatForever(t),this)}repeatForever(t){return this._queue.add(new yf(this._entity,t)),this}follow(t,i){return i===void 0?this._queue.add(new Fl(this._entity,t)):this._queue.add(new Fl(this._entity,t,i)),this}meet(t,i){return i===void 0?this._queue.add(new Ml(this._entity,t)):this._queue.add(new Ml(this._entity,t,i)),this}toPromise(){return new Promise(i=>{this._queue.add(new Gu(()=>{i()}))})}}class $n extends Ci{constructor(){super(...arguments),this.dependencies=[st,kt],this._ctx=null}onAdd(t){this._ctx=new uo(t)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(t){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(t)}update(t){var i;return(i=this._ctx)===null||i===void 0?void 0:i.update(t)}clearActions(){var t;(t=this._ctx)===null||t===void 0||t.clearActions()}curveBy(t){return this._getCtx().curveBy.apply(this._ctx,[t])}curveTo(t){return this._getCtx().curveTo.apply(this._ctx,[t])}easeTo(...t){return this._getCtx().easeTo.apply(this._ctx,t)}easeBy(...t){return this._getCtx().easeBy.apply(this._ctx,t)}moveTo(t,i,n){return this._getCtx().moveTo.apply(this._ctx,[t,i,n])}moveBy(t,i,n){return this._getCtx().moveBy.apply(this._ctx,[t,i,n])}rotateTo(t,i,n){return this._getCtx().rotateTo.apply(this._ctx,[t,i,n])}rotateBy(t,i,n){return this._getCtx().rotateBy.apply(this._ctx,[t,i,n])}scaleTo(t,i,n,o){return this._getCtx().scaleTo.apply(this._ctx,[t,i,n,o])}scaleBy(t,i,n){return this._getCtx().scaleBy.apply(this._ctx,[t,i,n])}blink(t,i,n){return this._getCtx().blink(t,i,n)}fade(t,i){return this._getCtx().fade(t,i)}flash(t,i=1e3){return this._getCtx().flash(t,i)}delay(t){return this._getCtx().delay(t)}die(){return this._getCtx().die()}callMethod(t){return this._getCtx().callMethod(t)}repeat(t,i){return this._getCtx().repeat(t,i)}repeatForever(t){return this._getCtx().repeatForever(t)}follow(t,i){return this._getCtx().follow(t,i)}meet(t,i){return this._getCtx().meet(t,i)}toPromise(){return this._getCtx().toPromise()}}function Dv(d){return d instanceof ti}const Fv={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class ti extends qe{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(t){this.body.oldPos.setTo(t.x,t.y)}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t.clone()}get oldVel(){return this.body.oldVel}set oldVel(t){this.body.oldVel.setTo(t.x,t.y)}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t.clone()}set oldAcc(t){this.body.oldAcc.setTo(t.x,t.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(t){this.transform.rotation=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}get scale(){return this.get(st).scale}set scale(t){this.get(st).scale=t}get anchor(){return this._anchor}set anchor(t){this._anchor=Li(t,i=>this._handleAnchorChange(i)),this._handleAnchorChange(t)}_handleAnchorChange(t){this.graphics&&(this.graphics.anchor=t)}get offset(){return this._offset}set offset(t){this._offset=Li(t,i=>this._handleOffsetChange(i)),this._handleOffsetChange(t)}_handleOffsetChange(t){this.graphics&&(this.graphics.offset=t)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(t){t&&(t&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!t&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=t)}get color(){return this.graphics.color}set color(t){this.graphics.color=t}constructor(t){super(),this.events=new $t,this._anchor=Li(k.Half,lt=>this._handleAnchorChange(lt)),this._offset=Li(k.Zero,lt=>this._handleOffsetChange(lt)),this.logger=dt.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=lt=>{this._dragging&&(this.pos=lt.worldPos)},this._pointerDragLeaveHandler=lt=>{this._dragging&&(this.pos=lt.worldPos)};const{name:i,x:n,y:o,pos:h,coordPlane:c,scale:_,width:p,height:v,radius:x,collider:b,vel:S,acc:P,rotation:I,angularVelocity:M,z:R,color:T,visible:F,opacity:W,anchor:U,offset:V,collisionType:j,collisionGroup:X,silenceWarnings:rt}={...t};this.name=i??this.name,this.anchor=U??ti.defaults.anchor.clone(),this.offset=V??k.Zero,this.transform=new st,this.addComponent(this.transform),this.pos=h??G(n??0,o??0),this.rotation=I??0,this.scale=_??G(1,1),this.z=R??0,this.transform.coordPlane=c??ke.World,this._silenceWarnings=rt??!1,this.pointer=new Js,this.addComponent(this.pointer),this.graphics=new ae({anchor:this.anchor,offset:this.offset,opacity:W}),this.addComponent(this.graphics),this.motion=new kt,this.addComponent(this.motion),this.vel=S??k.Zero,this.acc=P??k.Zero,this.angularVelocity=M??0,this.actions=new $n,this.addComponent(this.actions),this.body=new Pt,this.addComponent(this.body),this.body.collisionType=j??ft.Passive,X&&(this.body.group=X),T&&(this.color=T),b?(this.collider=new ve(b),this.addComponent(this.collider)):x?(this.collider=new ve(Ve.Circle(x)),this.addComponent(this.collider),T&&this.graphics.add(new Ra({color:T,radius:x}))):p>0&&v>0?(this.collider=new ve(Ve.Box(p,v,this.anchor)),this.addComponent(this.collider),T&&p&&v&&this.graphics.add(new ho({color:T,width:p,height:v}))):(this.collider=new ve,this.addComponent(this.collider)),this.graphics.isVisible=F??!0}clone(){const t=new ti({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});t.clearComponents(),t.processComponentRemoval(),t.addComponent(t.transform=this.transform.clone(),!0),t.addComponent(t.pointer=this.pointer.clone(),!0),t.addComponent(t.graphics=this.graphics.clone(),!0),t.addComponent(t.motion=this.motion.clone(),!0),t.addComponent(t.actions=this.actions.clone(),!0),t.addComponent(t.body=this.body.clone(),!0),t.addComponent(t.collider=this.collider.clone(),!0);const i=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],n=this.getComponents();for(const o of n)i.includes(o)||t.addComponent(o.clone(),!0);return t}onInitialize(t){}_initialize(t){super._initialize(t);for(const i of this.children)i._initialize(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_prekill(t){this.events.emit("prekill",new Kl(this)),this.onPreKill(t)}onPreKill(t){}_postkill(t){this.events.emit("postkill",new $l(this)),this.onPostKill(t)}onPostKill(t){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new Pa(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(st).z}set z(t){this.get(st).z=t}get center(){const t=this.getGlobalPos();return new k(t.x+this.width/2-this.anchor.x*this.width,t.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new k(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(st).globalRotation}get globalRotation(){return this.get(st).globalRotation}getGlobalPos(){return this.get(st).globalPos}get globalPos(){return this.get(st).globalPos}getGlobalScale(){return this.get(st).globalScale}get globalScale(){return this.get(st).globalScale}get globalZ(){return this.get(st).globalZ}contains(t,i,n=!1){const o=G(t,i),h=this.get(ve);h.update();const c=h.get();if(!c)return!1;const _=c.contains(o);return n?_||this.children.some(p=>p.contains(t,i,!0)):_}within(t,i){const n=this.get(ve),o=t.get(ve),h=n.get(),c=o.get();return h&&c?h.getClosestLineBetween(c).getLength()<=i:!1}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i),this._postupdate(t,i),this._remove(t)}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreCollisionResolve(t,i,n,o){}onPostCollisionResolve(t,i,n,o){}onCollisionStart(t,i,n,o){}onCollisionEnd(t,i,n,o){}_preupdate(t,i){this.events.emit("preupdate",new Ks(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new $s(t,i,this)),this.onPostUpdate(t,i)}}ti.defaults={anchor:k.Half};function Zf(d){return d instanceof Dc}class Dc extends ti{constructor(t){var i,n;super({...t}),this.get(st).coordPlane=ke.Screen,this.anchor=(i=t?.anchor)!==null&&i!==void 0?i:G(0,0),this.body.collisionType=(n=t?.collisionType)!==null&&n!==void 0?n:ft.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!t?.collider&&t?.width>0&&t?.height>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(t){this._engine=t,super._initialize(t)}contains(t,i,n=!0){if(n)return super.contains(t,i);const o=this._engine.worldToScreenCoordinates(new k(t,i));return super.contains(o.x,o.y)}}class En{get complete(){return this._complete}constructor(t){var i;this._logger=dt.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const n=(i=t.action)!==null&&i!==void 0?i:t.fcn,o=t.interval,h=t.repeats,c=t.numberOfRepeats,_=t.randomRange,p=t.random;if(c&&c>=0&&(this.maxNumberOfRepeats=c,!h))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=En._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=o,_){if(_[0]>_[1])throw new Error("min value must be lower than max value for range");this.random=p??new hr,this.randomRange=_,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=h||this.repeats,n&&this.on(n)}on(t){this._callbacks.push(t)}off(t){const i=this._callbacks.indexOf(t);this._callbacks.splice(i,1)}update(t){this._running&&(this._totalTimeAlive+=t,this._elapsedTime+=t,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(i=>{i.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(t,i){if(t&&t>=0&&(this._baseInterval=this.interval=t),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=i,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}En._MAX_ID=0;class Da extends Ci{constructor(t){super(),this.parallaxFactor=G(1,1),this.parallaxFactor=t??this.parallaxFactor}}class Fa extends Ci{constructor(t,i=!0){super(),this.draw=t,this.useTransform=i}}function Vu(d){return d&&d._dispatchPointerEvents&&d._processPointerToObject}class Mv{get events(){return this.object.events}init(t,i,n){this.object=t,this.contains=i,this.active=n}}class Fc{constructor(){this._proxyPool=new io(()=>new Mv,t=>t,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(t,i,n){const o=this._proxyPool.rent(!1);o.init(t,i,n),this._proxies.push(o),this._objectToProxy.set(t,o)}_getProxy(t){const i=this._objectToProxy.get(t);if(i)return i;throw new Error("No PointerTargetProxy for object")}removeObject(t){const i=this._objectToProxy.get(t);if(i){const n=this._proxies.indexOf(i);n>-1&&this._proxies.splice(n,1),this._proxyPool.return(i)}}_objectCurrentlyUnderPointer(t,i){return!!(this._currentFrameObjectToPointers.has(t)&&this._currentFrameObjectToPointers.get(t).includes(i))}_objectWasUnderPointer(t,i){return!!(this._lastFrameObjectToPointers.has(t)&&this._lastFrameObjectToPointers.get(t).includes(i))}_entered(t,i){return this._objectCurrentlyUnderPointer(t,i)&&!this._lastFrameObjectToPointers.has(t)}_left(t,i){return!this._currentFrameObjectToPointers.has(t)&&this._objectWasUnderPointer(t,i)}addPointerToObject(t,i){const n=this._objectToProxy.get(t);n&&this._addPointerToProxy(n,i)}_addPointerToProxy(t,i){if(!this._currentFrameObjectToPointers.has(t)){this._currentFrameObjectToPointers.set(t,[i]);return}const n=this._currentFrameObjectToPointers.get(t);this._currentFrameObjectToPointers.set(t,n.concat(i))}dispatchEvents(t,i){const n=new Set(this._lastFrameObjectToPointers.keys()),o=new Set(this._currentFrameObjectToPointers.keys());let h,c,_;for(let p=0;p<i.length;p++){const v=i[p],x=this._getProxy(v);if(Vu(v)&&v._dispatchPointerEvents(t),n.has(x)||o.has(x)){_=this._processDownAndEmit(t,x),c=this._processUpAndEmit(t,x),h=this._processMoveAndEmit(t,x);const b=[...h.values(),..._.values(),...c.values()];this._processEnterLeaveAndEmit(t,x,b),this._processCancelAndEmit(t,x),this._processWheelAndEmit(t,x)}}}processPointerToObject(t,i){for(let n=0;n<i.length;n++){const o=i[n],h=this._getProxy(o);Vu(o)&&o._processPointerToObject(t);for(const[c,_]of t.currentFramePointerCoords.entries())h.contains(_)&&this._addPointerToProxy(h,c)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(t,i){const n=new Map;for(const o of t.currentFrameDown)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerdown",o),t.isDragStart(o.pointerId)&&i.events.emit("pointerdragstart",o)),n.set(o.pointerId,o);return n}_processUpAndEmit(t,i){const n=new Map;for(const o of t.currentFrameUp)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerup",o),t.isDragEnd(o.pointerId)&&i.events.emit("pointerdragend",o)),n.set(o.pointerId,o);return n}_processMoveAndEmit(t,i){const n=new Map;for(const o of t.currentFrameMove)o.active&&i.active()&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointermove",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragmove",o)),n.set(o.pointerId,o);return n}_processEnterLeaveAndEmit(t,i,n){for(const o of n){if(o.active&&i.active()&&this._entered(i,o.pointerId)){i.events.emit("pointerenter",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragenter",o);break}if(o.active&&i.active()&&(this._left(i,o.pointerId)||this._objectCurrentlyUnderPointer(i,o.pointerId)&&o.type==="up")){i.events.emit("pointerleave",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragleave",o);break}}}_processCancelAndEmit(t,i){for(const n of t.currentFrameCancel)n.active&&i.active()&&this._objectCurrentlyUnderPointer(i,n.pointerId)&&i.events.emit("pointercancel",n)}_processWheelAndEmit(t,i){for(const n of t.currentFrameWheel)n.active&&i.active()&&this._objectCurrentlyUnderPointer(i,0)&&i.events.emit("pointerwheel",n)}}const Bv={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class Qf extends qe{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let t=0;t<this.tiles.length;t++)this.tiles[t]&&this.tiles[t].flagDirty()}get x(){var t;return(t=this.transform.pos.x)!==null&&t!==void 0?t:0}set x(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.get(st).pos=G(t,this.y))}get y(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.pos.y)!==null&&i!==void 0?i:0}set y(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.transform.pos=G(this.x,t))}get z(){var t;return(t=this.transform.z)!==null&&t!==void 0?t:0}set z(t){this.transform&&(this.transform.z=t)}get rotation(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.rotation)!==null&&i!==void 0?i:0}set rotation(t){this.transform&&(this.transform.rotation=t)}get scale(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.scale)!==null&&i!==void 0?i:k.One}set scale(t){var i;!((i=this.transform)===null||i===void 0)&&i.scale&&(this.transform.scale=t)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get vel(){return this._motion.vel}set vel(t){this._motion.vel=t}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,n,o;super([],t.name),this.events=new $t,this._token=0,this.logger=dt.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(i=t.meshingLookBehind)!==null&&i!==void 0?i:this.meshingLookBehind,this.addComponent(new st),this.addComponent(new kt),this.addComponent(new Pt({type:ft.Fixed})),this.addComponent(new ae({onPostDraw:(c,_)=>this.draw(c,_)})),this.addComponent(new Fa((c,_)=>this.debug(c,_),!1)),this.addComponent(new ve),this.addComponent(new Js),this.pointer=this.get(Js),this._graphics=this.get(ae),this.transform=this.get(st),this._motion=this.get(kt),this.collider=this.get(ve),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(n=t.pos)!==null&&n!==void 0?n:k.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(o=t.renderFromTopOfGraphic)!==null&&o!==void 0?o:this.renderFromTopOfGraphic,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight,this.rows=t.rows,this.columns=t.columns,this._pointerEventDispatcher=new Fc,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let h=[];for(let c=0;c<this.columns;c++){for(let _=0;_<this.rows;_++){const p=new Jf({x:c,y:_,map:this});p.map=this,this.tiles[c+_*this.columns]=p,this._pointerEventDispatcher.addObject(p,v=>p.bounds.contains(v.worldPos),()=>!0),h.push(p),this._rows[_]||(this._rows[_]=[]),this._rows[_].push(p)}this._cols[c]=h,h=[]}this._graphics.localBounds=new ct({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(t){super._initialize(t),this._engine=t}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:k.Zero;{const n=t.offset;return this._originalOffsets.set(t,n),n}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const t=[];this._composite=this.collider.useCompositeCollider([]);let i=null;const n=(h,c)=>h&&c?h.top===c.top&&h.bottom===c.bottom&&h.right===c.left:!1,o=(h,c,_=this.meshingLookBehind)=>{if(!h)return!1;for(let p=c.length-1;p>=0;p--){if(_--<0)return!1;const v=c[p];if(n(v,h))return c[p]=v.combine(h),!0}return!1};for(let h=0;h<this.columns;h++){for(let c=0;c<this.rows;c++){const _=this.tiles[h+c*this.columns];if(_.solid)if(_.getColliders().length>0){for(const p of _.getColliders()){const v=this._getOrSetColliderOriginalOffset(p);p.offset=G(_.x*this.tileWidth*this.scale.x,_.y*this.tileHeight*this.scale.y).add(v),p.owner=this,this._composite.addCollider(p)}i&&!o(i,t)&&t.push(i),i=null}else i?i=i.combine(_.defaultGeometry):i=_.defaultGeometry;else i&&!o(i,t)&&t.push(i),i=null}i&&!o(i,t)&&t.push(i),i=null}for(const h of t){const c=Ve.Box(h.width,h.height,k.Zero,G(h.left-this.pos.x,h.top-this.pos.y));c.owner=this,this._composite.addCollider(c)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(t){var i;return(i=this.tiles[t])!==null&&i!==void 0?i:null}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const{x:i,y:n}=this._getTileCoordinates(t),o=this.getTile(i,n);return i>=0&&n>=0&&i<this.columns&&n<this.rows&&o?o:null}_getTileCoordinates(t){t=this.transform.applyInverse(t);const i=Math.floor(t.x/this.tileWidth),n=Math.floor(t.y/this.tileHeight);return{x:i,y:n}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let t=this._engine.screen.getWorldBounds();const i=this.get(Da);if(i&&this.isInitialized){let P=this.pos;const I=k.One.sub(i.parallaxFactor),M=this._engine.currentScene.camera.pos.scale(I);P=P.sub(M),t=t.translate(P)}const n=this.transform.coordPlane===ke.Screen?this._engine.screen.getScreenBounds():t,o=this._getTileCoordinates(n.topLeft),h=this._getTileCoordinates(n.topRight),c=this._getTileCoordinates(n.bottomRight),_=this._getTileCoordinates(n.bottomLeft),p=Math.min(At(o.x,0,this.columns-1),At(h.x,0,this.columns-1)),v=Math.min(At(o.y,0,this.rows-1),At(h.y,0,this.rows-1)),x=Math.max(At(c.x,0,this.columns-1),At(_.x,0,this.columns-1)),b=Math.max(At(c.y,0,this.rows-1),At(_.y,0,this.rows-1)),S=[];for(let P=p;P<=x;P++)for(let I=v;I<=b;I++)S.push(this.getTile(P,I));return S}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(t,i){this._initialize(t),this.onPreUpdate(t,i),this.emit("preupdate",new Ks(t,i,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(t,i),this.emit("postupdate",new $s(t,i,this))}draw(t,i){if(!this.isInitialized)return;this.emit("predraw",new ur(t,i,this));let n,o,h;const c=this.getOnScreenTiles();for(let _=0;_<c.length;_++){const p=c[_],v=p.getGraphicsOffsets();for(n=p.getGraphics(),o=0,h=n.length;o<h;o++){const x=n[o],b=v[o];if(x){Jl(x)&&x?.tick(i,this._token);const S=this.renderFromTopOfGraphic?0:x.height-this.tileHeight;x.draw(t,p.x*this.tileWidth+b.x,p.y*this.tileHeight-S+b.y)}}}this.emit("postdraw",new fr(t,i,this))}debug(t,i){const{showAll:n,showGrid:o,gridColor:h,gridWidth:c,showSolidBounds:_,solidBoundsColor:p,showColliderGeometry:v}=i.tilemap,{geometryColor:x,geometryLineWidth:b,geometryPointSize:S}=i.collider,P=this.tileWidth*this.columns*this.scale.x,I=this.tileHeight*this.rows*this.scale.y,M=this.pos;if(o||n){for(let R=0;R<this.rows+1;R++){const T=G(0,R*this.tileHeight*this.scale.y);t.drawLine(M.add(T),M.add(G(P,T.y)),h,c)}for(let R=0;R<this.columns+1;R++){const T=G(R*this.tileWidth*this.scale.x,0);t.drawLine(M.add(T),M.add(G(T.x,I)),h,c)}}if(n||_||v){const R=this._composite.getColliders();t.save(),t.translate(this.pos.x,this.pos.y),t.scale(this.scale.x,this.scale.y);for(const T of R){const F=T.localBounds,W=T.worldPos.sub(this.pos);_&&t.drawRectangle(W,F.width,F.height,p)}if(t.restore(),v)for(const T of R)T.debug(t,x,{lineWidth:b,pointSize:S})}if(n||_){if(t.save(),t.z=999,_)for(let R=0;R<this.tiles.length;R++)this.tiles[R].bounds.draw(t);t.restore()}}}class Jf{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(t){var i;(i=this.map)===null||i===void 0||i.flagCollidersDirty(),this._solid=t}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(t,i){this._graphics.push(t),i?.offset?this._offsets.push(i.offset):this._offsets.push(k.Zero)}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&(this._graphics.splice(i,1),this._offsets.splice(i,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(t){var i,n;this._posDirty=!1,this.events=new $t,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=t.x,this.y=t.y,this.map=t.map,this._width=t.map.tileWidth*this.map.scale.x,this._height=t.map.tileHeight*this.map.scale.y,this.solid=(i=t.solid)!==null&&i!==void 0?i:this.solid,this._graphics=(n=t.graphics)!==null&&n!==void 0?n:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const t=this.map.pos.add(G(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new ct(t.x,t.y,t.x+this.map.tileWidth,t.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(G(this.x*this._width,this.y*this._height)),this._bounds=new ct(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new k(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}class Kf{constructor(t){this.camera=t}lockToActor(t){this.camera.addStrategy(new $f(t))}lockToActorAxis(t,i){this.camera.addStrategy(new t_(t,i))}elasticToActor(t,i,n){this.camera.addStrategy(new e_(t,i,n))}radiusAroundActor(t,i){this.camera.addStrategy(new i_(t,i))}limitCameraBounds(t){this.camera.addStrategy(new s_(t))}}var xa;(function(d){d[d.X=0]="X",d[d.Y=1]="Y"})(xa||(xa={}));class $f{constructor(t){this.target=t,this.action=(i,n,o,h)=>i.center}}class t_{constructor(t,i){this.target=t,this.axis=i,this.action=(n,o,h,c)=>{const _=n.center,p=o.getFocus();return this.axis===xa.X?new k(_.x,p.y):new k(p.x,_.y)}}}class e_{constructor(t,i,n){this.target=t,this.cameraElasticity=i,this.cameraFriction=n,this.action=(o,h,c,_)=>{const p=o.center;let v=h.getFocus(),x=h.vel.clone();const b=p.sub(v).scale(this.cameraElasticity);x=x.add(b);const S=x.scale(-1).scale(this.cameraFriction);return x=x.add(S),v=v.add(x),v}}}class i_{constructor(t,i){this.target=t,this.radius=i,this.action=(n,o,h,c)=>{const _=n.center,p=o.getFocus(),v=_.sub(p),x=v.magnitude;if(x>=this.radius){const b=x-this.radius;return p.add(v.normalize().scale(b))}return p}}}class s_{constructor(t){this.target=t,this.boundSizeChecked=!1,this.action=(i,n,o,h)=>{const c=n.getFocus();this.boundSizeChecked||((i.bottom-i.top<o.drawHeight||i.right-i.left<o.drawWidth)&&dt.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let _=c.x,p=c.y;return c.x<i.left+o.halfDrawWidth?_=i.left+o.halfDrawWidth:c.x>i.right-o.halfDrawWidth&&(_=i.right-o.halfDrawWidth),c.y<i.top+o.halfDrawHeight?p=i.top+o.halfDrawHeight:c.y>i.bottom-o.halfDrawHeight&&(p=i.bottom-o.halfDrawHeight),G(_,p)}}}const kv={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class n_{constructor(){this.events=new $t,this.transform=me.identity(),this.inverse=me.identity(),this._cameraStrategies=[],this.strategy=new Kf(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new js(k.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=k.Zero,this.acc=k.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Xt.EaseInOutCubic,this._easing=Xt.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=G(0,0)}get zoom(){return this._z}set zoom(t){this._z=t,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(t){this._angularVelocity=t}get pos(){return this._pos}set pos(t){this._posChanged=!0,this._pos=new js(t,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(t){!this._follow&&!this._cameraMoving&&(this.pos=G(t,this.pos.y))}get y(){return this.pos.y}set y(t){!this._follow&&!this._cameraMoving&&(this.pos=G(this.pos.x,t))}get dx(){return this.vel.x}set dx(t){this.vel=G(t,this.vel.y)}get dy(){return this.vel.y}set dy(t){this.vel=G(this.vel.x,t)}get ax(){return this.acc.x}set ax(t){this.acc=G(t,this.acc.y)}get ay(){return this.acc.y}set ay(t){this.acc=G(this.acc.x,t)}getFocus(){return this.pos}move(t,i,n=Xt.EaseInOutCubic){if(typeof n!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(t):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(t),this._lerpPromise=new Promise(o=>{this._lerpResolve=o}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=i,this._lerpEnd=t,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=n,this._lerpPromise)}shake(t,i,n){this._isShaking=!0,this._shakeMagnitudeX=t,this._shakeMagnitudeY=i,this._shakeDuration=n}zoomOverTime(t,i=0,n=Xt.EaseInOutCubic){if(this._zoomPromise=new Promise(o=>{this._zoomResolve=o}),i)this._isZooming=!0,this._zoomEasing=n,this._currentZoomTime=0,this._zoomDuration=i,this._zoomStart=this.zoom,this._zoomEnd=t;else return this._isZooming=!1,this.zoom=t,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new ct(0,0,0,0)}addStrategy(t){this._cameraStrategies.push(t)}removeStrategy(t){lr(t,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(t,i){this.events.emit("preupdate",new Ks(t,i,this)),this.onPreUpdate(t,i)}onPreUpdate(t,i){}_postupdate(t,i){this.events.emit("postupdate",new $s(t,i,this)),this.onPostUpdate(t,i)}onPostUpdate(t,i){}get isInitialized(){return this._isInitialized}_initialize(t){if(!this.isInitialized){this._engine=t,this._screen=t.screen;const i=this._screen.contentArea;let n=G(i.width/2,i.height/2);if(!this._engine.loadingComplete){const o=this._screen.peekResolution();o&&(n=G(o.width/2,o.height/2))}this._halfWidth=n.x,this._halfHeight=n.y,this._posChanged||(this.pos=n),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(t,t.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(t),this.events.emit("initialize",new _r(t,this)),this._isInitialized=!0}}onInitialize(t){}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}runStrategies(t,i){for(const n of this._cameraStrategies)this.pos=n.action.call(n,n.target,this,t,i)}updateViewport(){this._viewport=new ct(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(t,i){if(this._initialize(t),this._preupdate(t,i),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(i/1e3)),this.zoom+=this.dz*i/1e3,this.vel=this.vel.add(this.acc.scale(i/1e3)),this.dz+=this.az*i/1e3,this.rotation+=this.angularVelocity*i/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const n=this._zoomEasing,o=n(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=o,this._currentZoomTime+=i}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const o=Xt.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=o,this._currentLerpTime+=i}else{this.pos=this._lerpEnd;const n=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(n)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=i,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(t,i),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(t,i),this._posChanged=!1}draw(t){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const i=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,n=this.pos.scale(i).add(this._oldPos.scale(1-i));n.clone(this.drawPos),this.updateTransform(n)}if(t.snapToPixel){const i=this.drawPos.clone(this._snapPos);i.x=~~(i.x+pt*qt(i.x)),i.y=~~(i.y+pt*qt(i.y)),i.clone(this.drawPos),this.updateTransform(i)}t.multiply(this.transform)}updateTransform(t){const i=this._screen.resolution.width/this.zoom,n=this._screen.resolution.height/this.zoom,o=G(-t.x+i/2+this._xShake,-t.y+n/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(i/2,n/2),this.transform.rotate(this.rotation),this.transform.translate(-i/2,-n/2),this.transform.translate(o.x,o.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const Lv={ExitTrigger:"exit",EnterTrigger:"enter"};class r_ extends ti{constructor(t){var i,n,o,h;super({...t}),this.events=new $t,this.filter=(i=t.filter)!==null&&i!==void 0?i:()=>!0,this.repeat=(n=t.repeat)!==null&&n!==void 0?n:-1,this.action=(o=t.action)!==null&&o!==void 0?o:()=>{},this.target=t.target,this.graphics.isVisible=(h=t.visible)!==null&&h!==void 0?h:!1,this.body.collisionType=ft.Passive,this.events.on("collisionstart",({other:c})=>{this._matchesTarget(c.owner)&&(this.events.emit("enter",new vc(this,c.owner)),this._dispatchAction(c.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:c})=>{this._matchesTarget(c.owner)&&this.events.emit("exit",new wc(this,c.owner))})}_matchesTarget(t){return this.filter(t)&&(this.target===void 0||this.target===t)}_dispatchAction(t){this.repeat!==0&&(this.action.call(this,t),this.repeat--)}}const as={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var pi;(function(d){d.Update="update",d.Draw="draw"})(pi||(pi={}));class yi{}yi.priority=as.Average;class o_{constructor(t){this._world=t,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>i=>{this.addEntity(i)},this._createChildRemovedHandler=()=>i=>{this.removeEntity(i,!1)},this._entitiesToRemove=[]}updateEntities(t,i){for(let n=0;n<this.entities.length;n++){const o=this.entities[n];o.update(t.engine,i),o.isActive||this.removeEntity(o)}}findEntitiesForRemoval(){for(let t=0;t<this.entities.length;t++){const i=this.entities[t];i.isActive||this.removeEntity(i)}}addEntity(t){if(t.isActive=!0,t.scene=this._world.scene,t&&!this._entityIndex[t.id]){this._entityIndex[t.id]=t,this.entities.push(t),this._world.queryManager.addEntity(t),t.children.forEach(o=>{o.scene=t.scene,this.addEntity(o)});const i=this._createChildAddedHandler();this._childAddedHandlerMap.set(t,i);const n=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(t,n),t.childrenAdded$.subscribe(i),t.childrenRemoved$.subscribe(n)}}removeEntity(t,i=!0){var n,o;let h=0;t instanceof qe?h=t.id:h=t;const c=this._entityIndex[h];if(c&&c.isActive&&(c.isActive=!1),c&&i){this._entitiesToRemove.push(c);return}if(delete this._entityIndex[h],c){c.scene=null,lr(c,this.entities),this._world.queryManager.removeEntity(c),c.children.forEach(v=>{v.scene=null,this.removeEntity(v,i)});const _=this._childAddedHandlerMap.get(c);_&&c.childrenAdded$.unsubscribe(_);const p=this._childRemovedHandlerMap.get(c);p&&c.childrenRemoved$.unsubscribe(p),!((o=(n=this._world)===null||n===void 0?void 0:n.scene)===null||o===void 0)&&o.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let t=0;t<this._entitiesToRemove.length;t++){const i=this._entitiesToRemove[t];i.isActive||this.removeEntity(i,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let t=0;t<this.entities.length;t++)this.entities[t].processComponentRemoval()}getById(t){return this._entityIndex[t]}getByName(t){return this.entities.filter(i=>i.name===t)}clear(){for(let t=this.entities.length-1;t>=0;t--)this.removeEntity(this.entities[t])}}class Qr{constructor(t){if(this.requiredComponents=t,this.components=new Set,this.entities=[],this.entityAdded$=new Ke,this.entityRemoved$=new Ke,t.length===0)throw new Error("Cannot create query without components");for(const i of t)this.components.add(i);this.id=Qr.createId(t)}static createId(t){return t.slice().map(i=>i.name).sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAll(Array.from(this.components))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class Jr{constructor(t){if(this.requiredTags=t,this.tags=new Set,this.entities=[],this.entityAdded$=new Ke,this.entityRemoved$=new Ke,t.length===0)throw new Error("Cannot create tag query without tags");for(const i of t)this.tags.add(i);this.id=Jr.createId(t)}static createId(t){return t.slice().sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAllTags(Array.from(this.tags))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class a_{constructor(t){this._world=t,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=i=>n=>{this.addComponent(i,n)},this._createRemoveComponentHandler=i=>n=>{this.removeComponent(i,n)},this._createAddTagHandler=i=>n=>{this.addTag(i,n)},this._createRemoveTagHandler=i=>n=>{this.removeTag(i,n)}}createQuery(t){const i=Qr.createId(t);if(this._queries.has(i))return this._queries.get(i);const n=new Qr(t);this._queries.set(n.id,n);for(const o of t){const h=this._componentToQueriesIndex.get(o);h?h.push(n):this._componentToQueriesIndex.set(o,[n])}for(const o of this._world.entities)this.addEntity(o);return n}createTagQuery(t){const i=Jr.createId(t);if(this._tagQueries.has(i))return this._tagQueries.get(i);const n=new Jr(t);this._tagQueries.set(n.id,n);for(const o of t){const h=this._tagToQueriesIndex.get(o);h?h.push(n):this._tagToQueriesIndex.set(o,[n])}for(const o of this._world.entities)this.addEntity(o);return n}addEntity(t){const i=this._addComponentHandlers.get(t),n=this._removeComponentHandlers.get(t),o=i??this._createAddComponentHandler(t),h=n??this._createRemoveComponentHandler(t);this._addComponentHandlers.set(t,o),this._removeComponentHandlers.set(t,h);const c=this._addTagHandlers.get(t),_=this._removeTagHandlers.get(t),p=c??this._createAddTagHandler(t),v=_??this._createRemoveTagHandler(t);this._addTagHandlers.set(t,p),this._removeTagHandlers.set(t,v);for(const x of this._queries.values())x.checkAndAdd(t);for(const x of this._tagQueries.values())x.checkAndAdd(t);t.componentAdded$.subscribe(o),t.componentRemoved$.subscribe(h),t.tagAdded$.subscribe(p),t.tagRemoved$.subscribe(v)}removeEntity(t){const i=this._addComponentHandlers.get(t),n=this._removeComponentHandlers.get(t);for(const c of this._queries.values())c.removeEntity(t);i&&t.componentAdded$.unsubscribe(i),n&&t.componentRemoved$.unsubscribe(n);const o=this._addTagHandlers.get(t),h=this._removeTagHandlers.get(t);for(const c of this._tagQueries.values())c.removeEntity(t);o&&t.tagAdded$.unsubscribe(o),h&&t.tagRemoved$.unsubscribe(h)}addComponent(t,i){var n;const o=(n=this._componentToQueriesIndex.get(i.constructor))!==null&&n!==void 0?n:[];for(const h of o)h.checkAndAdd(t)}removeComponent(t,i){var n;const o=(n=this._componentToQueriesIndex.get(i.constructor))!==null&&n!==void 0?n:[];for(const h of o)h.removeEntity(t)}addTag(t,i){var n;const o=(n=this._tagToQueriesIndex.get(i))!==null&&n!==void 0?n:[];for(const h of o)h.checkAndAdd(t)}removeTag(t,i){var n;const o=(n=this._tagToQueriesIndex.get(i))!==null&&n!==void 0?n:[];for(const h of o)h.removeEntity(t)}}function h_(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class l_{constructor(t){this._world=t,this.systems=[],this.initialized=!1}get(t){return this.systems.find(i=>i instanceof t)}addSystem(t){let i;t instanceof yi?i=t:i=new t(this._world),this.systems.push(i),this.systems.sort((n,o)=>n.constructor.priority-o.constructor.priority),this.initialized&&i.initialize&&i.initialize(this._world,this._world.scene)}removeSystem(t){lr(t,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const t of this.systems)t.initialize&&t.initialize(this._world,this._world.scene)}}updateSystems(t,i,n){const o=this.systems.filter(h=>h.systemType===t);for(const h of o)h.preupdate&&h.preupdate(i,n);for(const h of o)h.update(n);for(const h of o)h.postupdate&&h.postupdate(i,n)}clear(){for(let t=this.systems.length-1;t>=0;t--)this.removeSystem(this.systems[t])}}class c_{constructor(t){this.scene=t,this._logger=dt.getInstance(),this.queryManager=new a_(this),this.entityManager=new o_(this),this.systemManager=new l_(this)}query(t){return this.queryManager.createQuery(t)}queryTags(t){return this.queryManager.createTagQuery(t)}update(t,i){t===pi.Update&&this.entityManager.updateEntities(this.scene,i),this.systemManager.updateSystems(t,this.scene,i),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(t){if(t instanceof qe){this.entityManager.addEntity(t);return}if(t instanceof yi||h_(t)){this.systemManager.addSystem(t);return}this._logger.warn(`Could not add entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(t){return this.systemManager.get(t)}remove(t,i=!0){if(t instanceof qe){this.entityManager.removeEntity(t,i);return}if(t instanceof yi){this.systemManager.removeSystem(t);return}this._logger.warn(`Could not remove entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class Ma extends yi{constructor(t,i){super(),this.world=t,this.physics=i,this.systemType=pi.Update,this._physicsConfigDirty=!1,i.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([st,kt])}update(t){let i,n;const o=this.query.entities,h=this.physics.config.substep;for(let c=0;c<o.length;c++){i=o[c].get(st),n=o[c].get(kt);const _=o[c].get(Pt);if(this._physicsConfigDirty&&_&&_.updatePhysicsConfig(this.physics.config.bodies),_?.isSleeping)continue;const p=n.acc.clone();_?.collisionType===ft.Active&&_?.useGravity&&p.addEqual(this.physics.config.gravity),o[c].parent||this.captureOldTransformWithChildren(o[c]),Je.integrate(i,n,p,t/h)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(t){var i;(i=t.get(Pt))===null||i===void 0||i.captureOldTransform();for(let n=0;n<t.children.length;n++)this.captureOldTransformWithChildren(t.children[n])}}Ma.priority=as.Higher;class Bl{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map}solve(t){this.preSolve(t),t=t.filter(n=>!n.isCanceled());let i;switch(this.config.contactSolveBias){case Ds.HorizontalFirst:{i=Ec;break}case Ds.VerticalFirst:{i=Tc;break}default:i=Ic}t.sort((n,o)=>{const h=this.directionMap.get(n.id),c=this.directionMap.get(o.id),_=this.distanceMap.get(n.id),p=this.distanceMap.get(o.id);return i[h]-i[c]||_-p});for(const n of t)this.solvePosition(n),this.solveVelocity(n);return this.postSolve(t),t}preSolve(t){for(let n=0;n<t.length;n++){const o=t[n];if(Math.abs(o.mtv.x)<1e-4&&Math.abs(o.mtv.y)<1e-4){o.cancel();continue}const h=Ot.fromDirection(o.mtv),c=o.mtv.negate(),_=Math.abs(o.info.separation);this.distanceMap.set(o.id,_),this.directionMap.set(o.id,h===Ot.Left||h===Ot.Right?"horizontal":"vertical"),o.colliderA.events.emit("precollision",new Mn(o.colliderA,o.colliderB,h,c,o)),o.colliderB.events.emit("precollision",new Mn(o.colliderB,o.colliderA,Ot.getOpposite(h),c.negate(),o))}}postSolve(t){var i,n;for(let o=0;o<t.length;o++){const h=t[o];if(h.isCanceled())continue;const c=h.colliderA,_=h.colliderB,p=(i=c.owner)===null||i===void 0?void 0:i.get(Pt),v=(n=_.owner)===null||n===void 0?void 0:n.get(Pt);if(p&&v&&(p.collisionType===ft.Passive||v.collisionType===ft.Passive))continue;const x=Ot.fromDirection(h.mtv),b=h.mtv.negate();h.colliderA.events.emit("postcollision",new Bn(h.colliderA,h.colliderB,x,b,h)),h.colliderB.events.emit("postcollision",new Bn(h.colliderB,h.colliderA,Ot.getOpposite(x),b.negate(),h))}}solvePosition(t){var i,n;if(!t.colliderA.bounds.overlaps(t.colliderB.bounds,1e-4)){t.cancel();return}if(Math.abs(t.mtv.x)<1e-4&&Math.abs(t.mtv.y)<1e-4){t.cancel();return}let h=t.mtv;const c=t.colliderA,_=t.colliderB,p=(i=c.owner)===null||i===void 0?void 0:i.get(Pt),v=(n=_.owner)===null||n===void 0?void 0:n.get(Pt);if(p&&v){if(p.collisionType===ft.Passive||v.collisionType===ft.Passive)return;p.collisionType===ft.Active&&v.collisionType===ft.Active&&(h=h.scale(.5)),p.collisionType===ft.Active&&(p.globalPos.x-=h.x,p.globalPos.y-=h.y,c.update(p.transform.get())),v.collisionType===ft.Active&&(v.globalPos.x+=h.x,v.globalPos.y+=h.y,_.update(v.transform.get()))}}solveVelocity(t){var i,n;if(t.isCanceled())return;const o=t.colliderA,h=t.colliderB,c=(i=o.owner)===null||i===void 0?void 0:i.get(Pt),_=(n=h.owner)===null||n===void 0?void 0:n.get(Pt);if(c&&_){if(c.collisionType===ft.Passive||_.collisionType===ft.Passive)return;const p=t.normal,v=p.negate();if(c.collisionType===ft.Active&&c.vel.normalize().dot(v)<0){const x=p.scale(p.dot(c.vel.negate()));c.vel=c.vel.add(x)}if(_.collisionType===ft.Active&&_.vel.normalize().dot(p)<0){const x=v.scale(v.dot(_.vel.negate()));_.vel=_.vel.add(x)}}}}class d_{constructor(t,i,n){this.point=t,this.local=i,this.contact=n,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new k(0,0),this.bToContact=new k(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const t=this.contact.bodyA,i=this.contact.colliderA,n=this.contact.bodyB,o=this.contact.colliderB;if(t&&n){const h=this.contact.normal,c=this.contact.tangent;this.aToContact=this.point.sub(i.center),this.bToContact=this.point.sub(o.center);const _=this.aToContact.cross(h),p=this.bToContact.cross(h);this.normalMass=t.inverseMass+n.inverseMass+t.inverseInertia*_*_+n.inverseInertia*p*p;const v=this.aToContact.cross(c),x=this.bToContact.cross(c);this.tangentMass=t.inverseMass+n.inverseMass+t.inverseInertia*v*v+n.inverseInertia*x*x}return this}getRelativeVelocity(){const t=this.contact.bodyA,i=this.contact.bodyB;if(t&&i){const n=t.vel.add(k.cross(t.angularVelocity,this.aToContact));return i.vel.add(k.cross(i.angularVelocity,this.bToContact)).sub(n)}return k.Zero}}class kl{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(t){var i;return(i=this.idToContactConstraint.get(t))!==null&&i!==void 0?i:[]}solve(t){this.preSolve(t),t=t.filter(n=>!n.isCanceled());let i;switch(this.config.contactSolveBias){case Ds.HorizontalFirst:{i=Ec;break}case Ds.VerticalFirst:{i=Tc;break}default:i=Ic}return t.sort((n,o)=>{const h=this.directionMap.get(n.id),c=this.directionMap.get(o.id),_=this.distanceMap.get(n.id),p=this.distanceMap.get(o.id);return i[h]-i[c]||_-p}),this.solveVelocity(t),this.solvePosition(t),this.postSolve(t),t}preSolve(t){var i,n,o,h;for(let p=0;p<t.length;p++){const v=t[p];if(Math.abs(v.mtv.x)<1e-4&&Math.abs(v.mtv.y)<1e-4){v.cancel();continue}const x=Ot.fromDirection(v.mtv),b=Math.abs(((i=v?.info)===null||i===void 0?void 0:i.separation)||0);this.distanceMap.set(v.id,b),this.directionMap.set(v.id,x===Ot.Left||x===Ot.Right?"horizontal":"vertical"),v.colliderA.events.emit("precollision",new Mn(v.colliderA,v.colliderB,x,v.mtv,v)),v.colliderA.events.emit("beforecollisionresolve",new pa(v.colliderA,v.colliderB,x,v.mtv,v)),v.colliderB.events.emit("precollision",new Mn(v.colliderB,v.colliderA,Ot.getOpposite(x),v.mtv.negate(),v)),v.colliderB.events.emit("beforecollisionresolve",new pa(v.colliderB,v.colliderA,Ot.getOpposite(x),v.mtv.negate(),v)),v.matchAwake()}const _=Array.from(this.idToContactConstraint.keys());for(let p=0;p<t.length;p++){const v=t[p],x=_.indexOf(v.id);x>-1&&_.splice(x,1);const b=(n=this.idToContactConstraint.get(v.id))!==null&&n!==void 0?n:[];let S=0;const P=v.bodyA,I=v.colliderA,M=v.bodyB,R=v.colliderB;if(P&&M)for(let T=0;T<v.points.length;T++){const F=v.points[T],W=v.normal,U=v.tangent,V=F.sub(I.center),j=F.sub(R.center),X=V.cross(W),rt=j.cross(W),lt=P.inverseMass+M.inverseMass+P.inverseInertia*X*X+M.inverseInertia*rt*rt,xt=V.cross(U),mt=j.cross(U),Ct=P.inverseMass+M.inverseMass+P.inverseInertia*xt*xt+M.inverseInertia*mt*mt;b[S]&&((h=(o=b[S])===null||o===void 0?void 0:o.point)===null||h===void 0?void 0:h.squareDistance(F))<4?(b[S].point=F,b[S].local=v.localPoints[S]):b[S]=new d_(F,v.localPoints[S],v),b[S].aToContact=V,b[S].bToContact=j,b[S].normalMass=1/lt,b[S].tangentMass=1/Ct;const Rt=P.bounciness>M.bounciness?P.bounciness:M.bounciness,B=v.normal.dot(b[S].getRelativeVelocity());b[S].originalVelocityAndRestitution=0,B<-.1&&(b[S].originalVelocityAndRestitution=-Rt*B),S++}this.idToContactConstraint.set(v.id,b)}for(const p of _)this.idToContactConstraint.delete(p);if(this.config.warmStart)this.warmStart(t);else for(let p=0;p<t.length;p++){const v=t[p],x=this.getContactConstraints(v.id);for(const b of x)b.normalImpulse=0,b.tangentImpulse=0}}postSolve(t){for(let i=0;i<t.length;i++){const n=t[i],o=n.bodyA,h=n.bodyB;if(o&&h){if(o.collisionType===ft.Passive||h.collisionType===ft.Passive)continue;o.updateMotion(),h.updateMotion()}const c=Ot.fromDirection(n.mtv);n.colliderA.events.emit("postcollision",new Bn(n.colliderA,n.colliderB,c,n.mtv,n)),n.colliderA.events.emit("aftercollisionresolve",new ma(n.colliderA,n.colliderB,c,n.mtv,n)),n.colliderB.events.emit("postcollision",new Bn(n.colliderB,n.colliderA,Ot.getOpposite(c),n.mtv.negate(),n)),n.colliderB.events.emit("aftercollisionresolve",new ma(n.colliderB,n.colliderA,Ot.getOpposite(c),n.mtv.negate(),n))}this.lastFrameContacts.clear();for(let i=0;i<t.length;i++){const n=t[i];this.lastFrameContacts.set(n.id,n)}}warmStart(t){var i;for(let n=0;n<t.length;n++){const o=t[n],h=o.bodyA,c=o.bodyB;if(h&&c){const _=(i=this.idToContactConstraint.get(o.id))!==null&&i!==void 0?i:[];for(const p of _)if(this.config.warmStart){const v=o.normal.scale(p.normalImpulse),x=o.tangent.scale(p.tangentImpulse),b=v.add(x);h.applyImpulse(p.point,b.negate()),c.applyImpulse(p.point,b)}else p.normalImpulse=0,p.tangentImpulse=0}}}solvePosition(t){var i;for(let n=0;n<this.config.positionIterations;n++)for(let o=0;o<t.length;o++){const h=t[o],c=h.bodyA,_=h.bodyB;if(c&&_){if(c.collisionType===ft.Passive||_.collisionType===ft.Passive)continue;const p=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const v of p){const x=h.normal,b=zi.FindContactSeparation(h,v.local),S=this.config.steeringFactor,P=-5,I=this.config.slop,M=At(S*(b+I),P,0),R=x.scale(-M*v.normalMass);if(c.collisionType===ft.Active){const T=R.negate().scale(c.inverseMass);c.limitDegreeOfFreedom.includes(ri.X)&&(T.x=0),c.limitDegreeOfFreedom.includes(ri.Y)&&(T.y=0),c.globalPos=c.globalPos.add(T),c.limitDegreeOfFreedom.includes(ri.Rotation)||(c.rotation-=v.aToContact.cross(R)*c.inverseInertia)}if(_.collisionType===ft.Active){const T=R.scale(_.inverseMass);_.limitDegreeOfFreedom.includes(ri.X)&&(T.x=0),_.limitDegreeOfFreedom.includes(ri.Y)&&(T.y=0),_.globalPos=_.globalPos.add(T),_.limitDegreeOfFreedom.includes(ri.Rotation)||(_.rotation+=v.bToContact.cross(R)*_.inverseInertia)}}}}}solveVelocity(t){var i;for(let n=0;n<this.config.velocityIterations;n++)for(let o=0;o<t.length;o++){const h=t[o],c=h.bodyA,_=h.bodyB;if(c&&_){if(c.collisionType===ft.Passive||_.collisionType===ft.Passive)continue;const p=Math.min(c.friction,_.friction),v=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const x of v){let P=-x.getRelativeVelocity().dot(h.tangent)*x.tangentMass;const I=p*x.normalImpulse,M=At(x.tangentImpulse+P,-I,I);P=M-x.tangentImpulse,x.tangentImpulse=M;const R=h.tangent.scale(P);c.applyImpulse(x.point,R.negate()),_.applyImpulse(x.point,R)}for(const x of v){const S=x.getRelativeVelocity().dot(h.normal);let P=-x.normalMass*(S-x.originalVelocityAndRestitution);const I=Math.max(x.normalImpulse+P,0);P=I-x.normalImpulse,x.normalImpulse=I;const M=h.normal.scale(P);c.applyImpulse(x.point,M.negate()),_.applyImpulse(x.point,M)}}}}}class Ba extends yi{get _processor(){return this._physics.collisionProcessor}constructor(t,i){super(),this._physics=i,this.systemType=pi.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new Bl(i.config.arcade),this._realisticSolver=new kl(i.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=n=>this._processor.track(n),this._untrackCollider=n=>this._processor.untrack(n),this.query=t.query([st,kt,ve]),this.query.entityAdded$.subscribe(n=>{const o=n.get(ve);o.$colliderAdded.subscribe(this._trackCollider),o.$colliderRemoved.subscribe(this._untrackCollider);const h=o.get();h&&this._processor.track(h)}),this.query.entityRemoved$.subscribe(n=>{const o=n.get(ve),h=o.get();o&&h&&this._processor.untrack(h)}),this._motionSystem=t.get(Ma)}initialize(t,i){this._engine=i.engine}update(t){var i,n,o,h;if(!this._physics.config.enabled)return;let c=[];for(let b=0;b<this.query.entities.length;b++){const P=this.query.entities[b].get(ve),I=P?.get();if(P&&(!((i=P.owner)===null||i===void 0)&&i.isActive)&&I)if(P.update(),I instanceof Ee){const M=I.getColliders();I.compositeStrategy||(I.compositeStrategy=this._physics.config.colliders.compositeStrategy),c=c.concat(M)}else c.push(I)}this._processor.update(c,t);let _=this._processor.broadphase(c,t);this._currentFrameContacts.clear();let p=[];const v=this.getSolver(),x=this._physics.config.substep;for(let b=0;b<x;b++)if(b>0&&this._motionSystem.update(t),p.length&&(_=p.map(S=>new $e(S.colliderA,S.colliderB))),_.length){p=this._processor.narrowphase(_,(h=(o=(n=this._engine)===null||n===void 0?void 0:n.debug)===null||o===void 0?void 0:o.stats)===null||h===void 0?void 0:h.currFrame),p=v.solve(p);for(const S of p){if(S.isCanceled())continue;const P=S.id.indexOf("|");if(P>0){const I=S.id.substring(P+1);this._currentFrameContacts.set(I,S)}else this._currentFrameContacts.set(S.id,S)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const b of this.query.entities){const S=b.get(ve);S&&S.processColliderRemoval()}}postupdate(){pe.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new Bl(this._physics.config.arcade),this._realisticSolver=new kl(this._physics.config.realistic)),this._physics.config.solver===Zr.Realistic?this._realisticSolver:this._arcadeSolver}debug(t){this._processor.debug(t,0)}runContactStartEnd(){for(const[t,i]of this._currentFrameContacts)if(!this._lastFrameContacts.has(t)){const n=i.colliderA,o=i.colliderB,h=Ot.fromDirection(i.mtv),c=Ot.getOpposite(h);n.events.emit("collisionstart",new Xr(n,o,h,i)),n.events.emit("contactstart",new _a(n,o,h,i)),o.events.emit("collisionstart",new Xr(o,n,c,i)),o.events.emit("contactstart",new _a(o,n,c,i))}for(const[t,i]of this._lastFrameContacts)if(!this._currentFrameContacts.has(t)){const n=i.colliderA,o=i.colliderB,h=Ot.fromDirection(i.mtv),c=Ot.getOpposite(h);n.events.emit("collisionend",new qr(n,o,h,i)),n.events.emit("contactend",new ga(n,o,h,i)),o.events.emit("collisionend",new qr(o,n,c,i)),o.events.emit("contactend",new ga(o,n,c,i))}}}Ba.priority=as.Higher;function Uv(d,t,i,n){if(d.parent!==t.parent){const x=d.clone(),b=d.globalPos.clone(),S=d.globalScale.clone(),P=d.globalRotation;x.parent=t.parent,x.globalPos=b,x.globalScale=S,x.globalRotation=P,d=x}let o=t.pos,h=t.scale,c=t.rotation;o=t.pos.scale(i).add(d.pos.scale(1-i)),h=t.scale.scale(i).add(d.scale.scale(1-i));const _=(1-i)*Math.cos(d.rotation)+i*Math.cos(t.rotation),p=(1-i)*Math.sin(d.rotation)+i*Math.sin(t.rotation);c=Math.atan2(p,_);const v=n??new Is;return v.setTransform(o,c,h),v}class Mc extends yi{get sortedTransforms(){return this._sortedTransforms}constructor(t){super(),this.world=t,this.systemType=pi.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new Is,this.query=this.world.query([st,ae]),this.query.entityAdded$.subscribe(i=>{const n=i.get(st);this._sortedTransforms.push(n),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{const n=i.get(st);n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const o=this._sortedTransforms.indexOf(n);o>-1&&this._sortedTransforms.splice(o,1)})}initialize(t,i){this._camera=i.camera,this._engine=i.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>t.globalZ-i.globalZ),this._zHasChanged=!1)}update(t){this._token++;let i;Ht.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let n=0;n<this._sortedTransforms.length;n++){const o=this._sortedTransforms[n],h=o.owner;if(h.hasTag("ex.offscreen")||(i=h.get(ae),!i.isVisible))continue;i.onPreTransformDraw&&i.onPreTransformDraw(this._graphicsContext,t),h.events.emit("pretransformdraw",new ic(this._graphicsContext,t,h)),o.coordPlane===ke.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),o.coordPlane===ke.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),i.update(t,this._token);const c=h.get(Da);if(c){const _=k.One.sub(c.parallaxFactor),p=this._camera.drawPos.scale(_);this._graphicsContext.translate(p.x,p.y)}this._applyTransform(h),i.material&&(this._graphicsContext.material=i.material),i.onPreDraw&&i.onPreDraw(this._graphicsContext,t),h.events.emit("predraw",new ur(this._graphicsContext,t,h)),this._applyOpacity(h),this._drawGraphicsComponent(i,o),i.onPostDraw&&i.onPostDraw(this._graphicsContext,t),h.events.emit("postdraw",new fr(this._graphicsContext,t,h)),this._graphicsContext.restore(),o.coordPlane===ke.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),i.onPostTransformDraw&&i.onPostTransformDraw(this._graphicsContext,t),h.events.emit("posttransformdraw",new sc(this._graphicsContext,t,h))}this._graphicsContext.restore()}_drawGraphicsComponent(t,i){var n,o;if(t.isVisible){const h=t.flipHorizontal,c=t.flipVertical,_=t.current,p=(n=t.currentOptions)!==null&&n!==void 0?n:{};if(_){let v=t.anchor,x=t.offset,b=1,S=1;p?.anchor&&(v=p.anchor),p?.offset&&(x=p.offset);const P=i.globalScale;b*=_.scale.x*P.x,S*=_.scale.y*P.y;const I=-_.width*v.x+x.x*b,M=-_.height*v.y+x.y*S,R=_.flipHorizontal,T=_.flipVertical;if((h||c)&&(_.flipHorizontal=h?!R:R,_.flipVertical=c?!T:T),_?.draw(this._graphicsContext,I,M),(h||c)&&(_.flipHorizontal=R,_.flipVertical=T),!((o=this._engine)===null||o===void 0)&&o.isDebug&&this._engine.debug.graphics.showBounds){const F=G(I,M);if(_ instanceof er)for(const W of _.members){let U,V=k.Zero;W instanceof oe?U=W:(U=W.graphic,V=W.offset),_.useAnchor?U?.localBounds.translate(F.add(V)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):U?.localBounds.translate(V).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else _?.localBounds.translate(F).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(t){const i=t.getAncestors();for(let n=0;n<i.length;n++){const o=i[n],h=o?.get(st),c=o?.get(Pt);if(h){let _=h.get();if(c&&this._engine.fixedUpdateTimestep&&c.__oldTransformCaptured&&c.enableFixedUpdateInterpolate){const p=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;_=Uv(c.oldTransform,h.get(),p,this._targetInterpolationTransform)}this._graphicsContext.z=h.globalZ,this._graphicsContext.translate(_.pos.x,_.pos.y),this._graphicsContext.scale(_.scale.x,_.scale.y),this._graphicsContext.rotate(_.rotation)}}}_applyOpacity(t){var i;const n=t.getAncestors();for(let o=0;o<n.length;o++){const h=n[o],c=h?.get(ae);this._graphicsContext.opacity*=(i=c?.opacity)!==null&&i!==void 0?i:1}}}Mc.priority=as.Average;class Bc extends yi{constructor(t){super(),this.world=t,this.systemType=pi.Draw,this.query=this.world.query([st])}initialize(t,i){this._graphicsContext=i.engine.graphicsContext,this._camera=i.camera,this._engine=i.engine,this._collisionSystem=t.systemManager.get(Ba)}update(){var t;if(!this._engine.isDebug)return;const i=this._engine.debug.filter;let n,o;const h=this._engine.debug.entity;let c;const _=this._engine.debug.transform;let p;const v=this._engine.debug.motion;let x;const b=this._engine.debug.collider,S=this._engine.debug.physics;let P;const I=this._engine.debug.graphics;let M,R;const T=this._engine.debug.body,F=this._engine.debug.camera;for(let W=0;W<this.query.entities.length;W++){const U=this.query.entities[W];if(U.hasTag("offscreen")||U instanceof Ta||i.useFilter&&(!(i.ids.length===0||i.ids.includes(U.id))||!(i.nameQuery===""||U.name.includes(i.nameQuery))))continue;let V=k.Zero;const j=G(0,16);if(n=U.id,o=U.name,c=U.get(st),this._pushCameraTransform(c),this._graphicsContext.save(),c.coordPlane===ke.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=_.debugZIndex,this._applyTransform(U),c&&((_.showAll||_.showPosition)&&this._graphicsContext.debug.drawPoint(k.Zero,{size:4,color:_.positionColor}),(_.showAll||_.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${c.pos.toString(2)}`,V),V=V.add(j)),(_.showAll||_.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${c.z.toFixed(1)})`,V),V=V.add(j)),(h.showAll||h.showId)&&(this._graphicsContext.debug.drawText(`id(${n}) ${U.parent?"child of id("+((t=U.parent)===null||t===void 0?void 0:t.id)+")":""}`,V),V=V.add(j)),(h.showAll||h.showName)&&(this._graphicsContext.debug.drawText(`name(${o})`,V),V=V.add(j)),(_.showAll||_.showRotation)&&(this._graphicsContext.drawLine(k.Zero,k.fromAngle(c.rotation).scale(50).add(k.Zero),_.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${tf(c.rotation).toFixed(2)})`,V),V=V.add(j)),(_.showAll||_.showScale)&&this._graphicsContext.drawLine(k.Zero,c.scale.add(k.Zero),_.scaleColor,2)),P=U.get(ae),P&&(I.showAll||I.showBounds)&&P.localBounds.draw(this._graphicsContext,I.boundsColor),M=U.get(Fa),M&&(M.useTransform||this._graphicsContext.restore(),M.draw(this._graphicsContext,this._engine.debug),M.useTransform||(this._graphicsContext.save(),this._applyTransform(U))),R=U.get(Pt),R&&((T.showAll||T.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${R.group.name})`,V),V=V.add(j)),(T.showAll||T.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${R.collisionType})`,V),V=V.add(j)),(T.showAll||T.showMass)&&(this._graphicsContext.debug.drawText(`mass(${R.mass})`,V),V=V.add(j)),(T.showAll||T.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${R.sleepMotion})`,V),V=V.add(j)),(T.showAll||T.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${R.canSleep?R.isSleeping:"cant sleep"})`,V),V=V.add(j))),this._graphicsContext.restore(),this._graphicsContext.save(),c.coordPlane===ke.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=_.debugZIndex,p=U.get(kt),p&&((v.showAll||v.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${p.vel.toString(2)}`,V.add(c.globalPos)),this._graphicsContext.drawLine(c.globalPos,c.globalPos.add(p.vel),v.velocityColor,2),V=V.add(j)),(v.showAll||v.showAcceleration)&&this._graphicsContext.drawLine(c.globalPos,c.globalPos.add(p.acc),v.accelerationColor,2)),x=U.get(ve),x){const X=x.get();if((b.showAll||b.showGeometry)&&X&&X.debug(this._graphicsContext,b.geometryColor,{lineWidth:b.geometryLineWidth,pointSize:b.geometryPointSize}),b.showAll||b.showBounds){if(X instanceof Ee){const rt=X.getColliders();for(const lt of rt){const xt=lt.bounds,mt=G(xt.left,xt.top);this._graphicsContext.debug.drawRect(mt.x,mt.y,xt.width,xt.height,{color:b.boundsColor}),(b.showAll||b.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${lt.owner.id})`,mt)}x.bounds.draw(this._graphicsContext,b.boundsColor)}else if(X){const rt=x.bounds,lt=G(rt.left,rt.top);this._graphicsContext.debug.drawRect(lt.x,lt.y,rt.width,rt.height,{color:b.boundsColor}),(b.showAll||b.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${x.owner.id})`,lt)}}}this._graphicsContext.restore(),this._popCameraTransform(c)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(S.showAll||S.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),S.showAll||S.showCollisionContacts||S.showCollisionNormals)for(const[W,U]of this._engine.debug.stats.currFrame.physics.contacts){if(S.showAll||S.showCollisionContacts)for(const V of U.points)this._graphicsContext.debug.drawPoint(V,{size:S.contactSize,color:S.collisionContactColor});if(S.showAll||S.showCollisionNormals)for(const V of U.points)this._graphicsContext.debug.drawLine(V,U.normal.scale(30).add(V),{color:S.collisionNormalColor})}this._graphicsContext.restore(),F&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(F.showAll||F.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,F.focusColor),(F.showAll||F.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(t,i){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),Te.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(t){const i=t.getAncestors();for(const n of i){const o=n?.get(st);o&&(this._graphicsContext.translate(o.pos.x,o.pos.y),this._graphicsContext.scale(o.scale.x,o.scale.y),this._graphicsContext.rotate(o.rotation))}}_pushCameraTransform(t){t.coordPlane===ke.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(t){t.coordPlane===ke.World&&this._graphicsContext.restore()}}Bc.priority=as.Lowest;class kc{constructor(t,i){this.object=t,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=i,this.bounds=t.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const t=this.object.bounds,i=Math.floor(t.left/this.gridSize),n=Math.floor(t.right/this.gridSize),o=Math.floor(t.bottom/this.gridSize),h=Math.floor(t.top/this.gridSize);return this.leftX!==i||this.rightX!==n||this.bottomY!==o||this.topY!==h}clear(){for(const t of this.cells){const i=t.proxies.indexOf(this);i>-1&&t.proxies.splice(i,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class es{constructor(){this.proxies=[]}configure(t,i){this.x=t,this.y=i,this.key=es.calculateHashKey(t,i)}static calculateHashKey(t,i){return`${t}+${i}`}}class Lc{constructor(t){this.bounds=new ct,this._hashGridCellPool=new io(()=>new es,i=>(i.configure(0,0),i.proxies.length=0,i),1e3),this.gridSize=t.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,t.proxyFactory?this._buildProxy=i=>t.proxyFactory(i,this.gridSize):this._buildProxy=i=>new kc(i,this.gridSize)}query(t){const i=new Set;if(t instanceof ct){const n=t,o=Math.floor(n.left/this.gridSize),h=Math.floor(n.right/this.gridSize),c=Math.floor(n.bottom/this.gridSize),_=Math.floor(n.top/this.gridSize);for(let p=o;p<=h;p++)for(let v=_;v<=c;v++){const x=es.calculateHashKey(p,v),b=this.sparseHashGrid.get(x);if(b)for(let S=0;S<b.proxies.length;S++)b.proxies[S].updateBounds(),b.proxies[S].bounds.intersect(n)&&i.add(b.proxies[S].object)}}else{const n=t,o=es.calculateHashKey(Math.floor(n.x/this.gridSize),Math.floor(n.y/this.gridSize)),h=this.sparseHashGrid.get(o);if(h)for(let c=0;c<h.proxies.length;c++)h.proxies[c].updateBounds(),h.proxies[c].bounds.contains(n)&&i.add(h.proxies[c].object)}return Array.from(i)}get(t,i){const n=es.calculateHashKey(t,i);return this.sparseHashGrid.get(n)}_insert(t,i,n){const o=es.calculateHashKey(t,i);let h=this.sparseHashGrid.get(o);h||(h=this._hashGridCellPool.rent(),h.configure(t,i),this.sparseHashGrid.set(h.key,h)),h.proxies.push(n),n.cells.push(h),this.bounds.combine(n.bounds,this.bounds)}_remove(t,i,n){const o=es.calculateHashKey(t,i),h=this.sparseHashGrid.get(o);if(h){const c=h.proxies.indexOf(n);c>-1&&h.proxies.splice(c,1);const _=n.cells.indexOf(h);_>-1&&n.cells.splice(_,1),h.proxies.length===0&&(this._hashGridCellPool.return(h),this.sparseHashGrid.delete(o))}}track(t){const i=this._buildProxy(t);this.objectToProxy.set(t,i);for(let n=i.leftX;n<=i.rightX;n++)for(let o=i.topY;o<=i.bottomY;o++)this._insert(n,o,i)}untrack(t){const i=this.objectToProxy.get(t);i&&(i.clear(),this.objectToProxy.delete(t))}update(t){let i=0;for(const n of t){const o=this.objectToProxy.get(n);if(o&&o.hasChanged()){for(let h=o.leftX;h<=o.rightX;h++)for(let c=o.topY;c<=o.bottomY;c++)this._remove(h,c,o);o.update();for(let h=o.leftX;h<=o.rightX;h++)for(let c=o.topY;c<=o.bottomY;c++)this._insert(h,c,o);i++}}return i}debug(t,i){const n=K.Transparent,o=K.White;for(const h of this.sparseHashGrid.values())t.drawRectangle(G(h.x*this.gridSize,h.y*this.gridSize),this.gridSize,this.gridSize,n,o,2)}}class ka extends yi{constructor(t){super(),this.world=t,this.systemType=pi.Update,this._graphicsHashGrid=new Lc({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new Fc,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([st,Js]),this.query.entityAdded$.subscribe(i=>{const n=i.get(st),o=i.get(Js);this._pointerEventDispatcher.addObject(i,c=>o&&o.localBounds?o.localBounds.transform(n.get().matrix).contains(n.coordPlane===ke.World?c.worldPos:c.screenPos):!1,()=>i.isActive),this._entityToPointer.set(i,o);const h=i.get(ae);h&&(this._graphics.push(h),this._graphicsHashGrid.track(h)),this._sortedTransforms.push(n),this._sortedEntities.push(n.owner),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{this._pointerEventDispatcher.removeObject(i);const n=i.get(st);this._entityToPointer.delete(i);const o=i.get(ae);if(o){const c=this._graphics.indexOf(o);c>-1&&this._graphics.splice(c,1),this._graphicsHashGrid.untrack(o)}n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const h=this._sortedTransforms.indexOf(n);h>-1&&(this._sortedTransforms.splice(h,1),this._sortedEntities.splice(h,1))})}initialize(t,i){this._engine=i.engine,this._scene=i}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>i.z-t.z),this._sortedEntities=this._sortedTransforms.map(t=>t.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[t,i]of this._engineReceiver.currentFramePointerCoords.entries()){const n=this._scene.physics.query(i.worldPos);for(let h=0;h<n.length;h++){const c=n[h],_=this._entityToPointer.get(c.owner);_&&(_.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(c.owner,t)}const o=this._graphicsHashGrid.query(i.worldPos);for(let h=0;h<o.length;h++){const c=o[h],_=this._entityToPointer.get(c.owner);_&&(_.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(c.owner,t)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(t=>t.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(t=>t.clear())}}ka.priority=as.Higher;class Uc extends yi{constructor(t){super(),this.world=t,this.systemType=pi.Update,this._actions=[],this.query=this.world.query([$n]),this.query.entityAdded$.subscribe(i=>this._actions.push(i.get($n))),this.query.entityRemoved$.subscribe(i=>{const n=i.get($n),o=this._actions.indexOf(n);o>-1&&this._actions.splice(o,1)})}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}}Uc.priority=as.Higher;class Kr extends Ci{constructor(t){super(),this.elevation=0,this.columns=t.columns,this.rows=t.rows,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight}}class zc extends yi{constructor(t){super(),this.world=t,this.systemType=pi.Update,this.query=this.world.query([st,Kr])}update(){let t,i;for(let n=0;n<this.query.entities.length;n++){const o=this.query.entities[n];t=o.get(st),i=o.get(Kr);const c=Math.max(i.columns*i.tileWidth,i.rows*i.tileHeight)*i.elevation+t.pos.y;t.z=c}}}zc.priority=as.Lower;class Hc extends yi{constructor(t){super(),this.world=t,this.systemType=pi.Draw,this.query=this.world.query([st,ae])}initialize(t,i){this._camera=i.camera,this._screen=i.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let t,i,n;for(let o=0;o<this.query.entities.length;o++){const h=this.query.entities[o];i=h.get(ae),t=h.get(st),n=h.get(Da);let c;if(n){const p=k.One.sub(n.parallaxFactor);c=this._camera.pos.scale(p)}const _=this._isOffscreen(t,i,c);_&&!h.hasTag("ex.offscreen")&&(h.events.emit("exitviewport",new pc(h)),h.addTag("ex.offscreen")),!_&&h.hasTag("ex.offscreen")&&(h.events.emit("enterviewport",new mc(h)),h.removeTag("ex.offscreen"))}}_isOffscreen(t,i,n){if(i.forceOnScreen)return!1;if(t.coordPlane===ke.World){let o=i.localBounds;n&&(o=o.translate(n));const h=o.transform(t.get().matrix);return!this._worldBounds.overlaps(h)}else return!1}}Hc.priority=as.Higher;class u_ extends kc{constructor(t,i){var n,o;super(t,i),this.collider=t,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=i;const h=t.bounds;this.hasZeroBounds=h.hasZeroDimensions(),this.leftX=Math.floor(h.left/this.gridSize),this.rightX=Math.floor(h.right/this.gridSize),this.bottomY=Math.floor(h.bottom/this.gridSize),this.topY=Math.floor(h.top/this.gridSize),this.owner=t.owner,this.body=(n=this.owner)===null||n===void 0?void 0:n.get(Pt),this.collisionType=(o=this.body.collisionType)!==null&&o!==void 0?o:ft.PreventCollision}update(){var t,i;super.update(),this.body=(t=this.owner)===null||t===void 0?void 0:t.get(Pt),this.collisionType=(i=this.body.collisionType)!==null&&i!==void 0?i:ft.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class Ll{constructor(t){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new Sa(()=>new $e({id:Rn("collider",0)},{id:Rn("collider",0)}),i=>(i.colliderA=null,i.colliderB=null,i),200),this.gridSize=t.size,this.hashGrid=new Lc({size:this.gridSize,proxyFactory:(i,n)=>new u_(i,n)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(t){return this.hashGrid.query(t)}rayCast(t,i){var n,o,h;const c=[],_=(n=i?.maxDistance)!==null&&n!==void 0?n:1/0,p=i?.collisionGroup,v=p?p.category:(o=i?.collisionMask)!==null&&o!==void 0?o:Rs.All.category,x=(h=i?.searchAllColliders)!==null&&h!==void 0?h:!1,b=t.dir.normalize(),S=b.y/b.x,P=b.x/b.y,I=Math.sqrt(1+S*S)*this.gridSize,M=Math.sqrt(1+P*P)*this.gridSize,R=t.pos.x/this.gridSize,T=t.pos.y/this.gridSize,F=G(1,1);let W=~~R,U=~~T,V=0,j=0;b.x<0?(F.x=-1,V=(R-W)*I):(F.x=1,V=(W+1-R)*I),b.y<0?(F.y=-1,j=(T-U)*M):(F.y=1,j=(U+1-T)*M);const X=new Set;let rt=!1,lt=9999;for(;!rt&&lt>0&&(lt--,!!this.hashGrid.bounds.contains(G(W*this.gridSize,U*this.gridSize)));){const xt=es.calculateHashKey(W,U),mt=this.hashGrid.sparseHashGrid.get(xt);if(mt){const Ct=[];for(let Rt=0;Rt<mt.proxies.length;Rt++){const B=mt.proxies[Rt];if(!X.has(B.collider.id.value)){if(X.add(B.collider.id.value),i?.ignoreCollisionGroupAll&&B.body.group===Rs.All)continue;const z=(v&B.body.group.category)!==0;if(B.body.group&&!z)continue;const Q=B.collider.rayCast(t,_);Q&&Ct.push(Q)}}Ct.sort((Rt,B)=>Rt.distance-B.distance);for(let Rt=0;Rt<Ct.length;Rt++){const B=Ct[Rt];if(i?.filter){if(i.filter(B)&&(c.push(B),!x)){rt=!0;break}}else if(c.push(B),!x){rt=!0;break}}}V<j?(W+=F.x,V+=I):(U+=F.y,j+=M)}return c.sort((xt,mt)=>xt.distance-mt.distance),!x&&c.length?[c[0]]:c}track(t){let i=[t];if(t instanceof Ee){const n=t.getColliders();for(const o of n)o.owner=t.owner;i=n}for(const n of i)this.hashGrid.track(n)}untrack(t){let i=[t];t instanceof Ee&&(i=t.getColliders());for(const n of i)this.hashGrid.untrack(n)}_canCollide(t,i){return!(t.collider.id===i.collider.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.hasZeroBounds||i.hasZeroBounds||!t.body.group.canCollide(i.body.group)||t.collisionType===ft.Fixed&&i.collisionType===ft.Fixed||t.collisionType===ft.PreventCollision||i.collisionType===ft.PreventCollision||!t.owner.isActive||!i.owner.isActive)}broadphase(t,i){const n=[];this._pairs.clear(),this._nonPairs.clear();let o=0;for(const h of this.hashGrid.objectToProxy.values())if(h.id=o++,!(!h.owner.isActive||h.collisionType===ft.PreventCollision))for(let c=0;c<h.cells.length;c++){const _=h.cells[c];for(let p=0;p<_.proxies.length;p++){const v=_.proxies[p];if(v.id===h.id)continue;const x=$e.calculatePairHash(h.collider.id,v.collider.id);if(!this._nonPairs.has(x))if(!this._pairs.has(x)&&this._canCollide(h,v)&&h.object.bounds.overlaps(v.object.bounds)){const b=this._pairPool.get();b.colliderA=h.collider,b.colliderB=v.collider,b.id=x,this._pairs.add(x),n.push(b)}else this._nonPairs.add(x)}}return n}narrowphase(t,i){const n=[];for(let o=0;o<t.length;o++){const h=t[o].collide();for(let c=0;c<h.length;c++){const _=h[c];n.push(_),i&&i.physics.contacts.set(_.id,_)}}return this._pairPool.done(),i&&(i.physics.collisions+=n.length),n}update(t,i){return this.hashGrid.update(t)}debug(t,i){this.hashGrid.debug(t,i)}}class f_{get config(){return Dm(this._config,t=>{this.$configUpdate.notifyAll(t)})}set config(t){this._config=t,this.$configUpdate.notifyAll(t)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const t=this._collisionProcessor.getColliders();this._config.spatialPartition===ir.SparseHashGrid?this._collisionProcessor=new Ll(this._config.sparseHashGrid):this._collisionProcessor=new wa(this._config);for(const i of t)this._collisionProcessor.track(i)}return this._collisionProcessor}constructor(t){this.$configUpdate=new Ke,this._configDirty=!1,this.config=t,this.$configUpdate.subscribe(i=>{this._configDirty=!0,Pt.updateDefaultPhysicsConfig(i.bodies)}),this._config.spatialPartition===ir.SparseHashGrid?this._collisionProcessor=new Ll(this._config.sparseHashGrid):this._collisionProcessor=new wa(this._config)}rayCast(t,i){return this.collisionProcessor.rayCast(t,i)}query(t){return this._collisionProcessor.query(t)}}class La{constructor(){this.events=new $t,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(t){this._enabled=t}setMinimumGamepadConfiguration(t){this._enableAndUpdate(),this._minimumConfiguration=t}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(t){if(!this._minimumConfiguration)return!0;if(!t)return!1;const i=t.axes.filter(o=>typeof o!==void 0).length,n=t.buttons.filter(o=>typeof o!==void 0).length;return i>=this._minimumConfiguration.axis&&n>=this._minimumConfiguration.buttons&&t.connected}emit(t,i){this.events.emit(t,i)}on(t,i){return this._enableAndUpdate(),this.events.on(t,i)}once(t,i){return this._enableAndUpdate(),this.events.once(t,i)}off(t,i){this._enableAndUpdate(),this.events.off(t,i)}update(){var t,i;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const n=this._navigator.getGamepads();for(let o=0;o<n.length;o++){if(n[o]){const c=this.at(o);!this.at(o).connected&&this._isGamepadValid(n[o])&&(c.events.pipe(this.events),this.events.emit("connect",new hc(o,this.at(o)))),this.at(o).connected=!0}else{const c=this.at(o);c.connected&&(this.events.emit("disconnect",new lc(o,c)),c.events.unpipe(this.events)),c.connected=!1;continue}if(this.at(o).update(),n[o].timestamp&&n[o].timestamp===this._gamePadTimeStamps[o])continue;this._gamePadTimeStamps[o]=n[o].timestamp,this.at(o).navigatorGamepad=n[o];const h=n[o];if(h){for(let c=0;c<h.buttons.length;c++){const _=h.buttons[c],p=_?.value;p!==((t=this._oldPads[o])===null||t===void 0?void 0:t.getButton(c))&&(_?.pressed?(this.at(o).updateButton(c,p),this.at(o).events.emit("button",new cc(c in $r?c:$r.Unknown,c,p,this.at(o)))):this.at(o).updateButton(c,0))}for(let c=0;c<h.axes.length;c++){const _=h.axes[c];_!==((i=this._oldPads[o])===null||i===void 0?void 0:i.getAxes(c))&&(this.at(o).updateAxes(c,_),this.at(o).events.emit("axis",new dc(c,_,this.at(o))))}}this._oldPads[o]=this._clonePad(n[o])}}at(t){if(this._enableAndUpdate(),t>=this._pads.length)for(let i=this._pads.length-1,n=t;i<n;i++)this._pads.push(new ra),this._oldPads.push(new ra);return this._pads[t]}getValidGamepads(){this._enableAndUpdate();const t=[];for(let i=0;i<this._pads.length;i++)this._isGamepadValid(this.at(i).navigatorGamepad)&&this.at(i).connected&&t.push(this.at(i));return t}count(){return this._pads.filter(t=>t.connected).length}_clonePads(t){const i=[];for(let n=0,o=t.length;n<o;n++)i.push(this._clonePad(t[n]));return i}_clonePad(t){let i,n;const o=new ra;if(!t)return o;for(i=0,n=t.buttons.length;i<n;i++)t.buttons[i]&&o.updateButton(i,t.buttons[i].value);for(i=0,n=t.axes.length;i<n;i++)o.updateAxes(i,t.axes[i]);return o}}La.MinAxisMoveThreshold=.05;class ra{constructor(){this.events=new $t,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let t=0;t<this._buttons.length;t++)this._buttons[t]=0;for(let t=0;t<this._axes.length;t++)this._axes[t]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(t,i=1){return this._buttons[t]>=i}isButtonHeld(t,i=1){return this._buttons[t]>=i}wasButtonPressed(t,i=1){return this._buttonsDown[t]>=i}wasButtonReleased(t){return!!this._buttonsUp[t]}getButton(t){return this._buttons[t]}getAxes(t){const i=this._axes[t];return Math.abs(i)<La.MinAxisMoveThreshold?0:i}updateButton(t,i){i===0&&this._buttons[t]?this._buttonsUp[t]=1:this._buttonsDown[t]=i,this._buttons[t]=i}updateAxes(t,i){this._axes[t]=i}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}var $r;(function(d){d[d.Unknown=-1]="Unknown",d[d.Face1=0]="Face1",d[d.Face2=1]="Face2",d[d.Face3=2]="Face3",d[d.Face4=3]="Face4",d[d.LeftBumper=4]="LeftBumper",d[d.RightBumper=5]="RightBumper",d[d.LeftTrigger=6]="LeftTrigger",d[d.RightTrigger=7]="RightTrigger",d[d.Select=8]="Select",d[d.Start=9]="Start",d[d.LeftStick=10]="LeftStick",d[d.RightStick=11]="RightStick",d[d.DpadUp=12]="DpadUp",d[d.DpadDown=13]="DpadDown",d[d.DpadLeft=14]="DpadLeft",d[d.DpadRight=15]="DpadRight",d[d.CenterButton=16]="CenterButton",d[d.MiscButton1=17]="MiscButton1"})($r||($r={}));var Ul;(function(d){d[d.LeftStickX=0]="LeftStickX",d[d.LeftStickY=1]="LeftStickY",d[d.RightStickX=2]="RightStickX",d[d.RightStickY=3]="RightStickY"})(Ul||(Ul={}));class __{constructor(t){this.inputs=t,this._handlers=new Map}execute(){for(const[t,i]of this._handlers.entries()){const n=t(this.inputs);n&&i(n)}}on(t,i){this._handlers.set(t,i)}}function g_(){try{const d=()=>{};window.top.addEventListener("blur",d),window.top.removeEventListener("blur",d)}catch{return!0}return!1}var to;(function(d){d.Backquote="Backquote",d.Backslash="Backslash",d.BracketLeft="BracketLeft",d.BracketRight="BracketRight",d.Comma="Comma",d.Key0="Digit0",d.Key1="Digit1",d.Key2="Digit2",d.Key3="Digit3",d.Key4="Digit4",d.Key5="Digit5",d.Key6="Digit6",d.Key7="Digit7",d.Key8="Digit8",d.Key9="Digit9",d.Digit0="Digit0",d.Digit1="Digit1",d.Digit2="Digit2",d.Digit3="Digit3",d.Digit4="Digit4",d.Digit5="Digit5",d.Digit6="Digit6",d.Digit7="Digit7",d.Digit8="Digit8",d.Digit9="Digit9",d.Equal="Equal",d.IntlBackslash="IntlBackslash",d.IntlRo="IntlRo",d.IntlYen="IntlYen",d.A="KeyA",d.B="KeyB",d.C="KeyC",d.D="KeyD",d.E="KeyE",d.F="KeyF",d.G="KeyG",d.H="KeyH",d.I="KeyI",d.J="KeyJ",d.K="KeyK",d.L="KeyL",d.M="KeyM",d.N="KeyN",d.O="KeyO",d.P="KeyP",d.Q="KeyQ",d.R="KeyR",d.S="KeyS",d.T="KeyT",d.U="KeyU",d.V="KeyV",d.W="KeyW",d.X="KeyX",d.Y="KeyY",d.Z="KeyZ",d.KeyA="KeyA",d.KeyB="KeyB",d.KeyC="KeyC",d.KeyD="KeyD",d.KeyE="KeyE",d.KeyF="KeyF",d.KeyG="KeyG",d.KeyH="KeyH",d.KeyI="KeyI",d.KeyJ="KeyJ",d.KeyK="KeyK",d.KeyL="KeyL",d.KeyM="KeyM",d.KeyN="KeyN",d.KeyO="KeyO",d.KeyP="KeyP",d.KeyQ="KeyQ",d.KeyR="KeyR",d.KeyS="KeyS",d.KeyT="KeyT",d.KeyU="KeyU",d.KeyV="KeyV",d.KeyW="KeyW",d.KeyX="KeyX",d.KeyY="KeyY",d.KeyZ="KeyZ",d.Minus="Minus",d.Period="Period",d.Quote="Quote",d.Semicolon="Semicolon",d.Slash="Slash",d.AltLeft="AltLeft",d.AltRight="AltRight",d.Alt="Alt",d.AltGraph="AltGraph",d.Backspace="Backspace",d.CapsLock="CapsLock",d.ContextMenu="ContextMenu",d.ControlLeft="ControlLeft",d.ControlRight="ControlRight",d.Enter="Enter",d.MetaLeft="MetaLeft",d.MetaRight="MetaRight",d.ShiftLeft="ShiftLeft",d.ShiftRight="ShiftRight",d.Space="Space",d.Tab="Tab",d.Convert="Convert",d.KanaMode="KanaMode",d.NonConvert="NonConvert",d.Delete="Delete",d.End="End",d.Help="Help",d.Home="Home",d.Insert="Insert",d.PageDown="PageDown",d.PageUp="PageUp",d.Up="ArrowUp",d.Down="ArrowDown",d.Left="ArrowLeft",d.Right="ArrowRight",d.ArrowUp="ArrowUp",d.ArrowDown="ArrowDown",d.ArrowLeft="ArrowLeft",d.ArrowRight="ArrowRight",d.NumLock="NumLock",d.Numpad0="Numpad0",d.Numpad1="Numpad1",d.Numpad2="Numpad2",d.Numpad3="Numpad3",d.Numpad4="Numpad4",d.Numpad5="Numpad5",d.Numpad6="Numpad6",d.Numpad7="Numpad7",d.Numpad8="Numpad8",d.Numpad9="Numpad9",d.Num0="Numpad0",d.Num1="Numpad1",d.Num2="Numpad2",d.Num3="Numpad3",d.Num4="Numpad4",d.Num5="Numpad5",d.Num6="Numpad6",d.Num7="Numpad7",d.Num8="Numpad8",d.Num9="Numpad9",d.NumAdd="NumpadAdd",d.NumpadAdd="NumpadAdd",d.NumDecimal="NumpadDecimal",d.NumpadDecimal="NumpadDecimal",d.NumDivide="NumpadDivide",d.NumpadDivide="NumpadDivide",d.NumEnter="NumpadEnter",d.NumpadEnter="NumpadEnter",d.NumMultiply="NumpadMultiply",d.NumpadMultiply="NumpadMultiply",d.NumSubtract="NumpadSubtract",d.NumpadSubtract="NumpadSubtract",d.Esc="Escape",d.Escape="Escape",d.F1="F1",d.F2="F2",d.F3="F3",d.F4="F4",d.F5="F5",d.F6="F6",d.F7="F7",d.F8="F8",d.F9="F9",d.F10="F10",d.F11="F11",d.F12="F12",d.F13="F13",d.F14="F14",d.F15="F15",d.F16="F16",d.F17="F17",d.F18="F18",d.F19="F19",d.F20="F20",d.PrintScreen="PrintScreen",d.ScrollLock="ScrollLock",d.Pause="Pause",d.Unidentified="Unidentified"})(to||(to={}));class Wr extends wt{constructor(t,i,n){super(),this.key=t,this.value=i,this.originalEvent=n}}class p_{constructor(){this.events=new $t,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=t=>{for(const i of this._keys){const n=new Wr(i,t.key,t);this.events.emit("up",n),this.events.emit("release",n)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=t=>{if(!this._enabled)return;!t.metaKey&&(this._keys.includes(to.MetaLeft)||this._keys.includes(to.MetaRight))&&this._releaseAllKeys(t);const i=t.code;if(this._keys.indexOf(i)===-1){this._keys.push(i),this._keysDown.push(i);const n=new Wr(i,t.key,t);this.events.emit("down",n),this.events.emit("press",n)}},this._handleKeyUp=t=>{if(!this._enabled)return;const i=t.code,n=this._keys.indexOf(i);this._keys.splice(n,1),this._keysUp.push(i);const o=new Wr(i,t.key,t);this.events.emit("up",o),this.events.emit("release",o),t.key==="Meta"&&this._releaseAllKeys(t)}}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}init(t){let{global:i}=t;const{grabWindowFocus:n}=t;i||(g_()?(i=window,n&&window.focus(),dt.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):i=window.top),i.addEventListener("blur",()=>{this._keys.length=0}),i.addEventListener("keyup",this._handleKeyUp),i.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(t){this._enabled=t}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let t=0;t<this._keys.length;t++)this.events.emit("hold",new Wr(this._keys[t]))}getKeys(){return this._keys}wasPressed(t){return this._enabled?this._keysDown.indexOf(t)>-1:!1}isHeld(t){return this._enabled?this._keys.indexOf(t)>-1:!1}wasReleased(t){return this._enabled?this._keysUp.indexOf(t)>-1:!1}triggerEvent(t,i,n){t==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:i,key:n??null})),t==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:i,key:n??null}))}}class sr{static fromPagePosition(t,i,n){let o,h,c,_;arguments.length===3?(o=t,h=i,c=new k(o,h),_=n):(c=t,o=c.x,h=c.y,_=i);const p=_.screen.pageToScreenCoordinates(c),v=_.screen.screenToWorldCoordinates(p);return new sr(v,c,p)}constructor(t,i,n){this.worldPos=t,this.pagePos=i,this.screenPos=n}}class Nr{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(t,i,n,o,h,c){this.type=t,this.pointerId=i,this.button=n,this.pointerType=o,this.coordinates=h,this.nativeEvent=c,this.active=!0}}class m_{cancel(){this.active=!1}constructor(t,i,n,o,h,c,_,p,v,x,b,S){this.x=t,this.y=i,this.pageX=n,this.pageY=o,this.screenX=h,this.screenY=c,this.index=_,this.deltaX=p,this.deltaY=v,this.deltaZ=x,this.deltaMode=b,this.ev=S,this.active=!0}}class zl{constructor(){this.events=new $t,this.lastPagePos=k.Zero,this.lastScreenPos=k.Zero,this.lastWorldPos=k.Zero,this._onPointerMove=t=>{this.lastPagePos=new k(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new k(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new k(t.worldPos.x,t.worldPos.y)},this._onPointerDown=t=>{this.lastPagePos=new k(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new k(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new k(t.worldPos.x,t.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_updateWorldPosition(t){const i=sr.fromPagePosition(this.lastPagePos,t);this.lastScreenPos=i.screenPos,this.lastWorldPos=i.worldPos}}var tr;(function(d){d.Pixel="Pixel",d.Line="Line",d.Page="Page"})(tr||(tr={}));var qs;(function(d){d[d.NoButton=-1]="NoButton",d[d.Left=0]="Left",d[d.Middle=1]="Middle",d[d.Right=2]="Right",d[d.Unknown=3]="Unknown"})(qs||(qs={}));var ws;(function(d){d.Left="Left",d.Middle="Middle",d.Right="Right",d.Unknown="Unknown",d.NoButton="NoButton"})(ws||(ws={}));var xs;(function(d){d.Touch="Touch",d.Mouse="Mouse",d.Pen="Pen",d.Unknown="Unknown"})(xs||(xs={}));function zv(d){return globalThis.TouchEvent&&d instanceof globalThis.TouchEvent}function Hv(d){return globalThis.PointerEvent&&d instanceof globalThis.PointerEvent}class Ua{constructor(t,i){this.target=t,this.engine=i,this.events=new $t,this.primary=new zl,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(t){this._enabled=t}recreate(t,i){const n=new Ua(t,i);return n.primary=this.primary,n._pointers=this._pointers,n}at(t){if(t>=this._pointers.length)for(let i=this._pointers.length-1,n=t;i<n;i++)this._pointers.push(new zl);return this._pointers[t]}count(){return this._pointers.length}isDown(t){var i;return this._enabled&&(i=this.currentFramePointerDown.get(t))!==null&&i!==void 0?i:!1}wasDown(t){var i;return this._enabled&&(i=this.lastFramePointerDown.get(t))!==null&&i!==void 0?i:!1}isDragging(t){return this._enabled?this.isDown(t):!1}isDragStart(t){return this._enabled?this.isDown(t)&&!this.wasDown(t):!1}isDragEnd(t){return this._enabled?!this.isDown(t)&&this.wasDown(t):!1}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const t of this.currentFrameDown){if(!t.active)continue;this.emit("down",t),this.at(t.pointerId).emit("down",t),this.primary.emit("pointerdown",t)}for(const t of this.currentFrameUp){if(!t.active)continue;this.emit("up",t),this.at(t.pointerId).emit("up",t)}for(const t of this.currentFrameMove){if(!t.active)continue;this.emit("move",t),this.at(t.pointerId).emit("move",t)}for(const t of this.currentFrameCancel){if(!t.active)continue;this.emit("cancel",t),this.at(t.pointerId).emit("cancel",t)}for(const t of this.currentFrameWheel)t.active&&(this.emit("pointerwheel",t),this.emit("wheel",t),this.primary.emit("pointerwheel",t),this.primary.emit("wheel",t));if(this.engine.currentScene.camera.hasChanged())for(const t of this._pointers)t._updateWorldPosition(this.engine)}clear(){for(const t of this.currentFrameUp){this.currentFramePointerCoords.delete(t.pointerId);const i=this._activeNativePointerIdsToNormalized.entries();for(const[n,o]of i)o===t.pointerId&&this._activeNativePointerIdsToNormalized.delete(n)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(t){var i;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const n={passive:!(this.engine.pageScrollPreventionMode===Zs.All||this.engine.pageScrollPreventionMode===Zs.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,n):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,n):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,n),((i=t?.grabWindowFocus)!==null&&i!==void 0?i:!0)&&g_()){const h=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",h):(this.target.addEventListener("touchstart",h),this.target.addEventListener("mousedown",h))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(t){this._activeNativePointerIdsToNormalized.set(t,-1);const n=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((o,h)=>o-h).findIndex(o=>o===t);return this._activeNativePointerIdsToNormalized.set(t,n),n}_handle(t){if(!this._enabled)return;t.preventDefault();const i=new Map;let n,o;if(zv(t)){n=ws.Unknown,o=xs.Touch;for(let h=0;h<t.changedTouches.length;h++){const c=t.changedTouches[h],_=sr.fromPagePosition(c.pageX,c.pageY,this.engine),p=h+1,v=this._normalizePointerId(p);this.currentFramePointerCoords.set(v,_),i.set(v,_)}}else{n=this._nativeButtonToPointerButton(t.button),o=xs.Mouse;const h=sr.fromPagePosition(t.pageX,t.pageY,this.engine);let c=1;Hv(t)&&(c=t.pointerId,o=this._stringToPointerType(t.pointerType));const _=this._normalizePointerId(c);this.currentFramePointerCoords.set(_,h),i.set(_,h)}for(const[h,c]of i.entries())switch(t.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new Nr("down",h,n,o,c,t)),this.currentFramePointerDown.set(h,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new Nr("up",h,n,o,c,t)),this.currentFramePointerDown.set(h,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new Nr("move",h,n,o,c,t));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new Nr("cancel",h,n,o,c,t));break}}_handleWheel(t){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Zs.All||this.engine.pageScrollPreventionMode===Zs.Canvas&&t.target===this.engine.canvas)&&t.preventDefault();const i=this.engine.screen.pageToScreenCoordinates(G(t.pageX,t.pageY)),n=this.engine.screen.screenToWorldCoordinates(i),o=-1/40,h=t.deltaX||t.wheelDeltaX*o||0,c=t.deltaY||t.wheelDeltaY*o||t.wheelDelta*o||t.detail||0,_=t.deltaZ||0;let p=tr.Pixel;t.deltaMode&&(t.deltaMode===1?p=tr.Line:t.deltaMode===2&&(p=tr.Page));const v=new m_(n.x,n.y,t.pageX,t.pageY,i.x,i.y,0,h,c,_,p,t);this.currentFrameWheel.push(v)}triggerEvent(t,i){const n=this.engine.screen.worldToPageCoordinates(i);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+t,{pointerId:0,clientX:n.x,clientY:n.y})):this._handle(new window.MouseEvent("mouse"+t,{clientX:n.x,clientY:n.y}));const o=this.engine.currentScene.world.get(ka);o.preupdate(this.engine.currentScene,1),o.update(1)}_nativeButtonToPointerButton(t){switch(t){case qs.NoButton:return ws.NoButton;case qs.Left:return ws.Left;case qs.Middle:return ws.Middle;case qs.Right:return ws.Right;case qs.Unknown:return ws.Unknown;default:return nf(t)}}_stringToPointerType(t){switch(t){case"touch":return xs.Touch;case"mouse":return xs.Mouse;case"pen":return xs.Pen;default:return xs.Unknown}}}class Oc{constructor(t){this._enabled=!0;const{pointerTarget:i,grabWindowFocus:n,engine:o}=t;this.keyboard=new p_,this.pointers=new Ua(i,o),this.gamepads=new La,this.keyboard.init({grabWindowFocus:n}),this.pointers.init({grabWindowFocus:n}),this.gamepads.init(),this.inputMapper=new __({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(t){this._enabled=t,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class Ov{}const Wv={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function Ji(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class wi{get actors(){return this.world.entityManager.entities.filter(t=>t instanceof ti)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(t=>t instanceof r_)}get tileMaps(){return this.world.entityManager.entities.filter(t=>t instanceof Qf)}get timers(){return this._timers}constructor(){this._logger=dt.getInstance(),this.events=new $t,this.camera=new n_,this.world=new c_(this),this.physics=new f_(Es()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(Uc),this.world.add(new Ma(this.world,this.physics)),this.world.add(new Ba(this.world,this.physics)),this.world.add(ka),this.world.add(zc),this.world.add(Hc),this.world.add(Mc),this.world.add(Bc)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}onPreLoad(t){}onTransition(t){}onInitialize(t){}onActivate(t){}onDeactivate(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreDraw(t,i){}onPostDraw(t,i){}_initializeChildren(){for(const t of this.entities)t._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(t){var i;if(!this.isInitialized){try{this.engine=t,this.physics.config=this.engine.physics,this.input=new Oc({pointerTarget:t.pointerScope===Dn.Canvas?t.canvas:document,grabWindowFocus:t.grabWindowFocus,engine:t}),this.camera._initialize(t),this.world.systemManager.initialize(),await this.onInitialize(t),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,t),this.events.emit("initialize",new _r(t,this))}catch(n){throw this._logger.error(`Error during scene initialization for scene ${(i=t.director)===null||i===void 0?void 0:i.getSceneName(this)}!`),n}this._isInitialized=!0}}async _activate(t){var i,n;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(t)}catch(o){throw this._logger.error(`Error during scene activation for scene ${(n=(i=this.engine)===null||i===void 0?void 0:i.director)===null||n===void 0?void 0:n.getSceneName(this)}!`),o}}async _deactivate(t){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(t)}_preupdate(t,i){this.emit("preupdate",new Ks(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.emit("postupdate",new $s(t,i,this)),this.onPostUpdate(t,i)}_predraw(t,i){this.emit("predraw",new ur(t,i,this)),this.onPreDraw(t,i)}_postdraw(t,i){this.emit("postdraw",new fr(t,i,this)),this.onPostDraw(t,i)}update(t,i){var n;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(n=t.director)===null||n===void 0?void 0:n.getSceneName(this)}!`);return}this._preupdate(t,i);let o,h;for(o=0,h=this._cancelQueue.length;o<h;o++)this.removeTimer(this._cancelQueue[o]);this._cancelQueue.length=0;for(const c of this._timers)c.update(i);this.world.update(pi.Update,i),this.camera&&this.camera.update(t,i),this._collectActorStats(t),this._postupdate(t,i),this.input.update()}draw(t,i){var n;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(t,i),this.world.update(pi.Draw,i),!((n=this.engine)===null||n===void 0)&&n.isDebug&&this.debugDraw(t),this._postdraw(t,i)}debugDraw(t){this.emit("predebugdraw",new nc(t,this)),this.emit("postdebugdraw",new rc(t,this))}contains(t){return this.actors.indexOf(t)>-1}add(t){if(this.emit("entityadded",{target:t}),t instanceof En){sf(this._timers,t)||this.addTimer(t);return}this.world.add(t),t.scene=this}transfer(t){let i;t instanceof qe&&t.scene&&t.scene!==this&&(i=t.scene,t.scene.world.remove(t,!1)),t instanceof En&&t.scene&&(i=t.scene,t.scene.removeTimer(t)),i?.emit("entityremoved",{target:t}),this.add(t)}remove(t){this.emit("entityremoved",{target:t}),t instanceof qe&&(t.isActive&&t.kill(),this.world.remove(t)),t instanceof En&&this.removeTimer(t)}clear(t=!0){for(let i=this.entities.length-1;i>=0;i--)this.world.remove(this.entities[i],t);for(let i=this.timers.length-1;i>=0;i--)this.removeTimer(this.timers[i])}addTimer(t){return this._timers.push(t),t.scene=this,t}removeTimer(t){const i=this._timers.indexOf(t);return i!==-1&&this._timers.splice(i,1),t}cancelTimer(t){return this._cancelQueue.push(t),t}isTimerActive(t){return this._timers.indexOf(t)>-1&&!t.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(t){const i=this.actors;for(let n=0;n<i.length;n++){const o=i[n];o instanceof Dc&&t.stats.currFrame.actors.ui++,t.stats.currFrame.actors.alive++;for(let h=0;h<o.children.length;h++){const c=o.children[h];Zf(c)?t.stats.currFrame.actors.ui++:t.stats.currFrame.actors.alive++}}}}var In;(function(d){d.Protanope="Protanope",d.Deuteranope="Deuteranope",d.Tritanope="Tritanope"})(In||(In={}));const Nv=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class v_{constructor(t,i){this._shader=new hi({gl:t,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:i}),this._shader.compile(),this._buffer=new rs({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Fs({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class w_{constructor(t,i=!1){this._colorBlindnessMode=t,this._simulate=!1,this._simulate=i}initialize(t){this._shader=new v_(t,Nv),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(t){if(this._colorBlindnessMode=t,this._shader){const i=this._shader.getShader();i.use(),this._colorBlindnessMode===In.Protanope?i.setUniformInt("u_type",0):this._colorBlindnessMode===In.Deuteranope?i.setUniformInt("u_type",1):this._colorBlindnessMode===In.Tritanope&&i.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(t){if(this._simulate=t,this._shader){const i=this._shader.getShader();i.use(),i.setUniformBoolean("u_simulate",t)}}get simulate(){return this._simulate}}class x_{constructor(t){this._engine=t,this._colorBlindPostProcessor=new w_(In.Protanope)}correct(t){this._engine.graphicsContext instanceof Ts&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(t){this._engine.graphicsContext instanceof Ts&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class b_{constructor(t){this.stats={currFrame:new eo,prevFrame:new eo},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:K.Yellow,showZIndex:!1,showScale:!1,scaleColor:K.Green,showRotation:!1,rotationColor:K.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:K.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:K.Blue,showOwner:!1,showGeometry:!0,geometryColor:K.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:K.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:K.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:K.Yellow,showAcceleration:!1,accelerationColor:K.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:K.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:K.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:K.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:K.Yellow,positionSize:1,showGrid:!1,gridColor:K.Red,gridWidth:1,showColliderGeometry:!0},this._engine=t,this.colorBlindMode=new x_(this._engine)}useTestClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const n=t.toTestClock();return i&&n.start(),this._engine.clock=n,n}useStandardClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const n=t.toStandardClock();return i&&n.start(),this._engine.clock=n,n}}class eo{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new za,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(t){t?(this.id=t.id,this.elapsedMs=t.elapsedMs,this.fps=t.fps,this.actors.alive=t.actors.alive,this.actors.killed=t.actors.killed,this.actors.ui=t.actors.ui,this.duration.update=t.duration.update,this.duration.draw=t.duration.draw,this._physicsStats.reset(t.physics),this.graphics.drawCalls=t.graphics.drawCalls,this.graphics.drawnImages=t.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const t=new eo;return t.reset(this),t}get id(){return this._id}set id(t){this._id=t}get elapsedMs(){return this._elapsedMs}set elapsedMs(t){this._elapsedMs=t}get fps(){return this._fps}set fps(t){this._fps=t}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class za{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(t){t?(this.pairs=t.pairs,this.collisions=t.collisions,this.contacts=t.contacts,this.fastBodies=t.fastBodies,this.fastBodyCollisions=t.fastBodyCollisions,this.broadphase=t.broadphase,this.narrowphase=t.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const t=new za;return t.reset(this),t}get pairs(){return this._pairs}set pairs(t){this._pairs=t}get collisions(){return this._collisions}set collisions(t){this._collisions=t}get contacts(){return this._contacts}set contacts(t){this._contacts=t}get fastBodies(){return this._fastBodies}set fastBodies(t){this._fastBodies=t}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(t){this._fastBodyCollisions=t}get broadphase(){return this._broadphase}set broadphase(t){this._broadphase=t}get narrowphase(){return this._narrowphase}set narrowphase(t){this._narrowphase=t}}class Hl{on(t,i){this._nativeHandlers[t]&&this.off(t,this._nativeHandlers[t]),this._nativeHandlers[t]=this._decorate(i),this.nativeComponent.addEventListener(t,this._nativeHandlers[t])}off(t,i){i||(i=this._nativeHandlers[t]),this.nativeComponent.removeEventListener(t,i),this._nativeHandlers[t]=null}_decorate(t){return i=>{this._paused||t(i)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const t in this._nativeHandlers)this.off(t)}constructor(t){this.nativeComponent=t,this._paused=!1,this._nativeHandlers={}}}class y_{constructor(t,i){this._windowGlobal=t,this._documentGlobal=i,this._windowComponent=new Hl(this._windowGlobal),this._documentComponent=new Hl(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const A_={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:we.Blended,canvasImageRendering:"auto"},C_={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:we.Blended,canvasImageRendering:"auto"};class S_{constructor(t){var i;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=t.initialFps,this._samplePeriod=(i=t.samplePeriod)!==null&&i!==void 0?i:this._samplePeriod,this._currentFrameTime=1e3/t.initialFps,this._nowFn=t.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const t=this._nowFn();this._currentFrameTime=t-this._beginFrameTime,t>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(t-this._previousSampleTime),this._previousSampleTime=t,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class Wc{constructor(t){var i,n,o;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=t,this.tick=t.tick,this._lastTime=(i=this.now())!==null&&i!==void 0?i:0,this._maxFps=(n=t.maxFps)!==null&&n!==void 0?n:this._maxFps,this._onFatalException=(o=t.onFatalException)!==null&&o!==void 0?o:this._onFatalException,this.fpsSampler=new S_({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new P_({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new Nc({...this._options})}setFatalExceptionHandler(t){this._onFatalException=t}schedule(t,i=0,n="preframe"){const o=this._totalElapsed+i;this._scheduledCbs.push([t,o,n])}__runScheduledCbs(t="preframe"){for(let i=this._scheduledCbs.length-1;i>-1;i--)t===this._scheduledCbs[i][2]&&this._scheduledCbs[i][1]<=this._totalElapsed&&(this._scheduledCbs[i][0](this._elapsed),this._scheduledCbs.splice(i,1))}update(t){try{this.fpsSampler.start();const i=this.now();let n=i-this._lastTime||1;const o=1e3/this._maxFps;if(n>=o){let h=0;o!==0&&(h=n%o,n=n-h),n>200&&(n=1),this._elapsed=t||n,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(t||n),this.__runScheduledCbs("postframe"),o!==0?this._lastTime=i-h:this._lastTime=i,this.fpsSampler.end()}}catch(i){this._onFatalException(i),this.stop()}}}class Nc extends Wc{constructor(t){super(t),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const t=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(t),this.update()}catch(i){throw window.cancelAnimationFrame(this._requestId),i}};t()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class P_ extends Wc{constructor(t){super({...t}),this._logger=dt.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=t.defaultUpdateMs}now(){var t;return(t=this._currentTime)!==null&&t!==void 0?t:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(t){const i=t??this._updateMs;this._running?(this.update(i),this._currentTime+=i):this._logger.warn("The clock is not running, no step will be performed")}run(t,i){for(let n=0;n<t;n++)this.step(i??this._updateMs)}}var Gv=Ie(296);class T_{constructor(){this._toasterCss=Gv.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(t){const i=document.createElement("span");return i.innerText=t,i}toast(t,i,n){this._initialize();const o=document.createElement("div");o.className="ex-toast-message";const h=t.split("[LINK]").map(x=>this._createFragment(x));if(i){const x=document.createElement("a");x.href=i,n?x.innerText=n:x.innerText=i,h.splice(1,0,x)}const c=document.createElement("div");h.forEach(x=>{c.appendChild(x)}),o.appendChild(c);const _=document.createElement("button");_.innerText="x",_.addEventListener("click",()=>{this._container.removeChild(o)}),o.appendChild(_);const p=x=>{if(x.key==="Escape")try{this._container.removeChild(o)}catch{}document.removeEventListener("keydown",p)};document.addEventListener("keydown",p);const v=this._container.firstChild;this._container.insertBefore(o,v)}}const Vv={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class E_{get isTransitioning(){return this._isTransitioning}constructor(t,i){this._engine=t,this.events=new $t,this._logger=dt.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new wi,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const n in i){const o=i[n];this.add(n,o),n==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const t=this._deferredGoto;this._deferredGoto=void 0;const i=this._deferredTransition;this._deferredTransition=void 0;const n=this.getSceneInstance(t);n&&i&&i._addToTargetScene(this._engine,n),await this.swapScene(t),n&&i&&await this.playTransition(i,n)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(t,i){const n=i?.loader;n instanceof jr?this.mainLoader=n:El(n)?this.mainLoader=new n:this.mainLoader=new kn;let o;if(i?.inTransition){const{inTransition:h}=i;o=h}if(this.startScene=t,o){const h=this.getSceneInstance(this.startScene);h&&(o._addToTargetScene(this._engine,h),this.swapScene(this.startScene).then(()=>this.playTransition(o,h)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(t){return this._sceneToLoader.get(t)}_getInTransition(t){var i;const n=this.scenes[t];if(!(n instanceof wi||Ji(n)))return(i=n?.transitions)===null||i===void 0?void 0:i.in}_getOutTransition(t){var i;const n=this.scenes[t];if(!(n instanceof wi||Ji(n)))return(i=n?.transitions)===null||i===void 0?void 0:i.out}getDeferredScene(){const t=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&t?t:null}getSceneDefinition(t){const i=this.scenes[t];if(i instanceof wi||Ji(i))return i;if(i)return i.scene}getSceneName(t){for(const[i,n]of Object.entries(this.scenes))if(n instanceof wi){if(t===n)return i}else if(!Ji(n)&&t===n.scene)return i;for(const[i,n]of Object.entries(this.scenes))if(Ji(n)){if(t.constructor===n)return i}else if(!(n instanceof wi)&&t.constructor===n.scene)return i;return null}assertAdded(t){return this}assertRemoved(t){return this}add(t,i){if(!(i instanceof wi)&&!Ji(i)){const{loader:n,transitions:o}=i,{in:h,out:c}=o??{};this._sceneToTransition.set(t,{in:h,out:c}),El(n)?this._sceneToLoader.set(t,new n):n&&this._sceneToLoader.set(t,n)}return this.scenes[t]&&this._logger.warn("Scene",t,"already exists overwriting"),this.scenes[t]=i,this.assertAdded(t)}remove(t){if(t instanceof wi||Ji(t)){const i=t;for(const n in this.scenes)if(this.scenes.hasOwnProperty(n)){const o=this.scenes[n];let h;if(o instanceof wi||Ji(o)?h=o:h=o.scene,h===i){if(n===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${n}`);this._sceneToInstance.delete(n),this._sceneToTransition.delete(n),this._sceneToLoader.delete(n),delete this.scenes[n]}}}if(typeof t=="string"){if(t===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${t}`);this._sceneToInstance.delete(t),this._sceneToTransition.delete(t),this._sceneToLoader.delete(t),delete this.scenes[t]}}async goToScene(t,i){var n,o,h,c,_,p;const v=this.getSceneInstance(t);if(!v){this._logger.warn(`Scene ${t} does not exist! Check the name, are you sure you added it?`);return}const x=this.currentScene,b=this.currentSceneName,S=(o=(n=this._engine.input)===null||n===void 0?void 0:n.enabled)!==null&&o!==void 0?o:!0;this._isTransitioning=!0;const P=(h=this.getSceneInstance(b))===null||h===void 0?void 0:h.onTransition("out"),I=v?.onTransition("in");i={sourceOut:(c=this._getOutTransition(this.currentSceneName))!==null&&c!==void 0?c:P,destinationIn:(_=this._getInTransition(t))!==null&&_!==void 0?_:I,...i};const{sourceOut:M,destinationIn:R,sceneActivationData:T}=i,F=M??this._getOutTransition(this.currentSceneName),W=R??this._getInTransition(t),U=F?.hideLoader||W?.hideLoader;U&&this.maybeLoadScene(t,U),this._emitEvent("navigationstart",b,t),F&&await this.playTransition(F,x),await this.maybeLoadScene(t,U),W&&await W.onPreviousSceneDeactivate(this.currentScene),W&&W._addToTargetScene(this._engine,v),await this.swapScene(t,T),this._emitEvent("navigation",b,t),W&&await this.playTransition(W,v),this._emitEvent("navigationend",b,t),(p=this._engine.input)===null||p===void 0||p.toggleEnabled(S),this._isTransitioning=!1}getSceneInstance(t){const i=this.getSceneDefinition(t);if(!i)return;if(this._sceneToInstance.has(t))return this._sceneToInstance.get(t);if(i instanceof wi)return this._sceneToInstance.set(t,i),i;const n=new i;return this._sceneToInstance.set(t,n),n}async maybeLoadScene(t,i=!1){var n;const o=(n=this._getLoader(t))!==null&&n!==void 0?n:new jr,h=this.getSceneDefinition(t),c=this.getSceneInstance(t);h&&c&&!this._loadedScenes.has(c)&&(c.onPreLoad(o),c.events.emit("preload",{loader:o}),i?this._engine.load(o,i):await this._engine.load(o),this._loadedScenes.add(c))}async playTransition(t,i){var n,o,h,c,_,p,v;if(!this.isInitialized){this._deferredTransition=t;return}if(t){this.currentTransition=t;const x=(o=(n=i.input)===null||n===void 0?void 0:n.enabled)!==null&&o!==void 0?o:!0;(h=i.input)===null||h===void 0||h.toggleEnabled(!t.blockInput),(c=this._engine.input)===null||c===void 0||c.toggleEnabled(!t.blockInput),this.currentTransition._addToTargetScene(this._engine,i),await this.currentTransition._play(),(_=i.input)===null||_===void 0||_.toggleEnabled(x)}(p=this.currentTransition)===null||p===void 0||p.kill(),(v=this.currentTransition)===null||v===void 0||v.reset(),this.currentTransition=void 0}async swapScene(t,i){const n=this._engine;if(!this.isInitialized){this._deferredGoto=t;return}const o=this.getSceneInstance(t);if(o){const h=this.currentScene,c=o;if(this._logger.debug("Going to scene:",t),this.currentScene.isInitialized){const v={engine:n,previousScene:h,nextScene:c};await this.currentScene._deactivate(v),this.currentScene.events.emit("deactivate",new gc(v,this.currentScene)),this.currentScene.input.clear()}const _=this._sceneToLoader.get(t);await _?.areResourcesLoaded(),this.currentScene=c,this.currentSceneName=t,n.screen.setCurrentCamera(c.camera),await this.currentScene._initialize(n);const p={engine:n,previousScene:h,nextScene:c,data:i};await this.currentScene._activate(p),this.currentScene.events.emit("activate",new _c(p,this.currentScene))}else this._logger.error("Scene",t,"does not exist!")}_emitEvent(t,i,n){const o=this.getSceneDefinition(i),h=this.getSceneDefinition(n);this.events.emit(t,{sourceScene:o,sourceName:i,destinationScene:h,destinationName:n})}}function I_(){const d={scope:(t,i)=>{const n=d.value;d.value=t;try{return i()}catch(o){throw o}finally{d.value=n}},value:void 0};return d}function R_(d){return d.value}const Ol={textureCollectInterval:6e4};class D_{constructor(t){this.options=t,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=i=>{if(this._running){for(const[n,[o,h]]of this._collectors.entries()){const c=this.options.getTimestamp();for(const[_,[p,v]]of this._collectionMap.entries()){if(n!==p||v+h>=c)continue;o(_)&&this._collectionMap.delete(_)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(t,i,n){this._collectors.set(t,[n,i])}addCollectableResource(t,i){this._collectionMap.set(i,[t,this.options.getTimestamp()])}touch(t){const i=this._collectionMap.get(t);i&&this._collectionMap.set(t,[i[0],this.options.getTimestamp()])}forceCollectAll(){for(const[t,[i]]of this._collectors.entries())for(const[n]of this._collectionMap.entries())i(n)&&this._collectionMap.delete(n)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}Ku();const Xv={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Zs;(function(d){d[d.None=0]="None",d[d.Canvas=1]="Canvas",d[d.All=2]="All"})(Zs||(Zs={}));class ni{static useEngine(){const t=R_(ni.Context);if(!t)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return t}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(t){this.graphicsContext.snapToPixel=t}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,n,o,h,c,_,p,v,x;this.scope=U=>ni.Context.scope(this,U),this.version=Wl,this.events=new $t,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=U=>{dt.getInstance().fatal(U,U.stack)},this._toaster=new T_,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=U=>{var V;U.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",U);const j=document.createElement("div");j.id="ex-webgl-graphics-context-lost",j.style.position="absolute",j.style.zIndex="99",j.style.left="50%",j.style.top="50%",j.style.display="flex",j.style.flexDirection="column",j.style.transform="translate(-50%, -50%)",j.style.backgroundColor="white",j.style.padding="10px",j.style.borderStyle="solid 1px";const X=document.createElement("div");if(X.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,j.appendChild(X),!((V=this.canvas)===null||V===void 0)&&V.parentElement){this.canvas.parentElement.appendChild(j);const rt=X.querySelector("#ex-webgl-graphics-reload");rt?.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new bi,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],t={...ni._DEFAULT_ENGINE_OPTIONS,...t},this._originalOptions=t,Me.freeze(),this.browser=new y_(window,document);const b=new vf;if(!t.suppressMinimumBrowserFeatureDetection&&!(this._compatible=b.test())){const U=document.createElement("div");if(U.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(U),b.failedTests.forEach(function(V){const j=document.createElement("div");j.innerText="Browser feature missing "+V,document.body.appendChild(j)}),t.canvasElementId){const V=document.getElementById(t.canvasElementId);V&&V.parentElement.removeChild(V)}return}else this._compatible=!0;if(console.log&&!t.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${Wl})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),t.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=dt.getInstance(),this._logger.defaultLevel===xe.Debug&&b.logBrowserFeatures(),this._logger.debug("Building engine..."),t.garbageCollection===!0?this.garbageCollectorConfig={...Ol}:t.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...Ol,...t.garbageCollection},this._garbageCollector=new D_({getTimestamp:Date.now}),this.canvasElementId=t.canvasElementId,t.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+t.canvasElementId),document.getElementById(t.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(t.canvasElementId)}else t.canvasElement?(this._logger.debug("Using Canvas element specified:",t.canvasElement),this.canvas=t.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!t.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",U=>{U.preventDefault()});let S=(i=t.displayMode)!==null&&i!==void 0?i:Pe.Fixed;t.width&&t.height||t.viewport?(t.displayMode===void 0&&(S=Pe.Fixed),this._logger.debug("Engine viewport is size "+t.width+" x "+t.height)):t.displayMode||(this._logger.debug("Engine viewport is fit"),S=Pe.FitScreen),this.grabWindowFocus=t.grabWindowFocus,this.pointerScope=t.pointerScope,this._originalDisplayMode=S;let P,I,M,R,T,F;typeof t.antialiasing=="object"?{pixelArtSampler:P,nativeContextAntialiasing:M,multiSampleAntialiasing:F,filtering:T,canvasImageRendering:R}={...t.pixelArt?C_:A_,...t.antialiasing}:(P=!!t.pixelArt,M=!1,F=t.antialiasing,R=t.antialiasing?"auto":"pixelated",T=t.antialiasing?we.Blended:we.Pixel),M&&F&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),t.pixelArt&&(I=.25),(!t.antialiasing||T===we.Pixel)&&(I=0),I=(o=(n=t.uvPadding)!==null&&n!==void 0?n:I)!==null&&o!==void 0?o:.01;let W=Me.isEnabled("use-canvas-context");if(!W)try{this.graphicsContext=new Ts({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:P,antialiasing:M,multiSampleAntialiasing:F,uvPadding:I,powerPreference:t.powerPreference,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(h=t.handleContextLost)!==null&&h!==void 0?h:this._handleWebGLContextLost,handleContextRestored:t.handleContextRestored})}catch(U){this._logger.warn(`Excalibur could not load webgl for some reason (${U.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),W=!0}W&&(this.graphicsContext=new va({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:M,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting})),this.screen=new Tl({canvas:this.canvas,context:this.graphicsContext,antialiasing:M,canvasImageRendering:R,browser:this.browser,viewport:(c=t.viewport)!==null&&c!==void 0?c:t.width&&t.height?{width:t.width,height:t.height}:Pl.SVGA,resolution:t.resolution,displayMode:S,pixelRatio:t.suppressHiDPIScaling?1:(_=t.pixelRatio)!==null&&_!==void 0?_:null}),ne.filtering=T,t.backgroundColor&&(this.backgroundColor=t.backgroundColor.clone()),this.maxFps=(p=t.maxFps)!==null&&p!==void 0?p:this.maxFps,this.fixedUpdateTimestep=(v=t.fixedUpdateTimestep)!==null&&v!==void 0?v:this.fixedUpdateTimestep,this.fixedUpdateFps=(x=t.fixedUpdateFps)!==null&&x!==void 0?x:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new Nc({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:U=>this.onFatalException(U)}),this.enableCanvasTransparency=t.enableCanvasTransparency,typeof t.physics=="boolean"?this.physics={...Es(),enabled:t.physics}:(this.physics={...Es()},aa(this.physics,t.physics)),this.debug=new b_(this),this.director=new E_(this,t.scenes),this._initialize(t),window.___EXCALIBUR_DEVTOOL=this,ni.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:t}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:i,showPlayerMessage:n}=this._originalOptions.configurePerformanceCanvas2DFallback;if(i===void 0&&(i=ni._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),n===void 0&&(n=ni._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!Me.isEnabled("use-canvas-context")&&t&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===i.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let o=0;for(let c=0;c<this._fpsSamples.length;c++)o+=this._fpsSamples[c];const h=o/this._fpsSamples.length;this._fpsSamples.length===i.numberOfFrames&&h<=i.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),n&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var t,i,n;const o=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(o,this.canvas),this.canvas=o;const h={...this._originalOptions,antialiasing:this.screen.antialiasing},c=this._originalDisplayMode;this.graphicsContext=new va({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:h.antialiasing,backgroundColor:h.backgroundColor,snapToPixel:h.snapToPixel,useDrawSorting:h.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new Tl({canvas:this.canvas,context:this.graphicsContext,antialiasing:(t=h.antialiasing)!==null&&t!==void 0?t:!0,browser:this.browser,viewport:(i=h.viewport)!==null&&i!==void 0?i:h.width&&h.height?{width:h.width,height:h.height}:Pl.SVGA,resolution:h.resolution,displayMode:c,pixelRatio:h.suppressHiDPIScaling?1:(n=h.pixelRatio)!==null&&n!==void 0?n:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const _=h&&h.pointerScope===Dn.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(_,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,ni.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(t){if(t<0){dt.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=t}addTimer(t){return this.currentScene.addTimer(t)}removeTimer(t){return this.currentScene.removeTimer(t)}addScene(t,i){return this.director.add(t,i),this}removeScene(t){this.director.remove(t)}add(t){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const i=this.director.getDeferredScene();i instanceof wi?i.add(t):this.currentScene.add(t)}remove(t){t instanceof qe&&this.currentScene.remove(t),(t instanceof wi||Ji(t))&&this.removeScene(t),typeof t=="string"&&this.removeScene(t)}async goToScene(t,i){await this.scope(async()=>{await this.director.goToScene(t,i)})}screenToWorldCoordinates(t){return this.screen.screenToWorldCoordinates(t)}worldToScreenCoordinates(t){return this.screen.worldToScreenCoordinates(t)}_initialize(t){var i,n;this.pageScrollPreventionMode=t.scrollPreventionMode;const o=t&&t.pointerScope===Dn.Document?document:this.canvas,h=(n=(i=this._originalOptions)===null||i===void 0?void 0:i.grabWindowFocus)!==null&&n!==void 0?n:!0;this.input=new Oc({pointerTarget:o,grabWindowFocus:h,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new fc(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new uc(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!t.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(t){this._inputEnabled=t,this.input.toggleEnabled(this._inputEnabled)}onInitialize(t){}get isInitialized(){return this._isInitialized}async _overrideInitialize(t){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(t),this.events.emit("initialize",new _r(t,this)),this._isInitialized=!0)}_update(t){var i;if(this._isLoading){(i=this._loader)===null||i===void 0||i.onUpdate(this,t),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(t),this.currentScene.update(this,t),this.graphicsContext.updatePostProcessors(t),this.clock.__runScheduledCbs("postupdate"),this._postupdate(t),this.input.update()}_preupdate(t){this.emit("preupdate",new Ks(this,t,this)),this.onPreUpdate(this,t)}onPreUpdate(t,i){}_postupdate(t){this.emit("postupdate",new $s(this,t,this)),this.onPostUpdate(this,t)}onPostUpdate(t,i){}_draw(t){var i,n;if(this.graphicsContext.backgroundColor=(i=this.currentScene.backgroundColor)!==null&&i!==void 0?i:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,t),this._isLoading){this._hideLoader||((n=this._loader)===null||n===void 0||n.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,t),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,t),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(t,i){this.emit("predraw",new ur(t,i,this)),this.onPreDraw(t,i)}onPreDraw(t,i){}_postdraw(t,i){this.emit("postdraw",new fr(t,i,this)),this.onPostDraw(t,i)}onPostDraw(t,i){}showDebug(t){this._isDebug=t}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(t,i){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let n;return t instanceof jr?n=t:typeof t=="string"&&(this.director.configureStart(t,i),n=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(n??new kn),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new tc(this)),this._isReadyFuture.promise})}_mainloop(t){this.scope(()=>{this.emit("preframe",new oc(this,this.stats.prevFrame));const i=t*this.timescale;this.currentFrameElapsedMs=i;const n=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=n,this.stats.currFrame.elapsedMs=i,this.stats.currFrame.fps=this.clock.fpsSampler.fps,Kt.clear();const o=this.clock.now(),h=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=i;this._lagMs>=h;)this._update(h),this._lagMs-=h;else this._update(i);const c=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(i);const _=this.clock.now();this.stats.currFrame.duration.update=c-o,this.stats.currFrame.duration.draw=_-c,this.stats.currFrame.graphics.drawnImages=Kt.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=Kt.DrawCallCount,this.emit("postframe",new ac(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new ec(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(t=!1){return new Promise(n=>{this._screenShotRequests.push({preserveHiDPIResolution:t,resolve:n})})}_checkForScreenShots(){for(const t of this._screenShotRequests){const i=t.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,n=t.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,o=document.createElement("canvas");o.width=i,o.height=n;const h=o.getContext("2d");h.imageSmoothingEnabled=this.screen.antialiasing,h.drawImage(this.canvas,0,0,i,n);const c=new Image,_=o.toDataURL("image/png");c.onload=()=>{t.resolve(c)},c.src=_}this._screenShotRequests.length=0}async load(t,i=!1){await this.scope(async()=>{try{if(t.isLoaded())return;this._loader=t,this._isLoading=!0,this._hideLoader=i,t instanceof kn&&(t.suppressPlayButton=t.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await t.load()}catch(n){this._logger.error("Error loading resources, things may not behave properly",n),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}ni.Context=I_();ni.InstanceCount=0;ni._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:Dn.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Zs.Canvas,backgroundColor:K.fromHex("#2185d0")};class qv extends ti{set maxWidth(t){this._text.maxWidth=t}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(t){this._font=t,this._text.font=t}get text(){return this._text.text}set text(t){this._text.text=t}get color(){return this._text.color}set color(t){this._text&&(this._text.color=t)}get opacity(){return this.graphics.opacity}set opacity(t){this.graphics.opacity=t}get spriteFont(){return this._spriteFont}set spriteFont(t){t&&(this._spriteFont=t,this._text.font=this._spriteFont)}constructor(t){super(t),this._font=new Fn,this._text=new oo({text:"",font:this._font});const{text:i,pos:n,x:o,y:h,spriteFont:c,font:_,color:p,maxWidth:v}={text:"",...t};this.pos=n??(o&&h?G(o,h):this.pos),this.text=i??this.text,this.font=_??this.font,this.maxWidth=v??this.maxWidth,this.spriteFont=c??this.spriteFont,this._text.color=p??this.color;const x=this.get(ae);x.anchor=k.Zero,x.use(this._text)}_initialize(t){super._initialize(t)}getTextWidth(){return this._text.width}}var Qs;(function(d){d.Circle="circle",d.Rectangle="rectangle"})(Qs||(Qs={}));class Yv extends ti{constructor(t){var i,n;super({width:(i=t.width)!==null&&i!==void 0?i:0,height:(n=t.height)!==null&&n!==void 0?n:0}),this._particlesToEmit=0,this._particlePool=new io(()=>new Ta({}),I=>I,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=Qs.Rectangle,this.radius=0,this.particle={life:2e3,transform:Oi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:o,x:h,y:c,z:_,pos:p,isEmitting:v,emitRate:x,emitterType:b,radius:S,random:P}={...t};this.particle={...this.particle,...o},this.pos=p??G(h??0,c??0),this.z=_??0,this.isEmitting=v??this.isEmitting,this.emitRate=x??this.emitRate,this.emitterType=b??this.emitterType,this.radius=S??this.radius,this.body.collisionType=ft.PreventCollision,this.random=P??new hr}removeParticle(t){this.deadParticles.push(t)}emitParticles(t){var i;if(!(t<=0)){t=t|0;for(let n=0;n<t;n++){const o=this._createParticle();!((i=this===null||this===void 0?void 0:this.scene)===null||i===void 0)&&i.world&&(this.particle.transform===Oi.Global?this.scene.world.add(o):this.addChild(o)),this._activeParticles.push(o)}}}clearParticles(){for(let t=0;t<this._activeParticles.length;t++)this.removeParticle(this._activeParticles[t])}_createParticle(){let t=0,i=0;const n=ts(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),o=ts(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),h=this.particle.startSize||ts(this.particle.minSize||5,this.particle.maxSize||5,this.random),c=o*Math.cos(n),_=o*Math.sin(n);if(this.emitterType===Qs.Rectangle)t=ts(0,this.width,this.random),i=ts(0,this.height,this.random);else if(this.emitterType===Qs.Circle){const v=ts(0,this.radius,this.random);t=v*Math.cos(n),i=v*Math.sin(n)}const p=this._particlePool.rent();return p.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:G(t,i),vel:G(c,_),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:h,graphic:this.particle.graphic,fade:this.particle.fade}),p.registerEmitter(this),this.particle.randomRotation&&(p.transform.rotation=ts(0,Math.PI*2,this.random)),this.particle.focus&&(p.focus=this.particle.focus.add(G(this.pos.x,this.pos.y)),p.focusAccel=this.particle.focusAccel),p}update(t,i){var n;super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let o=0;o<this.deadParticles.length;o++){!((n=this===null||this===void 0?void 0:this.scene)===null||n===void 0)&&n.world&&(this.scene.world.remove(this.deadParticles[o],!1),this._particlePool.return(this.deadParticles[o]));const h=this._activeParticles.indexOf(this.deadParticles[o]);h>-1&&this._activeParticles.splice(h,1)}this.deadParticles.length=0}}function jv(d,t){}class ba{constructor(t,i,n){var o;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=t,this.particle=n,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=i,this._particleLife=(o=this.particle.life)!==null&&o!==void 0?o:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(t,i){if(this._initialized)return;const n=this.emitter.maxParticles,o=this._numInputFloats,h=this._particleData,c=4,_=t.createBuffer(),p=t.createVertexArray();t.bindVertexArray(p),t.bindBuffer(t.ARRAY_BUFFER,_),t.bufferData(t.ARRAY_BUFFER,n*o*c,t.DYNAMIC_DRAW),t.bufferSubData(t.ARRAY_BUFFER,0,h);let v=0;t.vertexAttribPointer(0,2,t.FLOAT,!1,o*c,0),v+=c*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*c,v),v+=c*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*c,v),v+=c*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(p),this._buffers.push(_),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null);const x=t.createBuffer(),b=t.createVertexArray();t.bindVertexArray(b),t.bindBuffer(t.ARRAY_BUFFER,x),t.bufferData(t.ARRAY_BUFFER,n*o*c,t.DYNAMIC_DRAW),v=0,t.vertexAttribPointer(0,2,t.FLOAT,!1,o*c,0),v+=c*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*c,v),v+=c*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*c,v),v+=c*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(b),this._buffers.push(x),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(t){const i=this._particleIndex,n=this.maxParticles*this._numInputFloats,o=t*this._numInputFloats+i;for(let h=i;h<o;h+=this._numInputFloats){const c=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||be),_=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),p=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),v=_*Math.cos(c),x=p*Math.sin(c);let b=0,S=0;if(this.emitter.emitterType===Qs.Rectangle)b=this._random.floating(-.5,.5)*this.emitter.width,S=this._random.floating(-.5,.5)*this.emitter.height;else{const M=this._random.floating(0,this.emitter.radius);b=M*Math.cos(c),S=M*Math.sin(c)}const P=this.emitter.transform.apply(G(b,S)),I=[this.particle.transform===Oi.Local?b:P.x,this.particle.transform===Oi.Local?S:P.y,v,x,this.particle.randomRotation?ts(0,be,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(I,h%this._particleData.length)}o>=n?(this._wrappedParticles+=(o-n)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=t),this._particleIndex=o%n,this._emitted.push([this._particleLife,i])}_uploadEmitted(t){this._particleIndex!==this._uploadIndex&&(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),t.bindBuffer(t.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(t){var i;if(this._particleLife=(i=this.particle.life)!==null&&i!==void 0?i:this._particleLife,this._wrappedLife>0?this._wrappedLife-=t:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let n=this._emitted.length-1;n>=0;n--){const o=this._emitted[n];o[0]-=t,o[0]<=0&&this._emitted.splice(n,1)}this._emitted.sort((n,o)=>n[0]-o[0])}}draw(t){if(this._initialized){if(this._clearRequested?(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData),t.bindBuffer(t.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(t),t.bindVertexArray(this._currentVao),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const i=this._emitted[0][1]/this._numInputFloats;t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-i)*this._numInputFloats*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,i,this.maxParticles-i),t.endTransformFeedback(),t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,i),t.endTransformFeedback()}else t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,this.maxParticles),t.endTransformFeedback();t.bindVertexArray(null),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}ba.GPU_MAX_PARTICLES=1e5;class Zv extends ti{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get z(){return this.transform.z}set z(t){this.transform.z=t}constructor(t){super({name:"GpuParticleEmitter",width:t.width,height:t.height}),this.particle={life:2e3,transform:Oi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new ae,this.isEmitting=!1,this.emitRate=1,this.emitterType=Qs.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:i,maxParticles:n,x:o,y:h,z:c,pos:_,isEmitting:p,emitRate:v,emitterType:x,radius:b,random:S}={...t};this.maxParticles=At(n??this.maxParticles,0,ba.GPU_MAX_PARTICLES),this.pos=_??G(o??0,h??0),this.z=c??0,this.isEmitting=p??this.isEmitting,this.emitRate=v??this.emitRate,this.emitterType=x??this.emitterType,this.radius=b??this.radius,this.particle={...this.particle,...i},this.random=S??new hr,this.renderer=new ba(this,this.random,this.particle)}_initialize(t){super._initialize(t);const i=t.graphicsContext;this.renderer.initialize(i.__gl,i)}update(t,i){super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(i)}emitParticles(t){t<=0||this.renderer.emitParticles(t|0)}clearParticles(){this.renderer.clearParticles()}draw(t,i){t.draw("ex.particle",this.renderer,i)}}class F_ extends qe{getGraphics(){return this._graphics}addGraphic(t,i){this._graphics.push(t),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,i?.offset&&(this._gfx.offset=i.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let t=this._tileBounds.clone();for(const i of this._graphics){const n=G(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:i.height-this.map.tileHeight));t=t.combine(i.localBounds.translate(n))}return t}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&this._graphics.splice(i,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(G(this.x,this.y))}get center(){return this.pos.add(G(0,this.map.tileHeight/2))}constructor(t,i,n,o){super([new st,new ae({offset:n??k.Zero,onPostDraw:(S,P)=>this.draw(S,P)}),new Kr(o)]),this.solid=!1,this.events=new $t,this._tileBounds=new ct,this._graphics=[],this._colliders=[],this.data=new Map,this.x=t,this.y=i,this.map=o,this._transform=this.get(st),this._isometricEntityComponent=this.get(Kr);const h=this.map.tileWidth/2,c=this.map.tileHeight/2,_=(this.x-this.y)*h,p=(this.x+this.y)*c;this._transform.pos=G(_,p),this._isometricEntityComponent.elevation=o.elevation,this._gfx=this.get(ae),this._gfx.isVisible=!1;const v=this.map.tileWidth,x=this.map.tileHeight,b=G(0,this.map.renderFromTopOfGraphic?x:0);this._gfx.localBounds=this._tileBounds=new ct({left:-v/2,top:-x,right:v/2,bottom:x}).translate(b)}draw(t,i){const n=this.map.tileWidth/2;t.save(),t.translate(-n,0);for(const o of this._graphics)o.draw(t,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:o.height-this.map.tileHeight));t.restore()}}class Qv extends qe{get visible(){return this.isVisible}set visible(t){this.isVisible=t}constructor(t){super([new st,new Pt({type:ft.Fixed}),new ve,new Js,new Fa((x,b)=>this.debug(x,b),!1)],t.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=G(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:i,tileWidth:n,tileHeight:o,columns:h,rows:c,renderFromTopOfGraphic:_,graphicsOffset:p,elevation:v}=t;this.transform=this.get(st),i&&(this.transform.pos=i),this.collider=this.get(ve),this.collider&&this.collider.set(this._composite=new Ee([])),this.pointer=this.get(Js),this.renderFromTopOfGraphic=_??this.renderFromTopOfGraphic,this.graphicsOffset=p??this.graphicsOffset,this.elevation=v??this.elevation,this.tileWidth=n,this.tileHeight=o,this.columns=h,this.rows=c,this._pointerEventDispatcher=new Fc,this.tiles=new Array(h*c);for(let x=0;x<c;x++)for(let b=0;b<h;b++){const S=new F_(b,x,this.graphicsOffset,this);this.tiles[b+x*h]=S,this.addChild(S),this._pointerEventDispatcher.addObject(S,P=>this.getTileByPoint(P.worldPos)===S,()=>!0)}this.pointer.localBounds=ct.fromDimension(n*h*this.transform.scale.x,o*c*this.transform.scale.y,G(.5,0))}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:k.Zero;{const n=t.offset;return this._originalOffsets.set(t,n),n}}updateColliders(){this._composite.clearColliders();const t=this.get(st).pos;for(const i of this.tiles)if(i.solid)for(const n of i.getColliders()){const o=this._getOrSetColliderOriginalOffset(n);n.offset=this.tileToWorld(G(i.x,i.y)).sub(t).add(o).sub(G(this.tileWidth/2,this.tileHeight)),n.owner=this,this._composite.addCollider(n)}this.collider.update()}worldToTile(t){t=t.sub(this.transform.globalPos);const i=this.tileWidth/2,n=this.tileHeight/2;return G(~~((t.x/i+t.y/n)/2),~~((t.y/n-t.x/i)/2))}tileToWorld(t){const i=this.tileWidth/2,n=this.tileHeight/2,o=(t.x-t.y)*i,h=(t.x+t.y)*n;return G(o,h).add(this.transform.pos)}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const i=this.worldToTile(t);return this.getTile(i.x,i.y)}_getMaxZIndex(){let t=Number.NEGATIVE_INFINITY;for(const i of this.tiles){const n=i.get(st).z;n>t&&(t=n)}return t}debug(t,i){const{showAll:n,showPosition:o,positionColor:h,positionSize:c,showGrid:_,gridColor:p,gridWidth:v,showColliderGeometry:x}=i.isometric,{geometryColor:b,geometryLineWidth:S,geometryPointSize:P}=i.collider;if(t.save(),t.z=this._getMaxZIndex()+.5,n||_){for(let I=0;I<this.rows+1;I++){const M=this.tileToWorld(G(0,I)),R=this.tileToWorld(G(this.columns,I));t.drawLine(M,R,p,v)}for(let I=0;I<this.columns+1;I++){const M=this.tileToWorld(G(I,0)),R=this.tileToWorld(G(I,this.rows));t.drawLine(M,R,p,v)}}if(n||o)for(const I of this.tiles)t.drawCircle(this.tileToWorld(G(I.x,I.y)),c,h);if(n||x){for(const I of this.tiles)if(I.solid)for(const M of I.getColliders())M.debug(t,b,{lineWidth:S,pointSize:P})}t.restore()}}class Gc{constructor(t,i){this.id=Nt(),this._stopped=!1,this._sequenceBuilder=i,this._sequenceContext=new uo(t),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(t){this._actionQueue.update(t)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(t){return new Gc(t,this._sequenceBuilder)}}class Jv{constructor(t){this.id=Nt(),this._actions=t}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}isComplete(t){return this._actions.every(i=>i.isComplete(t))}reset(){this._actions.forEach(t=>t.reset())}stop(){this._actions.forEach(t=>t.stop())}}class Jn{constructor(t,i){this.bounds=t,this.options=i,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...i},this.halfWidth=t.width/2,this.halfHeight=t.height/2}_split(){this._isDivided=!0;const t={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new Jn(new ct({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),t),this.topRight=new Jn(new ct({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),t),this.bottomLeft=new Jn(new ct({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),t),this.bottomRight=new Jn(new ct({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),t)}_insertIntoSubNodes(t){var i,n,o,h;!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.insert(t),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.topRight.insert(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.insert(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.insert(t)}insert(t){if(this._isDivided){this._insertIntoSubNodes(t);return}if(this.items.push(t),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const i of this.items)this._insertIntoSubNodes(i);this.items.length=0}}remove(t){var i,n,o,h;if(this.bounds.overlaps(t.bounds)){if(!this._isDivided){const c=this.items.indexOf(t);c>-1&&this.items.splice(c,1);return}!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.remove(t),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.topRight.remove(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.remove(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.remove(t)}}query(t){let i=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(t)&&(i=i.concat(this.topLeft.query(t))),this.topRight.bounds.overlaps(t)&&(i=i.concat(this.topRight.query(t))),this.bottomLeft.bounds.overlaps(t)&&(i=i.concat(this.bottomLeft.query(t))),this.bottomRight.bounds.overlaps(t)&&(i=i.concat(this.bottomRight.query(t)))),i=i.filter((n,o)=>i.indexOf(n)>=o),i}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let t=this.items;return this._isDivided&&(t=t.concat(this.topLeft.getAllItems()),t=t.concat(this.topRight.getAllItems()),t=t.concat(this.bottomLeft.getAllItems()),t=t.concat(this.bottomRight.getAllItems())),t=t.filter((i,n)=>t.indexOf(i)>=n),t}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(t){this.bounds.draw(t,K.Yellow),this._isDivided&&(this.topLeft.bounds.draw(t,K.Yellow),this.topRight.bounds.draw(t,K.Yellow),this.bottomLeft.bounds.draw(t,K.Yellow),this.bottomRight.bounds.draw(t,K.Yellow))}}function Kv(d){return!!d._initialize}function $v(d){return!!d.onAdd}function tw(d){return!!d.onRemove}function ew(d){return!!d.onInitialize}function iw(d){return!!d._preupdate}function sw(d){return!!d.onPreUpdate}function nw(d){return!!d.onPostUpdate}function rw(d){return!!d.onPostUpdate}function ow(d){return!!d.onAdd}function aw(d){return!!d.onRemove}function hw(d){return!!d.onPreDraw}function lw(d){return!!d.onPostDraw}class cw{constructor(t,i=!1){this.path=t,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new so(t,"arraybuffer",i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){const t=await this._resource.load();this._stream=new M_(t),this._gif=new B_(this._stream);const i=this._gif.images.map(n=>new is(n.src,!1));return await Promise.all(i.map(n=>n.load())),this.data=this._images=i,this._sprites=this._images.map(n=>n.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(t=0){var i;return(i=this._sprites[t])!==null&&i!==void 0?i:null}toSpriteSheet(){const t=this._sprites;return t.length?new Pn({sprites:t}):null}toAnimation(t){var i;const n=(i=this._gif)===null||i===void 0?void 0:i.images;if(n?.length){const o=n.map((h,c)=>{var _;return{graphic:this._sprites[c],duration:((_=this._gif)===null||_===void 0?void 0:_.frames[c].delayMs)||void 0}});return this._animation=new ki({frames:o,frameDuration:t}),this._animation}return null}get readCheckBytes(){var t,i;return(i=(t=this._gif)===null||t===void 0?void 0:t.checkBytes)!==null&&i!==void 0?i:[]}}const ta=d=>d.reduce(function(t,i){return t*2+i},0),dl=d=>{const t=[];for(let i=7;i>=0;i--)t.push(!!(d&1<<i));return t};class M_{constructor(t){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=i=>{const n=[];for(let o=0;o<i;o++)n.push(this.readByte());return n},this.read=i=>{let n="";for(let o=0;o<i;o++)n+=String.fromCharCode(this.readByte());return n},this.readUnsigned=()=>{const i=this.readBytes(2);return(i[1]<<8)+i[0]},this.data=new Uint8Array(t),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const dw=function(d,t){let i=0;const n=function(S){let P=0;for(let I=0;I<S;I++)t.charCodeAt(i>>3)&1<<(i&7)&&(P|=1<<I),i++;return P},o=[],h=1<<d,c=h+1;let _=d+1,p=[];const v=function(){p=[],_=d+1;for(let S=0;S<h;S++)p[S]=[S];p[h]=[],p[c]=null};let x=0,b=0;for(;;){if(b=x,x=n(_),x===h){v();continue}if(x===c)break;if(x<p.length)b!==h&&p.push(p[b].concat(p[x][0]));else{if(x!==p.length)throw new Error("Invalid LZW code.");p.push(p[b].concat(p[b][0]))}o.push.apply(o,p[x]),p.length===1<<_&&_<12&&_++}return o};class B_{constructor(t){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=i=>{const n=[];for(let o=0;o<i;o++){const h=this._st.readBytes(3);n.push(h)}return n},this.readSubBlocks=()=>{let i,n;n="";do i=this._st.readByte(),n+=this._st.read(i);while(i!==0);return n},this.parseHeader=()=>{const i={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(i.sig=this._st.read(3),i.ver=this._st.read(3),i.sig!=="GIF")throw new Error("Not a GIF file.");i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned(),this._currentFrameCanvas.width=i.width,this._currentFrameCanvas.height=i.height;const n=dl(this._st.readByte());i.gctFlag=n.shift(),i.colorResolution=ta(n.splice(0,3)),i.sortedFlag=n.shift(),i.globalColorTableSize=ta(n.splice(0,3)),i.backgroundColorIndex=this._st.readByte(),i.pixelAspectRatio=this._st.readByte(),i.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<i.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(i)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=i=>{const n=p=>{this.checkBytes.push(this._st.readByte());const v=dl(this._st.readByte());return p.reserved=v.splice(0,3),p.disposalMethod=ta(v.splice(0,3)),p.userInputFlag=v.shift(),p.transparentColorFlag=v.shift(),p.delayTime=this._st.readUnsigned(),p.transparentColorIndex=this._st.readByte(),p.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(p)&&this.checkBytes.push(this._handler.gce),p},o=p=>{p.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(p)&&this.checkBytes.push(this._handler.com)},h=p=>{this.checkBytes.push(this._st.readByte()),p.ptHeader=this._st.readBytes(12),p.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(p)&&this.checkBytes.push(this._handler.pte)},c=p=>{const v=b=>{this.checkBytes.push(this._st.readByte()),b.unknown=this._st.readByte(),b.iterations=this._st.readUnsigned(),b.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(b)&&this.checkBytes.push(this._handler.app)},x=b=>{b.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[b.identifier]&&this._handler.app[b.identifier](b)&&this.checkBytes.push(this._handler.app[b.identifier])};switch(this.checkBytes.push(this._st.readByte()),p.identifier=this._st.read(8),p.authCode=this._st.read(3),p.identifier){case"NETSCAPE":v(p);break;default:x(p);break}},_=p=>{p.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(p)&&this.checkBytes.push(this._handler.unknown)};switch(i.label=this._st.readByte(),i.label){case 249:i.extType="gce",this._gce=n(i);break;case 254:i.extType="com",o(i);break;case 1:i.extType="pte",h(i);break;case 255:i.extType="app",c(i);break;default:i.extType="unknown",_(i);break}},this.parseImg=i=>{var n;const o=(_,p)=>{const v=new Array(_.length),x=_.length/p,b=(M,R)=>{const T=_.slice(R*p,(R+1)*p);v.splice.apply(v,[M*p,p].concat(T))},S=[0,4,2,1],P=[8,8,4,2];let I=0;for(let M=0;M<4;M++)for(let R=S[M];R<x;R+=P[M])b(R,I),I++;return v};i.leftPos=this._st.readUnsigned(),i.topPos=this._st.readUnsigned(),i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned();const h=dl(this._st.readByte());i.lctFlag=h.shift(),i.interlaced=h.shift(),i.sorted=h.shift(),i.reserved=h.splice(0,2),i.lctSize=ta(h.splice(0,3)),i.lctFlag&&(i.lctBytes=this.parseColorTableBytes(1<<i.lctSize+1)),i.lzwMinCodeSize=this._st.readByte();const c=this.readSubBlocks();i.pixels=dw(i.lzwMinCodeSize,c),i.interlaced&&(i.pixels=o(i.pixels,i.width)),!((n=this._gce)===null||n===void 0)&&n.delayTime&&(i.delayMs=this._gce.delayTime*10),this.frames.push(i),this.arrayToImage(i,i.lctFlag?i.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(i)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const i={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(i.sentinel)){case"!":i.type="ext",this.parseExt(i);break;case",":i.type="img",this.parseImg(i);break;case";":i.type="eof",this._handler.eof&&this._handler.eof(i)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+i.sentinel.toString(16))}i.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(i,n)=>{var o,h,c,_;const p=document.createElement("canvas");p.width=i.width,p.height=i.height;const v=p.getContext("2d"),x=v.getImageData(0,0,p.width,p.height);let b=-1;!((o=this._gce)===null||o===void 0)&&o.transparentColorFlag&&(b=this._gce.transparentColorIndex);for(let P=0;P<i.pixels.length;P++){const I=i.pixels[P],M=n[I];I===b?x.data.set([0,0,0,0],P*4):x.data.set([...M,255],P*4)}if(v.putImageData(x,0,0),((h=this._gce)===null||h===void 0?void 0:h.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((c=this._gce)===null||c===void 0?void 0:c.disposalMethod)===2&&(!((_=this._hdr)===null||_===void 0)&&_.gctFlag)){const P=n[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${P[0]}, ${P[1]}, ${P[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(p,i.leftPos,i.topPos,i.width,i.height);const S=new Image;S.src=this._currentFrameCanvas.toDataURL(),this.images.push(S)},this._st=t,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class uw{constructor(t,i,{bustCache:n,...o}={}){this.path=t,this.family=i,this._isLoaded=!1,this._resource=new so(t,"blob",n),this._options=o}async load(){if(this.isLoaded())return this.data;try{const t=await this._resource.load(),i=URL.createObjectURL(t);this.data||(this.data=new FontFace(this.family,`url(${i})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(t){throw`Error loading FontSource from path '${this.path}' with error [${t.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(t){return new Fn({family:this.family,...this._options,...t})}}const Xu=I_(),fw=/^\s*(?:function)?\*/;function qu(d){return typeof d!="function"?!1:fw.test(Function.prototype.toString.call(d))?!0:Object.getPrototypeOf?Object.getPrototypeOf(d)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function k_(...d){var t;const i=dt.getInstance();let n,o,h,c;qu(d[0])&&(o=globalThis,n=d[0],h=d[1]),qu(d[1])&&(o=d[0],n=d[1],h=d[2]),d[1]instanceof ni&&(o=d[0],c=d[1],n=d[2],h=d[3]),d[0]instanceof ni&&(o=globalThis,c=d[0],n=d[1],h=d[2]);const _=R_(Xu),p=h?.timing,v=_?!1:(t=h?.autostart)!==null&&t!==void 0?t:!0;let x;try{x=c??ni.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let b=!1,S=!1,P=!1;const I=n.bind(o),M=I();let R;const T=new Promise((W,U)=>{R=V=>{try{if(P){S=!0,W();return}const{done:j,value:X}=Xu.scope(!0,()=>M.next(V));if(j||P){S=!0,W();return}X instanceof Promise?X.then(()=>{x.clock.schedule(R,0,p)}):X===void 0||X===void 0?x.clock.schedule(R,0,p):x.clock.schedule(R,X||0,p)}catch(j){U(j);return}},v&&(b=!0,R(x.clock.elapsed()))}),F={isRunning:()=>b&&!P&&!S,isComplete:()=>S,cancel:()=>{P=!0},start:()=>(b?i.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(I)):(b=!0,R(x.clock.elapsed())),F),generator:M,done:T,then:T.then.bind(T),[Symbol.iterator]:()=>M};return F}class Ha extends qe{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(t){var i,n,o,h;super(),this._logger=dt.getInstance(),this.transform=new st,this.graphics=new ae,this._completeFuture=new bi,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=t.duration,this.easing=(i=t.easing)!==null&&i!==void 0?i:Xt.Linear,this.direction=(n=t.direction)!==null&&n!==void 0?n:"out",this.hideLoader=(o=t.hideLoader)!==null&&o!==void 0?o:!1,this.blockInput=(h=t.blockInput)!==null&&h!==void 0?h:!1,this.transform.coordPlane=ke.Screen,this.transform.pos=k.Zero,this.transform.z=1/0,this.graphics.anchor=k.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(t,i){this.complete||(this._currentDistance+=At(i/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=At(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=At(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(t){}onStart(t){}onUpdate(t){}onEnd(t){}onReset(){}reset(){this.started=!1,this._completeFuture=new bi,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(t,i){const n=i;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),n.world.entityManager.getById(this.id))return this._co;this._engine=t,n.add(this);const o=this;return this._co=k_(t,function*(){for(;!o.complete;){const h=yield;o.updateTransition(o._engine,h),o._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class _w extends Ha{constructor(t){var i,n;super({...t,duration:(i=t.duration)!==null&&i!==void 0?i:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(n=t.color)!==null&&n!==void 0?n:K.Black}onInitialize(t){this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=new ho({width:t.screen.resolution.width,height:t.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=t}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class gw extends Ha{constructor(t){super({direction:"in",...t}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(t){this.image=await t.engine.screenshot(!0),await this.image.decode()}onInitialize(t){this.engine=t,this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=is.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=G(1/t.screen.pixelRatio,1/t.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class pw extends Ha{constructor(t){var i;super({direction:"in",...t}),this._easing=Xt.Linear,this.name=`Slide#${this.id}`,this.slideDirection=t.slideDirection,this.transform.coordPlane=ke.World,this.graphics.forceOnScreen=!0,this._easing=(i=t.easingFunction)!==null&&i!==void 0?i:this._easing,this._vectorEasing=Xt.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(t){this._image=await t.engine.screenshot(!0),await this._image.decode(),this._screenCover=is.fromHtmlImageElement(this._image).toSprite()}onInitialize(t){switch(this._engine=t,this.slideDirection){case"up":{this._directionOffset=G(0,-t.screen.resolution.height);break}case"down":{this._directionOffset=G(0,t.screen.resolution.height);break}case"left":{this._directionOffset=G(-t.screen.resolution.width,0);break}case"right":{this._directionOffset=G(t.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=G(1/t.screen.pixelRatio,1/t.screen.pixelRatio)}onUpdate(t){this._camera.pos=this._vectorEasing(t,this._destinationCameraPosition,this._startCameraPosition,1)}}class Vc extends oe{constructor(t){super(),this.color=K.Black,this.thickness=1;const{start:i,end:n,color:o,thickness:h}=t;this.start=i,this.end=n,this.color=o??this.color,this.thickness=h??this.thickness,this._localBounds=this._calculateBounds();const{width:c,height:_}=this._localBounds;this.width=c,this.height=_}get localBounds(){return this._localBounds}_calculateBounds(){const t=this.end.sub(this.start).normal(),i=this.thickness/2,n=[this.start.add(t.scale(i)),this.end.add(t.scale(i)),this.end.add(t.scale(-i)),this.start.add(t.scale(-i))];return ct.fromPoints(n)}_drawImage(t,i,n){t.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new Vc({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class Xc extends dr{get points(){return this._points}set points(t){this._points=t;const i=this.minPoint;this.width=this._points.reduce((n,o)=>Math.max(o.x,n),0)-i.x,this.height=this._points.reduce((n,o)=>Math.max(o.y,n),0)-i.y,this.flagDirty()}get minPoint(){const t=this._points.reduce((n,o)=>Math.min(o.x,n),1/0),i=this._points.reduce((n,o)=>Math.min(o.y,n),1/0);return G(t,i)}constructor(t){super(t),this._points=[],this.points=t.points,this.filtering=we.Blended,this.rasterize()}clone(){return new Xc({points:this.points.map(t=>t.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){if(this.points&&this.points.length){t.beginPath();const i=this.minPoint.negate(),n=this.points[0].add(i);t.moveTo(n.x,n.y),this.points.forEach(o=>{t.lineTo(o.x+i.x,o.y+i.y)}),t.lineTo(n.x,n.y),t.closePath(),this.color&&t.fill(),this.strokeColor&&t.stroke()}}}var bs;(function(d){d.Stretch="stretch",d.Tile="tile",d.TileFit="tile-fit"})(bs||(bs={}));class qc extends oe{constructor(t){super(t),this._logger=dt.getInstance(),this._config=t,this._imgSource=t.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(t,i=!1){this._config.width=t,i&&this._initialize()}setTargetHeight(t,i=!1){this._config.height=t,i&&this._initialize()}setMargins(t,i,n,o,h=!1){this._config.sourceConfig.leftMargin=t,this._config.sourceConfig.topMargin=i,this._config.sourceConfig.rightMargin=n,this._config.sourceConfig.bottomMargin=o,h&&this._initialize()}setStretch(t,i,n=!1){t==="horizontal"?this._config.destinationConfig.horizontalStretch=i:t==="vertical"?this._config.destinationConfig.verticalStretch=i:(this._config.destinationConfig.horizontalStretch=i,this._config.destinationConfig.verticalStretch=i),n&&this._initialize()}getConfig(){return this._config}_drawTile(t,i,n,o,h,c,_){const p=c||0,v=_||0;let x,b,S,P;const I=this._getNumberOfTiles(i.width,n.x,o),M=this._getNumberOfTiles(i.height,n.y,h);for(let R=0;R<I;R++)for(let T=0;T<M;T++){let{tempSize:F,tempPosition:W}=this._calculateParams(R,I,i.width,n.x,this._config.destinationConfig.horizontalStretch);x=F,b=W,{tempSize:F,tempPosition:W}=this._calculateParams(T,M,i.height,n.y,this._config.destinationConfig.verticalStretch),S=F,P=W,t.drawImage(i,0,0,i.width,i.height,p+b,v+P,x,S)}}_drawImage(t,i,n){this._imgSource.isLoaded()?(this._drawTile(t,this._canvasA,new k(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(t,this._canvasB,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(t,this._canvasC,new k(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(t,this._canvasD,new k(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(t,this._canvasE,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasF,new k(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasG,new k(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasH,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasI,new k(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const t=this._canvasA.getContext("2d");t?.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const i=this._canvasB.getContext("2d");i?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const n=this._canvasC.getContext("2d");n?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const o=this._canvasD.getContext("2d");o?.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const h=this._canvasE.getContext("2d");h?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const c=this._canvasF.getContext("2d");c?.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const _=this._canvasG.getContext("2d");_?.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const p=this._canvasH.getContext("2d");p?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const v=this._canvasI.getContext("2d");v?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new qc(this._config)}_getNumberOfTiles(t,i,n){switch(n){case bs.Stretch:return 1;case bs.Tile:return Math.ceil(i/t);case bs.TileFit:return Math.ceil(i/t)}}_calculateParams(t,i,n,o,h){switch(h){case bs.Stretch:return{tempPosition:0,tempSize:o};case bs.Tile:return t===i-1?{tempPosition:t*n,tempSize:n-(i*n-o)}:{tempPosition:t*n,tempSize:n};case bs.TileFit:const c=o/i;return{tempPosition:t*c,tempSize:c}}}}class Yc extends ki{constructor(t){super({...t,frames:t.animation.frames.slice(),strategy:t.animation.strategy,frameDuration:t.animation.frameDuration,speed:t.animation.speed,reverse:t.animation.isReversed}),this._ready=new bi,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...t.sourceView},this._tiledWidth=t.width,this._tiledHeight=t.height;const i=[];for(let n=0;n<this.frames.length;n++){const o=this.frames[n].graphic;if(o&&o instanceof Ui){const h=new no({image:o.image,width:t.width,height:t.height,sourceView:{...o.sourceView},wrapping:t.wrapping,filtering:t.filtering});this.frames[n].graphic=h,h.ready.then(()=>{h.sourceView={...h.sourceView,...this._sourceView}}),i.push(h.ready)}}Promise.all(i).then(()=>this._ready.resolve())}static fromAnimation(t,i){return new Yc({width:t.width,height:t.height,...i,animation:t})}_updateSourceView(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof Ui&&(i.sourceView={...i.sourceView,...this._sourceView})}}get sourceView(){return Li(this._sourceView,()=>this._updateSourceView())}set sourceView(t){this._sourceView=Li(t,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof Ui&&(i.sourceView.height=this._tiledHeight||i.height,i.destSize.height=this._tiledHeight||i.height,i.sourceView.width=this._tiledWidth||i.width,i.destSize.width=this._tiledWidth||i.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(t){this._tiledWidth=t,this._updateWidthHeight()}set height(t){this._tiledHeight=t,this._updateWidthHeight()}}const L_=5,nr={},mw=()=>{for(const d in nr)nr[d]=0},ea=(d,t)=>{const i=Me.isEnabled("suppress-obsolete-message");nr[d]<L_&&!i&&(dt.getInstance().warn(d),console.trace&&t.showStackTrace&&console.trace()),nr[d]++};function vw(d){return d={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...d},function(t,i,n){if(n&&!(typeof n.value=="function"||typeof n.get=="function"||typeof n.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const h=`${`${t.name||""}${t.name&&i?".":""}${i||""}`} is marked obsolete: ${d.message}`+(d.alternateMethod?` Use ${d.alternateMethod} instead`:"");nr[h]||(nr[h]=0);const c=n?{...n}:t;if(!n){class _ extends c{constructor(...v){ea(h,d),super(...v)}}return _}return n&&n.value?(c.value=function(){return ea(h,d),n.value.apply(this,arguments)},c):(n&&n.get&&(c.get=function(){return ea(h,d),n.get.apply(this,arguments)}),n&&n.set&&(c.set=function(){return ea(h,d),n.set.apply(this,arguments)}),c)}}class ww{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const t=new bi;return this._queue.push(t),t.promise}dequeue(t){this._queue.shift().resolve(t)}}class xw{constructor(t){this._count=t,this._waitQueue=new ww}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(t=1){if(t!==0){for(;t!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),t--;this._count+=t}}}const Wl="0.30.3";Ku();C.eKr;C.yVm;C.a7j;C.U_w;C.JF2;C.htg;C.HXL;C.mcg;var Wi=C.Agj;C.J3_;C.Wgv;C.u6S;C.x7M;var Ue=C.X55;C.m3M;C.aE5;var ze=C.YJU;C.eZi;C.GNv;C.Y56;C._0v;C.vhs;C.vrQ;C.Z8b;C.Yfw;C.IcQ;C.kgJ;C.GTT;C.ypY;C.i7d;C.fQ3;C.HlI;var U_=C.jlt;C.VQc;C.zD7;C.AUF;C.JoF;C.MlA;C.PZh;C.qA;var Oa=C.CrD;C.dQK;C.D3r;C.Qpo;C.D9n;C.b6v;C.mvh;var en=C.Bpo,Wt=C.Q1f;C.IKv;C.fcV;C.Glf;var jc=C.uAl;C.ElT;C.Z8r;C.QSL;C.sPV;C.nAn;C.zCU;C.QrV;C.fF9;C.Jqv;C.d_u;C.xI8;C.yar;C.SP7;C.oRy;C.f5X;C.V1c;C.Mlx;C.ZiM;C.ZCo;C.J5p;C.mL_;C.Guw;C.N5j;C.pgY;C.OP3;C.rl5;C.eod;var bw=C.q5Z;C.YUC;C.saR;C.hvr;C.Qol;C.Wf4;var ya=C.JCs;C.gJV;C.fWD;C.Va_;var yw=C.N$8;C._jQ;C.rxj;C.rhv;C.wCu;C.HAp;C.Zy1;C.bkB;C.wfL;C.sVA;C.$Gs;C.CJ0;C.NWh;C.tWi;C.xAj;C.zWh;C.i_4;C.iIx;C.Hxo;var z_=C.c9e,ys=C.KQV;C.weH;C.jXp;C.zzY;C.yRQ;C.MtE;C.rPj;C.KLc;C.Fir;C.V5f;C.Xj7;C.Wud;C.FVg;C.g5Y;C.YQB;C.KPb;C.nHK;C.Jrb;C.TX_;C.Olt;C.r3n;C.Fvk;C.gpR;C.vYh;C.hnk;var Ys=C.D2R;C.n1o;C.h9O;C.X5j;C.p3P;C.RLG;C.fBU;C.Adb;var Ft=C.bEs;C.wCy;C.CbD;C.x_C;C.pGf;C.ibQ;C.shR;C.Yjk;var Aw=C._u1;C.OBI;C.klh;C.s3S;C.D$R;C.xth;var As=C.JU7;C.h9x;C.N1A;C.e_k;var Cw=C.aHM;C.tlv;C.Vi9;C.ieR;C.$bb;C.VyI;C.imn;C.uqu;C.QnL;C.vnc;var Sw=C.wk_;C.GH0;C._1r;C.l0X;C.bT;C.HHX;C.jtW;C.tjk;C.rWe;C.j9l;var Yu=C.l0$,ia=C.sGJ;C.NVp;C.cPK;C.XoL;C.RmF;C.DXI;C.tCD;C.J3D;C.vCJ;C.e6k;C.f9l;C.v9m;C.yRJ;C.EU6;C.m3O;C.Ryz;C.OxP;C.LEs;C.Ec;C.Pi5;C.gmH;C.tS;C.XxX;C.bCz;C.nYS;C.yiT;C.NHl;C.mO8;C.PXI;C.bn5;C.Ywr;C.cMd;C.Bs6;C.G0k;C.pyn;C.QeM;C.aPX;C.ITP;C.BY0;C.MFw;C.sBn;C.S3L;C.XKQ;C.ESI;C.uxz;var gr=C.o8N;C.u_r;C.RlV;C.gVA;var Vs=C.M_G;C.BpG;C.GRB;C.kM6;C.dO8;C.jgM;C.FWq;C.s3j;C.hlw;C.L0q;C.B7e;C.PGN;C.H_X;C.S_d;C._Tq;C.U7E;C.IOH;var H_=C.Z58;C.yh2;C.ff$;C.cWi;var xi=C.NBt;C.oNz;C.QlU;C.Xey;C.jft;C._r8;C.bTC;C.Mtr;var Pw=C.ypk;C.mnM;C.q7S;C.bAZ;C.ABN;C.VK6;C.Hj2;C.Df8;C.oOx;C.kxk;C.DT1;var li=C.FLG;C.qN_;C.Z37;C.FtL;C.Z6X;C.iQT;C.ziO;C.OEF;C.uuE;C.tiv;C.T$Y;C.EYj;var Cs=C.nOB;C.Tap;C.FAs;C.B_P;C.aA5;C.J3s;C.Y0Q;C.M4G;C.l$l;C.dLy;C.WZP;C.eB6;C.nFK;C.l9z;C.YOF;C.yhB;C.J0N;var yt=C.Miz;C.Bj4;C.Rcs;C.vJ4;C.TqC;C.nM0;C.X1u;C.SpZ;C.DX8;C.Yx$;C.HK4;C.yt5;C.vAR;C.SE$;C.qE8;C.Pz7;C.sX_;C.JuI;C.pxT;C.Nl$;C.zDr;C.OwT;C.P$G;C.mHV;C.kEA;C.Fx_;C.WFC;C.vKu;C.aDq;C.jIg;C.UH3;C.AJO;C.U4;C.xAc;C._3Y;C.K6X;C.C1Y;C.Aw1;C.tm8;C.LBV;C.A8$;C.F5e;C.ran;C.c8L;C.o6M;C.hsx;C.l9E;C.aSf;C.CcK;C.nU8;C.td6;C.Zex;C.bkJ;C.mXP;C.vt$;C.hCA;C.pjR;C.U43;C.pSZ;C.y17;C.Ew7;C.hG1;C.jVr;C._SZ;C.xWn;C.ehJ;var nt=C.t6s;C.Eyn;const Tw={App:void 0},Ew=`
<style> 
   canvas {
       user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -moz-user-select: none;

      -webkit-touch-callout: none; /* disables long-press context menu on iOS Safari */
   }
</style> 
<div \${==>App}> 
    <canvas id='cnv'> </canvas> 
</div>`;class O_ extends jc{config={updateInterval:100,moveTolerance:5,deadZone:10,maxDistance:100,autoRecenter:!0,recenterThreshold:90};upHandler;downHandler;moveHandler;cancelHandler;gestureStartPos=yt.Zero;currentPos=yt.Zero;moveDelta=yt.Zero;lastDirection={x:0,y:0};isActive=!1;isDown=!1;lastEvent=null;updateInterval=null;lastState="idle";onJoystickChange=null;onAdd(t){this.owner=t}init(t={},i){if(this.config={...this.config,...t},i&&(this.onJoystickChange=i),!this.owner)return;const n=this.owner.scene?.engine.input.pointers.primary;n&&(this.downHandler=n.on("down",o=>this.onDown(o)),this.moveHandler=n.on("move",o=>this.onMove(o)),this.upHandler=n.on("up",o=>this.onUp(o)),this.notifyJoystickChange("idle"))}onRemove(t){console.log("closing tc"),this.upHandler?.close(),this.downHandler?.close(),this.moveHandler?.close(),this.clearUpdateInterval()}onDown(t){console.log("tc pointerdown"),this.gestureStartPos=t.worldPos.clone(),this.currentPos=t.worldPos.clone(),this.moveDelta=yt.Zero,this.lastDirection={x:0,y:0},this.isActive=!0,this.isDown=!0,this.lastEvent=t,this.clearUpdateInterval(),this.updateInterval=window.setInterval(()=>{this.processJoystickState()},this.config.updateInterval)}onMove(t){if(this.isDown&&(this.currentPos=t.worldPos.clone(),this.moveDelta=this.currentPos.sub(this.gestureStartPos),this.lastEvent=t,this.config.autoRecenter&&this.lastState==="active")){const i=this.moveDelta.magnitude;if(i>=this.config.deadZone){const n={x:this.moveDelta.x/i,y:this.moveDelta.y/i};if(Math.abs(this.lastDirection.x)>.01||Math.abs(this.lastDirection.y)>.01){const o=this.lastDirection.x*n.x+this.lastDirection.y*n.y;if(Math.acos(Math.max(-1,Math.min(1,o)))*(180/Math.PI)>this.config.recenterThreshold){const c=Math.min(i,this.config.maxDistance/2),_=new yt(n.x*c,n.y*c);this.gestureStartPos=this.currentPos.sub(_),this.moveDelta=_,this.lastDirection=n}}}}}onUp(t){console.log("tc pointerup"),this.isDown&&(this.isDown=!1,this.isActive=!1,this.moveDelta=yt.Zero,this.lastDirection={x:0,y:0},this.lastEvent=null,this.clearUpdateInterval(),this.notifyJoystickChange("idle"))}clearUpdateInterval(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null)}processJoystickState(){if(!this.isDown||!this.isActive)return;const t=this.moveDelta.magnitude;let i="idle";t>=this.config.deadZone&&(i="active");const n=Math.min(t,this.config.maxDistance);let o={x:0,y:0};t>0&&(o={x:this.moveDelta.x/t,y:this.moveDelta.y/t},this.lastDirection=o),(i!==this.lastState||i==="active")&&this.notifyJoystickChange(i,o,n),this.lastState=i}notifyJoystickChange(t,i={x:0,y:0},n=0){this.onJoystickChange&&this.onJoystickChange({direction:i,distance:n,state:t,rawEvent:this.lastEvent||void 0})}getJoystickState(){const t=this.moveDelta.magnitude,i=this.isDown&&t>=this.config.deadZone?"active":"idle";let n={x:0,y:0};return t>0&&(n={x:this.moveDelta.x/t,y:this.moveDelta.y/t}),{direction:n,distance:Math.min(t,this.config.maxDistance),state:i,rawEvent:this.lastEvent||void 0}}drawJoystick(t){if(!this.isDown)return;const i=this.gestureStartPos.x,n=this.gestureStartPos.y,o=this.currentPos.x,h=this.currentPos.y;t.beginPath(),t.arc(i,n,this.config.maxDistance,0,Math.PI*2),t.strokeStyle="rgba(255,255,255,0.5)",t.lineWidth=2,t.stroke(),t.beginPath(),t.moveTo(i,n),t.lineTo(o,h),t.strokeStyle="rgba(255,255,255,0.7)",t.lineWidth=3,t.stroke(),t.beginPath(),t.arc(o,h,20,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.8)",t.fill()}update(t,i){}}const Zc=new Oa("weapons",4,2),Iw=new Oa("enemy",2,5),W_=new Oa("player",1,10),N_=new Oa("drops",8,1),Rw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEQAAAAiCAYAAADmvn/1AAAAAXNSR0IArs4c6QAAAcBJREFUaIHt2L1qAkEYheFjiiBJ4yXYx8LKOk0uIb21VcpAUlhEsEwl5A4C6cVKglWEYEydIoWCWwpRMNWkWNbiyMfszLc7AZm3W3cchodh/wBlnXHTNHvnRjuPtlG7ZbqXNfU6Kr5/7IybBgA+lysAwHaxAQDM77bec/o0arcMACx/03UsVz8AgO7r2msdzn9iCC4UDENwvjC5B9sguLJgbBCcK4x1kCsEVxSMKwSXF0Y8qYXgfGG0EJwN5uDHoiG4vDBFQ3ASzP6gbAhOgikbgmOYSmgILoPpf12kCwwEwWUwcYfwDuEB8RoiFO8yQvE5RCg+qQrFdxmhY33bVXds30NOtBMMa0+Ym552GnVn721U367U83hvq/psagAgmSUAgF3ynZ64vwm6VSeNgQGARfIBAFhs1gCA291LmA9EDMGFgmEIzhcm92AbBFcWjA2Cc4WxDnKF4IqCcYXg8sKIJ7UQnC+MFoKzwRz8WDQElxemaAhOgtkflA3BSTBlQ3AMUwkNwWUwk+fTdIGBILgMJu4Q3iE8IF5DhOJdRig+hwjFJ1Wh+C4jdKxvu+rqs6nBw+O/fyCaNAamX71Wr+MPZlhfhBfdpjwAAAAASUVORK5CYII=",Dw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAAFACAYAAADNkKWqAAAAAXNSR0IArs4c6QAABW5JREFUeJzt3TFOHVcYhuFj6daRV0AdF9mCN4BckM4VC3DhjjKFy/S0kVyliBQXkTfAFigcicZiBRYbuCmSQeFcxndm7pyZc+Z/nsaIBn7J36sLjE1KK7u6udxf3Vzu1/481hL9fljTi7U+cN/of339cbXPaUnR74caLD62oa92thqC6PdDTRYb2dQv87YSguj3Q42Kj2uu72+1GoLo90PNio2q1Df2WwlB9PuhBbOPaamfaNYaguj3Q0tmG9Faj3LUEoLo90OLTh5PLc+wrRWC6PdDyyaPppbh55YKQfT7YQtGj6XW4edKhSD6/bAlg0fSyvBzc4Ug+v2wRUfH0erwc1NDEP1+2LLeUWxl+LmhIYh+P0RwMIatDj/XF4Lo90MkjyOIMvxcF4Lo90NEu6uby/2PZy/T3/ff1v5cVvHb1/f7lFLY+yGy3d3tQ7q7fUhvzs9SChSCu9uHJ39GvR8i23Vv/PX5PqUAIegbfvT7IaJd/o6thmDo8KPfD5EcBLCzlRBMHX70+yGC3gB2Wg3BXMOPfj9s2dEAdloJQanhR78ftujxGbCL64tRz8HVFoKpw//07tOL5H4I6eAvf2shmHv40e+HSHpHUHsISg8/+v0QwdEx1BaCpYcf/X7YssGjWDsEaw8/+v2wRaPHsXQIaht+9PthSyaPpHQIah9+9PthC04ey9whaG340e+Hls02mlND0Prwo98PLZp9PGNDMFWtwx9z/5vzs8d/YTJWrfdDS4qNqFQIWxn+kPunBLCV+6EFxcc0VwhbHf737h8TwFbvh5otNqqpIdzK8J+7f0gAt3I/1GjxcQ0N4VaH///7vxfArd4PNVltZH0hjDL8i+uL/XMBjHI/kFK6/HCzv/xwE/JXUqb/QrjUT86Bp1Z7tdEXvY+/vPYKCFjE4rHJw/fy1b8PBH/78vRLQSEESlssMnn4Hr7cppRS+uHVTykJIbCC4nE5Fr6cEAJLKRaVseHLCSFQ2uwxOTV8OSEESpktInOHLyeEwNxOjkfp8OWEEJjL5GgsHb6cEAKnGh2LtcOXE0JgqsGRqC18OSEExjoah9rDlxNCYKjeKLQWvpwQAsccxKD18OWEEOjzGIGthS8nhEBu9/6Pr/v0TBi68LUewr7wAezu//ycUkrp7OfzlDYUwmPh6+4B4tp1b2wlhMIHDLXL39FqCIUPGOsggJ1WQih8wFS9AezUGkLhA051NICdWkIofMBcHp+Bu3h7PepXM/aFsLPU/weYf7yxPv3+znOAENTB+GsLofABpfRGYO0QCh9Q2tEYLB1C4QOWMjgKpUMofMDSRsdh6VeEwgeUMjkSc4cwJ3xAaSfHotQrwrGEDxhrtmicGkLhA5Y2ezzGhnAq4QNOVSwipUIofMBcisdkrhAKHzC3xaIyNYTCB5SyeFyGhlD4gNJWi0xfCIUPCOPi7fV+qZ8cAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAhf4BDsJ9Emo7biEAAAAASUVORK5CYII=",Fw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACgCAYAAACLz2ctAAAAAXNSR0IArs4c6QAAAxFJREFUeJzt2jFoJFUYB/Avx0G6RAhcozzCrYFrtjtLIYhdbuC2sBCU4ywuRRR7CwsLGyvxIlwjiFpZ7EGS7hD0CgXDWdgIxrBZzl7sj7G5ibubzWY2O7uT3P5+sGR3M2/m7cw/771vshEAANV58PftvO4+lNXabuVnPYepKsI2+HOuTXISXoQTuLzevPSf4aK70vviq86HfcP/WnPpXEGapO2gL7ofTbSPYX0o06/l9Wb+xluvCuGU9QVwZ68bre1WXgTxRnpp7B0WF7doO04Ih237Qfp0ocx2hcG1X3urfaL9sPcGrXQWsx++P4iVzmJ21rac35XBN7KNFDt73YiI+KP7T0SMF6K15lJf22wjlW5fJhhnbbf58sNS+xhleb2ZH3b2d1c6i9lhZ3/XKDg9fQFsb7UXivD1Gmc6HRw1d/a6kW2kSfo4U71TbxG+OqbieamMT4yAxeiSbaT48/d/I+L/UPWuEU9TjHxF22JELdM2YvSab5L1YNkLNzj11jUVt7faC4N9bm238rKzxGUx8sMUJ2CtudQXqPdWPz+13agLPYuTV8VFur5689ZhZ3/3tNfMSGu7lQ97zPL4szpWVeZl6uQCc1MZgEsqNVKeGsm0xeylRsrzPM9//PmJEM6BE/cB65QaKb+zeT9++uW3ePT4ad3dYQYuVACZPxfqrvr11Zu3nj99LSJ+jYhwA5g+CgSmZlS4it8pEKjS8RowNVL+zbcP487m/RgMV1EcHB0cnbtAqDKwRuEXx3EArz67lt19+1723ZefZFefXRv6zY+PP9s510GKcFcRmtRI+dHBUVS1P+pVqgjpKQ76DCsQilB0/+pWXuAUI/Gbr78Sjx4/ja8fvD+V4zA7lV683oC8+87tysPx/A/huEKOUCVTIWs7aqHCnl+1/yekigqby6v2Bfw4BU4hNVKu+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAoBL/AZhvdR1TSKf6AAAAAElFTkSuQmCC",Mw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAZFJREFUWIXl179OwlAUx/HvTXgIpEvjxsJkGGrcJeqIq0NZHQi7b0AcWGVghREJrIbgQJxYupkuIpuPcB3MvdbS0v9l8ExN07SfnHv66y2WaUjLNCRHKvH18iABru6GALy6H6JUgDPoSIBqo8YxIEK1f9hrcQyIsExDDnst7P6cY0A0QFXZEGGZhpyNbHabLQCLpUN3vCptaSrqoNqoaYT3AXZ//gcyG9kKIvOAVIJOOoOOrN8/iTIggQCFACgasjeEi6XD5UV970IFUZXXjIjH23MJ6IeGAYqC6GlvN0198hDAD8maI+LUPLsGqPI59ULiIOAnN7LkiB7CHSc3AJO1O/VeEAfifYXbTZPueCXiDmvl3X17BlCdSAtJmyN766Ig+sYRS2P35/qmu81WD7F/WOF3XhQYAnIgr474cwR+uuLvSOS7GtWRydolS47ETq24S5M0RxLndxTEizlUCpL6S5Z0WMMq8zc9KyS33U1aSO77vKSQwna8cSGF7/2jIKX9BYVBSv0NC4KUDgiD/N/6BqlKK1m+ta+tAAAAAElFTkSuQmCC",Bw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAABG9JREFUeJztnL1P20AYh398CKQsdEJCgCFNVZEuDK4iEaljt7JlYOnQfyHq1qFi6Jp/gSFLB9SFTnRFiUSbNUioaT6KFMFElkhB0HSIzlzOZ/tIch+27pEixR+xLw/v3b1+HTMHg3AyzpC3vtPozKluiyiLuhtAS0sV8gCArDMAAFx0lkf7HMPbxzSZ2hpDxLHSgiAy+8cVAOaI1NIIJ+MMU4W8T1o6t+Tbt3l+N7ZMizRBotIGkKhzi663jieNhZUIjESaEI3KTsxGnYg4FhOjUekkEiXv+KDKXV/4uhd6vNoM2jYpSv5qdPSFyWv/bgMALo82AQAvP/wFAGy92PIkhnVnHVEo/YSi8n58+ucJY7k82sTbL/NGSlTShcPk0bCRR5ZZ0rkln8SsM9DSledlHpxEnwhnp9fe+8ujTVwebXrr6G1hpAr5wKsZWUiPwKgEGRilNYelGj6j69t2dnqNw59rcIsumud3XiTzolAHSrpwOreEvbUNVLtXgfu4RRffg7a9eTyOaUjrwk7GGbpFV+hLp3NLkfuJHCfrDJR3Y6ljIE21e4W9tQ3ferob8kQGyTWh+wIGVGN4mNhVg1AWgYA/CulJIa4oFQgEd+W4oqULexJzwbNyGKaMf4DGMZAXiWFpDhAu7qKzjKwzGOWdRRcoYajisk6KQCfjDIMqKDSsMF7XrnavIiOOyNPBzAWKyuMRFYEmonwSSRqJEVgr6SmrShkDdeR3qUIetVLFW1ZVF0xMBAIjiaLls1kxc4GdRmeuVqpJy9XIjSRTkBKBsiWahJYunCSxiRoDdWAFTkksBZo0kWgROM0NIfqnb+SlEy3VmGkSbV7hQKdEo7pwHGdnowRGobNsFYQUgdOUtKaBFFTdoqvs1qbUCAwa53iTiEj3DYu+xBRURWElxvXunNaKdFyl0SiZROI4u4oiRSAR1jy/U1Zc1VWRllK1pX+NPwt5InflgMdnSICYV6QnaTyJ1mm6eyIq0tMyScTqTK6lpjFhMpIysdiK9JRIu5Rj100qTeRziazGsMk06c5BTyPxaJ7fRaYn7HbVz4pouZRjvzT98KGINBYd6QtBWhrDi7TjgyryqZWxVxBR22l0pC8EqX8tdizsNDpzTsYZsmIq/d7YMm87HaWEWqmGfGpl7POqI1DZyZ5vv34HAPcLNyfvX2156xutW9++me1nY8uN1q1PMvAoutLvaXvcVfpJiTjAL29SeNIr/R4WH1b3/7R+BT2vIwWpeaCovN2d9Scdl41QYBSN9ws3J/Q5VSBNoMgX2d1Z9+Q9RSIvAp967lmh7VqYJyxKYrnejpSnGikCeRGw+LC6X663Ua63PVEfv1V8n+VJbLRuUa63sfiwus+bTCr9njcGhrVBBlImkajG3y/cnAAjqeR9FLQc9jP0NhoVE4q0WVj1YM6iajY2rh4YN6TmgbqiUGUuqDSRVoHqRFr5pZwsVIsjaLl+nJVMXdJotP/3M0BcqAnCLBaLxWKxWCwWi8VisVgsOvkPW9QWs7d38t4AAAAASUVORK5CYII=",kw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAABgCAYAAACaJ3mZAAAAAXNSR0IArs4c6QAADGpJREFUeJztXT9oG8kXfj4FX20ciEujcBxxJ/AJg0ih/kBcZ64Kl8K9WxXhCrcqrktxP1wd7g7B9SoOg5ANKg4SjIlxmYOE1DYn9Cvkt3p6mpl982//OPOBSbze3Xk7882bmbfzvgVISEhISEhISEhISEgoEBtlG5BQPzR39+f095vbS2cePfE3J+FrARKv3xpDuzsDAIDJqAEncDAHcCOiE3ND9oAEe5RR/83d/Xm/NYZXZw0AAHj39n7l75NRA06mB9a2WJ2s7QHTAwAojohld4Cyyi+r/jn5ECFIKD4xVg+wQdkdoMzyy6p/LBefd+9oU1m+qx2ik2L2ACnK7gBlll9W/Td39+fD43Pr63qDjtiGbyRGYA+gD6zqAe3uDPqt8doQ5QtVA2BPjF122eVXof45Pn/8ovw/Ynh8Ds3d/Tn+mO6VS0AAyNwvwOLBde6XnxsCZTdAmeWjByqj/vEZJqNlp5uMGtAbdODD+6cwGTVgMmrAh/dPoTforJxHkVcfRgLqXLC0B5jubYOyOkCZBDAhpAdSATtdvzUGANCSK88+vN4EkQdEuPQAH1SlA7iW70oAgOI8kBSTUSPrXLSTqY59eP80O5Y3KuQS0IVY2Cg+DaCzxaYB6kqAIj2QrmwE9+j/+/mv7Dj+DY9RSMvWEpAaghVg2wOwEl2HAVq2DWgD1I0AOsTyQDpQgtGQ0/bO1tq59BgfEfLqTklA3gvojWx6AP7dtgJ0BHBpgFAoigBFeyAddMTJI5Rt3a+9C1ZVABa6aARJD3iqvN4HSADaAAh9AzwQAMZwAgdzSWzK9Py0LGn5ruAkxyHftv5t6/7m9nID3+32QU7izx+/ZOSjZecF6Y2bEWjvXiWhvmJ9vU/oDuCKsghAr1PVYez6B1iSBYnIgcR8/uITbO9sQW/Qya7D9pMGxbUEtH0AVQ8AcG8AFQHwfjYNUDcCFO2B8mxRHc+IOV0/j9ovKXONgHiDPozXhh98GGkPoNfZVkBeQ3PoGsAWVSBAkR7IBXn3DLIZgQ+F9GHydoP47hahL/0psg7Qym8Aer6LDdQODpvyY70bpr/r6r8O2+SMBtIHLeNhdBVddgOUXX5CQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJ8xM4+S0jQorm7P//9p/+CphwkJIjQ3N2f//Pb3Xx2N5//89tdIqEHkjqWIxZbve6jZAN+TbBKy0wwb1NLsEdtPeDsbj7/7vsfAKD4bU++u60TlnAiYNnyaIjh8bm3QKILEvHCoXb6gGjD9dXFikRGEfJw1IZ+a7xWXhkbUZu7+6Jsv9oDww6zu3m2+qM/sUMSqHLw+0//ZStQbkeRYRFVOTQ0U4QduBp/9KtwTr6iSagiv6r82DaYiEU7R1EdEuuhzvHIyusD6sQZObh6Qsjy0Ybh8bn4+WJr9d3cXm70Bh04PZzVeiVupQ84GTW08mQxCKAjP8Xe0SbsHW3C8xefMhtCqWNh+ddXF7kd4Ob2coNm4QEUQ8I6kw/AQh9wMmrA8xefsgZHxCQAgJn8WN533/8AL988i0J+roqqa3AeH4zlkTnqTD4Ai0B0uzuDl2+eAcbeUKoCIB4B8sivg688nGnaofNo3APG6pCPDblxQFuFAoBVAgD499J2dwZ7RwvyX19dwN7R5gMxFg18fXWxcj6VhwMAsTARLxNg+coNIR3ytne2YHsnvlpq3WGlDwiw3tiqYyH0AXm5FKeHM9g72sw81N+//rs2R3SVh9N5Xsl1Okm0kIKdj82TKj2gXh/wHj5//ALbO1vQ7i6Ov3s7y45RIAEmowb0W3J5NF4+9cAq8gPEk4dblLuVkdvlWQD8PTKXKnHx6FXFmgc0CSS6KGTaDt868lNPhwsD1GShCCFP5ixq9DAHVOlG+3hk6Uocz6+TlzQuQlTqn9g4vUEnOAGk5FeFZD5//KIkjg2ZdNMOCtMcEK8N1SHpYkh6vk2ssgrQEtBl4eFLAFX5OvIDLJVJe4MO/PLHj/D6zyeZF6KrdMnCwSRLjCTCuJ4NfD0yTiEwBCV5Fhc7y4KzPmC/NYbnLz4BAATXB5Q21i9//JiVy+3nz2S6j4sqqwon0wMYdhcLGF/BTroYWiyEnhm/T7J8hlk2b25Oq79RoXL6gHTYUZL/waZXZw1ofLsR7JtoeF+Vx8XjtKOZ7NbpBdJnkXYK3hlNu36QtEh+tCXGBwxD3VMbB+SehHsZ0019jKMeGEErHG16/W34ni3xvHmrYN7gvh6Zx2El5OUxyJCEybaiBVqJV9o9FymQKfW8eCz2VzkBVqcCNDD++s8nRg+MQG+p2rvoa6POAwMEkuj9GiGddhTxXWDVVCBvSKXzRnodwpWEkmfHsm03Btc2JyQGfKYdIW2AFqx9JepkepAt/nTDn+rbJL75K3RTxunhTDT0Do/PoTfoiIbolBXHcHN7uYE/ZdlwMj1QRhFOpgdG70ID4fwbdy6gHjUvBIT7E+kmDEksMg3BFYXtkK/KU/GNRgAsvBlCsgJH9AYd0dwzETBhDarQES6IVAsgeh3dyIEwkTANwQla0IUQxjZNOTH91jgb/qUvE5IHTFBCNXznxRN15Kz625iEhISyUZfdKwkJCWXBNAGOlYzuck3yZo8Qzd39+exurmzcGOoApvLyrglpy2MndO3CMKrdvqeH8bLPsDwdEShRr68ugtqCcbXHnNZZOwKq1AZiJn/z3cWUjEg6TBc9PZwFswXJhxl5j5WEtdYHjNUgSCxEuzuDYXe50wOBpBsen8O7t/dZpmCI8pF8dBe09CW/LnE+jHVhYUVAmh64og9YsEBkuzuDPoxXyBACvOH4Fvh2dwbXZxfZ30KSToo8Emr3BVY0lVM8BOvSA9vdmZVqlAu4R8JyYyTe4JxLB504E4J7SRWk9aQTgdLVNXrOhZLEYujGBH7bVFDJeSHuISKgTqiHIpY0G72f0iNpktV9YSKZFNR2Om+U1BPN6lP9broHHbrxX2n7SO3Lu4d0zlp5fUCJRwrpdXz1n7EO0DvTToTHTbtD+E4UJJ5kuoF78qiSgw2QOK/OGs6LHjp/lXDBSx+QJqbHliOTeiQfr4ObPkOQkBMRiecCuiGVH+OjBJKwN+hk5Uk9J56LndoFtsKZuaspLtTz8s0zAFgQojfoZEPg37/+m6UCAqyS03Xyq0tNRNBtPzQJnSLTUxHmKeSVaQtqlzQ5iHpBkxC66TzVvRCqc3kylG86pzQTT7sK5r2ESqQBLIcTZPr11QVsKxSqANzFdHiSPAWSD//NdFdg2SDY4GWpBEiHTg6am8Lrje529hGAUiHk90+kdiiHYJ6XykEn/irBHCplAWAnxiMFJR8/jsMfNn5sGVuTjgzCNjVSmpdC60BVz7qhW3evor+BYlTHytMHxAfT6QMC+M0JVcMHRWz5Wwl4J8BGxJyIWN6XEgtDLbr6kCQ00fsVqTstDkSr9AGH3cUbAJ0+IE8RLAq8F8eoTD70I/D3hUbMcloQOmhO8e7t/dpbEw5JHeDQX2TAOlcdy1cfMIRLV3kYDlz54bzLpcHzPC7XiqnCJ7uwbnxWrhRFvy3JVccCUKlFLQV4eIyOypHZyKOZQEM8qmEGJ+FYFn0W1zJVoJN0tCUv/BSCFC6SF3WBcghGEqLUmAQqOTLfb8hxpQIqWGSa/4UQRVctcFTDLj8H534UPsPvSqiFDI94fDJyvnUlIFLJR9jqA4bosbTCVUJBFCHnWTwkQT2eifyLzQJLO308Mp8S5IVaqvDxRFsYCUh7s0oiDaaL8/LkyEKAklun4RcKpiHfRD68LvR0AENddLNrNlUyBKzrIGpu1AcEAOVWq5j6gDrw+JbqDQP+K43Cc7gM+XkdIMxboMbKd1FU9urI9+qsAXAYRs/PtV5NqGSv4KAv8xG6V274txCVTe+tmg+a4Dv/VXl76esxfm2IxSC+lg2tuFp5eTZOPtWwRueHoVDkkC+BTbk0krEYvv1CNHTB85CC4DS3VHnQWuSEcPLx11RUUi2UtJpqyKcxRhPh6ftn31eQdD7q8kozxL5G+pYEUxCury6sbMFNxfyayg/BZeSf5A356B1114eYDvAV8EoKRM49tdvyPacmKpskQzKSj+7dxGsqPwQXvXqTDPkmu0JNB/gq1+bzDrGmDdQm2y1bujc1lfeARYPvsQMoN47GvY7U+wHYeU1bmwDshDMR3I5EQIaqpJxS8B3PkvOLUvWXAO0p246EAkHTEcq2BUC/GPs/lcYWkAy4MuQAAAAASUVORK5CYII=",Lw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAEBJREFUWIVjYBgFo2AUjIJRMApGwSgYBaNgFIyCkQ4YiVWopGDiQ4rB9x6c2UKxA0i1lBzHMFHDAkrAgEfBKAAAZe4MBrg/DiUAAAAASUVORK5CYII=",Uw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAYAAAB3AH1ZAAAAAXNSR0IArs4c6QAAAEhJREFUSIljYBgFo2CAASMyh5nZ8D89LP379zwjhiAzs+F/egEMj8IsZ2BgoAtGdgQLskOUZFVpHvw4wUBFweBJhKNgFAwUAAB2WQDMTpagjAAAAABJRU5ErkJggg==",zw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAABACAMAAAB7sojtAAAABGdBTUEAALGPC/xhBQAAAMBQTFRFE2SIFGWGFH2qE2SGE2WGFXupE2WHFXyoEmWIE2WHFXyoFX2oAAAALq3jIpXFKKHUFXSbFGuPFXWdFG6TNbv0Jp3PFXqjMrXtH6fhIKniNLnyM7nyIKnjMrfxMLXvJa3mKbDpJ6/oJq7nLbPsJq3nJa3nIqvkK7HrLLPsLrTuLLLsMrfwLbPtJKzlH6jiM7jxIanjMbfwMLbvKK/pIqrkJKzmLrTtL7XuKrHqK7LrJ67oI6vlKbDqFGWHNr33Fn2oEt7TigAAAA10Uk5TTz8/769fn89v37+fAH/YHM0AAAEYSURBVGje3drHdcNQDERRWFkklCXSWbYl55wT+dF/V+bCBz083Arm7UdUW3mWGVCW5S1V0dzAcpWu2XhUJqByNDbrSt9WCWtlfTEr03IfaZlKsyYgpQOolP4DHqHiBBxBecAtlAc8Q8UJeIGKE3AM5QGfUHECrqE84AMqTsAdlAdsoDzgCsoDbqA84BsqTsAllAd8QcUJqKDiBJxAecArVJyAUygP+IGKE3AG5QFbKA84h/KANZQHvEPFCbiH8oBfqDgBF1Ae8AYVJ+AJKk7AIZQH7EF5wANUjICiuZxVu0hVczkrZM4+/c1lZjah7p+YzaSeko+v01ra9aKgzi8WdVs6NVpHdtgBItoj7+8173UdDKnzhwPVPwRCH/15giO3AAAAAElFTkSuQmCC",Hw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAABACAMAAAB7sojtAAAABGdBTUEAALGPC/xhBQAAAKVQTFRFFnyoFXyoFXyoFH2qFXupFn2oFX2oAAAAIpXFLq3jNbv0KKHUKLDqJp3PMrXtNLnyM7nyMrfxJKzlK7HrLbPsMrfwJq7nLbPtJa3mMLXvKbDpJq3nIqvkLrTuJ6/oLLPsLLLsJa3nIKnjIKniH6fhM7jxMLbvKK/pKbDqL7XuJ67oLrTtKrHqIqrkJKzmK7LrI6vlMbfwIanjH6jiHqfhNr33Fn2oU/4/+wAAAAh0Uk5Tr8+/P1/fnwDVUD04AAABAklEQVRo3u3aR1IDURAE0da4lh1hhLfCI7z5ff+jMQuizkB28E5QuS9zr7uqCqCq6mp38y7AOrcmYjzpC1A/GUc0NopFwVrEyCL6Ml0iTUsfMQSUsgVVym/ALVSegG0oBexBKeADKk/AHVSegCMoBTxC5Qk4g1LAE1SegAMoBaygFHABpYBLKAW8QeUJ2IVSwDNUnoAHqDwBx1AKuIfKE3AOpYANVJ6AfSgFnEApYA2lgEMoBbxC5QnYgVLAO1SegFMoBbxA5Qn4hMoTcAWlgGsoBXxB5Qm4gVLAN9R/wJ8IaIfb5Zy5fz7cLlsz9vHVrI6YUffPImr++du9aanz28b9ByOQclrdOBB9AAAAAElFTkSuQmCC",Ow="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAGpJREFUaIHt1cEJgCAYgNFqkmiGxmjcxmiGaJROQURBqRXie2fR/zuoVQUAAAAAAJSmTrlZ1/bD3bXzMo0pzowOeDL0lZiY4IAUgx+FhAQFvDH85mlE89YgX8k+oMw7sJftK3Tmj38AgCgrkfgcDGGvEREAAAAASUVORK5CYII=",Ww="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAABuBJREFUeJztnTFoG1cYx/9uC6GlZOlgYjpIVigYmiXIghiE5S0eMkZKtttCkIdMSZOCoSE4uJDNIWRo0WBITh2NcTNFQZCC7C2FQulFmho0FEIpBU/XoXmXd6e76M56uvd94vuBsNAd8v997/++793p3R0gCIIgCIIgCIIgCIIgCIIgCIIgCIIgCAJRFgtlX72StuetSRAEYRp8ZPLLFgtlf2FpFQdnjhK3H5w5Ip1EuRcA7voFYRLy9r+xBLpYKPvzhRIAYP1NGa8HR3PRfV4PjubW35QxXyiRHMjcCwB3/YAUANtwjr8N/xudgeroHTGuUyjAvQBw1w9IAbAN5/jb8v8nJr5E58/fXkA1JI7hwDP9L6cCRZNkgZv+1AMAwX5+3D42UQnoh7cPsP6mHLv94MwR1lEmqZ17/HXy8r+xBPoumEEn1CrVkX22tpu4c+sh3HYrtoMowL0AcNevkAJgF27xV+Ttf2MJVDfQcODBOXbRqu4E27e2m6G/bpuWgbgXAO76FVIA7MI1/rb8b/wQvlapogNgfQAsvOqjeq4IALhz66Hpf2UU7gWAu34pAHbhHn9b/jeaQFvHLpze+yQKAG67BQCxplJVmlJncC0ACq76pQDYhXv8FXn732gCdU41UKtU4bZboYTZqDuBeQCE3qsESwHuBYC7fkAKgG24xh+w43+jCXQ48OAOPDTqDjq97sj2pCRKBe4FgLt+KQB24R5/G/43ug50vlAiE8yTMBx4cNstNOpO7HY1e4i+pwJ3/foA0GnUHbx8/hS1ShW1ShUvnz9Fo+4kttMWrWMXnV4XtUo1GMBuuwW33UKn1w29gPdrRm1q1uEefxv+N5pAhwNv5NfHRt2B225hZe0KVtauoNPrYmXtCkrFZXLngrgXAO76pQDYhXv8bfjf6DpQ/TyQovuqj4Wl1eBQRuEOPHKD/UMFQD8lsbLWDX5NpdQG7vrnCyX80nHnAIfMrCwL3E9hzUL88/a/8WVMw4EHvKu0nV4XH3/6ZbBNNSLuF0rbcC8A3PUDUgBswzn+tvxvNIEqQW4bWid4WFhaRfdVP0icnV6XTOCjcC0ACq76pQDYZRbiD+Tv/6kFYNzJcYrBV0S1LyytAkBgok6v+26mQROu+pVudQ5OHwDVc8XQAKB2/hx4v5QpbvCOJCCi+gG+8Vfk6f+pBCBayahV2zRE1/VFodyWNL/sctIvBSBfuMZfkaf/J/6SOLHzhVKQdFRFBsJrrqiaBwAu1Bo+F/3c43/SZTyc9McloCGRQ+BJllFR1Z+n/yf6kqh4JTZpcaq+PIJSFYu2Ixrc6MwCoKF/kvjf/37DeuxFv10m0U9hBs09/sFC4Ge7u77v+6EbJ/u+7z/b3Q3e+77v376549++ueNfqDXI/EoZdwPccTeBpqKfe/y560/LLOq/t3nfehso+MfIQvoH19+iVFyG1z8MXqXiMh5cfxvaTy2+rVWqZJIQADy6dwNe/zB0ZYjXP8SjezcAjBqImv6TxJ8SXPWnHcBq/1nS/+1331jTHcWmfyZKoPoU/nxzH6XicvA639wP9qO2YDhK1g6gAvf4c9evGOefWdRfKi7nLXMECv4xeinn+eY+ftx7ERKvoxpC4fxhlCwdQFE/kC3+FOGmP+0AVoj+6WLDP8YfKrf69Wd4cu3SB/ehelPZtB1AVT/AO/4Ab/3j/KOYBf22f0BKIm//GE2gT65dwotf/8XVx3sj26hXL0WaDqAK9/hz1w8k+0f0Tx8b/jGaQOOER6FcvdJ0AIXlG0lkif+4x+/aYJb9oxD908OGfya+Fv714GgOBfhn7wKnNy8Hn/999yf88UUrdF/EYH+iXH28h42L8duo6j9J/BcLZb9Rd+B0N+CcagAWnxAp/qEDR/22/WPkSiR95X8S0X2odISagZ39y8HpzcvYuPg5dn7+J+gABWX9aeKvEicQXlC8td1EqbhsvT1ZZsK2tUZZLJT9cf5RUNMOZNMP0GtDGu/ol2Wb1D/xlUhq9f/WdhO/r8ypGU3oUFF/0Jaa9VA4FND1x129wEm/IqnSZtk3bxYL5WAGHDcYVMJ3uhv46qVPIuFH4Xz/gXHaqcY/zYRg2r43MgP1+ofB0wZ19FmPQj2fhFIncNevdCmS9EVvkEJBPxAewOrUghqo+ucArevI4/hQWzhq1j8H6MQ/6+QBmM6Rl5EgZHm4FLUHUQH89QP/69LPayaZnKL+C7WGH706RB+o4+5VQIW4QQ3QSTpJcI1/1glB2jGSBRKBEMygG52KydOQdAjJqQ0Kjm3hqFmRdULAdYwIgiAIgiAIgiAIgiAIgiAIgiAIgiAIgiAIgiAIgiAIgiAIAgn+A7oMD5O/vWDBAAAAAElFTkSuQmCC",Nw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAAQRJREFUeJzt2b1NBDEQgFGDKMSYFkwl5AQUctFJ1wUBOZVAC/x0YoLFiAgJbsUw7HuSJWf3zdxJt9KWAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMBXTqI+uNU+5v359TGsY6uy719/LP2L03VyjvN5mCxa7WOe6JZjZZ9Bf6wt95+tGfIdN9dXH/fbu/uojFW02ke2f+Hs+9cfS3+w8W6/O6R8itvvDmOejP3Z968/lv5grfY5Q8oBsn8B2fevP5b+hZdIP9RqH08vD6WUUi7OL9PN8B/2P+/6f5/+RbrB/4rsPyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYAPeAL/X/DNWhUtlAAAAAElFTkSuQmCC",Gw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAAOVJREFUeJzt2LEJAjEUgOEIDhIyQzaxt3CQqw7cwsJ5nOFwk1idWAmC8O5x31cl3Z+kSEgpAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHxziA5otY91vDwf4T2/0h8ra3+rfSzPxyFr/2rv/cf/5vym1T4u59N7fruXkekQ9MfSH0t/oFb7mKfrWM3TdXzeBlunP5b+WPo3oNU+Wu3vRWRbgP5YmfvX3qz9peTe/1L+0x/+XN37H0o0/TH8gW5D9n7YpWyvNQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA2JcXCrA+xD02G1sAAAAASUVORK5CYII=",Vw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAABQCAYAAAA3ICPMAAAAAXNSR0IArs4c6QAABPVJREFUeJzt3b9u21YUB+CjovArODEy0FSyuc4iD2mAIGuHwC06BF3ct/DaZs1bNEvRoWiNDFmLAEWHeEnspWisaAjy5xW8sINNW3YkmZQoUWS+bzEgCwZ9ZN8fz728ZAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMsmTXpZ3cfQJOoFECeDYZZlmUGxGPWqXjZG3ccFTfFF3Qewt/fUmXUJ6jV/ggSKqT1AYFkJEphMgDREf7Df6a5vxcbmNV1IRTqdTqfI+wQJjPZl3QcAdcpDpEhA5O8pGjyMrqv6tYcOBOJkUNORVG9UXdWvPQQIDClzdmwgLG5UXdWv+QQIXFKmG4koNv3F+HBWv+YSIDCGEKneuHBWv2YSIA21mnTrPoTPQtluBFiAfGf1wcv3dleXcOf+Q3Wr0bjd6+bzy1G/dtCBNMzHwVHdhwAQEQIEKuUsuhgL6u0gQKAggxtcJECgYoKmGF1I8wkQAKYiQGAOnEXPRv2aoZbr28ddftof7LvefgJ1q1fZQc3+katNqqn6Lb+F3403TXrZ43s3IiLi+1/+iEd3b8fGzTQiInYjMoPhZCNrd+9Gtvv8rSBZMlmWZQbByTqdTmdciKjf8lvoFFaa9LJn1/cj4mQA7K5vxZN3K3H4uh8REc+u73vOxRhqVy9TKvCpha+B/NrZjIiI7vrW2WtP3q1c+B6jqd18pUmv8t39gmc26scFw/+kadLL7tx/mF1+ndHUbn7SpJf9/PVm9u+dGFnLq25h4vYm01G/Zlv4GsjwPP1q0j27NYf5+6up3Xxt3EzjINJ4fKva9Thz+aMVDQf1W161fihp0stWk27889dv/jimoH7VSpNedvTmRfz+43ex+/xtJT9TuI82TWchRJZPrc9EHz6Lpjz1m14evh8HRxfq2F3fiqM3L2L39Ousuutbriy8RHi0R60BYvCbjfrNZjg8hkPk0d3bEbESh68+zPTzt7cftK4DydeHpv29hEe7+GDgVJr0sp2149i4mVYyhdW28IiYLUCmXRAXIMur1g4ElsXwBtdcGwOgLsJj9u5tGbkXFpw6fN2Pr/77M+zqn2w16ZbatCo8zrXtUdQCBOLkrPDJu5X45n1PeExQdgAUHufaeNGLAIFT/cF+R3hMll8yPtyF2MhaTH6xRpsIEKCUj4OjszPpfO1oZ+34k2kt3cfFcB3uQNoSugIEKGTUoJfvlfkhe3XhvcLj/Kq+x/duRJr0siKh2zQCBLjS8GC4s3YcO2vHke/aj4gLa0fC41werDtrx2evjQvdJmrdBwZUL3+cwMGtbyMiPtknM2t4RLQzQIYvDz983Y+f/n55FrptuNqv0QcPLE4+GO4+fxt7e09jY/NadNe3hMcVPEkUIM7XQQ5evs+yLDtbE3G7+8lG1awNrIEAhVV91tzmzqOsJgaqAAFK6Q/2O9vbD+Lw1Yc4evMi0qQ31fM6hMeJJgZHToAA1KSpwZETIMDC6T5Gh0fT6iJAgNJmmcZq2iDJeAIEWBjh0S4CBKAGbQhTAQJMZdQ01qT3t2HAnKcm1keAAJUZNwg2cXDkagIEmCvh0V4CBJha2Wks2kWAAJUa7jh0H5Pl9WlqnQQIMJO8C7msqYMixQkQYGb9wX5n+NbuwuPzIECASni+xXSELQATpUmvdc8DAWBBhAcAAAAAAAAAAAAAAAAAAADt9j/CHqkX1w2PcAAAAABJRU5ErkJggg==",Xw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAACO1JREFUeJztnV9oW9cdx79OTTGUPJUUkvTGRpjUMfawjVbM0uRa9kr60OKUmSaBzBDIDAnJGoaoQwhshmDiIDaXDgwmEEhH5wdBa9LHObK2ZA6LcEQdFLsxqhMt3YPxy8rAZBp3D1e/q3Ovrlw7utI5x/l9QFzfqyvpe77nd373/LmSAYZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhFCPUFLaCPI/ZGuw/8zKjdfyHmsLWf//9tuUnTjy20Xmy0bkC2H+mUnT2X2b87wjqjX7+8W8AlAr+dvGe6xidpxKhprC19M0O3+DwlqfcebJh/+WiewLS3X9Z8V9xAg01hS0jEsUfL5iuY16TaX9mYgBGJKpcJeiagNh/+XACkofs+A+kB5pLxAAARiQKIxLF0jc7nL8fLa3i28V7zuPR0qpzvgrIroAgYP/lwwlIHjLjP5AEakSiODeedPYpSMRK8Z6vEjonIID9lwknIPnIjP+6IN6Egkjk7s2TAICDg38q2c8lYsiupAL57Erx005QBRx4a5dz7NHSKs6NJ5UvA/tfGygRTk/fchrxXz79vasRe/X3938AAMro19l/QG78V/wm4pX02gd5vNV1CJ2nJ/D3O9+hq3M3Gl5rAADX/j6jQxnzAf0TEP3N/tceTkBy0Tr+Q01hyzw1ZZmnpqz7j/NWqClsLdw4b9W/Um/l1+39+lfqS/ZVGr7QcCvUFLbi5zsc/f+Yy1n59byjX9xXRT/7rwZiPdCDdPvtq6RfZ/9ViP/6IN5kZmIAD3JAa2tLEG9XM8Qrb+zSAI69243pLvu5rs7d2N/S7Zzr3VcJ9l8e1BhzidiWekAqsB38B+TGfyAJVGRvc7tr/8H1MwDgBNLU2TZ8civoT60MXROQH+x/7eAEpB61jv9AVuH7zsQBAJnMIgBbdMNrDXiaS+PAiT+gf2QO+4wO7DM60PvR2SA+smr4VYBYnqmzbZKUlYf9l8vMxACA7ZuAVPdfZvxX1APNrqTqkIhZAHAsEcPgnucA7Ep4cP0MOk9POJmfeKPnrDJDGKLvTByxSwOFCjjsVAAAHDhxD/tbuh3NvR8NAbcmJaotwv6rh44jAF39VyH+A7uNaXDPc/ziV/aq497mdrzRY2f6944cRyaziNbWFtdWiVUwuFfxBvc8x6/HzgEAni0voPP0hO9rlFnFK8D+y8FvCJ/6fMilff0/666he+rzIYR/OamEfkBv/wmZ8R/Yd+Fvfv8q+kfm0D8yh2fLCwBs8R0dnQBQslUFMpIqgLRT8Lx35Dj2GR2urYqw/7Unu5KqyyViyCViOPZud0kPCIAzlKQHNWxV0Nl/EVnxH0gCza6k6uhhNPagf2QOQFHs01waV8eG8TSXDuLjqoKuCQhg/2XCCUg+MuM/8FX4ZDJWZ5pRy2jswdWxYQDAwXcuOM9fHRtWbg5O7M6bZtTqH5kF4K0AMv9EreVtCfZfDje/fxU3Cw13+rf2MUpAmcxiyVYltoP/xGbiP/+/fGDTD1Wbx8iv562+IxeLB0JhxC4NIHraPpZ7MqvUPIqIaUYtALh7ZxyAuwLu3hl3EpCq+oHt7X+QDSBoTDNq5Z7M4mkujYvDYwDgNGQAuDg8hi+++LOy3gN6+0944z+ZjFVFc9WMuP84b0VH7dW96Kh9m0Hskn27R3Q0rtTXwfy4/zhvUbIBUExAo3Egm1I6AQH6++93AUA2BUDt5A9s7gKssn5Ab//9ME9NWdXQH/gQ3g9quA6FgihPKIzkjeO20UngpzcKFQHAaOxBdkWPcujo/4McnItWkWIPWmWSyVidnYCEg4UEdPCdC8g9mZUlbdPo7D/g7kAUCV5/YKvwXqjXQ1vxuA4BRLrvP85b4oMqRPUybBf/Rf26aAcKN3eHwnYSun7VbsihsGxZm0Z3/2ulvyrdcOql+SH+lqCqwwCvfvEqRsNfQB/9Ijr6T+igHWD9sqml/qoN4Q/tfob+Ux87++KVQGXzCdIfHY27tKv2Y7Ib4U38hA7+A/76ddG+2fg3d9Y7jT35gzqLM+X06+I/UJv4CTSB0uQ5AJf5hE7Jh/SLCy+EqkEk+l8y7wm9/PfTD9jfOlHBfzHxAaXJzy/+CSqDubPeOv/h+wCAz778uhoyX5hy+lXx3w/TjFo0TVKr+AkkgYaawpbR2FPYKZ3nmb7xKYC9QXxUVfgx/YTKCWij3zj0zoOqingBEFFVf6S9FYB9D6iJtCUmUXEBwxv/lDxnVtfx1dAAHi5nayu8DLr5L+LEfzZV0oarqT/4RaTCCm850apevRx89NsNoPC06voL6Oa/ubPewvw4MG/f+uOn31hLw1hLu15Dj5oJLZD8IV+XWMjg8u15XDv8pq3HjFpiEqIy/O1fdvI0GntgrKWd3islz8RCRvrwXTf/vWRXUnWO/mzKPfUWPwnETzr/5ylI3YH8Sw+n9+Z6IoxDu585u6rePKy7fhG/HkTuySyMSFTp+z7NnfVWpL0Vbc0hfPLXfxYbaZd9y4/R2GNv19I4/+H7znCXenCAPQSWkYSoJ9m3y/7Vn9zrxW95OboLWwCuMlAPVnYC/TH/CRX9JzYqA+bHq6a7ogJ7h43GWtoV9AQFf+71Dlw7/CaOTsaxv6VbeoPWXb8X52IwP+5qyIBdtpnVdSV1U/ADQFtzCEcn4+jb1eBORmtpRNpbkVjIuBoADX9lJSGx4Xoboxhfxlraee53P/uJRZoB+YtHOvtPbFSGwT3Pq6b7hV9IE+BHJ+O40tuFtuYQgGJG9wYPBdnD5WzJuS+qoRJ0118OcWHi4XIWl2/P46uhAXz25dcQFyxU1A1s3DsQGwmhQhLa6kq6iivvOvtPlCsDUJyvJoLSXfEi0pXeLly+PY8rvV2u42IvxygUjLK+KpPmgP76/SB9VC5K+CrrpkDu29VQ0khd5yxkNlz9lslmtaikmdhO/nvLUE3dFfVA/Y6XE7bV86uN7vo3YjOT4yrqJlTsob1MbAf/t0MZGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhGIZhXnL+DyMmbYWxYb8ZAAAAAElFTkSuQmCC",qw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAA3dJREFUeJzt3D9LHEEYx/HfBd+FHJFDu1gIJ2gVRaxthKuEpBHSpLKyEZtUV6UJaBOwSZHGFxAUFCxcsDBddL1jsdU3ENgUe3PxH7o7e3c7D34/jXDczP32med21l1RAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAojYlm+v7jj9R3bGOi6TUWGev1t54f1Qqhf974Diz74fXFDdUXN0rPU0YIC+DLev2t55ds94/LYDV/KP0z5jOoMdFM628XJEm/vq1qSdkiJAdtxZ2olmeO9uaqZurS0idJB+0077hBGcQCSKosu+X6W88v2e4fyXb+kPqn8Am0H77RvBdGkjbiSJIKhWlvrnqNKyOkBSjKev2t55ds949kO39o/VPoBPpU+LNEmqlnP9Voqp69/GKY2amx2umfv9kuWGBcWaEtQBHW6289v2S7fyTb+UPsH+97oA9tfPkpF2YU43w8twAuQ/3tQq5fb2anxmpnSfFxw2Kh/sPIQf/kZz3/c6rqH78TaLbj9J0l2eV/ctD2mi4EFr7Afdbrbz3/E0z1zwBzvPb+93qIJEmKIyXdQ7V6oS+vTvX7+2etbOc/iNbynKTeDekHRRmqOHq0C7vi92+Oh85y/SXb+a33j/X8UjD9U+gKNO5EtaR7qKR72H9tf2tel1enuj3e1fjkdP99eea7vDrV/tZ8NVcecaTkoK3W8pxay3NeWVrLc//fP4IvsPX6W89/j8H+ucdg/hD7p/AV6J1wqSSNT07r9nhX1xfnWtk+yTXHzdHOo3slSfcw94H76s2fSpJ7Crm/Na93H77eWYCTQgvgdj0337BZrr9kO7/1/rGeXwqvf7wfIrkPu744l5QdSLS3nmtsc21H1xfnXrtGWXEnqrmdTLq/AM21nVxz3BztpA8XYVQnIMdq/R2r+a33j/X8Tij9U+opfNyJaivbJ/3Cu4N5SbS33g+ed8yghbIAZViuv2Q7v/X+sZ7ffWbV/eP/EKkn7kS1xkQzdQeRp5DuvXkXbFiyBVAqnSjaWy+0AE6VJyDJdv0l2/mt94/1/FL1/TPyXeMu93djVexeT+XIm8W93zXdynb++0YhCaX+vkLJb71/rOf3FUr/vFpV/0MF2Ga9f6znBwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQFn/AEOMz2GJzMQ0AAAAAElFTkSuQmCC",Yw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAAxtJREFUeJzt2T9r21AUh+GfS7+FMTHCYzUUNMRTU0LI6CWQLoYWgsdMHkIW46WTpy4FZ2jBS4cu/gAlLQQ8RNDB3eooLsFz5kJBHWTJiv/RWrJkxe+zWFHE9bnnHh3JkgQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALBBjKLlvnjzyU07jm1F/rHN0qr/J3EMYhStzJ+4WW5A5B9RZTn/adb/06gDGEXLLezsSZK+vD/SvrxFuLtsyRnaueuff9zjg11JkjO0c4vG8LcXHbNOWW5A5H8zGEXLLbys69uHV4nnL6os5z/t+o/UQIPgDSvY1zo/kiQdX7ZkFC33+GBXN7fX+vHxVJWm3Okg/eDtTk2SZFXlJnkSp70AUZD/yRj+NheA/5Pl/G9C/a/cQOcF//1Oel7wPiWp2yjr2et3ur+6UL5kSurNBN9tlJUvmbKqbXUb5VXDiW0OWWlA5H8yhsQFYBVZzn/U+vfjjlr/sTwDnVZ/+1mSlC+Zur+60GjQl1VtzxxX2NkbT2wykaQsWwBft1HWze11aAFmi6fbKMvu1GRV2xoN+onFv8w25N8oWm7a+X8wh/E8WudHQRMKN6BuoxzEPD2G5DUgu1NL7G72MeR/kSTrP3oDdewHf+4fngX7/ITmS2ZwhQq7+/U1mFy+ZG7lAkRG/iVxAYhTFvIfSLn+47kDdWzJsVU/OQsCc4Z2rtLsBYmfF5x/jG8bFyAW5J8LwKoeQ/5XqH9naOfiqP+Vn4GOr6Su5BWC5AUe+p+coZ0zipbrT2Les5F/OWbtxgVTP/E+JwsgV+rJ7tSWNCAFP7n85yyJhLzl+ffjTCv/k0DsB3eh+4dnwfZo0Fe+ZI4bkDnTRL0G9FuV5uIaS0QG878p9R/LyeI/t0nl5IvAj3vRAoSPmd4/b5xlx6wT+U8+/+GXR9P8BhR+vjka9FVp9mbim30J0050DlI28z/v+9P47kydcOuS1Qb0WGQ1/zQgAIho3tt1AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEC8/gIPz/mfyE/ZzwAAAABJRU5ErkJggg==",jw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAgCAYAAADaInAlAAAAAXNSR0IArs4c6QAAAgtJREFUeJztmj1Ow0AQhWeRKc0BKKNUUcIBaIw7pFgKuQAnIHeg4QRwDKQIKdSRzxCUClHmAm4oLA0F2cjkh6zXaz/bma9K5bd+82bsdZZIEARBEARBODkUegEuCHyP9e84SVtxT0IOmJkD3+PX+zvOhqFKULpF9c9ciSMNUEqpOEnVx+cXTcYRrBhoH2z0nQSgyAJcwcw8XywJFYI4SVU46MECaKtfOADMzERE4aBHSAOIfk1AhgCpDdHXxdcEvseP11fQZzFqHdoLlAe2+tYTgJlZKbXzxo3uAgRZL9BTKK++ZyNyqPibLdhiyUREk3FENJ1x1VuzOEkVeg1NIfcEOFT8OhIOo9I19vnRpCmQKwCmxUcboJm/z2j0sirt+sf8qCKA/2GibxwAm85HG0BE9PZwSUS7L6xVUHYAXegbBcB27KMN6Hc7G32llHIZAhNPwmG0CSACE32nH4LqxuhlVVoBTAKFbgBnE8B191TF0+33HwOqvo9WTQBb8+puQBGOedKaCaAxDUHgexwOetTvduh5OoP9RZs1gNdUvYVFNoCJfu53gKY9DrQBao3r6+/zA90AefStvgTqm942VO/30d2PLkCTsN4FbCcfXXzkVMp6gQ5fXv3Ci2Nmvrk4JyJ85xPhCoBuAFt9ZwtEn8urQwGa1Pmtow5nEZp4JKxVnLwBgiAIgiAIhvwA7Cn27X2XP3EAAAAASUVORK5CYII=",Zw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAI5JREFUOI1jYBgFlANXDZv/rho2/0nR01LXDlfPuHLpmv8MDAwMc5onMDAwMDDsvnGEkZBmVXVVhts3bzPUNFUyMjIwMDDADIEZVOwlynD9ySsGTRkxDPoMjxmDiIgIg6CwIMPtm7cZmLDZcv3JK7w0AwMDw/u378n3goiICMObN28YapoqGSkOxFFABQAAAr9HnRBKjFsAAAAASUVORK5CYII=",Qw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAHFJREFUGJWF0DsOQEAURuFzbUGiUii1OoUN2alliESjMoUg86AaGcI47f3yF1cIWubx0JvCmh2ANK/E3+QNeQiQFbVc8AuFOAGIIV8C/KILxlrm4b74hZw1/4vOGvSqIHzP1HfHc0mvirJp5QY9fkMAJw9eXg2Xm1L2AAAAAElFTkSuQmCC",Jw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAIRJREFUGJV90DEKg0AQRuE34kHEVtJJihwgd/DO9nZik6QKIQTBZd1dq5FJjL52Pn7YFUyXc5M+45N5djg30g+t6C2zCFgRQFnUaQMBXu87ewnAqbpu1mz90Ep+BGwZcIj0lu+BEDwxhu9F+w2Kfvu7qEsxBm6PTtBXa2VRJ++nFSoCWACc8UydDDmB8AAAAABJRU5ErkJggg==",Kw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAgCAYAAACinX6EAAAAAXNSR0IArs4c6QAAAu1JREFUaIHtWT1o20AUfrJL95BCM/pnKmQx2CbQSXuhkLFTyd5Fq2evWTx18dwpIOjuSWCcgBfTUIrTjBkashuEOqR3fTq9d3dPJy91v0m+033fvXfvPT9JEdRAURQFNR5FUVSHT4peZ0jq393fiPW9F3BGs8QNO4MzmoOvM5w3SQ2vCAQ6Qmq4CZcjrJPSUG86NaShXic12AnTGKkRoetNY6T57bveeZKhIVyHC2++TmGTcLXMgSaNt3FzaNJ4G7dCScDXeN/wktYEX+N99X1qgr7wMV4RTgZLGMc5AACsFm2Yrs8qxBSfTcPHeIk+xUeNVVKAQ68zLCaDJfz4fg0fv7T1+DjOIU0ymAyWWmAfaSTRl6SR82SwOBYGAPj2eVf6vVq04eLq7z0UF6Xl2rBEX0WDjQvPOyNAiY/jvCRoigOA0/g6kOi7jKfwwucmlW+cMADA6aeX+rrfHfnQesNH//3l21rcLVdhSpOssujx4al0jY3fzHaQJhlbgbFGURSFLfx99bHxaZJZ9c1C6RUBCirHJoMlbG+fxy6uXuv5zYw+naZA6U/X7/Q85SwXnA5YLdqlEFTA+Q4AMD/PYRw/X6sTUqcQ0tBw+jjf4c9fI0Au1meLoCo+ahOActE0vt8dlTa5vX2lN4X/niSw6ZvGg1EnJPqkA7C4gtrE9ud1aXwz28H8w9cKB25WpE6w6ZtIkyxIv+IAUxx71ix2KuePT470OC5Q5nof2PSpYheq3zKrMrV4HOelsLcVOxV+nLD5r8O1r6Y+DntbsXPpezdC3MnPz2nix4cnMky50HWBO3kzNUL1yVYYd19Ug6M20X/zC45PjvQG7+5vIip/p+szXYl9WmGsTzU4IfqmFvv01usMC1zw+t0RSQJMA0PNS54GqaIVqk81XWwfwBlPCXIbbRL70mdfiOgbGnqokbxvwGjKmVzL7fW4GgoJ5z5eidk4D/6l6P/X4jaSg/4wonDQn8YwDvbjKIV/6fP4b2BkyaBYp0W6AAAAAElFTkSuQmCC",$w="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYAAAAAwCAYAAAAYeq1+AAAAAXNSR0IArs4c6QAACNxJREFUeJztnU9u2zoQxicP7xhZJM4VHCBdtL1C212aKzRddBHkCA9ZeBHnCq4BB0hzhbYLGWiuUDeAdQ+9RUKDlflnhhyKpDMfUCC1JOrHj0MOKUsygEgkEolEIpFIJBKJRCKRSCR6aRodjLvRwbjLzSESKUk8ptFeysL1Rls9PiQ9VwqF8qvjctc5hH90MO5+//kFy+USzk7Ps9bhJfqfkoXKUAq/ismjw+OgOADxP17UDDw6GHdd13Xr9bprmoY0oyxhBhrKr46j1plbFH7lt87eNE03mUyy1aE0/2uOf8VCZQjl55TOsVgsOj1WXT6Vwg+F+0+aFWIysAL9/ecXtG0LbdvCer0GAIDLiysATzZLNQPFZmAMv0uKHQCgaRq4uf46aPYO4Z/Np3B7ewv3dz9gNp9u2Nu2hfu7Hyz8Nftfc/yr8tq2haZpUB7G8IPmAVfcfP/5DZqmgeVyCfd3P+D3n18AAJt2Pjs9Z+XnVOn+/0upwH9XF3B5ceXMRKqj6PBt2/a3W8vQO/Cnzx/h5hrISydbHY4Oj61l6R3XxT+bT+Hk5GTDqKQGUH3w0Y+LFWYA1QcqCr9ih+fO9OnzR/bBv1b/dyH+1eCjyu0PoLpOTk5Q/K521BJYNPvq8WHv7ev33bsPbzYxenR4DAAA/11dADzHBBc/MCcwKNx/bwKgVkB91u986v/L5fKvIFfK3YFVEPn41WxjNp9C0zSbbSUMoLP5NIi/z3lzDawzuNr9rzn+MQOoOqe+AvTx25JYigSm2KAXkyqW3n14E8yvl6dPQoZMYDn9R18C0iugZKpAf7vKZKozKpNtHViBc3VgzBISerNgF79err6vaRv3AOpaQs7m062lMJa/zzn0Eh4K9h8qj39wtLXJQ/0zH7+ulJcQ1erXtgrW25vK3+8zqS4hqr9L8x+dALAVwBznOzZHBzYZVcJdKJQBdDKZRPPrnSzkzgVbmbX67+KoKf5dA6jrOBOf2vbp80eAASZwfW8osezjf/XqFUDmBBbDDwNMIDYgoXdChBzHfReEqUzsnQTUb+9Nf8dodDDuvnz5snX3w2Kx6BaLxWZbyfy1+x9SXgnxb/KccqyL39euEdhWXm7+yWTyV/8xfVYyf6z/qC+BVRYJyWLU65gpZqBgWF4BcobF+UVujFzXQPuf66Lw9/0OaW+bavV/V+I/VC7+1Gym+lPbwMff/77L9FlOpfb/n9gCSpepAw9xLu7zmRp79fiwp/5xnCOFdsX/GuUaQFOfsxbvU/afGvx3JgCOCnDMQNEFJFCJM1DK8Vh+26wqdxvk9F/iP5//rlk+xZfQFVgJ3sMA/idfAaiHGHKIowNj+UsdQMX/l+k/1wBK4S8xgYn/7vNYEwBXBUz3SlPOlzuIsPwpxDGAYvhLuNZsUy7/Jf6flMN/TDxifaHwl5jAUvuffAXQv/VvKHF1YAx/yQMoh/8hHUH8f1KO+OccQLH8pSYw8T/Af+wBrv1GxJeRcfBwlsnJj92HyufbjuHnaOtQPt/2XP7XHv9D82PKwvBQ93Xtn4ufsn8J/idZAYy0p1fVlxiz+TT4vmxqFovNwBT+Emef3P4DsQ3E/3zxT/HDVi6Vv7Q2SBH/lHPX5P/WcwAhFTDt33+TnU2lBY8Slh8ryv3LlAHUdf+/j18FVMgMLXWb5fJf4v9JnP5TvIfAGXe/bAp/iW0wlP+ol8HFSs9koRq6A+uy8Zc8gOoy8atZRojUy6xMEv+3NVT8cw6gulz8XINnTDzCU0x6J0OhypHAdKX0/68EwFWB1fMb8NS7XmzvpSi1A2P4Sx5Asf4D8T7joe4Jz+V/zfHPOYBS4gcrSrLHSu27v7+/dS4sf4kJbEj/WTrUcwXIL8OK6cC2xgwq0JJQMPwhAev6oQ9qQLr2d/Gr7d9/fiMP7Db+mv2vPf5j/Njf34e3r9+TX8aXor1TxSNHf/P1tRr937oExJGBdX3/+Q3evn7vLYNyPpNSLSFt/KvHh72jw+OggLUpxRKS4r/veqPtrZ2wI/5DxfEf44dp8FGy8adaAYfEo0su/zlXYLX6v0kAqSpwe3trPKaWDmzjN52vxAHUxb96fNg7Oz3v+u8W78v2Tn7bvliV5P8uxj/HAErxn8JmUkg8gmN2Dw7+WhJYav+dKwCOCvgAS+/AvllX6QMottPp1xtNZfjYd9H/muIfEg2gNv5UCYwSjz522/GU7ZR9a/TfOBNVFbAFJLYC2GtwlPP57oLQzad04NBriGq/2AEUMl0D7e+rfmQCiB0NdsD/fh1qi3+9TI4BFHMNOqS9sXUARzz62LH8nP1NL7cW/61BGVsBtcRaLpewXq/h8uLKuW9pHZjCDwUOoFT+fj2UqHce1Oy/Xlat8a+XCREDKJY/RQIz1UMXNo59/CUnsKH8Nz4HsHp82FM/NhKTgRU8ZunkOx82cDiXkFh+vRz1YxL9zynsXEtICn8Ir+34Wv3Xj6k1/vtsfT8oZWH4uS4husqnHqPk409xCVEvGyrw3/ogGEcFKE+xldiBQ57CK2kAzfUq3Jr975dTY/xzHY/lT5HAOIThLzmBDeF/skYJXbqVwpGbn2MJ2f9M/B9OL5U/9hIil6j8nJcQOVS7/zB6fpudUsxDCzlUCv+o90PwWI5S+EMl/Hn1UvlD+loKDeU/e3ZQoKan4ly3+5Ui4c8r4c8r4c+roflZC9MfrmgtLzA6Oz0HKHQ5LPx5Jfx5Jfx5lYOfzQQXvOnLDOxtiUNJ+PNK+PNK+PMqF390ARzXpnI2hPALf4yEX/hjlJs/6vcA9AdYQnV5cRV1fIyEX/hjJPzCH6MS+IMyR8pvx4fIxsJvl/D7Jfx2Cb9fJfGTVwCjg3Gn3yvLqZvrr0nK1SX8dgm/X8Jvl/D7VRp/9Hs5UihVFhZ+nITfLOHHSfjNKpEfvQIYHYy7dx/eBENRdH8H7D/SLPx4Cf+2hB8v4d9WqfxBj+QPrZjGEP54CX9eCX9evWR+kUgkEolEIpFIJBKJRCKRSCQSiUQikUgkElWk/wFLjIZEUKFiEgAAAABJRU5ErkJggg==",t0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAALpJREFUSIm9VckNwzAMq4ru4Wm8lAfIUpkmk7ivAIFrUqQe1dPmIfmQ4iVEH23u1s/jioxLAUjYMdpuqMKK0c/CThxlqGCDEZQzznixAz0BfbRZMbo5b4XQR5vVewmW/bqHMAh/HlfQCpCYU1Gw7Fl2LIknLq1gFUIVIY5lwIyQScnAiU+F5Lwsy6DSVdN/4AqvWmkF7kdbg/Yit/nZvegGofdvVVDJWOH9d+AwohLSyKwY2UNfNVLu6AtJL5wohWOTxAAAAABJRU5ErkJggg==",e0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAuhJREFUaIHtmDFo1FAYx/+1glTUxeG4o2Du4lKwS7lmkXBxER2cxAQXCS4O16FTaysULEel+5XidpvNOcpxbpcjcMJdtgpdTJNBKreKKA4SB32vaZqc1fcVj5IfhHu59/He933v+9738oCMjIyMM0VJKofsSeunnO8c5WAlqRwWZipo593U/nbeJTVigmqgklQOc5KMyalpHOx1sR+4iWMzuWHgpcr8DedFB0iDOlTSIDfgYK+LnCSn9g8Dj3Q+shBCJDwAQFPUY/0bm1WsLm/BajZIwgeUSRxVfhh4MJ2FI/0bm1X+a+gmWYiRh5CmqLAB3A2Awq4PdbYIAFhd3qKeCqA2oPHdgtk/NAIArGYDABLzgq2CSDiR1gHzggFNUbnSDEM30evsQFNUaIqKXmcHhm7C0E3hOUkNGAYerGYjVTGWB/G2CKQG5CSZbHc5KaSVmLUN3YTddzA5NQ11tgir2TiWA6weiBpMlsT7gTsR3UoZzq6PwkyF70YMi+goQRpCiHhWU1T8+PbxSJ/dd2D3HdL5TiVe40WqMFMBAL4Kdt/BO9simfvUEu5PlZYq2U9tBaK5QJWwSQgncZKn2XmftVldsJpIXBURw4Q8Elc+J8mJlZgRLXBxmX81gmQX2q4twvMHvBIDgOcPsF1b5G3PH3B5u+/g8aP7/PlvsI/325frYUkqh1HS/l9ZqocrS3X+Xlt7kXoBcBKEViC67HPVFuTiPH/mqi0ul3SUlovzAIBnz5+KqEB7nJ6rtrBw5xLqb78k9jNDWDFjRogkMfkHTeXGRdy8dgsPX75JlaG6kQD1UeLVk3vovv+aqHzc+1SQGjDK6wxK74MihPYDdwISwuvrwJW1B/z/z+uv8eHq4TGaba/U1Vh4sOhN2yjiMmORA0x5TVHh+QO08y5yksy9zpRk74ZucpmxuFb5rWC40dn5dWH1qQzg+Eowz1uBB+h19DarfAsdC0Zdp4vIZmRkZGRkZIw7PwFWwmQPmkz7+wAAAABJRU5ErkJggg==",i0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAA/pJREFUaIHtl19oW1Ucxz91QQpjT4LQ1dOGSxg1tJCEi3TM2aRV5oOQiUUd2KIwBxvrVuSywRAkUEYrQZ0KhWww2WQ6CMiYb3Omg0mCBhdI6bIS47pL9jLKQF9kFq4PN/f23iQVk3scIvf7cvI7+f3O+f0/vws+fPjw8b+AElQNmXyPFUpQNf787TmjnXLOvb/j6xZPyDroxePvQRuFVysF157FJwueDVCCqiESGp/Pjrn2mr1s0dcXJxEJTVoqBWQcoufSMDuGSGgAfHfmI9vTt+88YLVSsHlv33lg8kuClBQSCY2jn9ywaUt5Z1Sa+WWhR8YhVho58cOFtwDYM/1lC63n0tTuFqXc7RlWvitB1cjORIzy+RkjsC1g/JjXjY0/NozAtkAL/Z/pQpbnRULj8rUCJ65ullQs2seuodEtaVmQUgPXFycBCIeHZBzXEaR0ISf6QyMu+ta5wwD0bu8F4Osjw5y4Ku8+KRGYOJwFYGWlAg2le7f3ck8v8eyBj0mm8gyICAMiwvjrR2RcacNzJ3AW5PTORxxbOApAvVomenCxrcyAiEjrQp4OsYpYz6WZ3vmI1941+35/aISn46anX973JisrFcLhIddqwashXadQcyu8cP9Jkqk8yVSeerVsKx+JRAFaVqt7eW2pXRWxElQNMRiHRgeaMOsUPZdGDMZJppZcyt7TS8wvlBrSBwBIn5okKjBlc2mj20h0bICtvKLae+lTZhvVakX0tSXEYBwxGGd+4SQAe56ftXnnF04yICIuWa1WBOjKiI4MaKf8LR2iwlxRVASgry2xWikwsc8prJrKHjTJN14a5fK1gv2fMH91bIS07wHtdNZWBjYNSp+bd0eriW6W6xTdPWS1YksUrBG53aRppZhLXhI6CpezeGmkioVffv2J5S+OkUzlockQpwHa6WzL94BIaNCon05TqKMINA43ACxDrnywm+G3P+XhzbONMSLfEgU7TcCl/KbRaZyO+dcMwP3wGDQerYc3z1Kvlm3vA+ztq5N853hbI4oXD7Wc24338VLE1mXWo9UfGnEp5lTeVrLhfXUqQ71adkSt+xfZ0zRau1vsSaYwIE/x4iHbmGZcOX8G6Ldpp6FbyfxTeG6jlufUqQzJVN7OZWfKNPOrUxnUqYzXq0HWNNq2ABWVvX11m7x06auWNLHmIC8Dnedp1EmL9RLEZu1xwoK+toRYL6E/FeHDF55hfybLrqFRKSN11weM7QgYM6++wv5MlrnxGMMhBYDPvvmWG79v9DiNE+slEiNhhkMKy9VaC68XAzx/Us6Nx3j/+5+ZG4+59p3eFTsCBsBytYZzlQFPEWi3v5VHO+X34cOHDx8+fPh4DPgLH7O+nPtWwn0AAAAASUVORK5CYII=",s0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAA8lJREFUaIHtWDFoE1EY/s4USwVBsYNIF+uk6HpQ8eJlKc3gUBCC6NAtiKFLIWqFgIEqJnQp55Ch4FCxmRwcLrgkJuBw4FRpp+ISSgOKXapEEp9D73++u9wl95I2VbgPjpZ7/12/7/+/9/6/B4QIESJEiBAh/iOYAKPLb32YfE7IBJsAW4ovYHLKf31yavgiAsEE2JSeYDfiC77ZF+OGJWKk3wf/lSxLC3hiLiOrJ3zXM5Vi1+fdwuOAIstBhNTDJsCIvK5qHevPXjzA4sOXiOZSHcSI+M5sC2qsDQCwyhFceDsykJDAm1gkn6kUMVdLdZCnn9W04ci0CbCd2Rammwxz6xH+jBprY2KliZ3ZVt+WlLaQrmrI2iJqZ75Au3YRALD48KVnPJEXiV9JnsRm4ZdDiIUWzLcjTLYSUgJeNYuYs/6KiACI5g4q4d4XUYG8Gmtjs9DGleRJAHCQH1SEVB+YG01AVzVOmlBNG/hYXoeuatBVDR/L66imDU6MsFn45UleFCELKQGZShHRXIqTc4P2AezKTKw0O2K+7X73/J0wsdKU2g9SArJ6ou/TwipHUJ8fxfbWOKxyBFY5gu2tcdTnR2GVIwHe4A2pPWCf8awq3KumDURzKVy3avze9VgNGZu0rC2oKlSFXgkLXAF6kXuz1ja+YCm+wP2vqxoylSJ2ZluALQKCv0VBXve2t8YBu18EOV6lLASh0+qqhvbPumOtYtUQzaU4eQKJGFvc5YSJNN0TITa7XiL68rP7hUvxBcAeM0Tyaqzt8HcvO33b/c4r4O7Wflbqew7xywoJEMkGFeG2GwII6GsaFccKeAxw/WxcyryIIKdTzwp4ZTqrJzjprJ7ggx01OPKwSICGNqrQpctfce78WdTnRwH7kKDOLaJb9nsKcJMnsu5OTKAG597IIole47TsuB1IwIm1NUzfvYuS8jd8hjG8f/0av+/dwww7+Js00FWsWoetBp37/RDoGF2+v4eSomCGMX6VFAXL9/cccTRK6KrG4z5lnh8Fb46uAsSsreYbKCkKv1bzDR7nNUpTtZ48fXTIlJ2QamSr+QbGNvYd5EWIFoItoqQoR2Yf9NOJb149hTfJW11jMpUi4oBC1yAEe0FKwJvkLXz4/AN3Cu861tzZHxakBHgRd4OyPwipQ4cJsOnTBrudb7DKxj67nW+w6dMGo49Yj9NG18+NR4lAnVjsvH5wxwyrCl0tROTpXJ+cOiBKc5D7f4Rq2uAx/8qXO5gAY4w5bCLaxX3vcdpgjLFjsZMvZPx9XHshRIgQIY4HfwAAqOz+tklkrgAAAABJRU5ErkJggg==",n0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAQJJREFUWIXtls0NgyAUx/+0xiU6ThfoyRV6781bb3jpAF3CdIfO0gG8mjSvh0pFQATUEBp/CRHkCe+LJ0BkmPri/jqR6J8PD21+aXZrb7ApMAWTYz5FlxOq/FiemNbVZH094KysK94hIKUNu/1YlrkB4GZZZOpRGzmGhDXMB5BNzA83JgLa9o0834MxyHPMouRFGZfSZ9FPgb8CRfGzXkYLriNaCJScWCPsdgWsGCyfS2I5QATUdUQFIiKqW1B7AsS1AvolGQ8I6OppPQfoaCkTyXkAABqXfODDuDdji0X3wJzSZvz7Vd2zdNwjaQ8ICP2Nx9lyQXQPLEnQleCvPLARxAd9AZHBGwzNIwAAAABJRU5ErkJggg==",r0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAA7VJREFUWIXtl89rXFUUxz/3/ZiZxKntIgSr7ThJhErSpimChkaxVYqSlQj+QOtCjXbhHyAiLairgnTjqhIRxUWzMuLKGjShzRChqLXNTAO1SV6qMYk0STOZzHvz3r0uknmZycyb/By68cDA5d0z3/M953zvue/BPTax9sH5v15Q+fWph3pL9nfatGoHWM+MnQST9oISf18DQDQc3VD1tkUgl11Q8pceNMBoaEFNXvP31GhCbYSEKOz5elaoiV8/PKGOvH0GZ2KEUKwZzxrBwyMUay7+k24gYo8HEtmWBqavJgjFDwEglU0o1oxjJXHGCiohDOTNSyr72/dlE90ygbG0hOwdpi5/C5m7mPUxWJpDRqI+Kfvf2wihQNPIZZfK4mz5GJ55pV29cfRRJIJIzS76plwEEV7r7EBKCcCN3s850vURuVwOc3cddipB5Ng7RZhbFuHHPUPiuf2G0nWD9rP9Puhbp88BMPT+MfVY5+ukb10l2ngYMvNlcbZ1Cjo+vRxYofaz/cLuPKmijYcrYtzzQVTVUWsPdCvAP5pSgjY5jHhyVQdVq0A+eKG5t5Mlfjs6iguDlwwkwNjXDJPDmyegRhNlh8hG530lq9gCNZpQ8tZg4KiW1hW1llwlf00D9rXy5Sfv+T6BBPI9FKJ8ksqIIDzHJwogh75RuYlUYEKOtUkNOFay9HIBlB5CuFnfZ/hiD9lLX6mcnSXU0AqeWwm2yNY9BY6VxB4vEI4R9jMva56LEsGw9tgfmyPAShscKwkzFqxkDpAbv16WsFASlFeyJ6Xk+g8Xip4FtkDoIUQui9RWOTpLabAKerySqRIaOGkwwoUAZXHvb2rDm1ytYGAFjAebGO7vZVGazC1kgtwAOHjiJVJ931X0AYjUxwHoOv3Z+pNQGCbxVz9g/OIX7NkV5Z/ZzIr76u/mjxdI9vUA0Pz8y/66RO1C4EX2kLEXqdv/SPFWEAF7oFsRrUMPmQx+fY6mtieYSV0p8jnw7IsYawSXF6ARa0Fj+bi7ZpRMapD76vaiL84U3QUVCZgNbciZCTxP4C5NY6BhCIm3/L6BGT8EqnjuFArTfPjgCisXe34eOz1LreZhdrzpxw0U4c9/znOc3wk1tKDPTqHX7MVdmEN7II6WF5hScHd6ebm7HqEKggJSD6PhkhsbQSiPsFKYTxW/EW1oltsD3cp1XWobW8vuO1aS8NNdPlZ+MqZtD3NhBpG5g5SSmuPvlsTb1GWS+el8cb2FB0qn9plTVf+E+9+qZv8BLaSEjQIODXEAAAAASUVORK5CYII=",o0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAA11JREFUWIXtls1vFVUYxn/vOTO3rRITIUYTN7Iz6UpBWqMNSSHEKIZu0EQXfi0MuUBBF7b8AYQNtKOicaEsBK0mJrBADca7QZKmAXa90bAgLIwrwqYKvXfOeV3M3LkzvXM/KBoX8qzmnPN+POe87zznwH8MWTvx2e9T2vp+9/GzHev/NMy/neA+gX6QfM37Id8TYk1XP3V+4N4JBjUswIju+WmmdOnsrgj4c+BQ6yMA/FFfKV+IR+6KwEC/oQ1EnYbgGpl9IIE6HHt+nuXa+Rssz5/BOsGJgrbjhgHaNBYarrQsfZuwwpC+fGGW0UN7YYiEnLHqjCffBoEbRsRignaeEQJ96cIRpn78ABuGpT3TuwQPP6Yvfvc2187fSHbjhmjaVQ2cY3ftCKSl2LB5E7tr72Vu53YeVcGwis98nzz4CvX5b1RdXDiJniXY/8Q5mukup35oJ2xhsRp1cB4/OZ19r1y/CcDy3AKEjjC2NJ3rTaAMJhR9Zu5AIbHXvzDyAABbnnqdy1dPgwqxgzBsE1m5fpPf5r4m9uW/Zn8hEtT6ttliNcJ7nyUHuHz1NCKCmCR5I3c6GzZvwhmPCSqlPTAAAeHpqJok3xfhUSbG3ymY7NgxWxi/MDlDgzsZCeUhTNwsDd//L/AVAGr7IrwBg3Jp6fOchSf2tws+tdoxKgzj8QCMzb9JLOXC2ZdAw24EYEgbmDRgyy0byTDNkvgG025UfQQTdrLoTcCIjkV7IalEat52yd8GoXhUu18ro+/vwrvO9YGl2JiA57a9xcWlU20K0uIpjD17mAdHRjL7Wu0YE88f4OIvH2VzohbFrY8AGC4tncqOPY9a7SieGOMrhTPNJ08YOFhzCH174Mr+L9KvuIuDSatd6RmtfuIrwqBS6t0dXsWbO+kgWHN4veGBVU0EqaWIjUajQ4z660DaaeMnp7Hp1M6J8rdAC5OTM3hg+yeJGi5/uoCILbUdSIptILp1PpHixWoEvgkmzNZ9yU7yUlw/sYBq+XU88NPJgm79+GA2XqxGOBSLsm3LGyxd+RKPx2AKyX89/i2OZtc8d/fuFxR5lLEPX+1q0qp3fe4MigVfvvP1EUgfo6IGbxyj068V1urR94jeAk2VsssNeE8E8jC2U/zU31vM+/j/4W8T90THLuTz5AAAAABJRU5ErkJggg==",Tt={tsetD1:new Ft(Rw),ground:new Ft(Dw),overlay:new Ft(Fw),fence:new Ft(Mw),tree:new Ft(Bw),purpleGuy:new Ft(kw),purpleShadow:new Ft(Lw),lifebar:new Ft(Uw),buttonUp:new Ft(zw),buttonDown:new Ft(Hw),playerShadow:new Ft(Ow),swordPlayerBody:new Ft(Ww),swordPlayerHands:new Ft(Nw),swordPlayerHandArmed:new Ft(Gw),sword:new Ft(Vw),arrowPlayerBody:new Ft(Xw),arrowPlayerHands:new Ft(qw),arrowPlayerHandsArmed:new Ft(Yw),bow:new Ft(jw),arrow:new Ft(Zw),blessing:new Ft(Qw),soul:new Ft(Jw),cancel:new Ft(Kw),scale:new Ft($w),goLabel:new Ft(t0),swordPlayerIcon:new Ft(e0),bowPlayerIcon:new Ft(i0),swordPlayerIconDamaged:new Ft(s0),heart:new Ft(n0),flex:new Ft(r0),clock:new Ft(o0)},Ns=li.fromImageSource({image:Tt.scale,grid:{rows:1,columns:8,spriteHeight:48,spriteWidth:48}}),Aa=li.fromImageSource({image:Tt.cancel,grid:{rows:1,columns:2,spriteHeight:32,spriteWidth:32}});li.fromImageSource({image:Tt.tsetD1,grid:{rows:2,columns:2,spriteWidth:34,spriteHeight:17}});const sa=li.fromImageSource({image:Tt.ground,grid:{rows:10,columns:5,spriteWidth:64,spriteHeight:32}}),Qi=li.fromImageSource({image:Tt.overlay,grid:{rows:10,columns:10,spriteHeight:16,spriteWidth:16}}),Xe=li.fromImageSource({image:Tt.purpleGuy,grid:{rows:3,columns:5,spriteHeight:32,spriteWidth:32}}),G_=li.fromImageSource({image:Tt.playerShadow,grid:{rows:1,columns:1,spriteHeight:48,spriteWidth:48}}),wn=li.fromImageSource({image:Tt.swordPlayerBody,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),xn=li.fromImageSource({image:Tt.swordPlayerHands,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),bn=li.fromImageSource({image:Tt.swordPlayerHandArmed,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),Qn=li.fromImageSource({image:Tt.sword,grid:{rows:1,columns:5,spriteHeight:80,spriteWidth:80}}),yn=li.fromImageSource({image:Tt.arrowPlayerBody,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),An=li.fromImageSource({image:Tt.arrowPlayerHands,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),Cn=li.fromImageSource({image:Tt.arrowPlayerHandsArmed,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),Gr=li.fromImageSource({image:Tt.bow,grid:{rows:1,columns:4,spriteHeight:32,spriteWidth:32}}),V_=new Cw;for(let d of Object.values(Tt))V_.addResource(d);const a0=Wt.fromHex("#99e550"),h0=Wt.fromHex("#6cd705"),l0=Wt.fromHex("#ffe105"),c0=Wt.fromHex("#f5c100"),d0=Wt.fromHex("#ff2b05"),u0=Wt.fromHex("#d41c00");class X_ extends xi{constructor(t,i,n){const o=new Vs({width:26,height:1,color:a0}),h=new Vs({width:26,height:1,color:h0});super({name:"outerHealthBar",width:t.x,height:t.y,pos:i,z:1}),this.dims=t,this.position=i,this.maxVal=n,this.graphics.use(Tt.lifebar.toSprite()),this.percent=100,this.child1=new xi({name:"innerHealthBar",width:10,height:t.y,pos:new yt(3,7),z:1}),this.child2=new xi({name:"innerHealthBar2",width:10,height:t.y,pos:new yt(3,8),z:1}),this.child1.graphics.use(o),this.child2.graphics.use(h),this.addChild(this.child1),this.addChild(this.child2)}percent;child1;child2;setPercent(t){this.percent=t,this.percent<0&&(this.percent=0),this.percent>100&&(this.percent=100),this.percent<=40&&(this.child1.graphics.use(new Vs({width:26,height:1,color:l0})),this.child2.graphics.use(new Vs({width:26,height:1,color:c0}))),this.percent<=15&&(this.child1.graphics.use(new Vs({width:26,height:1,color:d0})),this.child2.graphics.use(new Vs({width:26,height:1,color:u0}))),this.child1.scale.x=this.percent/100,this.child1.scale.y=1,this.child2.scale.x=this.percent/100,this.child2.scale.y=1}}class q_ extends Wi{constructor(t){super({radius:3,pos:t,collisionType:en.Passive,collisionGroup:N_,z:1e3}),this.graphics.use(Tt.blessing.toSprite()),this.actions.repeatForever(i=>{i.moveBy({offset:nt(0,15),duration:1500,easing:ya.EaseInOutCubic}).moveBy({offset:nt(0,-15),duration:1500,easing:ya.EaseInOutCubic})})}}class Y_ extends Wi{constructor(t){super({radius:3,pos:t,collisionType:en.Passive,collisionGroup:N_,z:1e3}),this.graphics.use(Tt.soul.toSprite()),this.actions.repeatForever(i=>{i.moveBy({offset:nt(0,15),duration:1500,easing:ya.EaseInOutCubic}).moveBy({offset:nt(0,-15),duration:1500,easing:ya.EaseInOutCubic})})}}class j_ extends jc{_heldKeys=[];_keyEnable=!1;constructor(){super()}onAdd(t){this.owner=t}init(){window.addEventListener("keydown",t=>{if(!this._heldKeys.includes(t.key)){if(!this.keyEnable)return;this._heldKeys.push(t.key)}}),window.addEventListener("keyup",t=>{this.keyEnable||(this.keyEnable=!0);const i=this._heldKeys.indexOf(t.key);i>-1&&this._heldKeys.splice(i,1)})}get keys(){return this._heldKeys}set keyEnable(t){this._keyEnable=t}get keyEnable(){return this._keyEnable}onRemove(t){window.removeEventListener("keydown",this.init),window.removeEventListener("keyup",this.init)}update(t,i){}}class gi{controller;signalName;sender;callback;constructor(t,i){this.signalName=t,i?this.sender=i:this.sender=""}send(t){let i;t?i=new CustomEvent(this.signalName,{detail:{who:this.sender,params:[...t]}}):i=new CustomEvent(this.signalName,{detail:{who:this.sender}}),document.dispatchEvent(i)}listen(t){this.callback=t,this.controller=new AbortController,document.addEventListener(this.signalName,i=>{this.callback&&this.callback(i)},{signal:this.controller.signal})}stopListening(){this.controller&&this.controller.abort(),this.controller=null}}class fo extends jc{type="animation";currentName="";_currentAnimationName=null;_animations;_speed=1;_frameDuration=new WeakMap;constructor(t){super(),this._animations=t}set(t,i=0,n){const o=this.owner.graphics.current;this.currentName=t;const h=this._animations[t];this.is(t)||(i?h.goToFrame(i,n):h.reset(),o&&(h.scale.setTo(o.scale.x,o.scale.y),h.opacity=o.opacity),this.owner.graphics.use(h))}reset(){const t=this._animations[this.currentName];t.goToFrame(0),t.reset()}tint(t){this.current!==void 0&&(t===null?this.current.tint=Wt.White:this.current.tint=t)}get(t){return this._animations[t]}get current(){return this.owner.graphics.current}get currentFrame(){return this._animations[this.currentName].currentFrameIndex}is(t){return this.get(this._currentAnimationName)===this.get(t)}set speed(t){this._speed=t}get speed(){return this._speed}}const oi=75,rr=450,f0=50,_0=50,g0=50,p0=50,m0=50,Z_=new Ue({strategy:ze.Loop,frames:[{graphic:wn.getSprite(0,0),duration:rr},{graphic:wn.getSprite(1,0),duration:rr}]}),Q_=Z_.clone();Q_.flipHorizontal=!0;const J_=new Ue({strategy:ze.Loop,frames:[{graphic:wn.getSprite(2,0),duration:oi},{graphic:wn.getSprite(3,0),duration:oi},{graphic:wn.getSprite(4,0),duration:oi},{graphic:wn.getSprite(5,0),duration:oi},{graphic:wn.getSprite(6,0),duration:oi}]}),K_=J_.clone();K_.flipHorizontal=!0;const $_=new Ue({strategy:ze.Loop,frames:[{graphic:xn.getSprite(0,0),duration:rr},{graphic:xn.getSprite(1,0),duration:rr}]}),tg=$_.clone();tg.flipHorizontal=!0;const eg=new Ue({strategy:ze.Loop,frames:[{graphic:xn.getSprite(2,0),duration:oi},{graphic:xn.getSprite(3,0),duration:oi},{graphic:xn.getSprite(4,0),duration:oi},{graphic:xn.getSprite(5,0),duration:oi},{graphic:xn.getSprite(6,0),duration:oi}]}),ig=eg.clone();ig.flipHorizontal=!0;const sg=new Ue({strategy:ze.Loop,frames:[{graphic:bn.getSprite(0,0),duration:rr},{graphic:bn.getSprite(1,0),duration:rr}]}),ng=sg.clone();ng.flipHorizontal=!0;const rg=new Ue({strategy:ze.Loop,frames:[{graphic:bn.getSprite(2,0),duration:oi},{graphic:bn.getSprite(3,0),duration:oi},{graphic:bn.getSprite(4,0),duration:oi},{graphic:bn.getSprite(5,0),duration:oi},{graphic:bn.getSprite(6,0),duration:oi}]}),og=rg.clone();og.flipHorizontal=!0;const ag=new Ue({strategy:ze.End,frames:[{graphic:Qn.getSprite(0,0),duration:f0},{graphic:Qn.getSprite(1,0),duration:_0},{graphic:Qn.getSprite(2,0),duration:g0},{graphic:Qn.getSprite(3,0),duration:p0},{graphic:Qn.getSprite(4,0),duration:m0}]}),hg=ag.clone();hg.flipHorizontal=!0;class lg extends Wi{ac;_directionfacing="Right";animationSet;_walkState="idle";_attackState="Normal";_oldStates="idleNormalRight";_currentStates="idleNormalRight";constructor(t){super({width:19,height:30,z:1001}),this.animationSet=t}onInitialize(t){this.ac=new fo(this.animationSet),this.addComponent(this.ac),this.ac.set("idleNormalRight"),this._oldStates="idleNormalRight",this._currentStates="idleNormalRight"}set direction(t){this.ac&&(this._directionfacing=t,this._currentStates=this._walkState+this._attackState+this._directionfacing)}set attackState(t){this.ac&&(this._attackState=t,this._currentStates=this._walkState+this._attackState+this._directionfacing)}set walkState(t){this.ac&&(this._walkState=t,this._currentStates=this._walkState+this._attackState+this._directionfacing)}onPreUpdate(t,i){this.ac&&this._oldStates!==this._currentStates&&(this._oldStates=this._currentStates,this.ac.set(this._currentStates))}}const v0=300;class w0 extends Wi{damage;UISignal=new gi("stateUpdate");constructor(t,i,n){super({width:16,height:4,rotation:0,pos:t,anchor:yt.Half,z:1001,collisionType:en.Passive,collisionGroup:Zc}),this.damage=n,this.vel=i.pos.sub(this.pos).normalize().scale(v0),this.rotation=this.vel.toAngle(),this.graphics.use(Tt.arrow.toSprite())}onInitialize(t){this.events.on("exitviewport",()=>{this.kill()})}onCollisionStart(t,i,n,o){if(i.owner instanceof ar){const h=i.owner;this.UISignal.send(["enemyDefeated",h.affinity]),h.checkDrop(),h.pain("arrow");const c=this.scene?.engine;c&&c.clock.schedule(()=>{},1e3)}}}class x0 extends Wi{ac;directionfacing="Right";state="attack";animationSet;resetCallback=void 0;constructor(t,i,n){super({z:1001,collisionType:en.Passive,collisionGroup:Zc}),this.resetCallback=n,this.directionfacing=i,this.pos=nt(0,0),this.animationSet=t,this.animationSet.attackLeft.events.on("end",()=>{this.resetCallback&&this.resetCallback(),this.kill()}),this.animationSet.attackRight.events.on("end",()=>{this.resetCallback&&this.resetCallback(),this.kill()})}onInitialize(t){this.ac=new fo(this.animationSet),this.addComponent(this.ac);const i=this.state+this.directionfacing;this.ac.set(i)}get animationframe(){return this.ac?.currentFrame}onPreUpdate(t,i){}}const ai=75,or=150,b0=750,y0=100,A0=100,C0=700,cg=new Ue({strategy:ze.Loop,frames:[{graphic:yn.getSprite(0,0),duration:or},{graphic:yn.getSprite(1,0),duration:or}]}),dg=cg.clone();dg.flipHorizontal=!0;const ug=new Ue({strategy:ze.Loop,frames:[{graphic:yn.getSprite(2,0),duration:ai},{graphic:yn.getSprite(3,0),duration:ai},{graphic:yn.getSprite(4,0),duration:ai},{graphic:yn.getSprite(5,0),duration:ai},{graphic:yn.getSprite(6,0),duration:ai}]}),fg=ug.clone();fg.flipHorizontal=!0;const _g=new Ue({strategy:ze.Loop,frames:[{graphic:An.getSprite(0,0),duration:or},{graphic:An.getSprite(1,0),duration:or}]}),gg=_g.clone();gg.flipHorizontal=!0;const pg=new Ue({strategy:ze.Loop,frames:[{graphic:An.getSprite(2,0),duration:ai},{graphic:An.getSprite(3,0),duration:ai},{graphic:An.getSprite(4,0),duration:ai},{graphic:An.getSprite(5,0),duration:ai},{graphic:An.getSprite(6,0),duration:ai}]}),mg=pg.clone();mg.flipHorizontal=!0;const vg=new Ue({strategy:ze.Loop,frames:[{graphic:Cn.getSprite(0,0),duration:or},{graphic:Cn.getSprite(1,0),duration:or}]}),wg=vg.clone();wg.flipHorizontal=!0;const xg=new Ue({strategy:ze.Loop,frames:[{graphic:Cn.getSprite(2,0),duration:ai},{graphic:Cn.getSprite(3,0),duration:ai},{graphic:Cn.getSprite(4,0),duration:ai},{graphic:Cn.getSprite(5,0),duration:ai},{graphic:Cn.getSprite(6,0),duration:ai}]}),bg=xg.clone();bg.flipHorizontal=!0;const yg=new Ue({strategy:ze.End,frames:[{graphic:Gr.getSprite(0,0),duration:b0},{graphic:Gr.getSprite(1,0),duration:y0},{graphic:Gr.getSprite(2,0),duration:A0},{graphic:Gr.getSprite(3,0),duration:C0}]}),Ag=yg.clone();Ag.flipHorizontal=!0;class Cg extends Wi{currentHP=20;maxHP=20;exp=0;isPlayerActive=!1;jc=new O_;kc=new j_;ac=new fo({idleLeft:dg,idleRight:cg,walkLeft:fg,walkRight:ug});partner;HealthBar;fireIntervalHandler;isJoystickActive=!0;isKeyboardActive=!1;UISignal=new gi("stateUpdate");gamePausedSignal=new gi("pauseGame");directionFacing="Right";isWalking=!1;oldXVelocity=0;oldDirectionFacing="Right";weaponChild;closestEnemy;handChild=new lg({idleNormalLeft:gg,idleNormalRight:_g,walkNormalLeft:mg,walkNormalRight:pg,idleAttackLeft:wg,idleAttackRight:vg,walkAttackLeft:bg,walkAttackRight:xg});speed=100;fireInterval=3e3;fireRange=100;fireDamage=1;isFiring=!1;isWaveActive=!1;constructor(){super({radius:10,color:Wt.White,pos:nt(0,0),anchor:yt.Half,z:1e3,collisionType:en.Active,collisionGroup:W_}),this.addComponent(this.ac),this.ac.set("idleRight"),this.HealthBar=new X_(new yt(32,16),new yt(-16,-32),20),this.addChild(this.HealthBar),this.handChild.walkState="idle",this.handChild.attackState="Normal",this.handChild.direction="Right",this.addChild(this.handChild),this.fireIntervalHandler=setInterval(this.fire.bind(this),this.fireInterval);const t=new Wi({width:48,height:48});t.graphics.use(G_.sprites[0]),this.addChild(t),this.gamePausedSignal.listen(i=>{console.log("game paused",i.detail.params[0]),this.isWaveActive=!i.detail.params[0]})}onInitialize(t){this.kc.init()}onCollisionStart(t,i,n,o){i.owner instanceof q_&&(i.owner.kill(),this.UISignal.send(["blessing"]),this.exp+=1)}get direction(){return this.directionFacing}registerPartner(t){this.partner=t,this.pos=t.pos.clone().add(nt(0,-50))}fire(){if(!this.isWaveActive)return;let t=this.scene?.entities.filter(o=>o instanceof ar),i,n=1/0;for(const o of t){let h=o,c=this.pos.distance(h.pos);c<n&&(n=c,i=h)}i&&(this.closestEnemy=i,this.weaponChild=new x0({attackLeft:Ag,attackRight:yg},this.directionFacing,this.releaseWeapon),this.addChild(this.weaponChild),this.isFiring=!0,this.handChild.attackState="Attack")}releaseWeapon=()=>{this.handChild.attackState="Normal"};disableTouch(){this.removeComponent(this.jc)}enableTouch(){this.addComponent(this.jc)}joystickCallback=t=>{!this.isPlayerActive||!this.isJoystickActive||(t.state==="active"?(t.direction.x<0?this.directionFacing="Left":this.directionFacing="Right",this.vel.x=t.direction.x*this.speed,this.vel.y=t.direction.y*this.speed,this.isWalking===!1&&(this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`))):(this.vel.x=0,this.vel.y=0,this.isWalking===!0&&(this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))))};onPreUpdate(t,i){if(!this.isWaveActive)return;if(this.isFiring&&this.closestEnemy&&this.weaponChild&&this.weaponChild.animationframe==1){let c=new w0(this.pos,this.closestEnemy,this.fireDamage);this.scene?.add(c),this.closestEnemy=void 0,this.isFiring=!1}const o=this.actions.getQueue().getActions().find(h=>h instanceof z_);if(!this.isPlayerActive&&this.partner&&this.partner.pos.distance(this.pos)>25&&!o?this.actions.follow(this.partner,50):this.isPlayerActive&&o&&this.actions.clearActions(),!this.isPlayerActive){let h=!1;this.partner.isWalking&&this.isWalking===!1?(this.isWalking=!0,h=!0):!this.partner.isWalking&&this.isWalking===!0&&(this.isWalking=!1,h=!0),this.partner.directionFacing!=this.directionFacing&&(this.directionFacing=this.partner.directionFacing,this.handChild.direction=this.directionFacing,h=!0),h&&(this.isWalking?this.ac.set(`walk${this.directionFacing}`):this.ac.set(`idle${this.directionFacing}`))}if(this.HealthBar?.setPercent(this.currentHP/this.maxHP*100),this.kc.keyEnable&&(this.isKeyboardActive=!0,this.isJoystickActive=!1),this.isPlayerActive&&this.isKeyboardActive){let h=this.kc.keys;h.includes("ArrowLeft")?this.vel.x=-this.speed:h.includes("ArrowRight")&&(this.vel.x=this.speed),h.includes("ArrowUp")?this.vel.y=-this.speed:h.includes("ArrowDown")&&(this.vel.y=this.speed),!h.includes("ArrowLeft")&&!h.includes("ArrowRight")&&(this.vel.x=0),!h.includes("ArrowUp")&&!h.includes("ArrowDown")&&(this.vel.y=0),this.vel.x!=0||this.vel.y!=0?this.isWalking===!1?(this.vel.x>0?this.directionFacing="Right":this.directionFacing="Left",this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`)):this.oldXVelocity<0&&this.vel.x>0?(this.directionFacing="Right",this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`),this.handChild.direction=this.directionFacing):this.oldXVelocity>0&&this.vel.x<0&&(this.directionFacing="Left",this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`),this.handChild.direction=this.directionFacing):this.isWalking===!0&&(console.log("setting idle animatino"),this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))}this.currentHP<=0&&(this.isPlayerActive&&this.scene.switchPlayerFocus(),this.fireIntervalHandler&&clearInterval(this.fireIntervalHandler),this.kill())}}const S0=new Ue({strategy:ze.Loop,frames:[{graphic:Xe.getSprite(0,0),duration:100},{graphic:Xe.getSprite(1,0),duration:100},{graphic:Xe.getSprite(2,0),duration:100},{graphic:Xe.getSprite(3,0),duration:100},{graphic:Xe.getSprite(4,0),duration:100}]}),P0=new Ue({strategy:ze.End,frames:[{graphic:Xe.getSprite(0,1),duration:100},{graphic:Xe.getSprite(1,1),duration:100},{graphic:Xe.getSprite(2,1),duration:100},{graphic:Xe.getSprite(3,1),duration:100},{graphic:Xe.getSprite(4,1),duration:100}]}),T0=new Ue({strategy:ze.End,frames:[{graphic:Xe.getSprite(0,2),duration:100},{graphic:Xe.getSprite(1,2),duration:100},{graphic:Xe.getSprite(2,2),duration:100},{graphic:Xe.getSprite(3,2),duration:100},{graphic:Xe.getSprite(4,2),duration:100}]});function E0(d){const t={fragmentSource:`#version 300 es
    precision mediump float;

    in vec2 v_uv;
    out vec4 fragColor;

    uniform vec2 u_graphic_resolution;
    uniform sampler2D u_graphic;

    // Inigo Quilez pixel-art UV snapping
    vec2 uv_iq(in vec2 uv, in vec2 texture_size) {
      vec2 pixel = uv * texture_size;
      vec2 seam = floor(pixel + 0.5);
      vec2 dudv = fwidth(pixel);
      pixel = seam + clamp((pixel - seam) / dudv, -0.5, 0.5);
      return pixel / texture_size;
    }

    void main() {
      vec2 newUv = uv_iq(v_uv, u_graphic_resolution);
      vec4 texColor = texture(u_graphic, newUv);

      if (texColor.a < 0.01) {
        discard; // respect alpha mask
      }

      fragColor = vec4(1.0, 1.0, 1.0, texColor.a);
    }
  `};return d.graphicsContext.createMaterial(t)}const ju=(d,t,i,n)=>{t.graphics.material=E0(d),d.clock.schedule(()=>{t.graphics.material=null,n&&n()},i)},ul=25,fl=new gr(Date.now()),I0=new U_({radius:7.5,color:Wt.Red,strokeColor:Wt.fromHex("#000000"),lineWidth:2}),R0=new U_({radius:7.5,color:Wt.Red,strokeColor:Wt.fromHex("#FFFFFF"),lineWidth:2});class ar extends Wi{affinity="dark";state="default";lightTarget;darkTarget;currentTarget=void 0;graphic;UISignal=new gi("stateUpdate");swordDeathAnimation=P0.clone();arrowDeathAnimation=T0.clone();constructor(t,i,n){super({radius:7.5,pos:t,anchor:yt.Half,z:1e3,collisionType:en.Active,collisionGroup:Iw});const o=Math.floor(Math.random()*5),h=S0.clone();h.goToFrame(o);const c=new Ys({useAnchor:!0,members:[{graphic:Tt.purpleShadow.toSprite(),offset:nt(0,0)},{graphic:h,offset:nt(0,0)}]});this.graphic=c,this.lightTarget=i,this.darkTarget=n,this.graphics.use(this.graphic),fl.bool()?(this.affinity="light",this.graphic.tint=Wt.fromHex("#888888").lighten(.9)):this.graphic.tint=Wt.fromHex("#888888").darken(.1)}onCollisionStart(t,i,n,o){if(this.state!=="death"&&(i.owner instanceof Nl||i.owner instanceof Cg)){this.scene.enemyWaveManager?.enemyPool?.return(this),this.scene?.remove(this),i.owner.currentHP-=2;const h=i.owner.scene?.engine;h&&ju(h,i.owner,150),this.UISignal.send(["playerDamaged"])}}onInitialize(){this.swordDeathAnimation.events.on("end",()=>{this.kill()}),this.arrowDeathAnimation.events.on("end",()=>{this.kill()})}reset(){this.graphics.getNames().forEach(i=>this.graphics.remove(i)),fl.bool()?(this.affinity="light",this.graphics.add(R0)):(this.affinity="dark",this.graphics.add(I0))}checkDrop(){if(fl.integer(0,100)<40){if(!this.scene)return;this.affinity=="dark"?this.scene.add(new Y_(this.pos)):this.scene.add(new q_(this.pos))}}pain(t){this.actions.clearActions(),this.state="death",this.collider.clear();const i=this.scene?.engine;i&&ju(i,this,300,()=>{this.graphic.members[1]=t==="sword"?this.swordDeathAnimation:this.arrowDeathAnimation})}onPreUpdate(t,i){if(this.state==="death")return;this.graphics.use(this.graphic);const o=this.actions.getQueue().getActions().find(c=>c instanceof Sw);let h;if(o)this.scene?.entities?.find(p=>p==this.currentTarget)||(this.lightTarget&&this.darkTarget?h=this.lightTarget.pos.distance(this.pos)<this.darkTarget.pos.distance(this.pos)?this.lightTarget:this.darkTarget:this.lightTarget?h=this.lightTarget:h=this.darkTarget,this.currentTarget=h,this.actions.clearActions(),this.actions.meet(h,ul));else{if(this.lightTarget&&this.darkTarget?h=this.lightTarget.pos.distance(this.pos)<this.darkTarget.pos.distance(this.pos)?this.lightTarget:this.darkTarget:this.lightTarget?h=this.lightTarget:this.darkTarget&&(h=this.darkTarget),!h)return;this.currentTarget=h,this.actions.meet(h,ul)}if(this.lightTarget&&this.darkTarget){let c=this.lightTarget.pos.distance(this.pos)<this.darkTarget.pos.distance(this.pos)?this.lightTarget:this.darkTarget;this.actions.meet(c,ul)}}}class D0 extends Wi{ac;directionfacing="Right";state="attack";animationSet;resetCallback=void 0;leftVector=nt(-25,0);rightVector=nt(25,0);UISignal=new gi("stateUpdate");isColliding=!1;others=[];constructor(t,i,n){super({width:42,height:30,z:1001,collisionType:en.Passive,collisionGroup:Zc}),this.resetCallback=n,this.directionfacing=i,this.directionfacing=="Left"?this.pos=this.leftVector:this.pos=this.rightVector,this.pos=this.rightVector,this.animationSet=t,this.animationSet.attackLeft.events.on("end",()=>{this.resetCallback&&this.resetCallback(),this.kill()}),this.animationSet.attackRight.events.on("end",()=>{this.resetCallback&&this.resetCallback(),this.kill()})}onInitialize(t){this.directionfacing=="Left"?this.pos=this.leftVector:this.pos=this.rightVector,this.ac=new fo(this.animationSet),this.addComponent(this.ac);const i=this.state+this.directionfacing;this.ac.set(i)}onCollisionStart(t,i,n,o){i.owner instanceof ar&&(this.isColliding=!0,this.others.push(i.owner))}onCollisionEnd(t,i,n,o){if(i.owner instanceof ar){let h=this.others.findIndex(c=>c==i.owner);h!=-1&&this.others.splice(h,1),this.others.length==0&&(this.isColliding=!1)}}onPreUpdate(t,i){this.isColliding&&this.ac?.currentFrame==2&&this.others.forEach(n=>{this.UISignal.send(["enemyDefeated",n.affinity]),n.checkDrop(),n.pain("sword"),t.clock.schedule(()=>{},1e3)})}}class Nl extends Wi{currentHP=20;maxHP=20;isPlayerActive=!0;partner;isWalking=!1;oldXVelocity=0;jc=new O_;kc=new j_;ac=new fo({idleLeft:Q_,idleRight:Z_,walkLeft:K_,walkRight:J_});directionFacing="Right";handChild=new lg({idleNormalLeft:tg,idleNormalRight:$_,walkNormalLeft:ig,walkNormalRight:eg,idleAttackLeft:ng,idleAttackRight:sg,walkAttackLeft:og,walkAttackRight:rg});HealthBar;speed=80;exp=0;fireIntervalHandler;fireInterval=1e3;fireDamage=3;isJoystickActive=!0;isKeyboardActive=!1;UISignal=new gi("stateUpdate");gamePausedSignal=new gi("pauseGame");oldDirectionFacing="Right";isWaveActive=!1;constructor(){super({width:19,height:30,pos:nt(0,0),anchor:yt.Half,z:1001,collisionType:en.Active,collisionGroup:W_}),this.addComponent(this.ac),this.ac.set("idleRight"),this.HealthBar=new X_(new yt(32,16),new yt(-16,-32),20),this.addChild(this.HealthBar),this.fireIntervalHandler=setInterval(this.fire.bind(this),this.fireInterval),this.handChild.walkState="idle",this.handChild.attackState="Normal",this.handChild.direction="Right",this.addChild(this.handChild);const t=new Wi({width:48,height:48});t.graphics.use(G_.sprites[0]),this.addChild(t),this.gamePausedSignal.listen(i=>{console.log("darkplayer getting game paused"),this.isWaveActive=!i.detail.params[0]})}onInitialize(t){this.kc.init(),this.scene&&(this.scene.camera.strategy.lockToActor(this),this.scene.camera.zoom=1.5)}onCollisionStart(t,i,n,o){i.owner instanceof Y_&&(this.exp+=1,this.UISignal.send(["soul"]),i.owner.kill())}registerPartner(t){this.partner=t}get direction(){return this.directionFacing}disableTouch(){this.removeComponent(this.jc,!0)}enableTouch(){this.addComponent(this.jc,!0)}joystickCallback=t=>{!this.isPlayerActive||!this.isJoystickActive||(t.state==="active"?(t.direction.x<0?this.directionFacing="Left":this.directionFacing="Right",this.vel.x=t.direction.x*this.speed,this.vel.y=t.direction.y*this.speed,this.isWalking===!1&&(this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`))):(this.vel.x=0,this.vel.y=0,this.isWalking===!0&&(this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))))};fire(){this.isWaveActive&&(this.addChild(new D0({attackLeft:hg,attackRight:ag},this.directionFacing,this.releaseWeapon)),this.handChild.attackState="Attack",this.handChild.direction=this.directionFacing)}releaseWeapon=()=>{this.handChild.attackState="Normal"};onPreUpdate(t,i){if(!this.isWaveActive)return;const o=this.actions.getQueue().getActions().find(h=>h instanceof z_);if(!this.isPlayerActive&&this.partner&&this.partner.pos.distance(this.pos)>25&&!o?this.actions.follow(this.partner,50):this.isPlayerActive&&o&&this.actions.clearActions(),!this.isPlayerActive){let h=!1;this.partner.isWalking&&this.isWalking===!1?(this.isWalking=!0,h=!0):!this.partner.isWalking&&this.isWalking===!0&&(this.isWalking=!1,h=!0),this.partner.directionFacing!=this.directionFacing&&(this.directionFacing=this.partner.directionFacing,this.handChild.direction=this.directionFacing,h=!0),h&&(this.isWalking?this.ac.set(`walk${this.directionFacing}`):this.ac.set(`idle${this.directionFacing}`))}if(this.HealthBar?.setPercent(this.currentHP/this.maxHP*100),this.kc.keyEnable&&(this.isKeyboardActive=!0,this.isJoystickActive=!1),this.isPlayerActive&&this.isKeyboardActive){let h=this.kc.keys;h.includes("ArrowLeft")?this.vel.x=-this.speed:h.includes("ArrowRight")&&(this.vel.x=this.speed),h.includes("ArrowUp")?this.vel.y=-this.speed:h.includes("ArrowDown")&&(this.vel.y=this.speed),!h.includes("ArrowLeft")&&!h.includes("ArrowRight")&&(this.vel.x=0),!h.includes("ArrowUp")&&!h.includes("ArrowDown")&&(this.vel.y=0),this.vel.x!=0||this.vel.y!=0?this.isWalking===!1?(this.vel.x>0?this.directionFacing="Right":this.vel.x<0&&(this.directionFacing="Left"),this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`)):this.oldXVelocity<0&&this.vel.x>0?(this.directionFacing="Right",this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`)):this.oldXVelocity>0&&this.vel.x<0&&(this.directionFacing="Left",this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`)):this.isWalking===!0&&(this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))}this.currentHP<=0&&(this.isPlayerActive&&this.scene.switchPlayerFocus(),this.fireIntervalHandler&&clearInterval(this.fireIntervalHandler),this.kill())}}class F0{constructor(t,i,n=1){this.builder=t,this.cleaner=i,this.grow(n)}_pool=[];_size=0;grow(t){if(t>0){this._size+=t;for(let i=0;i<t;i++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}}function Sg(d,t,i){const n=d%t,o=Math.floor(d/t);return n===0||n===t-1||o===0||o===i-1}function M0(d,t,i){const n=d%t,o=Math.floor(d/t);return n===1||n===t-2||o===1||o===i-2}function B0(d){return Math.floor(55+d*25)}function k0(d){const t=Math.max(3,Math.floor(d/15));let i=Array.from({length:t},(_,p)=>p+1);const n=i.reduce((_,p)=>_+p,0);let o=i.map(_=>Math.floor(_/n*d)),h=o.reduce((_,p)=>_+p,0),c=d-h;for(;c!==0;)for(let _=o.length-1;_>=0&&c!==0;_--)o[_]+=c>0?1:-1,c+=c>0?-1:1;return o}function L0(d){return nt(0,d.rows*d.tileHeight/2)}class U0{rng=new gr(Date.now());getSpawnPositions(t,i){console.log("random");let n=[];for(let o=0;o<t;o++){let h=this.getRandomTile(i);n.push({x:h.x,y:h.y})}return n}getRandomTile(t){let i=t.columns*t.rows,n=this.rng.integer(0,i-1);for(;Sg(n,t.columns,t.rows);)n=this.rng.integer(0,i-1);return t.tiles[n].pos.clone()}}class z0{getSpawnPositions(t,i){console.log("circle");let n=i.columns,o=i.rows;const h=Math.ceil(n/2),c=Math.ceil(o/2),_=n/2-2;let p=[];for(let v=0;v<t;v++){const x=2*Math.PI*v/t,b=Math.floor(h+Math.cos(x)*_),P=Math.floor(c+Math.sin(x)*_)*n+b,I=i.tiles[P].pos.clone();p.push({x:I.x,y:I.y})}return p}}class H0{rng=new gr(Date.now());getSpawnPositions(t,i){console.log("edges");const n=[],o=i.tiles.filter((h,c)=>M0(c,i.columns,i.rows));for(let h=0;h<t;h++){const c=this.rng.pickOne(o);c&&n.push({x:c.pos.x,y:c.pos.y})}return n}}class O0{rng=new gr;getSpawnPositions(t,i){console.log("cluster");const n=[],o={tl:{x:Math.floor(i.columns/4),y:Math.floor(i.rows/4)},tr:{x:Math.floor(i.columns/4)*3,y:Math.floor(i.rows/4)},bl:{x:Math.floor(i.columns/4),y:Math.floor(i.rows/4)*3},br:{x:Math.floor(i.columns/4)*3,y:Math.floor(i.rows/4)*3}},h=["tl","tr","bl","br"],c=this.rng.pickOne(h),_=o[c],p=_.x,v=_.y,x=Math.floor(Math.sqrt(i.tiles.length)/4);for(let b=0;b<t;b++){let S=this.rng.integer(-x/2,x/2),P=this.rng.integer(-x/2,x/2),I=p+S;const R=(v+P)*i.columns+I,T=i.tiles[R];T&&n.push({x:T.pos.x,y:T.pos.y})}return n}}let Zu=18e3,W0=5;const N0={RANDOM:"RANDOM"},_l={RANDOM:new U0,CIRCLE:new z0,EDGES:new H0,CLUSTER:new O0};class G0{enemyPool;rng;lightPlayer;darkPlayer;spawnInterval=Zu;spawnEnabled=!1;scene;stateSignal=new gi("stateUpdate");burnDown=new gi("burnDown");gamePausedSignal=new gi("pauseGame");map;enemyCount=0;waveNumber=0;batchSize=[];batchIndex=0;spawnStrategy=N0.RANDOM;lastBatchSpawnedFlag=!1;endOfWaveInterval;monitorSpawning=!1;WaveTimer;isWaveActive=!1;duration=0;isStartDelayConsumed=!1;constructor(t,i,n,o){this.rng=new gr(Date.now()),this.lightPlayer=i,this.darkPlayer=n,this.scene=t,this.map=o,this.WaveTimer=setInterval(this.waveTik,1e3),this.endOfWaveInterval=setInterval(this.endOfWave,1e3)}endOfWave=()=>{this.monitorSpawning&&this.lastBatchSpawnedFlag&&this.scene.entities.filter(n=>n instanceof ar).length==0&&(this.isWaveActive=!1,this.monitorSpawning=!1,this.endWave())};init(){this.enemyPool=new F0(this.makeEnemy,this.cleanUpEnemy,500),this.isWaveActive=!1}waveTik=()=>{this.isWaveActive&&(this.duration+=1,!this.isStartDelayConsumed&&this.duration>=W0&&(this.isStartDelayConsumed=!0,this.spawnEnemies()),this.isStartDelayConsumed&&(this.stateSignal.send(["waveDuration",this.duration]),this.burnDown.send()))};startWave(){this.waveNumber+=1,this.isWaveActive=!0,this.spawnEnabled=!0,this.duration=0,this.isStartDelayConsumed=!1,this.enemyCount=B0(this.waveNumber),this.batchSize=k0(this.enemyCount),this.lastBatchSpawnedFlag=!1,this.batchIndex=0,this.monitorSpawning=!1,this.stateSignal.send(["batchsize",this.enemyCount]),this.spawnStrategy=this.rng.pickOne(Object.keys(_l)),this.gamePausedSignal.send([!1])}endWave(){this.spawnEnabled=!1,this.isWaveActive=!1,this.duration=0,this.isStartDelayConsumed=!1,this.scene.showEndOfWaveModal(),this.gamePausedSignal.send([!0])}spawnEnemies(){let t=_l[this.spawnStrategy].getSpawnPositions(this.batchSize[this.batchIndex],this.map);this.batchIndex+=1,this.spawnStrategy=this.rng.pickOne(Object.keys(_l)),this.batchIndex==this.batchSize.length&&(this.lastBatchSpawnedFlag=!0);for(let i=0;i<t.length;i++){let n=t[i];if(n===void 0)continue;let o=this.map?.tiles.find(c=>c.pos.x===n.x&&c.pos.y===n.y);if(!o)continue;let h=this.enemyPool?.rent(!0);h.pos=o.pos.clone(),this.scene.add(h),this.monitorSpawning=!0}}makeEnemy=()=>new ar(nt(0,0),this.lightPlayer,this.darkPlayer);cleanUpEnemy(t){return t.reset(),t}update(t){this.spawnEnabled&&this.isStartDelayConsumed&&(this.spawnInterval-=t,this.spawnInterval<=0&&(this.spawnInterval=Zu,this.spawnEnemies()))}}class V0 extends xi{constructor(t,i,n,o){const h=new Vs({width:t.x,height:t.y,color:Wt.Green}),c=new Vs({width:t.x,height:t.y,color:Wt.Red});super({name:"burnDownBar",width:t.x,height:t.y,pos:i,z:1001,opacity:.7}),this.dims=t,this.position=i,this.graphics.use(c),this.percent=n,this.scene=o,this.currentVal=n,this.maxVal=n,this.child=new xi({name:"innerHealthBar",width:t.x,height:t.y,pos:new yt(0,0),z:1}),this.child.graphics.use(h),this.addChild(this.child),this.burnDownSignal.listen(()=>{this.currentVal--,this.percent=this.currentVal/this.maxVal*100,this.percent<0&&(this.percent=0),this.percent>100&&(this.percent=100),this.child.scale.x=this.percent/100,this.child.scale.y=1,this.percent<=0&&(this.scene.switchPlayerFocus(),this.currentVal=this.maxVal,this.percent=100,this.child.scale.x=this.percent/100,this.child.scale.y=1)})}burnDownSignal=new gi("burnDown");currentVal;maxVal;percent;child;scene}var gl={exports:{}},pl={exports:{}};/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var Qu;function X0(){return Qu||(Qu=1,function(d,t){(function(n,o){d.exports=o()})(self,()=>(()=>{var i={851:(u,e,s)=>{s.d(e,{A:()=>m});var r=s(1),a=s.n(r),l=s(935),f=s.n(l),g=f()(a());g.push([u.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const m=g},296:(u,e,s)=>{s.d(e,{A:()=>m});var r=s(1),a=s.n(r),l=s(935),f=s.n(l),g=f()(a());g.push([u.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const m=g},935:u=>{u.exports=function(e){var s=[];return s.toString=function(){return this.map(function(a){var l="",f=typeof a[5]<"u";return a[4]&&(l+="@supports (".concat(a[4],") {")),a[2]&&(l+="@media ".concat(a[2]," {")),f&&(l+="@layer".concat(a[5].length>0?" ".concat(a[5]):""," {")),l+=e(a),f&&(l+="}"),a[2]&&(l+="}"),a[4]&&(l+="}"),l}).join("")},s.i=function(a,l,f,g,m){typeof a=="string"&&(a=[[null,a,void 0]]);var w={};if(f)for(var y=0;y<this.length;y++){var A=this[y][0];A!=null&&(w[A]=!0)}for(var E=0;E<a.length;E++){var D=[].concat(a[E]);f&&w[D[0]]||(typeof m<"u"&&(typeof D[5]>"u"||(D[1]="@layer".concat(D[5].length>0?" ".concat(D[5]):""," {").concat(D[1],"}")),D[5]=m),l&&(D[2]&&(D[1]="@media ".concat(D[2]," {").concat(D[1],"}")),D[2]=l),g&&(D[4]?(D[1]="@supports (".concat(D[4],") {").concat(D[1],"}"),D[4]=g):D[4]="".concat(g)),s.push(D))}},s}},1:u=>{u.exports=function(e){var s=e[1],r=e[3];if(!r)return s;if(typeof btoa=="function"){var a=btoa(unescape(encodeURIComponent(JSON.stringify(r)))),l="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),f="/*# ".concat(l," */");return[s].concat([f]).join(`
`)}return[s].join(`
`)}}},n={};function o(u){var e=n[u];if(e!==void 0)return e.exports;var s=n[u]={id:u,exports:{}};return i[u](s,s.exports,o),s.exports}o.n=u=>{var e=u&&u.__esModule?()=>u.default:()=>u;return o.d(e,{a:e}),e},o.d=(u,e)=>{for(var s in e)o.o(e,s)&&!o.o(u,s)&&Object.defineProperty(u,s,{enumerable:!0,get:e[s]})},o.o=(u,e)=>Object.prototype.hasOwnProperty.call(u,e),o.r=u=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(u,"__esModule",{value:!0})};var h={};o.r(h),o.d(h,{ActionCompleteEvent:()=>vh,ActionContext:()=>Dr,ActionQueue:()=>_d,ActionSequence:()=>il,ActionStartEvent:()=>mh,ActionsComponent:()=>Vn,ActionsSystem:()=>Xh,ActivateEvent:()=>dh,Actor:()=>Qe,ActorEvents:()=>Dp,AddEvent:()=>wh,AddedComponent:()=>op,AffineMatrix:()=>ue,Animation:()=>Ri,AnimationDirection:()=>xr,AnimationEvents:()=>ip,AnimationStrategy:()=>Ii,ArcadeSolver:()=>Hh,AudioContextFactory:()=>Cr,Axes:()=>Zh,Axis:()=>Wo,BaseAlign:()=>Co,BezierCurve:()=>Rr,Blink:()=>Ud,BodyComponent:()=>St,BoundingBox:()=>ht,BrowserComponent:()=>Kh,BrowserEvents:()=>vu,Buttons:()=>kr,Camera:()=>tu,CameraEvents:()=>Bp,Canvas:()=>ko,Circle:()=>zo,CircleCollider:()=>Oe,Clock:()=>$h,ClosestLineJumpTable:()=>Xi,Collider:()=>Us,ColliderComponent:()=>ge,CollisionContact:()=>dn,CollisionEndEvent:()=>Ar,CollisionGroup:()=>fs,CollisionGroupManager:()=>Vi,CollisionJumpTable:()=>Fi,CollisionPostSolveEvent:()=>Fo,CollisionPreSolveEvent:()=>Do,CollisionStartEvent:()=>yr,CollisionSystem:()=>Go,CollisionType:()=>ut,Color:()=>Q,ColorBlindFlags:()=>pu,ColorBlindnessMode:()=>fn,ColorBlindnessPostProcessor:()=>gu,Component:()=>Ai,CompositeCollider:()=>Ae,ConsoleAppender:()=>Si,ContactConstraintPoint:()=>au,ContactEndEvent:()=>Ro,ContactSolveBias:()=>_s,ContactStartEvent:()=>Io,CoordPlane:()=>Re,CrossFade:()=>_m,CurveBy:()=>Gd,CurveTo:()=>Nd,DeactivateEvent:()=>uh,Debug:()=>Ce,DebugConfig:()=>mu,DebugGraphicsComponent:()=>Oo,DebugSystem:()=>Nh,DebugText:()=>Na,DefaultAntialiasOptions:()=>wu,DefaultGarbageCollectionOptions:()=>el,DefaultLoader:()=>Sr,DefaultPixelArtOptions:()=>xu,DegreeOfFreedom:()=>ii,Delay:()=>Hd,Detector:()=>ud,Die:()=>Od,Direction:()=>Po,Director:()=>Cu,DirectorEvents:()=>Gp,DisplayMode:()=>ye,DynamicTree:()=>Th,DynamicTreeCollisionProcessor:()=>Uo,EX_VERSION:()=>hl,EaseBy:()=>Ld,EaseTo:()=>kd,EasingFunctions:()=>Vt,EdgeCollider:()=>di,ElasticToActorStrategy:()=>Jd,EmitterType:()=>Ws,Engine:()=>si,EngineEvents:()=>Vp,EnterTriggerEvent:()=>gh,EnterViewPortEvent:()=>_h,Entity:()=>He,EntityEvents:()=>cp,EntityManager:()=>iu,EventEmitter:()=>I,EventTypes:()=>To,Events:()=>p,ExResponse:()=>Ah,ExcaliburGraphicsContext2DCanvas:()=>Bo,ExcaliburGraphicsContextWebGL:()=>us,ExitTriggerEvent:()=>ph,ExitViewPortEvent:()=>fh,Fade:()=>zd,FadeInOut:()=>fm,Flags:()=>b,Flash:()=>Wd,Follow:()=>kh,Font:()=>nn,FontCache:()=>Lt,FontSource:()=>dm,FontStyle:()=>So,FontUnit:()=>yo,FpsSampler:()=>bu,FrameStats:()=>Hr,Future:()=>P,GameEvent:()=>vt,GameStartEvent:()=>Ja,GameStopEvent:()=>Ka,Gamepad:()=>qo,GamepadAxisEvent:()=>hh,GamepadButtonEvent:()=>ah,GamepadConnectEvent:()=>rh,GamepadDisconnectEvent:()=>oh,Gamepads:()=>Xo,GarbageCollector:()=>Tu,Gif:()=>lm,GifParser:()=>Ru,GlobalCoordinates:()=>Xn,GpuParticleEmitter:()=>jp,GpuParticleRenderer:()=>Zo,Graphic:()=>ee,GraphicsComponent:()=>se,GraphicsGroup:()=>Un,GraphicsSystem:()=>Wh,HashColliderProxy:()=>hu,HashGridCell:()=>ji,HashGridProxy:()=>Gh,HiddenEvent:()=>ch,HorizontalFirst:()=>Ih,ImageFiltering:()=>fe,ImageSource:()=>Ni,ImageSourceAttributeConstants:()=>Dt,ImageWrapping:()=>jt,InitializeEvent:()=>Nn,InputHost:()=>Jh,InputMapper:()=>cu,IsometricEntityComponent:()=>Br,IsometricEntitySystem:()=>qh,IsometricMap:()=>Zp,IsometricTile:()=>Eu,KeyEvent:()=>Ur,Keyboard:()=>uu,Keys:()=>Lr,KillEvent:()=>Eo,Label:()=>Xp,LimitCameraBoundsStrategy:()=>$d,Line:()=>nl,LineSegment:()=>le,Loader:()=>ln,LoaderEvents:()=>xp,LockCameraToActorAxisStrategy:()=>Qd,LockCameraToActorStrategy:()=>Zd,LogLevel:()=>Gt,Logger:()=>at,Material:()=>nd,Matrix:()=>ci,MatrixLocations:()=>Wa,MediaEvent:()=>Ch,Meet:()=>Lh,MotionComponent:()=>Bt,MotionSystem:()=>No,MoveBy:()=>Mh,MoveByWithOptions:()=>bd,MoveTo:()=>Bh,MoveToWithOptions:()=>Ad,NativePointerButton:()=>Hs,NativeSoundEvent:()=>hn,NativeSoundProcessedEvent:()=>ld,NineSlice:()=>ol,NineSliceStretch:()=>vs,None:()=>Rh,Observable:()=>Ye,OffscreenSystem:()=>Yh,Pair:()=>Ze,ParallaxComponent:()=>Ho,ParallelActions:()=>Qp,Particle:()=>Mo,ParticleEmitter:()=>qp,ParticleRenderer:()=>ad,ParticleTransform:()=>Di,PhysicsStats:()=>jo,PhysicsWorld:()=>lu,PointerAbstraction:()=>Qh,PointerButton:()=>ps,PointerComponent:()=>zs,PointerEvent:()=>zr,PointerEventReceiver:()=>Yo,PointerScope:()=>M,PointerSystem:()=>Vo,PointerType:()=>ms,Polygon:()=>rl,PolygonCollider:()=>De,Pool:()=>bo,PostCollisionEvent:()=>on,PostDebugDrawEvent:()=>ih,PostDrawEvent:()=>Wn,PostFrameEvent:()=>nh,PostKillEvent:()=>Qa,PostTransformDrawEvent:()=>th,PostUpdateEvent:()=>Ls,PreCollisionEvent:()=>rn,PreDebugDrawEvent:()=>eh,PreDrawEvent:()=>On,PreFrameEvent:()=>sh,PreKillEvent:()=>Za,PreLoadEvent:()=>Hp,PreTransformDrawEvent:()=>$a,PreUpdateEvent:()=>ks,Projection:()=>Pr,QuadIndexBuffer:()=>wr,QuadTree:()=>Yn,Query:()=>Fr,QueryManager:()=>su,RadiusAroundActorStrategy:()=>Kd,Random:()=>F,Raster:()=>zn,Ray:()=>cn,RealisticSolver:()=>Oh,Rectangle:()=>Er,RemoveEvent:()=>xh,RemovedComponent:()=>hp,Repeat:()=>gd,RepeatForever:()=>pd,Resolution:()=>bh,Resource:()=>mr,ResourceEvents:()=>Ig,RotateBy:()=>Td,RotateByWithOptions:()=>Pd,RotateTo:()=>Sd,RotateToWithOptions:()=>Cd,RotationType:()=>R,ScaleBy:()=>Md,ScaleByWithOptions:()=>Fd,ScaleTo:()=>Rd,ScaleToWithOptions:()=>Id,Scene:()=>vi,SceneEvents:()=>Op,Screen:()=>yh,ScreenAppender:()=>hs,ScreenElement:()=>Uh,ScreenEvents:()=>pp,ScreenShader:()=>_u,ScrollPreventionMode:()=>Os,Semaphore:()=>wm,SeparatingAxis:()=>_e,SeparationInfo:()=>fd,Shader:()=>ei,Shape:()=>We,Side:()=>It,Slide:()=>gm,SolverStrategy:()=>Tr,Sound:()=>cd,SoundEvents:()=>wp,SparseHashGrid:()=>Vh,SparseHashGridCollisionProcessor:()=>jh,SpatialPartitionStrategy:()=>Gn,Sprite:()=>Ti,SpriteFont:()=>wo,SpriteSheet:()=>sn,StandardClock:()=>tl,StateMachine:()=>Lo,StrategyContainer:()=>jd,Stream:()=>Iu,System:()=>mi,SystemManager:()=>ru,SystemPriority:()=>Yi,SystemType:()=>ui,TagQuery:()=>Mr,TestClock:()=>yu,Text:()=>br,TextAlign:()=>Ao,TextureLoader:()=>ie,Tile:()=>Yd,TileMap:()=>qd,TileMapEvents:()=>Mp,TiledAnimation:()=>al,TiledSprite:()=>vr,Timer:()=>un,Toaster:()=>Au,Transform:()=>ds,TransformComponent:()=>et,Transition:()=>Jo,TreeNode:()=>Ph,Trigger:()=>eu,TriggerEvents:()=>kp,TwoPI:()=>W,Util:()=>v,Vector:()=>B,VectorView:()=>Xa,VertexBuffer:()=>Gi,VertexLayout:()=>cs,VerticalFirst:()=>Eh,VisibleEvent:()=>lh,WebAudio:()=>an,WebAudioInstance:()=>hd,WheelDeltaMode:()=>qn,WheelEvent:()=>fu,World:()=>ou,approximatelyEqual:()=>X,assert:()=>Yp,canonicalizeAngle:()=>rt,clamp:()=>j,coroutine:()=>Mu,createId:()=>S,frac:()=>U,getDefaultPhysicsConfig:()=>gs,hasGraphicsTick:()=>ja,hasOnAdd:()=>rm,hasOnInitialize:()=>tm,hasOnPostUpdate:()=>nm,hasOnPreUpdate:()=>im,hasOnRemove:()=>om,hasPostDraw:()=>hm,hasPreDraw:()=>am,has_add:()=>Kp,has_initialize:()=>Jp,has_postupdate:()=>sm,has_preupdate:()=>em,has_remove:()=>$p,inverseLerp:()=>vd,inverseLerpVector:()=>wd,isActor:()=>Rp,isAddedComponent:()=>ap,isComponentCtor:()=>od,isLoaderConstructor:()=>Sh,isMoveByOptions:()=>xd,isMoveToOptions:()=>yd,isRemovedComponent:()=>lp,isRotateByOptions:()=>Ip,isRotateToOptions:()=>Ep,isScaleByOptions:()=>Dd,isScaleToOptions:()=>Ed,isSceneConstructor:()=>Zi,isScreenElement:()=>Vd,isSystemConstructor:()=>nu,lerp:()=>md,lerpAngle:()=>Fh,lerpVector:()=>Ir,maxMessages:()=>Bu,nextActionId:()=>Ut,obsolete:()=>mm,parseImageFiltering:()=>Ln,parseImageWrapping:()=>Ei,pixelSnapEpsilon:()=>gt,randomInRange:()=>Ct,randomIntInRange:()=>Rt,range:()=>mt,remap:()=>qi,remapVector:()=>Tp,resetObsoleteCounter:()=>pm,sign:()=>V,toDegrees:()=>lt,toRadians:()=>xt,vec:()=>z,webgl:()=>c});var c={};o.r(c),o.d(c,{getAttributeComponentSize:()=>id,getAttributePointerType:()=>sd,getGLTypeFromSource:()=>ed,getGlTypeSizeBytes:()=>Ga,getMaxShaderComplexity:()=>Va,isAttributeInSource:()=>td});var _={};o.r(_),o.d(_,{circle:()=>rp,line:()=>qa,point:()=>sp,roundRect:()=>Ya,vector:()=>np});var p={};o.r(p),o.d(p,{ActionCompleteEvent:()=>vh,ActionStartEvent:()=>mh,ActivateEvent:()=>dh,AddEvent:()=>wh,CollisionEndEvent:()=>Ar,CollisionPostSolveEvent:()=>Fo,CollisionPreSolveEvent:()=>Do,CollisionStartEvent:()=>yr,ContactEndEvent:()=>Ro,ContactStartEvent:()=>Io,DeactivateEvent:()=>uh,EnterTriggerEvent:()=>gh,EnterViewPortEvent:()=>_h,EventTypes:()=>To,ExitTriggerEvent:()=>ph,ExitViewPortEvent:()=>fh,GameEvent:()=>vt,GameStartEvent:()=>Ja,GameStopEvent:()=>Ka,GamepadAxisEvent:()=>hh,GamepadButtonEvent:()=>ah,GamepadConnectEvent:()=>rh,GamepadDisconnectEvent:()=>oh,HiddenEvent:()=>ch,InitializeEvent:()=>Nn,KillEvent:()=>Eo,PostCollisionEvent:()=>on,PostDebugDrawEvent:()=>ih,PostDrawEvent:()=>Wn,PostFrameEvent:()=>nh,PostKillEvent:()=>Qa,PostTransformDrawEvent:()=>th,PostUpdateEvent:()=>Ls,PreCollisionEvent:()=>rn,PreDebugDrawEvent:()=>eh,PreDrawEvent:()=>On,PreFrameEvent:()=>sh,PreKillEvent:()=>Za,PreTransformDrawEvent:()=>$a,PreUpdateEvent:()=>ks,RemoveEvent:()=>xh,VisibleEvent:()=>lh});var v={};o.r(v),o.d(v,{ConsoleAppender:()=>Si,DrawUtil:()=>_,EasingFunctions:()=>Vt,LogLevel:()=>Gt,Logger:()=>at,Observable:()=>Ye,ScreenAppender:()=>hs,addItemToArray:()=>_o,contains:()=>go,delay:()=>po,fail:()=>Qc,getPosition:()=>Ms,isObject:()=>mo,mergeDeep:()=>vo,omit:()=>Jc,removeItemFromArray:()=>ls});function x(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(u){window.setInterval(u,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const e=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(s){return new Promise((r,a)=>{e.call(this,s,r,a)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(u){const e=Date.now();return setTimeout(function(){u({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-e))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(u){clearTimeout(u)})}class b{static useCanvasGraphicsContext(){b.enable("use-canvas-context")}static useLegacyImageRenderer(){b.enable("use-legacy-image-renderer")}static freeze(){b._FROZEN=!0}static _reset(){b._FROZEN=!1,b._FLAGS={}}static enable(e){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");b._FLAGS[e]=!0}static disable(e){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");b._FLAGS[e]=!1}static isEnabled(e){return!!b._FLAGS[e]}static show(){return Object.keys(b._FLAGS)}}b._FROZEN=!1,b._FLAGS={};function S(u,e){return{type:u,value:e}}class P{constructor(){this._isCompleted=!1,this.promise=new Promise((e,s)=>{this._resolver=e,this._rejecter=s})}get isCompleted(){return this._isCompleted}resolve(e){this._isCompleted||(this._isCompleted=!0,this._resolver(e))}reject(e){this._isCompleted||(this._isCompleted=!0,this._rejecter(e))}}class I{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(e,s){var r;return this._empty=!1,this._listeners[e]=(r=this._listeners[e])!==null&&r!==void 0?r:[],this._listeners[e].push(s),{close:()=>this.off(e,s)}}once(e,s){var r;return this._empty=!1,this._listenersOnce[e]=(r=this._listenersOnce[e])!==null&&r!==void 0?r:[],this._listenersOnce[e].push(s),{close:()=>this.off(e,s)}}off(e,s){var r,a;if(s){const l=(r=this._listeners[e])===null||r===void 0?void 0:r.filter(g=>g!==s);this._listeners[e]=l;const f=(a=this._listenersOnce[e])===null||a===void 0?void 0:a.filter(g=>g!==s);this._listenersOnce[e]=f}else delete this._listeners[e]}emit(e,s){if(this._empty||this._paused)return;const r=this._listeners[e];if(r)for(let l=0;l<r.length;l++)r[l](s);const a=this._listenersOnce[e];if(this._listenersOnce[e]=[],a)for(let l=0;l<a.length;l++)a[l](s);for(let l=0;l<this._pipes.length;l++)this._pipes[l].emit(e,s)}pipe(e){if(this===e)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(e),{close:()=>{const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}}}unpipe(e){const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var M;(function(u){u.Canvas="Canvas",u.Document="Document"})(M||(M={}));var R;(function(u){u.ShortestPath="shortest-path",u.LongestPath="longest-path",u.Clockwise="clockwise",u.CounterClockwise="counter-clockwise"})(R||(R={}));const T=4294967295;class F{constructor(e){this.seed=e,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(e||Date.now())>>>0;for(let s=1;s<this._n;s++){const r=this._mt[s-1]^this._mt[s-1]>>>this._w-2;this._mt[s]=(this._f*((r&4294901760)>>>16)<<16)+this._f*(r&65535)+s>>>0}this._index=this._n}_twist(){const e=[0,this._a];let s=0,r=0;for(;r<this._n-this._m;r++)s=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+this._m]^s>>>1^e[s&1]&T;for(;r<this._n-1;r++)s=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+(this._m-this._n)]^s>>>1^e[s&1]&T;s=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^s>>>1^e[s&1]&T,this._index=0}nextInt(){this._index>=this._n&&this._twist();let e=this._mt[this._index++];return e^=e>>>this._u,e^=e<<this._s&this._b,e^=e<<this._t&this._c,e^=e>>>this._l,e>>>0}next(){return this.nextInt()*(1/4294967296)}floating(e,s){return(s-e)*this.next()+e}integer(e,s){return Math.floor((s-e+1)*this.next()+e)}bool(e=.5){return this.next()<=e}pickOne(e){return e[this.integer(0,e.length-1)]}pickSet(e,s,r=!1){return r?this._pickSetWithDuplicates(e,s):this._pickSetWithoutDuplicates(e,s)}_pickSetWithoutDuplicates(e,s){if(s>e.length||s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(s===e.length)return e;const r=new Array(s);let a=0;const l=e.slice(0);for(;a<s;){const f=this.integer(0,l.length-1);r[a++]=l[f],l.splice(f,1)}return r}_pickSetWithDuplicates(e,s){if(s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const r=new Array(s);for(let a=0;a<s;a++)r[a]=this.pickOne(e);return r}shuffle(e){const s=e.slice(0);let r;for(let a=0;a<s.length-2;a++){const l=this.integer(a,s.length-1);r=s[a],s[a]=s[l],s[l]=r}return s}range(e,s,r){const a=new Array(e);for(let l=0;l<e;l++)a[l]=this.integer(s,r);return a}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const W=Math.PI*2;function U(u){return u>=0?u-Math.floor(u):u-Math.ceil(u)}function V(u){return u===0?0:u<0?-1:1}function j(u,e,s){return Math.min(Math.max(e,u),s)}function X(u,e,s){return Math.abs(u-e)<s}function rt(u){let e=u;if(u>=W)for(;e>=W;)e-=W;if(u<0)for(;e<0;)e+=W;return e}function lt(u){return 180/Math.PI*u}function xt(u){return u/180*Math.PI}const mt=(u,e)=>Array.from(new Array(e-u+1),(s,r)=>r+u);function Ct(u,e,s=new F){return s?s.floating(u,e):u+Math.random()*(e-u)}function Rt(u,e,s=new F){return s?s.integer(u,e):Math.round(Ct(u,e))}class B{static get Zero(){return new B(0,0)}static get One(){return new B(1,1)}static get Half(){return new B(.5,.5)}static get Up(){return new B(0,-1)}static get Down(){return new B(0,1)}static get Left(){return new B(-1,0)}static get Right(){return new B(1,0)}static fromAngle(e){return new B(Math.cos(e),Math.sin(e))}static isValid(e){return!(e==null||isNaN(e.x)||isNaN(e.y)||e.x===1/0||e.y===1/0||e.x===-1/0||e.y===-1/0)}static distance(e,s){return Math.sqrt(Math.pow(e.x-s.x,2)+Math.pow(e.y-s.y,2))}static min(e,s){return new B(Math.min(e.x,s.x),Math.min(e.y,s.y))}static max(e,s){return new B(Math.max(e.x,s.x),Math.max(e.y,s.y))}constructor(e,s){this._x=0,this._y=0,this._x=e,this._y=s}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}setTo(e,s){this.x=e,this.y=s}equals(e,s=B.EQUALS_EPSILON){return Math.abs(this.x-e.x)<=s&&Math.abs(this.y-e.y)<=s}distance(e){if(!e)return Math.sqrt(this.x*this.x+this.y*this.y);const s=this.x-e.x,r=this.y-e.y;return Math.sqrt(s*s+r*r)}squareDistance(e){e||(e=B.Zero);const s=this.x-e.x,r=this.y-e.y;return s*s+r*r}clampMagnitude(e){const s=this.magnitude,r=j(s,0,e);return this.magnitude=r,this}get size(){return this.distance()}set size(e){const s=this.normalize().scale(e);this.setTo(s.x,s.y)}get magnitude(){return this.distance()}set magnitude(e){this.normalize().scale(e,this)}normalize(){const e=this.distance();return e===0?B.Zero:new B(this.x/e,this.y/e)}average(e){return this.add(e).scale(.5)}scale(e,s){const r=s||new B(0,0);return e instanceof B?(r.x=this.x*e.x,r.y=this.y*e.y):(r.x=this.x*e,r.y=this.y*e),r}add(e,s){return s?(s.x=this.x+e.x,s.y=this.y+e.y,s):new B(this.x+e.x,this.y+e.y)}sub(e,s){const r=s||new B(0,0),a=this.x-e.x,l=this.y-e.y;return r.x=a,r.y=l,r}addEqual(e){return this.setTo(this.x+e.x,this.y+e.y),this}subEqual(e){return this.setTo(this.x-e.x,this.y-e.y),this}scaleEqual(e){return this.setTo(this.x*e,this.y*e),this}dot(e){return this.x*e.x+this.y*e.y}cross(e){if(e instanceof B)return this.x*e.y-this.y*e.x;if(typeof e=="number")return new B(e*this.y,-e*this.x)}static cross(e,s){return new B(-e*s.y,e*s.x)}perpendicular(){return new B(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return rt(Math.atan2(this.y,this.x))}angleBetween(e,s){const r=this.toAngle(),a=rt(e);let l=0,f=0;switch(a>r?l=a-r:l=(W-r+a)%W,f=(l-W)%W,s){case R.ShortestPath:return Math.abs(l)<Math.abs(f)?l:f;case R.LongestPath:return Math.abs(l)>Math.abs(f)?l:f;case R.Clockwise:return l;case R.CounterClockwise:return f}}rotate(e,s,r){const a=r||new B(0,0);s||(s=new B(0,0));const l=Math.sin(e),f=Math.cos(e),g=f*(this.x-s.x)-l*(this.y-s.y)+s.x,m=l*(this.x-s.x)+f*(this.y-s.y)+s.y;return a.x=g,a.y=m,a}clone(e){const s=e??new B(0,0);return s.x=this.x,s.y=this.y,s}toString(e){return e?`(${this.x.toFixed(e)}, ${this.y.toFixed(e)})`:`(${this.x}, ${this.y})`}}B.EQUALS_EPSILON=.001;function z(u,e){return new B(u,e)}class Q{constructor(e,s,r,a){this.r=e,this.g=s,this.b=r,this.a=a??1}static fromRGB(e,s,r,a){return new Q(e,s,r,a)}static fromRGBString(e){const s=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let r=null;if(r=e.match(s)){const a=parseInt(r[1],10),l=parseInt(r[2],10),f=parseInt(r[3],10);let g=1;return r[4]&&(g=parseFloat(r[4])),new Q(a,l,f,g)}else throw new Error("Invalid rgb/a string: "+e)}static fromHex(e){const s=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let r=null;if(r=e.match(s)){const a=parseInt(r[1],16),l=parseInt(r[2],16),f=parseInt(r[3],16);let g=1;return r[4]&&(g=parseInt(r[4],16)/255),new Q(a,l,f,g)}else throw new Error("Invalid hex string: "+e)}static fromHSL(e,s,r,a=1){return new tt(e,s,r,a).toRGBA()}lighten(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.l+=(1-s.l)*e,s.toRGBA()}darken(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.l-=s.l*e,s.toRGBA()}saturate(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.s+=s.s*e,s.toRGBA()}desaturate(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.s-=s.s*e,s.toRGBA()}multiply(e){const s=e.r/255*this.r/255*255,r=e.g/255*this.g/255*255,a=e.b/255*this.b/255*255,l=e.a*this.a;return new Q(s,r,a,l)}screen(e){const s=e.invert(),r=e.invert();return s.multiply(r).invert()}invert(){return new Q(255-this.r,255-this.g,255-this.b,1-this.a)}average(e){const s=(e.r+this.r)/2,r=(e.g+this.g)/2,a=(e.b+this.b)/2,l=(e.a+this.a)/2;return new Q(s,r,a,l)}equal(e){return this.toString()===e.toString()}toString(e="rgb"){switch(e){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(e){const s=Math.max(Math.round(e),0).toString(16);return s.length===1?"0"+s:s}toHex(){let e="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(e+=this._componentToHex(this.a*255)),e}toRGBA(){const e=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+e+", "+String(this.a)+")":"rgb("+e+")"}toHSLA(){return tt.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(e){const s=e||new Q(this.r,this.g,this.b,this.a);return s.r=this.r,s.g=this.g,s.b=this.b,s.a=this.a,s}static get Black(){return Q.fromHex("#000000")}static get White(){return Q.fromHex("#FFFFFF")}static get Gray(){return Q.fromHex("#808080")}static get LightGray(){return Q.fromHex("#D3D3D3")}static get DarkGray(){return Q.fromHex("#A9A9A9")}static get Yellow(){return Q.fromHex("#FFFF00")}static get Orange(){return Q.fromHex("#FFA500")}static get Red(){return Q.fromHex("#FF0000")}static get Vermilion(){return Q.fromHex("#FF5B31")}static get Rose(){return Q.fromHex("#FF007F")}static get Pink(){return Q.fromHex("#FFC0CB")}static get Magenta(){return Q.fromHex("#FF00FF")}static get Violet(){return Q.fromHex("#7F00FF")}static get Purple(){return Q.fromHex("#800080")}static get Blue(){return Q.fromHex("#0000FF")}static get Azure(){return Q.fromHex("#007FFF")}static get Cyan(){return Q.fromHex("#00FFFF")}static get Viridian(){return Q.fromHex("#59978F")}static get Teal(){return Q.fromHex("#008080")}static get Green(){return Q.fromHex("#00FF00")}static get Chartreuse(){return Q.fromHex("#7FFF00")}static get Transparent(){return Q.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return Q.fromHex("#176BAA")}static get Brown(){return Q.fromHex("#964B00")}}class tt{constructor(e,s,r,a){this.h=e,this.s=s,this.l=r,this.a=a}static hue2rgb(e,s,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+(s-e)*6*r:r<1/2?s:r<2/3?e+(s-e)*(2/3-r)*6:e}static fromRGBA(e,s,r,a){e/=255,s/=255,r/=255;const l=Math.max(e,s,r),f=Math.min(e,s,r);let g,m;const w=(l+f)/2;if(l===f)g=m=0;else{const y=l-f;switch(m=w>.5?y/(2-l-f):y/(l+f),l){case e:g=(s-r)/y+(s<r?6:0);break;case s:g=(r-e)/y+2;break;case r:g=(e-s)/y+4;break}g/=6}return new tt(g,m,w,a)}toRGBA(){let e,s,r;if(this.s===0)e=s=r=this.l;else{const a=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,l=2*this.l-a;e=tt.hue2rgb(l,a,this.h+1/3),s=tt.hue2rgb(l,a,this.h),r=tt.hue2rgb(l,a,this.h-1/3)}return new Q(e*255,s*255,r*255,this.a)}toString(){const e=this.h.toFixed(0),s=this.s.toFixed(0),r=this.l.toFixed(0),a=this.a.toFixed(0);return`hsla(${e}, ${s}, ${r}, ${a})`}}var Gt;(function(u){u[u.Debug=0]="Debug",u[u.Info=1]="Info",u[u.Warn=2]="Warn",u[u.Error=3]="Error",u[u.Fatal=4]="Fatal"})(Gt||(Gt={}));class at{constructor(){if(this._appenders=[],this.defaultLevel=Gt.Info,this._logOnceSet=new Set,at._INSTANCE)throw new Error("Logger is a singleton");return at._INSTANCE=this,at._INSTANCE.addAppender(new Si),at._INSTANCE}static getInstance(){return at._INSTANCE==null&&(at._INSTANCE=new at),at._INSTANCE}addAppender(e){this._appenders.push(e)}clearAppenders(){this._appenders.length=0}_log(e,s){e==null&&(e=this.defaultLevel);const r=this._appenders.length;for(let a=0;a<r;a++)e>=this.defaultLevel&&this._appenders[a].log(e,s)}_logOnce(e,s){const r=e+s.join("+");this._logOnceSet.has(r)||(this._logOnceSet.add(r),this._log(e,s))}debug(...e){this._log(Gt.Debug,e)}debugOnce(...e){this._logOnce(Gt.Debug,e)}info(...e){this._log(Gt.Info,e)}infoOnce(...e){this._logOnce(Gt.Info,e)}warn(...e){this._log(Gt.Warn,e)}warnOnce(...e){this._logOnce(Gt.Warn,e)}error(...e){this._log(Gt.Error,e)}errorOnce(...e){this._logOnce(Gt.Error,e)}fatal(...e){this._log(Gt.Fatal,e)}fatalOnce(...e){this._logOnce(Gt.Fatal,e)}}at._INSTANCE=null;class Si{log(e,s){if(!console&&!console.log&&console.warn&&console.error)return;const r=[];r.unshift.apply(r,s),r.unshift("["+Gt[e]+"] : "),e<Gt.Warn?console.log.apply?console.log.apply(console,r):console.log(r.join(" ")):e<Gt.Error?console.warn.apply?console.warn.apply(console,r):console.warn(r.join(" ")):console.error.apply?console.error.apply(console,r):console.error(r.join(" "))}}class hs{constructor(e){var s,r;this._messages=[],this._pos=10,this._color=Q.Black,this._options=e,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(r=(s=e.zIndex)===null||s===void 0?void 0:s.toString())!==null&&r!==void 0?r:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),e.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var e,s,r,a;const l=this._options;this.canvas.width=(e=l.width)!==null&&e!==void 0?e:l.engine.screen.resolution.width,this.canvas.height=(s=l.height)!==null&&s!==void 0?s:l.engine.screen.resolution.height,this.canvas.style.position="absolute";const f=l.engine.screen.screenToPageCoordinates(z(0,0));this.canvas.style.left=f.x+"px",this.canvas.style.top=f.y+"px",this._pos=(r=l.xPos)!==null&&r!==void 0?r:this._pos,this._color=(a=l.color)!==null&&a!==void 0?a:this._color}log(e,s){const r=s.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+Gt[e]+"] : "+r);let a=10;this._messages=this._messages.slice(0,1e3);for(let l=0;l<this._messages.length;l++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[l],this._pos,a),a+=10}}var It;(function(u){u.None="None",u.Top="Top",u.Bottom="Bottom",u.Left="Left",u.Right="Right"})(It||(It={})),function(u){function e(r){return r===u.Top?u.Bottom:r===u.Bottom?u.Top:r===u.Left?u.Right:r===u.Right?u.Left:u.None}u.getOpposite=e;function s(r){return Math.abs(r.x)>=Math.abs(r.y)?r.x<=0?u.Left:u.Right:r.y<=0?u.Top:u.Bottom}u.fromDirection=s}(It||(It={}));class ht{constructor(e=0,s=0,r=0,a=0){this._points=[],typeof e=="object"?(this.left=e.left,this.top=e.top,this.right=e.right,this.bottom=e.bottom):typeof e=="number"&&(this.left=e,this.top=s,this.right=r,this.bottom=a)}clone(e){const s=e||new ht(0,0,0,0);return s.left=this.left,s.right=this.right,s.top=this.top,s.bottom=this.bottom,s}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(e){return e&&e?Math.abs(e.x)>Math.abs(e.y)?e.x<0?It.Right:It.Left:e.y<0?It.Bottom:It.Top:It.None}static fromPoints(e){let s=1/0,r=1/0,a=-1/0,l=-1/0;for(let f=0;f<e.length;f++)e[f].x<s&&(s=e[f].x),e[f].x>a&&(a=e[f].x),e[f].y<r&&(r=e[f].y),e[f].y>l&&(l=e[f].y);return new ht(s,r,a,l)}static fromDimension(e,s,r=B.Half,a=B.Zero){return new ht(-e*r.x+a.x,-s*r.y+a.y,e-e*r.x+a.x,s-s*r.y+a.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new B((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new B(this.left,this.top)}get bottomRight(){return new B(this.right,this.bottom)}get topRight(){return new B(this.right,this.top)}get bottomLeft(){return new B(this.left,this.bottom)}translate(e){return new ht(this.left+e.x,this.top+e.y,this.right+e.x,this.bottom+e.y)}rotate(e,s=B.Zero){const r=this.getPoints().map(a=>a.rotate(e,s));return ht.fromPoints(r)}scale(e,s=B.Zero){const r=this.translate(s);return new ht(r.left*e.x,r.top*e.y,r.right*e.x,r.bottom*e.y)}transform(e){const s=e.data[0]*this.left,r=e.data[1]*this.left,a=e.data[0]*this.right,l=e.data[1]*this.right,f=e.data[2]*this.top,g=e.data[3]*this.top,m=e.data[2]*this.bottom,w=e.data[3]*this.bottom,y=e.getPosition(),A=Math.min(s,a)+Math.min(f,m)+y.x,E=Math.min(r,l)+Math.min(g,w)+y.y,D=Math.max(s,a)+Math.max(f,m)+y.x,L=Math.max(r,l)+Math.max(g,w)+y.y;return new ht({left:A,top:E,right:D,bottom:L})}getPerimeter(){const e=this.width,s=this.height;return 2*(e+s)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new B(this.left,this.top)),this._points.push(new B(this.right,this.top)),this._points.push(new B(this.right,this.bottom)),this._points.push(new B(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(e,s=1/0){let r=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,f=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,g=(this.left-e.pos.x)*l,m=(this.right-e.pos.x)*l;r=Math.min(g,m),a=Math.max(g,m);const w=(this.top-e.pos.y)*f,y=(this.bottom-e.pos.y)*f;return r=Math.max(r,Math.min(w,y)),a=Math.min(a,Math.max(w,y)),a>=Math.max(0,r)&&r<s}rayCastTime(e,s=1/0){let r=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,f=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,g=(this.left-e.pos.x)*l,m=(this.right-e.pos.x)*l;r=Math.min(g,m),a=Math.max(g,m);const w=(this.top-e.pos.y)*f,y=(this.bottom-e.pos.y)*f;return r=Math.max(r,Math.min(w,y)),a=Math.min(a,Math.max(w,y)),a>=Math.max(0,r)&&r<s?r:-1}contains(e){return e instanceof B?this.left<=e.x&&this.top<=e.y&&e.y<=this.bottom&&e.x<=this.right:e instanceof ht?this.left<=e.left&&this.top<=e.top&&e.bottom<=this.bottom&&e.right<=this.right:!1}combine(e,s){const r=s||new ht(0,0,0,0),a=Math.min(this.left,e.left),l=Math.min(this.top,e.top),f=Math.max(this.right,e.right),g=Math.max(this.bottom,e.bottom);return r.left=a,r.top=l,r.right=f,r.bottom=g,r}get dimensions(){return new B(this.width,this.height)}overlaps(e,s){const r=s||0;if(e.hasZeroDimensions())return this.contains(e);if(this.hasZeroDimensions())return e.contains(this);const a=this.combine(e);return a.width+r<e.width+this.width&&a.height+r<e.height+this.height}intersect(e){const s=this.combine(e);if(s.width<e.width+this.width&&s.height<e.height+this.height&&!s.dimensions.equals(e.dimensions)&&!s.dimensions.equals(this.dimensions)){let r=0;this.right>=e.left&&this.right<=e.right?r=e.left-this.right:r=e.right-this.left;let a=0;return this.top<=e.bottom&&this.top>=e.top?a=e.bottom-this.top:a=e.top-this.bottom,Math.abs(r)<Math.abs(a)?new B(r,0):new B(0,a)}else if(s.dimensions.equals(e.dimensions)||s.dimensions.equals(this.dimensions)){let r=0;this.width-e.width>=0?this.right-e.right<=e.left-this.left?r=e.left-this.right:r=e.right-this.left:e.right-this.right<=this.left-e.left?r=this.left-e.right:r=this.right-e.left;let a=0;return this.height-e.height>=0?this.bottom-e.bottom<=e.top-this.top?a=e.top-this.bottom:a=e.bottom-this.top:e.bottom-this.bottom<=this.top-e.top?a=this.top-e.bottom:a=this.bottom-e.top,Math.abs(r)<Math.abs(a)?new B(r,0):new B(0,a)}else return null}intersectWithSide(e){const s=this.intersect(e);return ht.getSideFromIntersection(s)}draw(e,s=Q.Yellow){e.debug.drawRect(this.left,this.top,this.width,this.height,{color:s})}}function Ms(u){if(u&&u.getBoundingClientRect){const e=u.getBoundingClientRect();return z(e.x+window.scrollX,e.y+window.scrollY)}return B.Zero}function _o(u,e){return e.indexOf(u)===-1?(e.push(u),!0):!1}function ls(u,e){let s=-1;return(s=e.indexOf(u))>-1?(e.splice(s,1),!0):!1}function go(u,e){for(let s=0;s<u.length;s++)if(u[s]===e)return!0;return!1}function Qc(u){throw new Error(u)}function po(u,e){var s;const r=new P;return((s=e?.schedule.bind(e))!==null&&s!==void 0?s:setTimeout)(()=>{r.resolve()},u),r.promise}function Jc(u,e){const s={};for(const r in u)e.includes(r)||(s[r]=u[r]);return s}function mo(u){return u&&typeof u=="object"&&!Array.isArray(u)}function vo(u,...e){if(!e.length)return u;const s=e.shift();if(mo(u)&&mo(s))for(const r in s)mo(s[r])?(u[r]||Object.assign(u,{[r]:{}}),vo(u[r],s[r])):Object.assign(u,{[r]:s[r]});return vo(u,...e)}var Wa;(function(u){u[u.X=12]="X",u[u.Y=13]="Y"})(Wa||(Wa={}));class ci{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(e,s,r,a,l,f){const g=new ci;return g.data[0]=2/(s-e),g.data[1]=0,g.data[2]=0,g.data[3]=0,g.data[4]=0,g.data[5]=2/(a-r),g.data[6]=0,g.data[7]=0,g.data[8]=0,g.data[9]=0,g.data[10]=-2/(f-l),g.data[11]=0,g.data[12]=-(s+e)/(s-e),g.data[13]=-(a+r)/(a-r),g.data[14]=-(f+l)/(f-l),g.data[15]=1,g}clone(e){const s=e||new ci;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s.data[6]=this.data[6],s.data[7]=this.data[7],s.data[8]=this.data[8],s.data[9]=this.data[9],s.data[10]=this.data[10],s.data[11]=this.data[11],s.data[12]=this.data[12],s.data[13]=this.data[13],s.data[14]=this.data[14],s.data[15]=this.data[15],s}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(e){const s=new ci;return s.data=e,s}static identity(){const e=new ci;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}static translation(e,s){const r=ci.identity();return r.data[12]=e,r.data[13]=s,r}static scale(e,s){const r=ci.identity();return r.data[0]=e,r.data[5]=s,r.data[10]=1,r.data[15]=1,r}static rotation(e){const s=ci.identity();return s.data[0]=Math.cos(e),s.data[4]=-Math.sin(e),s.data[1]=Math.sin(e),s.data[5]=Math.cos(e),s}multiply(e,s){if(e instanceof B){const r=s||new B(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[4]+this.data[12],f=a.x*this.data[1]+a.y*this.data[5]+this.data[13];return r.x=l,r.y=f,r}else{const r=s||new ci,a=e,l=this.data[0],f=this.data[1],g=this.data[2],m=this.data[3],w=this.data[4],y=this.data[5],A=this.data[6],E=this.data[7],D=this.data[8],L=this.data[9],O=this.data[10],q=this.data[11],H=this.data[12],N=this.data[13],J=this.data[14],Y=this.data[15],$=a.data[0],ot=a.data[1],Z=a.data[2],_t=a.data[3],Et=a.data[4],Yt=a.data[5],Qt=a.data[6],Se=a.data[7],te=a.data[8],zt=a.data[9],Ne=a.data[10],Fe=a.data[11],it=a.data[12],_n=a.data[13],gn=a.data[14],pn=a.data[15];r.data[0]=l*$+w*ot+D*Z+H*_t,r.data[1]=f*$+y*ot+L*Z+N*_t,r.data[2]=g*$+A*ot+O*Z+J*_t,r.data[3]=m*$+E*ot+q*Z+Y*_t,r.data[4]=l*Et+w*Yt+D*Qt+H*Se,r.data[5]=f*Et+y*Yt+L*Qt+N*Se,r.data[6]=g*Et+A*Yt+O*Qt+J*Se,r.data[7]=m*Et+E*Yt+q*Qt+Y*Se,r.data[8]=l*te+w*zt+D*Ne+H*Fe,r.data[9]=f*te+y*zt+L*Ne+N*Fe,r.data[10]=g*te+A*zt+O*Ne+J*Fe,r.data[11]=m*te+E*zt+q*Ne+Y*Fe,r.data[12]=l*it+w*_n+D*gn+H*pn,r.data[13]=f*it+y*_n+L*gn+N*pn,r.data[14]=g*it+A*_n+O*gn+J*pn,r.data[15]=m*it+E*_n+q*gn+Y*pn;const Zn=this.getScale();return r._scaleSignX=V(Zn.x)*V(r._scaleSignX),r._scaleSignY=V(Zn.y)*V(r._scaleSignY),r}}translate(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],g=this.data[4],m=this.data[5],w=this.data[6],y=this.data[7],A=this.data[8],E=this.data[9],D=this.data[10],L=this.data[11],O=this.data[12],q=this.data[13],H=this.data[14],N=this.data[15],J=0,Y=1;return this.data[12]=r*e+g*s+A*J+O*Y,this.data[13]=a*e+m*s+E*J+q*Y,this.data[14]=l*e+w*s+D*J+H*Y,this.data[15]=f*e+y*s+L*J+N*Y,this}setPosition(e,s){this.data[12]=e,this.data[13]=s}getPosition(){return z(this.data[12],this.data[13])}rotate(e){const s=this.data[0],r=this.data[1],a=this.data[2],l=this.data[3],f=this.data[4],g=this.data[5],m=this.data[6],w=this.data[7],y=Math.sin(e),A=Math.cos(e);return this.data[0]=A*s+y*f,this.data[1]=A*r+y*g,this.data[2]=A*a+y*m,this.data[3]=A*l+y*w,this.data[4]=A*f-y*s,this.data[5]=A*g-y*r,this.data[6]=A*m-y*a,this.data[7]=A*w-y*l,this}scale(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],g=this.data[4],m=this.data[5],w=this.data[6],y=this.data[7];return this.data[0]=r*e,this.data[1]=a*e,this.data[2]=l*e,this.data[3]=f*e,this.data[4]=g*s,this.data[5]=m*s,this.data[6]=w*s,this.data[7]=y*s,this}setRotation(e){const s=this.getScale(),r=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=r*s.y,this.data[4]=-r*s.x,this.data[5]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return rt(e)}getScaleX(){const e=z(this.data[0],this.data[4]).magnitude;return this._scaleSignX*e}getScaleY(){const e=z(this.data[1],this.data[5]).magnitude;return this._scaleSignY*e}getScale(){return z(this.getScaleX(),this.getScaleY())}setScaleX(e){if(this._scaleX===e)return;this._scaleSignX=V(e);const s=z(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[4]=s.y*e,this._scaleX=e}setScaleY(e){if(this._scaleY===e)return;this._scaleSignY=V(e);const s=z(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[5]=s.y*e,this._scaleY=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(e){const r=1/this.getBasisDeterminant(),a=this.data[0],l=this.data[4],f=this.data[1],g=this.data[5],m=e||ci.identity();m.data[0]=g*r,m.data[1]=-f*r,m.data[4]=-l*r,m.data[5]=a*r;const w=this.data[12],y=this.data[13];return m.data[12]=-(w*m.data[0]+y*m.data[4]),m.data[13]=-(w*m.data[1]+y*m.data[5]),m}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class ue{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const e=new ue;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}static translation(e,s){const r=ue.identity();return r.data[4]=e,r.data[5]=s,r}static scale(e,s){const r=ue.identity();return r.data[0]=e,r.data[3]=s,r._scale[0]=e,r._scale[1]=s,r}static rotation(e){const s=ue.identity();return s.data[0]=Math.cos(e),s.data[1]=Math.sin(e),s.data[2]=-Math.sin(e),s.data[3]=Math.cos(e),s}setPosition(e,s){this.data[4]=e,this.data[5]=s}getPosition(){return z(this.data[4],this.data[5])}rotate(e){const s=this.data[0],r=this.data[1],a=this.data[2],l=this.data[3],f=Math.sin(e),g=Math.cos(e);return this.data[0]=g*s+f*a,this.data[1]=g*r+f*l,this.data[2]=g*a-f*s,this.data[3]=g*l-f*r,this}translate(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],g=this.data[4],m=this.data[5];return this.data[4]=r*e+l*s+g,this.data[5]=a*e+f*s+m,this}scale(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3];return this.data[0]=r*e,this.data[1]=a*e,this.data[2]=l*s,this.data[3]=f*s,this._scale[0]=e,this._scale[1]=s,this._scaleSignX=V(e),this._scaleSignY=V(s),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(e){const s=this.determinant();let r=s;s!==0&&(r=1/s);const a=this.data[0],l=this.data[2],f=this.data[1],g=this.data[3],m=e||ue.identity();m.data[0]=g*r,m.data[1]=-f*r,m.data[2]=-l*r,m.data[3]=a*r;const w=this.data[4],y=this.data[5];return m.data[4]=-(w*m.data[0]+y*m.data[2]),m.data[5]=-(w*m.data[1]+y*m.data[3]),m}multiply(e,s){if(e instanceof B){const r=s||new B(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[2]+this.data[4],f=a.x*this.data[1]+a.y*this.data[3]+this.data[5];return r.x=l,r.y=f,r}else{const r=s||new ue,a=e,l=this.data[0],f=this.data[1],g=this.data[2],m=this.data[3],w=this.data[4],y=this.data[5],A=a.data[0],E=a.data[1],D=a.data[2],L=a.data[3],O=a.data[4],q=a.data[5];r.data[0]=l*A+g*E,r.data[1]=f*A+m*E,r.data[2]=l*D+g*L,r.data[3]=f*D+m*L,r.data[4]=l*O+g*q+w,r.data[5]=f*O+m*q+y;const H=this._scaleSignX,N=this._scaleSignY;return r._scaleSignX=H*V(r._scaleSignX),r._scaleSignY=N*V(r._scaleSignY),r}}multiplyQuadInPlace(e){const s=e[0]*this.data[0]+e[1]*this.data[2]+this.data[4],r=e[0]*this.data[1]+e[1]*this.data[3]+this.data[5];e[0]=s,e[1]=r;const a=e[2]*this.data[0]+e[3]*this.data[2]+this.data[4],l=e[2]*this.data[1]+e[3]*this.data[3]+this.data[5];e[2]=a,e[3]=l;const f=e[4]*this.data[0]+e[5]*this.data[2]+this.data[4],g=e[4]*this.data[1]+e[5]*this.data[3]+this.data[5];e[4]=f,e[5]=g;const m=e[6]*this.data[0]+e[7]*this.data[2]+this.data[4],w=e[6]*this.data[1]+e[7]*this.data[3]+this.data[5];e[6]=m,e[7]=w}to4x4(){const e=new ci;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=0,e.data[3]=0,e.data[4]=this.data[2],e.data[5]=this.data[3],e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=this.data[4],e.data[13]=this.data[5],e.data[14]=0,e.data[15]=1,e}setRotation(e){const s=this.getScale(),r=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=r*s.y,this.data[2]=-r*s.x,this.data[3]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return rt(e)}getScaleX(){const e=this.data[0]*this.data[0]+this.data[2]*this.data[2];return e===1?this._scaleSignX:this._scaleSignX*Math.sqrt(e)}getScaleY(){const e=this.data[1]*this.data[1]+this.data[3]*this.data[3];return e===1?this._scaleSignY:this._scaleSignY*Math.sqrt(e)}getScale(){return z(this.getScaleX(),this.getScaleY())}setScaleX(e){if(e===this._scale[0])return;this._scaleSignX=V(e);const s=z(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[2]=s.y*e,this._scale[0]=e}setScaleY(e){if(e===this._scale[1])return;this._scaleSignY=V(e);const s=z(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[3]=s.y*e,this._scale[1]=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}clone(e){const s=e||new ue;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s._scaleSignX=this._scaleSignX,s._scaleSignY=this._scaleSignY,s}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}class pr{constructor(e,s,r=1){this.builder=e,this.cleaner=s,this._pool=[],this._size=0,this.grow(r)}grow(e){if(e>0){this._size+=e;for(let s=0;s<e;s++)this._pool.push(this.builder())}}rent(e=!1){return this._pool.length===0&&this.grow(this._size),e?this.cleaner(this._pool.pop()):this._pool.pop()}return(e){this._pool.push(e)}}class Tg{constructor(){this._pool=new pr(()=>ue.identity(),e=>e.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(e,s){return this._currentTransform.translate(e,s)}rotate(e){return this._currentTransform.rotate(e)}scale(e,s){return this._currentTransform.scale(e,s)}reset(){this._currentTransform.reset()}set current(e){this._currentTransform=e}get current(){return this._currentTransform}}class Eg{constructor(){this.opacity=1,this.z=0,this.tint=Q.White,this.material=null}}class Kc{constructor(){this._pool=new pr(()=>new Eg,e=>(e.opacity=1,e.z=0,e.tint=Q.White,e.material=null,e),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(e){var s;return e.opacity=this.current.opacity,e.z=this.current.z,e.tint=(s=this.current.tint)===null||s===void 0?void 0:s.clone(),e.material=this.current.material,e}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const Ig={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class mr{constructor(e,s,r=!1){this.path=e,this.responseType=s,this.bustCache=r,this.data=null,this.logger=at.getInstance(),this.events=new I}isLoaded(){return this.data!==null}_cacheBust(e){return/\?\w*=\w*/.test(e)?e+="&__="+Date.now():e+="?__="+Date.now(),e}load(){return new Promise((e,s)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),e(this.data);return}const r=new XMLHttpRequest;r.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),r.responseType=this.responseType,r.addEventListener("loadstart",a=>this.events.emit("loadstart",a)),r.addEventListener("progress",a=>this.events.emit("progress",a)),r.addEventListener("error",a=>this.events.emit("error",a)),r.addEventListener("load",a=>this.events.emit("load",a)),r.addEventListener("load",()=>{if(r.status!==0&&r.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",r.status),this.events.emit("error",r.response),s(new Error(r.statusText));return}if(r.response instanceof Blob&&r.response.type==="text/html"){const a=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",r.response),s(new Error(a));return}this.data=r.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),e(this.data)}),r.send()})}}function Pi(u,e){return u&&(u.__isProxy===void 0?new Proxy(u,{set:(s,r,a)=>(s[r]!==a&&(s[r]=a,typeof r=="string"&&r[0]!=="_"&&e(s)),!0),get:(s,r)=>r!=="__isProxy"?s[r]:!0}):u)}const $c=(u=[],e,s)=>({get:(r,a)=>a==="__isProxy"?!0:typeof r[a]=="object"&&r[a]!=null?new Proxy(r[a],$c([...u,a],e,s)):r[a],set:(r,a,l)=>(typeof a=="string"&&a[0]!=="_"&&e(s),r[a]=l,!0)});function Rg(u,e){return u&&(u.__isProxy===void 0?new Proxy(u,$c([],e,u)):u)}class ee{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(e){this._flipHorizontal=e,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(e){this._flipVertical=e,this._transformStale=!0}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._transformStale=!0}get scale(){return this._scale}set scale(e){this._scale=Pi(e,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(e){e&&(this._origin=Pi(e,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(e){var s,r,a,l,f,g,m;this.id=ee._ID++,this.transform=ue.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=B.One,this._width=0,this._height=0,e&&(this.origin=(s=e.origin)!==null&&s!==void 0?s:this.origin,this.flipHorizontal=(r=e.flipHorizontal)!==null&&r!==void 0?r:this.flipHorizontal,this.flipVertical=(a=e.flipVertical)!==null&&a!==void 0?a:this.flipVertical,this.rotation=(l=e.rotation)!==null&&l!==void 0?l:this.rotation,this.opacity=(f=e.opacity)!==null&&f!==void 0?f:this.opacity,this.scale=(g=e.scale)!==null&&g!==void 0?g:this.scale,this.tint=(m=e.tint)!==null&&m!==void 0?m:this.tint,e.width&&(this._width=e.width),e.height&&(this._height=e.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(e){this._width=e,this._transformStale=!0}set height(e){this._height=e,this._transformStale=!0}get localBounds(){return ht.fromDimension(this.width,this.height,B.Zero)}draw(e,s,r){this._preDraw(e,s,r),this._drawImage(e,0,0),this._postDraw(e)}_preDraw(e,s,r){e.save(),e.translate(s,r),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),e.multiply(this.transform),e.opacity=e.opacity*this.opacity,this.tint&&(e.tint=this.tint)}_rotate(e){var s;const r=this.scale.x>0?1:-1,a=this.scale.y>0?1:-1,l=(s=this.origin)!==null&&s!==void 0?s:z(this.width/2,this.height/2);e.translate(l.x,l.y),e.rotate(this.rotation),e.scale(r,a),e.translate(-l.x,-l.y)}_flip(e){this.flipHorizontal&&(e.translate(this.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,this.height/this.scale.y),e.scale(1,-1))}_postDraw(e){this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore()}}ee._ID=0;class Ti extends ee{static from(e,s){return new Ti({image:e,...s})}constructor(e){var s,r;super(e),this._logger=at.getInstance(),this._dirty=!0,this.image=e.image;const{width:a,height:l}=e;this.sourceView=(s=e.sourceView)!==null&&s!==void 0?s:{x:0,y:0,width:a??0,height:l??0},this.destSize=(r=e.destSize)!==null&&r!==void 0?r:{width:a??0,height:l??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(e){e/=Math.abs(this.scale.x),this.destSize.width=e,super.width=Math.ceil(this.destSize.width)}set height(e){e/=Math.abs(this.scale.y),this.destSize.height=e,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var e,s,r,a,l,f;const{width:g,height:m}=this.image;this.sourceView.width=((e=this.sourceView)===null||e===void 0?void 0:e.width)||g,this.sourceView.height=((s=this.sourceView)===null||s===void 0?void 0:s.height)||m,this.destSize.width=((r=this.destSize)===null||r===void 0?void 0:r.width)||((a=this.sourceView)===null||a===void 0?void 0:a.width)||g,this.destSize.height=((l=this.destSize)===null||l===void 0?void 0:l.height)||((f=this.sourceView)===null||f===void 0?void 0:f.height)||m,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(e,s,r){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(e,s,r)}_drawImage(e,s,r){this.image.isLoaded()?e.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,s,r,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new Ti({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var fe;(function(u){u.Pixel="Pixel",u.Blended="Blended"})(fe||(fe={}));function Ln(u){switch(u){case fe.Pixel:return fe.Pixel;case fe.Blended:return fe.Blended;default:return}}var jt;(function(u){u.Clamp="Clamp",u.Repeat="Repeat",u.Mirror="Mirror"})(jt||(jt={}));function Ei(u){switch(u){case jt.Clamp:return jt.Clamp;case jt.Repeat:return jt.Repeat;case jt.Mirror:return jt.Mirror;default:return jt.Clamp}}class ie{constructor(e,s){var r;this._garbageCollector=s,this._textureMap=new Map,this._collect=a=>{var l;if(this._gl){const f=(l=a.dataset.originalSrc)!==null&&l!==void 0?l:a.constructor.name;return ie._LOGGER.debug(`WebGL Texture for ${f} collected`),this.delete(a),!0}return!1},this._gl=e,ie._MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE),this._garbageCollector&&(ie._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(r=this._garbageCollector.garbageCollector)===null||r===void 0||r.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[e]of this._textureMap)this.delete(e);this._textureMap.clear(),this._gl=null}get(e){return this._textureMap.get(e)}has(e){return this._textureMap.has(e)}load(e,s,r=!1){var a,l;const f=this._gl;if(!f)return null;const{filtering:g,wrapping:m}={...s};let w=null;if(this.has(e)&&(w=this.get(e)),w)return r&&(f.bindTexture(f.TEXTURE_2D,w),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,e)),(a=this._garbageCollector)===null||a===void 0||a.garbageCollector.touch(e),w;w=f.createTexture(),ie.checkImageSizeSupportedAndLog(e),f.bindTexture(f.TEXTURE_2D,w),f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let y;m&&(typeof m=="string"?y={x:m,y:m}:y={x:m.x,y:m.y});const{x:A,y:E}=y??ie.wrapping;switch(A){case jt.Clamp:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);break;case jt.Repeat:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT);break;case jt.Mirror:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.MIRRORED_REPEAT);break;default:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE)}switch(E){case jt.Clamp:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);break;case jt.Repeat:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT);break;case jt.Mirror:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.MIRRORED_REPEAT);break;default:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE)}const D=g??ie.filtering;return f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,D===fe.Pixel?f.NEAREST:f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,D===fe.Pixel?f.NEAREST:f.LINEAR),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,e),this._textureMap.set(e,w),(l=this._garbageCollector)===null||l===void 0||l.garbageCollector.addCollectableResource("texture",e),w}delete(e){const s=this._gl;if(s&&this.has(e)){const r=this.get(e);r&&(this._textureMap.delete(e),s.deleteTexture(r))}}static checkImageSizeSupportedAndLog(e){var s;const r=(s=e.dataset.originalSrc)!==null&&s!==void 0?s:"internal canvas bitmap";return e.width>ie._MAX_TEXTURE_SIZE||e.height>ie._MAX_TEXTURE_SIZE?(ie._LOGGER.error(`The image [${r}] provided to Excalibur is too large for the device's maximum texture size of (${ie._MAX_TEXTURE_SIZE}x${ie._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((e.width>4096||e.height>4096)&&ie._LOGGER.warn(`The image [${r}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}ie._LOGGER=at.getInstance(),ie.filtering=fe.Blended,ie.wrapping={x:jt.Clamp,y:jt.Clamp},ie._MAX_TEXTURE_SIZE=4096;const Dt={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class Ni{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(e,s,r){this._logger=at.getInstance(),this.data=new Image,this._readyFuture=new P,this.ready=this._readyFuture.promise,this.path=e;let a=!1,l;typeof s=="boolean"?a=s:{filtering:r,wrapping:l,bustCache:a}={...s},this._resource=new mr(e,"blob",a),this.filtering=r??this.filtering,typeof l=="string"?this.wrapping={x:l,y:l}:this.wrapping=l??this.wrapping,e.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${e} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(e,s){const r=new Ni("");if(r._src="image-element",r.data=e,r.data.setAttribute("data-original-src","image-element"),s?.filtering?r.data.setAttribute(Dt.Filtering,s?.filtering):r.data.setAttribute(Dt.Filtering,fe.Blended),s?.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},r.data.setAttribute(Dt.WrappingX,a.x),r.data.setAttribute(Dt.WrappingY,a.y)}else r.data.setAttribute(Dt.WrappingX,jt.Clamp),r.data.setAttribute(Dt.WrappingY,jt.Clamp);return ie.checkImageSizeSupportedAndLog(e),r._readyFuture.resolve(e),r}static fromHtmlCanvasElement(e,s){const r=new Ni("");if(r._src="canvas-element-blob",r.data.setAttribute("data-original-src","canvas-element-blob"),s?.filtering?r.data.setAttribute(Dt.Filtering,s?.filtering):r.data.setAttribute(Dt.Filtering,fe.Blended),s?.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},r.data.setAttribute(Dt.WrappingX,a.x),r.data.setAttribute(Dt.WrappingY,a.y)}else r.data.setAttribute(Dt.WrappingX,jt.Clamp),r.data.setAttribute(Dt.WrappingY,jt.Clamp);return ie.checkImageSizeSupportedAndLog(e),e.toBlob(a=>{const l=URL.createObjectURL(a);r.image.onload=()=>{URL.revokeObjectURL(l),r.data=r.image,r._readyFuture.resolve(r.image)},r.image.src=l}),r}static fromSvgString(e,s){const r=new Blob([e],{type:"image/svg+xml"}),a=URL.createObjectURL(r);return new Ni(a,s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){var e,s,r,a;if(this.isLoaded())return this.data;try{let l;if(this.path.includes("data:image/"))l=this.path;else{const m=await this._resource.load();l=URL.createObjectURL(m)}const f=new Image,g=new P;f.onload=()=>g.resolve(),f.src=l,f.setAttribute("data-original-src",this.path),await g.promise,this.data=f,ie.checkImageSizeSupportedAndLog(this.data)}catch(l){throw`Error loading ImageSource from path '${this.path}' with error [${l.message}]`}return this.data.setAttribute(Dt.Filtering,this.filtering),this.data.setAttribute(Dt.WrappingX,(s=(e=this.wrapping)===null||e===void 0?void 0:e.x)!==null&&s!==void 0?s:jt.Clamp),this.data.setAttribute(Dt.WrappingY,(a=(r=this.wrapping)===null||r===void 0?void 0:r.y)!==null&&a!==void 0?a:jt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(e){return Ti.from(this,e)}unload(){this.data=new Image}}class wo extends ee{constructor(e){super(e),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=at.getInstance();const{alphabet:s,spriteSheet:r,caseInsensitive:a,spacing:l,shadow:f,lineHeight:g}=e;this.alphabet=s,this.spriteSheet=r,this.caseInsensitive=a??this.caseInsensitive,this.spacing=l??this.spacing,this.shadow=f??this.shadow,this.lineHeight=g??this.lineHeight}_getCharacterSprites(e){const s=[],r=this.caseInsensitive?e.toLocaleLowerCase():e,a=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let l=0;l<r.length;l++){const f=r[l];let g=a.indexOf(f);g===-1&&(g=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${f}' in configured alphabet '${a}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const m=this.spriteSheet.sprites[g];m?s.push(m):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${f}' at index '${g}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return s}measureText(e,s){const r=this._getLinesFromText(e,s),a=r.reduce((m,w)=>m.length>w.length?m:w),l=this._getCharacterSprites(a);let f=0,g=0;for(const m of l)f+=m.width+this.spacing,g=Math.max(g,m.height);return ht.fromDimension(f*this.scale.x,g*r.length*this.scale.y,B.Zero)}_drawImage(e,s,r,a){var l;let f=0,g=0,m=0;const w=this._getLinesFromText(this._text,a);for(const y of w){for(const A of this._getCharacterSprites(y))A.draw(e,s+f,r+g),f+=A.width+this.spacing,m=Math.max(m,A.height);f=0,g+=(l=this.lineHeight)!==null&&l!==void 0?l:m}}render(e,s,r,a,l,f){this._text=s;const g=this.measureText(s,f);this.width=g.width,this.height=g.height,this.shadow&&(e.save(),e.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(e,a,l),this._drawImage(e,0,0,f),this._postDraw(e),e.restore()),this._preDraw(e,a,l),this._drawImage(e,0,0,f),this._postDraw(e)}clone(){return new wo({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(e,s){var r;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let f=a[l],g="";if(this.measureText(f).width>s){for(;this.measureText(f).width>s;)g=f[f.length-1]+g,f=f.slice(0,-1);a[l]=f,a[l+1]=g}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class vr extends Ti{constructor(e){super({image:e.image,sourceView:e.sourceView,destSize:{width:e.width,height:e.height},flipHorizontal:e.flipHorizontal,flipVertical:e.flipVertical,rotation:e.rotation,scale:e.scale,opacity:e.opacity,tint:e.tint,origin:e.origin}),this._ready=new P,this.ready=this._ready.promise,this._options=e,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(e,s){return new vr({sourceView:{...e.sourceView},width:e.width,height:e.height,...s,image:e.image})}_applyTiling(){const{width:e,height:s,filtering:r,wrapping:a}={...this._options},l=document.createElement("canvas");l.width=this.sourceView.width,l.height=this.sourceView.height,l.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const g=Ni.fromHtmlCanvasElement(l,{wrapping:a??jt.Repeat,filtering:r});e&&(this.destSize.width=e,this.sourceView.width=e),s&&(this.destSize.height=s,this.sourceView.height=s),this.sourceView.x=0,this.sourceView.y=0,this.image=g,this.image.ready.then(()=>this._ready.resolve())}}class sn{constructor(e){this.sprites=[];const{sprites:s,rows:r,columns:a}=e;this.sprites=s,this.rows=r??1,this.columns=a??this.sprites.length}getSprite(e,s,r){var a,l,f,g,m,w,y,A,E;if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const D=e+s*this.columns,L=this.sprites[D];if(L){if(r){const O=L.clone();return O.flipHorizontal=(a=r.flipHorizontal)!==null&&a!==void 0?a:O.flipHorizontal,O.flipVertical=(l=r.flipVertical)!==null&&l!==void 0?l:O.flipVertical,O.width=(f=r.width)!==null&&f!==void 0?f:O.width,O.height=(g=r.height)!==null&&g!==void 0?g:O.height,O.rotation=(m=r.rotation)!==null&&m!==void 0?m:O.rotation,O.scale=(w=r.scale)!==null&&w!==void 0?w:O.scale,O.opacity=(y=r.opacity)!==null&&y!==void 0?y:O.opacity,O.tint=(A=r.tint)!==null&&A!==void 0?A:O.tint,O.origin=(E=r.origin)!==null&&E!==void 0?E:O.origin,O}return L}throw Error(`Invalid sprite coordinates (${e}, ${s})`)}getTiledSprite(e,s,r){if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const a=e+s*this.columns,l=this.sprites[a];if(l)return vr.fromSprite(l,r);throw Error(`Invalid sprite coordinates (${e}, ${s})`)}static fromImageSourceWithSourceViews(e){const s=e.sourceViews.map(r=>new Ti({image:e.image,sourceView:r}));return new sn({sprites:s})}static fromImageSource(e){var s;const r=[];e.spacing=(s=e.spacing)!==null&&s!==void 0?s:{};const{image:a,grid:{rows:l,columns:f,spriteWidth:g,spriteHeight:m},spacing:{originOffset:w,margin:y}}=e,A={x:0,y:0,...w},E={x:0,y:0,...y};for(let D=0;D<f;D++)for(let L=0;L<l;L++)r[D+L*f]=new Ti({image:a,sourceView:{x:D*g+E.x*D+A.x,y:L*m+E.y*L+A.y,width:g,height:m},destSize:{height:m,width:g}});return new sn({sprites:r,rows:l,columns:f})}clone(){return new sn({sprites:this.sprites.map(e=>e.clone()),rows:this.rows,columns:this.columns})}}const Dg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class Na{constructor(){this.fontSheet=Dg,this.size=16,this.load()}load(){return this._imageSource=new Ni(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=sn.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new wo({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(e,s,r){this._imageSource.isLoaded()&&this._spriteFont.render(e,s,null,r.x,r.y)}}class Fg{constructor(e,s){this._gl=e,this._texture=s}use(){const e=this._gl;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._texture)}disable(){const e=this._gl;e.bindTexture(e.TEXTURE_2D,null)}}class xo{constructor(e){var s,r;this.antialias=!1,this.samples=1,this._gl=e.gl,this.width=e.width,this.height=e.height,this.transparency=e.transparency,this.antialias=(s=e.antialias)!==null&&s!==void 0?s:this.antialias,this.samples=(r=e.samples)!==null&&r!==void 0?r:this._gl.getParameter(this._gl.MAX_SAMPLES);const a=this._gl;a.drawingBufferFormat?this.bufferFormat=a.drawingBufferFormat:this.transparency?this.bufferFormat=a.RGBA8:this.bufferFormat=a.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(e,s){const r=this._gl;this.width=e,this.height=s,r.bindTexture(r.TEXTURE_2D,this._frameTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.width,this.height,0,r.RGBA,r.UNSIGNED_BYTE,null),this._renderBuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,this._renderBuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,Math.min(this.samples,r.getParameter(r.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const e=this._gl;this._renderBuffer=e.createRenderbuffer(),this._renderFrameBuffer=e.createFramebuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._renderBuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,Math.min(this.samples,e.getParameter(e.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const e=this._gl;this._frameTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._frameTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const s=e.COLOR_ATTACHMENT0;this._frameBuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,s,e.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new Fg(this._gl,this._frameTexture)}blitToScreen(){const e=this._gl;this._renderBuffer?(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)):(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.frameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const e=this._gl;e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.frameBuffer),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)}}copyToTexture(e){const s=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),s.bindFramebuffer(s.FRAMEBUFFER,this._frameBuffer),s.bindTexture(s.TEXTURE_2D,e),s.copyTexImage2D(s.TEXTURE_2D,0,s.RGBA,0,0,this.width,this.height,0)}use(){const e=this._gl;this.antialias?e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.viewport(0,0,this.width,this.height)}disable(){const e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null)}}const Mg=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,Bg=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function Ga(u,e){switch(e){case u.INT:case u.UNSIGNED_INT:case u.FLOAT:return 4;case u.SHORT:return 2;case u.UNSIGNED_SHORT:return 2;case u.BYTE:return 1;case u.UNSIGNED_BYTE:return 1;default:return 1}}function td(u,e){const s=`(?<type>[a-z0-9]+)\\s+${e};`,a=new RegExp(s,"g").exec(u);return a?.length>0}function ed(u,e,s){var r;const a=`(?<type>[a-z0-9]+)\\s+${s};`,f=new RegExp(a,"g").exec(e);switch((r=f?.groups)===null||r===void 0?void 0:r.type){case"float":case"vec2":case"vec3":case"vec4":return u.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return u.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return u.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return u.BOOL;case"short":return u.SHORT;case"ushort":return u.UNSIGNED_SHORT;case"ubyte":return u.UNSIGNED_BYTE;case"byte":return u.BYTE;default:return u.FLOAT}}function id(u,e){switch(e){case u.LOW_FLOAT:case u.HIGH_FLOAT:case u.FLOAT:return 1;case u.FLOAT_VEC2:return 2;case u.FLOAT_VEC3:return 3;case u.FLOAT_VEC4:return 4;case u.BYTE:return 1;case u.UNSIGNED_BYTE:return 1;case u.UNSIGNED_SHORT:case u.SHORT:return 1;default:return 1}}function sd(u,e){switch(e){case u.LOW_FLOAT:case u.HIGH_FLOAT:case u.FLOAT:case u.FLOAT_VEC2:case u.FLOAT_VEC3:case u.FLOAT_VEC4:return u.FLOAT;case u.BYTE:return u.BYTE;case u.UNSIGNED_BYTE:return u.UNSIGNED_BYTE;case u.SHORT:return u.SHORT;case u.UNSIGNED_SHORT:return u.UNSIGNED_SHORT;default:return u.FLOAT}}function Va(u,e){const s=a=>{const l=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let f="";for(let g=0;g<a;g++)g===0?f+=`if (index <= ${g}.5) {
`:f+=`   else if (index <= ${g}.5) {
`,f+=`      fragColor = vec4(1.0);
`,f+=`   }
`;return l.replace("%%complexity%%",f)};let r=!1;do{const a=s(e),l=u.createShader(u.FRAGMENT_SHADER);u.shaderSource(l,a),u.compileShader(l),r=u.getShaderParameter(l,u.COMPILE_STATUS),r||(e=e/2|0)}while(!r);return e}class ei{get compiled(){return this._compiled}constructor(e){this._logger=at.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:s,vertexSource:r,fragmentSource:a,onPreLink:l,onPostCompile:f}=e;this._gl=s,this.vertexSource=r,this.fragmentSource=a,this._onPreLink=l,this._onPostCompile=f}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),ei._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return ei._ACTIVE_SHADER_INSTANCE===this}compile(){const e=this._gl,s=this._compileShader(e,this.vertexSource,e.VERTEX_SHADER),r=this._compileShader(e,this.fragmentSource,e.FRAGMENT_SHADER);this.program=this._createProgram(e,s,r);const a=this.getAttributes();for(const f of a)this.attributes[f.name]=f;const l=this.getUniforms();for(const f of l)this.uniforms[f.name]=f;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS),r=[];for(let a=0;a<s;a++){const l=e.getActiveUniform(this.program,a),f=e.getUniformLocation(this.program,l.name);r.push({name:l.name,glType:l.type,location:f})}return r}getAttributes(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES),r=[];for(let a=0;a<s;a++){const l=e.getActiveAttrib(this.program,a),f=e.getAttribLocation(this.program,l.name);r.push({name:l.name,glType:sd(e,l.type),size:id(e,l.type),location:f,normalized:!1})}return r}setTexture(e,s){const r=this._gl;r.activeTexture(r.TEXTURE0+e),r.bindTexture(r.TEXTURE_2D,s)}setUniformInt(e,s){this.setUniform("uniform1i",e,~~s)}trySetUniformInt(e,s){return this.trySetUniform("uniform1i",e,~~s)}setUniformIntArray(e,s){this.setUniform("uniform1iv",e,s)}trySetUniformIntArray(e,s){return this.trySetUniform("uniform1iv",e,s)}setUniformBoolean(e,s){this.setUniform("uniform1i",e,s?1:0)}trySetUniformBoolean(e,s){return this.trySetUniform("uniform1i",e,s?1:0)}setUniformFloat(e,s){this.setUniform("uniform1f",e,s)}trySetUniformFloat(e,s){return this.trySetUniform("uniform1f",e,s)}setUniformFloatArray(e,s){this.setUniform("uniform1fv",e,s)}trySetUniformFloatArray(e,s){return this.trySetUniform("uniform1fv",e,s)}setUniformFloatVector(e,s){this.setUniform("uniform2f",e,s.x,s.y)}trySetUniformFloatVector(e,s){return this.trySetUniform("uniform2f",e,s.x,s.y)}setUniformFloatColor(e,s){this.setUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}trySetUniformFloatColor(e,s){return this.trySetUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}setUniformMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,s.data)}setUniformAffineMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,[s.data[0],s.data[1],0,0,s.data[2],s.data[3],0,0,0,0,1,0,s.data[4],s.data[5],0,1])}trySetUniformMatrix(e,s){return this.trySetUniform("uniformMatrix4fv",e,!1,s.data)}setUniform(e,s,...r){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${e}:${s}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const l=this._gl.getUniformLocation(this.program,s);if(l){const f=[l,...r];this._gl[e].apply(this._gl,f)}else throw Error(`Uniform ${e}:${s} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(e,s,...r){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${e}:${s}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const l=this._gl.getUniformLocation(this.program,s);if(l){const f=[l,...r];this._gl[e].apply(this._gl,f)}else return!1;return!0}_createProgram(e,s,r){const a=e.createProgram();if(a===null)throw Error("Could not create graphics shader program");if(e.attachShader(a,s),e.attachShader(a,r),this._onPreLink&&this._onPreLink(a),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw Error(`Could not link the program: [${e.getProgramInfoLog(a)}]`);return a}_compileShader(e,s,r){const a=e.VERTEX_SHADER===r?"vertex":"fragment",l=e.createShader(r);if(l===null)throw Error(`Could not build shader: [${s}]`);if(e.shaderSource(l,s),e.compileShader(l),!e.getShaderParameter(l,e.COMPILE_STATUS)){const g=e.getShaderInfoLog(l);throw Error(`Could not compile ${a} shader:

${g}${this._processSourceForError(s,g)}`)}return l}_processSourceForError(e,s){if(!e)return s;const r=e.split(`
`),a=s.search(/\d:\d/),l=s.indexOf(" ",a),[f,g]=s.slice(a,l).split(":").map(m=>Number(m));for(let m=0;m<r.length;m++)r[m]=`${m+1}: ${r[m]}${g===m+1?" <----- ERROR!":""}`;return`

Source:
`+r.join(`
`)}}ei._ACTIVE_SHADER_INSTANCE=null;class Gi{constructor(e){this.type="dynamic";const{gl:s,size:r,type:a,data:l}=e;if(this._gl=s,this.buffer=this._gl.createBuffer(),!l&&!r)throw Error("Must either provide data or a size to the VertexBuffer");l?this.bufferData=l:this.bufferData=new Float32Array(r),this.type=a??this.type,s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer)}unbind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,null)}upload(e){const s=this._gl;s.bindBuffer(s.ARRAY_BUFFER,this.buffer),e?s.bufferSubData(s.ARRAY_BUFFER,0,this.bufferData,0,e):s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class cs{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(e){this._logger=at.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:s,shader:r,vertexBuffer:a,attributes:l,suppressWarnings:f}=e;this._gl=s,this._vertexBuffer=a,this._attributes=l,this._shader=r,this._suppressWarnings=f,r&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(e){e&&this._shader!==e&&(this._shader=e,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const e=this._shader.attributes;for(const l of this._attributes){const f=e[l[0]];if(!f){if(!td(this._shader.vertexSource,l[0]))throw Error(`The attribute named: ${l[0]} size ${l[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${l[0]} size ${l[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${l[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${l[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const g=ed(this._gl,this._shader.vertexSource,l[0]);this._layout.push({name:l[0],glType:g,size:l[1],location:-1,normalized:!1})}if(f){if(f.size!==l[1])throw Error(`VertexLayout size definition for attribute: [${l[0]}, ${l[1]}], doesn't match shader source size ${f.size}:
 ${this._shader.vertexSource}`);this._layout.push(f)}}let s=0;for(const l of this._layout){const f=Ga(this._gl,l.glType);this._vertexTotalSizeBytes+=f*l.size,s+=l.size}this._vertexBuffer.bufferData.length%s!==0&&this._logger.warn(`The vertex component size (${s})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const r=this._gl;this._vao=r.createVertexArray(),r.bindVertexArray(this._vao),this._vertexBuffer.bind();let a=0;for(const l of this._layout)l.location!==-1&&(l.glType===r.INT?r.vertexAttribIPointer(l.location,l.size,l.glType,this.totalVertexSizeBytes,a):r.vertexAttribPointer(l.location,l.size,l.glType,l.normalized,this.totalVertexSizeBytes,a),r.enableVertexAttribArray(l.location)),a+=Ga(r,l.glType)*l.size;r.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(e=!1,s){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const r=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),e&&this._vertexBuffer.upload(s),r.bindVertexArray(this._vao)}}class Zt{static clear(){Zt.DrawCallCount=0,Zt.DrawnImagesCount=0}}Zt.DrawCallCount=0,Zt.DrawnImagesCount=0;class kg{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=z(0,0),this._endScratch=z(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new ei({gl:e,vertexSource:Mg,fragmentSource:Bg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new Gi({gl:e,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new cs({gl:e,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,r){this._isFull()&&this.flush(),this._lineCount++;const a=this._context.getTransform(),l=a.multiply(e,this._startScratch),f=a.multiply(s,this._endScratch),g=this._vertexBuffer.bufferData;g[this._vertexIndex++]=l.x,g[this._vertexIndex++]=l.y,g[this._vertexIndex++]=r.r/255,g[this._vertexIndex++]=r.g/255,g[this._vertexIndex++]=r.b/255,g[this._vertexIndex++]=r.a,g[this._vertexIndex++]=f.x,g[this._vertexIndex++]=f.y,g[this._vertexIndex++]=r.r/255,g[this._vertexIndex++]=r.g/255,g[this._vertexIndex++]=r.b/255,g[this._vertexIndex++]=r.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.LINES,0,this._lineCount*2),Zt.DrawnImagesCount+=this._lineCount,Zt.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const Lg=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,Ug=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class zg{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new ei({gl:e,vertexSource:Lg,fragmentSource:Ug}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new Gi({gl:e,size:7*this._maxPoints,type:"dynamic"}),this._layout=new cs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,r){this._isFull()&&this.flush(),this._pointCount++;const a=this._context.getTransform(),l=this._context.opacity,f=this._context.snapToPixel,g=a.multiply(e);f&&(g.x=~~(g.x+gt),g.y=~~(g.y+gt));const m=this._buffer.bufferData;m[this._vertexIndex++]=g.x,m[this._vertexIndex++]=g.y,m[this._vertexIndex++]=s.r/255,m[this._vertexIndex++]=s.g/255,m[this._vertexIndex++]=s.b/255,m[this._vertexIndex++]=s.a*l,m[this._vertexIndex++]=r*Math.max(a.getScaleX(),a.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.POINTS,0,this._pointCount),Zt.DrawnImagesCount+=this._pointCount,Zt.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const Hg=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,Og=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class Wg{constructor(e){this._gl=e,this._shader=new ei({gl:e,vertexSource:Hg,fragmentSource:Og}),this._shader.compile(),this._buffer=new Gi({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new cs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(e){const s=this._gl,r=e.getShader();r.use(),e.getLayout().use(),s.activeTexture(s.TEXTURE0),r.trySetUniformInt("u_image",0),e.onDraw&&e.onDraw(),s.drawArrays(s.TRIANGLES,0,6)}renderToScreen(){const e=this._gl;this._shader.use(),this._layout.use(),e.drawArrays(e.TRIANGLES,0,6)}}class wr{constructor(e,s,r){this._logger=at.getInstance(),this._gl=e,this.buffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer);const a=s*6;if(!r)this.bufferData=new Uint32Array(a);else{const g=Math.floor(16383.5);this.bufferGlType=e.UNSIGNED_SHORT,this.bufferData=new Uint16Array(a),s>g&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${g}) requested quads(${s})`)}let l=0;for(let f=0;f<a;f+=6)this.bufferData[f+0]=l+0,this.bufferData[f+1]=l+1,this.bufferData[f+2]=l+2,this.bufferData[f+3]=l+2,this.bufferData[f+4]=l+1,this.bufferData[f+5]=l+3,l+=4;e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const Ng=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,Gg=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class Vg{constructor(e){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=Q.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=Va(e,r);this._maxTextures=Math.min(r,a);const l=this._transformFragmentSource(Ng,this._maxTextures);this._shader=new ei({gl:e,fragmentSource:l,vertexSource:Gg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((f,g)=>g)),this._buffer=new Gi({gl:e,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new cs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new wr(e,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let r=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_textureIndex <= ${l}.5) {
`:a+=`   else if (v_textureIndex <= ${l}.5) {
`,a+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return r=r.replace("%%texture_picker%%",a),r}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(Dt.Filtering),r=s?Ln(s):void 0,a=Ei(e.getAttribute(Dt.WrappingX)),l=Ei(e.getAttribute(Dt.WrappingY)),f=e.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);e.removeAttribute("forceUpload"),this._textures.indexOf(g)===-1&&(this._textures.push(g),this._textureToIndex.set(g,this._textureIndex++),this._images.add(e))}_bindTextures(e){for(let s=0;s<this._maxTextures;s++)e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_2D,this._textures[s]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const r=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(r))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,r,a,l,f,g,m,w){var y,A,E,D;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const L=this._getImageWidth(e),O=this._getImageHeight(e);let q=L||a||0,H=O||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(y=a??L)!==null&&y!==void 0?y:0,this._view[3]=(A=l??O)!==null&&A!==void 0?A:0,this._dest[0]=s??1,this._dest[1]=r??1,f!==void 0&&g!==void 0&&m!==void 0&&w!==void 0&&(this._view[0]=s??1,this._view[1]=r??1,this._view[2]=(E=a??L)!==null&&E!==void 0?E:0,this._view[3]=(D=l??O)!==null&&D!==void 0?D:0,this._dest[0]=f,this._dest[1]=g,q=m,H=w),s=this._view[0],r=this._view[1];const N=this._view[2],J=this._view[3],Y=this._context.getTransform(),$=this._context.opacity,ot=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+q,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+H,this._quad[6]=this._dest[0]+q,this._quad[7]=this._dest[1]+H,Y.multiplyQuadInPlace(this._quad),ot&&(this._quad[0]=~~(this._quad[0]+V(this._quad[0])*gt),this._quad[1]=~~(this._quad[1]+V(this._quad[1])*gt),this._quad[2]=~~(this._quad[2]+V(this._quad[2])*gt),this._quad[3]=~~(this._quad[3]+V(this._quad[3])*gt),this._quad[4]=~~(this._quad[4]+V(this._quad[4])*gt),this._quad[5]=~~(this._quad[5]+V(this._quad[5])*gt),this._quad[6]=~~(this._quad[6]+V(this._quad[6])*gt),this._quad[7]=~~(this._quad[7]+V(this._quad[7])*gt));const Z=this._context.tint||this._defaultTint,_t=this._getTextureIdForImage(e),Et=L||q,Yt=O||H,Qt=(s+this.uvPadding)/Et,Se=(r+this.uvPadding)/Yt,te=(s+N-this.uvPadding)/Et,zt=(r+J-this.uvPadding)/Yt,Ne=L,Fe=O,it=this._layout.vertexBuffer.bufferData;it[this._vertexIndex++]=this._quad[0],it[this._vertexIndex++]=this._quad[1],it[this._vertexIndex++]=$,it[this._vertexIndex++]=Ne,it[this._vertexIndex++]=Fe,it[this._vertexIndex++]=Qt,it[this._vertexIndex++]=Se,it[this._vertexIndex++]=_t,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a,it[this._vertexIndex++]=this._quad[4],it[this._vertexIndex++]=this._quad[5],it[this._vertexIndex++]=$,it[this._vertexIndex++]=Ne,it[this._vertexIndex++]=Fe,it[this._vertexIndex++]=Qt,it[this._vertexIndex++]=zt,it[this._vertexIndex++]=_t,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a,it[this._vertexIndex++]=this._quad[2],it[this._vertexIndex++]=this._quad[3],it[this._vertexIndex++]=$,it[this._vertexIndex++]=Ne,it[this._vertexIndex++]=Fe,it[this._vertexIndex++]=te,it[this._vertexIndex++]=Se,it[this._vertexIndex++]=_t,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a,it[this._vertexIndex++]=this._quad[6],it[this._vertexIndex++]=this._quad[7],it[this._vertexIndex++]=$,it[this._vertexIndex++]=Ne,it[this._vertexIndex++]=Fe,it[this._vertexIndex++]=te,it[this._vertexIndex++]=zt,it[this._vertexIndex++]=_t,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),this._quads.bind(),e.drawElements(e.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),Zt.DrawnImagesCount+=this._imageCount,Zt.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const Xg=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,qg=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class Yg{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=Q.Transparent,this._scratch1=z(0,0),this._scratch2=z(0,0),this._scratch3=z(0,0),this._scratch4=z(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new ei({gl:e,fragmentSource:Xg,vertexSource:qg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new Gi({gl:e,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new cs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new wr(e,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...e){e[0]instanceof B&&e[1]instanceof B?this.drawLine.apply(this,e):this.drawRectangle.apply(this,e)}drawLine(e,s,r,a=1){this._isFull()&&this.flush(),this._rectangleCount++;const l=this._context.getTransform(),f=this._context.opacity,g=this._context.snapToPixel,m=s.sub(e),w=m.magnitude,y=m.normalize().perpendicular(),A=a/2,E=l.multiply(y.scale(A,this._scratch1).add(e,this._scratch1),this._scratch1),D=l.multiply(y.scale(-A,this._scratch2).add(e,this._scratch2),this._scratch2),L=l.multiply(y.scale(A,this._scratch3).add(s,this._scratch3),this._scratch3),O=l.multiply(y.scale(-A,this._scratch4).add(s,this._scratch4),this._scratch4);g&&(E.x=~~(E.x+gt),E.y=~~(E.y+gt),L.x=~~(L.x+gt),L.y=~~(L.y+gt),D.x=~~(D.x+gt),D.y=~~(D.y+gt),O.x=~~(O.x+gt),O.y=~~(O.y+gt));const q=0,H=0,N=1,J=1,Y=this._transparent,$=0,ot=1,Z=this._layout.vertexBuffer.bufferData;Z[this._vertexIndex++]=E.x,Z[this._vertexIndex++]=E.y,Z[this._vertexIndex++]=q,Z[this._vertexIndex++]=H,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=$/ot,Z[this._vertexIndex++]=D.x,Z[this._vertexIndex++]=D.y,Z[this._vertexIndex++]=q,Z[this._vertexIndex++]=J,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=$/ot,Z[this._vertexIndex++]=L.x,Z[this._vertexIndex++]=L.y,Z[this._vertexIndex++]=N,Z[this._vertexIndex++]=H,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=$/ot,Z[this._vertexIndex++]=O.x,Z[this._vertexIndex++]=O.y,Z[this._vertexIndex++]=N,Z[this._vertexIndex++]=J,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=$/ot}drawRectangle(e,s,r,a,l=Q.Transparent,f=0){this._isFull()&&this.flush(),this._rectangleCount++;const g=this._context.getTransform(),m=this._context.opacity,w=this._context.snapToPixel,y=g.multiply(e.add(z(0,0))),A=g.multiply(e.add(z(s,0))),E=g.multiply(e.add(z(s,r))),D=g.multiply(e.add(z(0,r)));w&&(y.x=~~(y.x+gt),y.y=~~(y.y+gt),A.x=~~(A.x+gt),A.y=~~(A.y+gt),D.x=~~(D.x+gt),D.y=~~(D.y+gt),E.x=~~(E.x+gt),E.y=~~(E.y+gt));const L=0,O=0,q=1,H=1,N=this._layout.vertexBuffer.bufferData;N[this._vertexIndex++]=y.x,N[this._vertexIndex++]=y.y,N[this._vertexIndex++]=L,N[this._vertexIndex++]=O,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=f,N[this._vertexIndex++]=D.x,N[this._vertexIndex++]=D.y,N[this._vertexIndex++]=L,N[this._vertexIndex++]=H,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=f,N[this._vertexIndex++]=A.x,N[this._vertexIndex++]=A.y,N[this._vertexIndex++]=q,N[this._vertexIndex++]=O,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=f,N[this._vertexIndex++]=E.x,N[this._vertexIndex++]=E.y,N[this._vertexIndex++]=q,N[this._vertexIndex++]=H,N[this._vertexIndex++]=s,N[this._vertexIndex++]=r,N[this._vertexIndex++]=m,N[this._vertexIndex++]=a.r/255,N[this._vertexIndex++]=a.g/255,N[this._vertexIndex++]=a.b/255,N[this._vertexIndex++]=a.a,N[this._vertexIndex++]=l.r/255,N[this._vertexIndex++]=l.g/255,N[this._vertexIndex++]=l.b/255,N[this._vertexIndex++]=l.a,N[this._vertexIndex++]=f}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),Zt.DrawnImagesCount+=this._rectangleCount,Zt.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const jg=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,Zg=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class Qg{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new ei({gl:e,fragmentSource:jg,vertexSource:Zg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new Gi({gl:e,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new cs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new wr(e,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(e,s,r,a=Q.Transparent,l=0){this._isFull()&&this.flush(),this._circleCount++;const f=this._context.getTransform(),g=this._context.opacity,m=this._context.snapToPixel,w=f.multiply(e.add(z(-s,-s))),y=f.multiply(e.add(z(s,-s))),A=f.multiply(e.add(z(s,s))),E=f.multiply(e.add(z(-s,s)));m&&(w.x=~~(w.x+gt),w.y=~~(w.y+gt),y.x=~~(y.x+gt),y.y=~~(y.y+gt),E.x=~~(E.x+gt),E.y=~~(E.y+gt),A.x=~~(A.x+gt),A.y=~~(A.y+gt));const D=0,L=0,O=1,q=1,H=this._layout.vertexBuffer.bufferData;H[this._vertexIndex++]=w.x,H[this._vertexIndex++]=w.y,H[this._vertexIndex++]=D,H[this._vertexIndex++]=L,H[this._vertexIndex++]=g,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=E.x,H[this._vertexIndex++]=E.y,H[this._vertexIndex++]=D,H[this._vertexIndex++]=q,H[this._vertexIndex++]=g,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=y.x,H[this._vertexIndex++]=y.y,H[this._vertexIndex++]=O,H[this._vertexIndex++]=L,H[this._vertexIndex++]=g,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=A.x,H[this._vertexIndex++]=A.y,H[this._vertexIndex++]=O,H[this._vertexIndex++]=q,H[this._vertexIndex++]=g,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),Zt.DrawnImagesCount+=this._circleCount,Zt.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class bo{constructor(e,s,r=100){this.builder=e,this.recycler=s,this.maxObjects=r,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=at.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let e=0;e<this.maxObjects;e++)this.objects[e]=this.builder()}using(e){const s=e(this);return s?this.done(...s):this.done()}borrow(e){const s=this.get();e(s),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...e){this.index=0;for(const s of e){const r=this.objects.indexOf(s);this.objects[r]=this.builder(),this.totalAllocations++}return e}}class Jg{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=ue.identity(),this.state={z:0,opacity:1,tint:Q.White,material:null},this.args=new Array(10)}}const Kg=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class nd{constructor(e){this._logger=at.getInstance(),this._color=Q.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:s,name:r,vertexSource:a,fragmentSource:l,graphicsContext:f,images:g}=e;if(this._name=r??"anonymous material",this._vertexSource=a??Kg,this._fragmentSource=l,this._color=s??this._color,!f)throw Error(`Material ${r} must be provided an excalibur webgl graphics context`);if(f instanceof us?(this._graphicsContext=f,this._initialize(f)):this._logger.warn(`Material ${r} was created in 2D Canvas mode, currently only WebGL is supported`),g)for(const m in g)this.addImageSource(m,g[m])}_initialize(e){if(this._initialized)return;const s=e.__gl;this._maxTextureSlots=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=e.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(e){this._color=e}get name(){var e;return(e=this._name)!==null&&e!==void 0?e:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(e){this._shader&&(this._shader.use(),e(this._shader))}getShader(){return this._shader}addImageSource(e,s){this._images.size<this._maxTextureSlots?this._images.set(e,s):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(e){const s=this._images.get(e);this._graphicsContext.textureLoader.delete(s.image),this._images.delete(e)}_loadImageSource(e){const s=e.image,r=s.getAttribute(Dt.Filtering),a=r?Ln(r):void 0,l=Ei(s.getAttribute(Dt.WrappingX)),f=Ei(s.getAttribute(Dt.WrappingY)),g=s.getAttribute("forceUpload")==="true",m=this._graphicsContext.textureLoader.load(s,{filtering:a,wrapping:{x:l,y:f}},g);return s.removeAttribute("forceUpload"),this._textures.has(e)||this._textures.set(e,m),m}uploadAndBind(e,s=2){let r=s;for(const[a,l]of this._images.entries()){if(!l.isLoaded()){this._logger.warnOnce(`Image named ${a} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const f=this._loadImageSource(l);e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,f),this._shader.trySetUniformInt(a,r),r++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class rd{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(e,s){this._gl=e,this._context=s,this._buffer=new Gi({gl:e,size:6*4,type:"dynamic"}),this._layout=new cs({gl:e,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new wr(e,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(e,s,r,a,l,f,g,m,w){var y,A,E,D;const L=this._gl,O=this._context.material;if(!O)return;const q=this._context.getTransform(),H=this._context.opacity,N=O.getShader(),J=this._layout.vertexBuffer.bufferData;let Y=0,$=e?.width||a||0,ot=e?.height||l||0,Z=[0,0,(y=a??e?.width)!==null&&y!==void 0?y:0,(A=l??e?.height)!==null&&A!==void 0?A:0],_t=[s??1,r??1];f!==void 0&&g!==void 0&&m!==void 0&&w!==void 0&&(Z=[s??1,r??1,(E=a??e?.width)!==null&&E!==void 0?E:0,(D=l??e?.height)!==null&&D!==void 0?D:0],_t=[f,g],$=m,ot=w),s=Z[0],r=Z[1];const Et=Z[2],Yt=Z[3],Qt=z(_t[0],_t[1]),Se=z(_t[0]+$,_t[1]),te=z(_t[0],_t[1]+ot),zt=z(_t[0]+$,_t[1]+ot),Ne=e.width||$,Fe=e.height||ot,it=s/Ne,_n=r/Fe,gn=(s+Et-.01)/Ne,pn=(r+Yt-.01)/Fe,Zn=q.getPosition(),ku=Zn.add(zt),Lu=Zn.x/this._context.width,Uu=Zn.y/this._context.height,zu=ku.x/this._context.width,Hu=ku.y/this._context.height;J[Y++]=Qt.x,J[Y++]=Qt.y,J[Y++]=it,J[Y++]=_n,J[Y++]=Lu,J[Y++]=Uu,J[Y++]=te.x,J[Y++]=te.y,J[Y++]=it,J[Y++]=pn,J[Y++]=Lu,J[Y++]=Hu,J[Y++]=Se.x,J[Y++]=Se.y,J[Y++]=gn,J[Y++]=_n,J[Y++]=zu,J[Y++]=Uu,J[Y++]=zt.x,J[Y++]=zt.y,J[Y++]=gn,J[Y++]=pn,J[Y++]=zu,J[Y++]=Hu;const xm=this._addImageAsTexture(e);O.use(),this._layout.shader=N,this._layout.use(!0),N.trySetUniformFloat("u_time_ms",performance.now()),N.trySetUniformFloat("u_opacity",H),N.trySetUniformFloatVector("u_resolution",z(this._context.width,this._context.height)),N.trySetUniformFloatVector("u_graphic_resolution",z(Ne,Fe)),N.trySetUniformFloatVector("u_size",z(Et,Yt)),N.trySetUniformMatrix("u_matrix",this._context.ortho),N.trySetUniformMatrix("u_transform",q.to4x4()),L.activeTexture(L.TEXTURE0+0),L.bindTexture(L.TEXTURE_2D,xm),N.trySetUniformInt("u_graphic",0),L.activeTexture(L.TEXTURE0+1),L.bindTexture(L.TEXTURE_2D,this._context.materialScreenTexture),N.trySetUniformInt("u_screen_texture",1),O.uploadAndBind(L),this._quads.bind(),L.drawElements(L.TRIANGLES,6,this._quads.bufferGlType,0),Zt.DrawnImagesCount++,Zt.DrawCallCount++}_addImageAsTexture(e){const s=e.getAttribute(Dt.Filtering),r=s?Ln(s):void 0,a=Ei(e.getAttribute(Dt.WrappingX)),l=Ei(e.getAttribute(Dt.WrappingY)),f=e.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);return e.removeAttribute("forceUpload"),this._textures.indexOf(g)===-1&&this._textures.push(g),g}hasPendingDraws(){return!1}flush(){}}const $g=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,tp=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var Re;(function(u){u.World="world",u.Screen="screen"})(Re||(Re={}));class Xa extends B{constructor(e){super(0,0),this._getX=e.getX,this._getY=e.getY,this._setX=e.setX,this._setY=e.setY}get x(){return this._x=this._getX()}set x(e){this._setX(e),this._x=e}get y(){return this._y=this._getY()}set y(e){this._setY(e),this._y=e}}class Bs extends B{constructor(e,s){super(e.x,e.y),this.original=e,this.change=s}get x(){return this._x=this.original.x}set x(e){e!==this._x&&(this.change(e,this._y),this._x=this.original.x=e)}get y(){return this._y=this.original.y}set y(e){e!==this._y&&(this.change(this._x,e),this._y=this.original.y=e)}setTo(e,s){this.x=e,this.y=s}}class ds{constructor(){this._parent=null,this._children=[],this._pos=new Bs(z(0,0),()=>{this.flagDirty()}),this._globalPos=new Xa({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:e=>{if(this.parent){const{x:s}=this.parent.inverse.multiply(z(e,this.pos.y));this.pos.x=s}else this.pos.x=e;e!==this.matrix.data[4]&&this.flagDirty()},setY:e=>{if(this.parent){const{y:s}=this.parent.inverse.multiply(z(this.pos.x,e));this.pos.y=s}else this.pos.y=e;e!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new Bs(z(1,1),()=>{this.flagDirty()}),this._globalScale=new Xa({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:e=>{if(this.parent){const s=this.parent.globalScale.x;this.scale.x=e/s}else this.scale.x=e},setY:e=>{if(this.parent){const s=this.parent.globalScale.y;this.scale.y=e/s}else this.scale.y=e}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=ue.identity(),this._inverse=ue.identity(),this._scratch=ue.identity()}get parent(){return this._parent}set parent(e){if(this._parent){const s=this._parent._children.indexOf(this);s>-1&&this._parent._children.splice(s,1)}this._parent=e,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(e){this._pos.x=e.x,this._pos.y=e.y}get pos(){return this._pos}set globalPos(e){let s=e.clone();this.parent&&(s=this.parent.inverse.multiply(e)),s.equals(this._pos)||(this._pos=s,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(e){const s=rt(e);s!==this._rotation&&this.flagDirty(),this._rotation=s}get rotation(){return this._rotation}set globalRotation(e){let s=0;this.parent&&(s=this.parent.globalRotation);const r=rt(e+s);r!==this._rotation&&this.flagDirty(),this._rotation=r}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(e){this._scale.x=e.x,this._scale.y=e.y}get scale(){return this._scale}set globalScale(e){let s=z(1,1);this.parent&&(s=this.parent.globalScale),this.scale=e.scale(z(1/s.x,1/s.y))}get globalScale(){return this._globalScale}set z(e){this._z=e,this.flagDirty()}get z(){return this._z}set globalZ(e){this.parent?this.z=e-this.parent.globalZ:this.z=e}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let e=0;e<this._children.length;e++)this._children[e].flagDirty()}apply(e){return this.matrix.multiply(e)}applyInverse(e){return this.inverse.multiply(e)}setTransform(e,s,r){this._pos.x=e.x,this._pos.y=e.y,this._rotation=rt(s),this._scale.x=r.x,this._scale.y=r.y,this.flagDirty()}isMirrored(){const e=V(this.scale.x)>>>31,s=V(this.scale.y)>>>31;return!!(e^s)}clone(e){const s=e??new ds;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.flagDirty(),s}cloneWithParent(e){const s=e??new ds;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.parent=this.parent,s.flagDirty(),s}toString(){return this.matrix.toString()}}function od(u){return!!u&&!!u.prototype&&!!u.prototype.constructor}function ep(u){return!!u?.clone}class Ai{constructor(){this.owner=void 0}clone(){const e=new this.constructor;for(const s in this)if(this.hasOwnProperty(s)){const r=this[s];ep(r)&&s!=="owner"&&s!=="clone"?e[s]=r.clone():e[s]=r}return e}}class Ye{constructor(){this.observers=[],this.subscriptions=[]}register(e){this.observers.push(e)}subscribe(e){this.subscriptions.push(e)}unregister(e){const s=this.observers.indexOf(e);s!==-1&&this.observers.splice(s,1)}unsubscribe(e){const s=this.subscriptions.indexOf(e);s!==-1&&this.subscriptions.splice(s,1)}notifyAll(e){const s=this.observers.length;for(let a=0;a<s;a++)this.observers[a].notify(e);const r=this.subscriptions.length;for(let a=0;a<r;a++)this.subscriptions[a](e)}clear(){this.observers.length=0,this.subscriptions.length=0}}class et extends Ai{constructor(){super(...arguments),this._logger=at.getInstance(),this._parentComponent=null,this._transform=new ds,this._addChildTransform=e=>{const s=e.get(et);s&&(s._transform.parent=this._transform,s._parentComponent=this)},this.zIndexChanged$=new Ye,this._coordPlane=Re.World}get(){return this._transform}onAdd(e){for(const s of e.children)this._addChildTransform(s);e.childrenAdded$.subscribe(s=>this._addChildTransform(s)),e.childrenRemoved$.subscribe(s=>{const r=s.get(et);r&&(r._transform.parent=null,r._parentComponent=null)})}onRemove(e){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(e){const s=this._transform.z;this._transform.z=e,s!==e&&this.zIndexChanged$.notifyAll(e)}get globalZ(){return this._transform.globalZ}set globalZ(e){this._transform.globalZ=e}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(e){var s;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(s=this.owner)===null||s===void 0?void 0:s.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=e}get pos(){return this._transform.pos}set pos(e){this._transform.pos=e}get globalPos(){return this._transform.globalPos}set globalPos(e){this._transform.globalPos=e}get rotation(){return this._transform.rotation}set rotation(e){this._transform.rotation=e}get globalRotation(){return this._transform.globalRotation}set globalRotation(e){this._transform.globalRotation=e}get scale(){return this._transform.scale}set scale(e){this._transform.scale=e}get globalScale(){return this._transform.globalScale}set globalScale(e){this._transform.globalScale=e}applyInverse(e){return this._transform.applyInverse(e)}apply(e){return this._transform.apply(e)}clone(){const e=new et;return e._transform=this._transform.clone(),e}}var xr;(function(u){u.Forward="forward",u.Backward="backward"})(xr||(xr={}));var Ii;(function(u){u.End="end",u.Loop="loop",u.PingPong="pingpong",u.Freeze="freeze"})(Ii||(Ii={}));const ip={Frame:"frame",Loop:"loop",End:"end"};class Ri extends ee{constructor(e){var s,r,a;super(e),this.events=new I,this.frames=[],this.strategy=Ii.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=e.frames,this.speed=(s=e.speed)!==null&&s!==void 0?s:this.speed,this.strategy=(r=e.strategy)!==null&&r!==void 0?r:this.strategy,this.frameDuration=e.totalDuration?e.totalDuration/this.frames.length:(a=e.frameDuration)!==null&&a!==void 0?a:this.frameDuration,e.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new Ri({frames:this.frames.map(e=>({...e})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.width*this.scale.x):0}get height(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.height*this.scale.y):0}static fromSpriteSheet(e,s,r,a=Ii.Loop){const l=e.sprites.length-1,f=s.filter(g=>g<0||g>l);return f.length&&Ri._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${f.join(",")} no frame will be shown`),new Ri({frames:e.sprites.filter((g,m)=>s.indexOf(m)>-1).map(g=>({graphic:g,duration:r})),strategy:a})}static fromSpriteSheetCoordinates(e){var s;const{spriteSheet:r,frameCoordinates:a,durationPerFrame:l,durationPerFrameMs:f,speed:g,strategy:m,reverse:w}=e,y=(s=l??f)!==null&&s!==void 0?s:100,A=[];for(const E of a){const{x:D,y:L,duration:O,options:q}=E,H=r.getSprite(D,L,q);H?A.push({graphic:H,duration:O??y}):Ri._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${D}, ${L}), please check your SpriteSheet to confirm that sprite exists`)}return new Ri({frames:A,strategy:m,speed:g,reverse:w})}get speed(){return this._speed}set speed(e){this._speed=j(Math.abs(e),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?xr.Backward:xr.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const e=this.frames[this._currentFrame];e&&(this._timeLeftInFrame=e?.duration||this.frameDuration)}get canFinish(){switch(this.strategy){case Ii.End:case Ii.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(e,s){this._currentFrame=e,this._timeLeftInFrame=s??this.frameDuration;const r=this.frames[this._currentFrame];r&&!this._done&&(this._timeLeftInFrame=s??(r?.duration||this.frameDuration),this.events.emit("frame",{...r,frameIndex:this.currentFrameIndex}))}_nextFrame(){const e=this._currentFrame;if(this._done)return e;let s=-1;switch(this.strategy){case Ii.Loop:{s=(e+1)%this.frames.length,s===0&&this.events.emit("loop",this);break}case Ii.End:{s=e+1,s>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case Ii.Freeze:{s=j(e+1,0,this.frames.length-1),s>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case Ii.PingPong:{e+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),e+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),s=e+this._pingPongDirection%this.frames.length;break}}return s}tick(e,s=0){this._idempotencyToken!==s&&(this._idempotencyToken=s,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=e*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(e,s,r){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(e,s,r)}}Ri._LOGGER=at.getInstance();class Un extends ee{constructor(e){var s;super(e),this._logger=at.getInstance(),this.useAnchor=!0,this.members=[],this.members=e.members,this.useAnchor=(s=e.useAnchor)!==null&&s!==void 0?s:this.useAnchor,this._updateDimensions()}clone(){return new Un({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const e=this.localBounds;return this.width=e.width,this.height=e.height,e}get localBounds(){const e=new ht;for(const s of this.members)if(s instanceof ee)s.localBounds.combine(e,e);else{const{graphic:r,offset:a,useBounds:l}=s;r?(l===void 0?!0:l)&&r.localBounds.translate(a).combine(e,e):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(s)}.`)}return e}_isAnimationOrGroup(e){return e instanceof Ri||e instanceof Un}tick(e,s){for(const r of this.members){let a;r instanceof ee?a=r:a=r.graphic,this._isAnimationOrGroup(a)&&a.tick(e,s)}}reset(){for(const e of this.members){let s;e instanceof ee?s=e:s=e.graphic,this._isAnimationOrGroup(s)&&s.reset()}}_preDraw(e,s,r){this._updateDimensions(),super._preDraw(e,this.useAnchor?s:0,this.useAnchor?r:0)}_drawImage(e,s,r){const a=B.Zero;for(const l of this.members){let f;l instanceof ee?f=l:(f=l.graphic,l.offset.clone(a)),f&&(e.save(),e.translate(s,r),f.draw(e,a.x,a.y),this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore())}}}class zn extends ee{constructor(e){var s,r,a,l,f,g,m,w,y,A;super(Jc({...e},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=Pi(Q.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,e&&(this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this.color=(r=e.color)!==null&&r!==void 0?r:Q.Black,this.strokeColor=e?.strokeColor,this.smoothing=(a=e.smoothing)!==null&&a!==void 0?a:this.smoothing,this.lineWidth=(l=e.lineWidth)!==null&&l!==void 0?l:this.lineWidth,this.lineDash=(f=e.lineDash)!==null&&f!==void 0?f:this.lineDash,this.lineCap=(g=e.lineCap)!==null&&g!==void 0?g:this.lineCap,this.padding=(m=e.padding)!==null&&m!==void 0?m:this.padding,this.filtering=(w=e.filtering)!==null&&w!==void 0?w:this.filtering),this._bitmap=document.createElement("canvas");const E=(y=e?.width)!==null&&y!==void 0?y:this._bitmap.width,D=(A=e?.height)!==null&&A!==void 0?A:this._bitmap.height;this.width=E,this.height=D;const L=this._bitmap.getContext("2d");if(L)this._ctx=L;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(e){e/=Math.abs(this.scale.x),this._bitmap.width=e,this._originalWidth=e,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(e){e/=Math.abs(this.scale.y),this._bitmap.height=e,this._originalHeight=e,this.flagDirty()}_getTotalWidth(){var e;return(((e=this._originalWidth)!==null&&e!==void 0?e:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var e;return(((e=this._originalHeight)!==null&&e!==void 0?e:this._bitmap.height)+this.padding*2)*1}get localBounds(){return ht.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,B.Zero)}get smoothing(){return this._smoothing}set smoothing(e){this._smoothing=e,this.flagDirty()}get color(){return this._color}set color(e){this.flagDirty(),this._color=Pi(e,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(e){this.flagDirty(),e&&(this._strokeColor=Pi(e,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(e){this._lineDash=e,this.flagDirty()}get padding(){return this._padding}set padding(e){this._padding=e,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(e){var s,r,a,l;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),e.scale(this.quality,this.quality),e.translate(this.padding,this.padding),e.imageSmoothingEnabled=this.smoothing,e.lineWidth=this.lineWidth,e.setLineDash((s=this.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.lineCap=this.lineCap,e.strokeStyle=(a=(r=this.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&a!==void 0?a:"",e.fillStyle=(l=this.color)===null||l===void 0?void 0:l.toString()}_drawImage(e,s,r){this._dirty&&this.rasterize(),e.scale(1/this.quality,1/this.quality),e.drawImage(this._bitmap,s,r)}}var yo;(function(u){u.Em="em",u.Rem="rem",u.Px="px",u.Pt="pt",u.Percent="%"})(yo||(yo={}));var Ao;(function(u){u.Left="left",u.Right="right",u.Center="center",u.Start="start",u.End="end"})(Ao||(Ao={}));var Co;(function(u){u.Top="top",u.Hanging="hanging",u.Middle="middle",u.Alphabetic="alphabetic",u.Ideographic="ideographic",u.Bottom="bottom"})(Co||(Co={}));var So;(function(u){u.Normal="normal",u.Italic="italic",u.Oblique="oblique"})(So||(So={}));var Po;(function(u){u.LeftToRight="ltr",u.RightToLeft="rtl"})(Po||(Po={}));function qa(u,e=Q.Red,s,r,a,l,f=1,g="butt"){u.save(),u.beginPath(),u.lineWidth=f,u.lineCap=g,u.strokeStyle=e.toString(),u.moveTo(s,r),u.lineTo(a,l),u.closePath(),u.stroke(),u.restore()}function sp(u,e=Q.Red,s){u.beginPath(),u.strokeStyle=e.toString(),u.arc(s.x,s.y,5,0,Math.PI*2),u.closePath(),u.stroke()}function np(u,e,s,r,a=1){const l=e?e.toString():"blue",f=r.scale(a);u.beginPath(),u.strokeStyle=l,u.moveTo(s.x,s.y),u.lineTo(s.x+f.x,s.y+f.y),u.closePath(),u.stroke()}function Ya(u,e,s,r,a,l=5,f=Q.White,g=null){let m;if(typeof l=="number")m={tl:l,tr:l,br:l,bl:l};else{const w={tl:0,tr:0,br:0,bl:0};for(const y in w)if(w.hasOwnProperty(y)){const A=y;m[A]=l[A]||w[A]}}u.beginPath(),u.moveTo(e+m.tl,s),u.lineTo(e+r-m.tr,s),u.quadraticCurveTo(e+r,s,e+r,s+m.tr),u.lineTo(e+r,s+a-m.br),u.quadraticCurveTo(e+r,s+a,e+r-m.br,s+a),u.lineTo(e+m.bl,s+a),u.quadraticCurveTo(e,s+a,e,s+a-m.bl),u.lineTo(e,s+m.tl),u.quadraticCurveTo(e,s,e+m.tl,s),u.closePath(),g&&(u.fillStyle=g.toString(),u.fill()),f&&(u.strokeStyle=f.toString(),u.stroke())}function rp(u,e,s,r,a=Q.White,l=null){u.beginPath(),u.arc(e,s,r,0,Math.PI*2),u.closePath(),l&&(u.fillStyle=l.toString(),u.fill()),a&&(u.strokeStyle=a.toString(),u.stroke())}class Hn{constructor(e,s,r,a){this.font=e,this.text=s,this.color=r,this.maxWidth=a,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const l=this.canvas.getContext("2d");if(!l)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=l,this.dimensions=this.measureText(s),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(e,s){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let r=null;s!=null?r=this._getLinesFromText(e,s):r=e.split(`
`);const a=r.reduce((E,D)=>E.length>D.length?E:D);this._applyFont(this.ctx);const l=this.ctx.measureText(a);let f=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);const g=f*r.length;f=g;const m=g-Math.abs(l.actualBoundingBoxAscent),w=0,y=0;return new ht({left:w-Math.abs(l.actualBoundingBoxLeft)-this.font.padding,top:y-Math.abs(l.actualBoundingBoxAscent)-this.font.padding,bottom:y+m+this.font.padding,right:w+Math.abs(l.actualBoundingBoxRight)+this.font.padding})}_setDimension(e,s){let r=1;this.font.lineHeight&&(r=this.font.lineHeight/this.font.size),s.canvas.width=(e.width+this.font.padding*2)*2*this.font.quality,s.canvas.height=(e.height+this.font.padding*2)*2*this.font.quality*r}static getHashCode(e,s,r){var a;return s+"__hashcode__"+e.fontString+e.showDebug+e.textAlign+e.baseAlign+e.direction+e.lineHeight+JSON.stringify(e.shadow)+(e.padding.toString()+e.smoothing.toString()+e.lineWidth.toString()+e.lineDash.toString()+((a=e.strokeColor)===null||a===void 0?void 0:a.toString())+(r?r.toString():e.color.toString()))}getHashCode(e=!0){return Hn.getHashCode(this.font,this.text,e?this.color:void 0)}_applyRasterProperties(e){var s,r,a;e.translate(this.font.padding,this.font.padding),e.imageSmoothingEnabled=this.font.smoothing,e.lineWidth=this.font.lineWidth,e.setLineDash((s=this.font.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.strokeStyle=(a=(r=this.font.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&a!==void 0?a:"",e.fillStyle=this.color.toString()}_applyFont(e){e.resetTransform(),e.translate(this.font.padding+e.canvas.width/2,this.font.padding+e.canvas.height/2),e.scale(this.font.quality,this.font.quality),e.textAlign=this.font.textAlign,e.textBaseline=this.font.baseAlign,e.font=this.font.fontString,e.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(e.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(e.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(e.shadowOffsetX=this.font.shadow.offset.x,e.shadowOffsetY=this.font.shadow.offset.y))}_drawText(e,s,r){this._applyRasterProperties(e),this._applyFont(e);for(let a=0;a<s.length;a++){const l=s[a];this.color&&e.fillText(l,0,a*r),this.font.strokeColor&&e.strokeText(l,0,a*r)}this.font.showDebug&&(qa(e,Q.Green,-e.canvas.width/2,0,e.canvas.width/2,0,2),qa(e,Q.Red,0,-e.canvas.height/2,0,e.canvas.height/2,2))}_splitTextBitmap(e){const s=[];let r=0,a=0;const l=Math.min(4096,e.canvas.width),f=Math.min(4096,e.canvas.height);for(;r<e.canvas.width;){for(;a<e.canvas.height;){const g=document.createElement("canvas");g.width=l,g.height=f;const m=g.getContext("2d");if(!m)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");m.drawImage(e.canvas,r,a,l,f,0,0,l,f),s.push({x:r,y:a,canvas:g}),a+=f}r+=l,a=0}return s}flagDirty(){this._dirty=!0}render(e,s,r,a){var l;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=e;const f=this.getHashCode();if(this._lastHashCode!==f&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,a),this._setDimension(this.dimensions,this.ctx);const g=this._getLinesFromText(this.text,a),m=(l=this.font.lineHeight)!==null&&l!==void 0?l:this.dimensions.height/g.length;if(this._drawText(this.ctx,g,m),e instanceof us)for(const w of this._textFragments)e.textureLoader.delete(w.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),e instanceof us)for(const w of this._textFragments)e.textureLoader.load(w.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=f,this._dirty=!1}for(const g of this._textFragments)e.drawImage(g.canvas,0,0,g.canvas.width,g.canvas.height,g.x/this.font.quality+s-this.ctx.canvas.width/this.font.quality/2,g.y/this.font.quality+r-this.ctx.canvas.height/this.font.quality/2,g.canvas.width/this.font.quality,g.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof us)for(const e of this._textFragments)this._ex.textureLoader.delete(e.canvas);this._textFragments.length=0}_getLinesFromText(e,s){var r;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let f=a[l],g="";if(this.measureText(f).width>s){for(;this.measureText(f).width>s;)g=f[f.length-1]+g,f=f.slice(0,-1);a[l]=f,a[l+1]=g}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class Lt{static measureText(e,s,r){const a=Hn.getHashCode(s,e);if(Lt._MEASURE_CACHE.has(a))return Lt._MEASURE_CACHE.get(a);Lt._LOGGER.debug("Font text measurement cache miss");const l=s.measureTextWithoutCache(e,r);return Lt._MEASURE_CACHE.set(a,l),l}static getTextInstance(e,s,r){const a=Hn.getHashCode(s,e,r);let l=Lt._TEXT_CACHE.get(a);return l||(l=new Hn(s,e,r),Lt._TEXT_CACHE.set(a,l),Lt._LOGGER.debug("Font text instance cache miss")),Lt._TEXT_USAGE.set(l,performance.now()),l}static checkAndClearCache(){const e=[],s=new Set;for(const[a,l]of Lt._TEXT_USAGE.entries())if(l+Lt.FONT_TIMEOUT<performance.now())Lt._LOGGER.debug(`Text cache entry timed out ${a.text}`),e.push(a),a.dispose();else{const f=a.getHashCode(!1);s.add(f)}e.forEach(a=>{Lt._TEXT_USAGE.delete(a)}),this._TEXT_CACHE.clear();for(const[a]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(a.getHashCode(),a);const r=new Map;for(const a of s)Lt._MEASURE_CACHE.has(a)&&r.set(a,Lt._MEASURE_CACHE.get(a));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=r}static get cacheSize(){return Lt._TEXT_USAGE.size}static clearCache(){for(const[e]of Lt._TEXT_USAGE.entries())e.dispose();Lt._TEXT_USAGE.clear(),Lt._TEXT_CACHE.clear(),Lt._MEASURE_CACHE.clear()}}Lt.FONT_TIMEOUT=500,Lt._LOGGER=at.getInstance(),Lt._TEXT_USAGE=new Map,Lt._TEXT_CACHE=new Map,Lt._MEASURE_CACHE=new Map;class nn extends ee{constructor(e={}){var s,r,a,l,f,g,m,w,y,A,E,D,L,O,q,H,N,J,Y,$;super(e),this.filtering=fe.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=Q.Black,this.family="sans-serif",this.style=So.Normal,this.bold=!1,this.unit=yo.Px,this.textAlign=Ao.Left,this.baseAlign=Co.Top,this.direction=Po.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new ht,this._textMeasurement=new Hn(this,"",Q.Black),this.smoothing=(s=e?.smoothing)!==null&&s!==void 0?s:this.smoothing,this.padding=(r=e?.padding)!==null&&r!==void 0?r:this.padding,this.color=(a=e?.color)!==null&&a!==void 0?a:this.color,this.strokeColor=(l=e?.strokeColor)!==null&&l!==void 0?l:this.strokeColor,this.lineDash=(f=e?.lineDash)!==null&&f!==void 0?f:this.lineDash,this.lineWidth=(g=e?.lineWidth)!==null&&g!==void 0?g:this.lineWidth,this.filtering=(m=e?.filtering)!==null&&m!==void 0?m:this.filtering,this.family=(w=e?.family)!==null&&w!==void 0?w:this.family,this.style=(y=e?.style)!==null&&y!==void 0?y:this.style,this.bold=(A=e?.bold)!==null&&A!==void 0?A:this.bold,this.size=(E=e?.size)!==null&&E!==void 0?E:this.size,this.unit=(D=e?.unit)!==null&&D!==void 0?D:this.unit,this.textAlign=(L=e?.textAlign)!==null&&L!==void 0?L:this.textAlign,this.baseAlign=(O=e?.baseAlign)!==null&&O!==void 0?O:this.baseAlign,this.direction=(q=e?.direction)!==null&&q!==void 0?q:this.direction,this.lineHeight=(H=e?.lineHeight)!==null&&H!==void 0?H:this.lineHeight,this.quality=(N=e?.quality)!==null&&N!==void 0?N:this.quality,e?.shadow&&(this.shadow={},this.shadow.blur=(J=e.shadow.blur)!==null&&J!==void 0?J:this.shadow.blur,this.shadow.offset=(Y=e.shadow.offset)!==null&&Y!==void 0?Y:this.shadow.offset,this.shadow.color=($=e.shadow.color)!==null&&$!==void 0?$:this.shadow.color)}clone(){return new nn({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(e,s,r){}_rotate(e){var s;const r=(s=this.origin)!==null&&s!==void 0?s:this._textBounds.center;e.translate(r.x,r.y),e.rotate(this.rotation),e.translate(-r.x,-r.y)}_flip(e){this.flipHorizontal&&(e.translate(this._textBounds.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,-this._textBounds.height/2/this.scale.y),e.scale(1,-1))}measureTextWithoutCache(e,s){return this._textMeasurement.measureText(e,s)}measureText(e,s){return Lt.measureText(e,this,s)}_postDraw(e){e.restore()}render(e,s,r,a,l,f){const g=Lt.getTextInstance(s,this,r);this._textBounds=g.dimensions,this._preDraw(e,a,l),g.render(e,a,l,f),this._postDraw(e)}}class br extends ee{constructor(e){var s,r;super(e),this._text="",this._textWidth=0,this._textHeight=0,this.font=(s=e.font)!==null&&s!==void 0?s:new nn,this.color=(r=e.color)!==null&&r!==void 0?r:this.color,this.text=e.text,this.maxWidth=e.maxWidth}clone(){var e,s;return new br({text:this.text.slice(),color:(s=(e=this.color)===null||e===void 0?void 0:e.clone())!==null&&s!==void 0?s:Q.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(e){this._text=e,this._calculateDimension()}get font(){return this._font}set font(e){this._font=e}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:e,height:s}=this.font.measureText(this._text,this.maxWidth);this._textWidth=e,this._textHeight=s}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(e){}_flip(e){}_preDraw(e,s,r){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(e,s,r)}_drawImage(e,s,r){var a;let l=Q.Black;this.font instanceof nn&&(l=(a=this.color)!==null&&a!==void 0?a:this.font.color);const{width:f,height:g}=this.font.measureText(this._text,this.maxWidth);this._textWidth=f,this._textHeight=g,this.font.render(e,this._text,l,s,r,this.maxWidth),this.font.showDebug&&(e.debug.drawRect(s-f,r-g,f*2,g*2),this.maxWidth!=null&&e.debug.drawRect(s,r,this.maxWidth,this.height,{color:Q.Yellow}))}}function ja(u){return!!u.tick}class se extends Ai{get visible(){return this.isVisible}set visible(e){this.isVisible=e}get offset(){return this._offset}set offset(e){this._offset=new Bs(e,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(e){this._anchor=new Bs(e,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(e){if(e){this._color=e.clone();const s=this.graphics.current;(s instanceof zn||s instanceof br)&&(s.color=this._color)}}constructor(e){super(),this._logger=at.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new Bs(B.Zero,()=>this.recalculateBounds()),this._anchor=new Bs(B.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,e={visible:this.isVisible,graphics:{},...e};const{current:s,anchor:r,color:a,opacity:l,visible:f,graphics:g,offset:m,copyGraphics:w,onPreDraw:y,onPostDraw:A,onPreTransformDraw:E,onPostTransformDraw:D}=e;for(const[L,O]of Object.entries(g))O instanceof ee?this._graphics[L]=O:(this._graphics[L]=O.graphic,this._options[L]=O.options);this.offset=m??this.offset,this.opacity=l??this.opacity,this.anchor=r??this.anchor,this.color=a??this.color,this.copyGraphics=w??this.copyGraphics,this.onPreDraw=y??this.onPreDraw,this.onPostDraw=A??this.onPostDraw,this.onPreDraw=E??this.onPreTransformDraw,this.onPostTransformDraw=D??this.onPostTransformDraw,this.isVisible=!!f,this._current=s??this._current,s&&this._graphics[s]&&this.use(s)}getGraphic(e){return this._graphics[e]}getOptions(e){return this._options[e]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(e,s,r){let a="default",l=null,f;if(typeof e=="string"&&s instanceof ee&&(a=e,l=s,f=r),e instanceof ee&&!(s instanceof ee)&&(l=e,f=s),!l)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[a]=this.copyGraphics?l.clone():l,this._options[a]=this.copyGraphics?{...f}:f,a==="default"&&this.use("default"),l}remove(e){delete this._graphics[e],delete this._options[e],this._current===e&&(this._current="default",this.recalculateBounds())}use(e,s){var r;if(e instanceof ee){let a=e;this.copyGraphics&&(a=e.clone()),this._current="default",this._graphics[this._current]=a,this._options[this._current]=s}else this._current=e,this._options[this._current]=s,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(r=this.owner)===null||r===void 0?void 0:r.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(e){this._localBounds=e}recalculateBounds(){let e=new ht;const s=this._graphics[this._current],r=this._options[this._current];if(!s){this._localBounds=e;return}let a=this.anchor,l=this.offset;r?.anchor&&(a=r.anchor),r?.offset&&(l=r.offset);const f=s.localBounds,g=-f.width*a.x+l.x,m=-f.height*a.y+l.y;s instanceof Un&&!s.useAnchor?e=s?.localBounds.combine(e):e=s?.localBounds.translate(z(g,m)).combine(e),this._localBounds=e}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let e=this.localBounds;if(this.owner){const s=this.owner.get(et);s&&(e=e.transform(s.get().matrix))}return e}update(e,s=0){const r=this.current;r&&ja(r)&&r.tick(e,s)}clone(){const e=new se;return e._graphics={...this._graphics},e._options={...this._options},e.offset=this.offset.clone(),this.color&&(e.color=this.color.clone()),e.opacity=this.opacity,e.anchor=this.anchor.clone(),e.copyGraphics=this.copyGraphics,e.onPreDraw=this.onPreDraw,e.onPostDraw=this.onPostDraw,e.isVisible=this.isVisible,e}}var To;(function(u){u.Kill="kill",u.PreKill="prekill",u.PostKill="postkill",u.PreDraw="predraw",u.PostDraw="postdraw",u.PreDebugDraw="predebugdraw",u.PostDebugDraw="postdebugdraw",u.PreUpdate="preupdate",u.PostUpdate="postupdate",u.PreFrame="preframe",u.PostFrame="postframe",u.PreCollision="precollision",u.CollisionStart="collisionstart",u.CollisionEnd="collisionend",u.PostCollision="postcollision",u.Initialize="initialize",u.Activate="activate",u.Deactivate="deactivate",u.ExitViewport="exitviewport",u.EnterViewport="enterviewport",u.ExitTrigger="exit",u.EnterTrigger="enter",u.Connect="connect",u.Disconnect="disconnect",u.Button="button",u.Axis="axis",u.Visible="visible",u.Hidden="hidden",u.Start="start",u.Stop="stop",u.PointerUp="pointerup",u.PointerDown="pointerdown",u.PointerMove="pointermove",u.PointerEnter="pointerenter",u.PointerLeave="pointerleave",u.PointerCancel="pointercancel",u.PointerWheel="pointerwheel",u.Up="up",u.Down="down",u.Move="move",u.Enter="enter",u.Leave="leave",u.Cancel="cancel",u.Wheel="wheel",u.Press="press",u.Release="release",u.Hold="hold",u.PointerDragStart="pointerdragstart",u.PointerDragEnd="pointerdragend",u.PointerDragEnter="pointerdragenter",u.PointerDragLeave="pointerdragleave",u.PointerDragMove="pointerdragmove",u.ActionStart="actionstart",u.ActionComplete="actioncomplete",u.Add="add",u.Remove="remove"})(To||(To={}));class vt{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(e){this._bubbles=e}stopPropagation(){this.bubbles=!1}}class Eo extends vt{constructor(e){super(),this.self=e,this.target=e}}class Za extends vt{constructor(e){super(),this.self=e,this.target=e}}class Qa extends vt{constructor(e){super(),this.self=e,this.target=e}}class Ja extends vt{constructor(e){super(),this.self=e,this.target=e}}class Ka extends vt{constructor(e){super(),this.self=e,this.target=e}}class On extends vt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class Wn extends vt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class $a extends vt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class th extends vt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class eh extends vt{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class ih extends vt{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class ks extends vt{constructor(e,s,r){super(),this.engine=e,this.elapsed=s,this.self=r,this.target=r}}class Ls extends vt{constructor(e,s,r){super(),this.engine=e,this.elapsed=s,this.self=r,this.target=r}}class sh extends vt{constructor(e,s){super(),this.engine=e,this.prevStats=s,this.target=e}}class nh extends vt{constructor(e,s){super(),this.engine=e,this.stats=s,this.target=e}}class rh extends vt{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class oh extends vt{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class ah extends vt{constructor(e,s,r,a){super(),this.button=e,this.index=s,this.value=r,this.self=a,this.target=a}}class hh extends vt{constructor(e,s,r){super(),this.axis=e,this.value=s,this.self=r,this.target=r}}class lh extends vt{constructor(e){super(),this.self=e,this.target=e}}class ch extends vt{constructor(e){super(),this.self=e,this.target=e}}class rn extends vt{constructor(e,s,r,a,l){super(),this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l,this.target=e}}class on extends vt{constructor(e,s,r,a,l){super(),this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l,this.target=e}}class Io{constructor(e,s,r,a){this.self=e,this.other=s,this.side=r,this.contact=a}}class Ro{constructor(e,s,r,a){this.self=e,this.other=s,this.side=r,this.lastContact=a}}class Do{constructor(e,s,r,a,l){this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l}}class Fo{constructor(e,s,r,a,l){this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l}}class yr extends vt{constructor(e,s,r,a){super(),this.self=e,this.other=s,this.side=r,this.contact=a,this.target=e}}class Ar extends vt{constructor(e,s,r,a){super(),this.self=e,this.other=s,this.side=r,this.lastContact=a,this.target=e}}class Nn extends vt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class dh extends vt{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class uh extends vt{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class fh extends vt{constructor(e){super(),this.self=e,this.target=e}}class _h extends vt{constructor(e){super(),this.self=e,this.target=e}}class gh extends vt{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class ph extends vt{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class mh extends vt{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class vh extends vt{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class wh extends vt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class xh extends vt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class op{constructor(e){this.data=e,this.type="Component Added"}}function ap(u){return!!u&&u.type==="Component Added"}class hp{constructor(e){this.data=e,this.type="Component Removed"}}function lp(u){return!!u&&u.type==="Component Removed"}const cp={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class He{constructor(e,s){this.id=He._ID++,this.name=`Entity#${this.id}`,this.events=new I,this._tags=new Set,this.componentAdded$=new Ye,this.componentRemoved$=new Ye,this.tagAdded$=new Ye,this.tagRemoved$=new Ye,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new Ye,this.childrenRemoved$=new Ye,this._children=[],this._isInitialized=!1,this._isAdded=!1;let r,a;if(Array.isArray(e))r=e,a=s;else if(e&&typeof e=="object"){const{components:l,name:f,silenceWarnings:g}=e;r=l??[],a=f}if(a&&(this.name=a),r)for(const l of r)this.addComponent(l)}get active(){return this.isActive}set active(e){this.isActive=e}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new Eo(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(e){return this._tags.has(e)}addTag(e){return this._tags.add(e),this.tagAdded$.notifyAll(e),this}removeTag(e){return this._tags.delete(e),this.tagRemoved$.notifyAll(e),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(e){for(let s=0;s<e.length;s++)if(!this.components.has(e[s]))return!1;return!0}hasAllTags(e){for(let s=0;s<e.length;s++)if(!this.tags.has(e[s]))return!1;return!0}get(e){return this.components.get(e)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(e){if(e.parent===null){if(this.getAncestors().includes(e))throw new Error("Cycle detected, cannot add entity");this._children.push(e),e._parent=this,this.childrenAdded$.notifyAll(e)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(e){return e.parent===this&&(ls(e,this._children),e._parent=null,this.childrenRemoved$.notifyAll(e)),this}removeAllChildren(){for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);return this}getAncestors(){const e=[this];let s=this.parent;for(;s;)e.push(s),s=s.parent;return e.reverse()}getDescendants(){let e=[this],s=[this];for(;s.length>0;){const r=s.pop();r&&(s=s.concat(r.children),e=e.concat(r.children))}return e}clone(){const e=new He;for(const s of this.types){const r=this.get(s);r&&e.addComponent(r.clone())}for(const s of this.children)e.addChild(s.clone());return e}addTemplate(e,s=!1){for(const r of e.getComponents())this.addComponent(r.clone(),s);for(const r of e.children)this.addChild(r.clone().addTemplate(r));return this}_getClassHierarchyRoot(e){var s,r;let a=e,l=(s=Object.getPrototypeOf(a.prototype))===null||s===void 0?void 0:s.constructor;for(;l&&l!==Object&&l!==Ai;)a=l,l=(r=Object.getPrototypeOf(a.prototype))===null||r===void 0?void 0:r.constructor;return a}addComponent(e,s=!1){if(this.has(e.constructor))if(s)this.removeComponent(e.constructor,!0);else return this;if(e.dependencies&&e.dependencies.length)for(const a of e.dependencies)this.addComponent(new a);e.owner=this;const r=this._getClassHierarchyRoot(e.constructor);return this.components.set(r,e),this.components.set(e.constructor,e),this.componentValues.push(e),e.onAdd&&e.onAdd(this),this.componentAdded$.notifyAll(e),this}removeComponent(e,s=!1){let r;if(od(e)?r=e:r=e.constructor,s){const a=this.components.get(r);if(a){this.componentRemoved$.notifyAll(a),a.owner=void 0,a.onRemove&&a.onRemove(this);const f=this.componentValues.indexOf(a);f>-1&&this.componentValues.splice(f,1)}const l=this._getClassHierarchyRoot(r);this.components.delete(l),this.components.delete(r)}else this._componentsToRemove.push(r);return this}clearComponents(){const e=this.types;for(const s of e)this.removeComponent(s)}processComponentRemoval(){for(const e of this._componentsToRemove)this.removeComponent(e,!0);this._componentsToRemove.length=0}has(e){return this.components.has(e)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(e){this.isInitialized||(this.onInitialize(e),this.events.emit("initialize",new Nn(e,this)),this._isInitialized=!0)}_add(e){!this.isAdded&&this.isActive&&(this.onAdd(e),this.events.emit("add",new wh(e,this)),this._isAdded=!0)}_remove(e){this.isAdded&&!this.isActive&&(this.onRemove(e),this.events.emit("remove",new xh(e,this)),this._isAdded=!1)}_preupdate(e,s){this.events.emit("preupdate",new ks(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new Ls(e,s,this)),this.onPostUpdate(e,s)}onInitialize(e){}onAdd(e){}onRemove(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s);for(const r of this.children)r.update(e,s);this._postupdate(e,s),this._remove(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}He._ID=0;class Bt extends Ai{constructor(){super(...arguments),this.vel=B.Zero,this.acc=B.Zero,this.scaleFactor=B.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class je{static integrate(e,s,r,a){const l=a/1e3;s.vel.addEqual(r.scale(l,je._ACC)),e.pos.add(s.vel.scale(l,je._VEL),je._POS).addEqual(r.scale(.5*l*l,je._VEL_ACC)),s.angularVelocity+=s.torque*(1/s.inertia)*l;const f=e.rotation+s.angularVelocity*l;e.scale.add(s.scaleFactor.scale(l,this._SCALE_FACTOR),je._SCALE),e.get().setTransform(je._POS,f,je._SCALE)}}je._POS=new B(0,0),je._SCALE=new B(1,1),je._ACC=new B(0,0),je._VEL=new B(0,0),je._VEL_ACC=new B(0,0),je._SCALE_FACTOR=new B(0,0);class Mo extends He{constructor(e){super({silenceWarnings:!0}),this.beginColor=Q.White,this.endColor=Q.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=Q.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=Di.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new et),this.addComponent(this.motion=new Bt),this.addComponent(this.graphics=new se),this.configure(e)}registerEmitter(e){if(this._emitter=e,this.particleTransform===Di.Global){const s=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(s),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(e){var s,r,a,l,f,g,m,w,y,A,E,D,L,O;this.particleTransform=(s=e.transform)!==null&&s!==void 0?s:this.particleTransform,this.life=(r=e.life)!==null&&r!==void 0?r:this.life,this.fade=(a=e.fade)!==null&&a!==void 0?a:this.fade,this.size=(l=e.size)!==null&&l!==void 0?l:this.size,this.endColor=(f=e.endColor)!==null&&f!==void 0?f:this.endColor.clone(),this.beginColor=(g=e.beginColor)!==null&&g!==void 0?g:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=e.graphic,this.graphics.opacity=(m=e.opacity)!==null&&m!==void 0?m:this.graphics.opacity,this.transform.pos=(w=e.pos)!==null&&w!==void 0?w:this.transform.pos,this.transform.rotation=(y=e.rotation)!==null&&y!==void 0?y:0,this.transform.scale=z(1,1),this.motion.vel=(A=e.vel)!==null&&A!==void 0?A:this.motion.vel,this.motion.angularVelocity=(E=e.angularVelocity)!==null&&E!==void 0?E:0,this.motion.acc=(D=e.acc)!==null&&D!==void 0?D:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(L=e.startSize)!==null&&L!==void 0?L:0,this.endSize=(O=e.endSize)!==null&&O!==void 0?O:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=ht.fromDimension(this.size,this.size,B.Half),this.graphics.onPostDraw=q=>{q.save(),q.debug.drawPoint(z(0,0),{color:this._currentColor,size:this.size}),q.restore()})}kill(){var e;!((e=this._emitter)===null||e===void 0)&&e.isActive?this._emitter.removeParticle(this):super.kill()}update(e,s){this.life=this.life-s,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=j(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=j(this.sizeRate*s+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=j(this._currentColor.r+this._rRate*s,0,255),this._currentColor.g=j(this._currentColor.g+this._gRate*s,0,255),this._currentColor.b=j(this._currentColor.b+this._bRate*s,0,255),this._currentColor.a=this.graphics.opacity;let r=this.motion.acc;this.focus&&(r=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(s/1e3)),je.integrate(this.transform,this.motion,r,s)}}Mo.DefaultConfig={beginColor:Q.White,endColor:Q.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var Di;(function(u){u.Global="global",u.Local="local"})(Di||(Di={}));class ad{constructor(){this.type="ex.particle",this.priority=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new ei({gl:e,vertexSource:$g,fragmentSource:tp,onPreLink:r=>{e.transformFeedbackVaryings(r,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],e.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(e){const s=e.getAttribute(Dt.Filtering),r=s?Ln(s):void 0,a=Ei(e.getAttribute(Dt.WrappingX)),l=Ei(e.getAttribute(Dt.WrappingY)),f=e.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);return e.removeAttribute("forceUpload"),g}draw(e,s){var r,a,l,f,g,m,w,y,A;const E=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const D=e.particle.transform===Di.Local?this._context.getTransform():this._context.getTransform().multiply(e.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",D),this._shader.setUniformBoolean("fade",!!e.particle.fade),this._shader.setUniformBoolean("useTexture",!!e.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(r=e.particle.life)!==null&&r!==void 0?r:2e3),this._shader.setUniformFloat("deltaMs",s),this._shader.setUniformFloatVector("gravity",(a=e.particle.acc)!==null&&a!==void 0?a:z(0,0)),this._shader.setUniformFloatColor("beginColor",(l=e.particle.beginColor)!==null&&l!==void 0?l:Q.Transparent),this._shader.setUniformFloatColor("endColor",(f=e.particle.endColor)!==null&&f!==void 0?f:Q.Transparent);let L=(g=e.particle.startSize)!==null&&g!==void 0?g:0,O=(m=e.particle.endSize)!==null&&m!==void 0?m:0;const q=(w=e.particle.size)!==null&&w!==void 0?w:0;if(q>0&&(L=q,O=q),this._shader.setUniformFloat("startSize",L??10),this._shader.setUniformFloat("endSize",O??10),this._shader.setUniformFloat("startOpacity",(y=e.particle.opacity)!==null&&y!==void 0?y:1),e.particle.focus&&(this._shader.setUniformFloatVector("focus",e.particle.focus),this._shader.setUniformFloat("focusAccel",(A=e.particle.focusAccel)!==null&&A!==void 0?A:0)),e.particle.graphic){const H=e.particle.graphic,N=this._getTexture(H.image.image);E.activeTexture(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,N),this._shader.setUniformInt("graphic",0)}e.draw(E)}hasPendingDraws(){return!1}flush(){}dispose(){}}const dp=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,up=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class fp{constructor(e){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=Q.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=Va(e,r);this._maxTextures=Math.min(r,a);const l=this._transformFragmentSource(dp,this._maxTextures);this._shader=new ei({gl:e,fragmentSource:l,vertexSource:up}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((A,E)=>E)),this._vao=e.createVertexArray(),e.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._meshBuffer),e.bufferData(e.ARRAY_BUFFER,this._quadMesh,e.STATIC_DRAW),e.vertexAttribPointer(0,2,e.FLOAT,!1,16,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,16,8),e.enableVertexAttribArray(1),e.bindBuffer(e.ARRAY_BUFFER,null);const f=this._components;this._transformData=new Gi({gl:e,size:f*this._maxImages,type:"dynamic"}),this._transformData.bind();let g=0,m=2;const w=4,y=f*4;e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,g),e.enableVertexAttribArray(2),g+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,g),e.enableVertexAttribArray(3),g+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,g),e.enableVertexAttribArray(4),g+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,g),e.enableVertexAttribArray(5),g+=2*w,e.vertexAttribPointer(m++,1,e.FLOAT,!1,y,g),e.enableVertexAttribArray(6),g+=1*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,g),e.enableVertexAttribArray(7),g+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,g),e.enableVertexAttribArray(8),g+=2*w,e.vertexAttribPointer(m++,1,e.FLOAT,!1,y,g),e.enableVertexAttribArray(9),g+=1*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,g),e.enableVertexAttribArray(10),g+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,y,g),e.enableVertexAttribArray(11),g+=2*w,e.vertexAttribPointer(m++,4,e.FLOAT,!1,y,g),e.enableVertexAttribArray(12),g+=4*w,e.vertexAttribDivisor(2,1),e.vertexAttribDivisor(3,1),e.vertexAttribDivisor(4,1),e.vertexAttribDivisor(5,1),e.vertexAttribDivisor(6,1),e.vertexAttribDivisor(7,1),e.vertexAttribDivisor(8,1),e.vertexAttribDivisor(9,1),e.vertexAttribDivisor(10,1),e.vertexAttribDivisor(11,1),e.vertexAttribDivisor(12,1),e.bindVertexArray(null)}_bindData(e){const s=this._components;this._transformData.bind(),this._transformData.upload(s*this._imageCount),e.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let r=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_texture_index <= ${l}.5) {
`:a+=`   else if (v_texture_index <= ${l}.5) {
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return r=r.replace("%%texture_picker%%",a),r}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(Dt.Filtering),r=s?Ln(s):void 0,a=Ei(e.getAttribute(Dt.WrappingX)),l=Ei(e.getAttribute(Dt.WrappingY)),f=e.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);e.removeAttribute("forceUpload"),this._textures.indexOf(g)===-1&&(this._textures.push(g),this._textureToIndex.set(g,this._textureIndex++),this._images.add(e))}_bindTextures(e){const s=Math.min(this._textureIndex,this._maxTextures);for(let r=0;r<s;r++)e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,this._textures[r]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const r=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(r))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,r,a,l,f,g,m,w){var y,A,E,D;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const L=this._getImageWidth(e),O=this._getImageHeight(e);let q=L||a||0,H=O||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(y=a??L)!==null&&y!==void 0?y:0,this._view[3]=(A=l??O)!==null&&A!==void 0?A:0,this._dest[0]=s??1,this._dest[1]=r??1,f!==void 0&&g!==void 0&&m!==void 0&&w!==void 0&&(this._view[0]=s??1,this._view[1]=r??1,this._view[2]=(E=a??L)!==null&&E!==void 0?E:0,this._view[3]=(D=l??O)!==null&&D!==void 0?D:0,this._dest[0]=f,this._dest[1]=g,q=m,H=w),s=this._view[0],r=this._view[1];const N=this._view[2],J=this._view[3],Y=this._context.getTransform(),$=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+gt),this._dest[1]=~~(this._dest[1]+gt));const Z=this._context.tint||this._defaultTint,_t=this._getTextureIdForImage(e),Et=L||q,Yt=O||H,Qt=(s+this.uvPadding)/Et,Se=(r+this.uvPadding)/Yt,te=(s+N-this.uvPadding)/Et,zt=(r+J-this.uvPadding)/Yt,Ne=L,Fe=O,it=this._transformData.bufferData;it[this._vertexIndex++]=this._dest[0],it[this._vertexIndex++]=this._dest[1],it[this._vertexIndex++]=Y.data[0],it[this._vertexIndex++]=Y.data[1],it[this._vertexIndex++]=Y.data[2],it[this._vertexIndex++]=Y.data[3],it[this._vertexIndex++]=Y.data[4],it[this._vertexIndex++]=Y.data[5],it[this._vertexIndex++]=$,it[this._vertexIndex++]=q,it[this._vertexIndex++]=H,it[this._vertexIndex++]=Ne,it[this._vertexIndex++]=Fe,it[this._vertexIndex++]=_t,it[this._vertexIndex++]=Qt,it[this._vertexIndex++]=Se,it[this._vertexIndex++]=te,it[this._vertexIndex++]=zt,it[this._vertexIndex++]=Z.r/255,it[this._vertexIndex++]=Z.g/255,it[this._vertexIndex++]=Z.b/255,it[this._vertexIndex++]=Z.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._bindData(e),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),e.drawArraysInstanced(e.TRIANGLES,0,6,this._imageCount),Zt.DrawnImagesCount+=this._imageCount,Zt.DrawCallCount++,e.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const gt=1e-4;class _p{constructor(e){this._webglCtx=e,this._debugText=new Na}drawRect(e,s,r,a,l={color:Q.Black}){this.drawLine(z(e,s),z(e+r,s),{...l}),this.drawLine(z(e+r,s),z(e+r,s+a),{...l}),this.drawLine(z(e+r,s+a),z(e,s+a),{...l}),this.drawLine(z(e,s+a),z(e,s),{...l})}drawLine(e,s,r){var a;this._webglCtx.draw("ex.line",e,s,(a=r?.color)!==null&&a!==void 0?a:Q.Black)}drawPoint(e,s={color:Q.Black,size:5}){this._webglCtx.draw("ex.point",e,s.color,s.size)}drawText(e,s){this._debugText.write(this._webglCtx,e,s)}}class us{get z(){return this._state.current.z}set z(e){this._state.current.z=e}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(e){let s=!0;return(e.width>4096||e.height>4096)&&(s=!1),s}constructor(e){this._logger=at.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=b.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new bo(()=>new Jg,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new Tg,this._state=new Kc,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=Q.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new _p(this),this._totalPostProcessorTime=0;const{canvasElement:s,context:r,enableTransparency:a,antialiasing:l,uvPadding:f,multiSampleAntialiasing:g,pixelArtSampler:m,powerPreference:w,snapToPixel:y,backgroundColor:A,useDrawSorting:E,garbageCollector:D,handleContextLost:L,handleContextRestored:O}=e;if(this.__gl=r??s.getContext("webgl2",{antialias:l??this.smoothing,premultipliedAlpha:!1,alpha:a??this.transparency,depth:!1,powerPreference:w??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");L&&this.__gl.canvas.addEventListener("webglcontextlost",L,!1),O&&this.__gl.canvas.addEventListener("webglcontextrestored",O,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new ie(this.__gl,D),this.snapToPixel=y??this.snapToPixel,this.smoothing=l??this.smoothing,this.transparency=a??this.transparency,this.pixelArtSampler=m??this.pixelArtSampler,this.uvPadding=f??this.uvPadding,this.multiSampleAntialiasing=typeof g=="boolean"?g:this.multiSampleAntialiasing,this.samples=typeof g=="object"?g.samples:void 0,this.backgroundColor=A??this.backgroundColor,this.useDrawSorting=E??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const e of this._renderers.values())e.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const e=this.__gl;if(this._ortho=ci.ortho(0,e.canvas.width,e.canvas.height,0,400,-400),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.depthMask(!1),this.register(new Vg({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new rd),this.register(new Yg),this.register(new Qg),this.register(new zg),this.register(new kg),this.lazyRegister("ex.particle",()=>new ad),this.register(new fp({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=e.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");e.bindTexture(e.TEXTURE_2D,this.materialScreenTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.bindTexture(e.TEXTURE_2D,null),this._screenRenderer=new Wg(e),this._renderTarget=new xo({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),this._postProcessTargets=[new xo({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),new xo({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height})],this._msaaTarget=new xo({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(e){this._renderers.set(e.type,e),e.initialize(this.__gl,this)}lazyRegister(e,s){this._lazyRenderersFactory.set(e,s)}get(e){let s=this._renderers.get(e);if(!s){const r=this._lazyRenderersFactory.get(e);r&&(this._logger.debug("lazy init renderer:",e),s=r(),this.register(s))}return s}_isCurrentRenderer(e){return!this._currentRenderer||this._currentRenderer===e}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(e,...s){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${e}, the webgl context is lost`);return}const r=this.get(e);if(r)if(this.useDrawSorting){const a=this._drawCallPool.get();a.z=this._state.current.z,a.priority=r.priority,a.renderer=e,this.getTransform().clone(a.transform),a.state.z=this._state.current.z,a.state.opacity=this._state.current.opacity,a.state.tint=this._state.current.tint,a.state.material=this._state.current.material,a.args[0]=s[0],a.args[1]=s[1],a.args[2]=s[2],a.args[3]=s[3],a.args[4]=s[4],a.args[5]=s[5],a.args[6]=s[6],a.args[7]=s[7],a.args[8]=s[8],a.args[9]=s[9],this._drawCalls[this._drawCallIndex++]=a}else this._currentRenderer||(this._currentRenderer=r),this._isCurrentRenderer(r)||this._currentRenderer.flush(),r.draw(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9]),this._currentRenderer=r;else throw Error(`No renderer with name ${e} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(e){const s=this.__gl;this._ortho=this._ortho=ci.ortho(0,e.width,e.height,0,400,-400),this._renderTarget.setResolution(s.canvas.width,s.canvas.height),this._msaaTarget.setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[0].setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[1].setResolution(s.canvas.width,s.canvas.height)}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}drawImage(e,s,r,a,l,f,g,m,w){if(!(a===0||l===0)){{if(m===0||w===0)return;if(this._getImageWidth(e)===0||this._getImageHeight(e)===0)return}if(!e){at.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",e,s,r,a,l,f,g,m,w):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,e,s,r,a,l,f,g,m,w):this.draw(this.imageRenderer,e,s,r,a,l,f,g,m,w)}}drawLine(e,s,r,a=1){this.draw("ex.rectangle",e,s,r,a)}drawRectangle(e,s,r,a,l,f){this.draw("ex.rectangle",e,s,r,a,l,f)}drawCircle(e,s,r,a,l){this.draw("ex.circle",e,s,r,a,l)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(e,s){this._transform.translate(this.snapToPixel?~~(e+gt):e,this.snapToPixel?~~(s+gt):s)}rotate(e){this._transform.rotate(e)}scale(e,s){this._transform.scale(e,s)}transform(e){this._transform.current=e}getTransform(){return this._transform.current}multiply(e){this._transform.current.multiply(e,this._transform.current)}addPostProcessor(e){this._postprocessors.push(e),e.initialize(this.__gl)}removePostProcessor(e){const s=this._postprocessors.indexOf(e);s!==-1&&this._postprocessors.splice(s,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(e){for(const s of this._postprocessors){const r=s.getShader();r.use();const a=r.getUniforms();this._totalPostProcessorTime+=e,a.find(l=>l.name==="u_time_ms")&&r.setUniformFloat("u_time_ms",this._totalPostProcessorTime),a.find(l=>l.name==="u_elapsed_ms")&&r.setUniformFloat("u_elapsed_ms",e),a.find(l=>l.name==="u_resolution")&&r.setUniformFloatVector("u_resolution",z(this.width,this.height)),s.onUpdate&&s.onUpdate(e)}}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return new nd({...e,graphicsContext:this})}createShader(e){const s=this.__gl,{vertexSource:r,fragmentSource:a}=e,l=new ei({gl:s,vertexSource:r,fragmentSource:a});return l.compile(),l}clear(){const e=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT)}flush(){var e;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let s=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(s.use(),this.useDrawSorting){for(let f=this._drawCallIndex;f<this._drawCalls.length;f++)this._drawCalls[f]=null;const r=new Map;for(const[f]of this._renderers){let g=0;for(g=0;g<this._drawCallIndex&&this._drawCalls[g].renderer!==f;g++);r.set(f,g)}this._drawCalls.sort((f,g)=>{if(f===null||g===null)return 0;const m=f.z-g.z,w=r.get(f.renderer)-r.get(g.renderer),y=f.priority-g.priority;return m===0?y===0?w:y:m});const a=this._transform.current,l=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let f=this._drawCalls[0].renderer,g=this.get(f);for(let m=0;m<this._drawCallIndex;m++)this._transform.current=this._drawCalls[m].transform,this._state.current=this._drawCalls[m].state,this._drawCalls[m].renderer!==f&&(g.flush(),f=this._drawCalls[m].renderer,g=this.get(f)),g instanceof rd&&(!((e=this.material)===null||e===void 0)&&e.isUsingScreenTexture)&&(s.copyToTexture(this.materialScreenTexture),s.use()),g.draw(...this._drawCalls[m].args);g.hasPendingDraws()&&g.flush()}this._transform.current=a,this._state.current=l,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const r of this._renderers.values())r.hasPendingDraws()&&r.flush();s.disable(),this._postprocessors.length>0&&s.toRenderSource().use();for(let r=0;r<this._postprocessors.length;r++)s=this._postProcessTargets[r%2],this._postProcessTargets[r%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[r]),this._postProcessTargets[r%2].toRenderSource().use();s.blitToScreen()}}const he=1e-4;class gp{constructor(e){this._ex=e,this._debugText=new Na}drawRect(e,s,r,a){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(e+he):e,this._ex.snapToPixel?~~(s+he):s,this._ex.snapToPixel?~~(r+he):r,this._ex.snapToPixel?~~(a+he):a),this._ex.__ctx.restore()}drawLine(e,s,r={color:Q.Black}){var a,l;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(l=(a=r.color)===null||a===void 0?void 0:a.toString())!==null&&l!==void 0?l:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(e.x+he):e.x,this._ex.snapToPixel?~~(e.y+he):e.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(s.x+he):s.x,this._ex.snapToPixel?~~(s.y+he):s.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(e,s={color:Q.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=s.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(e.x+he):e.x,this._ex.snapToPixel?~~(e.y+he):e.y,s.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(e,s){this._debugText.write(this._ex,e,s)}}class Bo{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(e){this.__ctx.imageSmoothingEnabled=e}constructor(e){this.useDrawSorting=!1,this.z=0,this.backgroundColor=Q.ExcaliburBlue,this._state=new Kc,this.snapToPixel=!1,this.debug=new gp(this);const{canvasElement:s,context:r,enableTransparency:a,snapToPixel:l,antialiasing:f,backgroundColor:g}=e;if(this.__ctx=r??s.getContext("2d",{alpha:a??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=g??this.backgroundColor,this.snapToPixel=l??this.snapToPixel,this.smoothing=f??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(e){}drawImage(e,s,r,a,l,f,g,m,w){if(a===0||l===0)return;if(m===0||w===0)return;if(e.width===0||e.height===0)return;this.__ctx.globalAlpha=this.opacity;const y=[e,s,r,a,l,f,g,m,w].filter(A=>A!==void 0).map(A=>typeof A=="number"&&this.snapToPixel?~~A:A);this.__ctx.drawImage.apply(this.__ctx,y),Zt.DrawCallCount++,Zt.DrawnImagesCount=1}drawLine(e,s,r,a=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=r.toString(),this.__ctx.moveTo(this.snapToPixel?~~(e.x+he):e.x,this.snapToPixel?~~(e.y+he):e.y),this.__ctx.lineTo(this.snapToPixel?~~(s.x+he):s.x,this.snapToPixel?~~(s.y+he):s.y),this.__ctx.lineWidth=a,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(e,s,r,a){this.__ctx.save(),this.__ctx.fillStyle=a.toString(),this.__ctx.fillRect(this.snapToPixel?~~(e.x+he):e.x,this.snapToPixel?~~(e.y+he):e.y,this.snapToPixel?~~(s+he):s,this.snapToPixel?~~(r+he):r),this.__ctx.restore()}drawCircle(e,s,r,a,l){this.__ctx.save(),this.__ctx.beginPath(),a&&(this.__ctx.strokeStyle=a.toString()),l&&(this.__ctx.lineWidth=l),this.__ctx.fillStyle=r.toString(),this.__ctx.arc(this.snapToPixel?~~(e.x+he):e.x,this.snapToPixel?~~(e.y+he):e.y,s,0,Math.PI*2),this.__ctx.fill(),a&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(e,s){this.__ctx.translate(this.snapToPixel?~~(e+he):e,this.snapToPixel?~~(s+he):s)}rotate(e){this.__ctx.rotate(e)}scale(e,s){this.__ctx.scale(e,s)}getTransform(){throw new Error("Not implemented")}multiply(e){this.__ctx.setTransform(this.__ctx.getTransform().multiply(e.toDOMMatrix()))}addPostProcessor(e){}removePostProcessor(e){}clearPostProcessors(){}updatePostProcessors(e){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),Zt.clear()}flush(){}dispose(){this.__ctx=void 0}}var ye;(function(u){u.Fixed="Fixed",u.FitContainerAndFill="FitContainerAndFill",u.FitScreenAndFill="FitScreenAndFill",u.FitContainerAndZoom="FitContainerAndZoom",u.FitScreenAndZoom="FitScreenAndZoom",u.FitScreen="FitScreen",u.FillScreen="FillScreen",u.FitContainer="FitContainer",u.FillContainer="FillContainer"})(ye||(ye={}));class bh{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const pp={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class yh{constructor(e){var s,r,a,l;this.events=new I,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=at.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const f=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(f),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new ht,this._unsafeArea=new ht,this.viewport=e.viewport,this.resolution=(s=e.resolution)!==null&&s!==void 0?s:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(r=e.displayMode)!==null&&r!==void 0?r:ye.Fixed,this._canvas=e.canvas,this.graphicsContext=e.context,this._antialiasing=(a=e.antialiasing)!==null&&a!==void 0?a:this._antialiasing,this._canvasImageRendering=(l=e.canvasImageRendering)!==null&&l!==void 0?l:this._canvasImageRendering,this._browser=e.browser,this._pixelRatioOverride=e.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const e=this.worldToPageCoordinates(B.Zero);return this.worldToPageCoordinates(z(1,0)).sub(e).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(e){this._pixelRatioOverride=e}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case ye.FillContainer:case ye.FitContainer:case ye.FitContainerAndFill:case ye.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(e){this._resolution=e}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(e){this._viewport=e}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(e){this._camera=e}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof us&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let a=Math.max(1,this.pixelRatio-.5),l=!1;for(;a>1&&!l;){a=Math.max(1,a-.5);const f=this._resolution.width*a,g=this._resolution.height*a;l=this.graphicsContext.checkIfResolutionSupported({width:f,height:g})}this.pixelRatioOverride=a,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const e=this.viewport.widthUnit==="percent"?"%":"px",s=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+e,this._canvas.style.height=this.viewport.height+s,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof Bo&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(e){this._antialiasing=e,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(e){return this.enterFullscreen(e)}enterFullscreen(e){var s,r,a,l,f,g;if(e){const m=document.getElementById(e);if(m?.requestFullscreen||m?.webkitRequestFullscreen){if(m.getAttribute("ex-fullscreen-listener")||(m.setAttribute("ex-fullscreen-listener","true"),m.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),m.requestFullscreen)return(s=m.requestFullscreen())!==null&&s!==void 0?s:Promise.resolve();if(m.webkitRequestFullscreen)return(r=m.webkitRequestFullscreen())!==null&&r!==void 0?r:Promise.resolve()}}return!((a=this._canvas)===null||a===void 0)&&a.requestFullscreen?(f=(l=this._canvas)===null||l===void 0?void 0:l.requestFullscreen())!==null&&f!==void 0?f:Promise.resolve():this._canvas.webkitRequestFullscreen?(g=this._canvas.webkitRequestFullscreen())!==null&&g!==void 0?g:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(e){return{width:e.widthUnit==="percent"?this.canvas.offsetWidth:e.width,height:e.heightUnit==="percent"?this.canvas.offsetHeight:e.height}}pageToScreenCoordinates(e){let s=e.x,r=e.y;this._isFullscreen||(s-=Ms(this._canvas).x,r-=Ms(this._canvas).y);const a=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,f=(window.innerHeight-l)/2;r=(r-f)/l*a.height,s=s/window.innerWidth*a.width}else{const l=window.innerHeight*this.aspectRatio,f=(window.innerWidth-l)/2;s=(s-f)/l*a.width,r=r/window.innerHeight*a.height}return s=s/a.width*this.resolution.width,r=r/a.height*this.resolution.height,s=s-this.contentArea.left,r=r-this.contentArea.top,new B(s,r)}screenToPageCoordinates(e){let s=e.x,r=e.y;const a=this._viewportToPixels(this.viewport);if(s=s/this.resolution.width*a.width,r=r/this.resolution.height*a.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,f=(window.innerHeight-l)/2;r=r/a.height*l+f,s=s/a.width*window.innerWidth}else{const l=window.innerHeight*this.aspectRatio,f=(window.innerWidth-l)/2;s=s/a.width*l+f,r=r/a.height*window.innerHeight}return this._isFullscreen||(s+=Ms(this._canvas).x,r+=Ms(this._canvas).y),new B(s,r)}screenToWorldCoordinates(e){return e=e.add(z(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(e):e.sub(z(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(e){return this._camera?this._camera.transform.multiply(e):e.add(z(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(e){const s=this.pageToScreenCoordinates(e);return this.screenToWorldCoordinates(s)}worldToPageCoordinates(e){const s=this.worldToScreenCoordinates(e);return this.screenToPageCoordinates(s)}getWorldBounds(){return ht.fromDimension(this.resolution.width,this.resolution.height,B.Half).scale(z(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero,B.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return z(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=this.aspectRatio;let s=0,r=0;window.innerWidth/e<window.innerHeight?(s=window.innerWidth,r=window.innerWidth/e):(s=window.innerHeight*e,r=window.innerHeight),this.viewport={width:s,height:r},this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this._unsafeArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndFill(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(e,s,r){if(this.viewport=r??{width:e,height:s},e/s<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:e*this._contentResolution.width/e,height:e*this._contentResolution.width/e*s/e};const a=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new ht({top:a,left:0,right:this._contentResolution.width,bottom:this.resolution.height-a}),this._unsafeArea=new ht({top:-a,left:0,right:this._contentResolution.width,bottom:this.resolution.height+a})}else{this.resolution={width:s*this._contentResolution.height/s*e/s,height:s*this._contentResolution.height/s};const a=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new ht({top:0,left:a,right:this.resolution.width-a,bottom:this._contentResolution.height}),this._unsafeArea=new ht({top:0,left:-a,right:this.resolution.width+a,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndZoom(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const e=this.canvas.parentElement;e.style.overflow="hidden";const{offsetWidth:s,offsetHeight:r}=this.canvas;this._computeFitAndZoom(s,r),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(e,s){const r=this.aspectRatio;let a=0,l=0;e/r<s?(a=e,l=e/r):(a=s*r,l=s);const f=e/a,g=s/l,m=Math.max(f,g),w=a*m,y=l*m;w>e?this.canvas.style.left=-(w-e)/2+"px":this.canvas.style.left="",y>s?this.canvas.style.top=-(y-s)/2+"px":this.canvas.style.top="",this.viewport={width:w,height:y};const A=ht.fromDimension(this.viewport.width,this.viewport.height,B.Zero);if(this.viewport.width>e){const E=(this.viewport.width-e)/this.viewport.width*this.resolution.width;A.top=0,A.left=E/2,A.right=this.resolution.width-E/2,A.bottom=this.resolution.height}if(this.viewport.height>s){const E=(this.viewport.height-s)/this.viewport.height*this.resolution.height;A.top=E/2,A.left=0,A.bottom=this.resolution.height-E/2,A.right=this.resolution.width}this._contentArea=A}_computeFitContainer(){const e=this.aspectRatio;let s=0,r=0,a="pixel",l="pixel";const f=this.canvas.parentElement;f.clientWidth/e<f.clientHeight?(this.canvas.style.width="100%",s=100,a="percent",r=this.canvas.offsetWidth/e):(this.canvas.style.height="100%",r=100,l="percent",s=this.canvas.offsetHeight*e),this.viewport={width:s,widthUnit:a,height:r,heightUnit:l},this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(e){this.displayMode===ye.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===ye.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:e.innerWidth,height:e.innerHeight},this.viewport=this.resolution),this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.displayMode===ye.FitScreen&&this._computeFit(),this.displayMode===ye.FitContainer&&this._computeFitContainer(),this.displayMode===ye.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===ye.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===ye.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===ye.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class Cr{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function mp(u){return!!u.playbackState}class an{static unlock(){return new Promise((s,r)=>{if(an._UNLOCKED||!Cr.create())return s(!0);const a=setTimeout(()=>{at.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),s(!1)},200),l=Cr.create();l.resume().then(()=>{const f=l.createBuffer(1,1,22050),g=l.createBufferSource();let m=!1;g.buffer=f,g.connect(l.destination),g.onended=()=>m=!0,g.start(0),setTimeout(()=>{mp(g)?(g.playbackState===g.PLAYING_STATE||g.playbackState===g.FINISHED_STATE)&&(an._UNLOCKED=!0):(l.currentTime>0||m)&&(an._UNLOCKED=!0)},0),clearTimeout(a),s(!0)},()=>{r()})})}static isUnlocked(){return this._UNLOCKED}}an._UNLOCKED=!1;class ko extends zn{get ctx(){return this._ctx}constructor(e={}){super(e),this._options=e}clone(){return new ko({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){var s,r;!((s=this._options)===null||s===void 0)&&s.draw&&((r=this._options)===null||r===void 0||r.draw(e)),this._options.cache||this.flagDirty()}}class Ah{}Ah.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class Lo{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(e){this._currentState=e}static create(e,s){const r=new Lo;r.data=s;for(const a in e.states)r.states.set(a,{name:a,...e.states[a]});for(const a of r.states.values())for(const l of a.transitions)if(l!=="*"&&!r.states.has(l))throw Error(`Invalid state machine, state [${a.name}] has a transition to another state that doesn't exist [${l}]`);return r.currentState=r.startState=r.states.get(e.start),r}in(e){return this.currentState.name===e}go(e,s){var r,a;if(this.currentState.transitions.includes(e)||this.currentState.transitions.includes("*")){const l=this.states.get(e);return this.currentState.onExit&&((r=this.currentState)===null||r===void 0?void 0:r.onExit({to:l.name,data:this.data}))===!1||l?.onEnter&&l?.onEnter({from:this.currentState.name,eventData:s,data:this.data})===!1?!1:(this.currentState=l,!((a=this.currentState)===null||a===void 0)&&a.onState&&this.currentState.onState(),!0)}return!1}update(e){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,e)}save(e){localStorage.setItem(e,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(e){const s=JSON.parse(localStorage.getItem(e));this.currentState=this.states.get(s.currentState),this.data=s.data}}class hd{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(e){this._loop=e,this._instance&&(this._instance.loop=e,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(e){e=j(e,0,1),this._volume=e,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(e,this._audioContext.currentTime,.1):this._volumeNode.gain.value=e}get volume(){return this._volume}get duration(){var e;return(e=this._duration)!==null&&e!==void 0?e:this.getTotalPlaybackDuration()}set duration(e){this._duration=e}constructor(e){this._src=e,this._audioContext=Cr.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new P,this._stateMachine=Lo.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:s})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,s.pausedAt*this._playbackRate):this._instance.start(0,s.pausedAt*this._playbackRate,this.duration),s.startedAt=this._audioContext.currentTime-s.pausedAt,s.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:s})=>{s==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:s,data:r})=>{r.pausedAt=(s??0)/this._playbackRate,r.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:s})=>{s.pausedAt=0,s.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:s})=>{s.pausedAt=this._audioContext.currentTime-s.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(e=()=>{}){return this._playStarted=e,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(e){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",e)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:e,startedAt:s}=this._stateMachine.data;return e?e*this._playbackRate:s?(this._audioContext.currentTime-s)*this._playbackRate:0}set playbackRate(e){this._instance.playbackRate.value=this._playbackRate=e}get playbackRate(){return this._instance.playbackRate.value}}class Ch extends vt{set bubbles(e){}get bubbles(){return!1}get _path(){return null}set _path(e){}constructor(e,s="MediaEvent"){super(),this.target=e,this._name=s}stopPropagation(){}action(){}propagate(){}layPath(e){}}class hn extends Ch{constructor(e,s){super(e,"NativeSoundEvent"),this.track=s}}class ld extends Ch{constructor(e,s){super(e,"NativeSoundProcessedEvent"),this._processedData=s,this.data=this._processedData}}function vp(u){try{const e=new Audio,s=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,r=u.match(s)[1];return!!e.canPlayType("audio/"+r)}catch(e){return at.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",e),!1}}const wp={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class cd{set loop(e){this._loop=e;for(const s of this._tracks)s.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(e){this._volume=e;for(const s of this._tracks)s.volume=this._volume;this.events.emit("volumechange",new hn(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(e){this._duration=e}get instances(){return this._tracks}get path(){return this._resource.path}set path(e){this._resource.path=e}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}constructor(...e){this.events=new I,this.logger=at.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=Cr.create(),this._resource=new mr("",Ah.type.arraybuffer);for(const s of e)if(vp(s)){this.path=s;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",e.join(", ")),this.logger.warn("Attempting to use",e[0]),this.path=e[0])}isLoaded(){return!!this.data}async load(){var e,s;if(this.data)return this.data;const r=await this._resource.load(),a=await this.decodeAudio(r.slice(0));return this._duration=(s=(e=this._duration)!==null&&e!==void 0?e:a?.duration)!==null&&s!==void 0?s:void 0,this.events.emit("processed",new ld(this,a)),this.data=a}async decodeAudio(e){try{return await this._audioContext.decodeAudioData(e.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(e){e&&(this._engine=e,this._engine.on("hidden",()=>{e.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{e.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(e=>e.isPlaying())}isPaused(){return this._tracks.some(e=>e.isPaused())}isStopped(){return this._tracks.some(e=>e.isStopped())}play(e){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=e||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const e of this._tracks)e.pause();this.events.emit("pause",new hn(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const e of this._tracks)e.stop();this.events.emit("stop",new hn(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._tracks.forEach(s=>{s.playbackRate=this._playbackRate})}seek(e,s=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[s].seek(e)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(e=0){return this._tracks.length?this._tracks[e].getPlaybackPosition():0}getTrackId(e){return this._tracks.indexOf(e)}async _resumePlayback(){if(this.isPaused()){const e=[];for(const s of this._tracks)e.push(s.play().then(()=>(this._tracks.splice(this.getTrackId(s),1),!0)));this.events.emit("resume",new hn(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(e)}return!0}async _startPlayback(){const e=this._getTrackInstance(this.data),s=await e.play(()=>{this.events.emit("playbackstart",new hn(this,e)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new hn(this,e));const r=this.getTrackId(e);return r!==-1&&this._tracks.splice(r,1),s}_getTrackInstance(e){var s;const r=new hd(e);return r.loop=this.loop,r.volume=this.volume,r.duration=(s=this.duration)!==null&&s!==void 0?s:0,r.playbackRate=this._playbackRate,this._tracks.push(r),r}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const xp={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function Sh(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class Sr{get resources(){return this._resources}constructor(e){var s;this.events=new I,this.canvas=new ko({filtering:fe.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new P,e&&(!((s=e.loadables)===null||s===void 0)&&s.length)&&this.addResources(e.loadables)}onInitialize(e){this.engine=e,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await po(500,this.engine.clock)}addResource(e){this._resources.push(e)}addResources(e){let s=0;const r=e.length;for(s;s<r;s++)this.addResource(e[s])}markResourceComplete(){this._numLoaded++}get progress(){const e=this._resources.length;return e>0?j(this._numLoaded,0,e)/e:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(e,s){this._totalTimeMs+=s}onDraw(e){const s=this._totalTimeMs/1e3;e.fillStyle=Q.Black.toRGBA(),e.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),e.save(),e.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const r=s*10;e.strokeStyle="white",e.lineWidth=10,e.lineCap="round",e.arc(0,0,40,r,r+Math.PI*3/2),e.stroke(),e.fillStyle="white",e.font="16px sans-serif";const a=(this.progress*100).toFixed(0)+"%",l=e.measureText(a),f=Math.abs(l.actualBoundingBoxLeft)+Math.abs(l.actualBoundingBoxRight),g=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);e.fillText(a,-f/2,g/2),e.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async e=>{this.events.emit("loadresourcestart",e),await e.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",e)})}));for(const e of this._resources)e instanceof cd&&e.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await an.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const bp="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var yp=o(851);class ln extends Sr{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const e=document.getElementById("excalibur-play-root");return e&&(this._playButtonRootElement=e),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(e){const s=Array.isArray(e)?{loadables:e}:e;super(s),this._logger=at.getInstance(),this._originalOptions={loadables:[]},this.events=new I,this._playButtonShown=!1,this.logo=bp,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=Q.White,this.backgroundColor="#176BAA",this._imageLoaded=new P,this.suppressPlayButton=!1,this._playButtonStyles=yp.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let r=document.getElementById("excalibur-play");return r||(r=document.createElement("button")),r.id="excalibur-play",r.textContent=this.playButtonText,r.style.display="none",r},this._originalOptions={...ln._DEFAULT_LOADER_OPTIONS,...s}}onInitialize(e){this.engine=e,this.screen=e.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var e,s;if(this.suppressPlayButton)this.hidePlayButton(),await po(500,(e=this.engine)===null||e===void 0?void 0:e.clock);else{const r=()=>{try{this._positionPlayButton()}catch{}};return!((s=this.engine)===null||s===void 0)&&s.browser&&this.engine.browser.window.on("resize",r),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",l=>{l.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(l=>{const f=g=>{var m;if(g.stopPropagation(),this.hidePlayButton(),!((m=this.engine)===null||m===void 0)&&m.browser&&this.engine.browser.window.off("resize",r),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(w){this._logger.error("could not go fullscreen",w)}l()};this._playButton.addEventListener("click",f),this._playButton.addEventListener("touchend",f),this._playButton.addEventListener("pointerup",f),this.engine&&this.engine.input.gamepads.once("button",()=>f(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var e;await po(200,(e=this.engine)===null||e===void 0?void 0:e.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const e=this._image;await this._imageLoaded.promise,await e?.decode()}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:e,y:s,width:r,height:a}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const l=this._playButton.clientWidth,f=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${e+r/2-l/2}px`,this._playButtonRootElement.style.top=`${s+a/2-f/2+100}px`)}}}onDraw(e){const s=this.engine.canvasHeight/this.engine.pixelRatio,r=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),e.fillStyle=this.backgroundColor,e.fillRect(0,0,r,s);let a=s/2;const l=Math.min(this.logoWidth,r*.75);let f=r/2-l/2;this.logoPosition&&(f=this.logoPosition.x,a=this.logoPosition.y);const g=Math.floor(l*(this.logoHeight/this.logoWidth)),m=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,f,a,l,g):e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,f,a-g-20,l,g),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=m;return}let w=f,y=a;this.loadingBarPosition&&(w=this.loadingBarPosition.x,y=this.loadingBarPosition.y),e.lineWidth=2,Ya(e,w,y,l,20,10,this.loadingBarColor);const A=l*this.progress,E=5,D=A-E*2,L=20-E*2;Ya(e,w+E,y+E,D>10?D:10,L,5,null,this.loadingBarColor),this.engine.screen.antialiasing=m}}ln._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const dd={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class ud{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("2d"))},arrayBufferSupport:function(){const e=new XMLHttpRequest;e.open("GET","/");try{e.responseType="arraybuffer"}catch{return!1}return e.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const e=document.createElement("a").style;return e.cssText="background-color:rgba(150,255,150,.5)",(""+e.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let e=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const s=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],r=this.getBrowserFeatures();for(const a of Object.keys(dd))r[a]?(e+="(%c%c)",s.push("font-weight: bold; color: green"),s.push("font-weight: normal; color: inherit")):(e+="(%c%c)",s.push("font-weight: bold; color: red"),s.push("font-weight: normal; color: inherit")),e+=" "+dd[a]+`
`;s.unshift(e),console.log.apply(console,s)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let e=!1;for(const s in this._criticalTests)this._criticalTests[s].call(this)||(this.failedTests.push(s),at.getInstance().error("Critical browser feature missing, Excalibur requires:",s),e=!0);if(e)return!1;for(const s in this._warningTest)this._warningTest[s]()||at.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",s);return!0}}var ut;(function(u){u.PreventCollision="PreventCollision",u.Passive="Passive",u.Active="Active",u.Fixed="Fixed"})(ut||(ut={}));class Vi{static create(e,s){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(e)){const a=this._GROUPS.get(e);if(a.mask===s)return a;throw new Error(`Collision group ${e} already exists with a different mask!`)}const r=new fs(e,this._CURRENT_BIT,s!==void 0?s:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(e,r),r}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(e){return this._GROUPS.get(e)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}Vi._STARTING_BIT=1,Vi._MAX_GROUPS=32,Vi._CURRENT_GROUP=1,Vi._CURRENT_BIT=Vi._STARTING_BIT,Vi._GROUPS=new Map;class fs{constructor(e,s,r){this._name=e,this._category=s,this._mask=r}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(e){const s=this.category&e.mask,r=this.mask&e.category;return s!==0&&r!==0}invert(){const e=Vi.create("~("+this.name+")",~this.mask|0);return e._category=~this.category,e}static combine(e){const s=e.map(l=>l.name).join("+"),a=~e.reduce((l,f)=>f.category|l,0);return Vi.create(s,a)}static collidesWith(e){const s=`collidesWith(${e.map(a=>a.name).join("+")})`,r=e.reduce((a,l)=>l.category|a,0);return Vi.create(s,r)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}fs.All=new fs("Collide with all groups",-1,-1);class Ze{constructor(e,s){this.colliderA=e,this.colliderB=s,this.id=null,this.id=Ze.calculatePairHash(e.id,s.id)}static canCollide(e,s){var r,a;if(e.id===s.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.localBounds.hasZeroDimensions()||s.localBounds.hasZeroDimensions())return!1;const l=(r=e?.owner)===null||r===void 0?void 0:r.get(St),f=(a=s?.owner)===null||a===void 0?void 0:a.get(St);return!(!l||!f||!l.group.canCollide(f.group)||l.collisionType===ut.Fixed&&f.collisionType===ut.Fixed||f.collisionType===ut.PreventCollision||l.collisionType===ut.PreventCollision||!l.isActive||!f.isActive)}get canCollide(){const e=this.colliderA,s=this.colliderB;return Ze.canCollide(e,s)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(e){return e===this.colliderA||e===this.colliderB}static calculatePairHash(e,s){return e.value<s.value?`#${e.value}+${s.value}`:`#${s.value}+${e.value}`}}class Pr{constructor(e,s){this.min=e,this.max=s}overlaps(e){return this.max>e.min&&e.max>this.min}getOverlap(e){return this.overlaps(e)?this.max>e.max?e.max-this.min:this.max-e.min:0}}class Ph{constructor(e){this.parent=e,this.parent=e||null,this.data=null,this.bounds=new ht,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class Th{constructor(e,s=new ht(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=e,this.worldBounds=s,this.root=null,this.nodes={}}_insert(e){if(this.root===null){this.root=e,this.root.parent=null;return}const s=e.bounds;let r=this.root;for(;!r.isLeaf();){const g=r.left,m=r.right,w=r.bounds.getPerimeter(),A=r.bounds.combine(s).getPerimeter(),E=2*A,D=2*(A-w);let L=0;const O=s.combine(g.bounds);let q,H;g.isLeaf()?L=O.getPerimeter()+D:(H=g.bounds.getPerimeter(),q=O.getPerimeter(),L=q-H+D);let N=0;const J=s.combine(m.bounds);if(m.isLeaf()?N=J.getPerimeter()+D:(H=m.bounds.getPerimeter(),q=J.getPerimeter(),N=q-H+D),E<L&&E<N)break;L<N?r=g:r=m}const a=r.parent,l=new Ph(a);l.bounds=s.combine(r.bounds),l.height=r.height+1,a!==null?(a.left===r?a.left=l:a.right=l,l.left=r,l.right=e,r.parent=l,e.parent=l):(l.left=r,l.right=e,r.parent=l,e.parent=l,this.root=l);let f=e.parent;for(;f;){if(f=this._balance(f),!f.left)throw new Error("Parent of current leaf cannot have a null left child"+f);if(!f.right)throw new Error("Parent of current leaf cannot have a null right child"+f);f.height=1+Math.max(f.left.height,f.right.height),f.bounds=f.left.bounds.combine(f.right.bounds),f=f.parent}}_remove(e){if(e===this.root){this.root=null;return}const s=e.parent,r=s.parent;let a;if(s.left===e?a=s.right:a=s.left,r){r.left===s?r.left=a:r.right=a,a.parent=r;let l=r;for(;l;)l=this._balance(l),l.bounds=l.left.bounds.combine(l.right.bounds),l.height=1+Math.max(l.left.height,l.right.height),l=l.parent}else this.root=a,a.parent=null}trackCollider(e){const s=new Ph;s.data=e,s.bounds=e.bounds,s.bounds.left-=2,s.bounds.top-=2,s.bounds.right+=2,s.bounds.bottom+=2,this.nodes[e.id.value]=s,this._insert(s)}updateCollider(e){var s;const r=this.nodes[e.id.value];if(!r)return!1;const a=e.bounds;if(!this.worldBounds.contains(a))return at.getInstance().warn("Collider with id "+e.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(e),!1;if(r.bounds.contains(a))return!1;if(this._remove(r),a.left-=this._config.boundsPadding,a.top-=this._config.boundsPadding,a.right+=this._config.boundsPadding,a.bottom+=this._config.boundsPadding,e.owner){const l=(s=e.owner)===null||s===void 0?void 0:s.get(St);if(l){const f=l.vel.x*32/1e3*this._config.velocityMultiplier,g=l.vel.y*32/1e3*this._config.velocityMultiplier;f<0?a.left+=f:a.right+=f,g<0?a.top+=g:a.bottom+=g}}return r.bounds=a,this._insert(r),!0}untrackCollider(e){const s=this.nodes[e.id.value];s&&(this._remove(s),this.nodes[e.id.value]=null,delete this.nodes[e.id.value])}_balance(e){if(e===null)throw new Error("Cannot balance at null node");if(e.isLeaf()||e.height<2)return e;const s=e.left,r=e.right,a=e,l=s,f=r,g=s.left,m=s.right,w=r.left,y=r.right,A=f.height-l.height;if(A>1)return f.left=a,f.parent=a.parent,a.parent=f,f.parent?f.parent.left===a?f.parent.left=f:f.parent.right=f:this.root=f,w.height>y.height?(f.right=w,a.right=y,y.parent=a,a.bounds=l.bounds.combine(y.bounds),f.bounds=a.bounds.combine(w.bounds),a.height=1+Math.max(l.height,y.height),f.height=1+Math.max(a.height,w.height)):(f.right=y,a.right=w,w.parent=a,a.bounds=l.bounds.combine(w.bounds),f.bounds=a.bounds.combine(y.bounds),a.height=1+Math.max(l.height,w.height),f.height=1+Math.max(a.height,y.height)),f;if(A<-1){if(l.left=a,l.parent=a.parent,a.parent=l,l.parent)if(l.parent.left===a)l.parent.left=l;else{if(l.parent.right!==a)throw"Error rotating Dynamic Tree";l.parent.right=l}else this.root=l;return g.height>m.height?(l.right=g,a.left=m,m.parent=a,a.bounds=f.bounds.combine(m.bounds),l.bounds=a.bounds.combine(g.bounds),a.height=1+Math.max(f.height,m.height),l.height=1+Math.max(a.height,g.height)):(l.right=m,a.left=g,g.parent=a,a.bounds=f.bounds.combine(g.bounds),l.bounds=a.bounds.combine(m.bounds),a.height=1+Math.max(f.height,g.height),l.height=1+Math.max(a.height,m.height)),l}return e}getHeight(){return this.root===null?0:this.root.height}query(e,s){const r=e.bounds,a=l=>{if(l&&l.bounds.overlaps(r))if(l.isLeaf()&&l.data!==e){if(s.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}rayCastQuery(e,s=1/0,r){const a=l=>{if(l&&l.bounds.rayCast(e,s))if(l.isLeaf()){if(r.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}getNodes(){const e=s=>s?[s].concat(e(s.left),e(s.right)):[];return e(this.root)}debug(e){const s=r=>{r&&(r.isLeaf()?r.bounds.draw(e,Q.Green):r.bounds.draw(e,Q.White),r.left&&s(r.left),r.right&&s(r.right))};s(this.root)}}class cn{constructor(e,s){this.pos=e,this.dir=s.normalize()}intersect(e){const s=e.begin.sub(this.pos);if(this.dir.cross(e.getSlope())===0&&s.cross(this.dir)!==0)return-1;const r=this.dir.cross(e.getSlope());if(r===0)return-1;const a=s.cross(e.getSlope())/r;if(a>=0){const l=s.cross(this.dir)/r/e.getLength();if(l>=0&&l<=1)return a}return-1}intersectPoint(e){const s=this.intersect(e);return s<0?null:this.getPoint(s)}getPoint(e){return this.pos.add(this.dir.scale(e))}}class Uo{constructor(e){this._config=e,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new Th(e.dynamicTree)}getColliders(){return this._colliders}query(e){const s=[];return e instanceof ht?this._dynamicCollisionTree.query({id:S("collider",-1),owner:null,bounds:e},r=>(s.push(r),!1)):this._dynamicCollisionTree.query({id:S("collider",-1),owner:null,bounds:new ht(e.x,e.y,e.x,e.y)},r=>(s.push(r),!1)),s}rayCast(e,s){var r,a,l;const f=[],g=(r=s?.maxDistance)!==null&&r!==void 0?r:1/0,m=s?.collisionGroup,w=m?m.category:(a=s?.collisionMask)!==null&&a!==void 0?a:fs.All.category,y=(l=s?.searchAllColliders)!==null&&l!==void 0?l:!1;return this._dynamicCollisionTree.rayCastQuery(e,g,A=>{const D=A.owner.get(St);if(s?.ignoreCollisionGroupAll&&D.group===fs.All)return!1;const L=(w&D.group.category)!==0;if(D?.group&&!L)return!1;const O=A.rayCast(e,g);if(O){if(s?.filter){if(s.filter(O)&&(f.push(O),!y))return!0}else if(f.push(O),!y)return!0}return!1}),f}track(e){if(!e){at.getInstance().warn("Cannot track null collider");return}if(e instanceof Ae){const s=e.getColliders();for(const r of s)r.owner=e.owner,this._colliders.push(r),this._dynamicCollisionTree.trackCollider(r)}else this._colliders.push(e),this._dynamicCollisionTree.trackCollider(e)}untrack(e){if(!e){at.getInstance().warn("Cannot untrack a null collider");return}if(e instanceof Ae){const s=e.getColliders();for(const r of s){const a=this._colliders.indexOf(r);a!==-1&&this._colliders.splice(a,1),this._dynamicCollisionTree.untrackCollider(r)}}else{const s=this._colliders.indexOf(e);s!==-1&&this._colliders.splice(s,1),this._dynamicCollisionTree.untrackCollider(e)}}_pairExists(e,s){const r=Ze.calculatePairHash(e.id,s.id);return this._pairs.has(r)}broadphase(e,s,r){const a=s/1e3,l=e.filter(g=>{var m,w;const y=(m=g.owner)===null||m===void 0?void 0:m.get(St);return((w=g.owner)===null||w===void 0?void 0:w.isActive)&&y.collisionType!==ut.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let f;for(let g=0,m=l.length;g<m;g++)f=l[g],this._dynamicCollisionTree.query(f,w=>{if(!this._pairExists(f,w)&&Ze.canCollide(f,w)){const y=new Ze(f,w);this._pairs.add(y.id),this._collisionPairCache.push(y)}return!1});if(r&&(r.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const g of l){const m=g.owner.get(St);if(m.collisionType!==ut.Active)continue;const w=m.vel.magnitude*a+m.acc.magnitude*.5*a*a,y=Math.min(g.bounds.height,g.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||w>y/2){r&&r.physics.fastBodies++;const A=m.globalPos.sub(m.oldPos),E=g.center,D=g.getFurthestPoint(m.vel),L=D.sub(A),O=new cn(L,m.vel);O.pos=O.pos.add(O.dir.scale(-2*this._config.continuous.surfaceEpsilon));let q,H=new B(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(O,w+this._config.continuous.surfaceEpsilon*2,N=>{if(!this._pairExists(g,N)&&Ze.canCollide(g,N)){const J=N.rayCast(O,w+this._config.continuous.surfaceEpsilon*10);if(J){const Y=J.point.sub(L);Y.magnitude<H.magnitude&&(H=Y,q=N)}}return!1}),q&&B.isValid(H)){const N=new Ze(g,q);this._pairs.has(N.id)||(this._pairs.add(N.id),this._collisionPairCache.push(N));const J=E.sub(D);m.globalPos=L.add(J).add(H).add(O.dir.scale(10*this._config.continuous.surfaceEpsilon)),g.update(m.transform.get()),r&&r.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(e,s){let r=[];for(let a=0;a<e.length;a++){const l=e[a].collide();if(r=r.concat(l),s&&l.length>0)for(const f of l)s.physics.contacts.set(f.id,f)}return s&&(s.physics.collisions+=r.length),r}update(e){let s=0;const r=e.length;for(let a=0;a<r;a++)this._dynamicCollisionTree.updateCollider(e[a])&&s++;return s}debug(e){this._dynamicCollisionTree.debug(e)}}class Us{constructor(){this.id=S("collider",Us._ID++),this.composite=null,this.events=new I,this.offset=B.Zero}touching(e){return!!this.collide(e)}}Us._ID=0;var Tr;(function(u){u.Arcade="arcade",u.Realistic="realistic"})(Tr||(Tr={}));var _s;(function(u){u.None="none",u.VerticalFirst="vertical-first",u.HorizontalFirst="horizontal-first"})(_s||(_s={}));const Eh={vertical:1,horizontal:2},Ih={horizontal:1,vertical:2},Rh={horizontal:0,vertical:0};var Gn;(function(u){u.DynamicTree="dynamic-tree",u.SparseHashGrid="sparse-hash-grid"})(Gn||(Gn={}));const gs=()=>({enabled:!0,gravity:z(0,0).clone(),solver:Tr.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:Gn.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:_s.None},realistic:{contactSolveBias:_s.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class Ae extends Us{set compositeStrategy(e){this._compositeStrategy=e}get compositeStrategy(){return this._compositeStrategy}constructor(e){super(),this._collisionProcessor=new Uo({...gs()}),this._dynamicAABBTree=new Th({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const s of e)this.addCollider(s)}clearColliders(){this._colliders=[]}addCollider(e){let s;e instanceof Ae?(s=e.getColliders(),s.forEach(r=>r.offset.addEqual(e.offset))):s=[e];for(const r of s)r.events.pipe(this.events),r.composite=this,this._colliders.push(r),this._collisionProcessor.track(r),this._dynamicAABBTree.trackCollider(r)}removeCollider(e){e.events.pipe(this.events),e.composite=null,ls(e,this._colliders),this._collisionProcessor.untrack(e),this._dynamicAABBTree.untrackCollider(e)}getColliders(){return this._colliders}get worldPos(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:B.Zero).add(this.offset)}get center(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:B.Zero).add(this.offset)}get bounds(){var e,s;const r=this.getColliders();return r.reduce((l,f)=>l.combine(f.bounds),(s=(e=r[0])===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new ht().translate(this.worldPos)).translate(this.offset)}get localBounds(){var e,s;const r=this.getColliders();return r.reduce((l,f)=>l.combine(f.localBounds),(s=(e=r[0])===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new ht)}get axes(){const e=this.getColliders();let s=[];for(const r of e)s=s.concat(r.axes);return s}getFurthestPoint(e){const s=this.getColliders(),r=[];for(const f of s)r.push(f.getFurthestPoint(e));let a=r[0],l=-Number.MAX_VALUE;for(const f of r){const g=f.dot(e);g>l&&(a=f,l=g)}return a}getInertia(e){const s=this.getColliders();let r=0;for(const a of s)r+=a.getInertia(e);return r}collide(e){let s=[e];e instanceof Ae&&(s=e.getColliders());const r=[];for(const l of s)this._dynamicAABBTree.query(l,f=>(r.push(new Ze(l,f)),!1));let a=[];for(const l of r)a=a.concat(l.collide());return a}getClosestLineBetween(e){const s=this.getColliders(),r=[];if(e instanceof Ae){const a=e.getColliders();for(const l of s)for(const f of a){const g=l.getClosestLineBetween(f);g&&r.push(g)}}else for(const a of s){const l=e.getClosestLineBetween(a);l&&r.push(l)}if(r.length){let a=r[0].getLength(),l=r[0];for(const f of r){const g=f.getLength();g<a&&(a=g,l=f)}return l}return null}contains(e){const s=this.getColliders();for(const r of s)if(r.contains(e))return!0;return!1}rayCast(e,s){const r=this.getColliders(),a=[];for(const l of r){const f=l.rayCast(e,s);f&&a.push(f)}if(a.length){let l=a[0],f=l.point.dot(e.dir);for(const g of a){const m=e.dir.dot(g.point);m<f&&(l=g,f=m)}return l}return null}project(e){const s=this.getColliders(),r=[];for(const a of s){const l=a.project(e);l&&r.push(l)}if(r.length){const a=new Pr(r[0].min,r[0].max);for(const l of r)a.min=Math.min(l.min,a.min),a.max=Math.max(l.max,a.max);return a}return null}update(e){if(e){const s=this.getColliders();for(const r of s)r.owner=this.owner,r.update(e)}}debug(e,s,r){const a=this.getColliders();e.save(),e.translate(this.offset.x,this.offset.y);for(const l of a)l.debug(e,s,r);e.restore()}clone(){const e=new Ae(this._colliders.map(s=>s.clone()));return e.offset=this.offset.clone(),e}}class le{constructor(e,s){this.begin=e,this.end=s}clone(e){const s=e||new le(this.begin.clone(),this.end.clone());return s.begin=this.begin.clone(s.begin),s.end=this.end.clone(s.end),s}transform(e,s){const r=s||new le(B.Zero,B.Zero);return r.begin=e.multiply(this.begin,r.begin),r.end=e.multiply(this.end,r.end),r}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const e=this.begin,s=this.end,r=e.distance(s);return this._slope=s.sub(e).scale(1/r)}getEdge(){const e=this.begin;return this.end.sub(e)}getLength(){const e=this.begin,s=this.end;return e.distance(s)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new le(this.end,this.begin)}below(e){return(this.end.x-this.begin.x)*(e.y-this.begin.y)-(this.end.y-this.begin.y)*(e.x-this.begin.x)>=0}clip(e,s,r=!0){let a=e;r&&(a=a.normalize());const l=a.dot(this.begin)-s,f=a.dot(this.end)-s,g=[];if(l<=0&&g.push(this.begin),f<=0&&g.push(this.end),l*f<0){const m=l/(l-f);g.push(this.begin.add(this.end.sub(this.begin).scale(m)))}return g.length!==2?null:new le(g[0],g[1])}distanceToPoint(e,s=!1){const r=e.x,a=e.y,l=this.getLength(),f=this.end.y-this.begin.y,g=this.end.x-this.begin.x,m=(f*r-g*a+this.end.x*this.begin.y-this.end.y*this.begin.x)/l;return s?m:Math.abs(m)}findVectorToPoint(e){const s=this.begin.sub(e),r=this.getSlope();return s.sub(r.scale(s.dot(r)))}findPoint(e=null,s=null){const r=this.slope,a=this.intercept;if(e!==null)return new B(e,r*e+a);if(s!==null)return new B((s-a)/r,s);throw new Error("You must provide an X or a Y value")}hasPoint(){let e,s=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")e=new B(arguments[0],arguments[1]),s=arguments[2]||0;else if(arguments[0]instanceof B)e=arguments[0],s=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const r=e.x-this.begin.x,a=e.y-this.begin.y,l=this.end.x-this.begin.x,f=this.end.y-this.begin.y,g=r*f-a*l;return Math.abs(g)>s?!1:Math.abs(l)>=Math.abs(f)?l>0?this.begin.x<=e.x&&e.x<=this.end.x:this.end.x<=e.x&&e.x<=this.begin.x:f>0?this.begin.y<=e.y&&e.y<=this.end.y:this.end.y<=e.y&&e.y<=this.begin.y}}function Dh(u,e){const r=u.dir(),a=e.dir(),l=r.dot(r),f=a.dot(a);if(l<1e-9&&f<1e-9)return new le(u.begin,e.begin);if(l<1e-9){const q=j(a.dot(u.begin.sub(e.begin))/f,0,1),H=e.begin.add(a.scale(q));return new le(u.begin,H)}if(f<1e-9){const q=j(r.dot(e.begin.sub(u.begin))/l,0,1),H=u.begin.add(r.scale(q));return new le(H,e.begin)}const g=u.begin.sub(e.begin),m=l,w=f,y=a.dot(g),A=m*w-Math.pow(r.dot(a),2);let E=0,D=0;Math.abs(A)>1e-9?E=j((r.dot(a)*y-w*r.dot(g))/A,0,1):E=j(r.dot(g)/m,0,1),Math.abs(w)>1e-9?D=j((r.dot(a)*E+y)/w,0,1):D=0;const L=u.begin.add(r.scale(E)),O=e.begin.add(a.scale(D));return new le(L,O)}const Xi={PolygonPolygonClosestLine(u,e){const s=u.getSides(),r=e.getSides();let a=Number.MAX_VALUE,l=null;for(let f=0;f<s.length;f++)for(let g=0;g<r.length;g++){const m=Dh(s[f],r[g]),w=m.getLength();w<a&&(a=w,l=m)}return l},PolygonEdgeClosestLine(u,e){const r=e.worldPos.sub(u.worldPos),a=new cn(u.worldPos,r),l=u.rayCast(a).point.add(a.dir.scale(.1)),f=u.getClosestFace(l),g=e.asLine();return Dh(f.face,g)},PolygonCircleClosestLine(u,e){const s=e.worldPos,r=s.sub(u.worldPos),a=new cn(u.worldPos,r.normalize()),l=u.rayCast(a).point.add(a.dir.scale(.1)),f=u.getClosestFace(l),g=f.face.begin,m=f.face.getEdge();let w=(m.x*(s.x-g.x)+m.y*(s.y-g.y))/(m.x*m.x+m.y*m.y);w>1?w=1:w<0&&(w=0);const y=Math.sqrt(Math.pow(g.x+m.x*w-s.x,2)+Math.pow(g.y+m.y*w-s.y,2))-e.radius,A=(g.x+m.x*w-s.x)*e.radius/(e.radius+y),E=(g.y+m.y*w-s.y)*e.radius/(e.radius+y);return new le(m.scale(w).add(g),new B(s.x+A,s.y+E))},CircleCircleClosestLine(u,e){const r=e.worldPos.sub(u.worldPos),l=u.worldPos.sub(e.worldPos),f=new cn(u.worldPos,r),g=new cn(e.worldPos,l),m=u.rayCast(f),w=e.rayCast(g);return new le(m.point,w.point)},CircleEdgeClosestLine(u,e){const s=u.worldPos,r=e.asLine(),a=r.begin,l=r.getEdge(),f=a,g=l;let m=(g.x*(s.x-f.x)+g.y*(s.y-f.y))/(g.x*g.x+g.y*g.y);m>1?m=1:m<0&&(m=0);const w=Math.sqrt(Math.pow(f.x+g.x*m-s.x,2)+Math.pow(f.y+g.y*m-s.y,2))-u.radius,y=(f.x+g.x*m-s.x)*u.radius/(u.radius+w),A=(f.y+g.y*m-s.y)*u.radius/(u.radius+w);return new le(g.scale(m).add(f),new B(s.x+y,s.y+A))},EdgeEdgeClosestLine(u,e){const s=u.asLine(),r=e.asLine();return Dh(s,r)}};class Oe extends Us{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var e;if(this._radius)return this._radius;const s=this._transform,r=(e=s?.globalScale)!==null&&e!==void 0?e:B.One;return this._radius=this._naturalRadius*Math.min(r.x,r.y)}set radius(e){var s;const r=this._transform,a=(s=r?.globalScale)!==null&&s!==void 0?s:B.One;this._naturalRadius=e/Math.min(a.x,a.y),this._localBoundsDirty=!0,this._radius=e}constructor(e){super(),this.offset=B.Zero,this._globalMatrix=ue.identity(),this._localBoundsDirty=!0,this.offset=e.offset||B.Zero,this.radius=e.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new Oe({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(e){var s,r;return((r=(s=this._transform)===null||s===void 0?void 0:s.pos)!==null&&r!==void 0?r:this.offset).distance(e)<=this.radius}rayCast(e,s=1/0){var r,a;const l=this.center,f=e.dir,g=e.pos,m=l.sub(g),w=f.scale(m.dot(f)),A=m.sub(w).magnitude;if(A>this.radius)return null;{let E=0;if(X(A,this.radius,1e-4)){if(E=-f.dot(g.sub(l)),E>0&&E<s){const D=e.getPoint(E);return{point:D,normal:D.sub(l).normalize(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(St),distance:E}}return null}else{const D=Math.sqrt(Math.pow(f.dot(g.sub(l)),2)-Math.pow(g.sub(l).distance(),2)+Math.pow(this.radius,2)),L=-f.dot(g.sub(l))+D,O=-f.dot(g.sub(l))-D,q=[];L>=0&&q.push(L),O>=0&&q.push(O);const H=Math.min(...q);if(H<=s){const N=e.getPoint(H);return{point:N,normal:N.sub(l).normalize(),collider:this,body:(a=this.owner)===null||a===void 0?void 0:a.get(St),distance:H}}return null}}}getClosestLineBetween(e){if(e instanceof Oe)return Xi.CircleCircleClosestLine(this,e);if(e instanceof De)return Xi.PolygonCircleClosestLine(e,this).flip();if(e instanceof di)return Xi.CircleEdgeClosestLine(this,e).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof Oe)return Fi.CollideCircleCircle(this,e);if(e instanceof De)return Fi.CollideCirclePolygon(this,e);if(e instanceof di)return Fi.CollideCircleEdge(this,e);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){return this.center.add(e.normalize().scale(this.radius))}getFurthestLocalPoint(e){return e.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new ht(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(e){return e*this.radius*this.radius/2}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(e){const s=[],a=this.center.dot(e);return s.push(a),s.push(a+this.radius),s.push(a-this.radius),new Pr(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s,r){var a,l,f,g;const{lineWidth:m}={lineWidth:1,...r},w=this._transform,y=(a=w?.globalScale)!==null&&a!==void 0?a:B.One,A=(l=w?.globalRotation)!==null&&l!==void 0?l:0,E=(f=w?.globalPos)!==null&&f!==void 0?f:B.Zero;e.save(),e.translate(E.x,E.y),e.rotate(A),e.scale(y.x,y.y),e.drawCircle((g=this.offset)!==null&&g!==void 0?g:B.Zero,this._naturalRadius,Q.Transparent,s,m),e.restore()}}class dn{constructor(e,s,r,a,l,f,g,m){var w,y,A,E,D,L;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=e,this.colliderB=s,this.mtv=r,this.normal=a,this.tangent=l,this.points=f,this.localPoints=g,this.info=m,this.id=Ze.calculatePairHash(e.id,s.id),e.composite||s.composite){const O=((w=e.composite)===null||w===void 0?void 0:w.compositeStrategy)==="separate"?e.id:(A=(y=e.composite)===null||y===void 0?void 0:y.id)!==null&&A!==void 0?A:e.id,q=((E=s.composite)===null||E===void 0?void 0:E.compositeStrategy)==="separate"?s.id:(L=(D=s.composite)===null||D===void 0?void 0:D.id)!==null&&L!==void 0?L:s.id;this.id+="|"+Ze.calculatePairHash(O,q)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(St)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(St))}matchAwake(){const e=this.bodyA,s=this.bodyB;e&&s&&e.isSleeping!==s.isSleeping&&(e.isSleeping&&e.collisionType!==ut.Fixed&&s.sleepMotion>=e.wakeThreshold&&(e.isSleeping=!1),s.isSleeping&&s.collisionType!==ut.Fixed&&e.sleepMotion>=s.wakeThreshold&&(s.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(e){if(e!==this.colliderA&&e!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(e===this.colliderA)return this;const s=this.colliderA,r=this.colliderB;return this.colliderB=s,this.colliderA=r,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class fd{constructor(){this.axis=z(0,0),this.localAxis=z(0,0),this.side=new le(z(0,0),z(0,0)),this.localSide=new le(z(0,0),z(0,0)),this.point=z(0,0),this.localPoint=z(0,0)}}class _e{static findPolygonPolygonSeparation(e,s){if(s.transform.matrix.determinant()===0)return _e.findPolygonPolygonSeparationDegenerate(e,s);let r=-Number.MAX_VALUE,a=-1,l;const f=s.transform.inverse.multiply(e.transform.matrix,_e._SCRATCH_MATRIX),g=f.getRotation(),m=e.normals,w=e.points,y=s.points;for(let D=0;D<w.length;D++){const L=m[D].rotate(g,_e._ZERO,_e._SCRATCH_NORMAL),O=f.multiply(w[D],_e._SCRATCH_POINT);let q=Number.MAX_VALUE,H;for(let N=0;N<y.length;N++){const J=L.dot(y[N].sub(O,_e._SCRATCH_SUB_POINT));J<q&&(q=J,H=y[N])}q>r&&(r=q,a=D,l=H)}const A=(a+1)%w.length,E=_e.SeparationPool.get();return E.collider=e,E.separation=r,r>0||(m[a].clone(E.localAxis),m[a].rotate(e.transform.rotation,_e._ZERO,E.axis),e.transform.matrix.multiply(w[a],E.side.begin),e.transform.matrix.multiply(w[A],E.side.end),s.transform.matrix.multiply(l,E.point),E.sideId=a,l.clone(E.localPoint),w[a].clone(E.localSide.begin),w[A].clone(E.localSide.end)),E}static findCirclePolygonSeparation(e,s){const r=s.axes,l=s.center.sub(e.worldPos),f=s.getFurthestPoint(l.negate());r.push(f.sub(e.worldPos).normalize());let g=Number.MAX_VALUE,m=null,w=-1;for(let y=0;y<r.length;y++){const A=s.project(r[y]),E=e.project(r[y]),D=A.getOverlap(E);if(D<=0)return null;D<g&&(g=D,m=r[y],w=y)}return w<0?null:m.normalize().scale(g)}static findPolygonPolygonSeparationDegenerate(e,s){let r=-Number.MAX_VALUE,a=null,l=null,f=-1,g=null;const m=e.getSides(),w=e.getLocalSides();for(let y=0;y<m.length;y++){const A=m[y],E=A.normal(),D=s.getFurthestPoint(E.negate()),L=A.distanceToPoint(D,!0);L>r&&(r=L,a=A,l=E,f=y,g=D)}return{collider:e,separation:l?r:99,axis:l,side:a,localSide:w[f],sideId:f,point:g,localPoint:l?s.getFurthestLocalPoint(l.negate()):null}}}_e.SeparationPool=new bo(()=>new fd,u=>u,500),_e._ZERO=z(0,0),_e._SCRATCH_POINT=z(0,0),_e._SCRATCH_SUB_POINT=z(0,0),_e._SCRATCH_NORMAL=z(0,0),_e._SCRATCH_MATRIX=ue.identity(),_e.SeparationPool.disableWarnings=!0;const Ap=B.Zero,Cp=B.Zero,Sp=ue.identity(),Fi={CollideCircleCircle(u,e){const s=u.worldPos,r=e.worldPos,a=u.radius+e.radius,l=s.distance(r);if(l>a)return[];const f=a-l,g=r.sub(s).normalize(),m=g.perpendicular(),w=g.scale(f),y=u.getFurthestPoint(g),A=u.getFurthestLocalPoint(g),E={collider:u,separation:f,axis:g,point:y};return[new dn(u,e,w,g,m,[y],[A],E)]},CollideCirclePolygon(u,e){var s,r;let a=_e.findCirclePolygonSeparation(u,e);if(!a)return[];a=a.dot(e.center.sub(u.center))<0?a.negate():a;const f=u.getFurthestPoint(a),m=((r=(s=u.owner)===null||s===void 0?void 0:s.get(et))!==null&&r!==void 0?r:new et).applyInverse(f),w=a.normalize(),y={collider:u,separation:-a.magnitude,axis:w,point:f,localPoint:m,side:e.findSide(w.negate()),localSide:e.findLocalSide(w.negate())};return[new dn(u,e,a,w,w.perpendicular(),[f],[m],y)]},CollideCircleEdge(u,e){const s=u.center,r=e.asLine(),a=r.end.sub(r.begin),l=a.dot(r.end.sub(s)),f=a.dot(s.sub(r.begin)),g=e.asLine(),m=e.asLocalLine();if(f<=0){const H=r.begin.sub(s),N=H.dot(H);if(N>u.radius*u.radius)return[];const J=H.normalize(),Y=u.radius-Math.sqrt(N),$={collider:u,separation:Y,axis:J,point:g.begin,side:g,localSide:m};return[new dn(u,e,J.scale(Y),J,J.perpendicular(),[g.begin],[m.begin],$)]}if(l<=0){const H=r.end.sub(s),N=H.dot(H);if(N>u.radius*u.radius)return[];const J=H.normalize(),Y=u.radius-Math.sqrt(N),$={collider:u,separation:Y,axis:J,point:g.end,side:g,localSide:m};return[new dn(u,e,J.scale(Y),J,J.perpendicular(),[g.end],[m.end],$)]}const w=a.dot(a),y=r.begin.scale(l).add(r.end.scale(f)).scale(1/w),A=s.sub(y),E=A.dot(A);if(E>u.radius*u.radius)return[];let D=a.perpendicular();D.dot(s.sub(r.begin))<0&&(D.x=-D.x,D.y=-D.y),D=D.normalize();const L=u.radius-Math.sqrt(E),O=D.scale(L),q={collider:u,separation:L,axis:D,point:y,side:g,localSide:m};return[new dn(u,e,O,D.negate(),D.negate().perpendicular(),[y],[y.sub(e.worldPos)],q)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(u,e){var s;const r=u.center,l=e.center.sub(r).normalize(),f=new De({points:[e.begin,e.end,e.end.add(l.scale(100)),e.begin.add(l.scale(100))],offset:e.offset});f.owner=e.owner,((s=e.owner)===null||s===void 0?void 0:s.get(et))&&f.update(e.owner.get(et).get());const m=this.CollidePolygonPolygon(u,f);return m.length&&(m[0].colliderB=e,m[0].id=Ze.calculatePairHash(u.id,e.id)),m},CollidePolygonPolygon(u,e){const s=_e.findPolygonPolygonSeparation(u,e);if(s.separation>0)return[];const r=_e.findPolygonPolygonSeparation(e,u);if(r.separation>0)return[];const a=s.separation>r.separation?s:r,l=a.collider===u?e:u,f=a.collider===u?u:e,g=l.transform.inverse.multiply(f.transform.matrix,Sp),m=g.getRotation(),w=f.normals[a.sideId].rotate(m,Ap,Cp);let y=Number.MAX_VALUE,A=0;for(let H=0;H<l.normals.length;H++){const N=w.dot(l.normals[H]);N<y&&(y=N,A=H)}if(!a.localSide||!a.localAxis||!a.axis)return[];const E=a.localSide.transform(g),D=a.localAxis.perpendicular().negate().rotate(m),O=new le(l.points[A],l.points[(A+1)%l.points.length]).clip(D.negate(),-D.dot(E.begin),!1);let q=null;if(O&&(q=O.clip(D,D.dot(E.end),!1)),q){const H=[],N=[],J=q.getPoints();for(let ot=0;ot<J.length;ot++){const Z=J[ot];E.below(Z)&&(H.push(Z),N.push(l.transform.apply(Z)))}let Y=a.axis,$=Y.perpendicular();return e.center.sub(u.center).dot(Y)<0&&(Y=Y.negate(),$=Y.perpendicular()),[new dn(u,e,Y.scale(-a.separation),Y,$,N,H,a)]}return[]},FindContactSeparation(u,e){var s,r,a,l;const f=u.colliderA,g=(r=(s=u.bodyA)===null||s===void 0?void 0:s.transform)!==null&&r!==void 0?r:new et,m=u.colliderB,w=(l=(a=u.bodyB)===null||a===void 0?void 0:a.transform)!==null&&l!==void 0?l:new et;if(f instanceof Oe&&m instanceof Oe){const y=f.radius+m.radius,A=g.pos.distance(w.pos);return-(y-A)}if(f instanceof De&&m instanceof De&&u.info.localSide){let y,A;return u.info.collider===f?(y=new le(g.apply(u.info.localSide.begin).add(f.offset),g.apply(u.info.localSide.end).add(f.offset)),A=w.apply(e).add(m.offset)):(y=new le(w.apply(u.info.localSide.begin).add(m.offset),w.apply(u.info.localSide.end).add(m.offset)),A=g.apply(e).add(f.offset)),y.distanceToPoint(A,!0)}if(f instanceof De&&m instanceof Oe||m instanceof De&&f instanceof Oe){const y=g.apply(e);if(u.info.side)return u.info.side.distanceToPoint(y,!0)}if(f instanceof di&&m instanceof De||m instanceof di&&f instanceof De){let y;if(u.info.collider===f?y=w.apply(e):y=g.apply(e),u.info.side)return u.info.side.distanceToPoint(y,!0)}if(f instanceof Oe&&m instanceof di||m instanceof Oe&&f instanceof di){const y=w.apply(e);let A;f instanceof Oe&&(A=f.getFurthestPoint(u.normal));const E=y.distance(A);if(u.info.side)return E>0?-E:0}return 0}};class di extends Us{constructor(e){var s;super(),this._globalMatrix=ue.identity(),this.begin=e.begin||B.Zero,this.end=e.end||B.Zero,this.offset=(s=e.offset)!==null&&s!==void 0?s:B.Zero}clone(){return new di({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var e;const s=this._transform;return(e=s?.globalPos.add(this.offset))!==null&&e!==void 0?e:this.offset}get center(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.average(s)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const e=this._getTransformedBegin(),s=this._getTransformedEnd(),r=e.distance(s);return s.sub(e).scale(1/r)}getLength(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.distance(s)}contains(){return!1}rayCast(e,s=1/0){var r;const a=this._getTransformedBegin().sub(e.pos);if(e.dir.cross(this.getSlope())===0&&a.cross(e.dir)!==0)return null;const l=e.dir.cross(this.getSlope());if(l===0)return null;const f=a.cross(this.getSlope())/l;if(f>=0&&f<=s){const g=a.cross(e.dir)/l/this.getLength();if(g>=0&&g<=1)return{distance:f,normal:this.asLine().normal(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(St),point:e.getPoint(f)}}return null}getClosestLineBetween(e){if(e instanceof Oe)return Xi.CircleEdgeClosestLine(e,this);if(e instanceof De)return Xi.PolygonEdgeClosestLine(e,this).flip();if(e instanceof di)return Xi.EdgeEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof Oe)return Fi.CollideCircleEdge(e,this);if(e instanceof De)return Fi.CollidePolygonEdge(e,this);if(e instanceof di)return Fi.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this._getTransformedBegin(),r=this._getTransformedEnd();return e.dot(s)>0?s:r}_boundsFromBeginEnd(e,s,r=10){return new ht(Math.min(e.x,s.x)-r,Math.min(e.y,s.y)-r,Math.max(e.x,s.x)+r,Math.max(e.y,s.y)+r)}get bounds(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return this._boundsFromBeginEnd(e,s)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new le(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new le(this.begin,this.end)}get axes(){const s=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),r=[];return r.push(s),r.push(s.negate()),r.push(s.normal()),r.push(s.normal().negate()),r}getInertia(e){const s=this.end.sub(this.begin).distance()/2;return e*s*s}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(e){const s=[],r=[this._getTransformedBegin(),this._getTransformedEnd()],a=r.length;for(let l=0;l<a;l++)s.push(r[l].dot(e));return new Pr(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s){const r=this._getTransformedBegin(),a=this._getTransformedEnd();e.drawLine(r,a,s,2),e.drawCircle(r,2,s),e.drawCircle(a,2,s)}}class Ce{static registerGraphicsContext(e){Ce._ctx=e}static draw(e){this._drawCalls.push(e)}static drawPoint(e,s){Ce.draw(r=>{r.debug.drawPoint(e,s)})}static drawLine(e,s,r){Ce.draw(a=>{a.debug.drawLine(e,s,r)})}static drawLines(e,s){e.length>1&&Ce.draw(r=>{for(let a=0;a<e.length-1;a++)r.debug.drawLine(e[a],e[a+1],s)})}static drawText(e,s){Ce.draw(r=>{r.debug.drawText(e,s)})}static drawPolygon(e,s){e.length>1&&Ce.draw(r=>{const a=e[0],l=[...e,a];for(let f=0;f<l.length-1;f++)r.debug.drawLine(l[f],l[f+1],s)})}static drawCircle(e,s,r){const{color:a,strokeColor:l,width:f}={color:Q.Black,strokeColor:void 0,width:void 0,...r};Ce.draw(g=>{g.drawCircle(e,s,a,l,f)})}static drawBounds(e,s){Ce.draw(r=>{r.debug.drawRect(e.left,e.top,e.width,e.height,s)})}static drawRay(e,s){const{distance:r,color:a}={color:Q.Blue,distance:10,...s};Ce.draw(l=>{const f=e.pos,g=e.pos.add(e.dir.scale(r));l.debug.drawLine(f,g,{color:a})})}static flush(e){e.save(),e.z=Ce.z;for(const s of Ce._drawCalls)s(e);e.restore(),Ce.clear()}static clear(){Ce._drawCalls.length=0}}Ce._drawCalls=[],Ce.z=1/0;class De extends Us{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(e){if(e.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=e,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const e=[];for(let s=0;s<this._points.length;s++)e.push(this._points[(s+1)%this._points.length].sub(this._points[s]).normal());this._normals=e}get points(){return this._points}get transform(){return this._transform}constructor(e){var s;super(),this._logger=at.getInstance(),this._transform=new ds,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(s=e.offset)!==null&&s!==void 0?s:B.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=e.points,this.isConvex()||e.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(e){this._isCounterClockwiseWinding(e)||e.reverse()}_isCounterClockwiseWinding(e){let s=0;for(let r=0;r<e.length;r++)s+=(e[(r+1)%e.length].x-e[r].x)*(e[(r+1)%e.length].y+e[r].y);return s<0}isConvex(){if(this.points.length<3)return!1;let e=this.points[this.points.length-2],s=this.points[this.points.length-1],r=Math.atan2(s.y-e.y,s.x-e.x),a=0,l=0,f=0;for(const[g,m]of this.points.entries()){if(e=s,a=r,s=m,r=Math.atan2(s.y-e.y,s.x-e.x),e.equals(s))return!1;let w=r-a;if(w<=-Math.PI?w+=Math.PI*2:w>Math.PI&&(w-=Math.PI*2),g===0){if(w===0)return!1;l=w>0?1:-1}else if(l*w<=0)return!1;f+=w}return Math.abs(Math.round(f/(Math.PI*2)))===1}tessellate(){const e=[];for(let s=1;s<this.points.length-2;s++)e.push([this.points[0],this.points[s+1],this.points[s+2]]);return e.push([this.points[0],this.points[1],this.points[2]]),new Ae(e.map(s=>We.Polygon(s)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const e=[],s=[...this.points].reverse();let r=s.length;function a(A){return A===0?r-1:A-1}function l(A){return A===r-1?0:A+1}function f(A){const E=a(A),D=l(A),L=s[E],O=s[A],q=s[D],H=L.sub(O),N=q.sub(O);return!(H.cross(N)<0)}const g=s.map((A,E)=>f(E));function m(A,E,D,L){const O=D.sub(E),q=L.sub(D),H=E.sub(L),N=A.sub(E),J=A.sub(D),Y=A.sub(L),$=O.cross(N),ot=q.cross(J),Z=H.cross(Y);return!($>0||ot>0||Z>0)}function w(){for(let A=0;A<r;A++)if(g[A]){const E=a(A),D=l(A),L=s[E],O=s[A],q=s[D];let H=!0;for(let N=0;N<r;N++){if(N===A||N===E||N===D)continue;const J=s[N];if(m(J,L,O,q)){H=!1;break}}if(H)return A}for(let A=0;A<r;A++)if(g[A])return A;return 0}function y(A){const E=a(A),D=l(A),L=s[E],O=s[A],q=s[D];e.push([L,O,q]),s.splice(A,1),g.splice(A,1),r--}for(;r>3;){const A=w();y(A);for(let E=0;E<r;E++)g[E]=f(E)}return e.push([s[0],s[1],s[2]]),new Ae(e.map(A=>We.Polygon(A,B.Zero,!0)))}clone(){return new De({offset:this.offset.clone(),points:this.points.map(e=>e.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const e=this.points,s=e.length;this._transformedPoints.length=0;for(let r=0;r<s;r++)this._transformedPoints[r]=this._transform.apply(e[r].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const e=[],s=this.getTransformedPoints(),r=s.length;for(let a=0;a<r;a++)e.push(new le(s[a],s[(a+1)%r]));this._sides=e,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const e=[],s=this.points,r=s.length;for(let a=0;a<r;a++)e.push(new le(s[a],s[(a+1)%r]));this._localSides=e,this._localSidesDirty=!1}return this._localSides}findSide(e){const s=this.getSides();let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=s[l],m=f.normal().dot(e);m>a&&(r=f,a=m)}return r}findLocalSide(e){const s=this.getLocalSides();let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=s[l],m=f.normal().dot(e);m>a&&(r=f,a=m)}return r}get axes(){const e=[],s=this.getSides();for(let r=0;r<s.length;r++)e.push(s[r].normal());return e}update(e){e&&(e.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(s=>z(s.x*V(this._transform.scale.x),s.y*V(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(e){const s=this._transform.applyInverse(e),r=new cn(s,new B(1,0));let a=0;const l=this.getLocalSides();for(let f=0;f<l.length;f++){const g=l[f];r.intersect(g)>=0&&a++}return a%2!==0}getClosestLineBetween(e){if(e instanceof Oe)return Xi.PolygonCircleClosestLine(this,e);if(e instanceof De)return Xi.PolygonPolygonClosestLine(this,e);if(e instanceof di)return Xi.PolygonEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof Oe)return Fi.CollideCirclePolygon(e,this);if(e instanceof De)return Fi.CollidePolygonPolygon(this,e);if(e instanceof di)return Fi.CollidePolygonEdge(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this.getTransformedPoints();let r=null,a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=e.dot(s[l]);f>a&&(a=f,r=s[l])}return r}getFurthestLocalPoint(e){const s=this.points;let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=e.dot(s[l]);f>a&&(a=f,r=s[l])}return r}getClosestFace(e){const s=this.getSides();let r=Number.POSITIVE_INFINITY,a=-1,l=-1;for(let f=0;f<s.length;f++){const g=s[f].distanceToPoint(e);g<r&&(r=g,a=f,l=g)}return a!==-1?{distance:s[a].normal().scale(l),face:s[a]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=ht.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(e){if(this._cachedMass===e&&this._cachedInertia)return this._cachedInertia;let s=0,r=0;const a=this.points;for(let l=0;l<a.length;l++){const f=(l+1)%a.length,g=a[f].cross(a[l]);s+=g*(a[l].dot(a[l])+a[l].dot(a[f])+a[f].dot(a[f])),r+=g}return this._cachedMass=e,this._cachedInertia=e/6*(s/r)}rayCast(e,s=1/0){var r;const a=this.getSides(),l=a.length;let f=Number.MAX_VALUE,g,m=-1;for(let w=0;w<l;w++){const y=e.intersect(a[w]);y>=0&&y<f&&y<=s&&(f=y,g=a[w],m=w)}return m>=0?{collider:this,distance:f,body:(r=this.owner)===null||r===void 0?void 0:r.get(St),point:e.getPoint(f),normal:g.normal()}:null}project(e){const s=this.getTransformedPoints(),r=s.length;let a=Number.MAX_VALUE,l=-Number.MAX_VALUE;for(let f=0;f<r;f++){const g=s[f].dot(e);a=Math.min(a,g),l=Math.max(l,g)}return new Pr(a,l)}debug(e,s,r){const a=this.getTransformedPoints();Ce.drawPolygon(a,{color:s})}}class We{static Box(e,s,r=B.Half,a=B.Zero){return new De({points:new ht(-e*r.x,-s*r.y,e-e*r.x,s-s*r.y).getPoints(),offset:a})}static Polygon(e,s=B.Zero,r=!1){return new De({points:e,offset:s,suppressConvexWarning:r})}static Circle(e,s=B.Zero){return new Oe({radius:e,offset:s})}static Edge(e,s){return new di({begin:e,end:s})}static Capsule(e,s,r=B.Zero){const a=at.getInstance();return e===s&&a.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),s>=e?new Ae([We.Circle(e/2,z(0,-s/2+e/2).add(r)),We.Box(e,s-e,B.Half,r),We.Circle(e/2,z(0,s/2-e/2).add(r))]):new Ae([We.Circle(s/2,z(-e/2+s/2,0).add(r)),We.Box(e-s,s,B.Half,r),We.Circle(s/2,z(e/2-s/2,0).add(r))])}}class ge extends Ai{constructor(e){super(),this.events=new I,this.$colliderAdded=new Ye,this.$colliderRemoved=new Ye,this._collidersToRemove=[],this.set(e)}get(){return this._collider}set(e){return this.clear(),e&&(this._collider=e,this._collider.owner=this.owner,e.events.pipe(this.events),this.$colliderAdded.notifyAll(e),this.update()),e}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const e of this._collidersToRemove)e.events.unpipe(this.events),this.$colliderRemoved.notifyAll(e),e.owner=null}clone(){return new ge(this._collider.clone())}get bounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new ht}get localBounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new ht}update(){var e;const s=(e=this.owner)===null||e===void 0?void 0:e.get(et);this._collider&&(this._collider.owner=this.owner,s&&this._collider.update(s.get()))}collide(e){let s=this._collider,r=e._collider;if(!s||!r)return[];let a=!1;if(r instanceof Ae&&(s=r,r=this._collider,a=!0),this._collider){const l=s.collide(r);return l?(a&&l.forEach(f=>{f.mtv=f.mtv.negate(),f.normal=f.normal.negate(),f.tangent=f.normal.perpendicular(),f.colliderA=this._collider,f.colliderB=e._collider}),l):[]}return[]}onAdd(e){this._collider&&this.update(),this.events.on("precollision",s=>{const r=s;e.events.emit("precollision",new rn(r.self,r.other,r.side,r.intersection,r.contact)),e instanceof Qe&&e.onPreCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("postcollision",s=>{const r=s;e.events.emit("postcollision",new on(r.self,r.other,r.side,r.intersection,r.contact)),e instanceof Qe&&e.onPostCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("collisionstart",s=>{const r=s;e.events.emit("collisionstart",new yr(r.self,r.other,r.side,r.contact)),e instanceof Qe&&e.onCollisionStart(r.self,r.other,r.side,r.contact)}),this.events.on("collisionend",s=>{const r=s;e.events.emit("collisionend",new Ar(r.self,r.other,r.side,r.lastContact)),e instanceof Qe&&e.onCollisionEnd(r.self,r.other,r.side,r.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(e,s,r=B.Half,a=B.Zero){const l=We.Box(e,s,r,a);return this.set(l)}usePolygonCollider(e,s=B.Zero){const r=We.Polygon(e,s);return this.set(r)}useCircleCollider(e,s=B.Zero){const r=We.Circle(e,s);return this.set(r)}useEdgeCollider(e,s){const r=We.Edge(e,s);return this.set(r)}useCompositeCollider(e){return this.set(new Ae(e))}}var ii;(function(u){u.Rotation="rotation",u.X="x",u.Y="y"})(ii||(ii={}));class St extends Ai{constructor(e){var s,r,a;super(),this.dependencies=[et,Bt],this.id=S("body",St._ID++),this.events=new I,this.oldTransform=new ds,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=ut.PreventCollision,this.group=fs.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=B.Zero,this.oldVel=new B(0,0),this.oldAcc=B.Zero,this._impulseScratch=z(0,0),this._distanceFromCenterScratch=z(0,0),e?(this.collisionType=(s=e.type)!==null&&s!==void 0?s:this.collisionType,this.group=(r=e.group)!==null&&r!==void 0?r:this.group,this.useGravity=(a=e.useGravity)!==null&&a!==void 0?a:this.useGravity,this._bodyConfig={...gs().bodies,...e.config}):this._bodyConfig={...gs().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=St._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(e){this._bodyConfig={...gs().bodies,...e},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(e){St._DEFAULT_CONFIG=e}get mass(){return this._mass}set mass(e){this._mass=e,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===ut.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(e){this.isSleeping=e}set isSleeping(e){this._sleeping=e,e?(this.vel=B.Zero,this.acc=B.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const e=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),s=this._bodyConfig.sleepBias;this.sleepMotion=s*this.sleepMotion+(1-s)*e,this.sleepMotion=j(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const e=this.owner.get(ge);if(e){e.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),e.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const s=e.get();if(s)return this._cachedInertia=s.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===ut.Fixed?0:1/this.inertia}get active(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get isActive(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get center(){return this.globalPos}onAdd(e){var s,r;this.transform=(s=this.owner)===null||s===void 0?void 0:s.get(et),this.motion=(r=this.owner)===null||r===void 0?void 0:r.get(Bt)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get globalPos(){return this.transform.globalPos}set globalPos(e){this.transform.globalPos=e}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e}get torque(){return this.motion.torque}set torque(e){this.motion.torque=e}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(e){this.transform.globalRotation=e}get scale(){return this.transform.globalScale}set scale(e){this.transform.globalScale=e}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(e){this.motion.scaleFactor=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}applyImpulse(e,s){if(this.collisionType!==ut.Active)return;const r=s.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(ii.X)>-1&&(r.x=0),this.limitDegreeOfFreedom.indexOf(ii.Y)>-1&&(r.y=0),this.vel.addEqual(r),!this.limitDegreeOfFreedom.includes(ii.Rotation)){const a=e.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*a.cross(s)}}applyLinearImpulse(e){if(this.collisionType!==ut.Active)return;const s=e.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(ii.X)&&(s.x=0),this.limitDegreeOfFreedom.includes(ii.Y)&&(s.y=0),this.vel=this.vel.add(s)}applyAngularImpulse(e,s){if(this.collisionType===ut.Active&&!this.limitDegreeOfFreedom.includes(ii.Rotation)){const r=e.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*r.cross(s)}}captureOldTransform(){this.__oldTransformCaptured=!0;const e=this.transform.get();e.clone(this.oldTransform),this.oldTransform.parent=e.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}St._ID=0,St._DEFAULT_CONFIG={...gs().bodies};class Er extends zn{constructor(e){super(e),this.width=e.width,this.height=e.height,this.rasterize()}clone(){return new Er({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.color&&e.fillRect(0,0,this.width,this.height),this.strokeColor&&e.strokeRect(0,0,this.width,this.height)}}class zo extends zn{get radius(){return this._radius}set radius(e){this._radius=e,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(e){var s,r,a;super(e),this._radius=0;const l=(s=e.lineWidth)!==null&&s!==void 0?s:e.strokeColor?1:0;this.padding=(r=e.padding)!==null&&r!==void 0?r:2+l/2,this.radius=e.radius,this.filtering=(a=e.filtering)!==null&&a!==void 0?a:fe.Blended,this.rasterize()}clone(){return new zo({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.radius>0&&(e.beginPath(),e.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&e.fill(),this.strokeColor&&e.stroke())}}class zs extends Ai{constructor(e){var s,r;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(s=e?.useColliderShape)!==null&&s!==void 0?s:this.useColliderShape,this.useGraphicsBounds=(r=e?.useGraphicsBounds)!==null&&r!==void 0?r:this.useGraphicsBounds,this.localBounds=e?.localBounds}}class Vt{static CreateReversibleEasingFunction(e){return(s,r,a,l)=>a<r?r-(e(s,a,r,l)-a):e(s,r,a,l)}static CreateVectorEasingFunction(e){return(s,r,a,l)=>new B(e(s,r.x,a.x,l),e(s,r.y,a.y,l))}}Vt.Linear=Vt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,s*u/r+e)),Vt.EaseInQuad=Vt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,s*u*u+e)),Vt.EaseOutQuad=Vt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,-s*u*(u-2)+e)),Vt.EaseInOutQuad=Vt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r/2,u<1?s/2*u*u+e:(u--,-s/2*(u*(u-2)-1)+e))),Vt.EaseInCubic=Vt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,s*u*u*u+e)),Vt.EaseOutCubic=Vt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,u--,s*(u*u*u+1)+e)),Vt.EaseInOutCubic=Vt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r/2,u<1?s/2*u*u*u+e:(u-=2,s/2*(u*u*u+2)+e)));class _d{constructor(e){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=e}add(e){this._actions.push(e)}remove(e){const s=this._actions.indexOf(e);this._actions.splice(s,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const e=this._actions.length;for(let s=0;s<e;s++)this._actions[s].reset();this._completedActions=[]}update(e){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new mh(this._currentAction,this._entity))),this._currentAction.update(e),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new vh(this._currentAction,this._entity));const s=this._actions.shift();s&&this._completedActions.push(s)}}}let Pp=0;function Ut(){return Pp++}class gd{constructor(e,s,r){this.id=Ut(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new Dr(e),this._actionQueue=this._repeatContext.getQueue(),this._repeat=r,this._originalRepeat=r,this._repeatBuilder(this._repeatContext),this._repeat--}update(e){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(e)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class pd{constructor(e,s){this.id=Ut(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new Dr(e),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(e){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(e))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function md(u,e,s){return(1-s)*u+e*s}function Fh(u,e,s,r){const a=(u-e+W)%W>=Math.PI,l=Math.abs(e-u),f=W-l;let g=0,m=0;l>f?(g=f,m=l):(g=l,m=f);let w=0,y=1;switch(s){case R.ShortestPath:w=g,y=a?1:-1;break;case R.LongestPath:w=m,y=a?-1:1;break;case R.Clockwise:y=1,w=a?g:m;break;case R.CounterClockwise:y=-1,w=a?m:g;break}return u+y*(w*r)}function Ir(u,e,s){return u.scale(1-s).add(e.scale(s))}function vd(u,e,s){return(s-u)/(e-u)}function wd(u,e,s){const r=s.sub(u),a=e.sub(u),l=r.x/a.x,f=r.y/a.y;return Math.min(l,f)}function qi(u,e,s,r,a){const l=vd(u,e,a);return md(s,r,l)}function Tp(u,e,s,r,a){const l=wd(u,e,a);return Ir(s,r,l)}function xd(u){return u.offset instanceof B&&typeof u.duration=="number"}class bd{constructor(e,s){var r;if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._easing=Vt.Linear,this._offset=s.offset,this._easing=(r=s.easing)!==null&&r!==void 0?r:this._easing,this._tx=e.get(et),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=e;const s=j(qi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),f=(a-r.x)/(e/1e3),g=(l-r.y)/(e/1e3);this._motion.vel.x=f,this._motion.vel.y=g,this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=z(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Mh{constructor(e,s,r,a){if(this.id=Ut(),this._started=!1,this._stopped=!1,this._entity=e,this._tx=e.get(et),this._motion=e.get(Bt),this._speed=a,this._offset=new B(s,r),a<=0)throw at.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+a),new Error("Speed must be greater than 0 pixels per second")}update(e){this._started||(this._started=!0,this._start=new B(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(e){const s=e.get(et);return this._stopped||s.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function yd(u){return u.pos instanceof B&&typeof u.duration=="number"}class Ad{constructor(e,s){var r;if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._easing=Vt.Linear,this._end=s.pos,this._easing=(r=s.easing)!==null&&r!==void 0?r:this._easing,this._tx=e.get(et),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=e;const s=j(qi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),f=(a-r.x)/(e/1e3),g=(l-r.y)/(e/1e3);this._motion.vel.x=f,this._motion.vel.y=g,this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=z(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Bh{constructor(e,s,r,a){this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Bt),this._end=new B(s,r),this._speed=a}update(e){this._started||(this._started=!0,this._start=new B(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const s=this._dir.scale(this._speed);this._motion.vel=z(s.x,s.y),this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){const s=e.get(et);return this._stopped||new B(s.pos.x,s.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Ep(u){return typeof u.angle=="number"&&typeof u.duration=="number"}class Cd{constructor(e,s){var r;if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=s.angle,this._tx=e.get(et),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(r=s.rotationType)!==null&&r!==void 0?r:R.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=e;const s=j(qi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Fh(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(r-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Sd{constructor(e,s,r,a){this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Bt),this._end=s,this._speed=r,this._rotationType=a||R.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const s=Math.abs(this._end-this._start),r=W-s;switch(s>r?(this._shortDistance=r,this._longDistance=s):(this._shortDistance=s,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+W)%W>=Math.PI,this._rotationType){case R.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case R.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case R.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case R.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Ip(u){return typeof u.angleRadiansOffset=="number"&&typeof u.duration=="number"}class Pd{constructor(e,s){var r;if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=s.angleRadiansOffset,this._tx=e.get(et),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(r=s.rotationType)!==null&&r!==void 0?r:R.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._endAngle=rt(this._startAngle+this._offset),this._started=!0),this._currentMs-=e;const s=j(qi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Fh(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(r-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Td{constructor(e,s,r,a){this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Bt),this._speed=r,this._offset=s,this._rotationType=a||R.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const s=Math.abs(this._end-this._start),r=W-s;switch(s>r?(this._shortDistance=r,this._longDistance=s):(this._shortDistance=s,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+W)%W>=Math.PI,this._rotationType){case R.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case R.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case R.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case R.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function Ed(u){return typeof u.scale=="object"&&typeof u.duration=="number"}class Id{constructor(e,s){if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._endScale=z(1,1),this._startScale=z(1,1),this._endScale=s.scale,this._tx=e.get(et),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=e;const s=j(qi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Ir(this._startScale,this._endScale,s),a=this._tx.scale,l=r.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=B.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Rd{constructor(e,s,r,a,l){this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Bt),this._endX=s,this._endY=r,this._speedX=a,this._speedY=l}update(e){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*s}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*s}this.isComplete()&&(this._tx.scale=z(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Dd(u){return typeof u.scaleOffset=="object"&&typeof u.duration=="number"}class Fd{constructor(e,s){if(this.entity=e,this.id=Ut(),this._started=!1,this._stopped=!1,this._endScale=z(1,1),this._scaleOffset=z(0,0),this._startScale=z(1,1),this._scaleOffset=s.scaleOffset,this._tx=e.get(et),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=e;const s=j(qi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Ir(this._startScale,this._endScale,s),a=this._tx.scale,l=r.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=B.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Md{constructor(e,s,r,a){this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Bt),this._offset=new B(s,r),this._speedX=this._speedY=a}update(e){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Bd{constructor(e){this.id=Ut(),this._hasBeenCalled=!1,this._method=e}update(e){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class kd{constructor(e,s,r,a,l){this.easingFcn=l,this.id=Ut(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new B(0,0),this._lerpEnd=new B(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Bt),this._lerpDuration=a,this._lerpEnd=new B(s,r)}_initialize(){this._lerpStart=new B(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=z((s-this._tx.pos.x)/(e/1e3),(r-this._tx.pos.y)/(e/1e3))):(this._tx.pos=z(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=B.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=z(0,0),this._stopped=!0}}class Ld{constructor(e,s,r,a,l){this.easingFcn=l,this.id=Ut(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new B(0,0),this._lerpEnd=new B(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Bt),this._lerpDuration=a,this._offset=new B(s,r)}_initialize(){this._lerpStart=new B(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=z((s-this._tx.pos.x)/(e/1e3),(r-this._tx.pos.y)/(e/1e3))):(this._tx.pos=z(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=B.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=z(0,0),this._stopped=!0}}class Ud{constructor(e,s,r,a=1){this.id=Ut(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=e.get(se),this._timeVisible=s,this._timeNotVisible=r,this._duration=(s+r)*a}update(e){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=e,this._totalTime+=e,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class zd{constructor(e,s,r){this.id=Ut(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=e.get(se),this._endOpacity=s,this._remainingTime=this._originalTime=r}update(e){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*e)/this._remainingTime),this._remainingTime-=e,this.isComplete()&&(this._graphics.opacity=this._endOpacity),at.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class Hd{constructor(e){this.id=Ut(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=e}update(e){this._started||(this._started=!0),this._elapsedTime+=e}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class Od{constructor(e){this.id=Ut(),this._stopped=!1,this._entity=e}update(e){this._entity.get(Vn).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class kh{constructor(e,s,r){this.id=Ut(),this._started=!1,this._stopped=!1,this._tx=e.get(et),this._motion=e.get(Bt),this._followTx=s.get(et),this._followMotion=s.get(Bt),this._current=new B(this._tx.pos.x,this._tx.pos.y),this._end=new B(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=r!==void 0?r:this._current.distance(this._end),this._speed=0}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(s!==0&&(this._speed=s),this._current=z(this._tx.pos.x,this._tx.pos.y),this._end=z(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const r=this._dir.scale(this._speed);this._motion.vel=z(r.x,r.y)}else this._motion.vel=z(0,0);this.isComplete()&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}stop(){this._motion.vel=z(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class Lh{constructor(e,s,r){this.id=Ut(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=e.get(et),this._motion=e.get(Bt),this._meetTx=s.get(et),this._meetMotion=s.get(Bt),this._current=new B(this._tx.pos.x,this._tx.pos.y),this._end=new B(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=r||0,r!==void 0&&(this._speedWasSpecified=!0)}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));s!==0&&!this._speedWasSpecified&&(this._speed=s),this._current=z(this._tx.pos.x,this._tx.pos.y),this._end=z(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const r=this._dir.scale(this._speed);this._motion.vel=z(r.x,r.y),this.isComplete()&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class Wd{constructor(e,s,r=1e3){var a;this.id=Ut(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=e.get(se),this._duration=r,this._entity=e,this._material=(a=e.scene)===null||a===void 0?void 0:a.engine.graphicsContext.createMaterial({name:"flash-material",color:s,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=r}update(e){var s;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=e,this._graphics&&((s=this._material)===null||s===void 0||s.update(r=>{r.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Rr{constructor(e){var s;if(this._distLookup=[],this.quality=4,e.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...e.controlPoints],this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(e){this._controlPoints=[...e],this._calculateLookup()}setControlPoint(e,s){this._controlPoints[e]=s,this._calculateLookup()}_calculateLookup(){let e=0;this._distLookup.length=0;let s=this.controlPoints[0];const r=this.controlPoints.length*this.quality;for(let a=0;a<r;a++){const l=a/(r-1),f=this.getPoint(l),g=s.distance(f);e+=g,this._distLookup.push(e),s=f}this._arcLength=e}_getTimeGivenDistance(e){const s=this._distLookup.length,r=this.arcLength;if(e>=0&&e<r){for(let a=0;a<s-1;a++)if(this._distLookup[a]<=e&&e<this._distLookup[a+1])return qi(this._distLookup[a],this._distLookup[a+1],a/(s-1),(a+1)/(s-1),e)}return e/r}getPoint(e){const s=[...this.controlPoints];for(let r=1;r<s.length;r++)for(let a=0;a<s.length-r;a++)s[a]=Ir(s[a],s[a+1],e);return s[0]}getTangent(e){const s=e*e,r=this.controlPoints[0],a=this.controlPoints[1],l=this.controlPoints[2],f=this.controlPoints[3];return r.scale(-3*s+6*e-3).add(a.scale(9*s-12*e+3).add(l.scale(-9*s+6*e).add(f.scale(3*s)))).normalize()}getUniformTangent(e){const s=e*this.arcLength,r=this._getTimeGivenDistance(s);return this.getTangent(r)}getNormal(e){return this.getTangent(e).normal()}getUniformNormal(e){return this.getUniformTangent(e).normal()}getUniformPoint(e){const s=e*this.arcLength,r=this._getTimeGivenDistance(s);return this.getPoint(r)}clone(){return new Rr({controlPoints:[...this.controlPoints],quality:this.quality})}}class Nd{constructor(e,s){var r;if(this.id=Ut(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(et),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new Rr({controlPoints:[z(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(r=s.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=e;const s=j(qi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class Gd{constructor(e,s){var r;if(this.id=Ut(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(et),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new Rr({controlPoints:[z(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(r=s.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=e;const s=j(qi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class Dr{constructor(e){this._entity=e,this._queue=new _d(e)}getQueue(){return this._queue}update(e){this._queue.update(e)}clearActions(){this._queue.clearActions()}runAction(e){return e.reset(),this._queue.add(e),this}curveBy(e){return this._queue.add(new Gd(this._entity,e)),this}curveTo(e){return this._queue.add(new Nd(this._entity,e)),this}easeTo(...e){var s,r;let a=0,l=0,f=0,g=Vt.Linear;return e[0]instanceof B?(a=e[0].x,l=e[0].y,f=e[1],g=(s=e[2])!==null&&s!==void 0?s:g):(a=e[0],l=e[1],f=e[2],g=(r=e[3])!==null&&r!==void 0?r:g),this._queue.add(new kd(this._entity,a,l,f,g)),this}easeBy(...e){var s,r;let a=0,l=0,f=0,g=Vt.Linear;return e[0]instanceof B?(a=e[0].x,l=e[0].y,f=e[1],g=(s=e[2])!==null&&s!==void 0?s:g):(a=e[0],l=e[1],f=e[2],g=(r=e[3])!==null&&r!==void 0?r:g),this._queue.add(new Ld(this._entity,a,l,f,g)),this}moveTo(e,s,r){let a=0,l=0,f=0;return e instanceof B?(a=e.x,l=e.y,f=+(s??0),this._queue.add(new Bh(this._entity,a,l,f))):typeof e=="number"&&typeof s=="number"&&typeof r=="number"?(a=e,l=s,f=r,this._queue.add(new Bh(this._entity,a,l,f))):yd(e)&&this._queue.add(new Ad(this._entity,e)),this}moveBy(e,s,r){let a=0,l=0,f=0;return e instanceof B&&typeof s=="number"?(a=e.x,l=e.y,f=s,this._queue.add(new Mh(this._entity,a,l,f))):typeof e=="number"&&typeof s=="number"&&typeof r=="number"?(a=e,l=s,f=r,this._queue.add(new Mh(this._entity,a,l,f))):xd(e)&&this._queue.add(new bd(this._entity,e)),this}rotateTo(e,s,r){return typeof e=="number"&&typeof s=="number"?this._queue.add(new Sd(this._entity,e,s,r)):typeof e=="object"&&this._queue.add(new Cd(this._entity,e)),this}rotateBy(e,s,r){return typeof e=="object"?this._queue.add(new Pd(this._entity,e)):this._queue.add(new Td(this._entity,e,s,r)),this}scaleTo(e,s,r,a){let l=1,f=1,g=0,m=0;return Ed(e)?(this._queue.add(new Id(this._entity,e)),this):(e instanceof B&&s instanceof B&&(l=e.x,f=e.y,g=s.x,m=s.y),typeof e=="number"&&typeof s=="number"&&(l=e,f=s,g=r,m=a),this._queue.add(new Rd(this._entity,l,f,g,m)),this)}scaleBy(e,s,r){if(Dd(e))return this._queue.add(new Fd(this._entity,e)),this;let a=1,l=1;return e instanceof B&&(a=e.x,l=e.y,r=s),typeof e=="number"&&typeof s=="number"&&(a=e,l=s),this._queue.add(new Md(this._entity,a,l,r)),this}blink(e,s,r=1){return this._queue.add(new Ud(this._entity,e,s,r)),this}fade(e,s){return this._queue.add(new zd(this._entity,e,s)),this}flash(e,s=1e3){return this._queue.add(new Wd(this._entity,e,s)),this}delay(e){return this._queue.add(new Hd(e)),this}die(){return this._queue.add(new Od(this._entity)),this}callMethod(e){return this._queue.add(new Bd(e)),this}repeat(e,s){return s?(this._queue.add(new gd(this._entity,e,s)),this):(this.repeatForever(e),this)}repeatForever(e){return this._queue.add(new pd(this._entity,e)),this}follow(e,s){return s===void 0?this._queue.add(new kh(this._entity,e)):this._queue.add(new kh(this._entity,e,s)),this}meet(e,s){return s===void 0?this._queue.add(new Lh(this._entity,e)):this._queue.add(new Lh(this._entity,e,s)),this}toPromise(){return new Promise(s=>{this._queue.add(new Bd(()=>{s()}))})}}class Vn extends Ai{constructor(){super(...arguments),this.dependencies=[et,Bt],this._ctx=null}onAdd(e){this._ctx=new Dr(e)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(e){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(e)}update(e){var s;return(s=this._ctx)===null||s===void 0?void 0:s.update(e)}clearActions(){var e;(e=this._ctx)===null||e===void 0||e.clearActions()}curveBy(e){return this._getCtx().curveBy.apply(this._ctx,[e])}curveTo(e){return this._getCtx().curveTo.apply(this._ctx,[e])}easeTo(...e){return this._getCtx().easeTo.apply(this._ctx,e)}easeBy(...e){return this._getCtx().easeBy.apply(this._ctx,e)}moveTo(e,s,r){return this._getCtx().moveTo.apply(this._ctx,[e,s,r])}moveBy(e,s,r){return this._getCtx().moveBy.apply(this._ctx,[e,s,r])}rotateTo(e,s,r){return this._getCtx().rotateTo.apply(this._ctx,[e,s,r])}rotateBy(e,s,r){return this._getCtx().rotateBy.apply(this._ctx,[e,s,r])}scaleTo(e,s,r,a){return this._getCtx().scaleTo.apply(this._ctx,[e,s,r,a])}scaleBy(e,s,r){return this._getCtx().scaleBy.apply(this._ctx,[e,s,r])}blink(e,s,r){return this._getCtx().blink(e,s,r)}fade(e,s){return this._getCtx().fade(e,s)}flash(e,s=1e3){return this._getCtx().flash(e,s)}delay(e){return this._getCtx().delay(e)}die(){return this._getCtx().die()}callMethod(e){return this._getCtx().callMethod(e)}repeat(e,s){return this._getCtx().repeat(e,s)}repeatForever(e){return this._getCtx().repeatForever(e)}follow(e,s){return this._getCtx().follow(e,s)}meet(e,s){return this._getCtx().meet(e,s)}toPromise(){return this._getCtx().toPromise()}}function Rp(u){return u instanceof Qe}const Dp={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class Qe extends He{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(e){this.body.oldPos.setTo(e.x,e.y)}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e.clone()}get oldVel(){return this.body.oldVel}set oldVel(e){this.body.oldVel.setTo(e.x,e.y)}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e.clone()}set oldAcc(e){this.body.oldAcc.setTo(e.x,e.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(e){this.transform.rotation=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}get scale(){return this.get(et).scale}set scale(e){this.get(et).scale=e}get anchor(){return this._anchor}set anchor(e){this._anchor=Pi(e,s=>this._handleAnchorChange(s)),this._handleAnchorChange(e)}_handleAnchorChange(e){this.graphics&&(this.graphics.anchor=e)}get offset(){return this._offset}set offset(e){this._offset=Pi(e,s=>this._handleOffsetChange(s)),this._handleOffsetChange(e)}_handleOffsetChange(e){this.graphics&&(this.graphics.offset=e)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(e){e&&(e&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!e&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=e)}get color(){return this.graphics.color}set color(e){this.graphics.color=e}constructor(e){super(),this.events=new I,this._anchor=Pi(B.Half,Et=>this._handleAnchorChange(Et)),this._offset=Pi(B.Zero,Et=>this._handleOffsetChange(Et)),this.logger=at.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=Et=>{this._dragging&&(this.pos=Et.worldPos)},this._pointerDragLeaveHandler=Et=>{this._dragging&&(this.pos=Et.worldPos)};const{name:s,x:r,y:a,pos:l,coordPlane:f,scale:g,width:m,height:w,radius:y,collider:A,vel:E,acc:D,rotation:L,angularVelocity:O,z:q,color:H,visible:N,opacity:J,anchor:Y,offset:$,collisionType:ot,collisionGroup:Z,silenceWarnings:_t}={...e};this.name=s??this.name,this.anchor=Y??Qe.defaults.anchor.clone(),this.offset=$??B.Zero,this.transform=new et,this.addComponent(this.transform),this.pos=l??z(r??0,a??0),this.rotation=L??0,this.scale=g??z(1,1),this.z=q??0,this.transform.coordPlane=f??Re.World,this._silenceWarnings=_t??!1,this.pointer=new zs,this.addComponent(this.pointer),this.graphics=new se({anchor:this.anchor,offset:this.offset,opacity:J}),this.addComponent(this.graphics),this.motion=new Bt,this.addComponent(this.motion),this.vel=E??B.Zero,this.acc=D??B.Zero,this.angularVelocity=O??0,this.actions=new Vn,this.addComponent(this.actions),this.body=new St,this.addComponent(this.body),this.body.collisionType=ot??ut.Passive,Z&&(this.body.group=Z),H&&(this.color=H),A?(this.collider=new ge(A),this.addComponent(this.collider)):y?(this.collider=new ge(We.Circle(y)),this.addComponent(this.collider),H&&this.graphics.add(new zo({color:H,radius:y}))):m>0&&w>0?(this.collider=new ge(We.Box(m,w,this.anchor)),this.addComponent(this.collider),H&&m&&w&&this.graphics.add(new Er({color:H,width:m,height:w}))):(this.collider=new ge,this.addComponent(this.collider)),this.graphics.isVisible=N??!0}clone(){const e=new Qe({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});e.clearComponents(),e.processComponentRemoval(),e.addComponent(e.transform=this.transform.clone(),!0),e.addComponent(e.pointer=this.pointer.clone(),!0),e.addComponent(e.graphics=this.graphics.clone(),!0),e.addComponent(e.motion=this.motion.clone(),!0),e.addComponent(e.actions=this.actions.clone(),!0),e.addComponent(e.body=this.body.clone(),!0),e.addComponent(e.collider=this.collider.clone(),!0);const s=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],r=this.getComponents();for(const a of r)s.includes(a)||e.addComponent(a.clone(),!0);return e}onInitialize(e){}_initialize(e){super._initialize(e);for(const s of this.children)s._initialize(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_prekill(e){this.events.emit("prekill",new Za(this)),this.onPreKill(e)}onPreKill(e){}_postkill(e){this.events.emit("postkill",new Qa(this)),this.onPostKill(e)}onPostKill(e){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new Eo(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(et).z}set z(e){this.get(et).z=e}get center(){const e=this.getGlobalPos();return new B(e.x+this.width/2-this.anchor.x*this.width,e.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new B(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(et).globalRotation}get globalRotation(){return this.get(et).globalRotation}getGlobalPos(){return this.get(et).globalPos}get globalPos(){return this.get(et).globalPos}getGlobalScale(){return this.get(et).globalScale}get globalScale(){return this.get(et).globalScale}get globalZ(){return this.get(et).globalZ}contains(e,s,r=!1){const a=z(e,s),l=this.get(ge);l.update();const f=l.get();if(!f)return!1;const g=f.contains(a);return r?g||this.children.some(m=>m.contains(e,s,!0)):g}within(e,s){const r=this.get(ge),a=e.get(ge),l=r.get(),f=a.get();return l&&f?l.getClosestLineBetween(f).getLength()<=s:!1}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s),this._postupdate(e,s),this._remove(e)}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreCollisionResolve(e,s,r,a){}onPostCollisionResolve(e,s,r,a){}onCollisionStart(e,s,r,a){}onCollisionEnd(e,s,r,a){}_preupdate(e,s){this.events.emit("preupdate",new ks(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new Ls(e,s,this)),this.onPostUpdate(e,s)}}Qe.defaults={anchor:B.Half};function Vd(u){return u instanceof Uh}class Uh extends Qe{constructor(e){var s,r;super({...e}),this.get(et).coordPlane=Re.Screen,this.anchor=(s=e?.anchor)!==null&&s!==void 0?s:z(0,0),this.body.collisionType=(r=e?.collisionType)!==null&&r!==void 0?r:ut.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!e?.collider&&e?.width>0&&e?.height>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(e){this._engine=e,super._initialize(e)}contains(e,s,r=!0){if(r)return super.contains(e,s);const a=this._engine.worldToScreenCoordinates(new B(e,s));return super.contains(a.x,a.y)}}class un{get complete(){return this._complete}constructor(e){var s;this._logger=at.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const r=(s=e.action)!==null&&s!==void 0?s:e.fcn,a=e.interval,l=e.repeats,f=e.numberOfRepeats,g=e.randomRange,m=e.random;if(f&&f>=0&&(this.maxNumberOfRepeats=f,!l))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=un._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=a,g){if(g[0]>g[1])throw new Error("min value must be lower than max value for range");this.random=m??new F,this.randomRange=g,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=l||this.repeats,r&&this.on(r)}on(e){this._callbacks.push(e)}off(e){const s=this._callbacks.indexOf(e);this._callbacks.splice(s,1)}update(e){this._running&&(this._totalTimeAlive+=e,this._elapsedTime+=e,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(s=>{s.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(e,s){if(e&&e>=0&&(this._baseInterval=this.interval=e),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=s,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}un._MAX_ID=0;class Ho extends Ai{constructor(e){super(),this.parallaxFactor=z(1,1),this.parallaxFactor=e??this.parallaxFactor}}class Oo extends Ai{constructor(e,s=!0){super(),this.draw=e,this.useTransform=s}}function Xd(u){return u&&u._dispatchPointerEvents&&u._processPointerToObject}class Fp{get events(){return this.object.events}init(e,s,r){this.object=e,this.contains=s,this.active=r}}class zh{constructor(){this._proxyPool=new pr(()=>new Fp,e=>e,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(e,s,r){const a=this._proxyPool.rent(!1);a.init(e,s,r),this._proxies.push(a),this._objectToProxy.set(e,a)}_getProxy(e){const s=this._objectToProxy.get(e);if(s)return s;throw new Error("No PointerTargetProxy for object")}removeObject(e){const s=this._objectToProxy.get(e);if(s){const r=this._proxies.indexOf(s);r>-1&&this._proxies.splice(r,1),this._proxyPool.return(s)}}_objectCurrentlyUnderPointer(e,s){return!!(this._currentFrameObjectToPointers.has(e)&&this._currentFrameObjectToPointers.get(e).includes(s))}_objectWasUnderPointer(e,s){return!!(this._lastFrameObjectToPointers.has(e)&&this._lastFrameObjectToPointers.get(e).includes(s))}_entered(e,s){return this._objectCurrentlyUnderPointer(e,s)&&!this._lastFrameObjectToPointers.has(e)}_left(e,s){return!this._currentFrameObjectToPointers.has(e)&&this._objectWasUnderPointer(e,s)}addPointerToObject(e,s){const r=this._objectToProxy.get(e);r&&this._addPointerToProxy(r,s)}_addPointerToProxy(e,s){if(!this._currentFrameObjectToPointers.has(e)){this._currentFrameObjectToPointers.set(e,[s]);return}const r=this._currentFrameObjectToPointers.get(e);this._currentFrameObjectToPointers.set(e,r.concat(s))}dispatchEvents(e,s){const r=new Set(this._lastFrameObjectToPointers.keys()),a=new Set(this._currentFrameObjectToPointers.keys());let l,f,g;for(let m=0;m<s.length;m++){const w=s[m],y=this._getProxy(w);if(Xd(w)&&w._dispatchPointerEvents(e),r.has(y)||a.has(y)){g=this._processDownAndEmit(e,y),f=this._processUpAndEmit(e,y),l=this._processMoveAndEmit(e,y);const A=[...l.values(),...g.values(),...f.values()];this._processEnterLeaveAndEmit(e,y,A),this._processCancelAndEmit(e,y),this._processWheelAndEmit(e,y)}}}processPointerToObject(e,s){for(let r=0;r<s.length;r++){const a=s[r],l=this._getProxy(a);Xd(a)&&a._processPointerToObject(e);for(const[f,g]of e.currentFramePointerCoords.entries())l.contains(g)&&this._addPointerToProxy(l,f)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(e,s){const r=new Map;for(const a of e.currentFrameDown)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerdown",a),e.isDragStart(a.pointerId)&&s.events.emit("pointerdragstart",a)),r.set(a.pointerId,a);return r}_processUpAndEmit(e,s){const r=new Map;for(const a of e.currentFrameUp)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerup",a),e.isDragEnd(a.pointerId)&&s.events.emit("pointerdragend",a)),r.set(a.pointerId,a);return r}_processMoveAndEmit(e,s){const r=new Map;for(const a of e.currentFrameMove)a.active&&s.active()&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointermove",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragmove",a)),r.set(a.pointerId,a);return r}_processEnterLeaveAndEmit(e,s,r){for(const a of r){if(a.active&&s.active()&&this._entered(s,a.pointerId)){s.events.emit("pointerenter",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragenter",a);break}if(a.active&&s.active()&&(this._left(s,a.pointerId)||this._objectCurrentlyUnderPointer(s,a.pointerId)&&a.type==="up")){s.events.emit("pointerleave",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragleave",a);break}}}_processCancelAndEmit(e,s){for(const r of e.currentFrameCancel)r.active&&s.active()&&this._objectCurrentlyUnderPointer(s,r.pointerId)&&s.events.emit("pointercancel",r)}_processWheelAndEmit(e,s){for(const r of e.currentFrameWheel)r.active&&s.active()&&this._objectCurrentlyUnderPointer(s,0)&&s.events.emit("pointerwheel",r)}}const Mp={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class qd extends He{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let e=0;e<this.tiles.length;e++)this.tiles[e]&&this.tiles[e].flagDirty()}get x(){var e;return(e=this.transform.pos.x)!==null&&e!==void 0?e:0}set x(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.get(et).pos=z(e,this.y))}get y(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.pos.y)!==null&&s!==void 0?s:0}set y(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.transform.pos=z(this.x,e))}get z(){var e;return(e=this.transform.z)!==null&&e!==void 0?e:0}set z(e){this.transform&&(this.transform.z=e)}get rotation(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.rotation)!==null&&s!==void 0?s:0}set rotation(e){this.transform&&(this.transform.rotation=e)}get scale(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.scale)!==null&&s!==void 0?s:B.One}set scale(e){var s;!((s=this.transform)===null||s===void 0)&&s.scale&&(this.transform.scale=e)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get vel(){return this._motion.vel}set vel(e){this._motion.vel=e}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,r,a;super([],e.name),this.events=new I,this._token=0,this.logger=at.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(s=e.meshingLookBehind)!==null&&s!==void 0?s:this.meshingLookBehind,this.addComponent(new et),this.addComponent(new Bt),this.addComponent(new St({type:ut.Fixed})),this.addComponent(new se({onPostDraw:(f,g)=>this.draw(f,g)})),this.addComponent(new Oo((f,g)=>this.debug(f,g),!1)),this.addComponent(new ge),this.addComponent(new zs),this.pointer=this.get(zs),this._graphics=this.get(se),this.transform=this.get(et),this._motion=this.get(Bt),this.collider=this.get(ge),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(r=e.pos)!==null&&r!==void 0?r:B.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(a=e.renderFromTopOfGraphic)!==null&&a!==void 0?a:this.renderFromTopOfGraphic,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight,this.rows=e.rows,this.columns=e.columns,this._pointerEventDispatcher=new zh,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let l=[];for(let f=0;f<this.columns;f++){for(let g=0;g<this.rows;g++){const m=new Yd({x:f,y:g,map:this});m.map=this,this.tiles[f+g*this.columns]=m,this._pointerEventDispatcher.addObject(m,w=>m.bounds.contains(w.worldPos),()=>!0),l.push(m),this._rows[g]||(this._rows[g]=[]),this._rows[g].push(m)}this._cols[f]=l,l=[]}this._graphics.localBounds=new ht({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(e){super._initialize(e),this._engine=e}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:B.Zero;{const r=e.offset;return this._originalOffsets.set(e,r),r}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const e=[];this._composite=this.collider.useCompositeCollider([]);let s=null;const r=(l,f)=>l&&f?l.top===f.top&&l.bottom===f.bottom&&l.right===f.left:!1,a=(l,f,g=this.meshingLookBehind)=>{if(!l)return!1;for(let m=f.length-1;m>=0;m--){if(g--<0)return!1;const w=f[m];if(r(w,l))return f[m]=w.combine(l),!0}return!1};for(let l=0;l<this.columns;l++){for(let f=0;f<this.rows;f++){const g=this.tiles[l+f*this.columns];if(g.solid)if(g.getColliders().length>0){for(const m of g.getColliders()){const w=this._getOrSetColliderOriginalOffset(m);m.offset=z(g.x*this.tileWidth*this.scale.x,g.y*this.tileHeight*this.scale.y).add(w),m.owner=this,this._composite.addCollider(m)}s&&!a(s,e)&&e.push(s),s=null}else s?s=s.combine(g.defaultGeometry):s=g.defaultGeometry;else s&&!a(s,e)&&e.push(s),s=null}s&&!a(s,e)&&e.push(s),s=null}for(const l of e){const f=We.Box(l.width,l.height,B.Zero,z(l.left-this.pos.x,l.top-this.pos.y));f.owner=this,this._composite.addCollider(f)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(e){var s;return(s=this.tiles[e])!==null&&s!==void 0?s:null}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const{x:s,y:r}=this._getTileCoordinates(e),a=this.getTile(s,r);return s>=0&&r>=0&&s<this.columns&&r<this.rows&&a?a:null}_getTileCoordinates(e){e=this.transform.applyInverse(e);const s=Math.floor(e.x/this.tileWidth),r=Math.floor(e.y/this.tileHeight);return{x:s,y:r}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let e=this._engine.screen.getWorldBounds();const s=this.get(Ho);if(s&&this.isInitialized){let D=this.pos;const L=B.One.sub(s.parallaxFactor),O=this._engine.currentScene.camera.pos.scale(L);D=D.sub(O),e=e.translate(D)}const r=this.transform.coordPlane===Re.Screen?this._engine.screen.getScreenBounds():e,a=this._getTileCoordinates(r.topLeft),l=this._getTileCoordinates(r.topRight),f=this._getTileCoordinates(r.bottomRight),g=this._getTileCoordinates(r.bottomLeft),m=Math.min(j(a.x,0,this.columns-1),j(l.x,0,this.columns-1)),w=Math.min(j(a.y,0,this.rows-1),j(l.y,0,this.rows-1)),y=Math.max(j(f.x,0,this.columns-1),j(g.x,0,this.columns-1)),A=Math.max(j(f.y,0,this.rows-1),j(g.y,0,this.rows-1)),E=[];for(let D=m;D<=y;D++)for(let L=w;L<=A;L++)E.push(this.getTile(D,L));return E}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(e,s){this._initialize(e),this.onPreUpdate(e,s),this.emit("preupdate",new ks(e,s,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(e,s),this.emit("postupdate",new Ls(e,s,this))}draw(e,s){if(!this.isInitialized)return;this.emit("predraw",new On(e,s,this));let r,a,l;const f=this.getOnScreenTiles();for(let g=0;g<f.length;g++){const m=f[g],w=m.getGraphicsOffsets();for(r=m.getGraphics(),a=0,l=r.length;a<l;a++){const y=r[a],A=w[a];if(y){ja(y)&&y?.tick(s,this._token);const E=this.renderFromTopOfGraphic?0:y.height-this.tileHeight;y.draw(e,m.x*this.tileWidth+A.x,m.y*this.tileHeight-E+A.y)}}}this.emit("postdraw",new Wn(e,s,this))}debug(e,s){const{showAll:r,showGrid:a,gridColor:l,gridWidth:f,showSolidBounds:g,solidBoundsColor:m,showColliderGeometry:w}=s.tilemap,{geometryColor:y,geometryLineWidth:A,geometryPointSize:E}=s.collider,D=this.tileWidth*this.columns*this.scale.x,L=this.tileHeight*this.rows*this.scale.y,O=this.pos;if(a||r){for(let q=0;q<this.rows+1;q++){const H=z(0,q*this.tileHeight*this.scale.y);e.drawLine(O.add(H),O.add(z(D,H.y)),l,f)}for(let q=0;q<this.columns+1;q++){const H=z(q*this.tileWidth*this.scale.x,0);e.drawLine(O.add(H),O.add(z(H.x,L)),l,f)}}if(r||g||w){const q=this._composite.getColliders();e.save(),e.translate(this.pos.x,this.pos.y),e.scale(this.scale.x,this.scale.y);for(const H of q){const N=H.localBounds,J=H.worldPos.sub(this.pos);g&&e.drawRectangle(J,N.width,N.height,m)}if(e.restore(),w)for(const H of q)H.debug(e,y,{lineWidth:A,pointSize:E})}if(r||g){if(e.save(),e.z=999,g)for(let q=0;q<this.tiles.length;q++)this.tiles[q].bounds.draw(e);e.restore()}}}class Yd{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(e){var s;(s=this.map)===null||s===void 0||s.flagCollidersDirty(),this._solid=e}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(e,s){this._graphics.push(e),s?.offset?this._offsets.push(s.offset):this._offsets.push(B.Zero)}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&(this._graphics.splice(s,1),this._offsets.splice(s,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(e){var s,r;this._posDirty=!1,this.events=new I,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=e.x,this.y=e.y,this.map=e.map,this._width=e.map.tileWidth*this.map.scale.x,this._height=e.map.tileHeight*this.map.scale.y,this.solid=(s=e.solid)!==null&&s!==void 0?s:this.solid,this._graphics=(r=e.graphics)!==null&&r!==void 0?r:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const e=this.map.pos.add(z(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new ht(e.x,e.y,e.x+this.map.tileWidth,e.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(z(this.x*this._width,this.y*this._height)),this._bounds=new ht(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new B(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}class jd{constructor(e){this.camera=e}lockToActor(e){this.camera.addStrategy(new Zd(e))}lockToActorAxis(e,s){this.camera.addStrategy(new Qd(e,s))}elasticToActor(e,s,r){this.camera.addStrategy(new Jd(e,s,r))}radiusAroundActor(e,s){this.camera.addStrategy(new Kd(e,s))}limitCameraBounds(e){this.camera.addStrategy(new $d(e))}}var Wo;(function(u){u[u.X=0]="X",u[u.Y=1]="Y"})(Wo||(Wo={}));class Zd{constructor(e){this.target=e,this.action=(s,r,a,l)=>s.center}}class Qd{constructor(e,s){this.target=e,this.axis=s,this.action=(r,a,l,f)=>{const g=r.center,m=a.getFocus();return this.axis===Wo.X?new B(g.x,m.y):new B(m.x,g.y)}}}class Jd{constructor(e,s,r){this.target=e,this.cameraElasticity=s,this.cameraFriction=r,this.action=(a,l,f,g)=>{const m=a.center;let w=l.getFocus(),y=l.vel.clone();const A=m.sub(w).scale(this.cameraElasticity);y=y.add(A);const E=y.scale(-1).scale(this.cameraFriction);return y=y.add(E),w=w.add(y),w}}}class Kd{constructor(e,s){this.target=e,this.radius=s,this.action=(r,a,l,f)=>{const g=r.center,m=a.getFocus(),w=g.sub(m),y=w.magnitude;if(y>=this.radius){const A=y-this.radius;return m.add(w.normalize().scale(A))}return m}}}class $d{constructor(e){this.target=e,this.boundSizeChecked=!1,this.action=(s,r,a,l)=>{const f=r.getFocus();this.boundSizeChecked||((s.bottom-s.top<a.drawHeight||s.right-s.left<a.drawWidth)&&at.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let g=f.x,m=f.y;return f.x<s.left+a.halfDrawWidth?g=s.left+a.halfDrawWidth:f.x>s.right-a.halfDrawWidth&&(g=s.right-a.halfDrawWidth),f.y<s.top+a.halfDrawHeight?m=s.top+a.halfDrawHeight:f.y>s.bottom-a.halfDrawHeight&&(m=s.bottom-a.halfDrawHeight),z(g,m)}}}const Bp={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class tu{constructor(){this.events=new I,this.transform=ue.identity(),this.inverse=ue.identity(),this._cameraStrategies=[],this.strategy=new jd(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new Bs(B.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=B.Zero,this.acc=B.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Vt.EaseInOutCubic,this._easing=Vt.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=z(0,0)}get zoom(){return this._z}set zoom(e){this._z=e,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(e){this._angularVelocity=e}get pos(){return this._pos}set pos(e){this._posChanged=!0,this._pos=new Bs(e,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(e){!this._follow&&!this._cameraMoving&&(this.pos=z(e,this.pos.y))}get y(){return this.pos.y}set y(e){!this._follow&&!this._cameraMoving&&(this.pos=z(this.pos.x,e))}get dx(){return this.vel.x}set dx(e){this.vel=z(e,this.vel.y)}get dy(){return this.vel.y}set dy(e){this.vel=z(this.vel.x,e)}get ax(){return this.acc.x}set ax(e){this.acc=z(e,this.acc.y)}get ay(){return this.acc.y}set ay(e){this.acc=z(this.acc.x,e)}getFocus(){return this.pos}move(e,s,r=Vt.EaseInOutCubic){if(typeof r!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(e):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(e),this._lerpPromise=new Promise(a=>{this._lerpResolve=a}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=s,this._lerpEnd=e,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=r,this._lerpPromise)}shake(e,s,r){this._isShaking=!0,this._shakeMagnitudeX=e,this._shakeMagnitudeY=s,this._shakeDuration=r}zoomOverTime(e,s=0,r=Vt.EaseInOutCubic){if(this._zoomPromise=new Promise(a=>{this._zoomResolve=a}),s)this._isZooming=!0,this._zoomEasing=r,this._currentZoomTime=0,this._zoomDuration=s,this._zoomStart=this.zoom,this._zoomEnd=e;else return this._isZooming=!1,this.zoom=e,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new ht(0,0,0,0)}addStrategy(e){this._cameraStrategies.push(e)}removeStrategy(e){ls(e,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(e,s){this.events.emit("preupdate",new ks(e,s,this)),this.onPreUpdate(e,s)}onPreUpdate(e,s){}_postupdate(e,s){this.events.emit("postupdate",new Ls(e,s,this)),this.onPostUpdate(e,s)}onPostUpdate(e,s){}get isInitialized(){return this._isInitialized}_initialize(e){if(!this.isInitialized){this._engine=e,this._screen=e.screen;const s=this._screen.contentArea;let r=z(s.width/2,s.height/2);if(!this._engine.loadingComplete){const a=this._screen.peekResolution();a&&(r=z(a.width/2,a.height/2))}this._halfWidth=r.x,this._halfHeight=r.y,this._posChanged||(this.pos=r),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(e,e.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(e),this.events.emit("initialize",new Nn(e,this)),this._isInitialized=!0}}onInitialize(e){}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}runStrategies(e,s){for(const r of this._cameraStrategies)this.pos=r.action.call(r,r.target,this,e,s)}updateViewport(){this._viewport=new ht(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(e,s){if(this._initialize(e),this._preupdate(e,s),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(s/1e3)),this.zoom+=this.dz*s/1e3,this.vel=this.vel.add(this.acc.scale(s/1e3)),this.dz+=this.az*s/1e3,this.rotation+=this.angularVelocity*s/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const r=this._zoomEasing,a=r(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=a,this._currentZoomTime+=s}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const a=Vt.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=a,this._currentLerpTime+=s}else{this.pos=this._lerpEnd;const r=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(r)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=s,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(e,s),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(e,s),this._posChanged=!1}draw(e){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const s=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,r=this.pos.scale(s).add(this._oldPos.scale(1-s));r.clone(this.drawPos),this.updateTransform(r)}if(e.snapToPixel){const s=this.drawPos.clone(this._snapPos);s.x=~~(s.x+gt*V(s.x)),s.y=~~(s.y+gt*V(s.y)),s.clone(this.drawPos),this.updateTransform(s)}e.multiply(this.transform)}updateTransform(e){const s=this._screen.resolution.width/this.zoom,r=this._screen.resolution.height/this.zoom,a=z(-e.x+s/2+this._xShake,-e.y+r/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(s/2,r/2),this.transform.rotate(this.rotation),this.transform.translate(-s/2,-r/2),this.transform.translate(a.x,a.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const kp={ExitTrigger:"exit",EnterTrigger:"enter"};class eu extends Qe{constructor(e){var s,r,a,l;super({...e}),this.events=new I,this.filter=(s=e.filter)!==null&&s!==void 0?s:()=>!0,this.repeat=(r=e.repeat)!==null&&r!==void 0?r:-1,this.action=(a=e.action)!==null&&a!==void 0?a:()=>{},this.target=e.target,this.graphics.isVisible=(l=e.visible)!==null&&l!==void 0?l:!1,this.body.collisionType=ut.Passive,this.events.on("collisionstart",({other:f})=>{this._matchesTarget(f.owner)&&(this.events.emit("enter",new gh(this,f.owner)),this._dispatchAction(f.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:f})=>{this._matchesTarget(f.owner)&&this.events.emit("exit",new ph(this,f.owner))})}_matchesTarget(e){return this.filter(e)&&(this.target===void 0||this.target===e)}_dispatchAction(e){this.repeat!==0&&(this.action.call(this,e),this.repeat--)}}const Yi={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var ui;(function(u){u.Update="update",u.Draw="draw"})(ui||(ui={}));class mi{}mi.priority=Yi.Average;class iu{constructor(e){this._world=e,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>s=>{this.addEntity(s)},this._createChildRemovedHandler=()=>s=>{this.removeEntity(s,!1)},this._entitiesToRemove=[]}updateEntities(e,s){for(let r=0;r<this.entities.length;r++){const a=this.entities[r];a.update(e.engine,s),a.isActive||this.removeEntity(a)}}findEntitiesForRemoval(){for(let e=0;e<this.entities.length;e++){const s=this.entities[e];s.isActive||this.removeEntity(s)}}addEntity(e){if(e.isActive=!0,e.scene=this._world.scene,e&&!this._entityIndex[e.id]){this._entityIndex[e.id]=e,this.entities.push(e),this._world.queryManager.addEntity(e),e.children.forEach(a=>{a.scene=e.scene,this.addEntity(a)});const s=this._createChildAddedHandler();this._childAddedHandlerMap.set(e,s);const r=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(e,r),e.childrenAdded$.subscribe(s),e.childrenRemoved$.subscribe(r)}}removeEntity(e,s=!0){var r,a;let l=0;e instanceof He?l=e.id:l=e;const f=this._entityIndex[l];if(f&&f.isActive&&(f.isActive=!1),f&&s){this._entitiesToRemove.push(f);return}if(delete this._entityIndex[l],f){f.scene=null,ls(f,this.entities),this._world.queryManager.removeEntity(f),f.children.forEach(w=>{w.scene=null,this.removeEntity(w,s)});const g=this._childAddedHandlerMap.get(f);g&&f.childrenAdded$.unsubscribe(g);const m=this._childRemovedHandlerMap.get(f);m&&f.childrenRemoved$.unsubscribe(m),!((a=(r=this._world)===null||r===void 0?void 0:r.scene)===null||a===void 0)&&a.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let e=0;e<this._entitiesToRemove.length;e++){const s=this._entitiesToRemove[e];s.isActive||this.removeEntity(s,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let e=0;e<this.entities.length;e++)this.entities[e].processComponentRemoval()}getById(e){return this._entityIndex[e]}getByName(e){return this.entities.filter(s=>s.name===e)}clear(){for(let e=this.entities.length-1;e>=0;e--)this.removeEntity(this.entities[e])}}class Fr{constructor(e){if(this.requiredComponents=e,this.components=new Set,this.entities=[],this.entityAdded$=new Ye,this.entityRemoved$=new Ye,e.length===0)throw new Error("Cannot create query without components");for(const s of e)this.components.add(s);this.id=Fr.createId(e)}static createId(e){return e.slice().map(s=>s.name).sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAll(Array.from(this.components))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class Mr{constructor(e){if(this.requiredTags=e,this.tags=new Set,this.entities=[],this.entityAdded$=new Ye,this.entityRemoved$=new Ye,e.length===0)throw new Error("Cannot create tag query without tags");for(const s of e)this.tags.add(s);this.id=Mr.createId(e)}static createId(e){return e.slice().sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAllTags(Array.from(this.tags))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class su{constructor(e){this._world=e,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=s=>r=>{this.addComponent(s,r)},this._createRemoveComponentHandler=s=>r=>{this.removeComponent(s,r)},this._createAddTagHandler=s=>r=>{this.addTag(s,r)},this._createRemoveTagHandler=s=>r=>{this.removeTag(s,r)}}createQuery(e){const s=Fr.createId(e);if(this._queries.has(s))return this._queries.get(s);const r=new Fr(e);this._queries.set(r.id,r);for(const a of e){const l=this._componentToQueriesIndex.get(a);l?l.push(r):this._componentToQueriesIndex.set(a,[r])}for(const a of this._world.entities)this.addEntity(a);return r}createTagQuery(e){const s=Mr.createId(e);if(this._tagQueries.has(s))return this._tagQueries.get(s);const r=new Mr(e);this._tagQueries.set(r.id,r);for(const a of e){const l=this._tagToQueriesIndex.get(a);l?l.push(r):this._tagToQueriesIndex.set(a,[r])}for(const a of this._world.entities)this.addEntity(a);return r}addEntity(e){const s=this._addComponentHandlers.get(e),r=this._removeComponentHandlers.get(e),a=s??this._createAddComponentHandler(e),l=r??this._createRemoveComponentHandler(e);this._addComponentHandlers.set(e,a),this._removeComponentHandlers.set(e,l);const f=this._addTagHandlers.get(e),g=this._removeTagHandlers.get(e),m=f??this._createAddTagHandler(e),w=g??this._createRemoveTagHandler(e);this._addTagHandlers.set(e,m),this._removeTagHandlers.set(e,w);for(const y of this._queries.values())y.checkAndAdd(e);for(const y of this._tagQueries.values())y.checkAndAdd(e);e.componentAdded$.subscribe(a),e.componentRemoved$.subscribe(l),e.tagAdded$.subscribe(m),e.tagRemoved$.subscribe(w)}removeEntity(e){const s=this._addComponentHandlers.get(e),r=this._removeComponentHandlers.get(e);for(const f of this._queries.values())f.removeEntity(e);s&&e.componentAdded$.unsubscribe(s),r&&e.componentRemoved$.unsubscribe(r);const a=this._addTagHandlers.get(e),l=this._removeTagHandlers.get(e);for(const f of this._tagQueries.values())f.removeEntity(e);a&&e.tagAdded$.unsubscribe(a),l&&e.tagRemoved$.unsubscribe(l)}addComponent(e,s){var r;const a=(r=this._componentToQueriesIndex.get(s.constructor))!==null&&r!==void 0?r:[];for(const l of a)l.checkAndAdd(e)}removeComponent(e,s){var r;const a=(r=this._componentToQueriesIndex.get(s.constructor))!==null&&r!==void 0?r:[];for(const l of a)l.removeEntity(e)}addTag(e,s){var r;const a=(r=this._tagToQueriesIndex.get(s))!==null&&r!==void 0?r:[];for(const l of a)l.checkAndAdd(e)}removeTag(e,s){var r;const a=(r=this._tagToQueriesIndex.get(s))!==null&&r!==void 0?r:[];for(const l of a)l.removeEntity(e)}}function nu(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class ru{constructor(e){this._world=e,this.systems=[],this.initialized=!1}get(e){return this.systems.find(s=>s instanceof e)}addSystem(e){let s;e instanceof mi?s=e:s=new e(this._world),this.systems.push(s),this.systems.sort((r,a)=>r.constructor.priority-a.constructor.priority),this.initialized&&s.initialize&&s.initialize(this._world,this._world.scene)}removeSystem(e){ls(e,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const e of this.systems)e.initialize&&e.initialize(this._world,this._world.scene)}}updateSystems(e,s,r){const a=this.systems.filter(l=>l.systemType===e);for(const l of a)l.preupdate&&l.preupdate(s,r);for(const l of a)l.update(r);for(const l of a)l.postupdate&&l.postupdate(s,r)}clear(){for(let e=this.systems.length-1;e>=0;e--)this.removeSystem(this.systems[e])}}class ou{constructor(e){this.scene=e,this._logger=at.getInstance(),this.queryManager=new su(this),this.entityManager=new iu(this),this.systemManager=new ru(this)}query(e){return this.queryManager.createQuery(e)}queryTags(e){return this.queryManager.createTagQuery(e)}update(e,s){e===ui.Update&&this.entityManager.updateEntities(this.scene,s),this.systemManager.updateSystems(e,this.scene,s),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(e){if(e instanceof He){this.entityManager.addEntity(e);return}if(e instanceof mi||nu(e)){this.systemManager.addSystem(e);return}this._logger.warn(`Could not add entity/system ${e.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(e){return this.systemManager.get(e)}remove(e,s=!0){if(e instanceof He){this.entityManager.removeEntity(e,s);return}if(e instanceof mi){this.systemManager.removeSystem(e);return}this._logger.warn(`Could not remove entity/system ${e.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class No extends mi{constructor(e,s){super(),this.world=e,this.physics=s,this.systemType=ui.Update,this._physicsConfigDirty=!1,s.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([et,Bt])}update(e){let s,r;const a=this.query.entities,l=this.physics.config.substep;for(let f=0;f<a.length;f++){s=a[f].get(et),r=a[f].get(Bt);const g=a[f].get(St);if(this._physicsConfigDirty&&g&&g.updatePhysicsConfig(this.physics.config.bodies),g?.isSleeping)continue;const m=r.acc.clone();g?.collisionType===ut.Active&&g?.useGravity&&m.addEqual(this.physics.config.gravity),a[f].parent||this.captureOldTransformWithChildren(a[f]),je.integrate(s,r,m,e/l)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(e){var s;(s=e.get(St))===null||s===void 0||s.captureOldTransform();for(let r=0;r<e.children.length;r++)this.captureOldTransformWithChildren(e.children[r])}}No.priority=Yi.Higher;class Hh{constructor(e){this.config=e,this.directionMap=new Map,this.distanceMap=new Map}solve(e){this.preSolve(e),e=e.filter(r=>!r.isCanceled());let s;switch(this.config.contactSolveBias){case _s.HorizontalFirst:{s=Ih;break}case _s.VerticalFirst:{s=Eh;break}default:s=Rh}e.sort((r,a)=>{const l=this.directionMap.get(r.id),f=this.directionMap.get(a.id),g=this.distanceMap.get(r.id),m=this.distanceMap.get(a.id);return s[l]-s[f]||g-m});for(const r of e)this.solvePosition(r),this.solveVelocity(r);return this.postSolve(e),e}preSolve(e){for(let r=0;r<e.length;r++){const a=e[r];if(Math.abs(a.mtv.x)<1e-4&&Math.abs(a.mtv.y)<1e-4){a.cancel();continue}const l=It.fromDirection(a.mtv),f=a.mtv.negate(),g=Math.abs(a.info.separation);this.distanceMap.set(a.id,g),this.directionMap.set(a.id,l===It.Left||l===It.Right?"horizontal":"vertical"),a.colliderA.events.emit("precollision",new rn(a.colliderA,a.colliderB,l,f,a)),a.colliderB.events.emit("precollision",new rn(a.colliderB,a.colliderA,It.getOpposite(l),f.negate(),a))}}postSolve(e){var s,r;for(let a=0;a<e.length;a++){const l=e[a];if(l.isCanceled())continue;const f=l.colliderA,g=l.colliderB,m=(s=f.owner)===null||s===void 0?void 0:s.get(St),w=(r=g.owner)===null||r===void 0?void 0:r.get(St);if(m&&w&&(m.collisionType===ut.Passive||w.collisionType===ut.Passive))continue;const y=It.fromDirection(l.mtv),A=l.mtv.negate();l.colliderA.events.emit("postcollision",new on(l.colliderA,l.colliderB,y,A,l)),l.colliderB.events.emit("postcollision",new on(l.colliderB,l.colliderA,It.getOpposite(y),A.negate(),l))}}solvePosition(e){var s,r;if(!e.colliderA.bounds.overlaps(e.colliderB.bounds,1e-4)){e.cancel();return}if(Math.abs(e.mtv.x)<1e-4&&Math.abs(e.mtv.y)<1e-4){e.cancel();return}let l=e.mtv;const f=e.colliderA,g=e.colliderB,m=(s=f.owner)===null||s===void 0?void 0:s.get(St),w=(r=g.owner)===null||r===void 0?void 0:r.get(St);if(m&&w){if(m.collisionType===ut.Passive||w.collisionType===ut.Passive)return;m.collisionType===ut.Active&&w.collisionType===ut.Active&&(l=l.scale(.5)),m.collisionType===ut.Active&&(m.globalPos.x-=l.x,m.globalPos.y-=l.y,f.update(m.transform.get())),w.collisionType===ut.Active&&(w.globalPos.x+=l.x,w.globalPos.y+=l.y,g.update(w.transform.get()))}}solveVelocity(e){var s,r;if(e.isCanceled())return;const a=e.colliderA,l=e.colliderB,f=(s=a.owner)===null||s===void 0?void 0:s.get(St),g=(r=l.owner)===null||r===void 0?void 0:r.get(St);if(f&&g){if(f.collisionType===ut.Passive||g.collisionType===ut.Passive)return;const m=e.normal,w=m.negate();if(f.collisionType===ut.Active&&f.vel.normalize().dot(w)<0){const y=m.scale(m.dot(f.vel.negate()));f.vel=f.vel.add(y)}if(g.collisionType===ut.Active&&g.vel.normalize().dot(m)<0){const y=w.scale(w.dot(g.vel.negate()));g.vel=g.vel.add(y)}}}}class au{constructor(e,s,r){this.point=e,this.local=s,this.contact=r,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new B(0,0),this.bToContact=new B(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const e=this.contact.bodyA,s=this.contact.colliderA,r=this.contact.bodyB,a=this.contact.colliderB;if(e&&r){const l=this.contact.normal,f=this.contact.tangent;this.aToContact=this.point.sub(s.center),this.bToContact=this.point.sub(a.center);const g=this.aToContact.cross(l),m=this.bToContact.cross(l);this.normalMass=e.inverseMass+r.inverseMass+e.inverseInertia*g*g+r.inverseInertia*m*m;const w=this.aToContact.cross(f),y=this.bToContact.cross(f);this.tangentMass=e.inverseMass+r.inverseMass+e.inverseInertia*w*w+r.inverseInertia*y*y}return this}getRelativeVelocity(){const e=this.contact.bodyA,s=this.contact.bodyB;if(e&&s){const r=e.vel.add(B.cross(e.angularVelocity,this.aToContact));return s.vel.add(B.cross(s.angularVelocity,this.bToContact)).sub(r)}return B.Zero}}class Oh{constructor(e){this.config=e,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(e){var s;return(s=this.idToContactConstraint.get(e))!==null&&s!==void 0?s:[]}solve(e){this.preSolve(e),e=e.filter(r=>!r.isCanceled());let s;switch(this.config.contactSolveBias){case _s.HorizontalFirst:{s=Ih;break}case _s.VerticalFirst:{s=Eh;break}default:s=Rh}return e.sort((r,a)=>{const l=this.directionMap.get(r.id),f=this.directionMap.get(a.id),g=this.distanceMap.get(r.id),m=this.distanceMap.get(a.id);return s[l]-s[f]||g-m}),this.solveVelocity(e),this.solvePosition(e),this.postSolve(e),e}preSolve(e){var s,r,a,l;for(let m=0;m<e.length;m++){const w=e[m];if(Math.abs(w.mtv.x)<1e-4&&Math.abs(w.mtv.y)<1e-4){w.cancel();continue}const y=It.fromDirection(w.mtv),A=Math.abs(((s=w?.info)===null||s===void 0?void 0:s.separation)||0);this.distanceMap.set(w.id,A),this.directionMap.set(w.id,y===It.Left||y===It.Right?"horizontal":"vertical"),w.colliderA.events.emit("precollision",new rn(w.colliderA,w.colliderB,y,w.mtv,w)),w.colliderA.events.emit("beforecollisionresolve",new Do(w.colliderA,w.colliderB,y,w.mtv,w)),w.colliderB.events.emit("precollision",new rn(w.colliderB,w.colliderA,It.getOpposite(y),w.mtv.negate(),w)),w.colliderB.events.emit("beforecollisionresolve",new Do(w.colliderB,w.colliderA,It.getOpposite(y),w.mtv.negate(),w)),w.matchAwake()}const g=Array.from(this.idToContactConstraint.keys());for(let m=0;m<e.length;m++){const w=e[m],y=g.indexOf(w.id);y>-1&&g.splice(y,1);const A=(r=this.idToContactConstraint.get(w.id))!==null&&r!==void 0?r:[];let E=0;const D=w.bodyA,L=w.colliderA,O=w.bodyB,q=w.colliderB;if(D&&O)for(let H=0;H<w.points.length;H++){const N=w.points[H],J=w.normal,Y=w.tangent,$=N.sub(L.center),ot=N.sub(q.center),Z=$.cross(J),_t=ot.cross(J),Et=D.inverseMass+O.inverseMass+D.inverseInertia*Z*Z+O.inverseInertia*_t*_t,Yt=$.cross(Y),Qt=ot.cross(Y),Se=D.inverseMass+O.inverseMass+D.inverseInertia*Yt*Yt+O.inverseInertia*Qt*Qt;A[E]&&((l=(a=A[E])===null||a===void 0?void 0:a.point)===null||l===void 0?void 0:l.squareDistance(N))<4?(A[E].point=N,A[E].local=w.localPoints[E]):A[E]=new au(N,w.localPoints[E],w),A[E].aToContact=$,A[E].bToContact=ot,A[E].normalMass=1/Et,A[E].tangentMass=1/Se;const te=D.bounciness>O.bounciness?D.bounciness:O.bounciness,zt=w.normal.dot(A[E].getRelativeVelocity());A[E].originalVelocityAndRestitution=0,zt<-.1&&(A[E].originalVelocityAndRestitution=-te*zt),E++}this.idToContactConstraint.set(w.id,A)}for(const m of g)this.idToContactConstraint.delete(m);if(this.config.warmStart)this.warmStart(e);else for(let m=0;m<e.length;m++){const w=e[m],y=this.getContactConstraints(w.id);for(const A of y)A.normalImpulse=0,A.tangentImpulse=0}}postSolve(e){for(let s=0;s<e.length;s++){const r=e[s],a=r.bodyA,l=r.bodyB;if(a&&l){if(a.collisionType===ut.Passive||l.collisionType===ut.Passive)continue;a.updateMotion(),l.updateMotion()}const f=It.fromDirection(r.mtv);r.colliderA.events.emit("postcollision",new on(r.colliderA,r.colliderB,f,r.mtv,r)),r.colliderA.events.emit("aftercollisionresolve",new Fo(r.colliderA,r.colliderB,f,r.mtv,r)),r.colliderB.events.emit("postcollision",new on(r.colliderB,r.colliderA,It.getOpposite(f),r.mtv.negate(),r)),r.colliderB.events.emit("aftercollisionresolve",new Fo(r.colliderB,r.colliderA,It.getOpposite(f),r.mtv.negate(),r))}this.lastFrameContacts.clear();for(let s=0;s<e.length;s++){const r=e[s];this.lastFrameContacts.set(r.id,r)}}warmStart(e){var s;for(let r=0;r<e.length;r++){const a=e[r],l=a.bodyA,f=a.bodyB;if(l&&f){const g=(s=this.idToContactConstraint.get(a.id))!==null&&s!==void 0?s:[];for(const m of g)if(this.config.warmStart){const w=a.normal.scale(m.normalImpulse),y=a.tangent.scale(m.tangentImpulse),A=w.add(y);l.applyImpulse(m.point,A.negate()),f.applyImpulse(m.point,A)}else m.normalImpulse=0,m.tangentImpulse=0}}}solvePosition(e){var s;for(let r=0;r<this.config.positionIterations;r++)for(let a=0;a<e.length;a++){const l=e[a],f=l.bodyA,g=l.bodyB;if(f&&g){if(f.collisionType===ut.Passive||g.collisionType===ut.Passive)continue;const m=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const w of m){const y=l.normal,A=Fi.FindContactSeparation(l,w.local),E=this.config.steeringFactor,D=-5,L=this.config.slop,O=j(E*(A+L),D,0),q=y.scale(-O*w.normalMass);if(f.collisionType===ut.Active){const H=q.negate().scale(f.inverseMass);f.limitDegreeOfFreedom.includes(ii.X)&&(H.x=0),f.limitDegreeOfFreedom.includes(ii.Y)&&(H.y=0),f.globalPos=f.globalPos.add(H),f.limitDegreeOfFreedom.includes(ii.Rotation)||(f.rotation-=w.aToContact.cross(q)*f.inverseInertia)}if(g.collisionType===ut.Active){const H=q.scale(g.inverseMass);g.limitDegreeOfFreedom.includes(ii.X)&&(H.x=0),g.limitDegreeOfFreedom.includes(ii.Y)&&(H.y=0),g.globalPos=g.globalPos.add(H),g.limitDegreeOfFreedom.includes(ii.Rotation)||(g.rotation+=w.bToContact.cross(q)*g.inverseInertia)}}}}}solveVelocity(e){var s;for(let r=0;r<this.config.velocityIterations;r++)for(let a=0;a<e.length;a++){const l=e[a],f=l.bodyA,g=l.bodyB;if(f&&g){if(f.collisionType===ut.Passive||g.collisionType===ut.Passive)continue;const m=Math.min(f.friction,g.friction),w=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const y of w){let D=-y.getRelativeVelocity().dot(l.tangent)*y.tangentMass;const L=m*y.normalImpulse,O=j(y.tangentImpulse+D,-L,L);D=O-y.tangentImpulse,y.tangentImpulse=O;const q=l.tangent.scale(D);f.applyImpulse(y.point,q.negate()),g.applyImpulse(y.point,q)}for(const y of w){const E=y.getRelativeVelocity().dot(l.normal);let D=-y.normalMass*(E-y.originalVelocityAndRestitution);const L=Math.max(y.normalImpulse+D,0);D=L-y.normalImpulse,y.normalImpulse=L;const O=l.normal.scale(D);f.applyImpulse(y.point,O.negate()),g.applyImpulse(y.point,O)}}}}}class Go extends mi{get _processor(){return this._physics.collisionProcessor}constructor(e,s){super(),this._physics=s,this.systemType=ui.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new Hh(s.config.arcade),this._realisticSolver=new Oh(s.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=r=>this._processor.track(r),this._untrackCollider=r=>this._processor.untrack(r),this.query=e.query([et,Bt,ge]),this.query.entityAdded$.subscribe(r=>{const a=r.get(ge);a.$colliderAdded.subscribe(this._trackCollider),a.$colliderRemoved.subscribe(this._untrackCollider);const l=a.get();l&&this._processor.track(l)}),this.query.entityRemoved$.subscribe(r=>{const a=r.get(ge),l=a.get();a&&l&&this._processor.untrack(l)}),this._motionSystem=e.get(No)}initialize(e,s){this._engine=s.engine}update(e){var s,r,a,l;if(!this._physics.config.enabled)return;let f=[];for(let A=0;A<this.query.entities.length;A++){const D=this.query.entities[A].get(ge),L=D?.get();if(D&&(!((s=D.owner)===null||s===void 0)&&s.isActive)&&L)if(D.update(),L instanceof Ae){const O=L.getColliders();L.compositeStrategy||(L.compositeStrategy=this._physics.config.colliders.compositeStrategy),f=f.concat(O)}else f.push(L)}this._processor.update(f,e);let g=this._processor.broadphase(f,e);this._currentFrameContacts.clear();let m=[];const w=this.getSolver(),y=this._physics.config.substep;for(let A=0;A<y;A++)if(A>0&&this._motionSystem.update(e),m.length&&(g=m.map(E=>new Ze(E.colliderA,E.colliderB))),g.length){m=this._processor.narrowphase(g,(l=(a=(r=this._engine)===null||r===void 0?void 0:r.debug)===null||a===void 0?void 0:a.stats)===null||l===void 0?void 0:l.currFrame),m=w.solve(m);for(const E of m){if(E.isCanceled())continue;const D=E.id.indexOf("|");if(D>0){const L=E.id.substring(D+1);this._currentFrameContacts.set(L,E)}else this._currentFrameContacts.set(E.id,E)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const A of this.query.entities){const E=A.get(ge);E&&E.processColliderRemoval()}}postupdate(){_e.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new Hh(this._physics.config.arcade),this._realisticSolver=new Oh(this._physics.config.realistic)),this._physics.config.solver===Tr.Realistic?this._realisticSolver:this._arcadeSolver}debug(e){this._processor.debug(e,0)}runContactStartEnd(){for(const[e,s]of this._currentFrameContacts)if(!this._lastFrameContacts.has(e)){const r=s.colliderA,a=s.colliderB,l=It.fromDirection(s.mtv),f=It.getOpposite(l);r.events.emit("collisionstart",new yr(r,a,l,s)),r.events.emit("contactstart",new Io(r,a,l,s)),a.events.emit("collisionstart",new yr(a,r,f,s)),a.events.emit("contactstart",new Io(a,r,f,s))}for(const[e,s]of this._lastFrameContacts)if(!this._currentFrameContacts.has(e)){const r=s.colliderA,a=s.colliderB,l=It.fromDirection(s.mtv),f=It.getOpposite(l);r.events.emit("collisionend",new Ar(r,a,l,s)),r.events.emit("contactend",new Ro(r,a,l,s)),a.events.emit("collisionend",new Ar(a,r,f,s)),a.events.emit("contactend",new Ro(a,r,f,s))}}}Go.priority=Yi.Higher;function Lp(u,e,s,r){if(u.parent!==e.parent){const y=u.clone(),A=u.globalPos.clone(),E=u.globalScale.clone(),D=u.globalRotation;y.parent=e.parent,y.globalPos=A,y.globalScale=E,y.globalRotation=D,u=y}let a=e.pos,l=e.scale,f=e.rotation;a=e.pos.scale(s).add(u.pos.scale(1-s)),l=e.scale.scale(s).add(u.scale.scale(1-s));const g=(1-s)*Math.cos(u.rotation)+s*Math.cos(e.rotation),m=(1-s)*Math.sin(u.rotation)+s*Math.sin(e.rotation);f=Math.atan2(m,g);const w=r??new ds;return w.setTransform(a,f,l),w}class Wh extends mi{get sortedTransforms(){return this._sortedTransforms}constructor(e){super(),this.world=e,this.systemType=ui.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new ds,this.query=this.world.query([et,se]),this.query.entityAdded$.subscribe(s=>{const r=s.get(et);this._sortedTransforms.push(r),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{const r=s.get(et);r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const a=this._sortedTransforms.indexOf(r);a>-1&&this._sortedTransforms.splice(a,1)})}initialize(e,s){this._camera=s.camera,this._engine=s.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>e.globalZ-s.globalZ),this._zHasChanged=!1)}update(e){this._token++;let s;Lt.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let r=0;r<this._sortedTransforms.length;r++){const a=this._sortedTransforms[r],l=a.owner;if(l.hasTag("ex.offscreen")||(s=l.get(se),!s.isVisible))continue;s.onPreTransformDraw&&s.onPreTransformDraw(this._graphicsContext,e),l.events.emit("pretransformdraw",new $a(this._graphicsContext,e,l)),a.coordPlane===Re.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),a.coordPlane===Re.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),s.update(e,this._token);const f=l.get(Ho);if(f){const g=B.One.sub(f.parallaxFactor),m=this._camera.drawPos.scale(g);this._graphicsContext.translate(m.x,m.y)}this._applyTransform(l),s.material&&(this._graphicsContext.material=s.material),s.onPreDraw&&s.onPreDraw(this._graphicsContext,e),l.events.emit("predraw",new On(this._graphicsContext,e,l)),this._applyOpacity(l),this._drawGraphicsComponent(s,a),s.onPostDraw&&s.onPostDraw(this._graphicsContext,e),l.events.emit("postdraw",new Wn(this._graphicsContext,e,l)),this._graphicsContext.restore(),a.coordPlane===Re.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),s.onPostTransformDraw&&s.onPostTransformDraw(this._graphicsContext,e),l.events.emit("posttransformdraw",new th(this._graphicsContext,e,l))}this._graphicsContext.restore()}_drawGraphicsComponent(e,s){var r,a;if(e.isVisible){const l=e.flipHorizontal,f=e.flipVertical,g=e.current,m=(r=e.currentOptions)!==null&&r!==void 0?r:{};if(g){let w=e.anchor,y=e.offset,A=1,E=1;m?.anchor&&(w=m.anchor),m?.offset&&(y=m.offset);const D=s.globalScale;A*=g.scale.x*D.x,E*=g.scale.y*D.y;const L=-g.width*w.x+y.x*A,O=-g.height*w.y+y.y*E,q=g.flipHorizontal,H=g.flipVertical;if((l||f)&&(g.flipHorizontal=l?!q:q,g.flipVertical=f?!H:H),g?.draw(this._graphicsContext,L,O),(l||f)&&(g.flipHorizontal=q,g.flipVertical=H),!((a=this._engine)===null||a===void 0)&&a.isDebug&&this._engine.debug.graphics.showBounds){const N=z(L,O);if(g instanceof Un)for(const J of g.members){let Y,$=B.Zero;J instanceof ee?Y=J:(Y=J.graphic,$=J.offset),g.useAnchor?Y?.localBounds.translate(N.add($)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):Y?.localBounds.translate($).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else g?.localBounds.translate(N).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(e){const s=e.getAncestors();for(let r=0;r<s.length;r++){const a=s[r],l=a?.get(et),f=a?.get(St);if(l){let g=l.get();if(f&&this._engine.fixedUpdateTimestep&&f.__oldTransformCaptured&&f.enableFixedUpdateInterpolate){const m=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;g=Lp(f.oldTransform,l.get(),m,this._targetInterpolationTransform)}this._graphicsContext.z=l.globalZ,this._graphicsContext.translate(g.pos.x,g.pos.y),this._graphicsContext.scale(g.scale.x,g.scale.y),this._graphicsContext.rotate(g.rotation)}}}_applyOpacity(e){var s;const r=e.getAncestors();for(let a=0;a<r.length;a++){const l=r[a],f=l?.get(se);this._graphicsContext.opacity*=(s=f?.opacity)!==null&&s!==void 0?s:1}}}Wh.priority=Yi.Average;class Nh extends mi{constructor(e){super(),this.world=e,this.systemType=ui.Draw,this.query=this.world.query([et])}initialize(e,s){this._graphicsContext=s.engine.graphicsContext,this._camera=s.camera,this._engine=s.engine,this._collisionSystem=e.systemManager.get(Go)}update(){var e;if(!this._engine.isDebug)return;const s=this._engine.debug.filter;let r,a;const l=this._engine.debug.entity;let f;const g=this._engine.debug.transform;let m;const w=this._engine.debug.motion;let y;const A=this._engine.debug.collider,E=this._engine.debug.physics;let D;const L=this._engine.debug.graphics;let O,q;const H=this._engine.debug.body,N=this._engine.debug.camera;for(let J=0;J<this.query.entities.length;J++){const Y=this.query.entities[J];if(Y.hasTag("offscreen")||Y instanceof Mo||s.useFilter&&(!(s.ids.length===0||s.ids.includes(Y.id))||!(s.nameQuery===""||Y.name.includes(s.nameQuery))))continue;let $=B.Zero;const ot=z(0,16);if(r=Y.id,a=Y.name,f=Y.get(et),this._pushCameraTransform(f),this._graphicsContext.save(),f.coordPlane===Re.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=g.debugZIndex,this._applyTransform(Y),f&&((g.showAll||g.showPosition)&&this._graphicsContext.debug.drawPoint(B.Zero,{size:4,color:g.positionColor}),(g.showAll||g.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${f.pos.toString(2)}`,$),$=$.add(ot)),(g.showAll||g.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${f.z.toFixed(1)})`,$),$=$.add(ot)),(l.showAll||l.showId)&&(this._graphicsContext.debug.drawText(`id(${r}) ${Y.parent?"child of id("+((e=Y.parent)===null||e===void 0?void 0:e.id)+")":""}`,$),$=$.add(ot)),(l.showAll||l.showName)&&(this._graphicsContext.debug.drawText(`name(${a})`,$),$=$.add(ot)),(g.showAll||g.showRotation)&&(this._graphicsContext.drawLine(B.Zero,B.fromAngle(f.rotation).scale(50).add(B.Zero),g.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${lt(f.rotation).toFixed(2)})`,$),$=$.add(ot)),(g.showAll||g.showScale)&&this._graphicsContext.drawLine(B.Zero,f.scale.add(B.Zero),g.scaleColor,2)),D=Y.get(se),D&&(L.showAll||L.showBounds)&&D.localBounds.draw(this._graphicsContext,L.boundsColor),O=Y.get(Oo),O&&(O.useTransform||this._graphicsContext.restore(),O.draw(this._graphicsContext,this._engine.debug),O.useTransform||(this._graphicsContext.save(),this._applyTransform(Y))),q=Y.get(St),q&&((H.showAll||H.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${q.group.name})`,$),$=$.add(ot)),(H.showAll||H.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${q.collisionType})`,$),$=$.add(ot)),(H.showAll||H.showMass)&&(this._graphicsContext.debug.drawText(`mass(${q.mass})`,$),$=$.add(ot)),(H.showAll||H.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${q.sleepMotion})`,$),$=$.add(ot)),(H.showAll||H.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${q.canSleep?q.isSleeping:"cant sleep"})`,$),$=$.add(ot))),this._graphicsContext.restore(),this._graphicsContext.save(),f.coordPlane===Re.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=g.debugZIndex,m=Y.get(Bt),m&&((w.showAll||w.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${m.vel.toString(2)}`,$.add(f.globalPos)),this._graphicsContext.drawLine(f.globalPos,f.globalPos.add(m.vel),w.velocityColor,2),$=$.add(ot)),(w.showAll||w.showAcceleration)&&this._graphicsContext.drawLine(f.globalPos,f.globalPos.add(m.acc),w.accelerationColor,2)),y=Y.get(ge),y){const Z=y.get();if((A.showAll||A.showGeometry)&&Z&&Z.debug(this._graphicsContext,A.geometryColor,{lineWidth:A.geometryLineWidth,pointSize:A.geometryPointSize}),A.showAll||A.showBounds){if(Z instanceof Ae){const _t=Z.getColliders();for(const Et of _t){const Yt=Et.bounds,Qt=z(Yt.left,Yt.top);this._graphicsContext.debug.drawRect(Qt.x,Qt.y,Yt.width,Yt.height,{color:A.boundsColor}),(A.showAll||A.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${Et.owner.id})`,Qt)}y.bounds.draw(this._graphicsContext,A.boundsColor)}else if(Z){const _t=y.bounds,Et=z(_t.left,_t.top);this._graphicsContext.debug.drawRect(Et.x,Et.y,_t.width,_t.height,{color:A.boundsColor}),(A.showAll||A.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${y.owner.id})`,Et)}}}this._graphicsContext.restore(),this._popCameraTransform(f)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(E.showAll||E.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),E.showAll||E.showCollisionContacts||E.showCollisionNormals)for(const[J,Y]of this._engine.debug.stats.currFrame.physics.contacts){if(E.showAll||E.showCollisionContacts)for(const $ of Y.points)this._graphicsContext.debug.drawPoint($,{size:E.contactSize,color:E.collisionContactColor});if(E.showAll||E.showCollisionNormals)for(const $ of Y.points)this._graphicsContext.debug.drawLine($,Y.normal.scale(30).add($),{color:E.collisionNormalColor})}this._graphicsContext.restore(),N&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(N.showAll||N.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,N.focusColor),(N.showAll||N.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(e,s){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),Ce.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(e){const s=e.getAncestors();for(const r of s){const a=r?.get(et);a&&(this._graphicsContext.translate(a.pos.x,a.pos.y),this._graphicsContext.scale(a.scale.x,a.scale.y),this._graphicsContext.rotate(a.rotation))}}_pushCameraTransform(e){e.coordPlane===Re.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(e){e.coordPlane===Re.World&&this._graphicsContext.restore()}}Nh.priority=Yi.Lowest;class Gh{constructor(e,s){this.object=e,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=s,this.bounds=e.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const e=this.object.bounds,s=Math.floor(e.left/this.gridSize),r=Math.floor(e.right/this.gridSize),a=Math.floor(e.bottom/this.gridSize),l=Math.floor(e.top/this.gridSize);return this.leftX!==s||this.rightX!==r||this.bottomY!==a||this.topY!==l}clear(){for(const e of this.cells){const s=e.proxies.indexOf(this);s>-1&&e.proxies.splice(s,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class ji{constructor(){this.proxies=[]}configure(e,s){this.x=e,this.y=s,this.key=ji.calculateHashKey(e,s)}static calculateHashKey(e,s){return`${e}+${s}`}}class Vh{constructor(e){this.bounds=new ht,this._hashGridCellPool=new pr(()=>new ji,s=>(s.configure(0,0),s.proxies.length=0,s),1e3),this.gridSize=e.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,e.proxyFactory?this._buildProxy=s=>e.proxyFactory(s,this.gridSize):this._buildProxy=s=>new Gh(s,this.gridSize)}query(e){const s=new Set;if(e instanceof ht){const r=e,a=Math.floor(r.left/this.gridSize),l=Math.floor(r.right/this.gridSize),f=Math.floor(r.bottom/this.gridSize),g=Math.floor(r.top/this.gridSize);for(let m=a;m<=l;m++)for(let w=g;w<=f;w++){const y=ji.calculateHashKey(m,w),A=this.sparseHashGrid.get(y);if(A)for(let E=0;E<A.proxies.length;E++)A.proxies[E].updateBounds(),A.proxies[E].bounds.intersect(r)&&s.add(A.proxies[E].object)}}else{const r=e,a=ji.calculateHashKey(Math.floor(r.x/this.gridSize),Math.floor(r.y/this.gridSize)),l=this.sparseHashGrid.get(a);if(l)for(let f=0;f<l.proxies.length;f++)l.proxies[f].updateBounds(),l.proxies[f].bounds.contains(r)&&s.add(l.proxies[f].object)}return Array.from(s)}get(e,s){const r=ji.calculateHashKey(e,s);return this.sparseHashGrid.get(r)}_insert(e,s,r){const a=ji.calculateHashKey(e,s);let l=this.sparseHashGrid.get(a);l||(l=this._hashGridCellPool.rent(),l.configure(e,s),this.sparseHashGrid.set(l.key,l)),l.proxies.push(r),r.cells.push(l),this.bounds.combine(r.bounds,this.bounds)}_remove(e,s,r){const a=ji.calculateHashKey(e,s),l=this.sparseHashGrid.get(a);if(l){const f=l.proxies.indexOf(r);f>-1&&l.proxies.splice(f,1);const g=r.cells.indexOf(l);g>-1&&r.cells.splice(g,1),l.proxies.length===0&&(this._hashGridCellPool.return(l),this.sparseHashGrid.delete(a))}}track(e){const s=this._buildProxy(e);this.objectToProxy.set(e,s);for(let r=s.leftX;r<=s.rightX;r++)for(let a=s.topY;a<=s.bottomY;a++)this._insert(r,a,s)}untrack(e){const s=this.objectToProxy.get(e);s&&(s.clear(),this.objectToProxy.delete(e))}update(e){let s=0;for(const r of e){const a=this.objectToProxy.get(r);if(a&&a.hasChanged()){for(let l=a.leftX;l<=a.rightX;l++)for(let f=a.topY;f<=a.bottomY;f++)this._remove(l,f,a);a.update();for(let l=a.leftX;l<=a.rightX;l++)for(let f=a.topY;f<=a.bottomY;f++)this._insert(l,f,a);s++}}return s}debug(e,s){const r=Q.Transparent,a=Q.White;for(const l of this.sparseHashGrid.values())e.drawRectangle(z(l.x*this.gridSize,l.y*this.gridSize),this.gridSize,this.gridSize,r,a,2)}}class Vo extends mi{constructor(e){super(),this.world=e,this.systemType=ui.Update,this._graphicsHashGrid=new Vh({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new zh,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([et,zs]),this.query.entityAdded$.subscribe(s=>{const r=s.get(et),a=s.get(zs);this._pointerEventDispatcher.addObject(s,f=>a&&a.localBounds?a.localBounds.transform(r.get().matrix).contains(r.coordPlane===Re.World?f.worldPos:f.screenPos):!1,()=>s.isActive),this._entityToPointer.set(s,a);const l=s.get(se);l&&(this._graphics.push(l),this._graphicsHashGrid.track(l)),this._sortedTransforms.push(r),this._sortedEntities.push(r.owner),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{this._pointerEventDispatcher.removeObject(s);const r=s.get(et);this._entityToPointer.delete(s);const a=s.get(se);if(a){const f=this._graphics.indexOf(a);f>-1&&this._graphics.splice(f,1),this._graphicsHashGrid.untrack(a)}r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const l=this._sortedTransforms.indexOf(r);l>-1&&(this._sortedTransforms.splice(l,1),this._sortedEntities.splice(l,1))})}initialize(e,s){this._engine=s.engine,this._scene=s}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>s.z-e.z),this._sortedEntities=this._sortedTransforms.map(e=>e.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[e,s]of this._engineReceiver.currentFramePointerCoords.entries()){const r=this._scene.physics.query(s.worldPos);for(let l=0;l<r.length;l++){const f=r[l],g=this._entityToPointer.get(f.owner);g&&(g.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(f.owner,e)}const a=this._graphicsHashGrid.query(s.worldPos);for(let l=0;l<a.length;l++){const f=a[l],g=this._entityToPointer.get(f.owner);g&&(g.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(f.owner,e)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(e=>e.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(e=>e.clear())}}Vo.priority=Yi.Higher;class Xh extends mi{constructor(e){super(),this.world=e,this.systemType=ui.Update,this._actions=[],this.query=this.world.query([Vn]),this.query.entityAdded$.subscribe(s=>this._actions.push(s.get(Vn))),this.query.entityRemoved$.subscribe(s=>{const r=s.get(Vn),a=this._actions.indexOf(r);a>-1&&this._actions.splice(a,1)})}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}}Xh.priority=Yi.Higher;class Br extends Ai{constructor(e){super(),this.elevation=0,this.columns=e.columns,this.rows=e.rows,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight}}class qh extends mi{constructor(e){super(),this.world=e,this.systemType=ui.Update,this.query=this.world.query([et,Br])}update(){let e,s;for(let r=0;r<this.query.entities.length;r++){const a=this.query.entities[r];e=a.get(et),s=a.get(Br);const f=Math.max(s.columns*s.tileWidth,s.rows*s.tileHeight)*s.elevation+e.pos.y;e.z=f}}}qh.priority=Yi.Lower;class Yh extends mi{constructor(e){super(),this.world=e,this.systemType=ui.Draw,this.query=this.world.query([et,se])}initialize(e,s){this._camera=s.camera,this._screen=s.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let e,s,r;for(let a=0;a<this.query.entities.length;a++){const l=this.query.entities[a];s=l.get(se),e=l.get(et),r=l.get(Ho);let f;if(r){const m=B.One.sub(r.parallaxFactor);f=this._camera.pos.scale(m)}const g=this._isOffscreen(e,s,f);g&&!l.hasTag("ex.offscreen")&&(l.events.emit("exitviewport",new fh(l)),l.addTag("ex.offscreen")),!g&&l.hasTag("ex.offscreen")&&(l.events.emit("enterviewport",new _h(l)),l.removeTag("ex.offscreen"))}}_isOffscreen(e,s,r){if(s.forceOnScreen)return!1;if(e.coordPlane===Re.World){let a=s.localBounds;r&&(a=a.translate(r));const l=a.transform(e.get().matrix);return!this._worldBounds.overlaps(l)}else return!1}}Yh.priority=Yi.Higher;class hu extends Gh{constructor(e,s){var r,a;super(e,s),this.collider=e,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=s;const l=e.bounds;this.hasZeroBounds=l.hasZeroDimensions(),this.leftX=Math.floor(l.left/this.gridSize),this.rightX=Math.floor(l.right/this.gridSize),this.bottomY=Math.floor(l.bottom/this.gridSize),this.topY=Math.floor(l.top/this.gridSize),this.owner=e.owner,this.body=(r=this.owner)===null||r===void 0?void 0:r.get(St),this.collisionType=(a=this.body.collisionType)!==null&&a!==void 0?a:ut.PreventCollision}update(){var e,s;super.update(),this.body=(e=this.owner)===null||e===void 0?void 0:e.get(St),this.collisionType=(s=this.body.collisionType)!==null&&s!==void 0?s:ut.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class jh{constructor(e){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new bo(()=>new Ze({id:S("collider",0)},{id:S("collider",0)}),s=>(s.colliderA=null,s.colliderB=null,s),200),this.gridSize=e.size,this.hashGrid=new Vh({size:this.gridSize,proxyFactory:(s,r)=>new hu(s,r)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(e){return this.hashGrid.query(e)}rayCast(e,s){var r,a,l;const f=[],g=(r=s?.maxDistance)!==null&&r!==void 0?r:1/0,m=s?.collisionGroup,w=m?m.category:(a=s?.collisionMask)!==null&&a!==void 0?a:fs.All.category,y=(l=s?.searchAllColliders)!==null&&l!==void 0?l:!1,A=e.dir.normalize(),E=A.y/A.x,D=A.x/A.y,L=Math.sqrt(1+E*E)*this.gridSize,O=Math.sqrt(1+D*D)*this.gridSize,q=e.pos.x/this.gridSize,H=e.pos.y/this.gridSize,N=z(1,1);let J=~~q,Y=~~H,$=0,ot=0;A.x<0?(N.x=-1,$=(q-J)*L):(N.x=1,$=(J+1-q)*L),A.y<0?(N.y=-1,ot=(H-Y)*O):(N.y=1,ot=(Y+1-H)*O);const Z=new Set;let _t=!1,Et=9999;for(;!_t&&Et>0&&(Et--,!!this.hashGrid.bounds.contains(z(J*this.gridSize,Y*this.gridSize)));){const Yt=ji.calculateHashKey(J,Y),Qt=this.hashGrid.sparseHashGrid.get(Yt);if(Qt){const Se=[];for(let te=0;te<Qt.proxies.length;te++){const zt=Qt.proxies[te];if(!Z.has(zt.collider.id.value)){if(Z.add(zt.collider.id.value),s?.ignoreCollisionGroupAll&&zt.body.group===fs.All)continue;const Ne=(w&zt.body.group.category)!==0;if(zt.body.group&&!Ne)continue;const Fe=zt.collider.rayCast(e,g);Fe&&Se.push(Fe)}}Se.sort((te,zt)=>te.distance-zt.distance);for(let te=0;te<Se.length;te++){const zt=Se[te];if(s?.filter){if(s.filter(zt)&&(f.push(zt),!y)){_t=!0;break}}else if(f.push(zt),!y){_t=!0;break}}}$<ot?(J+=N.x,$+=L):(Y+=N.y,ot+=O)}return f.sort((Yt,Qt)=>Yt.distance-Qt.distance),!y&&f.length?[f[0]]:f}track(e){let s=[e];if(e instanceof Ae){const r=e.getColliders();for(const a of r)a.owner=e.owner;s=r}for(const r of s)this.hashGrid.track(r)}untrack(e){let s=[e];e instanceof Ae&&(s=e.getColliders());for(const r of s)this.hashGrid.untrack(r)}_canCollide(e,s){return!(e.collider.id===s.collider.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.hasZeroBounds||s.hasZeroBounds||!e.body.group.canCollide(s.body.group)||e.collisionType===ut.Fixed&&s.collisionType===ut.Fixed||e.collisionType===ut.PreventCollision||s.collisionType===ut.PreventCollision||!e.owner.isActive||!s.owner.isActive)}broadphase(e,s){const r=[];this._pairs.clear(),this._nonPairs.clear();let a=0;for(const l of this.hashGrid.objectToProxy.values())if(l.id=a++,!(!l.owner.isActive||l.collisionType===ut.PreventCollision))for(let f=0;f<l.cells.length;f++){const g=l.cells[f];for(let m=0;m<g.proxies.length;m++){const w=g.proxies[m];if(w.id===l.id)continue;const y=Ze.calculatePairHash(l.collider.id,w.collider.id);if(!this._nonPairs.has(y))if(!this._pairs.has(y)&&this._canCollide(l,w)&&l.object.bounds.overlaps(w.object.bounds)){const A=this._pairPool.get();A.colliderA=l.collider,A.colliderB=w.collider,A.id=y,this._pairs.add(y),r.push(A)}else this._nonPairs.add(y)}}return r}narrowphase(e,s){const r=[];for(let a=0;a<e.length;a++){const l=e[a].collide();for(let f=0;f<l.length;f++){const g=l[f];r.push(g),s&&s.physics.contacts.set(g.id,g)}}return this._pairPool.done(),s&&(s.physics.collisions+=r.length),r}update(e,s){return this.hashGrid.update(e)}debug(e,s){this.hashGrid.debug(e,s)}}class lu{get config(){return Rg(this._config,e=>{this.$configUpdate.notifyAll(e)})}set config(e){this._config=e,this.$configUpdate.notifyAll(e)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const e=this._collisionProcessor.getColliders();this._config.spatialPartition===Gn.SparseHashGrid?this._collisionProcessor=new jh(this._config.sparseHashGrid):this._collisionProcessor=new Uo(this._config);for(const s of e)this._collisionProcessor.track(s)}return this._collisionProcessor}constructor(e){this.$configUpdate=new Ye,this._configDirty=!1,this.config=e,this.$configUpdate.subscribe(s=>{this._configDirty=!0,St.updateDefaultPhysicsConfig(s.bodies)}),this._config.spatialPartition===Gn.SparseHashGrid?this._collisionProcessor=new jh(this._config.sparseHashGrid):this._collisionProcessor=new Uo(this._config)}rayCast(e,s){return this.collisionProcessor.rayCast(e,s)}query(e){return this._collisionProcessor.query(e)}}class Xo{constructor(){this.events=new I,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(e){this._enabled=e}setMinimumGamepadConfiguration(e){this._enableAndUpdate(),this._minimumConfiguration=e}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(e){if(!this._minimumConfiguration)return!0;if(!e)return!1;const s=e.axes.filter(a=>typeof a!==void 0).length,r=e.buttons.filter(a=>typeof a!==void 0).length;return s>=this._minimumConfiguration.axis&&r>=this._minimumConfiguration.buttons&&e.connected}emit(e,s){this.events.emit(e,s)}on(e,s){return this._enableAndUpdate(),this.events.on(e,s)}once(e,s){return this._enableAndUpdate(),this.events.once(e,s)}off(e,s){this._enableAndUpdate(),this.events.off(e,s)}update(){var e,s;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const r=this._navigator.getGamepads();for(let a=0;a<r.length;a++){if(r[a]){const f=this.at(a);!this.at(a).connected&&this._isGamepadValid(r[a])&&(f.events.pipe(this.events),this.events.emit("connect",new rh(a,this.at(a)))),this.at(a).connected=!0}else{const f=this.at(a);f.connected&&(this.events.emit("disconnect",new oh(a,f)),f.events.unpipe(this.events)),f.connected=!1;continue}if(this.at(a).update(),r[a].timestamp&&r[a].timestamp===this._gamePadTimeStamps[a])continue;this._gamePadTimeStamps[a]=r[a].timestamp,this.at(a).navigatorGamepad=r[a];const l=r[a];if(l){for(let f=0;f<l.buttons.length;f++){const g=l.buttons[f],m=g?.value;m!==((e=this._oldPads[a])===null||e===void 0?void 0:e.getButton(f))&&(g?.pressed?(this.at(a).updateButton(f,m),this.at(a).events.emit("button",new ah(f in kr?f:kr.Unknown,f,m,this.at(a)))):this.at(a).updateButton(f,0))}for(let f=0;f<l.axes.length;f++){const g=l.axes[f];g!==((s=this._oldPads[a])===null||s===void 0?void 0:s.getAxes(f))&&(this.at(a).updateAxes(f,g),this.at(a).events.emit("axis",new hh(f,g,this.at(a))))}}this._oldPads[a]=this._clonePad(r[a])}}at(e){if(this._enableAndUpdate(),e>=this._pads.length)for(let s=this._pads.length-1,r=e;s<r;s++)this._pads.push(new qo),this._oldPads.push(new qo);return this._pads[e]}getValidGamepads(){this._enableAndUpdate();const e=[];for(let s=0;s<this._pads.length;s++)this._isGamepadValid(this.at(s).navigatorGamepad)&&this.at(s).connected&&e.push(this.at(s));return e}count(){return this._pads.filter(e=>e.connected).length}_clonePads(e){const s=[];for(let r=0,a=e.length;r<a;r++)s.push(this._clonePad(e[r]));return s}_clonePad(e){let s,r;const a=new qo;if(!e)return a;for(s=0,r=e.buttons.length;s<r;s++)e.buttons[s]&&a.updateButton(s,e.buttons[s].value);for(s=0,r=e.axes.length;s<r;s++)a.updateAxes(s,e.axes[s]);return a}}Xo.MinAxisMoveThreshold=.05;class qo{constructor(){this.events=new I,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let e=0;e<this._buttons.length;e++)this._buttons[e]=0;for(let e=0;e<this._axes.length;e++)this._axes[e]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(e,s=1){return this._buttons[e]>=s}isButtonHeld(e,s=1){return this._buttons[e]>=s}wasButtonPressed(e,s=1){return this._buttonsDown[e]>=s}wasButtonReleased(e){return!!this._buttonsUp[e]}getButton(e){return this._buttons[e]}getAxes(e){const s=this._axes[e];return Math.abs(s)<Xo.MinAxisMoveThreshold?0:s}updateButton(e,s){s===0&&this._buttons[e]?this._buttonsUp[e]=1:this._buttonsDown[e]=s,this._buttons[e]=s}updateAxes(e,s){this._axes[e]=s}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}var kr;(function(u){u[u.Unknown=-1]="Unknown",u[u.Face1=0]="Face1",u[u.Face2=1]="Face2",u[u.Face3=2]="Face3",u[u.Face4=3]="Face4",u[u.LeftBumper=4]="LeftBumper",u[u.RightBumper=5]="RightBumper",u[u.LeftTrigger=6]="LeftTrigger",u[u.RightTrigger=7]="RightTrigger",u[u.Select=8]="Select",u[u.Start=9]="Start",u[u.LeftStick=10]="LeftStick",u[u.RightStick=11]="RightStick",u[u.DpadUp=12]="DpadUp",u[u.DpadDown=13]="DpadDown",u[u.DpadLeft=14]="DpadLeft",u[u.DpadRight=15]="DpadRight",u[u.CenterButton=16]="CenterButton",u[u.MiscButton1=17]="MiscButton1"})(kr||(kr={}));var Zh;(function(u){u[u.LeftStickX=0]="LeftStickX",u[u.LeftStickY=1]="LeftStickY",u[u.RightStickX=2]="RightStickX",u[u.RightStickY=3]="RightStickY"})(Zh||(Zh={}));class cu{constructor(e){this.inputs=e,this._handlers=new Map}execute(){for(const[e,s]of this._handlers.entries()){const r=e(this.inputs);r&&s(r)}}on(e,s){this._handlers.set(e,s)}}function du(){try{const u=()=>{};window.top.addEventListener("blur",u),window.top.removeEventListener("blur",u)}catch{return!0}return!1}var Lr;(function(u){u.Backquote="Backquote",u.Backslash="Backslash",u.BracketLeft="BracketLeft",u.BracketRight="BracketRight",u.Comma="Comma",u.Key0="Digit0",u.Key1="Digit1",u.Key2="Digit2",u.Key3="Digit3",u.Key4="Digit4",u.Key5="Digit5",u.Key6="Digit6",u.Key7="Digit7",u.Key8="Digit8",u.Key9="Digit9",u.Digit0="Digit0",u.Digit1="Digit1",u.Digit2="Digit2",u.Digit3="Digit3",u.Digit4="Digit4",u.Digit5="Digit5",u.Digit6="Digit6",u.Digit7="Digit7",u.Digit8="Digit8",u.Digit9="Digit9",u.Equal="Equal",u.IntlBackslash="IntlBackslash",u.IntlRo="IntlRo",u.IntlYen="IntlYen",u.A="KeyA",u.B="KeyB",u.C="KeyC",u.D="KeyD",u.E="KeyE",u.F="KeyF",u.G="KeyG",u.H="KeyH",u.I="KeyI",u.J="KeyJ",u.K="KeyK",u.L="KeyL",u.M="KeyM",u.N="KeyN",u.O="KeyO",u.P="KeyP",u.Q="KeyQ",u.R="KeyR",u.S="KeyS",u.T="KeyT",u.U="KeyU",u.V="KeyV",u.W="KeyW",u.X="KeyX",u.Y="KeyY",u.Z="KeyZ",u.KeyA="KeyA",u.KeyB="KeyB",u.KeyC="KeyC",u.KeyD="KeyD",u.KeyE="KeyE",u.KeyF="KeyF",u.KeyG="KeyG",u.KeyH="KeyH",u.KeyI="KeyI",u.KeyJ="KeyJ",u.KeyK="KeyK",u.KeyL="KeyL",u.KeyM="KeyM",u.KeyN="KeyN",u.KeyO="KeyO",u.KeyP="KeyP",u.KeyQ="KeyQ",u.KeyR="KeyR",u.KeyS="KeyS",u.KeyT="KeyT",u.KeyU="KeyU",u.KeyV="KeyV",u.KeyW="KeyW",u.KeyX="KeyX",u.KeyY="KeyY",u.KeyZ="KeyZ",u.Minus="Minus",u.Period="Period",u.Quote="Quote",u.Semicolon="Semicolon",u.Slash="Slash",u.AltLeft="AltLeft",u.AltRight="AltRight",u.Alt="Alt",u.AltGraph="AltGraph",u.Backspace="Backspace",u.CapsLock="CapsLock",u.ContextMenu="ContextMenu",u.ControlLeft="ControlLeft",u.ControlRight="ControlRight",u.Enter="Enter",u.MetaLeft="MetaLeft",u.MetaRight="MetaRight",u.ShiftLeft="ShiftLeft",u.ShiftRight="ShiftRight",u.Space="Space",u.Tab="Tab",u.Convert="Convert",u.KanaMode="KanaMode",u.NonConvert="NonConvert",u.Delete="Delete",u.End="End",u.Help="Help",u.Home="Home",u.Insert="Insert",u.PageDown="PageDown",u.PageUp="PageUp",u.Up="ArrowUp",u.Down="ArrowDown",u.Left="ArrowLeft",u.Right="ArrowRight",u.ArrowUp="ArrowUp",u.ArrowDown="ArrowDown",u.ArrowLeft="ArrowLeft",u.ArrowRight="ArrowRight",u.NumLock="NumLock",u.Numpad0="Numpad0",u.Numpad1="Numpad1",u.Numpad2="Numpad2",u.Numpad3="Numpad3",u.Numpad4="Numpad4",u.Numpad5="Numpad5",u.Numpad6="Numpad6",u.Numpad7="Numpad7",u.Numpad8="Numpad8",u.Numpad9="Numpad9",u.Num0="Numpad0",u.Num1="Numpad1",u.Num2="Numpad2",u.Num3="Numpad3",u.Num4="Numpad4",u.Num5="Numpad5",u.Num6="Numpad6",u.Num7="Numpad7",u.Num8="Numpad8",u.Num9="Numpad9",u.NumAdd="NumpadAdd",u.NumpadAdd="NumpadAdd",u.NumDecimal="NumpadDecimal",u.NumpadDecimal="NumpadDecimal",u.NumDivide="NumpadDivide",u.NumpadDivide="NumpadDivide",u.NumEnter="NumpadEnter",u.NumpadEnter="NumpadEnter",u.NumMultiply="NumpadMultiply",u.NumpadMultiply="NumpadMultiply",u.NumSubtract="NumpadSubtract",u.NumpadSubtract="NumpadSubtract",u.Esc="Escape",u.Escape="Escape",u.F1="F1",u.F2="F2",u.F3="F3",u.F4="F4",u.F5="F5",u.F6="F6",u.F7="F7",u.F8="F8",u.F9="F9",u.F10="F10",u.F11="F11",u.F12="F12",u.F13="F13",u.F14="F14",u.F15="F15",u.F16="F16",u.F17="F17",u.F18="F18",u.F19="F19",u.F20="F20",u.PrintScreen="PrintScreen",u.ScrollLock="ScrollLock",u.Pause="Pause",u.Unidentified="Unidentified"})(Lr||(Lr={}));class Ur extends vt{constructor(e,s,r){super(),this.key=e,this.value=s,this.originalEvent=r}}class uu{constructor(){this.events=new I,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=e=>{for(const s of this._keys){const r=new Ur(s,e.key,e);this.events.emit("up",r),this.events.emit("release",r)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=e=>{if(!this._enabled)return;!e.metaKey&&(this._keys.includes(Lr.MetaLeft)||this._keys.includes(Lr.MetaRight))&&this._releaseAllKeys(e);const s=e.code;if(this._keys.indexOf(s)===-1){this._keys.push(s),this._keysDown.push(s);const r=new Ur(s,e.key,e);this.events.emit("down",r),this.events.emit("press",r)}},this._handleKeyUp=e=>{if(!this._enabled)return;const s=e.code,r=this._keys.indexOf(s);this._keys.splice(r,1),this._keysUp.push(s);const a=new Ur(s,e.key,e);this.events.emit("up",a),this.events.emit("release",a),e.key==="Meta"&&this._releaseAllKeys(e)}}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}init(e){let{global:s}=e;const{grabWindowFocus:r}=e;s||(du()?(s=window,r&&window.focus(),at.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):s=window.top),s.addEventListener("blur",()=>{this._keys.length=0}),s.addEventListener("keyup",this._handleKeyUp),s.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(e){this._enabled=e}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let e=0;e<this._keys.length;e++)this.events.emit("hold",new Ur(this._keys[e]))}getKeys(){return this._keys}wasPressed(e){return this._enabled?this._keysDown.indexOf(e)>-1:!1}isHeld(e){return this._enabled?this._keys.indexOf(e)>-1:!1}wasReleased(e){return this._enabled?this._keysUp.indexOf(e)>-1:!1}triggerEvent(e,s,r){e==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:s,key:r??null})),e==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:s,key:r??null}))}}class Xn{static fromPagePosition(e,s,r){let a,l,f,g;arguments.length===3?(a=e,l=s,f=new B(a,l),g=r):(f=e,a=f.x,l=f.y,g=s);const m=g.screen.pageToScreenCoordinates(f),w=g.screen.screenToWorldCoordinates(m);return new Xn(w,f,m)}constructor(e,s,r){this.worldPos=e,this.pagePos=s,this.screenPos=r}}class zr{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(e,s,r,a,l,f){this.type=e,this.pointerId=s,this.button=r,this.pointerType=a,this.coordinates=l,this.nativeEvent=f,this.active=!0}}class fu{cancel(){this.active=!1}constructor(e,s,r,a,l,f,g,m,w,y,A,E){this.x=e,this.y=s,this.pageX=r,this.pageY=a,this.screenX=l,this.screenY=f,this.index=g,this.deltaX=m,this.deltaY=w,this.deltaZ=y,this.deltaMode=A,this.ev=E,this.active=!0}}class Qh{constructor(){this.events=new I,this.lastPagePos=B.Zero,this.lastScreenPos=B.Zero,this.lastWorldPos=B.Zero,this._onPointerMove=e=>{this.lastPagePos=new B(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new B(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new B(e.worldPos.x,e.worldPos.y)},this._onPointerDown=e=>{this.lastPagePos=new B(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new B(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new B(e.worldPos.x,e.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_updateWorldPosition(e){const s=Xn.fromPagePosition(this.lastPagePos,e);this.lastScreenPos=s.screenPos,this.lastWorldPos=s.worldPos}}var qn;(function(u){u.Pixel="Pixel",u.Line="Line",u.Page="Page"})(qn||(qn={}));var Hs;(function(u){u[u.NoButton=-1]="NoButton",u[u.Left=0]="Left",u[u.Middle=1]="Middle",u[u.Right=2]="Right",u[u.Unknown=3]="Unknown"})(Hs||(Hs={}));var ps;(function(u){u.Left="Left",u.Middle="Middle",u.Right="Right",u.Unknown="Unknown",u.NoButton="NoButton"})(ps||(ps={}));var ms;(function(u){u.Touch="Touch",u.Mouse="Mouse",u.Pen="Pen",u.Unknown="Unknown"})(ms||(ms={}));function Up(u){return globalThis.TouchEvent&&u instanceof globalThis.TouchEvent}function zp(u){return globalThis.PointerEvent&&u instanceof globalThis.PointerEvent}class Yo{constructor(e,s){this.target=e,this.engine=s,this.events=new I,this.primary=new Qh,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(e){this._enabled=e}recreate(e,s){const r=new Yo(e,s);return r.primary=this.primary,r._pointers=this._pointers,r}at(e){if(e>=this._pointers.length)for(let s=this._pointers.length-1,r=e;s<r;s++)this._pointers.push(new Qh);return this._pointers[e]}count(){return this._pointers.length}isDown(e){var s;return this._enabled&&(s=this.currentFramePointerDown.get(e))!==null&&s!==void 0?s:!1}wasDown(e){var s;return this._enabled&&(s=this.lastFramePointerDown.get(e))!==null&&s!==void 0?s:!1}isDragging(e){return this._enabled?this.isDown(e):!1}isDragStart(e){return this._enabled?this.isDown(e)&&!this.wasDown(e):!1}isDragEnd(e){return this._enabled?!this.isDown(e)&&this.wasDown(e):!1}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const e of this.currentFrameDown){if(!e.active)continue;this.emit("down",e),this.at(e.pointerId).emit("down",e),this.primary.emit("pointerdown",e)}for(const e of this.currentFrameUp){if(!e.active)continue;this.emit("up",e),this.at(e.pointerId).emit("up",e)}for(const e of this.currentFrameMove){if(!e.active)continue;this.emit("move",e),this.at(e.pointerId).emit("move",e)}for(const e of this.currentFrameCancel){if(!e.active)continue;this.emit("cancel",e),this.at(e.pointerId).emit("cancel",e)}for(const e of this.currentFrameWheel)e.active&&(this.emit("pointerwheel",e),this.emit("wheel",e),this.primary.emit("pointerwheel",e),this.primary.emit("wheel",e));if(this.engine.currentScene.camera.hasChanged())for(const e of this._pointers)e._updateWorldPosition(this.engine)}clear(){for(const e of this.currentFrameUp){this.currentFramePointerCoords.delete(e.pointerId);const s=this._activeNativePointerIdsToNormalized.entries();for(const[r,a]of s)a===e.pointerId&&this._activeNativePointerIdsToNormalized.delete(r)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(e){var s;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const r={passive:!(this.engine.pageScrollPreventionMode===Os.All||this.engine.pageScrollPreventionMode===Os.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,r):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,r):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,r),((s=e?.grabWindowFocus)!==null&&s!==void 0?s:!0)&&du()){const l=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",l):(this.target.addEventListener("touchstart",l),this.target.addEventListener("mousedown",l))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(e){this._activeNativePointerIdsToNormalized.set(e,-1);const r=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((a,l)=>a-l).findIndex(a=>a===e);return this._activeNativePointerIdsToNormalized.set(e,r),r}_handle(e){if(!this._enabled)return;e.preventDefault();const s=new Map;let r,a;if(Up(e)){r=ps.Unknown,a=ms.Touch;for(let l=0;l<e.changedTouches.length;l++){const f=e.changedTouches[l],g=Xn.fromPagePosition(f.pageX,f.pageY,this.engine),m=l+1,w=this._normalizePointerId(m);this.currentFramePointerCoords.set(w,g),s.set(w,g)}}else{r=this._nativeButtonToPointerButton(e.button),a=ms.Mouse;const l=Xn.fromPagePosition(e.pageX,e.pageY,this.engine);let f=1;zp(e)&&(f=e.pointerId,a=this._stringToPointerType(e.pointerType));const g=this._normalizePointerId(f);this.currentFramePointerCoords.set(g,l),s.set(g,l)}for(const[l,f]of s.entries())switch(e.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new zr("down",l,r,a,f,e)),this.currentFramePointerDown.set(l,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new zr("up",l,r,a,f,e)),this.currentFramePointerDown.set(l,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new zr("move",l,r,a,f,e));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new zr("cancel",l,r,a,f,e));break}}_handleWheel(e){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Os.All||this.engine.pageScrollPreventionMode===Os.Canvas&&e.target===this.engine.canvas)&&e.preventDefault();const s=this.engine.screen.pageToScreenCoordinates(z(e.pageX,e.pageY)),r=this.engine.screen.screenToWorldCoordinates(s),a=-1/40,l=e.deltaX||e.wheelDeltaX*a||0,f=e.deltaY||e.wheelDeltaY*a||e.wheelDelta*a||e.detail||0,g=e.deltaZ||0;let m=qn.Pixel;e.deltaMode&&(e.deltaMode===1?m=qn.Line:e.deltaMode===2&&(m=qn.Page));const w=new fu(r.x,r.y,e.pageX,e.pageY,s.x,s.y,0,l,f,g,m,e);this.currentFrameWheel.push(w)}triggerEvent(e,s){const r=this.engine.screen.worldToPageCoordinates(s);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+e,{pointerId:0,clientX:r.x,clientY:r.y})):this._handle(new window.MouseEvent("mouse"+e,{clientX:r.x,clientY:r.y}));const a=this.engine.currentScene.world.get(Vo);a.preupdate(this.engine.currentScene,1),a.update(1)}_nativeButtonToPointerButton(e){switch(e){case Hs.NoButton:return ps.NoButton;case Hs.Left:return ps.Left;case Hs.Middle:return ps.Middle;case Hs.Right:return ps.Right;case Hs.Unknown:return ps.Unknown;default:return Qc(e)}}_stringToPointerType(e){switch(e){case"touch":return ms.Touch;case"mouse":return ms.Mouse;case"pen":return ms.Pen;default:return ms.Unknown}}}class Jh{constructor(e){this._enabled=!0;const{pointerTarget:s,grabWindowFocus:r,engine:a}=e;this.keyboard=new uu,this.pointers=new Yo(s,a),this.gamepads=new Xo,this.keyboard.init({grabWindowFocus:r}),this.pointers.init({grabWindowFocus:r}),this.gamepads.init(),this.inputMapper=new cu({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(e){this._enabled=e,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class Hp{}const Op={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function Zi(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class vi{get actors(){return this.world.entityManager.entities.filter(e=>e instanceof Qe)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(e=>e instanceof eu)}get tileMaps(){return this.world.entityManager.entities.filter(e=>e instanceof qd)}get timers(){return this._timers}constructor(){this._logger=at.getInstance(),this.events=new I,this.camera=new tu,this.world=new ou(this),this.physics=new lu(gs()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(Xh),this.world.add(new No(this.world,this.physics)),this.world.add(new Go(this.world,this.physics)),this.world.add(Vo),this.world.add(qh),this.world.add(Yh),this.world.add(Wh),this.world.add(Nh)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}onPreLoad(e){}onTransition(e){}onInitialize(e){}onActivate(e){}onDeactivate(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreDraw(e,s){}onPostDraw(e,s){}_initializeChildren(){for(const e of this.entities)e._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(e){var s;if(!this.isInitialized){try{this.engine=e,this.physics.config=this.engine.physics,this.input=new Jh({pointerTarget:e.pointerScope===M.Canvas?e.canvas:document,grabWindowFocus:e.grabWindowFocus,engine:e}),this.camera._initialize(e),this.world.systemManager.initialize(),await this.onInitialize(e),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,e),this.events.emit("initialize",new Nn(e,this))}catch(r){throw this._logger.error(`Error during scene initialization for scene ${(s=e.director)===null||s===void 0?void 0:s.getSceneName(this)}!`),r}this._isInitialized=!0}}async _activate(e){var s,r;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(e)}catch(a){throw this._logger.error(`Error during scene activation for scene ${(r=(s=this.engine)===null||s===void 0?void 0:s.director)===null||r===void 0?void 0:r.getSceneName(this)}!`),a}}async _deactivate(e){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(e)}_preupdate(e,s){this.emit("preupdate",new ks(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.emit("postupdate",new Ls(e,s,this)),this.onPostUpdate(e,s)}_predraw(e,s){this.emit("predraw",new On(e,s,this)),this.onPreDraw(e,s)}_postdraw(e,s){this.emit("postdraw",new Wn(e,s,this)),this.onPostDraw(e,s)}update(e,s){var r;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(r=e.director)===null||r===void 0?void 0:r.getSceneName(this)}!`);return}this._preupdate(e,s);let a,l;for(a=0,l=this._cancelQueue.length;a<l;a++)this.removeTimer(this._cancelQueue[a]);this._cancelQueue.length=0;for(const f of this._timers)f.update(s);this.world.update(ui.Update,s),this.camera&&this.camera.update(e,s),this._collectActorStats(e),this._postupdate(e,s),this.input.update()}draw(e,s){var r;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(e,s),this.world.update(ui.Draw,s),!((r=this.engine)===null||r===void 0)&&r.isDebug&&this.debugDraw(e),this._postdraw(e,s)}debugDraw(e){this.emit("predebugdraw",new eh(e,this)),this.emit("postdebugdraw",new ih(e,this))}contains(e){return this.actors.indexOf(e)>-1}add(e){if(this.emit("entityadded",{target:e}),e instanceof un){go(this._timers,e)||this.addTimer(e);return}this.world.add(e),e.scene=this}transfer(e){let s;e instanceof He&&e.scene&&e.scene!==this&&(s=e.scene,e.scene.world.remove(e,!1)),e instanceof un&&e.scene&&(s=e.scene,e.scene.removeTimer(e)),s?.emit("entityremoved",{target:e}),this.add(e)}remove(e){this.emit("entityremoved",{target:e}),e instanceof He&&(e.isActive&&e.kill(),this.world.remove(e)),e instanceof un&&this.removeTimer(e)}clear(e=!0){for(let s=this.entities.length-1;s>=0;s--)this.world.remove(this.entities[s],e);for(let s=this.timers.length-1;s>=0;s--)this.removeTimer(this.timers[s])}addTimer(e){return this._timers.push(e),e.scene=this,e}removeTimer(e){const s=this._timers.indexOf(e);return s!==-1&&this._timers.splice(s,1),e}cancelTimer(e){return this._cancelQueue.push(e),e}isTimerActive(e){return this._timers.indexOf(e)>-1&&!e.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(e){const s=this.actors;for(let r=0;r<s.length;r++){const a=s[r];a instanceof Uh&&e.stats.currFrame.actors.ui++,e.stats.currFrame.actors.alive++;for(let l=0;l<a.children.length;l++){const f=a.children[l];Vd(f)?e.stats.currFrame.actors.ui++:e.stats.currFrame.actors.alive++}}}}var fn;(function(u){u.Protanope="Protanope",u.Deuteranope="Deuteranope",u.Tritanope="Tritanope"})(fn||(fn={}));const Wp=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class _u{constructor(e,s){this._shader=new ei({gl:e,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:s}),this._shader.compile(),this._buffer=new Gi({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new cs({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class gu{constructor(e,s=!1){this._colorBlindnessMode=e,this._simulate=!1,this._simulate=s}initialize(e){this._shader=new _u(e,Wp),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(e){if(this._colorBlindnessMode=e,this._shader){const s=this._shader.getShader();s.use(),this._colorBlindnessMode===fn.Protanope?s.setUniformInt("u_type",0):this._colorBlindnessMode===fn.Deuteranope?s.setUniformInt("u_type",1):this._colorBlindnessMode===fn.Tritanope&&s.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(e){if(this._simulate=e,this._shader){const s=this._shader.getShader();s.use(),s.setUniformBoolean("u_simulate",e)}}get simulate(){return this._simulate}}class pu{constructor(e){this._engine=e,this._colorBlindPostProcessor=new gu(fn.Protanope)}correct(e){this._engine.graphicsContext instanceof us&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(e){this._engine.graphicsContext instanceof us&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class mu{constructor(e){this.stats={currFrame:new Hr,prevFrame:new Hr},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:Q.Yellow,showZIndex:!1,showScale:!1,scaleColor:Q.Green,showRotation:!1,rotationColor:Q.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:Q.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:Q.Blue,showOwner:!1,showGeometry:!0,geometryColor:Q.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:Q.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:Q.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:Q.Yellow,showAcceleration:!1,accelerationColor:Q.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:Q.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:Q.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:Q.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:Q.Yellow,positionSize:1,showGrid:!1,gridColor:Q.Red,gridWidth:1,showColliderGeometry:!0},this._engine=e,this.colorBlindMode=new pu(this._engine)}useTestClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const r=e.toTestClock();return s&&r.start(),this._engine.clock=r,r}useStandardClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const r=e.toStandardClock();return s&&r.start(),this._engine.clock=r,r}}class Hr{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new jo,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(e){e?(this.id=e.id,this.elapsedMs=e.elapsedMs,this.fps=e.fps,this.actors.alive=e.actors.alive,this.actors.killed=e.actors.killed,this.actors.ui=e.actors.ui,this.duration.update=e.duration.update,this.duration.draw=e.duration.draw,this._physicsStats.reset(e.physics),this.graphics.drawCalls=e.graphics.drawCalls,this.graphics.drawnImages=e.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const e=new Hr;return e.reset(this),e}get id(){return this._id}set id(e){this._id=e}get elapsedMs(){return this._elapsedMs}set elapsedMs(e){this._elapsedMs=e}get fps(){return this._fps}set fps(e){this._fps=e}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class jo{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(e){e?(this.pairs=e.pairs,this.collisions=e.collisions,this.contacts=e.contacts,this.fastBodies=e.fastBodies,this.fastBodyCollisions=e.fastBodyCollisions,this.broadphase=e.broadphase,this.narrowphase=e.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const e=new jo;return e.reset(this),e}get pairs(){return this._pairs}set pairs(e){this._pairs=e}get collisions(){return this._collisions}set collisions(e){this._collisions=e}get contacts(){return this._contacts}set contacts(e){this._contacts=e}get fastBodies(){return this._fastBodies}set fastBodies(e){this._fastBodies=e}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(e){this._fastBodyCollisions=e}get broadphase(){return this._broadphase}set broadphase(e){this._broadphase=e}get narrowphase(){return this._narrowphase}set narrowphase(e){this._narrowphase=e}}class Kh{on(e,s){this._nativeHandlers[e]&&this.off(e,this._nativeHandlers[e]),this._nativeHandlers[e]=this._decorate(s),this.nativeComponent.addEventListener(e,this._nativeHandlers[e])}off(e,s){s||(s=this._nativeHandlers[e]),this.nativeComponent.removeEventListener(e,s),this._nativeHandlers[e]=null}_decorate(e){return s=>{this._paused||e(s)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const e in this._nativeHandlers)this.off(e)}constructor(e){this.nativeComponent=e,this._paused=!1,this._nativeHandlers={}}}class vu{constructor(e,s){this._windowGlobal=e,this._documentGlobal=s,this._windowComponent=new Kh(this._windowGlobal),this._documentComponent=new Kh(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const wu={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:fe.Blended,canvasImageRendering:"auto"},xu={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:fe.Blended,canvasImageRendering:"auto"};class bu{constructor(e){var s;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=e.initialFps,this._samplePeriod=(s=e.samplePeriod)!==null&&s!==void 0?s:this._samplePeriod,this._currentFrameTime=1e3/e.initialFps,this._nowFn=e.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const e=this._nowFn();this._currentFrameTime=e-this._beginFrameTime,e>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(e-this._previousSampleTime),this._previousSampleTime=e,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class $h{constructor(e){var s,r,a;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=e,this.tick=e.tick,this._lastTime=(s=this.now())!==null&&s!==void 0?s:0,this._maxFps=(r=e.maxFps)!==null&&r!==void 0?r:this._maxFps,this._onFatalException=(a=e.onFatalException)!==null&&a!==void 0?a:this._onFatalException,this.fpsSampler=new bu({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new yu({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new tl({...this._options})}setFatalExceptionHandler(e){this._onFatalException=e}schedule(e,s=0,r="preframe"){const a=this._totalElapsed+s;this._scheduledCbs.push([e,a,r])}__runScheduledCbs(e="preframe"){for(let s=this._scheduledCbs.length-1;s>-1;s--)e===this._scheduledCbs[s][2]&&this._scheduledCbs[s][1]<=this._totalElapsed&&(this._scheduledCbs[s][0](this._elapsed),this._scheduledCbs.splice(s,1))}update(e){try{this.fpsSampler.start();const s=this.now();let r=s-this._lastTime||1;const a=1e3/this._maxFps;if(r>=a){let l=0;a!==0&&(l=r%a,r=r-l),r>200&&(r=1),this._elapsed=e||r,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(e||r),this.__runScheduledCbs("postframe"),a!==0?this._lastTime=s-l:this._lastTime=s,this.fpsSampler.end()}}catch(s){this._onFatalException(s),this.stop()}}}class tl extends $h{constructor(e){super(e),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const e=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(e),this.update()}catch(s){throw window.cancelAnimationFrame(this._requestId),s}};e()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class yu extends $h{constructor(e){super({...e}),this._logger=at.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=e.defaultUpdateMs}now(){var e;return(e=this._currentTime)!==null&&e!==void 0?e:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(e){const s=e??this._updateMs;this._running?(this.update(s),this._currentTime+=s):this._logger.warn("The clock is not running, no step will be performed")}run(e,s){for(let r=0;r<e;r++)this.step(s??this._updateMs)}}var Np=o(296);class Au{constructor(){this._toasterCss=Np.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(e){const s=document.createElement("span");return s.innerText=e,s}toast(e,s,r){this._initialize();const a=document.createElement("div");a.className="ex-toast-message";const l=e.split("[LINK]").map(y=>this._createFragment(y));if(s){const y=document.createElement("a");y.href=s,r?y.innerText=r:y.innerText=s,l.splice(1,0,y)}const f=document.createElement("div");l.forEach(y=>{f.appendChild(y)}),a.appendChild(f);const g=document.createElement("button");g.innerText="x",g.addEventListener("click",()=>{this._container.removeChild(a)}),a.appendChild(g);const m=y=>{if(y.key==="Escape")try{this._container.removeChild(a)}catch{}document.removeEventListener("keydown",m)};document.addEventListener("keydown",m);const w=this._container.firstChild;this._container.insertBefore(a,w)}}const Gp={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class Cu{get isTransitioning(){return this._isTransitioning}constructor(e,s){this._engine=e,this.events=new I,this._logger=at.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new vi,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const r in s){const a=s[r];this.add(r,a),r==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const e=this._deferredGoto;this._deferredGoto=void 0;const s=this._deferredTransition;this._deferredTransition=void 0;const r=this.getSceneInstance(e);r&&s&&s._addToTargetScene(this._engine,r),await this.swapScene(e),r&&s&&await this.playTransition(s,r)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(e,s){const r=s?.loader;r instanceof Sr?this.mainLoader=r:Sh(r)?this.mainLoader=new r:this.mainLoader=new ln;let a;if(s?.inTransition){const{inTransition:l}=s;a=l}if(this.startScene=e,a){const l=this.getSceneInstance(this.startScene);l&&(a._addToTargetScene(this._engine,l),this.swapScene(this.startScene).then(()=>this.playTransition(a,l)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(e){return this._sceneToLoader.get(e)}_getInTransition(e){var s;const r=this.scenes[e];if(!(r instanceof vi||Zi(r)))return(s=r?.transitions)===null||s===void 0?void 0:s.in}_getOutTransition(e){var s;const r=this.scenes[e];if(!(r instanceof vi||Zi(r)))return(s=r?.transitions)===null||s===void 0?void 0:s.out}getDeferredScene(){const e=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&e?e:null}getSceneDefinition(e){const s=this.scenes[e];if(s instanceof vi||Zi(s))return s;if(s)return s.scene}getSceneName(e){for(const[s,r]of Object.entries(this.scenes))if(r instanceof vi){if(e===r)return s}else if(!Zi(r)&&e===r.scene)return s;for(const[s,r]of Object.entries(this.scenes))if(Zi(r)){if(e.constructor===r)return s}else if(!(r instanceof vi)&&e.constructor===r.scene)return s;return null}assertAdded(e){return this}assertRemoved(e){return this}add(e,s){if(!(s instanceof vi)&&!Zi(s)){const{loader:r,transitions:a}=s,{in:l,out:f}=a??{};this._sceneToTransition.set(e,{in:l,out:f}),Sh(r)?this._sceneToLoader.set(e,new r):r&&this._sceneToLoader.set(e,r)}return this.scenes[e]&&this._logger.warn("Scene",e,"already exists overwriting"),this.scenes[e]=s,this.assertAdded(e)}remove(e){if(e instanceof vi||Zi(e)){const s=e;for(const r in this.scenes)if(this.scenes.hasOwnProperty(r)){const a=this.scenes[r];let l;if(a instanceof vi||Zi(a)?l=a:l=a.scene,l===s){if(r===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${r}`);this._sceneToInstance.delete(r),this._sceneToTransition.delete(r),this._sceneToLoader.delete(r),delete this.scenes[r]}}}if(typeof e=="string"){if(e===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${e}`);this._sceneToInstance.delete(e),this._sceneToTransition.delete(e),this._sceneToLoader.delete(e),delete this.scenes[e]}}async goToScene(e,s){var r,a,l,f,g,m;const w=this.getSceneInstance(e);if(!w){this._logger.warn(`Scene ${e} does not exist! Check the name, are you sure you added it?`);return}const y=this.currentScene,A=this.currentSceneName,E=(a=(r=this._engine.input)===null||r===void 0?void 0:r.enabled)!==null&&a!==void 0?a:!0;this._isTransitioning=!0;const D=(l=this.getSceneInstance(A))===null||l===void 0?void 0:l.onTransition("out"),L=w?.onTransition("in");s={sourceOut:(f=this._getOutTransition(this.currentSceneName))!==null&&f!==void 0?f:D,destinationIn:(g=this._getInTransition(e))!==null&&g!==void 0?g:L,...s};const{sourceOut:O,destinationIn:q,sceneActivationData:H}=s,N=O??this._getOutTransition(this.currentSceneName),J=q??this._getInTransition(e),Y=N?.hideLoader||J?.hideLoader;Y&&this.maybeLoadScene(e,Y),this._emitEvent("navigationstart",A,e),N&&await this.playTransition(N,y),await this.maybeLoadScene(e,Y),J&&await J.onPreviousSceneDeactivate(this.currentScene),J&&J._addToTargetScene(this._engine,w),await this.swapScene(e,H),this._emitEvent("navigation",A,e),J&&await this.playTransition(J,w),this._emitEvent("navigationend",A,e),(m=this._engine.input)===null||m===void 0||m.toggleEnabled(E),this._isTransitioning=!1}getSceneInstance(e){const s=this.getSceneDefinition(e);if(!s)return;if(this._sceneToInstance.has(e))return this._sceneToInstance.get(e);if(s instanceof vi)return this._sceneToInstance.set(e,s),s;const r=new s;return this._sceneToInstance.set(e,r),r}async maybeLoadScene(e,s=!1){var r;const a=(r=this._getLoader(e))!==null&&r!==void 0?r:new Sr,l=this.getSceneDefinition(e),f=this.getSceneInstance(e);l&&f&&!this._loadedScenes.has(f)&&(f.onPreLoad(a),f.events.emit("preload",{loader:a}),s?this._engine.load(a,s):await this._engine.load(a),this._loadedScenes.add(f))}async playTransition(e,s){var r,a,l,f,g,m,w;if(!this.isInitialized){this._deferredTransition=e;return}if(e){this.currentTransition=e;const y=(a=(r=s.input)===null||r===void 0?void 0:r.enabled)!==null&&a!==void 0?a:!0;(l=s.input)===null||l===void 0||l.toggleEnabled(!e.blockInput),(f=this._engine.input)===null||f===void 0||f.toggleEnabled(!e.blockInput),this.currentTransition._addToTargetScene(this._engine,s),await this.currentTransition._play(),(g=s.input)===null||g===void 0||g.toggleEnabled(y)}(m=this.currentTransition)===null||m===void 0||m.kill(),(w=this.currentTransition)===null||w===void 0||w.reset(),this.currentTransition=void 0}async swapScene(e,s){const r=this._engine;if(!this.isInitialized){this._deferredGoto=e;return}const a=this.getSceneInstance(e);if(a){const l=this.currentScene,f=a;if(this._logger.debug("Going to scene:",e),this.currentScene.isInitialized){const w={engine:r,previousScene:l,nextScene:f};await this.currentScene._deactivate(w),this.currentScene.events.emit("deactivate",new uh(w,this.currentScene)),this.currentScene.input.clear()}const g=this._sceneToLoader.get(e);await g?.areResourcesLoaded(),this.currentScene=f,this.currentSceneName=e,r.screen.setCurrentCamera(f.camera),await this.currentScene._initialize(r);const m={engine:r,previousScene:l,nextScene:f,data:s};await this.currentScene._activate(m),this.currentScene.events.emit("activate",new dh(m,this.currentScene))}else this._logger.error("Scene",e,"does not exist!")}_emitEvent(e,s,r){const a=this.getSceneDefinition(s),l=this.getSceneDefinition(r);this.events.emit(e,{sourceScene:a,sourceName:s,destinationScene:l,destinationName:r})}}function Su(){const u={scope:(e,s)=>{const r=u.value;u.value=e;try{return s()}catch(a){throw a}finally{u.value=r}},value:void 0};return u}function Pu(u){return u.value}const el={textureCollectInterval:6e4};class Tu{constructor(e){this.options=e,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=s=>{if(this._running){for(const[r,[a,l]]of this._collectors.entries()){const f=this.options.getTimestamp();for(const[g,[m,w]]of this._collectionMap.entries()){if(r!==m||w+l>=f)continue;a(g)&&this._collectionMap.delete(g)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(e,s,r){this._collectors.set(e,[r,s])}addCollectableResource(e,s){this._collectionMap.set(s,[e,this.options.getTimestamp()])}touch(e){const s=this._collectionMap.get(e);s&&this._collectionMap.set(e,[s[0],this.options.getTimestamp()])}forceCollectAll(){for(const[e,[s]]of this._collectors.entries())for(const[r]of this._collectionMap.entries())s(r)&&this._collectionMap.delete(r)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}x();const Vp={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Os;(function(u){u[u.None=0]="None",u[u.Canvas=1]="Canvas",u[u.All=2]="All"})(Os||(Os={}));class si{static useEngine(){const e=Pu(si.Context);if(!e)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return e}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(e){this.graphicsContext.snapToPixel=e}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,r,a,l,f,g,m,w,y;this.scope=Y=>si.Context.scope(this,Y),this.version=hl,this.events=new I,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=Y=>{at.getInstance().fatal(Y,Y.stack)},this._toaster=new Au,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=Y=>{var $;Y.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",Y);const ot=document.createElement("div");ot.id="ex-webgl-graphics-context-lost",ot.style.position="absolute",ot.style.zIndex="99",ot.style.left="50%",ot.style.top="50%",ot.style.display="flex",ot.style.flexDirection="column",ot.style.transform="translate(-50%, -50%)",ot.style.backgroundColor="white",ot.style.padding="10px",ot.style.borderStyle="solid 1px";const Z=document.createElement("div");if(Z.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,ot.appendChild(Z),!(($=this.canvas)===null||$===void 0)&&$.parentElement){this.canvas.parentElement.appendChild(ot);const _t=Z.querySelector("#ex-webgl-graphics-reload");_t?.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new P,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],e={...si._DEFAULT_ENGINE_OPTIONS,...e},this._originalOptions=e,b.freeze(),this.browser=new vu(window,document);const A=new ud;if(!e.suppressMinimumBrowserFeatureDetection&&!(this._compatible=A.test())){const Y=document.createElement("div");if(Y.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(Y),A.failedTests.forEach(function($){const ot=document.createElement("div");ot.innerText="Browser feature missing "+$,document.body.appendChild(ot)}),e.canvasElementId){const $=document.getElementById(e.canvasElementId);$&&$.parentElement.removeChild($)}return}else this._compatible=!0;if(console.log&&!e.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${hl})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),e.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=at.getInstance(),this._logger.defaultLevel===Gt.Debug&&A.logBrowserFeatures(),this._logger.debug("Building engine..."),e.garbageCollection===!0?this.garbageCollectorConfig={...el}:e.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...el,...e.garbageCollection},this._garbageCollector=new Tu({getTimestamp:Date.now}),this.canvasElementId=e.canvasElementId,e.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+e.canvasElementId),document.getElementById(e.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(e.canvasElementId)}else e.canvasElement?(this._logger.debug("Using Canvas element specified:",e.canvasElement),this.canvas=e.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!e.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",Y=>{Y.preventDefault()});let E=(s=e.displayMode)!==null&&s!==void 0?s:ye.Fixed;e.width&&e.height||e.viewport?(e.displayMode===void 0&&(E=ye.Fixed),this._logger.debug("Engine viewport is size "+e.width+" x "+e.height)):e.displayMode||(this._logger.debug("Engine viewport is fit"),E=ye.FitScreen),this.grabWindowFocus=e.grabWindowFocus,this.pointerScope=e.pointerScope,this._originalDisplayMode=E;let D,L,O,q,H,N;typeof e.antialiasing=="object"?{pixelArtSampler:D,nativeContextAntialiasing:O,multiSampleAntialiasing:N,filtering:H,canvasImageRendering:q}={...e.pixelArt?xu:wu,...e.antialiasing}:(D=!!e.pixelArt,O=!1,N=e.antialiasing,q=e.antialiasing?"auto":"pixelated",H=e.antialiasing?fe.Blended:fe.Pixel),O&&N&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),e.pixelArt&&(L=.25),(!e.antialiasing||H===fe.Pixel)&&(L=0),L=(a=(r=e.uvPadding)!==null&&r!==void 0?r:L)!==null&&a!==void 0?a:.01;let J=b.isEnabled("use-canvas-context");if(!J)try{this.graphicsContext=new us({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:D,antialiasing:O,multiSampleAntialiasing:N,uvPadding:L,powerPreference:e.powerPreference,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(l=e.handleContextLost)!==null&&l!==void 0?l:this._handleWebGLContextLost,handleContextRestored:e.handleContextRestored})}catch(Y){this._logger.warn(`Excalibur could not load webgl for some reason (${Y.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),J=!0}J&&(this.graphicsContext=new Bo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:O,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting})),this.screen=new yh({canvas:this.canvas,context:this.graphicsContext,antialiasing:O,canvasImageRendering:q,browser:this.browser,viewport:(f=e.viewport)!==null&&f!==void 0?f:e.width&&e.height?{width:e.width,height:e.height}:bh.SVGA,resolution:e.resolution,displayMode:E,pixelRatio:e.suppressHiDPIScaling?1:(g=e.pixelRatio)!==null&&g!==void 0?g:null}),ie.filtering=H,e.backgroundColor&&(this.backgroundColor=e.backgroundColor.clone()),this.maxFps=(m=e.maxFps)!==null&&m!==void 0?m:this.maxFps,this.fixedUpdateTimestep=(w=e.fixedUpdateTimestep)!==null&&w!==void 0?w:this.fixedUpdateTimestep,this.fixedUpdateFps=(y=e.fixedUpdateFps)!==null&&y!==void 0?y:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new tl({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:Y=>this.onFatalException(Y)}),this.enableCanvasTransparency=e.enableCanvasTransparency,typeof e.physics=="boolean"?this.physics={...gs(),enabled:e.physics}:(this.physics={...gs()},vo(this.physics,e.physics)),this.debug=new mu(this),this.director=new Cu(this,e.scenes),this._initialize(e),window.___EXCALIBUR_DEVTOOL=this,si.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:e}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:s,showPlayerMessage:r}=this._originalOptions.configurePerformanceCanvas2DFallback;if(s===void 0&&(s=si._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),r===void 0&&(r=si._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!b.isEnabled("use-canvas-context")&&e&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===s.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let a=0;for(let f=0;f<this._fpsSamples.length;f++)a+=this._fpsSamples[f];const l=a/this._fpsSamples.length;this._fpsSamples.length===s.numberOfFrames&&l<=s.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),r&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var e,s,r;const a=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(a,this.canvas),this.canvas=a;const l={...this._originalOptions,antialiasing:this.screen.antialiasing},f=this._originalDisplayMode;this.graphicsContext=new Bo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:l.antialiasing,backgroundColor:l.backgroundColor,snapToPixel:l.snapToPixel,useDrawSorting:l.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new yh({canvas:this.canvas,context:this.graphicsContext,antialiasing:(e=l.antialiasing)!==null&&e!==void 0?e:!0,browser:this.browser,viewport:(s=l.viewport)!==null&&s!==void 0?s:l.width&&l.height?{width:l.width,height:l.height}:bh.SVGA,resolution:l.resolution,displayMode:f,pixelRatio:l.suppressHiDPIScaling?1:(r=l.pixelRatio)!==null&&r!==void 0?r:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const g=l&&l.pointerScope===M.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(g,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,si.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(e){if(e<0){at.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=e}addTimer(e){return this.currentScene.addTimer(e)}removeTimer(e){return this.currentScene.removeTimer(e)}addScene(e,s){return this.director.add(e,s),this}removeScene(e){this.director.remove(e)}add(e){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const s=this.director.getDeferredScene();s instanceof vi?s.add(e):this.currentScene.add(e)}remove(e){e instanceof He&&this.currentScene.remove(e),(e instanceof vi||Zi(e))&&this.removeScene(e),typeof e=="string"&&this.removeScene(e)}async goToScene(e,s){await this.scope(async()=>{await this.director.goToScene(e,s)})}screenToWorldCoordinates(e){return this.screen.screenToWorldCoordinates(e)}worldToScreenCoordinates(e){return this.screen.worldToScreenCoordinates(e)}_initialize(e){var s,r;this.pageScrollPreventionMode=e.scrollPreventionMode;const a=e&&e.pointerScope===M.Document?document:this.canvas,l=(r=(s=this._originalOptions)===null||s===void 0?void 0:s.grabWindowFocus)!==null&&r!==void 0?r:!0;this.input=new Jh({pointerTarget:a,grabWindowFocus:l,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new ch(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new lh(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!e.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(e){this._inputEnabled=e,this.input.toggleEnabled(this._inputEnabled)}onInitialize(e){}get isInitialized(){return this._isInitialized}async _overrideInitialize(e){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(e),this.events.emit("initialize",new Nn(e,this)),this._isInitialized=!0)}_update(e){var s;if(this._isLoading){(s=this._loader)===null||s===void 0||s.onUpdate(this,e),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(e),this.currentScene.update(this,e),this.graphicsContext.updatePostProcessors(e),this.clock.__runScheduledCbs("postupdate"),this._postupdate(e),this.input.update()}_preupdate(e){this.emit("preupdate",new ks(this,e,this)),this.onPreUpdate(this,e)}onPreUpdate(e,s){}_postupdate(e){this.emit("postupdate",new Ls(this,e,this)),this.onPostUpdate(this,e)}onPostUpdate(e,s){}_draw(e){var s,r;if(this.graphicsContext.backgroundColor=(s=this.currentScene.backgroundColor)!==null&&s!==void 0?s:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,e),this._isLoading){this._hideLoader||((r=this._loader)===null||r===void 0||r.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,e),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,e),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(e,s){this.emit("predraw",new On(e,s,this)),this.onPreDraw(e,s)}onPreDraw(e,s){}_postdraw(e,s){this.emit("postdraw",new Wn(e,s,this)),this.onPostDraw(e,s)}onPostDraw(e,s){}showDebug(e){this._isDebug=e}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(e,s){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let r;return e instanceof Sr?r=e:typeof e=="string"&&(this.director.configureStart(e,s),r=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(r??new ln),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new Ja(this)),this._isReadyFuture.promise})}_mainloop(e){this.scope(()=>{this.emit("preframe",new sh(this,this.stats.prevFrame));const s=e*this.timescale;this.currentFrameElapsedMs=s;const r=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=r,this.stats.currFrame.elapsedMs=s,this.stats.currFrame.fps=this.clock.fpsSampler.fps,Zt.clear();const a=this.clock.now(),l=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=s;this._lagMs>=l;)this._update(l),this._lagMs-=l;else this._update(s);const f=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(s);const g=this.clock.now();this.stats.currFrame.duration.update=f-a,this.stats.currFrame.duration.draw=g-f,this.stats.currFrame.graphics.drawnImages=Zt.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=Zt.DrawCallCount,this.emit("postframe",new nh(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new Ka(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(e=!1){return new Promise(r=>{this._screenShotRequests.push({preserveHiDPIResolution:e,resolve:r})})}_checkForScreenShots(){for(const e of this._screenShotRequests){const s=e.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,r=e.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,a=document.createElement("canvas");a.width=s,a.height=r;const l=a.getContext("2d");l.imageSmoothingEnabled=this.screen.antialiasing,l.drawImage(this.canvas,0,0,s,r);const f=new Image,g=a.toDataURL("image/png");f.onload=()=>{e.resolve(f)},f.src=g}this._screenShotRequests.length=0}async load(e,s=!1){await this.scope(async()=>{try{if(e.isLoaded())return;this._loader=e,this._isLoading=!0,this._hideLoader=s,e instanceof ln&&(e.suppressPlayButton=e.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await e.load()}catch(r){this._logger.error("Error loading resources, things may not behave properly",r),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}si.Context=Su(),si.InstanceCount=0,si._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:M.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Os.Canvas,backgroundColor:Q.fromHex("#2185d0")};class Xp extends Qe{set maxWidth(e){this._text.maxWidth=e}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(e){this._font=e,this._text.font=e}get text(){return this._text.text}set text(e){this._text.text=e}get color(){return this._text.color}set color(e){this._text&&(this._text.color=e)}get opacity(){return this.graphics.opacity}set opacity(e){this.graphics.opacity=e}get spriteFont(){return this._spriteFont}set spriteFont(e){e&&(this._spriteFont=e,this._text.font=this._spriteFont)}constructor(e){super(e),this._font=new nn,this._text=new br({text:"",font:this._font});const{text:s,pos:r,x:a,y:l,spriteFont:f,font:g,color:m,maxWidth:w}={text:"",...e};this.pos=r??(a&&l?z(a,l):this.pos),this.text=s??this.text,this.font=g??this.font,this.maxWidth=w??this.maxWidth,this.spriteFont=f??this.spriteFont,this._text.color=m??this.color;const y=this.get(se);y.anchor=B.Zero,y.use(this._text)}_initialize(e){super._initialize(e)}getTextWidth(){return this._text.width}}var Ws;(function(u){u.Circle="circle",u.Rectangle="rectangle"})(Ws||(Ws={}));class qp extends Qe{constructor(e){var s,r;super({width:(s=e.width)!==null&&s!==void 0?s:0,height:(r=e.height)!==null&&r!==void 0?r:0}),this._particlesToEmit=0,this._particlePool=new pr(()=>new Mo({}),L=>L,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=Ws.Rectangle,this.radius=0,this.particle={life:2e3,transform:Di.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:a,x:l,y:f,z:g,pos:m,isEmitting:w,emitRate:y,emitterType:A,radius:E,random:D}={...e};this.particle={...this.particle,...a},this.pos=m??z(l??0,f??0),this.z=g??0,this.isEmitting=w??this.isEmitting,this.emitRate=y??this.emitRate,this.emitterType=A??this.emitterType,this.radius=E??this.radius,this.body.collisionType=ut.PreventCollision,this.random=D??new F}removeParticle(e){this.deadParticles.push(e)}emitParticles(e){var s;if(!(e<=0)){e=e|0;for(let r=0;r<e;r++){const a=this._createParticle();!((s=this===null||this===void 0?void 0:this.scene)===null||s===void 0)&&s.world&&(this.particle.transform===Di.Global?this.scene.world.add(a):this.addChild(a)),this._activeParticles.push(a)}}}clearParticles(){for(let e=0;e<this._activeParticles.length;e++)this.removeParticle(this._activeParticles[e])}_createParticle(){let e=0,s=0;const r=Ct(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),a=Ct(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),l=this.particle.startSize||Ct(this.particle.minSize||5,this.particle.maxSize||5,this.random),f=a*Math.cos(r),g=a*Math.sin(r);if(this.emitterType===Ws.Rectangle)e=Ct(0,this.width,this.random),s=Ct(0,this.height,this.random);else if(this.emitterType===Ws.Circle){const w=Ct(0,this.radius,this.random);e=w*Math.cos(r),s=w*Math.sin(r)}const m=this._particlePool.rent();return m.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:z(e,s),vel:z(f,g),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:l,graphic:this.particle.graphic,fade:this.particle.fade}),m.registerEmitter(this),this.particle.randomRotation&&(m.transform.rotation=Ct(0,Math.PI*2,this.random)),this.particle.focus&&(m.focus=this.particle.focus.add(z(this.pos.x,this.pos.y)),m.focusAccel=this.particle.focusAccel),m}update(e,s){var r;super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let a=0;a<this.deadParticles.length;a++){!((r=this===null||this===void 0?void 0:this.scene)===null||r===void 0)&&r.world&&(this.scene.world.remove(this.deadParticles[a],!1),this._particlePool.return(this.deadParticles[a]));const l=this._activeParticles.indexOf(this.deadParticles[a]);l>-1&&this._activeParticles.splice(l,1)}this.deadParticles.length=0}}function Yp(u,e){}class Zo{constructor(e,s,r){var a;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=e,this.particle=r,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=s,this._particleLife=(a=this.particle.life)!==null&&a!==void 0?a:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(e,s){if(this._initialized)return;const r=this.emitter.maxParticles,a=this._numInputFloats,l=this._particleData,f=4,g=e.createBuffer(),m=e.createVertexArray();e.bindVertexArray(m),e.bindBuffer(e.ARRAY_BUFFER,g),e.bufferData(e.ARRAY_BUFFER,r*a*f,e.DYNAMIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,l);let w=0;e.vertexAttribPointer(0,2,e.FLOAT,!1,a*f,0),w+=f*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*f,w),w+=f*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*f,w),w+=f*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(m),this._buffers.push(g),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null);const y=e.createBuffer(),A=e.createVertexArray();e.bindVertexArray(A),e.bindBuffer(e.ARRAY_BUFFER,y),e.bufferData(e.ARRAY_BUFFER,r*a*f,e.DYNAMIC_DRAW),w=0,e.vertexAttribPointer(0,2,e.FLOAT,!1,a*f,0),w+=f*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*f,w),w+=f*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*f,w),w+=f*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(A),this._buffers.push(y),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(e){const s=this._particleIndex,r=this.maxParticles*this._numInputFloats,a=e*this._numInputFloats+s;for(let l=s;l<a;l+=this._numInputFloats){const f=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||W),g=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),m=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),w=g*Math.cos(f),y=m*Math.sin(f);let A=0,E=0;if(this.emitter.emitterType===Ws.Rectangle)A=this._random.floating(-.5,.5)*this.emitter.width,E=this._random.floating(-.5,.5)*this.emitter.height;else{const O=this._random.floating(0,this.emitter.radius);A=O*Math.cos(f),E=O*Math.sin(f)}const D=this.emitter.transform.apply(z(A,E)),L=[this.particle.transform===Di.Local?A:D.x,this.particle.transform===Di.Local?E:D.y,w,y,this.particle.randomRotation?Ct(0,W,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(L,l%this._particleData.length)}a>=r?(this._wrappedParticles+=(a-r)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=e),this._particleIndex=a%r,this._emitted.push([this._particleLife,s])}_uploadEmitted(e){this._particleIndex!==this._uploadIndex&&(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),e.bindBuffer(e.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(e){var s;if(this._particleLife=(s=this.particle.life)!==null&&s!==void 0?s:this._particleLife,this._wrappedLife>0?this._wrappedLife-=e:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let r=this._emitted.length-1;r>=0;r--){const a=this._emitted[r];a[0]-=e,a[0]<=0&&this._emitted.splice(r,1)}this._emitted.sort((r,a)=>r[0]-a[0])}}draw(e){if(this._initialized){if(this._clearRequested?(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData),e.bindBuffer(e.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(e),e.bindVertexArray(this._currentVao),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const s=this._emitted[0][1]/this._numInputFloats;e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-s)*this._numInputFloats*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,s,this.maxParticles-s),e.endTransformFeedback(),e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,s),e.endTransformFeedback()}else e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,this.maxParticles),e.endTransformFeedback();e.bindVertexArray(null),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}Zo.GPU_MAX_PARTICLES=1e5;class jp extends Qe{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get z(){return this.transform.z}set z(e){this.transform.z=e}constructor(e){super({name:"GpuParticleEmitter",width:e.width,height:e.height}),this.particle={life:2e3,transform:Di.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new se,this.isEmitting=!1,this.emitRate=1,this.emitterType=Ws.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:s,maxParticles:r,x:a,y:l,z:f,pos:g,isEmitting:m,emitRate:w,emitterType:y,radius:A,random:E}={...e};this.maxParticles=j(r??this.maxParticles,0,Zo.GPU_MAX_PARTICLES),this.pos=g??z(a??0,l??0),this.z=f??0,this.isEmitting=m??this.isEmitting,this.emitRate=w??this.emitRate,this.emitterType=y??this.emitterType,this.radius=A??this.radius,this.particle={...this.particle,...s},this.random=E??new F,this.renderer=new Zo(this,this.random,this.particle)}_initialize(e){super._initialize(e);const s=e.graphicsContext;this.renderer.initialize(s.__gl,s)}update(e,s){super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(s)}emitParticles(e){e<=0||this.renderer.emitParticles(e|0)}clearParticles(){this.renderer.clearParticles()}draw(e,s){e.draw("ex.particle",this.renderer,s)}}class Eu extends He{getGraphics(){return this._graphics}addGraphic(e,s){this._graphics.push(e),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,s?.offset&&(this._gfx.offset=s.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let e=this._tileBounds.clone();for(const s of this._graphics){const r=z(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:s.height-this.map.tileHeight));e=e.combine(s.localBounds.translate(r))}return e}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&this._graphics.splice(s,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(z(this.x,this.y))}get center(){return this.pos.add(z(0,this.map.tileHeight/2))}constructor(e,s,r,a){super([new et,new se({offset:r??B.Zero,onPostDraw:(E,D)=>this.draw(E,D)}),new Br(a)]),this.solid=!1,this.events=new I,this._tileBounds=new ht,this._graphics=[],this._colliders=[],this.data=new Map,this.x=e,this.y=s,this.map=a,this._transform=this.get(et),this._isometricEntityComponent=this.get(Br);const l=this.map.tileWidth/2,f=this.map.tileHeight/2,g=(this.x-this.y)*l,m=(this.x+this.y)*f;this._transform.pos=z(g,m),this._isometricEntityComponent.elevation=a.elevation,this._gfx=this.get(se),this._gfx.isVisible=!1;const w=this.map.tileWidth,y=this.map.tileHeight,A=z(0,this.map.renderFromTopOfGraphic?y:0);this._gfx.localBounds=this._tileBounds=new ht({left:-w/2,top:-y,right:w/2,bottom:y}).translate(A)}draw(e,s){const r=this.map.tileWidth/2;e.save(),e.translate(-r,0);for(const a of this._graphics)a.draw(e,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:a.height-this.map.tileHeight));e.restore()}}class Zp extends He{get visible(){return this.isVisible}set visible(e){this.isVisible=e}constructor(e){super([new et,new St({type:ut.Fixed}),new ge,new zs,new Oo((y,A)=>this.debug(y,A),!1)],e.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=z(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:s,tileWidth:r,tileHeight:a,columns:l,rows:f,renderFromTopOfGraphic:g,graphicsOffset:m,elevation:w}=e;this.transform=this.get(et),s&&(this.transform.pos=s),this.collider=this.get(ge),this.collider&&this.collider.set(this._composite=new Ae([])),this.pointer=this.get(zs),this.renderFromTopOfGraphic=g??this.renderFromTopOfGraphic,this.graphicsOffset=m??this.graphicsOffset,this.elevation=w??this.elevation,this.tileWidth=r,this.tileHeight=a,this.columns=l,this.rows=f,this._pointerEventDispatcher=new zh,this.tiles=new Array(l*f);for(let y=0;y<f;y++)for(let A=0;A<l;A++){const E=new Eu(A,y,this.graphicsOffset,this);this.tiles[A+y*l]=E,this.addChild(E),this._pointerEventDispatcher.addObject(E,D=>this.getTileByPoint(D.worldPos)===E,()=>!0)}this.pointer.localBounds=ht.fromDimension(r*l*this.transform.scale.x,a*f*this.transform.scale.y,z(.5,0))}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:B.Zero;{const r=e.offset;return this._originalOffsets.set(e,r),r}}updateColliders(){this._composite.clearColliders();const e=this.get(et).pos;for(const s of this.tiles)if(s.solid)for(const r of s.getColliders()){const a=this._getOrSetColliderOriginalOffset(r);r.offset=this.tileToWorld(z(s.x,s.y)).sub(e).add(a).sub(z(this.tileWidth/2,this.tileHeight)),r.owner=this,this._composite.addCollider(r)}this.collider.update()}worldToTile(e){e=e.sub(this.transform.globalPos);const s=this.tileWidth/2,r=this.tileHeight/2;return z(~~((e.x/s+e.y/r)/2),~~((e.y/r-e.x/s)/2))}tileToWorld(e){const s=this.tileWidth/2,r=this.tileHeight/2,a=(e.x-e.y)*s,l=(e.x+e.y)*r;return z(a,l).add(this.transform.pos)}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const s=this.worldToTile(e);return this.getTile(s.x,s.y)}_getMaxZIndex(){let e=Number.NEGATIVE_INFINITY;for(const s of this.tiles){const r=s.get(et).z;r>e&&(e=r)}return e}debug(e,s){const{showAll:r,showPosition:a,positionColor:l,positionSize:f,showGrid:g,gridColor:m,gridWidth:w,showColliderGeometry:y}=s.isometric,{geometryColor:A,geometryLineWidth:E,geometryPointSize:D}=s.collider;if(e.save(),e.z=this._getMaxZIndex()+.5,r||g){for(let L=0;L<this.rows+1;L++){const O=this.tileToWorld(z(0,L)),q=this.tileToWorld(z(this.columns,L));e.drawLine(O,q,m,w)}for(let L=0;L<this.columns+1;L++){const O=this.tileToWorld(z(L,0)),q=this.tileToWorld(z(L,this.rows));e.drawLine(O,q,m,w)}}if(r||a)for(const L of this.tiles)e.drawCircle(this.tileToWorld(z(L.x,L.y)),f,l);if(r||y){for(const L of this.tiles)if(L.solid)for(const O of L.getColliders())O.debug(e,A,{lineWidth:E,pointSize:D})}e.restore()}}class il{constructor(e,s){this.id=Ut(),this._stopped=!1,this._sequenceBuilder=s,this._sequenceContext=new Dr(e),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(e){this._actionQueue.update(e)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(e){return new il(e,this._sequenceBuilder)}}class Qp{constructor(e){this.id=Ut(),this._actions=e}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}isComplete(e){return this._actions.every(s=>s.isComplete(e))}reset(){this._actions.forEach(e=>e.reset())}stop(){this._actions.forEach(e=>e.stop())}}class Yn{constructor(e,s){this.bounds=e,this.options=s,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...s},this.halfWidth=e.width/2,this.halfHeight=e.height/2}_split(){this._isDivided=!0;const e={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new Yn(new ht({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),e),this.topRight=new Yn(new ht({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),e),this.bottomLeft=new Yn(new ht({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),e),this.bottomRight=new Yn(new ht({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),e)}_insertIntoSubNodes(e){var s,r,a,l;!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.insert(e),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(e.bounds)&&this.topRight.insert(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.insert(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.insert(e)}insert(e){if(this._isDivided){this._insertIntoSubNodes(e);return}if(this.items.push(e),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const s of this.items)this._insertIntoSubNodes(s);this.items.length=0}}remove(e){var s,r,a,l;if(this.bounds.overlaps(e.bounds)){if(!this._isDivided){const f=this.items.indexOf(e);f>-1&&this.items.splice(f,1);return}!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.remove(e),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(e.bounds)&&this.topRight.remove(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.remove(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.remove(e)}}query(e){let s=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(e)&&(s=s.concat(this.topLeft.query(e))),this.topRight.bounds.overlaps(e)&&(s=s.concat(this.topRight.query(e))),this.bottomLeft.bounds.overlaps(e)&&(s=s.concat(this.bottomLeft.query(e))),this.bottomRight.bounds.overlaps(e)&&(s=s.concat(this.bottomRight.query(e)))),s=s.filter((r,a)=>s.indexOf(r)>=a),s}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let e=this.items;return this._isDivided&&(e=e.concat(this.topLeft.getAllItems()),e=e.concat(this.topRight.getAllItems()),e=e.concat(this.bottomLeft.getAllItems()),e=e.concat(this.bottomRight.getAllItems())),e=e.filter((s,r)=>e.indexOf(s)>=r),e}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(e){this.bounds.draw(e,Q.Yellow),this._isDivided&&(this.topLeft.bounds.draw(e,Q.Yellow),this.topRight.bounds.draw(e,Q.Yellow),this.bottomLeft.bounds.draw(e,Q.Yellow),this.bottomRight.bounds.draw(e,Q.Yellow))}}function Jp(u){return!!u._initialize}function Kp(u){return!!u.onAdd}function $p(u){return!!u.onRemove}function tm(u){return!!u.onInitialize}function em(u){return!!u._preupdate}function im(u){return!!u.onPreUpdate}function sm(u){return!!u.onPostUpdate}function nm(u){return!!u.onPostUpdate}function rm(u){return!!u.onAdd}function om(u){return!!u.onRemove}function am(u){return!!u.onPreDraw}function hm(u){return!!u.onPostDraw}class lm{constructor(e,s=!1){this.path=e,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new mr(e,"arraybuffer",s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){const e=await this._resource.load();this._stream=new Iu(e),this._gif=new Ru(this._stream);const s=this._gif.images.map(r=>new Ni(r.src,!1));return await Promise.all(s.map(r=>r.load())),this.data=this._images=s,this._sprites=this._images.map(r=>r.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(e=0){var s;return(s=this._sprites[e])!==null&&s!==void 0?s:null}toSpriteSheet(){const e=this._sprites;return e.length?new sn({sprites:e}):null}toAnimation(e){var s;const r=(s=this._gif)===null||s===void 0?void 0:s.images;if(r?.length){const a=r.map((l,f)=>{var g;return{graphic:this._sprites[f],duration:((g=this._gif)===null||g===void 0?void 0:g.frames[f].delayMs)||void 0}});return this._animation=new Ri({frames:a,frameDuration:e}),this._animation}return null}get readCheckBytes(){var e,s;return(s=(e=this._gif)===null||e===void 0?void 0:e.checkBytes)!==null&&s!==void 0?s:[]}}const Qo=u=>u.reduce(function(e,s){return e*2+s},0),sl=u=>{const e=[];for(let s=7;s>=0;s--)e.push(!!(u&1<<s));return e};class Iu{constructor(e){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=s=>{const r=[];for(let a=0;a<s;a++)r.push(this.readByte());return r},this.read=s=>{let r="";for(let a=0;a<s;a++)r+=String.fromCharCode(this.readByte());return r},this.readUnsigned=()=>{const s=this.readBytes(2);return(s[1]<<8)+s[0]},this.data=new Uint8Array(e),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const cm=function(u,e){let s=0;const r=function(E){let D=0;for(let L=0;L<E;L++)e.charCodeAt(s>>3)&1<<(s&7)&&(D|=1<<L),s++;return D},a=[],l=1<<u,f=l+1;let g=u+1,m=[];const w=function(){m=[],g=u+1;for(let E=0;E<l;E++)m[E]=[E];m[l]=[],m[f]=null};let y=0,A=0;for(;;){if(A=y,y=r(g),y===l){w();continue}if(y===f)break;if(y<m.length)A!==l&&m.push(m[A].concat(m[y][0]));else{if(y!==m.length)throw new Error("Invalid LZW code.");m.push(m[A].concat(m[A][0]))}a.push.apply(a,m[y]),m.length===1<<g&&g<12&&g++}return a};class Ru{constructor(e){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=s=>{const r=[];for(let a=0;a<s;a++){const l=this._st.readBytes(3);r.push(l)}return r},this.readSubBlocks=()=>{let s,r;r="";do s=this._st.readByte(),r+=this._st.read(s);while(s!==0);return r},this.parseHeader=()=>{const s={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(s.sig=this._st.read(3),s.ver=this._st.read(3),s.sig!=="GIF")throw new Error("Not a GIF file.");s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned(),this._currentFrameCanvas.width=s.width,this._currentFrameCanvas.height=s.height;const r=sl(this._st.readByte());s.gctFlag=r.shift(),s.colorResolution=Qo(r.splice(0,3)),s.sortedFlag=r.shift(),s.globalColorTableSize=Qo(r.splice(0,3)),s.backgroundColorIndex=this._st.readByte(),s.pixelAspectRatio=this._st.readByte(),s.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<s.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(s)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=s=>{const r=m=>{this.checkBytes.push(this._st.readByte());const w=sl(this._st.readByte());return m.reserved=w.splice(0,3),m.disposalMethod=Qo(w.splice(0,3)),m.userInputFlag=w.shift(),m.transparentColorFlag=w.shift(),m.delayTime=this._st.readUnsigned(),m.transparentColorIndex=this._st.readByte(),m.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(m)&&this.checkBytes.push(this._handler.gce),m},a=m=>{m.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(m)&&this.checkBytes.push(this._handler.com)},l=m=>{this.checkBytes.push(this._st.readByte()),m.ptHeader=this._st.readBytes(12),m.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(m)&&this.checkBytes.push(this._handler.pte)},f=m=>{const w=A=>{this.checkBytes.push(this._st.readByte()),A.unknown=this._st.readByte(),A.iterations=this._st.readUnsigned(),A.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(A)&&this.checkBytes.push(this._handler.app)},y=A=>{A.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[A.identifier]&&this._handler.app[A.identifier](A)&&this.checkBytes.push(this._handler.app[A.identifier])};switch(this.checkBytes.push(this._st.readByte()),m.identifier=this._st.read(8),m.authCode=this._st.read(3),m.identifier){case"NETSCAPE":w(m);break;default:y(m);break}},g=m=>{m.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(m)&&this.checkBytes.push(this._handler.unknown)};switch(s.label=this._st.readByte(),s.label){case 249:s.extType="gce",this._gce=r(s);break;case 254:s.extType="com",a(s);break;case 1:s.extType="pte",l(s);break;case 255:s.extType="app",f(s);break;default:s.extType="unknown",g(s);break}},this.parseImg=s=>{var r;const a=(g,m)=>{const w=new Array(g.length),y=g.length/m,A=(O,q)=>{const H=g.slice(q*m,(q+1)*m);w.splice.apply(w,[O*m,m].concat(H))},E=[0,4,2,1],D=[8,8,4,2];let L=0;for(let O=0;O<4;O++)for(let q=E[O];q<y;q+=D[O])A(q,L),L++;return w};s.leftPos=this._st.readUnsigned(),s.topPos=this._st.readUnsigned(),s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned();const l=sl(this._st.readByte());s.lctFlag=l.shift(),s.interlaced=l.shift(),s.sorted=l.shift(),s.reserved=l.splice(0,2),s.lctSize=Qo(l.splice(0,3)),s.lctFlag&&(s.lctBytes=this.parseColorTableBytes(1<<s.lctSize+1)),s.lzwMinCodeSize=this._st.readByte();const f=this.readSubBlocks();s.pixels=cm(s.lzwMinCodeSize,f),s.interlaced&&(s.pixels=a(s.pixels,s.width)),!((r=this._gce)===null||r===void 0)&&r.delayTime&&(s.delayMs=this._gce.delayTime*10),this.frames.push(s),this.arrayToImage(s,s.lctFlag?s.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(s)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const s={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(s.sentinel)){case"!":s.type="ext",this.parseExt(s);break;case",":s.type="img",this.parseImg(s);break;case";":s.type="eof",this._handler.eof&&this._handler.eof(s)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+s.sentinel.toString(16))}s.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(s,r)=>{var a,l,f,g;const m=document.createElement("canvas");m.width=s.width,m.height=s.height;const w=m.getContext("2d"),y=w.getImageData(0,0,m.width,m.height);let A=-1;!((a=this._gce)===null||a===void 0)&&a.transparentColorFlag&&(A=this._gce.transparentColorIndex);for(let D=0;D<s.pixels.length;D++){const L=s.pixels[D],O=r[L];L===A?y.data.set([0,0,0,0],D*4):y.data.set([...O,255],D*4)}if(w.putImageData(y,0,0),((l=this._gce)===null||l===void 0?void 0:l.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((f=this._gce)===null||f===void 0?void 0:f.disposalMethod)===2&&(!((g=this._hdr)===null||g===void 0)&&g.gctFlag)){const D=r[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${D[0]}, ${D[1]}, ${D[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(m,s.leftPos,s.topPos,s.width,s.height);const E=new Image;E.src=this._currentFrameCanvas.toDataURL(),this.images.push(E)},this._st=e,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class dm{constructor(e,s,{bustCache:r,...a}={}){this.path=e,this.family=s,this._isLoaded=!1,this._resource=new mr(e,"blob",r),this._options=a}async load(){if(this.isLoaded())return this.data;try{const e=await this._resource.load(),s=URL.createObjectURL(e);this.data||(this.data=new FontFace(this.family,`url(${s})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(e){throw`Error loading FontSource from path '${this.path}' with error [${e.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(e){return new nn({family:this.family,...this._options,...e})}}const Du=Su(),um=/^\s*(?:function)?\*/;function Fu(u){return typeof u!="function"?!1:um.test(Function.prototype.toString.call(u))?!0:Object.getPrototypeOf?Object.getPrototypeOf(u)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function Mu(...u){var e;const s=at.getInstance();let r,a,l,f;Fu(u[0])&&(a=globalThis,r=u[0],l=u[1]),Fu(u[1])&&(a=u[0],r=u[1],l=u[2]),u[1]instanceof si&&(a=u[0],f=u[1],r=u[2],l=u[3]),u[0]instanceof si&&(a=globalThis,f=u[0],r=u[1],l=u[2]);const g=Pu(Du),m=l?.timing,w=g?!1:(e=l?.autostart)!==null&&e!==void 0?e:!0;let y;try{y=f??si.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let A=!1,E=!1,D=!1;const L=r.bind(a),O=L();let q;const H=new Promise((J,Y)=>{q=$=>{try{if(D){E=!0,J();return}const{done:ot,value:Z}=Du.scope(!0,()=>O.next($));if(ot||D){E=!0,J();return}Z instanceof Promise?Z.then(()=>{y.clock.schedule(q,0,m)}):Z===void 0||Z===void 0?y.clock.schedule(q,0,m):y.clock.schedule(q,Z||0,m)}catch(ot){Y(ot);return}},w&&(A=!0,q(y.clock.elapsed()))}),N={isRunning:()=>A&&!D&&!E,isComplete:()=>E,cancel:()=>{D=!0},start:()=>(A?s.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(L)):(A=!0,q(y.clock.elapsed())),N),generator:O,done:H,then:H.then.bind(H),[Symbol.iterator]:()=>O};return N}class Jo extends He{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(e){var s,r,a,l;super(),this._logger=at.getInstance(),this.transform=new et,this.graphics=new se,this._completeFuture=new P,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=e.duration,this.easing=(s=e.easing)!==null&&s!==void 0?s:Vt.Linear,this.direction=(r=e.direction)!==null&&r!==void 0?r:"out",this.hideLoader=(a=e.hideLoader)!==null&&a!==void 0?a:!1,this.blockInput=(l=e.blockInput)!==null&&l!==void 0?l:!1,this.transform.coordPlane=Re.Screen,this.transform.pos=B.Zero,this.transform.z=1/0,this.graphics.anchor=B.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(e,s){this.complete||(this._currentDistance+=j(s/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=j(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=j(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(e){}onStart(e){}onUpdate(e){}onEnd(e){}onReset(){}reset(){this.started=!1,this._completeFuture=new P,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(e,s){const r=s;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),r.world.entityManager.getById(this.id))return this._co;this._engine=e,r.add(this);const a=this;return this._co=Mu(e,function*(){for(;!a.complete;){const l=yield;a.updateTransition(a._engine,l),a._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class fm extends Jo{constructor(e){var s,r;super({...e,duration:(s=e.duration)!==null&&s!==void 0?s:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(r=e.color)!==null&&r!==void 0?r:Q.Black}onInitialize(e){this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=new Er({width:e.screen.resolution.width,height:e.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=e}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class _m extends Jo{constructor(e){super({direction:"in",...e}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(e){this.image=await e.engine.screenshot(!0),await this.image.decode()}onInitialize(e){this.engine=e,this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=Ni.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=z(1/e.screen.pixelRatio,1/e.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class gm extends Jo{constructor(e){var s;super({direction:"in",...e}),this._easing=Vt.Linear,this.name=`Slide#${this.id}`,this.slideDirection=e.slideDirection,this.transform.coordPlane=Re.World,this.graphics.forceOnScreen=!0,this._easing=(s=e.easingFunction)!==null&&s!==void 0?s:this._easing,this._vectorEasing=Vt.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(e){this._image=await e.engine.screenshot(!0),await this._image.decode(),this._screenCover=Ni.fromHtmlImageElement(this._image).toSprite()}onInitialize(e){switch(this._engine=e,this.slideDirection){case"up":{this._directionOffset=z(0,-e.screen.resolution.height);break}case"down":{this._directionOffset=z(0,e.screen.resolution.height);break}case"left":{this._directionOffset=z(-e.screen.resolution.width,0);break}case"right":{this._directionOffset=z(e.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=z(1/e.screen.pixelRatio,1/e.screen.pixelRatio)}onUpdate(e){this._camera.pos=this._vectorEasing(e,this._destinationCameraPosition,this._startCameraPosition,1)}}class nl extends ee{constructor(e){super(),this.color=Q.Black,this.thickness=1;const{start:s,end:r,color:a,thickness:l}=e;this.start=s,this.end=r,this.color=a??this.color,this.thickness=l??this.thickness,this._localBounds=this._calculateBounds();const{width:f,height:g}=this._localBounds;this.width=f,this.height=g}get localBounds(){return this._localBounds}_calculateBounds(){const e=this.end.sub(this.start).normal(),s=this.thickness/2,r=[this.start.add(e.scale(s)),this.end.add(e.scale(s)),this.end.add(e.scale(-s)),this.start.add(e.scale(-s))];return ht.fromPoints(r)}_drawImage(e,s,r){e.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new nl({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class rl extends zn{get points(){return this._points}set points(e){this._points=e;const s=this.minPoint;this.width=this._points.reduce((r,a)=>Math.max(a.x,r),0)-s.x,this.height=this._points.reduce((r,a)=>Math.max(a.y,r),0)-s.y,this.flagDirty()}get minPoint(){const e=this._points.reduce((r,a)=>Math.min(a.x,r),1/0),s=this._points.reduce((r,a)=>Math.min(a.y,r),1/0);return z(e,s)}constructor(e){super(e),this._points=[],this.points=e.points,this.filtering=fe.Blended,this.rasterize()}clone(){return new rl({points:this.points.map(e=>e.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){if(this.points&&this.points.length){e.beginPath();const s=this.minPoint.negate(),r=this.points[0].add(s);e.moveTo(r.x,r.y),this.points.forEach(a=>{e.lineTo(a.x+s.x,a.y+s.y)}),e.lineTo(r.x,r.y),e.closePath(),this.color&&e.fill(),this.strokeColor&&e.stroke()}}}var vs;(function(u){u.Stretch="stretch",u.Tile="tile",u.TileFit="tile-fit"})(vs||(vs={}));class ol extends ee{constructor(e){super(e),this._logger=at.getInstance(),this._config=e,this._imgSource=e.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(e,s=!1){this._config.width=e,s&&this._initialize()}setTargetHeight(e,s=!1){this._config.height=e,s&&this._initialize()}setMargins(e,s,r,a,l=!1){this._config.sourceConfig.leftMargin=e,this._config.sourceConfig.topMargin=s,this._config.sourceConfig.rightMargin=r,this._config.sourceConfig.bottomMargin=a,l&&this._initialize()}setStretch(e,s,r=!1){e==="horizontal"?this._config.destinationConfig.horizontalStretch=s:e==="vertical"?this._config.destinationConfig.verticalStretch=s:(this._config.destinationConfig.horizontalStretch=s,this._config.destinationConfig.verticalStretch=s),r&&this._initialize()}getConfig(){return this._config}_drawTile(e,s,r,a,l,f,g){const m=f||0,w=g||0;let y,A,E,D;const L=this._getNumberOfTiles(s.width,r.x,a),O=this._getNumberOfTiles(s.height,r.y,l);for(let q=0;q<L;q++)for(let H=0;H<O;H++){let{tempSize:N,tempPosition:J}=this._calculateParams(q,L,s.width,r.x,this._config.destinationConfig.horizontalStretch);y=N,A=J,{tempSize:N,tempPosition:J}=this._calculateParams(H,O,s.height,r.y,this._config.destinationConfig.verticalStretch),E=N,D=J,e.drawImage(s,0,0,s.width,s.height,m+A,w+D,y,E)}}_drawImage(e,s,r){this._imgSource.isLoaded()?(this._drawTile(e,this._canvasA,new B(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(e,this._canvasB,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(e,this._canvasC,new B(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(e,this._canvasD,new B(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(e,this._canvasE,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasF,new B(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasG,new B(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasH,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasI,new B(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const e=this._canvasA.getContext("2d");e?.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const s=this._canvasB.getContext("2d");s?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const r=this._canvasC.getContext("2d");r?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const a=this._canvasD.getContext("2d");a?.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const l=this._canvasE.getContext("2d");l?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const f=this._canvasF.getContext("2d");f?.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const g=this._canvasG.getContext("2d");g?.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const m=this._canvasH.getContext("2d");m?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const w=this._canvasI.getContext("2d");w?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new ol(this._config)}_getNumberOfTiles(e,s,r){switch(r){case vs.Stretch:return 1;case vs.Tile:return Math.ceil(s/e);case vs.TileFit:return Math.ceil(s/e)}}_calculateParams(e,s,r,a,l){switch(l){case vs.Stretch:return{tempPosition:0,tempSize:a};case vs.Tile:return e===s-1?{tempPosition:e*r,tempSize:r-(s*r-a)}:{tempPosition:e*r,tempSize:r};case vs.TileFit:const f=a/s;return{tempPosition:e*f,tempSize:f}}}}class al extends Ri{constructor(e){super({...e,frames:e.animation.frames.slice(),strategy:e.animation.strategy,frameDuration:e.animation.frameDuration,speed:e.animation.speed,reverse:e.animation.isReversed}),this._ready=new P,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...e.sourceView},this._tiledWidth=e.width,this._tiledHeight=e.height;const s=[];for(let r=0;r<this.frames.length;r++){const a=this.frames[r].graphic;if(a&&a instanceof Ti){const l=new vr({image:a.image,width:e.width,height:e.height,sourceView:{...a.sourceView},wrapping:e.wrapping,filtering:e.filtering});this.frames[r].graphic=l,l.ready.then(()=>{l.sourceView={...l.sourceView,...this._sourceView}}),s.push(l.ready)}}Promise.all(s).then(()=>this._ready.resolve())}static fromAnimation(e,s){return new al({width:e.width,height:e.height,...s,animation:e})}_updateSourceView(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof Ti&&(s.sourceView={...s.sourceView,...this._sourceView})}}get sourceView(){return Pi(this._sourceView,()=>this._updateSourceView())}set sourceView(e){this._sourceView=Pi(e,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof Ti&&(s.sourceView.height=this._tiledHeight||s.height,s.destSize.height=this._tiledHeight||s.height,s.sourceView.width=this._tiledWidth||s.width,s.destSize.width=this._tiledWidth||s.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(e){this._tiledWidth=e,this._updateWidthHeight()}set height(e){this._tiledHeight=e,this._updateWidthHeight()}}const Bu=5,jn={},pm=()=>{for(const u in jn)jn[u]=0},Ko=(u,e)=>{const s=b.isEnabled("suppress-obsolete-message");jn[u]<Bu&&!s&&(at.getInstance().warn(u),console.trace&&e.showStackTrace&&console.trace()),jn[u]++};function mm(u){return u={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...u},function(e,s,r){if(r&&!(typeof r.value=="function"||typeof r.get=="function"||typeof r.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const l=`${`${e.name||""}${e.name&&s?".":""}${s||""}`} is marked obsolete: ${u.message}`+(u.alternateMethod?` Use ${u.alternateMethod} instead`:"");jn[l]||(jn[l]=0);const f=r?{...r}:e;if(!r){class g extends f{constructor(...w){Ko(l,u),super(...w)}}return g}return r&&r.value?(f.value=function(){return Ko(l,u),r.value.apply(this,arguments)},f):(r&&r.get&&(f.get=function(){return Ko(l,u),r.get.apply(this,arguments)}),r&&r.set&&(f.set=function(){return Ko(l,u),r.set.apply(this,arguments)}),f)}}class vm{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const e=new P;return this._queue.push(e),e.promise}dequeue(e){this._queue.shift().resolve(e)}}class wm{constructor(e){this._count=e,this._waitQueue=new vm}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(e=1){if(e!==0){for(;e!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),e--;this._count+=e}}}const hl="0.30.3";return x(),h})())}(pl)),pl.exports}/*! For license information please see excalibur-perlin.min.js.LICENSE.txt */var Ju;function q0(){return Ju||(Ju=1,function(d,t){(function(i,n){d.exports=n(X0())})(self,i=>(()=>{var n={"./src/perlin-noise.ts":(_,p,v)=>{v.r(p),v.d(p,{PerlinDrawer2D:()=>I,PerlinGenerator:()=>P});var x=v("excalibur");function b(M,R,T){return R+M*(T-R)}function S(M){return M*M*M*(M*(6*M-15)+10)}class P{constructor(R){var T,F,W,U;this._perm=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],this._p=new Uint8Array(512),this._defaultPerlinOptions={octaves:1,frequency:1,amplitude:1,persistance:.5},this.persistance=.5,this.amplitude=1,this.frequency=1,this.octaves=1,R={...this._defaultPerlinOptions,...R},this.persistance=(T=R.persistance)!==null&&T!==void 0?T:this.persistance,this.amplitude=(F=R.amplitude)!==null&&F!==void 0?F:this.amplitude,this.frequency=(W=R.frequency)!==null&&W!==void 0?W:this.frequency,this.octaves=(U=R.octaves)!==null&&U!==void 0?U:this.octaves,R.seed?this._random=new x.Random(R.seed):this._random=new x.Random,this._perm=this._random.shuffle(this._perm);for(let V=0;V<512;V++)this._p[V]=255&this._perm[V%256]}noise(){let R=this.amplitude,T=this.frequency,F=0,W=0;for(let U=0;U<this.octaves;U++){switch(arguments.length){case 1:F+=this._noise1d(arguments[0]*T)*R;break;case 2:F+=this._noise2d(arguments[0]*T,arguments[1]*T)*R;break;case 3:F+=this._noise3d(arguments[0]*T,arguments[1]*T,arguments[2]*T)*R;break;default:throw new Error("Invalid arguments for perlin noise")}W+=R,R*=this.persistance,T*=2}return F/W}sequence(R,T){T||(T=1/R);const F=new Array(R);for(let W=0;W<R;W++)F[W]=this.noise(W*T);return F}grid(R,T,F){F||(F=1/Math.min(R,T));const W=new Array(R*T);for(let U=0;U<T;U++)for(let V=0;V<R;V++)W[V+U*R]=this.noise(V*F,U*F);return W}_gradient3d(R,T,F,W){const U=15&R,V=U<8?T:F,j=U<4?F:U===12||U===14?T:W;return((1&U)==0?V:-V)+((2&U)==0?j:-j)}_gradient2d(R,T,F){const W=(1&R)==0?T:F;return(2&R)==0?-W:W}_gradient1d(R,T){return(1&R)==0?-T:T}_noise1d(R){const T=255&Math.floor(R);return(b(S(R-=Math.floor(R)),this._gradient1d(this._p[T],R),this._gradient1d(this._p[T+1],R-1))+1)/2}_noise2d(R,T){const F=255&Math.floor(R),W=255&Math.floor(T);R-=Math.floor(R),T-=Math.floor(T);const U=S(R),V=S(T),j=this._p[F]+W,X=this._p[F+1]+W;return(b(V,b(U,this._gradient2d(this._p[j],R,T),this._gradient2d(this._p[X],R-1,T)),b(U,this._gradient2d(this._p[j+1],R,T-1),this._gradient2d(this._p[X+1],R-1,T-1)))+1)/2}_noise3d(R,T,F){const W=255&Math.floor(R),U=255&Math.floor(T),V=255&Math.floor(F);R-=Math.floor(R),T-=Math.floor(T),F-=Math.floor(F);const j=S(R),X=S(T),rt=S(F),lt=this._p[W]+U,xt=this._p[W+1]+U,mt=this._p[lt]+V,Ct=this._p[xt]+V,Rt=this._p[lt+1]+V,B=this._p[xt+1]+V;return(b(rt,b(X,b(j,this._gradient3d(this._p[mt],R,T,F),this._gradient3d(this._p[Ct],R-1,T,F)),b(j,this._gradient3d(this._p[Rt],R,T-1,F),this._gradient3d(this._p[B],R-1,T-1,F))),b(X,b(j,this._gradient3d(this._p[mt+1],R,T,F-1),this._gradient3d(this._p[Ct+1],R-1,T,F-1)),b(j,this._gradient3d(this._p[Rt+1],R,T-1,F-1),this._gradient3d(this._p[B+1],R-1,T-1,F-1))))+1)/2}}class I{constructor(R,T){this.generator=R,this.colorFcn=F=>F<.5?x.Color.Black:x.Color.White,T&&(this.colorFcn=T)}image(R,T){const F=document.createElement("img"),W=document.createElement("canvas");W.width=R,W.height=T;const U=W.getContext("2d");return this.draw(U,0,0,R,T),F.src=W.toDataURL(),F}draw(R,T,F,W,U){const V=this.generator.grid(W,U),j=R.getImageData(T,F,W,U);for(let X=0;X<U;X++)for(let rt=0;rt<W;rt++){const lt=4*(rt+X*j.width),xt=V[rt+W*X],mt=this.colorFcn(xt);j.data[lt]=mt.r,j.data[lt+1]=mt.g,j.data[lt+2]=mt.b,j.data[lt+3]=Math.floor(255*mt.a)}R.putImageData(j,T,F)}}},excalibur:_=>{_.exports=i}},o={};function h(_){var p=o[_];if(p!==void 0)return p.exports;var v=o[_]={exports:{}};return n[_](v,v.exports,h),v.exports}h.n=_=>{var p=_&&_.__esModule?()=>_.default:()=>_;return h.d(p,{a:p}),p},h.d=(_,p)=>{for(var v in p)h.o(p,v)&&!h.o(_,v)&&Object.defineProperty(_,v,{enumerable:!0,get:p[v]})},h.o=(_,p)=>Object.prototype.hasOwnProperty.call(_,p),h.r=_=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(_,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(_,"__esModule",{value:!0})};var c={};return(()=>{h.r(c),h.d(c,{PerlinDrawer2D:()=>_.PerlinDrawer2D,PerlinGenerator:()=>_.PerlinGenerator});var _=h("./src/perlin-noise.ts")})(),c})())}(gl)),gl.exports}var Y0=q0();const j0=new Y0.PerlinGenerator({seed:Date.now(),octaves:3,frequency:24,amplitude:.91,persistance:.95}),Xs=new Aw({pos:nt(0,0),tileWidth:64,tileHeight:32,columns:25,rows:25});let Z0=[Qi.getSprite(0,0),Qi.getSprite(1,0),Qi.getSprite(2,0),Qi.getSprite(3,0),Qi.getSprite(4,0),Qi.getSprite(5,0),Qi.getSprite(6,0),Qi.getSprite(0,1),Qi.getSprite(1,1),Qi.getSprite(2,1)],ml=0;for(const d of Xs.tiles){if(Sg(ml,Xs.columns,Xs.rows)){if(d.x==0){let t=new Ys({useAnchor:!0,members:[{graphic:sa.getSprite(0,0),offset:nt(0,16)},{graphic:Tt.tree.toSprite(),offset:nt(-6,-24)}]});d.addGraphic(t)}else if(d.y==0&&d.x!=0||d.y==Xs.rows-1&&d.x!=0){const t=Tt.fence.toSprite();let i=new Ys({useAnchor:!0,members:[{graphic:sa.getSprite(0,0),offset:nt(0,-32)},{graphic:t,offset:nt(0,-32)}]});d.addGraphic(i)}else{let t=new Ys({useAnchor:!0,members:[{graphic:sa.getSprite(0,0),offset:nt(0,-32)}]});d.addGraphic(t)}d.solid=!0,d.addCollider(Pw.Polygon([nt(0,17),nt(32,1),nt(63,17),nt(32,33)]))}else{let t=sa.getSprite(0,0);const n=j0.grid(Xs.columns,Xs.rows)[ml];let o=new gr;if(n>.55){const h=o.pickOne(Z0);let c=o.integer(16,32),_=-32,p=new Ys({useAnchor:!0,members:[{graphic:t,offset:nt(0,-32)},{graphic:h,offset:nt(c,_)}]});d.addGraphic(p)}else{let h=new Ys({useAnchor:!0,members:[{graphic:t,offset:nt(0,-32)}]});d.addGraphic(h)}}ml++}Xs.updateColliders();const Gs=150,Q0=new Ue({strategy:ze.Loop,frames:[{graphic:Ns.getSprite(0,0),duration:Gs},{graphic:Ns.getSprite(1,0),duration:Gs},{graphic:Ns.getSprite(2,0),duration:Gs},{graphic:Ns.getSprite(3,0),duration:Gs},{graphic:Ns.getSprite(4,0),duration:Gs},{graphic:Ns.getSprite(5,0),duration:Gs},{graphic:Ns.getSprite(6,0),duration:Gs},{graphic:Ns.getSprite(7,0),duration:Gs}]});class J0 extends xi{engine;scaleAnimation;lightEnemiesScore;darkEnemiesScore;blessingsScore;soulsScore;swordPlayerScore;bowPlayerScore;totalEnemies;totalEnemiesRemoved;myWidth;heartButton;flexButton;clockButton;uiData;constructor(t){let i=t.screen.contentArea,n=i.right-i.left-20,o=i.bottom-i.top-20,h=new yt(10,10);super({width:n,height:o,pos:h,color:Wt.fromHex("#444444"),z:9e3}),this.myWidth=n,this.uiData={lightEnemiesDefeated:0,darkEnemiesDefeated:0},this.engine=t;class c extends xi{constructor(){super({pos:nt(n/2-24,15),x:n/2,width:48,height:48,z:2002}),this.graphics.use(Q0)}}this.scaleAnimation=new c,this.addChild(this.scaleAnimation),new As({pos:nt(24,45),text:"0",font:new ys({family:"Arial",size:24,color:Wt.White,textAlign:Cs.Center})}),this.darkEnemiesScore=$i.create(nt(80,47),"0"),this.lightEnemiesScore=$i.create(nt(150,47),"0"),this.blessingsScore=$i.create(nt(80,88),"0"),this.soulsScore=$i.create(nt(150,88),"0"),this.swordPlayerScore=$i.create(nt(80,125),"0"),this.bowPlayerScore=$i.create(nt(150,125),"0"),this.totalEnemies=$i.create(nt(80,165),"0"),this.totalEnemiesRemoved=$i.create(nt(150,165),"0"),this.addChild(this.lightEnemiesScore),this.addChild(this.darkEnemiesScore),this.addChild(this.blessingsScore),this.addChild(this.soulsScore),this.addChild(this.swordPlayerScore),this.addChild(this.bowPlayerScore),this.addChild(this.totalEnemies),this.addChild(this.totalEnemiesRemoved),this.addChild(Ki.create(nt(110,45),Aa.getSprite(1,0),nt(.75,.75))),this.addChild(Ki.create(nt(40,45),Aa.getSprite(0,0),nt(.75,.75))),this.addChild(Ki.create(nt(44,90),Tt.blessing.toSprite(),nt(1.4,1.4))),this.addChild(Ki.create(nt(115,90),Tt.soul.toSprite(),nt(1.4,1.4))),this.addChild(Ki.create(nt(21,105),Qn.getSprite(0,0),nt(1,1))),this.addChild(Ki.create(nt(105,119),Gr.getSprite(0,0),nt(1,1))),this.addChild(Ki.create(nt(38,165),Xe.getSprite(0,0),nt(.75,.75))),this.addChild(Ki.create(nt(108,160),Tt.swordPlayerIconDamaged.toSprite(),nt(.6,.6)))}show(t,i){this.uiData.lightEnemiesDefeated=i.lightEnemiesDefeated,this.uiData.darkEnemiesDefeated=i.darkEnemiesDefeated,t.add(this)}hide(t){t.remove(this)}onAdd(t){this.clockButton=new vl(Tt.clock.toSprite(),nt(this.myWidth-75,155),()=>{console.log("clock")}),this.addChild(this.clockButton),this.heartButton=new vl(Tt.heart.toSprite(),nt(this.myWidth-75,45),()=>{console.log("heart")}),this.addChild(this.heartButton),this.flexButton=new vl(Tt.flex.toSprite(),nt(this.myWidth-75,100),()=>{console.log("flex")}),this.addChild(this.flexButton)}handleTouchControls(t){const i=t.rawEvent.coordinates.screenPos;t.rawEvent.type=="up"?this.heartButton?.contains(i.x,i.y)?this.heartButton.onUp():this.flexButton?.contains(i.x,i.y)?this.flexButton.onUp():this.clockButton?.contains(i.x,i.y)&&this.clockButton.onUp():t.rawEvent.type=="down"&&(this.heartButton?.contains(i.x,i.y)?this.heartButton.onDown():this.flexButton?.contains(i.x,i.y)?this.flexButton.onDown():this.clockButton?.contains(i.x,i.y)&&this.clockButton.onDown())}onInitialize(t){}}class Ki extends xi{constructor(t,i,n){super({pos:t}),n&&(this.scale=n),this.graphics.use(i)}static create(t,i,n){return new Ki(t,i,n)}}class $i extends As{constructor(t,i){super({pos:t,text:i,font:new ys({family:"Arial",size:20,color:Wt.White,textAlign:Cs.Center})})}static create(t,i){return new $i(t,i)}}class vl extends xi{constructor(t,i,n){super({width:80,height:48,pos:i,z:2002,anchor:yt.Half,color:Wt.fromHex("#2bb2ea")}),this.callback=n,this.pointer.useGraphicsBounds=!1,this.pointer.useColliderShape=!0,this.icon=t;const o={width:80,height:48,source:Tt.buttonUp,sourceConfig:{width:192,height:64,leftMargin:3,rightMargin:3,topMargin:2,bottomMargin:4},destinationConfig:{drawCenter:!0,horizontalStretch:ia.Stretch,verticalStretch:ia.Stretch}};this.upGraphic=new Yu(o),this.upGraphicGroup=new Ys({useAnchor:!0,members:[this.upGraphic,{graphic:t,offset:nt(22,8)}]}),this.graphics.use(this.upGraphicGroup);const h={width:80,height:48,source:Tt.buttonDown,sourceConfig:{width:192,height:64,leftMargin:3,rightMargin:3,topMargin:2,bottomMargin:2},destinationConfig:{drawCenter:!0,horizontalStretch:ia.Stretch,verticalStretch:ia.Stretch}};this.downGraphic=new Yu(h),this.downGraphicGroup=new Ys({useAnchor:!0,members:[this.downGraphic,{graphic:t,offset:nt(22,8)}]})}upGraphic;downGraphic;icon;upGraphicGroup;downGraphicGroup;subUp;subDown;onInitialize=t=>{};onDown(){this.graphics.use(this.downGraphicGroup)}onUp(){this.scene.hideEndOfWaveModal(),this.graphics.use(this.upGraphicGroup)}onAdd(t){}onRemove(t){}}class K0 extends xi{constructor(t){super({name:"StatusBar",width:t.x,height:15,x:0,y:1,z:999}),this.dims=t,this.updateSignal.listen(this.UIUpdate.bind(this)),this.lightKillsLabel=new As({anchor:yt.Zero,text:"0",font:new ys({size:8,family:"Arial",color:Wt.White,textAlign:Cs.Center}),x:t.x-58,y:1}),this.darkKillsLabel=new As({anchor:yt.Zero,text:"0",font:new ys({size:8,family:"Arial",color:Wt.White,textAlign:Cs.Center}),x:t.x-84,y:1}),this.enemiesRemainingLabel=new As({anchor:yt.Zero,text:"0",font:new ys({size:8,family:"Arial",color:Wt.White,textAlign:Cs.Center}),x:t.x-110,y:1}),this.soulsCollectedLabel=new As({anchor:yt.Zero,text:"0",font:new ys({size:8,family:"Arial",color:Wt.White,textAlign:Cs.Center}),x:t.x-36,y:1}),this.blessingsCollectedLabel=new As({anchor:yt.Zero,text:"0",font:new ys({size:8,family:"Arial",color:Wt.White,textAlign:Cs.Center}),x:t.x-12,y:1}),this.addChild(this.lightKillsLabel),this.addChild(this.darkKillsLabel),this.addChild(this.enemiesRemainingLabel),this.addChild(this.soulsCollectedLabel),this.addChild(this.blessingsCollectedLabel);class i extends xi{constructor(o,h,c){super({pos:o,width:10,height:10,z:999}),this.graphics.use(h),c&&(this.scale=c)}}this.addChild(new i(new yt(t.x-25,0),Tt.blessing.toSprite())),this.addChild(new i(new yt(t.x-50,0),Tt.soul.toSprite())),this.addChild(new i(new yt(t.x-125,0),Xe.getSprite(0,0),new yt(.4,.4))),this.addChild(new i(new yt(t.x-75,0),Aa.getSprite(0,0),new yt(.4,.4))),this.addChild(new i(new yt(t.x-100,0),Aa.getSprite(1,0),new yt(.4,.4)))}totalEnemiesDefeated=0;totalEnemiesRemaining=0;totalEnemiesRemoved=0;lightEnemiesDefeated=0;darkEnemiesDefeated=0;soulsCollected=0;blessingsCollected=0;updateSignal=new gi("stateUpdate");enemiesInWave=0;enemiesRemainingLabel;lightKillsLabel;darkKillsLabel;soulsCollectedLabel;blessingsCollectedLabel;onPreUpdate(t,i){this.enemiesRemainingLabel.text=`${this.totalEnemiesRemaining}`,this.lightKillsLabel.text=`${this.lightEnemiesDefeated}`,this.darkKillsLabel.text=`${this.darkEnemiesDefeated}`,this.soulsCollectedLabel.text=`${this.soulsCollected}`,this.blessingsCollectedLabel.text=`${this.blessingsCollected}`}UIUpdate(t){const[i,n]=t.detail.params;i==="enemyDefeated"?(n==="light"&&(this.lightEnemiesDefeated+=1),n==="dark"&&(this.darkEnemiesDefeated+=1),this.totalEnemiesDefeated=this.lightEnemiesDefeated+this.darkEnemiesDefeated+this.totalEnemiesRemoved,this.totalEnemiesRemaining=this.enemiesInWave-this.totalEnemiesDefeated):i=="soul"?this.soulsCollected++:i=="blessing"?this.blessingsCollected++:i=="batchsize"?(console.log("batchsize",n),this.enemiesInWave=n,this.totalEnemiesDefeated=0,this.totalEnemiesRemoved=0,this.lightEnemiesDefeated=0,this.darkEnemiesDefeated=0,this.totalEnemiesRemaining=this.enemiesInWave-this.totalEnemiesDefeated):i=="playerDamaged"&&(this.totalEnemiesRemoved++,this.totalEnemiesDefeated=this.lightEnemiesDefeated+this.darkEnemiesDefeated+this.totalEnemiesRemoved,this.totalEnemiesRemaining=this.enemiesInWave-this.totalEnemiesDefeated)}getUIState(){return{lightEnemiesDefeated:this.lightEnemiesDefeated,darkEnemiesDefeated:this.darkEnemiesDefeated,soulsCollected:this.soulsCollected,blessingsCollected:this.blessingsCollected,enemiesInWave:this.enemiesInWave,enemiesRemoved:this.totalEnemiesRemoved}}}class $0{scene;_isModalShowing=!1;_gestureStartPos=yt.Zero;_currentPos=yt.Zero;_moveDelta=yt.Zero;_lastDirection={x:0,y:0};_isActive=!1;_isDown=!1;_lastEvent=null;_updateInterval=null;_lastState="idle";_controlMap=new Map;_activeTouchReceiver=null;constructor(t){this.scene=t}initialize(t){const i=this.scene.engine;this._controlMap=t,i.input.pointers.primary.on("down",n=>this.onDown(n)),i.input.pointers.primary.on("up",n=>this.onUp(n)),i.input.pointers.primary.on("move",n=>this.onMove(n))}set activeTouchReceiver(t){this._activeTouchReceiver=t}get activeTouchReceiver(){return this._activeTouchReceiver}set modalShowing(t){this._isModalShowing=t}get modalShowing(){return this._isModalShowing}register(){}onDown(t){this._isModalShowing?(this._lastEvent=t,this.notifyJoystickChange("active",nt(0,0)),this._isDown=!0):(this._gestureStartPos=t.worldPos.clone(),this._currentPos=t.worldPos.clone(),this._moveDelta=yt.Zero,this._lastDirection={x:0,y:0},this._isActive=!0,this._isDown=!0,this._lastEvent=t,this.clearUpdateInterval(),this._updateInterval=window.setInterval(()=>{this.processJoystickState()},50))}onUp(t){this._isDown&&(console.log("tc up, activeTouchReceiver",this._activeTouchReceiver),this._isDown=!1,this._isActive=!1,this._moveDelta=yt.Zero,this._lastDirection={x:0,y:0},this._lastEvent=t,this.clearUpdateInterval(),this.notifyJoystickChange("idle"))}onMove(t){if(this._isDown&&(this._currentPos=t.worldPos.clone(),this._moveDelta=this._currentPos.sub(this._gestureStartPos),this._lastEvent=t,this._lastState==="active")){const i=this._moveDelta.magnitude;if(i>=15){const n={x:this._moveDelta.x/i,y:this._moveDelta.y/i};if(Math.abs(this._lastDirection.x)>.01||Math.abs(this._lastDirection.y)>.01){const o=this._lastDirection.x*n.x+this._lastDirection.y*n.y;if(Math.acos(Math.max(-1,Math.min(1,o)))*(180/Math.PI)>90){const c=Math.min(i,50),_=new yt(n.x*c,n.y*c);this._gestureStartPos=this._currentPos.sub(_),this._moveDelta=_,this._lastDirection=n}}}}}clearUpdateInterval(){this._updateInterval&&(window.clearInterval(this._updateInterval),this._updateInterval=null)}processJoystickState(){if(!this._isDown||!this._isActive)return;const t=this._moveDelta.magnitude;let i="idle";t>=15&&(i="active");const n=Math.min(t,15);let o={x:0,y:0};t>0&&(o={x:this._moveDelta.x/t,y:this._moveDelta.y/t},this._lastDirection=o),(i!==this._lastState||i==="active")&&this.notifyJoystickChange(i,o,n),this._lastState=i}notifyJoystickChange=(t,i={x:0,y:0},n=0)=>{if(!this._activeTouchReceiver)return;let o=this._controlMap.get(this._activeTouchReceiver);o&&(console.log(this._lastEvent),o({direction:i,distance:n,state:t,rawEvent:this._lastEvent||void 0}))}}class tx extends H_{arena;darkPlayer;lightPlayer;statusBar;sceneTouchManger;burnDown;enemyWaveManager;gameState={waveNumber:0,enemiesRemaining:0,darkEnemiesDefeated:0,lightEnemiesDefeated:0,darkExp:0,lightExp:0,gameDuration:0};stateSignal=new gi("stateUpdate");pauseGameSignal=new gi("pauseGame");endOfWaveModal;touchMap=new Map;constructor(){super()}onActivate(t){this.arena=Xs,this.add(this.arena),this.darkPlayer=new Nl,this.add(this.darkPlayer),this.darkPlayer.pos=L0(this.arena),this.lightPlayer=new Cg,this.add(this.lightPlayer),this.darkPlayer.registerPartner(this.lightPlayer),this.lightPlayer.registerPartner(this.darkPlayer),this.endOfWaveModal=new J0(t.engine),this.touchMap.set("darkPlayer",this.darkPlayer.joystickCallback),this.touchMap.set("lightPlayer",this.lightPlayer.joystickCallback),this.touchMap.set("UImodal",o=>{this.endOfWaveModal?.handleTouchControls(o)}),this.sceneTouchManger=new $0(this),this.sceneTouchManger.initialize(this.touchMap),this.sceneTouchManger.activeTouchReceiver="darkPlayer",this.enemyWaveManager=new G0(this,this.lightPlayer,this.darkPlayer,this.arena),this.enemyWaveManager?.init();const i=this.engine.screen.contentArea.width,n=this.engine.screen.contentArea.height;this.statusBar=new K0(nt(i,n)),this.add(this.statusBar),this.stateSignal.listen(this.stateUpdate.bind(this)),this.burnDown=new V0(nt(i,10),nt(0,n-12),60,this),this.add(this.burnDown),this.enemyWaveManager?.startWave()}onDeactivate(t){this.darkPlayer?.kill(),this.lightPlayer?.kill(),this.enemyWaveManager?.endWave()}onPreUpdate(t,i){this.enemyWaveManager?.update(i)}stateUpdate(t){const[i,n]=t.detail.params;this.gameState[i]=n}showEndOfWaveModal(){this.darkPlayer.vel=nt(0,0),this.lightPlayer.vel=nt(0,0),this.sceneTouchManger.activeTouchReceiver="UImodal",this.sceneTouchManger.modalShowing=!0,setTimeout(()=>this.endOfWaveModal?.show(this,this.statusBar.getUIState()),500)}hideEndOfWaveModal(){this.endOfWaveModal?.hide(this),this.sceneTouchManger.modalShowing=!1,this.enemyWaveManager?.startWave(),(this.darkPlayer?.isPlayerActive?this.darkPlayer:this.lightPlayer)instanceof Nl?this.sceneTouchManger.activeTouchReceiver="darkPlayer":this.sceneTouchManger.activeTouchReceiver="lightPlayer"}switchPlayerFocus(){this.darkPlayer?.isPlayerActive&&!this.lightPlayer?.isPlayerActive?(this.darkPlayer.isPlayerActive=!1,this.lightPlayer.isPlayerActive=!0,this.camera.strategy.lockToActor(this.lightPlayer)):(this.darkPlayer.isPlayerActive=!0,this.lightPlayer.isPlayerActive=!1,this.camera.strategy.lockToActor(this.darkPlayer))}}class ex extends xi{buttonText;upGraphic;downGraphic;constructor(t){super({width:192,height:64,pos:t}),this.buttonText=new As({text:"START",pos:nt(192/2,16),font:new ys({width:192,height:64,family:"Arial",size:36,color:Wt.White,textAlign:Cs.Center})}),this.addChild(this.buttonText),this.upGraphic=Tt.buttonUp.toSprite(),this.downGraphic=Tt.buttonDown.toSprite()}onInitialize(t){this.graphics.use(this.upGraphic),this.on("pointerup",()=>{this.graphics.use(this.upGraphic),t.goToScene("game"),this.buttonText.pos=this.buttonText.pos.add(nt(0,-4))}),this.on("pointerdown",()=>{this.graphics.use(this.downGraphic),this.buttonText.pos=this.buttonText.pos.add(nt(0,4))})}}class ix extends xi{title;constructor(t){let i=t.right-t.left-20,n=t.bottom-t.top-20,o=new yt(10,10);super({width:i,height:n,pos:o,color:Wt.fromHex("#005465")}),this.title=new As({width:i,height:n/4,pos:nt(0,0),text:"Angels 'n Demons",font:new ys({family:"Arial",size:36,color:Wt.White,textAlign:Cs.Center})}),this.title.pos=nt(i/2,n/4),this.addChild(this.title),this.addChild(new ex(nt(i/2-192/2,n*.55)))}onInitialize(t){}}class sx extends H_{starintModal;constructor(){super()}onActivate(t){this.starintModal=new ix(t.engine.screen.contentArea),this.add(this.starintModal)}onDeactivate(t){}}await bt.create(document.body,Tw,Ew).attached;const Pg=new yw({resolution:{width:640,height:360},viewport:{width:640,height:360},canvasElementId:"cnv",displayMode:bw.FitScreenAndZoom,pixelArt:!0,backgroundColor:Wt.fromHex("#26111f"),scenes:{intro:{scene:new sx},game:{scene:new tx}},pixelRatio:2});await Pg.start(V_);Pg.goToScene("intro");
