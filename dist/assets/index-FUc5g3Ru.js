(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const h of o)if(h.type==="childList")for(const c of h.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function i(o){const h={};return o.integrity&&(h.integrity=o.integrity),o.referrerPolicy&&(h.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?h.credentials="include":o.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function n(o){if(o.ep)return;o.ep=!0;const h=i(o);fetch(o.href,h)}})();class Rs{constructor(){this.state="created",this.host=null,this.bindings=[],this.views=[],this.animations=[],this.animationQueue=[],this.destroyed="",this.moved=""}static create(t,i={},n,o={parent:null,prepare:!0,sibling:null}){const h=new Rs;if(h.model=i,h.element=n??t,h.parent=o.parent??Ct,h.host=o.host??h.parent.host,h.sibling=o.sibling??null,n instanceof HTMLTemplateElement||n?.tagName==="TEMPLATE"){const c=n.content.cloneNode(!0);if(c.children.length===1)return Ct.create(t,i,c.firstElementChild,o);h.views=[...c.children].map(_=>Ct.create(t,i,_,{...o,parent:h})),h.state="rendered"}else h.bindings.push(...Ct.parse(h.element,i,h,o.parent));return h.parentElement=n!=null?t:t.ownerDocument.documentElement,h.views.length>1?(h.attached=Promise.all(h.views.map(c=>c.attached)),h.detached=Promise.all(h.views.map(c=>c.detached))):(h.attached=new Promise(c=>{h.t=c}),h.detached=new Promise(c=>{h.i=c})),h}get lastElement(){return this.render==null&&(this.render=!(this.element.hasAttribute?.("PUI-UNRENDERED")??!1)),this.render?this.element:this.bindings.flatMap(n=>n.views).slice(-1)[0]?.lastElement}destroy(){this.views.forEach(t=>t.destroy()),this.element.classList?.add("pui-removing"),this.destroyed="queue",Ct.destroyed.push(this)}terminate(){Promise.all(this.getAnimations()).then(()=>{const t=this.element.parentElement;t?.removeChild(this.element),this.i?.(),this.dispatchEvent(t,"removed"),this.bindings.forEach(n=>n.unbind());const i=this.parent.views.findIndex(n=>n===this);i>-1&&this.parent.views.splice(i,1)}),this.destroyed="destroyed"}move(t){this.moved="queue",this.element.classList?.add("pui-moving"),this.sibling=t}play(t,i){return typeof t=="string"&&(t=this.animations.find(n=>n.name===t).clone()),t.element=i,t.state="pending",this.animationQueue.push(t),this.updateAnimations(performance.now()),t}updateFromUI(){this.views.forEach(t=>t.updateFromUI()),this.bindings.forEach(t=>t.updateFromUI())}updateToUI(){const t=this.state==="created";switch(t||(this.views.forEach(i=>i.updateToUI()),this.bindings.forEach(i=>i.updateToUI())),this.state){case"created":if(this.element.classList?.add("pui-adding"),this.render=!(this.element.hasAttribute?.("PUI-UNRENDERED")??!1),this.render){const i=this.parent?.parent;let o=(i?.render??!1?this.sibling:i?.sibling)??null;o=(o instanceof Rs?o.lastElement:o)??null;const h=this.parentElement??Ct.parentElement(this.element,this.parent);h.insertBefore(this.element,o?.nextSibling??null),this.dispatchEvent(h,"added")}this.t(),this.state="attaching";break;case"attaching":this.getAnimations(!1).length===0&&(this.element.classList?.remove("pui-adding"),this.state="attached");break;case"attached":this.state="rendered";break}t&&(this.views.forEach(i=>i.updateToUI()),this.bindings.forEach(i=>i.updateToUI()))}updateAtEvents(){this.views.forEach(t=>t.updateAtEvents()),this.bindings.forEach(t=>t.updateAtEvents())}updateAnimations(t){for(;this.animationQueue[0]?.state==="finished";)this.animationQueue.shift().destroy();for(let i=0;i<this.animationQueue.length;i++){const n=this.animationQueue[i];n.state==="pending"&&(n.isBlocked(t)||(n.state="playing",n.startTime=t,n.animation=n.element.animate(n.keyframes,n.options),n.finished=n.animation.finished,n.finished.then(()=>{n.state="finished",this.updateAnimations(performance.now())})))}}updateMove(){switch(this.moved){case"queue":this.moved="move";break;case"move":if(this.getAnimations().length===0){const t=this.parentElement??Ct.parentElement(this.element,this.parent);let i=(this.sibling instanceof Rs?this.sibling.lastElement:this.sibling)??null;if(this.render)t.insertBefore(this.element,i?.nextSibling??null);else{const n=this.bindings.flatMap(o=>o.views);for(const o of n)t.insertBefore(o.element,i?.nextSibling??null),i=o.element}this.element.classList?.remove("pui-moving"),this.moved="",this.sibling=null}break}this.bindings.forEach(t=>t.updateMove()),this.views.forEach(t=>t.updateMove())}getAnimations(t=!0){return(this.element.getAnimations?.({subtree:t})??[]).filter(i=>i.playState!=="finished"&&i.effect?.getTiming().iterations!==1/0).map(i=>i.finished)}dispatchEvent(t,i){if(t!=null){const n=new CustomEvent(`pui-${i}`,{detail:{model:this.model.$model??this.model,context:this.model,element:this.element,view:this},bubbles:!0,cancelable:!0});t.dispatchEvent(n)}}}class Zl{constructor(){this.fromUI=!1,this.toUI=!0,this.atEvent=!1,this.oneTime=!1,this.views=[],this.firstUpdate=!0,this.events=[],this.triggerAtEvent=t=>{t.type==="change"?this.events.push(t):Ct.resolveValue(this.object,this.property).call(this.object.$model,t,this.object.$model,this.element,this.attribute,this.object)},this.twoWayBindingEvent=t=>{const{target:i,property:n}=Ct.resolveProperty(this.object,this.property),o=t.detail;if(o!==this.lastUIValue){let h=o;h!==void 0&&h!==this.lastValue&&Ct.resolveValue(this.object,this.property)==="number"&&!isNaN(h)&&(h=+h),i[n]=h}},this.id=++Ct.id}get element(){return this.$element==null&&(this.$element=typeof this.selector=="string"?this.context.querySelector(this.selector):this.selector),this.$element}set element(t){this.$element=t}static create(t){const i=new Zl,n=t.property?.split(":")??[],o=n.shift(),h=typeof t.attribute!="boolean"?(t.attribute??"innerText").split(":"):[],c=typeof t.attribute!="boolean"?h.shift():t.attribute;if(i.parent=t.parent??Ct,i.object="$model"in t.object?t.object:{$model:t.object},i.object.$parent==null){const _=i.parent.parent?.object?.$parent;_!=null&&(i.object.$parent=_)}return i.property=o,i.propertyArguments=n,i.context=t.context??document,i.selector=t.selector,i.attribute=c,i.attributeArguments=h,i.value=t.value??i.value,i.template=t.template??i.template,i.fromUI=t.fromUI??i.fromUI,i.toUI=t.toUI??i.toUI,i.atEvent=t.atEvent??i.atEvent,i.oneTime=t.oneTime??i.oneTime,i.addListener(),typeof i.fromUI!="boolean"&&(i.fromUI=i.fromUI.bind(i)),typeof i.toUI!="boolean"&&(i.toUI=i.toUI.bind(i)),i}destroy(){this.element=null,this.removeListener(),this.views.forEach(t=>t.destroy())}unbind(){Ct.unbind(this)}addListener(){this.atEvent&&(this.toUI=!1,this.fromUI=!1,this.element.addEventListener(this.attribute,this.triggerAtEvent)),this.toUI&&this.fromUI&&customElements.get(this.element.tagName.toLowerCase())!=null&&this.element.addEventListener(this.attribute,this.twoWayBindingEvent)}removeListener(){this.atEvent&&this.element.removeEventListener(this.attribute,this.triggerAtEvent),this.toUI&&this.fromUI&&customElements.get(this.element.tagName.toLowerCase())!=null&&this.element.removeEventListener(this.attribute,this.twoWayBindingEvent)}updateFromUI(){if(this.fromUI===!1||this.firstUpdate){this.firstUpdate=!1,this.views.forEach(o=>o.updateFromUI());return}const{target:t,property:i}=Ct.resolveProperty(this.element,this.attribute),n=t[i];if(n!==this.lastUIValue){let o=this.fromUI!==!0?this.fromUI(n,this.lastUIValue,this.property,this.object):n;if(this.lastUIValue=n,o!==void 0&&o!==this.lastValue){this.lastValue=o;const{target:h,property:c}=Ct.resolveProperty(this.object,this.property);Ct.resolveValue(this.object,this.property)==="number"&&!isNaN(o)&&(o=+o),h[c]=o}else this.lastValue=o;this.parent.host?.dispatchEvent(new CustomEvent(i,{detail:o}))}this.views.forEach(o=>o.updateFromUI())}updateToUI(){if(this.toUI===!1){this.views.forEach(i=>i.updateToUI());return}let t=Ct.resolveValue(this.object,this.property);if(this.template!=null)if(this.template instanceof HTMLElement)if(typeof this.attribute=="boolean"){if(t=(t??!1)!==!1,t!==this.lastValue){const i=this.toUI!==!0?this.toUI(t,this.lastValue,this.property,this.object,this.value):t;i!==void 0&&i!==this.lastUIValue&&(i===this.attribute?this.views.push(Rs.create(this.element.parentElement,this.object,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:this.element})):this.views.pop()?.destroy(),this.lastValue=t,this.lastUIValue=i)}}else{let i=!1,n=!1;t==null&&(t=[]);const o=this.propertyArguments[0],h=this.lastValue??[];if(t.length!==h.length)i=!0;else for(let b=0,S=t.length;b<S;b++){let P,I;o==null?t[b]!==h[b]&&(i=!0,n=!0):(P=Ct.resolveValue(t[b]??{},o),I=Ct.resolveValue(h[b]??{},o),P!==I&&(i=!0),t[b]!==h[b]&&(n=!0))}if(!i)if(n){const b=this.toUI!==!0?this.toUI(t,h,this.property,this.object,this.value):t;return this.updateViews(t,b)}else return this.updateViews();const c=this.toUI!==!0?this.toUI(t,h,this.property,this.object,this.value):t;if(c==null)return this.updateViews();const _=this.lastUIValue??[];let p=0;for(let b=0,S=c.length,P=0;b<S;b++,P++){let I,F;if(o==null?(I=c[b],F=_[P]):(I=Ct.resolveValue(c[b]??{},o),F=Ct.resolveValue(_[P]??{},o)),I===F)p++;else break}if(p===c.length&&c.length===_.length)return this.updateViews(t,c);const v=this.views.splice(0,p);let x=v[v.length-1];for(let b=p,S=c.length,P=p;b<S;b++,P++){const I=c[b],F=this.views.shift();if(F==null){const U={$model:{[this.attribute]:I},$parent:this.object},G=Rs.create(this.element.parentElement,U,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:x??this.element});v.push(G),x=G;continue}const R=o==null?I:Ct.resolveValue(I??{},o),T=F?.model.$model[this.attribute],M=o==null?T:Ct.resolveValue(T??{},o);if(R===M){v.push(F),F.move(x??this.element),x=F;continue}if(!c.slice(b).map(U=>o==null?U:Ct.resolveValue(U??{},o)).includes(M)){F.destroy(),b--,x=F;continue}this.views.unshift(F);let W=!1;for(let U=0,G=this.views.length;U<G;U++){const j=this.views[U],X=j?.model.$model[this.attribute],rt=o==null?X:Ct.resolveValue(X??{},o);if(R===rt){v.push(...this.views.splice(U,1)),j.move(x??this.element),W=!0,x=j;break}}if(!W){const U={$model:{[this.attribute]:I},$parent:this.object},G=Rs.create(this.element.parentElement,U,this.template.cloneNode(!0),{parent:this,prepare:!1,sibling:x??this.element});v.push(G),x=G}}return this.views.forEach(b=>b.destroy()),this.views=v,this.updateViews(t,c)}else{const i=Ct.resolveValue(this.object,this.attribute);if((t??i)==null||(t??i)!==this.lastValue){this.lastUIValue!=null&&(this.lastUIValue.destroy(),this.lastUIValue=null);const n=t==null?i:i.create(t),o=i.template;this.lastValue=t??i;const h=this.element.nodeType===8?this.element.parentElement:this.element,c=this.element.nodeType===8?this.element:null;if(this.lastUIValue=Ct.create(h,n,o,{parent:this,prepare:!0,sibling:c}),this.attributeArguments[0]!=null&&t!=null){const{target:_,property:p}=Ct.resolveProperty(this.object,this.attributeArguments[0]);_[p]=this.lastUIValue}this.views.push(this.lastUIValue)}}else if(t!==this.lastValue){const i=this.toUI!==!0?this.toUI(t,this.lastValue,this.property,this.object,this.value):t;if(i!==void 0&&i!==this.lastUIValue){const{target:n,property:o}=Ct.resolveProperty(this.element,this.attribute);n[o]=i,"setAttribute"in this.element&&this.element.setAttribute(this.attribute,i),this.lastValue=t,this.lastUIValue=i}}this.updateViews()}updateAtEvents(){let t=this.events.shift();for(;t!=null;)Ct.resolveValue(this.object,this.property).call(this.object.$model,t,this.object.$model,this.element,this.attribute,this.object),t=this.events.shift();this.views.forEach(i=>i.updateAtEvents())}updateMove(){this.views.forEach(t=>t.updateMove())}updateViews(t,i){t==null?this.views.forEach(n=>n.updateToUI()):(this.views.forEach((n,o)=>{const h=i[o];typeof h=="object"&&(h.$index=o),n.model.$model[this.attribute]=h,n.model.$index=o,n.updateToUI()}),this.lastValue=[...t],this.lastUIValue=[...i]),this.oneTime&&(this.toUI=!1,this.fromUI=!1)}}var Al;class Ue{static initialize(t=!0){if(!this.initialized&&(this.initialized=!0,this.initializeLoadPromise(),t!==!1)){if(t===!0){const i=()=>{this.update(),requestAnimationFrame(i)};requestAnimationFrame(i);return}setInterval(()=>this.update(),1e3/t)}}static import(t){this.initializeLoadPromise(),document.body.insertAdjacentHTML("afterbegin",`<object type="text/pui" data="${t}"></object>`)}static ready(){return this.initialize(),this.loadPromise.then(()=>(this.hoist()&&document.head.insertAdjacentHTML("beforeend",'<style> object[type="text/pui"] { height: 0; position: absolute; } </style>'),this.registrations))}static create(t=document.body,i={},n=null,o={parent:null,prepare:!0,sibling:null}){if(typeof t=="string"&&(t=document.querySelector(t)),(typeof i=="string"||i instanceof HTMLElement)&&(console.warn("Old parameter order to UI.create!"),[i,n]=[n,i]),typeof n=="string"){const c=t?.ownerDocument?.defaultView!=null?t.ownerDocument:document;if(n.startsWith("#"))n=c.querySelector(n).cloneNode(!0);else{const _=c.createElement("template");_.innerHTML=o.prepare?this.prepare(n):n,n=_}}const h=Rs.create(t,i,n,o);return h.parent===Ct&&this.views.push(h),this.initialize(),h}static play(t,i){return typeof t=="string"?(t=this.globals.animations.find(n=>n.name===t).clone(),t.play(i)):t.play()}static queue(t){this.h.push(t),this.initialize()}static register(t,i){if(typeof t=="string"){this.registrations[t]=i;return}this.registerWebComponent(i,t)}static parse(t,i,n,o){const h=[];if(t instanceof Comment)return[];if(t instanceof HTMLTemplateElement||t.tagName==="TEMPLATE")return[];if(t.nodeType===3){let c=t.textContent,_=c.match(this.regexValue);for(;_!=null;){const p=_[1];let v=_[2];c=_[3];let x=!1;v.startsWith("|")&&(x=!0,v=v.slice(1).trimStart());const b=v.match(this.regexConditionalValue);let S,P=!0;if(v.startsWith("(")){const F=`_pui${this.bindingCounter++}`;Object.defineProperty(i,F,{get:new Function(`return ${v}`)}),v=F}else b&&(v=b[3],S=`${b[2]}${b[1]}`,P=function(F,R,T,M,W){const U=W[0]==="=";return W=W.slice(2,-1),!!F===U?W:""});let I=t.cloneNode();t.textContent=p,this.parentElement(t,o).insertBefore(I,t.nextSibling),h.push(this.bind({selector:I,attribute:"textContent",object:i,property:v,parent:n,oneTime:x,value:S,toUI:P})),t=I,I=t.cloneNode(),I.textContent=c,this.parentElement(t,o).insertBefore(I,t.nextSibling),t=I,_=c.match(this.regexValue)}}else{const c=t.getAttribute("pui")??"";if(c.trim().length>0){const _=c.split(";");for(let p of _)p=p.trim(),p.length>0&&t.setAttribute(`pui.${this.bindingCounter++}`,p)}if(t.removeAttribute("pui"),h.push(...Object.keys(t.attributes??[]).reverse().map(_=>{const p=[];if(t instanceof Comment)return[];const v=t.attributes[_];if(v.name.startsWith("pui.")){const P=v.value.match(this.regexAttribute);let[I,F,R,T,M]=P,W,U,G=!1;if(R!=="@"){const j=F.match(/^'(.*?)'$/);if(j!=null)W=j[1],t.setAttribute("value",W),F=t.nodeName.toLowerCase()==="option"?"selected":"checked",T=X=>X?W:void 0,R=X=>X===W;else if(F==="")if(T===">"){const[X,rt]=M.split(":");if(X.length>0){const{target:lt,property:yt}=this.resolveProperty(i,X);lt[yt]=t}return(rt??"").length>0&&Ct.queue(()=>{const{target:lt,property:yt}=this.resolveProperty(i,rt);lt[yt]=n}),[]}else({element:t,template:U}=this.replaceWithComment(t,n,o,v.name)),F=R==="=",R=!0,T==="|"&&(G=!0);else if(T==="="&&R==="="){if(!t.tagName.includes("-")){t.setAttribute("pui-unrendered","");const X=this.parentNode(t,o);X.nodeType!==8?{element:t,template:U}=this.replaceWithComment(t,n,o,v.name,U):t=X}U=F,R=!0}else T==="*"?{element:t,template:U}=this.replaceWithComment(t,n,o,v.name):T==="|"?G=!0:F!=="checked"&&t.setAttribute(F,t.getAttribute?.(F)??"")}return[this.bind({selector:t,attribute:F,value:W,object:i,property:M,template:U,toUI:typeof R=="string"?R==="<":R,fromUI:typeof T=="string"?T===">":T,atEvent:R==="@",parent:n,oneTime:G})]}const x=[v.value];let b=0,S=x[b].match(this.regexValue);for(;S!=null;){let{before:P,property:I,after:F}=S.groups,R=!1;I.startsWith("|")&&(R=!0,I=I.slice(1).trimStart());const T=I.match(this.regexConditionalValue);let M;T&&(I=T[3],M=`${T[2]}${T[1]}`),p.push(this.bind({selector:t,attribute:v.name,object:i,property:I,oneTime:R,toUI(W,U,G,j,X){if(this.oneTime){const lt=x.indexOf(G);lt>-1&&(x[lt]=Ct.resolveValue(j,G),x[lt-1]+=x[lt]+x[lt+1],x.splice(lt,2))}const rt=x.map((lt,yt)=>{if(yt%2===0)return lt;const vt=lt.match(Ct.regexSplitConditionalValue);if(vt){const Pt=lt===`${G}${X}`?W:Ct.resolveValue(j,vt[1]),Dt=vt[2]==="=";return!!Pt===Dt?vt[3].slice(1,-1):""}return lt===G?W:Ct.resolveValue(j,lt)}).join("");return t.setAttribute(v.name,rt),rt},parent:n,value:M})),x[b++]=P,x[b++]=`${I}${M??""}`,x[b]=F,S=x[b].match(this.regexValue)}return p}).flat()),t instanceof Comment)return h.filter(_=>_.template!=null?!0:(_.unbind(),!1));if(!this.leaveAttributes)for(let _=Object.keys(t.attributes??[]).length-1;_>=0;_--){const p=t.attributes[Object.keys(t.attributes??[])[_]];p.name.startsWith("pui.")&&t.removeAttribute(p.name)}h.push(...Array.from(t.childNodes).map(_=>this.parse(_,i,n,o)).flat())}return h}static bind(t){return Zl.create(t)}static unbind(t){if(t.destroy(),t.parent!==Ct){const i=t.parent.bindings,n=i.indexOf(t);n>-1&&i.splice(n,1)}}static update(){this.u.forEach(i=>i()),this.u=this.h,this.h=[],this.views.forEach(i=>i.updateToUI()),this.views.forEach(i=>i.updateFromUI()),this.views.forEach(i=>i.updateAtEvents());const t=performance.now();[...this.views,this.globals].forEach(i=>i.updateAnimations(t)),this.views.forEach(i=>{i.updateMove()});for(let i=0;i<this.destroyed.length;i++){const n=this.destroyed[i];switch(n.destroyed){case"queue":n.state==="rendered"?n.destroyed="destroy":n.updateToUI();break;case"destroy":{n.terminate();const o=this.destroyed.findIndex(h=>n===h);o>-1&&(this.destroyed.splice(o,1),i--)}}}}static resolveProperty(t,i){i=i.replace("[",".").replace("]",".");const n=i.split(".").filter(h=>(h??"").length>0);for(;n[0]==="$parent"&&t.$parent!=null;)t=t.$parent,n.shift();let o=t;if(n[0]==="$index"&&this.objectHas(o,"$index"))return{target:o,property:n[0]};for(this.objectHas(o,"$model")&&(o=t.$model);n.length>1;)o=o[n.shift()];return{target:o,property:n[0]}}static resolveValue(t,i){let n=0;do{const{target:o,property:h}=this.resolveProperty(t,i);if(o!=null&&this.objectHas(o,h))return o[h];t=t.$parent}while(t!=null&&n++<1e3);if(i in this.registrations)return this.registrations[i]}static initializeLoadPromise(){this.loadPromise==null&&(this.loadPromise=new Promise(t=>this.loadResolve=t),document.defaultView?.addEventListener("load",this.loaded))}static hoist(t=document,i=document){t!==i&&((i.querySelectorAll("style")??[]).forEach(h=>{t.head.appendChild(h.cloneNode(!0))}),(i.querySelectorAll("template")??[]).forEach(h=>{t.head.appendChild(h.cloneNode(!0))}));const n=i.querySelectorAll('object[type="text/pui"]')??[];let o=n.length>0;return n.forEach(h=>{o=this.hoist(t,h.contentDocument)||o}),o}static objectHas(t,i){try{return i in t}catch{return!1}}static replaceWithComment(t,i,n,o,h){const c=document.createComment(o);return this.parentNode(t,n).insertBefore(c,t),this.parentNode(t,n).removeChild(t),t.removeAttribute(o),h=h??t,t=c,t.parentNode instanceof DocumentFragment&&(i.element=t),{element:t,template:h}}static parentElement(t,i){const n=t.parentElement;if(n!=null)return n;for(;i!=null&&(i.element==null||i.element===t);)i=i.parent;return i?.element}static parentNode(t,i){const n=t.parentNode;if(n!=null)return n;for(;i!=null&&(i.element==null||i.element===t);)i=i.parent;return i?.element}static prepare(t){let i=t;t="";let n=i.match(this.regexReplace);for(;n!=null;){const[o,h,c,_]=n;c.match(/\S\s*===/)?t+=`${h.trimEnd()}br PUI.${this.bindingCounter++}="${c}"`:t+=`${h} PUI.${this.bindingCounter++}="${c}" `,i=_,n=i.match(this.regexReplace)}return t+=i,t}static parseAttribute(t,i,n,o,h,c){const _=c.match(this.regexAttribute);let[p,v,x,b,S]=_,P,I,F=!1;if(x!=="@"){const R=v.match(/^'(.*?)'$/);if(R!=null)P=R[1],t.setAttribute("value",P),v=t.nodeName.toLowerCase()==="option"?"selected":"checked",b=T=>T?P:void 0,x=T=>T===P;else if(v==="")if(b===">"){const{target:T,property:M}=this.resolveProperty(i,S);return T[M]=t,[]}else({element:t,template:I}=this.replaceWithComment(t,n,o,h)),v=x==="=",x=!0,b==="|"&&(F=!0);else if(b==="="&&x==="="){const T=this.parentNode(t,o);T.nodeType!==8?{element:t,template:I}=this.replaceWithComment(t,n,o,h,I):t=T,I=v,F=!0,x=!0}else b==="*"?{element:t,template:I}=this.replaceWithComment(t,n,o,h):b==="|"?F=!0:v!=="checked"&&t.setAttribute(v,"")}return[this.bind({selector:t,attribute:v,value:P,object:i,property:S,template:I,toUI:typeof x=="string"?x==="<":x,fromUI:typeof b=="string"?b===">":b,atEvent:x==="@",parent:n,oneTime:F})]}static registerWebComponent(t,i){t??(t=i.webComponent);class n extends HTMLElement{constructor(){super(),this.webComponentComponent=i,this.webComponentUIView=null,this.attachShadow({mode:"open"})}connectedCallback(){this.initialize()}disconnectedCallback(){this.terminate()}attributeChangedCallback(c,_,p){this.initialize(),this.webComponentUIView.model[c]=p}initialize(){if(this.webComponentUIView==null){const c="create"in this.webComponentComponent?this.webComponentComponent.create():new this.webComponentComponent;c.webComponentHost=this,this.webComponentUIView=Ct.create(this.shadowRoot,c,this.webComponentComponent.template,{host:this.shadowRoot?.host})}}terminate(){this.webComponentUIView!=null&&this.webComponentUIView.destroy()}}n.observedAttributes=i.observedAttributes??[],n.observedProperties=i.observedProperties??n.observedAttributes;const o=[...new Set([...n.observedAttributes,...n.observedProperties])];for(const h of o)Object.defineProperty(n.prototype,h,{configurable:!0,enumerable:!1,get(){return this.webComponentUIView.model[h]},set(c){n.observedAttributes.includes(h)?this.setAttribute(h,c):(this.initialize(),this.webComponentUIView.model[h]=c)}});return customElements.define(t,n),n}}Al=Ue;Ue.initialized=!1;Ue.id=0;Ue.views=[];Ue.destroyed=[];Ue.globals=new Rs;Ue.registrations={};Ue.leaveAttributes=!1;Ue.regexReplace=/([\S\s]*?)\\?\$\{([^}]*?[<=@!]=[*=>|][^}]*?)\}([\S\s]*)/m;Ue.regexAttribute=/^\s*(\S*?)\s*([<=@!])=([*=>|])\s*(\S*?)\s*$/;Ue.regexValue=/(?<before>[\S\s]*?)\\?\$\{\s*(?<property>[\s\S]*?)\s*\}(?<after>[\S\s]*)/m;Ue.regexConditionalValue=/^\s*(.+?)\s*([=!])\s*(\S+)/;Ue.regexSplitConditionalValue=/^(.+?)([=!])(.*)/;Ue.bindingCounter=0;Ue.u=[];Ue.h=[];Ue.loaded=()=>{Al.loadResolve(),document.defaultView?.removeEventListener("load",Al.loaded)};function Mm(){let d=window,t=window;for(;;)try{if(d.parent===d){t=d;break}else d.parent.UI!=="guarantee-condition-always-true"&&(d=d.parent)}catch{break}return t}const yl=Mm();"UI"in yl||(yl.UI=Ue);const Ct=yl.UI;/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var Bm={851:(d,t,i)=>{i.d(t,{A:()=>p});var n=i(1),o=i.n(n),h=i(935),c=i.n(h),_=c()(o());_.push([d.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const p=_},296:(d,t,i)=>{i.d(t,{A:()=>p});var n=i(1),o=i.n(n),h=i(935),c=i.n(h),_=c()(o());_.push([d.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const p=_},935:d=>{d.exports=function(t){var i=[];return i.toString=function(){return this.map(function(o){var h="",c=typeof o[5]<"u";return o[4]&&(h+="@supports (".concat(o[4],") {")),o[2]&&(h+="@media ".concat(o[2]," {")),c&&(h+="@layer".concat(o[5].length>0?" ".concat(o[5]):""," {")),h+=t(o),c&&(h+="}"),o[2]&&(h+="}"),o[4]&&(h+="}"),h}).join("")},i.i=function(o,h,c,_,p){typeof o=="string"&&(o=[[null,o,void 0]]);var v={};if(c)for(var x=0;x<this.length;x++){var b=this[x][0];b!=null&&(v[b]=!0)}for(var S=0;S<o.length;S++){var P=[].concat(o[S]);c&&v[P[0]]||(typeof p<"u"&&(typeof P[5]>"u"||(P[1]="@layer".concat(P[5].length>0?" ".concat(P[5]):""," {").concat(P[1],"}")),P[5]=p),h&&(P[2]&&(P[1]="@media ".concat(P[2]," {").concat(P[1],"}")),P[2]=h),_&&(P[4]?(P[1]="@supports (".concat(P[4],") {").concat(P[1],"}"),P[4]=_):P[4]="".concat(_)),i.push(P))}},i}},1:d=>{d.exports=function(t){var i=t[1],n=t[3];if(!n)return i;if(typeof btoa=="function"){var o=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),h="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(o),c="/*# ".concat(h," */");return[i].concat([c]).join(`
`)}return[i].join(`
`)}}},Zu={};function Re(d){var t=Zu[d];if(t!==void 0)return t.exports;var i=Zu[d]={id:d,exports:{}};return Bm[d](i,i.exports,Re),i.exports}Re.n=d=>{var t=d&&d.__esModule?()=>d.default:()=>d;return Re.d(t,{a:t}),t};Re.d=(d,t)=>{for(var i in t)Re.o(t,i)&&!Re.o(d,i)&&Object.defineProperty(d,i,{enumerable:!0,get:t[i]})};Re.o=(d,t)=>Object.prototype.hasOwnProperty.call(d,t);Re.r=d=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(d,"__esModule",{value:!0})};var C={};Re.d(C,{eKr:()=>Tc,yVm:()=>po,a7j:()=>Bf,U_w:()=>Zc,JF2:()=>Pc,htg:()=>er,HXL:()=>Nc,mcg:()=>xc,Agj:()=>ii,J3_:()=>Gv,Wgv:()=>Ec,u6S:()=>wv,x7M:()=>ve,X55:()=>Hi,m3M:()=>Yr,aE5:()=>gv,YJU:()=>Ui,eZi:()=>Ul,GNv:()=>Qr,Y56:()=>Ol,_0v:()=>Ca,vhs:()=>_a,vrQ:()=>go,Z8b:()=>i_,Yfw:()=>Et,IcQ:()=>ct,kgJ:()=>Vl,GTT:()=>L_,ypY:()=>io,i7d:()=>v_,fQ3:()=>Yv,HlI:()=>Fa,jlt:()=>Ba,VQc:()=>Ge,zD7:()=>Yc,AUF:()=>ls,JoF:()=>sn,MlA:()=>we,PZh:()=>xn,qA:()=>Zr,CrD:()=>ks,dQK:()=>hs,D3r:()=>Vi,Qpo:()=>ba,D9n:()=>xa,b6v:()=>jr,mvh:()=>za,Bpo:()=>_t,Q1f:()=>K,IKv:()=>B_,fcV:()=>Dn,Glf:()=>M_,uAl:()=>Ei,ElT:()=>Ie,Z8r:()=>tc,QSL:()=>S_,sPV:()=>wa,nAn:()=>Ls,zCU:()=>va,QrV:()=>Le,fF9:()=>Tw,Jqv:()=>h_,d_u:()=>a_,xI8:()=>bc,yar:()=>Ee,SP7:()=>k_,oRy:()=>La,f5X:()=>Oc,V1c:()=>ec,Mlx:()=>U_,ZiM:()=>Nl,ZCo:()=>Jr,J5p:()=>z_,mL_:()=>hi,Guw:()=>n_,N5j:()=>Ff,pgY:()=>r_,OP3:()=>pa,rl5:()=>V_,eod:()=>iw,q5Z:()=>Te,YUC:()=>Fc,saR:()=>ya,hvr:()=>Gl,Qol:()=>e_,Wf4:()=>t_,JCs:()=>Xt,gJV:()=>pi,fWD:()=>g_,Va_:()=>Ks,N$8:()=>ai,_jQ:()=>sw,rxj:()=>Cc,rhv:()=>yc,wCu:()=>Ye,HAp:()=>yv,Zy1:()=>x_,bkB:()=>$t,wfL:()=>ma,sVA:()=>Kl,$Gs:()=>Rc,CJ0:()=>Aa,NWh:()=>Fs,tWi:()=>Sc,xAj:()=>Ac,zWh:()=>s_,i_4:()=>Pw,iIx:()=>Be,Hxo:()=>o_,c9e:()=>kl,KQV:()=>Bn,weH:()=>Ot,jXp:()=>Cw,zzY:()=>ga,yRQ:()=>ua,MtE:()=>H_,rPj:()=>no,KLc:()=>yi,Fir:()=>At,V5f:()=>oc,Xj7:()=>ac,Wud:()=>la,FVg:()=>mc,g5Y:()=>pc,YQB:()=>_c,KPb:()=>gc,nHK:()=>Oa,Jrb:()=>X_,TX_:()=>Aw,Olt:()=>j_,r3n:()=>rr,Fvk:()=>aw,gpR:()=>Sa,vYh:()=>ae,hnk:()=>he,D2R:()=>sr,n1o:()=>Hc,h9O:()=>P_,X5j:()=>is,p3P:()=>Wc,RLG:()=>wc,fBU:()=>Bc,Adb:()=>xe,bEs:()=>as,wCy:()=>Mt,CbD:()=>Jt,x_C:()=>gr,pGf:()=>qc,ibQ:()=>E_,shR:()=>eo,Yjk:()=>Gc,_u1:()=>hw,OBI:()=>q_,klh:()=>Nr,s3S:()=>R_,D$R:()=>so,xth:()=>Ra,JU7:()=>nw,h9x:()=>m_,N1A:()=>Qc,e_k:()=>ue,aHM:()=>Un,tlv:()=>Mv,Vi9:()=>__,ieR:()=>f_,$bb:()=>be,VyI:()=>dt,imn:()=>Pf,uqu:()=>gi,QnL:()=>Cl,vnc:()=>Dc,wk_:()=>Ll,GH0:()=>Lt,_1r:()=>Ua,l0X:()=>Ml,bT:()=>Wf,HHX:()=>Bl,jtW:()=>Nf,tjk:()=>Zs,rWe:()=>wn,j9l:()=>Rf,l0$:()=>Kc,sGJ:()=>Is,NVp:()=>kc,cPK:()=>ti,XoL:()=>Xc,RmF:()=>ei,DXI:()=>ka,tCD:()=>lw,J3D:()=>Da,vCJ:()=>rw,e6k:()=>Ef,f9l:()=>Gi,v9m:()=>Va,yRJ:()=>T_,EU6:()=>Wl,m3O:()=>Ts,Ryz:()=>$s,OxP:()=>Gr,LEs:()=>Wa,Ec:()=>Mn,Pi5:()=>Ha,gmH:()=>Es,tS:()=>Jc,XxX:()=>ke,bCz:()=>Ia,nYS:()=>Ln,yiT:()=>dc,NHl:()=>_r,mO8:()=>fc,PXI:()=>rc,bn5:()=>lc,Ywr:()=>en,cMd:()=>kn,Bs6:()=>cc,G0k:()=>fr,pyn:()=>uc,QeM:()=>nc,aPX:()=>Kv,ITP:()=>hc,BY0:()=>tn,MFw:()=>uo,sBn:()=>lo,S3L:()=>$n,XKQ:()=>$r,ESI:()=>b_,uxz:()=>p_,o8N:()=>lr,u_r:()=>ur,RlV:()=>Tn,gVA:()=>zl,M_G:()=>fo,BpG:()=>Ic,GRB:()=>bv,kM6:()=>kf,dO8:()=>Lf,jgM:()=>Il,FWq:()=>ao,s3j:()=>Vm,hlw:()=>Yf,L0q:()=>qf,B7e:()=>Xf,PGN:()=>Gf,H_X:()=>oe,S_d:()=>$f,_Tq:()=>Kf,U7E:()=>Qf,IOH:()=>Zf,Z58:()=>bi,yh2:()=>$v,ff$:()=>Rl,cWi:()=>pf,NBt:()=>Uc,oNz:()=>Iv,QlU:()=>F_,Xey:()=>Js,jft:()=>Fw,_r8:()=>me,bTC:()=>Mf,Mtr:()=>di,ypk:()=>Xe,mnM:()=>Wt,q7S:()=>Ew,bAZ:()=>Kr,ABN:()=>Df,VK6:()=>Fv,Hj2:()=>Vc,Df8:()=>Hl,oOx:()=>nr,kxk:()=>Wi,DT1:()=>Ea,FLG:()=>En,qN_:()=>jc,Z37:()=>Ma,FtL:()=>u_,Z6X:()=>Y_,iQT:()=>Ci,ziO:()=>y_,OEF:()=>_s,uuE:()=>vi,tiv:()=>to,T$Y:()=>O_,EYj:()=>co,nOB:()=>fa,Tap:()=>re,FAs:()=>d_,B_P:()=>c_,aA5:()=>qv,J3s:()=>$c,Y0Q:()=>ho,M4G:()=>Rn,l$l:()=>W_,dLy:()=>Bs,WZP:()=>nt,eB6:()=>Na,nFK:()=>Fl,l9z:()=>w_,YOF:()=>jv,yhB:()=>Ae,J0N:()=>$l,Miz:()=>k,Bj4:()=>Pl,Rcs:()=>us,vJ4:()=>Us,TqC:()=>Mc,nM0:()=>vc,X1u:()=>In,SpZ:()=>If,DX8:()=>ir,Yx$:()=>D_,HK4:()=>C_,yt5:()=>_f,vAR:()=>ow,SE$:()=>Ds,qE8:()=>St,Pz7:()=>Z_,sX_:()=>Fn,JuI:()=>km,pxT:()=>Ms,Nl$:()=>sc,zDr:()=>vw,OwT:()=>fw,P$G:()=>mw,mHV:()=>gw,kEA:()=>ww,Fx_:()=>bw,WFC:()=>xw,vKu:()=>dw,aDq:()=>cw,jIg:()=>pw,UH3:()=>_w,AJO:()=>uw,U4:()=>zf,xAc:()=>Hf,_3Y:()=>Nv,K6X:()=>xv,C1Y:()=>Tf,Aw1:()=>Dl,tm8:()=>Of,LBV:()=>Vf,A8$:()=>Av,F5e:()=>Vv,ran:()=>Wv,c8L:()=>Jf,o6M:()=>jf,hsx:()=>ts,l9E:()=>l_,aSf:()=>A_,CcK:()=>Uf,nU8:()=>Lc,td6:()=>_o,Zex:()=>Q_,bkJ:()=>Vt,mXP:()=>Rw,vt$:()=>dr,hCA:()=>Ni,pjR:()=>mt,U43:()=>es,pSZ:()=>zm,y17:()=>Um,Ew7:()=>fs,hG1:()=>Ov,jVr:()=>Iw,_SZ:()=>qt,xWn:()=>gf,ehJ:()=>Lm,t6s:()=>N,Eyn:()=>Ql});var Ql={};Re.r(Ql);Re.d(Ql,{getAttributeComponentSize:()=>Cf,getAttributePointerType:()=>Sf,getGLTypeFromSource:()=>yf,getGlTypeSizeBytes:()=>Sl,getMaxShaderComplexity:()=>ic,isAttributeInSource:()=>Af});var Jl={};Re.r(Jl);Re.d(Jl,{circle:()=>vv,line:()=>Tl,point:()=>pv,roundRect:()=>El,vector:()=>mv});var Kl={};Re.r(Kl);Re.d(Kl,{ActionCompleteEvent:()=>Tc,ActionStartEvent:()=>Pc,ActivateEvent:()=>xc,AddEvent:()=>Ec,CollisionEndEvent:()=>Zr,CollisionPostSolveEvent:()=>ba,CollisionPreSolveEvent:()=>xa,CollisionStartEvent:()=>jr,ContactEndEvent:()=>wa,ContactStartEvent:()=>va,DeactivateEvent:()=>bc,EnterTriggerEvent:()=>Cc,EnterViewPortEvent:()=>yc,EventTypes:()=>ma,ExitTriggerEvent:()=>Sc,ExitViewPortEvent:()=>Ac,GameEvent:()=>At,GameStartEvent:()=>oc,GameStopEvent:()=>ac,GamepadAxisEvent:()=>mc,GamepadButtonEvent:()=>pc,GamepadConnectEvent:()=>_c,GamepadDisconnectEvent:()=>gc,HiddenEvent:()=>wc,InitializeEvent:()=>gr,KillEvent:()=>Ra,PostCollisionEvent:()=>Ln,PostDebugDrawEvent:()=>dc,PostDrawEvent:()=>_r,PostFrameEvent:()=>fc,PostKillEvent:()=>rc,PostTransformDrawEvent:()=>lc,PostUpdateEvent:()=>en,PreCollisionEvent:()=>kn,PreDebugDrawEvent:()=>cc,PreDrawEvent:()=>fr,PreFrameEvent:()=>uc,PreKillEvent:()=>nc,PreTransformDrawEvent:()=>hc,PreUpdateEvent:()=>tn,RemoveEvent:()=>Ic,VisibleEvent:()=>vc});var $l={};Re.r($l);Re.d($l,{ConsoleAppender:()=>tc,DrawUtil:()=>Jl,EasingFunctions:()=>Xt,LogLevel:()=>be,Logger:()=>dt,Observable:()=>ti,ScreenAppender:()=>pf,addItemToArray:()=>Hm,contains:()=>mf,delay:()=>ca,fail:()=>vf,getPosition:()=>Vr,isObject:()=>ha,mergeDeep:()=>da,omit:()=>wf,removeItemFromArray:()=>cr});function ff(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(d){window.setInterval(d,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const t=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(i){return new Promise((n,o)=>{t.call(this,i,n,o)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(d){const t=Date.now();return setTimeout(function(){d({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(d){clearTimeout(d)})}class Be{static useCanvasGraphicsContext(){Be.enable("use-canvas-context")}static useLegacyImageRenderer(){Be.enable("use-legacy-image-renderer")}static freeze(){Be._FROZEN=!0}static _reset(){Be._FROZEN=!1,Be._FLAGS={}}static enable(t){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");Be._FLAGS[t]=!0}static disable(t){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");Be._FLAGS[t]=!1}static isEnabled(t){return!!Be._FLAGS[t]}static show(){return Object.keys(Be._FLAGS)}}Be._FROZEN=!1;Be._FLAGS={};function Fn(d,t){return{type:d,value:t}}class yi{constructor(){this._isCompleted=!1,this.promise=new Promise((t,i)=>{this._resolver=t,this._rejecter=i})}get isCompleted(){return this._isCompleted}resolve(t){this._isCompleted||(this._isCompleted=!0,this._resolver(t))}reject(t){this._isCompleted||(this._isCompleted=!0,this._rejecter(t))}}class $t{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(t,i){var n;return this._empty=!1,this._listeners[t]=(n=this._listeners[t])!==null&&n!==void 0?n:[],this._listeners[t].push(i),{close:()=>this.off(t,i)}}once(t,i){var n;return this._empty=!1,this._listenersOnce[t]=(n=this._listenersOnce[t])!==null&&n!==void 0?n:[],this._listenersOnce[t].push(i),{close:()=>this.off(t,i)}}off(t,i){var n,o;if(i){const h=(n=this._listeners[t])===null||n===void 0?void 0:n.filter(_=>_!==i);this._listeners[t]=h;const c=(o=this._listenersOnce[t])===null||o===void 0?void 0:o.filter(_=>_!==i);this._listenersOnce[t]=c}else delete this._listeners[t]}emit(t,i){if(this._empty||this._paused)return;const n=this._listeners[t];if(n)for(let h=0;h<n.length;h++)n[h](i);const o=this._listenersOnce[t];if(this._listenersOnce[t]=[],o)for(let h=0;h<o.length;h++)o[h](i);for(let h=0;h<this._pipes.length;h++)this._pipes[h].emit(t,i)}pipe(t){if(this===t)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(t),{close:()=>{const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}}}unpipe(t){const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var Mn;(function(d){d.Canvas="Canvas",d.Document="Document"})(Mn||(Mn={}));var oe;(function(d){d.ShortestPath="shortest-path",d.LongestPath="longest-path",d.Clockwise="clockwise",d.CounterClockwise="counter-clockwise"})(oe||(oe={}));const fl=4294967295;class lr{constructor(t){this.seed=t,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(t||Date.now())>>>0;for(let i=1;i<this._n;i++){const n=this._mt[i-1]^this._mt[i-1]>>>this._w-2;this._mt[i]=(this._f*((n&4294901760)>>>16)<<16)+this._f*(n&65535)+i>>>0}this._index=this._n}_twist(){const t=[0,this._a];let i=0,n=0;for(;n<this._n-this._m;n++)i=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+this._m]^i>>>1^t[i&1]&fl;for(;n<this._n-1;n++)i=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+(this._m-this._n)]^i>>>1^t[i&1]&fl;i=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^i>>>1^t[i&1]&fl,this._index=0}nextInt(){this._index>=this._n&&this._twist();let t=this._mt[this._index++];return t^=t>>>this._u,t^=t<<this._s&this._b,t^=t<<this._t&this._c,t^=t>>>this._l,t>>>0}next(){return this.nextInt()*(1/4294967296)}floating(t,i){return(i-t)*this.next()+t}integer(t,i){return Math.floor((i-t+1)*this.next()+t)}bool(t=.5){return this.next()<=t}pickOne(t){return t[this.integer(0,t.length-1)]}pickSet(t,i,n=!1){return n?this._pickSetWithDuplicates(t,i):this._pickSetWithoutDuplicates(t,i)}_pickSetWithoutDuplicates(t,i){if(i>t.length||i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(i===t.length)return t;const n=new Array(i);let o=0;const h=t.slice(0);for(;o<i;){const c=this.integer(0,h.length-1);n[o++]=h[c],h.splice(c,1)}return n}_pickSetWithDuplicates(t,i){if(i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const n=new Array(i);for(let o=0;o<i;o++)n[o]=this.pickOne(t);return n}shuffle(t){const i=t.slice(0);let n;for(let o=0;o<i.length-2;o++){const h=this.integer(o,i.length-1);n=i[o],i[o]=i[h],i[h]=n}return i}range(t,i,n){const o=new Array(t);for(let h=0;h<t;h++)o[h]=this.integer(i,n);return o}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const Ae=Math.PI*2;function km(d){return d>=0?d-Math.floor(d):d-Math.ceil(d)}function qt(d){return d===0?0:d<0?-1:1}function St(d,t,i){return Math.min(Math.max(t,d),i)}function _f(d,t,i){return Math.abs(d-t)<i}function Ds(d){let t=d;if(d>=Ae)for(;t>=Ae;)t-=Ae;if(d<0)for(;t<0;)t+=Ae;return t}function gf(d){return 180/Math.PI*d}function Lm(d){return d/180*Math.PI}const Um=(d,t)=>Array.from(new Array(t-d+1),(i,n)=>n+d);function es(d,t,i=new lr){return i?i.floating(d,t):d+Math.random()*(t-d)}function zm(d,t,i=new lr){return i?i.integer(d,t):Math.round(es(d,t))}class k{static get Zero(){return new k(0,0)}static get One(){return new k(1,1)}static get Half(){return new k(.5,.5)}static get Up(){return new k(0,-1)}static get Down(){return new k(0,1)}static get Left(){return new k(-1,0)}static get Right(){return new k(1,0)}static fromAngle(t){return new k(Math.cos(t),Math.sin(t))}static isValid(t){return!(t==null||isNaN(t.x)||isNaN(t.y)||t.x===1/0||t.y===1/0||t.x===-1/0||t.y===-1/0)}static distance(t,i){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))}static min(t,i){return new k(Math.min(t.x,i.x),Math.min(t.y,i.y))}static max(t,i){return new k(Math.max(t.x,i.x),Math.max(t.y,i.y))}constructor(t,i){this._x=0,this._y=0,this._x=t,this._y=i}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}setTo(t,i){this.x=t,this.y=i}equals(t,i=k.EQUALS_EPSILON){return Math.abs(this.x-t.x)<=i&&Math.abs(this.y-t.y)<=i}distance(t){if(!t)return Math.sqrt(this.x*this.x+this.y*this.y);const i=this.x-t.x,n=this.y-t.y;return Math.sqrt(i*i+n*n)}squareDistance(t){t||(t=k.Zero);const i=this.x-t.x,n=this.y-t.y;return i*i+n*n}clampMagnitude(t){const i=this.magnitude,n=St(i,0,t);return this.magnitude=n,this}get size(){return this.distance()}set size(t){const i=this.normalize().scale(t);this.setTo(i.x,i.y)}get magnitude(){return this.distance()}set magnitude(t){this.normalize().scale(t,this)}normalize(){const t=this.distance();return t===0?k.Zero:new k(this.x/t,this.y/t)}average(t){return this.add(t).scale(.5)}scale(t,i){const n=i||new k(0,0);return t instanceof k?(n.x=this.x*t.x,n.y=this.y*t.y):(n.x=this.x*t,n.y=this.y*t),n}add(t,i){return i?(i.x=this.x+t.x,i.y=this.y+t.y,i):new k(this.x+t.x,this.y+t.y)}sub(t,i){const n=i||new k(0,0),o=this.x-t.x,h=this.y-t.y;return n.x=o,n.y=h,n}addEqual(t){return this.setTo(this.x+t.x,this.y+t.y),this}subEqual(t){return this.setTo(this.x-t.x,this.y-t.y),this}scaleEqual(t){return this.setTo(this.x*t,this.y*t),this}dot(t){return this.x*t.x+this.y*t.y}cross(t){if(t instanceof k)return this.x*t.y-this.y*t.x;if(typeof t=="number")return new k(t*this.y,-t*this.x)}static cross(t,i){return new k(-t*i.y,t*i.x)}perpendicular(){return new k(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return Ds(Math.atan2(this.y,this.x))}angleBetween(t,i){const n=this.toAngle(),o=Ds(t);let h=0,c=0;switch(o>n?h=o-n:h=(Ae-n+o)%Ae,c=(h-Ae)%Ae,i){case oe.ShortestPath:return Math.abs(h)<Math.abs(c)?h:c;case oe.LongestPath:return Math.abs(h)>Math.abs(c)?h:c;case oe.Clockwise:return h;case oe.CounterClockwise:return c}}rotate(t,i,n){const o=n||new k(0,0);i||(i=new k(0,0));const h=Math.sin(t),c=Math.cos(t),_=c*(this.x-i.x)-h*(this.y-i.y)+i.x,p=h*(this.x-i.x)+c*(this.y-i.y)+i.y;return o.x=_,o.y=p,o}clone(t){const i=t??new k(0,0);return i.x=this.x,i.y=this.y,i}toString(t){return t?`(${this.x.toFixed(t)}, ${this.y.toFixed(t)})`:`(${this.x}, ${this.y})`}}k.EQUALS_EPSILON=.001;function N(d,t){return new k(d,t)}class K{constructor(t,i,n,o){this.r=t,this.g=i,this.b=n,this.a=o??1}static fromRGB(t,i,n,o){return new K(t,i,n,o)}static fromRGBString(t){const i=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let n=null;if(n=t.match(i)){const o=parseInt(n[1],10),h=parseInt(n[2],10),c=parseInt(n[3],10);let _=1;return n[4]&&(_=parseFloat(n[4])),new K(o,h,c,_)}else throw new Error("Invalid rgb/a string: "+t)}static fromHex(t){const i=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let n=null;if(n=t.match(i)){const o=parseInt(n[1],16),h=parseInt(n[2],16),c=parseInt(n[3],16);let _=1;return n[4]&&(_=parseInt(n[4],16)/255),new K(o,h,c,_)}else throw new Error("Invalid hex string: "+t)}static fromHSL(t,i,n,o=1){return new zi(t,i,n,o).toRGBA()}lighten(t=.1){const i=zi.fromRGBA(this.r,this.g,this.b,this.a);return i.l+=(1-i.l)*t,i.toRGBA()}darken(t=.1){const i=zi.fromRGBA(this.r,this.g,this.b,this.a);return i.l-=i.l*t,i.toRGBA()}saturate(t=.1){const i=zi.fromRGBA(this.r,this.g,this.b,this.a);return i.s+=i.s*t,i.toRGBA()}desaturate(t=.1){const i=zi.fromRGBA(this.r,this.g,this.b,this.a);return i.s-=i.s*t,i.toRGBA()}multiply(t){const i=t.r/255*this.r/255*255,n=t.g/255*this.g/255*255,o=t.b/255*this.b/255*255,h=t.a*this.a;return new K(i,n,o,h)}screen(t){const i=t.invert(),n=t.invert();return i.multiply(n).invert()}invert(){return new K(255-this.r,255-this.g,255-this.b,1-this.a)}average(t){const i=(t.r+this.r)/2,n=(t.g+this.g)/2,o=(t.b+this.b)/2,h=(t.a+this.a)/2;return new K(i,n,o,h)}equal(t){return this.toString()===t.toString()}toString(t="rgb"){switch(t){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(t){const i=Math.max(Math.round(t),0).toString(16);return i.length===1?"0"+i:i}toHex(){let t="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(t+=this._componentToHex(this.a*255)),t}toRGBA(){const t=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+t+", "+String(this.a)+")":"rgb("+t+")"}toHSLA(){return zi.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(t){const i=t||new K(this.r,this.g,this.b,this.a);return i.r=this.r,i.g=this.g,i.b=this.b,i.a=this.a,i}static get Black(){return K.fromHex("#000000")}static get White(){return K.fromHex("#FFFFFF")}static get Gray(){return K.fromHex("#808080")}static get LightGray(){return K.fromHex("#D3D3D3")}static get DarkGray(){return K.fromHex("#A9A9A9")}static get Yellow(){return K.fromHex("#FFFF00")}static get Orange(){return K.fromHex("#FFA500")}static get Red(){return K.fromHex("#FF0000")}static get Vermilion(){return K.fromHex("#FF5B31")}static get Rose(){return K.fromHex("#FF007F")}static get Pink(){return K.fromHex("#FFC0CB")}static get Magenta(){return K.fromHex("#FF00FF")}static get Violet(){return K.fromHex("#7F00FF")}static get Purple(){return K.fromHex("#800080")}static get Blue(){return K.fromHex("#0000FF")}static get Azure(){return K.fromHex("#007FFF")}static get Cyan(){return K.fromHex("#00FFFF")}static get Viridian(){return K.fromHex("#59978F")}static get Teal(){return K.fromHex("#008080")}static get Green(){return K.fromHex("#00FF00")}static get Chartreuse(){return K.fromHex("#7FFF00")}static get Transparent(){return K.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return K.fromHex("#176BAA")}static get Brown(){return K.fromHex("#964B00")}}class zi{constructor(t,i,n,o){this.h=t,this.s=i,this.l=n,this.a=o}static hue2rgb(t,i,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+(i-t)*6*n:n<1/2?i:n<2/3?t+(i-t)*(2/3-n)*6:t}static fromRGBA(t,i,n,o){t/=255,i/=255,n/=255;const h=Math.max(t,i,n),c=Math.min(t,i,n);let _,p;const v=(h+c)/2;if(h===c)_=p=0;else{const x=h-c;switch(p=v>.5?x/(2-h-c):x/(h+c),h){case t:_=(i-n)/x+(i<n?6:0);break;case i:_=(n-t)/x+2;break;case n:_=(t-i)/x+4;break}_/=6}return new zi(_,p,v,o)}toRGBA(){let t,i,n;if(this.s===0)t=i=n=this.l;else{const o=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,h=2*this.l-o;t=zi.hue2rgb(h,o,this.h+1/3),i=zi.hue2rgb(h,o,this.h),n=zi.hue2rgb(h,o,this.h-1/3)}return new K(t*255,i*255,n*255,this.a)}toString(){const t=this.h.toFixed(0),i=this.s.toFixed(0),n=this.l.toFixed(0),o=this.a.toFixed(0);return`hsla(${t}, ${i}, ${n}, ${o})`}}var be;(function(d){d[d.Debug=0]="Debug",d[d.Info=1]="Info",d[d.Warn=2]="Warn",d[d.Error=3]="Error",d[d.Fatal=4]="Fatal"})(be||(be={}));class dt{constructor(){if(this._appenders=[],this.defaultLevel=be.Info,this._logOnceSet=new Set,dt._INSTANCE)throw new Error("Logger is a singleton");return dt._INSTANCE=this,dt._INSTANCE.addAppender(new tc),dt._INSTANCE}static getInstance(){return dt._INSTANCE==null&&(dt._INSTANCE=new dt),dt._INSTANCE}addAppender(t){this._appenders.push(t)}clearAppenders(){this._appenders.length=0}_log(t,i){t==null&&(t=this.defaultLevel);const n=this._appenders.length;for(let o=0;o<n;o++)t>=this.defaultLevel&&this._appenders[o].log(t,i)}_logOnce(t,i){const n=t+i.join("+");this._logOnceSet.has(n)||(this._logOnceSet.add(n),this._log(t,i))}debug(...t){this._log(be.Debug,t)}debugOnce(...t){this._logOnce(be.Debug,t)}info(...t){this._log(be.Info,t)}infoOnce(...t){this._logOnce(be.Info,t)}warn(...t){this._log(be.Warn,t)}warnOnce(...t){this._logOnce(be.Warn,t)}error(...t){this._log(be.Error,t)}errorOnce(...t){this._logOnce(be.Error,t)}fatal(...t){this._log(be.Fatal,t)}fatalOnce(...t){this._logOnce(be.Fatal,t)}}dt._INSTANCE=null;class tc{log(t,i){if(!console&&!console.log&&console.warn&&console.error)return;const n=[];n.unshift.apply(n,i),n.unshift("["+be[t]+"] : "),t<be.Warn?console.log.apply?console.log.apply(console,n):console.log(n.join(" ")):t<be.Error?console.warn.apply?console.warn.apply(console,n):console.warn(n.join(" ")):console.error.apply?console.error.apply(console,n):console.error(n.join(" "))}}class pf{constructor(t){var i,n;this._messages=[],this._pos=10,this._color=K.Black,this._options=t,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(n=(i=t.zIndex)===null||i===void 0?void 0:i.toString())!==null&&n!==void 0?n:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),t.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var t,i,n,o;const h=this._options;this.canvas.width=(t=h.width)!==null&&t!==void 0?t:h.engine.screen.resolution.width,this.canvas.height=(i=h.height)!==null&&i!==void 0?i:h.engine.screen.resolution.height,this.canvas.style.position="absolute";const c=h.engine.screen.screenToPageCoordinates(N(0,0));this.canvas.style.left=c.x+"px",this.canvas.style.top=c.y+"px",this._pos=(n=h.xPos)!==null&&n!==void 0?n:this._pos,this._color=(o=h.color)!==null&&o!==void 0?o:this._color}log(t,i){const n=i.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+be[t]+"] : "+n);let o=10;this._messages=this._messages.slice(0,1e3);for(let h=0;h<this._messages.length;h++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[h],this._pos,o),o+=10}}var Wt;(function(d){d.None="None",d.Top="Top",d.Bottom="Bottom",d.Left="Left",d.Right="Right"})(Wt||(Wt={}));(function(d){function t(n){return n===d.Top?d.Bottom:n===d.Bottom?d.Top:n===d.Left?d.Right:n===d.Right?d.Left:d.None}d.getOpposite=t;function i(n){return Math.abs(n.x)>=Math.abs(n.y)?n.x<=0?d.Left:d.Right:n.y<=0?d.Top:d.Bottom}d.fromDirection=i})(Wt||(Wt={}));class ct{constructor(t=0,i=0,n=0,o=0){this._points=[],typeof t=="object"?(this.left=t.left,this.top=t.top,this.right=t.right,this.bottom=t.bottom):typeof t=="number"&&(this.left=t,this.top=i,this.right=n,this.bottom=o)}clone(t){const i=t||new ct(0,0,0,0);return i.left=this.left,i.right=this.right,i.top=this.top,i.bottom=this.bottom,i}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(t){return t&&t?Math.abs(t.x)>Math.abs(t.y)?t.x<0?Wt.Right:Wt.Left:t.y<0?Wt.Bottom:Wt.Top:Wt.None}static fromPoints(t){let i=1/0,n=1/0,o=-1/0,h=-1/0;for(let c=0;c<t.length;c++)t[c].x<i&&(i=t[c].x),t[c].x>o&&(o=t[c].x),t[c].y<n&&(n=t[c].y),t[c].y>h&&(h=t[c].y);return new ct(i,n,o,h)}static fromDimension(t,i,n=k.Half,o=k.Zero){return new ct(-t*n.x+o.x,-i*n.y+o.y,t-t*n.x+o.x,i-i*n.y+o.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new k((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new k(this.left,this.top)}get bottomRight(){return new k(this.right,this.bottom)}get topRight(){return new k(this.right,this.top)}get bottomLeft(){return new k(this.left,this.bottom)}translate(t){return new ct(this.left+t.x,this.top+t.y,this.right+t.x,this.bottom+t.y)}rotate(t,i=k.Zero){const n=this.getPoints().map(o=>o.rotate(t,i));return ct.fromPoints(n)}scale(t,i=k.Zero){const n=this.translate(i);return new ct(n.left*t.x,n.top*t.y,n.right*t.x,n.bottom*t.y)}transform(t){const i=t.data[0]*this.left,n=t.data[1]*this.left,o=t.data[0]*this.right,h=t.data[1]*this.right,c=t.data[2]*this.top,_=t.data[3]*this.top,p=t.data[2]*this.bottom,v=t.data[3]*this.bottom,x=t.getPosition(),b=Math.min(i,o)+Math.min(c,p)+x.x,S=Math.min(n,h)+Math.min(_,v)+x.y,P=Math.max(i,o)+Math.max(c,p)+x.x,I=Math.max(n,h)+Math.max(_,v)+x.y;return new ct({left:b,top:S,right:P,bottom:I})}getPerimeter(){const t=this.width,i=this.height;return 2*(t+i)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new k(this.left,this.top)),this._points.push(new k(this.right,this.top)),this._points.push(new k(this.right,this.bottom)),this._points.push(new k(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(t,i=1/0){let n=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,c=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,_=(this.left-t.pos.x)*h,p=(this.right-t.pos.x)*h;n=Math.min(_,p),o=Math.max(_,p);const v=(this.top-t.pos.y)*c,x=(this.bottom-t.pos.y)*c;return n=Math.max(n,Math.min(v,x)),o=Math.min(o,Math.max(v,x)),o>=Math.max(0,n)&&n<i}rayCastTime(t,i=1/0){let n=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,c=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,_=(this.left-t.pos.x)*h,p=(this.right-t.pos.x)*h;n=Math.min(_,p),o=Math.max(_,p);const v=(this.top-t.pos.y)*c,x=(this.bottom-t.pos.y)*c;return n=Math.max(n,Math.min(v,x)),o=Math.min(o,Math.max(v,x)),o>=Math.max(0,n)&&n<i?n:-1}contains(t){return t instanceof k?this.left<=t.x&&this.top<=t.y&&t.y<=this.bottom&&t.x<=this.right:t instanceof ct?this.left<=t.left&&this.top<=t.top&&t.bottom<=this.bottom&&t.right<=this.right:!1}combine(t,i){const n=i||new ct(0,0,0,0),o=Math.min(this.left,t.left),h=Math.min(this.top,t.top),c=Math.max(this.right,t.right),_=Math.max(this.bottom,t.bottom);return n.left=o,n.top=h,n.right=c,n.bottom=_,n}get dimensions(){return new k(this.width,this.height)}overlaps(t,i){const n=i||0;if(t.hasZeroDimensions())return this.contains(t);if(this.hasZeroDimensions())return t.contains(this);const o=this.combine(t);return o.width+n<t.width+this.width&&o.height+n<t.height+this.height}intersect(t){const i=this.combine(t);if(i.width<t.width+this.width&&i.height<t.height+this.height&&!i.dimensions.equals(t.dimensions)&&!i.dimensions.equals(this.dimensions)){let n=0;this.right>=t.left&&this.right<=t.right?n=t.left-this.right:n=t.right-this.left;let o=0;return this.top<=t.bottom&&this.top>=t.top?o=t.bottom-this.top:o=t.top-this.bottom,Math.abs(n)<Math.abs(o)?new k(n,0):new k(0,o)}else if(i.dimensions.equals(t.dimensions)||i.dimensions.equals(this.dimensions)){let n=0;this.width-t.width>=0?this.right-t.right<=t.left-this.left?n=t.left-this.right:n=t.right-this.left:t.right-this.right<=this.left-t.left?n=this.left-t.right:n=this.right-t.left;let o=0;return this.height-t.height>=0?this.bottom-t.bottom<=t.top-this.top?o=t.top-this.bottom:o=t.bottom-this.top:t.bottom-this.bottom<=this.top-t.top?o=this.top-t.bottom:o=this.bottom-t.top,Math.abs(n)<Math.abs(o)?new k(n,0):new k(0,o)}else return null}intersectWithSide(t){const i=this.intersect(t);return ct.getSideFromIntersection(i)}draw(t,i=K.Yellow){t.debug.drawRect(this.left,this.top,this.width,this.height,{color:i})}}function Vr(d){if(d&&d.getBoundingClientRect){const t=d.getBoundingClientRect();return N(t.x+window.scrollX,t.y+window.scrollY)}return k.Zero}function Hm(d,t){return t.indexOf(d)===-1?(t.push(d),!0):!1}function cr(d,t){let i=-1;return(i=t.indexOf(d))>-1?(t.splice(i,1),!0):!1}function mf(d,t){for(let i=0;i<d.length;i++)if(d[i]===t)return!0;return!1}function vf(d){throw new Error(d)}function ca(d,t){var i;const n=new yi;return((i=t?.schedule.bind(t))!==null&&i!==void 0?i:setTimeout)(()=>{n.resolve()},d),n.promise}function wf(d,t){const i={};for(const n in d)t.includes(n)||(i[n]=d[n]);return i}function ha(d){return d&&typeof d=="object"&&!Array.isArray(d)}function da(d,...t){if(!t.length)return d;const i=t.shift();if(ha(d)&&ha(i))for(const n in i)ha(i[n])?(d[n]||Object.assign(d,{[n]:{}}),da(d[n],i[n])):Object.assign(d,{[n]:i[n]});return da(d,...t)}var Cl;(function(d){d[d.X=12]="X",d[d.Y=13]="Y"})(Cl||(Cl={}));class gi{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(t,i,n,o,h,c){const _=new gi;return _.data[0]=2/(i-t),_.data[1]=0,_.data[2]=0,_.data[3]=0,_.data[4]=0,_.data[5]=2/(o-n),_.data[6]=0,_.data[7]=0,_.data[8]=0,_.data[9]=0,_.data[10]=-2/(c-h),_.data[11]=0,_.data[12]=-(i+t)/(i-t),_.data[13]=-(o+n)/(o-n),_.data[14]=-(c+h)/(c-h),_.data[15]=1,_}clone(t){const i=t||new gi;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i.data[6]=this.data[6],i.data[7]=this.data[7],i.data[8]=this.data[8],i.data[9]=this.data[9],i.data[10]=this.data[10],i.data[11]=this.data[11],i.data[12]=this.data[12],i.data[13]=this.data[13],i.data[14]=this.data[14],i.data[15]=this.data[15],i}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(t){const i=new gi;return i.data=t,i}static identity(){const t=new gi;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}static translation(t,i){const n=gi.identity();return n.data[12]=t,n.data[13]=i,n}static scale(t,i){const n=gi.identity();return n.data[0]=t,n.data[5]=i,n.data[10]=1,n.data[15]=1,n}static rotation(t){const i=gi.identity();return i.data[0]=Math.cos(t),i.data[4]=-Math.sin(t),i.data[1]=Math.sin(t),i.data[5]=Math.cos(t),i}multiply(t,i){if(t instanceof k){const n=i||new k(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[4]+this.data[12],c=o.x*this.data[1]+o.y*this.data[5]+this.data[13];return n.x=h,n.y=c,n}else{const n=i||new gi,o=t,h=this.data[0],c=this.data[1],_=this.data[2],p=this.data[3],v=this.data[4],x=this.data[5],b=this.data[6],S=this.data[7],P=this.data[8],I=this.data[9],F=this.data[10],R=this.data[11],T=this.data[12],M=this.data[13],W=this.data[14],U=this.data[15],G=o.data[0],j=o.data[1],X=o.data[2],rt=o.data[3],lt=o.data[4],yt=o.data[5],vt=o.data[6],Pt=o.data[7],Dt=o.data[8],B=o.data[9],z=o.data[10],Q=o.data[11],et=o.data[12],Nt=o.data[13],at=o.data[14],Ii=o.data[15];n.data[0]=h*G+v*j+P*X+T*rt,n.data[1]=c*G+x*j+I*X+M*rt,n.data[2]=_*G+b*j+F*X+W*rt,n.data[3]=p*G+S*j+R*X+U*rt,n.data[4]=h*lt+v*yt+P*vt+T*Pt,n.data[5]=c*lt+x*yt+I*vt+M*Pt,n.data[6]=_*lt+b*yt+F*vt+W*Pt,n.data[7]=p*lt+S*yt+R*vt+U*Pt,n.data[8]=h*Dt+v*B+P*z+T*Q,n.data[9]=c*Dt+x*B+I*z+M*Q,n.data[10]=_*Dt+b*B+F*z+W*Q,n.data[11]=p*Dt+S*B+R*z+U*Q,n.data[12]=h*et+v*Nt+P*at+T*Ii,n.data[13]=c*et+x*Nt+I*at+M*Ii,n.data[14]=_*et+b*Nt+F*at+W*Ii,n.data[15]=p*et+S*Nt+R*at+U*Ii;const gs=this.getScale();return n._scaleSignX=qt(gs.x)*qt(n._scaleSignX),n._scaleSignY=qt(gs.y)*qt(n._scaleSignY),n}}translate(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],_=this.data[4],p=this.data[5],v=this.data[6],x=this.data[7],b=this.data[8],S=this.data[9],P=this.data[10],I=this.data[11],F=this.data[12],R=this.data[13],T=this.data[14],M=this.data[15],W=0,U=1;return this.data[12]=n*t+_*i+b*W+F*U,this.data[13]=o*t+p*i+S*W+R*U,this.data[14]=h*t+v*i+P*W+T*U,this.data[15]=c*t+x*i+I*W+M*U,this}setPosition(t,i){this.data[12]=t,this.data[13]=i}getPosition(){return N(this.data[12],this.data[13])}rotate(t){const i=this.data[0],n=this.data[1],o=this.data[2],h=this.data[3],c=this.data[4],_=this.data[5],p=this.data[6],v=this.data[7],x=Math.sin(t),b=Math.cos(t);return this.data[0]=b*i+x*c,this.data[1]=b*n+x*_,this.data[2]=b*o+x*p,this.data[3]=b*h+x*v,this.data[4]=b*c-x*i,this.data[5]=b*_-x*n,this.data[6]=b*p-x*o,this.data[7]=b*v-x*h,this}scale(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],_=this.data[4],p=this.data[5],v=this.data[6],x=this.data[7];return this.data[0]=n*t,this.data[1]=o*t,this.data[2]=h*t,this.data[3]=c*t,this.data[4]=_*i,this.data[5]=p*i,this.data[6]=v*i,this.data[7]=x*i,this}setRotation(t){const i=this.getScale(),n=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=n*i.y,this.data[4]=-n*i.x,this.data[5]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return Ds(t)}getScaleX(){const t=N(this.data[0],this.data[4]).magnitude;return this._scaleSignX*t}getScaleY(){const t=N(this.data[1],this.data[5]).magnitude;return this._scaleSignY*t}getScale(){return N(this.getScaleX(),this.getScaleY())}setScaleX(t){if(this._scaleX===t)return;this._scaleSignX=qt(t);const i=N(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[4]=i.y*t,this._scaleX=t}setScaleY(t){if(this._scaleY===t)return;this._scaleSignY=qt(t);const i=N(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[5]=i.y*t,this._scaleY=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(t){const n=1/this.getBasisDeterminant(),o=this.data[0],h=this.data[4],c=this.data[1],_=this.data[5],p=t||gi.identity();p.data[0]=_*n,p.data[1]=-c*n,p.data[4]=-h*n,p.data[5]=o*n;const v=this.data[12],x=this.data[13];return p.data[12]=-(v*p.data[0]+x*p.data[4]),p.data[13]=-(v*p.data[1]+x*p.data[5]),p}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class ve{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const t=new ve;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}static translation(t,i){const n=ve.identity();return n.data[4]=t,n.data[5]=i,n}static scale(t,i){const n=ve.identity();return n.data[0]=t,n.data[3]=i,n._scale[0]=t,n._scale[1]=i,n}static rotation(t){const i=ve.identity();return i.data[0]=Math.cos(t),i.data[1]=Math.sin(t),i.data[2]=-Math.sin(t),i.data[3]=Math.cos(t),i}setPosition(t,i){this.data[4]=t,this.data[5]=i}getPosition(){return N(this.data[4],this.data[5])}rotate(t){const i=this.data[0],n=this.data[1],o=this.data[2],h=this.data[3],c=Math.sin(t),_=Math.cos(t);return this.data[0]=_*i+c*o,this.data[1]=_*n+c*h,this.data[2]=_*o-c*i,this.data[3]=_*h-c*n,this}translate(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3],_=this.data[4],p=this.data[5];return this.data[4]=n*t+h*i+_,this.data[5]=o*t+c*i+p,this}scale(t,i){const n=this.data[0],o=this.data[1],h=this.data[2],c=this.data[3];return this.data[0]=n*t,this.data[1]=o*t,this.data[2]=h*i,this.data[3]=c*i,this._scale[0]=t,this._scale[1]=i,this._scaleSignX=qt(t),this._scaleSignY=qt(i),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(t){const i=this.determinant();let n=i;i!==0&&(n=1/i);const o=this.data[0],h=this.data[2],c=this.data[1],_=this.data[3],p=t||ve.identity();p.data[0]=_*n,p.data[1]=-c*n,p.data[2]=-h*n,p.data[3]=o*n;const v=this.data[4],x=this.data[5];return p.data[4]=-(v*p.data[0]+x*p.data[2]),p.data[5]=-(v*p.data[1]+x*p.data[3]),p}multiply(t,i){if(t instanceof k){const n=i||new k(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[2]+this.data[4],c=o.x*this.data[1]+o.y*this.data[3]+this.data[5];return n.x=h,n.y=c,n}else{const n=i||new ve,o=t,h=this.data[0],c=this.data[1],_=this.data[2],p=this.data[3],v=this.data[4],x=this.data[5],b=o.data[0],S=o.data[1],P=o.data[2],I=o.data[3],F=o.data[4],R=o.data[5];n.data[0]=h*b+_*S,n.data[1]=c*b+p*S,n.data[2]=h*P+_*I,n.data[3]=c*P+p*I,n.data[4]=h*F+_*R+v,n.data[5]=c*F+p*R+x;const T=this._scaleSignX,M=this._scaleSignY;return n._scaleSignX=T*qt(n._scaleSignX),n._scaleSignY=M*qt(n._scaleSignY),n}}multiplyQuadInPlace(t){const i=t[0]*this.data[0]+t[1]*this.data[2]+this.data[4],n=t[0]*this.data[1]+t[1]*this.data[3]+this.data[5];t[0]=i,t[1]=n;const o=t[2]*this.data[0]+t[3]*this.data[2]+this.data[4],h=t[2]*this.data[1]+t[3]*this.data[3]+this.data[5];t[2]=o,t[3]=h;const c=t[4]*this.data[0]+t[5]*this.data[2]+this.data[4],_=t[4]*this.data[1]+t[5]*this.data[3]+this.data[5];t[4]=c,t[5]=_;const p=t[6]*this.data[0]+t[7]*this.data[2]+this.data[4],v=t[6]*this.data[1]+t[7]*this.data[3]+this.data[5];t[6]=p,t[7]=v}to4x4(){const t=new gi;return t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=0,t.data[3]=0,t.data[4]=this.data[2],t.data[5]=this.data[3],t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=this.data[4],t.data[13]=this.data[5],t.data[14]=0,t.data[15]=1,t}setRotation(t){const i=this.getScale(),n=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=n*i.y,this.data[2]=-n*i.x,this.data[3]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return Ds(t)}getScaleX(){const t=this.data[0]*this.data[0]+this.data[2]*this.data[2];return t===1?this._scaleSignX:this._scaleSignX*Math.sqrt(t)}getScaleY(){const t=this.data[1]*this.data[1]+this.data[3]*this.data[3];return t===1?this._scaleSignY:this._scaleSignY*Math.sqrt(t)}getScale(){return N(this.getScaleX(),this.getScaleY())}setScaleX(t){if(t===this._scale[0])return;this._scaleSignX=qt(t);const i=N(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[2]=i.y*t,this._scale[0]=t}setScaleY(t){if(t===this._scale[1])return;this._scaleSignY=qt(t);const i=N(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[3]=i.y*t,this._scale[1]=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}clone(t){const i=t||new ve;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i._scaleSignX=this._scaleSignX,i._scaleSignY=this._scaleSignY,i}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}let oo=class{constructor(t,i,n=1){this.builder=t,this.cleaner=i,this._pool=[],this._size=0,this.grow(n)}grow(t){if(t>0){this._size+=t;for(let i=0;i<t;i++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}};class Om{constructor(){this._pool=new oo(()=>ve.identity(),t=>t.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(t,i){return this._currentTransform.translate(t,i)}rotate(t){return this._currentTransform.rotate(t)}scale(t,i){return this._currentTransform.scale(t,i)}reset(){this._currentTransform.reset()}set current(t){this._currentTransform=t}get current(){return this._currentTransform}}class Wm{constructor(){this.opacity=1,this.z=0,this.tint=K.White,this.material=null}}class xf{constructor(){this._pool=new oo(()=>new Wm,t=>(t.opacity=1,t.z=0,t.tint=K.White,t.material=null,t),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(t){var i;return t.opacity=this.current.opacity,t.z=this.current.z,t.tint=(i=this.current.tint)===null||i===void 0?void 0:i.clone(),t.material=this.current.material,t}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const Vm={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class ao{constructor(t,i,n=!1){this.path=t,this.responseType=i,this.bustCache=n,this.data=null,this.logger=dt.getInstance(),this.events=new $t}isLoaded(){return this.data!==null}_cacheBust(t){return/\?\w*=\w*/.test(t)?t+="&__="+Date.now():t+="?__="+Date.now(),t}load(){return new Promise((t,i)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),t(this.data);return}const n=new XMLHttpRequest;n.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),n.responseType=this.responseType,n.addEventListener("loadstart",o=>this.events.emit("loadstart",o)),n.addEventListener("progress",o=>this.events.emit("progress",o)),n.addEventListener("error",o=>this.events.emit("error",o)),n.addEventListener("load",o=>this.events.emit("load",o)),n.addEventListener("load",()=>{if(n.status!==0&&n.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",n.status),this.events.emit("error",n.response),i(new Error(n.statusText));return}if(n.response instanceof Blob&&n.response.type==="text/html"){const o=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",n.response),i(new Error(o));return}this.data=n.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),t(this.data)}),n.send()})}}function Oi(d,t){return d&&(d.__isProxy===void 0?new Proxy(d,{set:(i,n,o)=>(i[n]!==o&&(i[n]=o,typeof n=="string"&&n[0]!=="_"&&t(i)),!0),get:(i,n)=>n!=="__isProxy"?i[n]:!0}):d)}const bf=(d=[],t,i)=>({get:(n,o)=>o==="__isProxy"?!0:typeof n[o]=="object"&&n[o]!=null?new Proxy(n[o],bf([...d,o],t,i)):n[o],set:(n,o,h)=>(typeof o=="string"&&o[0]!=="_"&&t(i),n[o]=h,!0)});function Nm(d,t){return d&&(d.__isProxy===void 0?new Proxy(d,bf([],t,d)):d)}class ae{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(t){this._flipHorizontal=t,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(t){this._flipVertical=t,this._transformStale=!0}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._transformStale=!0}get scale(){return this._scale}set scale(t){this._scale=Oi(t,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(t){t&&(this._origin=Oi(t,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(t){var i,n,o,h,c,_,p;this.id=ae._ID++,this.transform=ve.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=k.One,this._width=0,this._height=0,t&&(this.origin=(i=t.origin)!==null&&i!==void 0?i:this.origin,this.flipHorizontal=(n=t.flipHorizontal)!==null&&n!==void 0?n:this.flipHorizontal,this.flipVertical=(o=t.flipVertical)!==null&&o!==void 0?o:this.flipVertical,this.rotation=(h=t.rotation)!==null&&h!==void 0?h:this.rotation,this.opacity=(c=t.opacity)!==null&&c!==void 0?c:this.opacity,this.scale=(_=t.scale)!==null&&_!==void 0?_:this.scale,this.tint=(p=t.tint)!==null&&p!==void 0?p:this.tint,t.width&&(this._width=t.width),t.height&&(this._height=t.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(t){this._width=t,this._transformStale=!0}set height(t){this._height=t,this._transformStale=!0}get localBounds(){return ct.fromDimension(this.width,this.height,k.Zero)}draw(t,i,n){this._preDraw(t,i,n),this._drawImage(t,0,0),this._postDraw(t)}_preDraw(t,i,n){t.save(),t.translate(i,n),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),t.multiply(this.transform),t.opacity=t.opacity*this.opacity,this.tint&&(t.tint=this.tint)}_rotate(t){var i;const n=this.scale.x>0?1:-1,o=this.scale.y>0?1:-1,h=(i=this.origin)!==null&&i!==void 0?i:N(this.width/2,this.height/2);t.translate(h.x,h.y),t.rotate(this.rotation),t.scale(n,o),t.translate(-h.x,-h.y)}_flip(t){this.flipHorizontal&&(t.translate(this.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,this.height/this.scale.y),t.scale(1,-1))}_postDraw(t){this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore()}}ae._ID=0;class Wi extends ae{static from(t,i){return new Wi({image:t,...i})}constructor(t){var i,n;super(t),this._logger=dt.getInstance(),this._dirty=!0,this.image=t.image;const{width:o,height:h}=t;this.sourceView=(i=t.sourceView)!==null&&i!==void 0?i:{x:0,y:0,width:o??0,height:h??0},this.destSize=(n=t.destSize)!==null&&n!==void 0?n:{width:o??0,height:h??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(t){t/=Math.abs(this.scale.x),this.destSize.width=t,super.width=Math.ceil(this.destSize.width)}set height(t){t/=Math.abs(this.scale.y),this.destSize.height=t,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var t,i,n,o,h,c;const{width:_,height:p}=this.image;this.sourceView.width=((t=this.sourceView)===null||t===void 0?void 0:t.width)||_,this.sourceView.height=((i=this.sourceView)===null||i===void 0?void 0:i.height)||p,this.destSize.width=((n=this.destSize)===null||n===void 0?void 0:n.width)||((o=this.sourceView)===null||o===void 0?void 0:o.width)||_,this.destSize.height=((h=this.destSize)===null||h===void 0?void 0:h.height)||((c=this.sourceView)===null||c===void 0?void 0:c.height)||p,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(t,i,n){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(t,i,n)}_drawImage(t,i,n){this.image.isLoaded()?t.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,i,n,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new Wi({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var xe;(function(d){d.Pixel="Pixel",d.Blended="Blended"})(xe||(xe={}));function dr(d){switch(d){case xe.Pixel:return xe.Pixel;case xe.Blended:return xe.Blended;default:return}}var Jt;(function(d){d.Clamp="Clamp",d.Repeat="Repeat",d.Mirror="Mirror"})(Jt||(Jt={}));function Ni(d){switch(d){case Jt.Clamp:return Jt.Clamp;case Jt.Repeat:return Jt.Repeat;case Jt.Mirror:return Jt.Mirror;default:return Jt.Clamp}}class re{constructor(t,i){var n;this._garbageCollector=i,this._textureMap=new Map,this._collect=o=>{var h;if(this._gl){const c=(h=o.dataset.originalSrc)!==null&&h!==void 0?h:o.constructor.name;return re._LOGGER.debug(`WebGL Texture for ${c} collected`),this.delete(o),!0}return!1},this._gl=t,re._MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),this._garbageCollector&&(re._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(n=this._garbageCollector.garbageCollector)===null||n===void 0||n.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[t]of this._textureMap)this.delete(t);this._textureMap.clear(),this._gl=null}get(t){return this._textureMap.get(t)}has(t){return this._textureMap.has(t)}load(t,i,n=!1){var o,h;const c=this._gl;if(!c)return null;const{filtering:_,wrapping:p}={...i};let v=null;if(this.has(t)&&(v=this.get(t)),v)return n&&(c.bindTexture(c.TEXTURE_2D,v),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t)),(o=this._garbageCollector)===null||o===void 0||o.garbageCollector.touch(t),v;v=c.createTexture(),re.checkImageSizeSupportedAndLog(t),c.bindTexture(c.TEXTURE_2D,v),c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let x;p&&(typeof p=="string"?x={x:p,y:p}:x={x:p.x,y:p.y});const{x:b,y:S}=x??re.wrapping;switch(b){case Jt.Clamp:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);break;case Jt.Repeat:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT);break;case Jt.Mirror:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.MIRRORED_REPEAT);break;default:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE)}switch(S){case Jt.Clamp:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);break;case Jt.Repeat:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT);break;case Jt.Mirror:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.MIRRORED_REPEAT);break;default:c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE)}const P=_??re.filtering;return c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,P===xe.Pixel?c.NEAREST:c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,P===xe.Pixel?c.NEAREST:c.LINEAR),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t),this._textureMap.set(t,v),(h=this._garbageCollector)===null||h===void 0||h.garbageCollector.addCollectableResource("texture",t),v}delete(t){const i=this._gl;if(i&&this.has(t)){const n=this.get(t);n&&(this._textureMap.delete(t),i.deleteTexture(n))}}static checkImageSizeSupportedAndLog(t){var i;const n=(i=t.dataset.originalSrc)!==null&&i!==void 0?i:"internal canvas bitmap";return t.width>re._MAX_TEXTURE_SIZE||t.height>re._MAX_TEXTURE_SIZE?(re._LOGGER.error(`The image [${n}] provided to Excalibur is too large for the device's maximum texture size of (${re._MAX_TEXTURE_SIZE}x${re._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((t.width>4096||t.height>4096)&&re._LOGGER.warn(`The image [${n}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}re._LOGGER=dt.getInstance();re.filtering=xe.Blended;re.wrapping={x:Jt.Clamp,y:Jt.Clamp};re._MAX_TEXTURE_SIZE=4096;const Mt={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class as{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(t,i,n){this._logger=dt.getInstance(),this.data=new Image,this._readyFuture=new yi,this.ready=this._readyFuture.promise,this.path=t;let o=!1,h;typeof i=="boolean"?o=i:{filtering:n,wrapping:h,bustCache:o}={...i},this._resource=new ao(t,"blob",o),this.filtering=n??this.filtering,typeof h=="string"?this.wrapping={x:h,y:h}:this.wrapping=h??this.wrapping,t.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${t} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(t,i){const n=new as("");if(n._src="image-element",n.data=t,n.data.setAttribute("data-original-src","image-element"),i?.filtering?n.data.setAttribute(Mt.Filtering,i?.filtering):n.data.setAttribute(Mt.Filtering,xe.Blended),i?.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},n.data.setAttribute(Mt.WrappingX,o.x),n.data.setAttribute(Mt.WrappingY,o.y)}else n.data.setAttribute(Mt.WrappingX,Jt.Clamp),n.data.setAttribute(Mt.WrappingY,Jt.Clamp);return re.checkImageSizeSupportedAndLog(t),n._readyFuture.resolve(t),n}static fromHtmlCanvasElement(t,i){const n=new as("");if(n._src="canvas-element-blob",n.data.setAttribute("data-original-src","canvas-element-blob"),i?.filtering?n.data.setAttribute(Mt.Filtering,i?.filtering):n.data.setAttribute(Mt.Filtering,xe.Blended),i?.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},n.data.setAttribute(Mt.WrappingX,o.x),n.data.setAttribute(Mt.WrappingY,o.y)}else n.data.setAttribute(Mt.WrappingX,Jt.Clamp),n.data.setAttribute(Mt.WrappingY,Jt.Clamp);return re.checkImageSizeSupportedAndLog(t),t.toBlob(o=>{const h=URL.createObjectURL(o);n.image.onload=()=>{URL.revokeObjectURL(h),n.data=n.image,n._readyFuture.resolve(n.image)},n.image.src=h}),n}static fromSvgString(t,i){const n=new Blob([t],{type:"image/svg+xml"}),o=URL.createObjectURL(n);return new as(o,i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){var t,i,n,o;if(this.isLoaded())return this.data;try{let h;if(this.path.includes("data:image/"))h=this.path;else{const p=await this._resource.load();h=URL.createObjectURL(p)}const c=new Image,_=new yi;c.onload=()=>_.resolve(),c.src=h,c.setAttribute("data-original-src",this.path),await _.promise,this.data=c,re.checkImageSizeSupportedAndLog(this.data)}catch(h){throw`Error loading ImageSource from path '${this.path}' with error [${h.message}]`}return this.data.setAttribute(Mt.Filtering,this.filtering),this.data.setAttribute(Mt.WrappingX,(i=(t=this.wrapping)===null||t===void 0?void 0:t.x)!==null&&i!==void 0?i:Jt.Clamp),this.data.setAttribute(Mt.WrappingY,(o=(n=this.wrapping)===null||n===void 0?void 0:n.y)!==null&&o!==void 0?o:Jt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(t){return Wi.from(this,t)}unload(){this.data=new Image}}class Ea extends ae{constructor(t){super(t),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=dt.getInstance();const{alphabet:i,spriteSheet:n,caseInsensitive:o,spacing:h,shadow:c,lineHeight:_}=t;this.alphabet=i,this.spriteSheet=n,this.caseInsensitive=o??this.caseInsensitive,this.spacing=h??this.spacing,this.shadow=c??this.shadow,this.lineHeight=_??this.lineHeight}_getCharacterSprites(t){const i=[],n=this.caseInsensitive?t.toLocaleLowerCase():t,o=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let h=0;h<n.length;h++){const c=n[h];let _=o.indexOf(c);_===-1&&(_=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${c}' in configured alphabet '${o}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const p=this.spriteSheet.sprites[_];p?i.push(p):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${c}' at index '${_}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return i}measureText(t,i){const n=this._getLinesFromText(t,i),o=n.reduce((p,v)=>p.length>v.length?p:v),h=this._getCharacterSprites(o);let c=0,_=0;for(const p of h)c+=p.width+this.spacing,_=Math.max(_,p.height);return ct.fromDimension(c*this.scale.x,_*n.length*this.scale.y,k.Zero)}_drawImage(t,i,n,o){var h;let c=0,_=0,p=0;const v=this._getLinesFromText(this._text,o);for(const x of v){for(const b of this._getCharacterSprites(x))b.draw(t,i+c,n+_),c+=b.width+this.spacing,p=Math.max(p,b.height);c=0,_+=(h=this.lineHeight)!==null&&h!==void 0?h:p}}render(t,i,n,o,h,c){this._text=i;const _=this.measureText(i,c);this.width=_.width,this.height=_.height,this.shadow&&(t.save(),t.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(t,o,h),this._drawImage(t,0,0,c),this._postDraw(t),t.restore()),this._preDraw(t,o,h),this._drawImage(t,0,0,c),this._postDraw(t)}clone(){return new Ea({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(t,i){var n;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let c=o[h],_="";if(this.measureText(c).width>i){for(;this.measureText(c).width>i;)_=c[c.length-1]+_,c=c.slice(0,-1);o[h]=c,o[h+1]=_}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class ho extends Wi{constructor(t){super({image:t.image,sourceView:t.sourceView,destSize:{width:t.width,height:t.height},flipHorizontal:t.flipHorizontal,flipVertical:t.flipVertical,rotation:t.rotation,scale:t.scale,opacity:t.opacity,tint:t.tint,origin:t.origin}),this._ready=new yi,this.ready=this._ready.promise,this._options=t,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(t,i){return new ho({sourceView:{...t.sourceView},width:t.width,height:t.height,...i,image:t.image})}_applyTiling(){const{width:t,height:i,filtering:n,wrapping:o}={...this._options},h=document.createElement("canvas");h.width=this.sourceView.width,h.height=this.sourceView.height,h.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const _=as.fromHtmlCanvasElement(h,{wrapping:o??Jt.Repeat,filtering:n});t&&(this.destSize.width=t,this.sourceView.width=t),i&&(this.destSize.height=i,this.sourceView.height=i),this.sourceView.x=0,this.sourceView.y=0,this.image=_,this.image.ready.then(()=>this._ready.resolve())}}class En{constructor(t){this.sprites=[];const{sprites:i,rows:n,columns:o}=t;this.sprites=i,this.rows=n??1,this.columns=o??this.sprites.length}getSprite(t,i,n){var o,h,c,_,p,v,x,b,S;if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const P=t+i*this.columns,I=this.sprites[P];if(I){if(n){const F=I.clone();return F.flipHorizontal=(o=n.flipHorizontal)!==null&&o!==void 0?o:F.flipHorizontal,F.flipVertical=(h=n.flipVertical)!==null&&h!==void 0?h:F.flipVertical,F.width=(c=n.width)!==null&&c!==void 0?c:F.width,F.height=(_=n.height)!==null&&_!==void 0?_:F.height,F.rotation=(p=n.rotation)!==null&&p!==void 0?p:F.rotation,F.scale=(v=n.scale)!==null&&v!==void 0?v:F.scale,F.opacity=(x=n.opacity)!==null&&x!==void 0?x:F.opacity,F.tint=(b=n.tint)!==null&&b!==void 0?b:F.tint,F.origin=(S=n.origin)!==null&&S!==void 0?S:F.origin,F}return I}throw Error(`Invalid sprite coordinates (${t}, ${i})`)}getTiledSprite(t,i,n){if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const o=t+i*this.columns,h=this.sprites[o];if(h)return ho.fromSprite(h,n);throw Error(`Invalid sprite coordinates (${t}, ${i})`)}static fromImageSourceWithSourceViews(t){const i=t.sourceViews.map(n=>new Wi({image:t.image,sourceView:n}));return new En({sprites:i})}static fromImageSource(t){var i;const n=[];t.spacing=(i=t.spacing)!==null&&i!==void 0?i:{};const{image:o,grid:{rows:h,columns:c,spriteWidth:_,spriteHeight:p},spacing:{originOffset:v,margin:x}}=t,b={x:0,y:0,...v},S={x:0,y:0,...x};for(let P=0;P<c;P++)for(let I=0;I<h;I++)n[P+I*c]=new Wi({image:o,sourceView:{x:P*_+S.x*P+b.x,y:I*p+S.y*I+b.y,width:_,height:p},destSize:{height:p,width:_}});return new En({sprites:n,rows:h,columns:c})}clone(){return new En({sprites:this.sprites.map(t=>t.clone()),rows:this.rows,columns:this.columns})}}const Gm="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class ec{constructor(){this.fontSheet=Gm,this.size=16,this.load()}load(){return this._imageSource=new as(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=En.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new Ea({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(t,i,n){this._imageSource.isLoaded()&&this._spriteFont.render(t,i,null,n.x,n.y)}}class Xm{constructor(t,i){this._gl=t,this._texture=i}use(){const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture)}disable(){const t=this._gl;t.bindTexture(t.TEXTURE_2D,null)}}class sa{constructor(t){var i,n;this.antialias=!1,this.samples=1,this._gl=t.gl,this.width=t.width,this.height=t.height,this.transparency=t.transparency,this.antialias=(i=t.antialias)!==null&&i!==void 0?i:this.antialias,this.samples=(n=t.samples)!==null&&n!==void 0?n:this._gl.getParameter(this._gl.MAX_SAMPLES);const o=this._gl;o.drawingBufferFormat?this.bufferFormat=o.drawingBufferFormat:this.transparency?this.bufferFormat=o.RGBA8:this.bufferFormat=o.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(t,i){const n=this._gl;this.width=t,this.height=i,n.bindTexture(n.TEXTURE_2D,this._frameTexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.width,this.height,0,n.RGBA,n.UNSIGNED_BYTE,null),this._renderBuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,this._renderBuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,Math.min(this.samples,n.getParameter(n.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const t=this._gl;this._renderBuffer=t.createRenderbuffer(),this._renderFrameBuffer=t.createFramebuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._renderBuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,Math.min(this.samples,t.getParameter(t.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const t=this._gl;this._frameTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._frameTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const i=t.COLOR_ATTACHMENT0;this._frameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,i,t.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new Xm(this._gl,this._frameTexture)}blitToScreen(){const t=this._gl;this._renderBuffer?(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)):(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.frameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const t=this._gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.frameBuffer),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)}}copyToTexture(t){const i=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this._frameBuffer),i.bindTexture(i.TEXTURE_2D,t),i.copyTexImage2D(i.TEXTURE_2D,0,i.RGBA,0,0,this.width,this.height,0)}use(){const t=this._gl;this.antialias?t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.viewport(0,0,this.width,this.height)}disable(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null)}}const qm=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,Ym=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function Sl(d,t){switch(t){case d.INT:case d.UNSIGNED_INT:case d.FLOAT:return 4;case d.SHORT:return 2;case d.UNSIGNED_SHORT:return 2;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;default:return 1}}function Af(d,t){const i=`(?<type>[a-z0-9]+)\\s+${t};`,o=new RegExp(i,"g").exec(d);return o?.length>0}function yf(d,t,i){var n;const o=`(?<type>[a-z0-9]+)\\s+${i};`,c=new RegExp(o,"g").exec(t);switch((n=c?.groups)===null||n===void 0?void 0:n.type){case"float":case"vec2":case"vec3":case"vec4":return d.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return d.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return d.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return d.BOOL;case"short":return d.SHORT;case"ushort":return d.UNSIGNED_SHORT;case"ubyte":return d.UNSIGNED_BYTE;case"byte":return d.BYTE;default:return d.FLOAT}}function Cf(d,t){switch(t){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:return 1;case d.FLOAT_VEC2:return 2;case d.FLOAT_VEC3:return 3;case d.FLOAT_VEC4:return 4;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;case d.UNSIGNED_SHORT:case d.SHORT:return 1;default:return 1}}function Sf(d,t){switch(t){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:case d.FLOAT_VEC2:case d.FLOAT_VEC3:case d.FLOAT_VEC4:return d.FLOAT;case d.BYTE:return d.BYTE;case d.UNSIGNED_BYTE:return d.UNSIGNED_BYTE;case d.SHORT:return d.SHORT;case d.UNSIGNED_SHORT:return d.UNSIGNED_SHORT;default:return d.FLOAT}}function ic(d,t){const i=o=>{const h=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let c="";for(let _=0;_<o;_++)_===0?c+=`if (index <= ${_}.5) {
`:c+=`   else if (index <= ${_}.5) {
`,c+=`      fragColor = vec4(1.0);
`,c+=`   }
`;return h.replace("%%complexity%%",c)};let n=!1;do{const o=i(t),h=d.createShader(d.FRAGMENT_SHADER);d.shaderSource(h,o),d.compileShader(h),n=d.getShaderParameter(h,d.COMPILE_STATUS),n||(t=t/2|0)}while(!n);return t}class di{get compiled(){return this._compiled}constructor(t){this._logger=dt.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:i,vertexSource:n,fragmentSource:o,onPreLink:h,onPostCompile:c}=t;this._gl=i,this.vertexSource=n,this.fragmentSource=o,this._onPreLink=h,this._onPostCompile=c}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),di._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return di._ACTIVE_SHADER_INSTANCE===this}compile(){const t=this._gl,i=this._compileShader(t,this.vertexSource,t.VERTEX_SHADER),n=this._compileShader(t,this.fragmentSource,t.FRAGMENT_SHADER);this.program=this._createProgram(t,i,n);const o=this.getAttributes();for(const c of o)this.attributes[c.name]=c;const h=this.getUniforms();for(const c of h)this.uniforms[c.name]=c;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS),n=[];for(let o=0;o<i;o++){const h=t.getActiveUniform(this.program,o),c=t.getUniformLocation(this.program,h.name);n.push({name:h.name,glType:h.type,location:c})}return n}getAttributes(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES),n=[];for(let o=0;o<i;o++){const h=t.getActiveAttrib(this.program,o),c=t.getAttribLocation(this.program,h.name);n.push({name:h.name,glType:Sf(t,h.type),size:Cf(t,h.type),location:c,normalized:!1})}return n}setTexture(t,i){const n=this._gl;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,i)}setUniformInt(t,i){this.setUniform("uniform1i",t,~~i)}trySetUniformInt(t,i){return this.trySetUniform("uniform1i",t,~~i)}setUniformIntArray(t,i){this.setUniform("uniform1iv",t,i)}trySetUniformIntArray(t,i){return this.trySetUniform("uniform1iv",t,i)}setUniformBoolean(t,i){this.setUniform("uniform1i",t,i?1:0)}trySetUniformBoolean(t,i){return this.trySetUniform("uniform1i",t,i?1:0)}setUniformFloat(t,i){this.setUniform("uniform1f",t,i)}trySetUniformFloat(t,i){return this.trySetUniform("uniform1f",t,i)}setUniformFloatArray(t,i){this.setUniform("uniform1fv",t,i)}trySetUniformFloatArray(t,i){return this.trySetUniform("uniform1fv",t,i)}setUniformFloatVector(t,i){this.setUniform("uniform2f",t,i.x,i.y)}trySetUniformFloatVector(t,i){return this.trySetUniform("uniform2f",t,i.x,i.y)}setUniformFloatColor(t,i){this.setUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}trySetUniformFloatColor(t,i){return this.trySetUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}setUniformMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,i.data)}setUniformAffineMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,[i.data[0],i.data[1],0,0,i.data[2],i.data[3],0,0,0,0,1,0,i.data[4],i.data[5],0,1])}trySetUniformMatrix(t,i){return this.trySetUniform("uniformMatrix4fv",t,!1,i.data)}setUniform(t,i,...n){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${t}:${i}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const h=this._gl.getUniformLocation(this.program,i);if(h){const c=[h,...n];this._gl[t].apply(this._gl,c)}else throw Error(`Uniform ${t}:${i} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(t,i,...n){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${t}:${i}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const h=this._gl.getUniformLocation(this.program,i);if(h){const c=[h,...n];this._gl[t].apply(this._gl,c)}else return!1;return!0}_createProgram(t,i,n){const o=t.createProgram();if(o===null)throw Error("Could not create graphics shader program");if(t.attachShader(o,i),t.attachShader(o,n),this._onPreLink&&this._onPreLink(o),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw Error(`Could not link the program: [${t.getProgramInfoLog(o)}]`);return o}_compileShader(t,i,n){const o=t.VERTEX_SHADER===n?"vertex":"fragment",h=t.createShader(n);if(h===null)throw Error(`Could not build shader: [${i}]`);if(t.shaderSource(h,i),t.compileShader(h),!t.getShaderParameter(h,t.COMPILE_STATUS)){const _=t.getShaderInfoLog(h);throw Error(`Could not compile ${o} shader:

${_}${this._processSourceForError(i,_)}`)}return h}_processSourceForError(t,i){if(!t)return i;const n=t.split(`
`),o=i.search(/\d:\d/),h=i.indexOf(" ",o),[c,_]=i.slice(o,h).split(":").map(p=>Number(p));for(let p=0;p<n.length;p++)n[p]=`${p+1}: ${n[p]}${_===p+1?" <----- ERROR!":""}`;return`

Source:
`+n.join(`
`)}}di._ACTIVE_SHADER_INSTANCE=null;class us{constructor(t){this.type="dynamic";const{gl:i,size:n,type:o,data:h}=t;if(this._gl=i,this.buffer=this._gl.createBuffer(),!h&&!n)throw Error("Must either provide data or a size to the VertexBuffer");h?this.bufferData=h:this.bufferData=new Float32Array(n),this.type=o??this.type,i.bindBuffer(i.ARRAY_BUFFER,this.buffer),i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this.buffer)}unbind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,null)}upload(t){const i=this._gl;i.bindBuffer(i.ARRAY_BUFFER,this.buffer),t?i.bufferSubData(i.ARRAY_BUFFER,0,this.bufferData,0,t):i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class Us{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(t){this._logger=dt.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:i,shader:n,vertexBuffer:o,attributes:h,suppressWarnings:c}=t;this._gl=i,this._vertexBuffer=o,this._attributes=h,this._shader=n,this._suppressWarnings=c,n&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(t){t&&this._shader!==t&&(this._shader=t,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const t=this._shader.attributes;for(const h of this._attributes){const c=t[h[0]];if(!c){if(!Af(this._shader.vertexSource,h[0]))throw Error(`The attribute named: ${h[0]} size ${h[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${h[0]} size ${h[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${h[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${h[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const _=yf(this._gl,this._shader.vertexSource,h[0]);this._layout.push({name:h[0],glType:_,size:h[1],location:-1,normalized:!1})}if(c){if(c.size!==h[1])throw Error(`VertexLayout size definition for attribute: [${h[0]}, ${h[1]}], doesn't match shader source size ${c.size}:
 ${this._shader.vertexSource}`);this._layout.push(c)}}let i=0;for(const h of this._layout){const c=Sl(this._gl,h.glType);this._vertexTotalSizeBytes+=c*h.size,i+=h.size}this._vertexBuffer.bufferData.length%i!==0&&this._logger.warn(`The vertex component size (${i})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const n=this._gl;this._vao=n.createVertexArray(),n.bindVertexArray(this._vao),this._vertexBuffer.bind();let o=0;for(const h of this._layout)h.location!==-1&&(h.glType===n.INT?n.vertexAttribIPointer(h.location,h.size,h.glType,this.totalVertexSizeBytes,o):n.vertexAttribPointer(h.location,h.size,h.glType,h.normalized,this.totalVertexSizeBytes,o),n.enableVertexAttribArray(h.location)),o+=Sl(n,h.glType)*h.size;n.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(t=!1,i){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const n=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),t&&this._vertexBuffer.upload(i),n.bindVertexArray(this._vao)}}class Kt{static clear(){Kt.DrawCallCount=0,Kt.DrawnImagesCount=0}}Kt.DrawCallCount=0;Kt.DrawnImagesCount=0;class jm{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=N(0,0),this._endScratch=N(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new di({gl:t,vertexSource:qm,fragmentSource:Ym}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new us({gl:t,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new Us({gl:t,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,n){this._isFull()&&this.flush(),this._lineCount++;const o=this._context.getTransform(),h=o.multiply(t,this._startScratch),c=o.multiply(i,this._endScratch),_=this._vertexBuffer.bufferData;_[this._vertexIndex++]=h.x,_[this._vertexIndex++]=h.y,_[this._vertexIndex++]=n.r/255,_[this._vertexIndex++]=n.g/255,_[this._vertexIndex++]=n.b/255,_[this._vertexIndex++]=n.a,_[this._vertexIndex++]=c.x,_[this._vertexIndex++]=c.y,_[this._vertexIndex++]=n.r/255,_[this._vertexIndex++]=n.g/255,_[this._vertexIndex++]=n.b/255,_[this._vertexIndex++]=n.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.LINES,0,this._lineCount*2),Kt.DrawnImagesCount+=this._lineCount,Kt.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const Zm=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,Qm=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class Jm{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new di({gl:t,vertexSource:Zm,fragmentSource:Qm}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new us({gl:t,size:7*this._maxPoints,type:"dynamic"}),this._layout=new Us({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,n){this._isFull()&&this.flush(),this._pointCount++;const o=this._context.getTransform(),h=this._context.opacity,c=this._context.snapToPixel,_=o.multiply(t);c&&(_.x=~~(_.x+mt),_.y=~~(_.y+mt));const p=this._buffer.bufferData;p[this._vertexIndex++]=_.x,p[this._vertexIndex++]=_.y,p[this._vertexIndex++]=i.r/255,p[this._vertexIndex++]=i.g/255,p[this._vertexIndex++]=i.b/255,p[this._vertexIndex++]=i.a*h,p[this._vertexIndex++]=n*Math.max(o.getScaleX(),o.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.POINTS,0,this._pointCount),Kt.DrawnImagesCount+=this._pointCount,Kt.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const Km=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,$m=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class tv{constructor(t){this._gl=t,this._shader=new di({gl:t,vertexSource:Km,fragmentSource:$m}),this._shader.compile(),this._buffer=new us({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Us({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(t){const i=this._gl,n=t.getShader();n.use(),t.getLayout().use(),i.activeTexture(i.TEXTURE0),n.trySetUniformInt("u_image",0),t.onDraw&&t.onDraw(),i.drawArrays(i.TRIANGLES,0,6)}renderToScreen(){const t=this._gl;this._shader.use(),this._layout.use(),t.drawArrays(t.TRIANGLES,0,6)}}class lo{constructor(t,i,n){this._logger=dt.getInstance(),this._gl=t,this.buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer);const o=i*6;if(!n)this.bufferData=new Uint32Array(o);else{const _=Math.floor(16383.5);this.bufferGlType=t.UNSIGNED_SHORT,this.bufferData=new Uint16Array(o),i>_&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${_}) requested quads(${i})`)}let h=0;for(let c=0;c<o;c+=6)this.bufferData[c+0]=h+0,this.bufferData[c+1]=h+1,this.bufferData[c+2]=h+2,this.bufferData[c+3]=h+2,this.bufferData[c+4]=h+1,this.bufferData[c+5]=h+3,h+=4;t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const ev=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,iv=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class sv{constructor(t){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=K.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=ic(t,n);this._maxTextures=Math.min(n,o);const h=this._transformFragmentSource(ev,this._maxTextures);this._shader=new di({gl:t,fragmentSource:h,vertexSource:iv}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((c,_)=>_)),this._buffer=new us({gl:t,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new Us({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new lo(t,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let n=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_textureIndex <= ${h}.5) {
`:o+=`   else if (v_textureIndex <= ${h}.5) {
`,o+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return n=n.replace("%%texture_picker%%",o),n}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(Mt.Filtering),n=i?dr(i):void 0,o=Ni(t.getAttribute(Mt.WrappingX)),h=Ni(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&(this._textures.push(_),this._textureToIndex.set(_,this._textureIndex++),this._images.add(t))}_bindTextures(t){for(let i=0;i<this._maxTextures;i++)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,this._textures[i]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const n=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(n))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,n,o,h,c,_,p,v){var x,b,S,P;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const I=this._getImageWidth(t),F=this._getImageHeight(t);let R=I||o||0,T=F||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(x=o??I)!==null&&x!==void 0?x:0,this._view[3]=(b=h??F)!==null&&b!==void 0?b:0,this._dest[0]=i??1,this._dest[1]=n??1,c!==void 0&&_!==void 0&&p!==void 0&&v!==void 0&&(this._view[0]=i??1,this._view[1]=n??1,this._view[2]=(S=o??I)!==null&&S!==void 0?S:0,this._view[3]=(P=h??F)!==null&&P!==void 0?P:0,this._dest[0]=c,this._dest[1]=_,R=p,T=v),i=this._view[0],n=this._view[1];const M=this._view[2],W=this._view[3],U=this._context.getTransform(),G=this._context.opacity,j=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+R,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+T,this._quad[6]=this._dest[0]+R,this._quad[7]=this._dest[1]+T,U.multiplyQuadInPlace(this._quad),j&&(this._quad[0]=~~(this._quad[0]+qt(this._quad[0])*mt),this._quad[1]=~~(this._quad[1]+qt(this._quad[1])*mt),this._quad[2]=~~(this._quad[2]+qt(this._quad[2])*mt),this._quad[3]=~~(this._quad[3]+qt(this._quad[3])*mt),this._quad[4]=~~(this._quad[4]+qt(this._quad[4])*mt),this._quad[5]=~~(this._quad[5]+qt(this._quad[5])*mt),this._quad[6]=~~(this._quad[6]+qt(this._quad[6])*mt),this._quad[7]=~~(this._quad[7]+qt(this._quad[7])*mt));const X=this._context.tint||this._defaultTint,rt=this._getTextureIdForImage(t),lt=I||R,yt=F||T,vt=(i+this.uvPadding)/lt,Pt=(n+this.uvPadding)/yt,Dt=(i+M-this.uvPadding)/lt,B=(n+W-this.uvPadding)/yt,z=I,Q=F,et=this._layout.vertexBuffer.bufferData;et[this._vertexIndex++]=this._quad[0],et[this._vertexIndex++]=this._quad[1],et[this._vertexIndex++]=G,et[this._vertexIndex++]=z,et[this._vertexIndex++]=Q,et[this._vertexIndex++]=vt,et[this._vertexIndex++]=Pt,et[this._vertexIndex++]=rt,et[this._vertexIndex++]=X.r/255,et[this._vertexIndex++]=X.g/255,et[this._vertexIndex++]=X.b/255,et[this._vertexIndex++]=X.a,et[this._vertexIndex++]=this._quad[4],et[this._vertexIndex++]=this._quad[5],et[this._vertexIndex++]=G,et[this._vertexIndex++]=z,et[this._vertexIndex++]=Q,et[this._vertexIndex++]=vt,et[this._vertexIndex++]=B,et[this._vertexIndex++]=rt,et[this._vertexIndex++]=X.r/255,et[this._vertexIndex++]=X.g/255,et[this._vertexIndex++]=X.b/255,et[this._vertexIndex++]=X.a,et[this._vertexIndex++]=this._quad[2],et[this._vertexIndex++]=this._quad[3],et[this._vertexIndex++]=G,et[this._vertexIndex++]=z,et[this._vertexIndex++]=Q,et[this._vertexIndex++]=Dt,et[this._vertexIndex++]=Pt,et[this._vertexIndex++]=rt,et[this._vertexIndex++]=X.r/255,et[this._vertexIndex++]=X.g/255,et[this._vertexIndex++]=X.b/255,et[this._vertexIndex++]=X.a,et[this._vertexIndex++]=this._quad[6],et[this._vertexIndex++]=this._quad[7],et[this._vertexIndex++]=G,et[this._vertexIndex++]=z,et[this._vertexIndex++]=Q,et[this._vertexIndex++]=Dt,et[this._vertexIndex++]=B,et[this._vertexIndex++]=rt,et[this._vertexIndex++]=X.r/255,et[this._vertexIndex++]=X.g/255,et[this._vertexIndex++]=X.b/255,et[this._vertexIndex++]=X.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),this._quads.bind(),t.drawElements(t.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),Kt.DrawnImagesCount+=this._imageCount,Kt.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const nv=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,rv=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class ov{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=K.Transparent,this._scratch1=N(0,0),this._scratch2=N(0,0),this._scratch3=N(0,0),this._scratch4=N(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new di({gl:t,fragmentSource:nv,vertexSource:rv}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new us({gl:t,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new Us({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new lo(t,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...t){t[0]instanceof k&&t[1]instanceof k?this.drawLine.apply(this,t):this.drawRectangle.apply(this,t)}drawLine(t,i,n,o=1){this._isFull()&&this.flush(),this._rectangleCount++;const h=this._context.getTransform(),c=this._context.opacity,_=this._context.snapToPixel,p=i.sub(t),v=p.magnitude,x=p.normalize().perpendicular(),b=o/2,S=h.multiply(x.scale(b,this._scratch1).add(t,this._scratch1),this._scratch1),P=h.multiply(x.scale(-b,this._scratch2).add(t,this._scratch2),this._scratch2),I=h.multiply(x.scale(b,this._scratch3).add(i,this._scratch3),this._scratch3),F=h.multiply(x.scale(-b,this._scratch4).add(i,this._scratch4),this._scratch4);_&&(S.x=~~(S.x+mt),S.y=~~(S.y+mt),I.x=~~(I.x+mt),I.y=~~(I.y+mt),P.x=~~(P.x+mt),P.y=~~(P.y+mt),F.x=~~(F.x+mt),F.y=~~(F.y+mt));const R=0,T=0,M=1,W=1,U=this._transparent,G=0,j=1,X=this._layout.vertexBuffer.bufferData;X[this._vertexIndex++]=S.x,X[this._vertexIndex++]=S.y,X[this._vertexIndex++]=R,X[this._vertexIndex++]=T,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=G/j,X[this._vertexIndex++]=P.x,X[this._vertexIndex++]=P.y,X[this._vertexIndex++]=R,X[this._vertexIndex++]=W,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=G/j,X[this._vertexIndex++]=I.x,X[this._vertexIndex++]=I.y,X[this._vertexIndex++]=M,X[this._vertexIndex++]=T,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=G/j,X[this._vertexIndex++]=F.x,X[this._vertexIndex++]=F.y,X[this._vertexIndex++]=M,X[this._vertexIndex++]=W,X[this._vertexIndex++]=v,X[this._vertexIndex++]=o,X[this._vertexIndex++]=c,X[this._vertexIndex++]=n.r/255,X[this._vertexIndex++]=n.g/255,X[this._vertexIndex++]=n.b/255,X[this._vertexIndex++]=n.a,X[this._vertexIndex++]=U.r/255,X[this._vertexIndex++]=U.g/255,X[this._vertexIndex++]=U.b/255,X[this._vertexIndex++]=U.a,X[this._vertexIndex++]=G/j}drawRectangle(t,i,n,o,h=K.Transparent,c=0){this._isFull()&&this.flush(),this._rectangleCount++;const _=this._context.getTransform(),p=this._context.opacity,v=this._context.snapToPixel,x=_.multiply(t.add(N(0,0))),b=_.multiply(t.add(N(i,0))),S=_.multiply(t.add(N(i,n))),P=_.multiply(t.add(N(0,n)));v&&(x.x=~~(x.x+mt),x.y=~~(x.y+mt),b.x=~~(b.x+mt),b.y=~~(b.y+mt),P.x=~~(P.x+mt),P.y=~~(P.y+mt),S.x=~~(S.x+mt),S.y=~~(S.y+mt));const I=0,F=0,R=1,T=1,M=this._layout.vertexBuffer.bufferData;M[this._vertexIndex++]=x.x,M[this._vertexIndex++]=x.y,M[this._vertexIndex++]=I,M[this._vertexIndex++]=F,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=p,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=P.x,M[this._vertexIndex++]=P.y,M[this._vertexIndex++]=I,M[this._vertexIndex++]=T,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=p,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=b.x,M[this._vertexIndex++]=b.y,M[this._vertexIndex++]=R,M[this._vertexIndex++]=F,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=p,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c,M[this._vertexIndex++]=S.x,M[this._vertexIndex++]=S.y,M[this._vertexIndex++]=R,M[this._vertexIndex++]=T,M[this._vertexIndex++]=i,M[this._vertexIndex++]=n,M[this._vertexIndex++]=p,M[this._vertexIndex++]=o.r/255,M[this._vertexIndex++]=o.g/255,M[this._vertexIndex++]=o.b/255,M[this._vertexIndex++]=o.a,M[this._vertexIndex++]=h.r/255,M[this._vertexIndex++]=h.g/255,M[this._vertexIndex++]=h.b/255,M[this._vertexIndex++]=h.a,M[this._vertexIndex++]=c}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),Kt.DrawnImagesCount+=this._rectangleCount,Kt.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const av=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,hv=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class lv{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new di({gl:t,fragmentSource:av,vertexSource:hv}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new us({gl:t,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new Us({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new lo(t,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(t,i,n,o=K.Transparent,h=0){this._isFull()&&this.flush(),this._circleCount++;const c=this._context.getTransform(),_=this._context.opacity,p=this._context.snapToPixel,v=c.multiply(t.add(N(-i,-i))),x=c.multiply(t.add(N(i,-i))),b=c.multiply(t.add(N(i,i))),S=c.multiply(t.add(N(-i,i)));p&&(v.x=~~(v.x+mt),v.y=~~(v.y+mt),x.x=~~(x.x+mt),x.y=~~(x.y+mt),S.x=~~(S.x+mt),S.y=~~(S.y+mt),b.x=~~(b.x+mt),b.y=~~(b.y+mt));const P=0,I=0,F=1,R=1,T=this._layout.vertexBuffer.bufferData;T[this._vertexIndex++]=v.x,T[this._vertexIndex++]=v.y,T[this._vertexIndex++]=P,T[this._vertexIndex++]=I,T[this._vertexIndex++]=_,T[this._vertexIndex++]=n.r/255,T[this._vertexIndex++]=n.g/255,T[this._vertexIndex++]=n.b/255,T[this._vertexIndex++]=n.a,T[this._vertexIndex++]=o.r/255,T[this._vertexIndex++]=o.g/255,T[this._vertexIndex++]=o.b/255,T[this._vertexIndex++]=o.a,T[this._vertexIndex++]=h/i,T[this._vertexIndex++]=S.x,T[this._vertexIndex++]=S.y,T[this._vertexIndex++]=P,T[this._vertexIndex++]=R,T[this._vertexIndex++]=_,T[this._vertexIndex++]=n.r/255,T[this._vertexIndex++]=n.g/255,T[this._vertexIndex++]=n.b/255,T[this._vertexIndex++]=n.a,T[this._vertexIndex++]=o.r/255,T[this._vertexIndex++]=o.g/255,T[this._vertexIndex++]=o.b/255,T[this._vertexIndex++]=o.a,T[this._vertexIndex++]=h/i,T[this._vertexIndex++]=x.x,T[this._vertexIndex++]=x.y,T[this._vertexIndex++]=F,T[this._vertexIndex++]=I,T[this._vertexIndex++]=_,T[this._vertexIndex++]=n.r/255,T[this._vertexIndex++]=n.g/255,T[this._vertexIndex++]=n.b/255,T[this._vertexIndex++]=n.a,T[this._vertexIndex++]=o.r/255,T[this._vertexIndex++]=o.g/255,T[this._vertexIndex++]=o.b/255,T[this._vertexIndex++]=o.a,T[this._vertexIndex++]=h/i,T[this._vertexIndex++]=b.x,T[this._vertexIndex++]=b.y,T[this._vertexIndex++]=F,T[this._vertexIndex++]=R,T[this._vertexIndex++]=_,T[this._vertexIndex++]=n.r/255,T[this._vertexIndex++]=n.g/255,T[this._vertexIndex++]=n.b/255,T[this._vertexIndex++]=n.a,T[this._vertexIndex++]=o.r/255,T[this._vertexIndex++]=o.g/255,T[this._vertexIndex++]=o.b/255,T[this._vertexIndex++]=o.a,T[this._vertexIndex++]=h/i}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),Kt.DrawnImagesCount+=this._circleCount,Kt.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class Ia{constructor(t,i,n=100){this.builder=t,this.recycler=i,this.maxObjects=n,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=dt.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let t=0;t<this.maxObjects;t++)this.objects[t]=this.builder()}using(t){const i=t(this);return i?this.done(...i):this.done()}borrow(t){const i=this.get();t(i),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...t){this.index=0;for(const i of t){const n=this.objects.indexOf(i);this.objects[n]=this.builder(),this.totalAllocations++}return t}}class cv{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=ve.identity(),this.state={z:0,opacity:1,tint:K.White,material:null},this.args=new Array(10)}}const dv=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class Pf{constructor(t){this._logger=dt.getInstance(),this._color=K.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:i,name:n,vertexSource:o,fragmentSource:h,graphicsContext:c,images:_}=t;if(this._name=n??"anonymous material",this._vertexSource=o??dv,this._fragmentSource=h,this._color=i??this._color,!c)throw Error(`Material ${n} must be provided an excalibur webgl graphics context`);if(c instanceof Fs?(this._graphicsContext=c,this._initialize(c)):this._logger.warn(`Material ${n} was created in 2D Canvas mode, currently only WebGL is supported`),_)for(const p in _)this.addImageSource(p,_[p])}_initialize(t){if(this._initialized)return;const i=t.__gl;this._maxTextureSlots=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=t.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(t){this._color=t}get name(){var t;return(t=this._name)!==null&&t!==void 0?t:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(t){this._shader&&(this._shader.use(),t(this._shader))}getShader(){return this._shader}addImageSource(t,i){this._images.size<this._maxTextureSlots?this._images.set(t,i):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(t){const i=this._images.get(t);this._graphicsContext.textureLoader.delete(i.image),this._images.delete(t)}_loadImageSource(t){const i=t.image,n=i.getAttribute(Mt.Filtering),o=n?dr(n):void 0,h=Ni(i.getAttribute(Mt.WrappingX)),c=Ni(i.getAttribute(Mt.WrappingY)),_=i.getAttribute("forceUpload")==="true",p=this._graphicsContext.textureLoader.load(i,{filtering:o,wrapping:{x:h,y:c}},_);return i.removeAttribute("forceUpload"),this._textures.has(t)||this._textures.set(t,p),p}uploadAndBind(t,i=2){let n=i;for(const[o,h]of this._images.entries()){if(!h.isLoaded()){this._logger.warnOnce(`Image named ${o} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const c=this._loadImageSource(h);t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,c),this._shader.trySetUniformInt(o,n),n++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class Qu{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(t,i){this._gl=t,this._context=i,this._buffer=new us({gl:t,size:6*4,type:"dynamic"}),this._layout=new Us({gl:t,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new lo(t,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(t,i,n,o,h,c,_,p,v){var x,b,S,P;const I=this._gl,F=this._context.material;if(!F)return;const R=this._context.getTransform(),T=this._context.opacity,M=F.getShader(),W=this._layout.vertexBuffer.bufferData;let U=0,G=t?.width||o||0,j=t?.height||h||0,X=[0,0,(x=o??t?.width)!==null&&x!==void 0?x:0,(b=h??t?.height)!==null&&b!==void 0?b:0],rt=[i??1,n??1];c!==void 0&&_!==void 0&&p!==void 0&&v!==void 0&&(X=[i??1,n??1,(S=o??t?.width)!==null&&S!==void 0?S:0,(P=h??t?.height)!==null&&P!==void 0?P:0],rt=[c,_],G=p,j=v),i=X[0],n=X[1];const lt=X[2],yt=X[3],vt=N(rt[0],rt[1]),Pt=N(rt[0]+G,rt[1]),Dt=N(rt[0],rt[1]+j),B=N(rt[0]+G,rt[1]+j),z=t.width||G,Q=t.height||j,et=i/z,Nt=n/Q,at=(i+lt-.01)/z,Ii=(n+yt-.01)/Q,gs=R.getPosition(),Rt=gs.add(B),ht=gs.x/this._context.width,zs=gs.y/this._context.height,vo=Rt.x/this._context.width,ps=Rt.y/this._context.height;W[U++]=vt.x,W[U++]=vt.y,W[U++]=et,W[U++]=Nt,W[U++]=ht,W[U++]=zs,W[U++]=Dt.x,W[U++]=Dt.y,W[U++]=et,W[U++]=Ii,W[U++]=ht,W[U++]=ps,W[U++]=Pt.x,W[U++]=Pt.y,W[U++]=at,W[U++]=Nt,W[U++]=vo,W[U++]=zs,W[U++]=B.x,W[U++]=B.y,W[U++]=at,W[U++]=Ii,W[U++]=vo,W[U++]=ps;const wo=this._addImageAsTexture(t);F.use(),this._layout.shader=M,this._layout.use(!0),M.trySetUniformFloat("u_time_ms",performance.now()),M.trySetUniformFloat("u_opacity",T),M.trySetUniformFloatVector("u_resolution",N(this._context.width,this._context.height)),M.trySetUniformFloatVector("u_graphic_resolution",N(z,Q)),M.trySetUniformFloatVector("u_size",N(lt,yt)),M.trySetUniformMatrix("u_matrix",this._context.ortho),M.trySetUniformMatrix("u_transform",R.to4x4()),I.activeTexture(I.TEXTURE0+0),I.bindTexture(I.TEXTURE_2D,wo),M.trySetUniformInt("u_graphic",0),I.activeTexture(I.TEXTURE0+1),I.bindTexture(I.TEXTURE_2D,this._context.materialScreenTexture),M.trySetUniformInt("u_screen_texture",1),F.uploadAndBind(I),this._quads.bind(),I.drawElements(I.TRIANGLES,6,this._quads.bufferGlType,0),Kt.DrawnImagesCount++,Kt.DrawCallCount++}_addImageAsTexture(t){const i=t.getAttribute(Mt.Filtering),n=i?dr(i):void 0,o=Ni(t.getAttribute(Mt.WrappingX)),h=Ni(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);return t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&this._textures.push(_),_}hasPendingDraws(){return!1}flush(){}}const uv=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,fv=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var Le;(function(d){d.World="world",d.Screen="screen"})(Le||(Le={}));class Pl extends k{constructor(t){super(0,0),this._getX=t.getX,this._getY=t.getY,this._setX=t.setX,this._setY=t.setY}get x(){return this._x=this._getX()}set x(t){this._setX(t),this._x=t}get y(){return this._y=this._getY()}set y(t){this._setY(t),this._y=t}}class Qs extends k{constructor(t,i){super(t.x,t.y),this.original=t,this.change=i}get x(){return this._x=this.original.x}set x(t){t!==this._x&&(this.change(t,this._y),this._x=this.original.x=t)}get y(){return this._y=this.original.y}set y(t){t!==this._y&&(this.change(this._x,t),this._y=this.original.y=t)}setTo(t,i){this.x=t,this.y=i}}class Bs{constructor(){this._parent=null,this._children=[],this._pos=new Qs(N(0,0),()=>{this.flagDirty()}),this._globalPos=new Pl({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:t=>{if(this.parent){const{x:i}=this.parent.inverse.multiply(N(t,this.pos.y));this.pos.x=i}else this.pos.x=t;t!==this.matrix.data[4]&&this.flagDirty()},setY:t=>{if(this.parent){const{y:i}=this.parent.inverse.multiply(N(this.pos.x,t));this.pos.y=i}else this.pos.y=t;t!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new Qs(N(1,1),()=>{this.flagDirty()}),this._globalScale=new Pl({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:t=>{if(this.parent){const i=this.parent.globalScale.x;this.scale.x=t/i}else this.scale.x=t},setY:t=>{if(this.parent){const i=this.parent.globalScale.y;this.scale.y=t/i}else this.scale.y=t}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=ve.identity(),this._inverse=ve.identity(),this._scratch=ve.identity()}get parent(){return this._parent}set parent(t){if(this._parent){const i=this._parent._children.indexOf(this);i>-1&&this._parent._children.splice(i,1)}this._parent=t,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(t){this._pos.x=t.x,this._pos.y=t.y}get pos(){return this._pos}set globalPos(t){let i=t.clone();this.parent&&(i=this.parent.inverse.multiply(t)),i.equals(this._pos)||(this._pos=i,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(t){const i=Ds(t);i!==this._rotation&&this.flagDirty(),this._rotation=i}get rotation(){return this._rotation}set globalRotation(t){let i=0;this.parent&&(i=this.parent.globalRotation);const n=Ds(t+i);n!==this._rotation&&this.flagDirty(),this._rotation=n}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(t){this._scale.x=t.x,this._scale.y=t.y}get scale(){return this._scale}set globalScale(t){let i=N(1,1);this.parent&&(i=this.parent.globalScale),this.scale=t.scale(N(1/i.x,1/i.y))}get globalScale(){return this._globalScale}set z(t){this._z=t,this.flagDirty()}get z(){return this._z}set globalZ(t){this.parent?this.z=t-this.parent.globalZ:this.z=t}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let t=0;t<this._children.length;t++)this._children[t].flagDirty()}apply(t){return this.matrix.multiply(t)}applyInverse(t){return this.inverse.multiply(t)}setTransform(t,i,n){this._pos.x=t.x,this._pos.y=t.y,this._rotation=Ds(i),this._scale.x=n.x,this._scale.y=n.y,this.flagDirty()}isMirrored(){const t=qt(this.scale.x)>>>31,i=qt(this.scale.y)>>>31;return!!(t^i)}clone(t){const i=t??new Bs;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.flagDirty(),i}cloneWithParent(t){const i=t??new Bs;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.parent=this.parent,i.flagDirty(),i}toString(){return this.matrix.toString()}}function Tf(d){return!!d&&!!d.prototype&&!!d.prototype.constructor}function _v(d){return!!d?.clone}class Ei{constructor(){this.owner=void 0}clone(){const t=new this.constructor;for(const i in this)if(this.hasOwnProperty(i)){const n=this[i];_v(n)&&i!=="owner"&&i!=="clone"?t[i]=n.clone():t[i]=n}return t}}class ti{constructor(){this.observers=[],this.subscriptions=[]}register(t){this.observers.push(t)}subscribe(t){this.subscriptions.push(t)}unregister(t){const i=this.observers.indexOf(t);i!==-1&&this.observers.splice(i,1)}unsubscribe(t){const i=this.subscriptions.indexOf(t);i!==-1&&this.subscriptions.splice(i,1)}notifyAll(t){const i=this.observers.length;for(let o=0;o<i;o++)this.observers[o].notify(t);const n=this.subscriptions.length;for(let o=0;o<n;o++)this.subscriptions[o](t)}clear(){this.observers.length=0,this.subscriptions.length=0}}class nt extends Ei{constructor(){super(...arguments),this._logger=dt.getInstance(),this._parentComponent=null,this._transform=new Bs,this._addChildTransform=t=>{const i=t.get(nt);i&&(i._transform.parent=this._transform,i._parentComponent=this)},this.zIndexChanged$=new ti,this._coordPlane=Le.World}get(){return this._transform}onAdd(t){for(const i of t.children)this._addChildTransform(i);t.childrenAdded$.subscribe(i=>this._addChildTransform(i)),t.childrenRemoved$.subscribe(i=>{const n=i.get(nt);n&&(n._transform.parent=null,n._parentComponent=null)})}onRemove(t){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(t){const i=this._transform.z;this._transform.z=t,i!==t&&this.zIndexChanged$.notifyAll(t)}get globalZ(){return this._transform.globalZ}set globalZ(t){this._transform.globalZ=t}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(t){var i;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(i=this.owner)===null||i===void 0?void 0:i.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=t}get pos(){return this._transform.pos}set pos(t){this._transform.pos=t}get globalPos(){return this._transform.globalPos}set globalPos(t){this._transform.globalPos=t}get rotation(){return this._transform.rotation}set rotation(t){this._transform.rotation=t}get globalRotation(){return this._transform.globalRotation}set globalRotation(t){this._transform.globalRotation=t}get scale(){return this._transform.scale}set scale(t){this._transform.scale=t}get globalScale(){return this._transform.globalScale}set globalScale(t){this._transform.globalScale=t}applyInverse(t){return this._transform.applyInverse(t)}apply(t){return this._transform.apply(t)}clone(){const t=new nt;return t._transform=this._transform.clone(),t}}var Yr;(function(d){d.Forward="forward",d.Backward="backward"})(Yr||(Yr={}));var Ui;(function(d){d.End="end",d.Loop="loop",d.PingPong="pingpong",d.Freeze="freeze"})(Ui||(Ui={}));const gv={Frame:"frame",Loop:"loop",End:"end"};class Hi extends ae{constructor(t){var i,n,o;super(t),this.events=new $t,this.frames=[],this.strategy=Ui.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=t.frames,this.speed=(i=t.speed)!==null&&i!==void 0?i:this.speed,this.strategy=(n=t.strategy)!==null&&n!==void 0?n:this.strategy,this.frameDuration=t.totalDuration?t.totalDuration/this.frames.length:(o=t.frameDuration)!==null&&o!==void 0?o:this.frameDuration,t.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new Hi({frames:this.frames.map(t=>({...t})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.width*this.scale.x):0}get height(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.height*this.scale.y):0}static fromSpriteSheet(t,i,n,o=Ui.Loop){const h=t.sprites.length-1,c=i.filter(_=>_<0||_>h);return c.length&&Hi._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${c.join(",")} no frame will be shown`),new Hi({frames:t.sprites.filter((_,p)=>i.indexOf(p)>-1).map(_=>({graphic:_,duration:n})),strategy:o})}static fromSpriteSheetCoordinates(t){var i;const{spriteSheet:n,frameCoordinates:o,durationPerFrame:h,durationPerFrameMs:c,speed:_,strategy:p,reverse:v}=t,x=(i=h??c)!==null&&i!==void 0?i:100,b=[];for(const S of o){const{x:P,y:I,duration:F,options:R}=S,T=n.getSprite(P,I,R);T?b.push({graphic:T,duration:F??x}):Hi._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${P}, ${I}), please check your SpriteSheet to confirm that sprite exists`)}return new Hi({frames:b,strategy:p,speed:_,reverse:v})}get speed(){return this._speed}set speed(t){this._speed=St(Math.abs(t),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?Yr.Backward:Yr.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const t=this.frames[this._currentFrame];t&&(this._timeLeftInFrame=t?.duration||this.frameDuration)}get canFinish(){switch(this.strategy){case Ui.End:case Ui.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(t,i){this._currentFrame=t,this._timeLeftInFrame=i??this.frameDuration;const n=this.frames[this._currentFrame];n&&!this._done&&(this._timeLeftInFrame=i??(n?.duration||this.frameDuration),this.events.emit("frame",{...n,frameIndex:this.currentFrameIndex}))}_nextFrame(){const t=this._currentFrame;if(this._done)return t;let i=-1;switch(this.strategy){case Ui.Loop:{i=(t+1)%this.frames.length,i===0&&this.events.emit("loop",this);break}case Ui.End:{i=t+1,i>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case Ui.Freeze:{i=St(t+1,0,this.frames.length-1),i>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case Ui.PingPong:{t+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),t+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),i=t+this._pingPongDirection%this.frames.length;break}}return i}tick(t,i=0){this._idempotencyToken!==i&&(this._idempotencyToken=i,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=t*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(t,i,n){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(t,i,n)}}Hi._LOGGER=dt.getInstance();class sr extends ae{constructor(t){var i;super(t),this._logger=dt.getInstance(),this.useAnchor=!0,this.members=[],this.members=t.members,this.useAnchor=(i=t.useAnchor)!==null&&i!==void 0?i:this.useAnchor,this._updateDimensions()}clone(){return new sr({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const t=this.localBounds;return this.width=t.width,this.height=t.height,t}get localBounds(){const t=new ct;for(const i of this.members)if(i instanceof ae)i.localBounds.combine(t,t);else{const{graphic:n,offset:o,useBounds:h}=i;n?(h===void 0?!0:h)&&n.localBounds.translate(o).combine(t,t):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(i)}.`)}return t}_isAnimationOrGroup(t){return t instanceof Hi||t instanceof sr}tick(t,i){for(const n of this.members){let o;n instanceof ae?o=n:o=n.graphic,this._isAnimationOrGroup(o)&&o.tick(t,i)}}reset(){for(const t of this.members){let i;t instanceof ae?i=t:i=t.graphic,this._isAnimationOrGroup(i)&&i.reset()}}_preDraw(t,i,n){this._updateDimensions(),super._preDraw(t,this.useAnchor?i:0,this.useAnchor?n:0)}_drawImage(t,i,n){const o=k.Zero;for(const h of this.members){let c;h instanceof ae?c=h:(c=h.graphic,h.offset.clone(o)),c&&(t.save(),t.translate(i,n),c.draw(t,o.x,o.y),this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore())}}}class ur extends ae{constructor(t){var i,n,o,h,c,_,p,v,x,b;super(wf({...t},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=Oi(K.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,t&&(this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this.color=(n=t.color)!==null&&n!==void 0?n:K.Black,this.strokeColor=t?.strokeColor,this.smoothing=(o=t.smoothing)!==null&&o!==void 0?o:this.smoothing,this.lineWidth=(h=t.lineWidth)!==null&&h!==void 0?h:this.lineWidth,this.lineDash=(c=t.lineDash)!==null&&c!==void 0?c:this.lineDash,this.lineCap=(_=t.lineCap)!==null&&_!==void 0?_:this.lineCap,this.padding=(p=t.padding)!==null&&p!==void 0?p:this.padding,this.filtering=(v=t.filtering)!==null&&v!==void 0?v:this.filtering),this._bitmap=document.createElement("canvas");const S=(x=t?.width)!==null&&x!==void 0?x:this._bitmap.width,P=(b=t?.height)!==null&&b!==void 0?b:this._bitmap.height;this.width=S,this.height=P;const I=this._bitmap.getContext("2d");if(I)this._ctx=I;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(t){t/=Math.abs(this.scale.x),this._bitmap.width=t,this._originalWidth=t,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(t){t/=Math.abs(this.scale.y),this._bitmap.height=t,this._originalHeight=t,this.flagDirty()}_getTotalWidth(){var t;return(((t=this._originalWidth)!==null&&t!==void 0?t:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var t;return(((t=this._originalHeight)!==null&&t!==void 0?t:this._bitmap.height)+this.padding*2)*1}get localBounds(){return ct.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,k.Zero)}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this.flagDirty()}get color(){return this._color}set color(t){this.flagDirty(),this._color=Oi(t,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(t){this.flagDirty(),t&&(this._strokeColor=Oi(t,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(t){this._lineDash=t,this.flagDirty()}get padding(){return this._padding}set padding(t){this._padding=t,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(t){var i,n,o,h;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),t.scale(this.quality,this.quality),t.translate(this.padding,this.padding),t.imageSmoothingEnabled=this.smoothing,t.lineWidth=this.lineWidth,t.setLineDash((i=this.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.lineCap=this.lineCap,t.strokeStyle=(o=(n=this.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&o!==void 0?o:"",t.fillStyle=(h=this.color)===null||h===void 0?void 0:h.toString()}_drawImage(t,i,n){this._dirty&&this.rasterize(),t.scale(1/this.quality,1/this.quality),t.drawImage(this._bitmap,i,n)}}var ua;(function(d){d.Em="em",d.Rem="rem",d.Px="px",d.Pt="pt",d.Percent="%"})(ua||(ua={}));var fa;(function(d){d.Left="left",d.Right="right",d.Center="center",d.Start="start",d.End="end"})(fa||(fa={}));var _a;(function(d){d.Top="top",d.Hanging="hanging",d.Middle="middle",d.Alphabetic="alphabetic",d.Ideographic="ideographic",d.Bottom="bottom"})(_a||(_a={}));var ga;(function(d){d.Normal="normal",d.Italic="italic",d.Oblique="oblique"})(ga||(ga={}));var pa;(function(d){d.LeftToRight="ltr",d.RightToLeft="rtl"})(pa||(pa={}));function Tl(d,t=K.Red,i,n,o,h,c=1,_="butt"){d.save(),d.beginPath(),d.lineWidth=c,d.lineCap=_,d.strokeStyle=t.toString(),d.moveTo(i,n),d.lineTo(o,h),d.closePath(),d.stroke(),d.restore()}function pv(d,t=K.Red,i){d.beginPath(),d.strokeStyle=t.toString(),d.arc(i.x,i.y,5,0,Math.PI*2),d.closePath(),d.stroke()}function mv(d,t,i,n,o=1){const h=t?t.toString():"blue",c=n.scale(o);d.beginPath(),d.strokeStyle=h,d.moveTo(i.x,i.y),d.lineTo(i.x+c.x,i.y+c.y),d.closePath(),d.stroke()}function El(d,t,i,n,o,h=5,c=K.White,_=null){let p;if(typeof h=="number")p={tl:h,tr:h,br:h,bl:h};else{const v={tl:0,tr:0,br:0,bl:0};for(const x in v)if(v.hasOwnProperty(x)){const b=x;p[b]=h[b]||v[b]}}d.beginPath(),d.moveTo(t+p.tl,i),d.lineTo(t+n-p.tr,i),d.quadraticCurveTo(t+n,i,t+n,i+p.tr),d.lineTo(t+n,i+o-p.br),d.quadraticCurveTo(t+n,i+o,t+n-p.br,i+o),d.lineTo(t+p.bl,i+o),d.quadraticCurveTo(t,i+o,t,i+o-p.bl),d.lineTo(t,i+p.tl),d.quadraticCurveTo(t,i,t+p.tl,i),d.closePath(),_&&(d.fillStyle=_.toString(),d.fill()),c&&(d.strokeStyle=c.toString(),d.stroke())}function vv(d,t,i,n,o=K.White,h=null){d.beginPath(),d.arc(t,i,n,0,Math.PI*2),d.closePath(),h&&(d.fillStyle=h.toString(),d.fill()),o&&(d.strokeStyle=o.toString(),d.stroke())}class tr{constructor(t,i,n,o){this.font=t,this.text=i,this.color=n,this.maxWidth=o,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const h=this.canvas.getContext("2d");if(!h)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=h,this.dimensions=this.measureText(i),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(t,i){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let n=null;i!=null?n=this._getLinesFromText(t,i):n=t.split(`
`);const o=n.reduce((S,P)=>S.length>P.length?S:P);this._applyFont(this.ctx);const h=this.ctx.measureText(o);let c=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);const _=c*n.length;c=_;const p=_-Math.abs(h.actualBoundingBoxAscent),v=0,x=0;return new ct({left:v-Math.abs(h.actualBoundingBoxLeft)-this.font.padding,top:x-Math.abs(h.actualBoundingBoxAscent)-this.font.padding,bottom:x+p+this.font.padding,right:v+Math.abs(h.actualBoundingBoxRight)+this.font.padding})}_setDimension(t,i){let n=1;this.font.lineHeight&&(n=this.font.lineHeight/this.font.size),i.canvas.width=(t.width+this.font.padding*2)*2*this.font.quality,i.canvas.height=(t.height+this.font.padding*2)*2*this.font.quality*n}static getHashCode(t,i,n){var o;return i+"__hashcode__"+t.fontString+t.showDebug+t.textAlign+t.baseAlign+t.direction+t.lineHeight+JSON.stringify(t.shadow)+(t.padding.toString()+t.smoothing.toString()+t.lineWidth.toString()+t.lineDash.toString()+((o=t.strokeColor)===null||o===void 0?void 0:o.toString())+(n?n.toString():t.color.toString()))}getHashCode(t=!0){return tr.getHashCode(this.font,this.text,t?this.color:void 0)}_applyRasterProperties(t){var i,n,o;t.translate(this.font.padding,this.font.padding),t.imageSmoothingEnabled=this.font.smoothing,t.lineWidth=this.font.lineWidth,t.setLineDash((i=this.font.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.strokeStyle=(o=(n=this.font.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&o!==void 0?o:"",t.fillStyle=this.color.toString()}_applyFont(t){t.resetTransform(),t.translate(this.font.padding+t.canvas.width/2,this.font.padding+t.canvas.height/2),t.scale(this.font.quality,this.font.quality),t.textAlign=this.font.textAlign,t.textBaseline=this.font.baseAlign,t.font=this.font.fontString,t.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(t.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(t.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(t.shadowOffsetX=this.font.shadow.offset.x,t.shadowOffsetY=this.font.shadow.offset.y))}_drawText(t,i,n){this._applyRasterProperties(t),this._applyFont(t);for(let o=0;o<i.length;o++){const h=i[o];this.color&&t.fillText(h,0,o*n),this.font.strokeColor&&t.strokeText(h,0,o*n)}this.font.showDebug&&(Tl(t,K.Green,-t.canvas.width/2,0,t.canvas.width/2,0,2),Tl(t,K.Red,0,-t.canvas.height/2,0,t.canvas.height/2,2))}_splitTextBitmap(t){const i=[];let n=0,o=0;const h=Math.min(4096,t.canvas.width),c=Math.min(4096,t.canvas.height);for(;n<t.canvas.width;){for(;o<t.canvas.height;){const _=document.createElement("canvas");_.width=h,_.height=c;const p=_.getContext("2d");if(!p)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");p.drawImage(t.canvas,n,o,h,c,0,0,h,c),i.push({x:n,y:o,canvas:_}),o+=c}n+=h,o=0}return i}flagDirty(){this._dirty=!0}render(t,i,n,o){var h;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=t;const c=this.getHashCode();if(this._lastHashCode!==c&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,o),this._setDimension(this.dimensions,this.ctx);const _=this._getLinesFromText(this.text,o),p=(h=this.font.lineHeight)!==null&&h!==void 0?h:this.dimensions.height/_.length;if(this._drawText(this.ctx,_,p),t instanceof Fs)for(const v of this._textFragments)t.textureLoader.delete(v.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),t instanceof Fs)for(const v of this._textFragments)t.textureLoader.load(v.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=c,this._dirty=!1}for(const _ of this._textFragments)t.drawImage(_.canvas,0,0,_.canvas.width,_.canvas.height,_.x/this.font.quality+i-this.ctx.canvas.width/this.font.quality/2,_.y/this.font.quality+n-this.ctx.canvas.height/this.font.quality/2,_.canvas.width/this.font.quality,_.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof Fs)for(const t of this._textFragments)this._ex.textureLoader.delete(t.canvas);this._textFragments.length=0}_getLinesFromText(t,i){var n;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let c=o[h],_="";if(this.measureText(c).width>i){for(;this.measureText(c).width>i;)_=c[c.length-1]+_,c=c.slice(0,-1);o[h]=c,o[h+1]=_}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class Ot{static measureText(t,i,n){const o=tr.getHashCode(i,t);if(Ot._MEASURE_CACHE.has(o))return Ot._MEASURE_CACHE.get(o);Ot._LOGGER.debug("Font text measurement cache miss");const h=i.measureTextWithoutCache(t,n);return Ot._MEASURE_CACHE.set(o,h),h}static getTextInstance(t,i,n){const o=tr.getHashCode(i,t,n);let h=Ot._TEXT_CACHE.get(o);return h||(h=new tr(i,t,n),Ot._TEXT_CACHE.set(o,h),Ot._LOGGER.debug("Font text instance cache miss")),Ot._TEXT_USAGE.set(h,performance.now()),h}static checkAndClearCache(){const t=[],i=new Set;for(const[o,h]of Ot._TEXT_USAGE.entries())if(h+Ot.FONT_TIMEOUT<performance.now())Ot._LOGGER.debug(`Text cache entry timed out ${o.text}`),t.push(o),o.dispose();else{const c=o.getHashCode(!1);i.add(c)}t.forEach(o=>{Ot._TEXT_USAGE.delete(o)}),this._TEXT_CACHE.clear();for(const[o]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(o.getHashCode(),o);const n=new Map;for(const o of i)Ot._MEASURE_CACHE.has(o)&&n.set(o,Ot._MEASURE_CACHE.get(o));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=n}static get cacheSize(){return Ot._TEXT_USAGE.size}static clearCache(){for(const[t]of Ot._TEXT_USAGE.entries())t.dispose();Ot._TEXT_USAGE.clear(),Ot._TEXT_CACHE.clear(),Ot._MEASURE_CACHE.clear()}}Ot.FONT_TIMEOUT=500;Ot._LOGGER=dt.getInstance();Ot._TEXT_USAGE=new Map;Ot._TEXT_CACHE=new Map;Ot._MEASURE_CACHE=new Map;class Bn extends ae{constructor(t={}){var i,n,o,h,c,_,p,v,x,b,S,P,I,F,R,T,M,W,U,G;super(t),this.filtering=xe.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=K.Black,this.family="sans-serif",this.style=ga.Normal,this.bold=!1,this.unit=ua.Px,this.textAlign=fa.Left,this.baseAlign=_a.Top,this.direction=pa.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new ct,this._textMeasurement=new tr(this,"",K.Black),this.smoothing=(i=t?.smoothing)!==null&&i!==void 0?i:this.smoothing,this.padding=(n=t?.padding)!==null&&n!==void 0?n:this.padding,this.color=(o=t?.color)!==null&&o!==void 0?o:this.color,this.strokeColor=(h=t?.strokeColor)!==null&&h!==void 0?h:this.strokeColor,this.lineDash=(c=t?.lineDash)!==null&&c!==void 0?c:this.lineDash,this.lineWidth=(_=t?.lineWidth)!==null&&_!==void 0?_:this.lineWidth,this.filtering=(p=t?.filtering)!==null&&p!==void 0?p:this.filtering,this.family=(v=t?.family)!==null&&v!==void 0?v:this.family,this.style=(x=t?.style)!==null&&x!==void 0?x:this.style,this.bold=(b=t?.bold)!==null&&b!==void 0?b:this.bold,this.size=(S=t?.size)!==null&&S!==void 0?S:this.size,this.unit=(P=t?.unit)!==null&&P!==void 0?P:this.unit,this.textAlign=(I=t?.textAlign)!==null&&I!==void 0?I:this.textAlign,this.baseAlign=(F=t?.baseAlign)!==null&&F!==void 0?F:this.baseAlign,this.direction=(R=t?.direction)!==null&&R!==void 0?R:this.direction,this.lineHeight=(T=t?.lineHeight)!==null&&T!==void 0?T:this.lineHeight,this.quality=(M=t?.quality)!==null&&M!==void 0?M:this.quality,t?.shadow&&(this.shadow={},this.shadow.blur=(W=t.shadow.blur)!==null&&W!==void 0?W:this.shadow.blur,this.shadow.offset=(U=t.shadow.offset)!==null&&U!==void 0?U:this.shadow.offset,this.shadow.color=(G=t.shadow.color)!==null&&G!==void 0?G:this.shadow.color)}clone(){return new Bn({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(t,i,n){}_rotate(t){var i;const n=(i=this.origin)!==null&&i!==void 0?i:this._textBounds.center;t.translate(n.x,n.y),t.rotate(this.rotation),t.translate(-n.x,-n.y)}_flip(t){this.flipHorizontal&&(t.translate(this._textBounds.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,-this._textBounds.height/2/this.scale.y),t.scale(1,-1))}measureTextWithoutCache(t,i){return this._textMeasurement.measureText(t,i)}measureText(t,i){return Ot.measureText(t,this,i)}_postDraw(t){t.restore()}render(t,i,n,o,h,c){const _=Ot.getTextInstance(i,this,n);this._textBounds=_.dimensions,this._preDraw(t,o,h),_.render(t,o,h,c),this._postDraw(t)}}class co extends ae{constructor(t){var i,n;super(t),this._text="",this._textWidth=0,this._textHeight=0,this.font=(i=t.font)!==null&&i!==void 0?i:new Bn,this.color=(n=t.color)!==null&&n!==void 0?n:this.color,this.text=t.text,this.maxWidth=t.maxWidth}clone(){var t,i;return new co({text:this.text.slice(),color:(i=(t=this.color)===null||t===void 0?void 0:t.clone())!==null&&i!==void 0?i:K.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(t){this._text=t,this._calculateDimension()}get font(){return this._font}set font(t){this._font=t}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:t,height:i}=this.font.measureText(this._text,this.maxWidth);this._textWidth=t,this._textHeight=i}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(t){}_flip(t){}_preDraw(t,i,n){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(t,i,n)}_drawImage(t,i,n){var o;let h=K.Black;this.font instanceof Bn&&(h=(o=this.color)!==null&&o!==void 0?o:this.font.color);const{width:c,height:_}=this.font.measureText(this._text,this.maxWidth);this._textWidth=c,this._textHeight=_,this.font.render(t,this._text,h,i,n,this.maxWidth),this.font.showDebug&&(t.debug.drawRect(i-c,n-_,c*2,_*2),this.maxWidth!=null&&t.debug.drawRect(i,n,this.maxWidth,this.height,{color:K.Yellow}))}}function sc(d){return!!d.tick}class he extends Ei{get visible(){return this.isVisible}set visible(t){this.isVisible=t}get offset(){return this._offset}set offset(t){this._offset=new Qs(t,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(t){this._anchor=new Qs(t,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(t){if(t){this._color=t.clone();const i=this.graphics.current;(i instanceof ur||i instanceof co)&&(i.color=this._color)}}constructor(t){super(),this._logger=dt.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new Qs(k.Zero,()=>this.recalculateBounds()),this._anchor=new Qs(k.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,t={visible:this.isVisible,graphics:{},...t};const{current:i,anchor:n,color:o,opacity:h,visible:c,graphics:_,offset:p,copyGraphics:v,onPreDraw:x,onPostDraw:b,onPreTransformDraw:S,onPostTransformDraw:P}=t;for(const[I,F]of Object.entries(_))F instanceof ae?this._graphics[I]=F:(this._graphics[I]=F.graphic,this._options[I]=F.options);this.offset=p??this.offset,this.opacity=h??this.opacity,this.anchor=n??this.anchor,this.color=o??this.color,this.copyGraphics=v??this.copyGraphics,this.onPreDraw=x??this.onPreDraw,this.onPostDraw=b??this.onPostDraw,this.onPreDraw=S??this.onPreTransformDraw,this.onPostTransformDraw=P??this.onPostTransformDraw,this.isVisible=!!c,this._current=i??this._current,i&&this._graphics[i]&&this.use(i)}getGraphic(t){return this._graphics[t]}getOptions(t){return this._options[t]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(t,i,n){let o="default",h=null,c;if(typeof t=="string"&&i instanceof ae&&(o=t,h=i,c=n),t instanceof ae&&!(i instanceof ae)&&(h=t,c=i),!h)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[o]=this.copyGraphics?h.clone():h,this._options[o]=this.copyGraphics?{...c}:c,o==="default"&&this.use("default"),h}remove(t){delete this._graphics[t],delete this._options[t],this._current===t&&(this._current="default",this.recalculateBounds())}use(t,i){var n;if(t instanceof ae){let o=t;this.copyGraphics&&(o=t.clone()),this._current="default",this._graphics[this._current]=o,this._options[this._current]=i}else this._current=t,this._options[this._current]=i,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(n=this.owner)===null||n===void 0?void 0:n.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(t){this._localBounds=t}recalculateBounds(){let t=new ct;const i=this._graphics[this._current],n=this._options[this._current];if(!i){this._localBounds=t;return}let o=this.anchor,h=this.offset;n?.anchor&&(o=n.anchor),n?.offset&&(h=n.offset);const c=i.localBounds,_=-c.width*o.x+h.x,p=-c.height*o.y+h.y;i instanceof sr&&!i.useAnchor?t=i?.localBounds.combine(t):t=i?.localBounds.translate(N(_,p)).combine(t),this._localBounds=t}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let t=this.localBounds;if(this.owner){const i=this.owner.get(nt);i&&(t=t.transform(i.get().matrix))}return t}update(t,i=0){const n=this.current;n&&sc(n)&&n.tick(t,i)}clone(){const t=new he;return t._graphics={...this._graphics},t._options={...this._options},t.offset=this.offset.clone(),this.color&&(t.color=this.color.clone()),t.opacity=this.opacity,t.anchor=this.anchor.clone(),t.copyGraphics=this.copyGraphics,t.onPreDraw=this.onPreDraw,t.onPostDraw=this.onPostDraw,t.isVisible=this.isVisible,t}}var ma;(function(d){d.Kill="kill",d.PreKill="prekill",d.PostKill="postkill",d.PreDraw="predraw",d.PostDraw="postdraw",d.PreDebugDraw="predebugdraw",d.PostDebugDraw="postdebugdraw",d.PreUpdate="preupdate",d.PostUpdate="postupdate",d.PreFrame="preframe",d.PostFrame="postframe",d.PreCollision="precollision",d.CollisionStart="collisionstart",d.CollisionEnd="collisionend",d.PostCollision="postcollision",d.Initialize="initialize",d.Activate="activate",d.Deactivate="deactivate",d.ExitViewport="exitviewport",d.EnterViewport="enterviewport",d.ExitTrigger="exit",d.EnterTrigger="enter",d.Connect="connect",d.Disconnect="disconnect",d.Button="button",d.Axis="axis",d.Visible="visible",d.Hidden="hidden",d.Start="start",d.Stop="stop",d.PointerUp="pointerup",d.PointerDown="pointerdown",d.PointerMove="pointermove",d.PointerEnter="pointerenter",d.PointerLeave="pointerleave",d.PointerCancel="pointercancel",d.PointerWheel="pointerwheel",d.Up="up",d.Down="down",d.Move="move",d.Enter="enter",d.Leave="leave",d.Cancel="cancel",d.Wheel="wheel",d.Press="press",d.Release="release",d.Hold="hold",d.PointerDragStart="pointerdragstart",d.PointerDragEnd="pointerdragend",d.PointerDragEnter="pointerdragenter",d.PointerDragLeave="pointerdragleave",d.PointerDragMove="pointerdragmove",d.ActionStart="actionstart",d.ActionComplete="actioncomplete",d.Add="add",d.Remove="remove"})(ma||(ma={}));class At{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(t){this._bubbles=t}stopPropagation(){this.bubbles=!1}}class Ra extends At{constructor(t){super(),this.self=t,this.target=t}}class nc extends At{constructor(t){super(),this.self=t,this.target=t}}class rc extends At{constructor(t){super(),this.self=t,this.target=t}}class oc extends At{constructor(t){super(),this.self=t,this.target=t}}class ac extends At{constructor(t){super(),this.self=t,this.target=t}}class fr extends At{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class _r extends At{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class hc extends At{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class lc extends At{constructor(t,i,n){super(),this.ctx=t,this.elapsed=i,this.self=n,this.target=n}}class cc extends At{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class dc extends At{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class tn extends At{constructor(t,i,n){super(),this.engine=t,this.elapsed=i,this.self=n,this.target=n}}class en extends At{constructor(t,i,n){super(),this.engine=t,this.elapsed=i,this.self=n,this.target=n}}class uc extends At{constructor(t,i){super(),this.engine=t,this.prevStats=i,this.target=t}}class fc extends At{constructor(t,i){super(),this.engine=t,this.stats=i,this.target=t}}class _c extends At{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class gc extends At{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class pc extends At{constructor(t,i,n,o){super(),this.button=t,this.index=i,this.value=n,this.self=o,this.target=o}}class mc extends At{constructor(t,i,n){super(),this.axis=t,this.value=i,this.self=n,this.target=n}}class vc extends At{constructor(t){super(),this.self=t,this.target=t}}class wc extends At{constructor(t){super(),this.self=t,this.target=t}}class kn extends At{constructor(t,i,n,o,h){super(),this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h,this.target=t}}class Ln extends At{constructor(t,i,n,o,h){super(),this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h,this.target=t}}class va{constructor(t,i,n,o){this.self=t,this.other=i,this.side=n,this.contact=o}}class wa{constructor(t,i,n,o){this.self=t,this.other=i,this.side=n,this.lastContact=o}}class xa{constructor(t,i,n,o,h){this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h}}class ba{constructor(t,i,n,o,h){this.self=t,this.other=i,this.side=n,this.intersection=o,this.contact=h}}class jr extends At{constructor(t,i,n,o){super(),this.self=t,this.other=i,this.side=n,this.contact=o,this.target=t}}class Zr extends At{constructor(t,i,n,o){super(),this.self=t,this.other=i,this.side=n,this.lastContact=o,this.target=t}}class gr extends At{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class xc extends At{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class bc extends At{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class Ac extends At{constructor(t){super(),this.self=t,this.target=t}}class yc extends At{constructor(t){super(),this.self=t,this.target=t}}class Cc extends At{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class Sc extends At{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class Pc extends At{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class Tc extends At{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class Ec extends At{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class Ic extends At{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class wv{constructor(t){this.data=t,this.type="Component Added"}}function xv(d){return!!d&&d.type==="Component Added"}class bv{constructor(t){this.data=t,this.type="Component Removed"}}function Av(d){return!!d&&d.type==="Component Removed"}const yv={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class Ye{constructor(t,i){this.id=Ye._ID++,this.name=`Entity#${this.id}`,this.events=new $t,this._tags=new Set,this.componentAdded$=new ti,this.componentRemoved$=new ti,this.tagAdded$=new ti,this.tagRemoved$=new ti,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new ti,this.childrenRemoved$=new ti,this._children=[],this._isInitialized=!1,this._isAdded=!1;let n,o;if(Array.isArray(t))n=t,o=i;else if(t&&typeof t=="object"){const{components:h,name:c,silenceWarnings:_}=t;n=h??[],o=c}if(o&&(this.name=o),n)for(const h of n)this.addComponent(h)}get active(){return this.isActive}set active(t){this.isActive=t}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new Ra(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(t){return this._tags.has(t)}addTag(t){return this._tags.add(t),this.tagAdded$.notifyAll(t),this}removeTag(t){return this._tags.delete(t),this.tagRemoved$.notifyAll(t),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(t){for(let i=0;i<t.length;i++)if(!this.components.has(t[i]))return!1;return!0}hasAllTags(t){for(let i=0;i<t.length;i++)if(!this.tags.has(t[i]))return!1;return!0}get(t){return this.components.get(t)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(t){if(t.parent===null){if(this.getAncestors().includes(t))throw new Error("Cycle detected, cannot add entity");this._children.push(t),t._parent=this,this.childrenAdded$.notifyAll(t)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(t){return t.parent===this&&(cr(t,this._children),t._parent=null,this.childrenRemoved$.notifyAll(t)),this}removeAllChildren(){for(let t=this.children.length-1;t>=0;t--)this.removeChild(this.children[t]);return this}getAncestors(){const t=[this];let i=this.parent;for(;i;)t.push(i),i=i.parent;return t.reverse()}getDescendants(){let t=[this],i=[this];for(;i.length>0;){const n=i.pop();n&&(i=i.concat(n.children),t=t.concat(n.children))}return t}clone(){const t=new Ye;for(const i of this.types){const n=this.get(i);n&&t.addComponent(n.clone())}for(const i of this.children)t.addChild(i.clone());return t}addTemplate(t,i=!1){for(const n of t.getComponents())this.addComponent(n.clone(),i);for(const n of t.children)this.addChild(n.clone().addTemplate(n));return this}_getClassHierarchyRoot(t){var i,n;let o=t,h=(i=Object.getPrototypeOf(o.prototype))===null||i===void 0?void 0:i.constructor;for(;h&&h!==Object&&h!==Ei;)o=h,h=(n=Object.getPrototypeOf(o.prototype))===null||n===void 0?void 0:n.constructor;return o}addComponent(t,i=!1){if(this.has(t.constructor))if(i)this.removeComponent(t.constructor,!0);else return this;if(t.dependencies&&t.dependencies.length)for(const o of t.dependencies)this.addComponent(new o);t.owner=this;const n=this._getClassHierarchyRoot(t.constructor);return this.components.set(n,t),this.components.set(t.constructor,t),this.componentValues.push(t),t.onAdd&&t.onAdd(this),this.componentAdded$.notifyAll(t),this}removeComponent(t,i=!1){let n;if(Tf(t)?n=t:n=t.constructor,i){const o=this.components.get(n);if(o){this.componentRemoved$.notifyAll(o),o.owner=void 0,o.onRemove&&o.onRemove(this);const c=this.componentValues.indexOf(o);c>-1&&this.componentValues.splice(c,1)}const h=this._getClassHierarchyRoot(n);this.components.delete(h),this.components.delete(n)}else this._componentsToRemove.push(n);return this}clearComponents(){const t=this.types;for(const i of t)this.removeComponent(i)}processComponentRemoval(){for(const t of this._componentsToRemove)this.removeComponent(t,!0);this._componentsToRemove.length=0}has(t){return this.components.has(t)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(t){this.isInitialized||(this.onInitialize(t),this.events.emit("initialize",new gr(t,this)),this._isInitialized=!0)}_add(t){!this.isAdded&&this.isActive&&(this.onAdd(t),this.events.emit("add",new Ec(t,this)),this._isAdded=!0)}_remove(t){this.isAdded&&!this.isActive&&(this.onRemove(t),this.events.emit("remove",new Ic(t,this)),this._isAdded=!1)}_preupdate(t,i){this.events.emit("preupdate",new tn(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new en(t,i,this)),this.onPostUpdate(t,i)}onInitialize(t){}onAdd(t){}onRemove(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i);for(const n of this.children)n.update(t,i);this._postupdate(t,i),this._remove(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}Ye._ID=0;class Lt extends Ei{constructor(){super(...arguments),this.vel=k.Zero,this.acc=k.Zero,this.scaleFactor=k.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class $e{static integrate(t,i,n,o){const h=o/1e3;i.vel.addEqual(n.scale(h,$e._ACC)),t.pos.add(i.vel.scale(h,$e._VEL),$e._POS).addEqual(n.scale(.5*h*h,$e._VEL_ACC)),i.angularVelocity+=i.torque*(1/i.inertia)*h;const c=t.rotation+i.angularVelocity*h;t.scale.add(i.scaleFactor.scale(h,this._SCALE_FACTOR),$e._SCALE),t.get().setTransform($e._POS,c,$e._SCALE)}}$e._POS=new k(0,0);$e._SCALE=new k(1,1);$e._ACC=new k(0,0);$e._VEL=new k(0,0);$e._VEL_ACC=new k(0,0);$e._SCALE_FACTOR=new k(0,0);class Da extends Ye{constructor(t){super({silenceWarnings:!0}),this.beginColor=K.White,this.endColor=K.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=K.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=Gi.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new nt),this.addComponent(this.motion=new Lt),this.addComponent(this.graphics=new he),this.configure(t)}registerEmitter(t){if(this._emitter=t,this.particleTransform===Gi.Global){const i=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(i),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(t){var i,n,o,h,c,_,p,v,x,b,S,P,I,F;this.particleTransform=(i=t.transform)!==null&&i!==void 0?i:this.particleTransform,this.life=(n=t.life)!==null&&n!==void 0?n:this.life,this.fade=(o=t.fade)!==null&&o!==void 0?o:this.fade,this.size=(h=t.size)!==null&&h!==void 0?h:this.size,this.endColor=(c=t.endColor)!==null&&c!==void 0?c:this.endColor.clone(),this.beginColor=(_=t.beginColor)!==null&&_!==void 0?_:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=t.graphic,this.graphics.opacity=(p=t.opacity)!==null&&p!==void 0?p:this.graphics.opacity,this.transform.pos=(v=t.pos)!==null&&v!==void 0?v:this.transform.pos,this.transform.rotation=(x=t.rotation)!==null&&x!==void 0?x:0,this.transform.scale=N(1,1),this.motion.vel=(b=t.vel)!==null&&b!==void 0?b:this.motion.vel,this.motion.angularVelocity=(S=t.angularVelocity)!==null&&S!==void 0?S:0,this.motion.acc=(P=t.acc)!==null&&P!==void 0?P:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(I=t.startSize)!==null&&I!==void 0?I:0,this.endSize=(F=t.endSize)!==null&&F!==void 0?F:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=ct.fromDimension(this.size,this.size,k.Half),this.graphics.onPostDraw=R=>{R.save(),R.debug.drawPoint(N(0,0),{color:this._currentColor,size:this.size}),R.restore()})}kill(){var t;!((t=this._emitter)===null||t===void 0)&&t.isActive?this._emitter.removeParticle(this):super.kill()}update(t,i){this.life=this.life-i,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=St(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=St(this.sizeRate*i+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=St(this._currentColor.r+this._rRate*i,0,255),this._currentColor.g=St(this._currentColor.g+this._gRate*i,0,255),this._currentColor.b=St(this._currentColor.b+this._bRate*i,0,255),this._currentColor.a=this.graphics.opacity;let n=this.motion.acc;this.focus&&(n=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(i/1e3)),$e.integrate(this.transform,this.motion,n,i)}}Da.DefaultConfig={beginColor:K.White,endColor:K.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var Gi;(function(d){d.Global="global",d.Local="local"})(Gi||(Gi={}));class Ef{constructor(){this.type="ex.particle",this.priority=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new di({gl:t,vertexSource:uv,fragmentSource:fv,onPreLink:n=>{t.transformFeedbackVaryings(n,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],t.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(t){const i=t.getAttribute(Mt.Filtering),n=i?dr(i):void 0,o=Ni(t.getAttribute(Mt.WrappingX)),h=Ni(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);return t.removeAttribute("forceUpload"),_}draw(t,i){var n,o,h,c,_,p,v,x,b;const S=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const P=t.particle.transform===Gi.Local?this._context.getTransform():this._context.getTransform().multiply(t.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",P),this._shader.setUniformBoolean("fade",!!t.particle.fade),this._shader.setUniformBoolean("useTexture",!!t.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(n=t.particle.life)!==null&&n!==void 0?n:2e3),this._shader.setUniformFloat("deltaMs",i),this._shader.setUniformFloatVector("gravity",(o=t.particle.acc)!==null&&o!==void 0?o:N(0,0)),this._shader.setUniformFloatColor("beginColor",(h=t.particle.beginColor)!==null&&h!==void 0?h:K.Transparent),this._shader.setUniformFloatColor("endColor",(c=t.particle.endColor)!==null&&c!==void 0?c:K.Transparent);let I=(_=t.particle.startSize)!==null&&_!==void 0?_:0,F=(p=t.particle.endSize)!==null&&p!==void 0?p:0;const R=(v=t.particle.size)!==null&&v!==void 0?v:0;if(R>0&&(I=R,F=R),this._shader.setUniformFloat("startSize",I??10),this._shader.setUniformFloat("endSize",F??10),this._shader.setUniformFloat("startOpacity",(x=t.particle.opacity)!==null&&x!==void 0?x:1),t.particle.focus&&(this._shader.setUniformFloatVector("focus",t.particle.focus),this._shader.setUniformFloat("focusAccel",(b=t.particle.focusAccel)!==null&&b!==void 0?b:0)),t.particle.graphic){const T=t.particle.graphic,M=this._getTexture(T.image.image);S.activeTexture(S.TEXTURE0),S.bindTexture(S.TEXTURE_2D,M),this._shader.setUniformInt("graphic",0)}t.draw(S)}hasPendingDraws(){return!1}flush(){}dispose(){}}const Cv=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,Sv=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class Pv{constructor(t){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=K.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const n=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=ic(t,n);this._maxTextures=Math.min(n,o);const h=this._transformFragmentSource(Cv,this._maxTextures);this._shader=new di({gl:t,fragmentSource:h,vertexSource:Sv}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((b,S)=>S)),this._vao=t.createVertexArray(),t.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._meshBuffer),t.bufferData(t.ARRAY_BUFFER,this._quadMesh,t.STATIC_DRAW),t.vertexAttribPointer(0,2,t.FLOAT,!1,16,0),t.enableVertexAttribArray(0),t.vertexAttribPointer(1,2,t.FLOAT,!1,16,8),t.enableVertexAttribArray(1),t.bindBuffer(t.ARRAY_BUFFER,null);const c=this._components;this._transformData=new us({gl:t,size:c*this._maxImages,type:"dynamic"}),this._transformData.bind();let _=0,p=2;const v=4,x=c*4;t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(2),_+=2*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(3),_+=2*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(4),_+=2*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(5),_+=2*v,t.vertexAttribPointer(p++,1,t.FLOAT,!1,x,_),t.enableVertexAttribArray(6),_+=1*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(7),_+=2*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(8),_+=2*v,t.vertexAttribPointer(p++,1,t.FLOAT,!1,x,_),t.enableVertexAttribArray(9),_+=1*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(10),_+=2*v,t.vertexAttribPointer(p++,2,t.FLOAT,!1,x,_),t.enableVertexAttribArray(11),_+=2*v,t.vertexAttribPointer(p++,4,t.FLOAT,!1,x,_),t.enableVertexAttribArray(12),_+=4*v,t.vertexAttribDivisor(2,1),t.vertexAttribDivisor(3,1),t.vertexAttribDivisor(4,1),t.vertexAttribDivisor(5,1),t.vertexAttribDivisor(6,1),t.vertexAttribDivisor(7,1),t.vertexAttribDivisor(8,1),t.vertexAttribDivisor(9,1),t.vertexAttribDivisor(10,1),t.vertexAttribDivisor(11,1),t.vertexAttribDivisor(12,1),t.bindVertexArray(null)}_bindData(t){const i=this._components;this._transformData.bind(),this._transformData.upload(i*this._imageCount),t.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let n=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_texture_index <= ${h}.5) {
`:o+=`   else if (v_texture_index <= ${h}.5) {
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return n=n.replace("%%texture_picker%%",o),n}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(Mt.Filtering),n=i?dr(i):void 0,o=Ni(t.getAttribute(Mt.WrappingX)),h=Ni(t.getAttribute(Mt.WrappingY)),c=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:n,wrapping:{x:o,y:h}},c);t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&(this._textures.push(_),this._textureToIndex.set(_,this._textureIndex++),this._images.add(t))}_bindTextures(t){const i=Math.min(this._textureIndex,this._maxTextures);for(let n=0;n<i;n++)t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,this._textures[n]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const n=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(n))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,n,o,h,c,_,p,v){var x,b,S,P;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const I=this._getImageWidth(t),F=this._getImageHeight(t);let R=I||o||0,T=F||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(x=o??I)!==null&&x!==void 0?x:0,this._view[3]=(b=h??F)!==null&&b!==void 0?b:0,this._dest[0]=i??1,this._dest[1]=n??1,c!==void 0&&_!==void 0&&p!==void 0&&v!==void 0&&(this._view[0]=i??1,this._view[1]=n??1,this._view[2]=(S=o??I)!==null&&S!==void 0?S:0,this._view[3]=(P=h??F)!==null&&P!==void 0?P:0,this._dest[0]=c,this._dest[1]=_,R=p,T=v),i=this._view[0],n=this._view[1];const M=this._view[2],W=this._view[3],U=this._context.getTransform(),G=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+mt),this._dest[1]=~~(this._dest[1]+mt));const X=this._context.tint||this._defaultTint,rt=this._getTextureIdForImage(t),lt=I||R,yt=F||T,vt=(i+this.uvPadding)/lt,Pt=(n+this.uvPadding)/yt,Dt=(i+M-this.uvPadding)/lt,B=(n+W-this.uvPadding)/yt,z=I,Q=F,et=this._transformData.bufferData;et[this._vertexIndex++]=this._dest[0],et[this._vertexIndex++]=this._dest[1],et[this._vertexIndex++]=U.data[0],et[this._vertexIndex++]=U.data[1],et[this._vertexIndex++]=U.data[2],et[this._vertexIndex++]=U.data[3],et[this._vertexIndex++]=U.data[4],et[this._vertexIndex++]=U.data[5],et[this._vertexIndex++]=G,et[this._vertexIndex++]=R,et[this._vertexIndex++]=T,et[this._vertexIndex++]=z,et[this._vertexIndex++]=Q,et[this._vertexIndex++]=rt,et[this._vertexIndex++]=vt,et[this._vertexIndex++]=Pt,et[this._vertexIndex++]=Dt,et[this._vertexIndex++]=B,et[this._vertexIndex++]=X.r/255,et[this._vertexIndex++]=X.g/255,et[this._vertexIndex++]=X.b/255,et[this._vertexIndex++]=X.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._bindData(t),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),t.drawArraysInstanced(t.TRIANGLES,0,6,this._imageCount),Kt.DrawnImagesCount+=this._imageCount,Kt.DrawCallCount++,t.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const mt=1e-4;class Tv{constructor(t){this._webglCtx=t,this._debugText=new ec}drawRect(t,i,n,o,h={color:K.Black}){this.drawLine(N(t,i),N(t+n,i),{...h}),this.drawLine(N(t+n,i),N(t+n,i+o),{...h}),this.drawLine(N(t+n,i+o),N(t,i+o),{...h}),this.drawLine(N(t,i+o),N(t,i),{...h})}drawLine(t,i,n){var o;this._webglCtx.draw("ex.line",t,i,(o=n?.color)!==null&&o!==void 0?o:K.Black)}drawPoint(t,i={color:K.Black,size:5}){this._webglCtx.draw("ex.point",t,i.color,i.size)}drawText(t,i){this._debugText.write(this._webglCtx,t,i)}}class Fs{get z(){return this._state.current.z}set z(t){this._state.current.z=t}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(t){let i=!0;return(t.width>4096||t.height>4096)&&(i=!1),i}constructor(t){this._logger=dt.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=Be.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new Ia(()=>new cv,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new Om,this._state=new xf,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=K.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new Tv(this),this._totalPostProcessorTime=0;const{canvasElement:i,context:n,enableTransparency:o,antialiasing:h,uvPadding:c,multiSampleAntialiasing:_,pixelArtSampler:p,powerPreference:v,snapToPixel:x,backgroundColor:b,useDrawSorting:S,garbageCollector:P,handleContextLost:I,handleContextRestored:F}=t;if(this.__gl=n??i.getContext("webgl2",{antialias:h??this.smoothing,premultipliedAlpha:!1,alpha:o??this.transparency,depth:!1,powerPreference:v??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");I&&this.__gl.canvas.addEventListener("webglcontextlost",I,!1),F&&this.__gl.canvas.addEventListener("webglcontextrestored",F,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new re(this.__gl,P),this.snapToPixel=x??this.snapToPixel,this.smoothing=h??this.smoothing,this.transparency=o??this.transparency,this.pixelArtSampler=p??this.pixelArtSampler,this.uvPadding=c??this.uvPadding,this.multiSampleAntialiasing=typeof _=="boolean"?_:this.multiSampleAntialiasing,this.samples=typeof _=="object"?_.samples:void 0,this.backgroundColor=b??this.backgroundColor,this.useDrawSorting=S??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const t of this._renderers.values())t.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const t=this.__gl;if(this._ortho=gi.ortho(0,t.canvas.width,t.canvas.height,0,400,-400),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!1),this.register(new sv({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new Qu),this.register(new ov),this.register(new lv),this.register(new Jm),this.register(new jm),this.lazyRegister("ex.particle",()=>new Ef),this.register(new Pv({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=t.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");t.bindTexture(t.TEXTURE_2D,this.materialScreenTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),this._screenRenderer=new tv(t),this._renderTarget=new sa({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),this._postProcessTargets=[new sa({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),new sa({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height})],this._msaaTarget=new sa({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(t){this._renderers.set(t.type,t),t.initialize(this.__gl,this)}lazyRegister(t,i){this._lazyRenderersFactory.set(t,i)}get(t){let i=this._renderers.get(t);if(!i){const n=this._lazyRenderersFactory.get(t);n&&(this._logger.debug("lazy init renderer:",t),i=n(),this.register(i))}return i}_isCurrentRenderer(t){return!this._currentRenderer||this._currentRenderer===t}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(t,...i){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${t}, the webgl context is lost`);return}const n=this.get(t);if(n)if(this.useDrawSorting){const o=this._drawCallPool.get();o.z=this._state.current.z,o.priority=n.priority,o.renderer=t,this.getTransform().clone(o.transform),o.state.z=this._state.current.z,o.state.opacity=this._state.current.opacity,o.state.tint=this._state.current.tint,o.state.material=this._state.current.material,o.args[0]=i[0],o.args[1]=i[1],o.args[2]=i[2],o.args[3]=i[3],o.args[4]=i[4],o.args[5]=i[5],o.args[6]=i[6],o.args[7]=i[7],o.args[8]=i[8],o.args[9]=i[9],this._drawCalls[this._drawCallIndex++]=o}else this._currentRenderer||(this._currentRenderer=n),this._isCurrentRenderer(n)||this._currentRenderer.flush(),n.draw(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9]),this._currentRenderer=n;else throw Error(`No renderer with name ${t} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(t){const i=this.__gl;this._ortho=this._ortho=gi.ortho(0,t.width,t.height,0,400,-400),this._renderTarget.setResolution(i.canvas.width,i.canvas.height),this._msaaTarget.setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[0].setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[1].setResolution(i.canvas.width,i.canvas.height)}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}drawImage(t,i,n,o,h,c,_,p,v){if(!(o===0||h===0)){{if(p===0||v===0)return;if(this._getImageWidth(t)===0||this._getImageHeight(t)===0)return}if(!t){dt.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",t,i,n,o,h,c,_,p,v):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,t,i,n,o,h,c,_,p,v):this.draw(this.imageRenderer,t,i,n,o,h,c,_,p,v)}}drawLine(t,i,n,o=1){this.draw("ex.rectangle",t,i,n,o)}drawRectangle(t,i,n,o,h,c){this.draw("ex.rectangle",t,i,n,o,h,c)}drawCircle(t,i,n,o,h){this.draw("ex.circle",t,i,n,o,h)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(t,i){this._transform.translate(this.snapToPixel?~~(t+mt):t,this.snapToPixel?~~(i+mt):i)}rotate(t){this._transform.rotate(t)}scale(t,i){this._transform.scale(t,i)}transform(t){this._transform.current=t}getTransform(){return this._transform.current}multiply(t){this._transform.current.multiply(t,this._transform.current)}addPostProcessor(t){this._postprocessors.push(t),t.initialize(this.__gl)}removePostProcessor(t){const i=this._postprocessors.indexOf(t);i!==-1&&this._postprocessors.splice(i,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(t){for(const i of this._postprocessors){const n=i.getShader();n.use();const o=n.getUniforms();this._totalPostProcessorTime+=t,o.find(h=>h.name==="u_time_ms")&&n.setUniformFloat("u_time_ms",this._totalPostProcessorTime),o.find(h=>h.name==="u_elapsed_ms")&&n.setUniformFloat("u_elapsed_ms",t),o.find(h=>h.name==="u_resolution")&&n.setUniformFloatVector("u_resolution",N(this.width,this.height)),i.onUpdate&&i.onUpdate(t)}}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return new Pf({...t,graphicsContext:this})}createShader(t){const i=this.__gl,{vertexSource:n,fragmentSource:o}=t,h=new di({gl:i,vertexSource:n,fragmentSource:o});return h.compile(),h}clear(){const t=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT)}flush(){var t;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let i=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(i.use(),this.useDrawSorting){for(let c=this._drawCallIndex;c<this._drawCalls.length;c++)this._drawCalls[c]=null;const n=new Map;for(const[c]of this._renderers){let _=0;for(_=0;_<this._drawCallIndex&&this._drawCalls[_].renderer!==c;_++);n.set(c,_)}this._drawCalls.sort((c,_)=>{if(c===null||_===null)return 0;const p=c.z-_.z,v=n.get(c.renderer)-n.get(_.renderer),x=c.priority-_.priority;return p===0?x===0?v:x:p});const o=this._transform.current,h=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let c=this._drawCalls[0].renderer,_=this.get(c);for(let p=0;p<this._drawCallIndex;p++)this._transform.current=this._drawCalls[p].transform,this._state.current=this._drawCalls[p].state,this._drawCalls[p].renderer!==c&&(_.flush(),c=this._drawCalls[p].renderer,_=this.get(c)),_ instanceof Qu&&(!((t=this.material)===null||t===void 0)&&t.isUsingScreenTexture)&&(i.copyToTexture(this.materialScreenTexture),i.use()),_.draw(...this._drawCalls[p].args);_.hasPendingDraws()&&_.flush()}this._transform.current=o,this._state.current=h,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const n of this._renderers.values())n.hasPendingDraws()&&n.flush();i.disable(),this._postprocessors.length>0&&i.toRenderSource().use();for(let n=0;n<this._postprocessors.length;n++)i=this._postProcessTargets[n%2],this._postProcessTargets[n%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[n]),this._postProcessTargets[n%2].toRenderSource().use();i.blitToScreen()}}const de=1e-4;class Ev{constructor(t){this._ex=t,this._debugText=new ec}drawRect(t,i,n,o){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(t+de):t,this._ex.snapToPixel?~~(i+de):i,this._ex.snapToPixel?~~(n+de):n,this._ex.snapToPixel?~~(o+de):o),this._ex.__ctx.restore()}drawLine(t,i,n={color:K.Black}){var o,h;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(h=(o=n.color)===null||o===void 0?void 0:o.toString())!==null&&h!==void 0?h:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(t.x+de):t.x,this._ex.snapToPixel?~~(t.y+de):t.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(i.x+de):i.x,this._ex.snapToPixel?~~(i.y+de):i.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(t,i={color:K.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=i.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(t.x+de):t.x,this._ex.snapToPixel?~~(t.y+de):t.y,i.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(t,i){this._debugText.write(this._ex,t,i)}}class Aa{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(t){this.__ctx.imageSmoothingEnabled=t}constructor(t){this.useDrawSorting=!1,this.z=0,this.backgroundColor=K.ExcaliburBlue,this._state=new xf,this.snapToPixel=!1,this.debug=new Ev(this);const{canvasElement:i,context:n,enableTransparency:o,snapToPixel:h,antialiasing:c,backgroundColor:_}=t;if(this.__ctx=n??i.getContext("2d",{alpha:o??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=_??this.backgroundColor,this.snapToPixel=h??this.snapToPixel,this.smoothing=c??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(t){}drawImage(t,i,n,o,h,c,_,p,v){if(o===0||h===0)return;if(p===0||v===0)return;if(t.width===0||t.height===0)return;this.__ctx.globalAlpha=this.opacity;const x=[t,i,n,o,h,c,_,p,v].filter(b=>b!==void 0).map(b=>typeof b=="number"&&this.snapToPixel?~~b:b);this.__ctx.drawImage.apply(this.__ctx,x),Kt.DrawCallCount++,Kt.DrawnImagesCount=1}drawLine(t,i,n,o=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=n.toString(),this.__ctx.moveTo(this.snapToPixel?~~(t.x+de):t.x,this.snapToPixel?~~(t.y+de):t.y),this.__ctx.lineTo(this.snapToPixel?~~(i.x+de):i.x,this.snapToPixel?~~(i.y+de):i.y),this.__ctx.lineWidth=o,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(t,i,n,o){this.__ctx.save(),this.__ctx.fillStyle=o.toString(),this.__ctx.fillRect(this.snapToPixel?~~(t.x+de):t.x,this.snapToPixel?~~(t.y+de):t.y,this.snapToPixel?~~(i+de):i,this.snapToPixel?~~(n+de):n),this.__ctx.restore()}drawCircle(t,i,n,o,h){this.__ctx.save(),this.__ctx.beginPath(),o&&(this.__ctx.strokeStyle=o.toString()),h&&(this.__ctx.lineWidth=h),this.__ctx.fillStyle=n.toString(),this.__ctx.arc(this.snapToPixel?~~(t.x+de):t.x,this.snapToPixel?~~(t.y+de):t.y,i,0,Math.PI*2),this.__ctx.fill(),o&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(t,i){this.__ctx.translate(this.snapToPixel?~~(t+de):t,this.snapToPixel?~~(i+de):i)}rotate(t){this.__ctx.rotate(t)}scale(t,i){this.__ctx.scale(t,i)}getTransform(){throw new Error("Not implemented")}multiply(t){this.__ctx.setTransform(this.__ctx.getTransform().multiply(t.toDOMMatrix()))}addPostProcessor(t){}removePostProcessor(t){}clearPostProcessors(){}updatePostProcessors(t){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),Kt.clear()}flush(){}dispose(){this.__ctx=void 0}}var Te;(function(d){d.Fixed="Fixed",d.FitContainerAndFill="FitContainerAndFill",d.FitScreenAndFill="FitScreenAndFill",d.FitContainerAndZoom="FitContainerAndZoom",d.FitScreenAndZoom="FitScreenAndZoom",d.FitScreen="FitScreen",d.FillScreen="FillScreen",d.FitContainer="FitContainer",d.FillContainer="FillContainer"})(Te||(Te={}));class Il{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const Iv={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class Rl{constructor(t){var i,n,o,h;this.events=new $t,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=dt.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const c=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(c),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new ct,this._unsafeArea=new ct,this.viewport=t.viewport,this.resolution=(i=t.resolution)!==null&&i!==void 0?i:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(n=t.displayMode)!==null&&n!==void 0?n:Te.Fixed,this._canvas=t.canvas,this.graphicsContext=t.context,this._antialiasing=(o=t.antialiasing)!==null&&o!==void 0?o:this._antialiasing,this._canvasImageRendering=(h=t.canvasImageRendering)!==null&&h!==void 0?h:this._canvasImageRendering,this._browser=t.browser,this._pixelRatioOverride=t.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const t=this.worldToPageCoordinates(k.Zero);return this.worldToPageCoordinates(N(1,0)).sub(t).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(t){this._pixelRatioOverride=t}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case Te.FillContainer:case Te.FitContainer:case Te.FitContainerAndFill:case Te.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(t){this._resolution=t}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(t){this._viewport=t}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(t){this._camera=t}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof Fs&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let o=Math.max(1,this.pixelRatio-.5),h=!1;for(;o>1&&!h;){o=Math.max(1,o-.5);const c=this._resolution.width*o,_=this._resolution.height*o;h=this.graphicsContext.checkIfResolutionSupported({width:c,height:_})}this.pixelRatioOverride=o,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const t=this.viewport.widthUnit==="percent"?"%":"px",i=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+t,this._canvas.style.height=this.viewport.height+i,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof Aa&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(t){this._antialiasing=t,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(t){return this.enterFullscreen(t)}enterFullscreen(t){var i,n,o,h,c,_;if(t){const p=document.getElementById(t);if(p?.requestFullscreen||p?.webkitRequestFullscreen){if(p.getAttribute("ex-fullscreen-listener")||(p.setAttribute("ex-fullscreen-listener","true"),p.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),p.requestFullscreen)return(i=p.requestFullscreen())!==null&&i!==void 0?i:Promise.resolve();if(p.webkitRequestFullscreen)return(n=p.webkitRequestFullscreen())!==null&&n!==void 0?n:Promise.resolve()}}return!((o=this._canvas)===null||o===void 0)&&o.requestFullscreen?(c=(h=this._canvas)===null||h===void 0?void 0:h.requestFullscreen())!==null&&c!==void 0?c:Promise.resolve():this._canvas.webkitRequestFullscreen?(_=this._canvas.webkitRequestFullscreen())!==null&&_!==void 0?_:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(t){return{width:t.widthUnit==="percent"?this.canvas.offsetWidth:t.width,height:t.heightUnit==="percent"?this.canvas.offsetHeight:t.height}}pageToScreenCoordinates(t){let i=t.x,n=t.y;this._isFullscreen||(i-=Vr(this._canvas).x,n-=Vr(this._canvas).y);const o=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,c=(window.innerHeight-h)/2;n=(n-c)/h*o.height,i=i/window.innerWidth*o.width}else{const h=window.innerHeight*this.aspectRatio,c=(window.innerWidth-h)/2;i=(i-c)/h*o.width,n=n/window.innerHeight*o.height}return i=i/o.width*this.resolution.width,n=n/o.height*this.resolution.height,i=i-this.contentArea.left,n=n-this.contentArea.top,new k(i,n)}screenToPageCoordinates(t){let i=t.x,n=t.y;const o=this._viewportToPixels(this.viewport);if(i=i/this.resolution.width*o.width,n=n/this.resolution.height*o.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,c=(window.innerHeight-h)/2;n=n/o.height*h+c,i=i/o.width*window.innerWidth}else{const h=window.innerHeight*this.aspectRatio,c=(window.innerWidth-h)/2;i=i/o.width*h+c,n=n/o.height*window.innerHeight}return this._isFullscreen||(i+=Vr(this._canvas).x,n+=Vr(this._canvas).y),new k(i,n)}screenToWorldCoordinates(t){return t=t.add(N(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(t):t.sub(N(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(t){return this._camera?this._camera.transform.multiply(t):t.add(N(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(t){const i=this.pageToScreenCoordinates(t);return this.screenToWorldCoordinates(i)}worldToPageCoordinates(t){const i=this.worldToScreenCoordinates(t);return this.screenToPageCoordinates(i)}getWorldBounds(){return ct.fromDimension(this.resolution.width,this.resolution.height,k.Half).scale(N(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero,k.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return N(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=this.aspectRatio;let i=0,n=0;window.innerWidth/t<window.innerHeight?(i=window.innerWidth,n=window.innerWidth/t):(i=window.innerHeight*t,n=window.innerHeight),this.viewport={width:i,height:n},this._contentArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this._unsafeArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndFill(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(t,i,n){if(this.viewport=n??{width:t,height:i},t/i<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:t*this._contentResolution.width/t,height:t*this._contentResolution.width/t*i/t};const o=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new ct({top:o,left:0,right:this._contentResolution.width,bottom:this.resolution.height-o}),this._unsafeArea=new ct({top:-o,left:0,right:this._contentResolution.width,bottom:this.resolution.height+o})}else{this.resolution={width:i*this._contentResolution.height/i*t/i,height:i*this._contentResolution.height/i};const o=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new ct({top:0,left:o,right:this.resolution.width-o,bottom:this._contentResolution.height}),this._unsafeArea=new ct({top:0,left:-o,right:this.resolution.width+o,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndZoom(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const t=this.canvas.parentElement;t.style.overflow="hidden";const{offsetWidth:i,offsetHeight:n}=this.canvas;this._computeFitAndZoom(i,n),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(t,i){const n=this.aspectRatio;let o=0,h=0;t/n<i?(o=t,h=t/n):(o=i*n,h=i);const c=t/o,_=i/h,p=Math.max(c,_),v=o*p,x=h*p;v>t?this.canvas.style.left=-(v-t)/2+"px":this.canvas.style.left="",x>i?this.canvas.style.top=-(x-i)/2+"px":this.canvas.style.top="",this.viewport={width:v,height:x};const b=ct.fromDimension(this.viewport.width,this.viewport.height,k.Zero);if(this.viewport.width>t){const S=(this.viewport.width-t)/this.viewport.width*this.resolution.width;b.top=0,b.left=S/2,b.right=this.resolution.width-S/2,b.bottom=this.resolution.height}if(this.viewport.height>i){const S=(this.viewport.height-i)/this.viewport.height*this.resolution.height;b.top=S/2,b.left=0,b.bottom=this.resolution.height-S/2,b.right=this.resolution.width}this._contentArea=b}_computeFitContainer(){const t=this.aspectRatio;let i=0,n=0,o="pixel",h="pixel";const c=this.canvas.parentElement;c.clientWidth/t<c.clientHeight?(this.canvas.style.width="100%",i=100,o="percent",n=this.canvas.offsetWidth/t):(this.canvas.style.height="100%",n=100,h="percent",i=this.canvas.offsetHeight*t),this.viewport={width:i,widthUnit:o,height:n,heightUnit:h},this._contentArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(t){this.displayMode===Te.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===Te.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:t.innerWidth,height:t.innerHeight},this.viewport=this.resolution),this._contentArea=ct.fromDimension(this.resolution.width,this.resolution.height,k.Zero),this.displayMode===Te.FitScreen&&this._computeFit(),this.displayMode===Te.FitContainer&&this._computeFitContainer(),this.displayMode===Te.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===Te.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===Te.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===Te.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class Qr{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function Rv(d){return!!d.playbackState}class In{static unlock(){return new Promise((i,n)=>{if(In._UNLOCKED||!Qr.create())return i(!0);const o=setTimeout(()=>{dt.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),i(!1)},200),h=Qr.create();h.resume().then(()=>{const c=h.createBuffer(1,1,22050),_=h.createBufferSource();let p=!1;_.buffer=c,_.connect(h.destination),_.onended=()=>p=!0,_.start(0),setTimeout(()=>{Rv(_)?(_.playbackState===_.PLAYING_STATE||_.playbackState===_.FINISHED_STATE)&&(In._UNLOCKED=!0):(h.currentTime>0||p)&&(In._UNLOCKED=!0)},0),clearTimeout(o),i(!0)},()=>{n()})})}static isUnlocked(){return this._UNLOCKED}}In._UNLOCKED=!1;class Fa extends ur{get ctx(){return this._ctx}constructor(t={}){super(t),this._options=t}clone(){return new Fa({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){var i,n;!((i=this._options)===null||i===void 0)&&i.draw&&((n=this._options)===null||n===void 0||n.draw(t)),this._options.cache||this.flagDirty()}}class Rc{}Rc.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class Ma{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(t){this._currentState=t}static create(t,i){const n=new Ma;n.data=i;for(const o in t.states)n.states.set(o,{name:o,...t.states[o]});for(const o of n.states.values())for(const h of o.transitions)if(h!=="*"&&!n.states.has(h))throw Error(`Invalid state machine, state [${o.name}] has a transition to another state that doesn't exist [${h}]`);return n.currentState=n.startState=n.states.get(t.start),n}in(t){return this.currentState.name===t}go(t,i){var n,o;if(this.currentState.transitions.includes(t)||this.currentState.transitions.includes("*")){const h=this.states.get(t);return this.currentState.onExit&&((n=this.currentState)===null||n===void 0?void 0:n.onExit({to:h.name,data:this.data}))===!1||h?.onEnter&&h?.onEnter({from:this.currentState.name,eventData:i,data:this.data})===!1?!1:(this.currentState=h,!((o=this.currentState)===null||o===void 0)&&o.onState&&this.currentState.onState(),!0)}return!1}update(t){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,t)}save(t){localStorage.setItem(t,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(t){const i=JSON.parse(localStorage.getItem(t));this.currentState=this.states.get(i.currentState),this.data=i.data}}class If{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(t){this._loop=t,this._instance&&(this._instance.loop=t,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(t){t=St(t,0,1),this._volume=t,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(t,this._audioContext.currentTime,.1):this._volumeNode.gain.value=t}get volume(){return this._volume}get duration(){var t;return(t=this._duration)!==null&&t!==void 0?t:this.getTotalPlaybackDuration()}set duration(t){this._duration=t}constructor(t){this._src=t,this._audioContext=Qr.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new yi,this._stateMachine=Ma.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:i})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,i.pausedAt*this._playbackRate):this._instance.start(0,i.pausedAt*this._playbackRate,this.duration),i.startedAt=this._audioContext.currentTime-i.pausedAt,i.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:i})=>{i==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:i,data:n})=>{n.pausedAt=(i??0)/this._playbackRate,n.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:i})=>{i.pausedAt=0,i.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:i})=>{i.pausedAt=this._audioContext.currentTime-i.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(t=()=>{}){return this._playStarted=t,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(t){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",t)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:t,startedAt:i}=this._stateMachine.data;return t?t*this._playbackRate:i?(this._audioContext.currentTime-i)*this._playbackRate:0}set playbackRate(t){this._instance.playbackRate.value=this._playbackRate=t}get playbackRate(){return this._instance.playbackRate.value}}class Dc extends At{set bubbles(t){}get bubbles(){return!1}get _path(){return null}set _path(t){}constructor(t,i="MediaEvent"){super(),this.target=t,this._name=i}stopPropagation(){}action(){}propagate(){}layPath(t){}}class wn extends Dc{constructor(t,i){super(t,"NativeSoundEvent"),this.track=i}}class Rf extends Dc{constructor(t,i){super(t,"NativeSoundProcessedEvent"),this._processedData=i,this.data=this._processedData}}function Dv(d){try{const t=new Audio,i=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,n=d.match(i)[1];return!!t.canPlayType("audio/"+n)}catch(t){return dt.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",t),!1}}const Fv={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class Df{set loop(t){this._loop=t;for(const i of this._tracks)i.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(t){this._volume=t;for(const i of this._tracks)i.volume=this._volume;this.events.emit("volumechange",new wn(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(t){this._duration=t}get instances(){return this._tracks}get path(){return this._resource.path}set path(t){this._resource.path=t}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}constructor(...t){this.events=new $t,this.logger=dt.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=Qr.create(),this._resource=new ao("",Rc.type.arraybuffer);for(const i of t)if(Dv(i)){this.path=i;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",t.join(", ")),this.logger.warn("Attempting to use",t[0]),this.path=t[0])}isLoaded(){return!!this.data}async load(){var t,i;if(this.data)return this.data;const n=await this._resource.load(),o=await this.decodeAudio(n.slice(0));return this._duration=(i=(t=this._duration)!==null&&t!==void 0?t:o?.duration)!==null&&i!==void 0?i:void 0,this.events.emit("processed",new Rf(this,o)),this.data=o}async decodeAudio(t){try{return await this._audioContext.decodeAudioData(t.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(t){t&&(this._engine=t,this._engine.on("hidden",()=>{t.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{t.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(t=>t.isPlaying())}isPaused(){return this._tracks.some(t=>t.isPaused())}isStopped(){return this._tracks.some(t=>t.isStopped())}play(t){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=t||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const t of this._tracks)t.pause();this.events.emit("pause",new wn(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const t of this._tracks)t.stop();this.events.emit("stop",new wn(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._tracks.forEach(i=>{i.playbackRate=this._playbackRate})}seek(t,i=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[i].seek(t)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(t=0){return this._tracks.length?this._tracks[t].getPlaybackPosition():0}getTrackId(t){return this._tracks.indexOf(t)}async _resumePlayback(){if(this.isPaused()){const t=[];for(const i of this._tracks)t.push(i.play().then(()=>(this._tracks.splice(this.getTrackId(i),1),!0)));this.events.emit("resume",new wn(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(t)}return!0}async _startPlayback(){const t=this._getTrackInstance(this.data),i=await t.play(()=>{this.events.emit("playbackstart",new wn(this,t)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new wn(this,t));const n=this.getTrackId(t);return n!==-1&&this._tracks.splice(n,1),i}_getTrackInstance(t){var i;const n=new If(t);return n.loop=this.loop,n.volume=this.volume,n.duration=(i=this.duration)!==null&&i!==void 0?i:0,n.playbackRate=this._playbackRate,this._tracks.push(n),n}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const Mv={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function Dl(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class Jr{get resources(){return this._resources}constructor(t){var i;this.events=new $t,this.canvas=new Fa({filtering:xe.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new yi,t&&(!((i=t.loadables)===null||i===void 0)&&i.length)&&this.addResources(t.loadables)}onInitialize(t){this.engine=t,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await ca(500,this.engine.clock)}addResource(t){this._resources.push(t)}addResources(t){let i=0;const n=t.length;for(i;i<n;i++)this.addResource(t[i])}markResourceComplete(){this._numLoaded++}get progress(){const t=this._resources.length;return t>0?St(this._numLoaded,0,t)/t:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(t,i){this._totalTimeMs+=i}onDraw(t){const i=this._totalTimeMs/1e3;t.fillStyle=K.Black.toRGBA(),t.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),t.save(),t.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const n=i*10;t.strokeStyle="white",t.lineWidth=10,t.lineCap="round",t.arc(0,0,40,n,n+Math.PI*3/2),t.stroke(),t.fillStyle="white",t.font="16px sans-serif";const o=(this.progress*100).toFixed(0)+"%",h=t.measureText(o),c=Math.abs(h.actualBoundingBoxLeft)+Math.abs(h.actualBoundingBoxRight),_=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);t.fillText(o,-c/2,_/2),t.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async t=>{this.events.emit("loadresourcestart",t),await t.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",t)})}));for(const t of this._resources)t instanceof Df&&t.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await In.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const Bv="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var kv=Re(851);class Un extends Jr{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const t=document.getElementById("excalibur-play-root");return t&&(this._playButtonRootElement=t),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(t){const i=Array.isArray(t)?{loadables:t}:t;super(i),this._logger=dt.getInstance(),this._originalOptions={loadables:[]},this.events=new $t,this._playButtonShown=!1,this.logo=Bv,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=K.White,this.backgroundColor="#176BAA",this._imageLoaded=new yi,this.suppressPlayButton=!1,this._playButtonStyles=kv.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let n=document.getElementById("excalibur-play");return n||(n=document.createElement("button")),n.id="excalibur-play",n.textContent=this.playButtonText,n.style.display="none",n},this._originalOptions={...Un._DEFAULT_LOADER_OPTIONS,...i}}onInitialize(t){this.engine=t,this.screen=t.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var t,i;if(this.suppressPlayButton)this.hidePlayButton(),await ca(500,(t=this.engine)===null||t===void 0?void 0:t.clock);else{const n=()=>{try{this._positionPlayButton()}catch{}};return!((i=this.engine)===null||i===void 0)&&i.browser&&this.engine.browser.window.on("resize",n),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",h=>{h.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(h=>{const c=_=>{var p;if(_.stopPropagation(),this.hidePlayButton(),!((p=this.engine)===null||p===void 0)&&p.browser&&this.engine.browser.window.off("resize",n),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(v){this._logger.error("could not go fullscreen",v)}h()};this._playButton.addEventListener("click",c),this._playButton.addEventListener("touchend",c),this._playButton.addEventListener("pointerup",c),this.engine&&this.engine.input.gamepads.once("button",()=>c(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var t;await ca(200,(t=this.engine)===null||t===void 0?void 0:t.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const t=this._image;await this._imageLoaded.promise,await t?.decode()}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:t,y:i,width:n,height:o}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const h=this._playButton.clientWidth,c=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${t+n/2-h/2}px`,this._playButtonRootElement.style.top=`${i+o/2-c/2+100}px`)}}}onDraw(t){const i=this.engine.canvasHeight/this.engine.pixelRatio,n=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),t.fillStyle=this.backgroundColor,t.fillRect(0,0,n,i);let o=i/2;const h=Math.min(this.logoWidth,n*.75);let c=n/2-h/2;this.logoPosition&&(c=this.logoPosition.x,o=this.logoPosition.y);const _=Math.floor(h*(this.logoHeight/this.logoWidth)),p=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,c,o,h,_):t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,c,o-_-20,h,_),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=p;return}let v=c,x=o;this.loadingBarPosition&&(v=this.loadingBarPosition.x,x=this.loadingBarPosition.y),t.lineWidth=2,El(t,v,x,h,20,10,this.loadingBarColor);const b=h*this.progress,S=5,P=b-S*2,I=20-S*2;El(t,v+S,x+S,P>10?P:10,I,5,null,this.loadingBarColor),this.engine.screen.antialiasing=p}}Un._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const Ju={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class Ff{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("2d"))},arrayBufferSupport:function(){const t=new XMLHttpRequest;t.open("GET","/");try{t.responseType="arraybuffer"}catch{return!1}return t.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const t=document.createElement("a").style;return t.cssText="background-color:rgba(150,255,150,.5)",(""+t.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let t=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const i=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],n=this.getBrowserFeatures();for(const o of Object.keys(Ju))n[o]?(t+="(%c✓%c)",i.push("font-weight: bold; color: green"),i.push("font-weight: normal; color: inherit")):(t+="(%c✗%c)",i.push("font-weight: bold; color: red"),i.push("font-weight: normal; color: inherit")),t+=" "+Ju[o]+`
`;i.unshift(t),console.log.apply(console,i)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let t=!1;for(const i in this._criticalTests)this._criticalTests[i].call(this)||(this.failedTests.push(i),dt.getInstance().error("Critical browser feature missing, Excalibur requires:",i),t=!0);if(t)return!1;for(const i in this._warningTest)this._warningTest[i]()||dt.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",i);return!0}}var _t;(function(d){d.PreventCollision="PreventCollision",d.Passive="Passive",d.Active="Active",d.Fixed="Fixed"})(_t||(_t={}));class hs{static create(t,i){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(t)){const o=this._GROUPS.get(t);if(o.mask===i)return o;throw new Error(`Collision group ${t} already exists with a different mask!`)}const n=new ks(t,this._CURRENT_BIT,i!==void 0?i:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(t,n),n}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(t){return this._GROUPS.get(t)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}hs._STARTING_BIT=1;hs._MAX_GROUPS=32;hs._CURRENT_GROUP=1;hs._CURRENT_BIT=hs._STARTING_BIT;hs._GROUPS=new Map;class ks{constructor(t,i,n){this._name=t,this._category=i,this._mask=n}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(t){const i=this.category&t.mask,n=this.mask&t.category;return i!==0&&n!==0}invert(){const t=hs.create("~("+this.name+")",~this.mask|0);return t._category=~this.category,t}static combine(t){const i=t.map(h=>h.name).join("+"),o=~t.reduce((h,c)=>c.category|h,0);return hs.create(i,o)}static collidesWith(t){const i=`collidesWith(${t.map(o=>o.name).join("+")})`,n=t.reduce((o,h)=>h.category|o,0);return hs.create(i,n)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}ks.All=new ks("Collide with all groups",-1,-1);class ei{constructor(t,i){this.colliderA=t,this.colliderB=i,this.id=null,this.id=ei.calculatePairHash(t.id,i.id)}static canCollide(t,i){var n,o;if(t.id===i.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.localBounds.hasZeroDimensions()||i.localBounds.hasZeroDimensions())return!1;const h=(n=t?.owner)===null||n===void 0?void 0:n.get(Et),c=(o=i?.owner)===null||o===void 0?void 0:o.get(Et);return!(!h||!c||!h.group.canCollide(c.group)||h.collisionType===_t.Fixed&&c.collisionType===_t.Fixed||c.collisionType===_t.PreventCollision||h.collisionType===_t.PreventCollision||!h.isActive||!c.isActive)}get canCollide(){const t=this.colliderA,i=this.colliderB;return ei.canCollide(t,i)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(t){return t===this.colliderA||t===this.colliderB}static calculatePairHash(t,i){return t.value<i.value?`#${t.value}+${i.value}`:`#${i.value}+${t.value}`}}class uo{constructor(t,i){this.min=t,this.max=i}overlaps(t){return this.max>t.min&&t.max>this.min}getOverlap(t){return this.overlaps(t)?this.max>t.max?t.max-this.min:this.max-t.min:0}}class Fl{constructor(t){this.parent=t,this.parent=t||null,this.data=null,this.bounds=new ct,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class Fc{constructor(t,i=new ct(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=t,this.worldBounds=i,this.root=null,this.nodes={}}_insert(t){if(this.root===null){this.root=t,this.root.parent=null;return}const i=t.bounds;let n=this.root;for(;!n.isLeaf();){const _=n.left,p=n.right,v=n.bounds.getPerimeter(),b=n.bounds.combine(i).getPerimeter(),S=2*b,P=2*(b-v);let I=0;const F=i.combine(_.bounds);let R,T;_.isLeaf()?I=F.getPerimeter()+P:(T=_.bounds.getPerimeter(),R=F.getPerimeter(),I=R-T+P);let M=0;const W=i.combine(p.bounds);if(p.isLeaf()?M=W.getPerimeter()+P:(T=p.bounds.getPerimeter(),R=W.getPerimeter(),M=R-T+P),S<I&&S<M)break;I<M?n=_:n=p}const o=n.parent,h=new Fl(o);h.bounds=i.combine(n.bounds),h.height=n.height+1,o!==null?(o.left===n?o.left=h:o.right=h,h.left=n,h.right=t,n.parent=h,t.parent=h):(h.left=n,h.right=t,n.parent=h,t.parent=h,this.root=h);let c=t.parent;for(;c;){if(c=this._balance(c),!c.left)throw new Error("Parent of current leaf cannot have a null left child"+c);if(!c.right)throw new Error("Parent of current leaf cannot have a null right child"+c);c.height=1+Math.max(c.left.height,c.right.height),c.bounds=c.left.bounds.combine(c.right.bounds),c=c.parent}}_remove(t){if(t===this.root){this.root=null;return}const i=t.parent,n=i.parent;let o;if(i.left===t?o=i.right:o=i.left,n){n.left===i?n.left=o:n.right=o,o.parent=n;let h=n;for(;h;)h=this._balance(h),h.bounds=h.left.bounds.combine(h.right.bounds),h.height=1+Math.max(h.left.height,h.right.height),h=h.parent}else this.root=o,o.parent=null}trackCollider(t){const i=new Fl;i.data=t,i.bounds=t.bounds,i.bounds.left-=2,i.bounds.top-=2,i.bounds.right+=2,i.bounds.bottom+=2,this.nodes[t.id.value]=i,this._insert(i)}updateCollider(t){var i;const n=this.nodes[t.id.value];if(!n)return!1;const o=t.bounds;if(!this.worldBounds.contains(o))return dt.getInstance().warn("Collider with id "+t.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(t),!1;if(n.bounds.contains(o))return!1;if(this._remove(n),o.left-=this._config.boundsPadding,o.top-=this._config.boundsPadding,o.right+=this._config.boundsPadding,o.bottom+=this._config.boundsPadding,t.owner){const h=(i=t.owner)===null||i===void 0?void 0:i.get(Et);if(h){const c=h.vel.x*32/1e3*this._config.velocityMultiplier,_=h.vel.y*32/1e3*this._config.velocityMultiplier;c<0?o.left+=c:o.right+=c,_<0?o.top+=_:o.bottom+=_}}return n.bounds=o,this._insert(n),!0}untrackCollider(t){const i=this.nodes[t.id.value];i&&(this._remove(i),this.nodes[t.id.value]=null,delete this.nodes[t.id.value])}_balance(t){if(t===null)throw new Error("Cannot balance at null node");if(t.isLeaf()||t.height<2)return t;const i=t.left,n=t.right,o=t,h=i,c=n,_=i.left,p=i.right,v=n.left,x=n.right,b=c.height-h.height;if(b>1)return c.left=o,c.parent=o.parent,o.parent=c,c.parent?c.parent.left===o?c.parent.left=c:c.parent.right=c:this.root=c,v.height>x.height?(c.right=v,o.right=x,x.parent=o,o.bounds=h.bounds.combine(x.bounds),c.bounds=o.bounds.combine(v.bounds),o.height=1+Math.max(h.height,x.height),c.height=1+Math.max(o.height,v.height)):(c.right=x,o.right=v,v.parent=o,o.bounds=h.bounds.combine(v.bounds),c.bounds=o.bounds.combine(x.bounds),o.height=1+Math.max(h.height,v.height),c.height=1+Math.max(o.height,x.height)),c;if(b<-1){if(h.left=o,h.parent=o.parent,o.parent=h,h.parent)if(h.parent.left===o)h.parent.left=h;else{if(h.parent.right!==o)throw"Error rotating Dynamic Tree";h.parent.right=h}else this.root=h;return _.height>p.height?(h.right=_,o.left=p,p.parent=o,o.bounds=c.bounds.combine(p.bounds),h.bounds=o.bounds.combine(_.bounds),o.height=1+Math.max(c.height,p.height),h.height=1+Math.max(o.height,_.height)):(h.right=p,o.left=_,_.parent=o,o.bounds=c.bounds.combine(_.bounds),h.bounds=o.bounds.combine(p.bounds),o.height=1+Math.max(c.height,_.height),h.height=1+Math.max(o.height,p.height)),h}return t}getHeight(){return this.root===null?0:this.root.height}query(t,i){const n=t.bounds,o=h=>{if(h&&h.bounds.overlaps(n))if(h.isLeaf()&&h.data!==t){if(i.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}rayCastQuery(t,i=1/0,n){const o=h=>{if(h&&h.bounds.rayCast(t,i))if(h.isLeaf()){if(n.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}getNodes(){const t=i=>i?[i].concat(t(i.left),t(i.right)):[];return t(this.root)}debug(t){const i=n=>{n&&(n.isLeaf()?n.bounds.draw(t,K.Green):n.bounds.draw(t,K.White),n.left&&i(n.left),n.right&&i(n.right))};i(this.root)}}class Tn{constructor(t,i){this.pos=t,this.dir=i.normalize()}intersect(t){const i=t.begin.sub(this.pos);if(this.dir.cross(t.getSlope())===0&&i.cross(this.dir)!==0)return-1;const n=this.dir.cross(t.getSlope());if(n===0)return-1;const o=i.cross(t.getSlope())/n;if(o>=0){const h=i.cross(this.dir)/n/t.getLength();if(h>=0&&h<=1)return o}return-1}intersectPoint(t){const i=this.intersect(t);return i<0?null:this.getPoint(i)}getPoint(t){return this.pos.add(this.dir.scale(t))}}class ya{constructor(t){this._config=t,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new Fc(t.dynamicTree)}getColliders(){return this._colliders}query(t){const i=[];return t instanceof ct?this._dynamicCollisionTree.query({id:Fn("collider",-1),owner:null,bounds:t},n=>(i.push(n),!1)):this._dynamicCollisionTree.query({id:Fn("collider",-1),owner:null,bounds:new ct(t.x,t.y,t.x,t.y)},n=>(i.push(n),!1)),i}rayCast(t,i){var n,o,h;const c=[],_=(n=i?.maxDistance)!==null&&n!==void 0?n:1/0,p=i?.collisionGroup,v=p?p.category:(o=i?.collisionMask)!==null&&o!==void 0?o:ks.All.category,x=(h=i?.searchAllColliders)!==null&&h!==void 0?h:!1;return this._dynamicCollisionTree.rayCastQuery(t,_,b=>{const P=b.owner.get(Et);if(i?.ignoreCollisionGroupAll&&P.group===ks.All)return!1;const I=(v&P.group.category)!==0;if(P?.group&&!I)return!1;const F=b.rayCast(t,_);if(F){if(i?.filter){if(i.filter(F)&&(c.push(F),!x))return!0}else if(c.push(F),!x)return!0}return!1}),c}track(t){if(!t){dt.getInstance().warn("Cannot track null collider");return}if(t instanceof Ie){const i=t.getColliders();for(const n of i)n.owner=t.owner,this._colliders.push(n),this._dynamicCollisionTree.trackCollider(n)}else this._colliders.push(t),this._dynamicCollisionTree.trackCollider(t)}untrack(t){if(!t){dt.getInstance().warn("Cannot untrack a null collider");return}if(t instanceof Ie){const i=t.getColliders();for(const n of i){const o=this._colliders.indexOf(n);o!==-1&&this._colliders.splice(o,1),this._dynamicCollisionTree.untrackCollider(n)}}else{const i=this._colliders.indexOf(t);i!==-1&&this._colliders.splice(i,1),this._dynamicCollisionTree.untrackCollider(t)}}_pairExists(t,i){const n=ei.calculatePairHash(t.id,i.id);return this._pairs.has(n)}broadphase(t,i,n){const o=i/1e3,h=t.filter(_=>{var p,v;const x=(p=_.owner)===null||p===void 0?void 0:p.get(Et);return((v=_.owner)===null||v===void 0?void 0:v.isActive)&&x.collisionType!==_t.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let c;for(let _=0,p=h.length;_<p;_++)c=h[_],this._dynamicCollisionTree.query(c,v=>{if(!this._pairExists(c,v)&&ei.canCollide(c,v)){const x=new ei(c,v);this._pairs.add(x.id),this._collisionPairCache.push(x)}return!1});if(n&&(n.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const _ of h){const p=_.owner.get(Et);if(p.collisionType!==_t.Active)continue;const v=p.vel.magnitude*o+p.acc.magnitude*.5*o*o,x=Math.min(_.bounds.height,_.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||v>x/2){n&&n.physics.fastBodies++;const b=p.globalPos.sub(p.oldPos),S=_.center,P=_.getFurthestPoint(p.vel),I=P.sub(b),F=new Tn(I,p.vel);F.pos=F.pos.add(F.dir.scale(-2*this._config.continuous.surfaceEpsilon));let R,T=new k(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(F,v+this._config.continuous.surfaceEpsilon*2,M=>{if(!this._pairExists(_,M)&&ei.canCollide(_,M)){const W=M.rayCast(F,v+this._config.continuous.surfaceEpsilon*10);if(W){const U=W.point.sub(I);U.magnitude<T.magnitude&&(T=U,R=M)}}return!1}),R&&k.isValid(T)){const M=new ei(_,R);this._pairs.has(M.id)||(this._pairs.add(M.id),this._collisionPairCache.push(M));const W=S.sub(P);p.globalPos=I.add(W).add(T).add(F.dir.scale(10*this._config.continuous.surfaceEpsilon)),_.update(p.transform.get()),n&&n.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(t,i){let n=[];for(let o=0;o<t.length;o++){const h=t[o].collide();if(n=n.concat(h),i&&h.length>0)for(const c of h)i.physics.contacts.set(c.id,c)}return i&&(i.physics.collisions+=n.length),n}update(t){let i=0;const n=t.length;for(let o=0;o<n;o++)this._dynamicCollisionTree.updateCollider(t[o])&&i++;return i}debug(t){this._dynamicCollisionTree.debug(t)}}class sn{constructor(){this.id=Fn("collider",sn._ID++),this.composite=null,this.events=new $t,this.offset=k.Zero}touching(t){return!!this.collide(t)}}sn._ID=0;var Kr;(function(d){d.Arcade="arcade",d.Realistic="realistic"})(Kr||(Kr={}));var Ls;(function(d){d.None="none",d.VerticalFirst="vertical-first",d.HorizontalFirst="horizontal-first"})(Ls||(Ls={}));const Mc={vertical:1,horizontal:2},Bc={horizontal:1,vertical:2},kc={horizontal:0,vertical:0};var nr;(function(d){d.DynamicTree="dynamic-tree",d.SparseHashGrid="sparse-hash-grid"})(nr||(nr={}));const Ms=()=>({enabled:!0,gravity:N(0,0).clone(),solver:Kr.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:nr.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:Ls.None},realistic:{contactSolveBias:Ls.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class Ie extends sn{set compositeStrategy(t){this._compositeStrategy=t}get compositeStrategy(){return this._compositeStrategy}constructor(t){super(),this._collisionProcessor=new ya({...Ms()}),this._dynamicAABBTree=new Fc({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const i of t)this.addCollider(i)}clearColliders(){this._colliders=[]}addCollider(t){let i;t instanceof Ie?(i=t.getColliders(),i.forEach(n=>n.offset.addEqual(t.offset))):i=[t];for(const n of i)n.events.pipe(this.events),n.composite=this,this._colliders.push(n),this._collisionProcessor.track(n),this._dynamicAABBTree.trackCollider(n)}removeCollider(t){t.events.pipe(this.events),t.composite=null,cr(t,this._colliders),this._collisionProcessor.untrack(t),this._dynamicAABBTree.untrackCollider(t)}getColliders(){return this._colliders}get worldPos(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:k.Zero).add(this.offset)}get center(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:k.Zero).add(this.offset)}get bounds(){var t,i;const n=this.getColliders();return n.reduce((h,c)=>h.combine(c.bounds),(i=(t=n[0])===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new ct().translate(this.worldPos)).translate(this.offset)}get localBounds(){var t,i;const n=this.getColliders();return n.reduce((h,c)=>h.combine(c.localBounds),(i=(t=n[0])===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new ct)}get axes(){const t=this.getColliders();let i=[];for(const n of t)i=i.concat(n.axes);return i}getFurthestPoint(t){const i=this.getColliders(),n=[];for(const c of i)n.push(c.getFurthestPoint(t));let o=n[0],h=-Number.MAX_VALUE;for(const c of n){const _=c.dot(t);_>h&&(o=c,h=_)}return o}getInertia(t){const i=this.getColliders();let n=0;for(const o of i)n+=o.getInertia(t);return n}collide(t){let i=[t];t instanceof Ie&&(i=t.getColliders());const n=[];for(const h of i)this._dynamicAABBTree.query(h,c=>(n.push(new ei(h,c)),!1));let o=[];for(const h of n)o=o.concat(h.collide());return o}getClosestLineBetween(t){const i=this.getColliders(),n=[];if(t instanceof Ie){const o=t.getColliders();for(const h of i)for(const c of o){const _=h.getClosestLineBetween(c);_&&n.push(_)}}else for(const o of i){const h=t.getClosestLineBetween(o);h&&n.push(h)}if(n.length){let o=n[0].getLength(),h=n[0];for(const c of n){const _=c.getLength();_<o&&(o=_,h=c)}return h}return null}contains(t){const i=this.getColliders();for(const n of i)if(n.contains(t))return!0;return!1}rayCast(t,i){const n=this.getColliders(),o=[];for(const h of n){const c=h.rayCast(t,i);c&&o.push(c)}if(o.length){let h=o[0],c=h.point.dot(t.dir);for(const _ of o){const p=t.dir.dot(_.point);p<c&&(h=_,c=p)}return h}return null}project(t){const i=this.getColliders(),n=[];for(const o of i){const h=o.project(t);h&&n.push(h)}if(n.length){const o=new uo(n[0].min,n[0].max);for(const h of n)o.min=Math.min(h.min,o.min),o.max=Math.max(h.max,o.max);return o}return null}update(t){if(t){const i=this.getColliders();for(const n of i)n.owner=this.owner,n.update(t)}}debug(t,i,n){const o=this.getColliders();t.save(),t.translate(this.offset.x,this.offset.y);for(const h of o)h.debug(t,i,n);t.restore()}clone(){const t=new Ie(this._colliders.map(i=>i.clone()));return t.offset=this.offset.clone(),t}}class ue{constructor(t,i){this.begin=t,this.end=i}clone(t){const i=t||new ue(this.begin.clone(),this.end.clone());return i.begin=this.begin.clone(i.begin),i.end=this.end.clone(i.end),i}transform(t,i){const n=i||new ue(k.Zero,k.Zero);return n.begin=t.multiply(this.begin,n.begin),n.end=t.multiply(this.end,n.end),n}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const t=this.begin,i=this.end,n=t.distance(i);return this._slope=i.sub(t).scale(1/n)}getEdge(){const t=this.begin;return this.end.sub(t)}getLength(){const t=this.begin,i=this.end;return t.distance(i)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new ue(this.end,this.begin)}below(t){return(this.end.x-this.begin.x)*(t.y-this.begin.y)-(this.end.y-this.begin.y)*(t.x-this.begin.x)>=0}clip(t,i,n=!0){let o=t;n&&(o=o.normalize());const h=o.dot(this.begin)-i,c=o.dot(this.end)-i,_=[];if(h<=0&&_.push(this.begin),c<=0&&_.push(this.end),h*c<0){const p=h/(h-c);_.push(this.begin.add(this.end.sub(this.begin).scale(p)))}return _.length!==2?null:new ue(_[0],_[1])}distanceToPoint(t,i=!1){const n=t.x,o=t.y,h=this.getLength(),c=this.end.y-this.begin.y,_=this.end.x-this.begin.x,p=(c*n-_*o+this.end.x*this.begin.y-this.end.y*this.begin.x)/h;return i?p:Math.abs(p)}findVectorToPoint(t){const i=this.begin.sub(t),n=this.getSlope();return i.sub(n.scale(i.dot(n)))}findPoint(t=null,i=null){const n=this.slope,o=this.intercept;if(t!==null)return new k(t,n*t+o);if(i!==null)return new k((i-o)/n,i);throw new Error("You must provide an X or a Y value")}hasPoint(){let t,i=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")t=new k(arguments[0],arguments[1]),i=arguments[2]||0;else if(arguments[0]instanceof k)t=arguments[0],i=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const n=t.x-this.begin.x,o=t.y-this.begin.y,h=this.end.x-this.begin.x,c=this.end.y-this.begin.y,_=n*c-o*h;return Math.abs(_)>i?!1:Math.abs(h)>=Math.abs(c)?h>0?this.begin.x<=t.x&&t.x<=this.end.x:this.end.x<=t.x&&t.x<=this.begin.x:c>0?this.begin.y<=t.y&&t.y<=this.end.y:this.end.y<=t.y&&t.y<=this.begin.y}}function _l(d,t){const n=d.dir(),o=t.dir(),h=n.dot(n),c=o.dot(o);if(h<1e-9&&c<1e-9)return new ue(d.begin,t.begin);if(h<1e-9){const R=St(o.dot(d.begin.sub(t.begin))/c,0,1),T=t.begin.add(o.scale(R));return new ue(d.begin,T)}if(c<1e-9){const R=St(n.dot(t.begin.sub(d.begin))/h,0,1),T=d.begin.add(n.scale(R));return new ue(T,t.begin)}const _=d.begin.sub(t.begin),p=h,v=c,x=o.dot(_),b=p*v-Math.pow(n.dot(o),2);let S=0,P=0;Math.abs(b)>1e-9?S=St((n.dot(o)*x-v*n.dot(_))/b,0,1):S=St(n.dot(_)/p,0,1),Math.abs(v)>1e-9?P=St((n.dot(o)*S+x)/v,0,1):P=0;const I=d.begin.add(n.scale(S)),F=t.begin.add(o.scale(P));return new ue(I,F)}const ls={PolygonPolygonClosestLine(d,t){const i=d.getSides(),n=t.getSides();let o=Number.MAX_VALUE,h=null;for(let c=0;c<i.length;c++)for(let _=0;_<n.length;_++){const p=_l(i[c],n[_]),v=p.getLength();v<o&&(o=v,h=p)}return h},PolygonEdgeClosestLine(d,t){const n=t.worldPos.sub(d.worldPos),o=new Tn(d.worldPos,n),h=d.rayCast(o).point.add(o.dir.scale(.1)),c=d.getClosestFace(h),_=t.asLine();return _l(c.face,_)},PolygonCircleClosestLine(d,t){const i=t.worldPos,n=i.sub(d.worldPos),o=new Tn(d.worldPos,n.normalize()),h=d.rayCast(o).point.add(o.dir.scale(.1)),c=d.getClosestFace(h),_=c.face.begin,p=c.face.getEdge();let v=(p.x*(i.x-_.x)+p.y*(i.y-_.y))/(p.x*p.x+p.y*p.y);v>1?v=1:v<0&&(v=0);const x=Math.sqrt(Math.pow(_.x+p.x*v-i.x,2)+Math.pow(_.y+p.y*v-i.y,2))-t.radius,b=(_.x+p.x*v-i.x)*t.radius/(t.radius+x),S=(_.y+p.y*v-i.y)*t.radius/(t.radius+x);return new ue(p.scale(v).add(_),new k(i.x+b,i.y+S))},CircleCircleClosestLine(d,t){const n=t.worldPos.sub(d.worldPos),h=d.worldPos.sub(t.worldPos),c=new Tn(d.worldPos,n),_=new Tn(t.worldPos,h),p=d.rayCast(c),v=t.rayCast(_);return new ue(p.point,v.point)},CircleEdgeClosestLine(d,t){const i=d.worldPos,n=t.asLine(),o=n.begin,h=n.getEdge(),c=o,_=h;let p=(_.x*(i.x-c.x)+_.y*(i.y-c.y))/(_.x*_.x+_.y*_.y);p>1?p=1:p<0&&(p=0);const v=Math.sqrt(Math.pow(c.x+_.x*p-i.x,2)+Math.pow(c.y+_.y*p-i.y,2))-d.radius,x=(c.x+_.x*p-i.x)*d.radius/(d.radius+v),b=(c.y+_.y*p-i.y)*d.radius/(d.radius+v);return new ue(_.scale(p).add(c),new k(i.x+x,i.y+b))},EdgeEdgeClosestLine(d,t){const i=d.asLine(),n=t.asLine();return _l(i,n)}};class Ge extends sn{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var t;if(this._radius)return this._radius;const i=this._transform,n=(t=i?.globalScale)!==null&&t!==void 0?t:k.One;return this._radius=this._naturalRadius*Math.min(n.x,n.y)}set radius(t){var i;const n=this._transform,o=(i=n?.globalScale)!==null&&i!==void 0?i:k.One;this._naturalRadius=t/Math.min(o.x,o.y),this._localBoundsDirty=!0,this._radius=t}constructor(t){super(),this.offset=k.Zero,this._globalMatrix=ve.identity(),this._localBoundsDirty=!0,this.offset=t.offset||k.Zero,this.radius=t.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new Ge({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(t){var i,n;return((n=(i=this._transform)===null||i===void 0?void 0:i.pos)!==null&&n!==void 0?n:this.offset).distance(t)<=this.radius}rayCast(t,i=1/0){var n,o;const h=this.center,c=t.dir,_=t.pos,p=h.sub(_),v=c.scale(p.dot(c)),b=p.sub(v).magnitude;if(b>this.radius)return null;{let S=0;if(_f(b,this.radius,1e-4)){if(S=-c.dot(_.sub(h)),S>0&&S<i){const P=t.getPoint(S);return{point:P,normal:P.sub(h).normalize(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(Et),distance:S}}return null}else{const P=Math.sqrt(Math.pow(c.dot(_.sub(h)),2)-Math.pow(_.sub(h).distance(),2)+Math.pow(this.radius,2)),I=-c.dot(_.sub(h))+P,F=-c.dot(_.sub(h))-P,R=[];I>=0&&R.push(I),F>=0&&R.push(F);const T=Math.min(...R);if(T<=i){const M=t.getPoint(T);return{point:M,normal:M.sub(h).normalize(),collider:this,body:(o=this.owner)===null||o===void 0?void 0:o.get(Et),distance:T}}return null}}}getClosestLineBetween(t){if(t instanceof Ge)return ls.CircleCircleClosestLine(this,t);if(t instanceof ke)return ls.PolygonCircleClosestLine(t,this).flip();if(t instanceof pi)return ls.CircleEdgeClosestLine(this,t).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Ge)return Vi.CollideCircleCircle(this,t);if(t instanceof ke)return Vi.CollideCirclePolygon(this,t);if(t instanceof pi)return Vi.CollideCircleEdge(this,t);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){return this.center.add(t.normalize().scale(this.radius))}getFurthestLocalPoint(t){return t.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new ct(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(t){return t*this.radius*this.radius/2}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(t){const i=[],o=this.center.dot(t);return i.push(o),i.push(o+this.radius),i.push(o-this.radius),new uo(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i,n){var o,h,c,_;const{lineWidth:p}={lineWidth:1,...n},v=this._transform,x=(o=v?.globalScale)!==null&&o!==void 0?o:k.One,b=(h=v?.globalRotation)!==null&&h!==void 0?h:0,S=(c=v?.globalPos)!==null&&c!==void 0?c:k.Zero;t.save(),t.translate(S.x,S.y),t.rotate(b),t.scale(x.x,x.y),t.drawCircle((_=this.offset)!==null&&_!==void 0?_:k.Zero,this._naturalRadius,K.Transparent,i,p),t.restore()}}class xn{constructor(t,i,n,o,h,c,_,p){var v,x,b,S,P,I;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=t,this.colliderB=i,this.mtv=n,this.normal=o,this.tangent=h,this.points=c,this.localPoints=_,this.info=p,this.id=ei.calculatePairHash(t.id,i.id),t.composite||i.composite){const F=((v=t.composite)===null||v===void 0?void 0:v.compositeStrategy)==="separate"?t.id:(b=(x=t.composite)===null||x===void 0?void 0:x.id)!==null&&b!==void 0?b:t.id,R=((S=i.composite)===null||S===void 0?void 0:S.compositeStrategy)==="separate"?i.id:(I=(P=i.composite)===null||P===void 0?void 0:P.id)!==null&&I!==void 0?I:i.id;this.id+="|"+ei.calculatePairHash(F,R)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(Et)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(Et))}matchAwake(){const t=this.bodyA,i=this.bodyB;t&&i&&t.isSleeping!==i.isSleeping&&(t.isSleeping&&t.collisionType!==_t.Fixed&&i.sleepMotion>=t.wakeThreshold&&(t.isSleeping=!1),i.isSleeping&&i.collisionType!==_t.Fixed&&t.sleepMotion>=i.wakeThreshold&&(i.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(t){if(t!==this.colliderA&&t!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(t===this.colliderA)return this;const i=this.colliderA,n=this.colliderB;return this.colliderB=i,this.colliderA=n,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class Mf{constructor(){this.axis=N(0,0),this.localAxis=N(0,0),this.side=new ue(N(0,0),N(0,0)),this.localSide=new ue(N(0,0),N(0,0)),this.point=N(0,0),this.localPoint=N(0,0)}}class me{static findPolygonPolygonSeparation(t,i){if(i.transform.matrix.determinant()===0)return me.findPolygonPolygonSeparationDegenerate(t,i);let n=-Number.MAX_VALUE,o=-1,h;const c=i.transform.inverse.multiply(t.transform.matrix,me._SCRATCH_MATRIX),_=c.getRotation(),p=t.normals,v=t.points,x=i.points;for(let P=0;P<v.length;P++){const I=p[P].rotate(_,me._ZERO,me._SCRATCH_NORMAL),F=c.multiply(v[P],me._SCRATCH_POINT);let R=Number.MAX_VALUE,T;for(let M=0;M<x.length;M++){const W=I.dot(x[M].sub(F,me._SCRATCH_SUB_POINT));W<R&&(R=W,T=x[M])}R>n&&(n=R,o=P,h=T)}const b=(o+1)%v.length,S=me.SeparationPool.get();return S.collider=t,S.separation=n,n>0||(p[o].clone(S.localAxis),p[o].rotate(t.transform.rotation,me._ZERO,S.axis),t.transform.matrix.multiply(v[o],S.side.begin),t.transform.matrix.multiply(v[b],S.side.end),i.transform.matrix.multiply(h,S.point),S.sideId=o,h.clone(S.localPoint),v[o].clone(S.localSide.begin),v[b].clone(S.localSide.end)),S}static findCirclePolygonSeparation(t,i){const n=i.axes,h=i.center.sub(t.worldPos),c=i.getFurthestPoint(h.negate());n.push(c.sub(t.worldPos).normalize());let _=Number.MAX_VALUE,p=null,v=-1;for(let x=0;x<n.length;x++){const b=i.project(n[x]),S=t.project(n[x]),P=b.getOverlap(S);if(P<=0)return null;P<_&&(_=P,p=n[x],v=x)}return v<0?null:p.normalize().scale(_)}static findPolygonPolygonSeparationDegenerate(t,i){let n=-Number.MAX_VALUE,o=null,h=null,c=-1,_=null;const p=t.getSides(),v=t.getLocalSides();for(let x=0;x<p.length;x++){const b=p[x],S=b.normal(),P=i.getFurthestPoint(S.negate()),I=b.distanceToPoint(P,!0);I>n&&(n=I,o=b,h=S,c=x,_=P)}return{collider:t,separation:h?n:99,axis:h,side:o,localSide:v[c],sideId:c,point:_,localPoint:h?i.getFurthestLocalPoint(h.negate()):null}}}me.SeparationPool=new Ia(()=>new Mf,d=>d,500);me._ZERO=N(0,0);me._SCRATCH_POINT=N(0,0);me._SCRATCH_SUB_POINT=N(0,0);me._SCRATCH_NORMAL=N(0,0);me._SCRATCH_MATRIX=ve.identity();me.SeparationPool.disableWarnings=!0;const Lv=k.Zero,Uv=k.Zero,zv=ve.identity(),Vi={CollideCircleCircle(d,t){const i=d.worldPos,n=t.worldPos,o=d.radius+t.radius,h=i.distance(n);if(h>o)return[];const c=o-h,_=n.sub(i).normalize(),p=_.perpendicular(),v=_.scale(c),x=d.getFurthestPoint(_),b=d.getFurthestLocalPoint(_),S={collider:d,separation:c,axis:_,point:x};return[new xn(d,t,v,_,p,[x],[b],S)]},CollideCirclePolygon(d,t){var i,n;let o=me.findCirclePolygonSeparation(d,t);if(!o)return[];o=o.dot(t.center.sub(d.center))<0?o.negate():o;const c=d.getFurthestPoint(o),p=((n=(i=d.owner)===null||i===void 0?void 0:i.get(nt))!==null&&n!==void 0?n:new nt).applyInverse(c),v=o.normalize(),x={collider:d,separation:-o.magnitude,axis:v,point:c,localPoint:p,side:t.findSide(v.negate()),localSide:t.findLocalSide(v.negate())};return[new xn(d,t,o,v,v.perpendicular(),[c],[p],x)]},CollideCircleEdge(d,t){const i=d.center,n=t.asLine(),o=n.end.sub(n.begin),h=o.dot(n.end.sub(i)),c=o.dot(i.sub(n.begin)),_=t.asLine(),p=t.asLocalLine();if(c<=0){const T=n.begin.sub(i),M=T.dot(T);if(M>d.radius*d.radius)return[];const W=T.normalize(),U=d.radius-Math.sqrt(M),G={collider:d,separation:U,axis:W,point:_.begin,side:_,localSide:p};return[new xn(d,t,W.scale(U),W,W.perpendicular(),[_.begin],[p.begin],G)]}if(h<=0){const T=n.end.sub(i),M=T.dot(T);if(M>d.radius*d.radius)return[];const W=T.normalize(),U=d.radius-Math.sqrt(M),G={collider:d,separation:U,axis:W,point:_.end,side:_,localSide:p};return[new xn(d,t,W.scale(U),W,W.perpendicular(),[_.end],[p.end],G)]}const v=o.dot(o),x=n.begin.scale(h).add(n.end.scale(c)).scale(1/v),b=i.sub(x),S=b.dot(b);if(S>d.radius*d.radius)return[];let P=o.perpendicular();P.dot(i.sub(n.begin))<0&&(P.x=-P.x,P.y=-P.y),P=P.normalize();const I=d.radius-Math.sqrt(S),F=P.scale(I),R={collider:d,separation:I,axis:P,point:x,side:_,localSide:p};return[new xn(d,t,F,P.negate(),P.negate().perpendicular(),[x],[x.sub(t.worldPos)],R)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(d,t){var i;const n=d.center,h=t.center.sub(n).normalize(),c=new ke({points:[t.begin,t.end,t.end.add(h.scale(100)),t.begin.add(h.scale(100))],offset:t.offset});c.owner=t.owner,((i=t.owner)===null||i===void 0?void 0:i.get(nt))&&c.update(t.owner.get(nt).get());const p=this.CollidePolygonPolygon(d,c);return p.length&&(p[0].colliderB=t,p[0].id=ei.calculatePairHash(d.id,t.id)),p},CollidePolygonPolygon(d,t){const i=me.findPolygonPolygonSeparation(d,t);if(i.separation>0)return[];const n=me.findPolygonPolygonSeparation(t,d);if(n.separation>0)return[];const o=i.separation>n.separation?i:n,h=o.collider===d?t:d,c=o.collider===d?d:t,_=h.transform.inverse.multiply(c.transform.matrix,zv),p=_.getRotation(),v=c.normals[o.sideId].rotate(p,Lv,Uv);let x=Number.MAX_VALUE,b=0;for(let T=0;T<h.normals.length;T++){const M=v.dot(h.normals[T]);M<x&&(x=M,b=T)}if(!o.localSide||!o.localAxis||!o.axis)return[];const S=o.localSide.transform(_),P=o.localAxis.perpendicular().negate().rotate(p),F=new ue(h.points[b],h.points[(b+1)%h.points.length]).clip(P.negate(),-P.dot(S.begin),!1);let R=null;if(F&&(R=F.clip(P,P.dot(S.end),!1)),R){const T=[],M=[],W=R.getPoints();for(let j=0;j<W.length;j++){const X=W[j];S.below(X)&&(T.push(X),M.push(h.transform.apply(X)))}let U=o.axis,G=U.perpendicular();return t.center.sub(d.center).dot(U)<0&&(U=U.negate(),G=U.perpendicular()),[new xn(d,t,U.scale(-o.separation),U,G,M,T,o)]}return[]},FindContactSeparation(d,t){var i,n,o,h;const c=d.colliderA,_=(n=(i=d.bodyA)===null||i===void 0?void 0:i.transform)!==null&&n!==void 0?n:new nt,p=d.colliderB,v=(h=(o=d.bodyB)===null||o===void 0?void 0:o.transform)!==null&&h!==void 0?h:new nt;if(c instanceof Ge&&p instanceof Ge){const x=c.radius+p.radius,b=_.pos.distance(v.pos);return-(x-b)}if(c instanceof ke&&p instanceof ke&&d.info.localSide){let x,b;return d.info.collider===c?(x=new ue(_.apply(d.info.localSide.begin).add(c.offset),_.apply(d.info.localSide.end).add(c.offset)),b=v.apply(t).add(p.offset)):(x=new ue(v.apply(d.info.localSide.begin).add(p.offset),v.apply(d.info.localSide.end).add(p.offset)),b=_.apply(t).add(c.offset)),x.distanceToPoint(b,!0)}if(c instanceof ke&&p instanceof Ge||p instanceof ke&&c instanceof Ge){const x=_.apply(t);if(d.info.side)return d.info.side.distanceToPoint(x,!0)}if(c instanceof pi&&p instanceof ke||p instanceof pi&&c instanceof ke){let x;if(d.info.collider===c?x=v.apply(t):x=_.apply(t),d.info.side)return d.info.side.distanceToPoint(x,!0)}if(c instanceof Ge&&p instanceof pi||p instanceof Ge&&c instanceof pi){const x=v.apply(t);let b;c instanceof Ge&&(b=c.getFurthestPoint(d.normal));const S=x.distance(b);if(d.info.side)return S>0?-S:0}return 0}};class pi extends sn{constructor(t){var i;super(),this._globalMatrix=ve.identity(),this.begin=t.begin||k.Zero,this.end=t.end||k.Zero,this.offset=(i=t.offset)!==null&&i!==void 0?i:k.Zero}clone(){return new pi({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var t;const i=this._transform;return(t=i?.globalPos.add(this.offset))!==null&&t!==void 0?t:this.offset}get center(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.average(i)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const t=this._getTransformedBegin(),i=this._getTransformedEnd(),n=t.distance(i);return i.sub(t).scale(1/n)}getLength(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.distance(i)}contains(){return!1}rayCast(t,i=1/0){var n;const o=this._getTransformedBegin().sub(t.pos);if(t.dir.cross(this.getSlope())===0&&o.cross(t.dir)!==0)return null;const h=t.dir.cross(this.getSlope());if(h===0)return null;const c=o.cross(this.getSlope())/h;if(c>=0&&c<=i){const _=o.cross(t.dir)/h/this.getLength();if(_>=0&&_<=1)return{distance:c,normal:this.asLine().normal(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(Et),point:t.getPoint(c)}}return null}getClosestLineBetween(t){if(t instanceof Ge)return ls.CircleEdgeClosestLine(t,this);if(t instanceof ke)return ls.PolygonEdgeClosestLine(t,this).flip();if(t instanceof pi)return ls.EdgeEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Ge)return Vi.CollideCircleEdge(t,this);if(t instanceof ke)return Vi.CollidePolygonEdge(t,this);if(t instanceof pi)return Vi.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this._getTransformedBegin(),n=this._getTransformedEnd();return t.dot(i)>0?i:n}_boundsFromBeginEnd(t,i,n=10){return new ct(Math.min(t.x,i.x)-n,Math.min(t.y,i.y)-n,Math.max(t.x,i.x)+n,Math.max(t.y,i.y)+n)}get bounds(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return this._boundsFromBeginEnd(t,i)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new ue(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new ue(this.begin,this.end)}get axes(){const i=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),n=[];return n.push(i),n.push(i.negate()),n.push(i.normal()),n.push(i.normal().negate()),n}getInertia(t){const i=this.end.sub(this.begin).distance()/2;return t*i*i}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(t){const i=[],n=[this._getTransformedBegin(),this._getTransformedEnd()],o=n.length;for(let h=0;h<o;h++)i.push(n[h].dot(t));return new uo(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i){const n=this._getTransformedBegin(),o=this._getTransformedEnd();t.drawLine(n,o,i,2),t.drawCircle(n,2,i),t.drawCircle(o,2,i)}}class Ee{static registerGraphicsContext(t){Ee._ctx=t}static draw(t){this._drawCalls.push(t)}static drawPoint(t,i){Ee.draw(n=>{n.debug.drawPoint(t,i)})}static drawLine(t,i,n){Ee.draw(o=>{o.debug.drawLine(t,i,n)})}static drawLines(t,i){t.length>1&&Ee.draw(n=>{for(let o=0;o<t.length-1;o++)n.debug.drawLine(t[o],t[o+1],i)})}static drawText(t,i){Ee.draw(n=>{n.debug.drawText(t,i)})}static drawPolygon(t,i){t.length>1&&Ee.draw(n=>{const o=t[0],h=[...t,o];for(let c=0;c<h.length-1;c++)n.debug.drawLine(h[c],h[c+1],i)})}static drawCircle(t,i,n){const{color:o,strokeColor:h,width:c}={color:K.Black,strokeColor:void 0,width:void 0,...n};Ee.draw(_=>{_.drawCircle(t,i,o,h,c)})}static drawBounds(t,i){Ee.draw(n=>{n.debug.drawRect(t.left,t.top,t.width,t.height,i)})}static drawRay(t,i){const{distance:n,color:o}={color:K.Blue,distance:10,...i};Ee.draw(h=>{const c=t.pos,_=t.pos.add(t.dir.scale(n));h.debug.drawLine(c,_,{color:o})})}static flush(t){t.save(),t.z=Ee.z;for(const i of Ee._drawCalls)i(t);t.restore(),Ee.clear()}static clear(){Ee._drawCalls.length=0}}Ee._drawCalls=[];Ee.z=1/0;class ke extends sn{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(t){if(t.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=t,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const t=[];for(let i=0;i<this._points.length;i++)t.push(this._points[(i+1)%this._points.length].sub(this._points[i]).normal());this._normals=t}get points(){return this._points}get transform(){return this._transform}constructor(t){var i;super(),this._logger=dt.getInstance(),this._transform=new Bs,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(i=t.offset)!==null&&i!==void 0?i:k.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=t.points,this.isConvex()||t.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(t){this._isCounterClockwiseWinding(t)||t.reverse()}_isCounterClockwiseWinding(t){let i=0;for(let n=0;n<t.length;n++)i+=(t[(n+1)%t.length].x-t[n].x)*(t[(n+1)%t.length].y+t[n].y);return i<0}isConvex(){if(this.points.length<3)return!1;let t=this.points[this.points.length-2],i=this.points[this.points.length-1],n=Math.atan2(i.y-t.y,i.x-t.x),o=0,h=0,c=0;for(const[_,p]of this.points.entries()){if(t=i,o=n,i=p,n=Math.atan2(i.y-t.y,i.x-t.x),t.equals(i))return!1;let v=n-o;if(v<=-Math.PI?v+=Math.PI*2:v>Math.PI&&(v-=Math.PI*2),_===0){if(v===0)return!1;h=v>0?1:-1}else if(h*v<=0)return!1;c+=v}return Math.abs(Math.round(c/(Math.PI*2)))===1}tessellate(){const t=[];for(let i=1;i<this.points.length-2;i++)t.push([this.points[0],this.points[i+1],this.points[i+2]]);return t.push([this.points[0],this.points[1],this.points[2]]),new Ie(t.map(i=>Xe.Polygon(i)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const t=[],i=[...this.points].reverse();let n=i.length;function o(b){return b===0?n-1:b-1}function h(b){return b===n-1?0:b+1}function c(b){const S=o(b),P=h(b),I=i[S],F=i[b],R=i[P],T=I.sub(F),M=R.sub(F);return!(T.cross(M)<0)}const _=i.map((b,S)=>c(S));function p(b,S,P,I){const F=P.sub(S),R=I.sub(P),T=S.sub(I),M=b.sub(S),W=b.sub(P),U=b.sub(I),G=F.cross(M),j=R.cross(W),X=T.cross(U);return!(G>0||j>0||X>0)}function v(){for(let b=0;b<n;b++)if(_[b]){const S=o(b),P=h(b),I=i[S],F=i[b],R=i[P];let T=!0;for(let M=0;M<n;M++){if(M===b||M===S||M===P)continue;const W=i[M];if(p(W,I,F,R)){T=!1;break}}if(T)return b}for(let b=0;b<n;b++)if(_[b])return b;return 0}function x(b){const S=o(b),P=h(b),I=i[S],F=i[b],R=i[P];t.push([I,F,R]),i.splice(b,1),_.splice(b,1),n--}for(;n>3;){const b=v();x(b);for(let S=0;S<n;S++)_[S]=c(S)}return t.push([i[0],i[1],i[2]]),new Ie(t.map(b=>Xe.Polygon(b,k.Zero,!0)))}clone(){return new ke({offset:this.offset.clone(),points:this.points.map(t=>t.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const t=this.points,i=t.length;this._transformedPoints.length=0;for(let n=0;n<i;n++)this._transformedPoints[n]=this._transform.apply(t[n].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const t=[],i=this.getTransformedPoints(),n=i.length;for(let o=0;o<n;o++)t.push(new ue(i[o],i[(o+1)%n]));this._sides=t,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const t=[],i=this.points,n=i.length;for(let o=0;o<n;o++)t.push(new ue(i[o],i[(o+1)%n]));this._localSides=t,this._localSidesDirty=!1}return this._localSides}findSide(t){const i=this.getSides();let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=i[h],p=c.normal().dot(t);p>o&&(n=c,o=p)}return n}findLocalSide(t){const i=this.getLocalSides();let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=i[h],p=c.normal().dot(t);p>o&&(n=c,o=p)}return n}get axes(){const t=[],i=this.getSides();for(let n=0;n<i.length;n++)t.push(i[n].normal());return t}update(t){t&&(t.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(i=>N(i.x*qt(this._transform.scale.x),i.y*qt(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(t){const i=this._transform.applyInverse(t),n=new Tn(i,new k(1,0));let o=0;const h=this.getLocalSides();for(let c=0;c<h.length;c++){const _=h[c];n.intersect(_)>=0&&o++}return o%2!==0}getClosestLineBetween(t){if(t instanceof Ge)return ls.PolygonCircleClosestLine(this,t);if(t instanceof ke)return ls.PolygonPolygonClosestLine(this,t);if(t instanceof pi)return ls.PolygonEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Ge)return Vi.CollideCirclePolygon(t,this);if(t instanceof ke)return Vi.CollidePolygonPolygon(this,t);if(t instanceof pi)return Vi.CollidePolygonEdge(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this.getTransformedPoints();let n=null,o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=t.dot(i[h]);c>o&&(o=c,n=i[h])}return n}getFurthestLocalPoint(t){const i=this.points;let n=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const c=t.dot(i[h]);c>o&&(o=c,n=i[h])}return n}getClosestFace(t){const i=this.getSides();let n=Number.POSITIVE_INFINITY,o=-1,h=-1;for(let c=0;c<i.length;c++){const _=i[c].distanceToPoint(t);_<n&&(n=_,o=c,h=_)}return o!==-1?{distance:i[o].normal().scale(h),face:i[o]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=ct.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(t){if(this._cachedMass===t&&this._cachedInertia)return this._cachedInertia;let i=0,n=0;const o=this.points;for(let h=0;h<o.length;h++){const c=(h+1)%o.length,_=o[c].cross(o[h]);i+=_*(o[h].dot(o[h])+o[h].dot(o[c])+o[c].dot(o[c])),n+=_}return this._cachedMass=t,this._cachedInertia=t/6*(i/n)}rayCast(t,i=1/0){var n;const o=this.getSides(),h=o.length;let c=Number.MAX_VALUE,_,p=-1;for(let v=0;v<h;v++){const x=t.intersect(o[v]);x>=0&&x<c&&x<=i&&(c=x,_=o[v],p=v)}return p>=0?{collider:this,distance:c,body:(n=this.owner)===null||n===void 0?void 0:n.get(Et),point:t.getPoint(c),normal:_.normal()}:null}project(t){const i=this.getTransformedPoints(),n=i.length;let o=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let c=0;c<n;c++){const _=i[c].dot(t);o=Math.min(o,_),h=Math.max(h,_)}return new uo(o,h)}debug(t,i,n){const o=this.getTransformedPoints();Ee.drawPolygon(o,{color:i})}}class Xe{static Box(t,i,n=k.Half,o=k.Zero){return new ke({points:new ct(-t*n.x,-i*n.y,t-t*n.x,i-i*n.y).getPoints(),offset:o})}static Polygon(t,i=k.Zero,n=!1){return new ke({points:t,offset:i,suppressConvexWarning:n})}static Circle(t,i=k.Zero){return new Ge({radius:t,offset:i})}static Edge(t,i){return new pi({begin:t,end:i})}static Capsule(t,i,n=k.Zero){const o=dt.getInstance();return t===i&&o.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),i>=t?new Ie([Xe.Circle(t/2,N(0,-i/2+t/2).add(n)),Xe.Box(t,i-t,k.Half,n),Xe.Circle(t/2,N(0,i/2-t/2).add(n))]):new Ie([Xe.Circle(i/2,N(-t/2+i/2,0).add(n)),Xe.Box(t-i,i,k.Half,n),Xe.Circle(i/2,N(t/2-i/2,0).add(n))])}}class we extends Ei{constructor(t){super(),this.events=new $t,this.$colliderAdded=new ti,this.$colliderRemoved=new ti,this._collidersToRemove=[],this.set(t)}get(){return this._collider}set(t){return this.clear(),t&&(this._collider=t,this._collider.owner=this.owner,t.events.pipe(this.events),this.$colliderAdded.notifyAll(t),this.update()),t}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const t of this._collidersToRemove)t.events.unpipe(this.events),this.$colliderRemoved.notifyAll(t),t.owner=null}clone(){return new we(this._collider.clone())}get bounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new ct}get localBounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new ct}update(){var t;const i=(t=this.owner)===null||t===void 0?void 0:t.get(nt);this._collider&&(this._collider.owner=this.owner,i&&this._collider.update(i.get()))}collide(t){let i=this._collider,n=t._collider;if(!i||!n)return[];let o=!1;if(n instanceof Ie&&(i=n,n=this._collider,o=!0),this._collider){const h=i.collide(n);return h?(o&&h.forEach(c=>{c.mtv=c.mtv.negate(),c.normal=c.normal.negate(),c.tangent=c.normal.perpendicular(),c.colliderA=this._collider,c.colliderB=t._collider}),h):[]}return[]}onAdd(t){this._collider&&this.update(),this.events.on("precollision",i=>{const n=i;t.events.emit("precollision",new kn(n.self,n.other,n.side,n.intersection,n.contact)),t instanceof ii&&t.onPreCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("postcollision",i=>{const n=i;t.events.emit("postcollision",new Ln(n.self,n.other,n.side,n.intersection,n.contact)),t instanceof ii&&t.onPostCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("collisionstart",i=>{const n=i;t.events.emit("collisionstart",new jr(n.self,n.other,n.side,n.contact)),t instanceof ii&&t.onCollisionStart(n.self,n.other,n.side,n.contact)}),this.events.on("collisionend",i=>{const n=i;t.events.emit("collisionend",new Zr(n.self,n.other,n.side,n.lastContact)),t instanceof ii&&t.onCollisionEnd(n.self,n.other,n.side,n.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(t,i,n=k.Half,o=k.Zero){const h=Xe.Box(t,i,n,o);return this.set(h)}usePolygonCollider(t,i=k.Zero){const n=Xe.Polygon(t,i);return this.set(n)}useCircleCollider(t,i=k.Zero){const n=Xe.Circle(t,i);return this.set(n)}useEdgeCollider(t,i){const n=Xe.Edge(t,i);return this.set(n)}useCompositeCollider(t){return this.set(new Ie(t))}}var hi;(function(d){d.Rotation="rotation",d.X="x",d.Y="y"})(hi||(hi={}));class Et extends Ei{constructor(t){var i,n,o;super(),this.dependencies=[nt,Lt],this.id=Fn("body",Et._ID++),this.events=new $t,this.oldTransform=new Bs,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=_t.PreventCollision,this.group=ks.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=k.Zero,this.oldVel=new k(0,0),this.oldAcc=k.Zero,this._impulseScratch=N(0,0),this._distanceFromCenterScratch=N(0,0),t?(this.collisionType=(i=t.type)!==null&&i!==void 0?i:this.collisionType,this.group=(n=t.group)!==null&&n!==void 0?n:this.group,this.useGravity=(o=t.useGravity)!==null&&o!==void 0?o:this.useGravity,this._bodyConfig={...Ms().bodies,...t.config}):this._bodyConfig={...Ms().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=Et._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(t){this._bodyConfig={...Ms().bodies,...t},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(t){Et._DEFAULT_CONFIG=t}get mass(){return this._mass}set mass(t){this._mass=t,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===_t.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(t){this.isSleeping=t}set isSleeping(t){this._sleeping=t,t?(this.vel=k.Zero,this.acc=k.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const t=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),i=this._bodyConfig.sleepBias;this.sleepMotion=i*this.sleepMotion+(1-i)*t,this.sleepMotion=St(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const t=this.owner.get(we);if(t){t.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),t.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const i=t.get();if(i)return this._cachedInertia=i.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===_t.Fixed?0:1/this.inertia}get active(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get isActive(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get center(){return this.globalPos}onAdd(t){var i,n;this.transform=(i=this.owner)===null||i===void 0?void 0:i.get(nt),this.motion=(n=this.owner)===null||n===void 0?void 0:n.get(Lt)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get globalPos(){return this.transform.globalPos}set globalPos(t){this.transform.globalPos=t}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t}get torque(){return this.motion.torque}set torque(t){this.motion.torque=t}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(t){this.transform.globalRotation=t}get scale(){return this.transform.globalScale}set scale(t){this.transform.globalScale=t}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(t){this.motion.scaleFactor=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}applyImpulse(t,i){if(this.collisionType!==_t.Active)return;const n=i.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(hi.X)>-1&&(n.x=0),this.limitDegreeOfFreedom.indexOf(hi.Y)>-1&&(n.y=0),this.vel.addEqual(n),!this.limitDegreeOfFreedom.includes(hi.Rotation)){const o=t.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*o.cross(i)}}applyLinearImpulse(t){if(this.collisionType!==_t.Active)return;const i=t.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(hi.X)&&(i.x=0),this.limitDegreeOfFreedom.includes(hi.Y)&&(i.y=0),this.vel=this.vel.add(i)}applyAngularImpulse(t,i){if(this.collisionType===_t.Active&&!this.limitDegreeOfFreedom.includes(hi.Rotation)){const n=t.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*n.cross(i)}}captureOldTransform(){this.__oldTransformCaptured=!0;const t=this.transform.get();t.clone(this.oldTransform),this.oldTransform.parent=t.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}Et._ID=0;Et._DEFAULT_CONFIG={...Ms().bodies};class fo extends ur{constructor(t){super(t),this.width=t.width,this.height=t.height,this.rasterize()}clone(){return new fo({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.color&&t.fillRect(0,0,this.width,this.height),this.strokeColor&&t.strokeRect(0,0,this.width,this.height)}}class Ba extends ur{get radius(){return this._radius}set radius(t){this._radius=t,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(t){var i,n,o;super(t),this._radius=0;const h=(i=t.lineWidth)!==null&&i!==void 0?i:t.strokeColor?1:0;this.padding=(n=t.padding)!==null&&n!==void 0?n:2+h/2,this.radius=t.radius,this.filtering=(o=t.filtering)!==null&&o!==void 0?o:xe.Blended,this.rasterize()}clone(){return new Ba({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.radius>0&&(t.beginPath(),t.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&t.fill(),this.strokeColor&&t.stroke())}}class $s extends Ei{constructor(t){var i,n;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(i=t?.useColliderShape)!==null&&i!==void 0?i:this.useColliderShape,this.useGraphicsBounds=(n=t?.useGraphicsBounds)!==null&&n!==void 0?n:this.useGraphicsBounds,this.localBounds=t?.localBounds}}class Xt{static CreateReversibleEasingFunction(t){return(i,n,o,h)=>o<n?n-(t(i,o,n,h)-o):t(i,n,o,h)}static CreateVectorEasingFunction(t){return(i,n,o,h)=>new k(t(i,n.x,o.x,h),t(i,n.y,o.y,h))}}Xt.Linear=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,i*d/n+t));Xt.EaseInQuad=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,i*d*d+t));Xt.EaseOutQuad=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,-i*d*(d-2)+t));Xt.EaseInOutQuad=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n/2,d<1?i/2*d*d+t:(d--,-i/2*(d*(d-2)-1)+t)));Xt.EaseInCubic=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,i*d*d*d+t));Xt.EaseOutCubic=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n,d--,i*(d*d*d+1)+t));Xt.EaseInOutCubic=Xt.CreateReversibleEasingFunction((d,t,i,n)=>(i=i-t,d/=n/2,d<1?i/2*d*d*d+t:(d-=2,i/2*(d*d*d+2)+t)));class Bf{constructor(t){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=t}add(t){this._actions.push(t)}remove(t){const i=this._actions.indexOf(t);this._actions.splice(i,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const t=this._actions.length;for(let i=0;i<t;i++)this._actions[i].reset();this._completedActions=[]}update(t){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new Pc(this._currentAction,this._entity))),this._currentAction.update(t),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new Tc(this._currentAction,this._entity));const i=this._actions.shift();i&&this._completedActions.push(i)}}}let Hv=0;function Vt(){return Hv++}class kf{constructor(t,i,n){this.id=Vt(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new po(t),this._actionQueue=this._repeatContext.getQueue(),this._repeat=n,this._originalRepeat=n,this._repeatBuilder(this._repeatContext),this._repeat--}update(t){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(t)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class Lf{constructor(t,i){this.id=Vt(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new po(t),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(t){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(t))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function Uf(d,t,i){return(1-i)*d+t*i}function Lc(d,t,i,n){const o=(d-t+Ae)%Ae>=Math.PI,h=Math.abs(t-d),c=Ae-h;let _=0,p=0;h>c?(_=c,p=h):(_=h,p=c);let v=0,x=1;switch(i){case oe.ShortestPath:v=_,x=o?1:-1;break;case oe.LongestPath:v=p,x=o?-1:1;break;case oe.Clockwise:x=1,v=o?_:p;break;case oe.CounterClockwise:x=-1,v=o?p:_;break}return d+x*(v*n)}function _o(d,t,i){return d.scale(1-i).add(t.scale(i))}function zf(d,t,i){return(i-d)/(t-d)}function Hf(d,t,i){const n=i.sub(d),o=t.sub(d),h=n.x/o.x,c=n.y/o.y;return Math.min(h,c)}function fs(d,t,i,n,o){const h=zf(d,t,o);return Uf(i,n,h)}function Ov(d,t,i,n,o){const h=Hf(d,t,o);return _o(i,n,h)}function Of(d){return d.offset instanceof k&&typeof d.duration=="number"}class Wf{constructor(t,i){var n;if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._easing=Xt.Linear,this._offset=i.offset,this._easing=(n=i.easing)!==null&&n!==void 0?n:this._easing,this._tx=t.get(nt),this._motion=t.get(Lt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=t;const i=St(fs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),c=(o-n.x)/(t/1e3),_=(h-n.y)/(t/1e3);this._motion.vel.x=c,this._motion.vel.y=_,this.isComplete(this.entity)&&(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=N(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Ml{constructor(t,i,n,o){if(this.id=Vt(),this._started=!1,this._stopped=!1,this._entity=t,this._tx=t.get(nt),this._motion=t.get(Lt),this._speed=o,this._offset=new k(i,n),o<=0)throw dt.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+o),new Error("Speed must be greater than 0 pixels per second")}update(t){this._started||(this._started=!0,this._start=new k(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(t){const i=t.get(nt);return this._stopped||i.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=N(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Vf(d){return d.pos instanceof k&&typeof d.duration=="number"}class Nf{constructor(t,i){var n;if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._easing=Xt.Linear,this._end=i.pos,this._easing=(n=i.easing)!==null&&n!==void 0?n:this._easing,this._tx=t.get(nt),this._motion=t.get(Lt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=t;const i=St(fs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),c=(o-n.x)/(t/1e3),_=(h-n.y)/(t/1e3);this._motion.vel.x=c,this._motion.vel.y=_,this.isComplete(this.entity)&&(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=N(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Bl{constructor(t,i,n,o){this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(Lt),this._end=new k(i,n),this._speed=o}update(t){this._started||(this._started=!0,this._start=new k(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const i=this._dir.scale(this._speed);this._motion.vel=N(i.x,i.y),this.isComplete(this.entity)&&(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0))}isComplete(t){const i=t.get(nt);return this._stopped||new k(i.pos.x,i.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=N(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Wv(d){return typeof d.angle=="number"&&typeof d.duration=="number"}class Gf{constructor(t,i){var n;if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=i.angle,this._tx=t.get(nt),this._motion=t.get(Lt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(n=i.rotationType)!==null&&n!==void 0?n:oe.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=t;const i=St(fs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Lc(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(n-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Xf{constructor(t,i,n,o){this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(Lt),this._end=i,this._speed=n,this._rotationType=o||oe.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const i=Math.abs(this._end-this._start),n=Ae-i;switch(i>n?(this._shortDistance=n,this._longDistance=i):(this._shortDistance=i,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+Ae)%Ae>=Math.PI,this._rotationType){case oe.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case oe.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case oe.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case oe.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Vv(d){return typeof d.angleRadiansOffset=="number"&&typeof d.duration=="number"}class qf{constructor(t,i){var n;if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=i.angleRadiansOffset,this._tx=t.get(nt),this._motion=t.get(Lt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(n=i.rotationType)!==null&&n!==void 0?n:oe.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._endAngle=Ds(this._startAngle+this._offset),this._started=!0),this._currentMs-=t;const i=St(fs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Lc(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(n-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Yf{constructor(t,i,n,o){this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(Lt),this._speed=n,this._offset=i,this._rotationType=o||oe.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const i=Math.abs(this._end-this._start),n=Ae-i;switch(i>n?(this._shortDistance=n,this._longDistance=i):(this._shortDistance=i,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+Ae)%Ae>=Math.PI,this._rotationType){case oe.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case oe.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case oe.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case oe.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function jf(d){return typeof d.scale=="object"&&typeof d.duration=="number"}class Zf{constructor(t,i){if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._endScale=N(1,1),this._startScale=N(1,1),this._endScale=i.scale,this._tx=t.get(nt),this._motion=t.get(Lt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=t;const i=St(fs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=_o(this._startScale,this._endScale,i),o=this._tx.scale,h=n.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=k.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Qf{constructor(t,i,n,o,h){this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(Lt),this._endX=i,this._endY=n,this._speedX=o,this._speedY=h}update(t){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*i}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*i}this.isComplete()&&(this._tx.scale=N(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Jf(d){return typeof d.scaleOffset=="object"&&typeof d.duration=="number"}class Kf{constructor(t,i){if(this.entity=t,this.id=Vt(),this._started=!1,this._stopped=!1,this._endScale=N(1,1),this._scaleOffset=N(0,0),this._startScale=N(1,1),this._scaleOffset=i.scaleOffset,this._tx=t.get(nt),this._motion=t.get(Lt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=t;const i=St(fs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=_o(this._startScale,this._endScale,i),o=this._tx.scale,h=n.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=k.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class $f{constructor(t,i,n,o){this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(Lt),this._offset=new k(i,n),this._speedX=this._speedY=o}update(t){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Ku{constructor(t){this.id=Vt(),this._hasBeenCalled=!1,this._method=t}update(t){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class t_{constructor(t,i,n,o,h){this.easingFcn=h,this.id=Vt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new k(0,0),this._lerpEnd=new k(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(Lt),this._lerpDuration=o,this._lerpEnd=new k(i,n)}_initialize(){this._lerpStart=new k(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=N((i-this._tx.pos.x)/(t/1e3),(n-this._tx.pos.y)/(t/1e3))):(this._tx.pos=N(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=k.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=N(0,0),this._stopped=!0}}class e_{constructor(t,i,n,o,h){this.easingFcn=h,this.id=Vt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new k(0,0),this._lerpEnd=new k(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(Lt),this._lerpDuration=o,this._offset=new k(i,n)}_initialize(){this._lerpStart=new k(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=N((i-this._tx.pos.x)/(t/1e3),(n-this._tx.pos.y)/(t/1e3))):(this._tx.pos=N(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=k.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=N(0,0),this._stopped=!0}}class i_{constructor(t,i,n,o=1){this.id=Vt(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=t.get(he),this._timeVisible=i,this._timeNotVisible=n,this._duration=(i+n)*o}update(t){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=t,this._totalTime+=t,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class s_{constructor(t,i,n){this.id=Vt(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=t.get(he),this._endOpacity=i,this._remainingTime=this._originalTime=n}update(t){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*t)/this._remainingTime),this._remainingTime-=t,this.isComplete()&&(this._graphics.opacity=this._endOpacity),dt.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class n_{constructor(t){this.id=Vt(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=t}update(t){this._started||(this._started=!0),this._elapsedTime+=t}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class r_{constructor(t){this.id=Vt(),this._stopped=!1,this._entity=t}update(t){this._entity.get(er).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class kl{constructor(t,i,n){this.id=Vt(),this._started=!1,this._stopped=!1,this._tx=t.get(nt),this._motion=t.get(Lt),this._followTx=i.get(nt),this._followMotion=i.get(Lt),this._current=new k(this._tx.pos.x,this._tx.pos.y),this._end=new k(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=n!==void 0?n:this._current.distance(this._end),this._speed=0}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(i!==0&&(this._speed=i),this._current=N(this._tx.pos.x,this._tx.pos.y),this._end=N(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const n=this._dir.scale(this._speed);this._motion.vel=N(n.x,n.y)}else this._motion.vel=N(0,0);this.isComplete()&&(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0))}stop(){this._motion.vel=N(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class Ll{constructor(t,i,n){this.id=Vt(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=t.get(nt),this._motion=t.get(Lt),this._meetTx=i.get(nt),this._meetMotion=i.get(Lt),this._current=new k(this._tx.pos.x,this._tx.pos.y),this._end=new k(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=n||0,n!==void 0&&(this._speedWasSpecified=!0)}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));i!==0&&!this._speedWasSpecified&&(this._speed=i),this._current=N(this._tx.pos.x,this._tx.pos.y),this._end=N(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const n=this._dir.scale(this._speed);this._motion.vel=N(n.x,n.y),this.isComplete()&&(this._tx.pos=N(this._end.x,this._end.y),this._motion.vel=N(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=N(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class o_{constructor(t,i,n=1e3){var o;this.id=Vt(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=t.get(he),this._duration=n,this._entity=t,this._material=(o=t.scene)===null||o===void 0?void 0:o.engine.graphicsContext.createMaterial({name:"flash-material",color:i,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=n}update(t){var i;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=t,this._graphics&&((i=this._material)===null||i===void 0||i.update(n=>{n.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class go{constructor(t){var i;if(this._distLookup=[],this.quality=4,t.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...t.controlPoints],this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(t){this._controlPoints=[...t],this._calculateLookup()}setControlPoint(t,i){this._controlPoints[t]=i,this._calculateLookup()}_calculateLookup(){let t=0;this._distLookup.length=0;let i=this.controlPoints[0];const n=this.controlPoints.length*this.quality;for(let o=0;o<n;o++){const h=o/(n-1),c=this.getPoint(h),_=i.distance(c);t+=_,this._distLookup.push(t),i=c}this._arcLength=t}_getTimeGivenDistance(t){const i=this._distLookup.length,n=this.arcLength;if(t>=0&&t<n){for(let o=0;o<i-1;o++)if(this._distLookup[o]<=t&&t<this._distLookup[o+1])return fs(this._distLookup[o],this._distLookup[o+1],o/(i-1),(o+1)/(i-1),t)}return t/n}getPoint(t){const i=[...this.controlPoints];for(let n=1;n<i.length;n++)for(let o=0;o<i.length-n;o++)i[o]=_o(i[o],i[o+1],t);return i[0]}getTangent(t){const i=t*t,n=this.controlPoints[0],o=this.controlPoints[1],h=this.controlPoints[2],c=this.controlPoints[3];return n.scale(-3*i+6*t-3).add(o.scale(9*i-12*t+3).add(h.scale(-9*i+6*t).add(c.scale(3*i)))).normalize()}getUniformTangent(t){const i=t*this.arcLength,n=this._getTimeGivenDistance(i);return this.getTangent(n)}getNormal(t){return this.getTangent(t).normal()}getUniformNormal(t){return this.getUniformTangent(t).normal()}getUniformPoint(t){const i=t*this.arcLength,n=this._getTimeGivenDistance(i);return this.getPoint(n)}clone(){return new go({controlPoints:[...this.controlPoints],quality:this.quality})}}class a_{constructor(t,i){var n;if(this.id=Vt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(nt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new go({controlPoints:[N(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(n=i.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=t;const i=St(fs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class h_{constructor(t,i){var n;if(this.id=Vt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(nt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new go({controlPoints:[N(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(n=i.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=t;const i=St(fs(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class po{constructor(t){this._entity=t,this._queue=new Bf(t)}getQueue(){return this._queue}update(t){this._queue.update(t)}clearActions(){this._queue.clearActions()}runAction(t){return t.reset(),this._queue.add(t),this}curveBy(t){return this._queue.add(new h_(this._entity,t)),this}curveTo(t){return this._queue.add(new a_(this._entity,t)),this}easeTo(...t){var i,n;let o=0,h=0,c=0,_=Xt.Linear;return t[0]instanceof k?(o=t[0].x,h=t[0].y,c=t[1],_=(i=t[2])!==null&&i!==void 0?i:_):(o=t[0],h=t[1],c=t[2],_=(n=t[3])!==null&&n!==void 0?n:_),this._queue.add(new t_(this._entity,o,h,c,_)),this}easeBy(...t){var i,n;let o=0,h=0,c=0,_=Xt.Linear;return t[0]instanceof k?(o=t[0].x,h=t[0].y,c=t[1],_=(i=t[2])!==null&&i!==void 0?i:_):(o=t[0],h=t[1],c=t[2],_=(n=t[3])!==null&&n!==void 0?n:_),this._queue.add(new e_(this._entity,o,h,c,_)),this}moveTo(t,i,n){let o=0,h=0,c=0;return t instanceof k?(o=t.x,h=t.y,c=+(i??0),this._queue.add(new Bl(this._entity,o,h,c))):typeof t=="number"&&typeof i=="number"&&typeof n=="number"?(o=t,h=i,c=n,this._queue.add(new Bl(this._entity,o,h,c))):Vf(t)&&this._queue.add(new Nf(this._entity,t)),this}moveBy(t,i,n){let o=0,h=0,c=0;return t instanceof k&&typeof i=="number"?(o=t.x,h=t.y,c=i,this._queue.add(new Ml(this._entity,o,h,c))):typeof t=="number"&&typeof i=="number"&&typeof n=="number"?(o=t,h=i,c=n,this._queue.add(new Ml(this._entity,o,h,c))):Of(t)&&this._queue.add(new Wf(this._entity,t)),this}rotateTo(t,i,n){return typeof t=="number"&&typeof i=="number"?this._queue.add(new Xf(this._entity,t,i,n)):typeof t=="object"&&this._queue.add(new Gf(this._entity,t)),this}rotateBy(t,i,n){return typeof t=="object"?this._queue.add(new qf(this._entity,t)):this._queue.add(new Yf(this._entity,t,i,n)),this}scaleTo(t,i,n,o){let h=1,c=1,_=0,p=0;return jf(t)?(this._queue.add(new Zf(this._entity,t)),this):(t instanceof k&&i instanceof k&&(h=t.x,c=t.y,_=i.x,p=i.y),typeof t=="number"&&typeof i=="number"&&(h=t,c=i,_=n,p=o),this._queue.add(new Qf(this._entity,h,c,_,p)),this)}scaleBy(t,i,n){if(Jf(t))return this._queue.add(new Kf(this._entity,t)),this;let o=1,h=1;return t instanceof k&&(o=t.x,h=t.y,n=i),typeof t=="number"&&typeof i=="number"&&(o=t,h=i),this._queue.add(new $f(this._entity,o,h,n)),this}blink(t,i,n=1){return this._queue.add(new i_(this._entity,t,i,n)),this}fade(t,i){return this._queue.add(new s_(this._entity,t,i)),this}flash(t,i=1e3){return this._queue.add(new o_(this._entity,t,i)),this}delay(t){return this._queue.add(new n_(t)),this}die(){return this._queue.add(new r_(this._entity)),this}callMethod(t){return this._queue.add(new Ku(t)),this}repeat(t,i){return i?(this._queue.add(new kf(this._entity,t,i)),this):(this.repeatForever(t),this)}repeatForever(t){return this._queue.add(new Lf(this._entity,t)),this}follow(t,i){return i===void 0?this._queue.add(new kl(this._entity,t)):this._queue.add(new kl(this._entity,t,i)),this}meet(t,i){return i===void 0?this._queue.add(new Ll(this._entity,t)):this._queue.add(new Ll(this._entity,t,i)),this}toPromise(){return new Promise(i=>{this._queue.add(new Ku(()=>{i()}))})}}class er extends Ei{constructor(){super(...arguments),this.dependencies=[nt,Lt],this._ctx=null}onAdd(t){this._ctx=new po(t)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(t){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(t)}update(t){var i;return(i=this._ctx)===null||i===void 0?void 0:i.update(t)}clearActions(){var t;(t=this._ctx)===null||t===void 0||t.clearActions()}curveBy(t){return this._getCtx().curveBy.apply(this._ctx,[t])}curveTo(t){return this._getCtx().curveTo.apply(this._ctx,[t])}easeTo(...t){return this._getCtx().easeTo.apply(this._ctx,t)}easeBy(...t){return this._getCtx().easeBy.apply(this._ctx,t)}moveTo(t,i,n){return this._getCtx().moveTo.apply(this._ctx,[t,i,n])}moveBy(t,i,n){return this._getCtx().moveBy.apply(this._ctx,[t,i,n])}rotateTo(t,i,n){return this._getCtx().rotateTo.apply(this._ctx,[t,i,n])}rotateBy(t,i,n){return this._getCtx().rotateBy.apply(this._ctx,[t,i,n])}scaleTo(t,i,n,o){return this._getCtx().scaleTo.apply(this._ctx,[t,i,n,o])}scaleBy(t,i,n){return this._getCtx().scaleBy.apply(this._ctx,[t,i,n])}blink(t,i,n){return this._getCtx().blink(t,i,n)}fade(t,i){return this._getCtx().fade(t,i)}flash(t,i=1e3){return this._getCtx().flash(t,i)}delay(t){return this._getCtx().delay(t)}die(){return this._getCtx().die()}callMethod(t){return this._getCtx().callMethod(t)}repeat(t,i){return this._getCtx().repeat(t,i)}repeatForever(t){return this._getCtx().repeatForever(t)}follow(t,i){return this._getCtx().follow(t,i)}meet(t,i){return this._getCtx().meet(t,i)}toPromise(){return this._getCtx().toPromise()}}function Nv(d){return d instanceof ii}const Gv={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class ii extends Ye{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(t){this.body.oldPos.setTo(t.x,t.y)}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t.clone()}get oldVel(){return this.body.oldVel}set oldVel(t){this.body.oldVel.setTo(t.x,t.y)}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t.clone()}set oldAcc(t){this.body.oldAcc.setTo(t.x,t.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(t){this.transform.rotation=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}get scale(){return this.get(nt).scale}set scale(t){this.get(nt).scale=t}get anchor(){return this._anchor}set anchor(t){this._anchor=Oi(t,i=>this._handleAnchorChange(i)),this._handleAnchorChange(t)}_handleAnchorChange(t){this.graphics&&(this.graphics.anchor=t)}get offset(){return this._offset}set offset(t){this._offset=Oi(t,i=>this._handleOffsetChange(i)),this._handleOffsetChange(t)}_handleOffsetChange(t){this.graphics&&(this.graphics.offset=t)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(t){t&&(t&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!t&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=t)}get color(){return this.graphics.color}set color(t){this.graphics.color=t}constructor(t){super(),this.events=new $t,this._anchor=Oi(k.Half,lt=>this._handleAnchorChange(lt)),this._offset=Oi(k.Zero,lt=>this._handleOffsetChange(lt)),this.logger=dt.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=lt=>{this._dragging&&(this.pos=lt.worldPos)},this._pointerDragLeaveHandler=lt=>{this._dragging&&(this.pos=lt.worldPos)};const{name:i,x:n,y:o,pos:h,coordPlane:c,scale:_,width:p,height:v,radius:x,collider:b,vel:S,acc:P,rotation:I,angularVelocity:F,z:R,color:T,visible:M,opacity:W,anchor:U,offset:G,collisionType:j,collisionGroup:X,silenceWarnings:rt}={...t};this.name=i??this.name,this.anchor=U??ii.defaults.anchor.clone(),this.offset=G??k.Zero,this.transform=new nt,this.addComponent(this.transform),this.pos=h??N(n??0,o??0),this.rotation=I??0,this.scale=_??N(1,1),this.z=R??0,this.transform.coordPlane=c??Le.World,this._silenceWarnings=rt??!1,this.pointer=new $s,this.addComponent(this.pointer),this.graphics=new he({anchor:this.anchor,offset:this.offset,opacity:W}),this.addComponent(this.graphics),this.motion=new Lt,this.addComponent(this.motion),this.vel=S??k.Zero,this.acc=P??k.Zero,this.angularVelocity=F??0,this.actions=new er,this.addComponent(this.actions),this.body=new Et,this.addComponent(this.body),this.body.collisionType=j??_t.Passive,X&&(this.body.group=X),T&&(this.color=T),b?(this.collider=new we(b),this.addComponent(this.collider)):x?(this.collider=new we(Xe.Circle(x)),this.addComponent(this.collider),T&&this.graphics.add(new Ba({color:T,radius:x}))):p>0&&v>0?(this.collider=new we(Xe.Box(p,v,this.anchor)),this.addComponent(this.collider),T&&p&&v&&this.graphics.add(new fo({color:T,width:p,height:v}))):(this.collider=new we,this.addComponent(this.collider)),this.graphics.isVisible=M??!0}clone(){const t=new ii({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});t.clearComponents(),t.processComponentRemoval(),t.addComponent(t.transform=this.transform.clone(),!0),t.addComponent(t.pointer=this.pointer.clone(),!0),t.addComponent(t.graphics=this.graphics.clone(),!0),t.addComponent(t.motion=this.motion.clone(),!0),t.addComponent(t.actions=this.actions.clone(),!0),t.addComponent(t.body=this.body.clone(),!0),t.addComponent(t.collider=this.collider.clone(),!0);const i=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],n=this.getComponents();for(const o of n)i.includes(o)||t.addComponent(o.clone(),!0);return t}onInitialize(t){}_initialize(t){super._initialize(t);for(const i of this.children)i._initialize(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_prekill(t){this.events.emit("prekill",new nc(this)),this.onPreKill(t)}onPreKill(t){}_postkill(t){this.events.emit("postkill",new rc(this)),this.onPostKill(t)}onPostKill(t){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new Ra(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(nt).z}set z(t){this.get(nt).z=t}get center(){const t=this.getGlobalPos();return new k(t.x+this.width/2-this.anchor.x*this.width,t.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new k(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(nt).globalRotation}get globalRotation(){return this.get(nt).globalRotation}getGlobalPos(){return this.get(nt).globalPos}get globalPos(){return this.get(nt).globalPos}getGlobalScale(){return this.get(nt).globalScale}get globalScale(){return this.get(nt).globalScale}get globalZ(){return this.get(nt).globalZ}contains(t,i,n=!1){const o=N(t,i),h=this.get(we);h.update();const c=h.get();if(!c)return!1;const _=c.contains(o);return n?_||this.children.some(p=>p.contains(t,i,!0)):_}within(t,i){const n=this.get(we),o=t.get(we),h=n.get(),c=o.get();return h&&c?h.getClosestLineBetween(c).getLength()<=i:!1}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i),this._postupdate(t,i),this._remove(t)}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreCollisionResolve(t,i,n,o){}onPostCollisionResolve(t,i,n,o){}onCollisionStart(t,i,n,o){}onCollisionEnd(t,i,n,o){}_preupdate(t,i){this.events.emit("preupdate",new tn(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new en(t,i,this)),this.onPostUpdate(t,i)}}ii.defaults={anchor:k.Half};function l_(d){return d instanceof Uc}class Uc extends ii{constructor(t){var i,n;super({...t}),this.get(nt).coordPlane=Le.Screen,this.anchor=(i=t?.anchor)!==null&&i!==void 0?i:N(0,0),this.body.collisionType=(n=t?.collisionType)!==null&&n!==void 0?n:_t.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!t?.collider&&t?.width>0&&t?.height>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(t){this._engine=t,super._initialize(t)}contains(t,i,n=!0){if(n)return super.contains(t,i);const o=this._engine.worldToScreenCoordinates(new k(t,i));return super.contains(o.x,o.y)}}class Rn{get complete(){return this._complete}constructor(t){var i;this._logger=dt.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const n=(i=t.action)!==null&&i!==void 0?i:t.fcn,o=t.interval,h=t.repeats,c=t.numberOfRepeats,_=t.randomRange,p=t.random;if(c&&c>=0&&(this.maxNumberOfRepeats=c,!h))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=Rn._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=o,_){if(_[0]>_[1])throw new Error("min value must be lower than max value for range");this.random=p??new lr,this.randomRange=_,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=h||this.repeats,n&&this.on(n)}on(t){this._callbacks.push(t)}off(t){const i=this._callbacks.indexOf(t);this._callbacks.splice(i,1)}update(t){this._running&&(this._totalTimeAlive+=t,this._elapsedTime+=t,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(i=>{i.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(t,i){if(t&&t>=0&&(this._baseInterval=this.interval=t),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=i,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}Rn._MAX_ID=0;class ka extends Ei{constructor(t){super(),this.parallaxFactor=N(1,1),this.parallaxFactor=t??this.parallaxFactor}}class La extends Ei{constructor(t,i=!0){super(),this.draw=t,this.useTransform=i}}function $u(d){return d&&d._dispatchPointerEvents&&d._processPointerToObject}class Xv{get events(){return this.object.events}init(t,i,n){this.object=t,this.contains=i,this.active=n}}class zc{constructor(){this._proxyPool=new oo(()=>new Xv,t=>t,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(t,i,n){const o=this._proxyPool.rent(!1);o.init(t,i,n),this._proxies.push(o),this._objectToProxy.set(t,o)}_getProxy(t){const i=this._objectToProxy.get(t);if(i)return i;throw new Error("No PointerTargetProxy for object")}removeObject(t){const i=this._objectToProxy.get(t);if(i){const n=this._proxies.indexOf(i);n>-1&&this._proxies.splice(n,1),this._proxyPool.return(i)}}_objectCurrentlyUnderPointer(t,i){return!!(this._currentFrameObjectToPointers.has(t)&&this._currentFrameObjectToPointers.get(t).includes(i))}_objectWasUnderPointer(t,i){return!!(this._lastFrameObjectToPointers.has(t)&&this._lastFrameObjectToPointers.get(t).includes(i))}_entered(t,i){return this._objectCurrentlyUnderPointer(t,i)&&!this._lastFrameObjectToPointers.has(t)}_left(t,i){return!this._currentFrameObjectToPointers.has(t)&&this._objectWasUnderPointer(t,i)}addPointerToObject(t,i){const n=this._objectToProxy.get(t);n&&this._addPointerToProxy(n,i)}_addPointerToProxy(t,i){if(!this._currentFrameObjectToPointers.has(t)){this._currentFrameObjectToPointers.set(t,[i]);return}const n=this._currentFrameObjectToPointers.get(t);this._currentFrameObjectToPointers.set(t,n.concat(i))}dispatchEvents(t,i){const n=new Set(this._lastFrameObjectToPointers.keys()),o=new Set(this._currentFrameObjectToPointers.keys());let h,c,_;for(let p=0;p<i.length;p++){const v=i[p],x=this._getProxy(v);if($u(v)&&v._dispatchPointerEvents(t),n.has(x)||o.has(x)){_=this._processDownAndEmit(t,x),c=this._processUpAndEmit(t,x),h=this._processMoveAndEmit(t,x);const b=[...h.values(),..._.values(),...c.values()];this._processEnterLeaveAndEmit(t,x,b),this._processCancelAndEmit(t,x),this._processWheelAndEmit(t,x)}}}processPointerToObject(t,i){for(let n=0;n<i.length;n++){const o=i[n],h=this._getProxy(o);$u(o)&&o._processPointerToObject(t);for(const[c,_]of t.currentFramePointerCoords.entries())h.contains(_)&&this._addPointerToProxy(h,c)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(t,i){const n=new Map;for(const o of t.currentFrameDown)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerdown",o),t.isDragStart(o.pointerId)&&i.events.emit("pointerdragstart",o)),n.set(o.pointerId,o);return n}_processUpAndEmit(t,i){const n=new Map;for(const o of t.currentFrameUp)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerup",o),t.isDragEnd(o.pointerId)&&i.events.emit("pointerdragend",o)),n.set(o.pointerId,o);return n}_processMoveAndEmit(t,i){const n=new Map;for(const o of t.currentFrameMove)o.active&&i.active()&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointermove",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragmove",o)),n.set(o.pointerId,o);return n}_processEnterLeaveAndEmit(t,i,n){for(const o of n){if(o.active&&i.active()&&this._entered(i,o.pointerId)){i.events.emit("pointerenter",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragenter",o);break}if(o.active&&i.active()&&(this._left(i,o.pointerId)||this._objectCurrentlyUnderPointer(i,o.pointerId)&&o.type==="up")){i.events.emit("pointerleave",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragleave",o);break}}}_processCancelAndEmit(t,i){for(const n of t.currentFrameCancel)n.active&&i.active()&&this._objectCurrentlyUnderPointer(i,n.pointerId)&&i.events.emit("pointercancel",n)}_processWheelAndEmit(t,i){for(const n of t.currentFrameWheel)n.active&&i.active()&&this._objectCurrentlyUnderPointer(i,0)&&i.events.emit("pointerwheel",n)}}const qv={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class c_ extends Ye{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let t=0;t<this.tiles.length;t++)this.tiles[t]&&this.tiles[t].flagDirty()}get x(){var t;return(t=this.transform.pos.x)!==null&&t!==void 0?t:0}set x(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.get(nt).pos=N(t,this.y))}get y(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.pos.y)!==null&&i!==void 0?i:0}set y(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.transform.pos=N(this.x,t))}get z(){var t;return(t=this.transform.z)!==null&&t!==void 0?t:0}set z(t){this.transform&&(this.transform.z=t)}get rotation(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.rotation)!==null&&i!==void 0?i:0}set rotation(t){this.transform&&(this.transform.rotation=t)}get scale(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.scale)!==null&&i!==void 0?i:k.One}set scale(t){var i;!((i=this.transform)===null||i===void 0)&&i.scale&&(this.transform.scale=t)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get vel(){return this._motion.vel}set vel(t){this._motion.vel=t}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,n,o;super([],t.name),this.events=new $t,this._token=0,this.logger=dt.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(i=t.meshingLookBehind)!==null&&i!==void 0?i:this.meshingLookBehind,this.addComponent(new nt),this.addComponent(new Lt),this.addComponent(new Et({type:_t.Fixed})),this.addComponent(new he({onPostDraw:(c,_)=>this.draw(c,_)})),this.addComponent(new La((c,_)=>this.debug(c,_),!1)),this.addComponent(new we),this.addComponent(new $s),this.pointer=this.get($s),this._graphics=this.get(he),this.transform=this.get(nt),this._motion=this.get(Lt),this.collider=this.get(we),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(n=t.pos)!==null&&n!==void 0?n:k.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(o=t.renderFromTopOfGraphic)!==null&&o!==void 0?o:this.renderFromTopOfGraphic,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight,this.rows=t.rows,this.columns=t.columns,this._pointerEventDispatcher=new zc,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let h=[];for(let c=0;c<this.columns;c++){for(let _=0;_<this.rows;_++){const p=new d_({x:c,y:_,map:this});p.map=this,this.tiles[c+_*this.columns]=p,this._pointerEventDispatcher.addObject(p,v=>p.bounds.contains(v.worldPos),()=>!0),h.push(p),this._rows[_]||(this._rows[_]=[]),this._rows[_].push(p)}this._cols[c]=h,h=[]}this._graphics.localBounds=new ct({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(t){super._initialize(t),this._engine=t}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:k.Zero;{const n=t.offset;return this._originalOffsets.set(t,n),n}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const t=[];this._composite=this.collider.useCompositeCollider([]);let i=null;const n=(h,c)=>h&&c?h.top===c.top&&h.bottom===c.bottom&&h.right===c.left:!1,o=(h,c,_=this.meshingLookBehind)=>{if(!h)return!1;for(let p=c.length-1;p>=0;p--){if(_--<0)return!1;const v=c[p];if(n(v,h))return c[p]=v.combine(h),!0}return!1};for(let h=0;h<this.columns;h++){for(let c=0;c<this.rows;c++){const _=this.tiles[h+c*this.columns];if(_.solid)if(_.getColliders().length>0){for(const p of _.getColliders()){const v=this._getOrSetColliderOriginalOffset(p);p.offset=N(_.x*this.tileWidth*this.scale.x,_.y*this.tileHeight*this.scale.y).add(v),p.owner=this,this._composite.addCollider(p)}i&&!o(i,t)&&t.push(i),i=null}else i?i=i.combine(_.defaultGeometry):i=_.defaultGeometry;else i&&!o(i,t)&&t.push(i),i=null}i&&!o(i,t)&&t.push(i),i=null}for(const h of t){const c=Xe.Box(h.width,h.height,k.Zero,N(h.left-this.pos.x,h.top-this.pos.y));c.owner=this,this._composite.addCollider(c)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(t){var i;return(i=this.tiles[t])!==null&&i!==void 0?i:null}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const{x:i,y:n}=this._getTileCoordinates(t),o=this.getTile(i,n);return i>=0&&n>=0&&i<this.columns&&n<this.rows&&o?o:null}_getTileCoordinates(t){t=this.transform.applyInverse(t);const i=Math.floor(t.x/this.tileWidth),n=Math.floor(t.y/this.tileHeight);return{x:i,y:n}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let t=this._engine.screen.getWorldBounds();const i=this.get(ka);if(i&&this.isInitialized){let P=this.pos;const I=k.One.sub(i.parallaxFactor),F=this._engine.currentScene.camera.pos.scale(I);P=P.sub(F),t=t.translate(P)}const n=this.transform.coordPlane===Le.Screen?this._engine.screen.getScreenBounds():t,o=this._getTileCoordinates(n.topLeft),h=this._getTileCoordinates(n.topRight),c=this._getTileCoordinates(n.bottomRight),_=this._getTileCoordinates(n.bottomLeft),p=Math.min(St(o.x,0,this.columns-1),St(h.x,0,this.columns-1)),v=Math.min(St(o.y,0,this.rows-1),St(h.y,0,this.rows-1)),x=Math.max(St(c.x,0,this.columns-1),St(_.x,0,this.columns-1)),b=Math.max(St(c.y,0,this.rows-1),St(_.y,0,this.rows-1)),S=[];for(let P=p;P<=x;P++)for(let I=v;I<=b;I++)S.push(this.getTile(P,I));return S}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(t,i){this._initialize(t),this.onPreUpdate(t,i),this.emit("preupdate",new tn(t,i,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(t,i),this.emit("postupdate",new en(t,i,this))}draw(t,i){if(!this.isInitialized)return;this.emit("predraw",new fr(t,i,this));let n,o,h;const c=this.getOnScreenTiles();for(let _=0;_<c.length;_++){const p=c[_],v=p.getGraphicsOffsets();for(n=p.getGraphics(),o=0,h=n.length;o<h;o++){const x=n[o],b=v[o];if(x){sc(x)&&x?.tick(i,this._token);const S=this.renderFromTopOfGraphic?0:x.height-this.tileHeight;x.draw(t,p.x*this.tileWidth+b.x,p.y*this.tileHeight-S+b.y)}}}this.emit("postdraw",new _r(t,i,this))}debug(t,i){const{showAll:n,showGrid:o,gridColor:h,gridWidth:c,showSolidBounds:_,solidBoundsColor:p,showColliderGeometry:v}=i.tilemap,{geometryColor:x,geometryLineWidth:b,geometryPointSize:S}=i.collider,P=this.tileWidth*this.columns*this.scale.x,I=this.tileHeight*this.rows*this.scale.y,F=this.pos;if(o||n){for(let R=0;R<this.rows+1;R++){const T=N(0,R*this.tileHeight*this.scale.y);t.drawLine(F.add(T),F.add(N(P,T.y)),h,c)}for(let R=0;R<this.columns+1;R++){const T=N(R*this.tileWidth*this.scale.x,0);t.drawLine(F.add(T),F.add(N(T.x,I)),h,c)}}if(n||_||v){const R=this._composite.getColliders();t.save(),t.translate(this.pos.x,this.pos.y),t.scale(this.scale.x,this.scale.y);for(const T of R){const M=T.localBounds,W=T.worldPos.sub(this.pos);_&&t.drawRectangle(W,M.width,M.height,p)}if(t.restore(),v)for(const T of R)T.debug(t,x,{lineWidth:b,pointSize:S})}if(n||_){if(t.save(),t.z=999,_)for(let R=0;R<this.tiles.length;R++)this.tiles[R].bounds.draw(t);t.restore()}}}class d_{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(t){var i;(i=this.map)===null||i===void 0||i.flagCollidersDirty(),this._solid=t}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(t,i){this._graphics.push(t),i?.offset?this._offsets.push(i.offset):this._offsets.push(k.Zero)}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&(this._graphics.splice(i,1),this._offsets.splice(i,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(t){var i,n;this._posDirty=!1,this.events=new $t,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=t.x,this.y=t.y,this.map=t.map,this._width=t.map.tileWidth*this.map.scale.x,this._height=t.map.tileHeight*this.map.scale.y,this.solid=(i=t.solid)!==null&&i!==void 0?i:this.solid,this._graphics=(n=t.graphics)!==null&&n!==void 0?n:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const t=this.map.pos.add(N(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new ct(t.x,t.y,t.x+this.map.tileWidth,t.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(N(this.x*this._width,this.y*this._height)),this._bounds=new ct(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new k(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}class u_{constructor(t){this.camera=t}lockToActor(t){this.camera.addStrategy(new f_(t))}lockToActorAxis(t,i){this.camera.addStrategy(new __(t,i))}elasticToActor(t,i,n){this.camera.addStrategy(new g_(t,i,n))}radiusAroundActor(t,i){this.camera.addStrategy(new p_(t,i))}limitCameraBounds(t){this.camera.addStrategy(new m_(t))}}var Ca;(function(d){d[d.X=0]="X",d[d.Y=1]="Y"})(Ca||(Ca={}));class f_{constructor(t){this.target=t,this.action=(i,n,o,h)=>i.center}}class __{constructor(t,i){this.target=t,this.axis=i,this.action=(n,o,h,c)=>{const _=n.center,p=o.getFocus();return this.axis===Ca.X?new k(_.x,p.y):new k(p.x,_.y)}}}class g_{constructor(t,i,n){this.target=t,this.cameraElasticity=i,this.cameraFriction=n,this.action=(o,h,c,_)=>{const p=o.center;let v=h.getFocus(),x=h.vel.clone();const b=p.sub(v).scale(this.cameraElasticity);x=x.add(b);const S=x.scale(-1).scale(this.cameraFriction);return x=x.add(S),v=v.add(x),v}}}class p_{constructor(t,i){this.target=t,this.radius=i,this.action=(n,o,h,c)=>{const _=n.center,p=o.getFocus(),v=_.sub(p),x=v.magnitude;if(x>=this.radius){const b=x-this.radius;return p.add(v.normalize().scale(b))}return p}}}class m_{constructor(t){this.target=t,this.boundSizeChecked=!1,this.action=(i,n,o,h)=>{const c=n.getFocus();this.boundSizeChecked||((i.bottom-i.top<o.drawHeight||i.right-i.left<o.drawWidth)&&dt.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let _=c.x,p=c.y;return c.x<i.left+o.halfDrawWidth?_=i.left+o.halfDrawWidth:c.x>i.right-o.halfDrawWidth&&(_=i.right-o.halfDrawWidth),c.y<i.top+o.halfDrawHeight?p=i.top+o.halfDrawHeight:c.y>i.bottom-o.halfDrawHeight&&(p=i.bottom-o.halfDrawHeight),N(_,p)}}}const Yv={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class v_{constructor(){this.events=new $t,this.transform=ve.identity(),this.inverse=ve.identity(),this._cameraStrategies=[],this.strategy=new u_(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new Qs(k.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=k.Zero,this.acc=k.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Xt.EaseInOutCubic,this._easing=Xt.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=N(0,0)}get zoom(){return this._z}set zoom(t){this._z=t,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(t){this._angularVelocity=t}get pos(){return this._pos}set pos(t){this._posChanged=!0,this._pos=new Qs(t,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(t){!this._follow&&!this._cameraMoving&&(this.pos=N(t,this.pos.y))}get y(){return this.pos.y}set y(t){!this._follow&&!this._cameraMoving&&(this.pos=N(this.pos.x,t))}get dx(){return this.vel.x}set dx(t){this.vel=N(t,this.vel.y)}get dy(){return this.vel.y}set dy(t){this.vel=N(this.vel.x,t)}get ax(){return this.acc.x}set ax(t){this.acc=N(t,this.acc.y)}get ay(){return this.acc.y}set ay(t){this.acc=N(this.acc.x,t)}getFocus(){return this.pos}move(t,i,n=Xt.EaseInOutCubic){if(typeof n!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(t):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(t),this._lerpPromise=new Promise(o=>{this._lerpResolve=o}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=i,this._lerpEnd=t,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=n,this._lerpPromise)}shake(t,i,n){this._isShaking=!0,this._shakeMagnitudeX=t,this._shakeMagnitudeY=i,this._shakeDuration=n}zoomOverTime(t,i=0,n=Xt.EaseInOutCubic){if(this._zoomPromise=new Promise(o=>{this._zoomResolve=o}),i)this._isZooming=!0,this._zoomEasing=n,this._currentZoomTime=0,this._zoomDuration=i,this._zoomStart=this.zoom,this._zoomEnd=t;else return this._isZooming=!1,this.zoom=t,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new ct(0,0,0,0)}addStrategy(t){this._cameraStrategies.push(t)}removeStrategy(t){cr(t,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(t,i){this.events.emit("preupdate",new tn(t,i,this)),this.onPreUpdate(t,i)}onPreUpdate(t,i){}_postupdate(t,i){this.events.emit("postupdate",new en(t,i,this)),this.onPostUpdate(t,i)}onPostUpdate(t,i){}get isInitialized(){return this._isInitialized}_initialize(t){if(!this.isInitialized){this._engine=t,this._screen=t.screen;const i=this._screen.contentArea;let n=N(i.width/2,i.height/2);if(!this._engine.loadingComplete){const o=this._screen.peekResolution();o&&(n=N(o.width/2,o.height/2))}this._halfWidth=n.x,this._halfHeight=n.y,this._posChanged||(this.pos=n),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(t,t.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(t),this.events.emit("initialize",new gr(t,this)),this._isInitialized=!0}}onInitialize(t){}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}runStrategies(t,i){for(const n of this._cameraStrategies)this.pos=n.action.call(n,n.target,this,t,i)}updateViewport(){this._viewport=new ct(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(t,i){if(this._initialize(t),this._preupdate(t,i),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(i/1e3)),this.zoom+=this.dz*i/1e3,this.vel=this.vel.add(this.acc.scale(i/1e3)),this.dz+=this.az*i/1e3,this.rotation+=this.angularVelocity*i/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const n=this._zoomEasing,o=n(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=o,this._currentZoomTime+=i}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const o=Xt.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=o,this._currentLerpTime+=i}else{this.pos=this._lerpEnd;const n=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(n)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=i,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(t,i),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(t,i),this._posChanged=!1}draw(t){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const i=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,n=this.pos.scale(i).add(this._oldPos.scale(1-i));n.clone(this.drawPos),this.updateTransform(n)}if(t.snapToPixel){const i=this.drawPos.clone(this._snapPos);i.x=~~(i.x+mt*qt(i.x)),i.y=~~(i.y+mt*qt(i.y)),i.clone(this.drawPos),this.updateTransform(i)}t.multiply(this.transform)}updateTransform(t){const i=this._screen.resolution.width/this.zoom,n=this._screen.resolution.height/this.zoom,o=N(-t.x+i/2+this._xShake,-t.y+n/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(i/2,n/2),this.transform.rotate(this.rotation),this.transform.translate(-i/2,-n/2),this.transform.translate(o.x,o.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const jv={ExitTrigger:"exit",EnterTrigger:"enter"};class w_ extends ii{constructor(t){var i,n,o,h;super({...t}),this.events=new $t,this.filter=(i=t.filter)!==null&&i!==void 0?i:()=>!0,this.repeat=(n=t.repeat)!==null&&n!==void 0?n:-1,this.action=(o=t.action)!==null&&o!==void 0?o:()=>{},this.target=t.target,this.graphics.isVisible=(h=t.visible)!==null&&h!==void 0?h:!1,this.body.collisionType=_t.Passive,this.events.on("collisionstart",({other:c})=>{this._matchesTarget(c.owner)&&(this.events.emit("enter",new Cc(this,c.owner)),this._dispatchAction(c.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:c})=>{this._matchesTarget(c.owner)&&this.events.emit("exit",new Sc(this,c.owner))})}_matchesTarget(t){return this.filter(t)&&(this.target===void 0||this.target===t)}_dispatchAction(t){this.repeat!==0&&(this.action.call(this,t),this.repeat--)}}const _s={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var vi;(function(d){d.Update="update",d.Draw="draw"})(vi||(vi={}));class Ci{}Ci.priority=_s.Average;class x_{constructor(t){this._world=t,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>i=>{this.addEntity(i)},this._createChildRemovedHandler=()=>i=>{this.removeEntity(i,!1)},this._entitiesToRemove=[]}updateEntities(t,i){for(let n=0;n<this.entities.length;n++){const o=this.entities[n];o.update(t.engine,i),o.isActive||this.removeEntity(o)}}findEntitiesForRemoval(){for(let t=0;t<this.entities.length;t++){const i=this.entities[t];i.isActive||this.removeEntity(i)}}addEntity(t){if(t.isActive=!0,t.scene=this._world.scene,t&&!this._entityIndex[t.id]){this._entityIndex[t.id]=t,this.entities.push(t),this._world.queryManager.addEntity(t),t.children.forEach(o=>{o.scene=t.scene,this.addEntity(o)});const i=this._createChildAddedHandler();this._childAddedHandlerMap.set(t,i);const n=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(t,n),t.childrenAdded$.subscribe(i),t.childrenRemoved$.subscribe(n)}}removeEntity(t,i=!0){var n,o;let h=0;t instanceof Ye?h=t.id:h=t;const c=this._entityIndex[h];if(c&&c.isActive&&(c.isActive=!1),c&&i){this._entitiesToRemove.push(c);return}if(delete this._entityIndex[h],c){c.scene=null,cr(c,this.entities),this._world.queryManager.removeEntity(c),c.children.forEach(v=>{v.scene=null,this.removeEntity(v,i)});const _=this._childAddedHandlerMap.get(c);_&&c.childrenAdded$.unsubscribe(_);const p=this._childRemovedHandlerMap.get(c);p&&c.childrenRemoved$.unsubscribe(p),!((o=(n=this._world)===null||n===void 0?void 0:n.scene)===null||o===void 0)&&o.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let t=0;t<this._entitiesToRemove.length;t++){const i=this._entitiesToRemove[t];i.isActive||this.removeEntity(i,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let t=0;t<this.entities.length;t++)this.entities[t].processComponentRemoval()}getById(t){return this._entityIndex[t]}getByName(t){return this.entities.filter(i=>i.name===t)}clear(){for(let t=this.entities.length-1;t>=0;t--)this.removeEntity(this.entities[t])}}class $r{constructor(t){if(this.requiredComponents=t,this.components=new Set,this.entities=[],this.entityAdded$=new ti,this.entityRemoved$=new ti,t.length===0)throw new Error("Cannot create query without components");for(const i of t)this.components.add(i);this.id=$r.createId(t)}static createId(t){return t.slice().map(i=>i.name).sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAll(Array.from(this.components))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class to{constructor(t){if(this.requiredTags=t,this.tags=new Set,this.entities=[],this.entityAdded$=new ti,this.entityRemoved$=new ti,t.length===0)throw new Error("Cannot create tag query without tags");for(const i of t)this.tags.add(i);this.id=to.createId(t)}static createId(t){return t.slice().sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAllTags(Array.from(this.tags))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class b_{constructor(t){this._world=t,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=i=>n=>{this.addComponent(i,n)},this._createRemoveComponentHandler=i=>n=>{this.removeComponent(i,n)},this._createAddTagHandler=i=>n=>{this.addTag(i,n)},this._createRemoveTagHandler=i=>n=>{this.removeTag(i,n)}}createQuery(t){const i=$r.createId(t);if(this._queries.has(i))return this._queries.get(i);const n=new $r(t);this._queries.set(n.id,n);for(const o of t){const h=this._componentToQueriesIndex.get(o);h?h.push(n):this._componentToQueriesIndex.set(o,[n])}for(const o of this._world.entities)this.addEntity(o);return n}createTagQuery(t){const i=to.createId(t);if(this._tagQueries.has(i))return this._tagQueries.get(i);const n=new to(t);this._tagQueries.set(n.id,n);for(const o of t){const h=this._tagToQueriesIndex.get(o);h?h.push(n):this._tagToQueriesIndex.set(o,[n])}for(const o of this._world.entities)this.addEntity(o);return n}addEntity(t){const i=this._addComponentHandlers.get(t),n=this._removeComponentHandlers.get(t),o=i??this._createAddComponentHandler(t),h=n??this._createRemoveComponentHandler(t);this._addComponentHandlers.set(t,o),this._removeComponentHandlers.set(t,h);const c=this._addTagHandlers.get(t),_=this._removeTagHandlers.get(t),p=c??this._createAddTagHandler(t),v=_??this._createRemoveTagHandler(t);this._addTagHandlers.set(t,p),this._removeTagHandlers.set(t,v);for(const x of this._queries.values())x.checkAndAdd(t);for(const x of this._tagQueries.values())x.checkAndAdd(t);t.componentAdded$.subscribe(o),t.componentRemoved$.subscribe(h),t.tagAdded$.subscribe(p),t.tagRemoved$.subscribe(v)}removeEntity(t){const i=this._addComponentHandlers.get(t),n=this._removeComponentHandlers.get(t);for(const c of this._queries.values())c.removeEntity(t);i&&t.componentAdded$.unsubscribe(i),n&&t.componentRemoved$.unsubscribe(n);const o=this._addTagHandlers.get(t),h=this._removeTagHandlers.get(t);for(const c of this._tagQueries.values())c.removeEntity(t);o&&t.tagAdded$.unsubscribe(o),h&&t.tagRemoved$.unsubscribe(h)}addComponent(t,i){var n;const o=(n=this._componentToQueriesIndex.get(i.constructor))!==null&&n!==void 0?n:[];for(const h of o)h.checkAndAdd(t)}removeComponent(t,i){var n;const o=(n=this._componentToQueriesIndex.get(i.constructor))!==null&&n!==void 0?n:[];for(const h of o)h.removeEntity(t)}addTag(t,i){var n;const o=(n=this._tagToQueriesIndex.get(i))!==null&&n!==void 0?n:[];for(const h of o)h.checkAndAdd(t)}removeTag(t,i){var n;const o=(n=this._tagToQueriesIndex.get(i))!==null&&n!==void 0?n:[];for(const h of o)h.removeEntity(t)}}function A_(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class y_{constructor(t){this._world=t,this.systems=[],this.initialized=!1}get(t){return this.systems.find(i=>i instanceof t)}addSystem(t){let i;t instanceof Ci?i=t:i=new t(this._world),this.systems.push(i),this.systems.sort((n,o)=>n.constructor.priority-o.constructor.priority),this.initialized&&i.initialize&&i.initialize(this._world,this._world.scene)}removeSystem(t){cr(t,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const t of this.systems)t.initialize&&t.initialize(this._world,this._world.scene)}}updateSystems(t,i,n){const o=this.systems.filter(h=>h.systemType===t);for(const h of o)h.preupdate&&h.preupdate(i,n);for(const h of o)h.update(n);for(const h of o)h.postupdate&&h.postupdate(i,n)}clear(){for(let t=this.systems.length-1;t>=0;t--)this.removeSystem(this.systems[t])}}class C_{constructor(t){this.scene=t,this._logger=dt.getInstance(),this.queryManager=new b_(this),this.entityManager=new x_(this),this.systemManager=new y_(this)}query(t){return this.queryManager.createQuery(t)}queryTags(t){return this.queryManager.createTagQuery(t)}update(t,i){t===vi.Update&&this.entityManager.updateEntities(this.scene,i),this.systemManager.updateSystems(t,this.scene,i),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(t){if(t instanceof Ye){this.entityManager.addEntity(t);return}if(t instanceof Ci||A_(t)){this.systemManager.addSystem(t);return}this._logger.warn(`Could not add entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(t){return this.systemManager.get(t)}remove(t,i=!0){if(t instanceof Ye){this.entityManager.removeEntity(t,i);return}if(t instanceof Ci){this.systemManager.removeSystem(t);return}this._logger.warn(`Could not remove entity/system ${t.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class Ua extends Ci{constructor(t,i){super(),this.world=t,this.physics=i,this.systemType=vi.Update,this._physicsConfigDirty=!1,i.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([nt,Lt])}update(t){let i,n;const o=this.query.entities,h=this.physics.config.substep;for(let c=0;c<o.length;c++){i=o[c].get(nt),n=o[c].get(Lt);const _=o[c].get(Et);if(this._physicsConfigDirty&&_&&_.updatePhysicsConfig(this.physics.config.bodies),_?.isSleeping)continue;const p=n.acc.clone();_?.collisionType===_t.Active&&_?.useGravity&&p.addEqual(this.physics.config.gravity),o[c].parent||this.captureOldTransformWithChildren(o[c]),$e.integrate(i,n,p,t/h)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(t){var i;(i=t.get(Et))===null||i===void 0||i.captureOldTransform();for(let n=0;n<t.children.length;n++)this.captureOldTransformWithChildren(t.children[n])}}Ua.priority=_s.Higher;class Ul{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map}solve(t){this.preSolve(t),t=t.filter(n=>!n.isCanceled());let i;switch(this.config.contactSolveBias){case Ls.HorizontalFirst:{i=Bc;break}case Ls.VerticalFirst:{i=Mc;break}default:i=kc}t.sort((n,o)=>{const h=this.directionMap.get(n.id),c=this.directionMap.get(o.id),_=this.distanceMap.get(n.id),p=this.distanceMap.get(o.id);return i[h]-i[c]||_-p});for(const n of t)this.solvePosition(n),this.solveVelocity(n);return this.postSolve(t),t}preSolve(t){for(let n=0;n<t.length;n++){const o=t[n];if(Math.abs(o.mtv.x)<1e-4&&Math.abs(o.mtv.y)<1e-4){o.cancel();continue}const h=Wt.fromDirection(o.mtv),c=o.mtv.negate(),_=Math.abs(o.info.separation);this.distanceMap.set(o.id,_),this.directionMap.set(o.id,h===Wt.Left||h===Wt.Right?"horizontal":"vertical"),o.colliderA.events.emit("precollision",new kn(o.colliderA,o.colliderB,h,c,o)),o.colliderB.events.emit("precollision",new kn(o.colliderB,o.colliderA,Wt.getOpposite(h),c.negate(),o))}}postSolve(t){var i,n;for(let o=0;o<t.length;o++){const h=t[o];if(h.isCanceled())continue;const c=h.colliderA,_=h.colliderB,p=(i=c.owner)===null||i===void 0?void 0:i.get(Et),v=(n=_.owner)===null||n===void 0?void 0:n.get(Et);if(p&&v&&(p.collisionType===_t.Passive||v.collisionType===_t.Passive))continue;const x=Wt.fromDirection(h.mtv),b=h.mtv.negate();h.colliderA.events.emit("postcollision",new Ln(h.colliderA,h.colliderB,x,b,h)),h.colliderB.events.emit("postcollision",new Ln(h.colliderB,h.colliderA,Wt.getOpposite(x),b.negate(),h))}}solvePosition(t){var i,n;if(!t.colliderA.bounds.overlaps(t.colliderB.bounds,1e-4)){t.cancel();return}if(Math.abs(t.mtv.x)<1e-4&&Math.abs(t.mtv.y)<1e-4){t.cancel();return}let h=t.mtv;const c=t.colliderA,_=t.colliderB,p=(i=c.owner)===null||i===void 0?void 0:i.get(Et),v=(n=_.owner)===null||n===void 0?void 0:n.get(Et);if(p&&v){if(p.collisionType===_t.Passive||v.collisionType===_t.Passive)return;p.collisionType===_t.Active&&v.collisionType===_t.Active&&(h=h.scale(.5)),p.collisionType===_t.Active&&(p.globalPos.x-=h.x,p.globalPos.y-=h.y,c.update(p.transform.get())),v.collisionType===_t.Active&&(v.globalPos.x+=h.x,v.globalPos.y+=h.y,_.update(v.transform.get()))}}solveVelocity(t){var i,n;if(t.isCanceled())return;const o=t.colliderA,h=t.colliderB,c=(i=o.owner)===null||i===void 0?void 0:i.get(Et),_=(n=h.owner)===null||n===void 0?void 0:n.get(Et);if(c&&_){if(c.collisionType===_t.Passive||_.collisionType===_t.Passive)return;const p=t.normal,v=p.negate();if(c.collisionType===_t.Active&&c.vel.normalize().dot(v)<0){const x=p.scale(p.dot(c.vel.negate()));c.vel=c.vel.add(x)}if(_.collisionType===_t.Active&&_.vel.normalize().dot(p)<0){const x=v.scale(v.dot(_.vel.negate()));_.vel=_.vel.add(x)}}}}class S_{constructor(t,i,n){this.point=t,this.local=i,this.contact=n,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new k(0,0),this.bToContact=new k(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const t=this.contact.bodyA,i=this.contact.colliderA,n=this.contact.bodyB,o=this.contact.colliderB;if(t&&n){const h=this.contact.normal,c=this.contact.tangent;this.aToContact=this.point.sub(i.center),this.bToContact=this.point.sub(o.center);const _=this.aToContact.cross(h),p=this.bToContact.cross(h);this.normalMass=t.inverseMass+n.inverseMass+t.inverseInertia*_*_+n.inverseInertia*p*p;const v=this.aToContact.cross(c),x=this.bToContact.cross(c);this.tangentMass=t.inverseMass+n.inverseMass+t.inverseInertia*v*v+n.inverseInertia*x*x}return this}getRelativeVelocity(){const t=this.contact.bodyA,i=this.contact.bodyB;if(t&&i){const n=t.vel.add(k.cross(t.angularVelocity,this.aToContact));return i.vel.add(k.cross(i.angularVelocity,this.bToContact)).sub(n)}return k.Zero}}class zl{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(t){var i;return(i=this.idToContactConstraint.get(t))!==null&&i!==void 0?i:[]}solve(t){this.preSolve(t),t=t.filter(n=>!n.isCanceled());let i;switch(this.config.contactSolveBias){case Ls.HorizontalFirst:{i=Bc;break}case Ls.VerticalFirst:{i=Mc;break}default:i=kc}return t.sort((n,o)=>{const h=this.directionMap.get(n.id),c=this.directionMap.get(o.id),_=this.distanceMap.get(n.id),p=this.distanceMap.get(o.id);return i[h]-i[c]||_-p}),this.solveVelocity(t),this.solvePosition(t),this.postSolve(t),t}preSolve(t){var i,n,o,h;for(let p=0;p<t.length;p++){const v=t[p];if(Math.abs(v.mtv.x)<1e-4&&Math.abs(v.mtv.y)<1e-4){v.cancel();continue}const x=Wt.fromDirection(v.mtv),b=Math.abs(((i=v?.info)===null||i===void 0?void 0:i.separation)||0);this.distanceMap.set(v.id,b),this.directionMap.set(v.id,x===Wt.Left||x===Wt.Right?"horizontal":"vertical"),v.colliderA.events.emit("precollision",new kn(v.colliderA,v.colliderB,x,v.mtv,v)),v.colliderA.events.emit("beforecollisionresolve",new xa(v.colliderA,v.colliderB,x,v.mtv,v)),v.colliderB.events.emit("precollision",new kn(v.colliderB,v.colliderA,Wt.getOpposite(x),v.mtv.negate(),v)),v.colliderB.events.emit("beforecollisionresolve",new xa(v.colliderB,v.colliderA,Wt.getOpposite(x),v.mtv.negate(),v)),v.matchAwake()}const _=Array.from(this.idToContactConstraint.keys());for(let p=0;p<t.length;p++){const v=t[p],x=_.indexOf(v.id);x>-1&&_.splice(x,1);const b=(n=this.idToContactConstraint.get(v.id))!==null&&n!==void 0?n:[];let S=0;const P=v.bodyA,I=v.colliderA,F=v.bodyB,R=v.colliderB;if(P&&F)for(let T=0;T<v.points.length;T++){const M=v.points[T],W=v.normal,U=v.tangent,G=M.sub(I.center),j=M.sub(R.center),X=G.cross(W),rt=j.cross(W),lt=P.inverseMass+F.inverseMass+P.inverseInertia*X*X+F.inverseInertia*rt*rt,yt=G.cross(U),vt=j.cross(U),Pt=P.inverseMass+F.inverseMass+P.inverseInertia*yt*yt+F.inverseInertia*vt*vt;b[S]&&((h=(o=b[S])===null||o===void 0?void 0:o.point)===null||h===void 0?void 0:h.squareDistance(M))<4?(b[S].point=M,b[S].local=v.localPoints[S]):b[S]=new S_(M,v.localPoints[S],v),b[S].aToContact=G,b[S].bToContact=j,b[S].normalMass=1/lt,b[S].tangentMass=1/Pt;const Dt=P.bounciness>F.bounciness?P.bounciness:F.bounciness,B=v.normal.dot(b[S].getRelativeVelocity());b[S].originalVelocityAndRestitution=0,B<-.1&&(b[S].originalVelocityAndRestitution=-Dt*B),S++}this.idToContactConstraint.set(v.id,b)}for(const p of _)this.idToContactConstraint.delete(p);if(this.config.warmStart)this.warmStart(t);else for(let p=0;p<t.length;p++){const v=t[p],x=this.getContactConstraints(v.id);for(const b of x)b.normalImpulse=0,b.tangentImpulse=0}}postSolve(t){for(let i=0;i<t.length;i++){const n=t[i],o=n.bodyA,h=n.bodyB;if(o&&h){if(o.collisionType===_t.Passive||h.collisionType===_t.Passive)continue;o.updateMotion(),h.updateMotion()}const c=Wt.fromDirection(n.mtv);n.colliderA.events.emit("postcollision",new Ln(n.colliderA,n.colliderB,c,n.mtv,n)),n.colliderA.events.emit("aftercollisionresolve",new ba(n.colliderA,n.colliderB,c,n.mtv,n)),n.colliderB.events.emit("postcollision",new Ln(n.colliderB,n.colliderA,Wt.getOpposite(c),n.mtv.negate(),n)),n.colliderB.events.emit("aftercollisionresolve",new ba(n.colliderB,n.colliderA,Wt.getOpposite(c),n.mtv.negate(),n))}this.lastFrameContacts.clear();for(let i=0;i<t.length;i++){const n=t[i];this.lastFrameContacts.set(n.id,n)}}warmStart(t){var i;for(let n=0;n<t.length;n++){const o=t[n],h=o.bodyA,c=o.bodyB;if(h&&c){const _=(i=this.idToContactConstraint.get(o.id))!==null&&i!==void 0?i:[];for(const p of _)if(this.config.warmStart){const v=o.normal.scale(p.normalImpulse),x=o.tangent.scale(p.tangentImpulse),b=v.add(x);h.applyImpulse(p.point,b.negate()),c.applyImpulse(p.point,b)}else p.normalImpulse=0,p.tangentImpulse=0}}}solvePosition(t){var i;for(let n=0;n<this.config.positionIterations;n++)for(let o=0;o<t.length;o++){const h=t[o],c=h.bodyA,_=h.bodyB;if(c&&_){if(c.collisionType===_t.Passive||_.collisionType===_t.Passive)continue;const p=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const v of p){const x=h.normal,b=Vi.FindContactSeparation(h,v.local),S=this.config.steeringFactor,P=-5,I=this.config.slop,F=St(S*(b+I),P,0),R=x.scale(-F*v.normalMass);if(c.collisionType===_t.Active){const T=R.negate().scale(c.inverseMass);c.limitDegreeOfFreedom.includes(hi.X)&&(T.x=0),c.limitDegreeOfFreedom.includes(hi.Y)&&(T.y=0),c.globalPos=c.globalPos.add(T),c.limitDegreeOfFreedom.includes(hi.Rotation)||(c.rotation-=v.aToContact.cross(R)*c.inverseInertia)}if(_.collisionType===_t.Active){const T=R.scale(_.inverseMass);_.limitDegreeOfFreedom.includes(hi.X)&&(T.x=0),_.limitDegreeOfFreedom.includes(hi.Y)&&(T.y=0),_.globalPos=_.globalPos.add(T),_.limitDegreeOfFreedom.includes(hi.Rotation)||(_.rotation+=v.bToContact.cross(R)*_.inverseInertia)}}}}}solveVelocity(t){var i;for(let n=0;n<this.config.velocityIterations;n++)for(let o=0;o<t.length;o++){const h=t[o],c=h.bodyA,_=h.bodyB;if(c&&_){if(c.collisionType===_t.Passive||_.collisionType===_t.Passive)continue;const p=Math.min(c.friction,_.friction),v=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const x of v){let P=-x.getRelativeVelocity().dot(h.tangent)*x.tangentMass;const I=p*x.normalImpulse,F=St(x.tangentImpulse+P,-I,I);P=F-x.tangentImpulse,x.tangentImpulse=F;const R=h.tangent.scale(P);c.applyImpulse(x.point,R.negate()),_.applyImpulse(x.point,R)}for(const x of v){const S=x.getRelativeVelocity().dot(h.normal);let P=-x.normalMass*(S-x.originalVelocityAndRestitution);const I=Math.max(x.normalImpulse+P,0);P=I-x.normalImpulse,x.normalImpulse=I;const F=h.normal.scale(P);c.applyImpulse(x.point,F.negate()),_.applyImpulse(x.point,F)}}}}}class za extends Ci{get _processor(){return this._physics.collisionProcessor}constructor(t,i){super(),this._physics=i,this.systemType=vi.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new Ul(i.config.arcade),this._realisticSolver=new zl(i.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=n=>this._processor.track(n),this._untrackCollider=n=>this._processor.untrack(n),this.query=t.query([nt,Lt,we]),this.query.entityAdded$.subscribe(n=>{const o=n.get(we);o.$colliderAdded.subscribe(this._trackCollider),o.$colliderRemoved.subscribe(this._untrackCollider);const h=o.get();h&&this._processor.track(h)}),this.query.entityRemoved$.subscribe(n=>{const o=n.get(we),h=o.get();o&&h&&this._processor.untrack(h)}),this._motionSystem=t.get(Ua)}initialize(t,i){this._engine=i.engine}update(t){var i,n,o,h;if(!this._physics.config.enabled)return;let c=[];for(let b=0;b<this.query.entities.length;b++){const P=this.query.entities[b].get(we),I=P?.get();if(P&&(!((i=P.owner)===null||i===void 0)&&i.isActive)&&I)if(P.update(),I instanceof Ie){const F=I.getColliders();I.compositeStrategy||(I.compositeStrategy=this._physics.config.colliders.compositeStrategy),c=c.concat(F)}else c.push(I)}this._processor.update(c,t);let _=this._processor.broadphase(c,t);this._currentFrameContacts.clear();let p=[];const v=this.getSolver(),x=this._physics.config.substep;for(let b=0;b<x;b++)if(b>0&&this._motionSystem.update(t),p.length&&(_=p.map(S=>new ei(S.colliderA,S.colliderB))),_.length){p=this._processor.narrowphase(_,(h=(o=(n=this._engine)===null||n===void 0?void 0:n.debug)===null||o===void 0?void 0:o.stats)===null||h===void 0?void 0:h.currFrame),p=v.solve(p);for(const S of p){if(S.isCanceled())continue;const P=S.id.indexOf("|");if(P>0){const I=S.id.substring(P+1);this._currentFrameContacts.set(I,S)}else this._currentFrameContacts.set(S.id,S)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const b of this.query.entities){const S=b.get(we);S&&S.processColliderRemoval()}}postupdate(){me.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new Ul(this._physics.config.arcade),this._realisticSolver=new zl(this._physics.config.realistic)),this._physics.config.solver===Kr.Realistic?this._realisticSolver:this._arcadeSolver}debug(t){this._processor.debug(t,0)}runContactStartEnd(){for(const[t,i]of this._currentFrameContacts)if(!this._lastFrameContacts.has(t)){const n=i.colliderA,o=i.colliderB,h=Wt.fromDirection(i.mtv),c=Wt.getOpposite(h);n.events.emit("collisionstart",new jr(n,o,h,i)),n.events.emit("contactstart",new va(n,o,h,i)),o.events.emit("collisionstart",new jr(o,n,c,i)),o.events.emit("contactstart",new va(o,n,c,i))}for(const[t,i]of this._lastFrameContacts)if(!this._currentFrameContacts.has(t)){const n=i.colliderA,o=i.colliderB,h=Wt.fromDirection(i.mtv),c=Wt.getOpposite(h);n.events.emit("collisionend",new Zr(n,o,h,i)),n.events.emit("contactend",new wa(n,o,h,i)),o.events.emit("collisionend",new Zr(o,n,c,i)),o.events.emit("contactend",new wa(o,n,c,i))}}}za.priority=_s.Higher;function Zv(d,t,i,n){if(d.parent!==t.parent){const x=d.clone(),b=d.globalPos.clone(),S=d.globalScale.clone(),P=d.globalRotation;x.parent=t.parent,x.globalPos=b,x.globalScale=S,x.globalRotation=P,d=x}let o=t.pos,h=t.scale,c=t.rotation;o=t.pos.scale(i).add(d.pos.scale(1-i)),h=t.scale.scale(i).add(d.scale.scale(1-i));const _=(1-i)*Math.cos(d.rotation)+i*Math.cos(t.rotation),p=(1-i)*Math.sin(d.rotation)+i*Math.sin(t.rotation);c=Math.atan2(p,_);const v=n??new Bs;return v.setTransform(o,c,h),v}class Hc extends Ci{get sortedTransforms(){return this._sortedTransforms}constructor(t){super(),this.world=t,this.systemType=vi.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new Bs,this.query=this.world.query([nt,he]),this.query.entityAdded$.subscribe(i=>{const n=i.get(nt);this._sortedTransforms.push(n),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{const n=i.get(nt);n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const o=this._sortedTransforms.indexOf(n);o>-1&&this._sortedTransforms.splice(o,1)})}initialize(t,i){this._camera=i.camera,this._engine=i.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>t.globalZ-i.globalZ),this._zHasChanged=!1)}update(t){this._token++;let i;Ot.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let n=0;n<this._sortedTransforms.length;n++){const o=this._sortedTransforms[n],h=o.owner;if(h.hasTag("ex.offscreen")||(i=h.get(he),!i.isVisible))continue;i.onPreTransformDraw&&i.onPreTransformDraw(this._graphicsContext,t),h.events.emit("pretransformdraw",new hc(this._graphicsContext,t,h)),o.coordPlane===Le.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),o.coordPlane===Le.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),i.update(t,this._token);const c=h.get(ka);if(c){const _=k.One.sub(c.parallaxFactor),p=this._camera.drawPos.scale(_);this._graphicsContext.translate(p.x,p.y)}this._applyTransform(h),i.material&&(this._graphicsContext.material=i.material),i.onPreDraw&&i.onPreDraw(this._graphicsContext,t),h.events.emit("predraw",new fr(this._graphicsContext,t,h)),this._applyOpacity(h),this._drawGraphicsComponent(i,o),i.onPostDraw&&i.onPostDraw(this._graphicsContext,t),h.events.emit("postdraw",new _r(this._graphicsContext,t,h)),this._graphicsContext.restore(),o.coordPlane===Le.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),i.onPostTransformDraw&&i.onPostTransformDraw(this._graphicsContext,t),h.events.emit("posttransformdraw",new lc(this._graphicsContext,t,h))}this._graphicsContext.restore()}_drawGraphicsComponent(t,i){var n,o;if(t.isVisible){const h=t.flipHorizontal,c=t.flipVertical,_=t.current,p=(n=t.currentOptions)!==null&&n!==void 0?n:{};if(_){let v=t.anchor,x=t.offset,b=1,S=1;p?.anchor&&(v=p.anchor),p?.offset&&(x=p.offset);const P=i.globalScale;b*=_.scale.x*P.x,S*=_.scale.y*P.y;const I=-_.width*v.x+x.x*b,F=-_.height*v.y+x.y*S,R=_.flipHorizontal,T=_.flipVertical;if((h||c)&&(_.flipHorizontal=h?!R:R,_.flipVertical=c?!T:T),_?.draw(this._graphicsContext,I,F),(h||c)&&(_.flipHorizontal=R,_.flipVertical=T),!((o=this._engine)===null||o===void 0)&&o.isDebug&&this._engine.debug.graphics.showBounds){const M=N(I,F);if(_ instanceof sr)for(const W of _.members){let U,G=k.Zero;W instanceof ae?U=W:(U=W.graphic,G=W.offset),_.useAnchor?U?.localBounds.translate(M.add(G)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):U?.localBounds.translate(G).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else _?.localBounds.translate(M).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(t){const i=t.getAncestors();for(let n=0;n<i.length;n++){const o=i[n],h=o?.get(nt),c=o?.get(Et);if(h){let _=h.get();if(c&&this._engine.fixedUpdateTimestep&&c.__oldTransformCaptured&&c.enableFixedUpdateInterpolate){const p=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;_=Zv(c.oldTransform,h.get(),p,this._targetInterpolationTransform)}this._graphicsContext.z=h.globalZ,this._graphicsContext.translate(_.pos.x,_.pos.y),this._graphicsContext.scale(_.scale.x,_.scale.y),this._graphicsContext.rotate(_.rotation)}}}_applyOpacity(t){var i;const n=t.getAncestors();for(let o=0;o<n.length;o++){const h=n[o],c=h?.get(he);this._graphicsContext.opacity*=(i=c?.opacity)!==null&&i!==void 0?i:1}}}Hc.priority=_s.Average;class Oc extends Ci{constructor(t){super(),this.world=t,this.systemType=vi.Draw,this.query=this.world.query([nt])}initialize(t,i){this._graphicsContext=i.engine.graphicsContext,this._camera=i.camera,this._engine=i.engine,this._collisionSystem=t.systemManager.get(za)}update(){var t;if(!this._engine.isDebug)return;const i=this._engine.debug.filter;let n,o;const h=this._engine.debug.entity;let c;const _=this._engine.debug.transform;let p;const v=this._engine.debug.motion;let x;const b=this._engine.debug.collider,S=this._engine.debug.physics;let P;const I=this._engine.debug.graphics;let F,R;const T=this._engine.debug.body,M=this._engine.debug.camera;for(let W=0;W<this.query.entities.length;W++){const U=this.query.entities[W];if(U.hasTag("offscreen")||U instanceof Da||i.useFilter&&(!(i.ids.length===0||i.ids.includes(U.id))||!(i.nameQuery===""||U.name.includes(i.nameQuery))))continue;let G=k.Zero;const j=N(0,16);if(n=U.id,o=U.name,c=U.get(nt),this._pushCameraTransform(c),this._graphicsContext.save(),c.coordPlane===Le.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=_.debugZIndex,this._applyTransform(U),c&&((_.showAll||_.showPosition)&&this._graphicsContext.debug.drawPoint(k.Zero,{size:4,color:_.positionColor}),(_.showAll||_.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${c.pos.toString(2)}`,G),G=G.add(j)),(_.showAll||_.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${c.z.toFixed(1)})`,G),G=G.add(j)),(h.showAll||h.showId)&&(this._graphicsContext.debug.drawText(`id(${n}) ${U.parent?"child of id("+((t=U.parent)===null||t===void 0?void 0:t.id)+")":""}`,G),G=G.add(j)),(h.showAll||h.showName)&&(this._graphicsContext.debug.drawText(`name(${o})`,G),G=G.add(j)),(_.showAll||_.showRotation)&&(this._graphicsContext.drawLine(k.Zero,k.fromAngle(c.rotation).scale(50).add(k.Zero),_.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${gf(c.rotation).toFixed(2)})`,G),G=G.add(j)),(_.showAll||_.showScale)&&this._graphicsContext.drawLine(k.Zero,c.scale.add(k.Zero),_.scaleColor,2)),P=U.get(he),P&&(I.showAll||I.showBounds)&&P.localBounds.draw(this._graphicsContext,I.boundsColor),F=U.get(La),F&&(F.useTransform||this._graphicsContext.restore(),F.draw(this._graphicsContext,this._engine.debug),F.useTransform||(this._graphicsContext.save(),this._applyTransform(U))),R=U.get(Et),R&&((T.showAll||T.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${R.group.name})`,G),G=G.add(j)),(T.showAll||T.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${R.collisionType})`,G),G=G.add(j)),(T.showAll||T.showMass)&&(this._graphicsContext.debug.drawText(`mass(${R.mass})`,G),G=G.add(j)),(T.showAll||T.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${R.sleepMotion})`,G),G=G.add(j)),(T.showAll||T.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${R.canSleep?R.isSleeping:"cant sleep"})`,G),G=G.add(j))),this._graphicsContext.restore(),this._graphicsContext.save(),c.coordPlane===Le.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=_.debugZIndex,p=U.get(Lt),p&&((v.showAll||v.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${p.vel.toString(2)}`,G.add(c.globalPos)),this._graphicsContext.drawLine(c.globalPos,c.globalPos.add(p.vel),v.velocityColor,2),G=G.add(j)),(v.showAll||v.showAcceleration)&&this._graphicsContext.drawLine(c.globalPos,c.globalPos.add(p.acc),v.accelerationColor,2)),x=U.get(we),x){const X=x.get();if((b.showAll||b.showGeometry)&&X&&X.debug(this._graphicsContext,b.geometryColor,{lineWidth:b.geometryLineWidth,pointSize:b.geometryPointSize}),b.showAll||b.showBounds){if(X instanceof Ie){const rt=X.getColliders();for(const lt of rt){const yt=lt.bounds,vt=N(yt.left,yt.top);this._graphicsContext.debug.drawRect(vt.x,vt.y,yt.width,yt.height,{color:b.boundsColor}),(b.showAll||b.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${lt.owner.id})`,vt)}x.bounds.draw(this._graphicsContext,b.boundsColor)}else if(X){const rt=x.bounds,lt=N(rt.left,rt.top);this._graphicsContext.debug.drawRect(lt.x,lt.y,rt.width,rt.height,{color:b.boundsColor}),(b.showAll||b.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${x.owner.id})`,lt)}}}this._graphicsContext.restore(),this._popCameraTransform(c)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(S.showAll||S.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),S.showAll||S.showCollisionContacts||S.showCollisionNormals)for(const[W,U]of this._engine.debug.stats.currFrame.physics.contacts){if(S.showAll||S.showCollisionContacts)for(const G of U.points)this._graphicsContext.debug.drawPoint(G,{size:S.contactSize,color:S.collisionContactColor});if(S.showAll||S.showCollisionNormals)for(const G of U.points)this._graphicsContext.debug.drawLine(G,U.normal.scale(30).add(G),{color:S.collisionNormalColor})}this._graphicsContext.restore(),M&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(M.showAll||M.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,M.focusColor),(M.showAll||M.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(t,i){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),Ee.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(t){const i=t.getAncestors();for(const n of i){const o=n?.get(nt);o&&(this._graphicsContext.translate(o.pos.x,o.pos.y),this._graphicsContext.scale(o.scale.x,o.scale.y),this._graphicsContext.rotate(o.rotation))}}_pushCameraTransform(t){t.coordPlane===Le.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(t){t.coordPlane===Le.World&&this._graphicsContext.restore()}}Oc.priority=_s.Lowest;class Wc{constructor(t,i){this.object=t,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=i,this.bounds=t.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const t=this.object.bounds,i=Math.floor(t.left/this.gridSize),n=Math.floor(t.right/this.gridSize),o=Math.floor(t.bottom/this.gridSize),h=Math.floor(t.top/this.gridSize);return this.leftX!==i||this.rightX!==n||this.bottomY!==o||this.topY!==h}clear(){for(const t of this.cells){const i=t.proxies.indexOf(this);i>-1&&t.proxies.splice(i,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class is{constructor(){this.proxies=[]}configure(t,i){this.x=t,this.y=i,this.key=is.calculateHashKey(t,i)}static calculateHashKey(t,i){return`${t}+${i}`}}class Vc{constructor(t){this.bounds=new ct,this._hashGridCellPool=new oo(()=>new is,i=>(i.configure(0,0),i.proxies.length=0,i),1e3),this.gridSize=t.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,t.proxyFactory?this._buildProxy=i=>t.proxyFactory(i,this.gridSize):this._buildProxy=i=>new Wc(i,this.gridSize)}query(t){const i=new Set;if(t instanceof ct){const n=t,o=Math.floor(n.left/this.gridSize),h=Math.floor(n.right/this.gridSize),c=Math.floor(n.bottom/this.gridSize),_=Math.floor(n.top/this.gridSize);for(let p=o;p<=h;p++)for(let v=_;v<=c;v++){const x=is.calculateHashKey(p,v),b=this.sparseHashGrid.get(x);if(b)for(let S=0;S<b.proxies.length;S++)b.proxies[S].updateBounds(),b.proxies[S].bounds.intersect(n)&&i.add(b.proxies[S].object)}}else{const n=t,o=is.calculateHashKey(Math.floor(n.x/this.gridSize),Math.floor(n.y/this.gridSize)),h=this.sparseHashGrid.get(o);if(h)for(let c=0;c<h.proxies.length;c++)h.proxies[c].updateBounds(),h.proxies[c].bounds.contains(n)&&i.add(h.proxies[c].object)}return Array.from(i)}get(t,i){const n=is.calculateHashKey(t,i);return this.sparseHashGrid.get(n)}_insert(t,i,n){const o=is.calculateHashKey(t,i);let h=this.sparseHashGrid.get(o);h||(h=this._hashGridCellPool.rent(),h.configure(t,i),this.sparseHashGrid.set(h.key,h)),h.proxies.push(n),n.cells.push(h),this.bounds.combine(n.bounds,this.bounds)}_remove(t,i,n){const o=is.calculateHashKey(t,i),h=this.sparseHashGrid.get(o);if(h){const c=h.proxies.indexOf(n);c>-1&&h.proxies.splice(c,1);const _=n.cells.indexOf(h);_>-1&&n.cells.splice(_,1),h.proxies.length===0&&(this._hashGridCellPool.return(h),this.sparseHashGrid.delete(o))}}track(t){const i=this._buildProxy(t);this.objectToProxy.set(t,i);for(let n=i.leftX;n<=i.rightX;n++)for(let o=i.topY;o<=i.bottomY;o++)this._insert(n,o,i)}untrack(t){const i=this.objectToProxy.get(t);i&&(i.clear(),this.objectToProxy.delete(t))}update(t){let i=0;for(const n of t){const o=this.objectToProxy.get(n);if(o&&o.hasChanged()){for(let h=o.leftX;h<=o.rightX;h++)for(let c=o.topY;c<=o.bottomY;c++)this._remove(h,c,o);o.update();for(let h=o.leftX;h<=o.rightX;h++)for(let c=o.topY;c<=o.bottomY;c++)this._insert(h,c,o);i++}}return i}debug(t,i){const n=K.Transparent,o=K.White;for(const h of this.sparseHashGrid.values())t.drawRectangle(N(h.x*this.gridSize,h.y*this.gridSize),this.gridSize,this.gridSize,n,o,2)}}class Ha extends Ci{constructor(t){super(),this.world=t,this.systemType=vi.Update,this._graphicsHashGrid=new Vc({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new zc,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([nt,$s]),this.query.entityAdded$.subscribe(i=>{const n=i.get(nt),o=i.get($s);this._pointerEventDispatcher.addObject(i,c=>o&&o.localBounds?o.localBounds.transform(n.get().matrix).contains(n.coordPlane===Le.World?c.worldPos:c.screenPos):!1,()=>i.isActive),this._entityToPointer.set(i,o);const h=i.get(he);h&&(this._graphics.push(h),this._graphicsHashGrid.track(h)),this._sortedTransforms.push(n),this._sortedEntities.push(n.owner),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{this._pointerEventDispatcher.removeObject(i);const n=i.get(nt);this._entityToPointer.delete(i);const o=i.get(he);if(o){const c=this._graphics.indexOf(o);c>-1&&this._graphics.splice(c,1),this._graphicsHashGrid.untrack(o)}n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const h=this._sortedTransforms.indexOf(n);h>-1&&(this._sortedTransforms.splice(h,1),this._sortedEntities.splice(h,1))})}initialize(t,i){this._engine=i.engine,this._scene=i}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>i.z-t.z),this._sortedEntities=this._sortedTransforms.map(t=>t.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[t,i]of this._engineReceiver.currentFramePointerCoords.entries()){const n=this._scene.physics.query(i.worldPos);for(let h=0;h<n.length;h++){const c=n[h],_=this._entityToPointer.get(c.owner);_&&(_.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(c.owner,t)}const o=this._graphicsHashGrid.query(i.worldPos);for(let h=0;h<o.length;h++){const c=o[h],_=this._entityToPointer.get(c.owner);_&&(_.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(c.owner,t)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(t=>t.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(t=>t.clear())}}Ha.priority=_s.Higher;class Nc extends Ci{constructor(t){super(),this.world=t,this.systemType=vi.Update,this._actions=[],this.query=this.world.query([er]),this.query.entityAdded$.subscribe(i=>this._actions.push(i.get(er))),this.query.entityRemoved$.subscribe(i=>{const n=i.get(er),o=this._actions.indexOf(n);o>-1&&this._actions.splice(o,1)})}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}}Nc.priority=_s.Higher;class eo extends Ei{constructor(t){super(),this.elevation=0,this.columns=t.columns,this.rows=t.rows,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight}}class Gc extends Ci{constructor(t){super(),this.world=t,this.systemType=vi.Update,this.query=this.world.query([nt,eo])}update(){let t,i;for(let n=0;n<this.query.entities.length;n++){const o=this.query.entities[n];t=o.get(nt),i=o.get(eo);const c=Math.max(i.columns*i.tileWidth,i.rows*i.tileHeight)*i.elevation+t.pos.y;t.z=c}}}Gc.priority=_s.Lower;class Xc extends Ci{constructor(t){super(),this.world=t,this.systemType=vi.Draw,this.query=this.world.query([nt,he])}initialize(t,i){this._camera=i.camera,this._screen=i.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let t,i,n;for(let o=0;o<this.query.entities.length;o++){const h=this.query.entities[o];i=h.get(he),t=h.get(nt),n=h.get(ka);let c;if(n){const p=k.One.sub(n.parallaxFactor);c=this._camera.pos.scale(p)}const _=this._isOffscreen(t,i,c);_&&!h.hasTag("ex.offscreen")&&(h.events.emit("exitviewport",new Ac(h)),h.addTag("ex.offscreen")),!_&&h.hasTag("ex.offscreen")&&(h.events.emit("enterviewport",new yc(h)),h.removeTag("ex.offscreen"))}}_isOffscreen(t,i,n){if(i.forceOnScreen)return!1;if(t.coordPlane===Le.World){let o=i.localBounds;n&&(o=o.translate(n));const h=o.transform(t.get().matrix);return!this._worldBounds.overlaps(h)}else return!1}}Xc.priority=_s.Higher;class P_ extends Wc{constructor(t,i){var n,o;super(t,i),this.collider=t,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=i;const h=t.bounds;this.hasZeroBounds=h.hasZeroDimensions(),this.leftX=Math.floor(h.left/this.gridSize),this.rightX=Math.floor(h.right/this.gridSize),this.bottomY=Math.floor(h.bottom/this.gridSize),this.topY=Math.floor(h.top/this.gridSize),this.owner=t.owner,this.body=(n=this.owner)===null||n===void 0?void 0:n.get(Et),this.collisionType=(o=this.body.collisionType)!==null&&o!==void 0?o:_t.PreventCollision}update(){var t,i;super.update(),this.body=(t=this.owner)===null||t===void 0?void 0:t.get(Et),this.collisionType=(i=this.body.collisionType)!==null&&i!==void 0?i:_t.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class Hl{constructor(t){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new Ia(()=>new ei({id:Fn("collider",0)},{id:Fn("collider",0)}),i=>(i.colliderA=null,i.colliderB=null,i),200),this.gridSize=t.size,this.hashGrid=new Vc({size:this.gridSize,proxyFactory:(i,n)=>new P_(i,n)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(t){return this.hashGrid.query(t)}rayCast(t,i){var n,o,h;const c=[],_=(n=i?.maxDistance)!==null&&n!==void 0?n:1/0,p=i?.collisionGroup,v=p?p.category:(o=i?.collisionMask)!==null&&o!==void 0?o:ks.All.category,x=(h=i?.searchAllColliders)!==null&&h!==void 0?h:!1,b=t.dir.normalize(),S=b.y/b.x,P=b.x/b.y,I=Math.sqrt(1+S*S)*this.gridSize,F=Math.sqrt(1+P*P)*this.gridSize,R=t.pos.x/this.gridSize,T=t.pos.y/this.gridSize,M=N(1,1);let W=~~R,U=~~T,G=0,j=0;b.x<0?(M.x=-1,G=(R-W)*I):(M.x=1,G=(W+1-R)*I),b.y<0?(M.y=-1,j=(T-U)*F):(M.y=1,j=(U+1-T)*F);const X=new Set;let rt=!1,lt=9999;for(;!rt&&lt>0&&(lt--,!!this.hashGrid.bounds.contains(N(W*this.gridSize,U*this.gridSize)));){const yt=is.calculateHashKey(W,U),vt=this.hashGrid.sparseHashGrid.get(yt);if(vt){const Pt=[];for(let Dt=0;Dt<vt.proxies.length;Dt++){const B=vt.proxies[Dt];if(!X.has(B.collider.id.value)){if(X.add(B.collider.id.value),i?.ignoreCollisionGroupAll&&B.body.group===ks.All)continue;const z=(v&B.body.group.category)!==0;if(B.body.group&&!z)continue;const Q=B.collider.rayCast(t,_);Q&&Pt.push(Q)}}Pt.sort((Dt,B)=>Dt.distance-B.distance);for(let Dt=0;Dt<Pt.length;Dt++){const B=Pt[Dt];if(i?.filter){if(i.filter(B)&&(c.push(B),!x)){rt=!0;break}}else if(c.push(B),!x){rt=!0;break}}}G<j?(W+=M.x,G+=I):(U+=M.y,j+=F)}return c.sort((yt,vt)=>yt.distance-vt.distance),!x&&c.length?[c[0]]:c}track(t){let i=[t];if(t instanceof Ie){const n=t.getColliders();for(const o of n)o.owner=t.owner;i=n}for(const n of i)this.hashGrid.track(n)}untrack(t){let i=[t];t instanceof Ie&&(i=t.getColliders());for(const n of i)this.hashGrid.untrack(n)}_canCollide(t,i){return!(t.collider.id===i.collider.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.hasZeroBounds||i.hasZeroBounds||!t.body.group.canCollide(i.body.group)||t.collisionType===_t.Fixed&&i.collisionType===_t.Fixed||t.collisionType===_t.PreventCollision||i.collisionType===_t.PreventCollision||!t.owner.isActive||!i.owner.isActive)}broadphase(t,i){const n=[];this._pairs.clear(),this._nonPairs.clear();let o=0;for(const h of this.hashGrid.objectToProxy.values())if(h.id=o++,!(!h.owner.isActive||h.collisionType===_t.PreventCollision))for(let c=0;c<h.cells.length;c++){const _=h.cells[c];for(let p=0;p<_.proxies.length;p++){const v=_.proxies[p];if(v.id===h.id)continue;const x=ei.calculatePairHash(h.collider.id,v.collider.id);if(!this._nonPairs.has(x))if(!this._pairs.has(x)&&this._canCollide(h,v)&&h.object.bounds.overlaps(v.object.bounds)){const b=this._pairPool.get();b.colliderA=h.collider,b.colliderB=v.collider,b.id=x,this._pairs.add(x),n.push(b)}else this._nonPairs.add(x)}}return n}narrowphase(t,i){const n=[];for(let o=0;o<t.length;o++){const h=t[o].collide();for(let c=0;c<h.length;c++){const _=h[c];n.push(_),i&&i.physics.contacts.set(_.id,_)}}return this._pairPool.done(),i&&(i.physics.collisions+=n.length),n}update(t,i){return this.hashGrid.update(t)}debug(t,i){this.hashGrid.debug(t,i)}}class T_{get config(){return Nm(this._config,t=>{this.$configUpdate.notifyAll(t)})}set config(t){this._config=t,this.$configUpdate.notifyAll(t)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const t=this._collisionProcessor.getColliders();this._config.spatialPartition===nr.SparseHashGrid?this._collisionProcessor=new Hl(this._config.sparseHashGrid):this._collisionProcessor=new ya(this._config);for(const i of t)this._collisionProcessor.track(i)}return this._collisionProcessor}constructor(t){this.$configUpdate=new ti,this._configDirty=!1,this.config=t,this.$configUpdate.subscribe(i=>{this._configDirty=!0,Et.updateDefaultPhysicsConfig(i.bodies)}),this._config.spatialPartition===nr.SparseHashGrid?this._collisionProcessor=new Hl(this._config.sparseHashGrid):this._collisionProcessor=new ya(this._config)}rayCast(t,i){return this.collisionProcessor.rayCast(t,i)}query(t){return this._collisionProcessor.query(t)}}class Oa{constructor(){this.events=new $t,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(t){this._enabled=t}setMinimumGamepadConfiguration(t){this._enableAndUpdate(),this._minimumConfiguration=t}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(t){if(!this._minimumConfiguration)return!0;if(!t)return!1;const i=t.axes.filter(o=>typeof o!==void 0).length,n=t.buttons.filter(o=>typeof o!==void 0).length;return i>=this._minimumConfiguration.axis&&n>=this._minimumConfiguration.buttons&&t.connected}emit(t,i){this.events.emit(t,i)}on(t,i){return this._enableAndUpdate(),this.events.on(t,i)}once(t,i){return this._enableAndUpdate(),this.events.once(t,i)}off(t,i){this._enableAndUpdate(),this.events.off(t,i)}update(){var t,i;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const n=this._navigator.getGamepads();for(let o=0;o<n.length;o++){if(n[o]){const c=this.at(o);!this.at(o).connected&&this._isGamepadValid(n[o])&&(c.events.pipe(this.events),this.events.emit("connect",new _c(o,this.at(o)))),this.at(o).connected=!0}else{const c=this.at(o);c.connected&&(this.events.emit("disconnect",new gc(o,c)),c.events.unpipe(this.events)),c.connected=!1;continue}if(this.at(o).update(),n[o].timestamp&&n[o].timestamp===this._gamePadTimeStamps[o])continue;this._gamePadTimeStamps[o]=n[o].timestamp,this.at(o).navigatorGamepad=n[o];const h=n[o];if(h){for(let c=0;c<h.buttons.length;c++){const _=h.buttons[c],p=_?.value;p!==((t=this._oldPads[o])===null||t===void 0?void 0:t.getButton(c))&&(_?.pressed?(this.at(o).updateButton(c,p),this.at(o).events.emit("button",new pc(c in io?c:io.Unknown,c,p,this.at(o)))):this.at(o).updateButton(c,0))}for(let c=0;c<h.axes.length;c++){const _=h.axes[c];_!==((i=this._oldPads[o])===null||i===void 0?void 0:i.getAxes(c))&&(this.at(o).updateAxes(c,_),this.at(o).events.emit("axis",new mc(c,_,this.at(o))))}}this._oldPads[o]=this._clonePad(n[o])}}at(t){if(this._enableAndUpdate(),t>=this._pads.length)for(let i=this._pads.length-1,n=t;i<n;i++)this._pads.push(new la),this._oldPads.push(new la);return this._pads[t]}getValidGamepads(){this._enableAndUpdate();const t=[];for(let i=0;i<this._pads.length;i++)this._isGamepadValid(this.at(i).navigatorGamepad)&&this.at(i).connected&&t.push(this.at(i));return t}count(){return this._pads.filter(t=>t.connected).length}_clonePads(t){const i=[];for(let n=0,o=t.length;n<o;n++)i.push(this._clonePad(t[n]));return i}_clonePad(t){let i,n;const o=new la;if(!t)return o;for(i=0,n=t.buttons.length;i<n;i++)t.buttons[i]&&o.updateButton(i,t.buttons[i].value);for(i=0,n=t.axes.length;i<n;i++)o.updateAxes(i,t.axes[i]);return o}}Oa.MinAxisMoveThreshold=.05;class la{constructor(){this.events=new $t,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let t=0;t<this._buttons.length;t++)this._buttons[t]=0;for(let t=0;t<this._axes.length;t++)this._axes[t]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(t,i=1){return this._buttons[t]>=i}isButtonHeld(t,i=1){return this._buttons[t]>=i}wasButtonPressed(t,i=1){return this._buttonsDown[t]>=i}wasButtonReleased(t){return!!this._buttonsUp[t]}getButton(t){return this._buttons[t]}getAxes(t){const i=this._axes[t];return Math.abs(i)<Oa.MinAxisMoveThreshold?0:i}updateButton(t,i){i===0&&this._buttons[t]?this._buttonsUp[t]=1:this._buttonsDown[t]=i,this._buttons[t]=i}updateAxes(t,i){this._axes[t]=i}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}var io;(function(d){d[d.Unknown=-1]="Unknown",d[d.Face1=0]="Face1",d[d.Face2=1]="Face2",d[d.Face3=2]="Face3",d[d.Face4=3]="Face4",d[d.LeftBumper=4]="LeftBumper",d[d.RightBumper=5]="RightBumper",d[d.LeftTrigger=6]="LeftTrigger",d[d.RightTrigger=7]="RightTrigger",d[d.Select=8]="Select",d[d.Start=9]="Start",d[d.LeftStick=10]="LeftStick",d[d.RightStick=11]="RightStick",d[d.DpadUp=12]="DpadUp",d[d.DpadDown=13]="DpadDown",d[d.DpadLeft=14]="DpadLeft",d[d.DpadRight=15]="DpadRight",d[d.CenterButton=16]="CenterButton",d[d.MiscButton1=17]="MiscButton1"})(io||(io={}));var Ol;(function(d){d[d.LeftStickX=0]="LeftStickX",d[d.LeftStickY=1]="LeftStickY",d[d.RightStickX=2]="RightStickX",d[d.RightStickY=3]="RightStickY"})(Ol||(Ol={}));class E_{constructor(t){this.inputs=t,this._handlers=new Map}execute(){for(const[t,i]of this._handlers.entries()){const n=t(this.inputs);n&&i(n)}}on(t,i){this._handlers.set(t,i)}}function I_(){try{const d=()=>{};window.top.addEventListener("blur",d),window.top.removeEventListener("blur",d)}catch{return!0}return!1}var so;(function(d){d.Backquote="Backquote",d.Backslash="Backslash",d.BracketLeft="BracketLeft",d.BracketRight="BracketRight",d.Comma="Comma",d.Key0="Digit0",d.Key1="Digit1",d.Key2="Digit2",d.Key3="Digit3",d.Key4="Digit4",d.Key5="Digit5",d.Key6="Digit6",d.Key7="Digit7",d.Key8="Digit8",d.Key9="Digit9",d.Digit0="Digit0",d.Digit1="Digit1",d.Digit2="Digit2",d.Digit3="Digit3",d.Digit4="Digit4",d.Digit5="Digit5",d.Digit6="Digit6",d.Digit7="Digit7",d.Digit8="Digit8",d.Digit9="Digit9",d.Equal="Equal",d.IntlBackslash="IntlBackslash",d.IntlRo="IntlRo",d.IntlYen="IntlYen",d.A="KeyA",d.B="KeyB",d.C="KeyC",d.D="KeyD",d.E="KeyE",d.F="KeyF",d.G="KeyG",d.H="KeyH",d.I="KeyI",d.J="KeyJ",d.K="KeyK",d.L="KeyL",d.M="KeyM",d.N="KeyN",d.O="KeyO",d.P="KeyP",d.Q="KeyQ",d.R="KeyR",d.S="KeyS",d.T="KeyT",d.U="KeyU",d.V="KeyV",d.W="KeyW",d.X="KeyX",d.Y="KeyY",d.Z="KeyZ",d.KeyA="KeyA",d.KeyB="KeyB",d.KeyC="KeyC",d.KeyD="KeyD",d.KeyE="KeyE",d.KeyF="KeyF",d.KeyG="KeyG",d.KeyH="KeyH",d.KeyI="KeyI",d.KeyJ="KeyJ",d.KeyK="KeyK",d.KeyL="KeyL",d.KeyM="KeyM",d.KeyN="KeyN",d.KeyO="KeyO",d.KeyP="KeyP",d.KeyQ="KeyQ",d.KeyR="KeyR",d.KeyS="KeyS",d.KeyT="KeyT",d.KeyU="KeyU",d.KeyV="KeyV",d.KeyW="KeyW",d.KeyX="KeyX",d.KeyY="KeyY",d.KeyZ="KeyZ",d.Minus="Minus",d.Period="Period",d.Quote="Quote",d.Semicolon="Semicolon",d.Slash="Slash",d.AltLeft="AltLeft",d.AltRight="AltRight",d.Alt="Alt",d.AltGraph="AltGraph",d.Backspace="Backspace",d.CapsLock="CapsLock",d.ContextMenu="ContextMenu",d.ControlLeft="ControlLeft",d.ControlRight="ControlRight",d.Enter="Enter",d.MetaLeft="MetaLeft",d.MetaRight="MetaRight",d.ShiftLeft="ShiftLeft",d.ShiftRight="ShiftRight",d.Space="Space",d.Tab="Tab",d.Convert="Convert",d.KanaMode="KanaMode",d.NonConvert="NonConvert",d.Delete="Delete",d.End="End",d.Help="Help",d.Home="Home",d.Insert="Insert",d.PageDown="PageDown",d.PageUp="PageUp",d.Up="ArrowUp",d.Down="ArrowDown",d.Left="ArrowLeft",d.Right="ArrowRight",d.ArrowUp="ArrowUp",d.ArrowDown="ArrowDown",d.ArrowLeft="ArrowLeft",d.ArrowRight="ArrowRight",d.NumLock="NumLock",d.Numpad0="Numpad0",d.Numpad1="Numpad1",d.Numpad2="Numpad2",d.Numpad3="Numpad3",d.Numpad4="Numpad4",d.Numpad5="Numpad5",d.Numpad6="Numpad6",d.Numpad7="Numpad7",d.Numpad8="Numpad8",d.Numpad9="Numpad9",d.Num0="Numpad0",d.Num1="Numpad1",d.Num2="Numpad2",d.Num3="Numpad3",d.Num4="Numpad4",d.Num5="Numpad5",d.Num6="Numpad6",d.Num7="Numpad7",d.Num8="Numpad8",d.Num9="Numpad9",d.NumAdd="NumpadAdd",d.NumpadAdd="NumpadAdd",d.NumDecimal="NumpadDecimal",d.NumpadDecimal="NumpadDecimal",d.NumDivide="NumpadDivide",d.NumpadDivide="NumpadDivide",d.NumEnter="NumpadEnter",d.NumpadEnter="NumpadEnter",d.NumMultiply="NumpadMultiply",d.NumpadMultiply="NumpadMultiply",d.NumSubtract="NumpadSubtract",d.NumpadSubtract="NumpadSubtract",d.Esc="Escape",d.Escape="Escape",d.F1="F1",d.F2="F2",d.F3="F3",d.F4="F4",d.F5="F5",d.F6="F6",d.F7="F7",d.F8="F8",d.F9="F9",d.F10="F10",d.F11="F11",d.F12="F12",d.F13="F13",d.F14="F14",d.F15="F15",d.F16="F16",d.F17="F17",d.F18="F18",d.F19="F19",d.F20="F20",d.PrintScreen="PrintScreen",d.ScrollLock="ScrollLock",d.Pause="Pause",d.Unidentified="Unidentified"})(so||(so={}));class Nr extends At{constructor(t,i,n){super(),this.key=t,this.value=i,this.originalEvent=n}}class R_{constructor(){this.events=new $t,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=t=>{for(const i of this._keys){const n=new Nr(i,t.key,t);this.events.emit("up",n),this.events.emit("release",n)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=t=>{if(!this._enabled)return;!t.metaKey&&(this._keys.includes(so.MetaLeft)||this._keys.includes(so.MetaRight))&&this._releaseAllKeys(t);const i=t.code;if(this._keys.indexOf(i)===-1){this._keys.push(i),this._keysDown.push(i);const n=new Nr(i,t.key,t);this.events.emit("down",n),this.events.emit("press",n)}},this._handleKeyUp=t=>{if(!this._enabled)return;const i=t.code,n=this._keys.indexOf(i);this._keys.splice(n,1),this._keysUp.push(i);const o=new Nr(i,t.key,t);this.events.emit("up",o),this.events.emit("release",o),t.key==="Meta"&&this._releaseAllKeys(t)}}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}init(t){let{global:i}=t;const{grabWindowFocus:n}=t;i||(I_()?(i=window,n&&window.focus(),dt.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):i=window.top),i.addEventListener("blur",()=>{this._keys.length=0}),i.addEventListener("keyup",this._handleKeyUp),i.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(t){this._enabled=t}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let t=0;t<this._keys.length;t++)this.events.emit("hold",new Nr(this._keys[t]))}getKeys(){return this._keys}wasPressed(t){return this._enabled?this._keysDown.indexOf(t)>-1:!1}isHeld(t){return this._enabled?this._keys.indexOf(t)>-1:!1}wasReleased(t){return this._enabled?this._keysUp.indexOf(t)>-1:!1}triggerEvent(t,i,n){t==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:i,key:n??null})),t==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:i,key:n??null}))}}class rr{static fromPagePosition(t,i,n){let o,h,c,_;arguments.length===3?(o=t,h=i,c=new k(o,h),_=n):(c=t,o=c.x,h=c.y,_=i);const p=_.screen.pageToScreenCoordinates(c),v=_.screen.screenToWorldCoordinates(p);return new rr(v,c,p)}constructor(t,i,n){this.worldPos=t,this.pagePos=i,this.screenPos=n}}class Gr{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(t,i,n,o,h,c){this.type=t,this.pointerId=i,this.button=n,this.pointerType=o,this.coordinates=h,this.nativeEvent=c,this.active=!0}}class D_{cancel(){this.active=!1}constructor(t,i,n,o,h,c,_,p,v,x,b,S){this.x=t,this.y=i,this.pageX=n,this.pageY=o,this.screenX=h,this.screenY=c,this.index=_,this.deltaX=p,this.deltaY=v,this.deltaZ=x,this.deltaMode=b,this.ev=S,this.active=!0}}class Wl{constructor(){this.events=new $t,this.lastPagePos=k.Zero,this.lastScreenPos=k.Zero,this.lastWorldPos=k.Zero,this._onPointerMove=t=>{this.lastPagePos=new k(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new k(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new k(t.worldPos.x,t.worldPos.y)},this._onPointerDown=t=>{this.lastPagePos=new k(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new k(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new k(t.worldPos.x,t.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_updateWorldPosition(t){const i=rr.fromPagePosition(this.lastPagePos,t);this.lastScreenPos=i.screenPos,this.lastWorldPos=i.worldPos}}var ir;(function(d){d.Pixel="Pixel",d.Line="Line",d.Page="Page"})(ir||(ir={}));var Zs;(function(d){d[d.NoButton=-1]="NoButton",d[d.Left=0]="Left",d[d.Middle=1]="Middle",d[d.Right=2]="Right",d[d.Unknown=3]="Unknown"})(Zs||(Zs={}));var Ts;(function(d){d.Left="Left",d.Middle="Middle",d.Right="Right",d.Unknown="Unknown",d.NoButton="NoButton"})(Ts||(Ts={}));var Es;(function(d){d.Touch="Touch",d.Mouse="Mouse",d.Pen="Pen",d.Unknown="Unknown"})(Es||(Es={}));function Qv(d){return globalThis.TouchEvent&&d instanceof globalThis.TouchEvent}function Jv(d){return globalThis.PointerEvent&&d instanceof globalThis.PointerEvent}class Wa{constructor(t,i){this.target=t,this.engine=i,this.events=new $t,this.primary=new Wl,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(t){this._enabled=t}recreate(t,i){const n=new Wa(t,i);return n.primary=this.primary,n._pointers=this._pointers,n}at(t){if(t>=this._pointers.length)for(let i=this._pointers.length-1,n=t;i<n;i++)this._pointers.push(new Wl);return this._pointers[t]}count(){return this._pointers.length}isDown(t){var i;return this._enabled&&(i=this.currentFramePointerDown.get(t))!==null&&i!==void 0?i:!1}wasDown(t){var i;return this._enabled&&(i=this.lastFramePointerDown.get(t))!==null&&i!==void 0?i:!1}isDragging(t){return this._enabled?this.isDown(t):!1}isDragStart(t){return this._enabled?this.isDown(t)&&!this.wasDown(t):!1}isDragEnd(t){return this._enabled?!this.isDown(t)&&this.wasDown(t):!1}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const t of this.currentFrameDown){if(!t.active)continue;this.emit("down",t),this.at(t.pointerId).emit("down",t),this.primary.emit("pointerdown",t)}for(const t of this.currentFrameUp){if(!t.active)continue;this.emit("up",t),this.at(t.pointerId).emit("up",t)}for(const t of this.currentFrameMove){if(!t.active)continue;this.emit("move",t),this.at(t.pointerId).emit("move",t)}for(const t of this.currentFrameCancel){if(!t.active)continue;this.emit("cancel",t),this.at(t.pointerId).emit("cancel",t)}for(const t of this.currentFrameWheel)t.active&&(this.emit("pointerwheel",t),this.emit("wheel",t),this.primary.emit("pointerwheel",t),this.primary.emit("wheel",t));if(this.engine.currentScene.camera.hasChanged())for(const t of this._pointers)t._updateWorldPosition(this.engine)}clear(){for(const t of this.currentFrameUp){this.currentFramePointerCoords.delete(t.pointerId);const i=this._activeNativePointerIdsToNormalized.entries();for(const[n,o]of i)o===t.pointerId&&this._activeNativePointerIdsToNormalized.delete(n)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(t){var i;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const n={passive:!(this.engine.pageScrollPreventionMode===Js.All||this.engine.pageScrollPreventionMode===Js.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,n):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,n):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,n),((i=t?.grabWindowFocus)!==null&&i!==void 0?i:!0)&&I_()){const h=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",h):(this.target.addEventListener("touchstart",h),this.target.addEventListener("mousedown",h))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(t){this._activeNativePointerIdsToNormalized.set(t,-1);const n=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((o,h)=>o-h).findIndex(o=>o===t);return this._activeNativePointerIdsToNormalized.set(t,n),n}_handle(t){if(!this._enabled)return;t.preventDefault();const i=new Map;let n,o;if(Qv(t)){n=Ts.Unknown,o=Es.Touch;for(let h=0;h<t.changedTouches.length;h++){const c=t.changedTouches[h],_=rr.fromPagePosition(c.pageX,c.pageY,this.engine),p=h+1,v=this._normalizePointerId(p);this.currentFramePointerCoords.set(v,_),i.set(v,_)}}else{n=this._nativeButtonToPointerButton(t.button),o=Es.Mouse;const h=rr.fromPagePosition(t.pageX,t.pageY,this.engine);let c=1;Jv(t)&&(c=t.pointerId,o=this._stringToPointerType(t.pointerType));const _=this._normalizePointerId(c);this.currentFramePointerCoords.set(_,h),i.set(_,h)}for(const[h,c]of i.entries())switch(t.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new Gr("down",h,n,o,c,t)),this.currentFramePointerDown.set(h,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new Gr("up",h,n,o,c,t)),this.currentFramePointerDown.set(h,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new Gr("move",h,n,o,c,t));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new Gr("cancel",h,n,o,c,t));break}}_handleWheel(t){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Js.All||this.engine.pageScrollPreventionMode===Js.Canvas&&t.target===this.engine.canvas)&&t.preventDefault();const i=this.engine.screen.pageToScreenCoordinates(N(t.pageX,t.pageY)),n=this.engine.screen.screenToWorldCoordinates(i),o=-1/40,h=t.deltaX||t.wheelDeltaX*o||0,c=t.deltaY||t.wheelDeltaY*o||t.wheelDelta*o||t.detail||0,_=t.deltaZ||0;let p=ir.Pixel;t.deltaMode&&(t.deltaMode===1?p=ir.Line:t.deltaMode===2&&(p=ir.Page));const v=new D_(n.x,n.y,t.pageX,t.pageY,i.x,i.y,0,h,c,_,p,t);this.currentFrameWheel.push(v)}triggerEvent(t,i){const n=this.engine.screen.worldToPageCoordinates(i);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+t,{pointerId:0,clientX:n.x,clientY:n.y})):this._handle(new window.MouseEvent("mouse"+t,{clientX:n.x,clientY:n.y}));const o=this.engine.currentScene.world.get(Ha);o.preupdate(this.engine.currentScene,1),o.update(1)}_nativeButtonToPointerButton(t){switch(t){case Zs.NoButton:return Ts.NoButton;case Zs.Left:return Ts.Left;case Zs.Middle:return Ts.Middle;case Zs.Right:return Ts.Right;case Zs.Unknown:return Ts.Unknown;default:return vf(t)}}_stringToPointerType(t){switch(t){case"touch":return Es.Touch;case"mouse":return Es.Mouse;case"pen":return Es.Pen;default:return Es.Unknown}}}class qc{constructor(t){this._enabled=!0;const{pointerTarget:i,grabWindowFocus:n,engine:o}=t;this.keyboard=new R_,this.pointers=new Wa(i,o),this.gamepads=new Oa,this.keyboard.init({grabWindowFocus:n}),this.pointers.init({grabWindowFocus:n}),this.gamepads.init(),this.inputMapper=new E_({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(t){this._enabled=t,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class Kv{}const $v={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function ts(d){var t,i;return!!d?.prototype&&!!(!((i=(t=d?.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class bi{get actors(){return this.world.entityManager.entities.filter(t=>t instanceof ii)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(t=>t instanceof w_)}get tileMaps(){return this.world.entityManager.entities.filter(t=>t instanceof c_)}get timers(){return this._timers}constructor(){this._logger=dt.getInstance(),this.events=new $t,this.camera=new v_,this.world=new C_(this),this.physics=new T_(Ms()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(Nc),this.world.add(new Ua(this.world,this.physics)),this.world.add(new za(this.world,this.physics)),this.world.add(Ha),this.world.add(Gc),this.world.add(Xc),this.world.add(Hc),this.world.add(Oc)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}onPreLoad(t){}onTransition(t){}onInitialize(t){}onActivate(t){}onDeactivate(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreDraw(t,i){}onPostDraw(t,i){}_initializeChildren(){for(const t of this.entities)t._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(t){var i;if(!this.isInitialized){try{this.engine=t,this.physics.config=this.engine.physics,this.input=new qc({pointerTarget:t.pointerScope===Mn.Canvas?t.canvas:document,grabWindowFocus:t.grabWindowFocus,engine:t}),this.camera._initialize(t),this.world.systemManager.initialize(),await this.onInitialize(t),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,t),this.events.emit("initialize",new gr(t,this))}catch(n){throw this._logger.error(`Error during scene initialization for scene ${(i=t.director)===null||i===void 0?void 0:i.getSceneName(this)}!`),n}this._isInitialized=!0}}async _activate(t){var i,n;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(t)}catch(o){throw this._logger.error(`Error during scene activation for scene ${(n=(i=this.engine)===null||i===void 0?void 0:i.director)===null||n===void 0?void 0:n.getSceneName(this)}!`),o}}async _deactivate(t){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(t)}_preupdate(t,i){this.emit("preupdate",new tn(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.emit("postupdate",new en(t,i,this)),this.onPostUpdate(t,i)}_predraw(t,i){this.emit("predraw",new fr(t,i,this)),this.onPreDraw(t,i)}_postdraw(t,i){this.emit("postdraw",new _r(t,i,this)),this.onPostDraw(t,i)}update(t,i){var n;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(n=t.director)===null||n===void 0?void 0:n.getSceneName(this)}!`);return}this._preupdate(t,i);let o,h;for(o=0,h=this._cancelQueue.length;o<h;o++)this.removeTimer(this._cancelQueue[o]);this._cancelQueue.length=0;for(const c of this._timers)c.update(i);this.world.update(vi.Update,i),this.camera&&this.camera.update(t,i),this._collectActorStats(t),this._postupdate(t,i),this.input.update()}draw(t,i){var n;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(t,i),this.world.update(vi.Draw,i),!((n=this.engine)===null||n===void 0)&&n.isDebug&&this.debugDraw(t),this._postdraw(t,i)}debugDraw(t){this.emit("predebugdraw",new cc(t,this)),this.emit("postdebugdraw",new dc(t,this))}contains(t){return this.actors.indexOf(t)>-1}add(t){if(this.emit("entityadded",{target:t}),t instanceof Rn){mf(this._timers,t)||this.addTimer(t);return}this.world.add(t),t.scene=this}transfer(t){let i;t instanceof Ye&&t.scene&&t.scene!==this&&(i=t.scene,t.scene.world.remove(t,!1)),t instanceof Rn&&t.scene&&(i=t.scene,t.scene.removeTimer(t)),i?.emit("entityremoved",{target:t}),this.add(t)}remove(t){this.emit("entityremoved",{target:t}),t instanceof Ye&&(t.isActive&&t.kill(),this.world.remove(t)),t instanceof Rn&&this.removeTimer(t)}clear(t=!0){for(let i=this.entities.length-1;i>=0;i--)this.world.remove(this.entities[i],t);for(let i=this.timers.length-1;i>=0;i--)this.removeTimer(this.timers[i])}addTimer(t){return this._timers.push(t),t.scene=this,t}removeTimer(t){const i=this._timers.indexOf(t);return i!==-1&&this._timers.splice(i,1),t}cancelTimer(t){return this._cancelQueue.push(t),t}isTimerActive(t){return this._timers.indexOf(t)>-1&&!t.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(t){const i=this.actors;for(let n=0;n<i.length;n++){const o=i[n];o instanceof Uc&&t.stats.currFrame.actors.ui++,t.stats.currFrame.actors.alive++;for(let h=0;h<o.children.length;h++){const c=o.children[h];l_(c)?t.stats.currFrame.actors.ui++:t.stats.currFrame.actors.alive++}}}}var Dn;(function(d){d.Protanope="Protanope",d.Deuteranope="Deuteranope",d.Tritanope="Tritanope"})(Dn||(Dn={}));const tw=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class F_{constructor(t,i){this._shader=new di({gl:t,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:i}),this._shader.compile(),this._buffer=new us({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new Us({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class M_{constructor(t,i=!1){this._colorBlindnessMode=t,this._simulate=!1,this._simulate=i}initialize(t){this._shader=new F_(t,tw),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(t){if(this._colorBlindnessMode=t,this._shader){const i=this._shader.getShader();i.use(),this._colorBlindnessMode===Dn.Protanope?i.setUniformInt("u_type",0):this._colorBlindnessMode===Dn.Deuteranope?i.setUniformInt("u_type",1):this._colorBlindnessMode===Dn.Tritanope&&i.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(t){if(this._simulate=t,this._shader){const i=this._shader.getShader();i.use(),i.setUniformBoolean("u_simulate",t)}}get simulate(){return this._simulate}}class B_{constructor(t){this._engine=t,this._colorBlindPostProcessor=new M_(Dn.Protanope)}correct(t){this._engine.graphicsContext instanceof Fs&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(t){this._engine.graphicsContext instanceof Fs&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class k_{constructor(t){this.stats={currFrame:new no,prevFrame:new no},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:K.Yellow,showZIndex:!1,showScale:!1,scaleColor:K.Green,showRotation:!1,rotationColor:K.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:K.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:K.Blue,showOwner:!1,showGeometry:!0,geometryColor:K.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:K.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:K.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:K.Yellow,showAcceleration:!1,accelerationColor:K.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:K.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:K.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:K.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:K.Yellow,positionSize:1,showGrid:!1,gridColor:K.Red,gridWidth:1,showColliderGeometry:!0},this._engine=t,this.colorBlindMode=new B_(this._engine)}useTestClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const n=t.toTestClock();return i&&n.start(),this._engine.clock=n,n}useStandardClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const n=t.toStandardClock();return i&&n.start(),this._engine.clock=n,n}}class no{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new Va,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(t){t?(this.id=t.id,this.elapsedMs=t.elapsedMs,this.fps=t.fps,this.actors.alive=t.actors.alive,this.actors.killed=t.actors.killed,this.actors.ui=t.actors.ui,this.duration.update=t.duration.update,this.duration.draw=t.duration.draw,this._physicsStats.reset(t.physics),this.graphics.drawCalls=t.graphics.drawCalls,this.graphics.drawnImages=t.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const t=new no;return t.reset(this),t}get id(){return this._id}set id(t){this._id=t}get elapsedMs(){return this._elapsedMs}set elapsedMs(t){this._elapsedMs=t}get fps(){return this._fps}set fps(t){this._fps=t}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class Va{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(t){t?(this.pairs=t.pairs,this.collisions=t.collisions,this.contacts=t.contacts,this.fastBodies=t.fastBodies,this.fastBodyCollisions=t.fastBodyCollisions,this.broadphase=t.broadphase,this.narrowphase=t.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const t=new Va;return t.reset(this),t}get pairs(){return this._pairs}set pairs(t){this._pairs=t}get collisions(){return this._collisions}set collisions(t){this._collisions=t}get contacts(){return this._contacts}set contacts(t){this._contacts=t}get fastBodies(){return this._fastBodies}set fastBodies(t){this._fastBodies=t}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(t){this._fastBodyCollisions=t}get broadphase(){return this._broadphase}set broadphase(t){this._broadphase=t}get narrowphase(){return this._narrowphase}set narrowphase(t){this._narrowphase=t}}class Vl{on(t,i){this._nativeHandlers[t]&&this.off(t,this._nativeHandlers[t]),this._nativeHandlers[t]=this._decorate(i),this.nativeComponent.addEventListener(t,this._nativeHandlers[t])}off(t,i){i||(i=this._nativeHandlers[t]),this.nativeComponent.removeEventListener(t,i),this._nativeHandlers[t]=null}_decorate(t){return i=>{this._paused||t(i)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const t in this._nativeHandlers)this.off(t)}constructor(t){this.nativeComponent=t,this._paused=!1,this._nativeHandlers={}}}class L_{constructor(t,i){this._windowGlobal=t,this._documentGlobal=i,this._windowComponent=new Vl(this._windowGlobal),this._documentComponent=new Vl(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const U_={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:xe.Blended,canvasImageRendering:"auto"},z_={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:xe.Blended,canvasImageRendering:"auto"};class H_{constructor(t){var i;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=t.initialFps,this._samplePeriod=(i=t.samplePeriod)!==null&&i!==void 0?i:this._samplePeriod,this._currentFrameTime=1e3/t.initialFps,this._nowFn=t.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const t=this._nowFn();this._currentFrameTime=t-this._beginFrameTime,t>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(t-this._previousSampleTime),this._previousSampleTime=t,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class Yc{constructor(t){var i,n,o;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=t,this.tick=t.tick,this._lastTime=(i=this.now())!==null&&i!==void 0?i:0,this._maxFps=(n=t.maxFps)!==null&&n!==void 0?n:this._maxFps,this._onFatalException=(o=t.onFatalException)!==null&&o!==void 0?o:this._onFatalException,this.fpsSampler=new H_({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new O_({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new jc({...this._options})}setFatalExceptionHandler(t){this._onFatalException=t}schedule(t,i=0,n="preframe"){const o=this._totalElapsed+i;this._scheduledCbs.push([t,o,n])}__runScheduledCbs(t="preframe"){for(let i=this._scheduledCbs.length-1;i>-1;i--)t===this._scheduledCbs[i][2]&&this._scheduledCbs[i][1]<=this._totalElapsed&&(this._scheduledCbs[i][0](this._elapsed),this._scheduledCbs.splice(i,1))}update(t){try{this.fpsSampler.start();const i=this.now();let n=i-this._lastTime||1;const o=1e3/this._maxFps;if(n>=o){let h=0;o!==0&&(h=n%o,n=n-h),n>200&&(n=1),this._elapsed=t||n,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(t||n),this.__runScheduledCbs("postframe"),o!==0?this._lastTime=i-h:this._lastTime=i,this.fpsSampler.end()}}catch(i){this._onFatalException(i),this.stop()}}}class jc extends Yc{constructor(t){super(t),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const t=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(t),this.update()}catch(i){throw window.cancelAnimationFrame(this._requestId),i}};t()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class O_ extends Yc{constructor(t){super({...t}),this._logger=dt.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=t.defaultUpdateMs}now(){var t;return(t=this._currentTime)!==null&&t!==void 0?t:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(t){const i=t??this._updateMs;this._running?(this.update(i),this._currentTime+=i):this._logger.warn("The clock is not running, no step will be performed")}run(t,i){for(let n=0;n<t;n++)this.step(i??this._updateMs)}}var ew=Re(296);class W_{constructor(){this._toasterCss=ew.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(t){const i=document.createElement("span");return i.innerText=t,i}toast(t,i,n){this._initialize();const o=document.createElement("div");o.className="ex-toast-message";const h=t.split("[LINK]").map(x=>this._createFragment(x));if(i){const x=document.createElement("a");x.href=i,n?x.innerText=n:x.innerText=i,h.splice(1,0,x)}const c=document.createElement("div");h.forEach(x=>{c.appendChild(x)}),o.appendChild(c);const _=document.createElement("button");_.innerText="x",_.addEventListener("click",()=>{this._container.removeChild(o)}),o.appendChild(_);const p=x=>{if(x.key==="Escape")try{this._container.removeChild(o)}catch{}document.removeEventListener("keydown",p)};document.addEventListener("keydown",p);const v=this._container.firstChild;this._container.insertBefore(o,v)}}const iw={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class V_{get isTransitioning(){return this._isTransitioning}constructor(t,i){this._engine=t,this.events=new $t,this._logger=dt.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new bi,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const n in i){const o=i[n];this.add(n,o),n==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const t=this._deferredGoto;this._deferredGoto=void 0;const i=this._deferredTransition;this._deferredTransition=void 0;const n=this.getSceneInstance(t);n&&i&&i._addToTargetScene(this._engine,n),await this.swapScene(t),n&&i&&await this.playTransition(i,n)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(t,i){const n=i?.loader;n instanceof Jr?this.mainLoader=n:Dl(n)?this.mainLoader=new n:this.mainLoader=new Un;let o;if(i?.inTransition){const{inTransition:h}=i;o=h}if(this.startScene=t,o){const h=this.getSceneInstance(this.startScene);h&&(o._addToTargetScene(this._engine,h),this.swapScene(this.startScene).then(()=>this.playTransition(o,h)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(t){return this._sceneToLoader.get(t)}_getInTransition(t){var i;const n=this.scenes[t];if(!(n instanceof bi||ts(n)))return(i=n?.transitions)===null||i===void 0?void 0:i.in}_getOutTransition(t){var i;const n=this.scenes[t];if(!(n instanceof bi||ts(n)))return(i=n?.transitions)===null||i===void 0?void 0:i.out}getDeferredScene(){const t=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&t?t:null}getSceneDefinition(t){const i=this.scenes[t];if(i instanceof bi||ts(i))return i;if(i)return i.scene}getSceneName(t){for(const[i,n]of Object.entries(this.scenes))if(n instanceof bi){if(t===n)return i}else if(!ts(n)&&t===n.scene)return i;for(const[i,n]of Object.entries(this.scenes))if(ts(n)){if(t.constructor===n)return i}else if(!(n instanceof bi)&&t.constructor===n.scene)return i;return null}assertAdded(t){return this}assertRemoved(t){return this}add(t,i){if(!(i instanceof bi)&&!ts(i)){const{loader:n,transitions:o}=i,{in:h,out:c}=o??{};this._sceneToTransition.set(t,{in:h,out:c}),Dl(n)?this._sceneToLoader.set(t,new n):n&&this._sceneToLoader.set(t,n)}return this.scenes[t]&&this._logger.warn("Scene",t,"already exists overwriting"),this.scenes[t]=i,this.assertAdded(t)}remove(t){if(t instanceof bi||ts(t)){const i=t;for(const n in this.scenes)if(this.scenes.hasOwnProperty(n)){const o=this.scenes[n];let h;if(o instanceof bi||ts(o)?h=o:h=o.scene,h===i){if(n===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${n}`);this._sceneToInstance.delete(n),this._sceneToTransition.delete(n),this._sceneToLoader.delete(n),delete this.scenes[n]}}}if(typeof t=="string"){if(t===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${t}`);this._sceneToInstance.delete(t),this._sceneToTransition.delete(t),this._sceneToLoader.delete(t),delete this.scenes[t]}}async goToScene(t,i){var n,o,h,c,_,p;const v=this.getSceneInstance(t);if(!v){this._logger.warn(`Scene ${t} does not exist! Check the name, are you sure you added it?`);return}const x=this.currentScene,b=this.currentSceneName,S=(o=(n=this._engine.input)===null||n===void 0?void 0:n.enabled)!==null&&o!==void 0?o:!0;this._isTransitioning=!0;const P=(h=this.getSceneInstance(b))===null||h===void 0?void 0:h.onTransition("out"),I=v?.onTransition("in");i={sourceOut:(c=this._getOutTransition(this.currentSceneName))!==null&&c!==void 0?c:P,destinationIn:(_=this._getInTransition(t))!==null&&_!==void 0?_:I,...i};const{sourceOut:F,destinationIn:R,sceneActivationData:T}=i,M=F??this._getOutTransition(this.currentSceneName),W=R??this._getInTransition(t),U=M?.hideLoader||W?.hideLoader;U&&this.maybeLoadScene(t,U),this._emitEvent("navigationstart",b,t),M&&await this.playTransition(M,x),await this.maybeLoadScene(t,U),W&&await W.onPreviousSceneDeactivate(this.currentScene),W&&W._addToTargetScene(this._engine,v),await this.swapScene(t,T),this._emitEvent("navigation",b,t),W&&await this.playTransition(W,v),this._emitEvent("navigationend",b,t),(p=this._engine.input)===null||p===void 0||p.toggleEnabled(S),this._isTransitioning=!1}getSceneInstance(t){const i=this.getSceneDefinition(t);if(!i)return;if(this._sceneToInstance.has(t))return this._sceneToInstance.get(t);if(i instanceof bi)return this._sceneToInstance.set(t,i),i;const n=new i;return this._sceneToInstance.set(t,n),n}async maybeLoadScene(t,i=!1){var n;const o=(n=this._getLoader(t))!==null&&n!==void 0?n:new Jr,h=this.getSceneDefinition(t),c=this.getSceneInstance(t);h&&c&&!this._loadedScenes.has(c)&&(c.onPreLoad(o),c.events.emit("preload",{loader:o}),i?this._engine.load(o,i):await this._engine.load(o),this._loadedScenes.add(c))}async playTransition(t,i){var n,o,h,c,_,p,v;if(!this.isInitialized){this._deferredTransition=t;return}if(t){this.currentTransition=t;const x=(o=(n=i.input)===null||n===void 0?void 0:n.enabled)!==null&&o!==void 0?o:!0;(h=i.input)===null||h===void 0||h.toggleEnabled(!t.blockInput),(c=this._engine.input)===null||c===void 0||c.toggleEnabled(!t.blockInput),this.currentTransition._addToTargetScene(this._engine,i),await this.currentTransition._play(),(_=i.input)===null||_===void 0||_.toggleEnabled(x)}(p=this.currentTransition)===null||p===void 0||p.kill(),(v=this.currentTransition)===null||v===void 0||v.reset(),this.currentTransition=void 0}async swapScene(t,i){const n=this._engine;if(!this.isInitialized){this._deferredGoto=t;return}const o=this.getSceneInstance(t);if(o){const h=this.currentScene,c=o;if(this._logger.debug("Going to scene:",t),this.currentScene.isInitialized){const v={engine:n,previousScene:h,nextScene:c};await this.currentScene._deactivate(v),this.currentScene.events.emit("deactivate",new bc(v,this.currentScene)),this.currentScene.input.clear()}const _=this._sceneToLoader.get(t);await _?.areResourcesLoaded(),this.currentScene=c,this.currentSceneName=t,n.screen.setCurrentCamera(c.camera),await this.currentScene._initialize(n);const p={engine:n,previousScene:h,nextScene:c,data:i};await this.currentScene._activate(p),this.currentScene.events.emit("activate",new xc(p,this.currentScene))}else this._logger.error("Scene",t,"does not exist!")}_emitEvent(t,i,n){const o=this.getSceneDefinition(i),h=this.getSceneDefinition(n);this.events.emit(t,{sourceScene:o,sourceName:i,destinationScene:h,destinationName:n})}}function N_(){const d={scope:(t,i)=>{const n=d.value;d.value=t;try{return i()}catch(o){throw o}finally{d.value=n}},value:void 0};return d}function G_(d){return d.value}const Nl={textureCollectInterval:6e4};class X_{constructor(t){this.options=t,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=i=>{if(this._running){for(const[n,[o,h]]of this._collectors.entries()){const c=this.options.getTimestamp();for(const[_,[p,v]]of this._collectionMap.entries()){if(n!==p||v+h>=c)continue;o(_)&&this._collectionMap.delete(_)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(t,i,n){this._collectors.set(t,[n,i])}addCollectableResource(t,i){this._collectionMap.set(i,[t,this.options.getTimestamp()])}touch(t){const i=this._collectionMap.get(t);i&&this._collectionMap.set(t,[i[0],this.options.getTimestamp()])}forceCollectAll(){for(const[t,[i]]of this._collectors.entries())for(const[n]of this._collectionMap.entries())i(n)&&this._collectionMap.delete(n)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}ff();const sw={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Js;(function(d){d[d.None=0]="None",d[d.Canvas=1]="Canvas",d[d.All=2]="All"})(Js||(Js={}));class ai{static useEngine(){const t=G_(ai.Context);if(!t)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return t}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(t){this.graphicsContext.snapToPixel=t}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,n,o,h,c,_,p,v,x;this.scope=U=>ai.Context.scope(this,U),this.version=Gl,this.events=new $t,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=U=>{dt.getInstance().fatal(U,U.stack)},this._toaster=new W_,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=U=>{var G;U.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",U);const j=document.createElement("div");j.id="ex-webgl-graphics-context-lost",j.style.position="absolute",j.style.zIndex="99",j.style.left="50%",j.style.top="50%",j.style.display="flex",j.style.flexDirection="column",j.style.transform="translate(-50%, -50%)",j.style.backgroundColor="white",j.style.padding="10px",j.style.borderStyle="solid 1px";const X=document.createElement("div");if(X.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,j.appendChild(X),!((G=this.canvas)===null||G===void 0)&&G.parentElement){this.canvas.parentElement.appendChild(j);const rt=X.querySelector("#ex-webgl-graphics-reload");rt?.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new yi,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],t={...ai._DEFAULT_ENGINE_OPTIONS,...t},this._originalOptions=t,Be.freeze(),this.browser=new L_(window,document);const b=new Ff;if(!t.suppressMinimumBrowserFeatureDetection&&!(this._compatible=b.test())){const U=document.createElement("div");if(U.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(U),b.failedTests.forEach(function(G){const j=document.createElement("div");j.innerText="Browser feature missing "+G,document.body.appendChild(j)}),t.canvasElementId){const G=document.getElementById(t.canvasElementId);G&&G.parentElement.removeChild(G)}return}else this._compatible=!0;if(console.log&&!t.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${Gl})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),t.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=dt.getInstance(),this._logger.defaultLevel===be.Debug&&b.logBrowserFeatures(),this._logger.debug("Building engine..."),t.garbageCollection===!0?this.garbageCollectorConfig={...Nl}:t.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...Nl,...t.garbageCollection},this._garbageCollector=new X_({getTimestamp:Date.now}),this.canvasElementId=t.canvasElementId,t.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+t.canvasElementId),document.getElementById(t.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(t.canvasElementId)}else t.canvasElement?(this._logger.debug("Using Canvas element specified:",t.canvasElement),this.canvas=t.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!t.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",U=>{U.preventDefault()});let S=(i=t.displayMode)!==null&&i!==void 0?i:Te.Fixed;t.width&&t.height||t.viewport?(t.displayMode===void 0&&(S=Te.Fixed),this._logger.debug("Engine viewport is size "+t.width+" x "+t.height)):t.displayMode||(this._logger.debug("Engine viewport is fit"),S=Te.FitScreen),this.grabWindowFocus=t.grabWindowFocus,this.pointerScope=t.pointerScope,this._originalDisplayMode=S;let P,I,F,R,T,M;typeof t.antialiasing=="object"?{pixelArtSampler:P,nativeContextAntialiasing:F,multiSampleAntialiasing:M,filtering:T,canvasImageRendering:R}={...t.pixelArt?z_:U_,...t.antialiasing}:(P=!!t.pixelArt,F=!1,M=t.antialiasing,R=t.antialiasing?"auto":"pixelated",T=t.antialiasing?xe.Blended:xe.Pixel),F&&M&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),t.pixelArt&&(I=.25),(!t.antialiasing||T===xe.Pixel)&&(I=0),I=(o=(n=t.uvPadding)!==null&&n!==void 0?n:I)!==null&&o!==void 0?o:.01;let W=Be.isEnabled("use-canvas-context");if(!W)try{this.graphicsContext=new Fs({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:P,antialiasing:F,multiSampleAntialiasing:M,uvPadding:I,powerPreference:t.powerPreference,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(h=t.handleContextLost)!==null&&h!==void 0?h:this._handleWebGLContextLost,handleContextRestored:t.handleContextRestored})}catch(U){this._logger.warn(`Excalibur could not load webgl for some reason (${U.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),W=!0}W&&(this.graphicsContext=new Aa({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:F,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting})),this.screen=new Rl({canvas:this.canvas,context:this.graphicsContext,antialiasing:F,canvasImageRendering:R,browser:this.browser,viewport:(c=t.viewport)!==null&&c!==void 0?c:t.width&&t.height?{width:t.width,height:t.height}:Il.SVGA,resolution:t.resolution,displayMode:S,pixelRatio:t.suppressHiDPIScaling?1:(_=t.pixelRatio)!==null&&_!==void 0?_:null}),re.filtering=T,t.backgroundColor&&(this.backgroundColor=t.backgroundColor.clone()),this.maxFps=(p=t.maxFps)!==null&&p!==void 0?p:this.maxFps,this.fixedUpdateTimestep=(v=t.fixedUpdateTimestep)!==null&&v!==void 0?v:this.fixedUpdateTimestep,this.fixedUpdateFps=(x=t.fixedUpdateFps)!==null&&x!==void 0?x:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new jc({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:U=>this.onFatalException(U)}),this.enableCanvasTransparency=t.enableCanvasTransparency,typeof t.physics=="boolean"?this.physics={...Ms(),enabled:t.physics}:(this.physics={...Ms()},da(this.physics,t.physics)),this.debug=new k_(this),this.director=new V_(this,t.scenes),this._initialize(t),window.___EXCALIBUR_DEVTOOL=this,ai.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:t}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:i,showPlayerMessage:n}=this._originalOptions.configurePerformanceCanvas2DFallback;if(i===void 0&&(i=ai._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),n===void 0&&(n=ai._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!Be.isEnabled("use-canvas-context")&&t&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===i.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let o=0;for(let c=0;c<this._fpsSamples.length;c++)o+=this._fpsSamples[c];const h=o/this._fpsSamples.length;this._fpsSamples.length===i.numberOfFrames&&h<=i.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),n&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var t,i,n;const o=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(o,this.canvas),this.canvas=o;const h={...this._originalOptions,antialiasing:this.screen.antialiasing},c=this._originalDisplayMode;this.graphicsContext=new Aa({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:h.antialiasing,backgroundColor:h.backgroundColor,snapToPixel:h.snapToPixel,useDrawSorting:h.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new Rl({canvas:this.canvas,context:this.graphicsContext,antialiasing:(t=h.antialiasing)!==null&&t!==void 0?t:!0,browser:this.browser,viewport:(i=h.viewport)!==null&&i!==void 0?i:h.width&&h.height?{width:h.width,height:h.height}:Il.SVGA,resolution:h.resolution,displayMode:c,pixelRatio:h.suppressHiDPIScaling?1:(n=h.pixelRatio)!==null&&n!==void 0?n:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const _=h&&h.pointerScope===Mn.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(_,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,ai.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(t){if(t<0){dt.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=t}addTimer(t){return this.currentScene.addTimer(t)}removeTimer(t){return this.currentScene.removeTimer(t)}addScene(t,i){return this.director.add(t,i),this}removeScene(t){this.director.remove(t)}add(t){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const i=this.director.getDeferredScene();i instanceof bi?i.add(t):this.currentScene.add(t)}remove(t){t instanceof Ye&&this.currentScene.remove(t),(t instanceof bi||ts(t))&&this.removeScene(t),typeof t=="string"&&this.removeScene(t)}async goToScene(t,i){await this.scope(async()=>{await this.director.goToScene(t,i)})}screenToWorldCoordinates(t){return this.screen.screenToWorldCoordinates(t)}worldToScreenCoordinates(t){return this.screen.worldToScreenCoordinates(t)}_initialize(t){var i,n;this.pageScrollPreventionMode=t.scrollPreventionMode;const o=t&&t.pointerScope===Mn.Document?document:this.canvas,h=(n=(i=this._originalOptions)===null||i===void 0?void 0:i.grabWindowFocus)!==null&&n!==void 0?n:!0;this.input=new qc({pointerTarget:o,grabWindowFocus:h,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new wc(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new vc(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!t.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(t){this._inputEnabled=t,this.input.toggleEnabled(this._inputEnabled)}onInitialize(t){}get isInitialized(){return this._isInitialized}async _overrideInitialize(t){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(t),this.events.emit("initialize",new gr(t,this)),this._isInitialized=!0)}_update(t){var i;if(this._isLoading){(i=this._loader)===null||i===void 0||i.onUpdate(this,t),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(t),this.currentScene.update(this,t),this.graphicsContext.updatePostProcessors(t),this.clock.__runScheduledCbs("postupdate"),this._postupdate(t),this.input.update()}_preupdate(t){this.emit("preupdate",new tn(this,t,this)),this.onPreUpdate(this,t)}onPreUpdate(t,i){}_postupdate(t){this.emit("postupdate",new en(this,t,this)),this.onPostUpdate(this,t)}onPostUpdate(t,i){}_draw(t){var i,n;if(this.graphicsContext.backgroundColor=(i=this.currentScene.backgroundColor)!==null&&i!==void 0?i:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,t),this._isLoading){this._hideLoader||((n=this._loader)===null||n===void 0||n.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,t),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,t),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(t,i){this.emit("predraw",new fr(t,i,this)),this.onPreDraw(t,i)}onPreDraw(t,i){}_postdraw(t,i){this.emit("postdraw",new _r(t,i,this)),this.onPostDraw(t,i)}onPostDraw(t,i){}showDebug(t){this._isDebug=t}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(t,i){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let n;return t instanceof Jr?n=t:typeof t=="string"&&(this.director.configureStart(t,i),n=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(n??new Un),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new oc(this)),this._isReadyFuture.promise})}_mainloop(t){this.scope(()=>{this.emit("preframe",new uc(this,this.stats.prevFrame));const i=t*this.timescale;this.currentFrameElapsedMs=i;const n=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=n,this.stats.currFrame.elapsedMs=i,this.stats.currFrame.fps=this.clock.fpsSampler.fps,Kt.clear();const o=this.clock.now(),h=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=i;this._lagMs>=h;)this._update(h),this._lagMs-=h;else this._update(i);const c=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(i);const _=this.clock.now();this.stats.currFrame.duration.update=c-o,this.stats.currFrame.duration.draw=_-c,this.stats.currFrame.graphics.drawnImages=Kt.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=Kt.DrawCallCount,this.emit("postframe",new fc(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new ac(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(t=!1){return new Promise(n=>{this._screenShotRequests.push({preserveHiDPIResolution:t,resolve:n})})}_checkForScreenShots(){for(const t of this._screenShotRequests){const i=t.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,n=t.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,o=document.createElement("canvas");o.width=i,o.height=n;const h=o.getContext("2d");h.imageSmoothingEnabled=this.screen.antialiasing,h.drawImage(this.canvas,0,0,i,n);const c=new Image,_=o.toDataURL("image/png");c.onload=()=>{t.resolve(c)},c.src=_}this._screenShotRequests.length=0}async load(t,i=!1){await this.scope(async()=>{try{if(t.isLoaded())return;this._loader=t,this._isLoading=!0,this._hideLoader=i,t instanceof Un&&(t.suppressPlayButton=t.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await t.load()}catch(n){this._logger.error("Error loading resources, things may not behave properly",n),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}ai.Context=N_();ai.InstanceCount=0;ai._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:Mn.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Js.Canvas,backgroundColor:K.fromHex("#2185d0")};class nw extends ii{set maxWidth(t){this._text.maxWidth=t}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(t){this._font=t,this._text.font=t}get text(){return this._text.text}set text(t){this._text.text=t}get color(){return this._text.color}set color(t){this._text&&(this._text.color=t)}get opacity(){return this.graphics.opacity}set opacity(t){this.graphics.opacity=t}get spriteFont(){return this._spriteFont}set spriteFont(t){t&&(this._spriteFont=t,this._text.font=this._spriteFont)}constructor(t){super(t),this._font=new Bn,this._text=new co({text:"",font:this._font});const{text:i,pos:n,x:o,y:h,spriteFont:c,font:_,color:p,maxWidth:v}={text:"",...t};this.pos=n??(o&&h?N(o,h):this.pos),this.text=i??this.text,this.font=_??this.font,this.maxWidth=v??this.maxWidth,this.spriteFont=c??this.spriteFont,this._text.color=p??this.color;const x=this.get(he);x.anchor=k.Zero,x.use(this._text)}_initialize(t){super._initialize(t)}getTextWidth(){return this._text.width}}var Ks;(function(d){d.Circle="circle",d.Rectangle="rectangle"})(Ks||(Ks={}));class rw extends ii{constructor(t){var i,n;super({width:(i=t.width)!==null&&i!==void 0?i:0,height:(n=t.height)!==null&&n!==void 0?n:0}),this._particlesToEmit=0,this._particlePool=new oo(()=>new Da({}),I=>I,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=Ks.Rectangle,this.radius=0,this.particle={life:2e3,transform:Gi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:o,x:h,y:c,z:_,pos:p,isEmitting:v,emitRate:x,emitterType:b,radius:S,random:P}={...t};this.particle={...this.particle,...o},this.pos=p??N(h??0,c??0),this.z=_??0,this.isEmitting=v??this.isEmitting,this.emitRate=x??this.emitRate,this.emitterType=b??this.emitterType,this.radius=S??this.radius,this.body.collisionType=_t.PreventCollision,this.random=P??new lr}removeParticle(t){this.deadParticles.push(t)}emitParticles(t){var i;if(!(t<=0)){t=t|0;for(let n=0;n<t;n++){const o=this._createParticle();!((i=this===null||this===void 0?void 0:this.scene)===null||i===void 0)&&i.world&&(this.particle.transform===Gi.Global?this.scene.world.add(o):this.addChild(o)),this._activeParticles.push(o)}}}clearParticles(){for(let t=0;t<this._activeParticles.length;t++)this.removeParticle(this._activeParticles[t])}_createParticle(){let t=0,i=0;const n=es(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),o=es(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),h=this.particle.startSize||es(this.particle.minSize||5,this.particle.maxSize||5,this.random),c=o*Math.cos(n),_=o*Math.sin(n);if(this.emitterType===Ks.Rectangle)t=es(0,this.width,this.random),i=es(0,this.height,this.random);else if(this.emitterType===Ks.Circle){const v=es(0,this.radius,this.random);t=v*Math.cos(n),i=v*Math.sin(n)}const p=this._particlePool.rent();return p.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:N(t,i),vel:N(c,_),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:h,graphic:this.particle.graphic,fade:this.particle.fade}),p.registerEmitter(this),this.particle.randomRotation&&(p.transform.rotation=es(0,Math.PI*2,this.random)),this.particle.focus&&(p.focus=this.particle.focus.add(N(this.pos.x,this.pos.y)),p.focusAccel=this.particle.focusAccel),p}update(t,i){var n;super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let o=0;o<this.deadParticles.length;o++){!((n=this===null||this===void 0?void 0:this.scene)===null||n===void 0)&&n.world&&(this.scene.world.remove(this.deadParticles[o],!1),this._particlePool.return(this.deadParticles[o]));const h=this._activeParticles.indexOf(this.deadParticles[o]);h>-1&&this._activeParticles.splice(h,1)}this.deadParticles.length=0}}function ow(d,t){}class Sa{constructor(t,i,n){var o;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=t,this.particle=n,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=i,this._particleLife=(o=this.particle.life)!==null&&o!==void 0?o:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(t,i){if(this._initialized)return;const n=this.emitter.maxParticles,o=this._numInputFloats,h=this._particleData,c=4,_=t.createBuffer(),p=t.createVertexArray();t.bindVertexArray(p),t.bindBuffer(t.ARRAY_BUFFER,_),t.bufferData(t.ARRAY_BUFFER,n*o*c,t.DYNAMIC_DRAW),t.bufferSubData(t.ARRAY_BUFFER,0,h);let v=0;t.vertexAttribPointer(0,2,t.FLOAT,!1,o*c,0),v+=c*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*c,v),v+=c*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*c,v),v+=c*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(p),this._buffers.push(_),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null);const x=t.createBuffer(),b=t.createVertexArray();t.bindVertexArray(b),t.bindBuffer(t.ARRAY_BUFFER,x),t.bufferData(t.ARRAY_BUFFER,n*o*c,t.DYNAMIC_DRAW),v=0,t.vertexAttribPointer(0,2,t.FLOAT,!1,o*c,0),v+=c*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*c,v),v+=c*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*c,v),v+=c*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*c,v),v+=c*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(b),this._buffers.push(x),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(t){const i=this._particleIndex,n=this.maxParticles*this._numInputFloats,o=t*this._numInputFloats+i;for(let h=i;h<o;h+=this._numInputFloats){const c=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||Ae),_=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),p=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),v=_*Math.cos(c),x=p*Math.sin(c);let b=0,S=0;if(this.emitter.emitterType===Ks.Rectangle)b=this._random.floating(-.5,.5)*this.emitter.width,S=this._random.floating(-.5,.5)*this.emitter.height;else{const F=this._random.floating(0,this.emitter.radius);b=F*Math.cos(c),S=F*Math.sin(c)}const P=this.emitter.transform.apply(N(b,S)),I=[this.particle.transform===Gi.Local?b:P.x,this.particle.transform===Gi.Local?S:P.y,v,x,this.particle.randomRotation?es(0,Ae,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(I,h%this._particleData.length)}o>=n?(this._wrappedParticles+=(o-n)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=t),this._particleIndex=o%n,this._emitted.push([this._particleLife,i])}_uploadEmitted(t){this._particleIndex!==this._uploadIndex&&(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),t.bindBuffer(t.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(t){var i;if(this._particleLife=(i=this.particle.life)!==null&&i!==void 0?i:this._particleLife,this._wrappedLife>0?this._wrappedLife-=t:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let n=this._emitted.length-1;n>=0;n--){const o=this._emitted[n];o[0]-=t,o[0]<=0&&this._emitted.splice(n,1)}this._emitted.sort((n,o)=>n[0]-o[0])}}draw(t){if(this._initialized){if(this._clearRequested?(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData),t.bindBuffer(t.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(t),t.bindVertexArray(this._currentVao),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const i=this._emitted[0][1]/this._numInputFloats;t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-i)*this._numInputFloats*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,i,this.maxParticles-i),t.endTransformFeedback(),t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,i),t.endTransformFeedback()}else t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,this.maxParticles),t.endTransformFeedback();t.bindVertexArray(null),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}Sa.GPU_MAX_PARTICLES=1e5;class aw extends ii{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get z(){return this.transform.z}set z(t){this.transform.z=t}constructor(t){super({name:"GpuParticleEmitter",width:t.width,height:t.height}),this.particle={life:2e3,transform:Gi.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new he,this.isEmitting=!1,this.emitRate=1,this.emitterType=Ks.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:i,maxParticles:n,x:o,y:h,z:c,pos:_,isEmitting:p,emitRate:v,emitterType:x,radius:b,random:S}={...t};this.maxParticles=St(n??this.maxParticles,0,Sa.GPU_MAX_PARTICLES),this.pos=_??N(o??0,h??0),this.z=c??0,this.isEmitting=p??this.isEmitting,this.emitRate=v??this.emitRate,this.emitterType=x??this.emitterType,this.radius=b??this.radius,this.particle={...this.particle,...i},this.random=S??new lr,this.renderer=new Sa(this,this.random,this.particle)}_initialize(t){super._initialize(t);const i=t.graphicsContext;this.renderer.initialize(i.__gl,i)}update(t,i){super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(i)}emitParticles(t){t<=0||this.renderer.emitParticles(t|0)}clearParticles(){this.renderer.clearParticles()}draw(t,i){t.draw("ex.particle",this.renderer,i)}}class q_ extends Ye{getGraphics(){return this._graphics}addGraphic(t,i){this._graphics.push(t),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,i?.offset&&(this._gfx.offset=i.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let t=this._tileBounds.clone();for(const i of this._graphics){const n=N(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:i.height-this.map.tileHeight));t=t.combine(i.localBounds.translate(n))}return t}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&this._graphics.splice(i,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(N(this.x,this.y))}get center(){return this.pos.add(N(0,this.map.tileHeight/2))}constructor(t,i,n,o){super([new nt,new he({offset:n??k.Zero,onPostDraw:(S,P)=>this.draw(S,P)}),new eo(o)]),this.solid=!1,this.events=new $t,this._tileBounds=new ct,this._graphics=[],this._colliders=[],this.data=new Map,this.x=t,this.y=i,this.map=o,this._transform=this.get(nt),this._isometricEntityComponent=this.get(eo);const h=this.map.tileWidth/2,c=this.map.tileHeight/2,_=(this.x-this.y)*h,p=(this.x+this.y)*c;this._transform.pos=N(_,p),this._isometricEntityComponent.elevation=o.elevation,this._gfx=this.get(he),this._gfx.isVisible=!1;const v=this.map.tileWidth,x=this.map.tileHeight,b=N(0,this.map.renderFromTopOfGraphic?x:0);this._gfx.localBounds=this._tileBounds=new ct({left:-v/2,top:-x,right:v/2,bottom:x}).translate(b)}draw(t,i){const n=this.map.tileWidth/2;t.save(),t.translate(-n,0);for(const o of this._graphics)o.draw(t,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:o.height-this.map.tileHeight));t.restore()}}class hw extends Ye{get visible(){return this.isVisible}set visible(t){this.isVisible=t}constructor(t){super([new nt,new Et({type:_t.Fixed}),new we,new $s,new La((x,b)=>this.debug(x,b),!1)],t.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=N(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:i,tileWidth:n,tileHeight:o,columns:h,rows:c,renderFromTopOfGraphic:_,graphicsOffset:p,elevation:v}=t;this.transform=this.get(nt),i&&(this.transform.pos=i),this.collider=this.get(we),this.collider&&this.collider.set(this._composite=new Ie([])),this.pointer=this.get($s),this.renderFromTopOfGraphic=_??this.renderFromTopOfGraphic,this.graphicsOffset=p??this.graphicsOffset,this.elevation=v??this.elevation,this.tileWidth=n,this.tileHeight=o,this.columns=h,this.rows=c,this._pointerEventDispatcher=new zc,this.tiles=new Array(h*c);for(let x=0;x<c;x++)for(let b=0;b<h;b++){const S=new q_(b,x,this.graphicsOffset,this);this.tiles[b+x*h]=S,this.addChild(S),this._pointerEventDispatcher.addObject(S,P=>this.getTileByPoint(P.worldPos)===S,()=>!0)}this.pointer.localBounds=ct.fromDimension(n*h*this.transform.scale.x,o*c*this.transform.scale.y,N(.5,0))}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:k.Zero;{const n=t.offset;return this._originalOffsets.set(t,n),n}}updateColliders(){this._composite.clearColliders();const t=this.get(nt).pos;for(const i of this.tiles)if(i.solid)for(const n of i.getColliders()){const o=this._getOrSetColliderOriginalOffset(n);n.offset=this.tileToWorld(N(i.x,i.y)).sub(t).add(o).sub(N(this.tileWidth/2,this.tileHeight)),n.owner=this,this._composite.addCollider(n)}this.collider.update()}worldToTile(t){t=t.sub(this.transform.globalPos);const i=this.tileWidth/2,n=this.tileHeight/2;return N(~~((t.x/i+t.y/n)/2),~~((t.y/n-t.x/i)/2))}tileToWorld(t){const i=this.tileWidth/2,n=this.tileHeight/2,o=(t.x-t.y)*i,h=(t.x+t.y)*n;return N(o,h).add(this.transform.pos)}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const i=this.worldToTile(t);return this.getTile(i.x,i.y)}_getMaxZIndex(){let t=Number.NEGATIVE_INFINITY;for(const i of this.tiles){const n=i.get(nt).z;n>t&&(t=n)}return t}debug(t,i){const{showAll:n,showPosition:o,positionColor:h,positionSize:c,showGrid:_,gridColor:p,gridWidth:v,showColliderGeometry:x}=i.isometric,{geometryColor:b,geometryLineWidth:S,geometryPointSize:P}=i.collider;if(t.save(),t.z=this._getMaxZIndex()+.5,n||_){for(let I=0;I<this.rows+1;I++){const F=this.tileToWorld(N(0,I)),R=this.tileToWorld(N(this.columns,I));t.drawLine(F,R,p,v)}for(let I=0;I<this.columns+1;I++){const F=this.tileToWorld(N(I,0)),R=this.tileToWorld(N(I,this.rows));t.drawLine(F,R,p,v)}}if(n||o)for(const I of this.tiles)t.drawCircle(this.tileToWorld(N(I.x,I.y)),c,h);if(n||x){for(const I of this.tiles)if(I.solid)for(const F of I.getColliders())F.debug(t,b,{lineWidth:S,pointSize:P})}t.restore()}}class Zc{constructor(t,i){this.id=Vt(),this._stopped=!1,this._sequenceBuilder=i,this._sequenceContext=new po(t),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(t){this._actionQueue.update(t)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(t){return new Zc(t,this._sequenceBuilder)}}class lw{constructor(t){this.id=Vt(),this._actions=t}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}isComplete(t){return this._actions.every(i=>i.isComplete(t))}reset(){this._actions.forEach(t=>t.reset())}stop(){this._actions.forEach(t=>t.stop())}}class $n{constructor(t,i){this.bounds=t,this.options=i,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...i},this.halfWidth=t.width/2,this.halfHeight=t.height/2}_split(){this._isDivided=!0;const t={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new $n(new ct({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),t),this.topRight=new $n(new ct({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),t),this.bottomLeft=new $n(new ct({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),t),this.bottomRight=new $n(new ct({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),t)}_insertIntoSubNodes(t){var i,n,o,h;!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.insert(t),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.topRight.insert(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.insert(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.insert(t)}insert(t){if(this._isDivided){this._insertIntoSubNodes(t);return}if(this.items.push(t),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const i of this.items)this._insertIntoSubNodes(i);this.items.length=0}}remove(t){var i,n,o,h;if(this.bounds.overlaps(t.bounds)){if(!this._isDivided){const c=this.items.indexOf(t);c>-1&&this.items.splice(c,1);return}!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.remove(t),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(t.bounds)&&this.topRight.remove(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.remove(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.remove(t)}}query(t){let i=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(t)&&(i=i.concat(this.topLeft.query(t))),this.topRight.bounds.overlaps(t)&&(i=i.concat(this.topRight.query(t))),this.bottomLeft.bounds.overlaps(t)&&(i=i.concat(this.bottomLeft.query(t))),this.bottomRight.bounds.overlaps(t)&&(i=i.concat(this.bottomRight.query(t)))),i=i.filter((n,o)=>i.indexOf(n)>=o),i}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let t=this.items;return this._isDivided&&(t=t.concat(this.topLeft.getAllItems()),t=t.concat(this.topRight.getAllItems()),t=t.concat(this.bottomLeft.getAllItems()),t=t.concat(this.bottomRight.getAllItems())),t=t.filter((i,n)=>t.indexOf(i)>=n),t}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(t){this.bounds.draw(t,K.Yellow),this._isDivided&&(this.topLeft.bounds.draw(t,K.Yellow),this.topRight.bounds.draw(t,K.Yellow),this.bottomLeft.bounds.draw(t,K.Yellow),this.bottomRight.bounds.draw(t,K.Yellow))}}function cw(d){return!!d._initialize}function dw(d){return!!d.onAdd}function uw(d){return!!d.onRemove}function fw(d){return!!d.onInitialize}function _w(d){return!!d._preupdate}function gw(d){return!!d.onPreUpdate}function pw(d){return!!d.onPostUpdate}function mw(d){return!!d.onPostUpdate}function vw(d){return!!d.onAdd}function ww(d){return!!d.onRemove}function xw(d){return!!d.onPreDraw}function bw(d){return!!d.onPostDraw}class Aw{constructor(t,i=!1){this.path=t,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new ao(t,"arraybuffer",i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){const t=await this._resource.load();this._stream=new Y_(t),this._gif=new j_(this._stream);const i=this._gif.images.map(n=>new as(n.src,!1));return await Promise.all(i.map(n=>n.load())),this.data=this._images=i,this._sprites=this._images.map(n=>n.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(t=0){var i;return(i=this._sprites[t])!==null&&i!==void 0?i:null}toSpriteSheet(){const t=this._sprites;return t.length?new En({sprites:t}):null}toAnimation(t){var i;const n=(i=this._gif)===null||i===void 0?void 0:i.images;if(n?.length){const o=n.map((h,c)=>{var _;return{graphic:this._sprites[c],duration:((_=this._gif)===null||_===void 0?void 0:_.frames[c].delayMs)||void 0}});return this._animation=new Hi({frames:o,frameDuration:t}),this._animation}return null}get readCheckBytes(){var t,i;return(i=(t=this._gif)===null||t===void 0?void 0:t.checkBytes)!==null&&i!==void 0?i:[]}}const na=d=>d.reduce(function(t,i){return t*2+i},0),gl=d=>{const t=[];for(let i=7;i>=0;i--)t.push(!!(d&1<<i));return t};class Y_{constructor(t){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=i=>{const n=[];for(let o=0;o<i;o++)n.push(this.readByte());return n},this.read=i=>{let n="";for(let o=0;o<i;o++)n+=String.fromCharCode(this.readByte());return n},this.readUnsigned=()=>{const i=this.readBytes(2);return(i[1]<<8)+i[0]},this.data=new Uint8Array(t),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const yw=function(d,t){let i=0;const n=function(S){let P=0;for(let I=0;I<S;I++)t.charCodeAt(i>>3)&1<<(i&7)&&(P|=1<<I),i++;return P},o=[],h=1<<d,c=h+1;let _=d+1,p=[];const v=function(){p=[],_=d+1;for(let S=0;S<h;S++)p[S]=[S];p[h]=[],p[c]=null};let x=0,b=0;for(;;){if(b=x,x=n(_),x===h){v();continue}if(x===c)break;if(x<p.length)b!==h&&p.push(p[b].concat(p[x][0]));else{if(x!==p.length)throw new Error("Invalid LZW code.");p.push(p[b].concat(p[b][0]))}o.push.apply(o,p[x]),p.length===1<<_&&_<12&&_++}return o};class j_{constructor(t){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=i=>{const n=[];for(let o=0;o<i;o++){const h=this._st.readBytes(3);n.push(h)}return n},this.readSubBlocks=()=>{let i,n;n="";do i=this._st.readByte(),n+=this._st.read(i);while(i!==0);return n},this.parseHeader=()=>{const i={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(i.sig=this._st.read(3),i.ver=this._st.read(3),i.sig!=="GIF")throw new Error("Not a GIF file.");i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned(),this._currentFrameCanvas.width=i.width,this._currentFrameCanvas.height=i.height;const n=gl(this._st.readByte());i.gctFlag=n.shift(),i.colorResolution=na(n.splice(0,3)),i.sortedFlag=n.shift(),i.globalColorTableSize=na(n.splice(0,3)),i.backgroundColorIndex=this._st.readByte(),i.pixelAspectRatio=this._st.readByte(),i.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<i.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(i)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=i=>{const n=p=>{this.checkBytes.push(this._st.readByte());const v=gl(this._st.readByte());return p.reserved=v.splice(0,3),p.disposalMethod=na(v.splice(0,3)),p.userInputFlag=v.shift(),p.transparentColorFlag=v.shift(),p.delayTime=this._st.readUnsigned(),p.transparentColorIndex=this._st.readByte(),p.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(p)&&this.checkBytes.push(this._handler.gce),p},o=p=>{p.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(p)&&this.checkBytes.push(this._handler.com)},h=p=>{this.checkBytes.push(this._st.readByte()),p.ptHeader=this._st.readBytes(12),p.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(p)&&this.checkBytes.push(this._handler.pte)},c=p=>{const v=b=>{this.checkBytes.push(this._st.readByte()),b.unknown=this._st.readByte(),b.iterations=this._st.readUnsigned(),b.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(b)&&this.checkBytes.push(this._handler.app)},x=b=>{b.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[b.identifier]&&this._handler.app[b.identifier](b)&&this.checkBytes.push(this._handler.app[b.identifier])};switch(this.checkBytes.push(this._st.readByte()),p.identifier=this._st.read(8),p.authCode=this._st.read(3),p.identifier){case"NETSCAPE":v(p);break;default:x(p);break}},_=p=>{p.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(p)&&this.checkBytes.push(this._handler.unknown)};switch(i.label=this._st.readByte(),i.label){case 249:i.extType="gce",this._gce=n(i);break;case 254:i.extType="com",o(i);break;case 1:i.extType="pte",h(i);break;case 255:i.extType="app",c(i);break;default:i.extType="unknown",_(i);break}},this.parseImg=i=>{var n;const o=(_,p)=>{const v=new Array(_.length),x=_.length/p,b=(F,R)=>{const T=_.slice(R*p,(R+1)*p);v.splice.apply(v,[F*p,p].concat(T))},S=[0,4,2,1],P=[8,8,4,2];let I=0;for(let F=0;F<4;F++)for(let R=S[F];R<x;R+=P[F])b(R,I),I++;return v};i.leftPos=this._st.readUnsigned(),i.topPos=this._st.readUnsigned(),i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned();const h=gl(this._st.readByte());i.lctFlag=h.shift(),i.interlaced=h.shift(),i.sorted=h.shift(),i.reserved=h.splice(0,2),i.lctSize=na(h.splice(0,3)),i.lctFlag&&(i.lctBytes=this.parseColorTableBytes(1<<i.lctSize+1)),i.lzwMinCodeSize=this._st.readByte();const c=this.readSubBlocks();i.pixels=yw(i.lzwMinCodeSize,c),i.interlaced&&(i.pixels=o(i.pixels,i.width)),!((n=this._gce)===null||n===void 0)&&n.delayTime&&(i.delayMs=this._gce.delayTime*10),this.frames.push(i),this.arrayToImage(i,i.lctFlag?i.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(i)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const i={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(i.sentinel)){case"!":i.type="ext",this.parseExt(i);break;case",":i.type="img",this.parseImg(i);break;case";":i.type="eof",this._handler.eof&&this._handler.eof(i)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+i.sentinel.toString(16))}i.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(i,n)=>{var o,h,c,_;const p=document.createElement("canvas");p.width=i.width,p.height=i.height;const v=p.getContext("2d"),x=v.getImageData(0,0,p.width,p.height);let b=-1;!((o=this._gce)===null||o===void 0)&&o.transparentColorFlag&&(b=this._gce.transparentColorIndex);for(let P=0;P<i.pixels.length;P++){const I=i.pixels[P],F=n[I];I===b?x.data.set([0,0,0,0],P*4):x.data.set([...F,255],P*4)}if(v.putImageData(x,0,0),((h=this._gce)===null||h===void 0?void 0:h.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((c=this._gce)===null||c===void 0?void 0:c.disposalMethod)===2&&(!((_=this._hdr)===null||_===void 0)&&_.gctFlag)){const P=n[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${P[0]}, ${P[1]}, ${P[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(p,i.leftPos,i.topPos,i.width,i.height);const S=new Image;S.src=this._currentFrameCanvas.toDataURL(),this.images.push(S)},this._st=t,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class Cw{constructor(t,i,{bustCache:n,...o}={}){this.path=t,this.family=i,this._isLoaded=!1,this._resource=new ao(t,"blob",n),this._options=o}async load(){if(this.isLoaded())return this.data;try{const t=await this._resource.load(),i=URL.createObjectURL(t);this.data||(this.data=new FontFace(this.family,`url(${i})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(t){throw`Error loading FontSource from path '${this.path}' with error [${t.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(t){return new Bn({family:this.family,...this._options,...t})}}const tf=N_(),Sw=/^\s*(?:function)?\*/;function ef(d){return typeof d!="function"?!1:Sw.test(Function.prototype.toString.call(d))?!0:Object.getPrototypeOf?Object.getPrototypeOf(d)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function Z_(...d){var t;const i=dt.getInstance();let n,o,h,c;ef(d[0])&&(o=globalThis,n=d[0],h=d[1]),ef(d[1])&&(o=d[0],n=d[1],h=d[2]),d[1]instanceof ai&&(o=d[0],c=d[1],n=d[2],h=d[3]),d[0]instanceof ai&&(o=globalThis,c=d[0],n=d[1],h=d[2]);const _=G_(tf),p=h?.timing,v=_?!1:(t=h?.autostart)!==null&&t!==void 0?t:!0;let x;try{x=c??ai.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let b=!1,S=!1,P=!1;const I=n.bind(o),F=I();let R;const T=new Promise((W,U)=>{R=G=>{try{if(P){S=!0,W();return}const{done:j,value:X}=tf.scope(!0,()=>F.next(G));if(j||P){S=!0,W();return}X instanceof Promise?X.then(()=>{x.clock.schedule(R,0,p)}):X===void 0||X===void 0?x.clock.schedule(R,0,p):x.clock.schedule(R,X||0,p)}catch(j){U(j);return}},v&&(b=!0,R(x.clock.elapsed()))}),M={isRunning:()=>b&&!P&&!S,isComplete:()=>S,cancel:()=>{P=!0},start:()=>(b?i.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(I)):(b=!0,R(x.clock.elapsed())),M),generator:F,done:T,then:T.then.bind(T),[Symbol.iterator]:()=>F};return M}class Na extends Ye{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(t){var i,n,o,h;super(),this._logger=dt.getInstance(),this.transform=new nt,this.graphics=new he,this._completeFuture=new yi,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=t.duration,this.easing=(i=t.easing)!==null&&i!==void 0?i:Xt.Linear,this.direction=(n=t.direction)!==null&&n!==void 0?n:"out",this.hideLoader=(o=t.hideLoader)!==null&&o!==void 0?o:!1,this.blockInput=(h=t.blockInput)!==null&&h!==void 0?h:!1,this.transform.coordPlane=Le.Screen,this.transform.pos=k.Zero,this.transform.z=1/0,this.graphics.anchor=k.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(t,i){this.complete||(this._currentDistance+=St(i/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=St(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=St(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(t){}onStart(t){}onUpdate(t){}onEnd(t){}onReset(){}reset(){this.started=!1,this._completeFuture=new yi,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(t,i){const n=i;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),n.world.entityManager.getById(this.id))return this._co;this._engine=t,n.add(this);const o=this;return this._co=Z_(t,function*(){for(;!o.complete;){const h=yield;o.updateTransition(o._engine,h),o._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class Pw extends Na{constructor(t){var i,n;super({...t,duration:(i=t.duration)!==null&&i!==void 0?i:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(n=t.color)!==null&&n!==void 0?n:K.Black}onInitialize(t){this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=new fo({width:t.screen.resolution.width,height:t.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=t}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class Tw extends Na{constructor(t){super({direction:"in",...t}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(t){this.image=await t.engine.screenshot(!0),await this.image.decode()}onInitialize(t){this.engine=t,this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=as.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=N(1/t.screen.pixelRatio,1/t.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class Ew extends Na{constructor(t){var i;super({direction:"in",...t}),this._easing=Xt.Linear,this.name=`Slide#${this.id}`,this.slideDirection=t.slideDirection,this.transform.coordPlane=Le.World,this.graphics.forceOnScreen=!0,this._easing=(i=t.easingFunction)!==null&&i!==void 0?i:this._easing,this._vectorEasing=Xt.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(t){this._image=await t.engine.screenshot(!0),await this._image.decode(),this._screenCover=as.fromHtmlImageElement(this._image).toSprite()}onInitialize(t){switch(this._engine=t,this.slideDirection){case"up":{this._directionOffset=N(0,-t.screen.resolution.height);break}case"down":{this._directionOffset=N(0,t.screen.resolution.height);break}case"left":{this._directionOffset=N(-t.screen.resolution.width,0);break}case"right":{this._directionOffset=N(t.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=N(1/t.screen.pixelRatio,1/t.screen.pixelRatio)}onUpdate(t){this._camera.pos=this._vectorEasing(t,this._destinationCameraPosition,this._startCameraPosition,1)}}class Qc extends ae{constructor(t){super(),this.color=K.Black,this.thickness=1;const{start:i,end:n,color:o,thickness:h}=t;this.start=i,this.end=n,this.color=o??this.color,this.thickness=h??this.thickness,this._localBounds=this._calculateBounds();const{width:c,height:_}=this._localBounds;this.width=c,this.height=_}get localBounds(){return this._localBounds}_calculateBounds(){const t=this.end.sub(this.start).normal(),i=this.thickness/2,n=[this.start.add(t.scale(i)),this.end.add(t.scale(i)),this.end.add(t.scale(-i)),this.start.add(t.scale(-i))];return ct.fromPoints(n)}_drawImage(t,i,n){t.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new Qc({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class Jc extends ur{get points(){return this._points}set points(t){this._points=t;const i=this.minPoint;this.width=this._points.reduce((n,o)=>Math.max(o.x,n),0)-i.x,this.height=this._points.reduce((n,o)=>Math.max(o.y,n),0)-i.y,this.flagDirty()}get minPoint(){const t=this._points.reduce((n,o)=>Math.min(o.x,n),1/0),i=this._points.reduce((n,o)=>Math.min(o.y,n),1/0);return N(t,i)}constructor(t){super(t),this._points=[],this.points=t.points,this.filtering=xe.Blended,this.rasterize()}clone(){return new Jc({points:this.points.map(t=>t.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){if(this.points&&this.points.length){t.beginPath();const i=this.minPoint.negate(),n=this.points[0].add(i);t.moveTo(n.x,n.y),this.points.forEach(o=>{t.lineTo(o.x+i.x,o.y+i.y)}),t.lineTo(n.x,n.y),t.closePath(),this.color&&t.fill(),this.strokeColor&&t.stroke()}}}var Is;(function(d){d.Stretch="stretch",d.Tile="tile",d.TileFit="tile-fit"})(Is||(Is={}));class Kc extends ae{constructor(t){super(t),this._logger=dt.getInstance(),this._config=t,this._imgSource=t.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(t,i=!1){this._config.width=t,i&&this._initialize()}setTargetHeight(t,i=!1){this._config.height=t,i&&this._initialize()}setMargins(t,i,n,o,h=!1){this._config.sourceConfig.leftMargin=t,this._config.sourceConfig.topMargin=i,this._config.sourceConfig.rightMargin=n,this._config.sourceConfig.bottomMargin=o,h&&this._initialize()}setStretch(t,i,n=!1){t==="horizontal"?this._config.destinationConfig.horizontalStretch=i:t==="vertical"?this._config.destinationConfig.verticalStretch=i:(this._config.destinationConfig.horizontalStretch=i,this._config.destinationConfig.verticalStretch=i),n&&this._initialize()}getConfig(){return this._config}_drawTile(t,i,n,o,h,c,_){const p=c||0,v=_||0;let x,b,S,P;const I=this._getNumberOfTiles(i.width,n.x,o),F=this._getNumberOfTiles(i.height,n.y,h);for(let R=0;R<I;R++)for(let T=0;T<F;T++){let{tempSize:M,tempPosition:W}=this._calculateParams(R,I,i.width,n.x,this._config.destinationConfig.horizontalStretch);x=M,b=W,{tempSize:M,tempPosition:W}=this._calculateParams(T,F,i.height,n.y,this._config.destinationConfig.verticalStretch),S=M,P=W,t.drawImage(i,0,0,i.width,i.height,p+b,v+P,x,S)}}_drawImage(t,i,n){this._imgSource.isLoaded()?(this._drawTile(t,this._canvasA,new k(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(t,this._canvasB,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(t,this._canvasC,new k(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(t,this._canvasD,new k(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(t,this._canvasE,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasF,new k(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasG,new k(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasH,new k(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasI,new k(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const t=this._canvasA.getContext("2d");t?.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const i=this._canvasB.getContext("2d");i?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const n=this._canvasC.getContext("2d");n?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const o=this._canvasD.getContext("2d");o?.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const h=this._canvasE.getContext("2d");h?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const c=this._canvasF.getContext("2d");c?.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const _=this._canvasG.getContext("2d");_?.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const p=this._canvasH.getContext("2d");p?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const v=this._canvasI.getContext("2d");v?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new Kc(this._config)}_getNumberOfTiles(t,i,n){switch(n){case Is.Stretch:return 1;case Is.Tile:return Math.ceil(i/t);case Is.TileFit:return Math.ceil(i/t)}}_calculateParams(t,i,n,o,h){switch(h){case Is.Stretch:return{tempPosition:0,tempSize:o};case Is.Tile:return t===i-1?{tempPosition:t*n,tempSize:n-(i*n-o)}:{tempPosition:t*n,tempSize:n};case Is.TileFit:const c=o/i;return{tempPosition:t*c,tempSize:c}}}}class $c extends Hi{constructor(t){super({...t,frames:t.animation.frames.slice(),strategy:t.animation.strategy,frameDuration:t.animation.frameDuration,speed:t.animation.speed,reverse:t.animation.isReversed}),this._ready=new yi,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...t.sourceView},this._tiledWidth=t.width,this._tiledHeight=t.height;const i=[];for(let n=0;n<this.frames.length;n++){const o=this.frames[n].graphic;if(o&&o instanceof Wi){const h=new ho({image:o.image,width:t.width,height:t.height,sourceView:{...o.sourceView},wrapping:t.wrapping,filtering:t.filtering});this.frames[n].graphic=h,h.ready.then(()=>{h.sourceView={...h.sourceView,...this._sourceView}}),i.push(h.ready)}}Promise.all(i).then(()=>this._ready.resolve())}static fromAnimation(t,i){return new $c({width:t.width,height:t.height,...i,animation:t})}_updateSourceView(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof Wi&&(i.sourceView={...i.sourceView,...this._sourceView})}}get sourceView(){return Oi(this._sourceView,()=>this._updateSourceView())}set sourceView(t){this._sourceView=Oi(t,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof Wi&&(i.sourceView.height=this._tiledHeight||i.height,i.destSize.height=this._tiledHeight||i.height,i.sourceView.width=this._tiledWidth||i.width,i.destSize.width=this._tiledWidth||i.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(t){this._tiledWidth=t,this._updateWidthHeight()}set height(t){this._tiledHeight=t,this._updateWidthHeight()}}const Q_=5,or={},Iw=()=>{for(const d in or)or[d]=0},ra=(d,t)=>{const i=Be.isEnabled("suppress-obsolete-message");or[d]<Q_&&!i&&(dt.getInstance().warn(d),console.trace&&t.showStackTrace&&console.trace()),or[d]++};function Rw(d){return d={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...d},function(t,i,n){if(n&&!(typeof n.value=="function"||typeof n.get=="function"||typeof n.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const h=`${`${t.name||""}${t.name&&i?".":""}${i||""}`} is marked obsolete: ${d.message}`+(d.alternateMethod?` Use ${d.alternateMethod} instead`:"");or[h]||(or[h]=0);const c=n?{...n}:t;if(!n){class _ extends c{constructor(...v){ra(h,d),super(...v)}}return _}return n&&n.value?(c.value=function(){return ra(h,d),n.value.apply(this,arguments)},c):(n&&n.get&&(c.get=function(){return ra(h,d),n.get.apply(this,arguments)}),n&&n.set&&(c.set=function(){return ra(h,d),n.set.apply(this,arguments)}),c)}}class Dw{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const t=new yi;return this._queue.push(t),t.promise}dequeue(t){this._queue.shift().resolve(t)}}class Fw{constructor(t){this._count=t,this._waitQueue=new Dw}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(t=1){if(t!==0){for(;t!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),t--;this._count+=t}}}const Gl="0.30.3";ff();C.eKr;C.yVm;C.a7j;C.U_w;C.JF2;C.htg;C.HXL;C.mcg;var mi=C.Agj;C.J3_;C.Wgv;C.u6S;C.x7M;var ze=C.X55;C.m3M;C.aE5;var He=C.YJU;C.eZi;C.GNv;C.Y56;C._0v;C.vhs;C.vrQ;C.Z8b;C.Yfw;C.IcQ;C.kgJ;C.GTT;C.ypY;C.i7d;C.fQ3;C.HlI;C.jlt;C.VQc;C.zD7;C.AUF;C.JoF;C.MlA;C.PZh;C.qA;var Ga=C.CrD;C.dQK;C.D3r;C.Qpo;C.D9n;C.b6v;C.mvh;var cs=C.Bpo,kt=C.Q1f;C.IKv;C.fcV;C.Glf;var td=C.uAl;C.ElT;C.Z8r;C.QSL;C.sPV;C.nAn;C.zCU;C.QrV;C.fF9;C.Jqv;C.d_u;C.xI8;C.yar;C.SP7;C.oRy;C.f5X;C.V1c;C.Mlx;C.ZiM;C.ZCo;C.J5p;C.mL_;C.Guw;C.N5j;C.pgY;C.OP3;C.rl5;C.eod;var Mw=C.q5Z;C.YUC;C.saR;C.hvr;C.Qol;C.Wf4;var sf=C.JCs;C.gJV;C.fWD;C.Va_;var Bw=C.N$8;C._jQ;C.rxj;C.rhv;C.wCu;C.HAp;C.Zy1;C.bkB;C.wfL;C.sVA;C.$Gs;C.CJ0;C.NWh;C.tWi;C.xAj;C.zWh;C.i_4;C.iIx;C.Hxo;var J_=C.c9e,ss=C.KQV;C.weH;C.jXp;C.zzY;C.yRQ;C.MtE;C.rPj;C.KLc;C.Fir;C.V5f;C.Xj7;C.Wud;C.FVg;C.g5Y;C.YQB;C.KPb;C.nHK;C.Jrb;C.TX_;C.Olt;C.r3n;C.Fvk;C.gpR;C.vYh;C.hnk;var ns=C.D2R;C.n1o;C.h9O;C.X5j;C.p3P;C.RLG;C.fBU;C.Adb;var xt=C.bEs;C.wCy;C.CbD;C.x_C;C.pGf;C.ibQ;C.shR;C.Yjk;var kw=C._u1;C.OBI;C.klh;C.s3S;C.D$R;C.xth;var rs=C.JU7;C.h9x;C.N1A;C.e_k;var Lw=C.aHM;C.tlv;C.Vi9;C.ieR;C.$bb;C.VyI;C.imn;C.uqu;C.QnL;C.vnc;var Uw=C.wk_;C.GH0;C._1r;C.l0X;C.bT;C.HHX;C.jtW;C.tjk;C.rWe;C.j9l;var nf=C.l0$,oa=C.sGJ;C.NVp;C.cPK;C.XoL;C.RmF;C.DXI;C.tCD;C.J3D;C.vCJ;C.e6k;C.f9l;C.v9m;C.yRJ;C.EU6;C.m3O;C.Ryz;C.OxP;C.LEs;C.Ec;C.Pi5;C.gmH;C.tS;C.XxX;C.bCz;C.nYS;C.yiT;C.NHl;C.mO8;C.PXI;C.bn5;C.Ywr;C.cMd;C.Bs6;C.G0k;C.pyn;C.QeM;C.aPX;C.ITP;C.BY0;C.MFw;C.sBn;C.S3L;C.XKQ;C.ESI;C.uxz;var pr=C.o8N;C.u_r;C.RlV;C.gVA;var Ps=C.M_G;C.BpG;C.GRB;C.kM6;C.dO8;C.jgM;C.FWq;C.s3j;C.hlw;C.L0q;C.B7e;C.PGN;C.H_X;C.S_d;C._Tq;C.U7E;C.IOH;var ed=C.Z58;C.yh2;C.ff$;C.cWi;var Ai=C.NBt;C.oNz;C.QlU;C.Xey;C.jft;C._r8;C.bTC;C.Mtr;var zw=C.ypk;C.mnM;C.q7S;C.bAZ;var vn=C.ABN;C.VK6;C.Hj2;C.Df8;C.oOx;C.kxk;C.DT1;var si=C.FLG;C.qN_;C.Z37;C.FtL;C.Z6X;C.iQT;C.ziO;C.OEF;C.uuE;C.tiv;C.T$Y;C.EYj;var os=C.nOB;C.Tap;C.FAs;C.B_P;C.aA5;C.J3s;C.Y0Q;var Pa=C.M4G;C.l$l;C.dLy;C.WZP;C.eB6;C.nFK;C.l9z;C.YOF;C.yhB;C.J0N;var bt=C.Miz;C.Bj4;C.Rcs;C.vJ4;C.TqC;C.nM0;C.X1u;C.SpZ;C.DX8;C.Yx$;C.HK4;C.yt5;C.vAR;C.SE$;C.qE8;C.Pz7;C.sX_;C.JuI;C.pxT;C.Nl$;C.zDr;C.OwT;C.P$G;C.mHV;C.kEA;C.Fx_;C.WFC;C.vKu;C.aDq;C.jIg;C.UH3;C.AJO;C.U4;C.xAc;C._3Y;C.K6X;C.C1Y;C.Aw1;C.tm8;C.LBV;C.A8$;C.F5e;C.ran;C.c8L;C.o6M;C.hsx;C.l9E;C.aSf;C.CcK;C.nU8;C.td6;C.Zex;C.bkJ;C.mXP;C.vt$;C.hCA;C.pjR;C.U43;C.pSZ;C.y17;C.Ew7;C.hG1;C.jVr;C._SZ;C.xWn;var rf=C.ehJ,tt=C.t6s;C.Eyn;const Hw={App:void 0},Ow=`
<style> 
   canvas {
       user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      -moz-user-select: none;

      -webkit-touch-callout: none; /* disables long-press context menu on iOS Safari */
   }
</style> 
<div \${==>App}> 
    <canvas id='cnv'> </canvas> 
</div>`;class K_ extends td{config={updateInterval:100,moveTolerance:5,deadZone:10,maxDistance:100,autoRecenter:!0,recenterThreshold:90};upHandler;downHandler;moveHandler;cancelHandler;gestureStartPos=bt.Zero;currentPos=bt.Zero;moveDelta=bt.Zero;lastDirection={x:0,y:0};isActive=!1;isDown=!1;lastEvent=null;updateInterval=null;lastState="idle";onJoystickChange=null;onAdd(t){this.owner=t}init(t={},i){if(this.config={...this.config,...t},i&&(this.onJoystickChange=i),!this.owner)return;const n=this.owner.scene?.engine.input.pointers.primary;n&&(this.downHandler=n.on("down",o=>this.onDown(o)),this.moveHandler=n.on("move",o=>this.onMove(o)),this.upHandler=n.on("up",o=>this.onUp(o)),this.notifyJoystickChange("idle"))}onRemove(t){console.log("closing tc"),this.upHandler?.close(),this.downHandler?.close(),this.moveHandler?.close(),this.clearUpdateInterval()}onDown(t){console.log("tc pointerdown"),this.gestureStartPos=t.worldPos.clone(),this.currentPos=t.worldPos.clone(),this.moveDelta=bt.Zero,this.lastDirection={x:0,y:0},this.isActive=!0,this.isDown=!0,this.lastEvent=t,this.clearUpdateInterval(),this.updateInterval=window.setInterval(()=>{this.processJoystickState()},this.config.updateInterval)}onMove(t){if(this.isDown&&(this.currentPos=t.worldPos.clone(),this.moveDelta=this.currentPos.sub(this.gestureStartPos),this.lastEvent=t,this.config.autoRecenter&&this.lastState==="active")){const i=this.moveDelta.magnitude;if(i>=this.config.deadZone){const n={x:this.moveDelta.x/i,y:this.moveDelta.y/i};if(Math.abs(this.lastDirection.x)>.01||Math.abs(this.lastDirection.y)>.01){const o=this.lastDirection.x*n.x+this.lastDirection.y*n.y;if(Math.acos(Math.max(-1,Math.min(1,o)))*(180/Math.PI)>this.config.recenterThreshold){const c=Math.min(i,this.config.maxDistance/2),_=new bt(n.x*c,n.y*c);this.gestureStartPos=this.currentPos.sub(_),this.moveDelta=_,this.lastDirection=n}}}}}onUp(t){console.log("tc pointerup"),this.isDown&&(this.isDown=!1,this.isActive=!1,this.moveDelta=bt.Zero,this.lastDirection={x:0,y:0},this.lastEvent=null,this.clearUpdateInterval(),this.notifyJoystickChange("idle"))}clearUpdateInterval(){this.updateInterval!==null&&(clearInterval(this.updateInterval),this.updateInterval=null)}processJoystickState(){if(!this.isDown||!this.isActive)return;const t=this.moveDelta.magnitude;let i="idle";t>=this.config.deadZone&&(i="active");const n=Math.min(t,this.config.maxDistance);let o={x:0,y:0};t>0&&(o={x:this.moveDelta.x/t,y:this.moveDelta.y/t},this.lastDirection=o),(i!==this.lastState||i==="active")&&this.notifyJoystickChange(i,o,n),this.lastState=i}notifyJoystickChange(t,i={x:0,y:0},n=0){this.onJoystickChange&&this.onJoystickChange({direction:i,distance:n,state:t,rawEvent:this.lastEvent||void 0})}getJoystickState(){const t=this.moveDelta.magnitude,i=this.isDown&&t>=this.config.deadZone?"active":"idle";let n={x:0,y:0};return t>0&&(n={x:this.moveDelta.x/t,y:this.moveDelta.y/t}),{direction:n,distance:Math.min(t,this.config.maxDistance),state:i,rawEvent:this.lastEvent||void 0}}drawJoystick(t){if(!this.isDown)return;const i=this.gestureStartPos.x,n=this.gestureStartPos.y,o=this.currentPos.x,h=this.currentPos.y;t.beginPath(),t.arc(i,n,this.config.maxDistance,0,Math.PI*2),t.strokeStyle="rgba(255,255,255,0.5)",t.lineWidth=2,t.stroke(),t.beginPath(),t.moveTo(i,n),t.lineTo(o,h),t.strokeStyle="rgba(255,255,255,0.7)",t.lineWidth=3,t.stroke(),t.beginPath(),t.arc(o,h,20,0,Math.PI*2),t.fillStyle="rgba(255,255,255,0.8)",t.fill()}update(t,i){}}const id=new Ga("weapons",4,2),Ww=new Ga("enemy",2,5),$_=new Ga("player",1,10),tg=new Ga("drops",8,1),Vw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEQAAAAiCAYAAADmvn/1AAAAAXNSR0IArs4c6QAAAcBJREFUaIHt2L1qAkEYheFjiiBJ4yXYx8LKOk0uIb21VcpAUlhEsEwl5A4C6cVKglWEYEydIoWCWwpRMNWkWNbiyMfszLc7AZm3W3cchodh/wBlnXHTNHvnRjuPtlG7ZbqXNfU6Kr5/7IybBgA+lysAwHaxAQDM77bec/o0arcMACx/03UsVz8AgO7r2msdzn9iCC4UDENwvjC5B9sguLJgbBCcK4x1kCsEVxSMKwSXF0Y8qYXgfGG0EJwN5uDHoiG4vDBFQ3ASzP6gbAhOgikbgmOYSmgILoPpf12kCwwEwWUwcYfwDuEB8RoiFO8yQvE5RCg+qQrFdxmhY33bVXds30NOtBMMa0+Ym552GnVn721U367U83hvq/psagAgmSUAgF3ynZ64vwm6VSeNgQGARfIBAFhs1gCA291LmA9EDMGFgmEIzhcm92AbBFcWjA2Cc4WxDnKF4IqCcYXg8sKIJ7UQnC+MFoKzwRz8WDQElxemaAhOgtkflA3BSTBlQ3AMUwkNwWUwk+fTdIGBILgMJu4Q3iE8IF5DhOJdRig+hwjFJ1Wh+C4jdKxvu+rqs6nBw+O/fyCaNAamX71Wr+MPZlhfhBfdpjwAAAAASUVORK5CYII=",Nw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAAFACAYAAADNkKWqAAAAAXNSR0IArs4c6QAABchJREFUeJzt3b1uVEcch+FB2TriClyHIlcQiRtAFE5H5QugoKNMQZf0bqNQpYgUiogb8C24IBENQkpP3EebAh2DZzk5XzNzZs55ngbLBd6/xO/V2l7jEFb2/Ori+Pzq4rj241jL3u+HNd1b6wP3jf6nhy9Xe0wl7f1+qEHxsY19trPVEOz9fqhJsZHN/TRvKyHY+/1Qo+zjSvX1rVZDsPf7oWbZRpXrC/uthGDv90MLko8p1/DvfXX3of743S9VhqDUd3SFEJZLNqJS4YvVEsK1XsoihDDf4vGkHv5Q8PqsFcJaXsMnhDDd7NHUEr5YqRDWEr6YEMJ4k8dSa/hiuUJYa/hiQgjDRo+klfDFUoWwlfDFhBD6DY6j1fDF5oaw1fDFhBBO9Y5iK+E7/nv3jLEh2Er4YkIIn5yMYavhi/WFYKvhiwkhfBbAvYQv1oVgL+GLCSF7dnh+dXH85ux++PP9h2R/6Vrxm+Pnd8+OIYSk9wNtOLy9vglvr2/C40dnIYTlIWjlmd/b65s7f6a6vxXd3bBnh+6NP16/DyHMD0Fr4Ystvb8VwgefHOJ3TA1B6+GLbTWEwgenTgLYGQrB1sIX20oIhQ/69QawE4fgr7//yfuIepQKX6zVEAofDBsMYGetEK4VvlgrIRQ+GO/289jzy/NJpckdwlLhe/X01b0Q5t9fSwiX3g97dPKPf+0Qlg5frLUQCh/M1zuCUiGcGrxO7uHXHkLhg+UGx5ArhLWGL1ZbCIUP0hk9ilQhbCV8sbVDuPb9sEWTx1E6BLUNf+/3w5bMHknuENQ+/L3fD1uweCypQ9Da8Pd+P7Qs2WiWhqD14e/9fmhR8vFMDcFctQ5/yv2PH53d/oTJVLXeDy3JNqJcIWxl+GPunxPAVu6HFmQfU6oQtjr8/7t/SgBbvR9qVmxUc0O4leF/6f4xAdzK/VCj4uMaG8KtDv/z+/8vgFu9H2qy2sj6QriX4Z9fnh+/FMC93A+EEC5eXB0vXlzt8ldShvAxhKW+cw7ctdqzjb7ovfzhoWdAQBHFYxOH7/6Djy8I/vDm7qeCQgjkViwycfhu3lyHEEL4+sG3IQQhBMrLHpeh8MWEECglW1Smhi8mhEBuyWOyNHwxIQRySRaR1OGLCSGQ2uJ45A5fTAiBVGZHo3T4YkIILDU5FmuHLyaEwFyjI1Fb+GJCCEw1GIfawxcTQmCs3ii0Fr6YEAJDTmLQevhiQgj0uY3A1sIXE0Igdnj227tjCKdh6MLXegj7wgdweP/76xBCCGffPwohbCeEQ+Hr7gH269C9sZUQCh8w1iF+R6shFD5gqpMAdloJofABc/UGsFNrCIUPWGowgJ1aQih8QCq3r4E7f3I56Vcz9oWwU+r/A4w/3lSvfn3qdYCwUyfjry2Ewgfk0huBtUMofEBugzEoHULhA0oZHYXcIRQ+oLTJcSj9jFD4gFxmRyJ1CGPCB+S2OBa5nhFOJXzAVMmisTSEwgeUljweU0M4l/ABS2WLSK4QCh+QSvaYpAqh8AGpFYvK3BAKH5BL8biMDaHwAbmtFpm+EAofsBvnTy6Ppb5zDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFfoPOgenF1SuIsUAAAAASUVORK5CYII=",Gw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACgCAYAAACLz2ctAAAAAXNSR0IArs4c6QAAAxFJREFUeJzt2jFoJFUYB/Avx0G6RAhcozzCrYFrtjtLIYhdbuC2sBCU4ywuRRR7CwsLGyvxIlwjiFpZ7EGS7hD0CgXDWdgIxrBZzl7sj7G5ibubzWY2O7uT3P5+sGR3M2/m7cw/771vshEAANV58PftvO4+lNXabuVnPYepKsI2+HOuTXISXoQTuLzevPSf4aK70vviq86HfcP/WnPpXEGapO2gL7ofTbSPYX0o06/l9Wb+xluvCuGU9QVwZ68bre1WXgTxRnpp7B0WF7doO04Ih237Qfp0ocx2hcG1X3urfaL9sPcGrXQWsx++P4iVzmJ21rac35XBN7KNFDt73YiI+KP7T0SMF6K15lJf22wjlW5fJhhnbbf58sNS+xhleb2ZH3b2d1c6i9lhZ3/XKDg9fQFsb7UXivD1Gmc6HRw1d/a6kW2kSfo4U71TbxG+OqbieamMT4yAxeiSbaT48/d/I+L/UPWuEU9TjHxF22JELdM2YvSab5L1YNkLNzj11jUVt7faC4N9bm238rKzxGUx8sMUJ2CtudQXqPdWPz+13agLPYuTV8VFur5689ZhZ3/3tNfMSGu7lQ97zPL4szpWVeZl6uQCc1MZgEsqNVKeGsm0xeylRsrzPM9//PmJEM6BE/cB65QaKb+zeT9++uW3ePT4ad3dYQYuVACZPxfqrvr11Zu3nj99LSJ+jYhwA5g+CgSmZlS4it8pEKjS8RowNVL+zbcP487m/RgMV1EcHB0cnbtAqDKwRuEXx3EArz67lt19+1723ZefZFefXRv6zY+PP9s510GKcFcRmtRI+dHBUVS1P+pVqgjpKQ76DCsQilB0/+pWXuAUI/Gbr78Sjx4/ja8fvD+V4zA7lV683oC8+87tysPx/A/huEKOUCVTIWs7aqHCnl+1/yekigqby6v2Bfw4BU4hNVKu+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAoBL/AZhvdR1TSKf6AAAAAElFTkSuQmCC",Xw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAZFJREFUWIXl179OwlAUx/HvTXgIpEvjxsJkGGrcJeqIq0NZHQi7b0AcWGVghREJrIbgQJxYupkuIpuPcB3MvdbS0v9l8ExN07SfnHv66y2WaUjLNCRHKvH18iABru6GALy6H6JUgDPoSIBqo8YxIEK1f9hrcQyIsExDDnst7P6cY0A0QFXZEGGZhpyNbHabLQCLpUN3vCptaSrqoNqoaYT3AXZ//gcyG9kKIvOAVIJOOoOOrN8/iTIggQCFACgasjeEi6XD5UV970IFUZXXjIjH23MJ6IeGAYqC6GlvN0198hDAD8maI+LUPLsGqPI59ULiIOAnN7LkiB7CHSc3AJO1O/VeEAfifYXbTZPueCXiDmvl3X17BlCdSAtJmyN766Ig+sYRS2P35/qmu81WD7F/WOF3XhQYAnIgr474cwR+uuLvSOS7GtWRydolS47ETq24S5M0RxLndxTEizlUCpL6S5Z0WMMq8zc9KyS33U1aSO77vKSQwna8cSGF7/2jIKX9BYVBSv0NC4KUDgiD/N/6BqlKK1m+ta+tAAAAAElFTkSuQmCC",qw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAABG9JREFUeJztnL1P20AYh398CKQsdEJCgCFNVZEuDK4iEaljt7JlYOnQfyHq1qFi6Jp/gSFLB9SFTnRFiUSbNUioaT6KFMFElkhB0HSIzlzOZ/tIch+27pEixR+xLw/v3b1+HTMHg3AyzpC3vtPozKluiyiLuhtAS0sV8gCArDMAAFx0lkf7HMPbxzSZ2hpDxLHSgiAy+8cVAOaI1NIIJ+MMU4W8T1o6t+Tbt3l+N7ZMizRBotIGkKhzi663jieNhZUIjESaEI3KTsxGnYg4FhOjUekkEiXv+KDKXV/4uhd6vNoM2jYpSv5qdPSFyWv/bgMALo82AQAvP/wFAGy92PIkhnVnHVEo/YSi8n58+ucJY7k82sTbL/NGSlTShcPk0bCRR5ZZ0rkln8SsM9DSledlHpxEnwhnp9fe+8ujTVwebXrr6G1hpAr5wKsZWUiPwKgEGRilNYelGj6j69t2dnqNw59rcIsumud3XiTzolAHSrpwOreEvbUNVLtXgfu4RRffg7a9eTyOaUjrwk7GGbpFV+hLp3NLkfuJHCfrDJR3Y6ljIE21e4W9tQ3ferob8kQGyTWh+wIGVGN4mNhVg1AWgYA/CulJIa4oFQgEd+W4oqULexJzwbNyGKaMf4DGMZAXiWFpDhAu7qKzjKwzGOWdRRcoYajisk6KQCfjDIMqKDSsMF7XrnavIiOOyNPBzAWKyuMRFYEmonwSSRqJEVgr6SmrShkDdeR3qUIetVLFW1ZVF0xMBAIjiaLls1kxc4GdRmeuVqpJy9XIjSRTkBKBsiWahJYunCSxiRoDdWAFTkksBZo0kWgROM0NIfqnb+SlEy3VmGkSbV7hQKdEo7pwHGdnowRGobNsFYQUgdOUtKaBFFTdoqvs1qbUCAwa53iTiEj3DYu+xBRURWElxvXunNaKdFyl0SiZROI4u4oiRSAR1jy/U1Zc1VWRllK1pX+NPwt5InflgMdnSICYV6QnaTyJ1mm6eyIq0tMyScTqTK6lpjFhMpIysdiK9JRIu5Rj100qTeRziazGsMk06c5BTyPxaJ7fRaYn7HbVz4pouZRjvzT98KGINBYd6QtBWhrDi7TjgyryqZWxVxBR22l0pC8EqX8tdizsNDpzTsYZsmIq/d7YMm87HaWEWqmGfGpl7POqI1DZyZ5vv34HAPcLNyfvX2156xutW9++me1nY8uN1q1PMvAoutLvaXvcVfpJiTjAL29SeNIr/R4WH1b3/7R+BT2vIwWpeaCovN2d9Scdl41QYBSN9ws3J/Q5VSBNoMgX2d1Z9+Q9RSIvAp967lmh7VqYJyxKYrnejpSnGikCeRGw+LC6X663Ua63PVEfv1V8n+VJbLRuUa63sfiwus+bTCr9njcGhrVBBlImkajG3y/cnAAjqeR9FLQc9jP0NhoVE4q0WVj1YM6iajY2rh4YN6TmgbqiUGUuqDSRVoHqRFr5pZwsVIsjaLl+nJVMXdJotP/3M0BcqAnCLBaLxWKxWCwWi8VisVgsOvkPW9QWs7d38t4AAAAASUVORK5CYII=",Yw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAABgCAYAAACaJ3mZAAAAAXNSR0IArs4c6QAADHZJREFUeJztXT1oJMcS/vT2kGMhwykUOow5ZQvyIhAXbG4QzoSjwxcoV7rB4UCpAmcX2CgyysyC8w2MYFkJFBjuIcQTCs9wx8USXvYFo5qtre3u6b/50/UH4k6jmema7q+runu6vgESEhISEhISEhISEhIqxErdBiS0D1ubOzP+++3dpTePnoWbk/ClgIg36I7R608BAJNRB8fYnQF+RPRibswekOCOOup/a3NnNuiO8fqsAwB4/+5h4e+TUQfHV7vOtjidrO0BV7sAqiNi3R2grvLrqn9JPkIMElqfWFYPcEHdHaDO8uuqfyqXnnf7cFVZvq8dVieV2QNsUXcHqLP8uup/a3NnNjw6d75u/2TP2ob/2BhBPYA/sKoH9PpTDLrjpRAVClUDUE8su+y6y29C/QMZqXT49OHzwjnDo3Nsbe7M6Md030ICAsjdL5A9uM79ynNjoO4GqLN88kB11D89w2SUdbrh0Tn2T/bw6cNnTEadhR8gI5/KWxbVh5GA3AX79ADTvV1QVweokwASZXkgFajTDbpjAHMSAsBPv3+/dL48RvbQ9SZYeUDAvweEoCkdwLd8XwIA1XkgF9D9eSej//Oy//ffr/O/FUWFQgJy9gNuPSCkASR8GqCtBKjSA+nKJvDZPgD89uOf+XH6Gx3jsC1bS0BuCG8EbhT/v6oHUCX6hgFeNsG1AdpGABPK8EA6cIJxEq5vrC2dy4/RsxNk+0koCSh7Ab+RSw+gv7tWgI4APg0QC5NRpxICVO2BdNARp4hQrnW/9C5YVQFU6GTUQa9v0wO+Vl4fgqzs6UIDEPQN8EgAjHGM3ZnN2pTp+XlZtuX7QpKcwr1r/bvW/e3d5Qq92x3AnsSfPnzOycfLLlqkN25G4C54kYT6ig31PrE7gC/qIgC/TlWHZdc/MCcLEVGCiPni5Uesb6zlk6/bu8sVaj/bRXEtAV0fQNUDAP8GUBGA7ufSAG0jQNUeqMgW1fGcmFfL53H7bcpcIiDdYIDxUvihh7HtAfw61wooamgJXQO4ogkEqNID+aDonlE2I8hQyB+maDdI6G4R/tKfI+8A3eIG4Of72MDtkHApv6x3w/x3Xf23YZuc0UD+oHU8jK6i626AustPSEhISEhISEhISEhISEhISEhISEhISEgoH2VknyUkWGFrc2f26w//Rks5SEiwxtbmzuzvX+5n0/vZ7O9f7hMJA5DUsTyRbfV6iLLb+0uGdVpmQgbTNrUEd7TWA07vZ7Nvvv0OQPXbnkJ3WyfM4UXAuuXRCMOj82CBRB8k4sVD6/QByYab64sFiYwq5OG4DYPueKm8Ojaibm3uWGX7tR607DC9n+WzP/5T9pIEqRz8+sO/+QxU2lHlsoiqHL40U4UdNBt/8rNwSb6qSagiv6r8sm0wEYt3jqo6JNVDm9cjG68PqBNnlKBxWRnycGTD8Ojc+vnK1OoDsjC/f7KH04Npq2fiTvqAk1FHK09WBgF05OfYPlzF9uEqXrz8uCDhEaPhqfyb64vCDnB7d7nCs/CAakjYZvIBDvqAk1EHL15+zBucUCYBADP5qbxvvv0Or94+L4X8UhVV1+ByfbAsjyzRZvIBDgvRvf4Ur94+B629cWmysghQRH4dQuXhTMMOnUeTHrCsDvnUULgO6KpQACwSAAjvpb3+FNuHGflvri+wfbj6SIysgW+uLxbO5/JwAKyFiWSZwPyVG8E25K1vrGF9o1zv9xTgpA8ILDe26lgMfUBZLsfpwRTbh6u5h/rr53+Wxoi+8nA6z2tznU4SLaZg51PzpEoPqNcHfMCnD5+xvrGGXj87/v7dND/GQQSYjDoYdO3l0WT53AOryA+UJw+XlbuWk9vnWYBwjyylSnw8elOx5AF1AomAn0Kma/jWkZ97OpoYqHSbY8iTeYsaPY4BZR0AYR7ZdiZO57fJSxonIVKiFZg3zv7JXnQC2JJftSRD2s0SLmTSDTs4TGNAujZWh+STIdvzXdYqmwAtAX0mHqEEUJWvIz8wVybdP9nDT79/jzd/PMu9EJ+l20wcTLLERCJa13NBqEemIQQtQdk8i4+ddcFbH3DQHePFy48AEF0f0LaxSBxcJ5DIj5nu46PKqsLx1S6G/WwCEyrYySdD2UToufH7JPNnmObj5q2r5m9UaJw+IA87SvI/2vT6rIPOVyvRvolG91V5XDrOO5rJbp1eIH8W204hO6Np1w+RlshPtpTxAcNY99SuA0pPIr2M6aYhxnEPTOAVTja9+Sp+z7bxvEWzYNngoR5ZrsPakFeuQcYkTL4VLdJMvNHuuUqBTFvPS8fK/ionsDgU4Avjb/54ZvTABPKWqr2LoTbqPDAQSaL3S4TtsKOK7wKrhgJFIZWPG/l1BF8S2jw7le26Mbi1OSFlIGTYEdMGdLH0lajjq9188qcLf6pvk4Tmr/BNGacHU6vQ+/hZM6sQnbLiBG7vLlfopy4bjq92lasIx1e7Ru/CF8L59SHkI49atARE+xP5JgybtcgUghsK15CvylMJXY0AFj9BZjMDJ+yf7FmNPRMBE5agWjqiCZFqAsSv4xs5CCYSphCcoAWfCNHapiknZtAd5+Hf9mVC8oAJSqjCd9F6oo6cTX8bk5CQUDfasnslISGhLpgGwGUlo/tck7zZE8TW5s5sej9TNm4Z6gCm8oquiWnLUyd065ZhVLt9Tw/Kyz6j8nRE4ES9ub6Iagutqz3ltM7WEVClNlBm8rfcXczJSKSjdNHTg2k0W4h8lJH3VEnYan3AshqEiEXo9acY9uc7PQhEuuHROd6/e8gzBWOUT+Tju6BtX/LrEufjWBcXTgTk6YEL+oAVC0T2+lMMMF4gQwzIhpNb4Hv9KW7OLvK/xSSdLYpIqN0X2NBUTusQrEsP7PWnTqpRPpAeicotI/GGxlw66MSZCNJLqmBbTzoRKF1dk+fMlCSy0E0J/K6poDbnxbiHFQF1Qj0cZUmz8fspPZImWT0UJpLZgtvOx4029cSz+lS/m+7BQzf9a9s+tvYV3cN2zNp4fUAbjxTT64TqP1MdkHfmnYiOm3aHyJ0oRDyb4QbtyeNKDi4g4rw+63hPevj41YYLQfqAPDG9bDkyW48U4nVo02cMEkoiEvF8wDekymMyShAJ90/28vJsPSedS53aB67CmYWzKSnU8+rtcwAZIfZP9vIQ+NfP/+SpgMAiOX0Hv7rURALf9sOT0DlyPRXLPIWiMl3B7bJNDuJe0CSEbjpPdS+C6lyZDBWazmmbiaedBctewiXSgHk4IabfXF9gXaFQBfiL6cgkeQ4iH/2b665g3iDU4HWpBNiGTgmemyLrje92DhGAUiHm909s7VCGYJmXKsEH/irBHC5lAbiJ8diCk08ep/BHjV+2jK1JR4bgmhppm5fC60BVz7rQrbtX1d9AMapjFekD0oPp9AGBsDGhKnxwlC1/awPZCagRKSeiLO/LiUVLLbr6sElo4verUnfaeiFapQ847GdvAHT6gDJFsCrIXlxGZcrQT6DfM42Y+bAg9qI5x/t3D0tvTSRs6oBCf5UL1oXqWKH6gDFcusrDSNDMj8ZdPg1e5HGlVkwTPtlFdRMyc+Wo+m1JoToWoFKLmgvwyDU6LkfmIo9mAl/iUYUZGoRTWfxZfMtUgQ/SyZai5acYpPCRvGgLlCGYSEhSYzZQyZGFfkNOKhVwwSLT+C+GKLpqgqMKu/IcGvtxhITfhaUWFh7p+GTkfetGwEoln+CqDxijx/IKVwkFccQcZ8klCe7xTOTPNgvM7QzxyHJIULTU0oSPJ7rCSEDem1USabjKziuSI4sBTm6dhl8smEK+iXx0XezhAC118c2u+VDJsGDdBlFzoz4gAOVWqzL1AXWQ61uqNwz0r+0qvIRPyC/qAHHeAnUWvouisldHvtdnHeAgjp6fb72a0MheIcFf5hN0r9zobzEqm99bNR40IXT8q/L2tq/H5LUxJoP0Wja24mrj5dkk+VRhjY8PY6HKkG8Dl3L5SkYWvsOWaPiE5zEFwWtsqfKgrcgJkeSTr6m4pFosaTVVyOdrjCbC8/fPoa8g+XjU55VmjH2N/C0JpSDcXF842UKbiuU1jQ/BdeSfFIV88o6662MMB+QMeCEFouCe2m35gUMTlU02IZnIx/du0jWND8FVz95sQr7JrljDATnLdfm8Q1nDBm6T65Yt3ZuaxnvAqiH32AH1rqNJr2Pr/QA3r+lqE+AmnEmQdiQCCjQl5ZRD7ni2Ob8qVX8bkD1125FQIXg6Qt22APrJ2P8Bnh00kNVFA+AAAAAASUVORK5CYII=",jw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAEBJREFUWIVjYBgFo2AUjIJRMApGwSgYBaNgFIyCkQ4YiVWopGDiQ4rB9x6c2UKxA0i1lBzHMFHDAkrAgEfBKAAAZe4MBrg/DiUAAAAASUVORK5CYII=",Zw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAQCAYAAAB3AH1ZAAAAAXNSR0IArs4c6QAAAEhJREFUSIljYBgFo2CAASMyh5nZ8D89LP379zwjhiAzs+F/egEMj8IsZ2BgoAtGdgQLskOUZFVpHvw4wUBFweBJhKNgFAwUAAB2WQDMTpagjAAAAABJRU5ErkJggg==",Qw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAABACAMAAAB7sojtAAAABGdBTUEAALGPC/xhBQAAAMBQTFRFE2SIFGWGFH2qE2SGE2WGFXupE2WHFXyoEmWIE2WHFXyoFX2oAAAALq3jIpXFKKHUFXSbFGuPFXWdFG6TNbv0Jp3PFXqjMrXtH6fhIKniNLnyM7nyIKnjMrfxMLXvJa3mKbDpJ6/oJq7nLbPsJq3nJa3nIqvkK7HrLLPsLrTuLLLsMrfwLbPtJKzlH6jiM7jxIanjMbfwMLbvKK/pIqrkJKzmLrTtL7XuKrHqK7LrJ67oI6vlKbDqFGWHNr33Fn2oEt7TigAAAA10Uk5TTz8/769fn89v37+fAH/YHM0AAAEYSURBVGje3drHdcNQDERRWFkklCXSWbYl55wT+dF/V+bCBz083Arm7UdUW3mWGVCW5S1V0dzAcpWu2XhUJqByNDbrSt9WCWtlfTEr03IfaZlKsyYgpQOolP4DHqHiBBxBecAtlAc8Q8UJeIGKE3AM5QGfUHECrqE84AMqTsAdlAdsoDzgCsoDbqA84BsqTsAllAd8QcUJqKDiBJxAecArVJyAUygP+IGKE3AG5QFbKA84h/KANZQHvEPFCbiH8oBfqDgBF1Ae8AYVJ+AJKk7AIZQH7EF5wANUjICiuZxVu0hVczkrZM4+/c1lZjah7p+YzaSeko+v01ra9aKgzi8WdVs6NVpHdtgBItoj7+8173UdDKnzhwPVPwRCH/15giO3AAAAAElFTkSuQmCC",Jw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAABACAMAAAB7sojtAAAABGdBTUEAALGPC/xhBQAAAKVQTFRFFnyoFXyoFXyoFH2qFXupFn2oFX2oAAAAIpXFLq3jNbv0KKHUKLDqJp3PMrXtNLnyM7nyMrfxJKzlK7HrLbPsMrfwJq7nLbPtJa3mMLXvKbDpJq3nIqvkLrTuJ6/oLLPsLLLsJa3nIKnjIKniH6fhM7jxMLbvKK/pKbDqL7XuJ67oLrTtKrHqIqrkJKzmK7LrI6vlMbfwIanjH6jiHqfhNr33Fn2oU/4/+wAAAAh0Uk5Tr8+/P1/fnwDVUD04AAABAklEQVRo3u3aR1IDURAE0da4lh1hhLfCI7z5ff+jMQuizkB28E5QuS9zr7uqCqCq6mp38y7AOrcmYjzpC1A/GUc0NopFwVrEyCL6Ml0iTUsfMQSUsgVVym/ALVSegG0oBexBKeADKk/AHVSegCMoBTxC5Qk4g1LAE1SegAMoBaygFHABpYBLKAW8QeUJ2IVSwDNUnoAHqDwBx1AKuIfKE3AOpYANVJ6AfSgFnEApYA2lgEMoBbxC5QnYgVLAO1SegFMoBbxA5Qn4hMoTcAWlgGsoBXxB5Qm4gVLAN9R/wJ8IaIfb5Zy5fz7cLlsz9vHVrI6YUffPImr++du9aanz28b9ByOQclrdOBB9AAAAAElFTkSuQmCC",Kw="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAGpJREFUaIHt1cEJgCAYgNFqkmiGxmjcxmiGaJROQURBqRXie2fR/zuoVQUAAAAAAJSmTrlZ1/bD3bXzMo0pzowOeDL0lZiY4IAUgx+FhAQFvDH85mlE89YgX8k+oMw7sJftK3Tmj38AgCgrkfgcDGGvEREAAAAASUVORK5CYII=",$w="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAABu5JREFUeJztnTFoG1cYx/9uC6GlZOlgYjpIVigYmiXIghgOy1s8ZCqRkqUcXUKQh2wpKQQagosL3hJChhZtyaljCO4WGUEKsrcUCqWKNDV4KIRSCpnUIf1e3p3vbJ39dO/7zPcDYaE75P/73v9937u7dzpAURRFURRFURRFURRFURRFURRFURRFURSmzJeqY3plbS9ak6IoyjR4z+WXzZeq47mFZWyd2c3cvnVml3USlV4ApOtXlONQtP+dJdD5UnU8W6oAAFZfVfFytDuT3OflaHdm9VUVs6UKy4EsvQBI1w9oAfCN5Pj78L/TGaiN3RGHdQoHpBcA6foBLQC+kRx/X/7/wMWX2Pz52zaoIWnsjQau/+VU4GiSPEjTP/EAgNlvnLaPTygB/fB6E6uvqqnbt87sYhVVltqlx9+mKP87S6D/B9N0Qr0W7NtnfaOFWzfvI+q0UzuIA9ILgHT9hBYAv0iLP1G0/50lUNtAe6MBwjcR2sE9s319oxX7G3V4GUh6AZCun9AC4Bep8fflf+eH8PVagC6A1REw92KI4FwZAHDr5n3X/8op0guAdP1aAPwiPf6+/O80gbbfRAj775IoAESdNgCkmoqqNKfOkFoACKn6tQD4RXr8iaL97zSBhqeaqNcCRJ12LGE2G6ExD4DYe0qwHJBeAKTrB7QA+EZq/AE//neaQPdGA6AWoNkI0e339m3PSqJckF4ApOvXAuAX6fH34X+n60APOvcjATo/1WyEqdtp9pB8zwXp+u0BYNNshHj+7DHqtQD1WoDnzx6j2Qgz2+mL9psI3X4P9VpgxkLUaSPqtNHt92Iv4N2aUZ+abaTH34f/p7aQnmg2QkSdNpZWrmBp5Qq6/R6WVq6gUl5kdy5IegGQrl8LgF+kx9+H/51fhacKTPReDDG3sGwOZYhoNGCVPLOgAmCfklha6RmzcW+DJP0nogAIPoUlPf5pTNv/U1lIT0m02+/h/Q8/NftQI9KuUHJBegGQrj+JFgC/SIo/ULz/nc5AKYkCbwW+ZYC5hWX0XgxNw7r9HrvASy8A0vUTWgD8IjX+vvw/tQAcdnKcU/Bt0nTPLSwDgDFRt9/DL91I9TvGXgqUHADBuXJsAHA7f36QdgD7ExAz/YDs+BNF+38qAbA7AgDbansQyXV9NtzbMcmVXa5t0ALgF8nxJ4r0v9MgkPDZUsUkndlSxUyZ7auTHM1D2B2Qpp+T9jSzSIr/UZfxcNFPHNSOtAS0x+wQGMjfFxz0+/b/sb8kLdlkLU61l0dwrGJ2AQCwL/Cknxbq+tafNE+e+H/3/Zr32EvXb5M86rJJWx4kRb/dH7Z+DjNoDv5xsg70wd0bGAx3sDcaGPGD4Q4e3L1h3g+GO2Z/TsnT/gHc2VLFVC9qS9RpYzDciQWfQ/K0OUr8OSFZf3IxfL0WGP/QS5J+ADHt5P+k/q++/KJwrVn49I+TBLp5/TUq5UUjdDDcQaW8iM3rr2P70eLbei3AhXqTzR0YdgfQbMHuACC+cJib/qPEnxNS9VPiOWwAExL0Z/kfiOv/5tuvC1abjU//OLsT6XzrKSrlRfM633pqtnFbMJwkbwdwwT6Ekhh/6fqJw/xzEvVXyotFy9wHB/84vZXzfOspfnyyHRNvQw3hdAhP5OkAjvqBfPHniDT9kw5gQvVPFx/+cX4v/PLnH+HRtUsH7sP1R2Un7QCu+gHZ8Qdk6z/MP8RJ0O/7AlIWRfvHaQJ9dO0Stn/9F1cfPtm3jXv1IibpAK5Ij790/UC2f1T/9PHhH6cJNE14Es7Va5IO4LB8I4s88ef4qOmT7B9C9U8PH/459r3wL0e7MyhhfPYOcPr2ZfP533d+wh+ftGO/i2j2Z8rVh0+wdjF9G1f9R4n/fKk6bjZChL01hKeagMcnRKp/+CBRv2//OFlIb6/8zyK5D5eOoBnY2b9CnL59GWsXP8a9n/8xHUBw1j9J/ClxAvEFxesbLVTKi97bk2cm7FtrkvlSdXyYfwhu2oF8+gF+bZjEO/Zt2S71H+uLaPDWawHWN1r4fWmGZjSxQ0X7zh6a9XA4FLD1p929IEk/kVVp8+xbNPOlqpkBpw0GSvhhbw2fPR+zSPhJTtrvD9hwjf8kE4Jp+97JDHQw3DFPG7SxZz0EPZ+EUydI10+6iCx9yR9I4aAfiA9gOrVAA9X+HOB7HzlxUFskarY/B/jEP+/kAZjOkZeTIOR5uBS3B1EB8vUDb3XZ5zWzTM5R/4V6c5y8O8QeqMkixkm7TdqgBvgknSykxj/vhGDSMZIHFoFQ3GAbnYvJJyHrEFJSGwiJbZGomcg7IZA6RhRFURRFURRFURRFURRFURRFURRFURRFURRFURRFURRFURSFBf8B2OyFPQlBC5sAAAAASUVORK5CYII=",t0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAAQlJREFUeJzt2cFJxEAYBeBfsJCQGtLJ3vewVQiCIihaxR62HmsQO4kHGRG87Qaev34fBHIKL28mkzCpAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+mKdlTWe4hPxZ8n+63uIi5/h+A2/vr1epHP/ZGAP9Z+g/a4v+YwvoYb/7Oj+eau02ibq/ALr3f9jv6niqtguQ/rO26j+2gN4+3FRV1dP9SyrCRbo/AN37H/mr9J+g/7B5Wtah437KyP5499wyf/f+R379Z+g/bJ6WdRzpLOfoPgD6z9J/1lb9t/rs/k2674H+BX7CZOkfAAAAAAAAAAAAAAAAAAAAAAAAAAAAoIEPAh/lWUHyS2gAAAAASUVORK5CYII=",e0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAASJJREFUeJzt2DFKxEAUgOEX8A62Y/YCFrGwEXtLCzsLDyGKhVgIHsDawvPsGZa9ybMaWRthZckw5vuqSaqfZBgeEwEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAb4bWAWOZsq4323Xznn3pb6vX/rFMudmuh177q6X3Hx02Zz9jmfLu9vr7+eMzsqef0GN/ZmZExOrkLCIi9M9rt9/+md+h+5sdoHXzPL08RETE6/Nbq5Q/6bV/GIbh8f49j8sqri5O9c9Mf1u99/8wlinHMmW1O073oNf+88ubrO3656e/rUP2Nx+3l36H0kK9f6vr+l7/PGpzr3eg/+H799wPi9fLtAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMv0BWVfKARXfrX4AAAAAElFTkSuQmCC",i0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAABQCAYAAAA3ICPMAAAAAXNSR0IArs4c6QAAB0xJREFUeJzt3b9u21YUx/HDosiUdIxlx4MsIwgCuJ5Ej9kzuMoTGCj6Dn6BZso7FAXyBFU9eCzgpYWpJbaBICj8Z3BsOWOTKQs72Ee5ovhXpHV5ye8HCOBISsL8nNzDy3t5KAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQNN5tg/A1Ov2Q/367GJUq2OrKzIDYMv3tg8g6vQ8EBGR9TU/FGFQzIPMANhgtYDo2bM54J0cjUVkelBkQPyGzKoVhmEY97rneeQHZPjO1h/c6/bD5898ebKyOjUoDgbbU587PQ+mLtO0WVZmJ0djOTkak1kFwju2j8NVN+PP5NcCCy8g5sD2/kMgH68uZz6zsdlZ6DHVXZ7McD8oJPP7dPMlcYaHZljoJaxetx+engeyvuaHw+He1HuDwfbMPzTz0kxbL8sUzUxEJrOQtmZWhOd5Xp5BTj/Dpa18ljqPvJvx51CE7JrMyhqIDoRBcCgiIr6/NXlNZx9aPHArLTOUowMbhaR6n26+yOOlhyJCdk1kbRHdHAhNv//259TPo++3WVJm+rois/lQSKqlsxCziIiQXZNYW0TXQU4Hv43NjmxsduTnX36a+UybnV2MvPU1XzY2O+L7W+L7WxIEh1NFQ183sZg+vyIDG2sk6ZY6jxKzJDv3Wd3Gq4PexmZH1td8OT0P5ORoTOHIYOYzGGxPLmWRW3WKzEb0c5xRJ4vOQkxk5y4rM5DoVl21vuYnvofk3AaDbXK7J0VnI/d5LK5Km4UosnPTwqt+r9sPzy5GXvTSivmauTiss5O27yYiN/vyDHKcScfTHVlJsxARsnPRwmcg5oCmN8WZojuLoovqbVU0N1TPu5P2Gc6k4+ks5NPNl8TPkJ17atcLyxQEh/L69a+cRReg26CZfQC4b7UsIFo4RGgMmJdZOETIzSYWheMlbes1kZ1baldAdDGYAbAYCsdicJmlnDxFBO6oVQFh8Mt2l1H4/JkvsiIiIrQrqSHOpOdHdu6wdiMhgHbKs6AON1BAgHvC5a75kZ0brF7Cev8hsPnHO43s4DLWQprB6gxkf3kkb16sZn8QM8jODZxJZ0u6lEV29We1gLy87suP//5h8xCcRXaLx4BWrTwtTlBvVi9hvXmxKi8PbB6Bm7R9yfHTVyLXl5M2J7aPq+mSdgYldTzme5JO25uIJDdbZEdWvVktILsHl7Kz8lXeXj2weRjOIj/79ImRcXgiZDKzeIik98hCfVktIAx+5ZCffXfPa4l73DAzkARFiwezkPqy9k3Raf+bF6uye3DJf7aCyK86ZR+6ZRaPIDicPJeFrgqzysw8KCL1Y3URXQc/zIf8yut1+6HuZttZ+SoiMtndtr88EpHb7sdJP0z6lEjzaZHPn/k8FfKOWTweLz2keDSAtUtYZxcjb1ck1K9tHYeryK86uweXk2K8s/JVdg8uZX95JLpJ4b/P17l/L33ksCrya5ssWjyKoHjUF98YtF6Vl7BMTb6EpZnl+buVKR4izSkgRTJzRWP+IoAtcU+EbPIiepH1N4rHraauWdaqGy9Qd0mzlbQnQpq/pikDR571N4rHtCauWdJMESjo9DyQ4XAvtmiY6x+9bj/sdfvhcLgnSfeKuErXi5JQPGZlZeYiZiBACdEtvHGvN1HaPUhli0dTNfG+LWYgQAF3Nw5OHiGcx8Zmp3HPqH979SC2mWcVxaOJsw+R5MxcRgEBKqI3EDadFkJt5qlrPBSPdPvLo7nXQOrayJMCAhRkzkKiMxGziOj7TZt9qOOnryY3W1I8spl5FVHX4iHCNl5gbnrmndJMUUSas/PKFN2N9vc/f4lIuTWPJheQaF55/01o8ahrNiyiA3PSQWB9zW9lO/cnK6vyw6PlydMxKR7ponllqfPMQ1FAgJKaXijyoHhUyywedc6HAgLAmjoPjovmwowjigICIJeYO+pDWbntOLy+5he+WbLJxaNI94G0wlH3jCggAFJFNwvo5gDMKpqVi7MOEwUEQCLzkb0nR+PKft+6n1nPo2hWWcXDhYwoIABi6YCYt3B4nuflOaN2YWAsqmhWTcGNhABy02ecqI9Xl1PbUrMu2TSxeCQpk5UrOTEDATAj64xauwybBoPt8PQ8mGtB3WVtzooZCIDcktrY63tpXDmrrsq8WbmUEwUEQKYgOIxtVx99PYlLg2JZZbNyCQUEwIyktvXRQdD3t8T3tyavnxyNRS/NqLYVj7ivRb412kwrIq5lxRoIgExprep1QGxLO/s0bcuJAgKgEHN30XC4NzUgDgbbU4vCrp1RV6lITiJuZuXcAQNYnLgdRoPB9qQ9R7RNuTo9D5wcEOdVNKezi5HX6/bDs4uRV/eW7WmYgQAoxWxTrgOmg2PhvYu2czd7ZLlYPAAgU6/bD9Xxu+vw+N11aJ5R97r9MGkm0ibkBAAxdPBTDITx2pYT0yYAuRVpU95m5AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaKf/AazGqgAsxibiAAAAAElFTkSuQmCC",s0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAACQdJREFUeJztnVFoW9cZx/9ORTEUP4UUmvTGRpjUEfaQjRimTiPLXkgfWpwy0TSQGQqZwSHZTBF1MIHNEIIdxOaRgcEYBm7p8iBIQvJSmCN7NHPYhCPqoNid0ZzcpS/GLysDk3ncPlyd63uvrhQ7utL5jvP9QMj36kr6n//5zqfvnCPbAMMwDMMwDMMwDMMwDMMwDMMwDMMwDMMwxAg2RQw/r2N2B/vPvMooHf/Bpojxv//81PASZz9X7jrZqNwB7D9TKSr7LzP+9/n1Qj/79WcAigV/t/zAcU5cR4lgU8RY+XafZ3C421PqOtmw/3JRPQGp7r+s+K84gQabIoYWS+CPQ1HHObfJ4nh2Mg4tliDXCaomIPZfPpyA5CE7/n2pQPV0EgCgxRLQYgmsfLvP+vnxyjq+W35g3R6vrFvXU0B2B/gB+y8fTkDykBn/viRQLZbAhYl561gEib1T3NdTQuUEBLD/MuEEJB+Z8V/nx4uIILJzf+YsAKCr/8uiYz2dRH4t48t7V4qXdoHogKPvHLDOPV5Zx4WJefJtYP9rg0iEt2/fsQbxX/7wO8cgduvv6/sQAMjoV9l/QG78V/wi9k/Sax9u4Z2O99B+bhJ/++Zf6Gh/C/Vv1AOA4/iwFiZjPqB+AhI/s/+1hxOQXJSO/2BTxIh+esOIfnrD+Mc/t4xgU8RY+tNFI/BawNjaNI8DrwWKjilNX8R0K9gUMVIXw5b+vy/oxtbmlqXffkxFP/tPA3s/iJvQ7XVMSb/K/lOI/4AfLzI7GcdDHQiFWvx4uZph/+RNjsRx+kQnbneYj3W0v4UjLZ3Wte5jSrD/8hCDUU8nd1UBUWAv+A/IjX9fEqidQ81tjuOH04MAYAXSjfOt+PyO3+9aGaomIC/Y/9rBCYgetY5/X3bhewdTAIBcbhmAKbr+jXo81bM4eub36BtdwGEtjMNaGD0fn/fjLauGVwfY23PjfKskZaVh/+UyOxkHsHcTEHX/ZcZ/RRVofi1Th3TSAIDT6ST6Dz4HYHbCw+lBtJ+btDK/4M3u82SmMILewRSSI/FCBxy3OgAAjp55gCMtnZbmno8HgDtTEtVuw/7TQ8UZgKr+U4h/377G1H/wOX7+S3PX8VBzG97sNjP9+yc/QS63jFCoxXFPYhcMzl28/oPP8avxCwCAZ6tLaD836fkcMrt4Bdh/OXhN4TNfDDi0b/530zF1z3wxgMgvpkjoB9T2XyAz/n37XfiZ719H3+gC+kYX8Gx1CYApPhxuB4CieyoII0UHCO0ieN4/+QkOa2HHPUXY/9qTX8vU6ekk9HQSp090FlVAAKyppLiJgU0Flf23Iyv+fdlE0hq7Hcd9o3MAtsU+1bMYG88WHj3jx1v6zsz3r2NmdAEAcPs35jnRAbncctE9Nex9wP7Xjvxaps5eAT1bXcKh5jZHAvKqgKihqv8CWfHv+y48YDZGa+zG2PgwAKDr2JD12Nj4MLk1ONU/APJrmTqtsduair3If4rwB4BcVPbfPX5rGf++rWNEownHl1Nnvx5D78lL2yeCESRH4kicM8/pT+ZIraO49QPA/W8mADg7QJyjtA7kpV0l/730A+X93/r/FgntQGEt1DaI9SdzeKpncWl4HIBz0F4aHsdXX/2ZjPeA+v7vNP4F92fO+qbftzXQ+fmkQ9BDHeagnR5ziLcfU/mNBqBYf3J6DF3HhraDp9CWrv4vrXOU9LvZif+Umf262H/AHMyUZjDRaMLwqoC6jg1hbHwYY+PDVjvEuad61vvFJFAqearifyl6B1OmZnEDgHwGyGd81e/rFH5+Plnn1SHJkbjzRD7j59v6gmcgFao21aHsf6kBbH0AOLRvV9DBpohBqYpzY1ZAthPBCJDPoOvYEPQncwBAWr9K/nvlneRIHImrqZL6/cK3ChRwDobE1ZTnNYmrKRFAZPAaxKX0q5JQhX53O6j57678BV76qWkHSuu3V0DJ6TEzbhSo/AWq+F+KWumvzhqoK1BE0klcTTn+liCVT7CiBFpCP+BsAxX9QHn/7ajov8D9dyhZvz+8jH4q2u1Y7aih/qrswgtEGe1VzVHqgHJLD2791P6YrKDUNEbg7gNV/BfsVf3RhoD1vPkf5GzM7FY/Je/LUQv9VUugQry9EadPmL+RoUIHuPVTHsBA8YaW11IDxcq5FOWWSijotyc+L3ay1BNtCBgXP/oAAHD95l1/hL0k7iSqylJVEYXqs1b6fVkDdQxej/K5VBVKhRfpF6iUgOxQ9l5Qai0RoKs/1hZCrC0EfX8YWJxwPOZee3MTbQgYs+ubAIBHq/nqCq0Qqv7bscawxwZpNfX7uokEwGpAKdHkk4+HfhWnL6r5H20IGFicsBKRl35tIwttI+t4jrjVTGiB+R+26tJLOVy+t4hrx9/2vMbdBq2x29GGWwNxPFrNI72UkzZ9F6jmv5v8WqbO0p/POIu21Fkgddb6P09+6vblX3q4vwdnPuCs5KguoKuu347XOpb+ZA5aLEG6eo42BIxYWwitzUF8/td/bw/SDvMrP1pjt3m/kcXFjz6wpruz65u4NWBO1a7fvCslCYlKsveA+Vd/9P3b3zG0dBfuATjaEGsLAYD0BPoi/wUU/ReUawMWJ6qmu6IGu9fdtI2sI+gFIvj1/WFcO/42Tk2lcKSlU/pgVl2/G+vDYHHCMZABs22z65skdYvgB4DW5iBOTaXQe6DemYw2soi1hZBeyjkGgJj+ykpC9oHrHoz2+NI2stZjv333J4bQDMjbPBKo7L+gXBv6Dz6vmu6XfqJYAD81lcKVng60NgcBbGd0d/CIIHu0mi+69mU1VILq+kth35h4tJrH5XuLuDUQx/Wbd2HfsKCoGyhfHdgHiYBCEtrtTjqFnXc3KvsvKNUGAKiW7op34a/0dODyvUVc6elwnLdXOVqhYSLrU1o0V12/F0KfaJdI+JR1i0DuPVBfNEgd1yzlDK/nUWCnWihpFuwl/91tqKbuiipQr/OlhO32+mqjuv5y7GRxnKJuAcUK7VViL/i/F9rAMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzDMAzzivMjXk4u1W//VMIAAAAASUVORK5CYII=",n0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAA6BJREFUeJzt3LFOFFEUxvFvjW9hNm4mlFKYTAGdxlDTkFCRWJHYWG1FQ2ioprIx0cbE1oYHMAuJCQWTUGAJ45IJtY8wFsMdF9zsztzZZe6R/68xrnt3v3vO4Q4woAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwFTRIC66zvCYWa+/9fzoVtfz86TN4mgQF/3XQ69NRIO46HrzLkfXGXxZr7/1/C5H1xnasJw/hPnxPkDvv3mTMG7jvptflBAa4Mt6/a3nn8xhcX5cBqv5Q5mfpz6LokFc9J+/kiR9/7ilN+9u/2GUFNk47c1b3389VLK3pZd9lWtrrlukNoVzDZDUWfY29ZfUaf3/x/mJBnHtDF3Pj8tw/+9W8oc0P40P0Cp8FFePJXtbkqRhlkpSozDJ3pbXujamNaAvFfkoUegH0CLqXw2/Hr7+/+v8SDJzAbCcP7T5aXSATgt/nksv++WfimL1y4dnh8lSDQ//brz2ugWwfABZr7/1/FJ4H8BNWc4f4vy0uok0aXj4rQrzEOt8zGqAy9B//mr+l/dZquHht7JpTdYtkYX6LyMH81Of9fyzdDU/fgdoecWpnOdSPkqUjxKvlwuBhQ/givX6W88/han5WWCOxz7//p+BZqnyUaLtjTVtb6zp6teZjvbXa23i5CTpKUu1vbH29/n3irJUATXAm+X6376f2fzW58d6fimY+Wl0gGbjtJdfHyu/Pq4eO9pf19WvM/3+8VnPVlar5816nWgQF/n1caNNL1wgDWjCev2t57/D4PzcYTB/iPPT+C78RLhCkp6trOr3j8+6ubzQ5sHp3PXRIC7Sr7v/PJ5fH9e+A+7r9vULSXJ3IY/21/Xi7YeJBpw2asDPL++1eZBUr7dslusv2c5vfX6s55fCmx/vL+Hdm91cXkgqNzIt2LR18c4n3VxeNLpqLEo2TnvuSibdbUC882nueteA+3t9qAPIsVr/yRySvfzW58d6fieU+Wl1Fz4bp73Ng9Oq8G4zs7gGuOB11ixDKA1ow3L9Jdv5rc+P9fzuPbueH6/fRJqUjdNeNIgLt4l5hSwbUH76Xadhy1Q2QIV0qvTrbqMGOF0eQJLt+ku281ufH+v5pe7n58GvGpPcz411cfWalqNuFvd8N3SbB/O/bxSiUOrvK5T81ufHen5foczPo9X1f6gA26zPj/X8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaOsPJX9bKo9VcbIAAAAASUVORK5CYII=",r0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVAAAAAwCAYAAABHayI3AAAAAXNSR0IArs4c6QAAAzVJREFUeJzt2r9rGmEcx/GPpf+FSEQc61C4IW4pIWR0CWQSOgShSyeHkEVcOjl1KZil4FTo4lxKOgQs5KCDHY0xBOfMneygd57eacL98PLo+7X46+Hx+3yf733P3EUCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkJRC3pqkHcMuI//YZWnU/6u4JirkrUnuXd3og9j02Mk/ojA5/2nVfywNdDloEzfC5Aa0Lv+mrMfk/DtMj93U/KdZ/6+jTlDIW5Pc3oEk6eeXEx1+mH1w1ZoMR3bGGSNJzuugOZznq8YkKWgDvLGnEdNzrcu/JH378VunR/vkP2FOA/LWvSlMzn/a9R+pgbrBFyz3vdbFiSTp9KrlBnZ7d6O/Xz+q0pRvM5wxdqcmSbKq/jFJSnsDongq/5J0erS/kP/lGMl/dDSg3a3/0A00KPg/D9Lb3PRRkrqNst68/6zH60tliyVJPd8c3UZZ2WJJVrWtbqMcNpxQwmzASzkBhM3/cvGYln+JE0BcTM5/1Pp34o5a/7HdRPKqf/ouScoWS3q8vtR40JdVbfvG5fYOZgubL2RT1m2Ao9so6/buxrMB/jm6jbLsTk1Wta3xoL+ByJ+2zfn3HgBp539hDbN1tC5O3CYkzRtQt1F2Y16eQ5o2ILtT29g1yG3I/yqbrP/oDXRoL7w8PD5333MSmi2W3DOU18P9L3dx2WJpJzcgMvIviRNAnEzIvyvl+o/nF+jQloa26mfnbmDDkZ2pNHtu4oOCc8Y4dnEDYkH+OQGEtQ35D1H/w5GdiaP+Q18DnZ1JJ9K0EKRp4J7PNBzZmULemjiLCLo28pwxiZsVTP1s+jjfAE2knuxObU0DkvsnV9B13sRC3vH8O3Gmlf95IPbCr9DD43P3+XjQV7ZYmjWgkq+JThvQP1Waq2tsIwzM/0up/1gOlqf+TemlcuJetQHeMcvvB82zbkySyP/m8++9ebTMaUDe65vjQV+VZs8Xn/8mTHuja5DMzH/Q96fx3UYdcEkxtQFtC1PzTwMCgIiC7q4DAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOL1HyL1Aqy//oIZAAAAAElFTkSuQmCC",o0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAgCAYAAADaInAlAAAAAXNSR0IArs4c6QAAAgtJREFUeJztmj1Ow0AQhWeRKc0BKKNUUcIBaIw7pFgKuQAnIHeg4QRwDKQIKdSRzxCUClHmAm4oLA0F2cjkh6zXaz/bma9K5bd+82bsdZZIEARBEARBODkUegEuCHyP9e84SVtxT0IOmJkD3+PX+zvOhqFKULpF9c9ciSMNUEqpOEnVx+cXTcYRrBhoH2z0nQSgyAJcwcw8XywJFYI4SVU46MECaKtfOADMzERE4aBHSAOIfk1AhgCpDdHXxdcEvseP11fQZzFqHdoLlAe2+tYTgJlZKbXzxo3uAgRZL9BTKK++ZyNyqPibLdhiyUREk3FENJ1x1VuzOEkVeg1NIfcEOFT8OhIOo9I19vnRpCmQKwCmxUcboJm/z2j0sirt+sf8qCKA/2GibxwAm85HG0BE9PZwSUS7L6xVUHYAXegbBcB27KMN6Hc7G32llHIZAhNPwmG0CSACE32nH4LqxuhlVVoBTAKFbgBnE8B191TF0+33HwOqvo9WTQBb8+puQBGOedKaCaAxDUHgexwOetTvduh5OoP9RZs1gNdUvYVFNoCJfu53gKY9DrQBao3r6+/zA90AefStvgTqm942VO/30d2PLkCTsN4FbCcfXXzkVMp6gQ5fXv3Ci2Nmvrk4JyJ85xPhCoBuAFt9ZwtEn8urQwGa1Pmtow5nEZp4JKxVnLwBgiAIgiAIhvwA7Cn27X2XP3EAAAAASUVORK5CYII=",a0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAI5JREFUOI1jYBgFlANXDZv/rho2/0nR01LXDlfPuHLpmv8MDAwMc5onMDAwMDDsvnGEkZBmVXVVhts3bzPUNFUyMjIwMDDADIEZVOwlynD9ySsGTRkxDPoMjxmDiIgIg6CwIMPtm7cZmLDZcv3JK7w0AwMDw/u378n3goiICMObN28YapoqGSkOxFFABQAAAr9HnRBKjFsAAAAASUVORK5CYII=",h0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAHFJREFUGJWF0DsOQEAURuFzbUGiUii1OoUN2alliESjMoUg86AaGcI47f3yF1cIWubx0JvCmh2ANK/E3+QNeQiQFbVc8AuFOAGIIV8C/KILxlrm4b74hZw1/4vOGvSqIHzP1HfHc0mvirJp5QY9fkMAJw9eXg2Xm1L2AAAAAElFTkSuQmCC",l0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAIRJREFUGJV90DEKg0AQRuE34kHEVtJJihwgd/DO9nZik6QKIQTBZd1dq5FJjL52Pn7YFUyXc5M+45N5djg30g+t6C2zCFgRQFnUaQMBXu87ewnAqbpu1mz90Ep+BGwZcIj0lu+BEDwxhu9F+w2Kfvu7qEsxBm6PTtBXa2VRJ++nFSoCWACc8UydDDmB8AAAAABJRU5ErkJggg==",c0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAgCAYAAACinX6EAAAAAXNSR0IArs4c6QAAAu1JREFUaIHtWT1o20AUfrJL95BCM/pnKmQx2CbQSXuhkLFTyd5Fq2evWTx18dwpIOjuSWCcgBfTUIrTjBkashuEOqR3fTq9d3dPJy91v0m+033fvXfvPT9JEdRAURQFNR5FUVSHT4peZ0jq393fiPW9F3BGs8QNO4MzmoOvM5w3SQ2vCAQ6Qmq4CZcjrJPSUG86NaShXic12AnTGKkRoetNY6T57bveeZKhIVyHC2++TmGTcLXMgSaNt3FzaNJ4G7dCScDXeN/wktYEX+N99X1qgr7wMV4RTgZLGMc5AACsFm2Yrs8qxBSfTcPHeIk+xUeNVVKAQ68zLCaDJfz4fg0fv7T1+DjOIU0ymAyWWmAfaSTRl6SR82SwOBYGAPj2eVf6vVq04eLq7z0UF6Xl2rBEX0WDjQvPOyNAiY/jvCRoigOA0/g6kOi7jKfwwucmlW+cMADA6aeX+rrfHfnQesNH//3l21rcLVdhSpOssujx4al0jY3fzHaQJhlbgbFGURSFLfx99bHxaZJZ9c1C6RUBCirHJoMlbG+fxy6uXuv5zYw+naZA6U/X7/Q85SwXnA5YLdqlEFTA+Q4AMD/PYRw/X6sTUqcQ0tBw+jjf4c9fI0Au1meLoCo+ahOActE0vt8dlTa5vX2lN4X/niSw6ZvGg1EnJPqkA7C4gtrE9ud1aXwz28H8w9cKB25WpE6w6ZtIkyxIv+IAUxx71ix2KuePT470OC5Q5nof2PSpYheq3zKrMrV4HOelsLcVOxV+nLD5r8O1r6Y+DntbsXPpezdC3MnPz2nix4cnMky50HWBO3kzNUL1yVYYd19Ug6M20X/zC45PjvQG7+5vIip/p+szXYl9WmGsTzU4IfqmFvv01usMC1zw+t0RSQJMA0PNS54GqaIVqk81XWwfwBlPCXIbbRL70mdfiOgbGnqokbxvwGjKmVzL7fW4GgoJ5z5eidk4D/6l6P/X4jaSg/4wonDQn8YwDvbjKIV/6fP4b2BkyaBYp0W6AAAAAElFTkSuQmCC",d0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYAAAAAwCAYAAAAYeq1+AAAAAXNSR0IArs4c6QAACNxJREFUeJztnU9u2zoQxicP7xhZJM4VHCBdtL1C212aKzRddBHkCA9ZeBHnCq4BB0hzhbYLGWiuUDeAdQ+9RUKDlflnhhyKpDMfUCC1JOrHj0MOKUsygEgkEolEIpFIJBKJRCKRSCR6aRodjLvRwbjLzSESKUk8ptFeysL1Rls9PiQ9VwqF8qvjctc5hH90MO5+//kFy+USzk7Ps9bhJfqfkoXKUAq/ismjw+OgOADxP17UDDw6GHdd13Xr9bprmoY0oyxhBhrKr46j1plbFH7lt87eNE03mUyy1aE0/2uOf8VCZQjl55TOsVgsOj1WXT6Vwg+F+0+aFWIysAL9/ecXtG0LbdvCer0GAIDLiysATzZLNQPFZmAMv0uKHQCgaRq4uf46aPYO4Z/Np3B7ewv3dz9gNp9u2Nu2hfu7Hyz8Nftfc/yr8tq2haZpUB7G8IPmAVfcfP/5DZqmgeVyCfd3P+D3n18AAJt2Pjs9Z+XnVOn+/0upwH9XF3B5ceXMRKqj6PBt2/a3W8vQO/Cnzx/h5hrISydbHY4Oj61l6R3XxT+bT+Hk5GTDqKQGUH3w0Y+LFWYA1QcqCr9ih+fO9OnzR/bBv1b/dyH+1eCjyu0PoLpOTk5Q/K521BJYNPvq8WHv7ev33bsPbzYxenR4DAAA/11dADzHBBc/MCcwKNx/bwKgVkB91u986v/L5fKvIFfK3YFVEPn41WxjNp9C0zSbbSUMoLP5NIi/z3lzDawzuNr9rzn+MQOoOqe+AvTx25JYigSm2KAXkyqW3n14E8yvl6dPQoZMYDn9R18C0iugZKpAf7vKZKozKpNtHViBc3VgzBISerNgF79err6vaRv3AOpaQs7m062lMJa/zzn0Eh4K9h8qj39wtLXJQ/0zH7+ulJcQ1erXtgrW25vK3+8zqS4hqr9L8x+dALAVwBznOzZHBzYZVcJdKJQBdDKZRPPrnSzkzgVbmbX67+KoKf5dA6jrOBOf2vbp80eAASZwfW8osezjf/XqFUDmBBbDDwNMIDYgoXdChBzHfReEqUzsnQTUb+9Nf8dodDDuvnz5snX3w2Kx6BaLxWZbyfy1+x9SXgnxb/KccqyL39euEdhWXm7+yWTyV/8xfVYyf6z/qC+BVRYJyWLU65gpZqBgWF4BcobF+UVujFzXQPuf66Lw9/0OaW+bavV/V+I/VC7+1Gym+lPbwMff/77L9FlOpfb/n9gCSpepAw9xLu7zmRp79fiwp/5xnCOFdsX/GuUaQFOfsxbvU/afGvx3JgCOCnDMQNEFJFCJM1DK8Vh+26wqdxvk9F/iP5//rlk+xZfQFVgJ3sMA/idfAaiHGHKIowNj+UsdQMX/l+k/1wBK4S8xgYn/7vNYEwBXBUz3SlPOlzuIsPwpxDGAYvhLuNZsUy7/Jf6flMN/TDxifaHwl5jAUvuffAXQv/VvKHF1YAx/yQMoh/8hHUH8f1KO+OccQLH8pSYw8T/Af+wBrv1GxJeRcfBwlsnJj92HyufbjuHnaOtQPt/2XP7XHv9D82PKwvBQ93Xtn4ufsn8J/idZAYy0p1fVlxiz+TT4vmxqFovNwBT+Emef3P4DsQ3E/3zxT/HDVi6Vv7Q2SBH/lHPX5P/WcwAhFTDt33+TnU2lBY8Slh8ryv3LlAHUdf+/j18FVMgMLXWb5fJf4v9JnP5TvIfAGXe/bAp/iW0wlP+ol8HFSs9koRq6A+uy8Zc8gOoy8atZRojUy6xMEv+3NVT8cw6gulz8XINnTDzCU0x6J0OhypHAdKX0/68EwFWB1fMb8NS7XmzvpSi1A2P4Sx5Asf4D8T7joe4Jz+V/zfHPOYBS4gcrSrLHSu27v7+/dS4sf4kJbEj/WTrUcwXIL8OK6cC2xgwq0JJQMPwhAev6oQ9qQLr2d/Gr7d9/fiMP7Db+mv2vPf5j/Njf34e3r9+TX8aXor1TxSNHf/P1tRr937oExJGBdX3/+Q3evn7vLYNyPpNSLSFt/KvHh72jw+OggLUpxRKS4r/veqPtrZ2wI/5DxfEf44dp8FGy8adaAYfEo0su/zlXYLX6v0kAqSpwe3trPKaWDmzjN52vxAHUxb96fNg7Oz3v+u8W78v2Tn7bvliV5P8uxj/HAErxn8JmUkg8gmN2Dw7+WhJYav+dKwCOCvgAS+/AvllX6QMottPp1xtNZfjYd9H/muIfEg2gNv5UCYwSjz522/GU7ZR9a/TfOBNVFbAFJLYC2GtwlPP57oLQzad04NBriGq/2AEUMl0D7e+rfmQCiB0NdsD/fh1qi3+9TI4BFHMNOqS9sXUARzz62LH8nP1NL7cW/61BGVsBtcRaLpewXq/h8uLKuW9pHZjCDwUOoFT+fj2UqHce1Oy/Xlat8a+XCREDKJY/RQIz1UMXNo59/CUnsKH8Nz4HsHp82FM/NhKTgRU8ZunkOx82cDiXkFh+vRz1YxL9zynsXEtICn8Ir+34Wv3Xj6k1/vtsfT8oZWH4uS4husqnHqPk409xCVEvGyrw3/ogGEcFKE+xldiBQ57CK2kAzfUq3Jr975dTY/xzHY/lT5HAOIThLzmBDeF/skYJXbqVwpGbn2MJ2f9M/B9OL5U/9hIil6j8nJcQOVS7/zB6fpudUsxDCzlUCv+o90PwWI5S+EMl/Hn1UvlD+loKDeU/e3ZQoKan4ly3+5Ui4c8r4c8r4c+roflZC9MfrmgtLzA6Oz0HKHQ5LPx5Jfx5Jfx5lYOfzQQXvOnLDOxtiUNJ+PNK+PNK+PMqF390ARzXpnI2hPALf4yEX/hjlJs/6vcA9AdYQnV5cRV1fIyEX/hjJPzCH6MS+IMyR8pvx4fIxsJvl/D7Jfx2Cb9fJfGTVwCjg3Gn3yvLqZvrr0nK1SX8dgm/X8Jvl/D7VRp/9Hs5UihVFhZ+nITfLOHHSfjNKpEfvQIYHYy7dx/eBENRdH8H7D/SLPx4Cf+2hB8v4d9WqfxBj+QPrZjGEP54CX9eCX9evWR+kUgkEolEIpFIJBKJRCKRSCQSiUQikUgkElWk/wFLjIZEUKFiEgAAAABJRU5ErkJggg==",u0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAALpJREFUSIm9VckNwzAMq4ru4Wm8lAfIUpkmk7ivAIFrUqQe1dPmIfmQ4iVEH23u1s/jioxLAUjYMdpuqMKK0c/CThxlqGCDEZQzznixAz0BfbRZMbo5b4XQR5vVewmW/bqHMAh/HlfQCpCYU1Gw7Fl2LIknLq1gFUIVIY5lwIyQScnAiU+F5Lwsy6DSVdN/4AqvWmkF7kdbg/Yit/nZvegGofdvVVDJWOH9d+AwohLSyKwY2UNfNVLu6AtJL5wohWOTxAAAAABJRU5ErkJggg==",f0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAuhJREFUaIHtmDFo1FAYx/+1glTUxeG4o2Du4lKwS7lmkXBxER2cxAQXCS4O16FTaysULEel+5XidpvNOcpxbpcjcMJdtgpdTJNBKreKKA4SB32vaZqc1fcVj5IfhHu59/He933v+9738oCMjIyMM0VJKofsSeunnO8c5WAlqRwWZipo593U/nbeJTVigmqgklQOc5KMyalpHOx1sR+4iWMzuWHgpcr8DedFB0iDOlTSIDfgYK+LnCSn9g8Dj3Q+shBCJDwAQFPUY/0bm1WsLm/BajZIwgeUSRxVfhh4MJ2FI/0bm1X+a+gmWYiRh5CmqLAB3A2Awq4PdbYIAFhd3qKeCqA2oPHdgtk/NAIArGYDABLzgq2CSDiR1gHzggFNUbnSDEM30evsQFNUaIqKXmcHhm7C0E3hOUkNGAYerGYjVTGWB/G2CKQG5CSZbHc5KaSVmLUN3YTddzA5NQ11tgir2TiWA6weiBpMlsT7gTsR3UoZzq6PwkyF70YMi+goQRpCiHhWU1T8+PbxSJ/dd2D3HdL5TiVe40WqMFMBAL4Kdt/BO9simfvUEu5PlZYq2U9tBaK5QJWwSQgncZKn2XmftVldsJpIXBURw4Q8Elc+J8mJlZgRLXBxmX81gmQX2q4twvMHvBIDgOcPsF1b5G3PH3B5u+/g8aP7/PlvsI/325frYUkqh1HS/l9ZqocrS3X+Xlt7kXoBcBKEViC67HPVFuTiPH/mqi0ul3SUlovzAIBnz5+KqEB7nJ6rtrBw5xLqb78k9jNDWDFjRogkMfkHTeXGRdy8dgsPX75JlaG6kQD1UeLVk3vovv+aqHzc+1SQGjDK6wxK74MihPYDdwISwuvrwJW1B/z/z+uv8eHq4TGaba/U1Vh4sOhN2yjiMmORA0x5TVHh+QO08y5yksy9zpRk74ZucpmxuFb5rWC40dn5dWH1qQzg+Eowz1uBB+h19DarfAsdC0Zdp4vIZmRkZGRkZIw7PwFWwmQPmkz7+wAAAABJRU5ErkJggg==",_0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAA/pJREFUaIHtl19oW1Ucxz91QQpjT4LQ1dOGSxg1tJCEi3TM2aRV5oOQiUUd2KIwBxvrVuSywRAkUEYrQZ0KhWww2WQ6CMiYb3Omg0mCBhdI6bIS47pL9jLKQF9kFq4PN/f23iQVk3scIvf7cvI7+f3O+f0/vws+fPjw8b+AElQNmXyPFUpQNf787TmjnXLOvb/j6xZPyDroxePvQRuFVysF157FJwueDVCCqiESGp/Pjrn2mr1s0dcXJxEJTVoqBWQcoufSMDuGSGgAfHfmI9vTt+88YLVSsHlv33lg8kuClBQSCY2jn9ywaUt5Z1Sa+WWhR8YhVho58cOFtwDYM/1lC63n0tTuFqXc7RlWvitB1cjORIzy+RkjsC1g/JjXjY0/NozAtkAL/Z/pQpbnRULj8rUCJ65ullQs2seuodEtaVmQUgPXFycBCIeHZBzXEaR0ISf6QyMu+ta5wwD0bu8F4Osjw5y4Ku8+KRGYOJwFYGWlAg2le7f3ck8v8eyBj0mm8gyICAMiwvjrR2RcacNzJ3AW5PTORxxbOApAvVomenCxrcyAiEjrQp4OsYpYz6WZ3vmI1941+35/aISn46anX973JisrFcLhIddqwashXadQcyu8cP9Jkqk8yVSeerVsKx+JRAFaVqt7eW2pXRWxElQNMRiHRgeaMOsUPZdGDMZJppZcyt7TS8wvlBrSBwBIn5okKjBlc2mj20h0bICtvKLae+lTZhvVakX0tSXEYBwxGGd+4SQAe56ftXnnF04yICIuWa1WBOjKiI4MaKf8LR2iwlxRVASgry2xWikwsc8prJrKHjTJN14a5fK1gv2fMH91bIS07wHtdNZWBjYNSp+bd0eriW6W6xTdPWS1YksUrBG53aRppZhLXhI6CpezeGmkioVffv2J5S+OkUzlockQpwHa6WzL94BIaNCon05TqKMINA43ACxDrnywm+G3P+XhzbONMSLfEgU7TcCl/KbRaZyO+dcMwP3wGDQerYc3z1Kvlm3vA+ztq5N853hbI4oXD7Wc24338VLE1mXWo9UfGnEp5lTeVrLhfXUqQ71adkSt+xfZ0zRau1vsSaYwIE/x4iHbmGZcOX8G6Ldpp6FbyfxTeG6jlufUqQzJVN7OZWfKNPOrUxnUqYzXq0HWNNq2ABWVvX11m7x06auWNLHmIC8Dnedp1EmL9RLEZu1xwoK+toRYL6E/FeHDF55hfybLrqFRKSN11weM7QgYM6++wv5MlrnxGMMhBYDPvvmWG79v9DiNE+slEiNhhkMKy9VaC68XAzx/Us6Nx3j/+5+ZG4+59p3eFTsCBsBytYZzlQFPEWi3v5VHO+X34cOHDx8+fPh4DPgLH7O+nPtWwn0AAAAASUVORK5CYII=",g0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAA8lJREFUaIHtWDFoE1EY/s4USwVBsYNIF+uk6HpQ8eJlKc3gUBCC6NAtiKFLIWqFgIEqJnQp55Ch4FCxmRwcLrgkJuBw4FRpp+ISSgOKXapEEp9D73++u9wl95I2VbgPjpZ7/12/7/+/9/6/B4QIESJEiBAh/iOYAKPLb32YfE7IBJsAW4ovYHLKf31yavgiAsEE2JSeYDfiC77ZF+OGJWKk3wf/lSxLC3hiLiOrJ3zXM5Vi1+fdwuOAIstBhNTDJsCIvK5qHevPXjzA4sOXiOZSHcSI+M5sC2qsDQCwyhFceDsykJDAm1gkn6kUMVdLdZCnn9W04ci0CbCd2Rammwxz6xH+jBprY2KliZ3ZVt+WlLaQrmrI2iJqZ75Au3YRALD48KVnPJEXiV9JnsRm4ZdDiIUWzLcjTLYSUgJeNYuYs/6KiACI5g4q4d4XUYG8Gmtjs9DGleRJAHCQH1SEVB+YG01AVzVOmlBNG/hYXoeuatBVDR/L66imDU6MsFn45UleFCELKQGZShHRXIqTc4P2AezKTKw0O2K+7X73/J0wsdKU2g9SArJ6ou/TwipHUJ8fxfbWOKxyBFY5gu2tcdTnR2GVIwHe4A2pPWCf8awq3KumDURzKVy3avze9VgNGZu0rC2oKlSFXgkLXAF6kXuz1ja+YCm+wP2vqxoylSJ2ZluALQKCv0VBXve2t8YBu18EOV6lLASh0+qqhvbPumOtYtUQzaU4eQKJGFvc5YSJNN0TITa7XiL68rP7hUvxBcAeM0Tyaqzt8HcvO33b/c4r4O7Wflbqew7xywoJEMkGFeG2GwII6GsaFccKeAxw/WxcyryIIKdTzwp4ZTqrJzjprJ7ggx01OPKwSICGNqrQpctfce78WdTnRwH7kKDOLaJb9nsKcJMnsu5OTKAG597IIole47TsuB1IwIm1NUzfvYuS8jd8hjG8f/0av+/dwww7+Js00FWsWoetBp37/RDoGF2+v4eSomCGMX6VFAXL9/cccTRK6KrG4z5lnh8Fb46uAsSsreYbKCkKv1bzDR7nNUpTtZ48fXTIlJ2QamSr+QbGNvYd5EWIFoItoqQoR2Yf9NOJb149hTfJW11jMpUi4oBC1yAEe0FKwJvkLXz4/AN3Cu861tzZHxakBHgRd4OyPwipQ4cJsOnTBrudb7DKxj67nW+w6dMGo49Yj9NG18+NR4lAnVjsvH5wxwyrCl0tROTpXJ+cOiBKc5D7f4Rq2uAx/8qXO5gAY4w5bCLaxX3vcdpgjLFjsZMvZPx9XHshRIgQIY4HfwAAqOz+tklkrgAAAABJRU5ErkJggg==",p0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAQJJREFUWIXtls0NgyAUx/+0xiU6ThfoyRV6781bb3jpAF3CdIfO0gG8mjSvh0pFQATUEBp/CRHkCe+LJ0BkmPri/jqR6J8PD21+aXZrb7ApMAWTYz5FlxOq/FiemNbVZH094KysK94hIKUNu/1YlrkB4GZZZOpRGzmGhDXMB5BNzA83JgLa9o0834MxyHPMouRFGZfSZ9FPgb8CRfGzXkYLriNaCJScWCPsdgWsGCyfS2I5QATUdUQFIiKqW1B7AsS1AvolGQ8I6OppPQfoaCkTyXkAABqXfODDuDdji0X3wJzSZvz7Vd2zdNwjaQ8ICP2Nx9lyQXQPLEnQleCvPLARxAd9AZHBGwzNIwAAAABJRU5ErkJggg==",m0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAA7VJREFUWIXtl89rXFUUxz/3/ZiZxKntIgSr7ThJhErSpimChkaxVYqSlQj+QOtCjXbhHyAiLairgnTjqhIRxUWzMuLKGjShzRChqLXNTAO1SV6qMYk0STOZzHvz3r0uknmZycyb/By68cDA5d0z3/M953zvue/BPTax9sH5v15Q+fWph3pL9nfatGoHWM+MnQST9oISf18DQDQc3VD1tkUgl11Q8pceNMBoaEFNXvP31GhCbYSEKOz5elaoiV8/PKGOvH0GZ2KEUKwZzxrBwyMUay7+k24gYo8HEtmWBqavJgjFDwEglU0o1oxjJXHGCiohDOTNSyr72/dlE90ygbG0hOwdpi5/C5m7mPUxWJpDRqI+Kfvf2wihQNPIZZfK4mz5GJ55pV29cfRRJIJIzS76plwEEV7r7EBKCcCN3s850vURuVwOc3cddipB5Ng7RZhbFuHHPUPiuf2G0nWD9rP9Puhbp88BMPT+MfVY5+ukb10l2ngYMvNlcbZ1Cjo+vRxYofaz/cLuPKmijYcrYtzzQVTVUWsPdCvAP5pSgjY5jHhyVQdVq0A+eKG5t5Mlfjs6iguDlwwkwNjXDJPDmyegRhNlh8hG530lq9gCNZpQ8tZg4KiW1hW1llwlf00D9rXy5Sfv+T6BBPI9FKJ8ksqIIDzHJwogh75RuYlUYEKOtUkNOFay9HIBlB5CuFnfZ/hiD9lLX6mcnSXU0AqeWwm2yNY9BY6VxB4vEI4R9jMva56LEsGw9tgfmyPAShscKwkzFqxkDpAbv16WsFASlFeyJ6Xk+g8Xip4FtkDoIUQui9RWOTpLabAKerySqRIaOGkwwoUAZXHvb2rDm1ytYGAFjAebGO7vZVGazC1kgtwAOHjiJVJ931X0AYjUxwHoOv3Z+pNQGCbxVz9g/OIX7NkV5Z/ZzIr76u/mjxdI9vUA0Pz8y/66RO1C4EX2kLEXqdv/SPFWEAF7oFsRrUMPmQx+fY6mtieYSV0p8jnw7IsYawSXF6ARa0Fj+bi7ZpRMapD76vaiL84U3QUVCZgNbciZCTxP4C5NY6BhCIm3/L6BGT8EqnjuFArTfPjgCisXe34eOz1LreZhdrzpxw0U4c9/znOc3wk1tKDPTqHX7MVdmEN7II6WF5hScHd6ebm7HqEKggJSD6PhkhsbQSiPsFKYTxW/EW1oltsD3cp1XWobW8vuO1aS8NNdPlZ+MqZtD3NhBpG5g5SSmuPvlsTb1GWS+el8cb2FB0qn9plTVf+E+9+qZv8BLaSEjQIODXEAAAAASUVORK5CYII=",v0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAA11JREFUWIXtls1vFVUYxn/vOTO3rRITIUYTN7Iz6UpBWqMNSSHEKIZu0EQXfi0MuUBBF7b8AYQNtKOicaEsBK0mJrBADca7QZKmAXa90bAgLIwrwqYKvXfOeV3M3LkzvXM/KBoX8qzmnPN+POe87zznwH8MWTvx2e9T2vp+9/GzHev/NMy/neA+gX6QfM37Id8TYk1XP3V+4N4JBjUswIju+WmmdOnsrgj4c+BQ6yMA/FFfKV+IR+6KwEC/oQ1EnYbgGpl9IIE6HHt+nuXa+Rssz5/BOsGJgrbjhgHaNBYarrQsfZuwwpC+fGGW0UN7YYiEnLHqjCffBoEbRsRignaeEQJ96cIRpn78ABuGpT3TuwQPP6Yvfvc2187fSHbjhmjaVQ2cY3ftCKSl2LB5E7tr72Vu53YeVcGwis98nzz4CvX5b1RdXDiJniXY/8Q5mukup35oJ2xhsRp1cB4/OZ19r1y/CcDy3AKEjjC2NJ3rTaAMJhR9Zu5AIbHXvzDyAABbnnqdy1dPgwqxgzBsE1m5fpPf5r4m9uW/Zn8hEtT6ttliNcJ7nyUHuHz1NCKCmCR5I3c6GzZvwhmPCSqlPTAAAeHpqJok3xfhUSbG3ymY7NgxWxi/MDlDgzsZCeUhTNwsDd//L/AVAGr7IrwBg3Jp6fOchSf2tws+tdoxKgzj8QCMzb9JLOXC2ZdAw24EYEgbmDRgyy0byTDNkvgG025UfQQTdrLoTcCIjkV7IalEat52yd8GoXhUu18ro+/vwrvO9YGl2JiA57a9xcWlU20K0uIpjD17mAdHRjL7Wu0YE88f4OIvH2VzohbFrY8AGC4tncqOPY9a7SieGOMrhTPNJ08YOFhzCH174Mr+L9KvuIuDSatd6RmtfuIrwqBS6t0dXsWbO+kgWHN4veGBVU0EqaWIjUajQ4z660DaaeMnp7Hp1M6J8rdAC5OTM3hg+yeJGi5/uoCILbUdSIptILp1PpHixWoEvgkmzNZ9yU7yUlw/sYBq+XU88NPJgm79+GA2XqxGOBSLsm3LGyxd+RKPx2AKyX89/i2OZtc8d/fuFxR5lLEPX+1q0qp3fe4MigVfvvP1EUgfo6IGbxyj068V1urR94jeAk2VsssNeE8E8jC2U/zU31vM+/j/4W8T90THLuTz5AAAAABJRU5ErkJggg==",w0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAACxJREFUOI1jYBgFo2AUMDAwMDDiklBSMElDF7v34MwsogzAphmXIRS7gGIAACcyDARxUxk1AAAADmVYSWZNTQAqAAAACAAAAAAAAADSU5MAAAAASUVORK5CYII=",x0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAQCAYAAACBSfjBAAAAAXNSR0IArs4c6QAAAqxJREFUWIXtl01IG0EYhp+VtgQtFLxEC4E1gVaKCrWr2IDU1B4aaKmH1rSeclQQ+oM3C6WgtxwsFOwxp9IEDxa8tlEECSbtIU3RLN0YENSoCIWiSNHtYc26+d+DNQZ8YJmd75sZZl7eL5mFc04WuyiplcxXG4KxYxclVVmJ4GjqIJmKCrmDzeQTsRqutx3qebsoqcb33LyRxluDpsRd//Yhb26luJAbkJ0CVtEDoBoPaRcl1So6kJ0CIBVd8N7zV4BPnyMvh7nW3KWvZcwbabw1qK5FJ01t+qqEelZEzBPQvS4BCgC3ezxZjkinFNxFxLOLkmpzjfD+xR0ehXx5pZrpf5l8TO8QEPKphVxYbdQUCnr6vSgrEdIphZ7ObtIphYXQJzz93pKLrYY0Z9lcIyRiNcjLYZYSW8jLYf1ZSmzp44xsr8lau7mnP39G+5CdQlZse3NPH3sWKChgBmUlktWWw+YaYXhiDgDh0gJLia2i48ywFvpsalwlKSmgo6kjqy1FMhUVjM7qHZriZruN4Yk5eoemsNRZsNRZGJ6YYzXkK/gnksHy7hk7fbV6f6evlnBLe/nTVIC830Cr6CAQ9BMI+rGKDj3mdD0lnVLw9HsJBP0FF7tx+T7jL58cB4q8j0biJIkW3VQ1OC9DloBHrlCtooOezm5mF+eZXZwH0PpAIOgv6Z621uKmjv04NLWp+uldQHOe/KuZrvh3ukzNPH1KlvBJYla8aiOvhAH8+wG8i9q1JcPsUbzYNQZgJj4mPGxFHf/4FtDceLB/wE/52LCjA2+YiY8VdHA8tkFDwxW9Xz+9m+e8jY3f5c50quQJmExFBTeSCkpuqapupJLlC5qIDGgiaq4zJ16GsyZQOf7bRfZBy+u8z7Jy4l1svGvqU+7v+teqv4Cfc87J8A91AS7TrQNZcQAAAABJRU5ErkJggg==",b0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAAAQCAYAAADeWHeIAAAAAXNSR0IArs4c6QAAAHtJREFUaIHt2LERg0AMRNGVUQkeZ5ATcv3XAKGbuRscGLVwCvRfqGhntNGaHsty3EIZY1wmSSb9n9/7mZsIU7k3jXGZx/M/7z07Eybq/Sv3dnsctm3NzIMkr+wAyEUBiqMAxVGA4ihAcewARcUOYHFgCawllkAAAAAU9AOxxh7Hp5aGdAAAAABJRU5ErkJggg==",A0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAHCAYAAADJTCeUAAAAAXNSR0IArs4c6QAAACFJREFUCJljSDvw/j/Toz1vGJgYGBigxINr56EsBS1DBgDNQgirkuOzpAAAAABJRU5ErkJggg==",y0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAHCAYAAADJTCeUAAAAAXNSR0IArs4c6QAAACdJREFUCJlj+N+v+Z/hvzPDfyYGBgYGJgYGBgaGJwKaEC7Df2eG/wC26QlbSztwcgAAAABJRU5ErkJggg==",C0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAHCAYAAADJTCeUAAAAAXNSR0IArs4c6QAAABRJREFUCJlj+P///38mBgYGBpwEAIJzBAn3xZTnAAAAAElFTkSuQmCC",S0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAHFJREFUOI1jYBgFjHCWrNR/knQ+fsbIwMDAwIIsdvPRI4L61MOCGBhOnIHzEQY8fsaoLif3/+ajRwz6DO8Yyhi4GLoYvpHkKAiQlfp/8/+f/xz/X2FghlC//8R5FYshxGvGYgjpmpEMIV8zsiGjAC8AABuXSEe8+vBUAAAAAElFTkSuQmCC",P0=""+new URL("sfx-enemy-kill-BneAiP4n.mp3",import.meta.url).href,T0="data:audio/mpeg;base64,SUQzBAAAAAAAIlRTU0UAAAAOAAADTGF2ZjYxLjEuMTAwAAAAAAAAAAAAAAD/+0DAAAAAAAAAAAAAAAAAAAAAAABJbmZvAAAADwAAAAwAAAqBACUlJSUlJSUlOTk5OTk5OTlMTExMTExMTGBgYGBgYGBgYHR0dHR0dHR0iIiIiIiIiIicnJycnJycnJywsLCwsLCwsMTExMTExMTE2NjY2NjY2NjY7Ozs7Ozs7Oz//////////wAAAABMYXZjNjEuMy4AAAAAAAAAAAAAAAAkA78AAAAAAAAKgVBvV3QAAAAAAP/7UMQAAAjccxBUYwABkZfq9x6AAAAUMgQIYeAwGFsAwvYw8mTYHAZMmTJp7BMnsRnvf/3u9a78Z72Caegg638H3g/y5/4gBD//D9YfEZ8ochj3cH3w+Xfwx/ggWKRU5FaLRWLBWazWAg/jneiChEansyMCdO+lFBEW14/NOBwckIeSeHESl90MJY0kekIluMMowxHGjn79E4qrLHvPVe9p74cVp2Mo3f0kAglBe9zX06GnAGs0Sw3/pOJ9xRzFxZVR851MJT+NhhogAkDSEAb/+1LEB4IMaG9YHYeAAWuW7ej2DTClrB2XIAIIWDYPLEiAg7AaY/zrvdHw26tlZV+xv6QlZEy/Y7RYUalYfmh5j0GvEZ4LBCOFQmwbeoqKLI7xfA7QTVF3U0p4fh+q1ep1NTqdWXfl6uPANhOSOTBbRSSuPgtx+ACAhthaJSE0Szc8VZA3+U0yUetYWpXbKF60eptpTJ7kDObYwehEIOwgiYsIzu6vllWSmbgmJhxpwJGgi4ROBmfV/dgD2pZ9TW/7U6U0qoEgFJuS07IKNMBriv/7UsQGAAvoq2zsMGjBbZwv/YYMtD6kzJNXdKDy1AHcukgmL0cC14qwQSAPSIhEQzr5e9OERtlJSSEMheNl4qlaXkXmCMPPBlqXvWZOFz51zbmspMbBVszfF6aF60ZNgq1j0vTJW0qFoMjBlNka2aXa8yGQDNZdWIsHAHJou00ORwFwcp7R3VKz48xtcEzDx6IMKFCWttKt70tHDU4iVSJkaQ/2p//aVa9zk8r/CfOZLg1mTKhv1hJVgb0fOI967fIjf2WNhvRRxtuOXgNykJEm//tSxAaADBR9d6ewZ2F2Cy309gzsTsRIS0MoVDuyPp2B0Wk5LJ9nLbvNMib3ATdxa2hdaVjNXErS3Qm2Gech8a9Q9J4JDjwMU2Pl0YoauScO7K7zbIpYcQ4eVZovHLmgCsaq6Ig6x9lgYDPZRKSLTdMGh0lvQwGGA4oSB8tENgSQZnBirjVLSUqeWrZHpXHFl3JwDVwSSiWiR7DwhYFhRsfQhYcZNYjWHGg6cFmLpC84CcQoxRKR0z2s9D9xdTWEBzjW/0IOKggLM2UG3JJaTCX/+1LEBQALsJltp6RugXEV7bDzDdxHESCvHGSBXotRH+jjYNBJHpR66mxE6GWiPbkqpbSD0ndeE0PhFTNtCU6UzJM4lHlRYkBghxbA4jFAgQPaicQJODNWqse+1tLA4is0Xqn1OowN2NZEenSXPRUHW2uzPHaHKTk9zlSCKcG86C7oFtYlACG0pZqCE3SugrbaXqpHpwjy/NzKpkVpNfpZ9tJTuLzowIv6eRdrTEg+o0GLjiL22LcorzDQVCRFgmDvCblKqg0ACq4KVIJgKUvxof/7UsQGAAtwXVzHmA8BVwzs9MSM5MUWkNUJoLUI9WWMtFECJGW5YMRk1UUSJN/lV5k0UFr0hkKPAx8WNWh5BuPETy0MmKXyREktLYFO4u4bqi5xJo6+6S1akgOzNhg0SEBrDtiw0bto67I2k2Dx8WgFBKGwNmg0kJwGEwKhESwIHSWTVBVQYGFp/AyKQuGyI7jh1EjkCxkKPC4pJJUbh1xVRYyYMVVCJb9UpS8yj802TZeStxAR3eRs42oAhIQelQDuXA0xplAbjqSCE6Nz4uH+//tSxAsACki9VSewY8FPjKpw8w2Q0LUKU9QvgpzoWKHQ9SbLj8JCtPMquSGpGbHECn3g/3Mz2hTLXYwRBQSnbcjO6rlY70kVB3FI5O3/7af6wUg4kx1VVj0LseBoKItWY5WpbSzs53sU8jBEvjFwp7rFgrpCSVOIqFkDIRDwPWuGyxU6hs8K1EQobFDZu+qzs0sXJO6Eqe6tU9kUXPNpXNJOyOoJ1QlegKSiaKFiGAsFQFXU4zITUmxGOkPT8fVq2FaLZZ5rjDG0VRTPmoZCN17/+1LEFYAKPG1NR7BhwUaL6KWGDDBRpYqG1FxGFxCBg6aBk45LzBl6ZMLoj49VG/JO2JH0fZ/klv3p6tgEuiCksQwtpoFzQKnx7HQfCYIpKeJY6pjI+FsoEwfGCv6q0CrJFL6aiVjSYHWSHJNKk44CkgdWUxCdk6nqVTN+BTbEcs0R56n7ve5T12NiyrL1FKBAAhAaLDUB4FlweoiUaGEY1gUQIFCqSqeXz5cUIioLCAcDAYeTFwo5AoCALisYIFLtRI1C2KEvc3Giuo7NaNtaXv/7UsQhgAl8Nz8MMSCBUJDn5PYMcCqkbdxhVf+73E/PgrKUE3UgfhfA4JRMHcdRJA6oqIIwEkssHCViAiCq8EvAw8lOK5IOTEDBlcnvHBEubLRmHqJGh18kxwyt+ofvoTYBL2kdhG9aw2i+ocgl97P/6CVNACYelgOwWUtx0F5RA7DsbiUE5gDc9HqIcUiCYwkAY1pV+Yci0WbWsc+FlBwMhsJsU80YLAYMCtwdPJal6FPU+lHkcRYbcEEZ1J1IiArTQwO21lBVNNKqkQVFkHwG//tSxC+ACnxfNwewxwFJlubwww3kCkfA1aoX3SoRygZjq64WK0KK5RK3LQ3pobSOGLL1TqalDNtTZf7DbOkGLrl9UtcjzuWOAnmizmq4FslWGtSlnlwbkVPBWiPVAQmAFQ6LwHozFIvAUTgBIgSH2zA+5dCs2JCY0FS1GpRROPoyuSLVJ4CjAKCr1QlEYKuW1Z1ocAwiEolAJbUJXBIdi+8YWXuy3w0LUfv1aqAqyABMiXH8LkXLLGhCKgSNYiVZmSnkqlyxwTYzPRUFGWzO18z/+1LEOgIJ+FkipiTHASSQYxj0jGijNRjZtmhBg8qG0PMioFZiw5/JXS3NK87yXHKpan0Xo++/XbRSBJZQwEOdCRIFSISPSQifKhIGjx2GsRNWdkcRZ46sZPSLT3lSwC55ZZ+ieOnZ5p1Q/vlXrdaHQk8ZLIiERCXw7h28egKCdDI1kpGTLLZUcj9llsdDJlkpGTKwMGCcMmf/4SFxGZBYWFWf/U2LCzP4tioqKCxrFjTxUUFqhb+sVaaAoVDFTEFNRTMuMTAwVVVVVVVVVVVVVf/7UsRLgwhoBwhBCGABAY5VADAOQFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",E0=""+new URL("sfx-shoot-arrow-DFaw4xCo.mp3",import.meta.url).href,I0=""+new URL("sfx-player-hurt-CCE8627I.mp3",import.meta.url).href,R0=""+new URL("sfx-pickup-general-DW7SsHNM.mp3",import.meta.url).href,D0=""+new URL("sfx-death-TOGcuXFX.mp3",import.meta.url).href,F0=""+new URL("sfx-player-switch-YecUMPyN.mp3",import.meta.url).href,M0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASAAAAAKCAYAAAAUw4NkAAAAAXNSR0IArs4c6QAAAS5JREFUaIHtmV1qg0AUhb8JeWiiQukK8rOFhG6hi+iSZw3DLKC0hdifh0L6UIQYTRO90qnkfOBL9Nx7HMnhjrrVYrNHCCESMAW4vZv3LpDnmcmAXZ8n7t9fb/Vu7T+Mfrzrj/yb+heFrfd6ucUBrBabfZ8QuubFt+oVPvI/Zv+XhM/XbgfAtCga59bLLSF6N6l+eH1+72Tgmhffqlf4yP+Y/V86+bQFT+MagBD9zyREv0lICCHa+G36AZi0iYQQ4i+oBVCI3nXdigkhxCnKsqwdh9MPgDsWVJ/lZ9nN2eLZfGY2aKkxRP/cWMPkP7Nvd1P6/w968/0bn0Fy/4n/gwB5hzW8f3isBVBjCxaidyF69/H2aTIlhBCHHIcP1UvoU5wLoSFC6okXcw0hxDj5BobeSN7k/wjEAAAAAElFTkSuQmCC",B0="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAFCAYAAAB8ZH1oAAAAAXNSR0IArs4c6QAAAElJREFUCJljZGBgYGDKrP/PgAf8m97IyALj/J3WwFB+5yOGop6+flQBpsz6///////PcBmBcdrE5h8HV8zmH4fXOQxs/nFYFQEAe5Yn3JE1KAQAAAAASUVORK5CYII=",ut={tsetD1:new xt(Vw),ground:new xt(Nw),overlay:new xt(Gw),fence:new xt(Xw),tree:new xt(qw),purpleGuy:new xt(Yw),purpleShadow:new xt(jw),lifebar:new xt(Zw),buttonUp:new xt(Qw),buttonDown:new xt(Jw),playerShadow:new xt(Kw),swordPlayerBody:new xt($w),swordPlayerHands:new xt(t0),swordPlayerHandArmed:new xt(e0),sword:new xt(i0),arrowPlayerBody:new xt(s0),arrowPlayerHands:new xt(n0),arrowPlayerHandsArmed:new xt(r0),bow:new xt(o0),arrow:new xt(a0),blessing:new xt(h0),soul:new xt(l0),cancel:new xt(c0),scale:new xt(d0),goLabel:new xt(u0),swordPlayerIcon:new xt(f0),bowPlayerIcon:new xt(_0),swordPlayerIconDamaged:new xt(g0),heart:new xt(p0),flex:new xt(m0),clock:new xt(v0),pickupshadow:new xt(w0),pickupSS:new xt(x0),timebar:new xt(b0),bluetik:new xt(A0),redtik:new xt(y0),whitetik:new xt(C0),activePlayerTik:new xt(S0),spectrum:new xt(M0),cursor:new xt(B0),sfxEnemyKilled:new vn(P0),sfxSwordSwing:new vn(T0),sfxShootArrow:new vn(E0),sfxPlayerHurt:new vn(I0),sfxGeneralPickup:new vn(R0),sfxDeath:new vn(D0),sfxPlayerSwitch:new vn(F0)},ds=.3,eg=si.fromImageSource({image:ut.pickupSS,grid:{rows:1,columns:2,spriteHeight:16,spriteWidth:16}}),Ti=si.fromImageSource({image:ut.scale,grid:{rows:1,columns:8,spriteHeight:48,spriteWidth:48}}),Ta=si.fromImageSource({image:ut.cancel,grid:{rows:1,columns:2,spriteHeight:32,spriteWidth:32}});si.fromImageSource({image:ut.tsetD1,grid:{rows:2,columns:2,spriteWidth:34,spriteHeight:17}});const aa=si.fromImageSource({image:ut.ground,grid:{rows:10,columns:5,spriteWidth:64,spriteHeight:32}}),$i=si.fromImageSource({image:ut.overlay,grid:{rows:10,columns:10,spriteHeight:16,spriteWidth:16}}),qe=si.fromImageSource({image:ut.purpleGuy,grid:{rows:3,columns:5,spriteHeight:32,spriteWidth:32}}),ig=si.fromImageSource({image:ut.playerShadow,grid:{rows:1,columns:1,spriteHeight:48,spriteWidth:48}}),bn=si.fromImageSource({image:ut.swordPlayerBody,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),An=si.fromImageSource({image:ut.swordPlayerHands,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),yn=si.fromImageSource({image:ut.swordPlayerHandArmed,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),Kn=si.fromImageSource({image:ut.sword,grid:{rows:1,columns:5,spriteHeight:80,spriteWidth:80}}),Cn=si.fromImageSource({image:ut.arrowPlayerBody,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),Sn=si.fromImageSource({image:ut.arrowPlayerHands,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),Pn=si.fromImageSource({image:ut.arrowPlayerHandsArmed,grid:{rows:1,columns:7,spriteHeight:48,spriteWidth:48}}),Xr=si.fromImageSource({image:ut.bow,grid:{rows:1,columns:4,spriteHeight:32,spriteWidth:32}}),sg=new Lw;for(let d of Object.values(ut))sg.addResource(d);const of=kt.fromHex("#99e550"),af=kt.fromHex("#6cd705"),k0=kt.fromHex("#ffe105"),L0=kt.fromHex("#f5c100"),U0=kt.fromHex("#ff2b05"),z0=kt.fromHex("#d41c00");class ng extends Ai{constructor(t,i,n){const o=new Ps({width:26,height:1,color:of}),h=new Ps({width:26,height:1,color:af});super({name:"outerHealthBar",width:t.x,height:t.y,pos:i,z:1}),this.dims=t,this.position=i,this.maxVal=n,this.graphics.use(ut.lifebar.toSprite()),this.percent=100,this.child1=new Ai({name:"innerHealthBar",width:10,height:t.y,pos:new bt(3,7),z:1}),this.child2=new Ai({name:"innerHealthBar2",width:10,height:t.y,pos:new bt(3,8),z:1}),this.child1.graphics.use(o),this.child2.graphics.use(h),this.addChild(this.child1),this.addChild(this.child2)}percent;child1;child2;setPercent(t){this.percent=t,this.percent<0&&(this.percent=0),this.percent>100&&(this.percent=100),this.percent>40&&(this.child1.graphics.use(new Ps({width:26,height:1,color:of})),this.child2.graphics.use(new Ps({width:26,height:1,color:af}))),this.percent<=40&&(this.child1.graphics.use(new Ps({width:26,height:1,color:k0})),this.child2.graphics.use(new Ps({width:26,height:1,color:L0}))),this.percent<=15&&(this.child1.graphics.use(new Ps({width:26,height:1,color:U0})),this.child2.graphics.use(new Ps({width:26,height:1,color:z0}))),this.child1.scale.x=this.percent/100,this.child1.scale.y=1,this.child2.scale.x=this.percent/100,this.child2.scale.y=1}}class Xl extends mi{bouncingchild;lightPlayerInstance=null;lifetime=1e4;constructor(t){super({radius:8,pos:t,collisionType:cs.Passive,collisionGroup:tg,z:1e3}),this.bouncingchild=new rg(eg.getSprite(1,0)),this.addChild(this.bouncingchild),this.graphics.use(ut.pickupshadow.toSprite()),setInterval(()=>this.lifeTik(),1e3)}lifeTik(){this.lifetime-=1e3,this.lifetime<=4e3&&this.actions.blink(400,400),this.lifetime<=0&&this.kill()}comeToActor(t){this.actions.clearActions(),this.actions.meet(t,150)}onPreUpdate(t,i){this.bouncingchild.graphics.isVisible=this.graphics.isVisible}}class ql extends mi{bouncingchild;lifetime=1e4;constructor(t){super({radius:8,pos:t,collisionType:cs.Passive,collisionGroup:tg,z:1e3}),this.bouncingchild=new rg(eg.getSprite(0,0)),this.addChild(this.bouncingchild),this.graphics.use(ut.pickupshadow.toSprite()),setInterval(()=>this.lifeTik(),1e3)}lifeTik(){this.lifetime-=1e3,this.lifetime<=4e3&&this.actions.blink(400,400),this.lifetime<=0&&this.kill()}comeToActor(t){this.actions.clearActions(),this.actions.meet(t,150)}onPreUpdate(t,i){this.bouncingchild.graphics.isVisible=this.graphics.isVisible}}class rg extends mi{constructor(t){super({radius:3,pos:tt(0,-20),z:1001}),this.graphics.use(t),this.actions.repeatForever(i=>{i.moveBy({offset:tt(0,10),duration:1500,easing:sf.EaseInOutCubic}).moveBy({offset:tt(0,-10),duration:1500,easing:sf.EaseInOutCubic})})}}class og extends td{_heldKeys=[];_keyEnable=!1;constructor(){super()}onAdd(t){this.owner=t}init(){window.addEventListener("keydown",t=>{if(!this._heldKeys.includes(t.key)){if(!this.keyEnable)return;this._heldKeys.push(t.code)}}),window.addEventListener("keyup",t=>{this.keyEnable||(this.keyEnable=!0);const i=this._heldKeys.indexOf(t.code);i>-1&&this._heldKeys.splice(i,1)})}get keys(){return this._heldKeys}set keyEnable(t){this._keyEnable=t}get keyEnable(){return this._keyEnable}onRemove(t){window.removeEventListener("keydown",this.init),window.removeEventListener("keyup",this.init)}update(t,i){}}class ee{controller;signalName;sender;callback;constructor(t,i){this.signalName=t,i?this.sender=i:this.sender=""}send(t){let i;t?i=new CustomEvent(this.signalName,{detail:{who:this.sender,params:[...t]}}):i=new CustomEvent(this.signalName,{detail:{who:this.sender}}),document.dispatchEvent(i)}listen(t){this.callback=t,this.controller=new AbortController,document.addEventListener(this.signalName,i=>{this.callback&&this.callback(i)},{signal:this.controller.signal})}stopListening(){this.controller&&this.controller.abort(),this.controller=null}}class mo extends td{type="animation";currentName="";_currentAnimationName=null;_animations;_speed=1;_frameDuration=new WeakMap;constructor(t){super(),this._animations=t}set(t,i=0,n){const o=this.owner.graphics.current;this.currentName=t;const h=this._animations[t];this.is(t)||(i?h.goToFrame(i,n):h.reset(),o&&(h.scale.setTo(o.scale.x,o.scale.y),h.opacity=o.opacity),this.owner.graphics.use(h))}reset(){const t=this._animations[this.currentName];t.goToFrame(0),t.reset()}tint(t){this.current!==void 0&&(t===null?this.current.tint=kt.White:this.current.tint=t)}get(t){return this._animations[t]}get current(){return this.owner.graphics.current}get currentFrame(){return this._animations[this.currentName].currentFrameIndex}is(t){return this.get(this._currentAnimationName)===this.get(t)}set speed(t){this._speed=t}get speed(){return this._speed}}const li=75,ar=450,H0=50,O0=50,W0=50,V0=50,N0=50,ag=new ze({strategy:He.Loop,frames:[{graphic:bn.getSprite(0,0),duration:ar},{graphic:bn.getSprite(1,0),duration:ar}]}),hg=ag.clone();hg.flipHorizontal=!0;const lg=new ze({strategy:He.Loop,frames:[{graphic:bn.getSprite(2,0),duration:li},{graphic:bn.getSprite(3,0),duration:li},{graphic:bn.getSprite(4,0),duration:li},{graphic:bn.getSprite(5,0),duration:li},{graphic:bn.getSprite(6,0),duration:li}]}),cg=lg.clone();cg.flipHorizontal=!0;const dg=new ze({strategy:He.Loop,frames:[{graphic:An.getSprite(0,0),duration:ar},{graphic:An.getSprite(1,0),duration:ar}]}),ug=dg.clone();ug.flipHorizontal=!0;const fg=new ze({strategy:He.Loop,frames:[{graphic:An.getSprite(2,0),duration:li},{graphic:An.getSprite(3,0),duration:li},{graphic:An.getSprite(4,0),duration:li},{graphic:An.getSprite(5,0),duration:li},{graphic:An.getSprite(6,0),duration:li}]}),_g=fg.clone();_g.flipHorizontal=!0;const gg=new ze({strategy:He.Loop,frames:[{graphic:yn.getSprite(0,0),duration:ar},{graphic:yn.getSprite(1,0),duration:ar}]}),pg=gg.clone();pg.flipHorizontal=!0;const mg=new ze({strategy:He.Loop,frames:[{graphic:yn.getSprite(2,0),duration:li},{graphic:yn.getSprite(3,0),duration:li},{graphic:yn.getSprite(4,0),duration:li},{graphic:yn.getSprite(5,0),duration:li},{graphic:yn.getSprite(6,0),duration:li}]}),vg=mg.clone();vg.flipHorizontal=!0;const Yl=new ze({strategy:He.End,frames:[{graphic:Kn.getSprite(0,0),duration:H0},{graphic:Kn.getSprite(1,0),duration:O0},{graphic:Kn.getSprite(2,0),duration:W0},{graphic:Kn.getSprite(3,0),duration:V0},{graphic:Kn.getSprite(4,0),duration:N0}]}),jl=Yl.clone();jl.flipHorizontal=!0;class wg extends mi{ac;_directionfacing="Right";animationSet;_walkState="idle";_attackState="Normal";_oldStates="idleNormalRight";_currentStates="idleNormalRight";constructor(t){super({width:19,height:30,z:1001}),this.animationSet=t}onInitialize(t){this.ac=new mo(this.animationSet),this.addComponent(this.ac),this.ac.set("idleNormalRight"),this._oldStates="idleNormalRight",this._currentStates="idleNormalRight"}set direction(t){this.ac&&(this._directionfacing=t,this._currentStates=this._walkState+this._attackState+this._directionfacing)}set attackState(t){this.ac&&(this._attackState=t,this._currentStates=this._walkState+this._attackState+this._directionfacing)}set walkState(t){this.ac&&(this._walkState=t,this._currentStates=this._walkState+this._attackState+this._directionfacing)}onPreUpdate(t,i){this.ac&&this._oldStates!==this._currentStates&&(this._oldStates=this._currentStates,this.ac.set(this._currentStates))}}const G0=300;class Wr extends mi{constructor(t,i,n,o,h){super({width:16,height:4,rotation:0,pos:t,anchor:bt.Half,z:1001,collisionType:cs.Passive,collisionGroup:id}),this.playSFX=h,this.owner=o,this.damage=n,this.vel=i.sub(this.pos).normalize().scale(G0),this.rotation=this.vel.toAngle(),this.graphics.use(ut.arrow.toSprite())}damage;owner;UISignal=new ee("stateUpdate");onInitialize(t){this.events.on("exitviewport",()=>{this.kill()}),this.playSFX&&ut.sfxShootArrow.play(ds)}onCollisionStart(t,i,n,o){if(i.owner instanceof ro){const h=i.owner;if(h.state=="death")return;h.pain("arrow"),this.owner.numenemies++}}}class xg extends mi{ac;directionfacing="Right";state="attack";animationSet;resetCallback=void 0;constructor(t,i,n){super({z:1001,collisionType:cs.Passive,collisionGroup:id}),this.resetCallback=n,this.directionfacing=i,this.pos=tt(0,0),this.animationSet=t,this.animationSet.attackLeft.events.on("end",()=>{console.log("killing weapon left"),this.kill(),this.resetCallback&&this.resetCallback()}),this.animationSet.attackRight.events.on("end",()=>{console.log("killing weapon right"),this.kill(),this.resetCallback&&this.resetCallback()})}onInitialize(t){this.ac=new mo(this.animationSet),this.addComponent(this.ac);const i=this.state+this.directionfacing;this.ac.set(i)}onPreKill(t){this.animationSet.attackLeft.events.off("end"),this.animationSet.attackRight.events.off("end")}get animationframe(){return this.ac?.currentFrame}onPreUpdate(t,i){}}const ci=75,hr=150,X0=750,q0=100,Y0=100,j0=700,bg=new ze({strategy:He.Loop,frames:[{graphic:Cn.getSprite(0,0),duration:hr},{graphic:Cn.getSprite(1,0),duration:hr}]}),Ag=bg.clone();Ag.flipHorizontal=!0;const yg=new ze({strategy:He.Loop,frames:[{graphic:Cn.getSprite(2,0),duration:ci},{graphic:Cn.getSprite(3,0),duration:ci},{graphic:Cn.getSprite(4,0),duration:ci},{graphic:Cn.getSprite(5,0),duration:ci},{graphic:Cn.getSprite(6,0),duration:ci}]}),Cg=yg.clone();Cg.flipHorizontal=!0;const Sg=new ze({strategy:He.Loop,frames:[{graphic:Sn.getSprite(0,0),duration:hr},{graphic:Sn.getSprite(1,0),duration:hr}]}),Pg=Sg.clone();Pg.flipHorizontal=!0;const Tg=new ze({strategy:He.Loop,frames:[{graphic:Sn.getSprite(2,0),duration:ci},{graphic:Sn.getSprite(3,0),duration:ci},{graphic:Sn.getSprite(4,0),duration:ci},{graphic:Sn.getSprite(5,0),duration:ci},{graphic:Sn.getSprite(6,0),duration:ci}]}),Eg=Tg.clone();Eg.flipHorizontal=!0;const Ig=new ze({strategy:He.Loop,frames:[{graphic:Pn.getSprite(0,0),duration:hr},{graphic:Pn.getSprite(1,0),duration:hr}]}),Rg=Ig.clone();Rg.flipHorizontal=!0;const Dg=new ze({strategy:He.Loop,frames:[{graphic:Pn.getSprite(2,0),duration:ci},{graphic:Pn.getSprite(3,0),duration:ci},{graphic:Pn.getSprite(4,0),duration:ci},{graphic:Pn.getSprite(5,0),duration:ci},{graphic:Pn.getSprite(6,0),duration:ci}]}),Fg=Dg.clone();Fg.flipHorizontal=!0;const Mg=new ze({strategy:He.End,frames:[{graphic:Xr.getSprite(0,0),duration:X0},{graphic:Xr.getSprite(1,0),duration:q0},{graphic:Xr.getSprite(2,0),duration:Y0},{graphic:Xr.getSprite(3,0),duration:j0}]}),Bg=Mg.clone();Bg.flipHorizontal=!0;class sd extends mi{currentHP=15;maxHP=15;regenRate=1e3;attackPower=1;pickupDistance=50;speed=100;fireInterval=3e3;exp=0;isPlayerActive=!1;jc=new K_;kc=new og;ac=new mo({idleLeft:Ag,idleRight:bg,walkLeft:Cg,walkRight:yg});partner;HealthBar;fireIntervalHandler;isJoystickActive=!0;isKeyboardActive=!1;UISignal=new ee("stateUpdate");gamePausedSignal=new ee("pauseGame");progressionSignal=new ee("progressionUpdate");waveResetSignal=new ee("waveReset");numenemies=0;directionFacing="Right";isWalking=!1;oldXVelocity=0;oldDirectionFacing="Right";weaponChild;closestEnemy;timer=void 0;switchLock=!1;handChild=new wg({idleNormalLeft:Pg,idleNormalRight:Sg,walkNormalLeft:Eg,walkNormalRight:Tg,idleAttackLeft:Rg,idleAttackRight:Ig,walkAttackLeft:Fg,walkAttackRight:Dg});fireRange=100;fireDamage=1;isFiring=!1;isWaveActive=!1;isAlive=!0;constructor(){super({radius:10,color:kt.White,pos:tt(0,0),anchor:bt.Half,z:1e3,collisionType:cs.Active,collisionGroup:$_}),this.addComponent(this.ac),this.ac.set("idleRight"),this.HealthBar=new ng(new bt(32,16),new bt(-16,-32),20),this.addChild(this.HealthBar),this.handChild.walkState="idle",this.handChild.attackState="Normal",this.handChild.direction="Right",this.addChild(this.handChild);const t=new mi({width:48,height:48});t.graphics.use(ig.sprites[0]),this.addChild(t);class i extends mi{owner;wasActive=!0;constructor(o){super({pos:tt(0,-32),z:1002,scale:tt(.8,.8)}),this.owner=o,this.graphics.use(ut.activePlayerTik.toSprite())}onPreUpdate(o,h){this.owner.isPlayerActive===!0?this.wasActive||(this.graphics.use(ut.activePlayerTik.toSprite()),this.wasActive=!0):this.wasActive&&(this.wasActive=!1,this.graphics.hide())}}this.addChild(new i(this)),this.waveResetSignal.listen(n=>this.numenemies=0),this.gamePausedSignal.listen(n=>{this.isWaveActive=!n.detail.params[0]}),this.progressionSignal.listen(n=>{switch(n.detail.params[0]){case"constitution":this.maxHP+=10,this.maxHP>35&&(this.maxHP=35),this.currentHP=this.maxHP,this.regenRate=Math.floor(this.regenRate*.95);break;case"speed":this.fireInterval=Math.floor(this.fireInterval*.75),this.timer?.cancel(),this.timer=new Pa({fcn:()=>this.fire(),repeats:!0,interval:this.fireInterval}),this.scene.add(this.timer),this.timer.start(),this.speed+=25;break;case"strength":this.attackPower+=1,this.pickupDistance=Math.floor(this.pickupDistance*1.05);break}})}onInitialize(t){this.kc.init(),this.timer=new Pa({fcn:()=>this.fire(),repeats:!0,interval:this.fireInterval}),t.currentScene.add(this.timer),this.timer.start()}onCollisionStart(t,i,n,o){i.owner instanceof Xl&&(i.owner.kill(),this.UISignal.send(["blessing"]),this.exp+=1,ut.sfxGeneralPickup.play(ds))}get direction(){return this.directionFacing}registerPartner(t){this.partner=t,this.pos=t.pos.clone().add(tt(0,-50))}fire(){if(!this.isWaveActive)return;let t=this.scene?.entities.filter(o=>o instanceof ro),i,n=1/0;for(const o of t){let h=o,c=this.pos.distance(h.pos);c<n&&(n=c,i=h)}i&&(this.closestEnemy=i,this.weaponChild=new xg({attackLeft:Bg,attackRight:Mg},this.directionFacing,this.releaseWeapon),this.addChild(this.weaponChild),this.isFiring=!0,this.handChild.attackState="Attack")}releaseWeapon=()=>{this.handChild.attackState="Normal",this.children.includes(this.weaponChild)&&(console.log("removing weapon bow"),this.removeChild(this.weaponChild)),this.weaponChild=void 0};disableTouch(){this.removeComponent(this.jc)}enableTouch(){this.addComponent(this.jc)}joystickCallback=t=>{!this.isPlayerActive||!this.isJoystickActive||(t.state==="hold"&&(this.switchLock=!0,this.scene.switchPlayerFocus()),t.state==="active"?(t.direction.x<0?this.directionFacing="Left":this.directionFacing="Right",this.vel.x=t.direction.x*this.speed,this.vel.y=t.direction.y*this.speed,this.isWalking===!1&&(this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`))):(this.vel.x=0,this.vel.y=0,this.isWalking===!0&&(this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))))};onPreUpdate(t,i){if(!this.isWaveActive)return;if(this.isFiring&&this.closestEnemy&&this.weaponChild&&this.weaponChild.animationframe==1){let _=this.closestEnemy.pos.sub(this.pos).toAngle(),p=rf(7.5),v=rf(15),x=new Wr(this.pos,this.closestEnemy.pos,this.fireDamage,this,!0);if(this.scene?.add(x),this.attackPower>=2){let b=_+p,S=_-p,P=this.pos.add(tt(Math.cos(b),Math.sin(b))),I=this.pos.add(tt(Math.cos(S),Math.sin(S))),F=new Wr(this.pos,P,this.fireDamage,this,!1),R=new Wr(this.pos,I,this.fireDamage,this,!1);this.scene?.add(F),this.scene?.add(R)}if(this.attackPower>=3){let b=_+v,S=_-v,P=this.pos.add(tt(Math.cos(b),Math.sin(b))),I=this.pos.add(tt(Math.cos(S),Math.sin(S))),F=new Wr(this.pos,P,this.fireDamage,this,!1),R=new Wr(this.pos,I,this.fireDamage,this,!1);this.scene?.add(F),this.scene?.add(R)}this.closestEnemy=void 0,this.isFiring=!1}const o=this.actions.getQueue().getActions().find(c=>c instanceof J_);if(!this.isPlayerActive&&this.partner&&this.partner.pos.distance(this.pos)>25&&!o?this.actions.follow(this.partner,50):this.isPlayerActive&&o&&this.actions.clearActions(),!this.isPlayerActive){let c=!1;this.partner.isWalking&&this.isWalking===!1?(this.isWalking=!0,c=!0):!this.partner.isWalking&&this.isWalking===!0&&(this.isWalking=!1,c=!0),this.partner.directionFacing!=this.directionFacing&&(this.directionFacing=this.partner.directionFacing,this.handChild.direction=this.directionFacing,c=!0),c&&(this.isWalking?this.ac.set(`walk${this.directionFacing}`):this.ac.set(`idle${this.directionFacing}`))}if(this.HealthBar?.setPercent(this.currentHP/this.maxHP*100),this.kc.keyEnable&&(this.isKeyboardActive=!0,this.isJoystickActive=!1),this.isPlayerActive&&this.isKeyboardActive){let c=this.kc.keys;c.includes("ArrowLeft")?this.vel.x=-this.speed:c.includes("ArrowRight")&&(this.vel.x=this.speed),c.includes("ArrowUp")?this.vel.y=-this.speed:c.includes("ArrowDown")&&(this.vel.y=this.speed),!c.includes("ArrowLeft")&&!c.includes("ArrowRight")&&(this.vel.x=0),!c.includes("ArrowUp")&&!c.includes("ArrowDown")&&(this.vel.y=0),c.includes("Space")&&!this.switchLock&&this.isPlayerActive&&(this.switchLock=!0,this.scene.switchPlayerFocus()),this.vel.x!=0||this.vel.y!=0?this.isWalking===!1?(this.vel.x>0?this.directionFacing="Right":this.directionFacing="Left",this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`)):this.oldXVelocity<0&&this.vel.x>0?(this.directionFacing="Right",this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`),this.handChild.direction=this.directionFacing):this.oldXVelocity>0&&this.vel.x<0&&(this.directionFacing="Left",this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`),this.handChild.direction=this.directionFacing):this.isWalking===!0&&(this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))}const h=this.scene?.entities.filter(c=>c instanceof Xl);if(h)for(let c=0;c<h.length;c++)this.pos.distance(h[c].pos)<this.pickupDistance&&h[c].comeToActor(this);this.currentHP<=0&&(this.isPlayerActive&&this.scene.switchPlayerFocus(),this.fireIntervalHandler&&clearInterval(this.fireIntervalHandler),ut.sfxDeath.play(ds),this.isAlive=!1,this.kill())}}const Z0=new ze({strategy:He.Loop,frames:[{graphic:qe.getSprite(0,0),duration:100},{graphic:qe.getSprite(1,0),duration:100},{graphic:qe.getSprite(2,0),duration:100},{graphic:qe.getSprite(3,0),duration:100},{graphic:qe.getSprite(4,0),duration:100}]}),Q0=new ze({strategy:He.End,frames:[{graphic:qe.getSprite(0,1),duration:100},{graphic:qe.getSprite(1,1),duration:100},{graphic:qe.getSprite(2,1),duration:100},{graphic:qe.getSprite(3,1),duration:100},{graphic:qe.getSprite(4,1),duration:100}]}),J0=new ze({strategy:He.End,frames:[{graphic:qe.getSprite(0,2),duration:100},{graphic:qe.getSprite(1,2),duration:100},{graphic:qe.getSprite(2,2),duration:100},{graphic:qe.getSprite(3,2),duration:100},{graphic:qe.getSprite(4,2),duration:100}]});function K0(d){const t={fragmentSource:`#version 300 es
    precision mediump float;

    in vec2 v_uv;
    out vec4 fragColor;

    uniform vec2 u_graphic_resolution;
    uniform sampler2D u_graphic;

    // Inigo Quilez pixel-art UV snapping
    vec2 uv_iq(in vec2 uv, in vec2 texture_size) {
      vec2 pixel = uv * texture_size;
      vec2 seam = floor(pixel + 0.5);
      vec2 dudv = fwidth(pixel);
      pixel = seam + clamp((pixel - seam) / dudv, -0.5, 0.5);
      return pixel / texture_size;
    }

    void main() {
      vec2 newUv = uv_iq(v_uv, u_graphic_resolution);
      vec4 texColor = texture(u_graphic, newUv);

      if (texColor.a < 0.01) {
        discard; // respect alpha mask
      }

      fragColor = vec4(1.0, 1.0, 1.0, texColor.a);
    }
  `};return d.graphicsContext.createMaterial(t)}const hf=(d,t,i,n)=>{t.graphics.material=K0(d),d.clock.schedule(()=>{t.graphics.material=null,n&&n()},i)},pl=new pr(Date.now());class ro extends mi{currentHP=1;maxHP=1;attackPower=1;speed=25;_waveLevel=1;affinity="dark";state="default";lightTarget;darkTarget;currentTarget=void 0;graphic;UISignal=new ee("stateUpdate");progressionSignal=new ee("progressionUpdate");swordDeathAnimation=Q0.clone();arrowDeathAnimation=J0.clone();startingGraphic;startingAnimation;startingCollider;constructor(t,i,n){super({radius:7.5,pos:t,anchor:bt.Half,z:1e3,collisionType:cs.Active,collisionGroup:Ww});const o=Math.floor(Math.random()*5),h=Z0.clone();h.goToFrame(o);const c=new ns({useAnchor:!0,members:[{graphic:ut.purpleShadow.toSprite(),offset:tt(0,0)},{graphic:h,offset:tt(0,0)}]});this.graphic=c,this.startingGraphic=c.clone(),this.startingAnimation=h.clone(),this.startingCollider=this.collider.clone(),this.lightTarget=i,this.darkTarget=n,this.graphics.use(this.graphic),pl.bool()?(this.affinity="light",this.graphic.tint=kt.fromHex("#888888").lighten(.9)):this.graphic.tint=kt.fromHex("#888888").darken(.1)}set waveLevel(t){this._waveLevel!==t&&(this._waveLevel=t,this.maxHP=t,this.speed=this.speed+t,this.attackPower*=t*.1,this.scale)}onCollisionStart(t,i,n,o){if(this.state!=="death"&&(i.owner instanceof qr||i.owner instanceof sd)){this.scene.enemyWaveManager?.enemyPool?.return(this),this.scene?.remove(this),i.owner.currentHP-=this.attackPower;const h=i.owner.scene?.engine;h&&(hf(h,i.owner,150),ut.sfxPlayerHurt.play(ds)),this.UISignal.send(["playerDamaged"])}}onInitialize(){this.swordDeathAnimation.events.on("end",()=>{}),this.arrowDeathAnimation.events.on("end",()=>{})}setAffinity(t){this.affinity=t,t=="dark"?this.graphic.tint=kt.fromHex("#888888").darken(.1):this.graphic.tint=kt.fromHex("#888888").lighten(.9)}reset(){this.graphics.getNames().forEach(i=>this.graphics.remove(i)),this.graphics.use(this.startingGraphic.clone()),this.graphic.members[1]=this.startingAnimation.clone(),this.swordDeathAnimation.reset(),this.arrowDeathAnimation.reset(),this.state="default",this.collider=this.startingCollider.clone(),this.body.collisionType=cs.Active,pl.bool()?(this.affinity="light",this.graphic.tint=kt.fromHex("#888888").lighten(.9)):(this.affinity="dark",this.graphic.tint=kt.fromHex("#888888").darken(.1))}checkDrop(){if(pl.integer(0,100)<40){if(!this.scene)return;this.affinity=="dark"?this.scene.add(new ql(this.pos)):this.scene.add(new Xl(this.pos))}}pain(t){this.actions.clearActions(),this.state="death",this.collider.clear(),this.body.collisionType=cs.Passive,ut.sfxEnemyKilled.play(ds);const i=this.scene?.engine;i&&hf(i,this,300,()=>{this.graphic.members[1]=t==="sword"?this.swordDeathAnimation:this.arrowDeathAnimation})}onPreUpdate(t,i){if(this.state==="death"){this.swordDeathAnimation.done&&(this.checkDrop(),this.UISignal.send(["enemyDefeated",this.affinity]),this.actions.clearActions(),this.scene?.remove(this),this.scene.enemyWaveManager?.enemyPool?.return(this)),this.arrowDeathAnimation.done&&(this.checkDrop(),this.UISignal.send(["enemyDefeated",this.affinity]),this.actions.clearActions(),this.scene?.remove(this),this.scene.enemyWaveManager?.enemyPool?.return(this));return}this.graphics.use(this.graphic);const o=this.actions.getQueue().getActions().find(c=>c instanceof Uw);let h;if(o){if(this.currentTarget?.isAlive)return;this.actions.clearActions(),this.lightTarget?.isAlive?this.currentTarget=this.lightTarget:this.darkTarget?.isAlive&&(this.currentTarget=this.darkTarget),this.actions.meet(this.currentTarget,this.speed)}else{if(this.lightTarget?.isAlive&&this.darkTarget?.isAlive?h=this.lightTarget.pos.distance(this.pos)<this.darkTarget.pos.distance(this.pos)?this.lightTarget:this.darkTarget:this.lightTarget?.isAlive?h=this.lightTarget:this.darkTarget?.isAlive&&(h=this.darkTarget),!h)return;this.currentTarget=h,this.actions.meet(h,this.speed)}}}class lf extends mi{ac;directionfacing="Right";state="attack";animationSet;resetCallback=void 0;leftVector=tt(-25,0);rightVector=tt(25,0);UISignal=new ee("stateUpdate");waveResetSignal=new ee("waveReset");isColliding=!1;others=[];numenemies=0;isPlayerActive;constructor(t,i,n,o){super({width:42,height:30,z:1001,collisionType:cs.Passive,collisionGroup:id}),this.resetCallback=o,this.directionfacing=i,this.directionfacing=="Left"?this.pos=this.leftVector:this.pos=this.rightVector,this.pos=this.rightVector,this.animationSet=t,this.animationSet.attackLeft.events.on("end",()=>{this.resetCallback&&this.resetCallback(),this.kill()}),this.animationSet.attackRight.events.on("end",()=>{this.resetCallback&&this.resetCallback(),this.kill()}),this.isPlayerActive=n}onPreKill(t){this.animationSet.attackLeft.events.off("end"),this.animationSet.attackRight.events.off("end")}makeBig(){this.scale=tt(1.5,1.5)}onInitialize(t){this.directionfacing=="Left"?this.pos=new bt(this.leftVector.x+4,this.leftVector.y+2):this.pos=new bt(this.rightVector.x-4,this.rightVector.y+2),this.ac=new mo(this.animationSet),this.addComponent(this.ac);const i=this.state+this.directionfacing;this.ac.set(i);const n=ds-.25;ut.sfxSwordSwing.play(this.isPlayerActive?ds:n)}onCollisionStart(t,i,n,o){i.owner instanceof ro&&(this.isColliding=!0,this.others.push(i.owner))}onCollisionEnd(t,i,n,o){if(i.owner instanceof ro){let h=this.others.findIndex(c=>c==i.owner);h!=-1&&this.others.splice(h,1),this.others.length==0&&(this.isColliding=!1)}}onPreUpdate(t,i){this.isColliding&&this.ac?.currentFrame==2&&this.others.forEach(n=>{n.state!="death"&&(this.parent.numenemies++,n.pain("sword"))})}}class qr extends mi{currentHP=25;maxHP=25;regenRate=1e3;attackPower=1;pickupDistance=50;speed=80;fireInterval=1e3;isPlayerActive=!0;partner;isWalking=!1;oldXVelocity=0;timer=void 0;switchLock=!1;jc=new K_;kc=new og;ac=new mo({idleLeft:hg,idleRight:ag,walkLeft:cg,walkRight:lg});directionFacing="Right";handChild=new wg({idleNormalLeft:ug,idleNormalRight:dg,walkNormalLeft:_g,walkNormalRight:fg,idleAttackLeft:pg,idleAttackRight:gg,walkAttackLeft:vg,walkAttackRight:mg});HealthBar;exp=0;fireIntervalHandler;weaponchild;weaponchild2;fireDamage=3;isJoystickActive=!0;isKeyboardActive=!1;UISignal=new ee("stateUpdate");gamePausedSignal=new ee("pauseGame");progressionSignal=new ee("progressionUpdate");oldDirectionFacing="Right";isWaveActive=!1;waveResetSignal=new ee("waveReset");numenemies=0;isAlive=!0;constructor(){super({width:19,height:30,pos:tt(0,0),anchor:bt.Half,z:1001,collisionType:cs.Active,collisionGroup:$_}),this.addComponent(this.ac),this.ac.set("idleRight"),this.HealthBar=new ng(new bt(32,16),new bt(-16,-32),20),this.addChild(this.HealthBar),this.handChild.walkState="idle",this.handChild.attackState="Normal",this.handChild.direction="Right",this.addChild(this.handChild);const t=new mi({width:48,height:48});t.graphics.use(ig.sprites[0]),this.addChild(t);class i extends mi{owner;wasActive=!1;constructor(o){super({pos:tt(0,-32),z:1002,scale:tt(.8,.8)}),this.owner=o,this.graphics.use(ut.activePlayerTik.toSprite())}onPreUpdate(o,h){this.owner.isPlayerActive===!0?this.wasActive||(this.graphics.use(ut.activePlayerTik.toSprite()),this.wasActive=!0):this.wasActive&&(this.wasActive=!1,this.graphics.hide())}}this.addChild(new i(this)),this.waveResetSignal.listen(n=>this.numenemies=0),this.gamePausedSignal.listen(n=>{this.isWaveActive=!n.detail.params[0]}),this.progressionSignal.listen(n=>{switch(n.detail.params[0]){case"constitution":this.maxHP+=10,this.maxHP>50&&(this.maxHP=50),this.currentHP=this.maxHP;break;case"speed":this.fireInterval=Math.floor(this.fireInterval*.75),this.speed+=25,this.timer?.cancel(),this.timer=new Pa({fcn:()=>this.fire(),repeats:!0,interval:this.fireInterval}),this.scene?.add(this.timer),this.timer.start();break;case"strength":this.attackPower++,this.pickupDistance=Math.floor(this.pickupDistance*1.05);break}})}onInitialize(t){this.kc.init(),this.scene&&(this.scene.camera.strategy.lockToActor(this),this.scene.camera.zoom=1.5,this.timer=new Pa({fcn:()=>this.fire(),repeats:!0,interval:this.fireInterval}),t.currentScene.add(this.timer),this.timer.start())}onCollisionStart(t,i,n,o){i.owner instanceof ql&&(this.exp+=1,this.UISignal.send(["soul"]),i.owner.kill(),ut.sfxGeneralPickup.play(ds))}registerPartner(t){this.partner=t}get direction(){return this.directionFacing}disableTouch(){this.removeComponent(this.jc,!0)}enableTouch(){this.addComponent(this.jc,!0)}joystickCallback=t=>{!this.isPlayerActive||!this.isJoystickActive||(t.state==="hold"&&(this.switchLock=!0,this.scene.switchPlayerFocus()),t.state==="active"?(t.direction.x<0?this.directionFacing="Left":this.directionFacing="Right",this.vel.x=t.direction.x*this.speed,this.vel.y=t.direction.y*this.speed,this.isWalking===!1&&(this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`))):(this.vel.x=0,this.vel.y=0,this.isWalking===!0&&(this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))))};fire(){if(this.isWaveActive){if(this.weaponchild=new lf({attackLeft:jl,attackRight:Yl},this.directionFacing,this.isPlayerActive,this.releaseWeapon),this.addChild(this.weaponchild),this.handChild.attackState="Attack",this.handChild.direction=this.directionFacing,this.attackPower>=2){let t=this.directionFacing=="Left"?"Right":"Left";this.weaponchild2=new lf({attackLeft:jl,attackRight:Yl},t,this.isPlayerActive,this.releaseWeapon),this.addChild(this.weaponchild2)}this.attackPower>2&&(this.weaponchild.makeBig(),this.weaponchild2.makeBig())}}releaseWeapon=()=>{this.handChild.attackState="Normal",this.weaponchild&&(this.removeChild(this.weaponchild),this.weaponchild=void 0)};onPreUpdate(t,i){if(!this.isWaveActive)return;const o=this.actions.getQueue().getActions().find(c=>c instanceof J_);if(!this.isPlayerActive&&this.partner&&this.partner.pos.distance(this.pos)>25&&!o?this.actions.follow(this.partner,50):this.isPlayerActive&&o&&this.actions.clearActions(),!this.isPlayerActive){let c=!1;this.partner.isWalking&&this.isWalking===!1?(this.isWalking=!0,c=!0):!this.partner.isWalking&&this.isWalking===!0&&(this.isWalking=!1,c=!0),this.partner.directionFacing!=this.directionFacing&&(this.directionFacing=this.partner.directionFacing,this.handChild.direction=this.directionFacing,c=!0),c&&(this.isWalking?this.ac.set(`walk${this.directionFacing}`):this.ac.set(`idle${this.directionFacing}`))}if(this.HealthBar?.setPercent(this.currentHP/this.maxHP*100),this.kc.keyEnable&&(this.isKeyboardActive=!0,this.isJoystickActive=!1),this.isPlayerActive&&this.isKeyboardActive){let c=this.kc.keys;c.includes("ArrowLeft")?this.vel.x=-this.speed:c.includes("ArrowRight")&&(this.vel.x=this.speed),c.includes("ArrowUp")?this.vel.y=-this.speed:c.includes("ArrowDown")&&(this.vel.y=this.speed),c.includes("Space")&&!this.switchLock&&this.isPlayerActive&&(this.switchLock=!0,this.scene.switchPlayerFocus()),!c.includes("ArrowLeft")&&!c.includes("ArrowRight")&&(this.vel.x=0),!c.includes("ArrowUp")&&!c.includes("ArrowDown")&&(this.vel.y=0),this.vel.x!=0||this.vel.y!=0?this.isWalking===!1?(this.vel.x>0?this.directionFacing="Right":this.vel.x<0&&(this.directionFacing="Left"),this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.isWalking=!0,this.ac.set(`walk${this.directionFacing}`)):this.oldXVelocity<0&&this.vel.x>0?(this.directionFacing="Right",this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`)):this.oldXVelocity>0&&this.vel.x<0&&(this.directionFacing="Left",this.handChild.direction=this.directionFacing,this.oldXVelocity=this.vel.x,this.ac.set(`walk${this.directionFacing}`)):this.isWalking===!0&&(this.isWalking=!1,this.ac.set(`idle${this.directionFacing}`))}const h=this.scene?.entities.filter(c=>c instanceof ql);if(h)for(let c=0;c<h.length;c++)this.pos.distance(h[c].pos)<this.pickupDistance&&h[c].comeToActor(this);this.currentHP<=0&&(this.isPlayerActive&&this.scene.switchPlayerFocus(),this.fireIntervalHandler&&clearInterval(this.fireIntervalHandler),ut.sfxDeath.play(ds),this.isAlive=!1,this.kill())}}class $0{constructor(t,i,n=1){this.builder=t,this.cleaner=i,this.grow(n)}_pool=[];_size=0;grow(t){if(t>0){this._size+=t;for(let i=0;i<t;i++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}}function kg(d,t,i){const n=d%t,o=Math.floor(d/t);return n===0||n===t-1||o===0||o===i-1}function tx(d,t,i){const n=d%t,o=Math.floor(d/t);return n===1||n===t-2||o===1||o===i-2}function ex(d){return Math.floor(55+d*25)}function ix(d){const t=Math.max(3,Math.floor(d/15));let i=Array.from({length:t},(_,p)=>p+1);const n=i.reduce((_,p)=>_+p,0);let o=i.map(_=>Math.floor(_/n*d)),h=o.reduce((_,p)=>_+p,0),c=d-h;for(;c!==0;)for(let _=o.length-1;_>=0&&c!==0;_--)o[_]+=c>0?1:-1,c+=c>0?-1:1;return o}function sx(d){return tt(0,d.rows*d.tileHeight/2)}class nx{rng=new pr(Date.now());getSpawnPositions(t,i){console.log("random");let n=[];for(let o=0;o<t;o++){let h=this.getRandomTile(i);n.push({x:h.x,y:h.y})}return n}getRandomTile(t){let i=t.columns*t.rows,n=this.rng.integer(0,i-1);for(;kg(n,t.columns,t.rows);)n=this.rng.integer(0,i-1);return t.tiles[n].pos.clone()}}class rx{getSpawnPositions(t,i){console.log("circle");let n=i.columns,o=i.rows;const h=Math.ceil(n/2),c=Math.ceil(o/2),_=n/2-2;let p=[];for(let v=0;v<t;v++){const x=2*Math.PI*v/t,b=Math.floor(h+Math.cos(x)*_),P=Math.floor(c+Math.sin(x)*_)*n+b,I=i.tiles[P].pos.clone();p.push({x:I.x,y:I.y})}return p}}class ox{rng=new pr(Date.now());getSpawnPositions(t,i){console.log("edges");const n=[],o=i.tiles.filter((h,c)=>tx(c,i.columns,i.rows));for(let h=0;h<t;h++){const c=this.rng.pickOne(o);c&&n.push({x:c.pos.x,y:c.pos.y})}return n}}class ax{rng=new pr;getSpawnPositions(t,i){console.log("cluster");const n=[],o={tl:{x:Math.floor(i.columns/4),y:Math.floor(i.rows/4)},tr:{x:Math.floor(i.columns/4)*3,y:Math.floor(i.rows/4)},bl:{x:Math.floor(i.columns/4),y:Math.floor(i.rows/4)*3},br:{x:Math.floor(i.columns/4)*3,y:Math.floor(i.rows/4)*3}},h=["tl","tr","bl","br"],c=this.rng.pickOne(h),_=o[c],p=_.x,v=_.y,x=Math.floor(Math.sqrt(i.tiles.length)/4);for(let b=0;b<t;b++){let S=this.rng.integer(-x/2,x/2),P=this.rng.integer(-x/2,x/2),I=p+S;const R=(v+P)*i.columns+I,T=i.tiles[R];T&&n.push({x:T.pos.x,y:T.pos.y})}return n}}let cf=1e4,hx=5;const lx={RANDOM:"RANDOM"},ml={RANDOM:new nx,CIRCLE:new rx,EDGES:new ox,CLUSTER:new ax};class cx{enemyPool;rng;lightPlayer;darkPlayer;spawnInterval=cf;spawnEnabled=!1;scene;stateSignal=new ee("stateUpdate");burnDown=new ee("burnDown");gamePausedSignal=new ee("pauseGame");map;enemyCount=0;waveNumber=0;batchSize=[];batchIndex=0;spawnStrategy=lx.RANDOM;lastBatchSpawnedFlag=!1;endOfWaveInterval;monitorSpawning=!1;enemyKillCount=0;enemyRemovedCount=0;WaveTimer;isWaveActive=!1;duration=0;isStartDelayConsumed=!1;constructor(t,i,n,o){this.rng=new pr(Date.now()),this.lightPlayer=i,this.darkPlayer=n,this.scene=t,this.map=o,this.WaveTimer=setInterval(this.waveTik,1e3),this.endOfWaveInterval=setInterval(this.endOfWave,1e3)}endOfWave=(t=!1)=>{(this.monitorSpawning&&this.lastBatchSpawnedFlag&&this.isWaveActive||t)&&this.enemyKillCount+this.enemyRemovedCount>=this.enemyCount&&(this.isWaveActive=!1,this.monitorSpawning=!1,this.endWave())};init(){this.enemyPool=new $0(this.makeEnemy,this.cleanUpEnemy,500),this.isWaveActive=!1,this.stateSignal.listen(t=>{const[i,n]=t.detail.params;i==="enemyDefeated"?this.enemyKillCount+=1:i==="playerDamaged"&&(this.enemyRemovedCount+=1)})}waveTik=()=>{this.lastBatchSpawnedFlag||this.isWaveActive&&(this.duration+=1,!this.isStartDelayConsumed&&this.duration>=hx&&(this.isStartDelayConsumed=!0,this.spawnEnemies()),this.isStartDelayConsumed&&(this.stateSignal.send(["waveDuration",this.duration]),this.burnDown.send()))};startWave(){this.enemyKillCount=0,this.enemyRemovedCount=0,this.waveNumber+=1,this.isWaveActive=!0,this.spawnEnabled=!0,this.duration=0,this.isStartDelayConsumed=!1,this.enemyCount=ex(this.waveNumber),this.batchSize=ix(this.enemyCount),this.lastBatchSpawnedFlag=!1,this.batchIndex=0,this.monitorSpawning=!1,this.stateSignal.send(["batchsize",this.enemyCount]),this.spawnStrategy=this.rng.pickOne(Object.keys(ml)),this.gamePausedSignal.send([!1])}endWave(){this.spawnEnabled=!1,this.isWaveActive=!1,this.duration=0,this.isStartDelayConsumed=!1,this.scene.showEndOfWaveModal(),this.gamePausedSignal.send([!0])}spawnEnemies(){let t=ml[this.spawnStrategy].getSpawnPositions(this.batchSize[this.batchIndex],this.map);this.batchIndex+=1,this.spawnStrategy=this.rng.pickOne(Object.keys(ml));for(let i=0;i<t.length;i++){let n=t[i];if(n===void 0)continue;let o=this.map?.tiles.find(c=>c.pos.x===n.x&&c.pos.y===n.y);if(!o)continue;let h=this.enemyPool?.rent(!0);h.waveLevel=this.waveNumber,this.lightPlayer.isAlive?this.darkPlayer.isAlive||h.setAffinity("light"):h.setAffinity("dark"),h.pos=o.pos.clone(),this.scene.add(h),this.monitorSpawning=!0}this.batchIndex==this.batchSize.length&&(this.lastBatchSpawnedFlag=!0)}makeEnemy=()=>new ro(tt(0,0),this.lightPlayer,this.darkPlayer);cleanUpEnemy(t){return t.reset(),t}update(t){this.spawnEnabled&&this.isStartDelayConsumed&&!this.lastBatchSpawnedFlag&&(this.spawnInterval-=t,this.spawnInterval<=0&&(this.spawnInterval=cf,this.spawnEnemies()))}}class dx extends Ai{constructor(t,i,n){let o=tt(ut.timebar.width,ut.timebar.height);const h=new Ps({width:o.x-2,height:o.y/2,color:kt.Green});super({name:"burnDownBar",pos:t,z:1001,opacity:.7}),this.position=t,this.graphics.use(ut.timebar.toSprite()),this.percent=i,this.scene=n,this.currentVal=i,this.maxVal=i,this.child=new ux,this.child.graphics.use(h),this.addChild(this.child),this.burnDownSignal.listen(()=>{this.isActive&&(this.currentVal--,this.percent=this.currentVal/this.maxVal*100,this.percent<0&&(this.percent=0),this.percent>100&&(this.percent=100),this.child.percent=this.percent,this.percent<=0&&(this.scene.switchPlayerFocus(),this.currentVal=this.maxVal,this.percent=100))})}burnDownSignal=new ee("burnDown");currentVal;maxVal;percent;child;scene;isActive=!0;onPreUpdate(t,i){let n=this.scene?.entities.filter(o=>o instanceof qr||o instanceof sd);n&&n?.length<2&&(this.isActive=!1,this.graphics.isVisible=!1)}}class ux extends Ai{whitetik;bluetik;redtik;_percent=100;numtiks=124;graphicsGroup;constructor(){super({pos:tt(2,2),z:1001}),this.whitetik=ut.whitetik,this.bluetik=ut.bluetik,this.redtik=ut.redtik;let t=new Array(this.numtiks).fill({graphic:this.bluetik.toSprite(),offset:tt(0,0)});this.graphicsGroup=new ns({useAnchor:!0,members:t}),this.setOffsets(),this.graphics.use(this.graphicsGroup)}set percent(t){this._percent=t}setOffsets(){for(let t=0;t<this.graphicsGroup.members.length;t++)this.graphicsGroup.members[t].offset=tt(t,0)}onPreUpdate(t,i){const n=Math.floor(this.numtiks*this._percent/100),o=Math.floor(this.numtiks/4);let h;n<=o?h=this.redtik.toSprite():h=this.bluetik.toSprite(),this.graphicsGroup=new ns({useAnchor:!0,members:[]});for(let c=0;c<n;c++)c<n-1?this.graphicsGroup.members.push({graphic:h,offset:tt(c,0)}):this.graphicsGroup.members.push({graphic:this.whitetik.toSprite(),offset:tt(c,0)});this.setOffsets(),this.graphics.use(this.graphicsGroup)}}var vl={exports:{}},wl={exports:{}};/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var df;function fx(){return df||(df=1,function(d,t){(function(n,o){d.exports=o()})(self,()=>(()=>{var i={851:(u,e,s)=>{s.d(e,{A:()=>m});var r=s(1),a=s.n(r),l=s(935),f=s.n(l),g=f()(a());g.push([u.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const m=g},296:(u,e,s)=>{s.d(e,{A:()=>m});var r=s(1),a=s.n(r),l=s(935),f=s.n(l),g=f()(a());g.push([u.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const m=g},935:u=>{u.exports=function(e){var s=[];return s.toString=function(){return this.map(function(a){var l="",f=typeof a[5]<"u";return a[4]&&(l+="@supports (".concat(a[4],") {")),a[2]&&(l+="@media ".concat(a[2]," {")),f&&(l+="@layer".concat(a[5].length>0?" ".concat(a[5]):""," {")),l+=e(a),f&&(l+="}"),a[2]&&(l+="}"),a[4]&&(l+="}"),l}).join("")},s.i=function(a,l,f,g,m){typeof a=="string"&&(a=[[null,a,void 0]]);var w={};if(f)for(var A=0;A<this.length;A++){var y=this[A][0];y!=null&&(w[y]=!0)}for(var E=0;E<a.length;E++){var D=[].concat(a[E]);f&&w[D[0]]||(typeof m<"u"&&(typeof D[5]>"u"||(D[1]="@layer".concat(D[5].length>0?" ".concat(D[5]):""," {").concat(D[1],"}")),D[5]=m),l&&(D[2]&&(D[1]="@media ".concat(D[2]," {").concat(D[1],"}")),D[2]=l),g&&(D[4]?(D[1]="@supports (".concat(D[4],") {").concat(D[1],"}"),D[4]=g):D[4]="".concat(g)),s.push(D))}},s}},1:u=>{u.exports=function(e){var s=e[1],r=e[3];if(!r)return s;if(typeof btoa=="function"){var a=btoa(unescape(encodeURIComponent(JSON.stringify(r)))),l="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),f="/*# ".concat(l," */");return[s].concat([f]).join(`
`)}return[s].join(`
`)}}},n={};function o(u){var e=n[u];if(e!==void 0)return e.exports;var s=n[u]={id:u,exports:{}};return i[u](s,s.exports,o),s.exports}o.n=u=>{var e=u&&u.__esModule?()=>u.default:()=>u;return o.d(e,{a:e}),e},o.d=(u,e)=>{for(var s in e)o.o(e,s)&&!o.o(u,s)&&Object.defineProperty(u,s,{enumerable:!0,get:e[s]})},o.o=(u,e)=>Object.prototype.hasOwnProperty.call(u,e),o.r=u=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(u,"__esModule",{value:!0})};var h={};o.r(h),o.d(h,{ActionCompleteEvent:()=>Ah,ActionContext:()=>Fr,ActionQueue:()=>yd,ActionSequence:()=>ol,ActionStartEvent:()=>bh,ActionsComponent:()=>qn,ActionsSystem:()=>Zh,ActivateEvent:()=>gh,Actor:()=>Je,ActorEvents:()=>Np,AddEvent:()=>yh,AddedComponent:()=>vp,AffineMatrix:()=>fe,Animation:()=>Bi,AnimationDirection:()=>br,AnimationEvents:()=>_p,AnimationStrategy:()=>Mi,ArcadeSolver:()=>Nh,AudioContextFactory:()=>Sr,Axes:()=>$h,Axis:()=>Xo,BaseAlign:()=>Eo,BezierCurve:()=>Dr,Blink:()=>qd,BodyComponent:()=>Tt,BoundingBox:()=>ht,BrowserComponent:()=>il,BrowserEvents:()=>Tu,Buttons:()=>Lr,Camera:()=>lu,CameraEvents:()=>qp,Canvas:()=>Ho,Circle:()=>Vo,CircleCollider:()=>We,Clock:()=>sl,ClosestLineJumpTable:()=>ji,Collider:()=>Vs,ColliderComponent:()=>pe,CollisionContact:()=>un,CollisionEndEvent:()=>Cr,CollisionGroup:()=>xs,CollisionGroupManager:()=>Yi,CollisionJumpTable:()=>Li,CollisionPostSolveEvent:()=>Lo,CollisionPreSolveEvent:()=>ko,CollisionStartEvent:()=>yr,CollisionSystem:()=>Yo,CollisionType:()=>ft,Color:()=>Q,ColorBlindFlags:()=>Su,ColorBlindnessMode:()=>_n,ColorBlindnessPostProcessor:()=>Cu,Component:()=>Si,CompositeCollider:()=>Ce,ConsoleAppender:()=>Ii,ContactConstraintPoint:()=>pu,ContactEndEvent:()=>Bo,ContactSolveBias:()=>bs,ContactStartEvent:()=>Mo,CoordPlane:()=>De,CrossFade:()=>Pm,CurveBy:()=>Kd,CurveTo:()=>Jd,DeactivateEvent:()=>ph,Debug:()=>Se,DebugConfig:()=>Pu,DebugGraphicsComponent:()=>Go,DebugSystem:()=>qh,DebugText:()=>qa,DefaultAntialiasOptions:()=>Eu,DefaultGarbageCollectionOptions:()=>rl,DefaultLoader:()=>Pr,DefaultPixelArtOptions:()=>Iu,DegreeOfFreedom:()=>ri,Delay:()=>jd,Detector:()=>bd,Die:()=>Zd,Direction:()=>Ro,Director:()=>Mu,DirectorEvents:()=>em,DisplayMode:()=>ye,DynamicTree:()=>Dh,DynamicTreeCollisionProcessor:()=>Wo,EX_VERSION:()=>ul,EaseBy:()=>Xd,EaseTo:()=>Gd,EasingFunctions:()=>Gt,EdgeCollider:()=>fi,ElasticToActorStrategy:()=>ou,EmitterType:()=>qs,Engine:()=>oi,EngineEvents:()=>im,EnterTriggerEvent:()=>wh,EnterViewPortEvent:()=>vh,Entity:()=>Oe,EntityEvents:()=>Ap,EntityManager:()=>du,EventEmitter:()=>I,EventTypes:()=>Do,Events:()=>p,ExResponse:()=>Th,ExcaliburGraphicsContext2DCanvas:()=>zo,ExcaliburGraphicsContextWebGL:()=>ws,ExitTriggerEvent:()=>xh,ExitViewPortEvent:()=>mh,Fade:()=>Yd,FadeInOut:()=>Sm,Flags:()=>b,Flash:()=>Qd,Follow:()=>Hh,Font:()=>rn,FontCache:()=>Ut,FontSource:()=>ym,FontStyle:()=>Io,FontUnit:()=>Po,FpsSampler:()=>Ru,FrameStats:()=>Or,Future:()=>P,GameEvent:()=>wt,GameStartEvent:()=>eh,GameStopEvent:()=>ih,Gamepad:()=>Qo,GamepadAxisEvent:()=>uh,GamepadButtonEvent:()=>dh,GamepadConnectEvent:()=>lh,GamepadDisconnectEvent:()=>ch,Gamepads:()=>Zo,GarbageCollector:()=>Lu,Gif:()=>bm,GifParser:()=>Hu,GlobalCoordinates:()=>Yn,GpuParticleEmitter:()=>om,GpuParticleRenderer:()=>$o,Graphic:()=>ie,GraphicsComponent:()=>ne,GraphicsGroup:()=>Hn,GraphicsSystem:()=>Xh,HashColliderProxy:()=>mu,HashGridCell:()=>Ji,HashGridProxy:()=>Yh,HiddenEvent:()=>_h,HorizontalFirst:()=>Mh,ImageFiltering:()=>_e,ImageSource:()=>Xi,ImageSourceAttributeConstants:()=>Ft,ImageWrapping:()=>jt,InitializeEvent:()=>Gn,InputHost:()=>el,InputMapper:()=>wu,IsometricEntityComponent:()=>kr,IsometricEntitySystem:()=>Qh,IsometricMap:()=>am,IsometricTile:()=>Uu,KeyEvent:()=>zr,Keyboard:()=>bu,Keys:()=>Ur,KillEvent:()=>Fo,Label:()=>sm,LimitCameraBoundsStrategy:()=>hu,Line:()=>hl,LineSegment:()=>ce,Loader:()=>cn,LoaderEvents:()=>Fp,LockCameraToActorAxisStrategy:()=>ru,LockCameraToActorStrategy:()=>nu,LogLevel:()=>Nt,Logger:()=>at,Material:()=>fd,Matrix:()=>ui,MatrixLocations:()=>Xa,MediaEvent:()=>Eh,Meet:()=>Oh,MotionComponent:()=>Bt,MotionSystem:()=>qo,MoveBy:()=>Uh,MoveByWithOptions:()=>Rd,MoveTo:()=>zh,MoveToWithOptions:()=>Fd,NativePointerButton:()=>Gs,NativeSoundEvent:()=>ln,NativeSoundProcessedEvent:()=>vd,NineSlice:()=>cl,NineSliceStretch:()=>Ss,None:()=>Bh,Observable:()=>je,OffscreenSystem:()=>Jh,Pair:()=>Qe,ParallaxComponent:()=>No,ParallelActions:()=>hm,Particle:()=>Uo,ParticleEmitter:()=>nm,ParticleRenderer:()=>pd,ParticleTransform:()=>ki,PhysicsStats:()=>Ko,PhysicsWorld:()=>vu,PointerAbstraction:()=>tl,PointerButton:()=>ys,PointerComponent:()=>Ns,PointerEvent:()=>Hr,PointerEventReceiver:()=>Jo,PointerScope:()=>F,PointerSystem:()=>jo,PointerType:()=>Cs,Polygon:()=>ll,PolygonCollider:()=>Fe,Pool:()=>So,PostCollisionEvent:()=>an,PostDebugDrawEvent:()=>oh,PostDrawEvent:()=>Nn,PostFrameEvent:()=>hh,PostKillEvent:()=>th,PostTransformDrawEvent:()=>nh,PostUpdateEvent:()=>Ws,PreCollisionEvent:()=>on,PreDebugDrawEvent:()=>rh,PreDrawEvent:()=>Vn,PreFrameEvent:()=>ah,PreKillEvent:()=>$a,PreLoadEvent:()=>Jp,PreTransformDrawEvent:()=>sh,PreUpdateEvent:()=>Os,Projection:()=>Tr,QuadIndexBuffer:()=>xr,QuadTree:()=>Zn,Query:()=>Mr,QueryManager:()=>uu,RadiusAroundActorStrategy:()=>au,Random:()=>M,Raster:()=>On,Ray:()=>dn,RealisticSolver:()=>Gh,Rectangle:()=>Ir,RemoveEvent:()=>Ch,RemovedComponent:()=>xp,Repeat:()=>Cd,RepeatForever:()=>Sd,Resolution:()=>Sh,Resource:()=>vr,ResourceEvents:()=>Wg,RotateBy:()=>Ld,RotateByWithOptions:()=>kd,RotateTo:()=>Bd,RotateToWithOptions:()=>Md,RotationType:()=>R,ScaleBy:()=>Vd,ScaleByWithOptions:()=>Wd,ScaleTo:()=>Hd,ScaleToWithOptions:()=>zd,Scene:()=>xi,SceneEvents:()=>Kp,Screen:()=>Ph,ScreenAppender:()=>gs,ScreenElement:()=>Wh,ScreenEvents:()=>Ep,ScreenShader:()=>yu,ScrollPreventionMode:()=>Xs,Semaphore:()=>Dm,SeparatingAxis:()=>ge,SeparationInfo:()=>Ad,Shader:()=>ni,Shape:()=>Ve,Side:()=>Rt,Slide:()=>Tm,SolverStrategy:()=>Er,Sound:()=>wd,SoundEvents:()=>Dp,SparseHashGrid:()=>jh,SparseHashGridCollisionProcessor:()=>Kh,SpatialPartitionStrategy:()=>Xn,Sprite:()=>Di,SpriteFont:()=>yo,SpriteSheet:()=>nn,StandardClock:()=>nl,StateMachine:()=>Oo,StrategyContainer:()=>su,Stream:()=>zu,System:()=>wi,SystemManager:()=>_u,SystemPriority:()=>Qi,SystemType:()=>_i,TagQuery:()=>Br,TestClock:()=>Du,Text:()=>Ar,TextAlign:()=>To,TextureLoader:()=>se,Tile:()=>iu,TileMap:()=>eu,TileMapEvents:()=>Xp,TiledAnimation:()=>dl,TiledSprite:()=>wr,Timer:()=>fn,Toaster:()=>Fu,Transform:()=>vs,TransformComponent:()=>it,Transition:()=>ea,TreeNode:()=>Rh,Trigger:()=>cu,TriggerEvents:()=>Yp,TwoPI:()=>W,Util:()=>v,Vector:()=>B,VectorView:()=>Za,VertexBuffer:()=>qi,VertexLayout:()=>ms,VerticalFirst:()=>Fh,VisibleEvent:()=>fh,WebAudio:()=>hn,WebAudioInstance:()=>md,WheelDeltaMode:()=>jn,WheelEvent:()=>Au,World:()=>gu,approximatelyEqual:()=>X,assert:()=>rm,canonicalizeAngle:()=>rt,clamp:()=>j,coroutine:()=>Vu,createId:()=>S,frac:()=>U,getDefaultPhysicsConfig:()=>As,hasGraphicsTick:()=>Ka,hasOnAdd:()=>mm,hasOnInitialize:()=>um,hasOnPostUpdate:()=>pm,hasOnPreUpdate:()=>_m,hasOnRemove:()=>vm,hasPostDraw:()=>xm,hasPreDraw:()=>wm,has_add:()=>cm,has_initialize:()=>lm,has_postupdate:()=>gm,has_preupdate:()=>fm,has_remove:()=>dm,inverseLerp:()=>Td,inverseLerpVector:()=>Ed,isActor:()=>Vp,isAddedComponent:()=>wp,isComponentCtor:()=>gd,isLoaderConstructor:()=>Ih,isMoveByOptions:()=>Id,isMoveToOptions:()=>Dd,isRemovedComponent:()=>bp,isRotateByOptions:()=>Wp,isRotateToOptions:()=>Op,isScaleByOptions:()=>Od,isScaleToOptions:()=>Ud,isSceneConstructor:()=>Ki,isScreenElement:()=>$d,isSystemConstructor:()=>fu,lerp:()=>Pd,lerpAngle:()=>Lh,lerpVector:()=>Rr,maxMessages:()=>Nu,nextActionId:()=>zt,obsolete:()=>Im,parseImageFiltering:()=>zn,parseImageWrapping:()=>Fi,pixelSnapEpsilon:()=>pt,randomInRange:()=>Pt,randomIntInRange:()=>Dt,range:()=>vt,remap:()=>Zi,remapVector:()=>Hp,resetObsoleteCounter:()=>Em,sign:()=>G,toDegrees:()=>lt,toRadians:()=>yt,vec:()=>z,webgl:()=>c});var c={};o.r(c),o.d(c,{getAttributeComponentSize:()=>dd,getAttributePointerType:()=>ud,getGLTypeFromSource:()=>cd,getGlTypeSizeBytes:()=>Ya,getMaxShaderComplexity:()=>ja,isAttributeInSource:()=>ld});var _={};o.r(_),o.d(_,{circle:()=>mp,line:()=>Qa,point:()=>gp,roundRect:()=>Ja,vector:()=>pp});var p={};o.r(p),o.d(p,{ActionCompleteEvent:()=>Ah,ActionStartEvent:()=>bh,ActivateEvent:()=>gh,AddEvent:()=>yh,CollisionEndEvent:()=>Cr,CollisionPostSolveEvent:()=>Lo,CollisionPreSolveEvent:()=>ko,CollisionStartEvent:()=>yr,ContactEndEvent:()=>Bo,ContactStartEvent:()=>Mo,DeactivateEvent:()=>ph,EnterTriggerEvent:()=>wh,EnterViewPortEvent:()=>vh,EventTypes:()=>Do,ExitTriggerEvent:()=>xh,ExitViewPortEvent:()=>mh,GameEvent:()=>wt,GameStartEvent:()=>eh,GameStopEvent:()=>ih,GamepadAxisEvent:()=>uh,GamepadButtonEvent:()=>dh,GamepadConnectEvent:()=>lh,GamepadDisconnectEvent:()=>ch,HiddenEvent:()=>_h,InitializeEvent:()=>Gn,KillEvent:()=>Fo,PostCollisionEvent:()=>an,PostDebugDrawEvent:()=>oh,PostDrawEvent:()=>Nn,PostFrameEvent:()=>hh,PostKillEvent:()=>th,PostTransformDrawEvent:()=>nh,PostUpdateEvent:()=>Ws,PreCollisionEvent:()=>on,PreDebugDrawEvent:()=>rh,PreDrawEvent:()=>Vn,PreFrameEvent:()=>ah,PreKillEvent:()=>$a,PreTransformDrawEvent:()=>sh,PreUpdateEvent:()=>Os,RemoveEvent:()=>Ch,VisibleEvent:()=>fh});var v={};o.r(v),o.d(v,{ConsoleAppender:()=>Ii,DrawUtil:()=>_,EasingFunctions:()=>Gt,LogLevel:()=>Nt,Logger:()=>at,Observable:()=>je,ScreenAppender:()=>gs,addItemToArray:()=>vo,contains:()=>wo,delay:()=>xo,fail:()=>rd,getPosition:()=>zs,isObject:()=>bo,mergeDeep:()=>Ao,omit:()=>od,removeItemFromArray:()=>ps});function x(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(u){window.setInterval(u,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const e=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(s){return new Promise((r,a)=>{e.call(this,s,r,a)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(u){const e=Date.now();return setTimeout(function(){u({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-e))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(u){clearTimeout(u)})}class b{static useCanvasGraphicsContext(){b.enable("use-canvas-context")}static useLegacyImageRenderer(){b.enable("use-legacy-image-renderer")}static freeze(){b._FROZEN=!0}static _reset(){b._FROZEN=!1,b._FLAGS={}}static enable(e){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");b._FLAGS[e]=!0}static disable(e){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");b._FLAGS[e]=!1}static isEnabled(e){return!!b._FLAGS[e]}static show(){return Object.keys(b._FLAGS)}}b._FROZEN=!1,b._FLAGS={};function S(u,e){return{type:u,value:e}}class P{constructor(){this._isCompleted=!1,this.promise=new Promise((e,s)=>{this._resolver=e,this._rejecter=s})}get isCompleted(){return this._isCompleted}resolve(e){this._isCompleted||(this._isCompleted=!0,this._resolver(e))}reject(e){this._isCompleted||(this._isCompleted=!0,this._rejecter(e))}}class I{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(e,s){var r;return this._empty=!1,this._listeners[e]=(r=this._listeners[e])!==null&&r!==void 0?r:[],this._listeners[e].push(s),{close:()=>this.off(e,s)}}once(e,s){var r;return this._empty=!1,this._listenersOnce[e]=(r=this._listenersOnce[e])!==null&&r!==void 0?r:[],this._listenersOnce[e].push(s),{close:()=>this.off(e,s)}}off(e,s){var r,a;if(s){const l=(r=this._listeners[e])===null||r===void 0?void 0:r.filter(g=>g!==s);this._listeners[e]=l;const f=(a=this._listenersOnce[e])===null||a===void 0?void 0:a.filter(g=>g!==s);this._listenersOnce[e]=f}else delete this._listeners[e]}emit(e,s){if(this._empty||this._paused)return;const r=this._listeners[e];if(r)for(let l=0;l<r.length;l++)r[l](s);const a=this._listenersOnce[e];if(this._listenersOnce[e]=[],a)for(let l=0;l<a.length;l++)a[l](s);for(let l=0;l<this._pipes.length;l++)this._pipes[l].emit(e,s)}pipe(e){if(this===e)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(e),{close:()=>{const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}}}unpipe(e){const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var F;(function(u){u.Canvas="Canvas",u.Document="Document"})(F||(F={}));var R;(function(u){u.ShortestPath="shortest-path",u.LongestPath="longest-path",u.Clockwise="clockwise",u.CounterClockwise="counter-clockwise"})(R||(R={}));const T=4294967295;class M{constructor(e){this.seed=e,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(e||Date.now())>>>0;for(let s=1;s<this._n;s++){const r=this._mt[s-1]^this._mt[s-1]>>>this._w-2;this._mt[s]=(this._f*((r&4294901760)>>>16)<<16)+this._f*(r&65535)+s>>>0}this._index=this._n}_twist(){const e=[0,this._a];let s=0,r=0;for(;r<this._n-this._m;r++)s=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+this._m]^s>>>1^e[s&1]&T;for(;r<this._n-1;r++)s=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+(this._m-this._n)]^s>>>1^e[s&1]&T;s=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^s>>>1^e[s&1]&T,this._index=0}nextInt(){this._index>=this._n&&this._twist();let e=this._mt[this._index++];return e^=e>>>this._u,e^=e<<this._s&this._b,e^=e<<this._t&this._c,e^=e>>>this._l,e>>>0}next(){return this.nextInt()*(1/4294967296)}floating(e,s){return(s-e)*this.next()+e}integer(e,s){return Math.floor((s-e+1)*this.next()+e)}bool(e=.5){return this.next()<=e}pickOne(e){return e[this.integer(0,e.length-1)]}pickSet(e,s,r=!1){return r?this._pickSetWithDuplicates(e,s):this._pickSetWithoutDuplicates(e,s)}_pickSetWithoutDuplicates(e,s){if(s>e.length||s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(s===e.length)return e;const r=new Array(s);let a=0;const l=e.slice(0);for(;a<s;){const f=this.integer(0,l.length-1);r[a++]=l[f],l.splice(f,1)}return r}_pickSetWithDuplicates(e,s){if(s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const r=new Array(s);for(let a=0;a<s;a++)r[a]=this.pickOne(e);return r}shuffle(e){const s=e.slice(0);let r;for(let a=0;a<s.length-2;a++){const l=this.integer(a,s.length-1);r=s[a],s[a]=s[l],s[l]=r}return s}range(e,s,r){const a=new Array(e);for(let l=0;l<e;l++)a[l]=this.integer(s,r);return a}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const W=Math.PI*2;function U(u){return u>=0?u-Math.floor(u):u-Math.ceil(u)}function G(u){return u===0?0:u<0?-1:1}function j(u,e,s){return Math.min(Math.max(e,u),s)}function X(u,e,s){return Math.abs(u-e)<s}function rt(u){let e=u;if(u>=W)for(;e>=W;)e-=W;if(u<0)for(;e<0;)e+=W;return e}function lt(u){return 180/Math.PI*u}function yt(u){return u/180*Math.PI}const vt=(u,e)=>Array.from(new Array(e-u+1),(s,r)=>r+u);function Pt(u,e,s=new M){return s?s.floating(u,e):u+Math.random()*(e-u)}function Dt(u,e,s=new M){return s?s.integer(u,e):Math.round(Pt(u,e))}class B{static get Zero(){return new B(0,0)}static get One(){return new B(1,1)}static get Half(){return new B(.5,.5)}static get Up(){return new B(0,-1)}static get Down(){return new B(0,1)}static get Left(){return new B(-1,0)}static get Right(){return new B(1,0)}static fromAngle(e){return new B(Math.cos(e),Math.sin(e))}static isValid(e){return!(e==null||isNaN(e.x)||isNaN(e.y)||e.x===1/0||e.y===1/0||e.x===-1/0||e.y===-1/0)}static distance(e,s){return Math.sqrt(Math.pow(e.x-s.x,2)+Math.pow(e.y-s.y,2))}static min(e,s){return new B(Math.min(e.x,s.x),Math.min(e.y,s.y))}static max(e,s){return new B(Math.max(e.x,s.x),Math.max(e.y,s.y))}constructor(e,s){this._x=0,this._y=0,this._x=e,this._y=s}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}setTo(e,s){this.x=e,this.y=s}equals(e,s=B.EQUALS_EPSILON){return Math.abs(this.x-e.x)<=s&&Math.abs(this.y-e.y)<=s}distance(e){if(!e)return Math.sqrt(this.x*this.x+this.y*this.y);const s=this.x-e.x,r=this.y-e.y;return Math.sqrt(s*s+r*r)}squareDistance(e){e||(e=B.Zero);const s=this.x-e.x,r=this.y-e.y;return s*s+r*r}clampMagnitude(e){const s=this.magnitude,r=j(s,0,e);return this.magnitude=r,this}get size(){return this.distance()}set size(e){const s=this.normalize().scale(e);this.setTo(s.x,s.y)}get magnitude(){return this.distance()}set magnitude(e){this.normalize().scale(e,this)}normalize(){const e=this.distance();return e===0?B.Zero:new B(this.x/e,this.y/e)}average(e){return this.add(e).scale(.5)}scale(e,s){const r=s||new B(0,0);return e instanceof B?(r.x=this.x*e.x,r.y=this.y*e.y):(r.x=this.x*e,r.y=this.y*e),r}add(e,s){return s?(s.x=this.x+e.x,s.y=this.y+e.y,s):new B(this.x+e.x,this.y+e.y)}sub(e,s){const r=s||new B(0,0),a=this.x-e.x,l=this.y-e.y;return r.x=a,r.y=l,r}addEqual(e){return this.setTo(this.x+e.x,this.y+e.y),this}subEqual(e){return this.setTo(this.x-e.x,this.y-e.y),this}scaleEqual(e){return this.setTo(this.x*e,this.y*e),this}dot(e){return this.x*e.x+this.y*e.y}cross(e){if(e instanceof B)return this.x*e.y-this.y*e.x;if(typeof e=="number")return new B(e*this.y,-e*this.x)}static cross(e,s){return new B(-e*s.y,e*s.x)}perpendicular(){return new B(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return rt(Math.atan2(this.y,this.x))}angleBetween(e,s){const r=this.toAngle(),a=rt(e);let l=0,f=0;switch(a>r?l=a-r:l=(W-r+a)%W,f=(l-W)%W,s){case R.ShortestPath:return Math.abs(l)<Math.abs(f)?l:f;case R.LongestPath:return Math.abs(l)>Math.abs(f)?l:f;case R.Clockwise:return l;case R.CounterClockwise:return f}}rotate(e,s,r){const a=r||new B(0,0);s||(s=new B(0,0));const l=Math.sin(e),f=Math.cos(e),g=f*(this.x-s.x)-l*(this.y-s.y)+s.x,m=l*(this.x-s.x)+f*(this.y-s.y)+s.y;return a.x=g,a.y=m,a}clone(e){const s=e??new B(0,0);return s.x=this.x,s.y=this.y,s}toString(e){return e?`(${this.x.toFixed(e)}, ${this.y.toFixed(e)})`:`(${this.x}, ${this.y})`}}B.EQUALS_EPSILON=.001;function z(u,e){return new B(u,e)}class Q{constructor(e,s,r,a){this.r=e,this.g=s,this.b=r,this.a=a??1}static fromRGB(e,s,r,a){return new Q(e,s,r,a)}static fromRGBString(e){const s=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let r=null;if(r=e.match(s)){const a=parseInt(r[1],10),l=parseInt(r[2],10),f=parseInt(r[3],10);let g=1;return r[4]&&(g=parseFloat(r[4])),new Q(a,l,f,g)}else throw new Error("Invalid rgb/a string: "+e)}static fromHex(e){const s=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let r=null;if(r=e.match(s)){const a=parseInt(r[1],16),l=parseInt(r[2],16),f=parseInt(r[3],16);let g=1;return r[4]&&(g=parseInt(r[4],16)/255),new Q(a,l,f,g)}else throw new Error("Invalid hex string: "+e)}static fromHSL(e,s,r,a=1){return new et(e,s,r,a).toRGBA()}lighten(e=.1){const s=et.fromRGBA(this.r,this.g,this.b,this.a);return s.l+=(1-s.l)*e,s.toRGBA()}darken(e=.1){const s=et.fromRGBA(this.r,this.g,this.b,this.a);return s.l-=s.l*e,s.toRGBA()}saturate(e=.1){const s=et.fromRGBA(this.r,this.g,this.b,this.a);return s.s+=s.s*e,s.toRGBA()}desaturate(e=.1){const s=et.fromRGBA(this.r,this.g,this.b,this.a);return s.s-=s.s*e,s.toRGBA()}multiply(e){const s=e.r/255*this.r/255*255,r=e.g/255*this.g/255*255,a=e.b/255*this.b/255*255,l=e.a*this.a;return new Q(s,r,a,l)}screen(e){const s=e.invert(),r=e.invert();return s.multiply(r).invert()}invert(){return new Q(255-this.r,255-this.g,255-this.b,1-this.a)}average(e){const s=(e.r+this.r)/2,r=(e.g+this.g)/2,a=(e.b+this.b)/2,l=(e.a+this.a)/2;return new Q(s,r,a,l)}equal(e){return this.toString()===e.toString()}toString(e="rgb"){switch(e){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(e){const s=Math.max(Math.round(e),0).toString(16);return s.length===1?"0"+s:s}toHex(){let e="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(e+=this._componentToHex(this.a*255)),e}toRGBA(){const e=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+e+", "+String(this.a)+")":"rgb("+e+")"}toHSLA(){return et.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(e){const s=e||new Q(this.r,this.g,this.b,this.a);return s.r=this.r,s.g=this.g,s.b=this.b,s.a=this.a,s}static get Black(){return Q.fromHex("#000000")}static get White(){return Q.fromHex("#FFFFFF")}static get Gray(){return Q.fromHex("#808080")}static get LightGray(){return Q.fromHex("#D3D3D3")}static get DarkGray(){return Q.fromHex("#A9A9A9")}static get Yellow(){return Q.fromHex("#FFFF00")}static get Orange(){return Q.fromHex("#FFA500")}static get Red(){return Q.fromHex("#FF0000")}static get Vermilion(){return Q.fromHex("#FF5B31")}static get Rose(){return Q.fromHex("#FF007F")}static get Pink(){return Q.fromHex("#FFC0CB")}static get Magenta(){return Q.fromHex("#FF00FF")}static get Violet(){return Q.fromHex("#7F00FF")}static get Purple(){return Q.fromHex("#800080")}static get Blue(){return Q.fromHex("#0000FF")}static get Azure(){return Q.fromHex("#007FFF")}static get Cyan(){return Q.fromHex("#00FFFF")}static get Viridian(){return Q.fromHex("#59978F")}static get Teal(){return Q.fromHex("#008080")}static get Green(){return Q.fromHex("#00FF00")}static get Chartreuse(){return Q.fromHex("#7FFF00")}static get Transparent(){return Q.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return Q.fromHex("#176BAA")}static get Brown(){return Q.fromHex("#964B00")}}class et{constructor(e,s,r,a){this.h=e,this.s=s,this.l=r,this.a=a}static hue2rgb(e,s,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+(s-e)*6*r:r<1/2?s:r<2/3?e+(s-e)*(2/3-r)*6:e}static fromRGBA(e,s,r,a){e/=255,s/=255,r/=255;const l=Math.max(e,s,r),f=Math.min(e,s,r);let g,m;const w=(l+f)/2;if(l===f)g=m=0;else{const A=l-f;switch(m=w>.5?A/(2-l-f):A/(l+f),l){case e:g=(s-r)/A+(s<r?6:0);break;case s:g=(r-e)/A+2;break;case r:g=(e-s)/A+4;break}g/=6}return new et(g,m,w,a)}toRGBA(){let e,s,r;if(this.s===0)e=s=r=this.l;else{const a=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,l=2*this.l-a;e=et.hue2rgb(l,a,this.h+1/3),s=et.hue2rgb(l,a,this.h),r=et.hue2rgb(l,a,this.h-1/3)}return new Q(e*255,s*255,r*255,this.a)}toString(){const e=this.h.toFixed(0),s=this.s.toFixed(0),r=this.l.toFixed(0),a=this.a.toFixed(0);return`hsla(${e}, ${s}, ${r}, ${a})`}}var Nt;(function(u){u[u.Debug=0]="Debug",u[u.Info=1]="Info",u[u.Warn=2]="Warn",u[u.Error=3]="Error",u[u.Fatal=4]="Fatal"})(Nt||(Nt={}));class at{constructor(){if(this._appenders=[],this.defaultLevel=Nt.Info,this._logOnceSet=new Set,at._INSTANCE)throw new Error("Logger is a singleton");return at._INSTANCE=this,at._INSTANCE.addAppender(new Ii),at._INSTANCE}static getInstance(){return at._INSTANCE==null&&(at._INSTANCE=new at),at._INSTANCE}addAppender(e){this._appenders.push(e)}clearAppenders(){this._appenders.length=0}_log(e,s){e==null&&(e=this.defaultLevel);const r=this._appenders.length;for(let a=0;a<r;a++)e>=this.defaultLevel&&this._appenders[a].log(e,s)}_logOnce(e,s){const r=e+s.join("+");this._logOnceSet.has(r)||(this._logOnceSet.add(r),this._log(e,s))}debug(...e){this._log(Nt.Debug,e)}debugOnce(...e){this._logOnce(Nt.Debug,e)}info(...e){this._log(Nt.Info,e)}infoOnce(...e){this._logOnce(Nt.Info,e)}warn(...e){this._log(Nt.Warn,e)}warnOnce(...e){this._logOnce(Nt.Warn,e)}error(...e){this._log(Nt.Error,e)}errorOnce(...e){this._logOnce(Nt.Error,e)}fatal(...e){this._log(Nt.Fatal,e)}fatalOnce(...e){this._logOnce(Nt.Fatal,e)}}at._INSTANCE=null;class Ii{log(e,s){if(!console&&!console.log&&console.warn&&console.error)return;const r=[];r.unshift.apply(r,s),r.unshift("["+Nt[e]+"] : "),e<Nt.Warn?console.log.apply?console.log.apply(console,r):console.log(r.join(" ")):e<Nt.Error?console.warn.apply?console.warn.apply(console,r):console.warn(r.join(" ")):console.error.apply?console.error.apply(console,r):console.error(r.join(" "))}}class gs{constructor(e){var s,r;this._messages=[],this._pos=10,this._color=Q.Black,this._options=e,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(r=(s=e.zIndex)===null||s===void 0?void 0:s.toString())!==null&&r!==void 0?r:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),e.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var e,s,r,a;const l=this._options;this.canvas.width=(e=l.width)!==null&&e!==void 0?e:l.engine.screen.resolution.width,this.canvas.height=(s=l.height)!==null&&s!==void 0?s:l.engine.screen.resolution.height,this.canvas.style.position="absolute";const f=l.engine.screen.screenToPageCoordinates(z(0,0));this.canvas.style.left=f.x+"px",this.canvas.style.top=f.y+"px",this._pos=(r=l.xPos)!==null&&r!==void 0?r:this._pos,this._color=(a=l.color)!==null&&a!==void 0?a:this._color}log(e,s){const r=s.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+Nt[e]+"] : "+r);let a=10;this._messages=this._messages.slice(0,1e3);for(let l=0;l<this._messages.length;l++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[l],this._pos,a),a+=10}}var Rt;(function(u){u.None="None",u.Top="Top",u.Bottom="Bottom",u.Left="Left",u.Right="Right"})(Rt||(Rt={})),function(u){function e(r){return r===u.Top?u.Bottom:r===u.Bottom?u.Top:r===u.Left?u.Right:r===u.Right?u.Left:u.None}u.getOpposite=e;function s(r){return Math.abs(r.x)>=Math.abs(r.y)?r.x<=0?u.Left:u.Right:r.y<=0?u.Top:u.Bottom}u.fromDirection=s}(Rt||(Rt={}));class ht{constructor(e=0,s=0,r=0,a=0){this._points=[],typeof e=="object"?(this.left=e.left,this.top=e.top,this.right=e.right,this.bottom=e.bottom):typeof e=="number"&&(this.left=e,this.top=s,this.right=r,this.bottom=a)}clone(e){const s=e||new ht(0,0,0,0);return s.left=this.left,s.right=this.right,s.top=this.top,s.bottom=this.bottom,s}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(e){return e&&e?Math.abs(e.x)>Math.abs(e.y)?e.x<0?Rt.Right:Rt.Left:e.y<0?Rt.Bottom:Rt.Top:Rt.None}static fromPoints(e){let s=1/0,r=1/0,a=-1/0,l=-1/0;for(let f=0;f<e.length;f++)e[f].x<s&&(s=e[f].x),e[f].x>a&&(a=e[f].x),e[f].y<r&&(r=e[f].y),e[f].y>l&&(l=e[f].y);return new ht(s,r,a,l)}static fromDimension(e,s,r=B.Half,a=B.Zero){return new ht(-e*r.x+a.x,-s*r.y+a.y,e-e*r.x+a.x,s-s*r.y+a.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new B((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new B(this.left,this.top)}get bottomRight(){return new B(this.right,this.bottom)}get topRight(){return new B(this.right,this.top)}get bottomLeft(){return new B(this.left,this.bottom)}translate(e){return new ht(this.left+e.x,this.top+e.y,this.right+e.x,this.bottom+e.y)}rotate(e,s=B.Zero){const r=this.getPoints().map(a=>a.rotate(e,s));return ht.fromPoints(r)}scale(e,s=B.Zero){const r=this.translate(s);return new ht(r.left*e.x,r.top*e.y,r.right*e.x,r.bottom*e.y)}transform(e){const s=e.data[0]*this.left,r=e.data[1]*this.left,a=e.data[0]*this.right,l=e.data[1]*this.right,f=e.data[2]*this.top,g=e.data[3]*this.top,m=e.data[2]*this.bottom,w=e.data[3]*this.bottom,A=e.getPosition(),y=Math.min(s,a)+Math.min(f,m)+A.x,E=Math.min(r,l)+Math.min(g,w)+A.y,D=Math.max(s,a)+Math.max(f,m)+A.x,L=Math.max(r,l)+Math.max(g,w)+A.y;return new ht({left:y,top:E,right:D,bottom:L})}getPerimeter(){const e=this.width,s=this.height;return 2*(e+s)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new B(this.left,this.top)),this._points.push(new B(this.right,this.top)),this._points.push(new B(this.right,this.bottom)),this._points.push(new B(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(e,s=1/0){let r=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,f=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,g=(this.left-e.pos.x)*l,m=(this.right-e.pos.x)*l;r=Math.min(g,m),a=Math.max(g,m);const w=(this.top-e.pos.y)*f,A=(this.bottom-e.pos.y)*f;return r=Math.max(r,Math.min(w,A)),a=Math.min(a,Math.max(w,A)),a>=Math.max(0,r)&&r<s}rayCastTime(e,s=1/0){let r=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,f=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,g=(this.left-e.pos.x)*l,m=(this.right-e.pos.x)*l;r=Math.min(g,m),a=Math.max(g,m);const w=(this.top-e.pos.y)*f,A=(this.bottom-e.pos.y)*f;return r=Math.max(r,Math.min(w,A)),a=Math.min(a,Math.max(w,A)),a>=Math.max(0,r)&&r<s?r:-1}contains(e){return e instanceof B?this.left<=e.x&&this.top<=e.y&&e.y<=this.bottom&&e.x<=this.right:e instanceof ht?this.left<=e.left&&this.top<=e.top&&e.bottom<=this.bottom&&e.right<=this.right:!1}combine(e,s){const r=s||new ht(0,0,0,0),a=Math.min(this.left,e.left),l=Math.min(this.top,e.top),f=Math.max(this.right,e.right),g=Math.max(this.bottom,e.bottom);return r.left=a,r.top=l,r.right=f,r.bottom=g,r}get dimensions(){return new B(this.width,this.height)}overlaps(e,s){const r=s||0;if(e.hasZeroDimensions())return this.contains(e);if(this.hasZeroDimensions())return e.contains(this);const a=this.combine(e);return a.width+r<e.width+this.width&&a.height+r<e.height+this.height}intersect(e){const s=this.combine(e);if(s.width<e.width+this.width&&s.height<e.height+this.height&&!s.dimensions.equals(e.dimensions)&&!s.dimensions.equals(this.dimensions)){let r=0;this.right>=e.left&&this.right<=e.right?r=e.left-this.right:r=e.right-this.left;let a=0;return this.top<=e.bottom&&this.top>=e.top?a=e.bottom-this.top:a=e.top-this.bottom,Math.abs(r)<Math.abs(a)?new B(r,0):new B(0,a)}else if(s.dimensions.equals(e.dimensions)||s.dimensions.equals(this.dimensions)){let r=0;this.width-e.width>=0?this.right-e.right<=e.left-this.left?r=e.left-this.right:r=e.right-this.left:e.right-this.right<=this.left-e.left?r=this.left-e.right:r=this.right-e.left;let a=0;return this.height-e.height>=0?this.bottom-e.bottom<=e.top-this.top?a=e.top-this.bottom:a=e.bottom-this.top:e.bottom-this.bottom<=this.top-e.top?a=this.top-e.bottom:a=this.bottom-e.top,Math.abs(r)<Math.abs(a)?new B(r,0):new B(0,a)}else return null}intersectWithSide(e){const s=this.intersect(e);return ht.getSideFromIntersection(s)}draw(e,s=Q.Yellow){e.debug.drawRect(this.left,this.top,this.width,this.height,{color:s})}}function zs(u){if(u&&u.getBoundingClientRect){const e=u.getBoundingClientRect();return z(e.x+window.scrollX,e.y+window.scrollY)}return B.Zero}function vo(u,e){return e.indexOf(u)===-1?(e.push(u),!0):!1}function ps(u,e){let s=-1;return(s=e.indexOf(u))>-1?(e.splice(s,1),!0):!1}function wo(u,e){for(let s=0;s<u.length;s++)if(u[s]===e)return!0;return!1}function rd(u){throw new Error(u)}function xo(u,e){var s;const r=new P;return((s=e?.schedule.bind(e))!==null&&s!==void 0?s:setTimeout)(()=>{r.resolve()},u),r.promise}function od(u,e){const s={};for(const r in u)e.includes(r)||(s[r]=u[r]);return s}function bo(u){return u&&typeof u=="object"&&!Array.isArray(u)}function Ao(u,...e){if(!e.length)return u;const s=e.shift();if(bo(u)&&bo(s))for(const r in s)bo(s[r])?(u[r]||Object.assign(u,{[r]:{}}),Ao(u[r],s[r])):Object.assign(u,{[r]:s[r]});return Ao(u,...e)}var Xa;(function(u){u[u.X=12]="X",u[u.Y=13]="Y"})(Xa||(Xa={}));class ui{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(e,s,r,a,l,f){const g=new ui;return g.data[0]=2/(s-e),g.data[1]=0,g.data[2]=0,g.data[3]=0,g.data[4]=0,g.data[5]=2/(a-r),g.data[6]=0,g.data[7]=0,g.data[8]=0,g.data[9]=0,g.data[10]=-2/(f-l),g.data[11]=0,g.data[12]=-(s+e)/(s-e),g.data[13]=-(a+r)/(a-r),g.data[14]=-(f+l)/(f-l),g.data[15]=1,g}clone(e){const s=e||new ui;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s.data[6]=this.data[6],s.data[7]=this.data[7],s.data[8]=this.data[8],s.data[9]=this.data[9],s.data[10]=this.data[10],s.data[11]=this.data[11],s.data[12]=this.data[12],s.data[13]=this.data[13],s.data[14]=this.data[14],s.data[15]=this.data[15],s}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(e){const s=new ui;return s.data=e,s}static identity(){const e=new ui;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}static translation(e,s){const r=ui.identity();return r.data[12]=e,r.data[13]=s,r}static scale(e,s){const r=ui.identity();return r.data[0]=e,r.data[5]=s,r.data[10]=1,r.data[15]=1,r}static rotation(e){const s=ui.identity();return s.data[0]=Math.cos(e),s.data[4]=-Math.sin(e),s.data[1]=Math.sin(e),s.data[5]=Math.cos(e),s}multiply(e,s){if(e instanceof B){const r=s||new B(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[4]+this.data[12],f=a.x*this.data[1]+a.y*this.data[5]+this.data[13];return r.x=l,r.y=f,r}else{const r=s||new ui,a=e,l=this.data[0],f=this.data[1],g=this.data[2],m=this.data[3],w=this.data[4],A=this.data[5],y=this.data[6],E=this.data[7],D=this.data[8],L=this.data[9],O=this.data[10],q=this.data[11],H=this.data[12],V=this.data[13],J=this.data[14],Y=this.data[15],$=a.data[0],ot=a.data[1],Z=a.data[2],gt=a.data[3],It=a.data[4],Yt=a.data[5],Qt=a.data[6],Pe=a.data[7],te=a.data[8],Ht=a.data[9],Ne=a.data[10],Me=a.data[11],st=a.data[12],gn=a.data[13],pn=a.data[14],mn=a.data[15];r.data[0]=l*$+w*ot+D*Z+H*gt,r.data[1]=f*$+A*ot+L*Z+V*gt,r.data[2]=g*$+y*ot+O*Z+J*gt,r.data[3]=m*$+E*ot+q*Z+Y*gt,r.data[4]=l*It+w*Yt+D*Qt+H*Pe,r.data[5]=f*It+A*Yt+L*Qt+V*Pe,r.data[6]=g*It+y*Yt+O*Qt+J*Pe,r.data[7]=m*It+E*Yt+q*Qt+Y*Pe,r.data[8]=l*te+w*Ht+D*Ne+H*Me,r.data[9]=f*te+A*Ht+L*Ne+V*Me,r.data[10]=g*te+y*Ht+O*Ne+J*Me,r.data[11]=m*te+E*Ht+q*Ne+Y*Me,r.data[12]=l*st+w*gn+D*pn+H*mn,r.data[13]=f*st+A*gn+L*pn+V*mn,r.data[14]=g*st+y*gn+O*pn+J*mn,r.data[15]=m*st+E*gn+q*pn+Y*mn;const Jn=this.getScale();return r._scaleSignX=G(Jn.x)*G(r._scaleSignX),r._scaleSignY=G(Jn.y)*G(r._scaleSignY),r}}translate(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],g=this.data[4],m=this.data[5],w=this.data[6],A=this.data[7],y=this.data[8],E=this.data[9],D=this.data[10],L=this.data[11],O=this.data[12],q=this.data[13],H=this.data[14],V=this.data[15],J=0,Y=1;return this.data[12]=r*e+g*s+y*J+O*Y,this.data[13]=a*e+m*s+E*J+q*Y,this.data[14]=l*e+w*s+D*J+H*Y,this.data[15]=f*e+A*s+L*J+V*Y,this}setPosition(e,s){this.data[12]=e,this.data[13]=s}getPosition(){return z(this.data[12],this.data[13])}rotate(e){const s=this.data[0],r=this.data[1],a=this.data[2],l=this.data[3],f=this.data[4],g=this.data[5],m=this.data[6],w=this.data[7],A=Math.sin(e),y=Math.cos(e);return this.data[0]=y*s+A*f,this.data[1]=y*r+A*g,this.data[2]=y*a+A*m,this.data[3]=y*l+A*w,this.data[4]=y*f-A*s,this.data[5]=y*g-A*r,this.data[6]=y*m-A*a,this.data[7]=y*w-A*l,this}scale(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],g=this.data[4],m=this.data[5],w=this.data[6],A=this.data[7];return this.data[0]=r*e,this.data[1]=a*e,this.data[2]=l*e,this.data[3]=f*e,this.data[4]=g*s,this.data[5]=m*s,this.data[6]=w*s,this.data[7]=A*s,this}setRotation(e){const s=this.getScale(),r=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=r*s.y,this.data[4]=-r*s.x,this.data[5]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return rt(e)}getScaleX(){const e=z(this.data[0],this.data[4]).magnitude;return this._scaleSignX*e}getScaleY(){const e=z(this.data[1],this.data[5]).magnitude;return this._scaleSignY*e}getScale(){return z(this.getScaleX(),this.getScaleY())}setScaleX(e){if(this._scaleX===e)return;this._scaleSignX=G(e);const s=z(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[4]=s.y*e,this._scaleX=e}setScaleY(e){if(this._scaleY===e)return;this._scaleSignY=G(e);const s=z(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[5]=s.y*e,this._scaleY=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(e){const r=1/this.getBasisDeterminant(),a=this.data[0],l=this.data[4],f=this.data[1],g=this.data[5],m=e||ui.identity();m.data[0]=g*r,m.data[1]=-f*r,m.data[4]=-l*r,m.data[5]=a*r;const w=this.data[12],A=this.data[13];return m.data[12]=-(w*m.data[0]+A*m.data[4]),m.data[13]=-(w*m.data[1]+A*m.data[5]),m}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class fe{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const e=new fe;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}static translation(e,s){const r=fe.identity();return r.data[4]=e,r.data[5]=s,r}static scale(e,s){const r=fe.identity();return r.data[0]=e,r.data[3]=s,r._scale[0]=e,r._scale[1]=s,r}static rotation(e){const s=fe.identity();return s.data[0]=Math.cos(e),s.data[1]=Math.sin(e),s.data[2]=-Math.sin(e),s.data[3]=Math.cos(e),s}setPosition(e,s){this.data[4]=e,this.data[5]=s}getPosition(){return z(this.data[4],this.data[5])}rotate(e){const s=this.data[0],r=this.data[1],a=this.data[2],l=this.data[3],f=Math.sin(e),g=Math.cos(e);return this.data[0]=g*s+f*a,this.data[1]=g*r+f*l,this.data[2]=g*a-f*s,this.data[3]=g*l-f*r,this}translate(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3],g=this.data[4],m=this.data[5];return this.data[4]=r*e+l*s+g,this.data[5]=a*e+f*s+m,this}scale(e,s){const r=this.data[0],a=this.data[1],l=this.data[2],f=this.data[3];return this.data[0]=r*e,this.data[1]=a*e,this.data[2]=l*s,this.data[3]=f*s,this._scale[0]=e,this._scale[1]=s,this._scaleSignX=G(e),this._scaleSignY=G(s),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(e){const s=this.determinant();let r=s;s!==0&&(r=1/s);const a=this.data[0],l=this.data[2],f=this.data[1],g=this.data[3],m=e||fe.identity();m.data[0]=g*r,m.data[1]=-f*r,m.data[2]=-l*r,m.data[3]=a*r;const w=this.data[4],A=this.data[5];return m.data[4]=-(w*m.data[0]+A*m.data[2]),m.data[5]=-(w*m.data[1]+A*m.data[3]),m}multiply(e,s){if(e instanceof B){const r=s||new B(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[2]+this.data[4],f=a.x*this.data[1]+a.y*this.data[3]+this.data[5];return r.x=l,r.y=f,r}else{const r=s||new fe,a=e,l=this.data[0],f=this.data[1],g=this.data[2],m=this.data[3],w=this.data[4],A=this.data[5],y=a.data[0],E=a.data[1],D=a.data[2],L=a.data[3],O=a.data[4],q=a.data[5];r.data[0]=l*y+g*E,r.data[1]=f*y+m*E,r.data[2]=l*D+g*L,r.data[3]=f*D+m*L,r.data[4]=l*O+g*q+w,r.data[5]=f*O+m*q+A;const H=this._scaleSignX,V=this._scaleSignY;return r._scaleSignX=H*G(r._scaleSignX),r._scaleSignY=V*G(r._scaleSignY),r}}multiplyQuadInPlace(e){const s=e[0]*this.data[0]+e[1]*this.data[2]+this.data[4],r=e[0]*this.data[1]+e[1]*this.data[3]+this.data[5];e[0]=s,e[1]=r;const a=e[2]*this.data[0]+e[3]*this.data[2]+this.data[4],l=e[2]*this.data[1]+e[3]*this.data[3]+this.data[5];e[2]=a,e[3]=l;const f=e[4]*this.data[0]+e[5]*this.data[2]+this.data[4],g=e[4]*this.data[1]+e[5]*this.data[3]+this.data[5];e[4]=f,e[5]=g;const m=e[6]*this.data[0]+e[7]*this.data[2]+this.data[4],w=e[6]*this.data[1]+e[7]*this.data[3]+this.data[5];e[6]=m,e[7]=w}to4x4(){const e=new ui;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=0,e.data[3]=0,e.data[4]=this.data[2],e.data[5]=this.data[3],e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=this.data[4],e.data[13]=this.data[5],e.data[14]=0,e.data[15]=1,e}setRotation(e){const s=this.getScale(),r=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=r*s.y,this.data[2]=-r*s.x,this.data[3]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return rt(e)}getScaleX(){const e=this.data[0]*this.data[0]+this.data[2]*this.data[2];return e===1?this._scaleSignX:this._scaleSignX*Math.sqrt(e)}getScaleY(){const e=this.data[1]*this.data[1]+this.data[3]*this.data[3];return e===1?this._scaleSignY:this._scaleSignY*Math.sqrt(e)}getScale(){return z(this.getScaleX(),this.getScaleY())}setScaleX(e){if(e===this._scale[0])return;this._scaleSignX=G(e);const s=z(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[2]=s.y*e,this._scale[0]=e}setScaleY(e){if(e===this._scale[1])return;this._scaleSignY=G(e);const s=z(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[3]=s.y*e,this._scale[1]=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}clone(e){const s=e||new fe;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s._scaleSignX=this._scaleSignX,s._scaleSignY=this._scaleSignY,s}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}class mr{constructor(e,s,r=1){this.builder=e,this.cleaner=s,this._pool=[],this._size=0,this.grow(r)}grow(e){if(e>0){this._size+=e;for(let s=0;s<e;s++)this._pool.push(this.builder())}}rent(e=!1){return this._pool.length===0&&this.grow(this._size),e?this.cleaner(this._pool.pop()):this._pool.pop()}return(e){this._pool.push(e)}}class Hg{constructor(){this._pool=new mr(()=>fe.identity(),e=>e.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(e,s){return this._currentTransform.translate(e,s)}rotate(e){return this._currentTransform.rotate(e)}scale(e,s){return this._currentTransform.scale(e,s)}reset(){this._currentTransform.reset()}set current(e){this._currentTransform=e}get current(){return this._currentTransform}}class Og{constructor(){this.opacity=1,this.z=0,this.tint=Q.White,this.material=null}}class ad{constructor(){this._pool=new mr(()=>new Og,e=>(e.opacity=1,e.z=0,e.tint=Q.White,e.material=null,e),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(e){var s;return e.opacity=this.current.opacity,e.z=this.current.z,e.tint=(s=this.current.tint)===null||s===void 0?void 0:s.clone(),e.material=this.current.material,e}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const Wg={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class vr{constructor(e,s,r=!1){this.path=e,this.responseType=s,this.bustCache=r,this.data=null,this.logger=at.getInstance(),this.events=new I}isLoaded(){return this.data!==null}_cacheBust(e){return/\?\w*=\w*/.test(e)?e+="&__="+Date.now():e+="?__="+Date.now(),e}load(){return new Promise((e,s)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),e(this.data);return}const r=new XMLHttpRequest;r.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),r.responseType=this.responseType,r.addEventListener("loadstart",a=>this.events.emit("loadstart",a)),r.addEventListener("progress",a=>this.events.emit("progress",a)),r.addEventListener("error",a=>this.events.emit("error",a)),r.addEventListener("load",a=>this.events.emit("load",a)),r.addEventListener("load",()=>{if(r.status!==0&&r.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",r.status),this.events.emit("error",r.response),s(new Error(r.statusText));return}if(r.response instanceof Blob&&r.response.type==="text/html"){const a=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",r.response),s(new Error(a));return}this.data=r.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),e(this.data)}),r.send()})}}function Ri(u,e){return u&&(u.__isProxy===void 0?new Proxy(u,{set:(s,r,a)=>(s[r]!==a&&(s[r]=a,typeof r=="string"&&r[0]!=="_"&&e(s)),!0),get:(s,r)=>r!=="__isProxy"?s[r]:!0}):u)}const hd=(u=[],e,s)=>({get:(r,a)=>a==="__isProxy"?!0:typeof r[a]=="object"&&r[a]!=null?new Proxy(r[a],hd([...u,a],e,s)):r[a],set:(r,a,l)=>(typeof a=="string"&&a[0]!=="_"&&e(s),r[a]=l,!0)});function Vg(u,e){return u&&(u.__isProxy===void 0?new Proxy(u,hd([],e,u)):u)}class ie{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(e){this._flipHorizontal=e,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(e){this._flipVertical=e,this._transformStale=!0}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._transformStale=!0}get scale(){return this._scale}set scale(e){this._scale=Ri(e,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(e){e&&(this._origin=Ri(e,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(e){var s,r,a,l,f,g,m;this.id=ie._ID++,this.transform=fe.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=B.One,this._width=0,this._height=0,e&&(this.origin=(s=e.origin)!==null&&s!==void 0?s:this.origin,this.flipHorizontal=(r=e.flipHorizontal)!==null&&r!==void 0?r:this.flipHorizontal,this.flipVertical=(a=e.flipVertical)!==null&&a!==void 0?a:this.flipVertical,this.rotation=(l=e.rotation)!==null&&l!==void 0?l:this.rotation,this.opacity=(f=e.opacity)!==null&&f!==void 0?f:this.opacity,this.scale=(g=e.scale)!==null&&g!==void 0?g:this.scale,this.tint=(m=e.tint)!==null&&m!==void 0?m:this.tint,e.width&&(this._width=e.width),e.height&&(this._height=e.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(e){this._width=e,this._transformStale=!0}set height(e){this._height=e,this._transformStale=!0}get localBounds(){return ht.fromDimension(this.width,this.height,B.Zero)}draw(e,s,r){this._preDraw(e,s,r),this._drawImage(e,0,0),this._postDraw(e)}_preDraw(e,s,r){e.save(),e.translate(s,r),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),e.multiply(this.transform),e.opacity=e.opacity*this.opacity,this.tint&&(e.tint=this.tint)}_rotate(e){var s;const r=this.scale.x>0?1:-1,a=this.scale.y>0?1:-1,l=(s=this.origin)!==null&&s!==void 0?s:z(this.width/2,this.height/2);e.translate(l.x,l.y),e.rotate(this.rotation),e.scale(r,a),e.translate(-l.x,-l.y)}_flip(e){this.flipHorizontal&&(e.translate(this.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,this.height/this.scale.y),e.scale(1,-1))}_postDraw(e){this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore()}}ie._ID=0;class Di extends ie{static from(e,s){return new Di({image:e,...s})}constructor(e){var s,r;super(e),this._logger=at.getInstance(),this._dirty=!0,this.image=e.image;const{width:a,height:l}=e;this.sourceView=(s=e.sourceView)!==null&&s!==void 0?s:{x:0,y:0,width:a??0,height:l??0},this.destSize=(r=e.destSize)!==null&&r!==void 0?r:{width:a??0,height:l??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(e){e/=Math.abs(this.scale.x),this.destSize.width=e,super.width=Math.ceil(this.destSize.width)}set height(e){e/=Math.abs(this.scale.y),this.destSize.height=e,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var e,s,r,a,l,f;const{width:g,height:m}=this.image;this.sourceView.width=((e=this.sourceView)===null||e===void 0?void 0:e.width)||g,this.sourceView.height=((s=this.sourceView)===null||s===void 0?void 0:s.height)||m,this.destSize.width=((r=this.destSize)===null||r===void 0?void 0:r.width)||((a=this.sourceView)===null||a===void 0?void 0:a.width)||g,this.destSize.height=((l=this.destSize)===null||l===void 0?void 0:l.height)||((f=this.sourceView)===null||f===void 0?void 0:f.height)||m,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(e,s,r){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(e,s,r)}_drawImage(e,s,r){this.image.isLoaded()?e.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,s,r,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new Di({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var _e;(function(u){u.Pixel="Pixel",u.Blended="Blended"})(_e||(_e={}));function zn(u){switch(u){case _e.Pixel:return _e.Pixel;case _e.Blended:return _e.Blended;default:return}}var jt;(function(u){u.Clamp="Clamp",u.Repeat="Repeat",u.Mirror="Mirror"})(jt||(jt={}));function Fi(u){switch(u){case jt.Clamp:return jt.Clamp;case jt.Repeat:return jt.Repeat;case jt.Mirror:return jt.Mirror;default:return jt.Clamp}}class se{constructor(e,s){var r;this._garbageCollector=s,this._textureMap=new Map,this._collect=a=>{var l;if(this._gl){const f=(l=a.dataset.originalSrc)!==null&&l!==void 0?l:a.constructor.name;return se._LOGGER.debug(`WebGL Texture for ${f} collected`),this.delete(a),!0}return!1},this._gl=e,se._MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE),this._garbageCollector&&(se._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(r=this._garbageCollector.garbageCollector)===null||r===void 0||r.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[e]of this._textureMap)this.delete(e);this._textureMap.clear(),this._gl=null}get(e){return this._textureMap.get(e)}has(e){return this._textureMap.has(e)}load(e,s,r=!1){var a,l;const f=this._gl;if(!f)return null;const{filtering:g,wrapping:m}={...s};let w=null;if(this.has(e)&&(w=this.get(e)),w)return r&&(f.bindTexture(f.TEXTURE_2D,w),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,e)),(a=this._garbageCollector)===null||a===void 0||a.garbageCollector.touch(e),w;w=f.createTexture(),se.checkImageSizeSupportedAndLog(e),f.bindTexture(f.TEXTURE_2D,w),f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let A;m&&(typeof m=="string"?A={x:m,y:m}:A={x:m.x,y:m.y});const{x:y,y:E}=A??se.wrapping;switch(y){case jt.Clamp:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);break;case jt.Repeat:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT);break;case jt.Mirror:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.MIRRORED_REPEAT);break;default:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE)}switch(E){case jt.Clamp:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);break;case jt.Repeat:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT);break;case jt.Mirror:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.MIRRORED_REPEAT);break;default:f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE)}const D=g??se.filtering;return f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,D===_e.Pixel?f.NEAREST:f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,D===_e.Pixel?f.NEAREST:f.LINEAR),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,e),this._textureMap.set(e,w),(l=this._garbageCollector)===null||l===void 0||l.garbageCollector.addCollectableResource("texture",e),w}delete(e){const s=this._gl;if(s&&this.has(e)){const r=this.get(e);r&&(this._textureMap.delete(e),s.deleteTexture(r))}}static checkImageSizeSupportedAndLog(e){var s;const r=(s=e.dataset.originalSrc)!==null&&s!==void 0?s:"internal canvas bitmap";return e.width>se._MAX_TEXTURE_SIZE||e.height>se._MAX_TEXTURE_SIZE?(se._LOGGER.error(`The image [${r}] provided to Excalibur is too large for the device's maximum texture size of (${se._MAX_TEXTURE_SIZE}x${se._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((e.width>4096||e.height>4096)&&se._LOGGER.warn(`The image [${r}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}se._LOGGER=at.getInstance(),se.filtering=_e.Blended,se.wrapping={x:jt.Clamp,y:jt.Clamp},se._MAX_TEXTURE_SIZE=4096;const Ft={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class Xi{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(e,s,r){this._logger=at.getInstance(),this.data=new Image,this._readyFuture=new P,this.ready=this._readyFuture.promise,this.path=e;let a=!1,l;typeof s=="boolean"?a=s:{filtering:r,wrapping:l,bustCache:a}={...s},this._resource=new vr(e,"blob",a),this.filtering=r??this.filtering,typeof l=="string"?this.wrapping={x:l,y:l}:this.wrapping=l??this.wrapping,e.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${e} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(e,s){const r=new Xi("");if(r._src="image-element",r.data=e,r.data.setAttribute("data-original-src","image-element"),s?.filtering?r.data.setAttribute(Ft.Filtering,s?.filtering):r.data.setAttribute(Ft.Filtering,_e.Blended),s?.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},r.data.setAttribute(Ft.WrappingX,a.x),r.data.setAttribute(Ft.WrappingY,a.y)}else r.data.setAttribute(Ft.WrappingX,jt.Clamp),r.data.setAttribute(Ft.WrappingY,jt.Clamp);return se.checkImageSizeSupportedAndLog(e),r._readyFuture.resolve(e),r}static fromHtmlCanvasElement(e,s){const r=new Xi("");if(r._src="canvas-element-blob",r.data.setAttribute("data-original-src","canvas-element-blob"),s?.filtering?r.data.setAttribute(Ft.Filtering,s?.filtering):r.data.setAttribute(Ft.Filtering,_e.Blended),s?.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},r.data.setAttribute(Ft.WrappingX,a.x),r.data.setAttribute(Ft.WrappingY,a.y)}else r.data.setAttribute(Ft.WrappingX,jt.Clamp),r.data.setAttribute(Ft.WrappingY,jt.Clamp);return se.checkImageSizeSupportedAndLog(e),e.toBlob(a=>{const l=URL.createObjectURL(a);r.image.onload=()=>{URL.revokeObjectURL(l),r.data=r.image,r._readyFuture.resolve(r.image)},r.image.src=l}),r}static fromSvgString(e,s){const r=new Blob([e],{type:"image/svg+xml"}),a=URL.createObjectURL(r);return new Xi(a,s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){var e,s,r,a;if(this.isLoaded())return this.data;try{let l;if(this.path.includes("data:image/"))l=this.path;else{const m=await this._resource.load();l=URL.createObjectURL(m)}const f=new Image,g=new P;f.onload=()=>g.resolve(),f.src=l,f.setAttribute("data-original-src",this.path),await g.promise,this.data=f,se.checkImageSizeSupportedAndLog(this.data)}catch(l){throw`Error loading ImageSource from path '${this.path}' with error [${l.message}]`}return this.data.setAttribute(Ft.Filtering,this.filtering),this.data.setAttribute(Ft.WrappingX,(s=(e=this.wrapping)===null||e===void 0?void 0:e.x)!==null&&s!==void 0?s:jt.Clamp),this.data.setAttribute(Ft.WrappingY,(a=(r=this.wrapping)===null||r===void 0?void 0:r.y)!==null&&a!==void 0?a:jt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(e){return Di.from(this,e)}unload(){this.data=new Image}}class yo extends ie{constructor(e){super(e),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=at.getInstance();const{alphabet:s,spriteSheet:r,caseInsensitive:a,spacing:l,shadow:f,lineHeight:g}=e;this.alphabet=s,this.spriteSheet=r,this.caseInsensitive=a??this.caseInsensitive,this.spacing=l??this.spacing,this.shadow=f??this.shadow,this.lineHeight=g??this.lineHeight}_getCharacterSprites(e){const s=[],r=this.caseInsensitive?e.toLocaleLowerCase():e,a=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let l=0;l<r.length;l++){const f=r[l];let g=a.indexOf(f);g===-1&&(g=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${f}' in configured alphabet '${a}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const m=this.spriteSheet.sprites[g];m?s.push(m):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${f}' at index '${g}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return s}measureText(e,s){const r=this._getLinesFromText(e,s),a=r.reduce((m,w)=>m.length>w.length?m:w),l=this._getCharacterSprites(a);let f=0,g=0;for(const m of l)f+=m.width+this.spacing,g=Math.max(g,m.height);return ht.fromDimension(f*this.scale.x,g*r.length*this.scale.y,B.Zero)}_drawImage(e,s,r,a){var l;let f=0,g=0,m=0;const w=this._getLinesFromText(this._text,a);for(const A of w){for(const y of this._getCharacterSprites(A))y.draw(e,s+f,r+g),f+=y.width+this.spacing,m=Math.max(m,y.height);f=0,g+=(l=this.lineHeight)!==null&&l!==void 0?l:m}}render(e,s,r,a,l,f){this._text=s;const g=this.measureText(s,f);this.width=g.width,this.height=g.height,this.shadow&&(e.save(),e.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(e,a,l),this._drawImage(e,0,0,f),this._postDraw(e),e.restore()),this._preDraw(e,a,l),this._drawImage(e,0,0,f),this._postDraw(e)}clone(){return new yo({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(e,s){var r;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let f=a[l],g="";if(this.measureText(f).width>s){for(;this.measureText(f).width>s;)g=f[f.length-1]+g,f=f.slice(0,-1);a[l]=f,a[l+1]=g}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class wr extends Di{constructor(e){super({image:e.image,sourceView:e.sourceView,destSize:{width:e.width,height:e.height},flipHorizontal:e.flipHorizontal,flipVertical:e.flipVertical,rotation:e.rotation,scale:e.scale,opacity:e.opacity,tint:e.tint,origin:e.origin}),this._ready=new P,this.ready=this._ready.promise,this._options=e,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(e,s){return new wr({sourceView:{...e.sourceView},width:e.width,height:e.height,...s,image:e.image})}_applyTiling(){const{width:e,height:s,filtering:r,wrapping:a}={...this._options},l=document.createElement("canvas");l.width=this.sourceView.width,l.height=this.sourceView.height,l.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const g=Xi.fromHtmlCanvasElement(l,{wrapping:a??jt.Repeat,filtering:r});e&&(this.destSize.width=e,this.sourceView.width=e),s&&(this.destSize.height=s,this.sourceView.height=s),this.sourceView.x=0,this.sourceView.y=0,this.image=g,this.image.ready.then(()=>this._ready.resolve())}}class nn{constructor(e){this.sprites=[];const{sprites:s,rows:r,columns:a}=e;this.sprites=s,this.rows=r??1,this.columns=a??this.sprites.length}getSprite(e,s,r){var a,l,f,g,m,w,A,y,E;if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const D=e+s*this.columns,L=this.sprites[D];if(L){if(r){const O=L.clone();return O.flipHorizontal=(a=r.flipHorizontal)!==null&&a!==void 0?a:O.flipHorizontal,O.flipVertical=(l=r.flipVertical)!==null&&l!==void 0?l:O.flipVertical,O.width=(f=r.width)!==null&&f!==void 0?f:O.width,O.height=(g=r.height)!==null&&g!==void 0?g:O.height,O.rotation=(m=r.rotation)!==null&&m!==void 0?m:O.rotation,O.scale=(w=r.scale)!==null&&w!==void 0?w:O.scale,O.opacity=(A=r.opacity)!==null&&A!==void 0?A:O.opacity,O.tint=(y=r.tint)!==null&&y!==void 0?y:O.tint,O.origin=(E=r.origin)!==null&&E!==void 0?E:O.origin,O}return L}throw Error(`Invalid sprite coordinates (${e}, ${s})`)}getTiledSprite(e,s,r){if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const a=e+s*this.columns,l=this.sprites[a];if(l)return wr.fromSprite(l,r);throw Error(`Invalid sprite coordinates (${e}, ${s})`)}static fromImageSourceWithSourceViews(e){const s=e.sourceViews.map(r=>new Di({image:e.image,sourceView:r}));return new nn({sprites:s})}static fromImageSource(e){var s;const r=[];e.spacing=(s=e.spacing)!==null&&s!==void 0?s:{};const{image:a,grid:{rows:l,columns:f,spriteWidth:g,spriteHeight:m},spacing:{originOffset:w,margin:A}}=e,y={x:0,y:0,...w},E={x:0,y:0,...A};for(let D=0;D<f;D++)for(let L=0;L<l;L++)r[D+L*f]=new Di({image:a,sourceView:{x:D*g+E.x*D+y.x,y:L*m+E.y*L+y.y,width:g,height:m},destSize:{height:m,width:g}});return new nn({sprites:r,rows:l,columns:f})}clone(){return new nn({sprites:this.sprites.map(e=>e.clone()),rows:this.rows,columns:this.columns})}}const Ng="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class qa{constructor(){this.fontSheet=Ng,this.size=16,this.load()}load(){return this._imageSource=new Xi(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=nn.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new yo({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(e,s,r){this._imageSource.isLoaded()&&this._spriteFont.render(e,s,null,r.x,r.y)}}class Gg{constructor(e,s){this._gl=e,this._texture=s}use(){const e=this._gl;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._texture)}disable(){const e=this._gl;e.bindTexture(e.TEXTURE_2D,null)}}class Co{constructor(e){var s,r;this.antialias=!1,this.samples=1,this._gl=e.gl,this.width=e.width,this.height=e.height,this.transparency=e.transparency,this.antialias=(s=e.antialias)!==null&&s!==void 0?s:this.antialias,this.samples=(r=e.samples)!==null&&r!==void 0?r:this._gl.getParameter(this._gl.MAX_SAMPLES);const a=this._gl;a.drawingBufferFormat?this.bufferFormat=a.drawingBufferFormat:this.transparency?this.bufferFormat=a.RGBA8:this.bufferFormat=a.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(e,s){const r=this._gl;this.width=e,this.height=s,r.bindTexture(r.TEXTURE_2D,this._frameTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.width,this.height,0,r.RGBA,r.UNSIGNED_BYTE,null),this._renderBuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,this._renderBuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,Math.min(this.samples,r.getParameter(r.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const e=this._gl;this._renderBuffer=e.createRenderbuffer(),this._renderFrameBuffer=e.createFramebuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._renderBuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,Math.min(this.samples,e.getParameter(e.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const e=this._gl;this._frameTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._frameTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const s=e.COLOR_ATTACHMENT0;this._frameBuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,s,e.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new Gg(this._gl,this._frameTexture)}blitToScreen(){const e=this._gl;this._renderBuffer?(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)):(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.frameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const e=this._gl;e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.frameBuffer),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)}}copyToTexture(e){const s=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),s.bindFramebuffer(s.FRAMEBUFFER,this._frameBuffer),s.bindTexture(s.TEXTURE_2D,e),s.copyTexImage2D(s.TEXTURE_2D,0,s.RGBA,0,0,this.width,this.height,0)}use(){const e=this._gl;this.antialias?e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.viewport(0,0,this.width,this.height)}disable(){const e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null)}}const Xg=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,qg=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function Ya(u,e){switch(e){case u.INT:case u.UNSIGNED_INT:case u.FLOAT:return 4;case u.SHORT:return 2;case u.UNSIGNED_SHORT:return 2;case u.BYTE:return 1;case u.UNSIGNED_BYTE:return 1;default:return 1}}function ld(u,e){const s=`(?<type>[a-z0-9]+)\\s+${e};`,a=new RegExp(s,"g").exec(u);return a?.length>0}function cd(u,e,s){var r;const a=`(?<type>[a-z0-9]+)\\s+${s};`,f=new RegExp(a,"g").exec(e);switch((r=f?.groups)===null||r===void 0?void 0:r.type){case"float":case"vec2":case"vec3":case"vec4":return u.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return u.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return u.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return u.BOOL;case"short":return u.SHORT;case"ushort":return u.UNSIGNED_SHORT;case"ubyte":return u.UNSIGNED_BYTE;case"byte":return u.BYTE;default:return u.FLOAT}}function dd(u,e){switch(e){case u.LOW_FLOAT:case u.HIGH_FLOAT:case u.FLOAT:return 1;case u.FLOAT_VEC2:return 2;case u.FLOAT_VEC3:return 3;case u.FLOAT_VEC4:return 4;case u.BYTE:return 1;case u.UNSIGNED_BYTE:return 1;case u.UNSIGNED_SHORT:case u.SHORT:return 1;default:return 1}}function ud(u,e){switch(e){case u.LOW_FLOAT:case u.HIGH_FLOAT:case u.FLOAT:case u.FLOAT_VEC2:case u.FLOAT_VEC3:case u.FLOAT_VEC4:return u.FLOAT;case u.BYTE:return u.BYTE;case u.UNSIGNED_BYTE:return u.UNSIGNED_BYTE;case u.SHORT:return u.SHORT;case u.UNSIGNED_SHORT:return u.UNSIGNED_SHORT;default:return u.FLOAT}}function ja(u,e){const s=a=>{const l=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let f="";for(let g=0;g<a;g++)g===0?f+=`if (index <= ${g}.5) {
`:f+=`   else if (index <= ${g}.5) {
`,f+=`      fragColor = vec4(1.0);
`,f+=`   }
`;return l.replace("%%complexity%%",f)};let r=!1;do{const a=s(e),l=u.createShader(u.FRAGMENT_SHADER);u.shaderSource(l,a),u.compileShader(l),r=u.getShaderParameter(l,u.COMPILE_STATUS),r||(e=e/2|0)}while(!r);return e}class ni{get compiled(){return this._compiled}constructor(e){this._logger=at.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:s,vertexSource:r,fragmentSource:a,onPreLink:l,onPostCompile:f}=e;this._gl=s,this.vertexSource=r,this.fragmentSource=a,this._onPreLink=l,this._onPostCompile=f}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),ni._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return ni._ACTIVE_SHADER_INSTANCE===this}compile(){const e=this._gl,s=this._compileShader(e,this.vertexSource,e.VERTEX_SHADER),r=this._compileShader(e,this.fragmentSource,e.FRAGMENT_SHADER);this.program=this._createProgram(e,s,r);const a=this.getAttributes();for(const f of a)this.attributes[f.name]=f;const l=this.getUniforms();for(const f of l)this.uniforms[f.name]=f;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS),r=[];for(let a=0;a<s;a++){const l=e.getActiveUniform(this.program,a),f=e.getUniformLocation(this.program,l.name);r.push({name:l.name,glType:l.type,location:f})}return r}getAttributes(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES),r=[];for(let a=0;a<s;a++){const l=e.getActiveAttrib(this.program,a),f=e.getAttribLocation(this.program,l.name);r.push({name:l.name,glType:ud(e,l.type),size:dd(e,l.type),location:f,normalized:!1})}return r}setTexture(e,s){const r=this._gl;r.activeTexture(r.TEXTURE0+e),r.bindTexture(r.TEXTURE_2D,s)}setUniformInt(e,s){this.setUniform("uniform1i",e,~~s)}trySetUniformInt(e,s){return this.trySetUniform("uniform1i",e,~~s)}setUniformIntArray(e,s){this.setUniform("uniform1iv",e,s)}trySetUniformIntArray(e,s){return this.trySetUniform("uniform1iv",e,s)}setUniformBoolean(e,s){this.setUniform("uniform1i",e,s?1:0)}trySetUniformBoolean(e,s){return this.trySetUniform("uniform1i",e,s?1:0)}setUniformFloat(e,s){this.setUniform("uniform1f",e,s)}trySetUniformFloat(e,s){return this.trySetUniform("uniform1f",e,s)}setUniformFloatArray(e,s){this.setUniform("uniform1fv",e,s)}trySetUniformFloatArray(e,s){return this.trySetUniform("uniform1fv",e,s)}setUniformFloatVector(e,s){this.setUniform("uniform2f",e,s.x,s.y)}trySetUniformFloatVector(e,s){return this.trySetUniform("uniform2f",e,s.x,s.y)}setUniformFloatColor(e,s){this.setUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}trySetUniformFloatColor(e,s){return this.trySetUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}setUniformMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,s.data)}setUniformAffineMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,[s.data[0],s.data[1],0,0,s.data[2],s.data[3],0,0,0,0,1,0,s.data[4],s.data[5],0,1])}trySetUniformMatrix(e,s){return this.trySetUniform("uniformMatrix4fv",e,!1,s.data)}setUniform(e,s,...r){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${e}:${s}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const l=this._gl.getUniformLocation(this.program,s);if(l){const f=[l,...r];this._gl[e].apply(this._gl,f)}else throw Error(`Uniform ${e}:${s} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(e,s,...r){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${e}:${s}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const l=this._gl.getUniformLocation(this.program,s);if(l){const f=[l,...r];this._gl[e].apply(this._gl,f)}else return!1;return!0}_createProgram(e,s,r){const a=e.createProgram();if(a===null)throw Error("Could not create graphics shader program");if(e.attachShader(a,s),e.attachShader(a,r),this._onPreLink&&this._onPreLink(a),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw Error(`Could not link the program: [${e.getProgramInfoLog(a)}]`);return a}_compileShader(e,s,r){const a=e.VERTEX_SHADER===r?"vertex":"fragment",l=e.createShader(r);if(l===null)throw Error(`Could not build shader: [${s}]`);if(e.shaderSource(l,s),e.compileShader(l),!e.getShaderParameter(l,e.COMPILE_STATUS)){const g=e.getShaderInfoLog(l);throw Error(`Could not compile ${a} shader:

${g}${this._processSourceForError(s,g)}`)}return l}_processSourceForError(e,s){if(!e)return s;const r=e.split(`
`),a=s.search(/\d:\d/),l=s.indexOf(" ",a),[f,g]=s.slice(a,l).split(":").map(m=>Number(m));for(let m=0;m<r.length;m++)r[m]=`${m+1}: ${r[m]}${g===m+1?" <----- ERROR!":""}`;return`

Source:
`+r.join(`
`)}}ni._ACTIVE_SHADER_INSTANCE=null;class qi{constructor(e){this.type="dynamic";const{gl:s,size:r,type:a,data:l}=e;if(this._gl=s,this.buffer=this._gl.createBuffer(),!l&&!r)throw Error("Must either provide data or a size to the VertexBuffer");l?this.bufferData=l:this.bufferData=new Float32Array(r),this.type=a??this.type,s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer)}unbind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,null)}upload(e){const s=this._gl;s.bindBuffer(s.ARRAY_BUFFER,this.buffer),e?s.bufferSubData(s.ARRAY_BUFFER,0,this.bufferData,0,e):s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class ms{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(e){this._logger=at.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:s,shader:r,vertexBuffer:a,attributes:l,suppressWarnings:f}=e;this._gl=s,this._vertexBuffer=a,this._attributes=l,this._shader=r,this._suppressWarnings=f,r&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(e){e&&this._shader!==e&&(this._shader=e,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const e=this._shader.attributes;for(const l of this._attributes){const f=e[l[0]];if(!f){if(!ld(this._shader.vertexSource,l[0]))throw Error(`The attribute named: ${l[0]} size ${l[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${l[0]} size ${l[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${l[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${l[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const g=cd(this._gl,this._shader.vertexSource,l[0]);this._layout.push({name:l[0],glType:g,size:l[1],location:-1,normalized:!1})}if(f){if(f.size!==l[1])throw Error(`VertexLayout size definition for attribute: [${l[0]}, ${l[1]}], doesn't match shader source size ${f.size}:
 ${this._shader.vertexSource}`);this._layout.push(f)}}let s=0;for(const l of this._layout){const f=Ya(this._gl,l.glType);this._vertexTotalSizeBytes+=f*l.size,s+=l.size}this._vertexBuffer.bufferData.length%s!==0&&this._logger.warn(`The vertex component size (${s})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const r=this._gl;this._vao=r.createVertexArray(),r.bindVertexArray(this._vao),this._vertexBuffer.bind();let a=0;for(const l of this._layout)l.location!==-1&&(l.glType===r.INT?r.vertexAttribIPointer(l.location,l.size,l.glType,this.totalVertexSizeBytes,a):r.vertexAttribPointer(l.location,l.size,l.glType,l.normalized,this.totalVertexSizeBytes,a),r.enableVertexAttribArray(l.location)),a+=Ya(r,l.glType)*l.size;r.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(e=!1,s){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const r=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),e&&this._vertexBuffer.upload(s),r.bindVertexArray(this._vao)}}class Zt{static clear(){Zt.DrawCallCount=0,Zt.DrawnImagesCount=0}}Zt.DrawCallCount=0,Zt.DrawnImagesCount=0;class Yg{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=z(0,0),this._endScratch=z(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new ni({gl:e,vertexSource:Xg,fragmentSource:qg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new qi({gl:e,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new ms({gl:e,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,r){this._isFull()&&this.flush(),this._lineCount++;const a=this._context.getTransform(),l=a.multiply(e,this._startScratch),f=a.multiply(s,this._endScratch),g=this._vertexBuffer.bufferData;g[this._vertexIndex++]=l.x,g[this._vertexIndex++]=l.y,g[this._vertexIndex++]=r.r/255,g[this._vertexIndex++]=r.g/255,g[this._vertexIndex++]=r.b/255,g[this._vertexIndex++]=r.a,g[this._vertexIndex++]=f.x,g[this._vertexIndex++]=f.y,g[this._vertexIndex++]=r.r/255,g[this._vertexIndex++]=r.g/255,g[this._vertexIndex++]=r.b/255,g[this._vertexIndex++]=r.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.LINES,0,this._lineCount*2),Zt.DrawnImagesCount+=this._lineCount,Zt.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const jg=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,Zg=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class Qg{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new ni({gl:e,vertexSource:jg,fragmentSource:Zg}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new qi({gl:e,size:7*this._maxPoints,type:"dynamic"}),this._layout=new ms({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,r){this._isFull()&&this.flush(),this._pointCount++;const a=this._context.getTransform(),l=this._context.opacity,f=this._context.snapToPixel,g=a.multiply(e);f&&(g.x=~~(g.x+pt),g.y=~~(g.y+pt));const m=this._buffer.bufferData;m[this._vertexIndex++]=g.x,m[this._vertexIndex++]=g.y,m[this._vertexIndex++]=s.r/255,m[this._vertexIndex++]=s.g/255,m[this._vertexIndex++]=s.b/255,m[this._vertexIndex++]=s.a*l,m[this._vertexIndex++]=r*Math.max(a.getScaleX(),a.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.POINTS,0,this._pointCount),Zt.DrawnImagesCount+=this._pointCount,Zt.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const Jg=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,Kg=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class $g{constructor(e){this._gl=e,this._shader=new ni({gl:e,vertexSource:Jg,fragmentSource:Kg}),this._shader.compile(),this._buffer=new qi({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new ms({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(e){const s=this._gl,r=e.getShader();r.use(),e.getLayout().use(),s.activeTexture(s.TEXTURE0),r.trySetUniformInt("u_image",0),e.onDraw&&e.onDraw(),s.drawArrays(s.TRIANGLES,0,6)}renderToScreen(){const e=this._gl;this._shader.use(),this._layout.use(),e.drawArrays(e.TRIANGLES,0,6)}}class xr{constructor(e,s,r){this._logger=at.getInstance(),this._gl=e,this.buffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer);const a=s*6;if(!r)this.bufferData=new Uint32Array(a);else{const g=Math.floor(16383.5);this.bufferGlType=e.UNSIGNED_SHORT,this.bufferData=new Uint16Array(a),s>g&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${g}) requested quads(${s})`)}let l=0;for(let f=0;f<a;f+=6)this.bufferData[f+0]=l+0,this.bufferData[f+1]=l+1,this.bufferData[f+2]=l+2,this.bufferData[f+3]=l+2,this.bufferData[f+4]=l+1,this.bufferData[f+5]=l+3,l+=4;e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const tp=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,ep=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class ip{constructor(e){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=Q.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=ja(e,r);this._maxTextures=Math.min(r,a);const l=this._transformFragmentSource(tp,this._maxTextures);this._shader=new ni({gl:e,fragmentSource:l,vertexSource:ep}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((f,g)=>g)),this._buffer=new qi({gl:e,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new ms({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new xr(e,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let r=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_textureIndex <= ${l}.5) {
`:a+=`   else if (v_textureIndex <= ${l}.5) {
`,a+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return r=r.replace("%%texture_picker%%",a),r}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(Ft.Filtering),r=s?zn(s):void 0,a=Fi(e.getAttribute(Ft.WrappingX)),l=Fi(e.getAttribute(Ft.WrappingY)),f=e.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);e.removeAttribute("forceUpload"),this._textures.indexOf(g)===-1&&(this._textures.push(g),this._textureToIndex.set(g,this._textureIndex++),this._images.add(e))}_bindTextures(e){for(let s=0;s<this._maxTextures;s++)e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_2D,this._textures[s]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const r=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(r))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,r,a,l,f,g,m,w){var A,y,E,D;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const L=this._getImageWidth(e),O=this._getImageHeight(e);let q=L||a||0,H=O||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(A=a??L)!==null&&A!==void 0?A:0,this._view[3]=(y=l??O)!==null&&y!==void 0?y:0,this._dest[0]=s??1,this._dest[1]=r??1,f!==void 0&&g!==void 0&&m!==void 0&&w!==void 0&&(this._view[0]=s??1,this._view[1]=r??1,this._view[2]=(E=a??L)!==null&&E!==void 0?E:0,this._view[3]=(D=l??O)!==null&&D!==void 0?D:0,this._dest[0]=f,this._dest[1]=g,q=m,H=w),s=this._view[0],r=this._view[1];const V=this._view[2],J=this._view[3],Y=this._context.getTransform(),$=this._context.opacity,ot=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+q,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+H,this._quad[6]=this._dest[0]+q,this._quad[7]=this._dest[1]+H,Y.multiplyQuadInPlace(this._quad),ot&&(this._quad[0]=~~(this._quad[0]+G(this._quad[0])*pt),this._quad[1]=~~(this._quad[1]+G(this._quad[1])*pt),this._quad[2]=~~(this._quad[2]+G(this._quad[2])*pt),this._quad[3]=~~(this._quad[3]+G(this._quad[3])*pt),this._quad[4]=~~(this._quad[4]+G(this._quad[4])*pt),this._quad[5]=~~(this._quad[5]+G(this._quad[5])*pt),this._quad[6]=~~(this._quad[6]+G(this._quad[6])*pt),this._quad[7]=~~(this._quad[7]+G(this._quad[7])*pt));const Z=this._context.tint||this._defaultTint,gt=this._getTextureIdForImage(e),It=L||q,Yt=O||H,Qt=(s+this.uvPadding)/It,Pe=(r+this.uvPadding)/Yt,te=(s+V-this.uvPadding)/It,Ht=(r+J-this.uvPadding)/Yt,Ne=L,Me=O,st=this._layout.vertexBuffer.bufferData;st[this._vertexIndex++]=this._quad[0],st[this._vertexIndex++]=this._quad[1],st[this._vertexIndex++]=$,st[this._vertexIndex++]=Ne,st[this._vertexIndex++]=Me,st[this._vertexIndex++]=Qt,st[this._vertexIndex++]=Pe,st[this._vertexIndex++]=gt,st[this._vertexIndex++]=Z.r/255,st[this._vertexIndex++]=Z.g/255,st[this._vertexIndex++]=Z.b/255,st[this._vertexIndex++]=Z.a,st[this._vertexIndex++]=this._quad[4],st[this._vertexIndex++]=this._quad[5],st[this._vertexIndex++]=$,st[this._vertexIndex++]=Ne,st[this._vertexIndex++]=Me,st[this._vertexIndex++]=Qt,st[this._vertexIndex++]=Ht,st[this._vertexIndex++]=gt,st[this._vertexIndex++]=Z.r/255,st[this._vertexIndex++]=Z.g/255,st[this._vertexIndex++]=Z.b/255,st[this._vertexIndex++]=Z.a,st[this._vertexIndex++]=this._quad[2],st[this._vertexIndex++]=this._quad[3],st[this._vertexIndex++]=$,st[this._vertexIndex++]=Ne,st[this._vertexIndex++]=Me,st[this._vertexIndex++]=te,st[this._vertexIndex++]=Pe,st[this._vertexIndex++]=gt,st[this._vertexIndex++]=Z.r/255,st[this._vertexIndex++]=Z.g/255,st[this._vertexIndex++]=Z.b/255,st[this._vertexIndex++]=Z.a,st[this._vertexIndex++]=this._quad[6],st[this._vertexIndex++]=this._quad[7],st[this._vertexIndex++]=$,st[this._vertexIndex++]=Ne,st[this._vertexIndex++]=Me,st[this._vertexIndex++]=te,st[this._vertexIndex++]=Ht,st[this._vertexIndex++]=gt,st[this._vertexIndex++]=Z.r/255,st[this._vertexIndex++]=Z.g/255,st[this._vertexIndex++]=Z.b/255,st[this._vertexIndex++]=Z.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),this._quads.bind(),e.drawElements(e.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),Zt.DrawnImagesCount+=this._imageCount,Zt.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const sp=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,np=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class rp{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=Q.Transparent,this._scratch1=z(0,0),this._scratch2=z(0,0),this._scratch3=z(0,0),this._scratch4=z(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new ni({gl:e,fragmentSource:sp,vertexSource:np}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new qi({gl:e,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new ms({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new xr(e,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...e){e[0]instanceof B&&e[1]instanceof B?this.drawLine.apply(this,e):this.drawRectangle.apply(this,e)}drawLine(e,s,r,a=1){this._isFull()&&this.flush(),this._rectangleCount++;const l=this._context.getTransform(),f=this._context.opacity,g=this._context.snapToPixel,m=s.sub(e),w=m.magnitude,A=m.normalize().perpendicular(),y=a/2,E=l.multiply(A.scale(y,this._scratch1).add(e,this._scratch1),this._scratch1),D=l.multiply(A.scale(-y,this._scratch2).add(e,this._scratch2),this._scratch2),L=l.multiply(A.scale(y,this._scratch3).add(s,this._scratch3),this._scratch3),O=l.multiply(A.scale(-y,this._scratch4).add(s,this._scratch4),this._scratch4);g&&(E.x=~~(E.x+pt),E.y=~~(E.y+pt),L.x=~~(L.x+pt),L.y=~~(L.y+pt),D.x=~~(D.x+pt),D.y=~~(D.y+pt),O.x=~~(O.x+pt),O.y=~~(O.y+pt));const q=0,H=0,V=1,J=1,Y=this._transparent,$=0,ot=1,Z=this._layout.vertexBuffer.bufferData;Z[this._vertexIndex++]=E.x,Z[this._vertexIndex++]=E.y,Z[this._vertexIndex++]=q,Z[this._vertexIndex++]=H,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=$/ot,Z[this._vertexIndex++]=D.x,Z[this._vertexIndex++]=D.y,Z[this._vertexIndex++]=q,Z[this._vertexIndex++]=J,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=$/ot,Z[this._vertexIndex++]=L.x,Z[this._vertexIndex++]=L.y,Z[this._vertexIndex++]=V,Z[this._vertexIndex++]=H,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=$/ot,Z[this._vertexIndex++]=O.x,Z[this._vertexIndex++]=O.y,Z[this._vertexIndex++]=V,Z[this._vertexIndex++]=J,Z[this._vertexIndex++]=w,Z[this._vertexIndex++]=a,Z[this._vertexIndex++]=f,Z[this._vertexIndex++]=r.r/255,Z[this._vertexIndex++]=r.g/255,Z[this._vertexIndex++]=r.b/255,Z[this._vertexIndex++]=r.a,Z[this._vertexIndex++]=Y.r/255,Z[this._vertexIndex++]=Y.g/255,Z[this._vertexIndex++]=Y.b/255,Z[this._vertexIndex++]=Y.a,Z[this._vertexIndex++]=$/ot}drawRectangle(e,s,r,a,l=Q.Transparent,f=0){this._isFull()&&this.flush(),this._rectangleCount++;const g=this._context.getTransform(),m=this._context.opacity,w=this._context.snapToPixel,A=g.multiply(e.add(z(0,0))),y=g.multiply(e.add(z(s,0))),E=g.multiply(e.add(z(s,r))),D=g.multiply(e.add(z(0,r)));w&&(A.x=~~(A.x+pt),A.y=~~(A.y+pt),y.x=~~(y.x+pt),y.y=~~(y.y+pt),D.x=~~(D.x+pt),D.y=~~(D.y+pt),E.x=~~(E.x+pt),E.y=~~(E.y+pt));const L=0,O=0,q=1,H=1,V=this._layout.vertexBuffer.bufferData;V[this._vertexIndex++]=A.x,V[this._vertexIndex++]=A.y,V[this._vertexIndex++]=L,V[this._vertexIndex++]=O,V[this._vertexIndex++]=s,V[this._vertexIndex++]=r,V[this._vertexIndex++]=m,V[this._vertexIndex++]=a.r/255,V[this._vertexIndex++]=a.g/255,V[this._vertexIndex++]=a.b/255,V[this._vertexIndex++]=a.a,V[this._vertexIndex++]=l.r/255,V[this._vertexIndex++]=l.g/255,V[this._vertexIndex++]=l.b/255,V[this._vertexIndex++]=l.a,V[this._vertexIndex++]=f,V[this._vertexIndex++]=D.x,V[this._vertexIndex++]=D.y,V[this._vertexIndex++]=L,V[this._vertexIndex++]=H,V[this._vertexIndex++]=s,V[this._vertexIndex++]=r,V[this._vertexIndex++]=m,V[this._vertexIndex++]=a.r/255,V[this._vertexIndex++]=a.g/255,V[this._vertexIndex++]=a.b/255,V[this._vertexIndex++]=a.a,V[this._vertexIndex++]=l.r/255,V[this._vertexIndex++]=l.g/255,V[this._vertexIndex++]=l.b/255,V[this._vertexIndex++]=l.a,V[this._vertexIndex++]=f,V[this._vertexIndex++]=y.x,V[this._vertexIndex++]=y.y,V[this._vertexIndex++]=q,V[this._vertexIndex++]=O,V[this._vertexIndex++]=s,V[this._vertexIndex++]=r,V[this._vertexIndex++]=m,V[this._vertexIndex++]=a.r/255,V[this._vertexIndex++]=a.g/255,V[this._vertexIndex++]=a.b/255,V[this._vertexIndex++]=a.a,V[this._vertexIndex++]=l.r/255,V[this._vertexIndex++]=l.g/255,V[this._vertexIndex++]=l.b/255,V[this._vertexIndex++]=l.a,V[this._vertexIndex++]=f,V[this._vertexIndex++]=E.x,V[this._vertexIndex++]=E.y,V[this._vertexIndex++]=q,V[this._vertexIndex++]=H,V[this._vertexIndex++]=s,V[this._vertexIndex++]=r,V[this._vertexIndex++]=m,V[this._vertexIndex++]=a.r/255,V[this._vertexIndex++]=a.g/255,V[this._vertexIndex++]=a.b/255,V[this._vertexIndex++]=a.a,V[this._vertexIndex++]=l.r/255,V[this._vertexIndex++]=l.g/255,V[this._vertexIndex++]=l.b/255,V[this._vertexIndex++]=l.a,V[this._vertexIndex++]=f}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),Zt.DrawnImagesCount+=this._rectangleCount,Zt.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const op=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,ap=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class hp{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new ni({gl:e,fragmentSource:op,vertexSource:ap}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new qi({gl:e,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new ms({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new xr(e,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(e,s,r,a=Q.Transparent,l=0){this._isFull()&&this.flush(),this._circleCount++;const f=this._context.getTransform(),g=this._context.opacity,m=this._context.snapToPixel,w=f.multiply(e.add(z(-s,-s))),A=f.multiply(e.add(z(s,-s))),y=f.multiply(e.add(z(s,s))),E=f.multiply(e.add(z(-s,s)));m&&(w.x=~~(w.x+pt),w.y=~~(w.y+pt),A.x=~~(A.x+pt),A.y=~~(A.y+pt),E.x=~~(E.x+pt),E.y=~~(E.y+pt),y.x=~~(y.x+pt),y.y=~~(y.y+pt));const D=0,L=0,O=1,q=1,H=this._layout.vertexBuffer.bufferData;H[this._vertexIndex++]=w.x,H[this._vertexIndex++]=w.y,H[this._vertexIndex++]=D,H[this._vertexIndex++]=L,H[this._vertexIndex++]=g,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=E.x,H[this._vertexIndex++]=E.y,H[this._vertexIndex++]=D,H[this._vertexIndex++]=q,H[this._vertexIndex++]=g,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=A.x,H[this._vertexIndex++]=A.y,H[this._vertexIndex++]=O,H[this._vertexIndex++]=L,H[this._vertexIndex++]=g,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s,H[this._vertexIndex++]=y.x,H[this._vertexIndex++]=y.y,H[this._vertexIndex++]=O,H[this._vertexIndex++]=q,H[this._vertexIndex++]=g,H[this._vertexIndex++]=r.r/255,H[this._vertexIndex++]=r.g/255,H[this._vertexIndex++]=r.b/255,H[this._vertexIndex++]=r.a,H[this._vertexIndex++]=a.r/255,H[this._vertexIndex++]=a.g/255,H[this._vertexIndex++]=a.b/255,H[this._vertexIndex++]=a.a,H[this._vertexIndex++]=l/s}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),Zt.DrawnImagesCount+=this._circleCount,Zt.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class So{constructor(e,s,r=100){this.builder=e,this.recycler=s,this.maxObjects=r,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=at.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let e=0;e<this.maxObjects;e++)this.objects[e]=this.builder()}using(e){const s=e(this);return s?this.done(...s):this.done()}borrow(e){const s=this.get();e(s),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...e){this.index=0;for(const s of e){const r=this.objects.indexOf(s);this.objects[r]=this.builder(),this.totalAllocations++}return e}}class lp{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=fe.identity(),this.state={z:0,opacity:1,tint:Q.White,material:null},this.args=new Array(10)}}const cp=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class fd{constructor(e){this._logger=at.getInstance(),this._color=Q.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:s,name:r,vertexSource:a,fragmentSource:l,graphicsContext:f,images:g}=e;if(this._name=r??"anonymous material",this._vertexSource=a??cp,this._fragmentSource=l,this._color=s??this._color,!f)throw Error(`Material ${r} must be provided an excalibur webgl graphics context`);if(f instanceof ws?(this._graphicsContext=f,this._initialize(f)):this._logger.warn(`Material ${r} was created in 2D Canvas mode, currently only WebGL is supported`),g)for(const m in g)this.addImageSource(m,g[m])}_initialize(e){if(this._initialized)return;const s=e.__gl;this._maxTextureSlots=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=e.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(e){this._color=e}get name(){var e;return(e=this._name)!==null&&e!==void 0?e:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(e){this._shader&&(this._shader.use(),e(this._shader))}getShader(){return this._shader}addImageSource(e,s){this._images.size<this._maxTextureSlots?this._images.set(e,s):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(e){const s=this._images.get(e);this._graphicsContext.textureLoader.delete(s.image),this._images.delete(e)}_loadImageSource(e){const s=e.image,r=s.getAttribute(Ft.Filtering),a=r?zn(r):void 0,l=Fi(s.getAttribute(Ft.WrappingX)),f=Fi(s.getAttribute(Ft.WrappingY)),g=s.getAttribute("forceUpload")==="true",m=this._graphicsContext.textureLoader.load(s,{filtering:a,wrapping:{x:l,y:f}},g);return s.removeAttribute("forceUpload"),this._textures.has(e)||this._textures.set(e,m),m}uploadAndBind(e,s=2){let r=s;for(const[a,l]of this._images.entries()){if(!l.isLoaded()){this._logger.warnOnce(`Image named ${a} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const f=this._loadImageSource(l);e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,f),this._shader.trySetUniformInt(a,r),r++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class _d{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(e,s){this._gl=e,this._context=s,this._buffer=new qi({gl:e,size:6*4,type:"dynamic"}),this._layout=new ms({gl:e,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new xr(e,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(e,s,r,a,l,f,g,m,w){var A,y,E,D;const L=this._gl,O=this._context.material;if(!O)return;const q=this._context.getTransform(),H=this._context.opacity,V=O.getShader(),J=this._layout.vertexBuffer.bufferData;let Y=0,$=e?.width||a||0,ot=e?.height||l||0,Z=[0,0,(A=a??e?.width)!==null&&A!==void 0?A:0,(y=l??e?.height)!==null&&y!==void 0?y:0],gt=[s??1,r??1];f!==void 0&&g!==void 0&&m!==void 0&&w!==void 0&&(Z=[s??1,r??1,(E=a??e?.width)!==null&&E!==void 0?E:0,(D=l??e?.height)!==null&&D!==void 0?D:0],gt=[f,g],$=m,ot=w),s=Z[0],r=Z[1];const It=Z[2],Yt=Z[3],Qt=z(gt[0],gt[1]),Pe=z(gt[0]+$,gt[1]),te=z(gt[0],gt[1]+ot),Ht=z(gt[0]+$,gt[1]+ot),Ne=e.width||$,Me=e.height||ot,st=s/Ne,gn=r/Me,pn=(s+It-.01)/Ne,mn=(r+Yt-.01)/Me,Jn=q.getPosition(),Gu=Jn.add(Ht),Xu=Jn.x/this._context.width,qu=Jn.y/this._context.height,Yu=Gu.x/this._context.width,ju=Gu.y/this._context.height;J[Y++]=Qt.x,J[Y++]=Qt.y,J[Y++]=st,J[Y++]=gn,J[Y++]=Xu,J[Y++]=qu,J[Y++]=te.x,J[Y++]=te.y,J[Y++]=st,J[Y++]=mn,J[Y++]=Xu,J[Y++]=ju,J[Y++]=Pe.x,J[Y++]=Pe.y,J[Y++]=pn,J[Y++]=gn,J[Y++]=Yu,J[Y++]=qu,J[Y++]=Ht.x,J[Y++]=Ht.y,J[Y++]=pn,J[Y++]=mn,J[Y++]=Yu,J[Y++]=ju;const Fm=this._addImageAsTexture(e);O.use(),this._layout.shader=V,this._layout.use(!0),V.trySetUniformFloat("u_time_ms",performance.now()),V.trySetUniformFloat("u_opacity",H),V.trySetUniformFloatVector("u_resolution",z(this._context.width,this._context.height)),V.trySetUniformFloatVector("u_graphic_resolution",z(Ne,Me)),V.trySetUniformFloatVector("u_size",z(It,Yt)),V.trySetUniformMatrix("u_matrix",this._context.ortho),V.trySetUniformMatrix("u_transform",q.to4x4()),L.activeTexture(L.TEXTURE0+0),L.bindTexture(L.TEXTURE_2D,Fm),V.trySetUniformInt("u_graphic",0),L.activeTexture(L.TEXTURE0+1),L.bindTexture(L.TEXTURE_2D,this._context.materialScreenTexture),V.trySetUniformInt("u_screen_texture",1),O.uploadAndBind(L),this._quads.bind(),L.drawElements(L.TRIANGLES,6,this._quads.bufferGlType,0),Zt.DrawnImagesCount++,Zt.DrawCallCount++}_addImageAsTexture(e){const s=e.getAttribute(Ft.Filtering),r=s?zn(s):void 0,a=Fi(e.getAttribute(Ft.WrappingX)),l=Fi(e.getAttribute(Ft.WrappingY)),f=e.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);return e.removeAttribute("forceUpload"),this._textures.indexOf(g)===-1&&this._textures.push(g),g}hasPendingDraws(){return!1}flush(){}}const dp=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,up=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var De;(function(u){u.World="world",u.Screen="screen"})(De||(De={}));class Za extends B{constructor(e){super(0,0),this._getX=e.getX,this._getY=e.getY,this._setX=e.setX,this._setY=e.setY}get x(){return this._x=this._getX()}set x(e){this._setX(e),this._x=e}get y(){return this._y=this._getY()}set y(e){this._setY(e),this._y=e}}class Hs extends B{constructor(e,s){super(e.x,e.y),this.original=e,this.change=s}get x(){return this._x=this.original.x}set x(e){e!==this._x&&(this.change(e,this._y),this._x=this.original.x=e)}get y(){return this._y=this.original.y}set y(e){e!==this._y&&(this.change(this._x,e),this._y=this.original.y=e)}setTo(e,s){this.x=e,this.y=s}}class vs{constructor(){this._parent=null,this._children=[],this._pos=new Hs(z(0,0),()=>{this.flagDirty()}),this._globalPos=new Za({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:e=>{if(this.parent){const{x:s}=this.parent.inverse.multiply(z(e,this.pos.y));this.pos.x=s}else this.pos.x=e;e!==this.matrix.data[4]&&this.flagDirty()},setY:e=>{if(this.parent){const{y:s}=this.parent.inverse.multiply(z(this.pos.x,e));this.pos.y=s}else this.pos.y=e;e!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new Hs(z(1,1),()=>{this.flagDirty()}),this._globalScale=new Za({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:e=>{if(this.parent){const s=this.parent.globalScale.x;this.scale.x=e/s}else this.scale.x=e},setY:e=>{if(this.parent){const s=this.parent.globalScale.y;this.scale.y=e/s}else this.scale.y=e}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=fe.identity(),this._inverse=fe.identity(),this._scratch=fe.identity()}get parent(){return this._parent}set parent(e){if(this._parent){const s=this._parent._children.indexOf(this);s>-1&&this._parent._children.splice(s,1)}this._parent=e,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(e){this._pos.x=e.x,this._pos.y=e.y}get pos(){return this._pos}set globalPos(e){let s=e.clone();this.parent&&(s=this.parent.inverse.multiply(e)),s.equals(this._pos)||(this._pos=s,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(e){const s=rt(e);s!==this._rotation&&this.flagDirty(),this._rotation=s}get rotation(){return this._rotation}set globalRotation(e){let s=0;this.parent&&(s=this.parent.globalRotation);const r=rt(e+s);r!==this._rotation&&this.flagDirty(),this._rotation=r}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(e){this._scale.x=e.x,this._scale.y=e.y}get scale(){return this._scale}set globalScale(e){let s=z(1,1);this.parent&&(s=this.parent.globalScale),this.scale=e.scale(z(1/s.x,1/s.y))}get globalScale(){return this._globalScale}set z(e){this._z=e,this.flagDirty()}get z(){return this._z}set globalZ(e){this.parent?this.z=e-this.parent.globalZ:this.z=e}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let e=0;e<this._children.length;e++)this._children[e].flagDirty()}apply(e){return this.matrix.multiply(e)}applyInverse(e){return this.inverse.multiply(e)}setTransform(e,s,r){this._pos.x=e.x,this._pos.y=e.y,this._rotation=rt(s),this._scale.x=r.x,this._scale.y=r.y,this.flagDirty()}isMirrored(){const e=G(this.scale.x)>>>31,s=G(this.scale.y)>>>31;return!!(e^s)}clone(e){const s=e??new vs;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.flagDirty(),s}cloneWithParent(e){const s=e??new vs;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.parent=this.parent,s.flagDirty(),s}toString(){return this.matrix.toString()}}function gd(u){return!!u&&!!u.prototype&&!!u.prototype.constructor}function fp(u){return!!u?.clone}class Si{constructor(){this.owner=void 0}clone(){const e=new this.constructor;for(const s in this)if(this.hasOwnProperty(s)){const r=this[s];fp(r)&&s!=="owner"&&s!=="clone"?e[s]=r.clone():e[s]=r}return e}}class je{constructor(){this.observers=[],this.subscriptions=[]}register(e){this.observers.push(e)}subscribe(e){this.subscriptions.push(e)}unregister(e){const s=this.observers.indexOf(e);s!==-1&&this.observers.splice(s,1)}unsubscribe(e){const s=this.subscriptions.indexOf(e);s!==-1&&this.subscriptions.splice(s,1)}notifyAll(e){const s=this.observers.length;for(let a=0;a<s;a++)this.observers[a].notify(e);const r=this.subscriptions.length;for(let a=0;a<r;a++)this.subscriptions[a](e)}clear(){this.observers.length=0,this.subscriptions.length=0}}class it extends Si{constructor(){super(...arguments),this._logger=at.getInstance(),this._parentComponent=null,this._transform=new vs,this._addChildTransform=e=>{const s=e.get(it);s&&(s._transform.parent=this._transform,s._parentComponent=this)},this.zIndexChanged$=new je,this._coordPlane=De.World}get(){return this._transform}onAdd(e){for(const s of e.children)this._addChildTransform(s);e.childrenAdded$.subscribe(s=>this._addChildTransform(s)),e.childrenRemoved$.subscribe(s=>{const r=s.get(it);r&&(r._transform.parent=null,r._parentComponent=null)})}onRemove(e){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(e){const s=this._transform.z;this._transform.z=e,s!==e&&this.zIndexChanged$.notifyAll(e)}get globalZ(){return this._transform.globalZ}set globalZ(e){this._transform.globalZ=e}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(e){var s;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(s=this.owner)===null||s===void 0?void 0:s.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=e}get pos(){return this._transform.pos}set pos(e){this._transform.pos=e}get globalPos(){return this._transform.globalPos}set globalPos(e){this._transform.globalPos=e}get rotation(){return this._transform.rotation}set rotation(e){this._transform.rotation=e}get globalRotation(){return this._transform.globalRotation}set globalRotation(e){this._transform.globalRotation=e}get scale(){return this._transform.scale}set scale(e){this._transform.scale=e}get globalScale(){return this._transform.globalScale}set globalScale(e){this._transform.globalScale=e}applyInverse(e){return this._transform.applyInverse(e)}apply(e){return this._transform.apply(e)}clone(){const e=new it;return e._transform=this._transform.clone(),e}}var br;(function(u){u.Forward="forward",u.Backward="backward"})(br||(br={}));var Mi;(function(u){u.End="end",u.Loop="loop",u.PingPong="pingpong",u.Freeze="freeze"})(Mi||(Mi={}));const _p={Frame:"frame",Loop:"loop",End:"end"};class Bi extends ie{constructor(e){var s,r,a;super(e),this.events=new I,this.frames=[],this.strategy=Mi.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=e.frames,this.speed=(s=e.speed)!==null&&s!==void 0?s:this.speed,this.strategy=(r=e.strategy)!==null&&r!==void 0?r:this.strategy,this.frameDuration=e.totalDuration?e.totalDuration/this.frames.length:(a=e.frameDuration)!==null&&a!==void 0?a:this.frameDuration,e.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new Bi({frames:this.frames.map(e=>({...e})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.width*this.scale.x):0}get height(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.height*this.scale.y):0}static fromSpriteSheet(e,s,r,a=Mi.Loop){const l=e.sprites.length-1,f=s.filter(g=>g<0||g>l);return f.length&&Bi._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${f.join(",")} no frame will be shown`),new Bi({frames:e.sprites.filter((g,m)=>s.indexOf(m)>-1).map(g=>({graphic:g,duration:r})),strategy:a})}static fromSpriteSheetCoordinates(e){var s;const{spriteSheet:r,frameCoordinates:a,durationPerFrame:l,durationPerFrameMs:f,speed:g,strategy:m,reverse:w}=e,A=(s=l??f)!==null&&s!==void 0?s:100,y=[];for(const E of a){const{x:D,y:L,duration:O,options:q}=E,H=r.getSprite(D,L,q);H?y.push({graphic:H,duration:O??A}):Bi._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${D}, ${L}), please check your SpriteSheet to confirm that sprite exists`)}return new Bi({frames:y,strategy:m,speed:g,reverse:w})}get speed(){return this._speed}set speed(e){this._speed=j(Math.abs(e),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?br.Backward:br.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const e=this.frames[this._currentFrame];e&&(this._timeLeftInFrame=e?.duration||this.frameDuration)}get canFinish(){switch(this.strategy){case Mi.End:case Mi.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(e,s){this._currentFrame=e,this._timeLeftInFrame=s??this.frameDuration;const r=this.frames[this._currentFrame];r&&!this._done&&(this._timeLeftInFrame=s??(r?.duration||this.frameDuration),this.events.emit("frame",{...r,frameIndex:this.currentFrameIndex}))}_nextFrame(){const e=this._currentFrame;if(this._done)return e;let s=-1;switch(this.strategy){case Mi.Loop:{s=(e+1)%this.frames.length,s===0&&this.events.emit("loop",this);break}case Mi.End:{s=e+1,s>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case Mi.Freeze:{s=j(e+1,0,this.frames.length-1),s>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case Mi.PingPong:{e+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),e+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),s=e+this._pingPongDirection%this.frames.length;break}}return s}tick(e,s=0){this._idempotencyToken!==s&&(this._idempotencyToken=s,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=e*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(e,s,r){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(e,s,r)}}Bi._LOGGER=at.getInstance();class Hn extends ie{constructor(e){var s;super(e),this._logger=at.getInstance(),this.useAnchor=!0,this.members=[],this.members=e.members,this.useAnchor=(s=e.useAnchor)!==null&&s!==void 0?s:this.useAnchor,this._updateDimensions()}clone(){return new Hn({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const e=this.localBounds;return this.width=e.width,this.height=e.height,e}get localBounds(){const e=new ht;for(const s of this.members)if(s instanceof ie)s.localBounds.combine(e,e);else{const{graphic:r,offset:a,useBounds:l}=s;r?(l===void 0?!0:l)&&r.localBounds.translate(a).combine(e,e):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(s)}.`)}return e}_isAnimationOrGroup(e){return e instanceof Bi||e instanceof Hn}tick(e,s){for(const r of this.members){let a;r instanceof ie?a=r:a=r.graphic,this._isAnimationOrGroup(a)&&a.tick(e,s)}}reset(){for(const e of this.members){let s;e instanceof ie?s=e:s=e.graphic,this._isAnimationOrGroup(s)&&s.reset()}}_preDraw(e,s,r){this._updateDimensions(),super._preDraw(e,this.useAnchor?s:0,this.useAnchor?r:0)}_drawImage(e,s,r){const a=B.Zero;for(const l of this.members){let f;l instanceof ie?f=l:(f=l.graphic,l.offset.clone(a)),f&&(e.save(),e.translate(s,r),f.draw(e,a.x,a.y),this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore())}}}class On extends ie{constructor(e){var s,r,a,l,f,g,m,w,A,y;super(od({...e},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=Ri(Q.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,e&&(this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this.color=(r=e.color)!==null&&r!==void 0?r:Q.Black,this.strokeColor=e?.strokeColor,this.smoothing=(a=e.smoothing)!==null&&a!==void 0?a:this.smoothing,this.lineWidth=(l=e.lineWidth)!==null&&l!==void 0?l:this.lineWidth,this.lineDash=(f=e.lineDash)!==null&&f!==void 0?f:this.lineDash,this.lineCap=(g=e.lineCap)!==null&&g!==void 0?g:this.lineCap,this.padding=(m=e.padding)!==null&&m!==void 0?m:this.padding,this.filtering=(w=e.filtering)!==null&&w!==void 0?w:this.filtering),this._bitmap=document.createElement("canvas");const E=(A=e?.width)!==null&&A!==void 0?A:this._bitmap.width,D=(y=e?.height)!==null&&y!==void 0?y:this._bitmap.height;this.width=E,this.height=D;const L=this._bitmap.getContext("2d");if(L)this._ctx=L;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(e){e/=Math.abs(this.scale.x),this._bitmap.width=e,this._originalWidth=e,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(e){e/=Math.abs(this.scale.y),this._bitmap.height=e,this._originalHeight=e,this.flagDirty()}_getTotalWidth(){var e;return(((e=this._originalWidth)!==null&&e!==void 0?e:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var e;return(((e=this._originalHeight)!==null&&e!==void 0?e:this._bitmap.height)+this.padding*2)*1}get localBounds(){return ht.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,B.Zero)}get smoothing(){return this._smoothing}set smoothing(e){this._smoothing=e,this.flagDirty()}get color(){return this._color}set color(e){this.flagDirty(),this._color=Ri(e,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(e){this.flagDirty(),e&&(this._strokeColor=Ri(e,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(e){this._lineDash=e,this.flagDirty()}get padding(){return this._padding}set padding(e){this._padding=e,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(e){var s,r,a,l;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),e.scale(this.quality,this.quality),e.translate(this.padding,this.padding),e.imageSmoothingEnabled=this.smoothing,e.lineWidth=this.lineWidth,e.setLineDash((s=this.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.lineCap=this.lineCap,e.strokeStyle=(a=(r=this.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&a!==void 0?a:"",e.fillStyle=(l=this.color)===null||l===void 0?void 0:l.toString()}_drawImage(e,s,r){this._dirty&&this.rasterize(),e.scale(1/this.quality,1/this.quality),e.drawImage(this._bitmap,s,r)}}var Po;(function(u){u.Em="em",u.Rem="rem",u.Px="px",u.Pt="pt",u.Percent="%"})(Po||(Po={}));var To;(function(u){u.Left="left",u.Right="right",u.Center="center",u.Start="start",u.End="end"})(To||(To={}));var Eo;(function(u){u.Top="top",u.Hanging="hanging",u.Middle="middle",u.Alphabetic="alphabetic",u.Ideographic="ideographic",u.Bottom="bottom"})(Eo||(Eo={}));var Io;(function(u){u.Normal="normal",u.Italic="italic",u.Oblique="oblique"})(Io||(Io={}));var Ro;(function(u){u.LeftToRight="ltr",u.RightToLeft="rtl"})(Ro||(Ro={}));function Qa(u,e=Q.Red,s,r,a,l,f=1,g="butt"){u.save(),u.beginPath(),u.lineWidth=f,u.lineCap=g,u.strokeStyle=e.toString(),u.moveTo(s,r),u.lineTo(a,l),u.closePath(),u.stroke(),u.restore()}function gp(u,e=Q.Red,s){u.beginPath(),u.strokeStyle=e.toString(),u.arc(s.x,s.y,5,0,Math.PI*2),u.closePath(),u.stroke()}function pp(u,e,s,r,a=1){const l=e?e.toString():"blue",f=r.scale(a);u.beginPath(),u.strokeStyle=l,u.moveTo(s.x,s.y),u.lineTo(s.x+f.x,s.y+f.y),u.closePath(),u.stroke()}function Ja(u,e,s,r,a,l=5,f=Q.White,g=null){let m;if(typeof l=="number")m={tl:l,tr:l,br:l,bl:l};else{const w={tl:0,tr:0,br:0,bl:0};for(const A in w)if(w.hasOwnProperty(A)){const y=A;m[y]=l[y]||w[y]}}u.beginPath(),u.moveTo(e+m.tl,s),u.lineTo(e+r-m.tr,s),u.quadraticCurveTo(e+r,s,e+r,s+m.tr),u.lineTo(e+r,s+a-m.br),u.quadraticCurveTo(e+r,s+a,e+r-m.br,s+a),u.lineTo(e+m.bl,s+a),u.quadraticCurveTo(e,s+a,e,s+a-m.bl),u.lineTo(e,s+m.tl),u.quadraticCurveTo(e,s,e+m.tl,s),u.closePath(),g&&(u.fillStyle=g.toString(),u.fill()),f&&(u.strokeStyle=f.toString(),u.stroke())}function mp(u,e,s,r,a=Q.White,l=null){u.beginPath(),u.arc(e,s,r,0,Math.PI*2),u.closePath(),l&&(u.fillStyle=l.toString(),u.fill()),a&&(u.strokeStyle=a.toString(),u.stroke())}class Wn{constructor(e,s,r,a){this.font=e,this.text=s,this.color=r,this.maxWidth=a,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const l=this.canvas.getContext("2d");if(!l)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=l,this.dimensions=this.measureText(s),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(e,s){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let r=null;s!=null?r=this._getLinesFromText(e,s):r=e.split(`
`);const a=r.reduce((E,D)=>E.length>D.length?E:D);this._applyFont(this.ctx);const l=this.ctx.measureText(a);let f=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);const g=f*r.length;f=g;const m=g-Math.abs(l.actualBoundingBoxAscent),w=0,A=0;return new ht({left:w-Math.abs(l.actualBoundingBoxLeft)-this.font.padding,top:A-Math.abs(l.actualBoundingBoxAscent)-this.font.padding,bottom:A+m+this.font.padding,right:w+Math.abs(l.actualBoundingBoxRight)+this.font.padding})}_setDimension(e,s){let r=1;this.font.lineHeight&&(r=this.font.lineHeight/this.font.size),s.canvas.width=(e.width+this.font.padding*2)*2*this.font.quality,s.canvas.height=(e.height+this.font.padding*2)*2*this.font.quality*r}static getHashCode(e,s,r){var a;return s+"__hashcode__"+e.fontString+e.showDebug+e.textAlign+e.baseAlign+e.direction+e.lineHeight+JSON.stringify(e.shadow)+(e.padding.toString()+e.smoothing.toString()+e.lineWidth.toString()+e.lineDash.toString()+((a=e.strokeColor)===null||a===void 0?void 0:a.toString())+(r?r.toString():e.color.toString()))}getHashCode(e=!0){return Wn.getHashCode(this.font,this.text,e?this.color:void 0)}_applyRasterProperties(e){var s,r,a;e.translate(this.font.padding,this.font.padding),e.imageSmoothingEnabled=this.font.smoothing,e.lineWidth=this.font.lineWidth,e.setLineDash((s=this.font.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.strokeStyle=(a=(r=this.font.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&a!==void 0?a:"",e.fillStyle=this.color.toString()}_applyFont(e){e.resetTransform(),e.translate(this.font.padding+e.canvas.width/2,this.font.padding+e.canvas.height/2),e.scale(this.font.quality,this.font.quality),e.textAlign=this.font.textAlign,e.textBaseline=this.font.baseAlign,e.font=this.font.fontString,e.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(e.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(e.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(e.shadowOffsetX=this.font.shadow.offset.x,e.shadowOffsetY=this.font.shadow.offset.y))}_drawText(e,s,r){this._applyRasterProperties(e),this._applyFont(e);for(let a=0;a<s.length;a++){const l=s[a];this.color&&e.fillText(l,0,a*r),this.font.strokeColor&&e.strokeText(l,0,a*r)}this.font.showDebug&&(Qa(e,Q.Green,-e.canvas.width/2,0,e.canvas.width/2,0,2),Qa(e,Q.Red,0,-e.canvas.height/2,0,e.canvas.height/2,2))}_splitTextBitmap(e){const s=[];let r=0,a=0;const l=Math.min(4096,e.canvas.width),f=Math.min(4096,e.canvas.height);for(;r<e.canvas.width;){for(;a<e.canvas.height;){const g=document.createElement("canvas");g.width=l,g.height=f;const m=g.getContext("2d");if(!m)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");m.drawImage(e.canvas,r,a,l,f,0,0,l,f),s.push({x:r,y:a,canvas:g}),a+=f}r+=l,a=0}return s}flagDirty(){this._dirty=!0}render(e,s,r,a){var l;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=e;const f=this.getHashCode();if(this._lastHashCode!==f&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,a),this._setDimension(this.dimensions,this.ctx);const g=this._getLinesFromText(this.text,a),m=(l=this.font.lineHeight)!==null&&l!==void 0?l:this.dimensions.height/g.length;if(this._drawText(this.ctx,g,m),e instanceof ws)for(const w of this._textFragments)e.textureLoader.delete(w.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),e instanceof ws)for(const w of this._textFragments)e.textureLoader.load(w.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=f,this._dirty=!1}for(const g of this._textFragments)e.drawImage(g.canvas,0,0,g.canvas.width,g.canvas.height,g.x/this.font.quality+s-this.ctx.canvas.width/this.font.quality/2,g.y/this.font.quality+r-this.ctx.canvas.height/this.font.quality/2,g.canvas.width/this.font.quality,g.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof ws)for(const e of this._textFragments)this._ex.textureLoader.delete(e.canvas);this._textFragments.length=0}_getLinesFromText(e,s){var r;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let f=a[l],g="";if(this.measureText(f).width>s){for(;this.measureText(f).width>s;)g=f[f.length-1]+g,f=f.slice(0,-1);a[l]=f,a[l+1]=g}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class Ut{static measureText(e,s,r){const a=Wn.getHashCode(s,e);if(Ut._MEASURE_CACHE.has(a))return Ut._MEASURE_CACHE.get(a);Ut._LOGGER.debug("Font text measurement cache miss");const l=s.measureTextWithoutCache(e,r);return Ut._MEASURE_CACHE.set(a,l),l}static getTextInstance(e,s,r){const a=Wn.getHashCode(s,e,r);let l=Ut._TEXT_CACHE.get(a);return l||(l=new Wn(s,e,r),Ut._TEXT_CACHE.set(a,l),Ut._LOGGER.debug("Font text instance cache miss")),Ut._TEXT_USAGE.set(l,performance.now()),l}static checkAndClearCache(){const e=[],s=new Set;for(const[a,l]of Ut._TEXT_USAGE.entries())if(l+Ut.FONT_TIMEOUT<performance.now())Ut._LOGGER.debug(`Text cache entry timed out ${a.text}`),e.push(a),a.dispose();else{const f=a.getHashCode(!1);s.add(f)}e.forEach(a=>{Ut._TEXT_USAGE.delete(a)}),this._TEXT_CACHE.clear();for(const[a]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(a.getHashCode(),a);const r=new Map;for(const a of s)Ut._MEASURE_CACHE.has(a)&&r.set(a,Ut._MEASURE_CACHE.get(a));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=r}static get cacheSize(){return Ut._TEXT_USAGE.size}static clearCache(){for(const[e]of Ut._TEXT_USAGE.entries())e.dispose();Ut._TEXT_USAGE.clear(),Ut._TEXT_CACHE.clear(),Ut._MEASURE_CACHE.clear()}}Ut.FONT_TIMEOUT=500,Ut._LOGGER=at.getInstance(),Ut._TEXT_USAGE=new Map,Ut._TEXT_CACHE=new Map,Ut._MEASURE_CACHE=new Map;class rn extends ie{constructor(e={}){var s,r,a,l,f,g,m,w,A,y,E,D,L,O,q,H,V,J,Y,$;super(e),this.filtering=_e.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=Q.Black,this.family="sans-serif",this.style=Io.Normal,this.bold=!1,this.unit=Po.Px,this.textAlign=To.Left,this.baseAlign=Eo.Top,this.direction=Ro.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new ht,this._textMeasurement=new Wn(this,"",Q.Black),this.smoothing=(s=e?.smoothing)!==null&&s!==void 0?s:this.smoothing,this.padding=(r=e?.padding)!==null&&r!==void 0?r:this.padding,this.color=(a=e?.color)!==null&&a!==void 0?a:this.color,this.strokeColor=(l=e?.strokeColor)!==null&&l!==void 0?l:this.strokeColor,this.lineDash=(f=e?.lineDash)!==null&&f!==void 0?f:this.lineDash,this.lineWidth=(g=e?.lineWidth)!==null&&g!==void 0?g:this.lineWidth,this.filtering=(m=e?.filtering)!==null&&m!==void 0?m:this.filtering,this.family=(w=e?.family)!==null&&w!==void 0?w:this.family,this.style=(A=e?.style)!==null&&A!==void 0?A:this.style,this.bold=(y=e?.bold)!==null&&y!==void 0?y:this.bold,this.size=(E=e?.size)!==null&&E!==void 0?E:this.size,this.unit=(D=e?.unit)!==null&&D!==void 0?D:this.unit,this.textAlign=(L=e?.textAlign)!==null&&L!==void 0?L:this.textAlign,this.baseAlign=(O=e?.baseAlign)!==null&&O!==void 0?O:this.baseAlign,this.direction=(q=e?.direction)!==null&&q!==void 0?q:this.direction,this.lineHeight=(H=e?.lineHeight)!==null&&H!==void 0?H:this.lineHeight,this.quality=(V=e?.quality)!==null&&V!==void 0?V:this.quality,e?.shadow&&(this.shadow={},this.shadow.blur=(J=e.shadow.blur)!==null&&J!==void 0?J:this.shadow.blur,this.shadow.offset=(Y=e.shadow.offset)!==null&&Y!==void 0?Y:this.shadow.offset,this.shadow.color=($=e.shadow.color)!==null&&$!==void 0?$:this.shadow.color)}clone(){return new rn({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(e,s,r){}_rotate(e){var s;const r=(s=this.origin)!==null&&s!==void 0?s:this._textBounds.center;e.translate(r.x,r.y),e.rotate(this.rotation),e.translate(-r.x,-r.y)}_flip(e){this.flipHorizontal&&(e.translate(this._textBounds.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,-this._textBounds.height/2/this.scale.y),e.scale(1,-1))}measureTextWithoutCache(e,s){return this._textMeasurement.measureText(e,s)}measureText(e,s){return Ut.measureText(e,this,s)}_postDraw(e){e.restore()}render(e,s,r,a,l,f){const g=Ut.getTextInstance(s,this,r);this._textBounds=g.dimensions,this._preDraw(e,a,l),g.render(e,a,l,f),this._postDraw(e)}}class Ar extends ie{constructor(e){var s,r;super(e),this._text="",this._textWidth=0,this._textHeight=0,this.font=(s=e.font)!==null&&s!==void 0?s:new rn,this.color=(r=e.color)!==null&&r!==void 0?r:this.color,this.text=e.text,this.maxWidth=e.maxWidth}clone(){var e,s;return new Ar({text:this.text.slice(),color:(s=(e=this.color)===null||e===void 0?void 0:e.clone())!==null&&s!==void 0?s:Q.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(e){this._text=e,this._calculateDimension()}get font(){return this._font}set font(e){this._font=e}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:e,height:s}=this.font.measureText(this._text,this.maxWidth);this._textWidth=e,this._textHeight=s}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(e){}_flip(e){}_preDraw(e,s,r){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(e,s,r)}_drawImage(e,s,r){var a;let l=Q.Black;this.font instanceof rn&&(l=(a=this.color)!==null&&a!==void 0?a:this.font.color);const{width:f,height:g}=this.font.measureText(this._text,this.maxWidth);this._textWidth=f,this._textHeight=g,this.font.render(e,this._text,l,s,r,this.maxWidth),this.font.showDebug&&(e.debug.drawRect(s-f,r-g,f*2,g*2),this.maxWidth!=null&&e.debug.drawRect(s,r,this.maxWidth,this.height,{color:Q.Yellow}))}}function Ka(u){return!!u.tick}class ne extends Si{get visible(){return this.isVisible}set visible(e){this.isVisible=e}get offset(){return this._offset}set offset(e){this._offset=new Hs(e,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(e){this._anchor=new Hs(e,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(e){if(e){this._color=e.clone();const s=this.graphics.current;(s instanceof On||s instanceof Ar)&&(s.color=this._color)}}constructor(e){super(),this._logger=at.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new Hs(B.Zero,()=>this.recalculateBounds()),this._anchor=new Hs(B.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,e={visible:this.isVisible,graphics:{},...e};const{current:s,anchor:r,color:a,opacity:l,visible:f,graphics:g,offset:m,copyGraphics:w,onPreDraw:A,onPostDraw:y,onPreTransformDraw:E,onPostTransformDraw:D}=e;for(const[L,O]of Object.entries(g))O instanceof ie?this._graphics[L]=O:(this._graphics[L]=O.graphic,this._options[L]=O.options);this.offset=m??this.offset,this.opacity=l??this.opacity,this.anchor=r??this.anchor,this.color=a??this.color,this.copyGraphics=w??this.copyGraphics,this.onPreDraw=A??this.onPreDraw,this.onPostDraw=y??this.onPostDraw,this.onPreDraw=E??this.onPreTransformDraw,this.onPostTransformDraw=D??this.onPostTransformDraw,this.isVisible=!!f,this._current=s??this._current,s&&this._graphics[s]&&this.use(s)}getGraphic(e){return this._graphics[e]}getOptions(e){return this._options[e]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(e,s,r){let a="default",l=null,f;if(typeof e=="string"&&s instanceof ie&&(a=e,l=s,f=r),e instanceof ie&&!(s instanceof ie)&&(l=e,f=s),!l)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[a]=this.copyGraphics?l.clone():l,this._options[a]=this.copyGraphics?{...f}:f,a==="default"&&this.use("default"),l}remove(e){delete this._graphics[e],delete this._options[e],this._current===e&&(this._current="default",this.recalculateBounds())}use(e,s){var r;if(e instanceof ie){let a=e;this.copyGraphics&&(a=e.clone()),this._current="default",this._graphics[this._current]=a,this._options[this._current]=s}else this._current=e,this._options[this._current]=s,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(r=this.owner)===null||r===void 0?void 0:r.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(e){this._localBounds=e}recalculateBounds(){let e=new ht;const s=this._graphics[this._current],r=this._options[this._current];if(!s){this._localBounds=e;return}let a=this.anchor,l=this.offset;r?.anchor&&(a=r.anchor),r?.offset&&(l=r.offset);const f=s.localBounds,g=-f.width*a.x+l.x,m=-f.height*a.y+l.y;s instanceof Hn&&!s.useAnchor?e=s?.localBounds.combine(e):e=s?.localBounds.translate(z(g,m)).combine(e),this._localBounds=e}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let e=this.localBounds;if(this.owner){const s=this.owner.get(it);s&&(e=e.transform(s.get().matrix))}return e}update(e,s=0){const r=this.current;r&&Ka(r)&&r.tick(e,s)}clone(){const e=new ne;return e._graphics={...this._graphics},e._options={...this._options},e.offset=this.offset.clone(),this.color&&(e.color=this.color.clone()),e.opacity=this.opacity,e.anchor=this.anchor.clone(),e.copyGraphics=this.copyGraphics,e.onPreDraw=this.onPreDraw,e.onPostDraw=this.onPostDraw,e.isVisible=this.isVisible,e}}var Do;(function(u){u.Kill="kill",u.PreKill="prekill",u.PostKill="postkill",u.PreDraw="predraw",u.PostDraw="postdraw",u.PreDebugDraw="predebugdraw",u.PostDebugDraw="postdebugdraw",u.PreUpdate="preupdate",u.PostUpdate="postupdate",u.PreFrame="preframe",u.PostFrame="postframe",u.PreCollision="precollision",u.CollisionStart="collisionstart",u.CollisionEnd="collisionend",u.PostCollision="postcollision",u.Initialize="initialize",u.Activate="activate",u.Deactivate="deactivate",u.ExitViewport="exitviewport",u.EnterViewport="enterviewport",u.ExitTrigger="exit",u.EnterTrigger="enter",u.Connect="connect",u.Disconnect="disconnect",u.Button="button",u.Axis="axis",u.Visible="visible",u.Hidden="hidden",u.Start="start",u.Stop="stop",u.PointerUp="pointerup",u.PointerDown="pointerdown",u.PointerMove="pointermove",u.PointerEnter="pointerenter",u.PointerLeave="pointerleave",u.PointerCancel="pointercancel",u.PointerWheel="pointerwheel",u.Up="up",u.Down="down",u.Move="move",u.Enter="enter",u.Leave="leave",u.Cancel="cancel",u.Wheel="wheel",u.Press="press",u.Release="release",u.Hold="hold",u.PointerDragStart="pointerdragstart",u.PointerDragEnd="pointerdragend",u.PointerDragEnter="pointerdragenter",u.PointerDragLeave="pointerdragleave",u.PointerDragMove="pointerdragmove",u.ActionStart="actionstart",u.ActionComplete="actioncomplete",u.Add="add",u.Remove="remove"})(Do||(Do={}));class wt{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(e){this._bubbles=e}stopPropagation(){this.bubbles=!1}}class Fo extends wt{constructor(e){super(),this.self=e,this.target=e}}class $a extends wt{constructor(e){super(),this.self=e,this.target=e}}class th extends wt{constructor(e){super(),this.self=e,this.target=e}}class eh extends wt{constructor(e){super(),this.self=e,this.target=e}}class ih extends wt{constructor(e){super(),this.self=e,this.target=e}}class Vn extends wt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class Nn extends wt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class sh extends wt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class nh extends wt{constructor(e,s,r){super(),this.ctx=e,this.elapsed=s,this.self=r,this.target=r}}class rh extends wt{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class oh extends wt{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class Os extends wt{constructor(e,s,r){super(),this.engine=e,this.elapsed=s,this.self=r,this.target=r}}class Ws extends wt{constructor(e,s,r){super(),this.engine=e,this.elapsed=s,this.self=r,this.target=r}}class ah extends wt{constructor(e,s){super(),this.engine=e,this.prevStats=s,this.target=e}}class hh extends wt{constructor(e,s){super(),this.engine=e,this.stats=s,this.target=e}}class lh extends wt{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class ch extends wt{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class dh extends wt{constructor(e,s,r,a){super(),this.button=e,this.index=s,this.value=r,this.self=a,this.target=a}}class uh extends wt{constructor(e,s,r){super(),this.axis=e,this.value=s,this.self=r,this.target=r}}class fh extends wt{constructor(e){super(),this.self=e,this.target=e}}class _h extends wt{constructor(e){super(),this.self=e,this.target=e}}class on extends wt{constructor(e,s,r,a,l){super(),this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l,this.target=e}}class an extends wt{constructor(e,s,r,a,l){super(),this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l,this.target=e}}class Mo{constructor(e,s,r,a){this.self=e,this.other=s,this.side=r,this.contact=a}}class Bo{constructor(e,s,r,a){this.self=e,this.other=s,this.side=r,this.lastContact=a}}class ko{constructor(e,s,r,a,l){this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l}}class Lo{constructor(e,s,r,a,l){this.self=e,this.other=s,this.side=r,this.intersection=a,this.contact=l}}class yr extends wt{constructor(e,s,r,a){super(),this.self=e,this.other=s,this.side=r,this.contact=a,this.target=e}}class Cr extends wt{constructor(e,s,r,a){super(),this.self=e,this.other=s,this.side=r,this.lastContact=a,this.target=e}}class Gn extends wt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class gh extends wt{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class ph extends wt{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class mh extends wt{constructor(e){super(),this.self=e,this.target=e}}class vh extends wt{constructor(e){super(),this.self=e,this.target=e}}class wh extends wt{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class xh extends wt{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class bh extends wt{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class Ah extends wt{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class yh extends wt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class Ch extends wt{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class vp{constructor(e){this.data=e,this.type="Component Added"}}function wp(u){return!!u&&u.type==="Component Added"}class xp{constructor(e){this.data=e,this.type="Component Removed"}}function bp(u){return!!u&&u.type==="Component Removed"}const Ap={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class Oe{constructor(e,s){this.id=Oe._ID++,this.name=`Entity#${this.id}`,this.events=new I,this._tags=new Set,this.componentAdded$=new je,this.componentRemoved$=new je,this.tagAdded$=new je,this.tagRemoved$=new je,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new je,this.childrenRemoved$=new je,this._children=[],this._isInitialized=!1,this._isAdded=!1;let r,a;if(Array.isArray(e))r=e,a=s;else if(e&&typeof e=="object"){const{components:l,name:f,silenceWarnings:g}=e;r=l??[],a=f}if(a&&(this.name=a),r)for(const l of r)this.addComponent(l)}get active(){return this.isActive}set active(e){this.isActive=e}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new Fo(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(e){return this._tags.has(e)}addTag(e){return this._tags.add(e),this.tagAdded$.notifyAll(e),this}removeTag(e){return this._tags.delete(e),this.tagRemoved$.notifyAll(e),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(e){for(let s=0;s<e.length;s++)if(!this.components.has(e[s]))return!1;return!0}hasAllTags(e){for(let s=0;s<e.length;s++)if(!this.tags.has(e[s]))return!1;return!0}get(e){return this.components.get(e)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(e){if(e.parent===null){if(this.getAncestors().includes(e))throw new Error("Cycle detected, cannot add entity");this._children.push(e),e._parent=this,this.childrenAdded$.notifyAll(e)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(e){return e.parent===this&&(ps(e,this._children),e._parent=null,this.childrenRemoved$.notifyAll(e)),this}removeAllChildren(){for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);return this}getAncestors(){const e=[this];let s=this.parent;for(;s;)e.push(s),s=s.parent;return e.reverse()}getDescendants(){let e=[this],s=[this];for(;s.length>0;){const r=s.pop();r&&(s=s.concat(r.children),e=e.concat(r.children))}return e}clone(){const e=new Oe;for(const s of this.types){const r=this.get(s);r&&e.addComponent(r.clone())}for(const s of this.children)e.addChild(s.clone());return e}addTemplate(e,s=!1){for(const r of e.getComponents())this.addComponent(r.clone(),s);for(const r of e.children)this.addChild(r.clone().addTemplate(r));return this}_getClassHierarchyRoot(e){var s,r;let a=e,l=(s=Object.getPrototypeOf(a.prototype))===null||s===void 0?void 0:s.constructor;for(;l&&l!==Object&&l!==Si;)a=l,l=(r=Object.getPrototypeOf(a.prototype))===null||r===void 0?void 0:r.constructor;return a}addComponent(e,s=!1){if(this.has(e.constructor))if(s)this.removeComponent(e.constructor,!0);else return this;if(e.dependencies&&e.dependencies.length)for(const a of e.dependencies)this.addComponent(new a);e.owner=this;const r=this._getClassHierarchyRoot(e.constructor);return this.components.set(r,e),this.components.set(e.constructor,e),this.componentValues.push(e),e.onAdd&&e.onAdd(this),this.componentAdded$.notifyAll(e),this}removeComponent(e,s=!1){let r;if(gd(e)?r=e:r=e.constructor,s){const a=this.components.get(r);if(a){this.componentRemoved$.notifyAll(a),a.owner=void 0,a.onRemove&&a.onRemove(this);const f=this.componentValues.indexOf(a);f>-1&&this.componentValues.splice(f,1)}const l=this._getClassHierarchyRoot(r);this.components.delete(l),this.components.delete(r)}else this._componentsToRemove.push(r);return this}clearComponents(){const e=this.types;for(const s of e)this.removeComponent(s)}processComponentRemoval(){for(const e of this._componentsToRemove)this.removeComponent(e,!0);this._componentsToRemove.length=0}has(e){return this.components.has(e)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(e){this.isInitialized||(this.onInitialize(e),this.events.emit("initialize",new Gn(e,this)),this._isInitialized=!0)}_add(e){!this.isAdded&&this.isActive&&(this.onAdd(e),this.events.emit("add",new yh(e,this)),this._isAdded=!0)}_remove(e){this.isAdded&&!this.isActive&&(this.onRemove(e),this.events.emit("remove",new Ch(e,this)),this._isAdded=!1)}_preupdate(e,s){this.events.emit("preupdate",new Os(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new Ws(e,s,this)),this.onPostUpdate(e,s)}onInitialize(e){}onAdd(e){}onRemove(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s);for(const r of this.children)r.update(e,s);this._postupdate(e,s),this._remove(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}Oe._ID=0;class Bt extends Si{constructor(){super(...arguments),this.vel=B.Zero,this.acc=B.Zero,this.scaleFactor=B.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class Ze{static integrate(e,s,r,a){const l=a/1e3;s.vel.addEqual(r.scale(l,Ze._ACC)),e.pos.add(s.vel.scale(l,Ze._VEL),Ze._POS).addEqual(r.scale(.5*l*l,Ze._VEL_ACC)),s.angularVelocity+=s.torque*(1/s.inertia)*l;const f=e.rotation+s.angularVelocity*l;e.scale.add(s.scaleFactor.scale(l,this._SCALE_FACTOR),Ze._SCALE),e.get().setTransform(Ze._POS,f,Ze._SCALE)}}Ze._POS=new B(0,0),Ze._SCALE=new B(1,1),Ze._ACC=new B(0,0),Ze._VEL=new B(0,0),Ze._VEL_ACC=new B(0,0),Ze._SCALE_FACTOR=new B(0,0);class Uo extends Oe{constructor(e){super({silenceWarnings:!0}),this.beginColor=Q.White,this.endColor=Q.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=Q.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=ki.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new it),this.addComponent(this.motion=new Bt),this.addComponent(this.graphics=new ne),this.configure(e)}registerEmitter(e){if(this._emitter=e,this.particleTransform===ki.Global){const s=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(s),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(e){var s,r,a,l,f,g,m,w,A,y,E,D,L,O;this.particleTransform=(s=e.transform)!==null&&s!==void 0?s:this.particleTransform,this.life=(r=e.life)!==null&&r!==void 0?r:this.life,this.fade=(a=e.fade)!==null&&a!==void 0?a:this.fade,this.size=(l=e.size)!==null&&l!==void 0?l:this.size,this.endColor=(f=e.endColor)!==null&&f!==void 0?f:this.endColor.clone(),this.beginColor=(g=e.beginColor)!==null&&g!==void 0?g:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=e.graphic,this.graphics.opacity=(m=e.opacity)!==null&&m!==void 0?m:this.graphics.opacity,this.transform.pos=(w=e.pos)!==null&&w!==void 0?w:this.transform.pos,this.transform.rotation=(A=e.rotation)!==null&&A!==void 0?A:0,this.transform.scale=z(1,1),this.motion.vel=(y=e.vel)!==null&&y!==void 0?y:this.motion.vel,this.motion.angularVelocity=(E=e.angularVelocity)!==null&&E!==void 0?E:0,this.motion.acc=(D=e.acc)!==null&&D!==void 0?D:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(L=e.startSize)!==null&&L!==void 0?L:0,this.endSize=(O=e.endSize)!==null&&O!==void 0?O:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=ht.fromDimension(this.size,this.size,B.Half),this.graphics.onPostDraw=q=>{q.save(),q.debug.drawPoint(z(0,0),{color:this._currentColor,size:this.size}),q.restore()})}kill(){var e;!((e=this._emitter)===null||e===void 0)&&e.isActive?this._emitter.removeParticle(this):super.kill()}update(e,s){this.life=this.life-s,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=j(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=j(this.sizeRate*s+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=j(this._currentColor.r+this._rRate*s,0,255),this._currentColor.g=j(this._currentColor.g+this._gRate*s,0,255),this._currentColor.b=j(this._currentColor.b+this._bRate*s,0,255),this._currentColor.a=this.graphics.opacity;let r=this.motion.acc;this.focus&&(r=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(s/1e3)),Ze.integrate(this.transform,this.motion,r,s)}}Uo.DefaultConfig={beginColor:Q.White,endColor:Q.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var ki;(function(u){u.Global="global",u.Local="local"})(ki||(ki={}));class pd{constructor(){this.type="ex.particle",this.priority=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new ni({gl:e,vertexSource:dp,fragmentSource:up,onPreLink:r=>{e.transformFeedbackVaryings(r,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],e.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(e){const s=e.getAttribute(Ft.Filtering),r=s?zn(s):void 0,a=Fi(e.getAttribute(Ft.WrappingX)),l=Fi(e.getAttribute(Ft.WrappingY)),f=e.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);return e.removeAttribute("forceUpload"),g}draw(e,s){var r,a,l,f,g,m,w,A,y;const E=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const D=e.particle.transform===ki.Local?this._context.getTransform():this._context.getTransform().multiply(e.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",D),this._shader.setUniformBoolean("fade",!!e.particle.fade),this._shader.setUniformBoolean("useTexture",!!e.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(r=e.particle.life)!==null&&r!==void 0?r:2e3),this._shader.setUniformFloat("deltaMs",s),this._shader.setUniformFloatVector("gravity",(a=e.particle.acc)!==null&&a!==void 0?a:z(0,0)),this._shader.setUniformFloatColor("beginColor",(l=e.particle.beginColor)!==null&&l!==void 0?l:Q.Transparent),this._shader.setUniformFloatColor("endColor",(f=e.particle.endColor)!==null&&f!==void 0?f:Q.Transparent);let L=(g=e.particle.startSize)!==null&&g!==void 0?g:0,O=(m=e.particle.endSize)!==null&&m!==void 0?m:0;const q=(w=e.particle.size)!==null&&w!==void 0?w:0;if(q>0&&(L=q,O=q),this._shader.setUniformFloat("startSize",L??10),this._shader.setUniformFloat("endSize",O??10),this._shader.setUniformFloat("startOpacity",(A=e.particle.opacity)!==null&&A!==void 0?A:1),e.particle.focus&&(this._shader.setUniformFloatVector("focus",e.particle.focus),this._shader.setUniformFloat("focusAccel",(y=e.particle.focusAccel)!==null&&y!==void 0?y:0)),e.particle.graphic){const H=e.particle.graphic,V=this._getTexture(H.image.image);E.activeTexture(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,V),this._shader.setUniformInt("graphic",0)}e.draw(E)}hasPendingDraws(){return!1}flush(){}dispose(){}}const yp=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,Cp=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class Sp{constructor(e){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=Q.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const r=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=ja(e,r);this._maxTextures=Math.min(r,a);const l=this._transformFragmentSource(yp,this._maxTextures);this._shader=new ni({gl:e,fragmentSource:l,vertexSource:Cp}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((y,E)=>E)),this._vao=e.createVertexArray(),e.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._meshBuffer),e.bufferData(e.ARRAY_BUFFER,this._quadMesh,e.STATIC_DRAW),e.vertexAttribPointer(0,2,e.FLOAT,!1,16,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,16,8),e.enableVertexAttribArray(1),e.bindBuffer(e.ARRAY_BUFFER,null);const f=this._components;this._transformData=new qi({gl:e,size:f*this._maxImages,type:"dynamic"}),this._transformData.bind();let g=0,m=2;const w=4,A=f*4;e.vertexAttribPointer(m++,2,e.FLOAT,!1,A,g),e.enableVertexAttribArray(2),g+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,A,g),e.enableVertexAttribArray(3),g+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,A,g),e.enableVertexAttribArray(4),g+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,A,g),e.enableVertexAttribArray(5),g+=2*w,e.vertexAttribPointer(m++,1,e.FLOAT,!1,A,g),e.enableVertexAttribArray(6),g+=1*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,A,g),e.enableVertexAttribArray(7),g+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,A,g),e.enableVertexAttribArray(8),g+=2*w,e.vertexAttribPointer(m++,1,e.FLOAT,!1,A,g),e.enableVertexAttribArray(9),g+=1*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,A,g),e.enableVertexAttribArray(10),g+=2*w,e.vertexAttribPointer(m++,2,e.FLOAT,!1,A,g),e.enableVertexAttribArray(11),g+=2*w,e.vertexAttribPointer(m++,4,e.FLOAT,!1,A,g),e.enableVertexAttribArray(12),g+=4*w,e.vertexAttribDivisor(2,1),e.vertexAttribDivisor(3,1),e.vertexAttribDivisor(4,1),e.vertexAttribDivisor(5,1),e.vertexAttribDivisor(6,1),e.vertexAttribDivisor(7,1),e.vertexAttribDivisor(8,1),e.vertexAttribDivisor(9,1),e.vertexAttribDivisor(10,1),e.vertexAttribDivisor(11,1),e.vertexAttribDivisor(12,1),e.bindVertexArray(null)}_bindData(e){const s=this._components;this._transformData.bind(),this._transformData.upload(s*this._imageCount),e.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let r=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_texture_index <= ${l}.5) {
`:a+=`   else if (v_texture_index <= ${l}.5) {
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return r=r.replace("%%texture_picker%%",a),r}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(Ft.Filtering),r=s?zn(s):void 0,a=Fi(e.getAttribute(Ft.WrappingX)),l=Fi(e.getAttribute(Ft.WrappingY)),f=e.getAttribute("forceUpload")==="true",g=this._context.textureLoader.load(e,{filtering:r,wrapping:{x:a,y:l}},f);e.removeAttribute("forceUpload"),this._textures.indexOf(g)===-1&&(this._textures.push(g),this._textureToIndex.set(g,this._textureIndex++),this._images.add(e))}_bindTextures(e){const s=Math.min(this._textureIndex,this._maxTextures);for(let r=0;r<s;r++)e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,this._textures[r]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const r=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(r))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,r,a,l,f,g,m,w){var A,y,E,D;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const L=this._getImageWidth(e),O=this._getImageHeight(e);let q=L||a||0,H=O||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(A=a??L)!==null&&A!==void 0?A:0,this._view[3]=(y=l??O)!==null&&y!==void 0?y:0,this._dest[0]=s??1,this._dest[1]=r??1,f!==void 0&&g!==void 0&&m!==void 0&&w!==void 0&&(this._view[0]=s??1,this._view[1]=r??1,this._view[2]=(E=a??L)!==null&&E!==void 0?E:0,this._view[3]=(D=l??O)!==null&&D!==void 0?D:0,this._dest[0]=f,this._dest[1]=g,q=m,H=w),s=this._view[0],r=this._view[1];const V=this._view[2],J=this._view[3],Y=this._context.getTransform(),$=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+pt),this._dest[1]=~~(this._dest[1]+pt));const Z=this._context.tint||this._defaultTint,gt=this._getTextureIdForImage(e),It=L||q,Yt=O||H,Qt=(s+this.uvPadding)/It,Pe=(r+this.uvPadding)/Yt,te=(s+V-this.uvPadding)/It,Ht=(r+J-this.uvPadding)/Yt,Ne=L,Me=O,st=this._transformData.bufferData;st[this._vertexIndex++]=this._dest[0],st[this._vertexIndex++]=this._dest[1],st[this._vertexIndex++]=Y.data[0],st[this._vertexIndex++]=Y.data[1],st[this._vertexIndex++]=Y.data[2],st[this._vertexIndex++]=Y.data[3],st[this._vertexIndex++]=Y.data[4],st[this._vertexIndex++]=Y.data[5],st[this._vertexIndex++]=$,st[this._vertexIndex++]=q,st[this._vertexIndex++]=H,st[this._vertexIndex++]=Ne,st[this._vertexIndex++]=Me,st[this._vertexIndex++]=gt,st[this._vertexIndex++]=Qt,st[this._vertexIndex++]=Pe,st[this._vertexIndex++]=te,st[this._vertexIndex++]=Ht,st[this._vertexIndex++]=Z.r/255,st[this._vertexIndex++]=Z.g/255,st[this._vertexIndex++]=Z.b/255,st[this._vertexIndex++]=Z.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._bindData(e),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),e.drawArraysInstanced(e.TRIANGLES,0,6,this._imageCount),Zt.DrawnImagesCount+=this._imageCount,Zt.DrawCallCount++,e.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const pt=1e-4;class Pp{constructor(e){this._webglCtx=e,this._debugText=new qa}drawRect(e,s,r,a,l={color:Q.Black}){this.drawLine(z(e,s),z(e+r,s),{...l}),this.drawLine(z(e+r,s),z(e+r,s+a),{...l}),this.drawLine(z(e+r,s+a),z(e,s+a),{...l}),this.drawLine(z(e,s+a),z(e,s),{...l})}drawLine(e,s,r){var a;this._webglCtx.draw("ex.line",e,s,(a=r?.color)!==null&&a!==void 0?a:Q.Black)}drawPoint(e,s={color:Q.Black,size:5}){this._webglCtx.draw("ex.point",e,s.color,s.size)}drawText(e,s){this._debugText.write(this._webglCtx,e,s)}}class ws{get z(){return this._state.current.z}set z(e){this._state.current.z=e}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(e){let s=!0;return(e.width>4096||e.height>4096)&&(s=!1),s}constructor(e){this._logger=at.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=b.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new So(()=>new lp,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new Hg,this._state=new ad,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=Q.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new Pp(this),this._totalPostProcessorTime=0;const{canvasElement:s,context:r,enableTransparency:a,antialiasing:l,uvPadding:f,multiSampleAntialiasing:g,pixelArtSampler:m,powerPreference:w,snapToPixel:A,backgroundColor:y,useDrawSorting:E,garbageCollector:D,handleContextLost:L,handleContextRestored:O}=e;if(this.__gl=r??s.getContext("webgl2",{antialias:l??this.smoothing,premultipliedAlpha:!1,alpha:a??this.transparency,depth:!1,powerPreference:w??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");L&&this.__gl.canvas.addEventListener("webglcontextlost",L,!1),O&&this.__gl.canvas.addEventListener("webglcontextrestored",O,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new se(this.__gl,D),this.snapToPixel=A??this.snapToPixel,this.smoothing=l??this.smoothing,this.transparency=a??this.transparency,this.pixelArtSampler=m??this.pixelArtSampler,this.uvPadding=f??this.uvPadding,this.multiSampleAntialiasing=typeof g=="boolean"?g:this.multiSampleAntialiasing,this.samples=typeof g=="object"?g.samples:void 0,this.backgroundColor=y??this.backgroundColor,this.useDrawSorting=E??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const e of this._renderers.values())e.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const e=this.__gl;if(this._ortho=ui.ortho(0,e.canvas.width,e.canvas.height,0,400,-400),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.depthMask(!1),this.register(new ip({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new _d),this.register(new rp),this.register(new hp),this.register(new Qg),this.register(new Yg),this.lazyRegister("ex.particle",()=>new pd),this.register(new Sp({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=e.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");e.bindTexture(e.TEXTURE_2D,this.materialScreenTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.bindTexture(e.TEXTURE_2D,null),this._screenRenderer=new $g(e),this._renderTarget=new Co({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),this._postProcessTargets=[new Co({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),new Co({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height})],this._msaaTarget=new Co({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(e){this._renderers.set(e.type,e),e.initialize(this.__gl,this)}lazyRegister(e,s){this._lazyRenderersFactory.set(e,s)}get(e){let s=this._renderers.get(e);if(!s){const r=this._lazyRenderersFactory.get(e);r&&(this._logger.debug("lazy init renderer:",e),s=r(),this.register(s))}return s}_isCurrentRenderer(e){return!this._currentRenderer||this._currentRenderer===e}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(e,...s){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${e}, the webgl context is lost`);return}const r=this.get(e);if(r)if(this.useDrawSorting){const a=this._drawCallPool.get();a.z=this._state.current.z,a.priority=r.priority,a.renderer=e,this.getTransform().clone(a.transform),a.state.z=this._state.current.z,a.state.opacity=this._state.current.opacity,a.state.tint=this._state.current.tint,a.state.material=this._state.current.material,a.args[0]=s[0],a.args[1]=s[1],a.args[2]=s[2],a.args[3]=s[3],a.args[4]=s[4],a.args[5]=s[5],a.args[6]=s[6],a.args[7]=s[7],a.args[8]=s[8],a.args[9]=s[9],this._drawCalls[this._drawCallIndex++]=a}else this._currentRenderer||(this._currentRenderer=r),this._isCurrentRenderer(r)||this._currentRenderer.flush(),r.draw(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9]),this._currentRenderer=r;else throw Error(`No renderer with name ${e} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(e){const s=this.__gl;this._ortho=this._ortho=ui.ortho(0,e.width,e.height,0,400,-400),this._renderTarget.setResolution(s.canvas.width,s.canvas.height),this._msaaTarget.setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[0].setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[1].setResolution(s.canvas.width,s.canvas.height)}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}drawImage(e,s,r,a,l,f,g,m,w){if(!(a===0||l===0)){{if(m===0||w===0)return;if(this._getImageWidth(e)===0||this._getImageHeight(e)===0)return}if(!e){at.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",e,s,r,a,l,f,g,m,w):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,e,s,r,a,l,f,g,m,w):this.draw(this.imageRenderer,e,s,r,a,l,f,g,m,w)}}drawLine(e,s,r,a=1){this.draw("ex.rectangle",e,s,r,a)}drawRectangle(e,s,r,a,l,f){this.draw("ex.rectangle",e,s,r,a,l,f)}drawCircle(e,s,r,a,l){this.draw("ex.circle",e,s,r,a,l)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(e,s){this._transform.translate(this.snapToPixel?~~(e+pt):e,this.snapToPixel?~~(s+pt):s)}rotate(e){this._transform.rotate(e)}scale(e,s){this._transform.scale(e,s)}transform(e){this._transform.current=e}getTransform(){return this._transform.current}multiply(e){this._transform.current.multiply(e,this._transform.current)}addPostProcessor(e){this._postprocessors.push(e),e.initialize(this.__gl)}removePostProcessor(e){const s=this._postprocessors.indexOf(e);s!==-1&&this._postprocessors.splice(s,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(e){for(const s of this._postprocessors){const r=s.getShader();r.use();const a=r.getUniforms();this._totalPostProcessorTime+=e,a.find(l=>l.name==="u_time_ms")&&r.setUniformFloat("u_time_ms",this._totalPostProcessorTime),a.find(l=>l.name==="u_elapsed_ms")&&r.setUniformFloat("u_elapsed_ms",e),a.find(l=>l.name==="u_resolution")&&r.setUniformFloatVector("u_resolution",z(this.width,this.height)),s.onUpdate&&s.onUpdate(e)}}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return new fd({...e,graphicsContext:this})}createShader(e){const s=this.__gl,{vertexSource:r,fragmentSource:a}=e,l=new ni({gl:s,vertexSource:r,fragmentSource:a});return l.compile(),l}clear(){const e=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT)}flush(){var e;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let s=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(s.use(),this.useDrawSorting){for(let f=this._drawCallIndex;f<this._drawCalls.length;f++)this._drawCalls[f]=null;const r=new Map;for(const[f]of this._renderers){let g=0;for(g=0;g<this._drawCallIndex&&this._drawCalls[g].renderer!==f;g++);r.set(f,g)}this._drawCalls.sort((f,g)=>{if(f===null||g===null)return 0;const m=f.z-g.z,w=r.get(f.renderer)-r.get(g.renderer),A=f.priority-g.priority;return m===0?A===0?w:A:m});const a=this._transform.current,l=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let f=this._drawCalls[0].renderer,g=this.get(f);for(let m=0;m<this._drawCallIndex;m++)this._transform.current=this._drawCalls[m].transform,this._state.current=this._drawCalls[m].state,this._drawCalls[m].renderer!==f&&(g.flush(),f=this._drawCalls[m].renderer,g=this.get(f)),g instanceof _d&&(!((e=this.material)===null||e===void 0)&&e.isUsingScreenTexture)&&(s.copyToTexture(this.materialScreenTexture),s.use()),g.draw(...this._drawCalls[m].args);g.hasPendingDraws()&&g.flush()}this._transform.current=a,this._state.current=l,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const r of this._renderers.values())r.hasPendingDraws()&&r.flush();s.disable(),this._postprocessors.length>0&&s.toRenderSource().use();for(let r=0;r<this._postprocessors.length;r++)s=this._postProcessTargets[r%2],this._postProcessTargets[r%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[r]),this._postProcessTargets[r%2].toRenderSource().use();s.blitToScreen()}}const le=1e-4;class Tp{constructor(e){this._ex=e,this._debugText=new qa}drawRect(e,s,r,a){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(e+le):e,this._ex.snapToPixel?~~(s+le):s,this._ex.snapToPixel?~~(r+le):r,this._ex.snapToPixel?~~(a+le):a),this._ex.__ctx.restore()}drawLine(e,s,r={color:Q.Black}){var a,l;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(l=(a=r.color)===null||a===void 0?void 0:a.toString())!==null&&l!==void 0?l:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(e.x+le):e.x,this._ex.snapToPixel?~~(e.y+le):e.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(s.x+le):s.x,this._ex.snapToPixel?~~(s.y+le):s.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(e,s={color:Q.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=s.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(e.x+le):e.x,this._ex.snapToPixel?~~(e.y+le):e.y,s.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(e,s){this._debugText.write(this._ex,e,s)}}class zo{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(e){this.__ctx.imageSmoothingEnabled=e}constructor(e){this.useDrawSorting=!1,this.z=0,this.backgroundColor=Q.ExcaliburBlue,this._state=new ad,this.snapToPixel=!1,this.debug=new Tp(this);const{canvasElement:s,context:r,enableTransparency:a,snapToPixel:l,antialiasing:f,backgroundColor:g}=e;if(this.__ctx=r??s.getContext("2d",{alpha:a??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=g??this.backgroundColor,this.snapToPixel=l??this.snapToPixel,this.smoothing=f??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(e){}drawImage(e,s,r,a,l,f,g,m,w){if(a===0||l===0)return;if(m===0||w===0)return;if(e.width===0||e.height===0)return;this.__ctx.globalAlpha=this.opacity;const A=[e,s,r,a,l,f,g,m,w].filter(y=>y!==void 0).map(y=>typeof y=="number"&&this.snapToPixel?~~y:y);this.__ctx.drawImage.apply(this.__ctx,A),Zt.DrawCallCount++,Zt.DrawnImagesCount=1}drawLine(e,s,r,a=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=r.toString(),this.__ctx.moveTo(this.snapToPixel?~~(e.x+le):e.x,this.snapToPixel?~~(e.y+le):e.y),this.__ctx.lineTo(this.snapToPixel?~~(s.x+le):s.x,this.snapToPixel?~~(s.y+le):s.y),this.__ctx.lineWidth=a,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(e,s,r,a){this.__ctx.save(),this.__ctx.fillStyle=a.toString(),this.__ctx.fillRect(this.snapToPixel?~~(e.x+le):e.x,this.snapToPixel?~~(e.y+le):e.y,this.snapToPixel?~~(s+le):s,this.snapToPixel?~~(r+le):r),this.__ctx.restore()}drawCircle(e,s,r,a,l){this.__ctx.save(),this.__ctx.beginPath(),a&&(this.__ctx.strokeStyle=a.toString()),l&&(this.__ctx.lineWidth=l),this.__ctx.fillStyle=r.toString(),this.__ctx.arc(this.snapToPixel?~~(e.x+le):e.x,this.snapToPixel?~~(e.y+le):e.y,s,0,Math.PI*2),this.__ctx.fill(),a&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(e,s){this.__ctx.translate(this.snapToPixel?~~(e+le):e,this.snapToPixel?~~(s+le):s)}rotate(e){this.__ctx.rotate(e)}scale(e,s){this.__ctx.scale(e,s)}getTransform(){throw new Error("Not implemented")}multiply(e){this.__ctx.setTransform(this.__ctx.getTransform().multiply(e.toDOMMatrix()))}addPostProcessor(e){}removePostProcessor(e){}clearPostProcessors(){}updatePostProcessors(e){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),Zt.clear()}flush(){}dispose(){this.__ctx=void 0}}var ye;(function(u){u.Fixed="Fixed",u.FitContainerAndFill="FitContainerAndFill",u.FitScreenAndFill="FitScreenAndFill",u.FitContainerAndZoom="FitContainerAndZoom",u.FitScreenAndZoom="FitScreenAndZoom",u.FitScreen="FitScreen",u.FillScreen="FillScreen",u.FitContainer="FitContainer",u.FillContainer="FillContainer"})(ye||(ye={}));class Sh{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const Ep={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class Ph{constructor(e){var s,r,a,l;this.events=new I,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=at.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const f=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(f),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new ht,this._unsafeArea=new ht,this.viewport=e.viewport,this.resolution=(s=e.resolution)!==null&&s!==void 0?s:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(r=e.displayMode)!==null&&r!==void 0?r:ye.Fixed,this._canvas=e.canvas,this.graphicsContext=e.context,this._antialiasing=(a=e.antialiasing)!==null&&a!==void 0?a:this._antialiasing,this._canvasImageRendering=(l=e.canvasImageRendering)!==null&&l!==void 0?l:this._canvasImageRendering,this._browser=e.browser,this._pixelRatioOverride=e.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const e=this.worldToPageCoordinates(B.Zero);return this.worldToPageCoordinates(z(1,0)).sub(e).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(e){this._pixelRatioOverride=e}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case ye.FillContainer:case ye.FitContainer:case ye.FitContainerAndFill:case ye.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(e){this._resolution=e}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(e){this._viewport=e}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(e){this._camera=e}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof ws&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let a=Math.max(1,this.pixelRatio-.5),l=!1;for(;a>1&&!l;){a=Math.max(1,a-.5);const f=this._resolution.width*a,g=this._resolution.height*a;l=this.graphicsContext.checkIfResolutionSupported({width:f,height:g})}this.pixelRatioOverride=a,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const e=this.viewport.widthUnit==="percent"?"%":"px",s=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+e,this._canvas.style.height=this.viewport.height+s,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof zo&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(e){this._antialiasing=e,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(e){return this.enterFullscreen(e)}enterFullscreen(e){var s,r,a,l,f,g;if(e){const m=document.getElementById(e);if(m?.requestFullscreen||m?.webkitRequestFullscreen){if(m.getAttribute("ex-fullscreen-listener")||(m.setAttribute("ex-fullscreen-listener","true"),m.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),m.requestFullscreen)return(s=m.requestFullscreen())!==null&&s!==void 0?s:Promise.resolve();if(m.webkitRequestFullscreen)return(r=m.webkitRequestFullscreen())!==null&&r!==void 0?r:Promise.resolve()}}return!((a=this._canvas)===null||a===void 0)&&a.requestFullscreen?(f=(l=this._canvas)===null||l===void 0?void 0:l.requestFullscreen())!==null&&f!==void 0?f:Promise.resolve():this._canvas.webkitRequestFullscreen?(g=this._canvas.webkitRequestFullscreen())!==null&&g!==void 0?g:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(e){return{width:e.widthUnit==="percent"?this.canvas.offsetWidth:e.width,height:e.heightUnit==="percent"?this.canvas.offsetHeight:e.height}}pageToScreenCoordinates(e){let s=e.x,r=e.y;this._isFullscreen||(s-=zs(this._canvas).x,r-=zs(this._canvas).y);const a=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,f=(window.innerHeight-l)/2;r=(r-f)/l*a.height,s=s/window.innerWidth*a.width}else{const l=window.innerHeight*this.aspectRatio,f=(window.innerWidth-l)/2;s=(s-f)/l*a.width,r=r/window.innerHeight*a.height}return s=s/a.width*this.resolution.width,r=r/a.height*this.resolution.height,s=s-this.contentArea.left,r=r-this.contentArea.top,new B(s,r)}screenToPageCoordinates(e){let s=e.x,r=e.y;const a=this._viewportToPixels(this.viewport);if(s=s/this.resolution.width*a.width,r=r/this.resolution.height*a.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,f=(window.innerHeight-l)/2;r=r/a.height*l+f,s=s/a.width*window.innerWidth}else{const l=window.innerHeight*this.aspectRatio,f=(window.innerWidth-l)/2;s=s/a.width*l+f,r=r/a.height*window.innerHeight}return this._isFullscreen||(s+=zs(this._canvas).x,r+=zs(this._canvas).y),new B(s,r)}screenToWorldCoordinates(e){return e=e.add(z(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(e):e.sub(z(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(e){return this._camera?this._camera.transform.multiply(e):e.add(z(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(e){const s=this.pageToScreenCoordinates(e);return this.screenToWorldCoordinates(s)}worldToPageCoordinates(e){const s=this.worldToScreenCoordinates(e);return this.screenToPageCoordinates(s)}getWorldBounds(){return ht.fromDimension(this.resolution.width,this.resolution.height,B.Half).scale(z(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero,B.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return z(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=this.aspectRatio;let s=0,r=0;window.innerWidth/e<window.innerHeight?(s=window.innerWidth,r=window.innerWidth/e):(s=window.innerHeight*e,r=window.innerHeight),this.viewport={width:s,height:r},this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this._unsafeArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndFill(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(e,s,r){if(this.viewport=r??{width:e,height:s},e/s<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:e*this._contentResolution.width/e,height:e*this._contentResolution.width/e*s/e};const a=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new ht({top:a,left:0,right:this._contentResolution.width,bottom:this.resolution.height-a}),this._unsafeArea=new ht({top:-a,left:0,right:this._contentResolution.width,bottom:this.resolution.height+a})}else{this.resolution={width:s*this._contentResolution.height/s*e/s,height:s*this._contentResolution.height/s};const a=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new ht({top:0,left:a,right:this.resolution.width-a,bottom:this._contentResolution.height}),this._unsafeArea=new ht({top:0,left:-a,right:this.resolution.width+a,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndZoom(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const e=this.canvas.parentElement;e.style.overflow="hidden";const{offsetWidth:s,offsetHeight:r}=this.canvas;this._computeFitAndZoom(s,r),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(e,s){const r=this.aspectRatio;let a=0,l=0;e/r<s?(a=e,l=e/r):(a=s*r,l=s);const f=e/a,g=s/l,m=Math.max(f,g),w=a*m,A=l*m;w>e?this.canvas.style.left=-(w-e)/2+"px":this.canvas.style.left="",A>s?this.canvas.style.top=-(A-s)/2+"px":this.canvas.style.top="",this.viewport={width:w,height:A};const y=ht.fromDimension(this.viewport.width,this.viewport.height,B.Zero);if(this.viewport.width>e){const E=(this.viewport.width-e)/this.viewport.width*this.resolution.width;y.top=0,y.left=E/2,y.right=this.resolution.width-E/2,y.bottom=this.resolution.height}if(this.viewport.height>s){const E=(this.viewport.height-s)/this.viewport.height*this.resolution.height;y.top=E/2,y.left=0,y.bottom=this.resolution.height-E/2,y.right=this.resolution.width}this._contentArea=y}_computeFitContainer(){const e=this.aspectRatio;let s=0,r=0,a="pixel",l="pixel";const f=this.canvas.parentElement;f.clientWidth/e<f.clientHeight?(this.canvas.style.width="100%",s=100,a="percent",r=this.canvas.offsetWidth/e):(this.canvas.style.height="100%",r=100,l="percent",s=this.canvas.offsetHeight*e),this.viewport={width:s,widthUnit:a,height:r,heightUnit:l},this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(e){this.displayMode===ye.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===ye.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:e.innerWidth,height:e.innerHeight},this.viewport=this.resolution),this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,B.Zero),this.displayMode===ye.FitScreen&&this._computeFit(),this.displayMode===ye.FitContainer&&this._computeFitContainer(),this.displayMode===ye.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===ye.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===ye.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===ye.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class Sr{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function Ip(u){return!!u.playbackState}class hn{static unlock(){return new Promise((s,r)=>{if(hn._UNLOCKED||!Sr.create())return s(!0);const a=setTimeout(()=>{at.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),s(!1)},200),l=Sr.create();l.resume().then(()=>{const f=l.createBuffer(1,1,22050),g=l.createBufferSource();let m=!1;g.buffer=f,g.connect(l.destination),g.onended=()=>m=!0,g.start(0),setTimeout(()=>{Ip(g)?(g.playbackState===g.PLAYING_STATE||g.playbackState===g.FINISHED_STATE)&&(hn._UNLOCKED=!0):(l.currentTime>0||m)&&(hn._UNLOCKED=!0)},0),clearTimeout(a),s(!0)},()=>{r()})})}static isUnlocked(){return this._UNLOCKED}}hn._UNLOCKED=!1;class Ho extends On{get ctx(){return this._ctx}constructor(e={}){super(e),this._options=e}clone(){return new Ho({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){var s,r;!((s=this._options)===null||s===void 0)&&s.draw&&((r=this._options)===null||r===void 0||r.draw(e)),this._options.cache||this.flagDirty()}}class Th{}Th.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class Oo{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(e){this._currentState=e}static create(e,s){const r=new Oo;r.data=s;for(const a in e.states)r.states.set(a,{name:a,...e.states[a]});for(const a of r.states.values())for(const l of a.transitions)if(l!=="*"&&!r.states.has(l))throw Error(`Invalid state machine, state [${a.name}] has a transition to another state that doesn't exist [${l}]`);return r.currentState=r.startState=r.states.get(e.start),r}in(e){return this.currentState.name===e}go(e,s){var r,a;if(this.currentState.transitions.includes(e)||this.currentState.transitions.includes("*")){const l=this.states.get(e);return this.currentState.onExit&&((r=this.currentState)===null||r===void 0?void 0:r.onExit({to:l.name,data:this.data}))===!1||l?.onEnter&&l?.onEnter({from:this.currentState.name,eventData:s,data:this.data})===!1?!1:(this.currentState=l,!((a=this.currentState)===null||a===void 0)&&a.onState&&this.currentState.onState(),!0)}return!1}update(e){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,e)}save(e){localStorage.setItem(e,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(e){const s=JSON.parse(localStorage.getItem(e));this.currentState=this.states.get(s.currentState),this.data=s.data}}class md{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(e){this._loop=e,this._instance&&(this._instance.loop=e,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(e){e=j(e,0,1),this._volume=e,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(e,this._audioContext.currentTime,.1):this._volumeNode.gain.value=e}get volume(){return this._volume}get duration(){var e;return(e=this._duration)!==null&&e!==void 0?e:this.getTotalPlaybackDuration()}set duration(e){this._duration=e}constructor(e){this._src=e,this._audioContext=Sr.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new P,this._stateMachine=Oo.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:s})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,s.pausedAt*this._playbackRate):this._instance.start(0,s.pausedAt*this._playbackRate,this.duration),s.startedAt=this._audioContext.currentTime-s.pausedAt,s.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:s})=>{s==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:s,data:r})=>{r.pausedAt=(s??0)/this._playbackRate,r.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:s})=>{s.pausedAt=0,s.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:s})=>{s.pausedAt=this._audioContext.currentTime-s.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(e=()=>{}){return this._playStarted=e,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(e){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",e)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:e,startedAt:s}=this._stateMachine.data;return e?e*this._playbackRate:s?(this._audioContext.currentTime-s)*this._playbackRate:0}set playbackRate(e){this._instance.playbackRate.value=this._playbackRate=e}get playbackRate(){return this._instance.playbackRate.value}}class Eh extends wt{set bubbles(e){}get bubbles(){return!1}get _path(){return null}set _path(e){}constructor(e,s="MediaEvent"){super(),this.target=e,this._name=s}stopPropagation(){}action(){}propagate(){}layPath(e){}}class ln extends Eh{constructor(e,s){super(e,"NativeSoundEvent"),this.track=s}}class vd extends Eh{constructor(e,s){super(e,"NativeSoundProcessedEvent"),this._processedData=s,this.data=this._processedData}}function Rp(u){try{const e=new Audio,s=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,r=u.match(s)[1];return!!e.canPlayType("audio/"+r)}catch(e){return at.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",e),!1}}const Dp={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class wd{set loop(e){this._loop=e;for(const s of this._tracks)s.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(e){this._volume=e;for(const s of this._tracks)s.volume=this._volume;this.events.emit("volumechange",new ln(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(e){this._duration=e}get instances(){return this._tracks}get path(){return this._resource.path}set path(e){this._resource.path=e}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}constructor(...e){this.events=new I,this.logger=at.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=Sr.create(),this._resource=new vr("",Th.type.arraybuffer);for(const s of e)if(Rp(s)){this.path=s;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",e.join(", ")),this.logger.warn("Attempting to use",e[0]),this.path=e[0])}isLoaded(){return!!this.data}async load(){var e,s;if(this.data)return this.data;const r=await this._resource.load(),a=await this.decodeAudio(r.slice(0));return this._duration=(s=(e=this._duration)!==null&&e!==void 0?e:a?.duration)!==null&&s!==void 0?s:void 0,this.events.emit("processed",new vd(this,a)),this.data=a}async decodeAudio(e){try{return await this._audioContext.decodeAudioData(e.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(e){e&&(this._engine=e,this._engine.on("hidden",()=>{e.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{e.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(e=>e.isPlaying())}isPaused(){return this._tracks.some(e=>e.isPaused())}isStopped(){return this._tracks.some(e=>e.isStopped())}play(e){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=e||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const e of this._tracks)e.pause();this.events.emit("pause",new ln(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const e of this._tracks)e.stop();this.events.emit("stop",new ln(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._tracks.forEach(s=>{s.playbackRate=this._playbackRate})}seek(e,s=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[s].seek(e)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(e=0){return this._tracks.length?this._tracks[e].getPlaybackPosition():0}getTrackId(e){return this._tracks.indexOf(e)}async _resumePlayback(){if(this.isPaused()){const e=[];for(const s of this._tracks)e.push(s.play().then(()=>(this._tracks.splice(this.getTrackId(s),1),!0)));this.events.emit("resume",new ln(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(e)}return!0}async _startPlayback(){const e=this._getTrackInstance(this.data),s=await e.play(()=>{this.events.emit("playbackstart",new ln(this,e)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new ln(this,e));const r=this.getTrackId(e);return r!==-1&&this._tracks.splice(r,1),s}_getTrackInstance(e){var s;const r=new md(e);return r.loop=this.loop,r.volume=this.volume,r.duration=(s=this.duration)!==null&&s!==void 0?s:0,r.playbackRate=this._playbackRate,this._tracks.push(r),r}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const Fp={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function Ih(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class Pr{get resources(){return this._resources}constructor(e){var s;this.events=new I,this.canvas=new Ho({filtering:_e.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new P,e&&(!((s=e.loadables)===null||s===void 0)&&s.length)&&this.addResources(e.loadables)}onInitialize(e){this.engine=e,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await xo(500,this.engine.clock)}addResource(e){this._resources.push(e)}addResources(e){let s=0;const r=e.length;for(s;s<r;s++)this.addResource(e[s])}markResourceComplete(){this._numLoaded++}get progress(){const e=this._resources.length;return e>0?j(this._numLoaded,0,e)/e:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(e,s){this._totalTimeMs+=s}onDraw(e){const s=this._totalTimeMs/1e3;e.fillStyle=Q.Black.toRGBA(),e.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),e.save(),e.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const r=s*10;e.strokeStyle="white",e.lineWidth=10,e.lineCap="round",e.arc(0,0,40,r,r+Math.PI*3/2),e.stroke(),e.fillStyle="white",e.font="16px sans-serif";const a=(this.progress*100).toFixed(0)+"%",l=e.measureText(a),f=Math.abs(l.actualBoundingBoxLeft)+Math.abs(l.actualBoundingBoxRight),g=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);e.fillText(a,-f/2,g/2),e.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async e=>{this.events.emit("loadresourcestart",e),await e.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",e)})}));for(const e of this._resources)e instanceof wd&&e.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await hn.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const Mp="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var Bp=o(851);class cn extends Pr{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const e=document.getElementById("excalibur-play-root");return e&&(this._playButtonRootElement=e),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(e){const s=Array.isArray(e)?{loadables:e}:e;super(s),this._logger=at.getInstance(),this._originalOptions={loadables:[]},this.events=new I,this._playButtonShown=!1,this.logo=Mp,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=Q.White,this.backgroundColor="#176BAA",this._imageLoaded=new P,this.suppressPlayButton=!1,this._playButtonStyles=Bp.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let r=document.getElementById("excalibur-play");return r||(r=document.createElement("button")),r.id="excalibur-play",r.textContent=this.playButtonText,r.style.display="none",r},this._originalOptions={...cn._DEFAULT_LOADER_OPTIONS,...s}}onInitialize(e){this.engine=e,this.screen=e.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var e,s;if(this.suppressPlayButton)this.hidePlayButton(),await xo(500,(e=this.engine)===null||e===void 0?void 0:e.clock);else{const r=()=>{try{this._positionPlayButton()}catch{}};return!((s=this.engine)===null||s===void 0)&&s.browser&&this.engine.browser.window.on("resize",r),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",l=>{l.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(l=>{const f=g=>{var m;if(g.stopPropagation(),this.hidePlayButton(),!((m=this.engine)===null||m===void 0)&&m.browser&&this.engine.browser.window.off("resize",r),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(w){this._logger.error("could not go fullscreen",w)}l()};this._playButton.addEventListener("click",f),this._playButton.addEventListener("touchend",f),this._playButton.addEventListener("pointerup",f),this.engine&&this.engine.input.gamepads.once("button",()=>f(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var e;await xo(200,(e=this.engine)===null||e===void 0?void 0:e.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const e=this._image;await this._imageLoaded.promise,await e?.decode()}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:e,y:s,width:r,height:a}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const l=this._playButton.clientWidth,f=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${e+r/2-l/2}px`,this._playButtonRootElement.style.top=`${s+a/2-f/2+100}px`)}}}onDraw(e){const s=this.engine.canvasHeight/this.engine.pixelRatio,r=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),e.fillStyle=this.backgroundColor,e.fillRect(0,0,r,s);let a=s/2;const l=Math.min(this.logoWidth,r*.75);let f=r/2-l/2;this.logoPosition&&(f=this.logoPosition.x,a=this.logoPosition.y);const g=Math.floor(l*(this.logoHeight/this.logoWidth)),m=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,f,a,l,g):e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,f,a-g-20,l,g),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=m;return}let w=f,A=a;this.loadingBarPosition&&(w=this.loadingBarPosition.x,A=this.loadingBarPosition.y),e.lineWidth=2,Ja(e,w,A,l,20,10,this.loadingBarColor);const y=l*this.progress,E=5,D=y-E*2,L=20-E*2;Ja(e,w+E,A+E,D>10?D:10,L,5,null,this.loadingBarColor),this.engine.screen.antialiasing=m}}cn._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const xd={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class bd{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("2d"))},arrayBufferSupport:function(){const e=new XMLHttpRequest;e.open("GET","/");try{e.responseType="arraybuffer"}catch{return!1}return e.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const e=document.createElement("a").style;return e.cssText="background-color:rgba(150,255,150,.5)",(""+e.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let e=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const s=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],r=this.getBrowserFeatures();for(const a of Object.keys(xd))r[a]?(e+="(%c✓%c)",s.push("font-weight: bold; color: green"),s.push("font-weight: normal; color: inherit")):(e+="(%c✗%c)",s.push("font-weight: bold; color: red"),s.push("font-weight: normal; color: inherit")),e+=" "+xd[a]+`
`;s.unshift(e),console.log.apply(console,s)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let e=!1;for(const s in this._criticalTests)this._criticalTests[s].call(this)||(this.failedTests.push(s),at.getInstance().error("Critical browser feature missing, Excalibur requires:",s),e=!0);if(e)return!1;for(const s in this._warningTest)this._warningTest[s]()||at.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",s);return!0}}var ft;(function(u){u.PreventCollision="PreventCollision",u.Passive="Passive",u.Active="Active",u.Fixed="Fixed"})(ft||(ft={}));class Yi{static create(e,s){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(e)){const a=this._GROUPS.get(e);if(a.mask===s)return a;throw new Error(`Collision group ${e} already exists with a different mask!`)}const r=new xs(e,this._CURRENT_BIT,s!==void 0?s:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(e,r),r}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(e){return this._GROUPS.get(e)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}Yi._STARTING_BIT=1,Yi._MAX_GROUPS=32,Yi._CURRENT_GROUP=1,Yi._CURRENT_BIT=Yi._STARTING_BIT,Yi._GROUPS=new Map;class xs{constructor(e,s,r){this._name=e,this._category=s,this._mask=r}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(e){const s=this.category&e.mask,r=this.mask&e.category;return s!==0&&r!==0}invert(){const e=Yi.create("~("+this.name+")",~this.mask|0);return e._category=~this.category,e}static combine(e){const s=e.map(l=>l.name).join("+"),a=~e.reduce((l,f)=>f.category|l,0);return Yi.create(s,a)}static collidesWith(e){const s=`collidesWith(${e.map(a=>a.name).join("+")})`,r=e.reduce((a,l)=>l.category|a,0);return Yi.create(s,r)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}xs.All=new xs("Collide with all groups",-1,-1);class Qe{constructor(e,s){this.colliderA=e,this.colliderB=s,this.id=null,this.id=Qe.calculatePairHash(e.id,s.id)}static canCollide(e,s){var r,a;if(e.id===s.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.localBounds.hasZeroDimensions()||s.localBounds.hasZeroDimensions())return!1;const l=(r=e?.owner)===null||r===void 0?void 0:r.get(Tt),f=(a=s?.owner)===null||a===void 0?void 0:a.get(Tt);return!(!l||!f||!l.group.canCollide(f.group)||l.collisionType===ft.Fixed&&f.collisionType===ft.Fixed||f.collisionType===ft.PreventCollision||l.collisionType===ft.PreventCollision||!l.isActive||!f.isActive)}get canCollide(){const e=this.colliderA,s=this.colliderB;return Qe.canCollide(e,s)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(e){return e===this.colliderA||e===this.colliderB}static calculatePairHash(e,s){return e.value<s.value?`#${e.value}+${s.value}`:`#${s.value}+${e.value}`}}class Tr{constructor(e,s){this.min=e,this.max=s}overlaps(e){return this.max>e.min&&e.max>this.min}getOverlap(e){return this.overlaps(e)?this.max>e.max?e.max-this.min:this.max-e.min:0}}class Rh{constructor(e){this.parent=e,this.parent=e||null,this.data=null,this.bounds=new ht,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class Dh{constructor(e,s=new ht(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=e,this.worldBounds=s,this.root=null,this.nodes={}}_insert(e){if(this.root===null){this.root=e,this.root.parent=null;return}const s=e.bounds;let r=this.root;for(;!r.isLeaf();){const g=r.left,m=r.right,w=r.bounds.getPerimeter(),y=r.bounds.combine(s).getPerimeter(),E=2*y,D=2*(y-w);let L=0;const O=s.combine(g.bounds);let q,H;g.isLeaf()?L=O.getPerimeter()+D:(H=g.bounds.getPerimeter(),q=O.getPerimeter(),L=q-H+D);let V=0;const J=s.combine(m.bounds);if(m.isLeaf()?V=J.getPerimeter()+D:(H=m.bounds.getPerimeter(),q=J.getPerimeter(),V=q-H+D),E<L&&E<V)break;L<V?r=g:r=m}const a=r.parent,l=new Rh(a);l.bounds=s.combine(r.bounds),l.height=r.height+1,a!==null?(a.left===r?a.left=l:a.right=l,l.left=r,l.right=e,r.parent=l,e.parent=l):(l.left=r,l.right=e,r.parent=l,e.parent=l,this.root=l);let f=e.parent;for(;f;){if(f=this._balance(f),!f.left)throw new Error("Parent of current leaf cannot have a null left child"+f);if(!f.right)throw new Error("Parent of current leaf cannot have a null right child"+f);f.height=1+Math.max(f.left.height,f.right.height),f.bounds=f.left.bounds.combine(f.right.bounds),f=f.parent}}_remove(e){if(e===this.root){this.root=null;return}const s=e.parent,r=s.parent;let a;if(s.left===e?a=s.right:a=s.left,r){r.left===s?r.left=a:r.right=a,a.parent=r;let l=r;for(;l;)l=this._balance(l),l.bounds=l.left.bounds.combine(l.right.bounds),l.height=1+Math.max(l.left.height,l.right.height),l=l.parent}else this.root=a,a.parent=null}trackCollider(e){const s=new Rh;s.data=e,s.bounds=e.bounds,s.bounds.left-=2,s.bounds.top-=2,s.bounds.right+=2,s.bounds.bottom+=2,this.nodes[e.id.value]=s,this._insert(s)}updateCollider(e){var s;const r=this.nodes[e.id.value];if(!r)return!1;const a=e.bounds;if(!this.worldBounds.contains(a))return at.getInstance().warn("Collider with id "+e.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(e),!1;if(r.bounds.contains(a))return!1;if(this._remove(r),a.left-=this._config.boundsPadding,a.top-=this._config.boundsPadding,a.right+=this._config.boundsPadding,a.bottom+=this._config.boundsPadding,e.owner){const l=(s=e.owner)===null||s===void 0?void 0:s.get(Tt);if(l){const f=l.vel.x*32/1e3*this._config.velocityMultiplier,g=l.vel.y*32/1e3*this._config.velocityMultiplier;f<0?a.left+=f:a.right+=f,g<0?a.top+=g:a.bottom+=g}}return r.bounds=a,this._insert(r),!0}untrackCollider(e){const s=this.nodes[e.id.value];s&&(this._remove(s),this.nodes[e.id.value]=null,delete this.nodes[e.id.value])}_balance(e){if(e===null)throw new Error("Cannot balance at null node");if(e.isLeaf()||e.height<2)return e;const s=e.left,r=e.right,a=e,l=s,f=r,g=s.left,m=s.right,w=r.left,A=r.right,y=f.height-l.height;if(y>1)return f.left=a,f.parent=a.parent,a.parent=f,f.parent?f.parent.left===a?f.parent.left=f:f.parent.right=f:this.root=f,w.height>A.height?(f.right=w,a.right=A,A.parent=a,a.bounds=l.bounds.combine(A.bounds),f.bounds=a.bounds.combine(w.bounds),a.height=1+Math.max(l.height,A.height),f.height=1+Math.max(a.height,w.height)):(f.right=A,a.right=w,w.parent=a,a.bounds=l.bounds.combine(w.bounds),f.bounds=a.bounds.combine(A.bounds),a.height=1+Math.max(l.height,w.height),f.height=1+Math.max(a.height,A.height)),f;if(y<-1){if(l.left=a,l.parent=a.parent,a.parent=l,l.parent)if(l.parent.left===a)l.parent.left=l;else{if(l.parent.right!==a)throw"Error rotating Dynamic Tree";l.parent.right=l}else this.root=l;return g.height>m.height?(l.right=g,a.left=m,m.parent=a,a.bounds=f.bounds.combine(m.bounds),l.bounds=a.bounds.combine(g.bounds),a.height=1+Math.max(f.height,m.height),l.height=1+Math.max(a.height,g.height)):(l.right=m,a.left=g,g.parent=a,a.bounds=f.bounds.combine(g.bounds),l.bounds=a.bounds.combine(m.bounds),a.height=1+Math.max(f.height,g.height),l.height=1+Math.max(a.height,m.height)),l}return e}getHeight(){return this.root===null?0:this.root.height}query(e,s){const r=e.bounds,a=l=>{if(l&&l.bounds.overlaps(r))if(l.isLeaf()&&l.data!==e){if(s.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}rayCastQuery(e,s=1/0,r){const a=l=>{if(l&&l.bounds.rayCast(e,s))if(l.isLeaf()){if(r.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}getNodes(){const e=s=>s?[s].concat(e(s.left),e(s.right)):[];return e(this.root)}debug(e){const s=r=>{r&&(r.isLeaf()?r.bounds.draw(e,Q.Green):r.bounds.draw(e,Q.White),r.left&&s(r.left),r.right&&s(r.right))};s(this.root)}}class dn{constructor(e,s){this.pos=e,this.dir=s.normalize()}intersect(e){const s=e.begin.sub(this.pos);if(this.dir.cross(e.getSlope())===0&&s.cross(this.dir)!==0)return-1;const r=this.dir.cross(e.getSlope());if(r===0)return-1;const a=s.cross(e.getSlope())/r;if(a>=0){const l=s.cross(this.dir)/r/e.getLength();if(l>=0&&l<=1)return a}return-1}intersectPoint(e){const s=this.intersect(e);return s<0?null:this.getPoint(s)}getPoint(e){return this.pos.add(this.dir.scale(e))}}class Wo{constructor(e){this._config=e,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new Dh(e.dynamicTree)}getColliders(){return this._colliders}query(e){const s=[];return e instanceof ht?this._dynamicCollisionTree.query({id:S("collider",-1),owner:null,bounds:e},r=>(s.push(r),!1)):this._dynamicCollisionTree.query({id:S("collider",-1),owner:null,bounds:new ht(e.x,e.y,e.x,e.y)},r=>(s.push(r),!1)),s}rayCast(e,s){var r,a,l;const f=[],g=(r=s?.maxDistance)!==null&&r!==void 0?r:1/0,m=s?.collisionGroup,w=m?m.category:(a=s?.collisionMask)!==null&&a!==void 0?a:xs.All.category,A=(l=s?.searchAllColliders)!==null&&l!==void 0?l:!1;return this._dynamicCollisionTree.rayCastQuery(e,g,y=>{const D=y.owner.get(Tt);if(s?.ignoreCollisionGroupAll&&D.group===xs.All)return!1;const L=(w&D.group.category)!==0;if(D?.group&&!L)return!1;const O=y.rayCast(e,g);if(O){if(s?.filter){if(s.filter(O)&&(f.push(O),!A))return!0}else if(f.push(O),!A)return!0}return!1}),f}track(e){if(!e){at.getInstance().warn("Cannot track null collider");return}if(e instanceof Ce){const s=e.getColliders();for(const r of s)r.owner=e.owner,this._colliders.push(r),this._dynamicCollisionTree.trackCollider(r)}else this._colliders.push(e),this._dynamicCollisionTree.trackCollider(e)}untrack(e){if(!e){at.getInstance().warn("Cannot untrack a null collider");return}if(e instanceof Ce){const s=e.getColliders();for(const r of s){const a=this._colliders.indexOf(r);a!==-1&&this._colliders.splice(a,1),this._dynamicCollisionTree.untrackCollider(r)}}else{const s=this._colliders.indexOf(e);s!==-1&&this._colliders.splice(s,1),this._dynamicCollisionTree.untrackCollider(e)}}_pairExists(e,s){const r=Qe.calculatePairHash(e.id,s.id);return this._pairs.has(r)}broadphase(e,s,r){const a=s/1e3,l=e.filter(g=>{var m,w;const A=(m=g.owner)===null||m===void 0?void 0:m.get(Tt);return((w=g.owner)===null||w===void 0?void 0:w.isActive)&&A.collisionType!==ft.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let f;for(let g=0,m=l.length;g<m;g++)f=l[g],this._dynamicCollisionTree.query(f,w=>{if(!this._pairExists(f,w)&&Qe.canCollide(f,w)){const A=new Qe(f,w);this._pairs.add(A.id),this._collisionPairCache.push(A)}return!1});if(r&&(r.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const g of l){const m=g.owner.get(Tt);if(m.collisionType!==ft.Active)continue;const w=m.vel.magnitude*a+m.acc.magnitude*.5*a*a,A=Math.min(g.bounds.height,g.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||w>A/2){r&&r.physics.fastBodies++;const y=m.globalPos.sub(m.oldPos),E=g.center,D=g.getFurthestPoint(m.vel),L=D.sub(y),O=new dn(L,m.vel);O.pos=O.pos.add(O.dir.scale(-2*this._config.continuous.surfaceEpsilon));let q,H=new B(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(O,w+this._config.continuous.surfaceEpsilon*2,V=>{if(!this._pairExists(g,V)&&Qe.canCollide(g,V)){const J=V.rayCast(O,w+this._config.continuous.surfaceEpsilon*10);if(J){const Y=J.point.sub(L);Y.magnitude<H.magnitude&&(H=Y,q=V)}}return!1}),q&&B.isValid(H)){const V=new Qe(g,q);this._pairs.has(V.id)||(this._pairs.add(V.id),this._collisionPairCache.push(V));const J=E.sub(D);m.globalPos=L.add(J).add(H).add(O.dir.scale(10*this._config.continuous.surfaceEpsilon)),g.update(m.transform.get()),r&&r.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(e,s){let r=[];for(let a=0;a<e.length;a++){const l=e[a].collide();if(r=r.concat(l),s&&l.length>0)for(const f of l)s.physics.contacts.set(f.id,f)}return s&&(s.physics.collisions+=r.length),r}update(e){let s=0;const r=e.length;for(let a=0;a<r;a++)this._dynamicCollisionTree.updateCollider(e[a])&&s++;return s}debug(e){this._dynamicCollisionTree.debug(e)}}class Vs{constructor(){this.id=S("collider",Vs._ID++),this.composite=null,this.events=new I,this.offset=B.Zero}touching(e){return!!this.collide(e)}}Vs._ID=0;var Er;(function(u){u.Arcade="arcade",u.Realistic="realistic"})(Er||(Er={}));var bs;(function(u){u.None="none",u.VerticalFirst="vertical-first",u.HorizontalFirst="horizontal-first"})(bs||(bs={}));const Fh={vertical:1,horizontal:2},Mh={horizontal:1,vertical:2},Bh={horizontal:0,vertical:0};var Xn;(function(u){u.DynamicTree="dynamic-tree",u.SparseHashGrid="sparse-hash-grid"})(Xn||(Xn={}));const As=()=>({enabled:!0,gravity:z(0,0).clone(),solver:Er.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:Xn.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:bs.None},realistic:{contactSolveBias:bs.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class Ce extends Vs{set compositeStrategy(e){this._compositeStrategy=e}get compositeStrategy(){return this._compositeStrategy}constructor(e){super(),this._collisionProcessor=new Wo({...As()}),this._dynamicAABBTree=new Dh({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const s of e)this.addCollider(s)}clearColliders(){this._colliders=[]}addCollider(e){let s;e instanceof Ce?(s=e.getColliders(),s.forEach(r=>r.offset.addEqual(e.offset))):s=[e];for(const r of s)r.events.pipe(this.events),r.composite=this,this._colliders.push(r),this._collisionProcessor.track(r),this._dynamicAABBTree.trackCollider(r)}removeCollider(e){e.events.pipe(this.events),e.composite=null,ps(e,this._colliders),this._collisionProcessor.untrack(e),this._dynamicAABBTree.untrackCollider(e)}getColliders(){return this._colliders}get worldPos(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:B.Zero).add(this.offset)}get center(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:B.Zero).add(this.offset)}get bounds(){var e,s;const r=this.getColliders();return r.reduce((l,f)=>l.combine(f.bounds),(s=(e=r[0])===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new ht().translate(this.worldPos)).translate(this.offset)}get localBounds(){var e,s;const r=this.getColliders();return r.reduce((l,f)=>l.combine(f.localBounds),(s=(e=r[0])===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new ht)}get axes(){const e=this.getColliders();let s=[];for(const r of e)s=s.concat(r.axes);return s}getFurthestPoint(e){const s=this.getColliders(),r=[];for(const f of s)r.push(f.getFurthestPoint(e));let a=r[0],l=-Number.MAX_VALUE;for(const f of r){const g=f.dot(e);g>l&&(a=f,l=g)}return a}getInertia(e){const s=this.getColliders();let r=0;for(const a of s)r+=a.getInertia(e);return r}collide(e){let s=[e];e instanceof Ce&&(s=e.getColliders());const r=[];for(const l of s)this._dynamicAABBTree.query(l,f=>(r.push(new Qe(l,f)),!1));let a=[];for(const l of r)a=a.concat(l.collide());return a}getClosestLineBetween(e){const s=this.getColliders(),r=[];if(e instanceof Ce){const a=e.getColliders();for(const l of s)for(const f of a){const g=l.getClosestLineBetween(f);g&&r.push(g)}}else for(const a of s){const l=e.getClosestLineBetween(a);l&&r.push(l)}if(r.length){let a=r[0].getLength(),l=r[0];for(const f of r){const g=f.getLength();g<a&&(a=g,l=f)}return l}return null}contains(e){const s=this.getColliders();for(const r of s)if(r.contains(e))return!0;return!1}rayCast(e,s){const r=this.getColliders(),a=[];for(const l of r){const f=l.rayCast(e,s);f&&a.push(f)}if(a.length){let l=a[0],f=l.point.dot(e.dir);for(const g of a){const m=e.dir.dot(g.point);m<f&&(l=g,f=m)}return l}return null}project(e){const s=this.getColliders(),r=[];for(const a of s){const l=a.project(e);l&&r.push(l)}if(r.length){const a=new Tr(r[0].min,r[0].max);for(const l of r)a.min=Math.min(l.min,a.min),a.max=Math.max(l.max,a.max);return a}return null}update(e){if(e){const s=this.getColliders();for(const r of s)r.owner=this.owner,r.update(e)}}debug(e,s,r){const a=this.getColliders();e.save(),e.translate(this.offset.x,this.offset.y);for(const l of a)l.debug(e,s,r);e.restore()}clone(){const e=new Ce(this._colliders.map(s=>s.clone()));return e.offset=this.offset.clone(),e}}class ce{constructor(e,s){this.begin=e,this.end=s}clone(e){const s=e||new ce(this.begin.clone(),this.end.clone());return s.begin=this.begin.clone(s.begin),s.end=this.end.clone(s.end),s}transform(e,s){const r=s||new ce(B.Zero,B.Zero);return r.begin=e.multiply(this.begin,r.begin),r.end=e.multiply(this.end,r.end),r}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const e=this.begin,s=this.end,r=e.distance(s);return this._slope=s.sub(e).scale(1/r)}getEdge(){const e=this.begin;return this.end.sub(e)}getLength(){const e=this.begin,s=this.end;return e.distance(s)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new ce(this.end,this.begin)}below(e){return(this.end.x-this.begin.x)*(e.y-this.begin.y)-(this.end.y-this.begin.y)*(e.x-this.begin.x)>=0}clip(e,s,r=!0){let a=e;r&&(a=a.normalize());const l=a.dot(this.begin)-s,f=a.dot(this.end)-s,g=[];if(l<=0&&g.push(this.begin),f<=0&&g.push(this.end),l*f<0){const m=l/(l-f);g.push(this.begin.add(this.end.sub(this.begin).scale(m)))}return g.length!==2?null:new ce(g[0],g[1])}distanceToPoint(e,s=!1){const r=e.x,a=e.y,l=this.getLength(),f=this.end.y-this.begin.y,g=this.end.x-this.begin.x,m=(f*r-g*a+this.end.x*this.begin.y-this.end.y*this.begin.x)/l;return s?m:Math.abs(m)}findVectorToPoint(e){const s=this.begin.sub(e),r=this.getSlope();return s.sub(r.scale(s.dot(r)))}findPoint(e=null,s=null){const r=this.slope,a=this.intercept;if(e!==null)return new B(e,r*e+a);if(s!==null)return new B((s-a)/r,s);throw new Error("You must provide an X or a Y value")}hasPoint(){let e,s=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")e=new B(arguments[0],arguments[1]),s=arguments[2]||0;else if(arguments[0]instanceof B)e=arguments[0],s=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const r=e.x-this.begin.x,a=e.y-this.begin.y,l=this.end.x-this.begin.x,f=this.end.y-this.begin.y,g=r*f-a*l;return Math.abs(g)>s?!1:Math.abs(l)>=Math.abs(f)?l>0?this.begin.x<=e.x&&e.x<=this.end.x:this.end.x<=e.x&&e.x<=this.begin.x:f>0?this.begin.y<=e.y&&e.y<=this.end.y:this.end.y<=e.y&&e.y<=this.begin.y}}function kh(u,e){const r=u.dir(),a=e.dir(),l=r.dot(r),f=a.dot(a);if(l<1e-9&&f<1e-9)return new ce(u.begin,e.begin);if(l<1e-9){const q=j(a.dot(u.begin.sub(e.begin))/f,0,1),H=e.begin.add(a.scale(q));return new ce(u.begin,H)}if(f<1e-9){const q=j(r.dot(e.begin.sub(u.begin))/l,0,1),H=u.begin.add(r.scale(q));return new ce(H,e.begin)}const g=u.begin.sub(e.begin),m=l,w=f,A=a.dot(g),y=m*w-Math.pow(r.dot(a),2);let E=0,D=0;Math.abs(y)>1e-9?E=j((r.dot(a)*A-w*r.dot(g))/y,0,1):E=j(r.dot(g)/m,0,1),Math.abs(w)>1e-9?D=j((r.dot(a)*E+A)/w,0,1):D=0;const L=u.begin.add(r.scale(E)),O=e.begin.add(a.scale(D));return new ce(L,O)}const ji={PolygonPolygonClosestLine(u,e){const s=u.getSides(),r=e.getSides();let a=Number.MAX_VALUE,l=null;for(let f=0;f<s.length;f++)for(let g=0;g<r.length;g++){const m=kh(s[f],r[g]),w=m.getLength();w<a&&(a=w,l=m)}return l},PolygonEdgeClosestLine(u,e){const r=e.worldPos.sub(u.worldPos),a=new dn(u.worldPos,r),l=u.rayCast(a).point.add(a.dir.scale(.1)),f=u.getClosestFace(l),g=e.asLine();return kh(f.face,g)},PolygonCircleClosestLine(u,e){const s=e.worldPos,r=s.sub(u.worldPos),a=new dn(u.worldPos,r.normalize()),l=u.rayCast(a).point.add(a.dir.scale(.1)),f=u.getClosestFace(l),g=f.face.begin,m=f.face.getEdge();let w=(m.x*(s.x-g.x)+m.y*(s.y-g.y))/(m.x*m.x+m.y*m.y);w>1?w=1:w<0&&(w=0);const A=Math.sqrt(Math.pow(g.x+m.x*w-s.x,2)+Math.pow(g.y+m.y*w-s.y,2))-e.radius,y=(g.x+m.x*w-s.x)*e.radius/(e.radius+A),E=(g.y+m.y*w-s.y)*e.radius/(e.radius+A);return new ce(m.scale(w).add(g),new B(s.x+y,s.y+E))},CircleCircleClosestLine(u,e){const r=e.worldPos.sub(u.worldPos),l=u.worldPos.sub(e.worldPos),f=new dn(u.worldPos,r),g=new dn(e.worldPos,l),m=u.rayCast(f),w=e.rayCast(g);return new ce(m.point,w.point)},CircleEdgeClosestLine(u,e){const s=u.worldPos,r=e.asLine(),a=r.begin,l=r.getEdge(),f=a,g=l;let m=(g.x*(s.x-f.x)+g.y*(s.y-f.y))/(g.x*g.x+g.y*g.y);m>1?m=1:m<0&&(m=0);const w=Math.sqrt(Math.pow(f.x+g.x*m-s.x,2)+Math.pow(f.y+g.y*m-s.y,2))-u.radius,A=(f.x+g.x*m-s.x)*u.radius/(u.radius+w),y=(f.y+g.y*m-s.y)*u.radius/(u.radius+w);return new ce(g.scale(m).add(f),new B(s.x+A,s.y+y))},EdgeEdgeClosestLine(u,e){const s=u.asLine(),r=e.asLine();return kh(s,r)}};class We extends Vs{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var e;if(this._radius)return this._radius;const s=this._transform,r=(e=s?.globalScale)!==null&&e!==void 0?e:B.One;return this._radius=this._naturalRadius*Math.min(r.x,r.y)}set radius(e){var s;const r=this._transform,a=(s=r?.globalScale)!==null&&s!==void 0?s:B.One;this._naturalRadius=e/Math.min(a.x,a.y),this._localBoundsDirty=!0,this._radius=e}constructor(e){super(),this.offset=B.Zero,this._globalMatrix=fe.identity(),this._localBoundsDirty=!0,this.offset=e.offset||B.Zero,this.radius=e.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new We({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(e){var s,r;return((r=(s=this._transform)===null||s===void 0?void 0:s.pos)!==null&&r!==void 0?r:this.offset).distance(e)<=this.radius}rayCast(e,s=1/0){var r,a;const l=this.center,f=e.dir,g=e.pos,m=l.sub(g),w=f.scale(m.dot(f)),y=m.sub(w).magnitude;if(y>this.radius)return null;{let E=0;if(X(y,this.radius,1e-4)){if(E=-f.dot(g.sub(l)),E>0&&E<s){const D=e.getPoint(E);return{point:D,normal:D.sub(l).normalize(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(Tt),distance:E}}return null}else{const D=Math.sqrt(Math.pow(f.dot(g.sub(l)),2)-Math.pow(g.sub(l).distance(),2)+Math.pow(this.radius,2)),L=-f.dot(g.sub(l))+D,O=-f.dot(g.sub(l))-D,q=[];L>=0&&q.push(L),O>=0&&q.push(O);const H=Math.min(...q);if(H<=s){const V=e.getPoint(H);return{point:V,normal:V.sub(l).normalize(),collider:this,body:(a=this.owner)===null||a===void 0?void 0:a.get(Tt),distance:H}}return null}}}getClosestLineBetween(e){if(e instanceof We)return ji.CircleCircleClosestLine(this,e);if(e instanceof Fe)return ji.PolygonCircleClosestLine(e,this).flip();if(e instanceof fi)return ji.CircleEdgeClosestLine(this,e).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof We)return Li.CollideCircleCircle(this,e);if(e instanceof Fe)return Li.CollideCirclePolygon(this,e);if(e instanceof fi)return Li.CollideCircleEdge(this,e);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){return this.center.add(e.normalize().scale(this.radius))}getFurthestLocalPoint(e){return e.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new ht(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(e){return e*this.radius*this.radius/2}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(e){const s=[],a=this.center.dot(e);return s.push(a),s.push(a+this.radius),s.push(a-this.radius),new Tr(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s,r){var a,l,f,g;const{lineWidth:m}={lineWidth:1,...r},w=this._transform,A=(a=w?.globalScale)!==null&&a!==void 0?a:B.One,y=(l=w?.globalRotation)!==null&&l!==void 0?l:0,E=(f=w?.globalPos)!==null&&f!==void 0?f:B.Zero;e.save(),e.translate(E.x,E.y),e.rotate(y),e.scale(A.x,A.y),e.drawCircle((g=this.offset)!==null&&g!==void 0?g:B.Zero,this._naturalRadius,Q.Transparent,s,m),e.restore()}}class un{constructor(e,s,r,a,l,f,g,m){var w,A,y,E,D,L;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=e,this.colliderB=s,this.mtv=r,this.normal=a,this.tangent=l,this.points=f,this.localPoints=g,this.info=m,this.id=Qe.calculatePairHash(e.id,s.id),e.composite||s.composite){const O=((w=e.composite)===null||w===void 0?void 0:w.compositeStrategy)==="separate"?e.id:(y=(A=e.composite)===null||A===void 0?void 0:A.id)!==null&&y!==void 0?y:e.id,q=((E=s.composite)===null||E===void 0?void 0:E.compositeStrategy)==="separate"?s.id:(L=(D=s.composite)===null||D===void 0?void 0:D.id)!==null&&L!==void 0?L:s.id;this.id+="|"+Qe.calculatePairHash(O,q)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(Tt)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(Tt))}matchAwake(){const e=this.bodyA,s=this.bodyB;e&&s&&e.isSleeping!==s.isSleeping&&(e.isSleeping&&e.collisionType!==ft.Fixed&&s.sleepMotion>=e.wakeThreshold&&(e.isSleeping=!1),s.isSleeping&&s.collisionType!==ft.Fixed&&e.sleepMotion>=s.wakeThreshold&&(s.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(e){if(e!==this.colliderA&&e!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(e===this.colliderA)return this;const s=this.colliderA,r=this.colliderB;return this.colliderB=s,this.colliderA=r,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class Ad{constructor(){this.axis=z(0,0),this.localAxis=z(0,0),this.side=new ce(z(0,0),z(0,0)),this.localSide=new ce(z(0,0),z(0,0)),this.point=z(0,0),this.localPoint=z(0,0)}}class ge{static findPolygonPolygonSeparation(e,s){if(s.transform.matrix.determinant()===0)return ge.findPolygonPolygonSeparationDegenerate(e,s);let r=-Number.MAX_VALUE,a=-1,l;const f=s.transform.inverse.multiply(e.transform.matrix,ge._SCRATCH_MATRIX),g=f.getRotation(),m=e.normals,w=e.points,A=s.points;for(let D=0;D<w.length;D++){const L=m[D].rotate(g,ge._ZERO,ge._SCRATCH_NORMAL),O=f.multiply(w[D],ge._SCRATCH_POINT);let q=Number.MAX_VALUE,H;for(let V=0;V<A.length;V++){const J=L.dot(A[V].sub(O,ge._SCRATCH_SUB_POINT));J<q&&(q=J,H=A[V])}q>r&&(r=q,a=D,l=H)}const y=(a+1)%w.length,E=ge.SeparationPool.get();return E.collider=e,E.separation=r,r>0||(m[a].clone(E.localAxis),m[a].rotate(e.transform.rotation,ge._ZERO,E.axis),e.transform.matrix.multiply(w[a],E.side.begin),e.transform.matrix.multiply(w[y],E.side.end),s.transform.matrix.multiply(l,E.point),E.sideId=a,l.clone(E.localPoint),w[a].clone(E.localSide.begin),w[y].clone(E.localSide.end)),E}static findCirclePolygonSeparation(e,s){const r=s.axes,l=s.center.sub(e.worldPos),f=s.getFurthestPoint(l.negate());r.push(f.sub(e.worldPos).normalize());let g=Number.MAX_VALUE,m=null,w=-1;for(let A=0;A<r.length;A++){const y=s.project(r[A]),E=e.project(r[A]),D=y.getOverlap(E);if(D<=0)return null;D<g&&(g=D,m=r[A],w=A)}return w<0?null:m.normalize().scale(g)}static findPolygonPolygonSeparationDegenerate(e,s){let r=-Number.MAX_VALUE,a=null,l=null,f=-1,g=null;const m=e.getSides(),w=e.getLocalSides();for(let A=0;A<m.length;A++){const y=m[A],E=y.normal(),D=s.getFurthestPoint(E.negate()),L=y.distanceToPoint(D,!0);L>r&&(r=L,a=y,l=E,f=A,g=D)}return{collider:e,separation:l?r:99,axis:l,side:a,localSide:w[f],sideId:f,point:g,localPoint:l?s.getFurthestLocalPoint(l.negate()):null}}}ge.SeparationPool=new So(()=>new Ad,u=>u,500),ge._ZERO=z(0,0),ge._SCRATCH_POINT=z(0,0),ge._SCRATCH_SUB_POINT=z(0,0),ge._SCRATCH_NORMAL=z(0,0),ge._SCRATCH_MATRIX=fe.identity(),ge.SeparationPool.disableWarnings=!0;const kp=B.Zero,Lp=B.Zero,Up=fe.identity(),Li={CollideCircleCircle(u,e){const s=u.worldPos,r=e.worldPos,a=u.radius+e.radius,l=s.distance(r);if(l>a)return[];const f=a-l,g=r.sub(s).normalize(),m=g.perpendicular(),w=g.scale(f),A=u.getFurthestPoint(g),y=u.getFurthestLocalPoint(g),E={collider:u,separation:f,axis:g,point:A};return[new un(u,e,w,g,m,[A],[y],E)]},CollideCirclePolygon(u,e){var s,r;let a=ge.findCirclePolygonSeparation(u,e);if(!a)return[];a=a.dot(e.center.sub(u.center))<0?a.negate():a;const f=u.getFurthestPoint(a),m=((r=(s=u.owner)===null||s===void 0?void 0:s.get(it))!==null&&r!==void 0?r:new it).applyInverse(f),w=a.normalize(),A={collider:u,separation:-a.magnitude,axis:w,point:f,localPoint:m,side:e.findSide(w.negate()),localSide:e.findLocalSide(w.negate())};return[new un(u,e,a,w,w.perpendicular(),[f],[m],A)]},CollideCircleEdge(u,e){const s=u.center,r=e.asLine(),a=r.end.sub(r.begin),l=a.dot(r.end.sub(s)),f=a.dot(s.sub(r.begin)),g=e.asLine(),m=e.asLocalLine();if(f<=0){const H=r.begin.sub(s),V=H.dot(H);if(V>u.radius*u.radius)return[];const J=H.normalize(),Y=u.radius-Math.sqrt(V),$={collider:u,separation:Y,axis:J,point:g.begin,side:g,localSide:m};return[new un(u,e,J.scale(Y),J,J.perpendicular(),[g.begin],[m.begin],$)]}if(l<=0){const H=r.end.sub(s),V=H.dot(H);if(V>u.radius*u.radius)return[];const J=H.normalize(),Y=u.radius-Math.sqrt(V),$={collider:u,separation:Y,axis:J,point:g.end,side:g,localSide:m};return[new un(u,e,J.scale(Y),J,J.perpendicular(),[g.end],[m.end],$)]}const w=a.dot(a),A=r.begin.scale(l).add(r.end.scale(f)).scale(1/w),y=s.sub(A),E=y.dot(y);if(E>u.radius*u.radius)return[];let D=a.perpendicular();D.dot(s.sub(r.begin))<0&&(D.x=-D.x,D.y=-D.y),D=D.normalize();const L=u.radius-Math.sqrt(E),O=D.scale(L),q={collider:u,separation:L,axis:D,point:A,side:g,localSide:m};return[new un(u,e,O,D.negate(),D.negate().perpendicular(),[A],[A.sub(e.worldPos)],q)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(u,e){var s;const r=u.center,l=e.center.sub(r).normalize(),f=new Fe({points:[e.begin,e.end,e.end.add(l.scale(100)),e.begin.add(l.scale(100))],offset:e.offset});f.owner=e.owner,((s=e.owner)===null||s===void 0?void 0:s.get(it))&&f.update(e.owner.get(it).get());const m=this.CollidePolygonPolygon(u,f);return m.length&&(m[0].colliderB=e,m[0].id=Qe.calculatePairHash(u.id,e.id)),m},CollidePolygonPolygon(u,e){const s=ge.findPolygonPolygonSeparation(u,e);if(s.separation>0)return[];const r=ge.findPolygonPolygonSeparation(e,u);if(r.separation>0)return[];const a=s.separation>r.separation?s:r,l=a.collider===u?e:u,f=a.collider===u?u:e,g=l.transform.inverse.multiply(f.transform.matrix,Up),m=g.getRotation(),w=f.normals[a.sideId].rotate(m,kp,Lp);let A=Number.MAX_VALUE,y=0;for(let H=0;H<l.normals.length;H++){const V=w.dot(l.normals[H]);V<A&&(A=V,y=H)}if(!a.localSide||!a.localAxis||!a.axis)return[];const E=a.localSide.transform(g),D=a.localAxis.perpendicular().negate().rotate(m),O=new ce(l.points[y],l.points[(y+1)%l.points.length]).clip(D.negate(),-D.dot(E.begin),!1);let q=null;if(O&&(q=O.clip(D,D.dot(E.end),!1)),q){const H=[],V=[],J=q.getPoints();for(let ot=0;ot<J.length;ot++){const Z=J[ot];E.below(Z)&&(H.push(Z),V.push(l.transform.apply(Z)))}let Y=a.axis,$=Y.perpendicular();return e.center.sub(u.center).dot(Y)<0&&(Y=Y.negate(),$=Y.perpendicular()),[new un(u,e,Y.scale(-a.separation),Y,$,V,H,a)]}return[]},FindContactSeparation(u,e){var s,r,a,l;const f=u.colliderA,g=(r=(s=u.bodyA)===null||s===void 0?void 0:s.transform)!==null&&r!==void 0?r:new it,m=u.colliderB,w=(l=(a=u.bodyB)===null||a===void 0?void 0:a.transform)!==null&&l!==void 0?l:new it;if(f instanceof We&&m instanceof We){const A=f.radius+m.radius,y=g.pos.distance(w.pos);return-(A-y)}if(f instanceof Fe&&m instanceof Fe&&u.info.localSide){let A,y;return u.info.collider===f?(A=new ce(g.apply(u.info.localSide.begin).add(f.offset),g.apply(u.info.localSide.end).add(f.offset)),y=w.apply(e).add(m.offset)):(A=new ce(w.apply(u.info.localSide.begin).add(m.offset),w.apply(u.info.localSide.end).add(m.offset)),y=g.apply(e).add(f.offset)),A.distanceToPoint(y,!0)}if(f instanceof Fe&&m instanceof We||m instanceof Fe&&f instanceof We){const A=g.apply(e);if(u.info.side)return u.info.side.distanceToPoint(A,!0)}if(f instanceof fi&&m instanceof Fe||m instanceof fi&&f instanceof Fe){let A;if(u.info.collider===f?A=w.apply(e):A=g.apply(e),u.info.side)return u.info.side.distanceToPoint(A,!0)}if(f instanceof We&&m instanceof fi||m instanceof We&&f instanceof fi){const A=w.apply(e);let y;f instanceof We&&(y=f.getFurthestPoint(u.normal));const E=A.distance(y);if(u.info.side)return E>0?-E:0}return 0}};class fi extends Vs{constructor(e){var s;super(),this._globalMatrix=fe.identity(),this.begin=e.begin||B.Zero,this.end=e.end||B.Zero,this.offset=(s=e.offset)!==null&&s!==void 0?s:B.Zero}clone(){return new fi({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var e;const s=this._transform;return(e=s?.globalPos.add(this.offset))!==null&&e!==void 0?e:this.offset}get center(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.average(s)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const e=this._getTransformedBegin(),s=this._getTransformedEnd(),r=e.distance(s);return s.sub(e).scale(1/r)}getLength(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.distance(s)}contains(){return!1}rayCast(e,s=1/0){var r;const a=this._getTransformedBegin().sub(e.pos);if(e.dir.cross(this.getSlope())===0&&a.cross(e.dir)!==0)return null;const l=e.dir.cross(this.getSlope());if(l===0)return null;const f=a.cross(this.getSlope())/l;if(f>=0&&f<=s){const g=a.cross(e.dir)/l/this.getLength();if(g>=0&&g<=1)return{distance:f,normal:this.asLine().normal(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(Tt),point:e.getPoint(f)}}return null}getClosestLineBetween(e){if(e instanceof We)return ji.CircleEdgeClosestLine(e,this);if(e instanceof Fe)return ji.PolygonEdgeClosestLine(e,this).flip();if(e instanceof fi)return ji.EdgeEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof We)return Li.CollideCircleEdge(e,this);if(e instanceof Fe)return Li.CollidePolygonEdge(e,this);if(e instanceof fi)return Li.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this._getTransformedBegin(),r=this._getTransformedEnd();return e.dot(s)>0?s:r}_boundsFromBeginEnd(e,s,r=10){return new ht(Math.min(e.x,s.x)-r,Math.min(e.y,s.y)-r,Math.max(e.x,s.x)+r,Math.max(e.y,s.y)+r)}get bounds(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return this._boundsFromBeginEnd(e,s)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new ce(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new ce(this.begin,this.end)}get axes(){const s=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),r=[];return r.push(s),r.push(s.negate()),r.push(s.normal()),r.push(s.normal().negate()),r}getInertia(e){const s=this.end.sub(this.begin).distance()/2;return e*s*s}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(e){const s=[],r=[this._getTransformedBegin(),this._getTransformedEnd()],a=r.length;for(let l=0;l<a;l++)s.push(r[l].dot(e));return new Tr(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s){const r=this._getTransformedBegin(),a=this._getTransformedEnd();e.drawLine(r,a,s,2),e.drawCircle(r,2,s),e.drawCircle(a,2,s)}}class Se{static registerGraphicsContext(e){Se._ctx=e}static draw(e){this._drawCalls.push(e)}static drawPoint(e,s){Se.draw(r=>{r.debug.drawPoint(e,s)})}static drawLine(e,s,r){Se.draw(a=>{a.debug.drawLine(e,s,r)})}static drawLines(e,s){e.length>1&&Se.draw(r=>{for(let a=0;a<e.length-1;a++)r.debug.drawLine(e[a],e[a+1],s)})}static drawText(e,s){Se.draw(r=>{r.debug.drawText(e,s)})}static drawPolygon(e,s){e.length>1&&Se.draw(r=>{const a=e[0],l=[...e,a];for(let f=0;f<l.length-1;f++)r.debug.drawLine(l[f],l[f+1],s)})}static drawCircle(e,s,r){const{color:a,strokeColor:l,width:f}={color:Q.Black,strokeColor:void 0,width:void 0,...r};Se.draw(g=>{g.drawCircle(e,s,a,l,f)})}static drawBounds(e,s){Se.draw(r=>{r.debug.drawRect(e.left,e.top,e.width,e.height,s)})}static drawRay(e,s){const{distance:r,color:a}={color:Q.Blue,distance:10,...s};Se.draw(l=>{const f=e.pos,g=e.pos.add(e.dir.scale(r));l.debug.drawLine(f,g,{color:a})})}static flush(e){e.save(),e.z=Se.z;for(const s of Se._drawCalls)s(e);e.restore(),Se.clear()}static clear(){Se._drawCalls.length=0}}Se._drawCalls=[],Se.z=1/0;class Fe extends Vs{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(e){if(e.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=e,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const e=[];for(let s=0;s<this._points.length;s++)e.push(this._points[(s+1)%this._points.length].sub(this._points[s]).normal());this._normals=e}get points(){return this._points}get transform(){return this._transform}constructor(e){var s;super(),this._logger=at.getInstance(),this._transform=new vs,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(s=e.offset)!==null&&s!==void 0?s:B.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=e.points,this.isConvex()||e.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(e){this._isCounterClockwiseWinding(e)||e.reverse()}_isCounterClockwiseWinding(e){let s=0;for(let r=0;r<e.length;r++)s+=(e[(r+1)%e.length].x-e[r].x)*(e[(r+1)%e.length].y+e[r].y);return s<0}isConvex(){if(this.points.length<3)return!1;let e=this.points[this.points.length-2],s=this.points[this.points.length-1],r=Math.atan2(s.y-e.y,s.x-e.x),a=0,l=0,f=0;for(const[g,m]of this.points.entries()){if(e=s,a=r,s=m,r=Math.atan2(s.y-e.y,s.x-e.x),e.equals(s))return!1;let w=r-a;if(w<=-Math.PI?w+=Math.PI*2:w>Math.PI&&(w-=Math.PI*2),g===0){if(w===0)return!1;l=w>0?1:-1}else if(l*w<=0)return!1;f+=w}return Math.abs(Math.round(f/(Math.PI*2)))===1}tessellate(){const e=[];for(let s=1;s<this.points.length-2;s++)e.push([this.points[0],this.points[s+1],this.points[s+2]]);return e.push([this.points[0],this.points[1],this.points[2]]),new Ce(e.map(s=>Ve.Polygon(s)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const e=[],s=[...this.points].reverse();let r=s.length;function a(y){return y===0?r-1:y-1}function l(y){return y===r-1?0:y+1}function f(y){const E=a(y),D=l(y),L=s[E],O=s[y],q=s[D],H=L.sub(O),V=q.sub(O);return!(H.cross(V)<0)}const g=s.map((y,E)=>f(E));function m(y,E,D,L){const O=D.sub(E),q=L.sub(D),H=E.sub(L),V=y.sub(E),J=y.sub(D),Y=y.sub(L),$=O.cross(V),ot=q.cross(J),Z=H.cross(Y);return!($>0||ot>0||Z>0)}function w(){for(let y=0;y<r;y++)if(g[y]){const E=a(y),D=l(y),L=s[E],O=s[y],q=s[D];let H=!0;for(let V=0;V<r;V++){if(V===y||V===E||V===D)continue;const J=s[V];if(m(J,L,O,q)){H=!1;break}}if(H)return y}for(let y=0;y<r;y++)if(g[y])return y;return 0}function A(y){const E=a(y),D=l(y),L=s[E],O=s[y],q=s[D];e.push([L,O,q]),s.splice(y,1),g.splice(y,1),r--}for(;r>3;){const y=w();A(y);for(let E=0;E<r;E++)g[E]=f(E)}return e.push([s[0],s[1],s[2]]),new Ce(e.map(y=>Ve.Polygon(y,B.Zero,!0)))}clone(){return new Fe({offset:this.offset.clone(),points:this.points.map(e=>e.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const e=this.points,s=e.length;this._transformedPoints.length=0;for(let r=0;r<s;r++)this._transformedPoints[r]=this._transform.apply(e[r].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const e=[],s=this.getTransformedPoints(),r=s.length;for(let a=0;a<r;a++)e.push(new ce(s[a],s[(a+1)%r]));this._sides=e,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const e=[],s=this.points,r=s.length;for(let a=0;a<r;a++)e.push(new ce(s[a],s[(a+1)%r]));this._localSides=e,this._localSidesDirty=!1}return this._localSides}findSide(e){const s=this.getSides();let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=s[l],m=f.normal().dot(e);m>a&&(r=f,a=m)}return r}findLocalSide(e){const s=this.getLocalSides();let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=s[l],m=f.normal().dot(e);m>a&&(r=f,a=m)}return r}get axes(){const e=[],s=this.getSides();for(let r=0;r<s.length;r++)e.push(s[r].normal());return e}update(e){e&&(e.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(s=>z(s.x*G(this._transform.scale.x),s.y*G(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(e){const s=this._transform.applyInverse(e),r=new dn(s,new B(1,0));let a=0;const l=this.getLocalSides();for(let f=0;f<l.length;f++){const g=l[f];r.intersect(g)>=0&&a++}return a%2!==0}getClosestLineBetween(e){if(e instanceof We)return ji.PolygonCircleClosestLine(this,e);if(e instanceof Fe)return ji.PolygonPolygonClosestLine(this,e);if(e instanceof fi)return ji.PolygonEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof We)return Li.CollideCirclePolygon(e,this);if(e instanceof Fe)return Li.CollidePolygonPolygon(this,e);if(e instanceof fi)return Li.CollidePolygonEdge(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this.getTransformedPoints();let r=null,a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=e.dot(s[l]);f>a&&(a=f,r=s[l])}return r}getFurthestLocalPoint(e){const s=this.points;let r=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const f=e.dot(s[l]);f>a&&(a=f,r=s[l])}return r}getClosestFace(e){const s=this.getSides();let r=Number.POSITIVE_INFINITY,a=-1,l=-1;for(let f=0;f<s.length;f++){const g=s[f].distanceToPoint(e);g<r&&(r=g,a=f,l=g)}return a!==-1?{distance:s[a].normal().scale(l),face:s[a]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=ht.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(e){if(this._cachedMass===e&&this._cachedInertia)return this._cachedInertia;let s=0,r=0;const a=this.points;for(let l=0;l<a.length;l++){const f=(l+1)%a.length,g=a[f].cross(a[l]);s+=g*(a[l].dot(a[l])+a[l].dot(a[f])+a[f].dot(a[f])),r+=g}return this._cachedMass=e,this._cachedInertia=e/6*(s/r)}rayCast(e,s=1/0){var r;const a=this.getSides(),l=a.length;let f=Number.MAX_VALUE,g,m=-1;for(let w=0;w<l;w++){const A=e.intersect(a[w]);A>=0&&A<f&&A<=s&&(f=A,g=a[w],m=w)}return m>=0?{collider:this,distance:f,body:(r=this.owner)===null||r===void 0?void 0:r.get(Tt),point:e.getPoint(f),normal:g.normal()}:null}project(e){const s=this.getTransformedPoints(),r=s.length;let a=Number.MAX_VALUE,l=-Number.MAX_VALUE;for(let f=0;f<r;f++){const g=s[f].dot(e);a=Math.min(a,g),l=Math.max(l,g)}return new Tr(a,l)}debug(e,s,r){const a=this.getTransformedPoints();Se.drawPolygon(a,{color:s})}}class Ve{static Box(e,s,r=B.Half,a=B.Zero){return new Fe({points:new ht(-e*r.x,-s*r.y,e-e*r.x,s-s*r.y).getPoints(),offset:a})}static Polygon(e,s=B.Zero,r=!1){return new Fe({points:e,offset:s,suppressConvexWarning:r})}static Circle(e,s=B.Zero){return new We({radius:e,offset:s})}static Edge(e,s){return new fi({begin:e,end:s})}static Capsule(e,s,r=B.Zero){const a=at.getInstance();return e===s&&a.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),s>=e?new Ce([Ve.Circle(e/2,z(0,-s/2+e/2).add(r)),Ve.Box(e,s-e,B.Half,r),Ve.Circle(e/2,z(0,s/2-e/2).add(r))]):new Ce([Ve.Circle(s/2,z(-e/2+s/2,0).add(r)),Ve.Box(e-s,s,B.Half,r),Ve.Circle(s/2,z(e/2-s/2,0).add(r))])}}class pe extends Si{constructor(e){super(),this.events=new I,this.$colliderAdded=new je,this.$colliderRemoved=new je,this._collidersToRemove=[],this.set(e)}get(){return this._collider}set(e){return this.clear(),e&&(this._collider=e,this._collider.owner=this.owner,e.events.pipe(this.events),this.$colliderAdded.notifyAll(e),this.update()),e}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const e of this._collidersToRemove)e.events.unpipe(this.events),this.$colliderRemoved.notifyAll(e),e.owner=null}clone(){return new pe(this._collider.clone())}get bounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new ht}get localBounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new ht}update(){var e;const s=(e=this.owner)===null||e===void 0?void 0:e.get(it);this._collider&&(this._collider.owner=this.owner,s&&this._collider.update(s.get()))}collide(e){let s=this._collider,r=e._collider;if(!s||!r)return[];let a=!1;if(r instanceof Ce&&(s=r,r=this._collider,a=!0),this._collider){const l=s.collide(r);return l?(a&&l.forEach(f=>{f.mtv=f.mtv.negate(),f.normal=f.normal.negate(),f.tangent=f.normal.perpendicular(),f.colliderA=this._collider,f.colliderB=e._collider}),l):[]}return[]}onAdd(e){this._collider&&this.update(),this.events.on("precollision",s=>{const r=s;e.events.emit("precollision",new on(r.self,r.other,r.side,r.intersection,r.contact)),e instanceof Je&&e.onPreCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("postcollision",s=>{const r=s;e.events.emit("postcollision",new an(r.self,r.other,r.side,r.intersection,r.contact)),e instanceof Je&&e.onPostCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("collisionstart",s=>{const r=s;e.events.emit("collisionstart",new yr(r.self,r.other,r.side,r.contact)),e instanceof Je&&e.onCollisionStart(r.self,r.other,r.side,r.contact)}),this.events.on("collisionend",s=>{const r=s;e.events.emit("collisionend",new Cr(r.self,r.other,r.side,r.lastContact)),e instanceof Je&&e.onCollisionEnd(r.self,r.other,r.side,r.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(e,s,r=B.Half,a=B.Zero){const l=Ve.Box(e,s,r,a);return this.set(l)}usePolygonCollider(e,s=B.Zero){const r=Ve.Polygon(e,s);return this.set(r)}useCircleCollider(e,s=B.Zero){const r=Ve.Circle(e,s);return this.set(r)}useEdgeCollider(e,s){const r=Ve.Edge(e,s);return this.set(r)}useCompositeCollider(e){return this.set(new Ce(e))}}var ri;(function(u){u.Rotation="rotation",u.X="x",u.Y="y"})(ri||(ri={}));class Tt extends Si{constructor(e){var s,r,a;super(),this.dependencies=[it,Bt],this.id=S("body",Tt._ID++),this.events=new I,this.oldTransform=new vs,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=ft.PreventCollision,this.group=xs.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=B.Zero,this.oldVel=new B(0,0),this.oldAcc=B.Zero,this._impulseScratch=z(0,0),this._distanceFromCenterScratch=z(0,0),e?(this.collisionType=(s=e.type)!==null&&s!==void 0?s:this.collisionType,this.group=(r=e.group)!==null&&r!==void 0?r:this.group,this.useGravity=(a=e.useGravity)!==null&&a!==void 0?a:this.useGravity,this._bodyConfig={...As().bodies,...e.config}):this._bodyConfig={...As().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=Tt._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(e){this._bodyConfig={...As().bodies,...e},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(e){Tt._DEFAULT_CONFIG=e}get mass(){return this._mass}set mass(e){this._mass=e,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===ft.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(e){this.isSleeping=e}set isSleeping(e){this._sleeping=e,e?(this.vel=B.Zero,this.acc=B.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const e=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),s=this._bodyConfig.sleepBias;this.sleepMotion=s*this.sleepMotion+(1-s)*e,this.sleepMotion=j(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const e=this.owner.get(pe);if(e){e.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),e.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const s=e.get();if(s)return this._cachedInertia=s.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===ft.Fixed?0:1/this.inertia}get active(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get isActive(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get center(){return this.globalPos}onAdd(e){var s,r;this.transform=(s=this.owner)===null||s===void 0?void 0:s.get(it),this.motion=(r=this.owner)===null||r===void 0?void 0:r.get(Bt)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get globalPos(){return this.transform.globalPos}set globalPos(e){this.transform.globalPos=e}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e}get torque(){return this.motion.torque}set torque(e){this.motion.torque=e}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(e){this.transform.globalRotation=e}get scale(){return this.transform.globalScale}set scale(e){this.transform.globalScale=e}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(e){this.motion.scaleFactor=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}applyImpulse(e,s){if(this.collisionType!==ft.Active)return;const r=s.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(ri.X)>-1&&(r.x=0),this.limitDegreeOfFreedom.indexOf(ri.Y)>-1&&(r.y=0),this.vel.addEqual(r),!this.limitDegreeOfFreedom.includes(ri.Rotation)){const a=e.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*a.cross(s)}}applyLinearImpulse(e){if(this.collisionType!==ft.Active)return;const s=e.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(ri.X)&&(s.x=0),this.limitDegreeOfFreedom.includes(ri.Y)&&(s.y=0),this.vel=this.vel.add(s)}applyAngularImpulse(e,s){if(this.collisionType===ft.Active&&!this.limitDegreeOfFreedom.includes(ri.Rotation)){const r=e.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*r.cross(s)}}captureOldTransform(){this.__oldTransformCaptured=!0;const e=this.transform.get();e.clone(this.oldTransform),this.oldTransform.parent=e.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}Tt._ID=0,Tt._DEFAULT_CONFIG={...As().bodies};class Ir extends On{constructor(e){super(e),this.width=e.width,this.height=e.height,this.rasterize()}clone(){return new Ir({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.color&&e.fillRect(0,0,this.width,this.height),this.strokeColor&&e.strokeRect(0,0,this.width,this.height)}}class Vo extends On{get radius(){return this._radius}set radius(e){this._radius=e,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(e){var s,r,a;super(e),this._radius=0;const l=(s=e.lineWidth)!==null&&s!==void 0?s:e.strokeColor?1:0;this.padding=(r=e.padding)!==null&&r!==void 0?r:2+l/2,this.radius=e.radius,this.filtering=(a=e.filtering)!==null&&a!==void 0?a:_e.Blended,this.rasterize()}clone(){return new Vo({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.radius>0&&(e.beginPath(),e.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&e.fill(),this.strokeColor&&e.stroke())}}class Ns extends Si{constructor(e){var s,r;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(s=e?.useColliderShape)!==null&&s!==void 0?s:this.useColliderShape,this.useGraphicsBounds=(r=e?.useGraphicsBounds)!==null&&r!==void 0?r:this.useGraphicsBounds,this.localBounds=e?.localBounds}}class Gt{static CreateReversibleEasingFunction(e){return(s,r,a,l)=>a<r?r-(e(s,a,r,l)-a):e(s,r,a,l)}static CreateVectorEasingFunction(e){return(s,r,a,l)=>new B(e(s,r.x,a.x,l),e(s,r.y,a.y,l))}}Gt.Linear=Gt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,s*u/r+e)),Gt.EaseInQuad=Gt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,s*u*u+e)),Gt.EaseOutQuad=Gt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,-s*u*(u-2)+e)),Gt.EaseInOutQuad=Gt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r/2,u<1?s/2*u*u+e:(u--,-s/2*(u*(u-2)-1)+e))),Gt.EaseInCubic=Gt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,s*u*u*u+e)),Gt.EaseOutCubic=Gt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r,u--,s*(u*u*u+1)+e)),Gt.EaseInOutCubic=Gt.CreateReversibleEasingFunction((u,e,s,r)=>(s=s-e,u/=r/2,u<1?s/2*u*u*u+e:(u-=2,s/2*(u*u*u+2)+e)));class yd{constructor(e){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=e}add(e){this._actions.push(e)}remove(e){const s=this._actions.indexOf(e);this._actions.splice(s,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const e=this._actions.length;for(let s=0;s<e;s++)this._actions[s].reset();this._completedActions=[]}update(e){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new bh(this._currentAction,this._entity))),this._currentAction.update(e),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new Ah(this._currentAction,this._entity));const s=this._actions.shift();s&&this._completedActions.push(s)}}}let zp=0;function zt(){return zp++}class Cd{constructor(e,s,r){this.id=zt(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new Fr(e),this._actionQueue=this._repeatContext.getQueue(),this._repeat=r,this._originalRepeat=r,this._repeatBuilder(this._repeatContext),this._repeat--}update(e){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(e)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class Sd{constructor(e,s){this.id=zt(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new Fr(e),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(e){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(e))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function Pd(u,e,s){return(1-s)*u+e*s}function Lh(u,e,s,r){const a=(u-e+W)%W>=Math.PI,l=Math.abs(e-u),f=W-l;let g=0,m=0;l>f?(g=f,m=l):(g=l,m=f);let w=0,A=1;switch(s){case R.ShortestPath:w=g,A=a?1:-1;break;case R.LongestPath:w=m,A=a?-1:1;break;case R.Clockwise:A=1,w=a?g:m;break;case R.CounterClockwise:A=-1,w=a?m:g;break}return u+A*(w*r)}function Rr(u,e,s){return u.scale(1-s).add(e.scale(s))}function Td(u,e,s){return(s-u)/(e-u)}function Ed(u,e,s){const r=s.sub(u),a=e.sub(u),l=r.x/a.x,f=r.y/a.y;return Math.min(l,f)}function Zi(u,e,s,r,a){const l=Td(u,e,a);return Pd(s,r,l)}function Hp(u,e,s,r,a){const l=Ed(u,e,a);return Rr(s,r,l)}function Id(u){return u.offset instanceof B&&typeof u.duration=="number"}class Rd{constructor(e,s){var r;if(this.entity=e,this.id=zt(),this._started=!1,this._stopped=!1,this._easing=Gt.Linear,this._offset=s.offset,this._easing=(r=s.easing)!==null&&r!==void 0?r:this._easing,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=e;const s=j(Zi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),f=(a-r.x)/(e/1e3),g=(l-r.y)/(e/1e3);this._motion.vel.x=f,this._motion.vel.y=g,this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=z(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Uh{constructor(e,s,r,a){if(this.id=zt(),this._started=!1,this._stopped=!1,this._entity=e,this._tx=e.get(it),this._motion=e.get(Bt),this._speed=a,this._offset=new B(s,r),a<=0)throw at.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+a),new Error("Speed must be greater than 0 pixels per second")}update(e){this._started||(this._started=!0,this._start=new B(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(e){const s=e.get(it);return this._stopped||s.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Dd(u){return u.pos instanceof B&&typeof u.duration=="number"}class Fd{constructor(e,s){var r;if(this.entity=e,this.id=zt(),this._started=!1,this._stopped=!1,this._easing=Gt.Linear,this._end=s.pos,this._easing=(r=s.easing)!==null&&r!==void 0?r:this._easing,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=e;const s=j(Zi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),f=(a-r.x)/(e/1e3),g=(l-r.y)/(e/1e3);this._motion.vel.x=f,this._motion.vel.y=g,this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=z(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class zh{constructor(e,s,r,a){this.entity=e,this.id=zt(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._end=new B(s,r),this._speed=a}update(e){this._started||(this._started=!0,this._start=new B(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const s=this._dir.scale(this._speed);this._motion.vel=z(s.x,s.y),this.isComplete(this.entity)&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(e){const s=e.get(it);return this._stopped||new B(s.pos.x,s.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Op(u){return typeof u.angle=="number"&&typeof u.duration=="number"}class Md{constructor(e,s){var r;if(this.entity=e,this.id=zt(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=s.angle,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(r=s.rotationType)!==null&&r!==void 0?r:R.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=e;const s=j(Zi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Lh(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(r-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Bd{constructor(e,s,r,a){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._end=s,this._speed=r,this._rotationType=a||R.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const s=Math.abs(this._end-this._start),r=W-s;switch(s>r?(this._shortDistance=r,this._longDistance=s):(this._shortDistance=s,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+W)%W>=Math.PI,this._rotationType){case R.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case R.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case R.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case R.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Wp(u){return typeof u.angleRadiansOffset=="number"&&typeof u.duration=="number"}class kd{constructor(e,s){var r;if(this.entity=e,this.id=zt(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=s.angleRadiansOffset,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(r=s.rotationType)!==null&&r!==void 0?r:R.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._endAngle=rt(this._startAngle+this._offset),this._started=!0),this._currentMs-=e;const s=j(Zi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Lh(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(r-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Ld{constructor(e,s,r,a){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._speed=r,this._offset=s,this._rotationType=a||R.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const s=Math.abs(this._end-this._start),r=W-s;switch(s>r?(this._shortDistance=r,this._longDistance=s):(this._shortDistance=s,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+W)%W>=Math.PI,this._rotationType){case R.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case R.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case R.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case R.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function Ud(u){return typeof u.scale=="object"&&typeof u.duration=="number"}class zd{constructor(e,s){if(this.entity=e,this.id=zt(),this._started=!1,this._stopped=!1,this._endScale=z(1,1),this._startScale=z(1,1),this._endScale=s.scale,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=e;const s=j(Zi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Rr(this._startScale,this._endScale,s),a=this._tx.scale,l=r.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=B.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Hd{constructor(e,s,r,a,l){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._endX=s,this._endY=r,this._speedX=a,this._speedY=l}update(e){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*s}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*s}this.isComplete()&&(this._tx.scale=z(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Od(u){return typeof u.scaleOffset=="object"&&typeof u.duration=="number"}class Wd{constructor(e,s){if(this.entity=e,this.id=zt(),this._started=!1,this._stopped=!1,this._endScale=z(1,1),this._scaleOffset=z(0,0),this._startScale=z(1,1),this._scaleOffset=s.scaleOffset,this._tx=e.get(it),this._motion=e.get(Bt),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=e;const s=j(Zi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Rr(this._startScale,this._endScale,s),a=this._tx.scale,l=r.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=B.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Vd{constructor(e,s,r,a){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._offset=new B(s,r),this._speedX=this._speedY=a}update(e){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Nd{constructor(e){this.id=zt(),this._hasBeenCalled=!1,this._method=e}update(e){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class Gd{constructor(e,s,r,a,l){this.easingFcn=l,this.id=zt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new B(0,0),this._lerpEnd=new B(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._lerpDuration=a,this._lerpEnd=new B(s,r)}_initialize(){this._lerpStart=new B(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=z((s-this._tx.pos.x)/(e/1e3),(r-this._tx.pos.y)/(e/1e3))):(this._tx.pos=z(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=B.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=z(0,0),this._stopped=!0}}class Xd{constructor(e,s,r,a,l){this.easingFcn=l,this.id=zt(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new B(0,0),this._lerpEnd=new B(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._lerpDuration=a,this._offset=new B(s,r)}_initialize(){this._lerpStart=new B(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=z((s-this._tx.pos.x)/(e/1e3),(r-this._tx.pos.y)/(e/1e3))):(this._tx.pos=z(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=B.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=z(0,0),this._stopped=!0}}class qd{constructor(e,s,r,a=1){this.id=zt(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=e.get(ne),this._timeVisible=s,this._timeNotVisible=r,this._duration=(s+r)*a}update(e){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=e,this._totalTime+=e,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class Yd{constructor(e,s,r){this.id=zt(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=e.get(ne),this._endOpacity=s,this._remainingTime=this._originalTime=r}update(e){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*e)/this._remainingTime),this._remainingTime-=e,this.isComplete()&&(this._graphics.opacity=this._endOpacity),at.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class jd{constructor(e){this.id=zt(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=e}update(e){this._started||(this._started=!0),this._elapsedTime+=e}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class Zd{constructor(e){this.id=zt(),this._stopped=!1,this._entity=e}update(e){this._entity.get(qn).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class Hh{constructor(e,s,r){this.id=zt(),this._started=!1,this._stopped=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._followTx=s.get(it),this._followMotion=s.get(Bt),this._current=new B(this._tx.pos.x,this._tx.pos.y),this._end=new B(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=r!==void 0?r:this._current.distance(this._end),this._speed=0}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(s!==0&&(this._speed=s),this._current=z(this._tx.pos.x,this._tx.pos.y),this._end=z(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const r=this._dir.scale(this._speed);this._motion.vel=z(r.x,r.y)}else this._motion.vel=z(0,0);this.isComplete()&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}stop(){this._motion.vel=z(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class Oh{constructor(e,s,r){this.id=zt(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=e.get(it),this._motion=e.get(Bt),this._meetTx=s.get(it),this._meetMotion=s.get(Bt),this._current=new B(this._tx.pos.x,this._tx.pos.y),this._end=new B(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=r||0,r!==void 0&&(this._speedWasSpecified=!0)}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));s!==0&&!this._speedWasSpecified&&(this._speed=s),this._current=z(this._tx.pos.x,this._tx.pos.y),this._end=z(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const r=this._dir.scale(this._speed);this._motion.vel=z(r.x,r.y),this.isComplete()&&(this._tx.pos=z(this._end.x,this._end.y),this._motion.vel=z(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=z(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class Qd{constructor(e,s,r=1e3){var a;this.id=zt(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=e.get(ne),this._duration=r,this._entity=e,this._material=(a=e.scene)===null||a===void 0?void 0:a.engine.graphicsContext.createMaterial({name:"flash-material",color:s,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=r}update(e){var s;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=e,this._graphics&&((s=this._material)===null||s===void 0||s.update(r=>{r.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Dr{constructor(e){var s;if(this._distLookup=[],this.quality=4,e.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...e.controlPoints],this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(e){this._controlPoints=[...e],this._calculateLookup()}setControlPoint(e,s){this._controlPoints[e]=s,this._calculateLookup()}_calculateLookup(){let e=0;this._distLookup.length=0;let s=this.controlPoints[0];const r=this.controlPoints.length*this.quality;for(let a=0;a<r;a++){const l=a/(r-1),f=this.getPoint(l),g=s.distance(f);e+=g,this._distLookup.push(e),s=f}this._arcLength=e}_getTimeGivenDistance(e){const s=this._distLookup.length,r=this.arcLength;if(e>=0&&e<r){for(let a=0;a<s-1;a++)if(this._distLookup[a]<=e&&e<this._distLookup[a+1])return Zi(this._distLookup[a],this._distLookup[a+1],a/(s-1),(a+1)/(s-1),e)}return e/r}getPoint(e){const s=[...this.controlPoints];for(let r=1;r<s.length;r++)for(let a=0;a<s.length-r;a++)s[a]=Rr(s[a],s[a+1],e);return s[0]}getTangent(e){const s=e*e,r=this.controlPoints[0],a=this.controlPoints[1],l=this.controlPoints[2],f=this.controlPoints[3];return r.scale(-3*s+6*e-3).add(a.scale(9*s-12*e+3).add(l.scale(-9*s+6*e).add(f.scale(3*s)))).normalize()}getUniformTangent(e){const s=e*this.arcLength,r=this._getTimeGivenDistance(s);return this.getTangent(r)}getNormal(e){return this.getTangent(e).normal()}getUniformNormal(e){return this.getUniformTangent(e).normal()}getUniformPoint(e){const s=e*this.arcLength,r=this._getTimeGivenDistance(s);return this.getPoint(r)}clone(){return new Dr({controlPoints:[...this.controlPoints],quality:this.quality})}}class Jd{constructor(e,s){var r;if(this.id=zt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(it),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new Dr({controlPoints:[z(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(r=s.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=e;const s=j(Zi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class Kd{constructor(e,s){var r;if(this.id=zt(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(it),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new Dr({controlPoints:[z(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(r=s.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=e;const s=j(Zi(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class Fr{constructor(e){this._entity=e,this._queue=new yd(e)}getQueue(){return this._queue}update(e){this._queue.update(e)}clearActions(){this._queue.clearActions()}runAction(e){return e.reset(),this._queue.add(e),this}curveBy(e){return this._queue.add(new Kd(this._entity,e)),this}curveTo(e){return this._queue.add(new Jd(this._entity,e)),this}easeTo(...e){var s,r;let a=0,l=0,f=0,g=Gt.Linear;return e[0]instanceof B?(a=e[0].x,l=e[0].y,f=e[1],g=(s=e[2])!==null&&s!==void 0?s:g):(a=e[0],l=e[1],f=e[2],g=(r=e[3])!==null&&r!==void 0?r:g),this._queue.add(new Gd(this._entity,a,l,f,g)),this}easeBy(...e){var s,r;let a=0,l=0,f=0,g=Gt.Linear;return e[0]instanceof B?(a=e[0].x,l=e[0].y,f=e[1],g=(s=e[2])!==null&&s!==void 0?s:g):(a=e[0],l=e[1],f=e[2],g=(r=e[3])!==null&&r!==void 0?r:g),this._queue.add(new Xd(this._entity,a,l,f,g)),this}moveTo(e,s,r){let a=0,l=0,f=0;return e instanceof B?(a=e.x,l=e.y,f=+(s??0),this._queue.add(new zh(this._entity,a,l,f))):typeof e=="number"&&typeof s=="number"&&typeof r=="number"?(a=e,l=s,f=r,this._queue.add(new zh(this._entity,a,l,f))):Dd(e)&&this._queue.add(new Fd(this._entity,e)),this}moveBy(e,s,r){let a=0,l=0,f=0;return e instanceof B&&typeof s=="number"?(a=e.x,l=e.y,f=s,this._queue.add(new Uh(this._entity,a,l,f))):typeof e=="number"&&typeof s=="number"&&typeof r=="number"?(a=e,l=s,f=r,this._queue.add(new Uh(this._entity,a,l,f))):Id(e)&&this._queue.add(new Rd(this._entity,e)),this}rotateTo(e,s,r){return typeof e=="number"&&typeof s=="number"?this._queue.add(new Bd(this._entity,e,s,r)):typeof e=="object"&&this._queue.add(new Md(this._entity,e)),this}rotateBy(e,s,r){return typeof e=="object"?this._queue.add(new kd(this._entity,e)):this._queue.add(new Ld(this._entity,e,s,r)),this}scaleTo(e,s,r,a){let l=1,f=1,g=0,m=0;return Ud(e)?(this._queue.add(new zd(this._entity,e)),this):(e instanceof B&&s instanceof B&&(l=e.x,f=e.y,g=s.x,m=s.y),typeof e=="number"&&typeof s=="number"&&(l=e,f=s,g=r,m=a),this._queue.add(new Hd(this._entity,l,f,g,m)),this)}scaleBy(e,s,r){if(Od(e))return this._queue.add(new Wd(this._entity,e)),this;let a=1,l=1;return e instanceof B&&(a=e.x,l=e.y,r=s),typeof e=="number"&&typeof s=="number"&&(a=e,l=s),this._queue.add(new Vd(this._entity,a,l,r)),this}blink(e,s,r=1){return this._queue.add(new qd(this._entity,e,s,r)),this}fade(e,s){return this._queue.add(new Yd(this._entity,e,s)),this}flash(e,s=1e3){return this._queue.add(new Qd(this._entity,e,s)),this}delay(e){return this._queue.add(new jd(e)),this}die(){return this._queue.add(new Zd(this._entity)),this}callMethod(e){return this._queue.add(new Nd(e)),this}repeat(e,s){return s?(this._queue.add(new Cd(this._entity,e,s)),this):(this.repeatForever(e),this)}repeatForever(e){return this._queue.add(new Sd(this._entity,e)),this}follow(e,s){return s===void 0?this._queue.add(new Hh(this._entity,e)):this._queue.add(new Hh(this._entity,e,s)),this}meet(e,s){return s===void 0?this._queue.add(new Oh(this._entity,e)):this._queue.add(new Oh(this._entity,e,s)),this}toPromise(){return new Promise(s=>{this._queue.add(new Nd(()=>{s()}))})}}class qn extends Si{constructor(){super(...arguments),this.dependencies=[it,Bt],this._ctx=null}onAdd(e){this._ctx=new Fr(e)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(e){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(e)}update(e){var s;return(s=this._ctx)===null||s===void 0?void 0:s.update(e)}clearActions(){var e;(e=this._ctx)===null||e===void 0||e.clearActions()}curveBy(e){return this._getCtx().curveBy.apply(this._ctx,[e])}curveTo(e){return this._getCtx().curveTo.apply(this._ctx,[e])}easeTo(...e){return this._getCtx().easeTo.apply(this._ctx,e)}easeBy(...e){return this._getCtx().easeBy.apply(this._ctx,e)}moveTo(e,s,r){return this._getCtx().moveTo.apply(this._ctx,[e,s,r])}moveBy(e,s,r){return this._getCtx().moveBy.apply(this._ctx,[e,s,r])}rotateTo(e,s,r){return this._getCtx().rotateTo.apply(this._ctx,[e,s,r])}rotateBy(e,s,r){return this._getCtx().rotateBy.apply(this._ctx,[e,s,r])}scaleTo(e,s,r,a){return this._getCtx().scaleTo.apply(this._ctx,[e,s,r,a])}scaleBy(e,s,r){return this._getCtx().scaleBy.apply(this._ctx,[e,s,r])}blink(e,s,r){return this._getCtx().blink(e,s,r)}fade(e,s){return this._getCtx().fade(e,s)}flash(e,s=1e3){return this._getCtx().flash(e,s)}delay(e){return this._getCtx().delay(e)}die(){return this._getCtx().die()}callMethod(e){return this._getCtx().callMethod(e)}repeat(e,s){return this._getCtx().repeat(e,s)}repeatForever(e){return this._getCtx().repeatForever(e)}follow(e,s){return this._getCtx().follow(e,s)}meet(e,s){return this._getCtx().meet(e,s)}toPromise(){return this._getCtx().toPromise()}}function Vp(u){return u instanceof Je}const Np={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class Je extends Oe{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(e){this.body.oldPos.setTo(e.x,e.y)}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e.clone()}get oldVel(){return this.body.oldVel}set oldVel(e){this.body.oldVel.setTo(e.x,e.y)}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e.clone()}set oldAcc(e){this.body.oldAcc.setTo(e.x,e.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(e){this.transform.rotation=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}get scale(){return this.get(it).scale}set scale(e){this.get(it).scale=e}get anchor(){return this._anchor}set anchor(e){this._anchor=Ri(e,s=>this._handleAnchorChange(s)),this._handleAnchorChange(e)}_handleAnchorChange(e){this.graphics&&(this.graphics.anchor=e)}get offset(){return this._offset}set offset(e){this._offset=Ri(e,s=>this._handleOffsetChange(s)),this._handleOffsetChange(e)}_handleOffsetChange(e){this.graphics&&(this.graphics.offset=e)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(e){e&&(e&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!e&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=e)}get color(){return this.graphics.color}set color(e){this.graphics.color=e}constructor(e){super(),this.events=new I,this._anchor=Ri(B.Half,It=>this._handleAnchorChange(It)),this._offset=Ri(B.Zero,It=>this._handleOffsetChange(It)),this.logger=at.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=It=>{this._dragging&&(this.pos=It.worldPos)},this._pointerDragLeaveHandler=It=>{this._dragging&&(this.pos=It.worldPos)};const{name:s,x:r,y:a,pos:l,coordPlane:f,scale:g,width:m,height:w,radius:A,collider:y,vel:E,acc:D,rotation:L,angularVelocity:O,z:q,color:H,visible:V,opacity:J,anchor:Y,offset:$,collisionType:ot,collisionGroup:Z,silenceWarnings:gt}={...e};this.name=s??this.name,this.anchor=Y??Je.defaults.anchor.clone(),this.offset=$??B.Zero,this.transform=new it,this.addComponent(this.transform),this.pos=l??z(r??0,a??0),this.rotation=L??0,this.scale=g??z(1,1),this.z=q??0,this.transform.coordPlane=f??De.World,this._silenceWarnings=gt??!1,this.pointer=new Ns,this.addComponent(this.pointer),this.graphics=new ne({anchor:this.anchor,offset:this.offset,opacity:J}),this.addComponent(this.graphics),this.motion=new Bt,this.addComponent(this.motion),this.vel=E??B.Zero,this.acc=D??B.Zero,this.angularVelocity=O??0,this.actions=new qn,this.addComponent(this.actions),this.body=new Tt,this.addComponent(this.body),this.body.collisionType=ot??ft.Passive,Z&&(this.body.group=Z),H&&(this.color=H),y?(this.collider=new pe(y),this.addComponent(this.collider)):A?(this.collider=new pe(Ve.Circle(A)),this.addComponent(this.collider),H&&this.graphics.add(new Vo({color:H,radius:A}))):m>0&&w>0?(this.collider=new pe(Ve.Box(m,w,this.anchor)),this.addComponent(this.collider),H&&m&&w&&this.graphics.add(new Ir({color:H,width:m,height:w}))):(this.collider=new pe,this.addComponent(this.collider)),this.graphics.isVisible=V??!0}clone(){const e=new Je({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});e.clearComponents(),e.processComponentRemoval(),e.addComponent(e.transform=this.transform.clone(),!0),e.addComponent(e.pointer=this.pointer.clone(),!0),e.addComponent(e.graphics=this.graphics.clone(),!0),e.addComponent(e.motion=this.motion.clone(),!0),e.addComponent(e.actions=this.actions.clone(),!0),e.addComponent(e.body=this.body.clone(),!0),e.addComponent(e.collider=this.collider.clone(),!0);const s=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],r=this.getComponents();for(const a of r)s.includes(a)||e.addComponent(a.clone(),!0);return e}onInitialize(e){}_initialize(e){super._initialize(e);for(const s of this.children)s._initialize(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_prekill(e){this.events.emit("prekill",new $a(this)),this.onPreKill(e)}onPreKill(e){}_postkill(e){this.events.emit("postkill",new th(this)),this.onPostKill(e)}onPostKill(e){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new Fo(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(it).z}set z(e){this.get(it).z=e}get center(){const e=this.getGlobalPos();return new B(e.x+this.width/2-this.anchor.x*this.width,e.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new B(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(it).globalRotation}get globalRotation(){return this.get(it).globalRotation}getGlobalPos(){return this.get(it).globalPos}get globalPos(){return this.get(it).globalPos}getGlobalScale(){return this.get(it).globalScale}get globalScale(){return this.get(it).globalScale}get globalZ(){return this.get(it).globalZ}contains(e,s,r=!1){const a=z(e,s),l=this.get(pe);l.update();const f=l.get();if(!f)return!1;const g=f.contains(a);return r?g||this.children.some(m=>m.contains(e,s,!0)):g}within(e,s){const r=this.get(pe),a=e.get(pe),l=r.get(),f=a.get();return l&&f?l.getClosestLineBetween(f).getLength()<=s:!1}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s),this._postupdate(e,s),this._remove(e)}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreCollisionResolve(e,s,r,a){}onPostCollisionResolve(e,s,r,a){}onCollisionStart(e,s,r,a){}onCollisionEnd(e,s,r,a){}_preupdate(e,s){this.events.emit("preupdate",new Os(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new Ws(e,s,this)),this.onPostUpdate(e,s)}}Je.defaults={anchor:B.Half};function $d(u){return u instanceof Wh}class Wh extends Je{constructor(e){var s,r;super({...e}),this.get(it).coordPlane=De.Screen,this.anchor=(s=e?.anchor)!==null&&s!==void 0?s:z(0,0),this.body.collisionType=(r=e?.collisionType)!==null&&r!==void 0?r:ft.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!e?.collider&&e?.width>0&&e?.height>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(e){this._engine=e,super._initialize(e)}contains(e,s,r=!0){if(r)return super.contains(e,s);const a=this._engine.worldToScreenCoordinates(new B(e,s));return super.contains(a.x,a.y)}}class fn{get complete(){return this._complete}constructor(e){var s;this._logger=at.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const r=(s=e.action)!==null&&s!==void 0?s:e.fcn,a=e.interval,l=e.repeats,f=e.numberOfRepeats,g=e.randomRange,m=e.random;if(f&&f>=0&&(this.maxNumberOfRepeats=f,!l))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=fn._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=a,g){if(g[0]>g[1])throw new Error("min value must be lower than max value for range");this.random=m??new M,this.randomRange=g,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=l||this.repeats,r&&this.on(r)}on(e){this._callbacks.push(e)}off(e){const s=this._callbacks.indexOf(e);this._callbacks.splice(s,1)}update(e){this._running&&(this._totalTimeAlive+=e,this._elapsedTime+=e,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(s=>{s.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(e,s){if(e&&e>=0&&(this._baseInterval=this.interval=e),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=s,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}fn._MAX_ID=0;class No extends Si{constructor(e){super(),this.parallaxFactor=z(1,1),this.parallaxFactor=e??this.parallaxFactor}}class Go extends Si{constructor(e,s=!0){super(),this.draw=e,this.useTransform=s}}function tu(u){return u&&u._dispatchPointerEvents&&u._processPointerToObject}class Gp{get events(){return this.object.events}init(e,s,r){this.object=e,this.contains=s,this.active=r}}class Vh{constructor(){this._proxyPool=new mr(()=>new Gp,e=>e,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(e,s,r){const a=this._proxyPool.rent(!1);a.init(e,s,r),this._proxies.push(a),this._objectToProxy.set(e,a)}_getProxy(e){const s=this._objectToProxy.get(e);if(s)return s;throw new Error("No PointerTargetProxy for object")}removeObject(e){const s=this._objectToProxy.get(e);if(s){const r=this._proxies.indexOf(s);r>-1&&this._proxies.splice(r,1),this._proxyPool.return(s)}}_objectCurrentlyUnderPointer(e,s){return!!(this._currentFrameObjectToPointers.has(e)&&this._currentFrameObjectToPointers.get(e).includes(s))}_objectWasUnderPointer(e,s){return!!(this._lastFrameObjectToPointers.has(e)&&this._lastFrameObjectToPointers.get(e).includes(s))}_entered(e,s){return this._objectCurrentlyUnderPointer(e,s)&&!this._lastFrameObjectToPointers.has(e)}_left(e,s){return!this._currentFrameObjectToPointers.has(e)&&this._objectWasUnderPointer(e,s)}addPointerToObject(e,s){const r=this._objectToProxy.get(e);r&&this._addPointerToProxy(r,s)}_addPointerToProxy(e,s){if(!this._currentFrameObjectToPointers.has(e)){this._currentFrameObjectToPointers.set(e,[s]);return}const r=this._currentFrameObjectToPointers.get(e);this._currentFrameObjectToPointers.set(e,r.concat(s))}dispatchEvents(e,s){const r=new Set(this._lastFrameObjectToPointers.keys()),a=new Set(this._currentFrameObjectToPointers.keys());let l,f,g;for(let m=0;m<s.length;m++){const w=s[m],A=this._getProxy(w);if(tu(w)&&w._dispatchPointerEvents(e),r.has(A)||a.has(A)){g=this._processDownAndEmit(e,A),f=this._processUpAndEmit(e,A),l=this._processMoveAndEmit(e,A);const y=[...l.values(),...g.values(),...f.values()];this._processEnterLeaveAndEmit(e,A,y),this._processCancelAndEmit(e,A),this._processWheelAndEmit(e,A)}}}processPointerToObject(e,s){for(let r=0;r<s.length;r++){const a=s[r],l=this._getProxy(a);tu(a)&&a._processPointerToObject(e);for(const[f,g]of e.currentFramePointerCoords.entries())l.contains(g)&&this._addPointerToProxy(l,f)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(e,s){const r=new Map;for(const a of e.currentFrameDown)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerdown",a),e.isDragStart(a.pointerId)&&s.events.emit("pointerdragstart",a)),r.set(a.pointerId,a);return r}_processUpAndEmit(e,s){const r=new Map;for(const a of e.currentFrameUp)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerup",a),e.isDragEnd(a.pointerId)&&s.events.emit("pointerdragend",a)),r.set(a.pointerId,a);return r}_processMoveAndEmit(e,s){const r=new Map;for(const a of e.currentFrameMove)a.active&&s.active()&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointermove",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragmove",a)),r.set(a.pointerId,a);return r}_processEnterLeaveAndEmit(e,s,r){for(const a of r){if(a.active&&s.active()&&this._entered(s,a.pointerId)){s.events.emit("pointerenter",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragenter",a);break}if(a.active&&s.active()&&(this._left(s,a.pointerId)||this._objectCurrentlyUnderPointer(s,a.pointerId)&&a.type==="up")){s.events.emit("pointerleave",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragleave",a);break}}}_processCancelAndEmit(e,s){for(const r of e.currentFrameCancel)r.active&&s.active()&&this._objectCurrentlyUnderPointer(s,r.pointerId)&&s.events.emit("pointercancel",r)}_processWheelAndEmit(e,s){for(const r of e.currentFrameWheel)r.active&&s.active()&&this._objectCurrentlyUnderPointer(s,0)&&s.events.emit("pointerwheel",r)}}const Xp={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class eu extends Oe{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let e=0;e<this.tiles.length;e++)this.tiles[e]&&this.tiles[e].flagDirty()}get x(){var e;return(e=this.transform.pos.x)!==null&&e!==void 0?e:0}set x(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.get(it).pos=z(e,this.y))}get y(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.pos.y)!==null&&s!==void 0?s:0}set y(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.transform.pos=z(this.x,e))}get z(){var e;return(e=this.transform.z)!==null&&e!==void 0?e:0}set z(e){this.transform&&(this.transform.z=e)}get rotation(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.rotation)!==null&&s!==void 0?s:0}set rotation(e){this.transform&&(this.transform.rotation=e)}get scale(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.scale)!==null&&s!==void 0?s:B.One}set scale(e){var s;!((s=this.transform)===null||s===void 0)&&s.scale&&(this.transform.scale=e)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get vel(){return this._motion.vel}set vel(e){this._motion.vel=e}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,r,a;super([],e.name),this.events=new I,this._token=0,this.logger=at.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(s=e.meshingLookBehind)!==null&&s!==void 0?s:this.meshingLookBehind,this.addComponent(new it),this.addComponent(new Bt),this.addComponent(new Tt({type:ft.Fixed})),this.addComponent(new ne({onPostDraw:(f,g)=>this.draw(f,g)})),this.addComponent(new Go((f,g)=>this.debug(f,g),!1)),this.addComponent(new pe),this.addComponent(new Ns),this.pointer=this.get(Ns),this._graphics=this.get(ne),this.transform=this.get(it),this._motion=this.get(Bt),this.collider=this.get(pe),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(r=e.pos)!==null&&r!==void 0?r:B.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(a=e.renderFromTopOfGraphic)!==null&&a!==void 0?a:this.renderFromTopOfGraphic,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight,this.rows=e.rows,this.columns=e.columns,this._pointerEventDispatcher=new Vh,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let l=[];for(let f=0;f<this.columns;f++){for(let g=0;g<this.rows;g++){const m=new iu({x:f,y:g,map:this});m.map=this,this.tiles[f+g*this.columns]=m,this._pointerEventDispatcher.addObject(m,w=>m.bounds.contains(w.worldPos),()=>!0),l.push(m),this._rows[g]||(this._rows[g]=[]),this._rows[g].push(m)}this._cols[f]=l,l=[]}this._graphics.localBounds=new ht({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(e){super._initialize(e),this._engine=e}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:B.Zero;{const r=e.offset;return this._originalOffsets.set(e,r),r}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const e=[];this._composite=this.collider.useCompositeCollider([]);let s=null;const r=(l,f)=>l&&f?l.top===f.top&&l.bottom===f.bottom&&l.right===f.left:!1,a=(l,f,g=this.meshingLookBehind)=>{if(!l)return!1;for(let m=f.length-1;m>=0;m--){if(g--<0)return!1;const w=f[m];if(r(w,l))return f[m]=w.combine(l),!0}return!1};for(let l=0;l<this.columns;l++){for(let f=0;f<this.rows;f++){const g=this.tiles[l+f*this.columns];if(g.solid)if(g.getColliders().length>0){for(const m of g.getColliders()){const w=this._getOrSetColliderOriginalOffset(m);m.offset=z(g.x*this.tileWidth*this.scale.x,g.y*this.tileHeight*this.scale.y).add(w),m.owner=this,this._composite.addCollider(m)}s&&!a(s,e)&&e.push(s),s=null}else s?s=s.combine(g.defaultGeometry):s=g.defaultGeometry;else s&&!a(s,e)&&e.push(s),s=null}s&&!a(s,e)&&e.push(s),s=null}for(const l of e){const f=Ve.Box(l.width,l.height,B.Zero,z(l.left-this.pos.x,l.top-this.pos.y));f.owner=this,this._composite.addCollider(f)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(e){var s;return(s=this.tiles[e])!==null&&s!==void 0?s:null}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const{x:s,y:r}=this._getTileCoordinates(e),a=this.getTile(s,r);return s>=0&&r>=0&&s<this.columns&&r<this.rows&&a?a:null}_getTileCoordinates(e){e=this.transform.applyInverse(e);const s=Math.floor(e.x/this.tileWidth),r=Math.floor(e.y/this.tileHeight);return{x:s,y:r}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let e=this._engine.screen.getWorldBounds();const s=this.get(No);if(s&&this.isInitialized){let D=this.pos;const L=B.One.sub(s.parallaxFactor),O=this._engine.currentScene.camera.pos.scale(L);D=D.sub(O),e=e.translate(D)}const r=this.transform.coordPlane===De.Screen?this._engine.screen.getScreenBounds():e,a=this._getTileCoordinates(r.topLeft),l=this._getTileCoordinates(r.topRight),f=this._getTileCoordinates(r.bottomRight),g=this._getTileCoordinates(r.bottomLeft),m=Math.min(j(a.x,0,this.columns-1),j(l.x,0,this.columns-1)),w=Math.min(j(a.y,0,this.rows-1),j(l.y,0,this.rows-1)),A=Math.max(j(f.x,0,this.columns-1),j(g.x,0,this.columns-1)),y=Math.max(j(f.y,0,this.rows-1),j(g.y,0,this.rows-1)),E=[];for(let D=m;D<=A;D++)for(let L=w;L<=y;L++)E.push(this.getTile(D,L));return E}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(e,s){this._initialize(e),this.onPreUpdate(e,s),this.emit("preupdate",new Os(e,s,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(e,s),this.emit("postupdate",new Ws(e,s,this))}draw(e,s){if(!this.isInitialized)return;this.emit("predraw",new Vn(e,s,this));let r,a,l;const f=this.getOnScreenTiles();for(let g=0;g<f.length;g++){const m=f[g],w=m.getGraphicsOffsets();for(r=m.getGraphics(),a=0,l=r.length;a<l;a++){const A=r[a],y=w[a];if(A){Ka(A)&&A?.tick(s,this._token);const E=this.renderFromTopOfGraphic?0:A.height-this.tileHeight;A.draw(e,m.x*this.tileWidth+y.x,m.y*this.tileHeight-E+y.y)}}}this.emit("postdraw",new Nn(e,s,this))}debug(e,s){const{showAll:r,showGrid:a,gridColor:l,gridWidth:f,showSolidBounds:g,solidBoundsColor:m,showColliderGeometry:w}=s.tilemap,{geometryColor:A,geometryLineWidth:y,geometryPointSize:E}=s.collider,D=this.tileWidth*this.columns*this.scale.x,L=this.tileHeight*this.rows*this.scale.y,O=this.pos;if(a||r){for(let q=0;q<this.rows+1;q++){const H=z(0,q*this.tileHeight*this.scale.y);e.drawLine(O.add(H),O.add(z(D,H.y)),l,f)}for(let q=0;q<this.columns+1;q++){const H=z(q*this.tileWidth*this.scale.x,0);e.drawLine(O.add(H),O.add(z(H.x,L)),l,f)}}if(r||g||w){const q=this._composite.getColliders();e.save(),e.translate(this.pos.x,this.pos.y),e.scale(this.scale.x,this.scale.y);for(const H of q){const V=H.localBounds,J=H.worldPos.sub(this.pos);g&&e.drawRectangle(J,V.width,V.height,m)}if(e.restore(),w)for(const H of q)H.debug(e,A,{lineWidth:y,pointSize:E})}if(r||g){if(e.save(),e.z=999,g)for(let q=0;q<this.tiles.length;q++)this.tiles[q].bounds.draw(e);e.restore()}}}class iu{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(e){var s;(s=this.map)===null||s===void 0||s.flagCollidersDirty(),this._solid=e}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(e,s){this._graphics.push(e),s?.offset?this._offsets.push(s.offset):this._offsets.push(B.Zero)}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&(this._graphics.splice(s,1),this._offsets.splice(s,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(e){var s,r;this._posDirty=!1,this.events=new I,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=e.x,this.y=e.y,this.map=e.map,this._width=e.map.tileWidth*this.map.scale.x,this._height=e.map.tileHeight*this.map.scale.y,this.solid=(s=e.solid)!==null&&s!==void 0?s:this.solid,this._graphics=(r=e.graphics)!==null&&r!==void 0?r:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const e=this.map.pos.add(z(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new ht(e.x,e.y,e.x+this.map.tileWidth,e.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(z(this.x*this._width,this.y*this._height)),this._bounds=new ht(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new B(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}class su{constructor(e){this.camera=e}lockToActor(e){this.camera.addStrategy(new nu(e))}lockToActorAxis(e,s){this.camera.addStrategy(new ru(e,s))}elasticToActor(e,s,r){this.camera.addStrategy(new ou(e,s,r))}radiusAroundActor(e,s){this.camera.addStrategy(new au(e,s))}limitCameraBounds(e){this.camera.addStrategy(new hu(e))}}var Xo;(function(u){u[u.X=0]="X",u[u.Y=1]="Y"})(Xo||(Xo={}));class nu{constructor(e){this.target=e,this.action=(s,r,a,l)=>s.center}}class ru{constructor(e,s){this.target=e,this.axis=s,this.action=(r,a,l,f)=>{const g=r.center,m=a.getFocus();return this.axis===Xo.X?new B(g.x,m.y):new B(m.x,g.y)}}}class ou{constructor(e,s,r){this.target=e,this.cameraElasticity=s,this.cameraFriction=r,this.action=(a,l,f,g)=>{const m=a.center;let w=l.getFocus(),A=l.vel.clone();const y=m.sub(w).scale(this.cameraElasticity);A=A.add(y);const E=A.scale(-1).scale(this.cameraFriction);return A=A.add(E),w=w.add(A),w}}}class au{constructor(e,s){this.target=e,this.radius=s,this.action=(r,a,l,f)=>{const g=r.center,m=a.getFocus(),w=g.sub(m),A=w.magnitude;if(A>=this.radius){const y=A-this.radius;return m.add(w.normalize().scale(y))}return m}}}class hu{constructor(e){this.target=e,this.boundSizeChecked=!1,this.action=(s,r,a,l)=>{const f=r.getFocus();this.boundSizeChecked||((s.bottom-s.top<a.drawHeight||s.right-s.left<a.drawWidth)&&at.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let g=f.x,m=f.y;return f.x<s.left+a.halfDrawWidth?g=s.left+a.halfDrawWidth:f.x>s.right-a.halfDrawWidth&&(g=s.right-a.halfDrawWidth),f.y<s.top+a.halfDrawHeight?m=s.top+a.halfDrawHeight:f.y>s.bottom-a.halfDrawHeight&&(m=s.bottom-a.halfDrawHeight),z(g,m)}}}const qp={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class lu{constructor(){this.events=new I,this.transform=fe.identity(),this.inverse=fe.identity(),this._cameraStrategies=[],this.strategy=new su(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new Hs(B.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=B.Zero,this.acc=B.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Gt.EaseInOutCubic,this._easing=Gt.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=z(0,0)}get zoom(){return this._z}set zoom(e){this._z=e,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(e){this._angularVelocity=e}get pos(){return this._pos}set pos(e){this._posChanged=!0,this._pos=new Hs(e,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(e){!this._follow&&!this._cameraMoving&&(this.pos=z(e,this.pos.y))}get y(){return this.pos.y}set y(e){!this._follow&&!this._cameraMoving&&(this.pos=z(this.pos.x,e))}get dx(){return this.vel.x}set dx(e){this.vel=z(e,this.vel.y)}get dy(){return this.vel.y}set dy(e){this.vel=z(this.vel.x,e)}get ax(){return this.acc.x}set ax(e){this.acc=z(e,this.acc.y)}get ay(){return this.acc.y}set ay(e){this.acc=z(this.acc.x,e)}getFocus(){return this.pos}move(e,s,r=Gt.EaseInOutCubic){if(typeof r!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(e):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(e),this._lerpPromise=new Promise(a=>{this._lerpResolve=a}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=s,this._lerpEnd=e,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=r,this._lerpPromise)}shake(e,s,r){this._isShaking=!0,this._shakeMagnitudeX=e,this._shakeMagnitudeY=s,this._shakeDuration=r}zoomOverTime(e,s=0,r=Gt.EaseInOutCubic){if(this._zoomPromise=new Promise(a=>{this._zoomResolve=a}),s)this._isZooming=!0,this._zoomEasing=r,this._currentZoomTime=0,this._zoomDuration=s,this._zoomStart=this.zoom,this._zoomEnd=e;else return this._isZooming=!1,this.zoom=e,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new ht(0,0,0,0)}addStrategy(e){this._cameraStrategies.push(e)}removeStrategy(e){ps(e,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(e,s){this.events.emit("preupdate",new Os(e,s,this)),this.onPreUpdate(e,s)}onPreUpdate(e,s){}_postupdate(e,s){this.events.emit("postupdate",new Ws(e,s,this)),this.onPostUpdate(e,s)}onPostUpdate(e,s){}get isInitialized(){return this._isInitialized}_initialize(e){if(!this.isInitialized){this._engine=e,this._screen=e.screen;const s=this._screen.contentArea;let r=z(s.width/2,s.height/2);if(!this._engine.loadingComplete){const a=this._screen.peekResolution();a&&(r=z(a.width/2,a.height/2))}this._halfWidth=r.x,this._halfHeight=r.y,this._posChanged||(this.pos=r),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(e,e.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(e),this.events.emit("initialize",new Gn(e,this)),this._isInitialized=!0}}onInitialize(e){}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}runStrategies(e,s){for(const r of this._cameraStrategies)this.pos=r.action.call(r,r.target,this,e,s)}updateViewport(){this._viewport=new ht(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(e,s){if(this._initialize(e),this._preupdate(e,s),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(s/1e3)),this.zoom+=this.dz*s/1e3,this.vel=this.vel.add(this.acc.scale(s/1e3)),this.dz+=this.az*s/1e3,this.rotation+=this.angularVelocity*s/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const r=this._zoomEasing,a=r(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=a,this._currentZoomTime+=s}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const a=Gt.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=a,this._currentLerpTime+=s}else{this.pos=this._lerpEnd;const r=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(r)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=s,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(e,s),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(e,s),this._posChanged=!1}draw(e){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const s=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,r=this.pos.scale(s).add(this._oldPos.scale(1-s));r.clone(this.drawPos),this.updateTransform(r)}if(e.snapToPixel){const s=this.drawPos.clone(this._snapPos);s.x=~~(s.x+pt*G(s.x)),s.y=~~(s.y+pt*G(s.y)),s.clone(this.drawPos),this.updateTransform(s)}e.multiply(this.transform)}updateTransform(e){const s=this._screen.resolution.width/this.zoom,r=this._screen.resolution.height/this.zoom,a=z(-e.x+s/2+this._xShake,-e.y+r/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(s/2,r/2),this.transform.rotate(this.rotation),this.transform.translate(-s/2,-r/2),this.transform.translate(a.x,a.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const Yp={ExitTrigger:"exit",EnterTrigger:"enter"};class cu extends Je{constructor(e){var s,r,a,l;super({...e}),this.events=new I,this.filter=(s=e.filter)!==null&&s!==void 0?s:()=>!0,this.repeat=(r=e.repeat)!==null&&r!==void 0?r:-1,this.action=(a=e.action)!==null&&a!==void 0?a:()=>{},this.target=e.target,this.graphics.isVisible=(l=e.visible)!==null&&l!==void 0?l:!1,this.body.collisionType=ft.Passive,this.events.on("collisionstart",({other:f})=>{this._matchesTarget(f.owner)&&(this.events.emit("enter",new wh(this,f.owner)),this._dispatchAction(f.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:f})=>{this._matchesTarget(f.owner)&&this.events.emit("exit",new xh(this,f.owner))})}_matchesTarget(e){return this.filter(e)&&(this.target===void 0||this.target===e)}_dispatchAction(e){this.repeat!==0&&(this.action.call(this,e),this.repeat--)}}const Qi={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var _i;(function(u){u.Update="update",u.Draw="draw"})(_i||(_i={}));class wi{}wi.priority=Qi.Average;class du{constructor(e){this._world=e,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>s=>{this.addEntity(s)},this._createChildRemovedHandler=()=>s=>{this.removeEntity(s,!1)},this._entitiesToRemove=[]}updateEntities(e,s){for(let r=0;r<this.entities.length;r++){const a=this.entities[r];a.update(e.engine,s),a.isActive||this.removeEntity(a)}}findEntitiesForRemoval(){for(let e=0;e<this.entities.length;e++){const s=this.entities[e];s.isActive||this.removeEntity(s)}}addEntity(e){if(e.isActive=!0,e.scene=this._world.scene,e&&!this._entityIndex[e.id]){this._entityIndex[e.id]=e,this.entities.push(e),this._world.queryManager.addEntity(e),e.children.forEach(a=>{a.scene=e.scene,this.addEntity(a)});const s=this._createChildAddedHandler();this._childAddedHandlerMap.set(e,s);const r=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(e,r),e.childrenAdded$.subscribe(s),e.childrenRemoved$.subscribe(r)}}removeEntity(e,s=!0){var r,a;let l=0;e instanceof Oe?l=e.id:l=e;const f=this._entityIndex[l];if(f&&f.isActive&&(f.isActive=!1),f&&s){this._entitiesToRemove.push(f);return}if(delete this._entityIndex[l],f){f.scene=null,ps(f,this.entities),this._world.queryManager.removeEntity(f),f.children.forEach(w=>{w.scene=null,this.removeEntity(w,s)});const g=this._childAddedHandlerMap.get(f);g&&f.childrenAdded$.unsubscribe(g);const m=this._childRemovedHandlerMap.get(f);m&&f.childrenRemoved$.unsubscribe(m),!((a=(r=this._world)===null||r===void 0?void 0:r.scene)===null||a===void 0)&&a.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let e=0;e<this._entitiesToRemove.length;e++){const s=this._entitiesToRemove[e];s.isActive||this.removeEntity(s,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let e=0;e<this.entities.length;e++)this.entities[e].processComponentRemoval()}getById(e){return this._entityIndex[e]}getByName(e){return this.entities.filter(s=>s.name===e)}clear(){for(let e=this.entities.length-1;e>=0;e--)this.removeEntity(this.entities[e])}}class Mr{constructor(e){if(this.requiredComponents=e,this.components=new Set,this.entities=[],this.entityAdded$=new je,this.entityRemoved$=new je,e.length===0)throw new Error("Cannot create query without components");for(const s of e)this.components.add(s);this.id=Mr.createId(e)}static createId(e){return e.slice().map(s=>s.name).sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAll(Array.from(this.components))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class Br{constructor(e){if(this.requiredTags=e,this.tags=new Set,this.entities=[],this.entityAdded$=new je,this.entityRemoved$=new je,e.length===0)throw new Error("Cannot create tag query without tags");for(const s of e)this.tags.add(s);this.id=Br.createId(e)}static createId(e){return e.slice().sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAllTags(Array.from(this.tags))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class uu{constructor(e){this._world=e,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=s=>r=>{this.addComponent(s,r)},this._createRemoveComponentHandler=s=>r=>{this.removeComponent(s,r)},this._createAddTagHandler=s=>r=>{this.addTag(s,r)},this._createRemoveTagHandler=s=>r=>{this.removeTag(s,r)}}createQuery(e){const s=Mr.createId(e);if(this._queries.has(s))return this._queries.get(s);const r=new Mr(e);this._queries.set(r.id,r);for(const a of e){const l=this._componentToQueriesIndex.get(a);l?l.push(r):this._componentToQueriesIndex.set(a,[r])}for(const a of this._world.entities)this.addEntity(a);return r}createTagQuery(e){const s=Br.createId(e);if(this._tagQueries.has(s))return this._tagQueries.get(s);const r=new Br(e);this._tagQueries.set(r.id,r);for(const a of e){const l=this._tagToQueriesIndex.get(a);l?l.push(r):this._tagToQueriesIndex.set(a,[r])}for(const a of this._world.entities)this.addEntity(a);return r}addEntity(e){const s=this._addComponentHandlers.get(e),r=this._removeComponentHandlers.get(e),a=s??this._createAddComponentHandler(e),l=r??this._createRemoveComponentHandler(e);this._addComponentHandlers.set(e,a),this._removeComponentHandlers.set(e,l);const f=this._addTagHandlers.get(e),g=this._removeTagHandlers.get(e),m=f??this._createAddTagHandler(e),w=g??this._createRemoveTagHandler(e);this._addTagHandlers.set(e,m),this._removeTagHandlers.set(e,w);for(const A of this._queries.values())A.checkAndAdd(e);for(const A of this._tagQueries.values())A.checkAndAdd(e);e.componentAdded$.subscribe(a),e.componentRemoved$.subscribe(l),e.tagAdded$.subscribe(m),e.tagRemoved$.subscribe(w)}removeEntity(e){const s=this._addComponentHandlers.get(e),r=this._removeComponentHandlers.get(e);for(const f of this._queries.values())f.removeEntity(e);s&&e.componentAdded$.unsubscribe(s),r&&e.componentRemoved$.unsubscribe(r);const a=this._addTagHandlers.get(e),l=this._removeTagHandlers.get(e);for(const f of this._tagQueries.values())f.removeEntity(e);a&&e.tagAdded$.unsubscribe(a),l&&e.tagRemoved$.unsubscribe(l)}addComponent(e,s){var r;const a=(r=this._componentToQueriesIndex.get(s.constructor))!==null&&r!==void 0?r:[];for(const l of a)l.checkAndAdd(e)}removeComponent(e,s){var r;const a=(r=this._componentToQueriesIndex.get(s.constructor))!==null&&r!==void 0?r:[];for(const l of a)l.removeEntity(e)}addTag(e,s){var r;const a=(r=this._tagToQueriesIndex.get(s))!==null&&r!==void 0?r:[];for(const l of a)l.checkAndAdd(e)}removeTag(e,s){var r;const a=(r=this._tagToQueriesIndex.get(s))!==null&&r!==void 0?r:[];for(const l of a)l.removeEntity(e)}}function fu(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class _u{constructor(e){this._world=e,this.systems=[],this.initialized=!1}get(e){return this.systems.find(s=>s instanceof e)}addSystem(e){let s;e instanceof wi?s=e:s=new e(this._world),this.systems.push(s),this.systems.sort((r,a)=>r.constructor.priority-a.constructor.priority),this.initialized&&s.initialize&&s.initialize(this._world,this._world.scene)}removeSystem(e){ps(e,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const e of this.systems)e.initialize&&e.initialize(this._world,this._world.scene)}}updateSystems(e,s,r){const a=this.systems.filter(l=>l.systemType===e);for(const l of a)l.preupdate&&l.preupdate(s,r);for(const l of a)l.update(r);for(const l of a)l.postupdate&&l.postupdate(s,r)}clear(){for(let e=this.systems.length-1;e>=0;e--)this.removeSystem(this.systems[e])}}class gu{constructor(e){this.scene=e,this._logger=at.getInstance(),this.queryManager=new uu(this),this.entityManager=new du(this),this.systemManager=new _u(this)}query(e){return this.queryManager.createQuery(e)}queryTags(e){return this.queryManager.createTagQuery(e)}update(e,s){e===_i.Update&&this.entityManager.updateEntities(this.scene,s),this.systemManager.updateSystems(e,this.scene,s),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(e){if(e instanceof Oe){this.entityManager.addEntity(e);return}if(e instanceof wi||fu(e)){this.systemManager.addSystem(e);return}this._logger.warn(`Could not add entity/system ${e.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(e){return this.systemManager.get(e)}remove(e,s=!0){if(e instanceof Oe){this.entityManager.removeEntity(e,s);return}if(e instanceof wi){this.systemManager.removeSystem(e);return}this._logger.warn(`Could not remove entity/system ${e.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class qo extends wi{constructor(e,s){super(),this.world=e,this.physics=s,this.systemType=_i.Update,this._physicsConfigDirty=!1,s.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([it,Bt])}update(e){let s,r;const a=this.query.entities,l=this.physics.config.substep;for(let f=0;f<a.length;f++){s=a[f].get(it),r=a[f].get(Bt);const g=a[f].get(Tt);if(this._physicsConfigDirty&&g&&g.updatePhysicsConfig(this.physics.config.bodies),g?.isSleeping)continue;const m=r.acc.clone();g?.collisionType===ft.Active&&g?.useGravity&&m.addEqual(this.physics.config.gravity),a[f].parent||this.captureOldTransformWithChildren(a[f]),Ze.integrate(s,r,m,e/l)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(e){var s;(s=e.get(Tt))===null||s===void 0||s.captureOldTransform();for(let r=0;r<e.children.length;r++)this.captureOldTransformWithChildren(e.children[r])}}qo.priority=Qi.Higher;class Nh{constructor(e){this.config=e,this.directionMap=new Map,this.distanceMap=new Map}solve(e){this.preSolve(e),e=e.filter(r=>!r.isCanceled());let s;switch(this.config.contactSolveBias){case bs.HorizontalFirst:{s=Mh;break}case bs.VerticalFirst:{s=Fh;break}default:s=Bh}e.sort((r,a)=>{const l=this.directionMap.get(r.id),f=this.directionMap.get(a.id),g=this.distanceMap.get(r.id),m=this.distanceMap.get(a.id);return s[l]-s[f]||g-m});for(const r of e)this.solvePosition(r),this.solveVelocity(r);return this.postSolve(e),e}preSolve(e){for(let r=0;r<e.length;r++){const a=e[r];if(Math.abs(a.mtv.x)<1e-4&&Math.abs(a.mtv.y)<1e-4){a.cancel();continue}const l=Rt.fromDirection(a.mtv),f=a.mtv.negate(),g=Math.abs(a.info.separation);this.distanceMap.set(a.id,g),this.directionMap.set(a.id,l===Rt.Left||l===Rt.Right?"horizontal":"vertical"),a.colliderA.events.emit("precollision",new on(a.colliderA,a.colliderB,l,f,a)),a.colliderB.events.emit("precollision",new on(a.colliderB,a.colliderA,Rt.getOpposite(l),f.negate(),a))}}postSolve(e){var s,r;for(let a=0;a<e.length;a++){const l=e[a];if(l.isCanceled())continue;const f=l.colliderA,g=l.colliderB,m=(s=f.owner)===null||s===void 0?void 0:s.get(Tt),w=(r=g.owner)===null||r===void 0?void 0:r.get(Tt);if(m&&w&&(m.collisionType===ft.Passive||w.collisionType===ft.Passive))continue;const A=Rt.fromDirection(l.mtv),y=l.mtv.negate();l.colliderA.events.emit("postcollision",new an(l.colliderA,l.colliderB,A,y,l)),l.colliderB.events.emit("postcollision",new an(l.colliderB,l.colliderA,Rt.getOpposite(A),y.negate(),l))}}solvePosition(e){var s,r;if(!e.colliderA.bounds.overlaps(e.colliderB.bounds,1e-4)){e.cancel();return}if(Math.abs(e.mtv.x)<1e-4&&Math.abs(e.mtv.y)<1e-4){e.cancel();return}let l=e.mtv;const f=e.colliderA,g=e.colliderB,m=(s=f.owner)===null||s===void 0?void 0:s.get(Tt),w=(r=g.owner)===null||r===void 0?void 0:r.get(Tt);if(m&&w){if(m.collisionType===ft.Passive||w.collisionType===ft.Passive)return;m.collisionType===ft.Active&&w.collisionType===ft.Active&&(l=l.scale(.5)),m.collisionType===ft.Active&&(m.globalPos.x-=l.x,m.globalPos.y-=l.y,f.update(m.transform.get())),w.collisionType===ft.Active&&(w.globalPos.x+=l.x,w.globalPos.y+=l.y,g.update(w.transform.get()))}}solveVelocity(e){var s,r;if(e.isCanceled())return;const a=e.colliderA,l=e.colliderB,f=(s=a.owner)===null||s===void 0?void 0:s.get(Tt),g=(r=l.owner)===null||r===void 0?void 0:r.get(Tt);if(f&&g){if(f.collisionType===ft.Passive||g.collisionType===ft.Passive)return;const m=e.normal,w=m.negate();if(f.collisionType===ft.Active&&f.vel.normalize().dot(w)<0){const A=m.scale(m.dot(f.vel.negate()));f.vel=f.vel.add(A)}if(g.collisionType===ft.Active&&g.vel.normalize().dot(m)<0){const A=w.scale(w.dot(g.vel.negate()));g.vel=g.vel.add(A)}}}}class pu{constructor(e,s,r){this.point=e,this.local=s,this.contact=r,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new B(0,0),this.bToContact=new B(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const e=this.contact.bodyA,s=this.contact.colliderA,r=this.contact.bodyB,a=this.contact.colliderB;if(e&&r){const l=this.contact.normal,f=this.contact.tangent;this.aToContact=this.point.sub(s.center),this.bToContact=this.point.sub(a.center);const g=this.aToContact.cross(l),m=this.bToContact.cross(l);this.normalMass=e.inverseMass+r.inverseMass+e.inverseInertia*g*g+r.inverseInertia*m*m;const w=this.aToContact.cross(f),A=this.bToContact.cross(f);this.tangentMass=e.inverseMass+r.inverseMass+e.inverseInertia*w*w+r.inverseInertia*A*A}return this}getRelativeVelocity(){const e=this.contact.bodyA,s=this.contact.bodyB;if(e&&s){const r=e.vel.add(B.cross(e.angularVelocity,this.aToContact));return s.vel.add(B.cross(s.angularVelocity,this.bToContact)).sub(r)}return B.Zero}}class Gh{constructor(e){this.config=e,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(e){var s;return(s=this.idToContactConstraint.get(e))!==null&&s!==void 0?s:[]}solve(e){this.preSolve(e),e=e.filter(r=>!r.isCanceled());let s;switch(this.config.contactSolveBias){case bs.HorizontalFirst:{s=Mh;break}case bs.VerticalFirst:{s=Fh;break}default:s=Bh}return e.sort((r,a)=>{const l=this.directionMap.get(r.id),f=this.directionMap.get(a.id),g=this.distanceMap.get(r.id),m=this.distanceMap.get(a.id);return s[l]-s[f]||g-m}),this.solveVelocity(e),this.solvePosition(e),this.postSolve(e),e}preSolve(e){var s,r,a,l;for(let m=0;m<e.length;m++){const w=e[m];if(Math.abs(w.mtv.x)<1e-4&&Math.abs(w.mtv.y)<1e-4){w.cancel();continue}const A=Rt.fromDirection(w.mtv),y=Math.abs(((s=w?.info)===null||s===void 0?void 0:s.separation)||0);this.distanceMap.set(w.id,y),this.directionMap.set(w.id,A===Rt.Left||A===Rt.Right?"horizontal":"vertical"),w.colliderA.events.emit("precollision",new on(w.colliderA,w.colliderB,A,w.mtv,w)),w.colliderA.events.emit("beforecollisionresolve",new ko(w.colliderA,w.colliderB,A,w.mtv,w)),w.colliderB.events.emit("precollision",new on(w.colliderB,w.colliderA,Rt.getOpposite(A),w.mtv.negate(),w)),w.colliderB.events.emit("beforecollisionresolve",new ko(w.colliderB,w.colliderA,Rt.getOpposite(A),w.mtv.negate(),w)),w.matchAwake()}const g=Array.from(this.idToContactConstraint.keys());for(let m=0;m<e.length;m++){const w=e[m],A=g.indexOf(w.id);A>-1&&g.splice(A,1);const y=(r=this.idToContactConstraint.get(w.id))!==null&&r!==void 0?r:[];let E=0;const D=w.bodyA,L=w.colliderA,O=w.bodyB,q=w.colliderB;if(D&&O)for(let H=0;H<w.points.length;H++){const V=w.points[H],J=w.normal,Y=w.tangent,$=V.sub(L.center),ot=V.sub(q.center),Z=$.cross(J),gt=ot.cross(J),It=D.inverseMass+O.inverseMass+D.inverseInertia*Z*Z+O.inverseInertia*gt*gt,Yt=$.cross(Y),Qt=ot.cross(Y),Pe=D.inverseMass+O.inverseMass+D.inverseInertia*Yt*Yt+O.inverseInertia*Qt*Qt;y[E]&&((l=(a=y[E])===null||a===void 0?void 0:a.point)===null||l===void 0?void 0:l.squareDistance(V))<4?(y[E].point=V,y[E].local=w.localPoints[E]):y[E]=new pu(V,w.localPoints[E],w),y[E].aToContact=$,y[E].bToContact=ot,y[E].normalMass=1/It,y[E].tangentMass=1/Pe;const te=D.bounciness>O.bounciness?D.bounciness:O.bounciness,Ht=w.normal.dot(y[E].getRelativeVelocity());y[E].originalVelocityAndRestitution=0,Ht<-.1&&(y[E].originalVelocityAndRestitution=-te*Ht),E++}this.idToContactConstraint.set(w.id,y)}for(const m of g)this.idToContactConstraint.delete(m);if(this.config.warmStart)this.warmStart(e);else for(let m=0;m<e.length;m++){const w=e[m],A=this.getContactConstraints(w.id);for(const y of A)y.normalImpulse=0,y.tangentImpulse=0}}postSolve(e){for(let s=0;s<e.length;s++){const r=e[s],a=r.bodyA,l=r.bodyB;if(a&&l){if(a.collisionType===ft.Passive||l.collisionType===ft.Passive)continue;a.updateMotion(),l.updateMotion()}const f=Rt.fromDirection(r.mtv);r.colliderA.events.emit("postcollision",new an(r.colliderA,r.colliderB,f,r.mtv,r)),r.colliderA.events.emit("aftercollisionresolve",new Lo(r.colliderA,r.colliderB,f,r.mtv,r)),r.colliderB.events.emit("postcollision",new an(r.colliderB,r.colliderA,Rt.getOpposite(f),r.mtv.negate(),r)),r.colliderB.events.emit("aftercollisionresolve",new Lo(r.colliderB,r.colliderA,Rt.getOpposite(f),r.mtv.negate(),r))}this.lastFrameContacts.clear();for(let s=0;s<e.length;s++){const r=e[s];this.lastFrameContacts.set(r.id,r)}}warmStart(e){var s;for(let r=0;r<e.length;r++){const a=e[r],l=a.bodyA,f=a.bodyB;if(l&&f){const g=(s=this.idToContactConstraint.get(a.id))!==null&&s!==void 0?s:[];for(const m of g)if(this.config.warmStart){const w=a.normal.scale(m.normalImpulse),A=a.tangent.scale(m.tangentImpulse),y=w.add(A);l.applyImpulse(m.point,y.negate()),f.applyImpulse(m.point,y)}else m.normalImpulse=0,m.tangentImpulse=0}}}solvePosition(e){var s;for(let r=0;r<this.config.positionIterations;r++)for(let a=0;a<e.length;a++){const l=e[a],f=l.bodyA,g=l.bodyB;if(f&&g){if(f.collisionType===ft.Passive||g.collisionType===ft.Passive)continue;const m=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const w of m){const A=l.normal,y=Li.FindContactSeparation(l,w.local),E=this.config.steeringFactor,D=-5,L=this.config.slop,O=j(E*(y+L),D,0),q=A.scale(-O*w.normalMass);if(f.collisionType===ft.Active){const H=q.negate().scale(f.inverseMass);f.limitDegreeOfFreedom.includes(ri.X)&&(H.x=0),f.limitDegreeOfFreedom.includes(ri.Y)&&(H.y=0),f.globalPos=f.globalPos.add(H),f.limitDegreeOfFreedom.includes(ri.Rotation)||(f.rotation-=w.aToContact.cross(q)*f.inverseInertia)}if(g.collisionType===ft.Active){const H=q.scale(g.inverseMass);g.limitDegreeOfFreedom.includes(ri.X)&&(H.x=0),g.limitDegreeOfFreedom.includes(ri.Y)&&(H.y=0),g.globalPos=g.globalPos.add(H),g.limitDegreeOfFreedom.includes(ri.Rotation)||(g.rotation+=w.bToContact.cross(q)*g.inverseInertia)}}}}}solveVelocity(e){var s;for(let r=0;r<this.config.velocityIterations;r++)for(let a=0;a<e.length;a++){const l=e[a],f=l.bodyA,g=l.bodyB;if(f&&g){if(f.collisionType===ft.Passive||g.collisionType===ft.Passive)continue;const m=Math.min(f.friction,g.friction),w=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const A of w){let D=-A.getRelativeVelocity().dot(l.tangent)*A.tangentMass;const L=m*A.normalImpulse,O=j(A.tangentImpulse+D,-L,L);D=O-A.tangentImpulse,A.tangentImpulse=O;const q=l.tangent.scale(D);f.applyImpulse(A.point,q.negate()),g.applyImpulse(A.point,q)}for(const A of w){const E=A.getRelativeVelocity().dot(l.normal);let D=-A.normalMass*(E-A.originalVelocityAndRestitution);const L=Math.max(A.normalImpulse+D,0);D=L-A.normalImpulse,A.normalImpulse=L;const O=l.normal.scale(D);f.applyImpulse(A.point,O.negate()),g.applyImpulse(A.point,O)}}}}}class Yo extends wi{get _processor(){return this._physics.collisionProcessor}constructor(e,s){super(),this._physics=s,this.systemType=_i.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new Nh(s.config.arcade),this._realisticSolver=new Gh(s.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=r=>this._processor.track(r),this._untrackCollider=r=>this._processor.untrack(r),this.query=e.query([it,Bt,pe]),this.query.entityAdded$.subscribe(r=>{const a=r.get(pe);a.$colliderAdded.subscribe(this._trackCollider),a.$colliderRemoved.subscribe(this._untrackCollider);const l=a.get();l&&this._processor.track(l)}),this.query.entityRemoved$.subscribe(r=>{const a=r.get(pe),l=a.get();a&&l&&this._processor.untrack(l)}),this._motionSystem=e.get(qo)}initialize(e,s){this._engine=s.engine}update(e){var s,r,a,l;if(!this._physics.config.enabled)return;let f=[];for(let y=0;y<this.query.entities.length;y++){const D=this.query.entities[y].get(pe),L=D?.get();if(D&&(!((s=D.owner)===null||s===void 0)&&s.isActive)&&L)if(D.update(),L instanceof Ce){const O=L.getColliders();L.compositeStrategy||(L.compositeStrategy=this._physics.config.colliders.compositeStrategy),f=f.concat(O)}else f.push(L)}this._processor.update(f,e);let g=this._processor.broadphase(f,e);this._currentFrameContacts.clear();let m=[];const w=this.getSolver(),A=this._physics.config.substep;for(let y=0;y<A;y++)if(y>0&&this._motionSystem.update(e),m.length&&(g=m.map(E=>new Qe(E.colliderA,E.colliderB))),g.length){m=this._processor.narrowphase(g,(l=(a=(r=this._engine)===null||r===void 0?void 0:r.debug)===null||a===void 0?void 0:a.stats)===null||l===void 0?void 0:l.currFrame),m=w.solve(m);for(const E of m){if(E.isCanceled())continue;const D=E.id.indexOf("|");if(D>0){const L=E.id.substring(D+1);this._currentFrameContacts.set(L,E)}else this._currentFrameContacts.set(E.id,E)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const y of this.query.entities){const E=y.get(pe);E&&E.processColliderRemoval()}}postupdate(){ge.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new Nh(this._physics.config.arcade),this._realisticSolver=new Gh(this._physics.config.realistic)),this._physics.config.solver===Er.Realistic?this._realisticSolver:this._arcadeSolver}debug(e){this._processor.debug(e,0)}runContactStartEnd(){for(const[e,s]of this._currentFrameContacts)if(!this._lastFrameContacts.has(e)){const r=s.colliderA,a=s.colliderB,l=Rt.fromDirection(s.mtv),f=Rt.getOpposite(l);r.events.emit("collisionstart",new yr(r,a,l,s)),r.events.emit("contactstart",new Mo(r,a,l,s)),a.events.emit("collisionstart",new yr(a,r,f,s)),a.events.emit("contactstart",new Mo(a,r,f,s))}for(const[e,s]of this._lastFrameContacts)if(!this._currentFrameContacts.has(e)){const r=s.colliderA,a=s.colliderB,l=Rt.fromDirection(s.mtv),f=Rt.getOpposite(l);r.events.emit("collisionend",new Cr(r,a,l,s)),r.events.emit("contactend",new Bo(r,a,l,s)),a.events.emit("collisionend",new Cr(a,r,f,s)),a.events.emit("contactend",new Bo(a,r,f,s))}}}Yo.priority=Qi.Higher;function jp(u,e,s,r){if(u.parent!==e.parent){const A=u.clone(),y=u.globalPos.clone(),E=u.globalScale.clone(),D=u.globalRotation;A.parent=e.parent,A.globalPos=y,A.globalScale=E,A.globalRotation=D,u=A}let a=e.pos,l=e.scale,f=e.rotation;a=e.pos.scale(s).add(u.pos.scale(1-s)),l=e.scale.scale(s).add(u.scale.scale(1-s));const g=(1-s)*Math.cos(u.rotation)+s*Math.cos(e.rotation),m=(1-s)*Math.sin(u.rotation)+s*Math.sin(e.rotation);f=Math.atan2(m,g);const w=r??new vs;return w.setTransform(a,f,l),w}class Xh extends wi{get sortedTransforms(){return this._sortedTransforms}constructor(e){super(),this.world=e,this.systemType=_i.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new vs,this.query=this.world.query([it,ne]),this.query.entityAdded$.subscribe(s=>{const r=s.get(it);this._sortedTransforms.push(r),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{const r=s.get(it);r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const a=this._sortedTransforms.indexOf(r);a>-1&&this._sortedTransforms.splice(a,1)})}initialize(e,s){this._camera=s.camera,this._engine=s.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>e.globalZ-s.globalZ),this._zHasChanged=!1)}update(e){this._token++;let s;Ut.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let r=0;r<this._sortedTransforms.length;r++){const a=this._sortedTransforms[r],l=a.owner;if(l.hasTag("ex.offscreen")||(s=l.get(ne),!s.isVisible))continue;s.onPreTransformDraw&&s.onPreTransformDraw(this._graphicsContext,e),l.events.emit("pretransformdraw",new sh(this._graphicsContext,e,l)),a.coordPlane===De.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),a.coordPlane===De.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),s.update(e,this._token);const f=l.get(No);if(f){const g=B.One.sub(f.parallaxFactor),m=this._camera.drawPos.scale(g);this._graphicsContext.translate(m.x,m.y)}this._applyTransform(l),s.material&&(this._graphicsContext.material=s.material),s.onPreDraw&&s.onPreDraw(this._graphicsContext,e),l.events.emit("predraw",new Vn(this._graphicsContext,e,l)),this._applyOpacity(l),this._drawGraphicsComponent(s,a),s.onPostDraw&&s.onPostDraw(this._graphicsContext,e),l.events.emit("postdraw",new Nn(this._graphicsContext,e,l)),this._graphicsContext.restore(),a.coordPlane===De.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),s.onPostTransformDraw&&s.onPostTransformDraw(this._graphicsContext,e),l.events.emit("posttransformdraw",new nh(this._graphicsContext,e,l))}this._graphicsContext.restore()}_drawGraphicsComponent(e,s){var r,a;if(e.isVisible){const l=e.flipHorizontal,f=e.flipVertical,g=e.current,m=(r=e.currentOptions)!==null&&r!==void 0?r:{};if(g){let w=e.anchor,A=e.offset,y=1,E=1;m?.anchor&&(w=m.anchor),m?.offset&&(A=m.offset);const D=s.globalScale;y*=g.scale.x*D.x,E*=g.scale.y*D.y;const L=-g.width*w.x+A.x*y,O=-g.height*w.y+A.y*E,q=g.flipHorizontal,H=g.flipVertical;if((l||f)&&(g.flipHorizontal=l?!q:q,g.flipVertical=f?!H:H),g?.draw(this._graphicsContext,L,O),(l||f)&&(g.flipHorizontal=q,g.flipVertical=H),!((a=this._engine)===null||a===void 0)&&a.isDebug&&this._engine.debug.graphics.showBounds){const V=z(L,O);if(g instanceof Hn)for(const J of g.members){let Y,$=B.Zero;J instanceof ie?Y=J:(Y=J.graphic,$=J.offset),g.useAnchor?Y?.localBounds.translate(V.add($)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):Y?.localBounds.translate($).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else g?.localBounds.translate(V).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(e){const s=e.getAncestors();for(let r=0;r<s.length;r++){const a=s[r],l=a?.get(it),f=a?.get(Tt);if(l){let g=l.get();if(f&&this._engine.fixedUpdateTimestep&&f.__oldTransformCaptured&&f.enableFixedUpdateInterpolate){const m=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;g=jp(f.oldTransform,l.get(),m,this._targetInterpolationTransform)}this._graphicsContext.z=l.globalZ,this._graphicsContext.translate(g.pos.x,g.pos.y),this._graphicsContext.scale(g.scale.x,g.scale.y),this._graphicsContext.rotate(g.rotation)}}}_applyOpacity(e){var s;const r=e.getAncestors();for(let a=0;a<r.length;a++){const l=r[a],f=l?.get(ne);this._graphicsContext.opacity*=(s=f?.opacity)!==null&&s!==void 0?s:1}}}Xh.priority=Qi.Average;class qh extends wi{constructor(e){super(),this.world=e,this.systemType=_i.Draw,this.query=this.world.query([it])}initialize(e,s){this._graphicsContext=s.engine.graphicsContext,this._camera=s.camera,this._engine=s.engine,this._collisionSystem=e.systemManager.get(Yo)}update(){var e;if(!this._engine.isDebug)return;const s=this._engine.debug.filter;let r,a;const l=this._engine.debug.entity;let f;const g=this._engine.debug.transform;let m;const w=this._engine.debug.motion;let A;const y=this._engine.debug.collider,E=this._engine.debug.physics;let D;const L=this._engine.debug.graphics;let O,q;const H=this._engine.debug.body,V=this._engine.debug.camera;for(let J=0;J<this.query.entities.length;J++){const Y=this.query.entities[J];if(Y.hasTag("offscreen")||Y instanceof Uo||s.useFilter&&(!(s.ids.length===0||s.ids.includes(Y.id))||!(s.nameQuery===""||Y.name.includes(s.nameQuery))))continue;let $=B.Zero;const ot=z(0,16);if(r=Y.id,a=Y.name,f=Y.get(it),this._pushCameraTransform(f),this._graphicsContext.save(),f.coordPlane===De.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=g.debugZIndex,this._applyTransform(Y),f&&((g.showAll||g.showPosition)&&this._graphicsContext.debug.drawPoint(B.Zero,{size:4,color:g.positionColor}),(g.showAll||g.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${f.pos.toString(2)}`,$),$=$.add(ot)),(g.showAll||g.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${f.z.toFixed(1)})`,$),$=$.add(ot)),(l.showAll||l.showId)&&(this._graphicsContext.debug.drawText(`id(${r}) ${Y.parent?"child of id("+((e=Y.parent)===null||e===void 0?void 0:e.id)+")":""}`,$),$=$.add(ot)),(l.showAll||l.showName)&&(this._graphicsContext.debug.drawText(`name(${a})`,$),$=$.add(ot)),(g.showAll||g.showRotation)&&(this._graphicsContext.drawLine(B.Zero,B.fromAngle(f.rotation).scale(50).add(B.Zero),g.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${lt(f.rotation).toFixed(2)})`,$),$=$.add(ot)),(g.showAll||g.showScale)&&this._graphicsContext.drawLine(B.Zero,f.scale.add(B.Zero),g.scaleColor,2)),D=Y.get(ne),D&&(L.showAll||L.showBounds)&&D.localBounds.draw(this._graphicsContext,L.boundsColor),O=Y.get(Go),O&&(O.useTransform||this._graphicsContext.restore(),O.draw(this._graphicsContext,this._engine.debug),O.useTransform||(this._graphicsContext.save(),this._applyTransform(Y))),q=Y.get(Tt),q&&((H.showAll||H.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${q.group.name})`,$),$=$.add(ot)),(H.showAll||H.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${q.collisionType})`,$),$=$.add(ot)),(H.showAll||H.showMass)&&(this._graphicsContext.debug.drawText(`mass(${q.mass})`,$),$=$.add(ot)),(H.showAll||H.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${q.sleepMotion})`,$),$=$.add(ot)),(H.showAll||H.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${q.canSleep?q.isSleeping:"cant sleep"})`,$),$=$.add(ot))),this._graphicsContext.restore(),this._graphicsContext.save(),f.coordPlane===De.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=g.debugZIndex,m=Y.get(Bt),m&&((w.showAll||w.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${m.vel.toString(2)}`,$.add(f.globalPos)),this._graphicsContext.drawLine(f.globalPos,f.globalPos.add(m.vel),w.velocityColor,2),$=$.add(ot)),(w.showAll||w.showAcceleration)&&this._graphicsContext.drawLine(f.globalPos,f.globalPos.add(m.acc),w.accelerationColor,2)),A=Y.get(pe),A){const Z=A.get();if((y.showAll||y.showGeometry)&&Z&&Z.debug(this._graphicsContext,y.geometryColor,{lineWidth:y.geometryLineWidth,pointSize:y.geometryPointSize}),y.showAll||y.showBounds){if(Z instanceof Ce){const gt=Z.getColliders();for(const It of gt){const Yt=It.bounds,Qt=z(Yt.left,Yt.top);this._graphicsContext.debug.drawRect(Qt.x,Qt.y,Yt.width,Yt.height,{color:y.boundsColor}),(y.showAll||y.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${It.owner.id})`,Qt)}A.bounds.draw(this._graphicsContext,y.boundsColor)}else if(Z){const gt=A.bounds,It=z(gt.left,gt.top);this._graphicsContext.debug.drawRect(It.x,It.y,gt.width,gt.height,{color:y.boundsColor}),(y.showAll||y.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${A.owner.id})`,It)}}}this._graphicsContext.restore(),this._popCameraTransform(f)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(E.showAll||E.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),E.showAll||E.showCollisionContacts||E.showCollisionNormals)for(const[J,Y]of this._engine.debug.stats.currFrame.physics.contacts){if(E.showAll||E.showCollisionContacts)for(const $ of Y.points)this._graphicsContext.debug.drawPoint($,{size:E.contactSize,color:E.collisionContactColor});if(E.showAll||E.showCollisionNormals)for(const $ of Y.points)this._graphicsContext.debug.drawLine($,Y.normal.scale(30).add($),{color:E.collisionNormalColor})}this._graphicsContext.restore(),V&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(V.showAll||V.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,V.focusColor),(V.showAll||V.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(e,s){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),Se.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(e){const s=e.getAncestors();for(const r of s){const a=r?.get(it);a&&(this._graphicsContext.translate(a.pos.x,a.pos.y),this._graphicsContext.scale(a.scale.x,a.scale.y),this._graphicsContext.rotate(a.rotation))}}_pushCameraTransform(e){e.coordPlane===De.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(e){e.coordPlane===De.World&&this._graphicsContext.restore()}}qh.priority=Qi.Lowest;class Yh{constructor(e,s){this.object=e,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=s,this.bounds=e.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const e=this.object.bounds,s=Math.floor(e.left/this.gridSize),r=Math.floor(e.right/this.gridSize),a=Math.floor(e.bottom/this.gridSize),l=Math.floor(e.top/this.gridSize);return this.leftX!==s||this.rightX!==r||this.bottomY!==a||this.topY!==l}clear(){for(const e of this.cells){const s=e.proxies.indexOf(this);s>-1&&e.proxies.splice(s,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class Ji{constructor(){this.proxies=[]}configure(e,s){this.x=e,this.y=s,this.key=Ji.calculateHashKey(e,s)}static calculateHashKey(e,s){return`${e}+${s}`}}class jh{constructor(e){this.bounds=new ht,this._hashGridCellPool=new mr(()=>new Ji,s=>(s.configure(0,0),s.proxies.length=0,s),1e3),this.gridSize=e.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,e.proxyFactory?this._buildProxy=s=>e.proxyFactory(s,this.gridSize):this._buildProxy=s=>new Yh(s,this.gridSize)}query(e){const s=new Set;if(e instanceof ht){const r=e,a=Math.floor(r.left/this.gridSize),l=Math.floor(r.right/this.gridSize),f=Math.floor(r.bottom/this.gridSize),g=Math.floor(r.top/this.gridSize);for(let m=a;m<=l;m++)for(let w=g;w<=f;w++){const A=Ji.calculateHashKey(m,w),y=this.sparseHashGrid.get(A);if(y)for(let E=0;E<y.proxies.length;E++)y.proxies[E].updateBounds(),y.proxies[E].bounds.intersect(r)&&s.add(y.proxies[E].object)}}else{const r=e,a=Ji.calculateHashKey(Math.floor(r.x/this.gridSize),Math.floor(r.y/this.gridSize)),l=this.sparseHashGrid.get(a);if(l)for(let f=0;f<l.proxies.length;f++)l.proxies[f].updateBounds(),l.proxies[f].bounds.contains(r)&&s.add(l.proxies[f].object)}return Array.from(s)}get(e,s){const r=Ji.calculateHashKey(e,s);return this.sparseHashGrid.get(r)}_insert(e,s,r){const a=Ji.calculateHashKey(e,s);let l=this.sparseHashGrid.get(a);l||(l=this._hashGridCellPool.rent(),l.configure(e,s),this.sparseHashGrid.set(l.key,l)),l.proxies.push(r),r.cells.push(l),this.bounds.combine(r.bounds,this.bounds)}_remove(e,s,r){const a=Ji.calculateHashKey(e,s),l=this.sparseHashGrid.get(a);if(l){const f=l.proxies.indexOf(r);f>-1&&l.proxies.splice(f,1);const g=r.cells.indexOf(l);g>-1&&r.cells.splice(g,1),l.proxies.length===0&&(this._hashGridCellPool.return(l),this.sparseHashGrid.delete(a))}}track(e){const s=this._buildProxy(e);this.objectToProxy.set(e,s);for(let r=s.leftX;r<=s.rightX;r++)for(let a=s.topY;a<=s.bottomY;a++)this._insert(r,a,s)}untrack(e){const s=this.objectToProxy.get(e);s&&(s.clear(),this.objectToProxy.delete(e))}update(e){let s=0;for(const r of e){const a=this.objectToProxy.get(r);if(a&&a.hasChanged()){for(let l=a.leftX;l<=a.rightX;l++)for(let f=a.topY;f<=a.bottomY;f++)this._remove(l,f,a);a.update();for(let l=a.leftX;l<=a.rightX;l++)for(let f=a.topY;f<=a.bottomY;f++)this._insert(l,f,a);s++}}return s}debug(e,s){const r=Q.Transparent,a=Q.White;for(const l of this.sparseHashGrid.values())e.drawRectangle(z(l.x*this.gridSize,l.y*this.gridSize),this.gridSize,this.gridSize,r,a,2)}}class jo extends wi{constructor(e){super(),this.world=e,this.systemType=_i.Update,this._graphicsHashGrid=new jh({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new Vh,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([it,Ns]),this.query.entityAdded$.subscribe(s=>{const r=s.get(it),a=s.get(Ns);this._pointerEventDispatcher.addObject(s,f=>a&&a.localBounds?a.localBounds.transform(r.get().matrix).contains(r.coordPlane===De.World?f.worldPos:f.screenPos):!1,()=>s.isActive),this._entityToPointer.set(s,a);const l=s.get(ne);l&&(this._graphics.push(l),this._graphicsHashGrid.track(l)),this._sortedTransforms.push(r),this._sortedEntities.push(r.owner),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{this._pointerEventDispatcher.removeObject(s);const r=s.get(it);this._entityToPointer.delete(s);const a=s.get(ne);if(a){const f=this._graphics.indexOf(a);f>-1&&this._graphics.splice(f,1),this._graphicsHashGrid.untrack(a)}r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const l=this._sortedTransforms.indexOf(r);l>-1&&(this._sortedTransforms.splice(l,1),this._sortedEntities.splice(l,1))})}initialize(e,s){this._engine=s.engine,this._scene=s}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>s.z-e.z),this._sortedEntities=this._sortedTransforms.map(e=>e.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[e,s]of this._engineReceiver.currentFramePointerCoords.entries()){const r=this._scene.physics.query(s.worldPos);for(let l=0;l<r.length;l++){const f=r[l],g=this._entityToPointer.get(f.owner);g&&(g.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(f.owner,e)}const a=this._graphicsHashGrid.query(s.worldPos);for(let l=0;l<a.length;l++){const f=a[l],g=this._entityToPointer.get(f.owner);g&&(g.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(f.owner,e)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(e=>e.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(e=>e.clear())}}jo.priority=Qi.Higher;class Zh extends wi{constructor(e){super(),this.world=e,this.systemType=_i.Update,this._actions=[],this.query=this.world.query([qn]),this.query.entityAdded$.subscribe(s=>this._actions.push(s.get(qn))),this.query.entityRemoved$.subscribe(s=>{const r=s.get(qn),a=this._actions.indexOf(r);a>-1&&this._actions.splice(a,1)})}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}}Zh.priority=Qi.Higher;class kr extends Si{constructor(e){super(),this.elevation=0,this.columns=e.columns,this.rows=e.rows,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight}}class Qh extends wi{constructor(e){super(),this.world=e,this.systemType=_i.Update,this.query=this.world.query([it,kr])}update(){let e,s;for(let r=0;r<this.query.entities.length;r++){const a=this.query.entities[r];e=a.get(it),s=a.get(kr);const f=Math.max(s.columns*s.tileWidth,s.rows*s.tileHeight)*s.elevation+e.pos.y;e.z=f}}}Qh.priority=Qi.Lower;class Jh extends wi{constructor(e){super(),this.world=e,this.systemType=_i.Draw,this.query=this.world.query([it,ne])}initialize(e,s){this._camera=s.camera,this._screen=s.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let e,s,r;for(let a=0;a<this.query.entities.length;a++){const l=this.query.entities[a];s=l.get(ne),e=l.get(it),r=l.get(No);let f;if(r){const m=B.One.sub(r.parallaxFactor);f=this._camera.pos.scale(m)}const g=this._isOffscreen(e,s,f);g&&!l.hasTag("ex.offscreen")&&(l.events.emit("exitviewport",new mh(l)),l.addTag("ex.offscreen")),!g&&l.hasTag("ex.offscreen")&&(l.events.emit("enterviewport",new vh(l)),l.removeTag("ex.offscreen"))}}_isOffscreen(e,s,r){if(s.forceOnScreen)return!1;if(e.coordPlane===De.World){let a=s.localBounds;r&&(a=a.translate(r));const l=a.transform(e.get().matrix);return!this._worldBounds.overlaps(l)}else return!1}}Jh.priority=Qi.Higher;class mu extends Yh{constructor(e,s){var r,a;super(e,s),this.collider=e,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=s;const l=e.bounds;this.hasZeroBounds=l.hasZeroDimensions(),this.leftX=Math.floor(l.left/this.gridSize),this.rightX=Math.floor(l.right/this.gridSize),this.bottomY=Math.floor(l.bottom/this.gridSize),this.topY=Math.floor(l.top/this.gridSize),this.owner=e.owner,this.body=(r=this.owner)===null||r===void 0?void 0:r.get(Tt),this.collisionType=(a=this.body.collisionType)!==null&&a!==void 0?a:ft.PreventCollision}update(){var e,s;super.update(),this.body=(e=this.owner)===null||e===void 0?void 0:e.get(Tt),this.collisionType=(s=this.body.collisionType)!==null&&s!==void 0?s:ft.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class Kh{constructor(e){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new So(()=>new Qe({id:S("collider",0)},{id:S("collider",0)}),s=>(s.colliderA=null,s.colliderB=null,s),200),this.gridSize=e.size,this.hashGrid=new jh({size:this.gridSize,proxyFactory:(s,r)=>new mu(s,r)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(e){return this.hashGrid.query(e)}rayCast(e,s){var r,a,l;const f=[],g=(r=s?.maxDistance)!==null&&r!==void 0?r:1/0,m=s?.collisionGroup,w=m?m.category:(a=s?.collisionMask)!==null&&a!==void 0?a:xs.All.category,A=(l=s?.searchAllColliders)!==null&&l!==void 0?l:!1,y=e.dir.normalize(),E=y.y/y.x,D=y.x/y.y,L=Math.sqrt(1+E*E)*this.gridSize,O=Math.sqrt(1+D*D)*this.gridSize,q=e.pos.x/this.gridSize,H=e.pos.y/this.gridSize,V=z(1,1);let J=~~q,Y=~~H,$=0,ot=0;y.x<0?(V.x=-1,$=(q-J)*L):(V.x=1,$=(J+1-q)*L),y.y<0?(V.y=-1,ot=(H-Y)*O):(V.y=1,ot=(Y+1-H)*O);const Z=new Set;let gt=!1,It=9999;for(;!gt&&It>0&&(It--,!!this.hashGrid.bounds.contains(z(J*this.gridSize,Y*this.gridSize)));){const Yt=Ji.calculateHashKey(J,Y),Qt=this.hashGrid.sparseHashGrid.get(Yt);if(Qt){const Pe=[];for(let te=0;te<Qt.proxies.length;te++){const Ht=Qt.proxies[te];if(!Z.has(Ht.collider.id.value)){if(Z.add(Ht.collider.id.value),s?.ignoreCollisionGroupAll&&Ht.body.group===xs.All)continue;const Ne=(w&Ht.body.group.category)!==0;if(Ht.body.group&&!Ne)continue;const Me=Ht.collider.rayCast(e,g);Me&&Pe.push(Me)}}Pe.sort((te,Ht)=>te.distance-Ht.distance);for(let te=0;te<Pe.length;te++){const Ht=Pe[te];if(s?.filter){if(s.filter(Ht)&&(f.push(Ht),!A)){gt=!0;break}}else if(f.push(Ht),!A){gt=!0;break}}}$<ot?(J+=V.x,$+=L):(Y+=V.y,ot+=O)}return f.sort((Yt,Qt)=>Yt.distance-Qt.distance),!A&&f.length?[f[0]]:f}track(e){let s=[e];if(e instanceof Ce){const r=e.getColliders();for(const a of r)a.owner=e.owner;s=r}for(const r of s)this.hashGrid.track(r)}untrack(e){let s=[e];e instanceof Ce&&(s=e.getColliders());for(const r of s)this.hashGrid.untrack(r)}_canCollide(e,s){return!(e.collider.id===s.collider.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.hasZeroBounds||s.hasZeroBounds||!e.body.group.canCollide(s.body.group)||e.collisionType===ft.Fixed&&s.collisionType===ft.Fixed||e.collisionType===ft.PreventCollision||s.collisionType===ft.PreventCollision||!e.owner.isActive||!s.owner.isActive)}broadphase(e,s){const r=[];this._pairs.clear(),this._nonPairs.clear();let a=0;for(const l of this.hashGrid.objectToProxy.values())if(l.id=a++,!(!l.owner.isActive||l.collisionType===ft.PreventCollision))for(let f=0;f<l.cells.length;f++){const g=l.cells[f];for(let m=0;m<g.proxies.length;m++){const w=g.proxies[m];if(w.id===l.id)continue;const A=Qe.calculatePairHash(l.collider.id,w.collider.id);if(!this._nonPairs.has(A))if(!this._pairs.has(A)&&this._canCollide(l,w)&&l.object.bounds.overlaps(w.object.bounds)){const y=this._pairPool.get();y.colliderA=l.collider,y.colliderB=w.collider,y.id=A,this._pairs.add(A),r.push(y)}else this._nonPairs.add(A)}}return r}narrowphase(e,s){const r=[];for(let a=0;a<e.length;a++){const l=e[a].collide();for(let f=0;f<l.length;f++){const g=l[f];r.push(g),s&&s.physics.contacts.set(g.id,g)}}return this._pairPool.done(),s&&(s.physics.collisions+=r.length),r}update(e,s){return this.hashGrid.update(e)}debug(e,s){this.hashGrid.debug(e,s)}}class vu{get config(){return Vg(this._config,e=>{this.$configUpdate.notifyAll(e)})}set config(e){this._config=e,this.$configUpdate.notifyAll(e)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const e=this._collisionProcessor.getColliders();this._config.spatialPartition===Xn.SparseHashGrid?this._collisionProcessor=new Kh(this._config.sparseHashGrid):this._collisionProcessor=new Wo(this._config);for(const s of e)this._collisionProcessor.track(s)}return this._collisionProcessor}constructor(e){this.$configUpdate=new je,this._configDirty=!1,this.config=e,this.$configUpdate.subscribe(s=>{this._configDirty=!0,Tt.updateDefaultPhysicsConfig(s.bodies)}),this._config.spatialPartition===Xn.SparseHashGrid?this._collisionProcessor=new Kh(this._config.sparseHashGrid):this._collisionProcessor=new Wo(this._config)}rayCast(e,s){return this.collisionProcessor.rayCast(e,s)}query(e){return this._collisionProcessor.query(e)}}class Zo{constructor(){this.events=new I,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(e){this._enabled=e}setMinimumGamepadConfiguration(e){this._enableAndUpdate(),this._minimumConfiguration=e}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(e){if(!this._minimumConfiguration)return!0;if(!e)return!1;const s=e.axes.filter(a=>typeof a!==void 0).length,r=e.buttons.filter(a=>typeof a!==void 0).length;return s>=this._minimumConfiguration.axis&&r>=this._minimumConfiguration.buttons&&e.connected}emit(e,s){this.events.emit(e,s)}on(e,s){return this._enableAndUpdate(),this.events.on(e,s)}once(e,s){return this._enableAndUpdate(),this.events.once(e,s)}off(e,s){this._enableAndUpdate(),this.events.off(e,s)}update(){var e,s;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const r=this._navigator.getGamepads();for(let a=0;a<r.length;a++){if(r[a]){const f=this.at(a);!this.at(a).connected&&this._isGamepadValid(r[a])&&(f.events.pipe(this.events),this.events.emit("connect",new lh(a,this.at(a)))),this.at(a).connected=!0}else{const f=this.at(a);f.connected&&(this.events.emit("disconnect",new ch(a,f)),f.events.unpipe(this.events)),f.connected=!1;continue}if(this.at(a).update(),r[a].timestamp&&r[a].timestamp===this._gamePadTimeStamps[a])continue;this._gamePadTimeStamps[a]=r[a].timestamp,this.at(a).navigatorGamepad=r[a];const l=r[a];if(l){for(let f=0;f<l.buttons.length;f++){const g=l.buttons[f],m=g?.value;m!==((e=this._oldPads[a])===null||e===void 0?void 0:e.getButton(f))&&(g?.pressed?(this.at(a).updateButton(f,m),this.at(a).events.emit("button",new dh(f in Lr?f:Lr.Unknown,f,m,this.at(a)))):this.at(a).updateButton(f,0))}for(let f=0;f<l.axes.length;f++){const g=l.axes[f];g!==((s=this._oldPads[a])===null||s===void 0?void 0:s.getAxes(f))&&(this.at(a).updateAxes(f,g),this.at(a).events.emit("axis",new uh(f,g,this.at(a))))}}this._oldPads[a]=this._clonePad(r[a])}}at(e){if(this._enableAndUpdate(),e>=this._pads.length)for(let s=this._pads.length-1,r=e;s<r;s++)this._pads.push(new Qo),this._oldPads.push(new Qo);return this._pads[e]}getValidGamepads(){this._enableAndUpdate();const e=[];for(let s=0;s<this._pads.length;s++)this._isGamepadValid(this.at(s).navigatorGamepad)&&this.at(s).connected&&e.push(this.at(s));return e}count(){return this._pads.filter(e=>e.connected).length}_clonePads(e){const s=[];for(let r=0,a=e.length;r<a;r++)s.push(this._clonePad(e[r]));return s}_clonePad(e){let s,r;const a=new Qo;if(!e)return a;for(s=0,r=e.buttons.length;s<r;s++)e.buttons[s]&&a.updateButton(s,e.buttons[s].value);for(s=0,r=e.axes.length;s<r;s++)a.updateAxes(s,e.axes[s]);return a}}Zo.MinAxisMoveThreshold=.05;class Qo{constructor(){this.events=new I,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let e=0;e<this._buttons.length;e++)this._buttons[e]=0;for(let e=0;e<this._axes.length;e++)this._axes[e]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(e,s=1){return this._buttons[e]>=s}isButtonHeld(e,s=1){return this._buttons[e]>=s}wasButtonPressed(e,s=1){return this._buttonsDown[e]>=s}wasButtonReleased(e){return!!this._buttonsUp[e]}getButton(e){return this._buttons[e]}getAxes(e){const s=this._axes[e];return Math.abs(s)<Zo.MinAxisMoveThreshold?0:s}updateButton(e,s){s===0&&this._buttons[e]?this._buttonsUp[e]=1:this._buttonsDown[e]=s,this._buttons[e]=s}updateAxes(e,s){this._axes[e]=s}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}var Lr;(function(u){u[u.Unknown=-1]="Unknown",u[u.Face1=0]="Face1",u[u.Face2=1]="Face2",u[u.Face3=2]="Face3",u[u.Face4=3]="Face4",u[u.LeftBumper=4]="LeftBumper",u[u.RightBumper=5]="RightBumper",u[u.LeftTrigger=6]="LeftTrigger",u[u.RightTrigger=7]="RightTrigger",u[u.Select=8]="Select",u[u.Start=9]="Start",u[u.LeftStick=10]="LeftStick",u[u.RightStick=11]="RightStick",u[u.DpadUp=12]="DpadUp",u[u.DpadDown=13]="DpadDown",u[u.DpadLeft=14]="DpadLeft",u[u.DpadRight=15]="DpadRight",u[u.CenterButton=16]="CenterButton",u[u.MiscButton1=17]="MiscButton1"})(Lr||(Lr={}));var $h;(function(u){u[u.LeftStickX=0]="LeftStickX",u[u.LeftStickY=1]="LeftStickY",u[u.RightStickX=2]="RightStickX",u[u.RightStickY=3]="RightStickY"})($h||($h={}));class wu{constructor(e){this.inputs=e,this._handlers=new Map}execute(){for(const[e,s]of this._handlers.entries()){const r=e(this.inputs);r&&s(r)}}on(e,s){this._handlers.set(e,s)}}function xu(){try{const u=()=>{};window.top.addEventListener("blur",u),window.top.removeEventListener("blur",u)}catch{return!0}return!1}var Ur;(function(u){u.Backquote="Backquote",u.Backslash="Backslash",u.BracketLeft="BracketLeft",u.BracketRight="BracketRight",u.Comma="Comma",u.Key0="Digit0",u.Key1="Digit1",u.Key2="Digit2",u.Key3="Digit3",u.Key4="Digit4",u.Key5="Digit5",u.Key6="Digit6",u.Key7="Digit7",u.Key8="Digit8",u.Key9="Digit9",u.Digit0="Digit0",u.Digit1="Digit1",u.Digit2="Digit2",u.Digit3="Digit3",u.Digit4="Digit4",u.Digit5="Digit5",u.Digit6="Digit6",u.Digit7="Digit7",u.Digit8="Digit8",u.Digit9="Digit9",u.Equal="Equal",u.IntlBackslash="IntlBackslash",u.IntlRo="IntlRo",u.IntlYen="IntlYen",u.A="KeyA",u.B="KeyB",u.C="KeyC",u.D="KeyD",u.E="KeyE",u.F="KeyF",u.G="KeyG",u.H="KeyH",u.I="KeyI",u.J="KeyJ",u.K="KeyK",u.L="KeyL",u.M="KeyM",u.N="KeyN",u.O="KeyO",u.P="KeyP",u.Q="KeyQ",u.R="KeyR",u.S="KeyS",u.T="KeyT",u.U="KeyU",u.V="KeyV",u.W="KeyW",u.X="KeyX",u.Y="KeyY",u.Z="KeyZ",u.KeyA="KeyA",u.KeyB="KeyB",u.KeyC="KeyC",u.KeyD="KeyD",u.KeyE="KeyE",u.KeyF="KeyF",u.KeyG="KeyG",u.KeyH="KeyH",u.KeyI="KeyI",u.KeyJ="KeyJ",u.KeyK="KeyK",u.KeyL="KeyL",u.KeyM="KeyM",u.KeyN="KeyN",u.KeyO="KeyO",u.KeyP="KeyP",u.KeyQ="KeyQ",u.KeyR="KeyR",u.KeyS="KeyS",u.KeyT="KeyT",u.KeyU="KeyU",u.KeyV="KeyV",u.KeyW="KeyW",u.KeyX="KeyX",u.KeyY="KeyY",u.KeyZ="KeyZ",u.Minus="Minus",u.Period="Period",u.Quote="Quote",u.Semicolon="Semicolon",u.Slash="Slash",u.AltLeft="AltLeft",u.AltRight="AltRight",u.Alt="Alt",u.AltGraph="AltGraph",u.Backspace="Backspace",u.CapsLock="CapsLock",u.ContextMenu="ContextMenu",u.ControlLeft="ControlLeft",u.ControlRight="ControlRight",u.Enter="Enter",u.MetaLeft="MetaLeft",u.MetaRight="MetaRight",u.ShiftLeft="ShiftLeft",u.ShiftRight="ShiftRight",u.Space="Space",u.Tab="Tab",u.Convert="Convert",u.KanaMode="KanaMode",u.NonConvert="NonConvert",u.Delete="Delete",u.End="End",u.Help="Help",u.Home="Home",u.Insert="Insert",u.PageDown="PageDown",u.PageUp="PageUp",u.Up="ArrowUp",u.Down="ArrowDown",u.Left="ArrowLeft",u.Right="ArrowRight",u.ArrowUp="ArrowUp",u.ArrowDown="ArrowDown",u.ArrowLeft="ArrowLeft",u.ArrowRight="ArrowRight",u.NumLock="NumLock",u.Numpad0="Numpad0",u.Numpad1="Numpad1",u.Numpad2="Numpad2",u.Numpad3="Numpad3",u.Numpad4="Numpad4",u.Numpad5="Numpad5",u.Numpad6="Numpad6",u.Numpad7="Numpad7",u.Numpad8="Numpad8",u.Numpad9="Numpad9",u.Num0="Numpad0",u.Num1="Numpad1",u.Num2="Numpad2",u.Num3="Numpad3",u.Num4="Numpad4",u.Num5="Numpad5",u.Num6="Numpad6",u.Num7="Numpad7",u.Num8="Numpad8",u.Num9="Numpad9",u.NumAdd="NumpadAdd",u.NumpadAdd="NumpadAdd",u.NumDecimal="NumpadDecimal",u.NumpadDecimal="NumpadDecimal",u.NumDivide="NumpadDivide",u.NumpadDivide="NumpadDivide",u.NumEnter="NumpadEnter",u.NumpadEnter="NumpadEnter",u.NumMultiply="NumpadMultiply",u.NumpadMultiply="NumpadMultiply",u.NumSubtract="NumpadSubtract",u.NumpadSubtract="NumpadSubtract",u.Esc="Escape",u.Escape="Escape",u.F1="F1",u.F2="F2",u.F3="F3",u.F4="F4",u.F5="F5",u.F6="F6",u.F7="F7",u.F8="F8",u.F9="F9",u.F10="F10",u.F11="F11",u.F12="F12",u.F13="F13",u.F14="F14",u.F15="F15",u.F16="F16",u.F17="F17",u.F18="F18",u.F19="F19",u.F20="F20",u.PrintScreen="PrintScreen",u.ScrollLock="ScrollLock",u.Pause="Pause",u.Unidentified="Unidentified"})(Ur||(Ur={}));class zr extends wt{constructor(e,s,r){super(),this.key=e,this.value=s,this.originalEvent=r}}class bu{constructor(){this.events=new I,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=e=>{for(const s of this._keys){const r=new zr(s,e.key,e);this.events.emit("up",r),this.events.emit("release",r)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=e=>{if(!this._enabled)return;!e.metaKey&&(this._keys.includes(Ur.MetaLeft)||this._keys.includes(Ur.MetaRight))&&this._releaseAllKeys(e);const s=e.code;if(this._keys.indexOf(s)===-1){this._keys.push(s),this._keysDown.push(s);const r=new zr(s,e.key,e);this.events.emit("down",r),this.events.emit("press",r)}},this._handleKeyUp=e=>{if(!this._enabled)return;const s=e.code,r=this._keys.indexOf(s);this._keys.splice(r,1),this._keysUp.push(s);const a=new zr(s,e.key,e);this.events.emit("up",a),this.events.emit("release",a),e.key==="Meta"&&this._releaseAllKeys(e)}}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}init(e){let{global:s}=e;const{grabWindowFocus:r}=e;s||(xu()?(s=window,r&&window.focus(),at.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):s=window.top),s.addEventListener("blur",()=>{this._keys.length=0}),s.addEventListener("keyup",this._handleKeyUp),s.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(e){this._enabled=e}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let e=0;e<this._keys.length;e++)this.events.emit("hold",new zr(this._keys[e]))}getKeys(){return this._keys}wasPressed(e){return this._enabled?this._keysDown.indexOf(e)>-1:!1}isHeld(e){return this._enabled?this._keys.indexOf(e)>-1:!1}wasReleased(e){return this._enabled?this._keysUp.indexOf(e)>-1:!1}triggerEvent(e,s,r){e==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:s,key:r??null})),e==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:s,key:r??null}))}}class Yn{static fromPagePosition(e,s,r){let a,l,f,g;arguments.length===3?(a=e,l=s,f=new B(a,l),g=r):(f=e,a=f.x,l=f.y,g=s);const m=g.screen.pageToScreenCoordinates(f),w=g.screen.screenToWorldCoordinates(m);return new Yn(w,f,m)}constructor(e,s,r){this.worldPos=e,this.pagePos=s,this.screenPos=r}}class Hr{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(e,s,r,a,l,f){this.type=e,this.pointerId=s,this.button=r,this.pointerType=a,this.coordinates=l,this.nativeEvent=f,this.active=!0}}class Au{cancel(){this.active=!1}constructor(e,s,r,a,l,f,g,m,w,A,y,E){this.x=e,this.y=s,this.pageX=r,this.pageY=a,this.screenX=l,this.screenY=f,this.index=g,this.deltaX=m,this.deltaY=w,this.deltaZ=A,this.deltaMode=y,this.ev=E,this.active=!0}}class tl{constructor(){this.events=new I,this.lastPagePos=B.Zero,this.lastScreenPos=B.Zero,this.lastWorldPos=B.Zero,this._onPointerMove=e=>{this.lastPagePos=new B(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new B(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new B(e.worldPos.x,e.worldPos.y)},this._onPointerDown=e=>{this.lastPagePos=new B(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new B(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new B(e.worldPos.x,e.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_updateWorldPosition(e){const s=Yn.fromPagePosition(this.lastPagePos,e);this.lastScreenPos=s.screenPos,this.lastWorldPos=s.worldPos}}var jn;(function(u){u.Pixel="Pixel",u.Line="Line",u.Page="Page"})(jn||(jn={}));var Gs;(function(u){u[u.NoButton=-1]="NoButton",u[u.Left=0]="Left",u[u.Middle=1]="Middle",u[u.Right=2]="Right",u[u.Unknown=3]="Unknown"})(Gs||(Gs={}));var ys;(function(u){u.Left="Left",u.Middle="Middle",u.Right="Right",u.Unknown="Unknown",u.NoButton="NoButton"})(ys||(ys={}));var Cs;(function(u){u.Touch="Touch",u.Mouse="Mouse",u.Pen="Pen",u.Unknown="Unknown"})(Cs||(Cs={}));function Zp(u){return globalThis.TouchEvent&&u instanceof globalThis.TouchEvent}function Qp(u){return globalThis.PointerEvent&&u instanceof globalThis.PointerEvent}class Jo{constructor(e,s){this.target=e,this.engine=s,this.events=new I,this.primary=new tl,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(e){this._enabled=e}recreate(e,s){const r=new Jo(e,s);return r.primary=this.primary,r._pointers=this._pointers,r}at(e){if(e>=this._pointers.length)for(let s=this._pointers.length-1,r=e;s<r;s++)this._pointers.push(new tl);return this._pointers[e]}count(){return this._pointers.length}isDown(e){var s;return this._enabled&&(s=this.currentFramePointerDown.get(e))!==null&&s!==void 0?s:!1}wasDown(e){var s;return this._enabled&&(s=this.lastFramePointerDown.get(e))!==null&&s!==void 0?s:!1}isDragging(e){return this._enabled?this.isDown(e):!1}isDragStart(e){return this._enabled?this.isDown(e)&&!this.wasDown(e):!1}isDragEnd(e){return this._enabled?!this.isDown(e)&&this.wasDown(e):!1}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const e of this.currentFrameDown){if(!e.active)continue;this.emit("down",e),this.at(e.pointerId).emit("down",e),this.primary.emit("pointerdown",e)}for(const e of this.currentFrameUp){if(!e.active)continue;this.emit("up",e),this.at(e.pointerId).emit("up",e)}for(const e of this.currentFrameMove){if(!e.active)continue;this.emit("move",e),this.at(e.pointerId).emit("move",e)}for(const e of this.currentFrameCancel){if(!e.active)continue;this.emit("cancel",e),this.at(e.pointerId).emit("cancel",e)}for(const e of this.currentFrameWheel)e.active&&(this.emit("pointerwheel",e),this.emit("wheel",e),this.primary.emit("pointerwheel",e),this.primary.emit("wheel",e));if(this.engine.currentScene.camera.hasChanged())for(const e of this._pointers)e._updateWorldPosition(this.engine)}clear(){for(const e of this.currentFrameUp){this.currentFramePointerCoords.delete(e.pointerId);const s=this._activeNativePointerIdsToNormalized.entries();for(const[r,a]of s)a===e.pointerId&&this._activeNativePointerIdsToNormalized.delete(r)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(e){var s;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const r={passive:!(this.engine.pageScrollPreventionMode===Xs.All||this.engine.pageScrollPreventionMode===Xs.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,r):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,r):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,r),((s=e?.grabWindowFocus)!==null&&s!==void 0?s:!0)&&xu()){const l=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",l):(this.target.addEventListener("touchstart",l),this.target.addEventListener("mousedown",l))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(e){this._activeNativePointerIdsToNormalized.set(e,-1);const r=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((a,l)=>a-l).findIndex(a=>a===e);return this._activeNativePointerIdsToNormalized.set(e,r),r}_handle(e){if(!this._enabled)return;e.preventDefault();const s=new Map;let r,a;if(Zp(e)){r=ys.Unknown,a=Cs.Touch;for(let l=0;l<e.changedTouches.length;l++){const f=e.changedTouches[l],g=Yn.fromPagePosition(f.pageX,f.pageY,this.engine),m=l+1,w=this._normalizePointerId(m);this.currentFramePointerCoords.set(w,g),s.set(w,g)}}else{r=this._nativeButtonToPointerButton(e.button),a=Cs.Mouse;const l=Yn.fromPagePosition(e.pageX,e.pageY,this.engine);let f=1;Qp(e)&&(f=e.pointerId,a=this._stringToPointerType(e.pointerType));const g=this._normalizePointerId(f);this.currentFramePointerCoords.set(g,l),s.set(g,l)}for(const[l,f]of s.entries())switch(e.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new Hr("down",l,r,a,f,e)),this.currentFramePointerDown.set(l,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new Hr("up",l,r,a,f,e)),this.currentFramePointerDown.set(l,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new Hr("move",l,r,a,f,e));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new Hr("cancel",l,r,a,f,e));break}}_handleWheel(e){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Xs.All||this.engine.pageScrollPreventionMode===Xs.Canvas&&e.target===this.engine.canvas)&&e.preventDefault();const s=this.engine.screen.pageToScreenCoordinates(z(e.pageX,e.pageY)),r=this.engine.screen.screenToWorldCoordinates(s),a=-1/40,l=e.deltaX||e.wheelDeltaX*a||0,f=e.deltaY||e.wheelDeltaY*a||e.wheelDelta*a||e.detail||0,g=e.deltaZ||0;let m=jn.Pixel;e.deltaMode&&(e.deltaMode===1?m=jn.Line:e.deltaMode===2&&(m=jn.Page));const w=new Au(r.x,r.y,e.pageX,e.pageY,s.x,s.y,0,l,f,g,m,e);this.currentFrameWheel.push(w)}triggerEvent(e,s){const r=this.engine.screen.worldToPageCoordinates(s);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+e,{pointerId:0,clientX:r.x,clientY:r.y})):this._handle(new window.MouseEvent("mouse"+e,{clientX:r.x,clientY:r.y}));const a=this.engine.currentScene.world.get(jo);a.preupdate(this.engine.currentScene,1),a.update(1)}_nativeButtonToPointerButton(e){switch(e){case Gs.NoButton:return ys.NoButton;case Gs.Left:return ys.Left;case Gs.Middle:return ys.Middle;case Gs.Right:return ys.Right;case Gs.Unknown:return ys.Unknown;default:return rd(e)}}_stringToPointerType(e){switch(e){case"touch":return Cs.Touch;case"mouse":return Cs.Mouse;case"pen":return Cs.Pen;default:return Cs.Unknown}}}class el{constructor(e){this._enabled=!0;const{pointerTarget:s,grabWindowFocus:r,engine:a}=e;this.keyboard=new bu,this.pointers=new Jo(s,a),this.gamepads=new Zo,this.keyboard.init({grabWindowFocus:r}),this.pointers.init({grabWindowFocus:r}),this.gamepads.init(),this.inputMapper=new wu({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(e){this._enabled=e,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class Jp{}const Kp={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function Ki(u){var e,s;return!!u?.prototype&&!!(!((s=(e=u?.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class xi{get actors(){return this.world.entityManager.entities.filter(e=>e instanceof Je)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(e=>e instanceof cu)}get tileMaps(){return this.world.entityManager.entities.filter(e=>e instanceof eu)}get timers(){return this._timers}constructor(){this._logger=at.getInstance(),this.events=new I,this.camera=new lu,this.world=new gu(this),this.physics=new vu(As()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(Zh),this.world.add(new qo(this.world,this.physics)),this.world.add(new Yo(this.world,this.physics)),this.world.add(jo),this.world.add(Qh),this.world.add(Jh),this.world.add(Xh),this.world.add(qh)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}onPreLoad(e){}onTransition(e){}onInitialize(e){}onActivate(e){}onDeactivate(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreDraw(e,s){}onPostDraw(e,s){}_initializeChildren(){for(const e of this.entities)e._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(e){var s;if(!this.isInitialized){try{this.engine=e,this.physics.config=this.engine.physics,this.input=new el({pointerTarget:e.pointerScope===F.Canvas?e.canvas:document,grabWindowFocus:e.grabWindowFocus,engine:e}),this.camera._initialize(e),this.world.systemManager.initialize(),await this.onInitialize(e),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,e),this.events.emit("initialize",new Gn(e,this))}catch(r){throw this._logger.error(`Error during scene initialization for scene ${(s=e.director)===null||s===void 0?void 0:s.getSceneName(this)}!`),r}this._isInitialized=!0}}async _activate(e){var s,r;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(e)}catch(a){throw this._logger.error(`Error during scene activation for scene ${(r=(s=this.engine)===null||s===void 0?void 0:s.director)===null||r===void 0?void 0:r.getSceneName(this)}!`),a}}async _deactivate(e){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(e)}_preupdate(e,s){this.emit("preupdate",new Os(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.emit("postupdate",new Ws(e,s,this)),this.onPostUpdate(e,s)}_predraw(e,s){this.emit("predraw",new Vn(e,s,this)),this.onPreDraw(e,s)}_postdraw(e,s){this.emit("postdraw",new Nn(e,s,this)),this.onPostDraw(e,s)}update(e,s){var r;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(r=e.director)===null||r===void 0?void 0:r.getSceneName(this)}!`);return}this._preupdate(e,s);let a,l;for(a=0,l=this._cancelQueue.length;a<l;a++)this.removeTimer(this._cancelQueue[a]);this._cancelQueue.length=0;for(const f of this._timers)f.update(s);this.world.update(_i.Update,s),this.camera&&this.camera.update(e,s),this._collectActorStats(e),this._postupdate(e,s),this.input.update()}draw(e,s){var r;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(e,s),this.world.update(_i.Draw,s),!((r=this.engine)===null||r===void 0)&&r.isDebug&&this.debugDraw(e),this._postdraw(e,s)}debugDraw(e){this.emit("predebugdraw",new rh(e,this)),this.emit("postdebugdraw",new oh(e,this))}contains(e){return this.actors.indexOf(e)>-1}add(e){if(this.emit("entityadded",{target:e}),e instanceof fn){wo(this._timers,e)||this.addTimer(e);return}this.world.add(e),e.scene=this}transfer(e){let s;e instanceof Oe&&e.scene&&e.scene!==this&&(s=e.scene,e.scene.world.remove(e,!1)),e instanceof fn&&e.scene&&(s=e.scene,e.scene.removeTimer(e)),s?.emit("entityremoved",{target:e}),this.add(e)}remove(e){this.emit("entityremoved",{target:e}),e instanceof Oe&&(e.isActive&&e.kill(),this.world.remove(e)),e instanceof fn&&this.removeTimer(e)}clear(e=!0){for(let s=this.entities.length-1;s>=0;s--)this.world.remove(this.entities[s],e);for(let s=this.timers.length-1;s>=0;s--)this.removeTimer(this.timers[s])}addTimer(e){return this._timers.push(e),e.scene=this,e}removeTimer(e){const s=this._timers.indexOf(e);return s!==-1&&this._timers.splice(s,1),e}cancelTimer(e){return this._cancelQueue.push(e),e}isTimerActive(e){return this._timers.indexOf(e)>-1&&!e.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(e){const s=this.actors;for(let r=0;r<s.length;r++){const a=s[r];a instanceof Wh&&e.stats.currFrame.actors.ui++,e.stats.currFrame.actors.alive++;for(let l=0;l<a.children.length;l++){const f=a.children[l];$d(f)?e.stats.currFrame.actors.ui++:e.stats.currFrame.actors.alive++}}}}var _n;(function(u){u.Protanope="Protanope",u.Deuteranope="Deuteranope",u.Tritanope="Tritanope"})(_n||(_n={}));const $p=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class yu{constructor(e,s){this._shader=new ni({gl:e,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:s}),this._shader.compile(),this._buffer=new qi({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new ms({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class Cu{constructor(e,s=!1){this._colorBlindnessMode=e,this._simulate=!1,this._simulate=s}initialize(e){this._shader=new yu(e,$p),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(e){if(this._colorBlindnessMode=e,this._shader){const s=this._shader.getShader();s.use(),this._colorBlindnessMode===_n.Protanope?s.setUniformInt("u_type",0):this._colorBlindnessMode===_n.Deuteranope?s.setUniformInt("u_type",1):this._colorBlindnessMode===_n.Tritanope&&s.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(e){if(this._simulate=e,this._shader){const s=this._shader.getShader();s.use(),s.setUniformBoolean("u_simulate",e)}}get simulate(){return this._simulate}}class Su{constructor(e){this._engine=e,this._colorBlindPostProcessor=new Cu(_n.Protanope)}correct(e){this._engine.graphicsContext instanceof ws&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(e){this._engine.graphicsContext instanceof ws&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class Pu{constructor(e){this.stats={currFrame:new Or,prevFrame:new Or},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:Q.Yellow,showZIndex:!1,showScale:!1,scaleColor:Q.Green,showRotation:!1,rotationColor:Q.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:Q.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:Q.Blue,showOwner:!1,showGeometry:!0,geometryColor:Q.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:Q.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:Q.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:Q.Yellow,showAcceleration:!1,accelerationColor:Q.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:Q.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:Q.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:Q.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:Q.Yellow,positionSize:1,showGrid:!1,gridColor:Q.Red,gridWidth:1,showColliderGeometry:!0},this._engine=e,this.colorBlindMode=new Su(this._engine)}useTestClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const r=e.toTestClock();return s&&r.start(),this._engine.clock=r,r}useStandardClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const r=e.toStandardClock();return s&&r.start(),this._engine.clock=r,r}}class Or{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new Ko,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(e){e?(this.id=e.id,this.elapsedMs=e.elapsedMs,this.fps=e.fps,this.actors.alive=e.actors.alive,this.actors.killed=e.actors.killed,this.actors.ui=e.actors.ui,this.duration.update=e.duration.update,this.duration.draw=e.duration.draw,this._physicsStats.reset(e.physics),this.graphics.drawCalls=e.graphics.drawCalls,this.graphics.drawnImages=e.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const e=new Or;return e.reset(this),e}get id(){return this._id}set id(e){this._id=e}get elapsedMs(){return this._elapsedMs}set elapsedMs(e){this._elapsedMs=e}get fps(){return this._fps}set fps(e){this._fps=e}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class Ko{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(e){e?(this.pairs=e.pairs,this.collisions=e.collisions,this.contacts=e.contacts,this.fastBodies=e.fastBodies,this.fastBodyCollisions=e.fastBodyCollisions,this.broadphase=e.broadphase,this.narrowphase=e.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const e=new Ko;return e.reset(this),e}get pairs(){return this._pairs}set pairs(e){this._pairs=e}get collisions(){return this._collisions}set collisions(e){this._collisions=e}get contacts(){return this._contacts}set contacts(e){this._contacts=e}get fastBodies(){return this._fastBodies}set fastBodies(e){this._fastBodies=e}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(e){this._fastBodyCollisions=e}get broadphase(){return this._broadphase}set broadphase(e){this._broadphase=e}get narrowphase(){return this._narrowphase}set narrowphase(e){this._narrowphase=e}}class il{on(e,s){this._nativeHandlers[e]&&this.off(e,this._nativeHandlers[e]),this._nativeHandlers[e]=this._decorate(s),this.nativeComponent.addEventListener(e,this._nativeHandlers[e])}off(e,s){s||(s=this._nativeHandlers[e]),this.nativeComponent.removeEventListener(e,s),this._nativeHandlers[e]=null}_decorate(e){return s=>{this._paused||e(s)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const e in this._nativeHandlers)this.off(e)}constructor(e){this.nativeComponent=e,this._paused=!1,this._nativeHandlers={}}}class Tu{constructor(e,s){this._windowGlobal=e,this._documentGlobal=s,this._windowComponent=new il(this._windowGlobal),this._documentComponent=new il(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const Eu={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:_e.Blended,canvasImageRendering:"auto"},Iu={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:_e.Blended,canvasImageRendering:"auto"};class Ru{constructor(e){var s;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=e.initialFps,this._samplePeriod=(s=e.samplePeriod)!==null&&s!==void 0?s:this._samplePeriod,this._currentFrameTime=1e3/e.initialFps,this._nowFn=e.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const e=this._nowFn();this._currentFrameTime=e-this._beginFrameTime,e>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(e-this._previousSampleTime),this._previousSampleTime=e,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class sl{constructor(e){var s,r,a;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=e,this.tick=e.tick,this._lastTime=(s=this.now())!==null&&s!==void 0?s:0,this._maxFps=(r=e.maxFps)!==null&&r!==void 0?r:this._maxFps,this._onFatalException=(a=e.onFatalException)!==null&&a!==void 0?a:this._onFatalException,this.fpsSampler=new Ru({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new Du({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new nl({...this._options})}setFatalExceptionHandler(e){this._onFatalException=e}schedule(e,s=0,r="preframe"){const a=this._totalElapsed+s;this._scheduledCbs.push([e,a,r])}__runScheduledCbs(e="preframe"){for(let s=this._scheduledCbs.length-1;s>-1;s--)e===this._scheduledCbs[s][2]&&this._scheduledCbs[s][1]<=this._totalElapsed&&(this._scheduledCbs[s][0](this._elapsed),this._scheduledCbs.splice(s,1))}update(e){try{this.fpsSampler.start();const s=this.now();let r=s-this._lastTime||1;const a=1e3/this._maxFps;if(r>=a){let l=0;a!==0&&(l=r%a,r=r-l),r>200&&(r=1),this._elapsed=e||r,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(e||r),this.__runScheduledCbs("postframe"),a!==0?this._lastTime=s-l:this._lastTime=s,this.fpsSampler.end()}}catch(s){this._onFatalException(s),this.stop()}}}class nl extends sl{constructor(e){super(e),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const e=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(e),this.update()}catch(s){throw window.cancelAnimationFrame(this._requestId),s}};e()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class Du extends sl{constructor(e){super({...e}),this._logger=at.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=e.defaultUpdateMs}now(){var e;return(e=this._currentTime)!==null&&e!==void 0?e:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(e){const s=e??this._updateMs;this._running?(this.update(s),this._currentTime+=s):this._logger.warn("The clock is not running, no step will be performed")}run(e,s){for(let r=0;r<e;r++)this.step(s??this._updateMs)}}var tm=o(296);class Fu{constructor(){this._toasterCss=tm.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(e){const s=document.createElement("span");return s.innerText=e,s}toast(e,s,r){this._initialize();const a=document.createElement("div");a.className="ex-toast-message";const l=e.split("[LINK]").map(A=>this._createFragment(A));if(s){const A=document.createElement("a");A.href=s,r?A.innerText=r:A.innerText=s,l.splice(1,0,A)}const f=document.createElement("div");l.forEach(A=>{f.appendChild(A)}),a.appendChild(f);const g=document.createElement("button");g.innerText="x",g.addEventListener("click",()=>{this._container.removeChild(a)}),a.appendChild(g);const m=A=>{if(A.key==="Escape")try{this._container.removeChild(a)}catch{}document.removeEventListener("keydown",m)};document.addEventListener("keydown",m);const w=this._container.firstChild;this._container.insertBefore(a,w)}}const em={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class Mu{get isTransitioning(){return this._isTransitioning}constructor(e,s){this._engine=e,this.events=new I,this._logger=at.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new xi,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const r in s){const a=s[r];this.add(r,a),r==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const e=this._deferredGoto;this._deferredGoto=void 0;const s=this._deferredTransition;this._deferredTransition=void 0;const r=this.getSceneInstance(e);r&&s&&s._addToTargetScene(this._engine,r),await this.swapScene(e),r&&s&&await this.playTransition(s,r)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(e,s){const r=s?.loader;r instanceof Pr?this.mainLoader=r:Ih(r)?this.mainLoader=new r:this.mainLoader=new cn;let a;if(s?.inTransition){const{inTransition:l}=s;a=l}if(this.startScene=e,a){const l=this.getSceneInstance(this.startScene);l&&(a._addToTargetScene(this._engine,l),this.swapScene(this.startScene).then(()=>this.playTransition(a,l)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(e){return this._sceneToLoader.get(e)}_getInTransition(e){var s;const r=this.scenes[e];if(!(r instanceof xi||Ki(r)))return(s=r?.transitions)===null||s===void 0?void 0:s.in}_getOutTransition(e){var s;const r=this.scenes[e];if(!(r instanceof xi||Ki(r)))return(s=r?.transitions)===null||s===void 0?void 0:s.out}getDeferredScene(){const e=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&e?e:null}getSceneDefinition(e){const s=this.scenes[e];if(s instanceof xi||Ki(s))return s;if(s)return s.scene}getSceneName(e){for(const[s,r]of Object.entries(this.scenes))if(r instanceof xi){if(e===r)return s}else if(!Ki(r)&&e===r.scene)return s;for(const[s,r]of Object.entries(this.scenes))if(Ki(r)){if(e.constructor===r)return s}else if(!(r instanceof xi)&&e.constructor===r.scene)return s;return null}assertAdded(e){return this}assertRemoved(e){return this}add(e,s){if(!(s instanceof xi)&&!Ki(s)){const{loader:r,transitions:a}=s,{in:l,out:f}=a??{};this._sceneToTransition.set(e,{in:l,out:f}),Ih(r)?this._sceneToLoader.set(e,new r):r&&this._sceneToLoader.set(e,r)}return this.scenes[e]&&this._logger.warn("Scene",e,"already exists overwriting"),this.scenes[e]=s,this.assertAdded(e)}remove(e){if(e instanceof xi||Ki(e)){const s=e;for(const r in this.scenes)if(this.scenes.hasOwnProperty(r)){const a=this.scenes[r];let l;if(a instanceof xi||Ki(a)?l=a:l=a.scene,l===s){if(r===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${r}`);this._sceneToInstance.delete(r),this._sceneToTransition.delete(r),this._sceneToLoader.delete(r),delete this.scenes[r]}}}if(typeof e=="string"){if(e===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${e}`);this._sceneToInstance.delete(e),this._sceneToTransition.delete(e),this._sceneToLoader.delete(e),delete this.scenes[e]}}async goToScene(e,s){var r,a,l,f,g,m;const w=this.getSceneInstance(e);if(!w){this._logger.warn(`Scene ${e} does not exist! Check the name, are you sure you added it?`);return}const A=this.currentScene,y=this.currentSceneName,E=(a=(r=this._engine.input)===null||r===void 0?void 0:r.enabled)!==null&&a!==void 0?a:!0;this._isTransitioning=!0;const D=(l=this.getSceneInstance(y))===null||l===void 0?void 0:l.onTransition("out"),L=w?.onTransition("in");s={sourceOut:(f=this._getOutTransition(this.currentSceneName))!==null&&f!==void 0?f:D,destinationIn:(g=this._getInTransition(e))!==null&&g!==void 0?g:L,...s};const{sourceOut:O,destinationIn:q,sceneActivationData:H}=s,V=O??this._getOutTransition(this.currentSceneName),J=q??this._getInTransition(e),Y=V?.hideLoader||J?.hideLoader;Y&&this.maybeLoadScene(e,Y),this._emitEvent("navigationstart",y,e),V&&await this.playTransition(V,A),await this.maybeLoadScene(e,Y),J&&await J.onPreviousSceneDeactivate(this.currentScene),J&&J._addToTargetScene(this._engine,w),await this.swapScene(e,H),this._emitEvent("navigation",y,e),J&&await this.playTransition(J,w),this._emitEvent("navigationend",y,e),(m=this._engine.input)===null||m===void 0||m.toggleEnabled(E),this._isTransitioning=!1}getSceneInstance(e){const s=this.getSceneDefinition(e);if(!s)return;if(this._sceneToInstance.has(e))return this._sceneToInstance.get(e);if(s instanceof xi)return this._sceneToInstance.set(e,s),s;const r=new s;return this._sceneToInstance.set(e,r),r}async maybeLoadScene(e,s=!1){var r;const a=(r=this._getLoader(e))!==null&&r!==void 0?r:new Pr,l=this.getSceneDefinition(e),f=this.getSceneInstance(e);l&&f&&!this._loadedScenes.has(f)&&(f.onPreLoad(a),f.events.emit("preload",{loader:a}),s?this._engine.load(a,s):await this._engine.load(a),this._loadedScenes.add(f))}async playTransition(e,s){var r,a,l,f,g,m,w;if(!this.isInitialized){this._deferredTransition=e;return}if(e){this.currentTransition=e;const A=(a=(r=s.input)===null||r===void 0?void 0:r.enabled)!==null&&a!==void 0?a:!0;(l=s.input)===null||l===void 0||l.toggleEnabled(!e.blockInput),(f=this._engine.input)===null||f===void 0||f.toggleEnabled(!e.blockInput),this.currentTransition._addToTargetScene(this._engine,s),await this.currentTransition._play(),(g=s.input)===null||g===void 0||g.toggleEnabled(A)}(m=this.currentTransition)===null||m===void 0||m.kill(),(w=this.currentTransition)===null||w===void 0||w.reset(),this.currentTransition=void 0}async swapScene(e,s){const r=this._engine;if(!this.isInitialized){this._deferredGoto=e;return}const a=this.getSceneInstance(e);if(a){const l=this.currentScene,f=a;if(this._logger.debug("Going to scene:",e),this.currentScene.isInitialized){const w={engine:r,previousScene:l,nextScene:f};await this.currentScene._deactivate(w),this.currentScene.events.emit("deactivate",new ph(w,this.currentScene)),this.currentScene.input.clear()}const g=this._sceneToLoader.get(e);await g?.areResourcesLoaded(),this.currentScene=f,this.currentSceneName=e,r.screen.setCurrentCamera(f.camera),await this.currentScene._initialize(r);const m={engine:r,previousScene:l,nextScene:f,data:s};await this.currentScene._activate(m),this.currentScene.events.emit("activate",new gh(m,this.currentScene))}else this._logger.error("Scene",e,"does not exist!")}_emitEvent(e,s,r){const a=this.getSceneDefinition(s),l=this.getSceneDefinition(r);this.events.emit(e,{sourceScene:a,sourceName:s,destinationScene:l,destinationName:r})}}function Bu(){const u={scope:(e,s)=>{const r=u.value;u.value=e;try{return s()}catch(a){throw a}finally{u.value=r}},value:void 0};return u}function ku(u){return u.value}const rl={textureCollectInterval:6e4};class Lu{constructor(e){this.options=e,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=s=>{if(this._running){for(const[r,[a,l]]of this._collectors.entries()){const f=this.options.getTimestamp();for(const[g,[m,w]]of this._collectionMap.entries()){if(r!==m||w+l>=f)continue;a(g)&&this._collectionMap.delete(g)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(e,s,r){this._collectors.set(e,[r,s])}addCollectableResource(e,s){this._collectionMap.set(s,[e,this.options.getTimestamp()])}touch(e){const s=this._collectionMap.get(e);s&&this._collectionMap.set(e,[s[0],this.options.getTimestamp()])}forceCollectAll(){for(const[e,[s]]of this._collectors.entries())for(const[r]of this._collectionMap.entries())s(r)&&this._collectionMap.delete(r)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}x();const im={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Xs;(function(u){u[u.None=0]="None",u[u.Canvas=1]="Canvas",u[u.All=2]="All"})(Xs||(Xs={}));class oi{static useEngine(){const e=ku(oi.Context);if(!e)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return e}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(e){this.graphicsContext.snapToPixel=e}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,r,a,l,f,g,m,w,A;this.scope=Y=>oi.Context.scope(this,Y),this.version=ul,this.events=new I,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=Y=>{at.getInstance().fatal(Y,Y.stack)},this._toaster=new Fu,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=Y=>{var $;Y.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",Y);const ot=document.createElement("div");ot.id="ex-webgl-graphics-context-lost",ot.style.position="absolute",ot.style.zIndex="99",ot.style.left="50%",ot.style.top="50%",ot.style.display="flex",ot.style.flexDirection="column",ot.style.transform="translate(-50%, -50%)",ot.style.backgroundColor="white",ot.style.padding="10px",ot.style.borderStyle="solid 1px";const Z=document.createElement("div");if(Z.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,ot.appendChild(Z),!(($=this.canvas)===null||$===void 0)&&$.parentElement){this.canvas.parentElement.appendChild(ot);const gt=Z.querySelector("#ex-webgl-graphics-reload");gt?.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new P,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],e={...oi._DEFAULT_ENGINE_OPTIONS,...e},this._originalOptions=e,b.freeze(),this.browser=new Tu(window,document);const y=new bd;if(!e.suppressMinimumBrowserFeatureDetection&&!(this._compatible=y.test())){const Y=document.createElement("div");if(Y.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(Y),y.failedTests.forEach(function($){const ot=document.createElement("div");ot.innerText="Browser feature missing "+$,document.body.appendChild(ot)}),e.canvasElementId){const $=document.getElementById(e.canvasElementId);$&&$.parentElement.removeChild($)}return}else this._compatible=!0;if(console.log&&!e.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${ul})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),e.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=at.getInstance(),this._logger.defaultLevel===Nt.Debug&&y.logBrowserFeatures(),this._logger.debug("Building engine..."),e.garbageCollection===!0?this.garbageCollectorConfig={...rl}:e.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...rl,...e.garbageCollection},this._garbageCollector=new Lu({getTimestamp:Date.now}),this.canvasElementId=e.canvasElementId,e.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+e.canvasElementId),document.getElementById(e.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(e.canvasElementId)}else e.canvasElement?(this._logger.debug("Using Canvas element specified:",e.canvasElement),this.canvas=e.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!e.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",Y=>{Y.preventDefault()});let E=(s=e.displayMode)!==null&&s!==void 0?s:ye.Fixed;e.width&&e.height||e.viewport?(e.displayMode===void 0&&(E=ye.Fixed),this._logger.debug("Engine viewport is size "+e.width+" x "+e.height)):e.displayMode||(this._logger.debug("Engine viewport is fit"),E=ye.FitScreen),this.grabWindowFocus=e.grabWindowFocus,this.pointerScope=e.pointerScope,this._originalDisplayMode=E;let D,L,O,q,H,V;typeof e.antialiasing=="object"?{pixelArtSampler:D,nativeContextAntialiasing:O,multiSampleAntialiasing:V,filtering:H,canvasImageRendering:q}={...e.pixelArt?Iu:Eu,...e.antialiasing}:(D=!!e.pixelArt,O=!1,V=e.antialiasing,q=e.antialiasing?"auto":"pixelated",H=e.antialiasing?_e.Blended:_e.Pixel),O&&V&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),e.pixelArt&&(L=.25),(!e.antialiasing||H===_e.Pixel)&&(L=0),L=(a=(r=e.uvPadding)!==null&&r!==void 0?r:L)!==null&&a!==void 0?a:.01;let J=b.isEnabled("use-canvas-context");if(!J)try{this.graphicsContext=new ws({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:D,antialiasing:O,multiSampleAntialiasing:V,uvPadding:L,powerPreference:e.powerPreference,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(l=e.handleContextLost)!==null&&l!==void 0?l:this._handleWebGLContextLost,handleContextRestored:e.handleContextRestored})}catch(Y){this._logger.warn(`Excalibur could not load webgl for some reason (${Y.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),J=!0}J&&(this.graphicsContext=new zo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:O,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting})),this.screen=new Ph({canvas:this.canvas,context:this.graphicsContext,antialiasing:O,canvasImageRendering:q,browser:this.browser,viewport:(f=e.viewport)!==null&&f!==void 0?f:e.width&&e.height?{width:e.width,height:e.height}:Sh.SVGA,resolution:e.resolution,displayMode:E,pixelRatio:e.suppressHiDPIScaling?1:(g=e.pixelRatio)!==null&&g!==void 0?g:null}),se.filtering=H,e.backgroundColor&&(this.backgroundColor=e.backgroundColor.clone()),this.maxFps=(m=e.maxFps)!==null&&m!==void 0?m:this.maxFps,this.fixedUpdateTimestep=(w=e.fixedUpdateTimestep)!==null&&w!==void 0?w:this.fixedUpdateTimestep,this.fixedUpdateFps=(A=e.fixedUpdateFps)!==null&&A!==void 0?A:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new nl({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:Y=>this.onFatalException(Y)}),this.enableCanvasTransparency=e.enableCanvasTransparency,typeof e.physics=="boolean"?this.physics={...As(),enabled:e.physics}:(this.physics={...As()},Ao(this.physics,e.physics)),this.debug=new Pu(this),this.director=new Mu(this,e.scenes),this._initialize(e),window.___EXCALIBUR_DEVTOOL=this,oi.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:e}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:s,showPlayerMessage:r}=this._originalOptions.configurePerformanceCanvas2DFallback;if(s===void 0&&(s=oi._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),r===void 0&&(r=oi._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!b.isEnabled("use-canvas-context")&&e&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===s.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let a=0;for(let f=0;f<this._fpsSamples.length;f++)a+=this._fpsSamples[f];const l=a/this._fpsSamples.length;this._fpsSamples.length===s.numberOfFrames&&l<=s.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),r&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var e,s,r;const a=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(a,this.canvas),this.canvas=a;const l={...this._originalOptions,antialiasing:this.screen.antialiasing},f=this._originalDisplayMode;this.graphicsContext=new zo({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:l.antialiasing,backgroundColor:l.backgroundColor,snapToPixel:l.snapToPixel,useDrawSorting:l.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new Ph({canvas:this.canvas,context:this.graphicsContext,antialiasing:(e=l.antialiasing)!==null&&e!==void 0?e:!0,browser:this.browser,viewport:(s=l.viewport)!==null&&s!==void 0?s:l.width&&l.height?{width:l.width,height:l.height}:Sh.SVGA,resolution:l.resolution,displayMode:f,pixelRatio:l.suppressHiDPIScaling?1:(r=l.pixelRatio)!==null&&r!==void 0?r:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const g=l&&l.pointerScope===F.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(g,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,oi.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(e){if(e<0){at.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=e}addTimer(e){return this.currentScene.addTimer(e)}removeTimer(e){return this.currentScene.removeTimer(e)}addScene(e,s){return this.director.add(e,s),this}removeScene(e){this.director.remove(e)}add(e){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const s=this.director.getDeferredScene();s instanceof xi?s.add(e):this.currentScene.add(e)}remove(e){e instanceof Oe&&this.currentScene.remove(e),(e instanceof xi||Ki(e))&&this.removeScene(e),typeof e=="string"&&this.removeScene(e)}async goToScene(e,s){await this.scope(async()=>{await this.director.goToScene(e,s)})}screenToWorldCoordinates(e){return this.screen.screenToWorldCoordinates(e)}worldToScreenCoordinates(e){return this.screen.worldToScreenCoordinates(e)}_initialize(e){var s,r;this.pageScrollPreventionMode=e.scrollPreventionMode;const a=e&&e.pointerScope===F.Document?document:this.canvas,l=(r=(s=this._originalOptions)===null||s===void 0?void 0:s.grabWindowFocus)!==null&&r!==void 0?r:!0;this.input=new el({pointerTarget:a,grabWindowFocus:l,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new _h(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new fh(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!e.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(e){this._inputEnabled=e,this.input.toggleEnabled(this._inputEnabled)}onInitialize(e){}get isInitialized(){return this._isInitialized}async _overrideInitialize(e){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(e),this.events.emit("initialize",new Gn(e,this)),this._isInitialized=!0)}_update(e){var s;if(this._isLoading){(s=this._loader)===null||s===void 0||s.onUpdate(this,e),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(e),this.currentScene.update(this,e),this.graphicsContext.updatePostProcessors(e),this.clock.__runScheduledCbs("postupdate"),this._postupdate(e),this.input.update()}_preupdate(e){this.emit("preupdate",new Os(this,e,this)),this.onPreUpdate(this,e)}onPreUpdate(e,s){}_postupdate(e){this.emit("postupdate",new Ws(this,e,this)),this.onPostUpdate(this,e)}onPostUpdate(e,s){}_draw(e){var s,r;if(this.graphicsContext.backgroundColor=(s=this.currentScene.backgroundColor)!==null&&s!==void 0?s:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,e),this._isLoading){this._hideLoader||((r=this._loader)===null||r===void 0||r.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,e),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,e),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(e,s){this.emit("predraw",new Vn(e,s,this)),this.onPreDraw(e,s)}onPreDraw(e,s){}_postdraw(e,s){this.emit("postdraw",new Nn(e,s,this)),this.onPostDraw(e,s)}onPostDraw(e,s){}showDebug(e){this._isDebug=e}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(e,s){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let r;return e instanceof Pr?r=e:typeof e=="string"&&(this.director.configureStart(e,s),r=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(r??new cn),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new eh(this)),this._isReadyFuture.promise})}_mainloop(e){this.scope(()=>{this.emit("preframe",new ah(this,this.stats.prevFrame));const s=e*this.timescale;this.currentFrameElapsedMs=s;const r=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=r,this.stats.currFrame.elapsedMs=s,this.stats.currFrame.fps=this.clock.fpsSampler.fps,Zt.clear();const a=this.clock.now(),l=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=s;this._lagMs>=l;)this._update(l),this._lagMs-=l;else this._update(s);const f=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(s);const g=this.clock.now();this.stats.currFrame.duration.update=f-a,this.stats.currFrame.duration.draw=g-f,this.stats.currFrame.graphics.drawnImages=Zt.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=Zt.DrawCallCount,this.emit("postframe",new hh(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new ih(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(e=!1){return new Promise(r=>{this._screenShotRequests.push({preserveHiDPIResolution:e,resolve:r})})}_checkForScreenShots(){for(const e of this._screenShotRequests){const s=e.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,r=e.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,a=document.createElement("canvas");a.width=s,a.height=r;const l=a.getContext("2d");l.imageSmoothingEnabled=this.screen.antialiasing,l.drawImage(this.canvas,0,0,s,r);const f=new Image,g=a.toDataURL("image/png");f.onload=()=>{e.resolve(f)},f.src=g}this._screenShotRequests.length=0}async load(e,s=!1){await this.scope(async()=>{try{if(e.isLoaded())return;this._loader=e,this._isLoading=!0,this._hideLoader=s,e instanceof cn&&(e.suppressPlayButton=e.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await e.load()}catch(r){this._logger.error("Error loading resources, things may not behave properly",r),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}oi.Context=Bu(),oi.InstanceCount=0,oi._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:F.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Xs.Canvas,backgroundColor:Q.fromHex("#2185d0")};class sm extends Je{set maxWidth(e){this._text.maxWidth=e}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(e){this._font=e,this._text.font=e}get text(){return this._text.text}set text(e){this._text.text=e}get color(){return this._text.color}set color(e){this._text&&(this._text.color=e)}get opacity(){return this.graphics.opacity}set opacity(e){this.graphics.opacity=e}get spriteFont(){return this._spriteFont}set spriteFont(e){e&&(this._spriteFont=e,this._text.font=this._spriteFont)}constructor(e){super(e),this._font=new rn,this._text=new Ar({text:"",font:this._font});const{text:s,pos:r,x:a,y:l,spriteFont:f,font:g,color:m,maxWidth:w}={text:"",...e};this.pos=r??(a&&l?z(a,l):this.pos),this.text=s??this.text,this.font=g??this.font,this.maxWidth=w??this.maxWidth,this.spriteFont=f??this.spriteFont,this._text.color=m??this.color;const A=this.get(ne);A.anchor=B.Zero,A.use(this._text)}_initialize(e){super._initialize(e)}getTextWidth(){return this._text.width}}var qs;(function(u){u.Circle="circle",u.Rectangle="rectangle"})(qs||(qs={}));class nm extends Je{constructor(e){var s,r;super({width:(s=e.width)!==null&&s!==void 0?s:0,height:(r=e.height)!==null&&r!==void 0?r:0}),this._particlesToEmit=0,this._particlePool=new mr(()=>new Uo({}),L=>L,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=qs.Rectangle,this.radius=0,this.particle={life:2e3,transform:ki.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:a,x:l,y:f,z:g,pos:m,isEmitting:w,emitRate:A,emitterType:y,radius:E,random:D}={...e};this.particle={...this.particle,...a},this.pos=m??z(l??0,f??0),this.z=g??0,this.isEmitting=w??this.isEmitting,this.emitRate=A??this.emitRate,this.emitterType=y??this.emitterType,this.radius=E??this.radius,this.body.collisionType=ft.PreventCollision,this.random=D??new M}removeParticle(e){this.deadParticles.push(e)}emitParticles(e){var s;if(!(e<=0)){e=e|0;for(let r=0;r<e;r++){const a=this._createParticle();!((s=this===null||this===void 0?void 0:this.scene)===null||s===void 0)&&s.world&&(this.particle.transform===ki.Global?this.scene.world.add(a):this.addChild(a)),this._activeParticles.push(a)}}}clearParticles(){for(let e=0;e<this._activeParticles.length;e++)this.removeParticle(this._activeParticles[e])}_createParticle(){let e=0,s=0;const r=Pt(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),a=Pt(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),l=this.particle.startSize||Pt(this.particle.minSize||5,this.particle.maxSize||5,this.random),f=a*Math.cos(r),g=a*Math.sin(r);if(this.emitterType===qs.Rectangle)e=Pt(0,this.width,this.random),s=Pt(0,this.height,this.random);else if(this.emitterType===qs.Circle){const w=Pt(0,this.radius,this.random);e=w*Math.cos(r),s=w*Math.sin(r)}const m=this._particlePool.rent();return m.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:z(e,s),vel:z(f,g),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:l,graphic:this.particle.graphic,fade:this.particle.fade}),m.registerEmitter(this),this.particle.randomRotation&&(m.transform.rotation=Pt(0,Math.PI*2,this.random)),this.particle.focus&&(m.focus=this.particle.focus.add(z(this.pos.x,this.pos.y)),m.focusAccel=this.particle.focusAccel),m}update(e,s){var r;super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let a=0;a<this.deadParticles.length;a++){!((r=this===null||this===void 0?void 0:this.scene)===null||r===void 0)&&r.world&&(this.scene.world.remove(this.deadParticles[a],!1),this._particlePool.return(this.deadParticles[a]));const l=this._activeParticles.indexOf(this.deadParticles[a]);l>-1&&this._activeParticles.splice(l,1)}this.deadParticles.length=0}}function rm(u,e){}class $o{constructor(e,s,r){var a;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=e,this.particle=r,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=s,this._particleLife=(a=this.particle.life)!==null&&a!==void 0?a:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(e,s){if(this._initialized)return;const r=this.emitter.maxParticles,a=this._numInputFloats,l=this._particleData,f=4,g=e.createBuffer(),m=e.createVertexArray();e.bindVertexArray(m),e.bindBuffer(e.ARRAY_BUFFER,g),e.bufferData(e.ARRAY_BUFFER,r*a*f,e.DYNAMIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,l);let w=0;e.vertexAttribPointer(0,2,e.FLOAT,!1,a*f,0),w+=f*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*f,w),w+=f*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*f,w),w+=f*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(m),this._buffers.push(g),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null);const A=e.createBuffer(),y=e.createVertexArray();e.bindVertexArray(y),e.bindBuffer(e.ARRAY_BUFFER,A),e.bufferData(e.ARRAY_BUFFER,r*a*f,e.DYNAMIC_DRAW),w=0,e.vertexAttribPointer(0,2,e.FLOAT,!1,a*f,0),w+=f*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*f,w),w+=f*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*f,w),w+=f*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*f,w),w+=f*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(y),this._buffers.push(A),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(e){const s=this._particleIndex,r=this.maxParticles*this._numInputFloats,a=e*this._numInputFloats+s;for(let l=s;l<a;l+=this._numInputFloats){const f=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||W),g=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),m=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),w=g*Math.cos(f),A=m*Math.sin(f);let y=0,E=0;if(this.emitter.emitterType===qs.Rectangle)y=this._random.floating(-.5,.5)*this.emitter.width,E=this._random.floating(-.5,.5)*this.emitter.height;else{const O=this._random.floating(0,this.emitter.radius);y=O*Math.cos(f),E=O*Math.sin(f)}const D=this.emitter.transform.apply(z(y,E)),L=[this.particle.transform===ki.Local?y:D.x,this.particle.transform===ki.Local?E:D.y,w,A,this.particle.randomRotation?Pt(0,W,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(L,l%this._particleData.length)}a>=r?(this._wrappedParticles+=(a-r)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=e),this._particleIndex=a%r,this._emitted.push([this._particleLife,s])}_uploadEmitted(e){this._particleIndex!==this._uploadIndex&&(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),e.bindBuffer(e.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(e){var s;if(this._particleLife=(s=this.particle.life)!==null&&s!==void 0?s:this._particleLife,this._wrappedLife>0?this._wrappedLife-=e:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let r=this._emitted.length-1;r>=0;r--){const a=this._emitted[r];a[0]-=e,a[0]<=0&&this._emitted.splice(r,1)}this._emitted.sort((r,a)=>r[0]-a[0])}}draw(e){if(this._initialized){if(this._clearRequested?(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData),e.bindBuffer(e.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(e),e.bindVertexArray(this._currentVao),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const s=this._emitted[0][1]/this._numInputFloats;e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-s)*this._numInputFloats*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,s,this.maxParticles-s),e.endTransformFeedback(),e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,s),e.endTransformFeedback()}else e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,this.maxParticles),e.endTransformFeedback();e.bindVertexArray(null),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}$o.GPU_MAX_PARTICLES=1e5;class om extends Je{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get z(){return this.transform.z}set z(e){this.transform.z=e}constructor(e){super({name:"GpuParticleEmitter",width:e.width,height:e.height}),this.particle={life:2e3,transform:ki.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new ne,this.isEmitting=!1,this.emitRate=1,this.emitterType=qs.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:s,maxParticles:r,x:a,y:l,z:f,pos:g,isEmitting:m,emitRate:w,emitterType:A,radius:y,random:E}={...e};this.maxParticles=j(r??this.maxParticles,0,$o.GPU_MAX_PARTICLES),this.pos=g??z(a??0,l??0),this.z=f??0,this.isEmitting=m??this.isEmitting,this.emitRate=w??this.emitRate,this.emitterType=A??this.emitterType,this.radius=y??this.radius,this.particle={...this.particle,...s},this.random=E??new M,this.renderer=new $o(this,this.random,this.particle)}_initialize(e){super._initialize(e);const s=e.graphicsContext;this.renderer.initialize(s.__gl,s)}update(e,s){super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(s)}emitParticles(e){e<=0||this.renderer.emitParticles(e|0)}clearParticles(){this.renderer.clearParticles()}draw(e,s){e.draw("ex.particle",this.renderer,s)}}class Uu extends Oe{getGraphics(){return this._graphics}addGraphic(e,s){this._graphics.push(e),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,s?.offset&&(this._gfx.offset=s.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let e=this._tileBounds.clone();for(const s of this._graphics){const r=z(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:s.height-this.map.tileHeight));e=e.combine(s.localBounds.translate(r))}return e}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&this._graphics.splice(s,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(z(this.x,this.y))}get center(){return this.pos.add(z(0,this.map.tileHeight/2))}constructor(e,s,r,a){super([new it,new ne({offset:r??B.Zero,onPostDraw:(E,D)=>this.draw(E,D)}),new kr(a)]),this.solid=!1,this.events=new I,this._tileBounds=new ht,this._graphics=[],this._colliders=[],this.data=new Map,this.x=e,this.y=s,this.map=a,this._transform=this.get(it),this._isometricEntityComponent=this.get(kr);const l=this.map.tileWidth/2,f=this.map.tileHeight/2,g=(this.x-this.y)*l,m=(this.x+this.y)*f;this._transform.pos=z(g,m),this._isometricEntityComponent.elevation=a.elevation,this._gfx=this.get(ne),this._gfx.isVisible=!1;const w=this.map.tileWidth,A=this.map.tileHeight,y=z(0,this.map.renderFromTopOfGraphic?A:0);this._gfx.localBounds=this._tileBounds=new ht({left:-w/2,top:-A,right:w/2,bottom:A}).translate(y)}draw(e,s){const r=this.map.tileWidth/2;e.save(),e.translate(-r,0);for(const a of this._graphics)a.draw(e,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:a.height-this.map.tileHeight));e.restore()}}class am extends Oe{get visible(){return this.isVisible}set visible(e){this.isVisible=e}constructor(e){super([new it,new Tt({type:ft.Fixed}),new pe,new Ns,new Go((A,y)=>this.debug(A,y),!1)],e.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=z(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:s,tileWidth:r,tileHeight:a,columns:l,rows:f,renderFromTopOfGraphic:g,graphicsOffset:m,elevation:w}=e;this.transform=this.get(it),s&&(this.transform.pos=s),this.collider=this.get(pe),this.collider&&this.collider.set(this._composite=new Ce([])),this.pointer=this.get(Ns),this.renderFromTopOfGraphic=g??this.renderFromTopOfGraphic,this.graphicsOffset=m??this.graphicsOffset,this.elevation=w??this.elevation,this.tileWidth=r,this.tileHeight=a,this.columns=l,this.rows=f,this._pointerEventDispatcher=new Vh,this.tiles=new Array(l*f);for(let A=0;A<f;A++)for(let y=0;y<l;y++){const E=new Uu(y,A,this.graphicsOffset,this);this.tiles[y+A*l]=E,this.addChild(E),this._pointerEventDispatcher.addObject(E,D=>this.getTileByPoint(D.worldPos)===E,()=>!0)}this.pointer.localBounds=ht.fromDimension(r*l*this.transform.scale.x,a*f*this.transform.scale.y,z(.5,0))}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:B.Zero;{const r=e.offset;return this._originalOffsets.set(e,r),r}}updateColliders(){this._composite.clearColliders();const e=this.get(it).pos;for(const s of this.tiles)if(s.solid)for(const r of s.getColliders()){const a=this._getOrSetColliderOriginalOffset(r);r.offset=this.tileToWorld(z(s.x,s.y)).sub(e).add(a).sub(z(this.tileWidth/2,this.tileHeight)),r.owner=this,this._composite.addCollider(r)}this.collider.update()}worldToTile(e){e=e.sub(this.transform.globalPos);const s=this.tileWidth/2,r=this.tileHeight/2;return z(~~((e.x/s+e.y/r)/2),~~((e.y/r-e.x/s)/2))}tileToWorld(e){const s=this.tileWidth/2,r=this.tileHeight/2,a=(e.x-e.y)*s,l=(e.x+e.y)*r;return z(a,l).add(this.transform.pos)}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const s=this.worldToTile(e);return this.getTile(s.x,s.y)}_getMaxZIndex(){let e=Number.NEGATIVE_INFINITY;for(const s of this.tiles){const r=s.get(it).z;r>e&&(e=r)}return e}debug(e,s){const{showAll:r,showPosition:a,positionColor:l,positionSize:f,showGrid:g,gridColor:m,gridWidth:w,showColliderGeometry:A}=s.isometric,{geometryColor:y,geometryLineWidth:E,geometryPointSize:D}=s.collider;if(e.save(),e.z=this._getMaxZIndex()+.5,r||g){for(let L=0;L<this.rows+1;L++){const O=this.tileToWorld(z(0,L)),q=this.tileToWorld(z(this.columns,L));e.drawLine(O,q,m,w)}for(let L=0;L<this.columns+1;L++){const O=this.tileToWorld(z(L,0)),q=this.tileToWorld(z(L,this.rows));e.drawLine(O,q,m,w)}}if(r||a)for(const L of this.tiles)e.drawCircle(this.tileToWorld(z(L.x,L.y)),f,l);if(r||A){for(const L of this.tiles)if(L.solid)for(const O of L.getColliders())O.debug(e,y,{lineWidth:E,pointSize:D})}e.restore()}}class ol{constructor(e,s){this.id=zt(),this._stopped=!1,this._sequenceBuilder=s,this._sequenceContext=new Fr(e),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(e){this._actionQueue.update(e)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(e){return new ol(e,this._sequenceBuilder)}}class hm{constructor(e){this.id=zt(),this._actions=e}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}isComplete(e){return this._actions.every(s=>s.isComplete(e))}reset(){this._actions.forEach(e=>e.reset())}stop(){this._actions.forEach(e=>e.stop())}}class Zn{constructor(e,s){this.bounds=e,this.options=s,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...s},this.halfWidth=e.width/2,this.halfHeight=e.height/2}_split(){this._isDivided=!0;const e={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new Zn(new ht({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),e),this.topRight=new Zn(new ht({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),e),this.bottomLeft=new Zn(new ht({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),e),this.bottomRight=new Zn(new ht({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),e)}_insertIntoSubNodes(e){var s,r,a,l;!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.insert(e),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(e.bounds)&&this.topRight.insert(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.insert(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.insert(e)}insert(e){if(this._isDivided){this._insertIntoSubNodes(e);return}if(this.items.push(e),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const s of this.items)this._insertIntoSubNodes(s);this.items.length=0}}remove(e){var s,r,a,l;if(this.bounds.overlaps(e.bounds)){if(!this._isDivided){const f=this.items.indexOf(e);f>-1&&this.items.splice(f,1);return}!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.remove(e),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(e.bounds)&&this.topRight.remove(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.remove(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.remove(e)}}query(e){let s=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(e)&&(s=s.concat(this.topLeft.query(e))),this.topRight.bounds.overlaps(e)&&(s=s.concat(this.topRight.query(e))),this.bottomLeft.bounds.overlaps(e)&&(s=s.concat(this.bottomLeft.query(e))),this.bottomRight.bounds.overlaps(e)&&(s=s.concat(this.bottomRight.query(e)))),s=s.filter((r,a)=>s.indexOf(r)>=a),s}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let e=this.items;return this._isDivided&&(e=e.concat(this.topLeft.getAllItems()),e=e.concat(this.topRight.getAllItems()),e=e.concat(this.bottomLeft.getAllItems()),e=e.concat(this.bottomRight.getAllItems())),e=e.filter((s,r)=>e.indexOf(s)>=r),e}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(e){this.bounds.draw(e,Q.Yellow),this._isDivided&&(this.topLeft.bounds.draw(e,Q.Yellow),this.topRight.bounds.draw(e,Q.Yellow),this.bottomLeft.bounds.draw(e,Q.Yellow),this.bottomRight.bounds.draw(e,Q.Yellow))}}function lm(u){return!!u._initialize}function cm(u){return!!u.onAdd}function dm(u){return!!u.onRemove}function um(u){return!!u.onInitialize}function fm(u){return!!u._preupdate}function _m(u){return!!u.onPreUpdate}function gm(u){return!!u.onPostUpdate}function pm(u){return!!u.onPostUpdate}function mm(u){return!!u.onAdd}function vm(u){return!!u.onRemove}function wm(u){return!!u.onPreDraw}function xm(u){return!!u.onPostDraw}class bm{constructor(e,s=!1){this.path=e,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new vr(e,"arraybuffer",s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){const e=await this._resource.load();this._stream=new zu(e),this._gif=new Hu(this._stream);const s=this._gif.images.map(r=>new Xi(r.src,!1));return await Promise.all(s.map(r=>r.load())),this.data=this._images=s,this._sprites=this._images.map(r=>r.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(e=0){var s;return(s=this._sprites[e])!==null&&s!==void 0?s:null}toSpriteSheet(){const e=this._sprites;return e.length?new nn({sprites:e}):null}toAnimation(e){var s;const r=(s=this._gif)===null||s===void 0?void 0:s.images;if(r?.length){const a=r.map((l,f)=>{var g;return{graphic:this._sprites[f],duration:((g=this._gif)===null||g===void 0?void 0:g.frames[f].delayMs)||void 0}});return this._animation=new Bi({frames:a,frameDuration:e}),this._animation}return null}get readCheckBytes(){var e,s;return(s=(e=this._gif)===null||e===void 0?void 0:e.checkBytes)!==null&&s!==void 0?s:[]}}const ta=u=>u.reduce(function(e,s){return e*2+s},0),al=u=>{const e=[];for(let s=7;s>=0;s--)e.push(!!(u&1<<s));return e};class zu{constructor(e){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=s=>{const r=[];for(let a=0;a<s;a++)r.push(this.readByte());return r},this.read=s=>{let r="";for(let a=0;a<s;a++)r+=String.fromCharCode(this.readByte());return r},this.readUnsigned=()=>{const s=this.readBytes(2);return(s[1]<<8)+s[0]},this.data=new Uint8Array(e),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const Am=function(u,e){let s=0;const r=function(E){let D=0;for(let L=0;L<E;L++)e.charCodeAt(s>>3)&1<<(s&7)&&(D|=1<<L),s++;return D},a=[],l=1<<u,f=l+1;let g=u+1,m=[];const w=function(){m=[],g=u+1;for(let E=0;E<l;E++)m[E]=[E];m[l]=[],m[f]=null};let A=0,y=0;for(;;){if(y=A,A=r(g),A===l){w();continue}if(A===f)break;if(A<m.length)y!==l&&m.push(m[y].concat(m[A][0]));else{if(A!==m.length)throw new Error("Invalid LZW code.");m.push(m[y].concat(m[y][0]))}a.push.apply(a,m[A]),m.length===1<<g&&g<12&&g++}return a};class Hu{constructor(e){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=s=>{const r=[];for(let a=0;a<s;a++){const l=this._st.readBytes(3);r.push(l)}return r},this.readSubBlocks=()=>{let s,r;r="";do s=this._st.readByte(),r+=this._st.read(s);while(s!==0);return r},this.parseHeader=()=>{const s={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(s.sig=this._st.read(3),s.ver=this._st.read(3),s.sig!=="GIF")throw new Error("Not a GIF file.");s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned(),this._currentFrameCanvas.width=s.width,this._currentFrameCanvas.height=s.height;const r=al(this._st.readByte());s.gctFlag=r.shift(),s.colorResolution=ta(r.splice(0,3)),s.sortedFlag=r.shift(),s.globalColorTableSize=ta(r.splice(0,3)),s.backgroundColorIndex=this._st.readByte(),s.pixelAspectRatio=this._st.readByte(),s.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<s.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(s)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=s=>{const r=m=>{this.checkBytes.push(this._st.readByte());const w=al(this._st.readByte());return m.reserved=w.splice(0,3),m.disposalMethod=ta(w.splice(0,3)),m.userInputFlag=w.shift(),m.transparentColorFlag=w.shift(),m.delayTime=this._st.readUnsigned(),m.transparentColorIndex=this._st.readByte(),m.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(m)&&this.checkBytes.push(this._handler.gce),m},a=m=>{m.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(m)&&this.checkBytes.push(this._handler.com)},l=m=>{this.checkBytes.push(this._st.readByte()),m.ptHeader=this._st.readBytes(12),m.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(m)&&this.checkBytes.push(this._handler.pte)},f=m=>{const w=y=>{this.checkBytes.push(this._st.readByte()),y.unknown=this._st.readByte(),y.iterations=this._st.readUnsigned(),y.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(y)&&this.checkBytes.push(this._handler.app)},A=y=>{y.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[y.identifier]&&this._handler.app[y.identifier](y)&&this.checkBytes.push(this._handler.app[y.identifier])};switch(this.checkBytes.push(this._st.readByte()),m.identifier=this._st.read(8),m.authCode=this._st.read(3),m.identifier){case"NETSCAPE":w(m);break;default:A(m);break}},g=m=>{m.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(m)&&this.checkBytes.push(this._handler.unknown)};switch(s.label=this._st.readByte(),s.label){case 249:s.extType="gce",this._gce=r(s);break;case 254:s.extType="com",a(s);break;case 1:s.extType="pte",l(s);break;case 255:s.extType="app",f(s);break;default:s.extType="unknown",g(s);break}},this.parseImg=s=>{var r;const a=(g,m)=>{const w=new Array(g.length),A=g.length/m,y=(O,q)=>{const H=g.slice(q*m,(q+1)*m);w.splice.apply(w,[O*m,m].concat(H))},E=[0,4,2,1],D=[8,8,4,2];let L=0;for(let O=0;O<4;O++)for(let q=E[O];q<A;q+=D[O])y(q,L),L++;return w};s.leftPos=this._st.readUnsigned(),s.topPos=this._st.readUnsigned(),s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned();const l=al(this._st.readByte());s.lctFlag=l.shift(),s.interlaced=l.shift(),s.sorted=l.shift(),s.reserved=l.splice(0,2),s.lctSize=ta(l.splice(0,3)),s.lctFlag&&(s.lctBytes=this.parseColorTableBytes(1<<s.lctSize+1)),s.lzwMinCodeSize=this._st.readByte();const f=this.readSubBlocks();s.pixels=Am(s.lzwMinCodeSize,f),s.interlaced&&(s.pixels=a(s.pixels,s.width)),!((r=this._gce)===null||r===void 0)&&r.delayTime&&(s.delayMs=this._gce.delayTime*10),this.frames.push(s),this.arrayToImage(s,s.lctFlag?s.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(s)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const s={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(s.sentinel)){case"!":s.type="ext",this.parseExt(s);break;case",":s.type="img",this.parseImg(s);break;case";":s.type="eof",this._handler.eof&&this._handler.eof(s)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+s.sentinel.toString(16))}s.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(s,r)=>{var a,l,f,g;const m=document.createElement("canvas");m.width=s.width,m.height=s.height;const w=m.getContext("2d"),A=w.getImageData(0,0,m.width,m.height);let y=-1;!((a=this._gce)===null||a===void 0)&&a.transparentColorFlag&&(y=this._gce.transparentColorIndex);for(let D=0;D<s.pixels.length;D++){const L=s.pixels[D],O=r[L];L===y?A.data.set([0,0,0,0],D*4):A.data.set([...O,255],D*4)}if(w.putImageData(A,0,0),((l=this._gce)===null||l===void 0?void 0:l.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((f=this._gce)===null||f===void 0?void 0:f.disposalMethod)===2&&(!((g=this._hdr)===null||g===void 0)&&g.gctFlag)){const D=r[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${D[0]}, ${D[1]}, ${D[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(m,s.leftPos,s.topPos,s.width,s.height);const E=new Image;E.src=this._currentFrameCanvas.toDataURL(),this.images.push(E)},this._st=e,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class ym{constructor(e,s,{bustCache:r,...a}={}){this.path=e,this.family=s,this._isLoaded=!1,this._resource=new vr(e,"blob",r),this._options=a}async load(){if(this.isLoaded())return this.data;try{const e=await this._resource.load(),s=URL.createObjectURL(e);this.data||(this.data=new FontFace(this.family,`url(${s})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(e){throw`Error loading FontSource from path '${this.path}' with error [${e.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(e){return new rn({family:this.family,...this._options,...e})}}const Ou=Bu(),Cm=/^\s*(?:function)?\*/;function Wu(u){return typeof u!="function"?!1:Cm.test(Function.prototype.toString.call(u))?!0:Object.getPrototypeOf?Object.getPrototypeOf(u)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function Vu(...u){var e;const s=at.getInstance();let r,a,l,f;Wu(u[0])&&(a=globalThis,r=u[0],l=u[1]),Wu(u[1])&&(a=u[0],r=u[1],l=u[2]),u[1]instanceof oi&&(a=u[0],f=u[1],r=u[2],l=u[3]),u[0]instanceof oi&&(a=globalThis,f=u[0],r=u[1],l=u[2]);const g=ku(Ou),m=l?.timing,w=g?!1:(e=l?.autostart)!==null&&e!==void 0?e:!0;let A;try{A=f??oi.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let y=!1,E=!1,D=!1;const L=r.bind(a),O=L();let q;const H=new Promise((J,Y)=>{q=$=>{try{if(D){E=!0,J();return}const{done:ot,value:Z}=Ou.scope(!0,()=>O.next($));if(ot||D){E=!0,J();return}Z instanceof Promise?Z.then(()=>{A.clock.schedule(q,0,m)}):Z===void 0||Z===void 0?A.clock.schedule(q,0,m):A.clock.schedule(q,Z||0,m)}catch(ot){Y(ot);return}},w&&(y=!0,q(A.clock.elapsed()))}),V={isRunning:()=>y&&!D&&!E,isComplete:()=>E,cancel:()=>{D=!0},start:()=>(y?s.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(L)):(y=!0,q(A.clock.elapsed())),V),generator:O,done:H,then:H.then.bind(H),[Symbol.iterator]:()=>O};return V}class ea extends Oe{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(e){var s,r,a,l;super(),this._logger=at.getInstance(),this.transform=new it,this.graphics=new ne,this._completeFuture=new P,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=e.duration,this.easing=(s=e.easing)!==null&&s!==void 0?s:Gt.Linear,this.direction=(r=e.direction)!==null&&r!==void 0?r:"out",this.hideLoader=(a=e.hideLoader)!==null&&a!==void 0?a:!1,this.blockInput=(l=e.blockInput)!==null&&l!==void 0?l:!1,this.transform.coordPlane=De.Screen,this.transform.pos=B.Zero,this.transform.z=1/0,this.graphics.anchor=B.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(e,s){this.complete||(this._currentDistance+=j(s/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=j(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=j(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(e){}onStart(e){}onUpdate(e){}onEnd(e){}onReset(){}reset(){this.started=!1,this._completeFuture=new P,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(e,s){const r=s;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),r.world.entityManager.getById(this.id))return this._co;this._engine=e,r.add(this);const a=this;return this._co=Vu(e,function*(){for(;!a.complete;){const l=yield;a.updateTransition(a._engine,l),a._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class Sm extends ea{constructor(e){var s,r;super({...e,duration:(s=e.duration)!==null&&s!==void 0?s:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(r=e.color)!==null&&r!==void 0?r:Q.Black}onInitialize(e){this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=new Ir({width:e.screen.resolution.width,height:e.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=e}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class Pm extends ea{constructor(e){super({direction:"in",...e}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(e){this.image=await e.engine.screenshot(!0),await this.image.decode()}onInitialize(e){this.engine=e,this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=Xi.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=z(1/e.screen.pixelRatio,1/e.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class Tm extends ea{constructor(e){var s;super({direction:"in",...e}),this._easing=Gt.Linear,this.name=`Slide#${this.id}`,this.slideDirection=e.slideDirection,this.transform.coordPlane=De.World,this.graphics.forceOnScreen=!0,this._easing=(s=e.easingFunction)!==null&&s!==void 0?s:this._easing,this._vectorEasing=Gt.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(e){this._image=await e.engine.screenshot(!0),await this._image.decode(),this._screenCover=Xi.fromHtmlImageElement(this._image).toSprite()}onInitialize(e){switch(this._engine=e,this.slideDirection){case"up":{this._directionOffset=z(0,-e.screen.resolution.height);break}case"down":{this._directionOffset=z(0,e.screen.resolution.height);break}case"left":{this._directionOffset=z(-e.screen.resolution.width,0);break}case"right":{this._directionOffset=z(e.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=z(1/e.screen.pixelRatio,1/e.screen.pixelRatio)}onUpdate(e){this._camera.pos=this._vectorEasing(e,this._destinationCameraPosition,this._startCameraPosition,1)}}class hl extends ie{constructor(e){super(),this.color=Q.Black,this.thickness=1;const{start:s,end:r,color:a,thickness:l}=e;this.start=s,this.end=r,this.color=a??this.color,this.thickness=l??this.thickness,this._localBounds=this._calculateBounds();const{width:f,height:g}=this._localBounds;this.width=f,this.height=g}get localBounds(){return this._localBounds}_calculateBounds(){const e=this.end.sub(this.start).normal(),s=this.thickness/2,r=[this.start.add(e.scale(s)),this.end.add(e.scale(s)),this.end.add(e.scale(-s)),this.start.add(e.scale(-s))];return ht.fromPoints(r)}_drawImage(e,s,r){e.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new hl({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class ll extends On{get points(){return this._points}set points(e){this._points=e;const s=this.minPoint;this.width=this._points.reduce((r,a)=>Math.max(a.x,r),0)-s.x,this.height=this._points.reduce((r,a)=>Math.max(a.y,r),0)-s.y,this.flagDirty()}get minPoint(){const e=this._points.reduce((r,a)=>Math.min(a.x,r),1/0),s=this._points.reduce((r,a)=>Math.min(a.y,r),1/0);return z(e,s)}constructor(e){super(e),this._points=[],this.points=e.points,this.filtering=_e.Blended,this.rasterize()}clone(){return new ll({points:this.points.map(e=>e.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){if(this.points&&this.points.length){e.beginPath();const s=this.minPoint.negate(),r=this.points[0].add(s);e.moveTo(r.x,r.y),this.points.forEach(a=>{e.lineTo(a.x+s.x,a.y+s.y)}),e.lineTo(r.x,r.y),e.closePath(),this.color&&e.fill(),this.strokeColor&&e.stroke()}}}var Ss;(function(u){u.Stretch="stretch",u.Tile="tile",u.TileFit="tile-fit"})(Ss||(Ss={}));class cl extends ie{constructor(e){super(e),this._logger=at.getInstance(),this._config=e,this._imgSource=e.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(e,s=!1){this._config.width=e,s&&this._initialize()}setTargetHeight(e,s=!1){this._config.height=e,s&&this._initialize()}setMargins(e,s,r,a,l=!1){this._config.sourceConfig.leftMargin=e,this._config.sourceConfig.topMargin=s,this._config.sourceConfig.rightMargin=r,this._config.sourceConfig.bottomMargin=a,l&&this._initialize()}setStretch(e,s,r=!1){e==="horizontal"?this._config.destinationConfig.horizontalStretch=s:e==="vertical"?this._config.destinationConfig.verticalStretch=s:(this._config.destinationConfig.horizontalStretch=s,this._config.destinationConfig.verticalStretch=s),r&&this._initialize()}getConfig(){return this._config}_drawTile(e,s,r,a,l,f,g){const m=f||0,w=g||0;let A,y,E,D;const L=this._getNumberOfTiles(s.width,r.x,a),O=this._getNumberOfTiles(s.height,r.y,l);for(let q=0;q<L;q++)for(let H=0;H<O;H++){let{tempSize:V,tempPosition:J}=this._calculateParams(q,L,s.width,r.x,this._config.destinationConfig.horizontalStretch);A=V,y=J,{tempSize:V,tempPosition:J}=this._calculateParams(H,O,s.height,r.y,this._config.destinationConfig.verticalStretch),E=V,D=J,e.drawImage(s,0,0,s.width,s.height,m+y,w+D,A,E)}}_drawImage(e,s,r){this._imgSource.isLoaded()?(this._drawTile(e,this._canvasA,new B(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(e,this._canvasB,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(e,this._canvasC,new B(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(e,this._canvasD,new B(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(e,this._canvasE,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasF,new B(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasG,new B(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasH,new B(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasI,new B(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const e=this._canvasA.getContext("2d");e?.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const s=this._canvasB.getContext("2d");s?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const r=this._canvasC.getContext("2d");r?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const a=this._canvasD.getContext("2d");a?.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const l=this._canvasE.getContext("2d");l?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const f=this._canvasF.getContext("2d");f?.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const g=this._canvasG.getContext("2d");g?.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const m=this._canvasH.getContext("2d");m?.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const w=this._canvasI.getContext("2d");w?.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new cl(this._config)}_getNumberOfTiles(e,s,r){switch(r){case Ss.Stretch:return 1;case Ss.Tile:return Math.ceil(s/e);case Ss.TileFit:return Math.ceil(s/e)}}_calculateParams(e,s,r,a,l){switch(l){case Ss.Stretch:return{tempPosition:0,tempSize:a};case Ss.Tile:return e===s-1?{tempPosition:e*r,tempSize:r-(s*r-a)}:{tempPosition:e*r,tempSize:r};case Ss.TileFit:const f=a/s;return{tempPosition:e*f,tempSize:f}}}}class dl extends Bi{constructor(e){super({...e,frames:e.animation.frames.slice(),strategy:e.animation.strategy,frameDuration:e.animation.frameDuration,speed:e.animation.speed,reverse:e.animation.isReversed}),this._ready=new P,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...e.sourceView},this._tiledWidth=e.width,this._tiledHeight=e.height;const s=[];for(let r=0;r<this.frames.length;r++){const a=this.frames[r].graphic;if(a&&a instanceof Di){const l=new wr({image:a.image,width:e.width,height:e.height,sourceView:{...a.sourceView},wrapping:e.wrapping,filtering:e.filtering});this.frames[r].graphic=l,l.ready.then(()=>{l.sourceView={...l.sourceView,...this._sourceView}}),s.push(l.ready)}}Promise.all(s).then(()=>this._ready.resolve())}static fromAnimation(e,s){return new dl({width:e.width,height:e.height,...s,animation:e})}_updateSourceView(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof Di&&(s.sourceView={...s.sourceView,...this._sourceView})}}get sourceView(){return Ri(this._sourceView,()=>this._updateSourceView())}set sourceView(e){this._sourceView=Ri(e,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof Di&&(s.sourceView.height=this._tiledHeight||s.height,s.destSize.height=this._tiledHeight||s.height,s.sourceView.width=this._tiledWidth||s.width,s.destSize.width=this._tiledWidth||s.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(e){this._tiledWidth=e,this._updateWidthHeight()}set height(e){this._tiledHeight=e,this._updateWidthHeight()}}const Nu=5,Qn={},Em=()=>{for(const u in Qn)Qn[u]=0},ia=(u,e)=>{const s=b.isEnabled("suppress-obsolete-message");Qn[u]<Nu&&!s&&(at.getInstance().warn(u),console.trace&&e.showStackTrace&&console.trace()),Qn[u]++};function Im(u){return u={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...u},function(e,s,r){if(r&&!(typeof r.value=="function"||typeof r.get=="function"||typeof r.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const l=`${`${e.name||""}${e.name&&s?".":""}${s||""}`} is marked obsolete: ${u.message}`+(u.alternateMethod?` Use ${u.alternateMethod} instead`:"");Qn[l]||(Qn[l]=0);const f=r?{...r}:e;if(!r){class g extends f{constructor(...w){ia(l,u),super(...w)}}return g}return r&&r.value?(f.value=function(){return ia(l,u),r.value.apply(this,arguments)},f):(r&&r.get&&(f.get=function(){return ia(l,u),r.get.apply(this,arguments)}),r&&r.set&&(f.set=function(){return ia(l,u),r.set.apply(this,arguments)}),f)}}class Rm{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const e=new P;return this._queue.push(e),e.promise}dequeue(e){this._queue.shift().resolve(e)}}class Dm{constructor(e){this._count=e,this._waitQueue=new Rm}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(e=1){if(e!==0){for(;e!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),e--;this._count+=e}}}const ul="0.30.3";return x(),h})())}(wl)),wl.exports}/*! For license information please see excalibur-perlin.min.js.LICENSE.txt */var uf;function _x(){return uf||(uf=1,function(d,t){(function(i,n){d.exports=n(fx())})(self,i=>(()=>{var n={"./src/perlin-noise.ts":(_,p,v)=>{v.r(p),v.d(p,{PerlinDrawer2D:()=>I,PerlinGenerator:()=>P});var x=v("excalibur");function b(F,R,T){return R+F*(T-R)}function S(F){return F*F*F*(F*(6*F-15)+10)}class P{constructor(R){var T,M,W,U;this._perm=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],this._p=new Uint8Array(512),this._defaultPerlinOptions={octaves:1,frequency:1,amplitude:1,persistance:.5},this.persistance=.5,this.amplitude=1,this.frequency=1,this.octaves=1,R={...this._defaultPerlinOptions,...R},this.persistance=(T=R.persistance)!==null&&T!==void 0?T:this.persistance,this.amplitude=(M=R.amplitude)!==null&&M!==void 0?M:this.amplitude,this.frequency=(W=R.frequency)!==null&&W!==void 0?W:this.frequency,this.octaves=(U=R.octaves)!==null&&U!==void 0?U:this.octaves,R.seed?this._random=new x.Random(R.seed):this._random=new x.Random,this._perm=this._random.shuffle(this._perm);for(let G=0;G<512;G++)this._p[G]=255&this._perm[G%256]}noise(){let R=this.amplitude,T=this.frequency,M=0,W=0;for(let U=0;U<this.octaves;U++){switch(arguments.length){case 1:M+=this._noise1d(arguments[0]*T)*R;break;case 2:M+=this._noise2d(arguments[0]*T,arguments[1]*T)*R;break;case 3:M+=this._noise3d(arguments[0]*T,arguments[1]*T,arguments[2]*T)*R;break;default:throw new Error("Invalid arguments for perlin noise")}W+=R,R*=this.persistance,T*=2}return M/W}sequence(R,T){T||(T=1/R);const M=new Array(R);for(let W=0;W<R;W++)M[W]=this.noise(W*T);return M}grid(R,T,M){M||(M=1/Math.min(R,T));const W=new Array(R*T);for(let U=0;U<T;U++)for(let G=0;G<R;G++)W[G+U*R]=this.noise(G*M,U*M);return W}_gradient3d(R,T,M,W){const U=15&R,G=U<8?T:M,j=U<4?M:U===12||U===14?T:W;return((1&U)==0?G:-G)+((2&U)==0?j:-j)}_gradient2d(R,T,M){const W=(1&R)==0?T:M;return(2&R)==0?-W:W}_gradient1d(R,T){return(1&R)==0?-T:T}_noise1d(R){const T=255&Math.floor(R);return(b(S(R-=Math.floor(R)),this._gradient1d(this._p[T],R),this._gradient1d(this._p[T+1],R-1))+1)/2}_noise2d(R,T){const M=255&Math.floor(R),W=255&Math.floor(T);R-=Math.floor(R),T-=Math.floor(T);const U=S(R),G=S(T),j=this._p[M]+W,X=this._p[M+1]+W;return(b(G,b(U,this._gradient2d(this._p[j],R,T),this._gradient2d(this._p[X],R-1,T)),b(U,this._gradient2d(this._p[j+1],R,T-1),this._gradient2d(this._p[X+1],R-1,T-1)))+1)/2}_noise3d(R,T,M){const W=255&Math.floor(R),U=255&Math.floor(T),G=255&Math.floor(M);R-=Math.floor(R),T-=Math.floor(T),M-=Math.floor(M);const j=S(R),X=S(T),rt=S(M),lt=this._p[W]+U,yt=this._p[W+1]+U,vt=this._p[lt]+G,Pt=this._p[yt]+G,Dt=this._p[lt+1]+G,B=this._p[yt+1]+G;return(b(rt,b(X,b(j,this._gradient3d(this._p[vt],R,T,M),this._gradient3d(this._p[Pt],R-1,T,M)),b(j,this._gradient3d(this._p[Dt],R,T-1,M),this._gradient3d(this._p[B],R-1,T-1,M))),b(X,b(j,this._gradient3d(this._p[vt+1],R,T,M-1),this._gradient3d(this._p[Pt+1],R-1,T,M-1)),b(j,this._gradient3d(this._p[Dt+1],R,T-1,M-1),this._gradient3d(this._p[B+1],R-1,T-1,M-1))))+1)/2}}class I{constructor(R,T){this.generator=R,this.colorFcn=M=>M<.5?x.Color.Black:x.Color.White,T&&(this.colorFcn=T)}image(R,T){const M=document.createElement("img"),W=document.createElement("canvas");W.width=R,W.height=T;const U=W.getContext("2d");return this.draw(U,0,0,R,T),M.src=W.toDataURL(),M}draw(R,T,M,W,U){const G=this.generator.grid(W,U),j=R.getImageData(T,M,W,U);for(let X=0;X<U;X++)for(let rt=0;rt<W;rt++){const lt=4*(rt+X*j.width),yt=G[rt+W*X],vt=this.colorFcn(yt);j.data[lt]=vt.r,j.data[lt+1]=vt.g,j.data[lt+2]=vt.b,j.data[lt+3]=Math.floor(255*vt.a)}R.putImageData(j,T,M)}}},excalibur:_=>{_.exports=i}},o={};function h(_){var p=o[_];if(p!==void 0)return p.exports;var v=o[_]={exports:{}};return n[_](v,v.exports,h),v.exports}h.n=_=>{var p=_&&_.__esModule?()=>_.default:()=>_;return h.d(p,{a:p}),p},h.d=(_,p)=>{for(var v in p)h.o(p,v)&&!h.o(_,v)&&Object.defineProperty(_,v,{enumerable:!0,get:p[v]})},h.o=(_,p)=>Object.prototype.hasOwnProperty.call(_,p),h.r=_=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(_,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(_,"__esModule",{value:!0})};var c={};return(()=>{h.r(c),h.d(c,{PerlinDrawer2D:()=>_.PerlinDrawer2D,PerlinGenerator:()=>_.PerlinGenerator});var _=h("./src/perlin-noise.ts")})(),c})())}(vl)),vl.exports}var gx=_x();const px=new gx.PerlinGenerator({seed:Date.now(),octaves:3,frequency:24,amplitude:.91,persistance:.95}),js=new kw({pos:tt(0,0),tileWidth:64,tileHeight:32,columns:25,rows:25});let mx=[$i.getSprite(0,0),$i.getSprite(1,0),$i.getSprite(2,0),$i.getSprite(3,0),$i.getSprite(4,0),$i.getSprite(5,0),$i.getSprite(6,0),$i.getSprite(0,1),$i.getSprite(1,1),$i.getSprite(2,1)],xl=0;for(const d of js.tiles){if(kg(xl,js.columns,js.rows)){if(d.x==0){let t=new ns({useAnchor:!0,members:[{graphic:aa.getSprite(0,0),offset:tt(0,16)},{graphic:ut.tree.toSprite(),offset:tt(-6,-24)}]});d.addGraphic(t)}else if(d.y==0&&d.x!=0||d.y==js.rows-1&&d.x!=0){const t=ut.fence.toSprite();let i=new ns({useAnchor:!0,members:[{graphic:aa.getSprite(0,0),offset:tt(0,-32)},{graphic:t,offset:tt(0,-32)}]});d.addGraphic(i)}else{let t=new ns({useAnchor:!0,members:[{graphic:aa.getSprite(0,0),offset:tt(0,-32)}]});d.addGraphic(t)}d.solid=!0,d.addCollider(zw.Polygon([tt(0,17),tt(32,1),tt(63,17),tt(32,33)]))}else{let t=aa.getSprite(0,0);const n=px.grid(js.columns,js.rows)[xl];let o=new pr;if(n>.55){const h=o.pickOne(mx);let c=o.integer(16,32),_=-32,p=new ns({useAnchor:!0,members:[{graphic:t,offset:tt(0,-32)},{graphic:h,offset:tt(c,_)}]});d.addGraphic(p)}else{let h=new ns({useAnchor:!0,members:[{graphic:t,offset:tt(0,-32)}]});d.addGraphic(h)}}xl++}js.updateColliders();const Ys=150,vx=new ze({strategy:He.Loop,frames:[{graphic:Ti.getSprite(0,0),duration:Ys},{graphic:Ti.getSprite(1,0),duration:Ys},{graphic:Ti.getSprite(2,0),duration:Ys},{graphic:Ti.getSprite(3,0),duration:Ys},{graphic:Ti.getSprite(4,0),duration:Ys},{graphic:Ti.getSprite(5,0),duration:Ys},{graphic:Ti.getSprite(6,0),duration:Ys},{graphic:Ti.getSprite(7,0),duration:Ys}]});class wx extends Ai{engine;scaleAnimation;resetSignal=new ee("waveReset");lightEnemiesScore;darkEnemiesScore;blessingsScore;soulsScore;swordPlayerScore;bowPlayerScore;totalEnemies;totalEnemiesRemoved;balanceEnemyTypesDefeated;balancePickups;balancePlayerKills;balanceEnemyDefeatRate;myWidth;heartButton;flexButton;clockButton;uiData;constructor(t){let i=t.screen.contentArea,n=i.right-i.left-20,o=i.bottom-i.top-20,h=new bt(10,10);super({width:n,height:o,pos:h,color:kt.fromHex("#444444"),z:9e3}),this.myWidth=n,this.uiData={lightEnemiesDefeated:0,darkEnemiesDefeated:0,blessingsCollected:0,soulsCollected:0,totalEnemies:0,totalEnemiesRemoved:0,swordPlayerScore:0,bowPlayerScore:0},this.engine=t;class c extends Ai{constructor(){super({pos:tt(n/2-24,15),x:n/2,width:48,height:48,z:2002}),this.graphics.use(vx)}}this.scaleAnimation=new c,this.addChild(this.scaleAnimation),new rs({pos:tt(24,45),text:"0",font:new ss({family:"Arial",size:24,color:kt.White,textAlign:os.Center})}),this.darkEnemiesScore=Pi.create(tt(80,47),"0"),this.lightEnemiesScore=Pi.create(tt(150,47),"0"),this.blessingsScore=Pi.create(tt(80,88),"0"),this.soulsScore=Pi.create(tt(150,88),"0"),this.swordPlayerScore=Pi.create(tt(80,125),"0"),this.bowPlayerScore=Pi.create(tt(150,125),"0"),this.totalEnemies=Pi.create(tt(80,165),"0"),this.totalEnemiesRemoved=Pi.create(tt(150,165),"0"),this.balanceEnemyTypesDefeated=Pi.create(tt(225,47),"0"),this.balancePickups=Pi.create(tt(225,88),"0"),this.balancePlayerKills=Pi.create(tt(225,125),"0"),this.balanceEnemyDefeatRate=Pi.create(tt(231,165),"0"),this.addChild(this.lightEnemiesScore),this.addChild(this.darkEnemiesScore),this.addChild(this.blessingsScore),this.addChild(this.soulsScore),this.addChild(this.swordPlayerScore),this.addChild(this.bowPlayerScore),this.addChild(this.totalEnemies),this.addChild(this.totalEnemiesRemoved),this.addChild(this.balanceEnemyTypesDefeated),this.addChild(this.balancePickups),this.addChild(this.balancePlayerKills),this.addChild(this.balanceEnemyDefeatRate),this.addChild(Ke.create(tt(110,45),Ta.getSprite(1,0),tt(.75,.75))),this.addChild(Ke.create(tt(40,45),Ta.getSprite(0,0),tt(.75,.75))),this.addChild(Ke.create(tt(44,90),ut.blessing.toSprite(),tt(1.4,1.4))),this.addChild(Ke.create(tt(115,90),ut.soul.toSprite(),tt(1.4,1.4))),this.addChild(Ke.create(tt(21,105),Kn.getSprite(0,0),tt(1,1))),this.addChild(Ke.create(tt(105,119),Xr.getSprite(0,0),tt(1,1))),this.addChild(Ke.create(tt(38,165),qe.getSprite(0,0),tt(.75,.75))),this.addChild(Ke.create(tt(108,160),ut.swordPlayerIconDamaged.toSprite(),tt(.6,.6))),this.addChild(Ke.create(tt(180,45),Ti.getSprite(0,0),tt(.6,.6))),this.addChild(Ke.create(tt(180,85),Ti.getSprite(0,0),tt(.6,.6))),this.addChild(Ke.create(tt(180,125),Ti.getSprite(0,0),tt(.6,.6))),this.addChild(Ke.create(tt(180,165),Ti.getSprite(0,0),tt(.6,.6))),this.addChild(Ke.create(tt(n/2-144,250),ut.spectrum.toSprite(),tt(1,1))),this.addChild(Ke.create(tt(n/2-5,240),ut.cursor.toSprite(),tt(1.5,1.5)))}show(t,i,n,o){o.strength>=2&&this.flexButton.updateEnable(!1),o.speed>=2&&this.clockButton.updateEnable(!1),this.uiData.lightEnemiesDefeated=i.lightEnemiesDefeated,this.uiData.darkEnemiesDefeated=i.darkEnemiesDefeated,this.uiData.blessingsCollected=i.blessingsCollected,this.uiData.soulsCollected=i.soulsCollected,this.uiData.totalEnemies=i.totalEnemies,this.uiData.totalEnemiesRemoved=i.totalEnemiesRemoved,this.uiData.bowPlayerScore=n.lightNumberOfEnemiesDefeated,this.uiData.swordPlayerScore=n.darkNumberOfEnemiesDefeated,this.lightEnemiesScore.text=`${this.uiData.lightEnemiesDefeated}`,this.darkEnemiesScore.text=`${this.uiData.darkEnemiesDefeated}`,this.blessingsScore.text=`${this.uiData.blessingsCollected}`,this.soulsScore.text=`${this.uiData.soulsCollected}`,this.swordPlayerScore.text=`${this.uiData.swordPlayerScore}`,this.bowPlayerScore.text=`${this.uiData.bowPlayerScore}`,this.totalEnemies.text=`${this.uiData.totalEnemies}`,this.totalEnemiesRemoved.text=`${this.uiData.totalEnemiesRemoved}`;let h=Math.abs(this.uiData.darkEnemiesDefeated-this.uiData.lightEnemiesDefeated);this.balanceEnemyTypesDefeated.text=`${h}`;let c=Math.abs(this.uiData.blessingsCollected-this.uiData.soulsCollected);this.balancePickups.text=`${c}`;let _=Math.abs(this.uiData.bowPlayerScore-this.uiData.swordPlayerScore);if(this.balancePlayerKills.text=`${_}`,this.uiData.totalEnemies==0)this.balanceEnemyDefeatRate.text="0%";else{let p=((1-this.uiData.totalEnemiesRemoved/this.uiData.totalEnemies)*100).toFixed(0);p.length,this.balanceEnemyDefeatRate.text=`${p}%`}t.add(this),this.resetSignal.send([])}hide(t){t.remove(this)}onAdd(t){this.clockButton=new bl(ut.clock.toSprite(),tt(this.myWidth-75,155),"speed",()=>{console.log("clock")}),this.addChild(this.clockButton),this.heartButton=new bl(ut.heart.toSprite(),tt(this.myWidth-75,45),"constitution",()=>{console.log("heart")}),this.addChild(this.heartButton),this.flexButton=new bl(ut.flex.toSprite(),tt(this.myWidth-75,100),"strength",()=>{console.log("flex")}),this.addChild(this.flexButton)}handleTouchControls(t){const i=t.rawEvent.coordinates.screenPos;t.rawEvent.type=="up"?this.heartButton?.contains(i.x,i.y)?this.heartButton.onUp():this.flexButton?.contains(i.x,i.y)?this.flexButton.onUp():this.clockButton?.contains(i.x,i.y)&&this.clockButton.onUp():t.rawEvent.type=="down"&&(this.heartButton?.contains(i.x,i.y)?this.heartButton.onDown():this.flexButton?.contains(i.x,i.y)?this.flexButton.onDown():this.clockButton?.contains(i.x,i.y)&&this.clockButton.onDown())}onInitialize(t){}}class Ke extends Ai{constructor(t,i,n){super({pos:t}),n&&(this.scale=n),this.graphics.use(i)}static create(t,i,n){return new Ke(t,i,n)}}let Pi=class Lg extends rs{constructor(t,i){super({pos:t,text:i,font:new ss({family:"Arial",size:20,color:kt.White,textAlign:os.Center})})}static create(t,i){return new Lg(t,i)}};class bl extends Ai{constructor(t,i,n,o){super({width:80,height:48,pos:i,z:2002,anchor:bt.Half,color:kt.fromHex("#2bb2ea")}),this.callback=o,this.type=n,this.pointer.useGraphicsBounds=!1,this.pointer.useColliderShape=!0,this.icon=t;const h={width:80,height:48,source:ut.buttonUp,sourceConfig:{width:192,height:64,leftMargin:3,rightMargin:3,topMargin:2,bottomMargin:4},destinationConfig:{drawCenter:!0,horizontalStretch:oa.Stretch,verticalStretch:oa.Stretch}};this.upGraphic=new nf(h),this.upGraphicGroup=new ns({useAnchor:!0,members:[this.upGraphic,{graphic:t,offset:tt(22,8)}]}),this.graphics.use(this.upGraphicGroup);const c={width:80,height:48,source:ut.buttonDown,sourceConfig:{width:192,height:64,leftMargin:3,rightMargin:3,topMargin:2,bottomMargin:2},destinationConfig:{drawCenter:!0,horizontalStretch:oa.Stretch,verticalStretch:oa.Stretch}};this.downGraphic=new nf(c),this.downGraphicGroup=new ns({useAnchor:!0,members:[this.downGraphic,{graphic:t,offset:tt(22,8)}]})}upGraphic;downGraphic;icon;type;enabled=!0;upGraphicGroup;downGraphicGroup;subUp;subDown;progressionSignal=new ee("progressionUpdate");updateEnable(t){if(this.enabled=t,this.enabled==!1){const i=this.graphics.current;i&&(i.tint=kt.Gray)}}onInitialize=t=>{};onDown(){this.enabled&&this.graphics.use(this.downGraphicGroup)}onUp(){this.enabled&&(this.scene.hideEndOfWaveModal(),this.graphics.use(this.upGraphicGroup),this.progressionSignal.send([this.type]))}onAdd(t){}onRemove(t){}}class xx extends Ai{constructor(t){super({name:"StatusBar",width:t.x,height:15,x:0,y:1,z:999}),this.dims=t,this.updateSignal.listen(this.UIUpdate.bind(this)),this.lightKillsLabel=new rs({anchor:bt.Zero,text:"0",font:new ss({size:8,family:"Arial",color:kt.White,textAlign:os.Center}),x:t.x-58,y:1}),this.darkKillsLabel=new rs({anchor:bt.Zero,text:"0",font:new ss({size:8,family:"Arial",color:kt.White,textAlign:os.Center}),x:t.x-84,y:1}),this.enemiesRemainingLabel=new rs({anchor:bt.Zero,text:"0",font:new ss({size:8,family:"Arial",color:kt.White,textAlign:os.Center}),x:t.x-110,y:1}),this.soulsCollectedLabel=new rs({anchor:bt.Zero,text:"0",font:new ss({size:8,family:"Arial",color:kt.White,textAlign:os.Center}),x:t.x-36,y:1}),this.blessingsCollectedLabel=new rs({anchor:bt.Zero,text:"0",font:new ss({size:8,family:"Arial",color:kt.White,textAlign:os.Center}),x:t.x-12,y:1}),this.addChild(this.lightKillsLabel),this.addChild(this.darkKillsLabel),this.addChild(this.enemiesRemainingLabel),this.addChild(this.soulsCollectedLabel),this.addChild(this.blessingsCollectedLabel);class i extends Ai{constructor(o,h,c){super({pos:o,width:10,height:10,z:999}),this.graphics.use(h),c&&(this.scale=c)}}this.addChild(new i(new bt(t.x-25,0),ut.blessing.toSprite())),this.addChild(new i(new bt(t.x-50,0),ut.soul.toSprite())),this.addChild(new i(new bt(t.x-125,0),qe.getSprite(0,0),new bt(.4,.4))),this.addChild(new i(new bt(t.x-75,0),Ta.getSprite(0,0),new bt(.4,.4))),this.addChild(new i(new bt(t.x-100,0),Ta.getSprite(1,0),new bt(.4,.4))),this.resetSignal.listen(()=>this.reset())}totalEnemiesDefeated=0;totalEnemiesRemaining=0;totalEnemiesRemoved=0;lightEnemiesDefeated=0;darkEnemiesDefeated=0;soulsCollected=0;blessingsCollected=0;updateSignal=new ee("stateUpdate");enemiesInWave=0;resetSignal=new ee("waveReset");enemiesRemainingLabel;lightKillsLabel;darkKillsLabel;soulsCollectedLabel;blessingsCollectedLabel;onPreUpdate(t,i){this.enemiesRemainingLabel.text=`${this.totalEnemiesRemaining}`,this.lightKillsLabel.text=`${this.lightEnemiesDefeated}`,this.darkKillsLabel.text=`${this.darkEnemiesDefeated}`,this.soulsCollectedLabel.text=`${this.soulsCollected}`,this.blessingsCollectedLabel.text=`${this.blessingsCollected}`}UIUpdate(t){const[i,n]=t.detail.params;i==="enemyDefeated"?(n==="light"&&(this.lightEnemiesDefeated+=1),n==="dark"&&(this.darkEnemiesDefeated+=1),this.totalEnemiesDefeated=this.lightEnemiesDefeated+this.darkEnemiesDefeated+this.totalEnemiesRemoved,this.totalEnemiesRemaining=this.enemiesInWave-this.totalEnemiesDefeated):i=="soul"?this.soulsCollected++:i=="blessing"?this.blessingsCollected++:i=="batchsize"?(this.enemiesInWave=n,this.totalEnemiesDefeated=0,this.totalEnemiesRemoved=0,this.lightEnemiesDefeated=0,this.darkEnemiesDefeated=0,this.totalEnemiesRemaining=this.enemiesInWave-this.totalEnemiesDefeated):i=="playerDamaged"&&(this.totalEnemiesRemoved++,this.totalEnemiesDefeated=this.lightEnemiesDefeated+this.darkEnemiesDefeated+this.totalEnemiesRemoved,this.totalEnemiesRemaining=this.enemiesInWave-this.totalEnemiesDefeated)}reset(){this.lightEnemiesDefeated=0,this.darkEnemiesDefeated=0,this.soulsCollected=0,this.blessingsCollected=0,this.totalEnemiesDefeated=0,this.totalEnemiesRemoved=0}getUIState(){return{lightEnemiesDefeated:this.lightEnemiesDefeated,darkEnemiesDefeated:this.darkEnemiesDefeated,soulsCollected:this.soulsCollected,blessingsCollected:this.blessingsCollected,totalEnemies:this.enemiesInWave,totalEnemiesRemoved:this.totalEnemiesRemoved}}}class bx{scene;_isModalShowing=!1;_gestureStartPos=bt.Zero;_currentPos=bt.Zero;_moveDelta=bt.Zero;_lastDirection={x:0,y:0};_isActive=!1;_isDown=!1;_lastEvent=null;_updateInterval=null;_lastState="idle";_controlMap=new Map;_activeTouchReceiver=null;_holdTimeout=null;_holdTriggered=!1;constructor(t){this.scene=t}initialize(t){const i=this.scene.engine;this._controlMap=t,i.input.pointers.primary.on("down",n=>this.onDown(n)),i.input.pointers.primary.on("up",n=>this.onUp(n)),i.input.pointers.primary.on("move",n=>this.onMove(n))}set activeTouchReceiver(t){this._activeTouchReceiver=t}get activeTouchReceiver(){return this._activeTouchReceiver}set modalShowing(t){this._isModalShowing=t}get modalShowing(){return this._isModalShowing}register(){}onDown(t){this._isModalShowing?(this._lastEvent=t,this.notifyJoystickChange("active",tt(0,0)),this._isDown=!0):(this._gestureStartPos=t.worldPos.clone(),this._currentPos=t.worldPos.clone(),this._moveDelta=bt.Zero,this._lastDirection={x:0,y:0},this._isActive=!0,this._isDown=!0,this._lastEvent=t,this._holdTriggered=!1,this.clearHoldTimeout(),this._holdTimeout=window.setTimeout(()=>{this._holdTriggered=!0,this.notifyHold()},500),this.clearUpdateInterval(),this._updateInterval=window.setInterval(()=>{this.processJoystickState()},50))}onUp(t){this._isDown&&(this._isDown=!1,this._isActive=!1,this._moveDelta=bt.Zero,this._lastDirection={x:0,y:0},this._lastEvent=t,this.clearUpdateInterval(),this.clearHoldTimeout(),this.notifyJoystickChange("idle"))}clearHoldTimeout(){this._holdTimeout&&(window.clearTimeout(this._holdTimeout),this._holdTimeout=null)}onMove(t){if(this._isDown&&(this._currentPos=t.worldPos.clone(),this._moveDelta=this._currentPos.sub(this._gestureStartPos),this._lastEvent=t,!this._holdTriggered&&this._moveDelta.magnitude>10&&this.clearHoldTimeout(),this._lastState==="active")){const i=this._moveDelta.magnitude;if(i>=15){const n={x:this._moveDelta.x/i,y:this._moveDelta.y/i};if(Math.abs(this._lastDirection.x)>.01||Math.abs(this._lastDirection.y)>.01){const o=this._lastDirection.x*n.x+this._lastDirection.y*n.y;if(Math.acos(Math.max(-1,Math.min(1,o)))*(180/Math.PI)>90){const c=Math.min(i,50),_=new bt(n.x*c,n.y*c);this._gestureStartPos=this._currentPos.sub(_),this._moveDelta=_,this._lastDirection=n}}}}}clearUpdateInterval(){this._updateInterval&&(window.clearInterval(this._updateInterval),this._updateInterval=null)}processJoystickState(){if(!this._isDown||!this._isActive)return;const t=this._moveDelta.magnitude;let i="idle";t>=15&&(i="active");const n=Math.min(t,15);let o={x:0,y:0};t>0&&(o={x:this._moveDelta.x/t,y:this._moveDelta.y/t},this._lastDirection=o),(i!==this._lastState||i==="active")&&this.notifyJoystickChange(i,o,n),this._lastState=i}notifyHold(){if(!this._activeTouchReceiver)return;const t=this._controlMap.get(this._activeTouchReceiver);t&&t({type:"hold",state:"hold",rawEvent:this._lastEvent||void 0})}notifyJoystickChange=(t,i={x:0,y:0},n=0)=>{if(!this._activeTouchReceiver)return;let o=this._controlMap.get(this._activeTouchReceiver);o&&o({direction:i,distance:n,state:t,rawEvent:this._lastEvent||void 0})}}class Ax extends ed{arena;darkPlayer;lightPlayer;statusBar;sceneTouchManger;burnDown;enemyWaveManager;pregressionSignal=new ee("progressionUpdate");progressionStates={health:0,strength:0,speed:0};gameState={waveNumber:0,enemiesRemaining:0,darkEnemiesDefeated:0,lightEnemiesDefeated:0,darkExp:0,lightExp:0,gameDuration:0};stateSignal=new ee("stateUpdate");pauseGameSignal=new ee("pauseGame");endOfWaveModal;touchMap=new Map;scheduleGameOver=!1;scheculedGameOverTik=0;isEndOfWaveModalEnabled=!0;constructor(){super()}onActivate(t){this.isEndOfWaveModalEnabled=!0,this.scheduleGameOver=!1,this.scheculedGameOverTik=0,this.arena=js,this.add(this.arena),this.darkPlayer=new qr,this.add(this.darkPlayer),this.darkPlayer.pos=sx(this.arena),this.lightPlayer=new sd,this.add(this.lightPlayer),this.darkPlayer.registerPartner(this.lightPlayer),this.lightPlayer.registerPartner(this.darkPlayer),this.endOfWaveModal=new wx(t.engine),this.touchMap.set("darkPlayer",this.darkPlayer.joystickCallback),this.touchMap.set("lightPlayer",this.lightPlayer.joystickCallback),this.touchMap.set("UImodal",o=>{this.endOfWaveModal?.handleTouchControls(o)}),this.sceneTouchManger=new bx(this),this.sceneTouchManger.initialize(this.touchMap),this.sceneTouchManger.activeTouchReceiver="darkPlayer",this.enemyWaveManager=new cx(this,this.lightPlayer,this.darkPlayer,this.arena),this.enemyWaveManager?.init();const i=this.engine.screen.contentArea.width,n=this.engine.screen.contentArea.height;this.statusBar=new xx(tt(i,n)),this.add(this.statusBar),this.stateSignal.listen(this.stateUpdate.bind(this)),this.burnDown=new dx(tt(1,n-12),25,this),this.add(this.burnDown),this.pregressionSignal.listen(o=>{const h=o.detail.params[0];switch(console.log("progress type: ",h),h){case"constitution":this.progressionStates.health++,this.progressionStates.health>2&&(this.progressionStates.health=2);break;case"strength":this.progressionStates.strength++,this.progressionStates.strength>2&&(this.progressionStates.strength=2);break;case"speed":this.progressionStates.speed++,this.progressionStates.speed>2&&(this.progressionStates.speed=2);break}}),this.enemyWaveManager?.startWave()}onDeactivate(t){this.darkPlayer?.kill(),this.lightPlayer?.kill(),this.enemyWaveManager?.endWave()}onPreUpdate(t,i){this.scheduleGameOver&&this.scheculedGameOverTik++,this.scheculedGameOverTik>300&&this.engine.goToScene("gameOver"),this.enemyWaveManager?.update(i),!this.darkPlayer?.isAlive&&!this.lightPlayer?.isAlive&&(this.scheduleGameOver=!0,this.isEndOfWaveModalEnabled=!1,this.enemyWaveManager.isWaveActive=!1)}stateUpdate(t){const[i,n]=t.detail.params;this.gameState[i]=n}showEndOfWaveModal(){this.isEndOfWaveModalEnabled&&(this.darkPlayer.vel=tt(0,0),this.lightPlayer.vel=tt(0,0),console.log("end of wave entity report: ",this.entities.filter(t=>t instanceof xg)),this.sceneTouchManger.activeTouchReceiver="UImodal",this.sceneTouchManger.modalShowing=!0,setTimeout(()=>this.endOfWaveModal?.show(this,this.statusBar.getUIState(),this.getPlayerData(),this.progressionStates),500))}getPlayerData(){return{darkNumberOfEnemiesDefeated:this.darkPlayer.numenemies,lightNumberOfEnemiesDefeated:this.lightPlayer.numenemies}}hideEndOfWaveModal(){this.endOfWaveModal?.hide(this),this.sceneTouchManger.modalShowing=!1,this.enemyWaveManager?.startWave(),(this.darkPlayer?.isPlayerActive?this.darkPlayer:this.lightPlayer)instanceof qr?this.sceneTouchManger.activeTouchReceiver="darkPlayer":this.sceneTouchManger.activeTouchReceiver="lightPlayer"}switchPlayerFocus(){let t;ut.sfxPlayerSwitch.play(ds),this.darkPlayer?.isPlayerActive&&!this.lightPlayer?.isPlayerActive?t=this.lightPlayer:t=this.darkPlayer,this.engine.timescale=.1,this.camera.clearAllStrategies(),this.camera.zoomOverTime(.8,100).then(()=>{this.camera.zoomOverTime(1.5,100).then(()=>{this.engine.timescale=1,this.camera.strategy.lockToActor(t),this.lightPlayer.switchLock=!1,this.darkPlayer.switchLock=!1,t instanceof qr?(this.darkPlayer.isPlayerActive=!0,this.lightPlayer.isPlayerActive=!1,this.sceneTouchManger.activeTouchReceiver="darkPlayer"):(this.darkPlayer.isPlayerActive=!1,this.lightPlayer.isPlayerActive=!0,this.sceneTouchManger.activeTouchReceiver="lightPlayer")})}),this.camera.move(t.pos,200)}}class Ug extends Ai{buttonText;upGraphic;downGraphic;constructor(t){super({width:192,height:64,pos:t}),this.buttonText=new rs({text:"START",pos:tt(192/2,16),font:new ss({width:192,height:64,family:"Arial",size:36,color:kt.White,textAlign:os.Center})}),this.addChild(this.buttonText),this.upGraphic=ut.buttonUp.toSprite(),this.downGraphic=ut.buttonDown.toSprite()}onInitialize(t){this.graphics.use(this.upGraphic),this.on("pointerup",()=>{this.graphics.use(this.upGraphic),t.goToScene("game"),this.buttonText.pos=this.buttonText.pos.add(tt(0,-4))}),this.on("pointerdown",()=>{this.graphics.use(this.downGraphic),this.buttonText.pos=this.buttonText.pos.add(tt(0,4))})}}class yx extends Ai{title;constructor(t){let i=t.right-t.left-20,n=t.bottom-t.top-20,o=new bt(10,10);super({width:i,height:n,pos:o,color:kt.fromHex("#005465")}),this.title=new rs({width:i,height:n/4,pos:tt(0,0),text:"Angels 'n Demons",font:new ss({family:"Arial",size:36,color:kt.White,textAlign:os.Center})}),this.title.pos=tt(i/2,n/4),this.addChild(this.title),this.addChild(new Ug(tt(i/2-192/2,n*.55)))}onInitialize(t){}}class Cx extends ed{starintModal;constructor(){super()}onActivate(t){this.starintModal=new yx(t.engine.screen.contentArea),this.add(this.starintModal)}onDeactivate(t){}}class Sx extends ed{title;button;onActivate(t){const i=t.engine.screen.contentArea;this.title=nd.create(tt(i.width/2,i.height/2-100),"Game Over"),this.button=new Ug(tt(i.width/2-192/2,i.height/2)),this.add(this.title),this.add(this.button)}}class nd extends rs{constructor(t,i){super({pos:t,text:i,font:new ss({family:"Arial",size:42,color:kt.White,textAlign:os.Center}),z:2e3})}static create(t,i){return new nd(t,i)}}await Ct.create(document.body,Hw,Ow).attached;const zg=new Bw({resolution:{width:640,height:360},viewport:{width:640,height:360},canvasElementId:"cnv",displayMode:Mw.FitScreenAndZoom,pixelArt:!0,backgroundColor:kt.fromHex("#26111f"),scenes:{intro:{scene:new Cx},game:{scene:new Ax},gameOver:{scene:new Sx}},pixelRatio:2});await zg.start(sg);zg.goToScene("game");
